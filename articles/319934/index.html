<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Application Monitoring with Pinba</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! We at Badoo try to actively participate in the life of the IT community: we use many open-source technologies and tools, and we also share o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Application Monitoring with Pinba</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/7d8/9f2/f5c/7d89f2f5c7224c419cfed6b08aa53596.png" alt="Drawing" align="left">  Hi, Habr!  We at Badoo try to actively participate in the life of the IT community: we use many open-source technologies and tools, and we also share our developments. </p><br><p>  One of these tools is <a href="http://pinba.org/">Pinba</a> , a service for getting realtime statistics from running applications without the overhead of its collection.  You can learn more <a href="https://habrahabr.ru/company/badoo/blog/149695/">in this article</a> . </p><br><p>  We try to help everyone who uses Pinba in their projects and are always happy to hear the success stories related to Pinba.  This translation is one of similar stories from Dailymotion developers. </p><a name="habracut"></a><br><h3 id="vvedenie">  Introduction </h3><br><p>  Dailymotion uses many tools to monitor, analyze and optimize its applications, such as StatsD, Graphite, collectd and Datadog.  But among them is the less well-known - Pinba (stands for PHP Is Not a Bottleneck Anymore). </p><br><p>  We are currently working on migrating an outdated monolithic PHP application with a lot of legacy code.  Instead, it is planned to deploy several modern microservices.  With Pinba, we collect: </p><br><ul><li><p>  data about the current PHP application.  This allows you to more efficiently perform maintenance and deployment (identify releases that adversely affect performance), as well as find and analyze possible problems.  In addition, the data obtained help determine which components of the platform should be improved in the first place in order to obtain the greatest performance gains; </p><br></li><li>  data on new microservices.  And, depending on the development language (at present it is Python or Go), we use different clients (although for them there are clients out of the box - approx. Lane). </li></ul><br><h3 id="chto-takoe-pinba">  What is Pinba? </h3><br><p>  Pinba's creator, <a href="https://habrahabr.ru/users/tony2001/" class="user_link">tony2001</a> , describes it like this: </p><br><blockquote>  ‚ÄúThis is a statistics server using MySQL as an interface.  Pinba collects and processes data transmitted by a variety of PHP processes via the UDP protocol, and then displays the statistics in the form of simple and understandable reports.  In addition, using a special interface, you can access raw data in read-only mode to generate more detailed reports. ‚Äù </blockquote><p>  How it works? </p><br><p>  The Pinba extension for PHP is installed on all servers in our web farm.  It collects technical data for each PHP stream and, after the response is sent to the client, sends the received metrics to the central Pinba server via UDP (using the Google Protobuf data exchange format).  On the central server, the Pinba engine aggregates the contents of these messages and, pretending to read-only the MySQL engine, provides data in the form of tables that can be viewed and sampled from them using any familiar MySQL client.  Convenient and efficient. </p><br><p>  Despite common misconceptions, Pinba is not a debugger or graphical tool.  It‚Äôs just a data viewer that takes a picture of what‚Äôs happening in your production application (a real-time slice is created in the last minute or two).  It allows you to use dynamic metrics to build graphs of time series without sacrificing performance and, accordingly, in time to identify possible problems. </p><br><p>  Of course, Pinba is not a panacea and will not solve all problems.  One of the common mistakes associated with using this service to collect accurate data (for example, as a counter of events that took place in the last minute).  Pinba is not designed for this type of task (as you already know, in order to improve performance, protobuf messages are sent via UDP, so some packets may be lost along the way).  Use this tool to track trends, it is not suitable for accurate quantification of actions. </p><br><h3 id="nasha-arhitektura">  Our architecture </h3><br><p><img src="https://habrastorage.org/files/f12/d81/a93/f12d81a93aa24d0799a7923044fea666.png" alt="enter image description here"></p><br><p>  What metrics can be monitored using the service? <br>  The range of technical metrics tracked by default in all PHP processes is very wide: </p><br><ul><li><p>  doc_size - the size of the response; </p><br></li><li><p>  mem_peak_usage - allocated memory (maximum capacity); </p><br></li><li><p>  request_time - time taken to create the process (processing microsend); </p><br></li><li><p>  ru_utime / ru_stime - statistical data on the use of server resources (by the user and the system); </p><br></li><li><p>  status - HTTP response code; </p><br></li><li>  memory_footprint - the amount of memory occupied by the process. </li></ul><br><p>  The engine stores metrics for each process in the request table, allocating one line for each PHP response for the last pinba_stats_history seconds (in our case, 60 seconds). </p><br><pre><code class="hljs pgsql">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> script_name, doc_size, mem_peak_usage, status, memory_footprint, hostname <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> request <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>;</code> </pre> <br><table><thead><tr><th>  <strong>script_name</strong> </th><th>  <strong>doc_size</strong> </th><th>  <strong>mem_peak_usage</strong> </th><th>  <strong>status</strong> </th><th>  <strong>memory_footprint</strong> </th><th>  <strong>hostname</strong> </th></tr></thead><tbody><tr><td>  [PROD] video_item </td><td>  5.422 </td><td>  10240 </td><td>  200 </td><td>  54728 </td><td>  web-065 </td></tr><tr><td>  [PROD] widget_dispatch_v3 </td><td>  38.056 </td><td>  14848 </td><td>  200 </td><td>  31624 </td><td>  web-031 </td></tr><tr><td>  [PROD] video_list </td><td>  154.369 </td><td>  20736 </td><td>  200 </td><td>  87176 </td><td>  web-004 </td></tr><tr><td>  [PROD] rest_api </td><td>  0.235 </td><td>  22784 </td><td>  200 </td><td>  51568 </td><td>  web-128 </td></tr><tr><td>  [PROD] rest_api </td><td>  9.306 </td><td>  34048 </td><td>  200 </td><td>  55624 </td><td>  web-024 </td></tr><tr><td>  [PROD] rest_api </td><td>  5.448 </td><td>  35072 </td><td>  200 </td><td>  54676 </td><td>  web-041 </td></tr><tr><td>  [PROD] controller_dispatch </td><td>  2.003 </td><td>  11776 </td><td>  200 </td><td>  36388 </td><td>  web-033 </td></tr><tr><td>  [PROD] widget_v3_chunks </td><td>  22.525 </td><td>  12544 </td><td>  200 </td><td>  33544 </td><td>  web-165 </td></tr><tr><td>  [PROD] cdn_director </td><td>  0 </td><td>  9984 </td><td>  302 </td><td>  42892 </td><td>  web-034 </td></tr><tr><td>  [PROD] rest_api </td><td>  0.019 </td><td>  20736 </td><td>  200 </td><td>  32500 </td><td>  web-085 </td></tr></tbody></table><br><p>  The request table contains metrics for each PHP process, and accessing raw data can be quite difficult in the case of heavy traffic: </p><br><pre> <code class="hljs pgsql">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> COUNT(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> request;</code> </pre> <br><table><thead><tr><th>  COUNT (1) </th></tr></thead><tbody><tr><td>  1197502 </td></tr></tbody></table><br><p>  That is, within the framework of our entire web farm, in 19 seconds, 1 197 502 PHP responses were generated. </p><br><p>  Fortunately, the engine simultaneously performs instant aggregation by placing summary metrics in the report_ * table.  Metrics, grouped by value in the script_name field, are in the report_by_script_name table, so we can analyze the metrics for specific script_name values.  For example, we can get statistics on the ten most frequently called routes: </p><br><pre> <code class="hljs pgsql">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> script_name, req_count, req_per_sec, memory_footprint_total, req_time_median <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> report_by_script_name <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> req_count <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>;</code> </pre> <br><table><thead><tr><th>  <strong>script_name</strong> </th><th>  <strong>req_count</strong> </th><th>  <strong>req_per_sec</strong> </th><th>  <strong>memory_footprint_total</strong> </th><th>  <strong>req_time_median</strong> </th></tr></thead><tbody><tr><td>  [PROD] rest_api </td><td>  276508 </td><td>  4608.47 </td><td>  12916600000 </td><td>  0.0514983 </td></tr><tr><td>  [PROD] embed_player </td><td>  162808 </td><td>  2713.47 </td><td>  8074990000 </td><td>  0.109837 </td></tr><tr><td>  [PROD] cdn_director </td><td>  122526 </td><td>  2042.1 </td><td>  5103160000 </td><td>  0.0280768 </td></tr><tr><td>  [PROD] widget_dispatch_v3 </td><td>  105822 </td><td>  1763.7 </td><td>  4349350000 </td><td>  0.049904 </td></tr><tr><td>  [PROD] history_logger </td><td>  98481 </td><td>  1641.35 </td><td>  4060860000 </td><td>  0.0127946 </td></tr><tr><td>  [PROD] video_item </td><td>  66250 </td><td>  1104.17 </td><td>  3563420000 </td><td>  0.254091 </td></tr><tr><td>  [PROD] autocomplete_list </td><td>  56313 </td><td>  938.55 </td><td>  2322790000 </td><td>  0.0104993 </td></tr><tr><td>  [PROD] webapp_ads_mopub </td><td>  52187 </td><td>  869.783 </td><td>  2183980000 </td><td>  0.0326299 </td></tr><tr><td>  [PROD] gravity_report </td><td>  45992 </td><td>  766.533 </td><td>  1895290000 </td><td>  0.0167253 </td></tr><tr><td>  [PROD] player_data </td><td>  33584 </td><td>  559.733 </td><td>  1724540000 </td><td>  0.113651 </td></tr></tbody></table><br><p>  We can also calculate the average amount of allocated memory just by running a query. </p><br><pre> <code class="hljs pgsql">memory_footprint_total/req_count <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> avg_mem_footprint</code> </pre> <br><p>  By default, the engine also consolidates metrics in several other convenient tables: </p><br><ul><li><p>  report_by_server_name; </p><br></li><li><p>  report_by_hostname; </p><br></li><li><p>  report_by_server_and_script; </p><br></li><li><p>  report_by_hostname_and_server; </p><br></li><li>  report_by_hostname_server_and_script. </li></ul><br><p>  To obtain detailed information, use a table that combines data from several dimensions.  These can be, for example, the most frequently used scripts on the host and server: </p><br><pre> <code class="hljs pgsql">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> hostname, server_name, script_name, req_count, req_per_sec, req_time_median <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> report_by_hostname_server_and_script <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> req_count <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>;</code> </pre> <br><table><thead><tr><th>  <strong>hostname</strong> </th><th>  <strong>server_name</strong> </th><th>  <strong>script_name</strong> </th><th>  <strong>req_count</strong> </th><th>  <strong>req_per_sec</strong> </th><th>  <strong>req_time_median</strong> </th></tr></thead><tbody><tr><td>  web-121 </td><td>  api.dailymotion.com </td><td>  [PROD] api_oauth_token </td><td>  4144 </td><td>  69.0667 </td><td>  0.0104435 </td></tr><tr><td>  web-038 </td><td>  api.dailymotion.com </td><td>  [PROD] rest_api </td><td>  3455 </td><td>  57.5833 </td><td>  0.0441618 </td></tr></tbody></table><br><h3 id="sbor-sobstvennyh-metrik">  Collect your own metrics </h3><br><p>  As you can see, Pinba provides a lot of useful information without additional settings, but that's not all!  In addition to report tables, you can use tag <em>report</em> tables *.  Metrics are consolidated in these tables according to the tag values ‚Äã‚Äãthat you define in your code. </p><br><p>  For example, in the old Dailymotion code base we have two kinds of tags: </p><br><ul><li><p>  I / O: any access from the outside, blocking the execution of the process (access to <br>  servers like MySQL, Elastic, Redis, memcached or external API, <br>  for example, Facebook or Twitter); </p><br></li><li>  algo: the algorithms we want to watch. </li></ul><br><p>  For example, for memcache we use tags like this: </p><br><p>  <em>Client code</em> </p><br><pre> <code class="hljs php">$pinbaTimer = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;pinbaService-&gt;startTimer([ <span class="hljs-string"><span class="hljs-string">'group'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'memcached'</span></span>, <span class="hljs-string"><span class="hljs-string">'memcached'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;pinba_pool, <span class="hljs-string"><span class="hljs-string">'method'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'get'</span></span>, <span class="hljs-string"><span class="hljs-string">'namespace'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'dm_cache'</span></span> ]); $value = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;memcache-&gt;get(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;prefix . $key); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;pinbaService-&gt;stopTimer($pinbaTimer);</code> </pre> <br><p>  <em>Pinba service</em> </p><br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startTimer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $tags)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isPinbaInstalled) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } $timerId = <span class="hljs-string"><span class="hljs-string">'t'</span></span> . ++<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;incr; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;timers[$timerId] = pinba_timer_start($tags); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $timerId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stopTimer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($timerId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isPinbaInstalled &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;timers[$timerId])) { pinba_timer_stop(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;timers[$timerId]); <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;timers[$timerId]); } }</code> </pre> <br><p>  Then we create custom tables in the Pinba database, using comments explaining to the engine what to store in them. </p><br><p>  For example, this is how a table for storing metrics describing the use of memcached looks </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`tag_report_memcached_method_namespace`</span></span> ( <span class="hljs-string"><span class="hljs-string">`script_name`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`memcached`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`method`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`namespace`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`req_count`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`req_per_sec`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`hit_count`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`hit_per_sec`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`timer_value`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`timer_median`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`index_value`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=PINBA <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=latin1 <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span>=<span class="hljs-string"><span class="hljs-string">'tagN_report:memcached,method,namespace'</span></span>;</code> </pre> <br><p>  And so - a table for storing metrics about application I / O parameters: </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`tag_report_group_method`</span></span> ( <span class="hljs-string"><span class="hljs-string">`script_name`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`group`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`method`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`req_count`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`req_per_sec`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`hit_count`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`hit_per_sec`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`timer_value`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`timer_median`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`index_value`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=PINBA <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=latin1 <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span>=<span class="hljs-string"><span class="hljs-string">'tag2_report:group,method'</span></span>;</code> </pre> <br><p>  Note to yourself: next time, do not use SQL reserved words (group, ...) as column names. </p><br><p>  These tables allow us to obtain detailed statistical data, for example, about all I / O operations for a particular route: </p><br><pre> <code class="hljs pgsql">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> `<span class="hljs-keyword"><span class="hljs-keyword">group</span></span>`, SUM(req_count) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> req, AVG(timer_median) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> timer_median, SUM(timer_value)/SUM(hit_count) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> tph, SUM(timer_value)/SUM(req_count) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> tpr, SUM(timer_value) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> timer_total <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tag_report_group_method <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> script_name=<span class="hljs-string"><span class="hljs-string">'[PROD]video_item'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> `<span class="hljs-keyword"><span class="hljs-keyword">group</span></span>` != "int_api" <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> `<span class="hljs-keyword"><span class="hljs-keyword">group</span></span>` <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> timer_total <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>;</code> </pre> <br><table><thead><tr><th>  <strong>group</strong> </th><th>  <strong>req</strong> </th><th>  <strong>timer_median</strong> </th><th>  <strong>tph</strong> </th><th>  <strong>tpr</strong> </th><th>  <strong>timer_total</strong> </th></tr></thead><tbody><tr><td>  mysql </td><td>  118124 </td><td>  0.009819403290748596 </td><td>  0.003329653064723691 </td><td>  0.05909533790217434 </td><td>  6980.5776943564415 </td></tr><tr><td>  memcached </td><td>  188049 </td><td>  0.00976656749844551 </td><td>  0.0003179184672595343 </td><td>  0.01067464985796328 </td><td>  2007.3572311401367 </td></tr><tr><td>  Elastic </td><td>  32049 </td><td>  0.011334048118442297 </td><td>  0.016838098360988627 </td><td>  0.026841974640797184 </td><td>  860.2584452629089 </td></tr><tr><td>  Redis </td><td>  48999 </td><td>  0.009611431136727333 </td><td>  0.011986066101148827 </td><td>  0.012204265879965226 </td><td>  597.9968238524161 </td></tr><tr><td>  DMX </td><td>  61436 </td><td>  0.009767306968569756 </td><td>  0.0016191925102048436 </td><td>  0.0073448760845254615 </td><td>  451.23980712890625 </td></tr><tr><td>  Curl </td><td>  24882 </td><td>  0.06987743234882753 </td><td>  0.008533559191620778 </td><td>  0.008533559191620778 </td><td>  212.3320198059082 </td></tr><tr><td>  cleeng </td><td>  50 </td><td>  0.12915635108947754 </td><td>  0.1352721940790749 </td><td>  1.0902938842773438 </td><td>  54.51469421386719 </td></tr><tr><td>  Facebook API </td><td>  22 </td><td>  0.5436198115348816 </td><td>  0.5515929568897594 </td><td>  0.5515929568897594 </td><td>  12.135045051574707 </td></tr><tr><td>  Live API </td><td>  one </td><td>  0.01953125 </td><td>  0.0049230000004172325 </td><td>  0.0049230000004172325 </td><td>  0.0049230000004172325 </td></tr></tbody></table><br><p>  MySQL SELECT details: </p><br><pre> <code class="hljs pgsql">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> mysql, <span class="hljs-keyword"><span class="hljs-keyword">method</span></span>, timer_value, timer_value/req_count <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> avg_timer_value, hit_count/req_count <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> avg_op_count, timer_value/hit_count <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> avg_op_value, hit_count, req_count <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tag_report_mysql_method <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">method</span></span>=<span class="hljs-string"><span class="hljs-string">'select'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> script_name=<span class="hljs-string"><span class="hljs-string">'[PROD]video_item'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> req_count &gt; <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> avg_op_count <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>;</code> </pre> <br><table><thead><tr><th>  <strong>mysql</strong> </th><th>  <strong>method</strong> </th><th>  <strong>timer_value</strong> </th><th>  <strong>avg_timer_value</strong> </th><th>  <strong>avg_op_count</strong> </th><th>  <strong>avg_op_value</strong> </th><th>  <strong>hit_count</strong> </th><th>  <strong>req_count</strong> </th></tr></thead><tbody><tr><td>  video </td><td>  select </td><td>  3971.99 </td><td>  0.10144789052722653 </td><td>  16.6880 </td><td>  0.006079103953896177 </td><td>  653384 </td><td>  39153 </td></tr><tr><td>  video_view_summary </td><td>  select </td><td>  264.027 </td><td>  0.007824405328308366 </td><td>  12.6024 </td><td>  0.000620868312581275 </td><td>  425254 </td><td>  33744 </td></tr><tr><td>  static_asset_video_sprite </td><td>  select </td><td>  15.4905 </td><td>  0.022613802443455604 </td><td>  7.6496 </td><td>  0.0029561936400318875 </td><td>  5240 </td><td>  685 </td></tr><tr><td>  video_has_repost </td><td>  select </td><td>  1468.93 </td><td>  0.027541118671605483 </td><td>  6.7955 </td><td>  0.0040528553527407 </td><td>  362444 </td><td>  53336 </td></tr></tbody></table><br><p>  We track the use of select queries.  If their number becomes very large, it is possible that caching is performed inefficiently. </p><br><h3 id="dopolnitelnye-vozmozhnosti">  Additional features </h3><br><p>  We also use another interesting feature of Pinba - tags that allow you to distinguish between requests of different types.  Requests are tagged with the tags you defined.  For example, we use tags for the following queries: </p><br><ul><li><p>  format: response format (html, rss, atom, ...); </p><br></li><li><p>  site_content: languages ‚Äã‚Äãof site content (en, de, fr, jp, ru, ...); </p><br></li><li><p>  bot: real client or bot?  (yes / no); </p><br></li><li><p>  auth: user authenticated (logged in)?  (yes / no); </p><br></li><li>  provider: determine the differences between PHP versions: standard PHP or HHVM, etc. </li></ul><br><p>  Then we create the tables and in the comments for the engine specify what and where to store.  For example, we can create a table based on report_by_script_name, in which the engine stores data only for PHP processes with a value of no for the bot request tag and a value of no for the auth request tag.  In other words, these are real users who have not logged in to the system - a common situation. </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`auth_no_bot_no_report_by_script_name`</span></span> ( <span class="hljs-string"><span class="hljs-string">`req_count`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`req_per_sec`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ... <span class="hljs-string"><span class="hljs-string">`req_time_median`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`index_value`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=PINBA <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=latin1 <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span>=<span class="hljs-string"><span class="hljs-string">'report1::tag.auth=no,tag.bot=no'</span></span>;</code> </pre> <br><h3 id="postroenie-grafikov">  Plotting </h3><br><p>  Pinba only stores metrics for one or two minutes.  Therefore, to plot data, you need to consolidate on external resources.  Here we use collectd paired with the MySQL plugin.  In doing so, queries are made to the Pinba database, and the results are stored in Whisper.  We then query Whisper using Graphite and Tessera or Grafana. </p><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>  Using Pinba with our outdated PHP application allowed us to: </p><br><ul><li><p>  detect possible sources of problems in the application; </p><br></li><li><p>  identify errors (unreasonably large number of requests to servers on some routes); </p><br></li><li>  Build charts and set up alerts to detect performance degradation after release. </li></ul><br><p>  We also use Pinba in our Python projects.  A specialized version of Pynba was created by our old friend (and now a colleague) johnnoone. </p><br><p>  The only thing we noticed while using Pinba: the extension does not always correctly ‚Äúforget‚Äù the information about old queries.  Sometimes report tables contain phantom results - activity data that took place more than a minute ago.  This can be a problem if you need to make sure with Pinba that something is not happening (usually after deploying a new code on production).  This is one of the few cases when the cause of the error is not in your code. </p><br><p>  The easiest way to fix it is to restart the Pinba engine.  As a result, small gaps will appear on the graphs, but phantom data will definitely disappear.  (Note: TRUNCATE TABLE doesn't suit you, as it is not MySQL engine.) </p><br><h3 id="poleznye-resursy-dlya-polzovateley-pinba">  Useful Resources for Pinba Users </h3><br><ol><li>  GitHub: <a href="https://github.com/tony2001/pinba_engine">https://github.com/tony2001/pinba_engine</a> </li><li>  Documentation: <a href="https://github.com/tony2001/pinba_engine/wiki">https://github.com/tony2001/pinba_engine/wiki</a> </li><li>  Monitoring PHP code performance with Pinba: <br>  <a href="https://habrahabr.ru/company/badoo/blog/149695/">https://habrahabr.ru/company/badoo/blog/149695/</a> </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/319934/">https://habr.com/ru/post/319934/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../319920/index.html">Why data can be open and free</a></li>
<li><a href="../319922/index.html">Cocoa Delphi Flavored</a></li>
<li><a href="../319926/index.html">How to test the DSU in the data center</a></li>
<li><a href="../319928/index.html">Plan without B: planning in the company from ‚ÄúI‚Äù to ‚Äúwe‚Äù</a></li>
<li><a href="../319932/index.html">Site security by its headers, or what to do if you want to crawl into the insides of each site</a></li>
<li><a href="../319936/index.html">JS optimization killers are no longer so scary</a></li>
<li><a href="../319938/index.html">How to find your first job as a programmer? From summary to trial period</a></li>
<li><a href="../319940/index.html">Low-latency InfiniBand network performance on the HPC HUB virtual cluster</a></li>
<li><a href="../319942/index.html">Windows users have the opportunity to work with openSUSE (and Arch Linux)</a></li>
<li><a href="../319944/index.html">How to build a product localization process from scratch</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>