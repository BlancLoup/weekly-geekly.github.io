<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pillow-SIMD</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Acceleration of operations by 2.5 times compared with Pillow and 10 compared with ImageMagick 



 Pillow-SIMD is the fork-follower of the Pillow imag...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pillow-SIMD</h1><div class="post__text post__text-html js-mediator-article"><h1>  Acceleration of operations by 2.5 times compared with Pillow and 10 compared with ImageMagick </h1><br><img src="https://habrastorage.org/files/44d/568/307/44d5683071214a0ca5cbfc1f2a14a67a.png" align="right"><br><p>  <a href="https://github.com/uploadcare/pillow-simd">Pillow-SIMD</a> is the fork-follower of the <a href="https://python-pillow.org/">Pillow</a> imaging library (which itself is a fork of the PIL library, now deceased).  "Follower" means that the project does not become independent, but will be updated along with Pillow and have the same version numbering, only with a suffix.  I hope to release the Pillow-SIMD versions more or less immediately after the Pillow versions are released. </p><br><h2>  Why SIMD </h2><br><p>  There are several ways to improve image processing performance (and all other things, probably, too). </p><br><ol><li>  You can use better algorithms that give the same result. </li><li>  You can make a faster implementation of the existing algorithm. </li><li>  You can connect more computing resources to solve the same problem: additional CPU cores, GPUs. </li></ol><a name="habracut"></a><br><p>  The great thing is when you can use a faster algorithm, like when in Pillow 2.7 Gaussian blur based on convolutions <a href="https://habrahabr.ru/post/247219/">was replaced by</a> blur with a sequence of box filters.  Unfortunately, the number of such tricks is very limited.  Also very tempting is the idea of ‚Äã‚Äãusing more computing resources.  But unfortunately, they are often either not there, or they cost extra money (as is the case with leased servers).  Using the same GPU for computing is generally a non-trivial task related to the selection of a certain hardware and the correct setting of the drivers.  It remains the most reliable way - to try to get the existing code to work faster on the existing hardware.  And here SIMD-instructions fit perfectly well. </p><br><p>  SIMD means: ‚Äúsingle instruction, a lot of data‚Äù (single instruction, multiple data).  In classic programs, we take operands, perform an operation, and save the result.  In the case of SIMD, we immediately take a bundle of operands, do the same action on all of them at once, and save a bundle of results.  For a processor, this is easier than doing the same thing several times.  There are a huge number of processor command extensions with SIMD instructions, for example: MMX, SSE-SSE4, AVX, AVX2, AVX512, NEON. </p><br><p>  In the current version, Pillow-SIMD can be compiled using SSE4 extensions (default) or AVX2. </p><br><h2>  Project status </h2><br><p>  Pillow-SIMD is suitable for production.  Different versions of Pillow-SIMD have been working on <a href="https://uploadcare.com/">Uploadcare</a> servers for more than a year <a href="https://uploadcare.com/">now</a> .  Uploadcare is a service for storing and processing custom content and is the main sponsor of Pillow-SIMD. </p><br><p>  Currently the following operations are accelerated in the SIMD version: </p><br><ul><li>  Resize (convolution based resampling): SSE4, AVX2 </li><li>  Gaussian blur and box filters: SSE4 </li></ul><br><h2>  Performance </h2><br><p>  The numbers indicate the number of processed megapixels of the original image per second.  For example, if a resize of an image of size 7712 √ó 4352 was completed in 0.5 seconds, the performance would be 67.1 Mpx / s. </p><br><p>  <font color="#888">Already in the editing process, I realized that it seemed to me that there was confusion in the megapixel for ImageMagick 10 ^ 6 pixels, and in the megapixel for Pillow - 2 ^ 20.</font>  <font color="#888">But this does not greatly affect the overall picture.</font> </p><br><p>  Tested by: </p><br><ul><li><code>ImageMagick 6.9.3-8 Q8 x86_64</code> </li> <li> <code>Pillow 3.2.0</code> </li> <li> <code>Pillow-SIMD 3.2.0.post2</code> </li> </ul><br><table><tbody><tr><th>  Source </th><th>  Operation </th><th>  Filter </th><th>  IM </th><th>  Pillow </th><th>  SIMD SSE4 </th><th>  SIMD AVX2 </th></tr><tr><td rowspan="12">  7712 √ó 4352 RGB </td><th rowspan="3">  Resize to 16x16 </th><td>  Bilinear </td><td>  27.0 </td><td>  217 </td><td>  437 </td><td>  710 </td></tr><tr><td>  Bicubic </td><td>  10.9 </td><td>  115 </td><td>  232 </td><td>  391 </td></tr><tr><td>  Lanczos </td><td>  6.6 </td><td>  76.1 </td><td>  157 </td><td>  265 </td></tr><tr><th rowspan="3">  Resize to 320x180 </th><td>  Bilinear </td><td>  32.0 </td><td>  166 </td><td>  410 </td><td>  612 </td></tr><tr><td>  Bicubic </td><td>  16.5 </td><td>  92.3 </td><td>  211 </td><td>  344 </td></tr><tr><td>  Lanczos </td><td>  11.0 </td><td>  63.2 </td><td>  136 </td><td>  223 </td></tr><tr><th rowspan="3">  Resize to 2048x1155 </th><td>  Bilinear </td><td>  20.7 </td><td>  87.6 </td><td>  229 </td><td>  265 </td></tr><tr><td>  Bicubic </td><td>  12.2 </td><td>  65.7 </td><td>  140 </td><td>  171 </td></tr><tr><td>  Lanczos </td><td>  8.7 </td><td>  41.3 </td><td>  100 </td><td>  126 </td></tr><tr><th rowspan="3">  Blur </th><td>  1px </td><td>  8.1 </td><td>  17.1 </td><td>  37.8 </td><td rowspan="3"></td></tr><tr><td>  10px </td><td>  2.6 </td><td>  17.4 </td><td>  39.0 </td></tr><tr><td>  100px </td><td>  0.3 </td><td>  17.2 </td><td>  39.0 </td></tr><tr><td rowspan="12">  1920 √ó 1280 RGB </td><th rowspan="3">  Resize to 16x16 </th><td>  Bilinear </td><td>  41.6 </td><td>  196 </td><td>  426 </td><td>  750 </td></tr><tr><td>  Bicubic </td><td>  18.9 </td><td>  102 </td><td>  221 </td><td>  379 </td></tr><tr><td>  Lanczos </td><td>  13.7 </td><td>  68.6 </td><td>  140 </td><td>  227 </td></tr><tr><th rowspan="3">  Resize to 320x180 </th><td>  Bilinear </td><td>  27.6 </td><td>  111 </td><td>  303 </td><td>  346 </td></tr><tr><td>  Bicubic </td><td>  14.5 </td><td>  66.3 </td><td>  164 </td><td>  230 </td></tr><tr><td>  Lanczos </td><td>  9.8 </td><td>  44.3 </td><td>  108 </td><td>  143 </td></tr><tr><th rowspan="3">  Resize to 2048x1155 </th><td>  Bilinear </td><td>  9.1 </td><td>  20.7 </td><td>  71.1 </td><td>  69.6 </td></tr><tr><td>  Bicubic </td><td>  6.3 </td><td>  16.9 </td><td>  53.8 </td><td>  53.1 </td></tr><tr><td>  Lanczos </td><td>  4.7 </td><td>  14.6 </td><td>  40.7 </td><td>  41.7 </td></tr><tr><th rowspan="3">  Blur </th><td>  1px </td><td>  8.7 </td><td>  16.2 </td><td>  35.7 </td><td rowspan="3"></td></tr><tr><td>  10px </td><td>  2.8 </td><td>  16.7 </td><td>  35.4 </td></tr><tr><td>  100px </td><td>  0.4 </td><td>  16.4 </td><td>  36.2 </td></tr></tbody></table><br><p>  Pillow is always faster than ImageMagick, and Pillow-SIMD is faster than Pillow about 2-2.5 times for the SSE4 version.  Basically, the AVX2 version is faster than the ImageMagick 10-15 times. </p><br><p>  Tests were performed on Ubuntu 14.04 64-bit running on an Intel Core i5 4258U processor with AVX2.  All tests used only one processor core. </p><br><p>  The ImageMagick performance was measured by the convert command line utility with the arguments <code>-verbose</code> and <code>-bench</code> .  The selected filters exactly match the existing Pillow filters: </p><br><ul><li> <code>PIL.Image.BILINEAR == Triangle</code> </li> <li> <code>PIL.Image.BICUBIC == Catrom</code> </li> <li> <code>PIL.Image.LANCZOS == Lanczos</code> </li> </ul><br><p>  For testing <a href="https://gist.github.com/homm/f9b8d8a84a57a7e51f9c2a5828e40e63">such scripts</a> were used. </p><br><h2>  Why is Pillow so fast </h2><br><p>  There are no tricks here, high-quality resize and blur methods were used for the tests.  Results almost pixel by pixel with a small error.  The only difference is in the effectiveness of the algorithms themselves.  In Pillow 2.7, resampling <a href="https://habrahabr.ru/post/247219/">was rewritten</a> using pre-computed coefficients, less using floating point numbers and transposing, effectively using the processor cache. </p><br><h2>  Why Pillow-SIMD is even faster </h2><br><p>  Of course, due to the use of SIMD commands.  But I still have a few thoughts on how to improve this result. </p><br><ul><li>  <strong>Efficient memory management</strong> At the moment, each pixel is loaded into the SSE register from memory separately, while in one SSE register it is possible to read 4 pixels at a time. </li><li>  <strong>Calculations on integers</strong> Despite the fact that modern processors work very effectively with floating point numbers, there are two reasons to believe that working with integers will be more efficient: operations on integers are algorithmically simpler;  to work with them does not require additional coverings. </li><li>  <strong>Alignment of data in the memory</strong> loading and unloading of data from SIMD-registers is faster, if the addresses in the memory, which is being exchanged, are aligned. </li></ul><br><h2>  Why not put changes back into Pillow </h2><br><p>  In short, it is very difficult.  Pillow supports a large number of architectures, not just x86.  But even on x86 Pillow for some platforms it is distributed in the form of compiled executable files.  To be able to use SIMD commands in code, you need to pass arguments to the compiler allowing the use of the most advanced instructions that we want to use: <code>-mavx2</code> .  After that, you need to check the capabilities of the processor at runtime and enable this or that branch of code depending on them.  The problem is that such arguments automatically compile code hidden under the conditions of the preprocessor <code>if (__AVX2__)</code> and below, which may have no checks for execution time.  The saddest thing is that such code is actually located, at least when compiling GCC, and executable files without using AVX2 explicitly, but compiled with <code>-mavx2</code> , start to <code>-mavx2</code> .  Of course, you can build different versions of the library with different compiler options and dynamically connect them, but this [see  beginning of this paragraph]. </p><br><h2>  Installation </h2><br><p>  The good news is that to install the SSE4 version, it‚Äôs enough to write as usual <code>pip install pillow-simd</code> , and if your processor can do it in SSE4 (I think the probability is about 95%), everything will be fine.  Remember to remove the original Pillow package. </p><br><p>  If you want to build the AVX2 version, then you need to pass additional flags to the compiler.  The easiest way to do this is to set the <code>CC</code> environment variable during installation and compilation. </p><br><pre> <code class="markdown hljs">$ pip uninstall -y pillow-simd ; CC="cc -mavx2" pip install pillow-simd</code> </pre> <br><p>  Sometimes it happens that there is a dependency on Pillow not only on you, but on other packages that you use.  And even if these packages do not really need fast re-sampling, they still install Pillow without SIMD, which can be imported first.  For this, this hack may come in handy when installing from GitHub: </p><br><pre> <code class="markdown hljs">$ pip install -e git+https://github.com/uploadcare/pillow-simd.git@v3.2.0.post3#egg=pillow</code> </pre> <br><p>  Then during the installation of another package with a dependency on Pillow, another version of Pillow will not be installed: </p><br><pre> <code class="markdown hljs">$ pip install xhtml2pdf -e git+https://github.com/uploadcare/pillow-simd.git@v3.2.0.post3#egg=pillow</code> </pre> </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/301576/">https://habr.com/ru/post/301576/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../301564/index.html">Game Industry Digest: April</a></li>
<li><a href="../301566/index.html">Using Java arrays to insert, retrieve, and modify PostgreSQL arrays</a></li>
<li><a href="../301568/index.html">How vulnerable are our data?</a></li>
<li><a href="../301570/index.html">Recover ePMP firmware from Cambium Networks via TFTP</a></li>
<li><a href="../301574/index.html">Corporate laboratories - best practices for information security</a></li>
<li><a href="../301578/index.html">VectorDrawable - Part One</a></li>
<li><a href="../301580/index.html">Game development digest</a></li>
<li><a href="../301582/index.html">Our principles of naming</a></li>
<li><a href="../301584/index.html">Geo-distributed s3 cluster in active-active mode</a></li>
<li><a href="../301588/index.html">Javascript-only: homogeneous web project architecture</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>