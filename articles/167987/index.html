<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The study of the processor and its functional simulation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Probably every ASM / C / C ++ programmer once thought about writing his own operating system. 

 And probably every Verilog / VHDL developer for FPGAs...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The study of the processor and its functional simulation</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/d09/386/188/d093861883977f274f42a638f289b8be.jpg"><br><br>  Probably every ASM / C / C ++ programmer once thought about writing his own operating system. <br><br>  And probably every Verilog / VHDL developer for FPGAs ever thought about creating their own processor. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Actually to implement a more or less traditional processor today seems not very big problem.  The principles of operation of processors are described in many books and articles.  In addition, there are many processors with an open architecture like openRISC or openSPARC and many others.  They can be considered before reinventing your bike. <br><br>  I decided to study the ARM compatible AMBER processor.  Its source is on <a href="http://opencores.org/">http://opencores.org</a> . <a name="habracut"></a><br><br>  First of all, it should be noted that the source code of the AMBER project from opencores does not describe the newest processor.  This is just an ARM v2a.  This is all due to the fact that older processors and their instruction set are patented, but v2a is not.  Nevertheless, I decided to choose this processor for my experiments because: <br><ul><li>  All the same, this ARM is one of the most popular processors in phones, tablets and all sorts of embedded systems.  Studying the ARM command system is not in vain. </li><li>  The source code of the processor is written in Verilog - I am familiar with this language. </li><li>  The developer of the system on the AMBER chip provides patches for the Linux kernel to build it and it seems that the instructions are quite detailed. </li></ul><br>  It seems to me that creating a ‚Äúnew‚Äù processor is in itself possible, but has no value without a compiler and an OS.  Every developer who wants to start creating their own processor should think about it.  The system on the AMBER chip seems to give food for the mind - there is an ARM v2a processor, and the GCC compiler is Linux. <br><br>  Despite the fact that the source system is open, the work had to be done great.  The original AMBER project was launched on a debug board with Xilinx FPGA.  I was going to port the project to a completely different board with Altera FPGAs. <br><br>  I am porting the AMBER project to the Mars Rover 2: <br><br><img src="https://habrastorage.org/storage2/8cd/611/115/8cd611115a7dbe1a37e3ad774cfd1f0a.jpg"><br><br>  This board contains the FPGA Cyclone III EP3C10E144C8 (10 thousand logic elements), an SDRAM 8Mb memory chip, an integrated FTDI FT2232H based programmer, an ADC chip, buttons, LEDs, a VGA connector.  It is a budget fee. <br><br>  The FTDI chip provides a USB interface.  Chip FT2232H has two channels that can be programmed in different modes of operation.  This board assumes that channel A of the FTDI chip will be used for programming the FPGA via JTAG, and channel B will be like a high-speed serial port (921600 bps).  Both channels operate independently of each other.  Thus, the FPGA can receive or transmit data via the serial port, and in the meantime, the internal FPGA signals can be studied with the Altera SignalTap tool via the JTAG.  It is quite convenient - all through a single USB cable - and power to the board, and data transfer and download / debugging of the project. <br><br>  Unfortunately, porting the AMBER project to the Mars Rover 2 board was not very smooth and required quite a lot of effort.  Some problems were predictable and understandable, such as the fact that in the project it was necessary to replace the Xilinx DLL components and memory blocks for the cache or the bootram with similar Altera components.  Or another clear task - instead of using the components of the DDR controller, use the SDRAM module.  I used a Wishbone BUS compatible open source SDRAM controller with the same opencores.  It was also necessary to make new assignments of input / output signals to the FPGA pins according to the Mars Rover 2 card scheme. <br><br>  Other problems that had to be solved turned out to be far from trivial. <br><br>  For example, it turned out that some constructions of the Verilog language are interpreted by the Altera Quartus II compiler somewhat differently than the Xilinx compiler.  Moreover, for the functional simulation of the project, I used Icarus Verilog and it seems that he interprets Verilog in the same way as Xilinx, and not in the same way as Altera.  This is somewhat frustrating, but in the end, I managed to identify and fix problem areas in the source code of the Verilog AMBER processor after simulating icarus and in-circuit debugging with Altera SignalTap. <br><br>  The next difficulty was with the Linux kernel, which I compiled to run on the board.  Here I didn‚Äôt expect any problems at all, because the author of the system on the AMBER Santifort chip Conor described in his instruction how to build the core and how to run it.  I do not know why, but his instructions did not work.  I also encountered the problem of imposing patches and kernel compilation errors, which had to be resolved along the way.  I also had to make changes to the configuration files of the kernel, to make changes to the kernel itself. <br><br>  However, the result is already there.  How it works in the gland: <br><br><img src="https://habrastorage.org/storage2/a54/9ed/9c9/a549ed9c9a64604bbac811f8c3891161.png"><br><br>  Using the TeraTerm terminal program, I open the COM port owned by the board and from another program of the Altera Quartus II programmer I load the HW image of the system into the FPGA.  The processor starts from the FPGA bootram and an interactive ‚Äúmonitor‚Äù appears in the terminal console.  With it, you can read or write to the memory cells, as well as download any file from the computer to the RAM of the board through the same serial port with the XMODEM protocol. <br><br>  So, I load the <i>initrd</i> at <i>0x700000</i> and load the Linux kernel itself at <i>0x80000</i> .  The command ‚Äú <i>j 80000</i> ‚Äù from the monitor console starts the kernel and you can see how it starts: <br><br><img src="https://habrastorage.org/storage2/dca/152/7bf/dca1527bf5897dd5f47f2179099e6df2.png"><br><br>  The full console output looks like this: <br><br><pre><code class="bash hljs">Linux version 2.4.27-vrs1 (nick@ubuntu) (gcc version 4.5.2 (Sourcery G++ Lite 2011.03-46) ) <span class="hljs-comment"><span class="hljs-comment">#1 Tue Jan 22 23:48:37 PST 2013 CPU: Amber 2 revision 0 Machine: Amber-FPGA-System On node 0 totalpages: 256 zone(0): 256 pages. zone(1): 0 pages. zone(2): 0 pages. Kernel command line: console=ttyAM0 mem=8M root=/dev/ram 19.91 BogoMIPS (preset value used) Memory: 8MB = 8MB total Memory: 6304KB available (783K code, 222K data, 64K init) Dentry cache hash table entries: 4096 (order: 0, 32768 bytes) Inode cache hash table entries: 4096 (order: 0, 32768 bytes) Mount cache hash table entries: 4096 (order: 0, 32768 bytes) Buffer cache hash table entries: 8192 (order: 0, 32768 bytes) Page-cache hash table entries: 8192 (order: 0, 32768 bytes) POSIX conformance testing by UNIFIX Linux NET4.0 for Linux 2.4 Based upon Swansea University Computer Society NET3.039 Initializing RT netlink socket Starting kswapd ttyAM0 at MMIO 0x16000000 (irq = 1) is a WSBN pty: 256 Unix98 ptys configured Serial driver version 5.05c (2001-07-08) with no serial options enabled ttyS00 at 0x03f8 (irq = 10) is a 16450 ttyS01 at 0x02f8 (irq = 10) is a 16450 RAMDISK driver initialized: 16 RAM disks of 208K size 1024 blocksize NET4: Linux TCP/IP 1.0 for NET4.0 IP Protocols: ICMP, UDP, TCP IP: routing cache hash table of 4096 buckets, 32Kbytes TCP: Hash tables configured (established 4096 bind 8192) NET4: Unix domain sockets 1.0/SMP for Linux NET4.0. RAMDISK: ext2 filesystem found at block 0 RAMDISK: Loading 200 blocks [1 disk] into ram disk... done. Freeing initrd memory: 208K VFS: Mounted root (ext2 filesystem) readonly. Freeing init memory: 64K BINFMT_FLAT: Loading file: /sbin/init Mapping is 2b0000, Entry point is 8068, data_start is 8e4c Load /sbin/init: TEXT=2b0040-2b8e4c DATA=2b8e50-2b8e83 BSS=2b8e83-2b8e88 start_thread(regs=0x21f9fa4, entry=0x2b8068, start_stack=0x2affb4) Hello, World! Hello, Marsohod!</span></span></code> </pre> <br><br>  Perhaps the most interesting thing begins when you produce a functional simulation of the processor.  This makes it possible to "dig deeper", find out what is unavailable when you write or debug a program for a microcontroller or RaspberyPI.  Simulation of the processor allows you to consider in detail any signals inside the processor or the whole system. <br><br>  The simulation is performed using testbench.  Testbench is the same program on Verilog, only it already describes the entire system. <br><br>  For example, there is an AMBER system ported to the Mars Rover2 board.  This is the project that I compile with the help of Altera Quartus II and then the resulting image is loaded into the FPGA.  The AMBER SOC top-level module has a 100 MHz clock frequency input, TX / RX serial port input and output, as well as signals to an SDRAM memory chip. <br><br>  If you write a testbench to this system, then it should no longer have any inputs or outputs - now it will be a top-level module - a simulator of a printed circuit board with its components.  The testbench should simulate a crystal oscillator on the board, an external serial port transceiver (possibly sending commands through the port), and also simulate an SDRAM chip.  Models of memory chips can be obtained from their manufacturers.  At least Micron puts Verilog models of its memory chips into free access, where I took it (MT48LC4M16A2 chip model). <br><br>  Running a testbench in the Verilog simulator makes it possible to completely trace all the signals of the system.  It may not be easy and can be quite long.  But it is a very powerful tool. <br><br>  For example, in the simulator you can see the cycles of execution of processor commands, the contents of the registers, service signals: <br><br><img src="https://habrastorage.org/storage2/9f7/5eb/381/9f75eb3810a85a089c1c900e1ec2aae3.png"><br><br>  You can also consider the pipeline processor, see the cycles of accessing the cache or external memory, you can actually measure and see the reaction to interruptions of the processor. <br><br>  In general, you can fully simulate the test and launch of the Linux kernel. <br>  I did this in the command line console using Icarus Verilog: <br><br><img src="https://habrastorage.org/storage2/283/c58/0c0/283c580c0d1a6455d791537819f81eed.png"><br><br>  The truth in this screenshot was interrupted by the simulation at the very beginning - a complete simulation takes about an hour or even more, and if you do not do a full dump of all the signals in the VCD file.  And yes, everything is possible. <br><br>  I also dream to make my processor.  I think this experience is useful to me ... <br><br>  Useful links: <br>  1) The initial design of the system on the AMBER chip on the site <a href="http://opencores.org/">http://opencores.org</a> <br>  2) <a href="https://github.com/marsohod4you/Amber-Marsohod2">AMBER project sources for Altera Cyclone III FPGAs on GitHub</a> (my porting).  In the source, all the system code on a chip, as well as testbenches and patches for the Linux kernel.  All that is required for full reproduction of the result. <br>  3) The whole history of porting is described <a href="http://marsohod.org/index.php/prodmarsohod2/amber-arm-soc">in detail here</a> . <br>  4) <a href="http://marsohod.org/index.php/prodmarsohod2">Description and layout of the Mars Rover2 board</a> . </div><p>Source: <a href="https://habr.com/ru/post/167987/">https://habr.com/ru/post/167987/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../167977/index.html">Google has laid out the Grand Canyon panoramas</a></li>
<li><a href="../167979/index.html">NASA is testing a robot digger for exploring the moon</a></li>
<li><a href="../167981/index.html">Objective-C as the first programming language</a></li>
<li><a href="../167983/index.html">Scrum evaluation network for planning</a></li>
<li><a href="../167985/index.html">PSVita Hacking - First Steps, PSP Emulator</a></li>
<li><a href="../167989/index.html">Nokia starts work with graphene</a></li>
<li><a href="../167993/index.html">What Lebedev didn‚Äôt see, or Size, area and volume in diagrams</a></li>
<li><a href="../167995/index.html">Twitter hacked. 250k accounts at risk</a></li>
<li><a href="../167997/index.html">What does not want to remember the programmer</a></li>
<li><a href="../167999/index.html">Why do we (still) believe in remote work</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>