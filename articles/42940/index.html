<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Network Protocols Design</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I searched the articles on protocol design for habr and, to my surprise, found nothing. Perhaps it is worth then to share your thoughts on sabzh. I mu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Network Protocols Design</h1><div class="post__text post__text-html js-mediator-article">  I searched the articles on protocol design for habr and, to my surprise, found nothing.  Perhaps it is worth then to share your thoughts on sabzh.  I must say at once that the division into types is purely mine and may not coincide with what you find in reference books.  We also agree in advance that C / C ++ is used. <br><a name="habracut"></a><br><h4>  <b>Introduction</b> </h4><br>  Consider the main types of protocols: <br><ul><li>  question answer </li><li>  structures </li><li>  tags </li><li>  hybrid tags and structures </li></ul><br><h4>  <b>Question answer</b> </h4><br>  These protocols are based on communication in small portions of data.  The communication protocol is usually strongly typed.  As an example, you can bring all known AT-commands for modems. <br>  This type of protocol is the easiest to process (an elementary parsing of a string with isolation of data is required).  But to communicate with such a protocol on more or less serious tasks is not very easy.  Such protocols are well suited for sending small portions of scalar data types (strings, numbers). <br>  Nevertheless, it is also necessary to design such protocols. <br><br><h5>  Example </h5><br>  We need to transfer 10 numbers from the client to the server, and receive in response a string or a number (varies from the input data).  For this we need: the ‚Äúhandshake‚Äù stage, the data transfer stage, the answer receiving stage. <br>  <b>‚ÄúManpower‚Äù</b> : it is quite enough to send the word ‚ÄúHELLO‚Äù back and forth (if we know that there is a possibility to get to another client instead of the server, then we can separate the client and server greetings, for example, ‚ÄúHELLOCL‚Äù (from the client) and ‚ÄúHELLOSRV‚Äù (from server)).  The processing is elementary and comes down to string comparison. <br>  <b>Data transfer</b> : we take the command ‚ÄúSEND <i>x1 x2 x3 x4 x5 x6 x7 x8 x9 x10</i> ‚Äù as the sending command from the client and ‚ÄúOK SEND‚Äù as the server response.  The processing is again elementary and comes down to string comparison and calling sscanf (). <br>  <b>Receiving the answer</b> : let's agree that the server sends an ‚ÄúANSWER STR <i>string</i> ‚Äù (if the answer is a string) or an ANSWER NUM <i>number</i> (if the answer is a number).  The client responds with the ‚ÄúOK ANSWER‚Äù command. <br><br>  It would seem that everything is simple and clear.  BUT.  After all, this way we will not be able to understand to which set of numbers the answer sent belongs.  To solve this problem is simple.  When sending data, we will use the commands: ‚ÄúSEND <i>id</i> NUMS <i>x1 x2 x3 x4 x5 x6 x7 x8 x9 x10</i> ‚Äù and ‚ÄúOK SEND <i>id</i> ‚Äù, where id is the unique identifier for this set of numbers.  When responding, the commands will be as follows: ‚ÄúANSWER <i>id</i> STR <i>string</i> ‚Äù, ‚ÄúANSWER <i>id</i> NUM <i>number</i> ‚Äù, ‚ÄúOK ANSWER <i>id</i> ‚Äù.  Such a protocol will already be exhaustive in most cases. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  <b>Structures</b> </h4><br>  This type of protocol is the most common.  Its basis is hard typing of a portion of the sent data.  That is, we predetermine in advance that in all packets at such a displacement and such a length such and such data will lie (the displacement and length of some fields can also be specified in the structure, but mainly the initially specified displacements are used).  These protocols are almost all low-level protocols. <br>  The undoubted advantage of such protocols (especially under the condition of rigidly specified displacements and lengths of all fields) is the extreme simplicity of processing.  We just need to check the size and execute the memcpy () command into an instance of the structure corresponding to our package. <br>  When designing such protocols, it is necessary to remember about the features of storing structures in C. I mean what is called packing.  The fact is that any instance of any structure must be aligned in memory with a certain multiplicity (the multiplicity is set for the whole program alone).  By default, the multiplicity is 4 (I do not advise changing it, since this value strongly influences, for example, std namespace).  This means that the size of any structure will always be a multiple of 4 (if the size of the structure was 14, then 2 meaningless bytes will be added to the end and the size will be equal to 16).  Therefore, we need to take care of the same value of this parameter on the server and client. <br>  Also, the main error in designing such protocols is inattention to storing multibyte types in memory.  It must be remembered that x86 stores them in the form of little-endian (from the youngest to the oldest), and according to the standards of network protocols and for example in SPARC computers it is necessary to store them in the form of big-endian (from the older to the youngest).  Thus, we need to know in what order multibyte types will come to us and, if necessary, turn them over.  Moreover, if we need high speed, we have a large flow of exchanged data and we cannot get away from rotations (for example, criteria are important when developing a cross-architectural system of distributed computing), then it is necessary to give the function of turning extra half an hour, but write it as fast as possible.  In such cases, the standard htonl (), ntohl () may not be in time. <br><br><h4>  <b>Tags</b> </h4><br>  I now refer to tag protocols as fashionable XML-like protocols.  Although such protocols are extremely redundant, they are nevertheless easily processed and are completely flexible.  Their main problems are redundancy and not very high processing speed. <br>  The main mistake of designing such protocols is the desire to cram everything at once.  It is necessary as clearly as possible to formulate the requirements for the protocol and isolate the subset of functionality that is really necessary.  Such an approach to design is possible and is not very expandable, but it will allow us to save on processing time.  Moreover, with proper design of the parser module, we can reduce the problem of extensibility to a minimum (add a couple of functions and checks to the common code). <br>  To me personally (due to the specialization on speed-demanding and rigidly structured network applications), this approach seems redundant and wasteful. <br><br><h4>  <b>Tags + structures</b> </h4><br>  Perhaps the most interesting type of protocols.  Allows you to combine high parsing speed and flexibility. <br>  Packages of this protocol are divided into types.  You can also design a type subordination tree (for example, package A can only be included in package B, but cannot go separately).  The basis of such packages is a rigidly defined header structural part (for each type has its own) + non-rigid part of the data (the same approach is used in structural data with a variable length of the last parameter in the structure). <br>  Analysis of such protocols, though more difficult than the analysis of structural protocols, but easier and faster than the analysis of purely tagged protocols. <br>  Usually the type of the package is written by the first field in the header part and it is enough for us to read it and call the necessary function that will copy the header into the structure and the data into a piece of memory (usually char * is enough, but in some cases it is more convenient to copy into the array of structures immediately). <br>  The main error in the design is the desire to make "as in the tag protocol" and create a bunch of different types with small headers.  This leads to a loss of high parsing speed and negates all the advantages of this type.  Thus it is necessary to balance between slowness and slow speed.  As practice has shown, in most cases, perfect tagging is the same as breaking up into classes if this protocol were a normal data structure. <br><br>  <i>PS</i> This post is more a review than a specific implementation.  If anyone has a desire to read about some specific implementations (both well-known and designing any others), then write in the comments, I will try to write. <br></div><p>Source: <a href="https://habr.com/ru/post/42940/">https://habr.com/ru/post/42940/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../429388/index.html">How to make a redesign of the site and not to make problems: 4 important steps</a></li>
<li><a href="../429390/index.html">MIT course "Computer Systems Security". Lecture 16: "Attacks through the side channel", part 1</a></li>
<li><a href="../429392/index.html">MIT course "Computer Systems Security". Lecture 16: "Attacks through the side channel", part 2</a></li>
<li><a href="../429394/index.html">MIT course "Computer Systems Security". Lecture 16: "Attacks through the side channel", part 3</a></li>
<li><a href="../429396/index.html">How to test an application when interacting with an API using SoapUI</a></li>
<li><a href="../429400/index.html">Seals vs neural network 2. Or run SqueezeNet v.1.1 on Raspberry Zero in realtime (almost)</a></li>
<li><a href="../429402/index.html">ML.NET 0.7 (Machine Learning .NET)</a></li>
<li><a href="../429404/index.html">8 s ¬Ω ways to prioritize functionality</a></li>
<li><a href="../429406/index.html">"Monsters in games or how to create fear"</a></li>
<li><a href="../42941/index.html">Rating articles.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>