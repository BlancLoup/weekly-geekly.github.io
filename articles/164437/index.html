<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Analysis of keygenme from Ra $ cal on the basis of a virtual machine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="0. Info 
 KeygenMe page on crackmes.de 
 Crackme with simple vm. Key check algorithm is simple, so the main target is vm. 
 It is a pause to start. it...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Analysis of keygenme from Ra $ cal on the basis of a virtual machine</h1><div class="post__text post__text-html js-mediator-article"><h4>  0. Info </h4><br>  <a href="http://crackmes.de/users/racal/racal_crackme_n3_with_vm/">KeygenMe page on crackmes.de</a> <br>  Crackme with simple vm.  Key check algorithm is simple, so the main target is vm. <br>  It is a pause to start.  it looks like it‚Äôs like a regulator, registers, commands =) <br>  Good luck and have fun. <br>  Difficulty: 4 - Needs special knowledge <br>  Platform: Windows <br>  Language: C / C ++ <br><a name="habracut"></a><br>  We will start our research by viewing the code that is executed when we click the ‚ÄúCheck‚Äù button on the form.  Since CrackMe is based on the usual dialog box, we first look at its registered window function. <br><br><img src="https://habrastorage.org/storage2/54e/fac/cbf/54efaccbf229409bd04a38c67ada6054.png"><br>  <em>Figure 1. Part of the window dialog function responsible for handling WM_COMMAND.</em> <br><br>  Clicking the button causes the application to send a <b>WM_COMMAND</b> message with the ID of the element at which the event occurred.  In this case, the received values ‚Äã‚Äãare received using the <b>GetDlgItemTextA</b> API, and then the function that checks the entered values ‚Äã‚Äãis called. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/c6c/197/282/c6c197282a9bad4ea6028e5762273bac.png"><br>  <em>Figure 2. The function Check called from the window function.</em> <br><br>  Looking at the large number of NOP commands (403F3E - 4035A9 = 995h), it can be assumed that the source code of the algorithm that was chosen was originally located here, and was later jammed. <br>  The <b>sub_4017C0</b> function is a wrapper over a virtual machine call, the main loop of which is located in the <b>sub_401890</b> function <b>, the</b> pseudo-code of which is shown below. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/550/293/78b/55029378ba62d6ac7a161c7d9b799041.png" alt="sub_401890"><br>  <em>Figure 3. The main loop of the virtual machine in the sub_401890 function.</em> <br><br>  All these functions inside switch / case are command implementations. <br><br>  The virtualized code itself is stored in the .rvmpc section, starting at address 00407000. <br><br><h4>  1. Command format </h4><br>  Determining the structure of a virtual machine, determining its architecture, as well as the format of the commands it uses, is the first and most important task for code virtualization. <br>  This virtual machine is a registered virtual machine, a stack is used for temporary storage of variables. <br>  The command format of this virtual machine is not of fixed length and is rather redundant.  All types of commands have a general header of the following form: <br><table><tbody><tr><td>  Bias </td><td>  Type of </td><td>  The size </td><td>  Description </td></tr><tr><td>  +0 </td><td>  word </td><td>  2 </td><td>  operation code </td></tr><tr><td>  +2 </td><td>  dword </td><td>  four </td><td>  Team ID </td></tr><tr><td>  +6 </td><td>  byte </td><td>  one </td><td>  argument size </td></tr><tr><td>  +7 </td><td>  dword </td><td>  four </td><td>  ID of the next command </td></tr><tr><td>  + Bh </td><td>  dword </td><td>  four </td><td>  unknown </td></tr></tbody></table><br>  The ‚ÄúTeam ID‚Äù field contains a unique value for the entire bytecode.  Accordingly, to move to the next command, the virtual machine takes a value from the ‚ÄúID of the next command‚Äù field and searches in the entire code array for a command in which the ID matches the one specified.  After that, using switch / case on the value of the ‚Äúoperation code‚Äù field, each command is interpreted. <br><br>  The instruction set of the virtual machine under consideration allows operating its internal registers, native processor registers, and executing the native code. <br><br><table><tbody><tr><td>  opcode </td><td>  Act </td></tr><tr><td>  0x00 </td><td>  call </td></tr><tr><td>  0x01 </td><td>  call </td></tr><tr><td>  0x02 </td><td>  Conditional transition </td></tr><tr><td>  0x03 </td><td>  push dword </td></tr><tr><td>  0x04 </td><td>  sub / add ESP </td></tr><tr><td>  0x05 </td><td>  push dword </td></tr><tr><td>  0x06 </td><td>  mov [esp], dword </td></tr><tr><td>  0x07 </td><td>  jmp ID </td></tr><tr><td>  0x08 </td><td>  mov [ebp +?], dword </td></tr><tr><td>  0x09 </td><td>  native </td></tr><tr><td>  0x0A </td><td>  native </td></tr><tr><td>  0x0B </td><td>  - </td></tr><tr><td>  0x0C </td><td>  Modification of the internal flag dw4052AC </td></tr><tr><td>  0x0D </td><td>  - </td></tr><tr><td>  0x0E </td><td>  - </td></tr><tr><td>  0x0F </td><td>  - </td></tr><tr><td>  0x10 </td><td>  mov REGn, dword-reg / mov REGn, dword [reg + X] </td></tr><tr><td>  0x11 </td><td>  mov dword [addr], (reg / dword) / mov dword [REGn], (reg / dword) </td></tr><tr><td>  0x12 </td><td>  Various forwarding commands mov </td></tr><tr><td>  0x13 </td><td>  Various forwarding commands mov </td></tr><tr><td>  0x14 </td><td>  MOV _32 [A], unpack (REGn) </td></tr><tr><td>  0x15 </td><td>  MOV REGn, pack (_32 [A]) </td></tr><tr><td>  0x16 </td><td>  XOR _32 [A] [i], _32 [B] [j] </td></tr><tr><td>  0x17 </td><td>  mov [REGn], reg / mov reg, [REGn] </td></tr><tr><td>  0x18 </td><td>  XOR _32 [A] [c: d], _32 [B] [e: f] </td></tr><tr><td>  0x19 </td><td>  MOV _32 [A], 0 </td></tr></tbody></table>  Commands 0x14 - 0x19 work with an additional area of ‚Äã‚Äãmemory that allows performing bitwise operations on 32-bit numbers. <br><br><h4>  2. Disassembling VM Code </h4><br>  Now when we have a description of the format of commands and we know what functions they perform, it is worth writing a disassembler for this virtual machine.  Commands may not be at all like the command system of previously known architectures, so you can translate into mnemonics that you understand. <br><br>  <a href="http://narod.ru/disk/64982749001.ef47d9185ca1aaaac77ab3e27a1c0e90/vm3_disasm.zip.html">Disassembler sources using BeaEngine library (+ exe)</a> <br>  <a href="http://narod.ru/disk/64982291001.944852335ccdb348ddba40e430bf441b/disasm_log.txt.html">The disassembly command listing has made 961 lines.</a> <br><br><h4>  3. Devirtualization </h4><br>  This step is optional if the zavrutalenny code is small and you can understand the algorithm without re-encoding it into the native code.  As already mentioned above, the process of devirtualization consists in recoding the code for the virtual machine into the code for the native processor.  To do this, the disassembler instead of mnemonic virtual machine should produce one or more mnemonic native processor.  Then you should compile the resulting code.  This operation will provide support for existing tools - debuggers, decompilers, etc. <br><br>  In principle, I disassembled the algorithm at the most according to disassembler listing, but I wondered how HexRays would behave if the resulting listing was compiled into the native x86 code.  To do this, I got rid of all internal registers in command mnemonics, rewrote some of the code that works with bit values, and compiled everything in exe.  I did not achieve ideal behavior, so there are some logical errors in the decompiled code below. <br><br>  <a href="http://narod.ru/disk/64982360001.26400aabee7f12c136dfc3b60fbc4a6e/vm3.asm.html">The resulting source for x86 asm</a> <br>  The source is built using <a href="http://flatassembler.net/">FASM</a> . <br><br>  So for example a couple of commands <br><pre><code class="dos hljs">MOV REGn, EBP-x MOV reg, [REGn]</code> </pre>  turn into one <br><pre> <code class="dos hljs">MOV reg, [EBP-x]</code> </pre><br>  and commands to move in the opposite direction <br><pre> <code class="dos hljs">MOV REGn, EBP-x MOV [REGn], reg</code> </pre>  turn into <br><pre> <code class="dos hljs">MOV [EBP-x], reg</code> </pre> <br>  Most of all, the construction of the form is reduced: <br><pre> <code class="dos hljs">MOV REG9, DWORD PTR [ebp-E0] MOV eax, DWORD PTR [REG9] MOV [REG2], eax MOV _32[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-number"><span class="hljs-number">0</span></span> MOV _32[<span class="hljs-number"><span class="hljs-number">0</span></span>], unpack(REG2) XOR _32[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">7</span></span>], _32[<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>F] XOR _32[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">8</span></span>:F], _32[<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>] XOR _32[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>], _32[<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-number"><span class="hljs-number">8</span></span>:F] XOR _32[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>F], _32[<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">7</span></span>] MOV REG2, pack(_32[<span class="hljs-number"><span class="hljs-number">1</span></span>]) MOV eax, [REG2] MOV REG9, DWORD PTR [ebp-E0] MOV DWORD PTR [REG9], eax</code> </pre>  On the x86 assembly language, it will look like this: <br><pre> <code class="dos hljs">MOV eax, DWORD PTR [ebp-E0] BSWAP eax MOV DWORD PTR [ebp-E0], eax</code> </pre> <br>  Then I set the Hex-Rays plugin on the compiled EXE and get the source as in the picture below: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/676/137/8ab/6761378ab37c9b672bf62d9f8236bbae.png" alt="decompiled code"><br>  <em>Figure 4. Decompiled code rebuilt under the x86 architecture.</em> <br><br><h4>  4. Inversion of the algorithm </h4><br>  This is the saddest part of the study, because the algorithm is nothing interesting and is based on XOR and cyclic shifts. <br><br>  The key is as follows: <br>  <b>SSSS-11111111HHHHHHHH22222222 - ???</b> <br>  where: <br>  SSSS is a numerical value in a 10 numeral system; <br>  11111111, 22222222, HHHHHHHH - values ‚Äã‚Äãin the 16th numeral system; <br>  ???  - arbitrary value, arbitrary length <br><br>  Algorithm: <br><ol><li>  We count the sum of the characters of the entered name <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nLenName; i++ ) dwNameSum += name[i]</code> </pre></li><li>  Compare the value obtained with the first key block; </li><li>  We consider hash on behalf of the computer <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; nCompNameLen; j++ ) { dwHashCompName ^= j ^ szCompName[j]; dwHashCompName = __ROL__(dwHashCompName, <span class="hljs-number"><span class="hljs-number">3</span></span>); }</code> </pre></li><li>  From sections 11111111, 22222222 and HHHHHHHH we get from the binary representation (hexdec) - analogue of dwHash1, dwHash2, dwHash3. </li><li>  For each of the values ‚Äã‚Äãwe perform the operation: <br> <code>dwHashN = dwHashN xor dwHashCompName xor htonl(dwHashCompName)</code> </li> <li>  The key hash is calculated as follows: <br> <code>dwHashSerial = dwHash3 xor dwHash1 xor htonl(dwHash1) xor dwHash2 xor htonl(dwHash2) xor dwHashCompName xor htonl(dwHashCompName)</code> </li> <li>  Hash on behalf of is calculated by the algorithm: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( idx = <span class="hljs-number"><span class="hljs-number">0</span></span>; idx &lt; nLenName; idx++ ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( idx % <span class="hljs-number"><span class="hljs-number">2</span></span> ) dwHashName ^= <span class="hljs-number"><span class="hljs-number">0x4F620AEC</span></span> ^ (idx + dwHash1) ^ szName [idx]; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> dwHashName ^= <span class="hljs-number"><span class="hljs-number">0x4F620AEC</span></span> ^ (dwHash2 - idx) ^ szName[idx]; dwHashName = __ROL__(dwHashName, idx); }</code> </pre></li></ol><br>  All we need to do is to randomly generate 2 values ‚Äã‚Äãfor blocks 1 and 2. Then consider dwHashName and dwHashSerial, taking dwHash3 equal to 0. And it remains only to calculate the missing value using the formula <code>dwHash3 = dwHashName ^ dwHashSerial</code> <br><br>  And of course the result of the whole study: <br><br><img src="https://habrastorage.org/storage2/c2f/e1e/733/c2fe1e7332892ce9adae122f8dce21a1.png"><br><br>  <a href="http://narod.ru/disk/64982721001.4ace869659c128e3dfb58b46955d39b1/vm3_keygen_wnd.zip.html">Download EXE and keygen sources</a> <br><br>  PS Yandex burns somehow direct links, so if it shows 404, open links in a new tab. </div><p>Source: <a href="https://habr.com/ru/post/164437/">https://habr.com/ru/post/164437/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../164425/index.html">Munchhausen Style, or one abnormal way to run Java programs on Android</a></li>
<li><a href="../164427/index.html">LED standby lighting</a></li>
<li><a href="../164431/index.html">Happy New Year! or Demoscene on the calculator</a></li>
<li><a href="../164433/index.html">jQuery inside - introduction</a></li>
<li><a href="../164435/index.html">Why Facebook offers are not in a hurry to blow up the news feed?</a></li>
<li><a href="../164439/index.html">Universal C # code under .NET and JavaScript</a></li>
<li><a href="../164441/index.html">Christmas app on Android</a></li>
<li><a href="../164443/index.html">Correct ajax requests in Drupal 7</a></li>
<li><a href="../164445/index.html">Cfengine3 - configuration management system</a></li>
<li><a href="../164447/index.html">Will the base break if the server is pulled out of the socket, or DB ORACLE giblets for dummies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>