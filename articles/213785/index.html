<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Duplicate code search plugin for QtCreator</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Duplicate code makes it difficult to make changes, understanding the source texts and their further maintenance. In order to avoid duplication, as wel...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Duplicate code search plugin for QtCreator</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/592/0c6/31d/5920c631d41cfd45d0f5b418c9dc5c19.png" alt="image"></div><br>  Duplicate code makes it difficult to make changes, understanding the source texts and their further maintenance.  In order to avoid duplication, as well as to assess the quality of the code and its refactoring, some IDEs have built-in tools for searching for duplicate code fragments.  Plugins are written for other IDEs.  However, for the QtCreator development environment, to date, there has been no built-in tools or duplicate search plug-ins. <br>  The article describes two solutions to the problem of automatically finding duplicates in this IDE: using the integration tool of third-party utilities and using the developed plugin, which I hope will be useful for C ++ programmers using QtCreator. <br><a name="habracut"></a><br><h4>  1 Integration of a third-party repeater code search utility </h4><br>  The integration mechanism of third-party utilities is a powerful means of expanding QtCreator functionality.  The configuration process is described in detail in the <a href="https://qt-project.org/doc/qtcreator-2.6/creator-editor-external.html">manual</a> .  The <a href="http://www.harukizaemon.com/simian/">simian - Similarity Analyzer</a> console utility was selected as a duplicate search tool, which will also be used in the plugin.  To integrate it into QtCreator, you must perform the following steps: <br>  1. Install the application. <br>  Windows: <br>  For Windows-based systems, we will use an exe-application ( <a href="http://www.harukizaemon.com/simian/get_it_now.html">download page from the author‚Äôs website</a> . We will unpack the archive with the application in the directory you need (for example, D: / Development / Simian). <br>  Unix-based: <br>  To run on Unix systems (supporting JRE), simian is also implemented as a Java application.  For some Unix systems, simian can be installed from package systems (for example, <a href="https://aur.archlinux.org/packages/simian/">for Arch Linux</a> ).  If there is no package for this application in the system, then you need to download the archive with the application <a href="http://www.harukizaemon.com/simian/get_it_now.html">by reference</a> , unpack it into the necessary directory (for example / usr / share / java / simian /), then create the file "simian "Containing the application startup script: <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash java -jar /usr/share/java/simian/simian.jar $@</span></span></code> </pre> <br>  In conclusion, this file must be set to execute permissions. <br>  2. Adding an external utility (external tool) to QtCreator <br>  On the <i>External Tools</i> tab of the <i>Environment</i> settings section, we add a new category and the utility ( <i>Add Category, Add Tool</i> ), an example is shown in the screenshot below. <br><br><div style="text-align:center;"><img width="750" src="https://habrastorage.org/getpro/habr/post_images/dfd/a64/e78/dfda64e7814ae7b98855940780ebbf7d.png"></div><br>  In the <i>Executable</i> field, specify the path to the executable file of the program (or in the case of Unix-based systems, enter ‚Äúsimian‚Äù), in the <i>Arguments</i> field, specify the launch arguments: <br><blockquote>  -failOnDuplication- -includes = ** / *. cpp -includes = ** / *. h -includes = *. cpp -includes = *. h </blockquote><br>  In the <i>Working Directory</i> field, specify the directory template of the current project: <br><blockquote>  % {CurrentProject: Path} </blockquote><br>  With these settings, the utility will search for repetitions in all files with the .cpp and .h extension in the project directory and all subdirectories. <br>  Now there is a new tab in the External Tools menu. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ac5/03a/a4f/ac503aa4f97fd321ffd714ba5d2d579b.png"></div><br>  When the <i>Check</i> menu item is selected, the <i>simian</i> utility is <i>launched</i> and its output is redirected to the message panel, and information about duplicates found (number, files, lines) is displayed.  If used in the launch arguments option <blockquote>  -reportDuplicateText + </blockquote>  then duplicate code will be output.  A complete list of <i>simian</i> launch <i>options</i> can be found <a href="http://www.harukizaemon.com/simian/features.html">at</a> . <br>  But this solution only automated the utility launch.  It was necessary to open files with repetitions and search for the necessary lines "manually".  But I wanted it to be like in other plugins and IDE: double clicking on the record opens the source file, goes to the necessary line and the text of the repetition is highlighted.  Then it was decided to write a plugin. <br><br><h4>  2 Duplicate code search plugin for QtCreator </h4><br>  I didn‚Äôt have experience of developing plug-ins and the <a href="http://habrahabr.ru/post/101311/">Ttdo Plugin for QtCreator</a> and the <a href="http://habrahabr.ru/post/135289/">System of Extensions Qt Creator</a> provided indispensable help.  I found the code for opening a file in the editor and switching to the right line in the ToDo plug-in source code.  In general, with the documentation on writing plugins for QtCreator, things are pretty bad.  It took a relatively long time to look for a solution to the task of highlighting the replay text.  The answer is found in the source code of the plug-in to assess the degree of coverage with <a href="https://github.com/3Hren/QtCreatorCoveragePlugin/wiki">Code Coverage</a> tests.  In my opinion, in writing a plugin for QtCreator, the main help is the study of source codes.  The <a href="http://qt-project.org/wiki/Qt_Creator_Plug-in_Gallery">plugin gallery on the Qt Project website</a> contains links to most third-party plug-ins.  Unclear questions can also be asked in the # qt-creator irc channel on freenode.net.  If you have an idea for a plugin, be sure to try to implement it.  Writing plugins is an exciting experience. <br><br><h5>  2.1 Building and Installing the Plugin </h5><br><h6>  2.1.1 Getting sources and building QtCreator </h6><br>  We will need the QtCreator sources for building both the IDE itself and the plug-ins for it.  It also assumes that you have already installed Qt, QtCreator and all the necessary system variables are configured.  The procedure for getting sources and builds is described in detail in <a href="http://qt-project.org/wiki/Building-Qt-Creator-from-Git">Building Qt Creator from git</a> .  After successfully completing this step, we will have 2 directories: qt-creator, in which the sources are located and qt-creator-build, where the assembled QtCreator is located. <br>  <u>A small digression:</u> <br>  Thus, we will now have two QtCreator - one of the installed Qt distribution (we will call it ‚Äúinstalled‚Äù) and one - assembled from source (let's call it ‚Äúassembled‚Äù).  At once I will make a reservation that in the future we will assemble the plugin for the ‚Äúassembled‚Äù creator.  The fact is that if you try to use the binary files of the plugin compiled for a newer version of QtCreator (obtained from the sources), then an error in resolving dependencies will occur. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b40/ef9/3d7/b40ef93d71a0c7728b2ab3c585c5b657.png"></div><br>  In this case, the <i>Core</i> and <i>ProjectExplorer</i> plugins should have the same version as QtCreator.  Also note that QtCreator from the distribution is built using <i>Microsoft Visual Studio C ++ compiller</i> .  Thus, to build a plugin for QtCreator installed along with Qt, you need to get the QtCreator source code of a specific revision (the <i>FromRevision</i> line in the About window), you also need the Qt version for MSVC.  I will not further describe the QtCreator build compiled by the MSVC compiler and assume that you will build (and continue to use in the work) the latest QtCreator version from source.  If you are developing a plugin, you will also need two QtCreator assemblies (not necessarily different as above, you can have two of the same).  In one, a plugin is developed and assembled, and in another it is copied and tested.  Hint: when developing a plugin, when it comes together in the window that appears, select the exe file of QtCreatora, in which the plugin is tested, then QtCreator with the plugin will start automatically. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8db/bca/955/8dbbca95549c21d0679caea913c43fa8.jpg"></div><br>  However, let's go back to the plugin. <br><br><h6>  2.1.2 Getting the sources and building the Simian plugin </h6><br>  Sources of the developed plugin are located on Sourceforge.net: <a href="http://sourceforge.net/projects/simianplugin/">QtCreator Similarity Analysis Plugin</a> .  You can download the archive with source codes or download them from the git-repository.  After that, open the project (simian.pro) in the ‚Äúinstalled‚Äù QtCreator.  In the project file simian.pro you will need to change two lines indicating the path to the source directory and the QtCreator build on your computer: <br><pre> <code class="cpp hljs">#<span class="hljs-meta"><span class="hljs-meta"># set the QTC_SOURCE environment variable to override the setting here QTCREATOR_SOURCES = $$(QTC_SOURCE) isEmpty(QTCREATOR_SOURCES):QTCREATOR_SOURCES=D:/Sources/QtCreator/qt-creator ## set the QTC_BUILD environment variable to override the setting here IDE_BUILD_TREE = $$(QTC_BUILD) isEmpty(IDE_BUILD_TREE):IDE_BUILD_TREE=D:/Sources/QtCreator/qt-creator-build</span></span></code> </pre><br>  Alternatively, set the system variables <i>QTC_SOURCE</i> and <i>QTC_BUILD</i> . <br><br>  We compile the release version of the plugin (Ctrl + R), which after the successful build phase is copied to <br><blockquote>  D: \ Sources \ QtCreator \ qt-creator-build \ lib \ qtcreator \ plugins \ SnaSoftware </blockquote><br>  The following line in the project file <i>simian.pro</i> is responsible for copying the plugin to the <i>SnaSoftware</i> folder. <br><blockquote>  PROVIDER = SnaSoftware </blockquote><br>  In this case, ‚ÄúProvider‚Äù is set to ‚Äúplugin provider‚Äù.  If you comment out this line, the plugins will be copied to the ‚ÄúQtProject‚Äù directory, which in my opinion is not entirely correct (plugins that are part of QtCreator are located in this directory).  Therefore, my nickname on Habr√© is used as the <i>PROVIDER</i> value. <br>  Now you can try the plugin in action. <br><br><h5>  2.2 Using the plugin </h5><br><h6>  2.2.1 Initial Setup and Startup </h6><br>  Before setting the plugin on the folders with your projects in the settings, you must specify the path to the executable file of the <i>simian</i> utility. <br>  In <u>Windows,</u> to do this, in the settings dialog ( <i>Tools-&gt; Options</i> ) in the <i>Simian</i> section that appears, select the utility exe file using the file selection dialog ( <i>Browse</i> button <i>...</i> in the <i>Simian Executable Path area</i> . You can also enter the path to the program directory simian into the system variable PATH, then in the <i>Executable</i> field you can simply specify the name of the exe-file without an extension (for example, for convenience of running in the console, I renamed the file <i>simian-2.3.34.exe</i> to <i>simian.exe</i> , included the path to the program to the <i>PATH</i> variable and text field using <i>simian</i> text). <br>  For <u>Unix-based</u> systems, if you have already completed the steps to install the simian utility from section 1, you will also need to simply enter the name of the executable script <i>‚Äúsimian‚Äù</i> (I remind you that it should be located in the PATH directory). <br>  After saving the settings (the <i>Ok</i> or <i>Apply</i> button), the plugin can be used.  To do this, open an existing or create a new project and start the search for repetitions.  Starting a search is performed either by selecting the <i>Tools-&gt; Find similarities</i> menu item that appears after installing the plug-in or by clicking a button on the tab of the <i>Simian</i> panel.  If you do not make changes in the application settings, then it starts with the default settings. <br>  To check the operation of the plugin, we will create a new QI GUI project, in the header file of which we will declare 2 functions and in their implementation we will write the same code consisting of 6 (as the default <i>Threshold</i> setting value is 6) of the same lines of code, for example: <br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> one; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> two; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> three; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> four; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> five; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> six;</code> </pre><br>  Now select the <i>Tools-&gt; Find similarities</i> action in the QtCreator menu (the created project must be active).  After analyzing the sources, the Output Panel will display the output panel, in which there will be links to files in which repetitions are found, by clicking on which these files will open in the editor, and repetition fragments will be highlighted in color: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6c6/125/7b7/6c61257b7a82060c3bdda59f60c81d2a.jpg"></div><br>  The plugin allows you to search not only for the exact correspondences of the fragments, but also to recognize variations of different kinds in fragments.  To do this, you need additional settings for the search for duplicate code. <br><br><h6>  2.2.2 Advanced Setup </h6><br>  Settings for duplicate code search are in the <i>Simian Behavior</i> group: <br><div style="text-align:center;"><img width="700" src="https://habrastorage.org/getpro/habr/post_images/f7a/eb3/74f/f7aeb374f5f6350a71a1ddbff58af968.png"></div><br>  When you change the settings in the <i>Options</i> dialog box and then save them in the current project directory, a text file of settings <i>simian.ini is created</i> .  If the current project uses default settings, this file is not created.  Although this approach adds one extra file to the project directory, it solves the problem of portability of settings by simple copying (the next time you open the settings window, the plugin checks for the presence of this file and loads the settings from it, or loads the default settings if there is no such file). <br>  The plugin allows you to customize the severity of the search.  Very rarely the copied text remains unchanged in the future: the values ‚Äã‚Äãof strings, numeric constants, variable names are modified.  However, the structure of the code usually remains unchanged.  The optimal settings for a specific project or quality requirements (admissible repeatability) of a code can be determined by changing the options, with settings with the minimum Threshold value (2 lines) and all included options (which allows for searching for repetitions the variation of constant values, identifiers and others), and on the other - with the most acceptable <i>Threshold</i> value and disabled settings options (which corresponds to the exact syntactic coincidence of the code so that it is considered a repetition).  The options used and their description are presented in the table: <br><table><tbody><tr><th>  Option </th><th>  Description </th></tr><tr><td>  Threshold </td><td>  How many lines must match to repeat a fragment (from 2 to 99). </td></tr><tr><td>  Ignore character case </td><td>  Compare case-insensitive constants ('A' is equivalent to 'a') </td></tr><tr><td>  Ignore characters </td><td>  Fully ignore character constants ('A' is equivalent to 'Z') </td></tr><tr><td>  Ignore string case </td><td>  Compare strings without case ("foo" is equivalent to "FOO") </td></tr><tr><td>  Ignore strings </td><td>  Ignore the contents of the lines ("foo" is equivalent to "bar") </td></tr><tr><td>  Ignore numbers </td><td>  Ignore the value of numeric constants (1 is equivalent to 2.5) </td></tr><tr><td>  Ignore identifier case </td><td>  Compare case-less identifier names (int foo; equivalent to int FOO;) </td></tr><tr><td>  Ignore identifier case </td><td>  Ignore identifier names (int foo; equivalent to int bar;) </td></tr><tr><td>  Ignore modifiers </td><td>  Ignore modifiers (public, private, static, etc) </td></tr><tr><td>  Ignore curly braces </td><td>  Ignore braces </td></tr><tr><td>  Ignore overlapping blocks </td><td>  Ignore overlapping blocks </td></tr><tr><td>  Balance square brackets </td><td>  Include square brackets when line wrapping </td></tr><tr><td>  Balance parentheses </td><td>  Consider parentheses when moving lines </td></tr></tbody></table><br>  Of the presented settings, I was not entirely clear to me: <i>Ignore overlapping blocks</i> , <i>Balance square brackets</i> and <i>Balance parentheses</i> , so I will allow myself to leave their understanding of the reader as a home task. <br><br><h4>  Conclusion </h4><br>  In programming, as well as in any professional activity, it is always necessary to develop.  At the same time, in my opinion, it is worthwhile not only to learn new technologies, design patterns or programming techniques, but also to improve your instrumental tools.  Sometimes it is enough to look at your favorite IDE and compare it with another (even if intended for another programming language).  Having noticed for yourself a new and interesting functionality, it is probably worth looking for it among existing plug-ins, but something you might want to implement yourself.  Hopefully, over time, there will be good documentation on the QtCreator plugin system and then we will have even more convenient and useful tools at our disposal.  In the next article I will try to make a review of the most interesting and useful of existing plug-ins (which I met while writing the plug-in described above). <br>  <u>Plans for the development of the plugin:</u> <br>  1. Build and test the plug-in under Unix-based systems.  The article describes only the order of action for Unix-systems, which "in theory" should work, but in practice has not been tested. <br>  2. Expansion of the interface functionality (the ‚Äúminimize-expand list‚Äù buttons, ordering by the number of files / rows of repetitions, setting the text selection color in the settings, etc.). <br>  3. Adding the generation of the html file with the inspection report. <br>  4. Adding other duplicate code search utilities with a choice of used ones. <br><br>  All requests, comments and error messages please write either in <a href="http://sourceforge.net/p/simianplugin/tickets/">the ticket system</a> , or in the section of the <a href="http://sourceforge.net/p/simianplugin/discussion/features-bugs/">Feature Request / Bug Report</a> forum. <br>  UPD: brought the screenshot and text of the test case in accordance with the text of the article (see the discussion in the comments) </div><p>Source: <a href="https://habr.com/ru/post/213785/">https://habr.com/ru/post/213785/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../213771/index.html">STM32 - correctly use the built-in flash</a></li>
<li><a href="../213773/index.html">VkInviter - inviting assistant administrator of VKontakte groups</a></li>
<li><a href="../213775/index.html">Writing a driver for an LCD display under embedded linux</a></li>
<li><a href="../213779/index.html">Reverse side of freedom of freelancing</a></li>
<li><a href="../213783/index.html">Hacking accounts through the form and event. "XSS" to avoid confusion with cascading style sheets</a></li>
<li><a href="../213787/index.html">The harsh life of a game tester</a></li>
<li><a href="../213789/index.html">Humidity Controller Atmega328</a></li>
<li><a href="../213791/index.html">Valentine's day gift for 4 nights and 1 day</a></li>
<li><a href="../213795/index.html">SmartWatch for Vasya Engineer</a></li>
<li><a href="../213797/index.html">We program robots on Windows 8. Sphero magic ball</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>