<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Parsing 0.5Tb xml in a few hours. Search for organizations in the open data of the register of SMEs of the Federal Tax Service</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="By occupation (process automation and development of information systems architecture), one often encounters the need to write a script and get the re...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Parsing 0.5Tb xml in a few hours. Search for organizations in the open data of the register of SMEs of the Federal Tax Service</h1><div class="post__text post__text-html js-mediator-article">  By occupation (process automation and development of information systems architecture), one often encounters the need to write a script and get the result ‚Äúhere and now‚Äù for an unexpectedly ‚Äúarrived‚Äù task in a situation when there is no possibility to promptly involve external developers. <br><br>  The solution to one of these problems will be devoted to the review  At some point, it became necessary to analyze the dynamics by months of the number of organizations of a certain type of activity, namely, agricultural enterprises, based on the open data of the ‚ÄúUnified Register of Small and Medium-Sized Enterprises‚Äù of the Federal Tax Service  The approaches that were used to solve it, I hope, will be useful to those who are looking for options for processing large structured XML data sets, but common processing tools such as SelectFromXML, online XML processors are not suitable for some reason.  Either the functionality is limited, or there are problems when working with Cyrillic encoding, or the required performance is not provided, or the resources of hardware are limited.  Programmers and professionals I hope I will not be too strict about the style of coding and the choice of methods of implementation, and criticism and advice in the comments are welcome. <br><br>  So the task: <br><a name="habracut"></a><br>  As of February 2018, the SME registry contains 18 zip archives with a size of 3-4Gb.  Each archive contains about 5-6 thousand files containing information about approximately 6 million organizations, totaling about 40Gb.  From this array, it is required to select only those belonging to agricultural enterprises and to analyze the dynamics of the number of these enterprises by months. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The source files of the FTS are posted <a href="https://www.nalog.ru/opendata/7707329152-rsmp/">on the link</a> <br><br>  Description files of organizations contain the following structure: <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"VO_RRMSPSV_0000_9965_20170110_01b07970-41d2-4d1e-bb80-0abee395d333"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"4.01"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"900"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"-"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"-"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"4e28d9a9-c004-0f72-a27d-7d677620df81"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"10.01.2017"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"01.08.2016"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"636204531704"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"63"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"42.21"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"      , "</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2014"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"52.21.2"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" ,    "</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2014"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"74.30"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"     "</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2014"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"63.91"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"  "</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2014"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"95.23"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"      "</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2014"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"42.21"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"      , "</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2014"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"62.09"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">",        , "</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2014"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"25.72"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"   "</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2014"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"47.54"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"      "</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2014"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"42.22.1"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"     "</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2014"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"47.99"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"    , , "</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2014"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"82.19"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"              "</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2014"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"49.32"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" "</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2014"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"42.22.2"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"     "</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2014"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"7a14e521-68a3-9514-7540-04cb03799ac4"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"10.01.2017"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"10.09.2016"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"636204538611"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"63"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"47.11"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"    ,  ,      "</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2014"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"47.25.12"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"     "</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2014"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ad8636bb-78c3-763c-52d2-4fe5a93e9a8f"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"10.01.2017"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"10.09.2016"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"636204540794"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"63"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"47.41"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"  ,          "</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2014"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"49.20.9"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"  "</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2014"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"47.78"</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"     "</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2014"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Processing will be performed in the bash shell on a Linux virtual machine with 2 cores, 8 Gb of RAM and 100Gb of disk space: <br><br><pre> <code class="bash hljs">%Cpu0 : 6.1 us, 2.0 sy, 0.0 ni, 91.8 id, 0.0 wa, 0.0 hi, 0.0 si, 0.0 st %Cpu1 : 54.1 us, 11.2 sy, 0.0 ni, 6.1 id, 28.6 wa, 0.0 hi, 0.0 si, 0.0 st KiB Mem : 8258760 total, 64684 free, 5645284 used, 2548792 buff/cache KiB Swap: 2129916 total, 1157076 free, 972840 used. 2271428 avail Mem</code> </pre><br>  The script should provide for downloading zip archives from the FTS website, renaming files for further processing, unpacking, processing with a parser (using xmlstarlet) to search for organizations that meet the criteria specified in the script, clearing the disk from temporary files (during processing, the source files take dozens of Gb ), saving in a format convenient for later use in data analysis systems and import into spreadsheet programs (in our case, the csv format will be used). <br><br>  Download and rename will be done using wget.  In order for the script to understand which archives with RMSP to process it, we will create a file under the conditional name ‚Äúflight mission‚Äù, where we will indicate which files to process and how to name the result obtained. <br><br>  The configuration file has the following structure: <br>  A link to the file, the name of the resulting file, a mark about the need to process '*' (in cases where it is necessary to download not the entire set of files). <br><br>  rmspfiles.txt <br><br><pre> <code class="html hljs xml">http://data.nalog.ru/opendata/7707329152-rsmp/data-08262016-structure-08012016.zip;20160826;* http://data.nalog.ru/opendata/7707329152-rsmp/data-09102016-structure-08012016.zip;20160910;* http://data.nalog.ru/opendata/7707329152-rsmp/data-10102016-structure-08012016.zip;20161010;* http://data.nalog.ru/opendata/7707329152-rsmp/data-11252016-structure-08012016.zip;20161125;* http://data.nalog.ru/opendata/7707329152-rsmp/data-12122016-structure-08012016.zip;20161212;* http://data.nalog.ru/opendata/7707329152-rsmp/data-01112017-structure-08012016.zip;20170111;* http://data.nalog.ru/opendata/7707329152-rsmp/data-02102017-structure-08012016.zip;20170212;* http://data.nalog.ru/opendata/7707329152-rsmp/data-03102017-structure-08012016.zip;20170310;* http://data.nalog.ru/opendata/7707329152-rsmp/data-04102017-structure-08012016.zip;20170410;* http://data.nalog.ru/opendata/7707329152-rsmp/data-05102017-structure-08012016.zip;20170510 http://data.nalog.ru/opendata/7707329152-rsmp/data-11062017-structure-08012016.zip;20170611 http://data.nalog.ru/opendata/7707329152-rsmp/data-07102017-structure-08012016.zip;20170710 http://data.nalog.ru/opendata/7707329152-rsmp/data-08102017-structure-08012016.zip;20170810 http://data.nalog.ru/opendata/7707329152-rsmp/data-09112017-structure-08012016.zip;20170911 http://data.nalog.ru/opendata/7707329152-rsmp/data-10102017-structure-08012016.zip;20171010 http://data.nalog.ru/opendata/7707329152-rsmp/data-11102017-structure-08012016.zip;20171110 http://data.nalog.ru/opendata/7707329152-rsmp/data-12112017-structure-08012016.zip;20171211 http://data.nalog.ru/opendata/7707329152-rsmp/data-01112018-structure-08012016.zip;20180111</code> </pre><br>  Upon completion of the download with renaming, a cycle is started on the archives received: unzip, search XML for the necessary records, write the result to csv files.  Before processing the next archive, the disk space of the source files is cleared. <br><br>  Despite the simplicity of the task, the script went through stages of debugging and improvement turned out to be quite intricate. <br><br>  So, what happened in the end: <br><br>  File Downloader: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # **************** batch downloader from rmsp v 1.0. 2018-02-15 *********************** start=`date +%s` dt=`date` logFn='output_wget.log' printf "********************************************************************************************\n" | tee tmp_output.log echo "* ${dt} wget *" | tee -a tmp_output.log printf "*********************************************************************************************\n\n" | tee -a tmp_output.log # download loop      ‚Äú ‚Äù,      zip2 IFS=';' while read line; do read -r -a array &lt;&lt;&lt; "$line" echo "${array[0]} | ${array[1]} " # wget ${array[0]} -O ./zip2/${array[1]}.zip | tee -a tmp_output.log 2&gt;&amp;1 # get filesize of external -          FILESIZE=$(wget --spider ${array[0]} 2&gt;&amp;1 | awk '/Length/ {print $2}') # - c - continue, 3&gt;&amp;1 -   wget -c ${array[0]} -O ./zip2/${array[1]}.zip 3&gt;&amp;1 | tee -a tmp_output.log end=`date +%s`; runtime=$((end-start)); dt=`date '+%Y-%m-%d %H:%M:%S'` printf "%s %4d sec %10d %s [ %s" ] ${dt} $runtime $FILESIZE ${array[0]} ${array[1]} | tee -a tmp_output.log done &lt; rmspfiles.txt echo "" | tee -a tmp_output.log //        cat tmp_output.log $logFn &gt; tmp_output2.log; mv tmp_output2.log $logFn</span></span></code> </pre><br>  2. Parser <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # 2018-02-16  1.1      # 2018-02-19           excell # 2018-02-19  sed   /n -&gt; ; @@; -&gt; \n #     #       (   ) sp=' ' #   ,      ,     . path_src="./src" path_zip="./zip2" path_res="./res" t1="p1.log" t2="p2.log" t3="parsz.log" fnExt=""$1 start=`date +%s` dt=`date '+%Y-%m-%d %H:%M:%S'` #     echo "**** | parsz | ${dt} unzip from: $path_zip/$fnExt.zip to $path_src/$fnExt" # | tee $t1 # -q quiet mode (-qq =&gt; quieter) # -o overwrite files WITHOUT prompting # -j junk paths. The archive's directory structure is not recreated; all files are deposited in the extraction directory (by default, the current one). unzip -j -q -o $path_zip/$fnExt.zip -d $path_src/$fnExt/ end=`date +%s` runtime=$((end-start)) MOREF1=`ls "$path_src/$fnExt/" | wc -l` echo " ${dt}, $runtime sec [${MOREF1}] | files from: $path_src/$fnExt/ to $path_res/$fnExt.csv" | tee -a $t1 echo "$sp \ $sp \ $sp \ $sp  ( )\ $sp\ $sp\ $sp\ $sp\ $sp\ $sp\ $sp\ $sp\ $sp\ $sp\ $sp@@\ " &gt; $path_res/res-$fnExt.csv /usr/bin/find $path_src/$fnExt/ -name "*.xml" | xargs -n1 xmlstarlet sel -T -f -t -m "///[contains(@,'')]" \ -v "@" -o "$sp" \ -v "@" -o "$sp" \ --if "../@=1" -o "" --else --if "../@=2" -o "" --else -o "" --break --break -o "$sp" \ --if "../@ = 1" -o "" --else -o "" --break -o "$sp[" \ -v "..///@" -o "]" \ -v "..///@" -o "$sp" \ -v "..///@" -o "$sp" \ -v "..///@" -o "$sp" \ -v "..///@" -o "$sp" \ -v "..///@" -o "$sp" \ -v "..///@" -o "$sp" \ -v "..///@" -o "$sp" \ -v "..///@" -o "$sp" \ -v "../@" -o "$sp" \ -v "../@" -o "$sp" \ -v "..//@" -o "$sp" \ -o "$fnExt@@" \ -n &gt;&gt; $path_res/res-$fnExt.csv end=`date +%s` runtime=$((end-start)) dt=`date '+%Y-%m-%d %H:%M:%S'` echo " ${dt}, $runtime sec :parsing" | tee -a $t1 #           sed -e ':a;N;$!ba;s/\n/;/g' $path_res/res-$fnExt.csv &gt; $path_res/sed_tmp.csv sed -e 's/@@;/\n/g' $path_res/sed_tmp.csv &gt; $path_res/res-$fnExt.csv end=`date +%s` runtime=$((end-start)) dt=`date '+%Y-%m-%d %H:%M:%S'` echo " ${dt}, $runtime sec :sed " | tee -a $t1 cat $t1 $t3 &gt; $t2; mv $t2 $t3 #   XML  rm -rf $path_src/$fnExt/* echo "  XML  rm -rf $path_src/$fnExt/*" rm $t1</span></span></code> </pre><br>  The entire data array of 18 files totaling hundreds of Gb is processed in about 6 hours. <br>  The processing process is recorded in files for further debugging and script optimization. <br><br>  After importing to MS Excel, we get the following result: <br><br><img src="https://habrastorage.org/webt/zh/zx/ah/zhzxahtref6lnv6gdt3jg7husge.png"></div><p>Source: <a href="https://habr.com/ru/post/358654/">https://habr.com/ru/post/358654/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358642/index.html">Redesign with a capital letter: we are studying the restart of Smashing Magazine in 2017</a></li>
<li><a href="../358644/index.html">Custdev from Support</a></li>
<li><a href="../358646/index.html">Security Week 17: Rise of the Machines</a></li>
<li><a href="../358648/index.html">How we invented the OTDR</a></li>
<li><a href="../358650/index.html">The mechanism of Arbitrary Code Guard (ACG) on the example of Microsoft Edge</a></li>
<li><a href="../358656/index.html">Welcome to Java Meetup at Raiffeisenbank UPD Broadcast</a></li>
<li><a href="../358658/index.html">Creating Destructive Meshes</a></li>
<li><a href="../358660/index.html">Open broadcast of the main hall of HolyJS</a></li>
<li><a href="../358662/index.html">Safe car sharing: components, main problems and Yandex competition</a></li>
<li><a href="../358664/index.html">Correction of typos, side view</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>