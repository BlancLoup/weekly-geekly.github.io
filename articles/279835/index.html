<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>AES encryption and Android client</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As they say, nothing foreshadowed trouble. The mobile client was slowly sawed, the coffee was dry, the puzzles were closed one by one, until suddenly ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">🔎</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">📜</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">⬆️</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">⬇️</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>AES encryption and Android client</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/970/258/dff/970258dff62e49218322e7b19807cddf.jpg"><br><br>  As they say, nothing foreshadowed trouble.  The mobile client was slowly sawed, the coffee was dry, the puzzles were closed one by one, until suddenly a letter arrived at the corporate email: <br><br>  <i>Urgently introduce new functionality.</i>  <i>All the necessary parameters for building a business model, for security purposes, will be transmitted in encrypted form <b>AES / CBC / PKCS5Padding</b> with an <b>AAACCCDDDYYUURRS</b> initialization <b>vector</b> and <b>ZZHHYYTTUUHHGGRR</b> encryption <b>key</b> .</i>  <i>An example of encrypted data:</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code>p+oJjsGEULNSptP5Sj1BM5w65hMjkqzahORd8ybIkqyJD0V/608c1tYuKIvDLUIa <br> RQ9jQ6+EwbyMFjlMa6xuEnxOx4sez001hd3NsLO7p00XoTqAvi9zwUBII+ <br> nPphP6Zr0P4icvODpmhlmRILgSBsUf1H/3VN1lNXjo4LTa <br> GxLqW3VSg9iV9yFq4VMWqsRF <br></code> <br>  Attempts to quickly search for solutions <s>gave a bunch of non-working examples that</s> showed that the task goes beyond the usual layout of layouts and writing Presenters and requires studying docks and reading manuals.  A great opportunity to learn something new and enrich your experience. <br><br>  But for a start, let's understand what encryption is and why it is needed at all. <br><a name="habracut"></a><br><h2>  A bit of theory about AES encryption </h2><br>  <b>Advanced Encryption Standard (AES)</b> is a symmetric block encryption algorithm adopted by the US government based on the results of the competition as an encryption standard and replacing the less reliable <b>Data Encryption Standard (DES) algorithm</b> .  The approved algorithm as a unified encryption standard has become widely used to protect electronic data. <br><br>  The algorithm is based on substitutions, substitutions and linear transformations, each of which is performed in blocks of 128 bits (digits with values ​​of 0 or 1), which are the basis of the structure of the input and output data, therefore it is called the block cipher.  The repetition of operations occurs repeatedly and in the process of each iteration (round) a unique key is calculated based on the encryption key and embedded in further calculations. <br><br>  The cryptographic key for the AES algorithm is a sequence of 128, 192 or 256 bits.  Other input and output parameters and a cryptographic key are not allowed by the AES standard. <br><br>  The reliability of encryption is ensured by the fact that changing even one block entails changing subsequent blocks and completely changing the final data at the output. <br><br>  This approach provides high reliability of the algorithm, which can be seen by considering the following simple example: <br><br><div class="spoiler">  <b class="spoiler_title">An example of calculating the time for cracking ciphertext</b> <div class="spoiler_text">  Table 1: Dependence of the number of combinations on the key length <br><table><tbody><tr><td>  Key size <br></td><td>  Possible number of combinations <br></td></tr><tr><td>  1 bit <br></td><td>  2 <br></td></tr><tr><td>  2 bits <br></td><td>  four <br></td></tr><tr><td>  4 bits <br></td><td>  sixteen <br></td></tr><tr><td>  8 bit <br></td><td>  256 <br></td></tr><tr><td>  16 bits <br></td><td>  65536 <br></td></tr><tr><td>  32 bits <br></td><td>  4.2 * 10 ^ 9 <br></td></tr><tr><td>  56 bits (DES Algorithm) <br></td><td>  7.2 * 10 ^ 16 <br></td></tr><tr><td>  64 bits <br></td><td>  1.8 * 10 ^ 19 <br></td></tr><tr><td>  128 bits (AES alogrhythm) <br></td><td>  3.4 * 10 ^ 38 <br></td></tr><tr><td>  192 bits (AES alog) <br></td><td>  6.2 * 10 ^ 57 <br></td></tr><tr><td>  256 bits (AES alogrhythm) <br></td><td>  1.1 * 10 ^ 77 <br></td></tr></tbody></table><br>  The fastest supercomputer: 10.51 PetaFlops = 10.51 x 10 ^ 15 Flops (floating point operations per second) <br><br>  Let the approximate number of operations per second required to test a combination be optimistic: 1000 <br><br>  The number of checks checks per second = (10.51 x 10 ^ 15) / 1000 = 10.51 x 10 ^ 12 <br><br>  The number of seconds in one year = 365 x 24 x 60 x 60 = 31536000 <br><br>  Number of years to crack AES with a 128-bit key = (3.4 x 10 ^ 38) / [(10.51 x 1012) x 31536000] = (0.323 x 10 ^ 26) / 31536000 = 1.02 x 10 ^ 18 = 1 billion billion years. <br><br>  Based on: <a href="http://www.eetimes.com/document.asp%3Fdoc_id%3D1279619">How secure is AES against brute force attacks?</a> <br></div></div><br>  A detailed description of the algorithm in English: <a href="http://csrc.nist.gov/publications/fips/fips197/fips-197.pdf">ADVANCED ENCRYPTION STANDARD</a> <br>  You can also read this wonderful article: <a href="https://habrahabr.ru/post/112733/">How AES works</a> <br><br><h2>  Initialization vector </h2><br>  <b>Initialization vector (IV)</b> - the initialization vector, is an arbitrary number that can be used along with the secret key to encrypt data. <br><br>  The use of IV prevents the repetition of data encryption, which makes the hacking process more difficult for a hacker to use a dictionary attack, trying to find patterns and break a cipher.  For example, a sequence may appear two or more times in the message body.  If the sequences in the encrypted data are repeated, the attacker may assume that the corresponding sequences in the message were also identical.  IV prevents the appearance of corresponding repeated sequences of characters in the encrypted text. <br><br><h2>  Mathematical basis </h2><br>  To <s>remember the</s> study of the mathematical basis, we will use the material from the documentation for the algorithm <a href="http://csrc.nist.gov/publications/fips/fips197/fips-197.pdf">ADVANCED ENCRYPTION STANDARD</a> , as well as this good material in Russian: <a href="http://bit.nmu.org.ua/ua/student/metod/cryptology/%25D0%25BB%25D0%25B5%25D0%25BA%25D1%2586%25D0%25B8%25D1%258F%25209.pdf">General description of the AES cryptoalgorithm</a> <br><br>  Accordingly, to describe the algorithm, a finite <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25BF%25D0%25BE%25D0%25BB%25D0%25B5">Galois</a> field GF (2 ^ 8) is used, constructed as an extension of the field GF (2) = {0,1} modulo an irreducible polynomial m (x) = x ^ 8 + x ^ 4 + x ^ 3 + x + 1. The elements of the field GF (2 ^ 8) are polynomials of the form <br><br>  b_7 · x ^ 7 + b_6 · x ^ 6 + b_5 · x ^ 5 + b_4 · x ^ 4 + b_3 · x ^ 3 + b_2 · x ^ 2 + b_1 · x + b_0 <br><br>  Field operations are performed modulo m (x).  In total, the field GF (2 ^ 8) has 2 ^ 8 = 256 polynomials. <br><br>  <b>Basic math operations in the GF field (2 ^ 8)</b> <br><ol><li>  Adding bytes can be done in any of three ways: <br><ul><li>  to represent the bytes as bit polynomials and add them according to the usual rule of summation of polynomials with the subsequent reduction of the modulus 2 coefficients (XOR operation on the coefficients); </li><li>  modulo 2 add the corresponding bits in bytes; </li><li>  add up bytes in hexadecimal. </li></ul></li><li>  Multiplication bytes is performed by presenting them. <br>  polynomials and multiplication by the usual algebraic rules. <br>  The resulting product must be reduced modulo the polynomial m (x) = x ^ 8 + x ^ 4 + x ^ 3 + x + 1 (the result of the reduction is equal to the remainder of dividing the product by m (x)) </li><li>  For any non-zero bit polynomial b (x) in the field GF (2 ^ 8) <br>  there is a polynomial b ^ -1 (x), inverse to it by <br>  multiplication, i.e.  b (x) · b ^ -1 (x) = 1 mod m (x) </li></ol><br>  <b>Polynomials with coefficients belonging to the field GF (2 ^ 8)</b> <br>  Third degree polynomials with coefficients from a finite <br>  the fields a_i ∈ GF (2 ^ 8) have the form: a (x) = a_3 · x ^ 3 + a_2 · x ^ 2 + a_1 · x + a_0 (1) <br><br>  Thus, in these polynomials, bytes instead of bits are used as coefficients for unknowns.  Further, these polynomials will be represented in the form of the word [a_0, a_1, a_2, a_3].  In the AES standard, when multiplying polynomials of the form (1), the coercion modulo another polynomial x ^ 4 + 1 is used. <br><br>  To study the arithmetic of the polynomials under consideration, we introduce an additional polynomial b (x) = b_3 · x ^ 3 + b_2 · x ^ 2 + b_1 · x + b_0, where b_i ∈ GF (2 ^ 8).  Then <br><ol><li>  Addition <br>  a (x) + b (x) = (a_3 ⊕ b_3) x ^ 3 + (a_2 ⊕ b_2) x ^ 2 + (a_1 ⊕ b_1) x + (a_0 b_0) </li><li>  Multiplication <br>  To represent the result by a four-byte word, the result is taken modulo a polynomial of degree at most 4. The cipher authors chose for this purpose the polynomial x ^ 4 + 1, for which x_i mod (x ^ 4 + 1) ≡ x_i mod 4 is valid. <i>x ^ 4 + 1</i> allows you to get the result in the form: <br><br>  d (x) = a (x) · b (x) = d_3 · x ^ 3 + d_2 · x ^ 2 + d_1 · x + d_0 <br></li></ol><br><h2>  Encryption options </h2><br>  Well, there is AES and the initialization vector has become clear.  Now we will try to understand the remaining words in the <b>AES / CBC / PKCS5Padding line</b> <br><br>  <b>Cipher block chaining (CBC)</b> - the ciphertext block concatenation mode is one of the encryption modes for a symmetric block cipher using a feedback mechanism.  Each block of plaintext (except the first) is bitwise modulated by 2 with the previous result.  One error in the ciphertext block bit affects the decryption of all subsequent blocks.  Reorganizing the order of the ciphertext blocks causes damage to the result of the decryption. <br><img src="https://habrastorage.org/files/c88/d65/e10/c88d65e1046a440db62600b5bb01a03e.png"><br><br>  Another parameter, <b>PKCS5Padding</b> , indicates how incomplete blocks should be processed.  When using one of the general fill algorithms, you need to include the block size in the encrypted data, ensuring that when you try to decrypt the encrypted message, you will receive the required number of bytes. <br><br>  For all AES encryption settings to work, each implementation of the Java platform must support the following standard encryption algorithms with key sizes (in parentheses): <br><br><div class="spoiler">  <b class="spoiler_title">Standard Cipher transformations</b> <div class="spoiler_text"><ul><li>  AES / CBC / NoPadding (128) <br></li><li>  AES / CBC / PKCS5Padding (128) <br></li><li>  AES / ECB / NoPadding (128) <br></li><li>  AES / ECB / PKCS5Padding (128) <br></li><li>  DES / CBC / NoPadding (56) <br></li><li>  DES / CBC / PKCS5Padding (56) <br></li><li>  DES / ECB / NoPadding (56) <br></li><li>  DES / ECB / PKCS5Padding (56) <br></li><li>  DESede / CBC / NoPadding (168) <br></li><li>  DESede / CBC / PKCS5Padding (168) <br></li><li>  DESede / ECB / NoPadding (168) <br></li><li>  DESede / ECB / PKCS5Padding (168) <br></li><li>  RSA / ECB / PKCS1Padding (1024, 2048) <br></li><li>  RSA / ECB / OAEPWithSHA-1AndMGF1Padding (1024, 2048) <br></li><li>  RSA / ECB / OAEPWithSHA-256AndMGF1Padding (1024, 2048) <br></li></ul><br><br>  Source: <a href="https://docs.oracle.com/javase/7/docs/api/javax/crypto/Cipher.html">Cipher</a> <br></div></div><br><h2>  Casket just opened </h2><br><img src="https://habrastorage.org/files/a68/022/073/a680220730f542efa970f151a5be1118.jpg"><br>  Having dealt with the theory, you can begin to implement the algorithm for decrypting the server message. <br><br>  Unlike the standard JDK set, for work we need <i>android.util.Base64</i> to convert the string: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.util.Base64; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.security.GeneralSecurityException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.crypto.Cipher; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.crypto.spec.IvParameterSpec; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.crypto.spec.SecretKeySpec; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decrypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String key, String iv, String encrypted)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> GeneralSecurityException </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      final byte[] keyBytes = key.getBytes(); final byte[] ivBytes = iv.getBytes(); final byte[] encryptedBytes = Base64.decode(encrypted, Base64.DEFAULT); //     SecretKeySpec secretKeySpec = new SecretKeySpec(keyBytes, "AES"); Cipher cipher = Cipher.getInstance("AES/CBC/PKCS5Padding"); cipher.init(Cipher.DECRYPT_MODE, secretKeySpec, new IvParameterSpec(ivBytes)); // final byte[] resultBytes = cipher.doFinal(encryptedBytes); return new String(resultBytes); }</span></span></code> </pre><br><br>  It is also worth taking into account that the size of the initialization vector should be 16 bytes (128 - bit).  This is due to the fact that the AES encryption standard includes three types of block ciphers: AES - 128, AES - 192 and AES - 256. Each of these ciphers has a 128 - bit block size, with key sizes of 128, 192 and 256 bits, respectively. and taking into account the fact that for all types of block cipher, the initialization vector is the same size as the size of the cipher block, we get that the initialization vector is always 128-bit size. <br><br>  Otherwise, even if we try to use a vector of a different size, the ciphertext will not be decrypted and we will get the following exception: <br><br><pre> <code class="java hljs">java.security.InvalidAlgorithmParameterException: Wrong IV length: must be <span class="hljs-number"><span class="hljs-number">16</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">long</span></span></code> </pre><br><br><h2>  Result </h2><br>  As can be seen from the implementation, the solution was quite simple and trivial in the context of tasks of this kind.  But nevertheless, sometimes it is very useful to delve into the docks and realize what is not so common in the working days of the Android developer. <br><br>  For the most inquisitive, under the spoiler, what was encrypted in the message: <br><br><div class="spoiler">  <b class="spoiler_title">answer to the problem</b> <div class="spoiler_text"><pre> <code class="xml hljs">{ "items": [ { "name": "star", "color": "green", "id": 21 }, { "name": "dog", "color": "brown", "id": 43 } ], "lucky_item_id": 43 }</code> </pre><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/279835/">https://habr.com/ru/post/279835/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../279819/index.html">“Half of the scientific work on Concurrency is complete nonsense!” - an interview with Roman Elizarov from Devexperts</a></li>
<li><a href="../279821/index.html">Perl plugin version 1.4 released for IntelliJ IDEA</a></li>
<li><a href="../279829/index.html">And again about the $ _SERVER ['HTTP_HOST'] vulnerability</a></li>
<li><a href="../279831/index.html">Ferroelectric (ferroelectric) memory and electronic ink - the perfect combination for battery power</a></li>
<li><a href="../279833/index.html">1,000,000 residential buildings in Russia</a></li>
<li><a href="../279839/index.html">RetroShare</a></li>
<li><a href="../279841/index.html">How to detect overflow of 32-bit variable in long cycles in a 64-bit program</a></li>
<li><a href="../279843/index.html">Laravel TestTools - recording tests for Laravel directly from the Chrome browser</a></li>
<li><a href="../279845/index.html">The open Tarantool database from Mail.ru is certified and placed in the Azure Marketplace</a></li>
<li><a href="../279847/index.html">Less than 2 months, GoPro, a cool idea and team - everything you need to make a first-person game</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>