<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We fix the hanstunnel on openwrt (calculation of the checksum of the network packet)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. Probably, many people here know the hanstunnel program, which allows you to raise the tunnel on top of ICMP, or rather on ping. I decided to pu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We fix the hanstunnel on openwrt (calculation of the checksum of the network packet)</h1><div class="post__text post__text-html js-mediator-article">  Hello.  Probably, many people here know the <a href="http://code.gerade.org/hans/">hanstunnel</a> program, which allows you to raise the tunnel on top of ICMP, or rather on ping.  I decided to put it on a router openwrt.  Collected, started ... Does not work.  The symptoms were simple - the packet goes from the router to the external network, but does not arrive at the addressee, while everything works in the local LAN.  In this case, the same hans running on a home computer connects outside without question.  Who cares how to build a hans package under openwrt and how to make it work - well, under cat. <br><br><a name="habracut"></a><br><br>  The first stage is the assembly.  How to raise the build environment on my machine is well written on the <a href="http://wiki.openwrt.org/doc/start">openwrt</a> site itself, as well as in a bunch of different articles, so I will leave this piece behind the scenes.  Suppose we have a toolchain environment and she is able to build standard openwrt packages. <br>  To build the package, we need the hanstunnel source, which can be taken <a href="http://sourceforge.net/projects/hanstunnel/files/source/">here</a> , as well as the Makefile with the package description, the config file and the init-script file.  The last three by chance I found <a href="https://dev.openwrt.org/attachment/ticket/14029/hans.patch">here</a> as a description of the patches.  Maybe someone will find direct links, but I already approached.  To build your packages, create a folder, for example, custom, put the future package folders in it and direct links from package / feeds / packages to them.  I lightly filed a Makefile for the package so that it compiles the sources of their src folder lying next to each other, <div class="spoiler">  <b class="spoiler_title">that's what happened</b> <div class="spoiler_text"><pre>
 # Copyright (C) 2006 OpenWrt.org
 #
 # This is a free software licensed under the GNU General Public License v2.
 # See / LICENSE for more information.
 #
 # $ Id: Makefile 6008 2007-01-06 18: 39: 10Z nbd $

 include $ (TOPDIR) /rules.mk

 PKG_NAME: = hanstunnel
 PKG_VERSION: = 0.4.3
 PKG_RELEASE: = 1

 PKG_BUILD_DIR: = $ (BUILD_DIR) / $ (PKG_NAME) - $ (PKG_VERSION)

 include $ (INCLUDE_DIR) /package.mk

 define Package / hanstunnel
         SECTION: = net
         CATEGORY: = Network
         SUBMENU: = Firewall Tunnel
         DEPENDS: = + libstdcpp + kmod-tun
         TITLE: = Hans IP over ICMP
         URL: = http: //code.gerade.org/hans/
 endef

 define Package / hanstunnel / description
         Hans makes it possible to tunnel IPv4 through ICMP echo packets,
         so you could call it a ping tunnel.  This can be useful when you
         find yourself in the situation that your Internet access is
         firewalled, but pings are allowed.  endef
 endef

 define Build / Prepare
         echo PREPARE PREPARE
         mkdir -p $ (PKG_BUILD_DIR)
         cp -r ./src/* $ (PKG_BUILD_DIR) /
 endef

 define Build / Compile 
         $ (MAKE) -C $ (PKG_BUILD_DIR) GCC = $ (TARGET_CC) GPP = $ (TARGET_CXX)
 endef 

 
 define Package / hanstunnel / install
         $ (INSTALL_DIR) $ (1) / usr / sbin
         $ (INSTALL_BIN) $ (PKG_BUILD_DIR) / hans $ (1) / usr / sbin /
         $ (INSTALL_DIR) $ (1) /etc/init.d
         $ (INSTALL_BIN) ./files/hans.init $ (1) /etc/init.d/hans
         $ (INSTALL_DIR) $ (1) / etc / config
         $ (INSTALL_CONF) ./files/hans.config $ (1) / etc / config / hans
 endef

 $ (eval $ (call BuildPackage, hanstunnel))
</pre><br></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The cap of the Makefile of the assembly also had to be slightly filed <br><div class="spoiler">  <b class="spoiler_title">Makefile build</b> <div class="spoiler_text"><pre> #LDFLAGS + = `sh osflags ld $ (MODE)`
 CFLAGS + = -c -g -DLINUX -DHAVE_LINUX_IF_TUN_H
 TUN_DEV_FILE = src / tun_dev_linux.c
 #GCC = gcc
 #GPP = g ++

 .PHONY: directories

 all: hans

 directories: build_dir

 build_dir:
	 mkdir -p build

 tunemu.o: directories build / tunemu.o

 hans: directories build / tun.o build / sha1.o build / main.o build / client.o build / server.o build / auth.o build / worker.o build / time.o build / tun_dev.o build / echo.o build / exception.o build / utility.o
	 $ (GPP) -o hans build / tun.o build / sha1.o build / main.o build / client.o build / server.o build / auth.o build / worker.o build / time.o build / tun_dev .o build / echo.o build / exception.o build / utility.o $ (LDFLAGS)

 build / utility.o: src / utility.cpp src / utility.h
	 $ (GPP) -c src / utility.cpp -o $ @ -o $ @ $ (CFLAGS)

 build / exception.o: src / exception.cpp src / exception.h
	 $ (GPP) -c src / exception.cpp -o $ @ $ (CFLAGS)

 build / echo.o: src / echo.cpp src / echo.h src / exception.h
	 $ (GPP) -c src / echo.cpp -o $ @ $ (CFLAGS)

 build / tun.o: src / tun.cpp src / tun.h src / exception.h src / utility.h src / tun_dev.h
	 $ (GPP) -c src / tun.cpp -o $ @ $ (CFLAGS)

 build / tun_dev.o:
	 $ (GCC) -c $ (TUN_DEV_FILE) -o build / tun_dev.o -o $ @ $ (CFLAGS)

 build / sha1.o: src / sha1.cpp src / sha1.h
	 $ (GPP) -c src / sha1.cpp -o $ @ $ (CFLAGS)

 build / main.o: src / main.cpp src / client.h src / server.h src / exception.h src / worker.h src / auth.h src / time.h src / echo.h src / tun. h src / tun_dev.h
	 $ (GPP) -c src / main.cpp -o $ @ $ (CFLAGS)

 build / client.o: src / client.cpp src / client.h src / server.h src / exception.h src / config.h src / worker.h src / auth.h src / time.h src / echo. h src / tun.h src / tun_dev.h
	 $ (GPP) -c src / client.cpp -o $ @ $ (CFLAGS)

 build / server.o: src / server.cpp src / server.h src / client.h src / utility.h src / config.h src / worker.h src / auth.h src / time.h src / echo. h src / tun.h src / tun_dev.h
	 $ (GPP) -c src / server.cpp -o $ @ $ (CFLAGS)

 build / auth.o: src / auth.cpp src / auth.h src / sha1.h src / utility.h
	 $ (GPP) -c src / auth.cpp -o $ @ $ (CFLAGS)

 build / worker.o: src / worker.cpp src / worker.h src / tun.h src / exception.h src / time.h src / echo.h src / tun_dev.h src / config.h
	 $ (GPP) -c src / worker.cpp -o $ @ $ (CFLAGS)

 build / time.o: src / time.cpp src / time.h
	 $ (GPP) -c src / time.cpp -o $ @ $ (CFLAGS)

 clean:
	 rm -f build / tun.o build / sha1.o build / main.o build / client.o build / server.o build / auth.o build / worker.o build / time.o build / tun_dev.o build / echo.o build / exception.o build / utility.o build / tunemu.o hans
	 rm -df build

 build / tunemu.o: src / tunemu.h src / tunemu.c
	 $ (GCC) -c src / tunemu.c -o build / tunemu.o
</pre><br></div></div><br><br>  Putting the files in places, you should get something like: <br><br><pre> $ ls -R custom 
 custom:
 hanstunnel

 custom / hanstunnel:
 files makefile src

 custom / hanstunnel / files:
 hans.config hans.init

 custom / hanstunnel / src:
 Makefile osflags src

 custom / hanstunnel / src / src:
 auth.cpp client.h echo.h main.cpp sha1.cpp time.cpp tun_dev_darwin_emu.c tun_dev.h tun_dev_svr4.c tun.h worker.cpp
 auth.h config.h exception.cpp server.cpp sha1.h time.h tun_dev_freebsd.c tun_dev_linux.c tunemu.c utility.cpp worker.h
 client.cpp echo.cpp exception.h server.h sha1_license.txt tun.cpp tun_dev_generic.c tun_dev_openbsd.c tunemu.h utility.h
</pre><br><br>  Next we go to the root buildroot and happily type <br><pre> $ make package / feeds / packages / hanstunnel / compile -j5
  make [1] package / feeds / packages / hanstunnel / compile
  make [2] -C package / kernel / linux compile
  make [2] -C package / libs / toolchain compile
  make [2] -C custom / hanstunnel compile
</pre><br><br>  Everything, the package is ready, it lies in the bin folder next to the others. <br><br>  It remains to check.  Here I was waiting for a bummer.  With my computer in my home LAN, the tunnel went right up without any questions.  Only I was delighted and went to check the connection outside, but, as described above, the packages with openwrt left, and the addressee did not see them.  The same situation arose if you run hans on a router in client mode.  After much thought, I guessed to remove the ICMP dump and look for the difference between connecting from the router and from my computer.  The problem was in the ICMP checksum, which wireshark happily told me about.  I honestly took the calculator and went by myself to manually count the amount according to the algorithm prescribed in echo.cpp, which is very similar to the <a href="http://www.faqs.org/rfcs/rfc1071.html">official one</a> .  It turned out anything, but not what is needed.  As a result, it turned out that the problem is in the odd packet length and MIPS architecture.  Good people at the RFC write that the last byte should just be added to the amount, but in fact it is not.  We need to add not the last byte, but two bytes, the second of which is 0, which on Big-endian architectures means an increase in our byte multiplied by 256. <br>  Here is the icmpChecksum function: <br><br><pre> uint16_t Echo :: icmpChecksum (const char * data, int length)
 {
     uint16_t * data16 = (uint16_t *) data;
     uint32_t sum = 0;

     for (sum = 0; length&gt; 1; length - = 2)
         sum + = * data16 ++;


     if (length == 1)
     {
         unsigned char tail [2] = {* (unsigned char *) data16, 0};
         sum + = * (uint16_t *) tail;
     }
     while (sum &gt;&gt; 16)
         sum = (sum &gt;&gt; 16) + (sum &amp; 0xffff);

     return ~ sum;
 }
</pre><br><br>  With her, finally, everything worked as it should.  Happy end. <br><br>  <b>UPD</b> : straightened tail for a more beautiful version of <a href="http://habrahabr.ru/users/jcmvbkbc/">jcmvbkbc</a> </div><p>Source: <a href="https://habr.com/ru/post/211284/">https://habr.com/ru/post/211284/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../211266/index.html">Save health% username%: sports search engine</a></li>
<li><a href="../211270/index.html">NERSC launches Edison supercomputer with 2.4 petaflops performance</a></li>
<li><a href="../211272/index.html">Part 3. Meet - laser called Amaris. Moving and first awakening of VisuMax</a></li>
<li><a href="../211278/index.html">Utopia replace Silk Road?</a></li>
<li><a href="../211282/index.html">Difficulties of choice</a></li>
<li><a href="../211286/index.html">Outsourcing electronics design: a review of approaches and trends in Russia and abroad</a></li>
<li><a href="../211288/index.html">Tizen DevLab and Hakaton in Novosibirsk</a></li>
<li><a href="../211290/index.html">Hi, cryptocurrency. A little news from the prosecutor's office</a></li>
<li><a href="../211292/index.html">Display filters for network analyzers (Wireshark, Paketyzer)</a></li>
<li><a href="../211296/index.html">Requests from the US intelligence in 2013</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>