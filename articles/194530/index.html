<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Authorization using client SSL certificates in IOS and Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The Secure Sockets Layer (SSL) data transfer protocol, in addition to providing secure data transmission, also allows you to implement client authoriz...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Authorization using client SSL certificates in IOS and Android</h1><div class="post__text post__text-html js-mediator-article">  The Secure Sockets Layer (SSL) data transfer protocol, in addition to providing secure data transmission, also allows you to implement client authorization using client SSL certificates.  This article is a practical guide to the implementation of this type of authorization in mobile applications on IOS and Android. <br><br>  The process of organizing the work of the server providing this type of authorization is not covered in the article, but at the end there are links on this topic. <br><br>  The authorization process is as follows.  When a client goes to a closed area, the server requests a certificate from the client, if the check is successful, then the client gets access to the closed content, otherwise the client may receive an error ‚Äú <b>No required SSL certificate was sent</b> ‚Äù. <br><a name="habracut"></a><br>  To organize the connection, we generated the client certificate, as well as created a certificate signing request, which resulted in the client.csr file.  Then we sent this file to the service provider and received our signed client certificate necessary for authentication on the remote server. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Connection testing can be done using the curl utility. <br><br>  <i>curl cert client.crt key client.key k <a href="https://someserive.com/">someserive.com</a></i> <br><br>  However, it is worth noting that the latest version of curl 7.30.0 in OS X is broken and cannot be used to organize testing ( <a href="http://curl.haxx.se/mail/archive-2013-10/0036.html">http://curl.haxx.se/mail/archive-2013-10/0036.html</a> ). <br><br>  To transfer the client certificate, we will use a file in the PKCS # 12 format.  In PKCS # 12 files, both the private key and the certificate are stored at the same time (of course, in encrypted form).  The approximate organization of the PKCS # 12 file is shown in the figure. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5f6/494/212/5f64942126e7730b5d4bade18c5d17b2.jpg"><br><br>  To convert your client.crt to a PKCS # 12 file, use the following command: <br><br>  <i>openssl pkcs12 export in client.crt inkey client.key out client.p12</i> <br><br>  After we received the file in the PKCS # 12 format, we can proceed to the development and testing of our mobile application.  Let's start with iOS. <br><br><h5>  1. Implement the iOS version of the application </h5><br>  You need to connect to your project Security.Framework <br>  In order to make a request, we need to extract a digital certificate and its associated private key (SecIdentityRef) from PKCS # 12.  The presence of this object will allow us to obtain the appropriate NSURLCredential. <br>  So, we implement the extractIdentityAndTrust function. <br><br><pre><code class="objectivec hljs">OSStatus extractIdentityAndTrust(<span class="hljs-built_in"><span class="hljs-built_in">CFDataRef</span></span> inP12data, SecIdentityRef *identity) { OSStatus securityError = errSecSuccess; <span class="hljs-built_in"><span class="hljs-built_in">CFStringRef</span></span> password = <span class="hljs-built_in"><span class="hljs-built_in">CFSTR</span></span>(<span class="hljs-string"><span class="hljs-string">""</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *keys[] = { kSecImportExportPassphrase }; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *values[] = { password }; <span class="hljs-built_in"><span class="hljs-built_in">CFDictionaryRef</span></span> options = <span class="hljs-built_in"><span class="hljs-built_in">CFDictionaryCreate</span></span>(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, keys, values, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">CFArrayRef</span></span> items = <span class="hljs-built_in"><span class="hljs-built_in">CFArrayCreate</span></span>(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); securityError = SecPKCS12Import(inP12data, options, &amp;items); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (securityError == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">CFDictionaryRef</span></span> myIdentityAndTrust = <span class="hljs-built_in"><span class="hljs-built_in">CFArrayGetValueAtIndex</span></span>(items, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *tempIdentity = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; tempIdentity = <span class="hljs-built_in"><span class="hljs-built_in">CFDictionaryGetValue</span></span>(myIdentityAndTrust, kSecImportItemIdentity); *identity = (SecIdentityRef)tempIdentity; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (options) { <span class="hljs-built_in"><span class="hljs-built_in">CFRelease</span></span>(options); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> securityError; }</code> </pre> <br>  We perform extraction using the SecPKCS12Import function, it is unforgettable to specify the password for the serial certificate. <br>  Next, we implement the canAuthenticateAgainstProtectionSpace delegate, a call to this delegate allows us to define the server properties, namely the protocol, the authorization mechanism.  With us, the implementation of this delegate will be simple; let us indicate that we are processing any authentication method provided by the server. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)connection:(<span class="hljs-built_in"><span class="hljs-built_in">NSURLConnection</span></span> *)connection canAuthenticateAgainstProtectionSpace:(<span class="hljs-built_in"><span class="hljs-built_in">NSURLProtectionSpace</span></span> *)protectionSpace { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; }</code> </pre><br>  We process possible errors: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)connection:(<span class="hljs-built_in"><span class="hljs-built_in">NSURLConnection</span></span>*) connection didFailWithError:(<span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *)error { <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"Did recieve error: %@"</span></span>, [error localizedDescription]); <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"%@"</span></span>, [error userInfo]); }</code> </pre><br>  We now turn to the implementation of the authentication mechanism itself.  Implement the didRecieveAuthentificationChallenge delegate: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)connection:(<span class="hljs-built_in"><span class="hljs-built_in">NSURLConnection</span></span> *)connection didReceiveAuthenticationChallenge:(<span class="hljs-built_in"><span class="hljs-built_in">NSURLAuthenticationChallenge</span></span> *)challenge { <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"Authentication challenge"</span></span>); <span class="hljs-comment"><span class="hljs-comment">// load cert NSString *path = [[NSBundle mainBundle] pathForResource:@"keystore" ofType:@"p12"]; NSData *p12data = [NSData dataWithContentsOfFile:path]; CFDataRef inP12data = (__bridge CFDataRef)p12data; SecIdentityRef myIdentity; OSStatus status = extractIdentityAndTrust(inP12data, &amp;myIdentity); SecCertificateRef myCertificate; SecIdentityCopyCertificate(myIdentity, &amp;myCertificate); const void *certs[] = { myCertificate }; CFArrayRef certsArray = CFArrayCreate(NULL, certs, 1, NULL); NSURLCredential *credential = [NSURLCredential credentialWithIdentity:myIdentity certificates:(__bridge NSArray*)certsArray persistence: NSURLCredentialPersistenceForSession]; [[challenge sender] useCredential:credential forAuthenticationChallenge:challenge]; }</span></span></code> </pre><br>  We load our certificate, extract the data we need from it, create the NSURLCredential, transfer the necessary information, save the authentication data only in the context of the current session. <br><br>  Well, for the sake of completeness, here is the code preparing the NSURLConnection: <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *key = <span class="hljs-string"><span class="hljs-string">@"test"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *jsonSerializationError = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">NSMutableDictionary</span></span> *projectDictionary = [<span class="hljs-built_in"><span class="hljs-built_in">NSMutableDictionary</span></span> dictionaryWithCapacity:<span class="hljs-number"><span class="hljs-number">1</span></span>]; [projectDictionary setObject:key forKey:<span class="hljs-string"><span class="hljs-string">@"test"</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">NSData</span></span> *jsonData = [<span class="hljs-built_in"><span class="hljs-built_in">NSJSONSerialization</span></span> dataWithJSONObject:projectDictionary options:<span class="hljs-literal"><span class="hljs-literal">nil</span></span> error:&amp;jsonSerializationError]; <span class="hljs-built_in"><span class="hljs-built_in">NSURL</span></span> *requestUrl = [[<span class="hljs-built_in"><span class="hljs-built_in">NSURL</span></span> alloc] initWithString:<span class="hljs-string"><span class="hljs-string">@"https://your_service"</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">NSMutableURLRequest</span></span> *request = [<span class="hljs-built_in"><span class="hljs-built_in">NSMutableURLRequest</span></span> requestWithURL:requestUrl cachePolicy:<span class="hljs-built_in"><span class="hljs-built_in">NSURLRequestReloadIgnoringCacheData</span></span> timeoutInterval:<span class="hljs-number"><span class="hljs-number">60.0</span></span>]; [request setHTTPMethod:<span class="hljs-string"><span class="hljs-string">@"POST"</span></span>]; [request setValue:<span class="hljs-string"><span class="hljs-string">@"UTF-8"</span></span> forHTTPHeaderField:<span class="hljs-string"><span class="hljs-string">@"content-charset"</span></span>]; [request setValue:<span class="hljs-string"><span class="hljs-string">@"application/json"</span></span> forHTTPHeaderField:<span class="hljs-string"><span class="hljs-string">@"Accept"</span></span>]; [request setValue:<span class="hljs-string"><span class="hljs-string">@"application/json"</span></span> forHTTPHeaderField:<span class="hljs-string"><span class="hljs-string">@"Content-Type"</span></span>]; [request setValue:[<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> stringWithFormat:<span class="hljs-string"><span class="hljs-string">@"%d"</span></span>, [jsonData length]] forHTTPHeaderField:<span class="hljs-string"><span class="hljs-string">@"Content-Length"</span></span>]; [request setHTTPBody: jsonData]; <span class="hljs-built_in"><span class="hljs-built_in">NSURLConnection</span></span> *connection = [[<span class="hljs-built_in"><span class="hljs-built_in">NSURLConnection</span></span> alloc] initWithRequest:request delegate:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>]; [connection start];</code> </pre><br><br>  Implementation of the delegate didReceiveData will not result. <br><br><h5>  2. Implement the Android version of the application </h5><br>  I'll start right away with the code: <br><br><pre> <code class="java hljs">KeyStore keystore = KeyStore.getInstance(<span class="hljs-string"><span class="hljs-string">"PKCS12"</span></span>); keystore.load(getResources().openRawResource(R.raw.keystore), <span class="hljs-string"><span class="hljs-string">""</span></span>.toCharArray()); SSLSocketFactory sslSocketFactory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AdditionalKeyStoresSSLSocketFactory(keystore); HttpParams params = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicHttpParams(); HttpProtocolParams.setVersion(params, HttpVersion.HTTP_1_1); HttpProtocolParams.setContentCharset(params, HTTP.UTF_8); HttpProtocolParams.setUseExpectContinue(params, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> SchemeRegistry registry = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchemeRegistry(); registry.register(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scheme(<span class="hljs-string"><span class="hljs-string">"http"</span></span>, PlainSocketFactory.getSocketFactory(), <span class="hljs-number"><span class="hljs-number">80</span></span>)); registry.register(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scheme(<span class="hljs-string"><span class="hljs-string">"https"</span></span>, sslSocketFactory, <span class="hljs-number"><span class="hljs-number">3123</span></span>)); ThreadSafeClientConnManager manager = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ThreadSafeClientConnManager(params, registry); DefaultHttpClient httpclient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultHttpClient(manager, params); HttpPost httpPostRequest = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpPost(<span class="hljs-string"><span class="hljs-string">"https://your_service"</span></span>); <span class="hljs-comment"><span class="hljs-comment">// datas - array which contains data to send to server StringEntity se = new StringEntity(datas[0].toString(), HTTP.UTF_8); // Set HTTP parameters httpPostRequest.setEntity(se); httpPostRequest.setHeader("Accept", "application/json"); httpPostRequest.setHeader("Content-Type", "application/json"); HttpResponse response = httpclient.execute(httpPostRequest);</span></span></code> </pre><br>  In our case, we get an instance of the corresponding KeyStore (PKCS12), download our certificate from the resources, specify the password as the second argument.  Next we create an instance of SSLSocketFactory, using our own implementation of SSLSocketFactory, which allows us to initialize the SSL context using our certificate.  The factory code is given below.  Next, we configure the connection parameters, register our factory, specify the port to which we will send the request, form the corresponding POST and execute the request. <br><br>  Factory code: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.IOException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.net.Socket; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.security.KeyManagementException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.security.KeyStore; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.security.KeyStoreException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.security.NoSuchAlgorithmException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.security.SecureRandom; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.security.UnrecoverableKeyException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.security.cert.CertificateException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.security.cert.X509Certificate; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.ArrayList; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Arrays; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.net.ssl.KeyManagerFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.net.ssl.SSLContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.net.ssl.TrustManager; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.net.ssl.TrustManagerFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.net.ssl.X509TrustManager; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.http.conn.ssl.SSLSocketFactory; <span class="hljs-comment"><span class="hljs-comment">/** * Allows you to trust certificates from additional KeyStores in addition to * the default KeyStore */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AdditionalKeyStoresSSLSocketFactory</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SSLSocketFactory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> SSLContext sslContext = SSLContext.getInstance(<span class="hljs-string"><span class="hljs-string">"TLS"</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AdditionalKeyStoresSSLSocketFactory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(KeyStore keyStore)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchAlgorithmException, KeyManagementException, KeyStoreException, UnrecoverableKeyException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); KeyManagerFactory kmf = KeyManagerFactory.getInstance(KeyManagerFactory.getDefaultAlgorithm()); kmf.init(keyStore, <span class="hljs-string"><span class="hljs-string">""</span></span>.toCharArray()); sslContext.init(kmf.getKeyManagers(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TrustManager[]{<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClientKeyStoresTrustManager(keyStore)}, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SecureRandom()); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Socket </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createSocket</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Socket socket, String host, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> port, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> autoClose)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sslContext.getSocketFactory().createSocket(socket, host, port, autoClose); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Socket </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createSocket</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sslContext.getSocketFactory().createSocket(); } <span class="hljs-comment"><span class="hljs-comment">/** * Based on http://download.oracle.com/javase/1.5.0/docs/guide/security/jsse/JSSERefGuide.html#X509TrustManager */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClientKeyStoresTrustManager</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">X509TrustManager</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ArrayList&lt;X509TrustManager&gt; x509TrustManagers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;X509TrustManager&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ClientKeyStoresTrustManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(KeyStore... additionalkeyStores)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ArrayList&lt;TrustManagerFactory&gt; factories = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;TrustManagerFactory&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// The default Trustmanager with default keystore final TrustManagerFactory original = TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm()); original.init((KeyStore) null); factories.add(original); for ( KeyStore keyStore : additionalkeyStores ) { final TrustManagerFactory additionalCerts = TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm()); additionalCerts.init(keyStore); factories.add(additionalCerts); } } catch (Exception e) { throw new RuntimeException(e); } /* * Iterate over the returned trustmanagers, and hold on * to any that are X509TrustManagers */ for (TrustManagerFactory tmf : factories) for ( TrustManager tm : tmf.getTrustManagers() ) if (tm instanceof X509TrustManager) x509TrustManagers.add( (X509TrustManager) tm ); if ( x509TrustManagers.size() == 0 ) throw new RuntimeException("Couldn't find any X509TrustManagers"); } public void checkClientTrusted(X509Certificate[] chain, String authType) throws CertificateException { for ( X509TrustManager tm : x509TrustManagers ) { try { tm.checkClientTrusted(chain, authType); return; } catch ( CertificateException e ) { } } throw new CertificateException(); } /* * Loop over the trustmanagers until we find one that accepts our server */ public void checkServerTrusted(X509Certificate[] chain, String authType) throws CertificateException { for ( X509TrustManager tm : x509TrustManagers ) { try { tm.checkServerTrusted(chain, authType); return; } catch ( CertificateException e ) { } } throw new CertificateException(); } public X509Certificate[] getAcceptedIssuers() { final ArrayList&lt;X509Certificate&gt; list = new ArrayList&lt;X509Certificate&gt;(); for ( X509TrustManager tm : x509TrustManagers ) list.addAll(Arrays.asList(tm.getAcceptedIssuers())); return list.toArray(new X509Certificate[list.size()]); } } }</span></span></code> </pre><br><h5>  Conclusion </h5><br>  We looked at how to authenticate over SSL using a client certificate. <br><br>  Useful information: <br>  <a href="https://developer.apple.com/library/mac/documentation/security/conceptual/certkeytrustprogguide/iPhone_Tasks/iPhone_Tasks.html">Certificate, Key, and Trust Services Tasks for iOS</a> <br>  <a href="http://ru.wikipedia.org/wiki/PKCS12">PKCS12 Description</a> <br>  <a href="http://stackoverflow.com/questions/6544653/creating-net-web-service-with-client-certificate-authentication">Creating .NET web service with client certificate authentication</a> <br>  <a href="http://stackoverflow.com/questions/14933477/certificate-authentication-in-asp-net">Certificate Authentication in asp.net</a> <br>  <a href="http://blog.palominolabs.com/2011/10/18/java-2-way-tlsssl-client-certificates-and-pkcs12-vs-jks-keystores/">Java 2-way TLS / SSL (Client Certificates) and PKCS12 vs JKS KeyStores</a> <br><br>  Thanks for attention! <br></div><p>Source: <a href="https://habr.com/ru/post/194530/">https://habr.com/ru/post/194530/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../194516/index.html">Microwave Repair Experience</a></li>
<li><a href="../194518/index.html">Impressions from entering Kikstarter</a></li>
<li><a href="../194520/index.html">Jaguar uses virtual technologies to organize sales</a></li>
<li><a href="../194526/index.html">As we studied project management in the mountains. Vertex # 2</a></li>
<li><a href="../194528/index.html">Adaptability</a></li>
<li><a href="../194534/index.html">Samsung NX: the transformation of the system camera into an ecosystem. Part 1</a></li>
<li><a href="../194538/index.html">QuickOffice became free. To it, Google adds 10 GB to Drive for two years.</a></li>
<li><a href="../194540/index.html">RailsClub'Moscow 2013. Interview with Petr Zotov</a></li>
<li><a href="../194542/index.html">Blizzard decided to close in-game auctions in Diablo 3</a></li>
<li><a href="../194546/index.html">Photoshop in Ubuntu</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>