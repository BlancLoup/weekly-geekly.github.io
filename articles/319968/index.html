<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Master Tarantool 1.6</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Evgeny Shadrin (Sberbank Digital Ventures) 
 Tracking the news of the last few years, you can see that new NoSQL solutions, some releases appear almos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Master Tarantool 1.6</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/239/4ca/d0a/2394cad0af8e623664f1e043aa4d6332.jpg"><br><br><h2>  Evgeny Shadrin (Sberbank Digital Ventures) </h2><br>  Tracking the news of the last few years, you can see that new NoSQL solutions, some releases appear almost every two weeks.  Of course, many of them do not survive, lose the competition, disappear, but the world of NoSQL is replenished with new solutions very often. <br><br>  At the conference, there are people who have never used NoSQL in their lives, and people who have used NoSQL for more than five years in their projects and companies.  Some even participate in open-source projects.  They are few, but there are some too. <br><a name="habracut"></a><br>  My name is Evgeniy.  I work in a small division of Sberbank Digital Ventures, which is engaged in the implementation of innovative products and solutions, i.e.  we make IT prototypes at the junction of new technologies. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this report, I want to tell you about my case of using a NoSQL solution by the user, so in the beginning I would like to briefly go through the theory. <br><br>  What is NoSQL? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/058/336/a06/058336a06a0abd4e6fc2739bd3fd9f1b.png"><br><br>  I use the acronym not only SQL, i.e.  <strong>not just</strong> SQL.  These are solutions that contain data models other than relational ones and designed to solve some issues;  for example, the question of ease of scaling.  Often, due to the fact that in NoSQL solutions for storing and working with data, it is not necessary to set specific schemes, entities and many configurations, it is very easy and simple to solve the scaling problem, deploy large clusters with a large number of nodes, add and delete these nodes.  Also, NoSQL solutions are often highly specialized, i.e.  Each team of developers does not always try to make a large universal project, but tries to solve some problem.  Such specialization of solutions allows to achieve very high rates of performance in specific tasks.  And in such tasks, using NoSQL solutions can be convenient and easy. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/851/e9f/a83/851e9fa834c3be863624a83e2b386350.png"><br><br>  Here I gave the most popular databases in order of classification.  You've heard about the key-value of the Redis repository and Riak ‚Äî they use the key-value model to store data.  The MongoDB document-oriented database is quite common and well known.  The document-oriented model is slightly more complex than the key-value model and allows you to store very large hierarchical information.  Next come the tabular, matrix database - for example, Apache HBase.  They can work with a large amount of distributed information.  OrientDB stands alone - a database that supports multi-paradigms, but I gave it as an example of databases that support the graph model.  The graph model has an advantage: it is very convenient to trace the connections between the data, which is not bad when working with projects-analogues of social networks. <br><br>  How to choose from all this diversity the solution that is right for you?  I use the following principles: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2e2/fed/809/2e2fed809a78659ffb5d9d396629a091.png"><br><br><ul><li>  Do not reinvent the wheel.  I met development teams that were eager to fight, saying that now they will quickly write their small repository that is right for them, which stores the types of data they need.  Everything turns out to be not so simple.  Here the Tarantool database has been developed for more than four years by a team of professional developers, and there are constantly some questions that need to be solved, solved and solved.  Many NoSQL solutions are older than ten years.  Therefore, to choose the right solution for you, based on your specific task. </li><li>  Most databases are designed to solve a problem.  If you understand what problem you are solving, you will most likely be able to find the right solution. </li><li>  I hope the point ‚Äúdraw on the experience of others‚Äù is understandable.  In the world of the Internet, it is not so difficult to climb, google, read books, finally, insolently, take and write to developers and say: ‚ÄúI have such a case.  Tell me, please, how do you recommend it? ‚Äù  Many developers are very responsive and help. </li><li>  If you are lucky and there are several solutions for your task, then you shouldn‚Äôt go very far in comparing performance, building test benches, understanding what is better - A or B. Choose what you know.  Save time on studying, on disassembling the product.  If you know - well, if your colleague knows - also not bad, you can always turn to him. </li></ul><br>  And a brief listing of those cases that NoSQL solves. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/22b/6fb/c69/22b6fbc69fd51baba28e665a576cdb73.png"><br><br>  I came across most of them personally. <br><br><ul><li>  ‚ÄúCaching‚Äù data is the well-known Memcached database.  Here you can add storage of intermediate data, i.e.  these are the data we want to access quickly, now, at the right moment. </li><li>  ‚ÄúWorking with large amounts of data‚Äù probably does not sound quite correct, because relational databases also work with large, huge data flows ... I meant exactly the word ‚Äúflows‚Äù, that is, for example, we are flowing from then server requests, and we want to quickly save them, and then figure out what to do with them next.  This task, for example, is not bad solved by HBase within the limits of a product of Hadoop. </li><li>  Queuing services.  NoSQL can act as part of the queue service.  For example, a bunch of RabbitMQ and Redis met a couple of times in my practice - a simple and convenient backend in the form of NoSQL. </li><li>  Separately, I made a platform for statistical data processing.  This is when we receive data and do not want to store them all: we have no memory, we have limited resources.  We can process this data immediately.  For example, we get some signs of users, we can throw out unnecessary signs, normalize the rest and just store them as ‚Äúkey-value‚Äù vectors, for example, in Redis. </li><li>  You can also use NoSQL as a small convenient backend for storage, i.e.  just took and saved.  MongoDB is a fairly quickly and conveniently deployable database that is suitable for this case. </li></ul><br>  Cases, of course, much more, but I talked about those with whom I came across.  In general, in Sberbank Digital Ventures I develop systems that work in real time and whose main purpose is to get information from the server, save it, process it, understand what it is, and give the server the right answer. <br><br>  For example, I get the necessary information about the user who goes somewhere in the depths of the Internet.  I get all the data that I could collect, analyze them and can segment the user, put him in one category or another, i.e.  find out that, say, this is a young man of 25 years old who is interested in cars, or this is a young girl of 18 who wants to go to university and is looking for a place to take a bribe for admission. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/182/2f0/517/1822f051786d9e16b650ff3129f8f176.png"><br><br>  To solve my problem, I use the NoSQL database Tarantool.  In the future, I will tell you why and why I use it and how it helps to solve problems that arise before me. <br><br>  On the slide - a quote from the main page of the developers site, this is their project positioning.  "A NoSQL database running in a Lua application server", i.e.  The developers themselves are positioning Tarantool as a project that consists of two parts: the first part is the non-relational database, the second part is the Lua application server, i.e.  application server using the Lua language. <br><br>  By the way, note that most of the modern NoSQL database icons use gray and red.  Probably, it is in trend =) <br><br>  Further I will give you code samples.  If someone has the opportunity, you can follow the link to the server <a href="https://tarantool.org/try.html">try.tarantool.org</a> is an interactive service where you can immediately use Tarantool, i.e.  This is a kind of interactive Tarantool, which stands out for you on the servers of developers.  Probably, someone wants code samples right there to drive in. <br><br>  What makes Tarantool stand out from the large stack of NoSQL technologies? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e99/750/dcd/e99750dcd01499b6d10348dd2cc49707.png"><br><br>  Tarantool keeps all its data in memory, so we get quick access to it.  The fact that Tarantool keeps them in memory does not mean that it is not safe and we can lose data.  Tarantool has data storage mechanisms: logs and binary snapshots of states.  These two mechanisms work together: we have points with stored data and descriptions of actions that were done before or after with this data.  With such information, we can always come to the desired state. <br><br>  At one time, the storage of data in memory led to the fact that this memory was running out very quickly.  It ends now, but all the same, the amounts of RAM are constantly growing, and similar databases get a wider range of applications.  Tarantool uses a document-oriented data model, i.e.  it stores all the data in some kind of abstraction called a document.  The document has its own fields, with which Tarantool works. <br><br>  One of the features of Tarantool as a database is the presence of secondary indexes.  The presence of secondary indexes allows you to make actions with data more lively, interesting and fast. <br><br>  I have not yet used transactions in my projects, but Tarantool supports full-fledged transactions.  As far as I know, in some companies - Mail.Ru Group, Avito - successfully use them to solve their cases.  Tarantool has a lightweight thread model, or green threads.  This is a multi-threaded model, only threads are created not at the Unix level, but within the application itself, which allows you to implement some asynchronous things, event models. <br><br>  Tarantool also works with the network and files: it has its own HTTP server, its own libraries, which save and open files;  This also came in handy when solving problems. <br><br>  Tarantool is a Lua application server, and Lua is an embedded language Tarantool.  Here I gave an example of a very artificial, absolutely not used in practice script to show what Lua is: <br><br><pre><code class="lua hljs">#!/usr/bin/tarantool <span class="hljs-comment"><span class="hljs-comment">-- This is lua script function hw(a, b) print (a.hello..b.world) end b = {} a = { hello = 'Hello ' } b['world'] = 'world!' hw(a, b)</span></span></code> </pre> <br>  The Lua language was developed in Brazil, at a Catholic university;  it originated from the language SOL, which works with data and was sharpened for work with databases.  Here we can see that this is not just a script, but an executable script.  The grid and the exclamation mark are the mechanism that allows us to specify who should run this script and how.  Having entered <code>tarantool script.lua</code> in the console, we get <code>hello world</code> on the screen.  Here we see a function that works with two objects, and below we initialize these objects themselves. <br><br>  The main data structure of Lua is the tables.  The objects <code>a</code> and <code>b</code> are tables, and I specifically initialized them in different ways to show that Lua is very flexible and syntactically pleasant.  These tables may contain other data within themselves - for example, the same tables, which, in turn, may contain other tables.  Sometimes due to inexperience, very large nestings were made.  Functions can also be stored inside a table.  In general, it is also possible to work with the ‚Äúfunctions‚Äù object as with a table ‚Äî there are methods for this. <br><br>  Next, I will give an example of a more practical script that can be refined and used in some of your production.  He solves a small problem, and solves quite trivially: he counts the number of unique visitors on a page. <br><br><pre> <code class="lua hljs">#!/usr/bin/tarantool <span class="hljs-comment"><span class="hljs-comment">-- Tarantool init script local log = require('log') local console = require('console') local server = require('http.server') local HOST = 'localhost' local PORT = 8008 box.cfg { log_level = 5, slab_alloc_arena = 1, } console.listen('127.0.0.1:33013') if not box.space.users then s = box.schema.space.create('users') s:create_index('primary', {type = 'tree', parts = {1, 'NUM'}}) end function handler(self) local id = self:cookie('tarantool_id') local ip = self.peer.host local data = '' log.info('Users id = %s', id) if not id then data = 'Welcome to tarantool server!' box.space.users:auto_increment({ip}) id = box.space.users:len() return self:render({ text = data}): setcookie({ name = 'tarantool_id', value = id, expires = '+1y' }) else local count = box.space.users:len() data = 'You id is ' .. id .. '. We have ' .. count .. ' users' return self:render({ text = data }) end end httpd = server.new(HOST, PORT) httpd:route({ path = '/' }, handler) httpd:start()</span></span></code> </pre> <br>  This is the so-called executable Lua script that will run in Tarantool and perform the sequence of actions that is contained in it. <br><br>  Briefly go through the blocks of what is there, and then analyze the details. <br><br>  At the top, I connect the packages that I need through the require: log, console, server loach mechanism.  I define some constants that I use. <br><br>  Next comes the configuration of the Tarantool database using the <code>box.cfg</code> module, where I set two parameters I need.  I launch the console and create entities of our database using <code>box.schema.space.create('users')</code> - i.e.  I created the users space.  I will tell about all this a bit later. <br><br>  The second part of the script is to work with the Tarantool server: I describe the <code>handler</code> function (request handler), and below I create a server, create a <code>route</code> for processing, and start this server. <br><br>  From the user's side, the result of running this script looks like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2ec/7fe/34d/2ec7fe34de4b5aa017d0b2b3ee4b35e7.png"><br><br>  The user went, for example, to localhost and saw a welcome message.  In the future, if he updates the page, he will already have a link to the <code>cookie</code> , he will be assigned an <code>id</code> , and he will know the number of unique users who visit this page. <br><br>  This small script solves some task I need - this is the answer to the question of why we use the Lua language. <br><br>  Lua is quite simple.  There are whole sets of articles ‚ÄúLua in 15 minutes‚Äù, ‚Äúin 30 minutes‚Äù ... You really need a little bit to get to know this interesting language.  For a couple of hours you will learn all its features. <br><br>  It is very convenient that the main data structure is a table.  This allows you to work consistently with all other data. <br><br>  By itself, the standard Lua interpreter is not very fast, or rather, it is not very fast, but there is a similar LuaJIT interpreter that does the JIT compilation, and it is much faster.  It is he who makes Lua a very productive language. <br><br>  There is a luafun library that allows you to program Lua in a functional style.  Thanks to LuaJIT, this library is very fast.  You can google, read about it, see reviews about its performance - very interesting. <br><br>  Also, Lua is a very well-built language, it has excellent integration with the C language. Due to the fact that sshishnye procedures can be run inside Lua, and Lua can be run inside C, Lua is very widely used in game dev.  Quite a lot of extensions, quests and various game mechanics and logic in the famous game World of Warcraft are written and are still being written in Lua. <br><br>  Tarantool is a full-fledged Lua interpreter, i.e.  if you just run Tarantool, you can trite working with Lua. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7c0/30b/adc/7c030badc640c084898ed0626cb2975e.png"><br><br>  Tarantool can be run in two entities: <br><br><ul><li>  The first is as an interpreter, i.e.  run Tarantool and execute some commands line by line.  This is useful if you do not know something or want to execute some command from the documentation. </li><li>  The second is using the <code>init.lua</code> startup script (you can call it whatever you like), which contains a sequence of commands. </li></ul><br>  Let us examine in more detail the above example of the init.lua startup script. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c5a/9fb/cdd/c5a9fbcdd5dee8b621859f96eb4ae339.png"><br><br>  Work begins with the base with its configuration, i.e.  the <code>box.cfg</code> mechanism is a <code>box</code> package that contains a <code>cfg</code> label inside itself, and I can set some of its parameters.  A box is a box, a box.  This package is directly responsible for the database.  You can just run Tarantool, execute procedures, functions, write some messages, etc., but you won‚Äôt run the database without configuring <code>box.cfg</code> .  In this case, I set two parameters that I would like to see.  First, I set the level of the logs to be printed - this is the fifth level, DEBUG.  I also set a very important parameter <code>slab_alloc_arena</code> - this is the memory that is allocated in Tarantool - more precisely, in RAM - for allocating and placing data.  In this case, ‚Äú1‚Äù is 1 GB. <br><br>  Also, the box package contains many other auxiliary things and tools, such as: <br><ul><li>  <code>box.info</code> is a library that displays general information about Tarantool. </li><li>  <code>box.slab</code> is an important <code>box.slab</code> with which we monitor the data of our Tarantool and see how much space we have left. </li><li>  <code>box.stat</code> is a statistics library, shows the number of <code>insert</code> , <code>select</code> and other operations that you performed. </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/cda/a74/96d/cdaa7496d88d9ce4442f52b38851a940.png"><br><br>  If in the Tarantool interpreter, after setting the parameters, type <code>box.cfg</code> , then you will get an object with a description of all the parameters that are - not only those that I specified, but also those that are set by default. <br><br>  Here we see that I have set <code>slab_alloc_arena</code> - 1 GB allocation space, see <code>log_level</code> five <code>log_level</code> (DEBUG), we also see an important parameter <code>snapshot_count</code> - this is the number of snapshots that Tarantool will store.  In this case, it will store the last 6 images that were taken over a certain period.  By the way, this period is also set here using the <code>snapshot_period</code> parameter;  its default value is 3600 seconds, i.e.  Tarantool will take a snapshot once every hour.  You yourself can choose the required level of security, you can take a picture at least every second or minute, but it will take away your resources very much.  The <code>snap_dir</code> and <code>wal_dir</code> define where you store your snapshots and logs, respectively. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b1b/f8d/bc5/b1bf8dbc5d4ebf9ac5a73483c999eef2.png"><br><br>  Here is an example <code>box.info</code> package.  Here you can see information about Tarantool, i.e.  if Tarantool is running as a daemon, you can find out its pid, the version (version 1.6.5 is currently relevant), the running time and the status of your machine. <br><br>  After you have configured the data, you can proceed to create the entities themselves, the data itself inside Tarantool. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b0b/3e9/1e1/b0b3e91e114cece6a6c9fbb4e2c085dc.png"><br><br>  Here I gave a picture from the documentation.  This is an image of the Tarantool data model, i.e.  in Tarantool, data is stored in spaces, each space has an entity tuple - these are records and indices that you specify, primary or secondary. <br><br>  Having finished configuring, we proceed to populate the database, i.e.  I need a space in which I will set information about users. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6b4/bbf/178/6b4bbf178662746663dfb050b57568ff.png"><br><br>  You may notice that I placed this information in a conditional construct.  This was done for a specific purpose: if for some reason your Tarantool was stopped and you start it again with saved images and syllables, it will restore its state before starting, i.e.  takes a snapshot of the state and does an action from xlog.  If you run it like this, it will not allow you to create the necessary users space, but you probably don‚Äôt need it, so we often insert such a check in order not to get an error.  If we have not created such a space, then we create a space and an index to it.  In this case, the <code>primary</code> is the primary index in the form of trees, which is a single number. <br><br>  Later in the script I need to add new user records.  You can do this using the standard <code>insert</code> operation, where we pass the key-value pair, but in my case in this simple script it is convenient to do this with the help of <code>auto_increment</code> .  The user will log in, and the key will automatically be assigned one more than the number of records in the database at the moment.  If I want to know the number of records in my database, I can use the standard <code>len()</code> mechanism.  As you can see, the syntax is very simple and straightforward. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1e6/186/f21/1e6186f21a35c27287252d5370c7f5a9.png"><br><br>  As mentioned above, Tarantool is not just a database, but a full-featured Lua application server.  Probably, the developers here meant that in the Lua language you can write any modules and packages and thereby implement the logic you need.  In fact, you are not inventing a big bike - you can invent a few small ones if you really need it or not in other solutions. <br><br>  You can see all this in the repositories on GitHub.  The basic modules that are somehow used are http and queue.  For example, <a href="https://tarantool.org/try.html">try.tarantool.org is</a> written entirely in Tarantool, it uses Tarantool-storage, Tarantool-server.  Tarantool also supports LuaRocks, a package manager that works with its repository and through which it is very convenient to install packages.  This is done by one team. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/472/a74/0b0/472a740b0c13a9d472f4457fd92c3be0.png"><br><br>  Packages.  Packages need to connect. <br><br>  A package means any other Lua script that implements some kind of logic.  By connecting this package, you can get methods from this file, some data from this file, some variables.  In this example, I connect with the help of the require mechanism two packets, <code>console</code> and <code>log</code> . <br><br>  I launch the <code>console</code> on localhost and hang it on port 33013. With the help of the <code>log</code> package, I can write to the log.  The console here refers to the administrator console or remote management console, which allows you to monitor the status of Tarantool.  It's easy to do this: if your console is running, standard Unix tools or some other, such as telnet and rlwrap, will do.  telnet is needed to connect to the port and listen to it, a rlwrap for convenient command entry and saving command history. <br><br>  You can go to that Tarantool that works for you and see some information from <code>box.info</code> or <code>box.stat</code> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f5f/992/603/f5f992603e1ba997b609896cb205b9cb.png"><br><br>  The package I use and which is often needed is http.  This is still a limited HTTP server, but it works with many of the necessary mechanisms.  In this case, I connected the package, created the server, hung up the <code>route</code> for processing, launched it.  And then in the <code>handler</code> function I returned the response to the server as text information and set the <code>cookie</code> user - <code>tarantool_id</code> , <code>value = id</code> .  Also set the expiration time, i.e.  removal time;  Here <code>cookie</code> are stored for a year. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7c3/568/f5a/7c3568f5a33eaaa3dd45102682b04b17.png"><br><br>  The basic mechanisms of the <code>http</code> package allow for the implementation of minimal logic, i.e.  there is a very full server, there is a client.  This package works with cookies and supports Lua as some kind of embedded language for some variables inside the Template, i.e.  we can write small routines inside HTML on Lua. <br><br><pre> <code class="lua hljs">#!/usr/bin/tarantool <span class="hljs-comment"><span class="hljs-comment">-- Tarantool init script local log = require('log') local console = require('console') local server = require('http.server') local HOST = 'localhost' local PORT = 8008 box.cfg { log_level = 5, slab_alloc_arena = 1, } console.listen('127.0.0.1:33013') if not box.space.users then s = box.schema.space.create('users') s:create_index('primary', {type = 'tree', parts = {1, 'NUM'}}) end</span></span></code> </pre> <br>  I tried to tell the main points of this script, so you should already be more clear.  To fix, you can and once again walk.  We have an executable script Tarantool with a comment.  Next we connect packages through <code>require</code> .  We have two variables - <code>HOST</code> and <code>PORT</code> .  Next comes the configuration of Tarantool via <code>box.cfg</code> , and I set two parameters: <code>log_level</code> (logging level) and <code>slab_alloc_arena</code> (space for allocations). <br><br>  I create an admin console that I will use.  Further, if I do not have the necessary space, I create a <code>users</code> space using <code>box.schema.space.create</code> and create an index for it. <br><br><pre> <code class="lua hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> id = self:cookie(<span class="hljs-string"><span class="hljs-string">'tarantool_id'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> ip = self.peer.host <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> data = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>.info(<span class="hljs-string"><span class="hljs-string">'Users id = %s'</span></span>, id) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> id <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> data = <span class="hljs-string"><span class="hljs-string">'Welcome to tarantool server!'</span></span> box.space.users:auto_increment({ip}) id = box.space.users:<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self:render({ text = data}): setcookie({ name = <span class="hljs-string"><span class="hljs-string">'tarantool_id'</span></span>, value = id, expires = <span class="hljs-string"><span class="hljs-string">'+1y'</span></span> }) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> count = box.space.users:<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>() data = <span class="hljs-string"><span class="hljs-string">'You id is '</span></span> .. id .. <span class="hljs-string"><span class="hljs-string">'. We have '</span></span> .. count .. <span class="hljs-string"><span class="hljs-string">' users'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self:render({ text = data }) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> httpd = server.new(HOST, PORT) httpd:route({ <span class="hljs-built_in"><span class="hljs-built_in">path</span></span> = <span class="hljs-string"><span class="hljs-string">'/'</span></span> }, handler) httpd:start()</code> </pre> <br>  In the processing function, I receive <code>cookie</code> that are contained by a user who has visited my page.  I watch his IP, write to the log.  If the <code>id</code> not in <code>tarantool_id</code> , then I will autorate the IP information of this user into the database, look at its <code>id</code> and return the welcome information to the <code>data</code> and assign the <code>cookie</code> value to <code>id</code> .  Otherwise, I count the number of entries in our tables and return to the user just the number of unique visitors.  And at the end, when I described the function, I start the server itself and already work with it. <br><br>  This is a simple example, but thanks to modules and the extensibility of access to the Lua language, it can be added, added, added, and after some time brought to a state that is used in real projects. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6c1/b77/30d/6c1b7730dd52837d552d6a9ff1a3e577.png"><br><br>  Tarantool has a lot of different packages.  There is a package for working with JSON, there is a fiber package (I will talk about it in more detail below), yaml, the digest cryptographic library (contains the basic necessary encryption mechanisms).  There is a package of non-blocking sockets, and you can work on the network yourself, implement some protocols.  There is a work with MessagePack, there is a fio library (file input / output) for working with files.  And there is an interesting net.box mechanism that allows Tarantool to work on a binary protocol - for example, with another Tarantool;  It turns out very quickly and conveniently.  Also, net.box.sql is implemented for working with any relational SQL database. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/93b/be9/df2/93bbe9df286c37744b61875f7e1f86b8.png"><br><br>  Faybery are so-called light flows that work on the model of green threads.  The main difference between them and standard streams is that they are created and work inside Tarantool; therefore, they are created fairly quickly and have good switching performance.  They can be useful to you if you are implementing some kind of asynchronous model, or you need to run some kind of daemon, which executes something else in parallel with the main logic. <br><br>  The basic principles of working with a fayber: fayber needs to be created, fayber can be put on standby using fiber.sleep, and fiber_object is fiber.create, you can always equip it and finish working with it. <br><br>  Very convenient fiber.time library, which from the event loop that counts time, can always bring us the desired value. <br><br>  With the help of the fiber library, a very popular expirationd library was written, which can remove from the database for some reason;  usually this time, i.e.  everything that is stored, say, a month, can be removed and cleaned. <br><br>  We can talk about Tarantool for a long time, we also do not know everything.  I don‚Äôt know if the developers themselves know all about it.  You can always read the documentation on <a href="https://tarantool.org/">tarantool.org</a> , recently it has changed and become more readable. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fb7/b4b/330/fb7b4b330d2defebced8d71548ac7543.png"><br><br>  Tarantool supports most Unix-like systems, they have their own Buildbot, and we always monitor the emergence of new packages - we work on Red Hat Enterprise Linux.  Also, the Tarantool developers officially support the Tarantool package in the same Debian. <br><br>  And a very important point that I like: in Tarantool communication with developers is possible.  I had questions, I found developers on Skype.  Kostya Osipov, the main developer of Tarantool, read a small report on the queue at this conference.  For developers, especially beginners, it is very important to seek advice and learn first-hand how to do this or that.  We must be prepared that the guys who develop open-source applications are very peculiar, there is a very peculiar community.  Perhaps this picture will be able to say more than I could: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/363/523/9a2/3635239a2e3803bc3991253ccca62cfc.png"><br><br>  But at the same time, communication in the community can be a very interesting experience that will allow you to grow yourself and make your projects a little better. <br><br>  In the end I would like to summarize the report. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/379/a65/732/379a657322f4077006e3ac41792549b6.png"><br><br>  Each NoSQL solution has its own scope of application.  It is often very difficult to say which base is better or worse, which is more productive.  They really often solve different problems. <br><br>  A development tool is very important: a properly selected tool allows you to develop quickly and easily and avoid a lot of problems.  But do not forget that more important is the idea, the goal;  after all, the task of each developer is to solve a problem, implement some ideas of his own, and make this world a little bit better. <br><br>  I hope I could show you that Tarantool is completely uncomplicated and you can also try using it.  Thanks for attention. <br><br><blockquote>  <font color="gray">This report is a transcript of one of the best speeches at the training conference for developers of high-load systems <a href="http://junior.highload.ru/%3Futm_source%3Dhabr%26utm_medium%3Dmedia%26utm_campaign%3Dpast.articles%26utm_content%3Dcommon">HighLoad ++ Junior</a> .</font> <font color="gray"><br><br></font>  <font color="gray">Also, some of these materials are used by us in an online training course on the development of high-load systems <a href="http://highload.guide/%3Futm_source%3Dhabr%26utm_medium%3Dmedia%26utm_campaign%3Dpast.articles%26utm_content%3Dcommon">HighLoad.Guide</a> is a chain of specially selected letters, articles, materials, videos.</font>  <font color="gray">Already, in our textbook more than 30 unique materials.</font>  <font color="gray">Get connected!</font> <font color="gray"><br><br></font>  <font color="gray">Well, the main news is that we have begun preparations for the spring festival " <a href="http://ritfest.ru/">Russian Internet Technologies</a> ", which includes eight conferences, including <strong>HighLoad ++ Junior</strong> .</font> </blockquote></div><p>Source: <a href="https://habr.com/ru/post/319968/">https://habr.com/ru/post/319968/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../319958/index.html">StressCam - an application to control stress, biological age and improve well-being</a></li>
<li><a href="../319960/index.html">Why Russia has a lot of ideas, but few startups</a></li>
<li><a href="../319962/index.html">Visual C ++ Extension for Linux Development</a></li>
<li><a href="../319964/index.html">Email Video: 8 Application Tips</a></li>
<li><a href="../319966/index.html">As I parsed the entire database of Metacritic games</a></li>
<li><a href="../319970/index.html">Welcome aboard: application guidance tips</a></li>
<li><a href="../319974/index.html">Soccer ball and fullerenes</a></li>
<li><a href="../319976/index.html">Sooo long whole</a></li>
<li><a href="../319978/index.html">Akso HTTP WebSocket in practice</a></li>
<li><a href="../319980/index.html">How SEO-agency spent 600 thousand rubles. on advertising and what came of it</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>