<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to determine "Where am I?" In applications on Windows Mobile</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How are location dependent applications implemented today? As a rule, the use of GPS devices that are capable of providing coordinates of the current ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to determine "Where am I?" In applications on Windows Mobile</h1><div class="post__text post__text-html js-mediator-article">  How are location dependent applications implemented today?  As a rule, the use of GPS devices that are capable of providing coordinates of the current location comes to mind.  However, GPS devices are far from being everywhere and not always.  Let's try to figure out how to implement a richer way to determine your current location. <br><a name="habracut"></a><br>  To date, many applications - mobile and desktop - acquire new features and implement various interesting and non-standard scenarios.  To such unusual today applications include applications that adapt to the current conditions in which the user is located.  For example, it can be an application that changes the brightness and font size in low light or an application that changes its user interface depending on where the user is now (at home, in the office, etc.).  Such applications have a common name - context-sensitive applications.  One of the particular cases of context-sensitive applications is applications that depend on the geographic location of the user.  For example, if an application displays a weather forecast, then it would be logical to display it for the particular location where the user is located.  Similarly, it would be logical to keep counting the time in the exact time zone where the user is located.  There are many examples of such scenarios, which once again proves the value of such applications in real life. <br><br>  How are location dependent applications implemented today?  As a rule, the use of GPS devices that are capable of providing coordinates of the current location comes to mind.  However, GPS devices are far from being everywhere and not always.  Moreover, the use of GPS-devices is limited by the fact that they can not be used inside buildings and enclosed spaces.  Often at this stage ideas about getting the current location end.  However, if you think about it, there are other sources for obtaining this information.  Since in our case we are talking about Windows Mobile, and devices based on this operating system often have a GSM module, the location information can be taken from the base stations of the state operators.  In addition, do not forget about location services by IP-address - on such devices, the mobile Internet is configured in most cases. <br><br>  Each of the above methods has its own advantages and disadvantages.  Therefore, each method can only work under certain conditions and under certain restrictions.  The most correct way is to use all the methods given earlier and combine the advantages of these methods in one application. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Throughout this article, we will look at the process of creating an application for Windows Mobile, in which we will use several alternative sources of information and build an application that can receive location information in various conditions.  Before proceeding to the implementation of the application itself, let's consider each of the ways to obtain information about the location. <br><br><h1>  GPS </h1><br>  GPS is the most popular way to get location information.  This method works in devices equipped with a GPS receiver.  For this, the GPS receiver uses several satellites at the same time (at least 4) and, based on this, it obtains the coordinates of the current location.  In addition to direct coordinates, the GPS receiver also provides information on the current speed, direction (north-south-west-east), altitude, etc.  In our case, only coordinates will be needed, so we will not use the other parameters. <br><br>  The advantages of this method include the accuracy of the information received and the possibility of its constant updating (in the case of movement).  Moreover, in general, to obtain the coordinates, no connection to the Internet or the cellular operator‚Äôs network is required.  However, GPS also has disadvantages.  Firstly, GPS receivers, as a rule, do not work in enclosed spaces (this is due to the peculiarities of the technology itself).  Secondly, it is often necessary for a GPS receiver to take some time (from a few seconds to a few minutes) in order to establish communication with the satellites.  Finally, at some point in time, the GPS receiver may simply not establish communication with the satellites due to weather conditions, your location relative to the satellites or other reasons.  All this creates inconvenience when working with GPS, and in some situations may make it impossible to use this method. <br><br>  Different approaches can be used to work with a GPS receiver in Windows Mobile.  Usually, a GPS receiver delivers its data through a COM port.  Therefore, you can connect to it and read all the necessary information.  However, with this approach there may be problems with connecting several applications to the GPS receiver.  In addition, in this case, we will have to manually parse the data formats that come from the receiver (a trifle, but not nice).  Therefore, in this case, it is recommended to use some ‚Äúlayer‚Äù in Windows Mobile, which allows you to centrally obtain information from a GPS device - the GPS API.  In fact, the GPS API works directly with the COM port, processes data and provides interfaces for other applications.  Using the GPS API, applications can receive all the information that is available from the GPS receiver. <br><br>  To work with the GPS API in Windows Mobile, there is a library gpsapi.dll, which comes with the operating system.  This library is unmanaged, so you need to use PInvoke to work with it.  Fortunately, Microsoft has already made a managed wrapper for this library, which comes with the Windows Mobile 6 SDK.  In our case, we will take this wrapper for use in our application. <br><br>  Using a manageable wrapper is quite simple.  To do this, you must create a NativeWrapperGps object, subscribe to the LocationChanged event, and call the Open method.  When the current location changes, a LocationChanged event will be generated.  After you finish working with the GPS device, you must call the Close method.  In general, work through the GPS API may look like this. <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">var</font> gps = <font color="#0000ff">new</font> NativeWrapperGps(); <br> gps.LocationChanged += <font color="#0000ff">delegate</font> ( <font color="#0000ff">object</font> sender, NativeWrapperGps.LocationChangedEventArgs args) <br> { <br> <font color="#008000">//..</font> <br> }; <br> gps.Open(); <br> <font color="#008000">// ..</font> <br> gps.Close();</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Thus, we can work with a GPS receiver in Windows Mobile and get information about your current location. <br><br><h1>  Cellular networks </h1><br>  Another source of information about the current location can be information that is available from the cellular operator.  Since wireless networks are based on the ‚Äúcell‚Äù principle, at each moment we work with a specific base station.  Each base station has a unique identifier that identifies each base station.  This identifier consists of several values ‚Äã‚Äã- Cell ID (or Tower ID), Location Area Code (LAC), Mobile Country Code (MCC) and Mobile Network Code (MNC).  All these values ‚Äã‚Äãcan be obtained from the base station and they will be unique for each base station. <br><br>  However, the identifier itself is not valuable location information.  However, there are centralized databases that associate these identifiers with geographic information.  It is clear that the accuracy of determining the location of the user depends on how much the base station serves.  However, such accuracy can satisfy the user often enough. <br><br>  Thus, the proposed method does not contain the disadvantages of the method of determining the location using GPS - no long initialization is required, the determination process does not depend on weather conditions and the position of the satellites, and the position determination occurs quickly enough.  However, the above method also has disadvantages.  The main disadvantage is the low accuracy of the positioning: if the GPS determines the coordinates with an accuracy of several meters, then the above method can ‚Äúmake a mistake‚Äù for several kilometers.  In addition, centralized databases may not contain information about the base station with which you are currently working - in this case, it is impossible to determine the location.  Finally, location determination requires coverage of the networks of mobile operators, as well as access to the Internet (GPRS, EDGE, 3G, etc.).  Access to the global network is necessary in order to use the services of a centralized database to determine the coordinates.  Thus, it is clear that this method has a rather serious limitation, but in some cases it can be applied quite successfully. <br><br>  In order to receive information from the GSM module of the phone, you can use the library ril.dll (RIL, Radio Interface Layer).  This library comes with the operating system and is developed on unmanaged code.  For this reason, you can use its functions through PInvoke.  RIL provides many interesting features that you can use.  In our case, it is necessary to obtain information about the base station, this can be done using the GetCellTowerInfo function.  Before using this function, you must call the initialization function, and after use - deinitialization.  During initialization, the method that will be called after receiving the information is specified (the process of obtaining information about the base station is asynchronous).  Thus, working with RIL will require a small wrapper over the unmanaged library. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#0000ff">class</font> RilInterop <br> { <br> <font color="#0000ff">public</font> <font color="#0000ff">delegate</font> <font color="#0000ff">void</font> RilResultCallback( <font color="#0000ff">uint</font> dwCode, <font color="#2B91AF">IntPtr</font> hrCmdID, <font color="#2B91AF">IntPtr</font> lpData, <font color="#0000ff">uint</font> cbData, <font color="#0000ff">uint</font> dwParam); <br> <font color="#0000ff">public</font> <font color="#0000ff">delegate</font> <font color="#0000ff">void</font> RilNotifyCallback( <font color="#0000ff">uint</font> dwCode, <font color="#2B91AF">IntPtr</font> lpData, <font color="#0000ff">uint</font> cbData, <font color="#0000ff">uint</font> dwParam); <br> [DllImport( <font color="#A31515">"ril.dll"</font> , EntryPoint = <font color="#A31515">"RIL_Initialize"</font> )] <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#0000ff">extern</font> <font color="#2B91AF">IntPtr</font> Initialize( <font color="#0000ff">uint</font> dwIndex, RilResultCallback pfnResult, RilNotifyCallback pfnNotify, <font color="#0000ff">uint</font> dwNotificationClasses, <font color="#0000ff">uint</font> dwParam, <font color="#0000ff">out</font> <font color="#2B91AF">IntPtr</font> lphRil); <br> [DllImport( <font color="#A31515">"ril.dll"</font> , EntryPoint = <font color="#A31515">"RIL_GetCellTowerInfo"</font> )] <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#0000ff">extern</font> <font color="#2B91AF">IntPtr</font> GetCellTowerInfo( <font color="#2B91AF">IntPtr</font> hRil); <br> [DllImport( <font color="#A31515">"ril.dll"</font> , EntryPoint = <font color="#A31515">"RIL_Deinitialize"</font> )] <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#0000ff">extern</font> <font color="#2B91AF">IntPtr</font> Deinitialize( <font color="#2B91AF">IntPtr</font> hRil); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  After that, you need to initialize the RIL, specify the callback method, call the GetCellTowerInfo method and call the de-initialization method.  The data will be received in asynchronous mode, so if you need to receive them synchronously, you need to use synchronization objects, for example, AutoResetEvent.  Thus, obtaining information about the base station will be as follows. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> RilWrapper <br> { <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> RilCellTowerInfo _towerDetails; <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> <font color="#0000ff">readonly</font> AutoResetEvent WaitHandle = <font color="#0000ff">new</font> AutoResetEvent( <font color="#0000ff">false</font> ); <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> CellTower GetCellTowerInfo() <br> { <br> <font color="#2B91AF">IntPtr</font> rilHandle; <br> <font color="#0000ff">if</font> (RilInterop.Initialize(1, CellDataCallback, <font color="#0000ff">null</font> , 0, 0, <font color="#0000ff">out</font> rilHandle) != <font color="#2B91AF">IntPtr</font> .Zero) <br> { <br> <font color="#0000ff">return</font> <font color="#0000ff">null</font> ; <br> } <br> RilInterop.GetCellTowerInfo(rilHandle); <br> WaitHandle.WaitOne(); <br> RilInterop.Deinitialize(rilHandle); <br> <font color="#0000ff">return</font> <font color="#0000ff">new</font> CellTower <br> { <br> TowerId = <font color="#2B91AF">Convert</font> .ToInt32(_towerDetails.DwCellID), <br> LocationAreaCode = <font color="#2B91AF">Convert</font> .ToInt32(_towerDetails.DwLocationAreaCode), <br> MobileCountryCode = <font color="#2B91AF">Convert</font> .ToInt32(_towerDetails.DwMobileCountryCode), <br> MobileNetworkCode = <font color="#2B91AF">Convert</font> .ToInt32(_towerDetails.DwMobileNetworkCode), <br> }; <br> } <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#0000ff">void</font> CellDataCallback( <font color="#0000ff">uint</font> dwCode, <font color="#2B91AF">IntPtr</font> hrCmdID, <font color="#2B91AF">IntPtr</font> lpData, <font color="#0000ff">uint</font> cbData, <font color="#0000ff">uint</font> dwParam) <br> { <br> _towerDetails = <font color="#0000ff">new</font> RilCellTowerInfo(); <br> Marshal.PtrToStructure(lpData, _towerDetails); <br> WaitHandle.Set(); <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  After calling the GetCellTowerInfo () method, an object will be returned containing values ‚Äã‚Äãthat characterize the current base station.  As mentioned above, to obtain geographic coordinates based on this information, it is necessary to use a publicly available database.  For example, such information contains the open service OpenCellId (opencellid.org).  Using this resource, you can get location coordinates from base station information.  Using the specified URL format, you can access the service and get the answer in the form of XML.  To recognize the information from this service, create a small object that performs these functions. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> OpenCellIdProvider : ICellToGpsProvider <br> { <br> <font color="#0000ff">public</font> GpsLocation GetCoordinates( <font color="#0000ff">int</font> cellId, <font color="#0000ff">int</font> locationAreaCode, <font color="#0000ff">int</font> mobileCountryCode, <font color="#0000ff">int</font> mobileNetworkCode) <br> { <br> GpsLocation result = <font color="#0000ff">null</font> ; <br> <font color="#0000ff">var</font> doc = <font color="#2B91AF">XDocument</font> .Load( <font color="#2B91AF">String</font> .Format( <font color="#A31515">"http://www.opencellid.org/cell/get?key={4}&amp;mnc={3}&amp;mcc={2}&amp;lac={1}&amp;cellid={0}"</font> , cellId, locationAreaCode, mobileCountryCode, mobileNetworkCode, Key)); <br> <font color="#0000ff">if</font> ((doc.Root != <font color="#0000ff">null</font> ) &amp;&amp; (doc.Root. <font color="#2B91AF">Attribute</font> (XName.Get( <font color="#A31515">"stat"</font> )).Value == <font color="#A31515">"ok"</font> )) <br> { <br> <font color="#0000ff">var</font> cellInfoElem = doc.Root.Element(XName.Get( <font color="#A31515">"cell"</font> )); <br> <font color="#0000ff">if</font> (cellInfoElem != <font color="#0000ff">null</font> ) <br> { <br> result = <font color="#0000ff">new</font> GpsLocation <br> { <br> Latitude = <font color="#2B91AF">Convert</font> .ToDouble(cellInfoElem. <font color="#2B91AF">Attribute</font> (XName.Get( <font color="#A31515">"lat"</font> )).Value.Replace('.', ',')), <br> Longitude = <font color="#2B91AF">Convert</font> .ToDouble(cellInfoElem. <font color="#2B91AF">Attribute</font> (XName.Get( <font color="#A31515">"lon"</font> )).Value.Replace('.', ',')) <br> }; <br> } <br> } <br> <font color="#0000ff">return</font> result; <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Now, after receiving information about the base station, we can access this service and get the coordinates of the current location. <br><br><h1>  Geoip </h1><br>  The last method that we consider as an option to get the current location is to determine the current coordinates based on the IP address.  Since most devices have a GRPS connection to the Internet, this method can work quite successfully.  Obtaining a location by IP address is an operation that does not always return accurate information.  Due to the use of ‚Äúgray‚Äù IP addresses, information can be very different from reality (for example, when a Russian IP address is determined by Irish).  However, when using the mobile Internet, the probability of obtaining the correct information is higher.  Therefore, we will consider this method as one of the alternatives. <br><br>  The strength of this method is that it does not depend on the presence of a GPS receiver, weather conditions and the possibility of a satellite connection.  In addition, this method does not depend on the availability of information in the database of base stations.  However, the disadvantages of this method are present and they are quite significant.  First, the accuracy of positioning often leaves much to be desired.  As a rule - this is the framework of the city (not even the district).  However, if this level of detail is fine, then why not?  Another disadvantage is the need for an internet connection;  if there is no internet connection, then this method does not work.  Moreover, the majority of full-fledged location tools by IP address are either chargeable or impose restrictions on the number of hits. <br><br>  However, let's take note of this method for the case when all of the listed restrictions are not significant.  GeoIp-services there are a great many.  Most of them are paid, others may simply require registration.  In our case, we will focus on the GeoIpTool service (geoiptool.com), in the general case, you can use any one presented on the Internet.  This service returns HTML when referring to its main page, within which there are coordinates corresponding to the client's IP address.  In this case, we simply process the HTML code and get the coordinates from it. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> GpsLocation GetLocation() <br> { <br> <font color="#0000ff">double</font> ? lat = <font color="#0000ff">null</font> ; <br> <font color="#0000ff">double</font> ? lon = <font color="#0000ff">null</font> ; <br> <font color="#0000ff">var</font> html = GetHtml( <font color="#A31515">"http://www.geoiptool.com/en/"</font> ); <br> <font color="#0000ff">var</font> lines = Regex.Matches(html.Replace( <font color="#A31515">"\r"</font> , <font color="#A31515">" "</font> ).Replace( <font color="#A31515">"\n"</font> , <font color="#A31515">" "</font> ), <font color="#A31515">@"&lt;tr&gt;(.)+?&lt;/tr&gt;"</font> , RegexOptions.IgnoreCase); <br> <font color="#0000ff">foreach</font> (Match line <font color="#0000ff">in</font> lines) <br> { <br> <font color="#0000ff">try</font> <br> { <br> <font color="#0000ff">if</font> (line.Value.Contains( <font color="#A31515">"Longitude:"</font> )) <br> { <br> lon = <font color="#2B91AF">Convert</font> .ToDouble(Regex.Match(line.Value, <font color="#A31515">@"&lt;td(.)*?&gt;(?&lt;val&gt;[0-9\.]+)&lt;/td&gt;"</font> ).Groups[ <font color="#A31515">"val"</font> ].Value.Replace('.', ',')); <br> } <br> <font color="#0000ff">if</font> (line.Value.Contains( <font color="#A31515">"Latitude:"</font> )) <br> { <br> lat = <font color="#2B91AF">Convert</font> .ToDouble(Regex.Match(line.Value, <font color="#A31515">@"&lt;td(.)*?&gt;(?&lt;val&gt;[0-9\.]+)&lt;/td&gt;"</font> ).Groups[ <font color="#A31515">"val"</font> ].Value.Replace('.', ',')); <br> } <br> } <br> <font color="#0000ff">catch</font> (FormatException) <br> { <br> } <br> } <br> <font color="#0000ff">return</font> (lat != <font color="#0000ff">null</font> ) &amp;&amp; (lon != <font color="#0000ff">null</font> ) ? <font color="#0000ff">new</font> GpsLocation { Latitude = ( <font color="#0000ff">double</font> )lat, Longitude = ( <font color="#0000ff">double</font> )lon } : <font color="#0000ff">null</font> ; <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Thus, we can get your location by IP address. <br><br><h1>  Build the final application </h1><br>  Now that we can determine the current location in at least three ways, let's build an application that will use all of these methods at the same time.  Since each of the methods has its own advantages and disadvantages, we will arrange these methods in order of priority.  It is clear that the most accurate way is to determine the coordinates based on GPS data.  Therefore, we will use it in priority.  In cases where the GPS receiver is not in the device or it cannot connect to the satellites, we will use data from the base stations of the mobile network.  In this case, the accuracy of the determination will be reduced, but we can find out your approximate location.  Finally, if for some reason we could not find out the location in this way (for example, data on the current base station were not found in the database), then you can find out the location using the mobile Internet and IP address.  In this case, the accuracy will decrease even more, but we will get the information. <br><br>  To work in this mode, I would like to have a general mechanism to which we will ask a question about the current location, and it, in turn, determines the location in an accessible way.  To do this, each of the methods will implement the provider interface ILocationProvider, defined as follows. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">interface</font> ILocationProvider <br> { <br> GpsLocation GetLocation(); <br> <font color="#0000ff">string</font> ProviderName { <font color="#0000ff">get</font> ; } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  This interface contains a method for retrieving the current location, and also returns the name of the provider.  After that, it is necessary to implement this interface in the objects that implement the logic for each of the above methods.  It is easy to guess how this can be done on the basis of the code provided for each of the methods.  Finally, an object is needed that performs the function of coordinating all providers, a kind of manager.  This object must contain a collection of available providers and, when accessing it, it must alternately poll each provider.  If a higher-priority provider generated an exception or simply returned null, then you need to contact the next provider, etc.  Thus, the following class description for such an object is obtained. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> LocationManager : ILocationProvider <br> { <br> <font color="#0000ff">private</font> <font color="#0000ff">readonly</font> <font color="#2B91AF">List</font> &lt;ILocationProvider&gt; _providers = <font color="#0000ff">new</font> <font color="#2B91AF">List</font> &lt;ILocationProvider&gt;(); <br> <font color="#0000ff">private</font> <font color="#0000ff">string</font> _lastProviderName = <font color="#0000ff">null</font> ; <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> ClearProviders() <br> { <br> _providers.Clear(); <br> } <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> RegisterProvider(ILocationProvider provider) <br> { <br> <font color="#0000ff">if</font> (_providers.Contains(provider)== <font color="#0000ff">false</font> ) <br> { <br> _providers.Add(provider); <br> } <br> } <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> RemoveProvider(ILocationProvider provider) <br> { <br> <font color="#0000ff">if</font> (_providers.Contains(provider) == <font color="#0000ff">true</font> ) <br> { <br> _providers.Remove(provider); <br> } <br> } <br> <font color="#0000ff">#region</font> ILocationProvider Members <br> <font color="#0000ff">public</font> GpsLocation GetLocation() <br> { <br> GpsLocation result = <font color="#0000ff">null</font> ; <br> _lastProviderName = <font color="#0000ff">null</font> ; <br> <font color="#0000ff">foreach</font> ( <font color="#0000ff">var</font> provider <font color="#0000ff">in</font> _providers) <br> { <br> <font color="#0000ff">try</font> <br> { <br> result = provider.GetLocation(); <br> <font color="#0000ff">if</font> (result != <font color="#0000ff">null</font> ) <br> { <br> _lastProviderName = provider.ProviderName; <br> <font color="#0000ff">break</font> ; <br> } <br> } <br> <font color="#0000ff">catch</font> (Exception ex) <br> { <br> <font color="#0000ff">continue</font> ; <br> } <br> } <br> <font color="#0000ff">return</font> result; <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> ProviderName <br> { <br> <font color="#0000ff">get</font> { <font color="#0000ff">return</font> _lastProviderName; } <br> } <br> <font color="#0000ff">#endregion</font> <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Thus, in order to use this mechanism, it is necessary to register all the necessary providers, and then contact the manager object with the question ‚Äúwhere am I?‚Äù.  For example, this code may look like this. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">LocationManager manager = <font color="#0000ff">new</font> LocationManager(); <br> manager.RegisterProvider( <font color="#0000ff">new</font> GpsLocationProvider()); <br> manager.RegisterProvider( <font color="#0000ff">new</font> CellLocationProvider( <font color="#0000ff">new</font> OpenCellIdProvider())); <br> manager.RegisterProvider( <font color="#0000ff">new</font> GeoIpLocationProvider()); <br> <font color="#0000ff">var</font> location = manager.GetLocation();</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  In the case when it is necessary to exclude any of the providers from the process, we simply do not register it.  Finally, you can display the received coordinates on the map and display them to the user. <br><br><img src="http://www.gotdotnet.ru/personal/sergun/content/binary/WindowsLiveWriter/WindowsMobile_F05F/image_8653d54f-a7dd-4533-94a4-e307c8eb0702.png"><br><br>  Thus, we received an application that uses several alternative sources of information to obtain its location: if at the moment you can use GPS, then this method is used, if GPS is not available, then alternative methods are used, albeit less accurate. <br><br><h1>  Instead of conclusion </h1><br>  Applications that respond to context changes are becoming increasingly popular in the midst of the development of modern applications.  Mobile applications are no exception.  However, many developers still consider a GPS receiver as the only means of obtaining information about their current location.  Here we looked at the way in which it is possible to obtain such information in case of impossibility of using GPS and even without a GPS receiver.  Often, alternative methods are less accurate in determining location, but accuracy is not needed everywhere and not always - a large number of scenarios are perfectly implemented based on the information about the city in which I am or even the country.  Therefore, you do not need to limit yourself to such opportunities, but simply turn on the fantasy and start using context-sensitive scripts in your applications. <br><br>  Thank you for reading to the end and good luck in building your applications!  :) <br><br>  Source codes of the application: <br>  <a title="LocationAwareApp.zip" href="">LocationAwareApp.zip</a> </div><p>Source: <a href="https://habr.com/ru/post/78724/">https://habr.com/ru/post/78724/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../78712/index.html">Imobilco: This strawberry causes heat inside</a></li>
<li><a href="../78715/index.html">Medvedev Group on Habr√©!</a></li>
<li><a href="../78716/index.html">Augmented reality - what's inside ?!</a></li>
<li><a href="../78718/index.html">Creation and promotion of a restaurant brand in the province</a></li>
<li><a href="../78721/index.html">Have you disconnected from the former providers?</a></li>
<li><a href="../78725/index.html">We write candidate's work</a></li>
<li><a href="../78726/index.html">File Grinder: Batch rename files (FB2, MP3, etc.)</a></li>
<li><a href="../78727/index.html">iPhone Client Forismatic</a></li>
<li><a href="../78728/index.html">Asymptotic analysis of algorithms</a></li>
<li><a href="../78732/index.html">Visual sugar for ActiveRecord</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>