<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Integration of the physics engine Box2D into the UIKit application for iOS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 
 Today we will show how easy it is to integrate the Box2D physics engine into any gaming application written in standard Apple frameworks. An ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Integration of the physics engine Box2D into the UIKit application for iOS</h1><div class="post__text post__text-html js-mediator-article"><h4>  Hello! </h4><br>  Today we will show how easy it is to integrate the Box2D physics engine into any gaming application written in standard Apple frameworks.  An example would be an interactive book released by our studio six months ago.  This book was our first application for children, and when we started working on it, we had little experience in creating animations, so we chose the standard Apple frameworks that we knew were powerful and well-documented - it was easier at that time.  The book was ready in two months.  However, some ideas were not implemented.  Of these wishes, a list was left for the future, so that when there is time and knowledge, return to the project. <br><br><h4>  Physics </h4><br>  One of the points was the simulation of the physical world, so that the user had the opportunity to play with objects: create them, throw them, throw them from corner to corner with accelerometer means, and so on.  To realize this possibility, integration into the project of a physics engine was required.  And now, when Cocos2D and Box2D were mastered on the new project, a reasonable question arose: if Box2D is inherently independent of the graphical implementation of the program, then why not use it in the very first book? <a name="habracut"></a>  Short searches in the open spaces of the Web led to a wonderful and concise blog <a href="http://www.cocoanetics.com/2010/05/physics-101-uikit-app-with-box2d-for-gravity/">article</a> <a href="http://www.cocoanetics.com/">http://www.cocoanetics.com</a> , which explains how to use Box2D in a standard application on UIKit.  And we set to work.  We were most concerned about the fact that the work of the engine written in C ++ will require large-scale changes in the current project code.  But, fortunately, it only cost a couple of small changes - the type of the page class files was changed to Objective-C ++, and the code was easily optimized.  These changes took about 4 hours. <br><br><h4>  Principle of operation </h4><br>  The principle of integration of the engine is simple (see the specified article).  When you load the page creates a physical world.  Next, he is assigned the required boundaries (in this case, the entire screen), and the required bodies are created.  Since the created bodies are not visible to the user, they are assigned the necessary UIKit objects, for example, pictures of the UIImageView class, using the body property userData.  Further, when calling the viewDidAppear method, a timer is started with the desired frequency, which, processing the positions of all bodies in the physical world, moves the corresponding images associated with the bodies to the desired positions.  This creates the illusion that the images themselves directly collide.  When the call to viewDidDissapear method is called, the timer stops, all the bodies created by the user and the corresponding images are removed from the world and from self.view.  Contrary to the fears that this scheme will not give an acceptable frame rate, the rendering was fast even on older devices like the iPhone 3G, not worse than rendering in an application based on Cocos2D. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Bodies </h4><br>  The method described in the original article allowed to create only rectangular bodies according to the size of the view transmitted in the message about the creation of the body.  For us, this was not a flexible way, since we could have any form of body.  In our work on the Cocos2D-based project, we used a handy program for Mac OS - <a href="http://itunes.apple.com/ru/app/spritehelper/id416068717%3Fmt%3D12">SpriteHelper</a> from the individual developer Bogdan Vladu.  A paid license allows you to make texture maps from pre-fabricated images and set parameters for physical bodies: shape, density, friction coefficient, elasticity, etc.  - all you need.  To work with the received files, the author wrote the SpriteHelperLoader class, which allows you to create the desired body in the desired physical world and the Cocos2D layer in one message.  One problem - this class was rigidly focused on collaboration with Cocos2D.  I had to spend some time and ‚Äúcut out‚Äù all the references to ‚Äúcoconut‚Äù from it.  In fact, we only needed it to get one body parameter ‚Äî a form (texture maps in this case are not used).  Now we have a comfortable, and most importantly familiar way in our hands to add physics to our first books, give them a second wind and, we hope, add some positive feedback.  The original method of adding bodies from the original article was rewritten: <br><pre><code class="hljs haskell">- (void) addPhysicalBodyForView:(<span class="hljs-type"><span class="hljs-type">UIImageView</span></span> *)physicalImageView ofType:(<span class="hljs-type"><span class="hljs-type">NSString</span></span> *)<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> { // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">image's</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">center</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">coordinates</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CGPoint</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">position</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">physicalImageView</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">center</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Define</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dynamic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">body</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b2BodyDef</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bodyDef</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bodyDef</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b2_dynamicBody</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bodyDef</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">position</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Set</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">position</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">/</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PTM_RATIO</span></span></span><span class="hljs-class">, (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">screenSize</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> - </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">position</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">)/</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PTM_RATIO</span></span></span><span class="hljs-class">); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">convert</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">into</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Box2D</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">coordinates</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bodyDef</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">userData</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">physicalImageView</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Tell</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">physics</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">world</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">body</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b2Body</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">body</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">world</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateBody</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bodyDef</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">position</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CGPointMake</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bodyDef</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">position</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bodyDef</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">position</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">use</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">modified</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SpriteHelperLoader</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shape</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tempBody</span></span></span><span class="hljs-class"> = [</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bodyLoader</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bodyWithUniqueName</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">atPosition</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">position</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">world</span></span></span><span class="hljs-class">:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">world</span></span></span><span class="hljs-class">]; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b2Fixture</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fixture</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tempBody</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetFixtureList</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b2Shape</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shape</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fixture</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetShape</span></span></span><span class="hljs-class">(); // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Define</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dynamic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">body</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fixture</span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b2FixtureDef</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fixtureDef</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fixtureDef</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shape</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shape</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fixtureDef</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">density</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fixture</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetDensity</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fixtureDef</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">friction</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fixture</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetFriction</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fixtureDef</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">restitution</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fixture</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetRestitution</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">body</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CreateFixture</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fixtureDef</span></span></span><span class="hljs-class">); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dynamic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">body</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">reacts</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">forces</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">right</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">away</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">body</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SetType(b2_dynamicBody)</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">world</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DestroyBody(tempBody)</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fixture</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shape</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil</span></span></span><span class="hljs-class">; }</span></span></code> </pre> <br><br><h4>  Touch processing </h4><br>  For touch processing, we used Box2D's <a href="http://www.learn-cocos2d.com/api-ref/1.0/Box2D/html/classb2_world.html">built-in mechanism</a> and <a href="http://developer.apple.com/library/ios/">standard</a> UIKit touch registration <a href="http://developer.apple.com/library/ios/">methods</a> .  When a touch is registered on the main view, the coordinates of the touch point are transformed from the UIKit coordinate system to the Box2D coordinate system.  Next, there is a check for hit in any body in the physical world.  And if there is a hit, then a physical connection with the body-ground (groundBody) is created between this body, which allows you to drag the body with your finger across the screen.  When the touch is completed, the body is sent to free flight (by destroying the connection) according to the impulse acquired during the movement.  It looks quite natural.  It is worth noting that in order for your dragged bodies to not fly out of the screen, it is necessary to allow the calculation of collisions for the created connection between the bodies.  For this, the collideConnected property must be set to YES. <br><pre> <code class="hljs dos">class QueryCallback : public b2QueryCallback { public: QueryCallback(const b2Vec2&amp; point) { m_point = point; m_fixture = NULL; } bool ReportFixture(b2Fixture* fixture) { b2Body* body = fixture-&gt;GetBody(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (body-&gt;GetType() == b2_dynamicBody) { bool inside = fixture-&gt;TestPoint(m_point); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inside) { m_fixture = fixture; // We are done, terminate the query. return false; } } // Continue the query. return true; } b2Vec2 m_point; b2Fixture* m_fixture; }; [...] #pragma mark - Drag and Drop // source - http://iphonedev.<span class="hljs-built_in"><span class="hljs-built_in">net</span></span>/<span class="hljs-number"><span class="hljs-number">2009</span></span>/<span class="hljs-number"><span class="hljs-number">08</span></span>/<span class="hljs-number"><span class="hljs-number">05</span></span>/how-to-grab-a-sprite-with-cocos2d-and-box2d/ - (void) touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event { UITouch* myTouch = [touches anyObject]; CGPoint location = [myTouch locationInView: [myTouch view]]; location = CGPointMake(location.x, screenSize.height-location.y); m_mouseWorld.<span class="hljs-built_in"><span class="hljs-built_in">Set</span></span>(location.x/PTM_RATIO, location.y/PTM_RATIO); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_mouseJoint != NULL) { NSLog(@"m_mouseJoint != NULL"); return; } b2AABB aabb; b2Vec2 d; d.<span class="hljs-built_in"><span class="hljs-built_in">Set</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">001</span></span>f, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">001</span></span>f); aabb.lowerBound = m_mouseWorld - d; aabb.upperBound = m_mouseWorld + d; // Query the world <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> overlapping shapes. QueryCallback callback(m_mouseWorld); world-&gt;QueryAABB(&amp;callback, aabb); b2Body* nbody = NULL; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (callback.m_fixture) { nbody = callback.m_fixture-&gt;GetBody(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nbody) { b2MouseJointDef <span class="hljs-built_in"><span class="hljs-built_in">md</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">md</span></span>.bodyA = groundBody; // <span class="hljs-built_in"><span class="hljs-built_in">md</span></span>.bodyB = nbody; <span class="hljs-built_in"><span class="hljs-built_in">md</span></span>.target = m_mouseWorld; <span class="hljs-built_in"><span class="hljs-built_in">md</span></span>.collideConnected = YES; #ifdef TARGET_FLOAT32_IS_FIXED <span class="hljs-built_in"><span class="hljs-built_in">md</span></span>.maxForce = (nbody-&gt;GetMass() &lt; <span class="hljs-number"><span class="hljs-number">16</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>)? (<span class="hljs-number"><span class="hljs-number">1000</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>f * nbody-&gt;GetMass()) : float32(<span class="hljs-number"><span class="hljs-number">16000</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>); #<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-built_in"><span class="hljs-built_in">md</span></span>.maxForce = <span class="hljs-number"><span class="hljs-number">1000</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>f * nbody-&gt;GetMass(); #endif m_mouseJoint = (b2MouseJoint*)world-&gt;CreateJoint(&amp;<span class="hljs-built_in"><span class="hljs-built_in">md</span></span>); nbody-&gt;SetAwake(YES); } } - (void) touchesMoved:(NSSet *)touches withEvent:(UIEvent *)event { UITouch* myTouch = [touches anyObject]; CGPoint location = [myTouch locationInView: [myTouch view]]; // translate uikit coordinates into box2d coordinates location = CGPointMake(location.x, screenSize.height-location.y); m_mouseWorld.<span class="hljs-built_in"><span class="hljs-built_in">Set</span></span>(location.x/PTM_RATIO, location.y/PTM_RATIO); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_mouseJoint) { m_mouseJoint-&gt;SetTarget(m_mouseWorld); } } - (void) touchesEnded:(NSSet *)touches withEvent:(UIEvent *)event { NSLog(@"touches ended"); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_mouseJoint) { AudioServicesPlaySystemSound (soundThrust); world-&gt;DestroyJoint(m_mouseJoint); m_mouseJoint = NULL; } } - (void) touchesCancelled:(NSSet *)touches withEvent:(UIEvent *)event { [self touchesEnded:touches withEvent:event]; }</code> </pre> <br><br><h4>  Accelerometer </h4><br>  When you try to create a realistic box with objects, you must not forget about gravity, and there are several pitfalls.  You can, of course, follow a simple path and get the components of the gravity vector from the accelerometer readings, taking the values ‚Äã‚Äãalong two axes - X and Y, as was done in the original article: <br><pre> <code class="hljs objectivec">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)accelerometer:(<span class="hljs-built_in"><span class="hljs-built_in">UIAccelerometer</span></span> *)accelerometer didAccelerate:(<span class="hljs-built_in"><span class="hljs-built_in">UIAcceleration</span></span> *)acceleration { b2Vec2 gravity; gravity.Set( acceleration.x * <span class="hljs-number"><span class="hljs-number">9.81</span></span>, acceleration.y * <span class="hljs-number"><span class="hljs-number">9.81</span></span> ); world-&gt;SetGravity(gravity); }</code> </pre><br>  But this method allows you to accidentally create unwanted weightlessness in the case of the device on a horizontal surface, since the projections of the earth's gravity on the X and Y axes of the device will become almost zero.  In the case of such virtual weightlessness, objects will float unnaturally in the air.  It will be more natural if the gravity vector is always equal to 1 and the objects will be under the influence of a constant force regardless of the device's position: on the knees or on the table, vertically in the hands or even above the head with the screen facing down.  We have implemented this somewhat more complicated algorithm for calculating the direction of gravity, but we will keep it secret as our small know-how.  It is also worth mentioning that for more accurate setting of the gravity vector and more subtle control of it on new devices, you can use the accelerometer, and from simple use of the <a href="http://developer.apple.com/library/ios/">UIAccelerometerDelegate</a> protocol (which is no longer used in iOS 5), you should switch to the integrated <a href="http://developer.apple.com/library/IOs/">CMMotionManager</a> from CoreMotion framework. <br><br><h4>  Video demonstration of the result </h4><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/-V8H12QW2Y0%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700190,15700253,15700256,15700259&amp;usg=ALkJrhggx2q_2One7ejEhpaDU2v3PKCBDQ" frameborder="0" allowfullscreen=""></iframe><br><br><h4>  Instead of conclusion </h4><br>  It took only a few days to integrate the physics engine on 4 pages of our <a href="http://itunes.apple.com/ru/app/the-wolf-and-the-little-goats/id448355294%3Fmt%3D8">book</a> , including inventing a small game plot on each page, creating appropriate graphics and coding ‚Äî the total costs are small, and there are many new possibilities.  Dare and you! <br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/137414/">https://habr.com/ru/post/137414/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../137409/index.html">SAPER on the fields of CAD</a></li>
<li><a href="../137410/index.html">How do you usually unpack the archive through the context menu</a></li>
<li><a href="../137411/index.html">Without knowing the ford, do not go into the water. Part two</a></li>
<li><a href="../137412/index.html">Creating animated tooltips with CSS3</a></li>
<li><a href="../137413/index.html">It is finished! Website iCloud "spoke" in Russian</a></li>
<li><a href="../137415/index.html">User Attributes in Python</a></li>
<li><a href="../137416/index.html">Anonymization and de-anonymization on the Internet</a></li>
<li><a href="../137417/index.html">Because of the new law, popular torrent trackers of Kazakhstan have stopped working</a></li>
<li><a href="../137419/index.html">Vulnerability in ISPSystem Billmanager</a></li>
<li><a href="../137420/index.html">Linux head-end computer - collect it yourself!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>