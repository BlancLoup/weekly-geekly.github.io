<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CMake and C ++ - brothers forever</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="During the development process, I like to change compilers, build modes, dependency versions, perform static analysis, measure performance, collect co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>CMake and C ++ - brothers forever</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/ac/a0/8-/aca08-xhl_t033obcrcqgxpmksk.png" alt="Friendship forever"></p><br><p>  During the development process, I like to change compilers, build modes, dependency versions, perform static analysis, measure performance, collect coverage, generate documentation, etc.  And I really love CMake, because it allows me to do everything that I want. </p><br><p>  Many criticize CMake, and often deservedly, but if you look, not everything is so bad, and recently it‚Äôs <strong>very good</strong> , and the direction of development is quite positive. </p><br><p>  In this article I want to tell how simple it is to organize a C ++ header library in the CMake system to get the following functionality: </p><br><ol><li>  Assembly; </li><li>  Autostart tests; </li><li>  Measurement of code coverage; </li><li>  Installation; </li><li>  Auto documenting </li><li>  Online sandbox generation; </li><li>  Static Analysis </li></ol><br><blockquote>  Whoever already understands the pros and s-make can just <a href="https://github.com/izvolov/mylib">download the project template</a> and start using it. </blockquote><a name="habracut"></a><br><a name="contents"></a><br><h2>  Content </h2><br><ol><li>  <a href="https://habr.com/ru/post/461817/">Project from the inside out</a> <br><ol><li>  <a href="https://habr.com/ru/post/461817/">Project structure</a> </li><li>  <a href="https://habr.com/ru/post/461817/">Main CMake file (./CMakeLists.txt)</a> <br><ol><li>  <a href="https://habr.com/ru/post/461817/">Project Information</a> </li><li>  <a href="https://habr.com/ru/post/461817/">Project Options</a> </li><li>  <a href="https://habr.com/ru/post/461817/">Compilation options</a> </li><li>  <a href="https://habr.com/ru/post/461817/">the main goal</a> </li><li>  <a href="https://habr.com/ru/post/461817/">Installation</a> </li><li>  <a href="https://habr.com/ru/post/461817/">Tests</a> </li><li>  <a href="https://habr.com/ru/post/461817/">Documentation</a> </li><li>  <a href="https://habr.com/ru/post/461817/">Online sandbox</a> </li></ol></li><li>  <a href="https://habr.com/ru/post/461817/">Script for tests (test / CMakeLists.txt)</a> <br><ol><li>  <a href="https://habr.com/ru/post/461817/">Testing</a> </li><li>  <a href="https://habr.com/ru/post/461817/">Coating</a> </li></ol></li><li>  <a href="https://habr.com/ru/post/461817/">Script for documentation (doc / CMakeLists.txt)</a> </li><li>  <a href="https://habr.com/ru/post/461817/">Script for an online sandbox (online / CMakeLists.txt)</a> </li></ol></li><li>  <a href="https://habr.com/ru/post/461817/">Project outside</a> <br><ol><li>  <a href="https://habr.com/ru/post/461817/">Assembly</a> <br><ol><li>  <a href="https://habr.com/ru/post/461817/">Generation</a> </li><li>  <a href="https://habr.com/ru/post/461817/">Assembly</a> </li></ol></li><li>  <a href="https://habr.com/ru/post/461817/">Options</a> <br><ol><li>  <a href="https://habr.com/ru/post/461817/">MYLIB_COVERAGE</a> </li><li>  <a href="https://habr.com/ru/post/461817/">MYLIB_TESTING</a> </li><li>  <a href="https://habr.com/ru/post/461817/">MYLIB_DOXYGEN_LANGUAGE</a> </li></ol></li><li>  <a href="https://habr.com/ru/post/461817/">Assembly goals</a> <br><ol><li>  <a href="https://habr.com/ru/post/461817/">Default</a> </li><li>  <a href="https://habr.com/ru/post/461817/">mylib-unit-tests</a> </li><li>  <a href="https://habr.com/ru/post/461817/">check</a> </li><li>  <a href="https://habr.com/ru/post/461817/">coverage</a> </li><li>  <a href="https://habr.com/ru/post/461817/">doc</a> </li><li>  <a href="https://habr.com/ru/post/461817/">wandbox</a> </li></ol></li><li>  <a href="https://habr.com/ru/post/461817/">Examples</a> </li></ol></li><li>  <a href="https://habr.com/ru/post/461817/">Instruments</a> </li><li>  <a href="https://habr.com/ru/post/461817/">Static analysis</a> </li><li>  <a href="https://habr.com/ru/post/461817/">Afterword</a> </li></ol><br><a name="project-from-the-inside"></a><br><h2>  <a href="https://habr.com/ru/post/461817/">Project from the inside out</a> </h2><br><a name="project-structure"></a><br><h3 id="struktura-proektacontents">  <a href="https://habr.com/ru/post/461817/">Project structure</a> </h3><br><pre><code class="plaintext hljs">. ‚îú‚îÄ‚îÄ CMakeLists.txt ‚îú‚îÄ‚îÄ README.en.md ‚îú‚îÄ‚îÄ README.md ‚îú‚îÄ‚îÄ doc ‚îÇ  ‚îú‚îÄ‚îÄ CMakeLists.txt ‚îÇ  ‚îî‚îÄ‚îÄ Doxyfile.in ‚îú‚îÄ‚îÄ include ‚îÇ  ‚îî‚îÄ‚îÄ mylib ‚îÇ  ‚îî‚îÄ‚îÄ myfeature.hpp ‚îú‚îÄ‚îÄ online ‚îÇ  ‚îú‚îÄ‚îÄ CMakeLists.txt ‚îÇ  ‚îú‚îÄ‚îÄ mylib-example.cpp ‚îÇ  ‚îî‚îÄ‚îÄ wandbox.py ‚îî‚îÄ‚îÄ test ‚îú‚îÄ‚îÄ CMakeLists.txt ‚îú‚îÄ‚îÄ mylib ‚îÇ  ‚îî‚îÄ‚îÄ myfeature.cpp ‚îî‚îÄ‚îÄ test_main.cpp</code> </pre> <br><p>  We will mainly talk about how to organize CMake scripts, so they will be analyzed in detail.  Everyone can see the rest of the files directly <a href="https://github.com/izvolov/mylib">on the project-template page</a> . </p><br><a name="cmakeliststxt"></a><br><h3 id="glavnyy-cmake-fayl-cmakeliststxtcontents">  <a href="https://habr.com/ru/post/461817/">Main CMake file (./CMakeLists.txt)</a> </h3><br><a name="project-information"></a><br><h4 id="informaciya-o-proektecontents">  <a href="https://habr.com/ru/post/461817/">Project Information</a> </h4><br><p>  First of all, you need to request the right version of the CMake system.  CMake is developing, team signatures, behavior in different conditions are changing.  In order for CMake to immediately understand what we want from him, we need to immediately fix our requirements for him. </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">cmake_minimum_required</span></span>(VERSION <span class="hljs-number"><span class="hljs-number">3.13</span></span>)</code> </pre> <br><p>  Then we designate our project, its name, version, languages ‚Äã‚Äãused, etc. (see <a href="https://cmake.org/cmake/help/v3.8/command/project.html"><code> project</code></a> ). </p><br><p>  In this case, we specify the <code>CXX</code> language (which means C ++) so that CMake does not strain and does not look for the C language compiler (by default, two languages ‚Äã‚Äãare included in CMake: C and C ++). </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">project</span></span>(Mylib VERSION <span class="hljs-number"><span class="hljs-number">1.0</span></span> LANGUAGES CXX)</code> </pre> <br><p>  Here you can immediately check whether our project is included in another project as a subproject.  This will greatly help in the future. </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">get_directory_property</span></span>(IS_SUBPROJECT PARENT_DIRECTORY)</code> </pre> <br><a name="project-options"></a><br><h4 id="opcii-proektacontents">  <a href="https://habr.com/ru/post/461817/">Project Options</a> </h4><br><p>  We provide two options. </p><br><p>  The first option - <a href="https://habr.com/ru/post/461817/"><code>MYLIB_TESTING</code></a> - to turn off unit tests.  This may be necessary if we are sure that everything is in order with the tests, and we want, for example, only to install or package our project.  Or our project is included as a subproject - in this case, the user of our project is not interested in running our tests.  You do not test the dependencies that you use? </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">option</span></span>(MYLIB_TESTING <span class="hljs-string"><span class="hljs-string">"  "</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>)</code> </pre> <br><p>  In addition, we will make a separate option <a href="https://habr.com/ru/post/461817/"><code>MYLIB_COVERAGE</code></a> for measuring code coverage with tests, but it will require additional tools, so you will need to enable it explicitly. </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">option</span></span>(MYLIB_COVERAGE <span class="hljs-string"><span class="hljs-string">"    "</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>)</code> </pre> <br><a name="compile-options"></a><br><h4 id="opcii-kompilyaciicontents">  <a href="https://habr.com/ru/post/461817/">Compilation options</a> </h4><br><p>  Of course, we are cool plus programmers, so we want the maximum level of compilation time diagnostics from the compiler.  Not a single mouse will slip through. </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">add_compile_options</span></span>( -Werror -Wall -Wextra -Wpedantic -Wcast-align -Wcast-qual -Wconversion -Wctor-dtor-privacy -Wenum-compare -Wfloat-<span class="hljs-keyword"><span class="hljs-keyword">equal</span></span> -Wnon-virtual-dtor -Wold-style-cast -Woverloaded-virtual -Wredundant-decls -Wsign-conversion -Wsign-promo )</code> </pre> <br><p>  We will also disable extensions to fully comply with the C ++ language standard.  By default, they are included in CMake. </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> CMAKE_CXX_EXTENSIONS) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(CMAKE_CXX_EXTENSIONS <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">endif</span></span>()</code> </pre> <br><a name="main-target"></a><br><h4 id="osnovnaya-celcontents">  <a href="https://habr.com/ru/post/461817/">the main goal</a> </h4><br><p>  Our library consists only of header files, which means that we do not have any exhaust in the form of static or dynamic libraries.  On the other hand, to use our library outside, you need to install it, you need to be able to find it in the system and connect it to your project, and at the same time these same headers, as well as, perhaps, some additional ones properties. </p><br><p>  For this purpose, we create an interface library. </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">add_library</span></span>(mylib INTERFACE)</code> </pre> <br><p>  Bind the headers to our front-end library. </p><br><p>  The modern, fashionable, youthful use of CMake implies that headers, properties, etc.  transmitted through one single purpose.  Thus, suffice it to say <a href="https://cmake.org/cmake/help/v3.8/command/target_link_libraries.html"><code>target_link_libraries(target PRIVATE dependency)</code></a> , and all the headers that are associated with the <code>dependency</code> target will be available for sources belonging to the target <code>target</code> .  And no <code>[target_]include_directories</code> is required.  This will be demonstrated below when parsing the <a href="https://habr.com/ru/post/461817/">CMake script for unit tests</a> . </p><br><p>  It is also worth paying attention to the so-called  <a href="https://cmake.org/cmake/help/v3.8/manual/cmake-generator-expressions.7.html"><code>-: $&lt;...&gt;</code></a> . </p><br><p>  This command associates the headers we need with our front-end library, and if our library is connected to any target within the same CMake hierarchy, then headers from the directory <code>${CMAKE_CURRENT_SOURCE_DIR}/include</code> will be associated with it, and if ours Since the library is installed on the system and connected to another project using the <a href="https://cmake.org/cmake/help/v3.8/command/find_package.html"><code>find_package</code></a> , the headers from the <code>include</code> directory relative to the installation directory will be associated with it. </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">target_include_directories</span></span>(mylib INTERFACE $&lt;BUILD_INTERFACE:<span class="hljs-variable"><span class="hljs-variable">${CMAKE_CURRENT_SOURCE_DIR}</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>&gt; $&lt;INSTALL_INTERFACE:<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>&gt; )</code> </pre> <br><p>  Set the language standard.  Of course, the very last.  At the same time, we not only include the standard, but also distribute it to those who will use our library.  This is achieved due to the fact that the set property has the <code>INTERFACE</code> category (see <a href="https://cmake.org/cmake/help/v3.8/command/target_compile_features.html">the target_compile_features command</a> ). </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">target_compile_features</span></span>(mylib INTERFACE cxx_std_17)</code> </pre> <br><p>  We create an alias for our library.  Moreover, for beauty, he will be in a special "namespace".  This will be useful when different modules appear in our library, and we go to connect them independently from each other.  <a href="https://cmake.org/cmake/help/v3.8/module/FindBoost.html">Like in Boost, for example</a> . </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">add_library</span></span>(Mylib::mylib ALIAS mylib)</code> </pre> <br><a name="installation"></a><br><h4 id="ustanovkacontents">  <a href="https://habr.com/ru/post/461817/">Installation</a> </h4><br><p>  Installing our headers in the system.  Everything is simple here.  We say that the folder with all the headers should be in the <code>include</code> directory relative to the installation location. </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">install</span></span>(DIRECTORY <span class="hljs-keyword"><span class="hljs-keyword">include</span></span>/mylib DESTINATION <span class="hljs-keyword"><span class="hljs-keyword">include</span></span>)</code> </pre> <br><p>  Next, we inform the build system that we want to be able to call <code>find_package(Mylib)</code> in third-party projects and get the target <code>Mylib::mylib</code> . </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">install</span></span>(TARGETS mylib <span class="hljs-keyword"><span class="hljs-keyword">EXPORT</span></span> MylibConfig) <span class="hljs-keyword"><span class="hljs-keyword">install</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">EXPORT</span></span> MylibConfig NAMESPACE Mylib:: DESTINATION share/Mylib/cmake)</code> </pre> <br><p>  The next spell should be understood as follows.  When we call <code>find_package(Mylib 1.2.3 REQUIRED)</code> in a third-party project, and in this case the real version of the installed library will be incompatible with version <code>1.2.3</code> , CMake will automatically generate an error.  That is, you will not need to follow the versions manually. </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">include</span></span>(CMakePackageConfigHelpers) write_basic_package_version_file(<span class="hljs-string"><span class="hljs-string">"${PROJECT_BINARY_DIR}/MylibConfigVersion.cmake"</span></span> VERSION <span class="hljs-variable"><span class="hljs-variable">${PROJECT_VERSION}</span></span> COMPATIBILITY AnyNewerVersion ) <span class="hljs-keyword"><span class="hljs-keyword">install</span></span>(FILES <span class="hljs-string"><span class="hljs-string">"${PROJECT_BINARY_DIR}/MylibConfigVersion.cmake"</span></span> DESTINATION share/Mylib/cmake)</code> </pre> <br><a name="tests"></a><br><h4 id="testycontents">  <a href="https://habr.com/ru/post/461817/">Tests</a> </h4><br><p>  If tests are turned off explicitly using the <a href="https://habr.com/ru/post/461817/">appropriate option,</a> or if our project is a subproject, that is, connected to another CMake project using the <a href="https://cmake.org/cmake/help/v3.8/command/add_subdirectory.html"><code>add_subdirectory</code></a> , we will not go further in the hierarchy, and the script that describes the commands for generating and running the tests simply does not start . </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> MYLIB_TESTING) <span class="hljs-keyword"><span class="hljs-keyword">message</span></span>(STATUS <span class="hljs-string"><span class="hljs-string">"  Mylib "</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span>(IS_SUBPROJECT) <span class="hljs-keyword"><span class="hljs-keyword">message</span></span>(STATUS <span class="hljs-string"><span class="hljs-string">"Mylib     "</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">add_subdirectory</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">test</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">endif</span></span>()</code> </pre> <br><a name="documentation"></a><br><h4 id="dokumentaciyacontents">  <a href="https://habr.com/ru/post/461817/">Documentation</a> </h4><br><p>  Documentation will also not be generated in the case of a subproject. </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> IS_SUBPROJECT) <span class="hljs-keyword"><span class="hljs-keyword">add_subdirectory</span></span>(doc) <span class="hljs-keyword"><span class="hljs-keyword">endif</span></span>()</code> </pre> <br><a name="online-sandbox"></a><br><h4 id="onlayn-pesochnicacontents">  <a href="https://habr.com/ru/post/461817/">Online sandbox</a> </h4><br><p>  Similarly, the subproject will also not have online sandboxes. </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> IS_SUBPROJECT) <span class="hljs-keyword"><span class="hljs-keyword">add_subdirectory</span></span>(online) <span class="hljs-keyword"><span class="hljs-keyword">endif</span></span>()</code> </pre> <br><a name="testcmakeliststxt"></a><br><h3 id="skript-dlya-testov-testcmakeliststxtcontents">  <a href="https://habr.com/ru/post/461817/">Script for tests (test / CMakeLists.txt)</a> </h3><br><a name="testing"></a><br><h4 id="testirovaniecontents">  <a href="https://habr.com/ru/post/461817/">Testing</a> </h4><br><p>  First of all, we find the package with the desired test framework (replace it with your favorite). </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">find_package</span></span>(doctest <span class="hljs-number"><span class="hljs-number">2.3</span></span>.<span class="hljs-number"><span class="hljs-number">3</span></span> REQUIRED)</code> </pre> <br><p>  We create our executable file with tests.  Usually directly in the executable binary I add only the file in which the <code>main</code> function will be. </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">add_executable</span></span>(mylib-unit-tests test_main.cpp)</code> </pre> <br><p>  And the files that describe the tests themselves are added later.  But this is not necessary. </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">target_sources</span></span>(mylib-unit-tests PRIVATE mylib/myfeature.cpp)</code> </pre> <br><p>  We connect dependencies.  Please note that we only <code>target_include_directories</code> CMake targets we needed to our binary, and did not call the <code>target_include_directories</code> command.  The headers from the test framework and from our <code>Mylib::mylib</code> , as well as the build parameters (in our case, this is the C ++ language standard) crawled along with these goals. </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">target_link_libraries</span></span>(mylib-unit-tests PRIVATE Mylib::mylib doctest::doctest )</code> </pre> <br><p>  Finally, create a fictitious target, the "assembly" of which is equivalent to running tests, and add this target to the default assembly (the <code>ALL</code> attribute is responsible for this).  This means that the assembly by default initiates the launch of tests, that is, we will never forget to run them. </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">add_custom_target</span></span>(check ALL <span class="hljs-keyword"><span class="hljs-keyword">COMMAND</span></span> mylib-unit-tests)</code> </pre> <br><a name="code-coverage"></a><br><h4 id="pokrytiecontents">  <a href="https://habr.com/ru/post/461817/">Coating</a> </h4><br><p>  Next, we enable code coverage measurement, if the corresponding option is specified.  I won‚Äôt go into details, because they relate more to the tool for measuring coatings than to CMake.  It is only important to note that, based on the results, a <a href="https://habr.com/ru/post/461817/"><code>coverage</code></a> goal will be created, with which it is convenient to start measuring coverage. </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">find_program</span></span>(GCOVR_EXECUTABLE gcovr) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(MYLIB_COVERAGE <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> GCOVR_EXECUTABLE) <span class="hljs-keyword"><span class="hljs-keyword">message</span></span>(STATUS <span class="hljs-string"><span class="hljs-string">"    "</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">target_compile_options</span></span>(mylib-unit-tests PRIVATE --coverage) <span class="hljs-keyword"><span class="hljs-keyword">target_link_libraries</span></span>(mylib-unit-tests PRIVATE gcov) <span class="hljs-keyword"><span class="hljs-keyword">add_custom_target</span></span>(coverage <span class="hljs-keyword"><span class="hljs-keyword">COMMAND</span></span> <span class="hljs-variable"><span class="hljs-variable">${GCOVR_EXECUTABLE}</span></span> --root=<span class="hljs-variable"><span class="hljs-variable">${PROJECT_SOURCE_DIR}</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>/ --object-directory=<span class="hljs-variable"><span class="hljs-variable">${CMAKE_CURRENT_BINARY_DIR}</span></span> DEPENDS check ) <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span>(MYLIB_COVERAGE <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> GCOVR_EXECUTABLE) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(MYLIB_COVERAGE <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">message</span></span>(WARNING <span class="hljs-string"><span class="hljs-string">"       gcovr"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">endif</span></span>()</code> </pre> <br><a name="doccmakeliststxt"></a><br><h3 id="skript-dlya-dokumentacii-doccmakeliststxtcontents">  <a href="https://habr.com/ru/post/461817/">Script for documentation (doc / CMakeLists.txt)</a> </h3><br><p>  <a href="https://cmake.org/cmake/help/v3.8/module/FindDoxygen.html">Found Doxygen</a> . </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">find_package</span></span>(Doxygen)</code> </pre> <br><p>  Next, we check whether the user has set the language variable.  If yes, then do not touch, if not, then take Russian.  Then configure the Doxygen system files.  All the necessary variables, including the language, get there during the configuration process (see <a href="https://cmake.org/cmake/help/v3.8/command/configure_file.html"><code> configure_file</code></a> ). </p><br><p>  Then we create the <a href="https://habr.com/ru/post/461817/"><code>doc</code></a> target, which will start the generation of documentation.  Since the generation of documentation is not the greatest need in the development process, by default the goal will not be enabled, it will have to be started explicitly. </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Doxygen_FOUND) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> MYLIB_DOXYGEN_LANGUAGE) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(MYLIB_DOXYGEN_LANGUAGE Russian) <span class="hljs-keyword"><span class="hljs-keyword">endif</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">message</span></span>(STATUS <span class="hljs-string"><span class="hljs-string">"Doxygen documentation will be generated in ${MYLIB_DOXYGEN_LANGUAGE}"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">configure_file</span></span>(Doxyfile.in Doxyfile) <span class="hljs-keyword"><span class="hljs-keyword">add_custom_target</span></span>(doc <span class="hljs-keyword"><span class="hljs-keyword">COMMAND</span></span> <span class="hljs-variable"><span class="hljs-variable">${DOXYGEN_EXECUTABLE}</span></span> <span class="hljs-variable"><span class="hljs-variable">${CMAKE_CURRENT_BINARY_DIR}</span></span>/Doxyfile) <span class="hljs-keyword"><span class="hljs-keyword">endif</span></span> ()</code> </pre> <br><a name="onlinecmakeliststxt"></a><br><h3 id="skript-dlya-onlayn-pesochnicy-onlinecmakeliststxtcontents">  <a href="https://habr.com/ru/post/461817/">Script for an online sandbox (online / CMakeLists.txt)</a> </h3><br><p>  Here we find the third Python and create a <a href="https://habr.com/ru/post/461817/"><code>wandbox</code></a> target that generates a request that matches the <a href="https://wandbox.org/">Wandbox</a> service API and sends it.  In response, a link to the finished sandbox comes. </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">find_program</span></span>(PYTHON3_EXECUTABLE python3) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(PYTHON3_EXECUTABLE) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(WANDBOX_URL <span class="hljs-string"><span class="hljs-string">"https://wandbox.org/api/compile.json"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">add_custom_target</span></span>(wandbox <span class="hljs-keyword"><span class="hljs-keyword">COMMAND</span></span> <span class="hljs-variable"><span class="hljs-variable">${PYTHON3_EXECUTABLE}</span></span> wandbox.py mylib-example.cpp <span class="hljs-string"><span class="hljs-string">"${PROJECT_SOURCE_DIR}"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> | curl -H <span class="hljs-string"><span class="hljs-string">"Content-type: application/json"</span></span> -d @- <span class="hljs-variable"><span class="hljs-variable">${WANDBOX_URL}</span></span> WORKING_DIRECTORY <span class="hljs-variable"><span class="hljs-variable">${CMAKE_CURRENT_SOURCE_DIR}</span></span> DEPENDS mylib-unit-tests ) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">message</span></span>(WARNING <span class="hljs-string"><span class="hljs-string">"  -    python 3- "</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">endif</span></span>()</code> </pre> <br><a name="project-from-the-outside"></a><br><h2>  <a href="https://habr.com/ru/post/461817/">Project outside</a> </h2><br><p>  Now consider how to use it all. </p><br><a name="build"></a><br><h3 id="sborkacontents">  <a href="https://habr.com/ru/post/461817/">Assembly</a> </h3><br><p>  The assembly of this project, like any other project on the CMake assembly system, consists of two stages: </p><br><a name="generate"></a><br><h4 id="generaciyacontents">  <a href="https://habr.com/ru/post/461817/">Generation</a> </h4><br><pre> <code class="plaintext hljs">cmake -S // -B /// [ ...]</code> </pre> <br><blockquote>  If the command above did not work due to the old version of CMake, try omitting <code>-S</code> : <br><pre> <code class="plaintext hljs">cmake // -B /// [ ...]</code> </pre> <br></blockquote><p>  <a href="https://habr.com/ru/post/461817/">More about options</a> . </p><br><a name="project-build"></a><br><h4 id="sborka-proektacontents">  <a href="https://habr.com/ru/post/461817/">Project assembly</a> </h4><br><pre> <code class="plaintext hljs">cmake --build /// [--target target]</code> </pre> <br><p>  <a href="https://habr.com/ru/post/461817/">Read more about assembly goals</a> . </p><br><a name="options"></a><br><h3 id="opciicontents">  <a href="https://habr.com/ru/post/461817/">Options</a> </h3><br><a name="MYLIB_COVERAGE"></a><br><h4 id="mylib_coveragecontents">  <a href="https://habr.com/ru/post/461817/">MYLIB_COVERAGE</a> </h4><br><pre> <code class="plaintext hljs">cmake -S ... -B ... -DMYLIB_COVERAGE=ON [  ...]</code> </pre> <br><p>  Includes a <a href="https://habr.com/ru/post/461817/"><code>coverage</code></a> target, with which you can start measuring coverage of code with tests. </p><br><a name="MYLIB_TESTING"></a><br><h4 id="mylib_testingcontents">  <a href="https://habr.com/ru/post/461817/">MYLIB_TESTING</a> </h4><br><pre> <code class="plaintext hljs">cmake -S ... -B ... -DMYLIB_TESTING=OFF [  ...]</code> </pre> <br><p>  Provides the ability to turn off the unit test assembly and the <a href="https://habr.com/ru/post/461817/"><code>check</code></a> target.  As a result, the measurement of code coverage by tests is <a href="https://habr.com/ru/post/461817/"><code>MYLIB_COVERAGE</code></a> off (see <a href="https://habr.com/ru/post/461817/"><code>MYLIB_COVERAGE</code></a> ). </p><br><p>  Also, testing is automatically disabled if the project is connected to another project as a subproject using the <a href="https://cmake.org/cmake/help/v3.8/command/add_subdirectory.html"><code>add_subdirectory</code></a> . </p><br><a name="MYLIB_DOXYGEN_LANGUAGE"></a><br><h4 id="mylib_doxygen_languagecontents">  <a href="https://habr.com/ru/post/461817/">MYLIB_DOXYGEN_LANGUAGE</a> </h4><br><pre> <code class="plaintext hljs">cmake -S ... -B ... -DMYLIB_DOXYGEN_LANGUAGE=English [  ...]</code> </pre> <br><p>  Switches the documentation language that the <a href="https://habr.com/ru/post/461817/"><code>doc</code></a> target generates to the specified one.  For a list of available languages, see the <a href="http://www.doxygen.nl/manual/config.html">Doxygen website</a> . </p><br><p>  By default, Russian is enabled. </p><br><a name="build-targets"></a><br><h3 id="sborochnye-celicontents">  <a href="https://habr.com/ru/post/461817/">Assembly goals</a> </h3><br><a name="default-target"></a><br><h4 id="po-umolchaniyucontents">  <a href="https://habr.com/ru/post/461817/">Default</a> </h4><br><pre> <code class="plaintext hljs">cmake --build path/to/build/directory cmake --build path/to/build/directory --target all</code> </pre> <br><p>  If the target is not specified (which is equivalent to the <code>all</code> goal), collects everything that is possible and also calls the <a href="https://habr.com/ru/post/461817/"><code>check</code></a> target. </p><br><a name="mylib-unit-tests"></a><br><h4 id="mylib-unit-testscontents">  <a href="https://habr.com/ru/post/461817/">mylib-unit-tests</a> </h4><br><pre> <code class="plaintext hljs">cmake --build path/to/build/directory --target mylib-unit-tests</code> </pre> <br><p>  Compiles unit tests.  Enabled by default. </p><br><a name="check"></a><br><h4 id="checkcontents">  <a href="https://habr.com/ru/post/461817/">check</a> </h4><br><pre> <code class="plaintext hljs">cmake --build /// --target check</code> </pre> <br><p>  Runs collected (collects, if not yet) unit tests.  Enabled by default. </p><br><p>  See also <a href="https://habr.com/ru/post/461817/"><code>mylib-unit-tests</code></a> . </p><br><a name="coverage"></a><br><h4 id="coveragecontents">  <a href="https://habr.com/ru/post/461817/">coverage</a> </h4><br><pre> <code class="plaintext hljs">cmake --build /// --target coverage</code> </pre> <br><p>  Analyzes running (runs, if not yet) unit tests for covering the code with tests using the <a href="https://gcovr.com/">gcovr</a> program. </p><br><p>  Coating exhaust will look something like this: </p><br><pre> <code class="plaintext hljs">------------------------------------------------------------------------------ GCC Code Coverage Report Directory: /path/to/cmakecpptemplate/include/ ------------------------------------------------------------------------------ File Lines Exec Cover Missing ------------------------------------------------------------------------------ mylib/myfeature.hpp 2 2 100% ------------------------------------------------------------------------------ TOTAL 2 2 100% ------------------------------------------------------------------------------</code> </pre> <br><p>  The target is only available when <a href="https://habr.com/ru/post/461817/"><code>MYLIB_COVERAGE</code></a> . </p><br><p>  See also <a href="https://habr.com/ru/post/461817/"><code>check</code></a> . </p><br><a name="doc"></a><br><h4 id="doccontents">  <a href="https://habr.com/ru/post/461817/">doc</a> </h4><br><pre> <code class="plaintext hljs">cmake --build /// --target doc</code> </pre> <br><p>  Starts the generation of code documentation using the <a href="http://doxygen.nl/">Doxygen</a> system. </p><br><a name="wandbox"></a><br><h4 id="wandboxcontents">  <a href="https://habr.com/ru/post/461817/">wandbox</a> </h4><br><pre> <code class="plaintext hljs">cmake --build /// --target wandbox</code> </pre> <br><p>  The response from the service looks something like this: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"permlink"</span></span> : <span class="hljs-string"><span class="hljs-string">"QElvxuMzHgL9fqci"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"status"</span></span> : <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"url"</span></span> : <span class="hljs-string"><span class="hljs-string">"https://wandbox.org/permlink/QElvxuMzHgL9fqci"</span></span> }</code> </pre> <br><p>  To do this, use the <a href="https://wandbox.org/">Wandbox</a> service.  I don‚Äôt know how rubber servers they have, but I think it‚Äôs not worth it to abuse this feature. </p><br><a name="examples"></a><br><h3 id="primerycontents">  <a href="https://habr.com/ru/post/461817/">Examples</a> </h3><br><h4 id="sborka-proekta-v-otladochnom-rezhime-s-zamerom-pokrytiya">  Project assembly in debug mode with coverage measurement </h4><br><pre> <code class="plaintext hljs">cmake -S // -B /// -DCMAKE_BUILD_TYPE=Debug -DMYLIB_COVERAGE=ON cmake --build /// --target coverage --parallel 16</code> </pre> <br><h4 id="ustanovka-proekta-bez-predvaritelnoy-sborki-i-testirovaniya">  Project installation without pre-assembly and testing </h4><br><pre> <code class="plaintext hljs">cmake -S // -B /// -DMYLIB_TESTING=OFF -DCMAKE_INSTALL_PREFIX=/// cmake --build /// --target install</code> </pre> <br><h4 id="sborka-v-vypusknom-rezhime-zadannym-kompilyatorom">  Build in release mode by the specified compiler </h4><br><pre> <code class="plaintext hljs">cmake -S // -B /// -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_COMPILER=g++-8 -DCMAKE_PREFIX_PATH=///// cmake --build /// --parallel 4</code> </pre> <br><h4 id="generirovanie-dokumentacii-na-angliyskom">  English documentation generation </h4><br><pre> <code class="plaintext hljs">cmake -S // -B /// -DCMAKE_BUILD_TYPE=Release -DMYLIB_DOXYGEN_LANGUAGE=English cmake --build /// --target doc</code> </pre> <br><a name="tools"></a><br><h2>  <a href="https://habr.com/ru/post/461817/">Instruments</a> </h2><br><ol><li><p>  <a href="https://cmake.org/">CMake</a> 3.13 </p><br><p>  In fact, CMake 3.13 is only required to run some of the console commands described in this help.  From the syntax point of view of CMake scripts, version 3.8 is sufficient if generation is called in other ways. </p><br></li><li><p>  <a href="https://github.com/onqtam/doctest">Doctest</a> testing <a href="https://github.com/onqtam/doctest">library</a> </p><br><p>  Testing can be disabled (see <a href="https://habr.com/ru/post/461817/"><code> MYLIB_TESTING</code></a> ). </p><br></li><li><p>  <a href="http://doxygen.nl/">Doxygen</a> </p><br><p>  To switch the language in which the documentation will be generated, the <a href="https://habr.com/ru/post/461817/"><code>MYLIB_DOXYGEN_LANGUAGE</code></a> option is <a href="https://habr.com/ru/post/461817/"><code>MYLIB_DOXYGEN_LANGUAGE</code></a> . </p><br></li><li><p>  <a href="https://www.python.org/">Python 3</a> Interpreter </p><br><p>  To automatically generate <a href="https://habr.com/ru/post/461817/">online sandboxes</a> . </p><br></li></ol><br><a name="static-analysis"></a><br><h2>  <a href="https://habr.com/ru/post/461817/">Static analysis</a> </h2><br><p>  With CMake and a couple of good tools, you can provide static analysis with minimal body movements. </p><br><h4 id="cppcheck">  Cppcheck </h4><br><p>  CMake has built-in support for the <a href="http://cppcheck.sourceforge.net/">Cppcheck</a> static analysis <a href="http://cppcheck.sourceforge.net/">tool</a> . </p><br><p>  To do this, use the <a href="https://cmake.org/cmake/help/v3.10/variable/CMAKE_LANG_CPPCHECK.html"><code>CMAKE_CXX_CPPCHECK</code></a> option: </p><br><pre> <code class="plaintext hljs">cmake -S // -B /// -DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_CPPCHECK="cppcheck;--enable=all;-I///include"</code> </pre> <br><p>  After that, the static analysis will be automatically started every time during compilation and recompilation of the sources.  You do not need to do anything extra. </p><br><h4 id="clang">  Clang </h4><br><p>  Using the wonderful <a href="https://clang-analyzer.llvm.org/scan-build"><code>scan-build</code></a> tool, you can also run static analysis in two counts: </p><br><pre> <code class="plaintext hljs">scan-build cmake -S // -B /// -DCMAKE_BUILD_TYPE=Debug scan-build cmake --build ///</code> </pre> <br><p>  Here, unlike the case with Cppcheck, you need to run the assembly every time through <code>scan-build</code> . </p><br><a name="afterword"></a><br><h2>  <a href="https://habr.com/ru/post/461817/">Afterword</a> </h2><br><p>  CMake is a very powerful and flexible system that allows you to implement functionality for every taste and color.  And, although the syntax sometimes leaves much to be desired, the devil is not so terrible as he is painted.  Use the CMake build system for the benefit of society and health. </p><br><hr><br><p>  ‚Üí <a href="https://github.com/izvolov/mylib">Download project template</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/461817/">https://habr.com/ru/post/461817/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../461801/index.html">DisplayPort-LVDS</a></li>
<li><a href="../461803/index.html">Data Version Control (DVC): data versioning and experiment reproducibility</a></li>
<li><a href="../461805/index.html">Monte Carlo Integration Application in Rendering</a></li>
<li><a href="../461807/index.html">How pod priorities at Kubernetes caused downtime at Grafana Labs</a></li>
<li><a href="../461815/index.html">A revolution in the design of computer power supplies half a century ago</a></li>
<li><a href="../461819/index.html">Why simple website design is better scientifically</a></li>
<li><a href="../461823/index.html">Enhanced Four Rules for Software Design</a></li>
<li><a href="../461827/index.html">Hybrid PHP / Go Application Development Using RoadRunner</a></li>
<li><a href="../46183/index.html">Domain .tel: Internet Phone Directory</a></li>
<li><a href="../461831/index.html">StealthWatch: Deployment and Customization. Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>