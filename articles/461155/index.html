<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Charity Cloud: Migration Guide</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, Mail.Ru Cloud Solutions (MCS) and the Welcome Mail.Ru service launched the Cloud for Charitable Funds project, thanks to which non-pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Charity Cloud: Migration Guide</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/z_/wc/we/z_wcwe5eqwz8ndq8g4jsdakds_q.jpeg"><br><br>  Not so long ago, Mail.Ru Cloud Solutions (MCS) and the Welcome Mail.Ru service launched the <a href="https://mcs.mail.ru/dobro/">Cloud for Charitable Funds</a> project, thanks to which non-profit organizations can get MCS cloud platform resources for free.  The <a href="https://www.a-dobra.ru/">Arithmetic of Good</a> charity foundation took part in the project and successfully deployed part of its infrastructure based on MCS. <br><br>  After validation, an NPO can receive virtual power from MCS, but further tuning requires certain qualifications.  In this article we want to share specific instructions for setting up a server based on Ubuntu Linux for the main fund website and a number of subdomains using free SSL certificates.  For many, this will be a simple guide, but we hope that our experience will be useful for other non-profit organizations, and not only. <br><a name="habracut"></a><br><blockquote>  <b>FYI</b> : what can I get from MCS?  4 CPU, 32 GB RAM, 1 TB HDD, Ubuntu Linux OS, 500 GB object storage. </blockquote><br><h2>  Step 1: start the virtual server </h2><br>  Let's get down to business immediately and create our virtual server (aka ‚Äúinstance‚Äù) in your personal MCS account.  In the application store, you need to select and install a ready-made LAMP stack, which is a complex of server software (LAMP = Linux, Apache, MySQL, PHP), which is necessary for launching most websites. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://lh5.googleusercontent.com/bBCMrdoQhQPD7ZhVyRecmIiD-q-7ADeKO_5bAmpLguzY44EVqT2APi70KaT51uHN_tc6-VrdnzprYE74y3qZgHnRZVOOxdZE-4ZiWbRkTQnGHWF9CrTnrCulM4yE3iep73CnqIYr"></div><br><div style="text-align:center;"><img src="https://lh3.googleusercontent.com/IKHPAboXdB8qyNV8vpkI2X8ASsPO18TPr3ZgZ6hA_M5x1zWTQuE0cxLDBogceHTXYFnFKSXO784lahiAHv6N7TaaBi9gLpkWRC0goCm6MYohHoP2fmEFsrTag89QMhPq2IzsxpgQ"></div><br><div style="text-align:center;"><img src="https://lh3.googleusercontent.com/iuJZXE-jjEHNOYAET7ai21uYRcIpXK7nmrKRvwAhsnDl1cPIQ1iDUonlcbehgtYo5sG6qVzxXNk50gaXX-hN6Q74YNCdHZOf-fVJZZXa6zhIV2c3hfRIY-lEjdXwNC5cDemj4jfY"></div><br>  Choose the appropriate configuration for the server and create a new SSH key.  After clicking on the ‚ÄúInstall‚Äù button, the server and LAMP stack will begin to install, it will take some time.  The system will also offer to download a private key to the computer to control the virtual machine through the console, save it. <br><br>  After installing the application, let's immediately configure the firewall, this is also done in your personal account: go to the section "Cloud Computing -&gt; Virtual Machines" and select the "Configure firewall" item: <br><br><div style="text-align:center;"><img src="https://lh3.googleusercontent.com/PnfLoRcwfCEui9nuMSxpIWI2Y6WQCezsxYRxchuikPAg1vaPIZehSlYrRYYy9cKs0_WdSNrQEijvPx6DNok8LoqjSb_wDTsKpDh868TGkeLe7xMYX3gn5V_4hgd_6AvrvxZ7Gaa8"></div><br>  You need to add permission for incoming traffic through port 80 and 9997.  This is necessary in the future to install SSL certificates and to work with phpMyAdmin.  In the end, the ruleset should look like this: <br><br><div style="text-align:center;"><img src="https://lh4.googleusercontent.com/IqlNpJ6YHkFIq5GMH7dXhIqAxQ29sHydYWZ_gPhklbJzGPnofgC_JXEsJdGEnxVXKld6nGpR2pR09bEWbAKV6w168YyJ1xBjvBOEVYHgiWAQhZGQjHVfDGG8bbCPalBz7Wy4JF1x"></div><br>  Now you can connect to your server via the command line using the SSH protocol.  To do this, type the following command, pointing to the SSH key on your computer and the external IP address of your server (you can find it in the "Virtual Machines" section): <br><br><pre><code class="bash hljs">$ ssh -i ////key.pem ubuntu@&lt;ip_&gt;</code> </pre> <br>  During the first connection to the server, it is recommended to install all current updates on it and reboot it.  To do this, run the following commands: <br><br><pre> <code class="plaintext hljs">$ sudo apt-get update</code> </pre> <br>  The system will receive a list of updates, install them using this command and follow the instructions: <br><br><pre> <code class="plaintext hljs">$ sudo apt-get upgrade</code> </pre> <br>  After installing the updates, restart the server: <br><br><pre> <code class="plaintext hljs">$ sudo reboot</code> </pre> <br><h2>  Step 2: configure virtual hosts </h2><br>  Many NPOs need to contain several domains or subdomains at the same time (for example, the main site and several landing pages for promotional campaigns, etc.).  All this can be conveniently hosted on a single server by creating multiple virtual hosts. <br><br>  First, we need to create a directory structure for sites that will be displayed to visitors.  Let's create some directories: <br><br><pre> <code class="plaintext hljs">$ sudo mkdir -p /var/www/a-dobra.ru/public_html</code> </pre> <br><pre> <code class="plaintext hljs">$ sudo mkdir -p /var/www/promo.a-dobra.ru/public_html</code> </pre> <br>  And indicate the owner of the current user: <br><br><pre> <code class="plaintext hljs">$ sudo chown -R $USER:$USER /var/www/a-dobra.ru/public_html</code> </pre> <br><pre> <code class="plaintext hljs">$ sudo chown -R $USER:$USER /var/www/promo.a-dobra.ru/public_html</code> </pre> <br>  The variable <code>$USER</code> contains the name of the user you are currently logged in to (the default is the <code>ubuntu</code> user).  Now the current user owns the public_html directories in which we will store the content. <br><br>  We also need to edit the permissions a bit to make sure that read access is allowed to the shared web directory, all files and folders contained in it.  This is necessary for the site pages to display correctly: <br><br><pre> <code class="plaintext hljs">$ sudo chmod -R 755 /var/www</code> </pre> <br>  Your web server should now have the permissions necessary to display the content.  In addition, now your user has the ability to create content in the necessary directories. <br><br>  There is already an index.php file in the / var / www / html directory, let's copy it to our new directories - this will be our content for now: <br><br><pre> <code class="plaintext hljs">$ cp /var/www/html/index.php /var/www/a-dobra.ru/public_html/index.php</code> </pre> <br><pre> <code class="plaintext hljs">$ cp /var/www/html/index.php /var/www/promo.a-dobra.ru/public_html/index.php</code> </pre> <br>  Now you need to make sure that the user can enter your site.  To do this, first of all, we will configure the virtual host files, which determine how exactly the Apache web server will respond to requests to different domains. <br><br>  By default, Apache has a virtual host file 000-default.conf, which we can use as a starting point.  We are going to copy it to create virtual host files for each of our domains.  We start from one domain, configure it, copy it to another domain, and then make the necessary edits again. <br><br>  Ubuntu's default configuration requires that each virtual host file has a * .conf extension. <br><br>  Let's start by copying the file for the first domain: <br><br><pre> <code class="plaintext hljs">$ sudo cp /etc/apache2/sites-available/000-default.conf /etc/apache2/sites-available/a-dobra.ru.conf</code> </pre> <br>  Open a new file in the editor with root privileges: <br><br><pre> <code class="plaintext hljs">$ sudo nano /etc/apache2/sites-available/a-dobra.ru.conf</code> </pre> <br>  Edit the data as follows, indicating port 80, your data for <code>ServerAdmin</code> , <code>ServerName</code> , <code>ServerAlias</code> , as well as the path to the root directory of your site, save the file (Ctrl + X, then Y): <br><br><pre> <code class="bash hljs">&lt;VirtualHost *:80&gt; ServerAdmin e.valuisky@a-dobra.ru ServerName a-dobra.ru ServerAlias www.a-dobra.ru DocumentRoot /var/www/a-dobra.ru/public_html ErrorLog <span class="hljs-variable"><span class="hljs-variable">${APACHE_LOG_DIR}</span></span>/error.log CustomLog <span class="hljs-variable"><span class="hljs-variable">${APACHE_LOG_DIR}</span></span>/access.log combined &lt;Directory /var/www/a-dobra.ru/public_html&gt; Options -Indexes +FollowSymLinks +MultiViews AllowOverride All Require all granted &lt;/Directory&gt; &lt;FilesMatch \.php$&gt; SetHandler <span class="hljs-string"><span class="hljs-string">"proxy:unix:/var/run/php/php7.2-fpm.sock|fcgi://localhost/"</span></span> &lt;/FilesMatch&gt; &lt;/VirtualHost&gt;</code> </pre> <br>  <code>ServerName</code> sets the primary domain, which must match the name of the virtual host.  This must be your domain name.  The second, <code>ServerAlias</code> , defines other names that should be interpreted as if it were the primary domain.  This is convenient for using additional domain names, for example, using www. <br><br>  We copy this config for another host and also edit it by analogy: <br><br><pre> <code class="plaintext hljs">$ sudo cp /etc/apache2/sites-available/a-dobra.ru.conf /etc/apache2/sites-available/promo.a-dobra.ru.conf</code> </pre> <br>  You can create any number of directories and virtual hosts for your websites!  Now that we have created our virtual host files, we need to include them.  We can use the a2ensite utility to enable each of our sites as follows: <br><br><pre> <code class="plaintext hljs">$ sudo a2ensite a-dobra.ru.conf</code> </pre> <br><pre> <code class="plaintext hljs">$ sudo a2ensite promo.a-dobra.ru.conf</code> </pre> <br>  By default, port 80 is closed in LAMP, and we will need it in the future to install an SSL certificate.  Therefore, let's immediately edit the ports.conf file and then restart Apache: <br><br><pre> <code class="plaintext hljs">$ sudo nano /etc/apache2/ports.conf</code> </pre> <br>  Add a new line and save the file so that it looks like this: <br><br><pre> <code class="plaintext hljs">Listen 80 Listen 443 Listen 9997</code> </pre> <br>  After completing the settings, you must restart Apache so that all changes take effect: <br><br><pre> <code class="plaintext hljs">$ sudo systemctl reload apache2</code> </pre> <br><h2>  Step 3: set up domain names </h2><br>  Next, you need to add DNS records that will point to your new server.  To manage domains, our Arithmetic of Good Foundation uses the dns-master.ru service, we will show it by example. <br><br>  The A-record setting for the main domain is usually indicated as follows ( <code>@</code> sign): <br><br><div style="text-align:center;"><img src="https://lh3.googleusercontent.com/2oT5yBkTaBReKcN2gfj4TSakwBu48EDpa5DXzdF3Kr4qA8Z30y9r9aBwtGzoWMgIV1YIub3D48X4aPGk9shb2GhbcK1i_DyQgiLrifpiYoJL2w9Am_EpMRKYG9BAV3ST8kxzebCv"></div><br>  An A-record for subdomains is usually indicated as follows: <br><br><div style="text-align:center;"><img src="https://lh4.googleusercontent.com/823UiNiVMqrx_V2wSXpjJyWTSgvjkNfPP9x1Ty4iM-ojWh6dweAO-mLioaiaY5I3fJU8Jd_YTNj06QoobTccDEVjG6xVRb3JwSDc0s9ib2d40jBE5ZpciU2WvmOzSJxMI7GIV0pl"></div><br>  The IP address is the address of the Linux server we just created.  TTL can specify = 3600. <br><br>  After a while, it will already be possible to access your site, but so far only through <code>http://</code> .  In the next step, we will add <code>https://</code> support. <br><br><h2>  Step 4: configure free SSL certificates </h2><br>  For your main site and all sub-domains, you can get Let's Encrypt free SSL certificates.  You can also configure their automatic renewal, which is very convenient.  To obtain SSL certificates, install Certbot on your server: <br><br><pre> <code class="plaintext hljs">$ sudo add-apt-repository ppa:certbot/certbot</code> </pre> <br>  Install the Certbot package for Apache using <code>apt</code> : <br><br><pre> <code class="plaintext hljs">$ sudo apt install python-certbot-apache</code> </pre> <br>  Certbot is now ready for use, we execute the command: <br><br><pre> <code class="plaintext hljs">$ sudo certbot --apache -d a-dobra.ru -d www.a-dobra.ru -d promo.a-dobra.ru</code> </pre> <br>  This command runs certbot, the <code>-d</code> switches specify the domain names for which the certificate is to be issued. <br><br>  If this is the first time you run certbot, you will be prompted to enter an email address and agree to the terms of service.  After that, certbot will contact the Let's Encrypt server and then verify that you are really in control of the domain for which you requested the certificate. <br><br>  If everything went well, certbot will ask how you want to configure the HTTPS configuration: <br><br><pre> <code class="plaintext hljs">Please choose whether or not to redirect HTTP traffic to HTTPS, removing HTTP access. - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 1: No redirect - Make no further changes to the webserver configuration. 2: Redirect - Make all requests redirect to secure HTTPS access. Choose this for new sites, or if you're confident your site works on HTTPS. You can undo this change by editing your web server's configuration. - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - Select the appropriate number [1-2] then [enter] (press 'c' to cancel):</code> </pre> <br>  We recommend that you select option 2 and press ENTER.  The configuration will be updated and Apache restarted to apply the changes. <br><br>  Now your certificates are uploaded, installed and working.  Try reloading your site using https: // and you will see the security icon in the browser.  If you test your server with an <a href="https://www.ssllabs.com/ssltest/">SSL Labs Server Test</a> , it will receive a grade of A. <br><br>  Let's Encrypt certificates are only valid for 90 days, but the certbot package we just installed will renew the certificates automatically.  To test the upgrade process, we can do a dry run certbot: <br><br><pre> <code class="plaintext hljs">$ sudo certbot renew --dry-run</code> </pre> <br>  If you don‚Äôt see any errors resulting from this command, then everything works! <br><br><h2>  Step 5: access to MySQL and phpMyAdmin </h2><br>  Many websites use databases.  The phpMyAdmin tool for managing the database is already installed on our server.  To access it, click on the link in your browser like: <br><br><pre> <code class="plaintext hljs">https://&lt;ip- &gt;:9997</code> </pre> <br>  The password for root access can be obtained in your personal MCS account ( <a href="https://mcs.mail.ru/app/services/marketplace/apps/">https://mcs.mail.ru/app/services/marketplace/apps/</a> ).  Do not forget to change the root password the first time you log in! <br><br><h2>  Step 6: configure file upload via SFTP </h2><br>  It will be convenient for developers to upload files for your website through SFTP.  To do this, we will create a new user, call him webmaster: <br><br><pre> <code class="plaintext hljs">$ sudo adduser webmaster</code> </pre> <br>  The system will ask you to set a password and enter some other data. <br><br>  Change the owner of the directory with your website: <br><br><pre> <code class="plaintext hljs">$ sudo chown -R webmaster:webmaster /var/www/a-dobra.ru/public_html</code> </pre> <br>  Now let's change the SSH config so that the new user has access only to SFTP, and not to the SSH terminal: <br><br><pre> <code class="plaintext hljs">$ sudo nano /etc/ssh/sshd_config</code> </pre> <br>  Scroll the configuration file to the very end and add the following block: <br><br><pre> <code class="plaintext hljs">Match User webmaster ForceCommand internal-sftp PasswordAuthentication yes ChrootDirectory /var/www/a-dobra.ru PermitTunnel no AllowAgentForwarding no AllowTcpForwarding no X11Forwarding no</code> </pre> <br>  Save the file and reload the service: <br><br><pre> <code class="plaintext hljs">$ sudo systemctl restart sshd</code> </pre> <br>  Now you can connect to the server through any client for SFTP, for example, through FileZilla. <br><br><h2>  Total </h2><br><ol><li>  Now you know how to create new directories and configure virtual hosts for your websites on the same server. </li><li>  You can easily create the necessary SSL certificates - it's free, and they will be updated automatically. </li><li>  You can conveniently work with the MySQL database through the familiar phpMyAdmin. </li><li>  Creating new SFTP accounts and setting permissions does not require much effort.  Such accounts can be transferred to third-party web developers and site administrators. </li><li>  Do not forget to periodically update the system, and also recommend making backups - in MCS, you can take ‚Äúsnapshots‚Äù of the entire system with one click, and then, if necessary, launch entire images. </li></ol><br>  Resources used that may be useful: <br><br>  <a href="https://www.digitalocean.com/community/tutorials/apache-ubuntu-14-04-lts-ru">https://www.digitalocean.com/community/tutorials/apache-ubuntu-14-04-lts-ru</a> <br>  <a href="https://www.digitalocean.com/community/tutorials/apache-let-s-encrypt-ubuntu-18-04-ru">https://www.digitalocean.com/community/tutorials/apache-let-s-encrypt-ubuntu-18-04-ru</a> <br>  <a href="https://www.digitalocean.com/community/tutorials/how-to-enable-sftp-without-shell-access-on-ubuntu-18-04">https://www.digitalocean.com/community/tutorials/how-to-enable-sftp-without-shell-access-on-ubuntu-18-04</a> <br><br>  By the way, <a href="https://vc.ru/services/76435-kak-obrazovatelnaya-platforma-v-oblake-pomogaet-detyam-sirotam-gotovitsya-k-ekzamenam">here</a> you can read on VC how our foundation has launched a platform for online education of orphans based on the MCS cloud. </div><p>Source: <a href="https://habr.com/ru/post/461155/">https://habr.com/ru/post/461155/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../461143/index.html">On current issues of game design and ways to resolve them. View from below</a></li>
<li><a href="../461145/index.html">What should a team lead: roles, responsibilities and skills</a></li>
<li><a href="../461147/index.html">How to save 64 hours by combining keys in PowerPoint</a></li>
<li><a href="../461151/index.html">From idea to production - Development of IoT project</a></li>
<li><a href="../461153/index.html">WebComponents as frameworks, component interaction</a></li>
<li><a href="../461157/index.html">What Feedback Assistant will offer - a developer platform that will replace Bug Reporter</a></li>
<li><a href="../461159/index.html">Ivideon Bridge: how to connect legacy CCTV systems to the cloud</a></li>
<li><a href="../46116/index.html">Officially started selling Grand Theft Auto IV on PC</a></li>
<li><a href="../461161/index.html">Android preferences delegate</a></li>
<li><a href="../461163/index.html">What links the birthday paradox and the vulnerability of electronic signatures?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>