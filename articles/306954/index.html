<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As we NoSQL in "Relation" replicated</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nowadays, NoSQL continues to gain popularity, but few know that non-relational DBMS appeared much earlier than even the relational algebra itself. 40 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As we NoSQL in "Relation" replicated</h1><div class="post__text post__text-html js-mediator-article">  Nowadays, NoSQL continues to gain popularity, but few know that non-relational DBMS appeared much earlier than even the relational algebra itself.  40 and even 50 years ago, only NoSQL products ‚Äúcooked‚Äù in the primary ‚Äúbroth‚Äù of the emerging IT industry.  And what is most interesting - products born in those difficult times are still alive and feel great. <br>  One such product was the DBMS <b>GT.m</b> , developed by Graystone Tehnologies in the 1970s and 1980s.  DBMS has found wide application in medicine, insurance and banking. <br><br>  In our bank, we also use GT.m, and this tool does an excellent job of processing a large number of transactions.  But ... There is one problem: GT.m is not for analytics, it does not contain SQL, analytical queries and everything that makes financial analytics happy.  Therefore, we have developed our own ‚Äúbicycle‚Äù for replicating data from GT.m to ‚Äúrelational‚Äù DBMS. <br><br><img src="https://habrastorage.org/files/fa8/718/648/fa8718648eab4d65929156afc11e57d6.jpg"><br>  <i>And here was supposed to be a picture with a flying bicycle</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      All interested invite under the cat. <br><a name="habracut"></a><br>  <b>Pss ... do you want some more GT.m?</b>  Already in those prehistoric times, GT.m had (or had) ACID, transactional serialization, and the presence of indices and the procedural language MUMPS.  By the way, MUMPS is not just a language, it is a whole direction that emerged in the 60s of the 20th century! <br><br>  One of the most successful and popular MUMPS-based DBMS has become <a href="https://ru.wikipedia.org/wiki/Cach%25C3%25A9">Cach√©</a> , and you most likely heard about it. <br><br>  The basis of MUMPS DBMS are hierarchical structures - globals.  Imagine JSON, XML, or the structure of folders and files on your computer - about the same.  And all this our fathers and grandfathers enjoyed before it became mainstream. <br>  One important point - in 2000, the database became Open Source. <br><br>  So, the old woman GT.m is reliable and, despite its advanced years, serves a large number of specific transactions without any effort, unlike, for example, from its SQL counterparts (the phrase is, of course, holivarnaya, but for us this is a fact: load NoSQL is still faster than SQL).  However, all the problems begin when we need to do the simplest analytics, transfer data to analytical systems or, God forbid, automate all this. <br><br>  For a long time, the solution to this problem was the ubiquitous "unloading."  CSV files were generated by procedures written in the M language (MUMPS), and each such upload was developed, tested and implemented by highly qualified specialists.  The effort involved in the development of each unloading was enormous, and the contents of two different unloadings could overlap significantly.  It happened that customers required unloading, to several fields different from the existing ones, and they had to do it all over again.  At the same time, the M language itself is rather hard to understand and read, which entails additional ‚Äúcosts‚Äù both for development and for supporting all this hardcode. <br><br><img src="https://habrastorage.org/files/909/4d7/c3a/9094d7c3acc4420aa2b9400cd01b0b59.png"><br>  <i>Solution with uploads</i> <br><br><h4>  <b>ODS (Operational Data Store)</b> </h4><br>  We already had an implemented architectural pattern called ODS ( <a href="https://en.wikipedia.org/wiki/Operational_data_store">Operational Data Store</a> ), in which we replicate our sources with minimal backlog from 2 seconds to 15 minutes. <br><br>  We load data from ODS into the data warehouse (DWH) or build operational reports on it.  And with relational databases such as Oracle, MS SQL, Sybase, etc.  no problem - we will load source tables into the same tables on the ODS. <br><br><img src="https://habrastorage.org/files/faf/9b4/899/faf9b4899e3b464696e6ad9ed04d14e6.png"><br><br>  We really wanted to implement a similar replication of GT.m in ODS. <br>  But how to load NoSQL structures into simple tables?  How, for example, download a client that can have 2 phones, and maybe 22? <br><br><img src="https://habrastorage.org/files/e65/9f5/f46/e659f5f46c2741419e670bdd9cdbec5c.png"><br><br>  We understood that it would be more correct to organize replication based on binary logs of the DBMS (in other DBMS they are called WAL, Redo, transaction log, etc.), since GT.m logs each transaction, the data being changed.  At the same time, ready-made products already existed on the market, one of which is the Evolve Replicator from <a href="http://www.cavsystems.com/en/">CAV systems</a> . <br><br><h4>  <b>Evolve CAV systems</b> </h4><br>  Evolve reads transaction logs, transforms them, and writes rows to tables already on the relational receiver. <br><br>  But there was one very small problem - this solution did not suit us ... In our structures there was a large number of calculated values ‚Äã‚Äã(Computed Data Items or CDI). <br><br>  I'll try to explain on the fingers.  This is somewhat reminiscent of a ‚Äúvirtual field‚Äù in a DBMS such as Oracle, in which the value is not stored, but calculated at the time of accessing this field.  At the same time, CDI can have quite complex logic and be based on data from child nodes, etc.  And, as you probably already guessed, such Computed Data Items cannot be replicated from DBMS logs, since information on them is not stored there, because only changes in physical fields are recorded in logs.  But we really need such ghost fields for analytics, they have complex logic, and it would be meaningless to have an analytical replica without these fields. <br><br>  Implementing similar logic with calculated fields in a replica is unrealistic.  First, because of performance, and second, to rewrite this entire hardcode from M to SQL is a thankless task. <br><br><img src="https://habrastorage.org/files/b33/ffd/a0e/b33ffda0ead24a2ca282009cdfa57712.jpg"><br><br><h4>  <b>FIS Profile</b> </h4><br>  In addition to the data level, in our system we have the level of applications written in the M. Language. Yes, in our times it sounds crazy, but most banking systems still live in the paradigm of two-tier architecture. <br><br>  Such an application is the FIS Profile (hereinafter Profile) - this is an automated banking system, fully integrated with GT.m.  In addition to banking automation functions, Profile provides the following functionality: <br>  1. The simplest SQL (select * from table where id = 1) <br>  2. Access to JDBC data <br>  3. Representation of globals in a table view, with one global can be presented in several different tables <br>  4. Triggers <br>  5. Secury <br>  In fact, we have another DBMS on top of another DBMS.  In this case, one of them will be relational, and the other - NoSQL. <br><br>  Profile is completely proprietary software, but there are also Open Source analogues, for example, <a href="http://www.hardhats.org/fileman/FMmain.html">Vista Fileman</a> . <br><br><img src="https://habrastorage.org/files/02c/8e9/d60/02c8e9d60b074c44ac65a568938275be.png"><br>  <i>The logical levels of our GT.m-system.</i> <br><br><h4>  <b>Concept implementation</b> </h4><br>  To replicate NoSQL data structures to SQL DBMS, first of all: <br><br>  <b>1. Present globaly in tabular form.</b> <br>  In this case, one node of the "tree" can be represented in the form of several, interconnected tables.  This feature is already provided by the Profile, and all we need is to properly configure such table views.  The task, though difficult, is quite solvable. <br><br>  <b>2. Capture change.</b> <br>  Unfortunately, the presence of CDI in our system does not allow making ‚Äúcorrect replication‚Äù from the DBMS logs.  The only possible option is logical replication with triggers.  The value in the table has changed - the trigger caught it and recorded the change in the journal table.  By the way, the journal table is the same global.  Now all see for yourself! <br><br>  This is what a typical global looks like: <br><br><img src="https://habrastorage.org/files/aaa/375/3e4/aaa3753e4c9949a0b8096eb54e3f4450.png"><br><br>  We understand that it looks at least ... strange, but in those early years the concepts of beauty were completely different.  The structure of the global is also called ‚Äúmultidimensional sparse array‚Äù.  And the key is like the coordinate of the data that lies in it. <br>  By the way, according to the "data" you can also build indexes, which is very convenient for the table view. <br><br>  Actually, from this global we can get 2 tables: <br><br>  TABLE_HEADER: <br><br><img src="https://habrastorage.org/files/117/b42/faa/117b42faade5442ab791af2b321e2d41"><br><br>  TABLE_SHED - change log: <br><br><img src="https://habrastorage.org/files/f69/05b/f2c/f6905bf2c99a4525be90623c93b4ef90"><br><br>  By the way, the numerical values ‚Äã‚Äãare converted to dates, for example, for the TJD field. <br><br>  A query is made on the available tables. <br><br><img src="https://habrastorage.org/files/8fd/d87/c05/8fdd87c055ff49c7a8fbb32610e1cecc"><br>  Where: <br>  <b>: STARTPOINT</b> - the last run date; <br>  <b>'T'</b> is the current date (it looks at least strange, but this function is analogous to sysdate () or now () in <s>normal</s> other DBMS) <br><br>  As we can see, the ‚Äútables‚Äù join;  in fact, the connection is local, within each node, which does not create a significant load. <br><br>  <b>3. Selection of data from journal tables and their subsequent transfer to the ODS.</b> <br>  The JDBC driver that existed at that time worked perfectly with atomic queries, but caused memory leaks during massive Select operations.  The existing driver had to be significantly rewritten. <br><br>  <b>4. Delivery and application of changes.</b> <br>  A very important aspect is the rapid application of data on the receiver.  If GT.m successfully copes with a large number of atomic transactions, then for Oracle relational DBMS such as it carries a large load.  At the same time, data from a large number of other sources (about 15 in total) are being poured into our ODS. <br>  To solve this problem, it is necessary to collect all such operations in batches and apply them as a group.  Such operations are called Bulk and are completely dependent on the specifics of the receiver DBMS. <br><br><img src="https://habrastorage.org/files/8b9/7e2/275/8b97e2275efe43ec925293bd4d501344.png"><br>  <i>Current replication architecture</i> <br><br>  Our application - by the way, we called it <b>Profile Loader</b> - loads two types of tables into ODS: journal and mirror.  We will try to tell about ODS in future articles, but if it is short, then: <br>  <b>log tables</b> - change log tables, these tables are convenient for incremental loading, for example, to analytical systems and DWH <br>  <b>mirror tables</b> - tables containing a complete copy of the source data, such tables are convenient to use for auditing and for operational analytics. <br><br>  <b>5. Point of management.</b> <br>  For easy administration, we made a web snout to start and stop replication streams.  And in general, all the main logic was written in Java, which allowed the use of ready-made Open Source components to solve some specific cases. <br><br><h4>  <b>Tasks solved by SQL replica</b> </h4><br>  1. Disposal of scattered discharges.  We received a single window for all data consumers. <br>  2. Audit.  The audit procedure is simplified due to the fact that the data lie in a convenient form, and the power of SQL allows you to conveniently and quickly operate with this data. <br>  3. Data quality.  For example, in GT.m there are only 2 data types - numeric and string.  When the data arrive in ODS, it is converted to other types, including dates.  If the date is in the wrong format, we can easily catch such an incident and improve the quality of the data already at the source. <br>  4. Calculation of increment for further loading in DWH. <br><br><h4>  <b>Further development</b> </h4><br>  For the future we plan to implement the following: <br>  1. Completely get rid of existing CSV uploads.  Now they are still alive, but we will slowly "shoot them off." <br>  2. Optimize some performance issues. <br>  3. Share ideas with the interested community, and possibly support the project in OpenSource. <br>  4. Try integration with Oracle GoldenGate at the change delivery level. <br>  5. It is possible to make a return replica (optional, not ODS) Replica -&gt; GT.m, for service processes of improving data quality. <br>  6. Develop operational reporting on top of ODS. <br><br><h4>  <b>Summary</b> </h4><br>  In the article we talked about our offspring - Profile Loader and how NoSQL data can be analyzed in SQL DBMS.  This decision may not be entirely correct and elegant, but it works perfectly and fulfills its obligations. <br><br>  If you decide to replicate your NoSQL database into a "relational" for convenient analytics, first of all, estimate the amount of changes, the data model and the capabilities of the technologies that will provide all this. <br><br>  We wish you success in your endeavors! <br>  Always ready to answer your questions. <br><br>  <i>PS We are also grateful to the colleagues who participated and actively assisted in the project: Shevelev Dmitriy, Olya Chechnya, Olya Zhukov, Olya Zhukov, Zhenya, Oksana, Lyubko Andrey, Kudyurova Pavel, Vorobiova Sergey, Lysykh Sergey, Kuleshov Sergey, Lyudko Andrey, Kudyurova Pavel, Vorobiova Sergey, Lysykh Sergey, Kuleshov Dmitry, Lyudko Andrey Yulia, Pasynkova Yuri and colleagues from CAV Systems and FIS.</i> </div><p>Source: <a href="https://habr.com/ru/post/306954/">https://habr.com/ru/post/306954/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../306940/index.html">Coroutines everywhere</a></li>
<li><a href="../306944/index.html">Machine learning for tennis prediction: part 1</a></li>
<li><a href="../306946/index.html">Lead from the fields: who and how applied qualitative methods in UX Research to develop IT products. Part 1 of 6</a></li>
<li><a href="../306948/index.html">Sign Language Translator: Implementing Support Vector Machines on Intel Edison</a></li>
<li><a href="../306950/index.html">Hackers got access to Telegram user accounts in Iran</a></li>
<li><a href="../306956/index.html">Will Twitter be the second ‚ÄúYahoo!‚Äù</a></li>
<li><a href="../306958/index.html">Another version of TFS settings for team work</a></li>
<li><a href="../306960/index.html">Throwing large volumes of documentation</a></li>
<li><a href="../306962/index.html">TDD implementation rules in the old project</a></li>
<li><a href="../306964/index.html">Windows 10 Anniversary Update became available</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>