<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Playing with emotions: Microsoft Cognitive Services + Unity</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Friends! Surely many of you have already heard about cognitive services that allow you to solve complex tasks with a single REST API call ‚Äî to determi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Playing with emotions: Microsoft Cognitive Services + Unity</h1><div class="post__text post__text-html js-mediator-article">  Friends!  Surely many of you have already heard about cognitive services that allow you to solve complex tasks with a single REST API call ‚Äî to determine emotions and a person‚Äôs age from a photo, to make machine translation of text, etc.  Often, cognitive services are implemented in applications or web backends.  Today, our big friend, VRTech employee and Game developer Grigory Dyadichenko will tell us how to implement cognitive services in Unity games, and also invite you to the Unity developers rally, where you can discuss this in more detail. <br><br><hr><br>  In this article I would like to tell about the integration of Microsoft Cognitive Services in Unity;  how to make HTTP requests to services through the WWW class (if suddenly someone else didn‚Äôt come across it and doesn‚Äôt know) and tell me what unexpected problems I faced while developing an application using these services for Google Play. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e31/7bf/8e4/e317bf8e48274c6bd46bf0e464099795.jpg"><br><a name="habracut"></a><br>  Microsoft Cognitive Services is a set of cloud services that allow you to perform tasks such as speech, face recognition, emotion recognition, and more.  More details can be found <a href="https://azure.microsoft.com/ru-ru/services/cognitive-services/">here.</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Once I already wrote <a href="https://habrahabr.ru/post/314904/">an article</a> about cognitive services, and even specifically about the Emotions API.  It used a library for UWP, which cannot be used in the Unity project.  Therefore recently the idea occurred to me that it would be quite good to write a wrapper for these services for Unity.  And I got down to business. <br><br>  These services are an interesting and inexpensive tool for creating ‚Äúwow effect‚Äù at trade shows, collecting contacts and similar tasks.  Working with them, in principle, is much easier than with the same OpenCV.  In the context of game development, you can make a cool bun for the player, which allows you to generate an avatar to the player from his photo. <br><br>  Let us turn to the description of the wrapper itself.  At the moment, it is partially covered with the Emotions API and Face API. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/28d/510/429/28d510429602666b73552a1009494fe4.jpg"><br><br>  Interaction with the solution is very simple.  You create the service you need by specifying the SubscriptionKey in the constructor (for convenience, the ScriptableObject was created in the demo scenes to store them), and then you create a quortenine in which you take the data you need. <br><br><div class="spoiler">  <b class="spoiler_title">Example</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> IEnumerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckEmotions</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {     EmotionService emoServ = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EmotionService(SubscriptionKeys.Instance.EmotionsApiKey);     <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>)     {          <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">yield</span></span></span><span class="hljs-function"> return new </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WaitForEndOfFrame</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>;          <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> emoServ.GetEmoInfoCoroutine(_WebCam.Screenshot);          <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> emotions = emoServ.LastEmotions;          <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (emotions != <span class="hljs-literal"><span class="hljs-literal">null</span></span>)          {               _MaxEmotionValue.text = GetMaxEmotionOnScreenshot(emotions);          }          <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">yield</span></span></span><span class="hljs-function"> return new </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WaitForSeconds</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DELAY</span></span></span><span class="hljs-function">)</span></span>;      } }</code> </pre> <br></div></div><br>  A free trial version of the subscription key can be obtained on <a href="https://azure.microsoft.com/ru-ru/try/cognitive-services/">the Microsoft cognitive services site.</a> <br><br>  So, why is the Cortina?  The fact is that the most convenient way to access services is Rest API.  The easiest way to do this in Unity is through the WWW class, in which the query runs asynchronously.  There are many ways to wait for its implementation. <br><br>  For example, you can block the main thread, but I suspect that in most cases this is undesirable. <br><br>  And you can make korutinami, which is implemented in this version of the wrapper. <br><br><div class="spoiler">  <b class="spoiler_title">Example</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> IEnumerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateRecognizeRequestAndSaveResponseCoroutine</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">           </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> contentHeader,           </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] data</span></span></span><span class="hljs-function">)</span></span> {    Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; headers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;();    headers.Add(Constants.SUB_KEY_HEADER, _SubscriptionKey);    headers.Add(Constants.CONTENT_TYPE_HEADER, contentHeader);    WWW request = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WWW(_RecognizeRequestUrl, data, headers);    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">yield</span></span></span><span class="hljs-function"> return new </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WaitUntil</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="hljs-function">)</span></span> =&gt; request.isDone);    ParseEmotionsFromJson(request.text); }</code> </pre> <br></div></div><br>  This method works well, and it suited me when I wrote my application for android.  Since the analysis of photos takes some time, so that the user does not sit idle, I decided to integrate advertising.  But during the integration of advertising, unexpected problems appeared.  The user watches the ad, the profile is analyzed - profit, but it was not there.  Here I was waiting for a feature about which I did not know about Unity Ads on the android.  The fact is that during the display of advertising, the main stream is blocked, so for the analysis of the profile it was decided to put everything into a separate stream. <br><br>  There I was waiting for a new, but quite logical discovery.  It turns out that the WWW class can only work in the main thread.  Therefore it was necessary to write everything on System.Net (version 2.0, since it is in Unity).  And I would put this solution in the repository, but they needed to sign an SSL certificate, which is not obvious, and can lead to unintended consequences for the user of the wrapper.  If suddenly it will be interesting to someone, then I can put it in a separate project on the githaba, but from the point of view of implementation, there is nothing complicated. <br><br>  (Not the most beautiful example made in haste) <br><br><div class="spoiler">  <b class="spoiler_title">Example in a separate thread</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateRecognizeRequest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {   Clear();   _Thread = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(Run);   _Thread.Start(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {   WebHeaderCollection headers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebHeaderCollection();   headers.Add(Constants.SUB_KEY_HEADER, _SubscriptionKey);   <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = HttpWebRequest.Create(_RecognizeRequestUrl);   request.ContentType = _ContentHeader;   request.Headers = headers;   request.ContentLength = _Data.Length;   request.Method = WebRequestMethods.Http.Post;   <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dataStream = request.GetRequestStream();   dataStream.Write(_Data, <span class="hljs-number"><span class="hljs-number">0</span></span>, _Data.Length);   dataStream.Close();   <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> response = request.GetResponse();   dataStream = response.GetResponseStream();   StreamReader reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StreamReader(dataStream);   <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> responseString = reader.ReadToEnd();   reader.Close();   dataStream.Close();   response.Close();   Debug.Log(responseString);   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!TryParseEmotionsFromJson(responseString))   {      Run();   }   <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>   {      _IsDataReady = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;   } }</code> </pre> <br></div></div><br>  Another fun discovery was discovered when testing the Face API.  I wanted to make this effect a perfect smile. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/UPyXnnR4TbU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Face API can return the same set of emotions as the Emotions API.  But in the course of the tests, I discovered that the results differ, while the Emotions API works a little more stable and accurate.  Therefore, for this effect, the landmarks of the face (in order to correctly put an asterisk) were taken from the Face API, and the emotions from the Emotions API. <br><br>  In the near future, I plan to return to the implementation of this wrapper and to the search for new jokes related to the use of Microsoft Cognitive Services.  In the meantime, there are Demo scenes in the project that show the simplest interaction of EmotionService with a webcam.  In addition, some useful utilities for screenshots (a script that takes a screenshot of a particular RectTransform for example) <br><br>  Returning to the wrapper, you can download and monitor its development <a href="https://github.com/Nox7atra/Microsoft-Cognitive-Services-Unity">in the Github repository</a> .  (It is possible after the mitap reach the hands to write documentation) <br><br><h3>  Unity Moscow Meetup # 3 </h3><br>  On June 7, the third Unity of developers in Moscow will be held at VSBI.  If you are engaged in development on Unity or it is interesting to you - come!  The event is free, registration is required, you can register and learn more information <a href="http://unimosmeet.hsbi.ru/">here.</a> <br><br>  And also, to make follow-ups and see materials from past meetings, you can join the groups: <br><br>  ‚Üí VK: <a href="https://vk.com/unimosmeet">vk.com/unimosmeet</a> <br>  ‚Üí FB: <a href="https://www.facebook.com/groups/unimosmeet/">www.facebook.com/groups/unimosmeet</a> <br><br><h3>  about the author </h3><br><img src="https://habrastorage.org/web/404/9c0/701/4049c070195f43758c51b3b8c5299cd2.jpg" align="left" width="128">  <a href="https://habrahabr.ru/users/dyadichenkoga/">Dyadichenko Grigory</a> is the leading Unity developer at VRTech.  Organizer of Unity Moscow Meetup.  He is fond of algorithms on graphs, game development and everything related to computer graphics. </div><p>Source: <a href="https://habr.com/ru/post/329866/">https://habr.com/ru/post/329866/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../329854/index.html">Porting MIPSfpga to other cards and integrating peripherals into the system. Part 3</a></li>
<li><a href="../329856/index.html">Postgres and Void</a></li>
<li><a href="../329858/index.html">Comparison of Elbrus-4–° and Elbrus-8–° in several problems of computer vision</a></li>
<li><a href="../329862/index.html">Remote connection to protected computers from corporate antivirus</a></li>
<li><a href="../329864/index.html">Chip for smart cameras ELISE - one of the most high-tech products in Russia in 2017. Developer fee and camera</a></li>
<li><a href="../329870/index.html">Kotlin and Swift. New era in mobile development?</a></li>
<li><a href="../329872/index.html">Deploying and maintaining Redmine, the right way</a></li>
<li><a href="../329874/index.html">Fifth generation of HPE MSA storage: twice the performance for the same price</a></li>
<li><a href="../329876/index.html">Limit the speed of processing requests in nginx</a></li>
<li><a href="../329878/index.html">The largest Git repository in the world</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>