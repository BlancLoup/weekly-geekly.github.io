<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Almost OCR to get VPNBook password. PHP + Mikrotik</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, VPNBook began to publish a password instead of direct text as an image. ‚ÄúWell, how is that?‚Äù - I thought and began to look for ways to solve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Almost OCR to get VPNBook password. PHP + Mikrotik</h1><div class="post__text post__text-html js-mediator-article">  Recently, VPNBook began to publish a password instead of direct text as an image.  ‚ÄúWell, how is that?‚Äù - I thought and began to look for ways to solve this problem.  We recognize the "picture" password VPNBook for PHP.  And, of course, the script for Mikrotik. <br><a name="habracut"></a><br>  I have already set up an automatic free PPTP VPN tunnel from VPNBook.com on my router (Mikrotik) and used it until recently successfully.  I will not go into details, they are described in the article " <a href="https://habr.com/post/309892/">Configuring automatic password retrieval for VPN on Mikrotik</a> ".  Before the problem, the password for the VPNBook could be simply extracted from the html page, for example, like this: <br><br><pre><code class="php hljs">preg_match(<span class="hljs-string"><span class="hljs-string">'/Password: &lt;strong&gt;([^&lt;]+)/'</span></span>, $homepage, $matches); <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>($matches[<span class="hljs-number"><span class="hljs-number">1</span></span>])</code> </pre> <br>  And more recently, the password has become a "picture".  And the first thought was to use optical text recognition.  I began to try online and offline services OCR, which could recognize the password.  <i>I say hello to <a href="https://habr.com/users/Winand/">Winand</a> , with whom we have correspondence on this topic.</i>  In general, the last OCR I fumbled with was Tesseract, which ‚Äúout of the box‚Äù defined the password, but with errors.  But it can be taught new fonts, which I was going to do.  When I selected a font that looked like a ‚Äúpicture‚Äù font, the thought arose that it was something simple, although it looked like a teminal from Windows or a terminus font from Linux.  And voila - it turned out to be just a built-in PHP font with the number (size) 5. Next, I abandoned OCR and wrote a PHP script that looks for characters of the ‚Äúpicture‚Äù password using the generated dictionary.  A dictionary is a set of images of possible password characters of the same color and size.  The search is done by matching the images.  Here is a simple reverse engineering.  I assume that the current version of the image in the VPNBook will not last long, given its primitiveness. <br><br><h3>  Script vpnbook.php </h3><br>  Sprint returns a string-password. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">//   $wchar = 9; $hchar = 13; $strDict = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789 '; $imgDict = imagecreatetruecolor(2 + strlen($strDict)* $wchar, $hchar); $bg = imagecolorallocate($imgDict, 0xF6, 0xF6, 0xF6); $textcolor = imagecolorallocate($imgDict, 0x4C, 0x4C, 0x4C); imagefill($imgDict, 0, 0, $bg); imagestring($imgDict, 5, 2, 0, $strDict, $textcolor); //  cURL $ch = curl_init(); //  url,      curl_setopt($ch, CURLOPT_URL, 'https://www.vpnbook.com/password.php'); //  ,      string curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); curl_setopt($ch, CURLOPT_BINARYTRANSFER, 1); // also, this seems wise considering output is image. //   $output = curl_exec($ch); //  cURL curl_close($ch); $imgOCR = imagecreatefromstring($output); // $imgOCR = imageCreateFromPng('password.png'); //      10  . 2 + 10*9 = 92 &lt; 100 $maxchar = floor((imagesx($imgOCR) - 2) / 9); $imgBox = imagecreatetruecolor($wchar, $hchar); $hashDict = Array(); //   for ($k = 0; $k &lt; strlen($strDict) ; $k++) { imagecopy($imgBox, $imgDict, 0, 0, 2 + $k * $wchar, 0, $wchar, $hchar); $hashStr = ""; for($y = 0; $y &lt; $hchar ; $y++) for($x = 0; $x &lt; $wchar; $x++) $hashStr .= (imagecolorat($imgBox, $x, $y) != 0xF6F6F6)? '1': '0'; $hashDict[$hashStr] = $strDict[$k]; } //     for ($k = 0; $k &lt; $maxchar ; $k++) { imagecopy($imgBox, $imgOCR, 0, 0, 2 + $k * $wchar, 0, $wchar, $hchar); $hashStr = ""; for($y = 0; $y &lt; $hchar ; $y++) for($x = 0; $x &lt; $wchar; $x++) $hashStr .= (imagecolorat($imgBox, $x, $y) != 0xF6F6F6)? '1': '0'; $tempchar = $hashDict[$hashStr]; if ($tempchar==' ') break; print($tempchar); } /*header('Content-type: image/png'); imagepng($imgOCR); */ //var_dump($hashDict); imagedestroy($imgDict); imagedestroy($imgOCR); imagedestroy($imgBox); </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre> <br><br><h3>  Plan B. Password from twitter </h3><br>  From the <a href="https://habr.com/users/vvsvic/">vvsvic</a> hint, I <a href="https://habr.com/users/vvsvic/">‚Äôll</a> quote a simple alternative script implementation for extracting the password from the VPNBook twitter (https://twitter.com/vpnbook/) <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">url_get_html</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($url)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  cURL $ch = curl_init(); //  url      curl_setopt($ch, CURLOPT_URL, $url); //        string curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); //   $output = curl_exec($ch); //  cURL curl_close($ch); //   return $output; } $homepage = url_get_html('https://twitter.com/vpnbook'); preg_match('/Password: ([^&lt;]+)/', $homepage, $matches); // Print the entire match result // var_dump($matches); print($matches[1]) // print_r($matches); </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br><br><h3>  Script Mikrotik VPNBook </h3><br>  The script needs to be called every minute from the scheduler.  The script monitors the status of the PPTP connection and, when the connection is broken, calls the whole procedure for requesting a new password, so the microtic does not ‚Äúflood attempts to open the connection for several hours with the wrong password, and reconnection is done in 1 minute.  Also, on-error errors for fetch and file get are tracked here to more accurately determine that a password has been received. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># VPNBookScript v2 :global VPNBookpIfName "pptp-out1" :global VPNBookServerAddresses {"euro217.vpnbook.com";"euro214.vpnbook.com";"us1.vpnbook.com";"us2.vpnbook.com";"ca1.vpnbook.com";"de233.vpnbook.com";"fr1.vpnbook.com"} #:if ([:typeof $VPNBookServerAddresses] != "array") do={ # :set VPNBookServerAddresses {"euro217.vpnbook.com";"euro214.vpnbook.com";"us1.vpnbook.com";"us2.vpnbook.com";"ca1.vpnbook.com";"de233.vpnbook.com"} #} :global VPNBookErr false :global VPNBookPassFile "VPNBookPass.txt" :global VPNBookPass :global VPNBookRun #:global TToken "4.....................2" #:global TChatId "2342432...9" :global VPNBookServerIndex :if ([:typeof $VPNBookServerIndex] != "num") do={:set VPNBookServerIndex 0} :if ([/interface pptp-client get $VPNBookpIfName running]) do={ :set VPNBookRun true } else { :if (!$VPNBookRun) do={ :set VPNBookServerIndex ($VPNBookServerIndex + 1) :if ($VPNBookServerIndex&gt;=[:len $VPNBookServerAddresses]) do={:set VPNBookServerIndex 0} } else { :set VPNBookRun false } :if (![/interface pptp-client get $VPNBookpIfName disabled]) do={/interface pptp-client set $VPNBookpIfName disabled=yes} :do {/tool fetch url="http://server/vpnbookpass.php" dst-path=$VPNBookPassFile} on-error={:set VPNBookErr true} :delay 2 :do {:set VPNBookPass [/file get $VPNBookPassFile contents]} on-error={:set VPNBookErr true} :if (!$VPNBookErr) do={ :if ([/interface pptp-client get $VPNBookpIfName password] != $VPNBookPass) do={/interface pptp-client set $VPNBookpIfName password=$VPNBookPass} :if ([/interface pptp-client get $VPNBookpIfName connect-to] != $VPNBookServerAddresses-&gt;$VPNBookServerIndex) do={/interface pptp-client set $VPNBookpIfName connect-to=($VPNBookServerAddresses-&gt;$VPNBookServerIndex)} :log info ("VPNBook: Attempt to connect to: ".($VPNBookServerAddresses-&gt;$VPNBookServerIndex).". Password: $VPNBookPass") # /tool fetch url=("https://api.telegram.org/bot$TToken/sendmessage\?chat_id=$TChatId&amp;text=VPNBook: Attempt to connect to: ".($VPNBookServerAddresses-&gt;$VPNBookServerIndex).". Password: $VPNBookPass") keep-result=no /interface pptp-client set $VPNBookpIfName disabled=no } }</span></span></code> </pre> <br>  I also recommend adding the disconnection of the PPTP interface by breaking the connection (on-down event) in the PPP profile so that the reconnection does not flood at all even for 1 minute. <br><br>  Accordingly, the main script will, within 1 minute in case of a successful receipt of a new password, raise the pptp-out1 connection. <br><br><pre> <code class="bash hljs">add change-tcp-mss=yes name=VPNBook on-down=\ <span class="hljs-string"><span class="hljs-string">":if (![/interface pptp-client get pptp-out1 disabled]) do={\r\ \n /interface pptp-client set pptp-out1 disabled=yes\r\ \n}"</span></span> only-one=yes use-compression=yes use-encryption=required use-ipv6=no use-mpls=no use-upnp=no</code> </pre> </div><p>Source: <a href="https://habr.com/ru/post/420373/">https://habr.com/ru/post/420373/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../420361/index.html">Bug when working TextBox.GetLineText in .NET WPF</a></li>
<li><a href="../420363/index.html">HPE webinars in August-October: new topics (+ storage, AI practice, turnkey petabyte storage)</a></li>
<li><a href="../420367/index.html">Air-conditioned apocalypse: blackout scenario of the grid using smart climate instruments</a></li>
<li><a href="../420369/index.html">Extreme Extended Edge, or IEEE 802.1BR based switching</a></li>
<li><a href="../420371/index.html">To the issue of bicycle engineering in the field of electromail posting</a></li>
<li><a href="../420375/index.html">Learn OpenGL. Lesson 5.8 - Bloom</a></li>
<li><a href="../420377/index.html">How we ran video calls</a></li>
<li><a href="../420379/index.html">Chamber of Commerce of Russia proposed not to punish users of "spyware" devices</a></li>
<li><a href="../420381/index.html">Why stop counting neural networks as a black box?</a></li>
<li><a href="../420383/index.html">"Yandex.Money to enter your application is not interesting to make stonibut"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>