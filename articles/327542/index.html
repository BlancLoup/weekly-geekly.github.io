<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Threats to the WPA2-Enterprise wireless corporate network and how to protect</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, together with Digital Security, we conducted a pentest of our corporate wi-fi-network. Today, with colleagues, we‚Äôll tell you what co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Threats to the WPA2-Enterprise wireless corporate network and how to protect</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/4be/a53/de9/4bea53de91c34156ac5739b6be4546e8.png"><br></p><br><p>  Not so long ago, together with <a href="https://habrahabr.ru/company/dsec/">Digital Security,</a> we conducted a pentest of our corporate wi-fi-network.  Today, with colleagues, we‚Äôll tell you what could threaten a wireless network built on the basis of WPA2-Enterprise with domain account authentication and how to protect against this. <a name="habracut"></a></p><br><h2 id="pro-wpa2-enterprise">  About WPA2-Enterprise </h2><br><p>  Before we talk about attacks and ways to protect against them, let us recall the main features of the WPA2-Enterprise standard. </p><br><p>  <b>Authentication.</b>  In order to connect to the network, the client must authenticate to the AAA server.  Often this is the RADIUS server.  Authentication can be performed using a domain password, client certificate, etc. (EAP). </p><br><p>  <b>Encryption.</b>  Organized by the AES algorithm.  The dynamic encryption key, individual for each client (802.1X), is generated at the time of authentication on the RADIUS server.  This key can be updated periodically as you work without breaking the connection. </p><br><img src="https://habrastorage.org/files/983/c2e/2be/983c2e2befa9420b8a64bd06420c1beb.PNG"><br><p>  <em>WPA2-Enterprise operation scheme.</em> </p><br><p>  The process of connecting a client to a wireless network can be briefly described as follows. <br>  When connected, client data is transmitted to an access point / controller using the 802.1x protocol.  The information is then sent to the RADIUS server, where the client is authenticated: the RADIUS server checks whether such a client with the specified login and password is in its lists and whether it can be connected. <br>  After successful authentication, the access point connects the client to the network. </p><br><p>  Let's take a closer look at the authentication process on the RADIUS server: </p><br><ol><li>  A client wishing to be authenticated will request to start a communication session. </li><li>  In response, the callee (the RADIUS server) sends arbitrary, but different, information to the client each time. </li><li>  The client adds a password to the received request and calculates a hash from this line. </li><li>  The RADIUS server performs similar actions with the value sent and compares the result.  If the hash values ‚Äã‚Äãmatch, then authentication is considered successful. <br>  Periodically, the RADIUS server sends a new challenge to the client, and the authentication procedure is repeated again. <br>  Such an authentication mechanism is called ‚Äúchallenge ‚Äì response‚Äù and occurs according to one of the EAP protocols - <a href="http://en.wikipedia.org/wiki/Protected_Extensible_Authentication_Protocol">PEAP-MSCHAPv2</a> . </li></ol><br><h2 id="ot-chego-zaschischaemsya">  What are we protecting ourselves from? </h2><br><p>  You need to know the enemy in person, so here‚Äôs a brief look at the mechanics of possible attacks against the WPA2-Enterprise network with domain account authentication. </p><br><p>  <strong>Connect clients to a false access point.</strong>  Knowing the network name SSID (ESSID, if the network is built on several access points) and the MAC address of the access point (BSSID), an attacker can deploy an illegitimate access point. </p><br><p>  To increase their chances of success, the attackers use the following simple techniques: </p><br><ul><li>  an illegitimate access point has a more powerful signal than a legitimate one; </li><li>  an illegitimate access point is deployed where the signal of legitimate access points does not reach, but where there are clients that usually connect to this network. </li></ul><br><p>  In order to connect to this access point, the attacker deploys his RADIUS server, to which an illegitimate access point will connect.  This RADIUS server has no task to authenticate the client and verify that it has entered the correct password.  The main thing is to get the authorization data from the client, the login and the answer to the challenge presented by the false Radius-server.  Their attacker will use for offline password guessing and subsequent connection to the target corporate wireless network. </p><br><p>  Without monitoring the broadcast, locating an illegitimate access point is not always easy.  An attacker is unlikely to look like a man with a huge backpack, a bunch of antennas and a diesel generator on a trolley. </p><br><p>  For example, for their Pentest, colleagues from Digital Security use a portable household router with a built-in battery (like <a href="http://www.tp-linkru.com/products/details/TL-MR3040.html">this</a> ).  Reflash using OpenWRT and install a custom package.  The output is an access point with a built-in RADIUS server, which can, if necessary, listen to the air and collect data.  If you wish, you can even use a regular phone. </p><br><p>  The locations of such access points are limited only by the ingenuity of the cracker.  If the victim's office is located in a business center, then you can deploy an access point in the lobby to the turnstiles or the lobby with sofas.  It is convenient to place such an access point in the elevator car: it moves away from the legitimate access points with great speed, so the client device is trapped and is likely to connect to a false access point.  The attacker can even ride with a false access point on corporate transport, which carries employees to the subway after work. </p><br><p>  <strong>Forced deauthentication</strong> .  If the client is already connected to a legitimate access point, then it must somehow be disconnected from it (forcibly deauthenticated) in order to reconnect to a false one.  The attacker listens to the broadcast.  To do this, he puts his wi-fi-adapter in monitor-mode.  Usually for this purpose use a set of utilities <a href="https://www.aircrack-ng.org/">aicrack-ng</a> .  With his help, the attacker begins to send messages to wireless clients that a legitimate access point to which the client is already connected is disconnected and leaves the air.  This effect is achieved with the help <a href="http://wi-life.ru/texnologii/wi-fi/wi-fi-frames-management-control-data">of wi-fi (Management Frame)</a> injection <a href="http://wi-life.ru/texnologii/wi-fi/wi-fi-frames-management-control-data">frames</a> , namely: <a href="https://mrncciew.com/2014/10/11/802-11-mgmt-deauth-disassociation-frames/">deassociation and deauthentication frames</a> . </p><br><p>  As a result, the client disconnects from the access point and begins to search for a new access point with the same ESSID.  In this situation, an access point with a more powerful signal just comes in handy.  The client device is trying to connect to it.  If the client authenticates to a false RADIUS server, the attacker can capture the user name and authentication MSCHAPv2 session. </p><br><h2 id="kak-zaschischaemsya">  How to defend </h2><br><p>  These attacks can be prevented by using the following protection measures: </p><br><table><thead><tr><th>  Attack </th><th>  Measure </th></tr></thead><tbody><tr><td>  Connecting clients to a false access point </td><td>  monitoring of the air to identify fake access points;  user authentication using client certificates </td></tr><tr><td>  Client Forced Deauthentication </td><td>  monitoring of the air to detect attempts to forcibly deauthenticate customers of wireless networks;  802.11w activation (Protected Management Frames, PMF) on the controller </td></tr></tbody></table><br><p>  Further we will tell how each of the methods of protection is implemented in our case. </p><br><p>  <strong>Monitor the air and identify false access points.</strong>  It is possible to organize monitoring of the air using standard means of access points and a WLAN controller.  The following discussion focuses on Cisco devices. <br>  To do this, the Off Channel Scanning mechanism is activated on access points, in which it periodically scans the air on all channels.  As a result of such monitoring, it identifies the least loaded channel and third-party access points (in Cisco terminology, Rogue AP).  Data from access points is sent to the controller to which they are connected. </p><br><p>  On the controller itself, the rule of classification of third-party access points is configured, according to which all extraneous access points with an SSID equivalent to ours are considered illegitimate (Jore in Cisco terminology).  You can read more about configuring a Cisco controller in <a href="https://habrahabr.ru/post/148903/">this</a> series of articles. </p><br><img src="https://habrastorage.org/files/dc9/aa1/1ba/dc9aa11ba29341ac865d473ee25aa400.png"><br><p>  <em>This is the message about the found illegitimate access point in the web interface of the controller.</em> </p><br><p>  <em>681 Mon Apr 10 12:10:55 2017 Rogue AP: 14: 2d: 27: ef: f8: 2b.</em> <em><br></em>  <em>682 Mon Apr 10 12:10:55 2017 Rogue AP 14: 2d: 27: ef: f8: 2b is advertising our SSID.</em>  <em>Auto containing as per WPS policy</em> <em><br></em>  <em>Messages in the controller logs when detecting an illegitimate access point.</em> </p><br><p>  In the monitoring system (in our case, it is Nagios), the SNMP poll of the controller is configured.  When an illegitimate access point is detected, a message is displayed on the monitoring screen containing: </p><br><ul><li>  MAC address of an illegitimate access point; </li><li>  The MAC address of the access point that detected it. </li></ul><br><p>  Using the table of the MAC address of the access point and its location, you can determine the approximate location of the illegitimate access point. </p><br><img src="https://habrastorage.org/files/97b/146/ba6/97b146ba61c24e398442e7066f5fcf52.PNG"><br><p>  The message in the monitoring system that an illegitimate access point was recorded. </p><br><p>  <strong>Monitor the air for attempts to forcibly deauthenticate wireless clients</strong> .  As part of the intrusion detection system (IDS), the Cisco controller has a standard set of standard signatures with which it can recognize the potentially dangerous behavior of customers and neighboring access points.  This includes multiple attempts to deauthenticate, authenticate, associate, etc. </p><br><p>  <em>Wed Apr 12 10:17:53 2017 IDS Signature attack detected.</em>  <em>Signature Type: Standard, Name: Auth flood, Description: Authentication Request flood, Track: Per-signature, Detecting AP Name: OST_Reception, Radio Type: 802.11b / g, Preced: 5, Hits: 500, Channel: 11, srcMac: 14: 2d: 27: ef: f8: 2b</em> <em><br></em>  <em>Multiple Authentication Messages in Cisco Controller Logs</em> </p><br><p>  The controller in question also has intrusion prevention mechanisms (IPS).  For example, if you identify an illegitimate access point, you can counteract the invasion by the same means that are used in the attacks - deauthentication and deassociation.  The controller can be configured so that when an access point appears with an SSID that matches the controller being advertised, the auto contain mechanism will start: access points that capture the signal of the illegitimate access point start sending deauthentication frames to the clients on behalf of this access point.  As a result, it becomes very difficult for the client to work and transmit data to an illegitimate access point. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/fa7/136/b8e/fa7136b8ea634987b608aee3383438c2.png"></div><br><p>  <em>Configure automatic deauthentication of clients that connect to an illegitimate access point on a Cisco controller.</em> </p><br><p>  You can receive information from the controller about IDS events in two ways: sending SNMP traps to the monitoring system or parsing the controller log. </p><br><p>  The monitoring system also receives a message with the MAC address of the illegitimate access point and the MAC address of the legitimate access point that detected it. </p><br><p>  To protect against forced deauthentication, 802.11w is activated on the controller (Protected Management Frames, PMF).  This mode prevents attacks aimed at forcibly disconnecting the client from the legitimate access point and reconnecting to the illegitimate one.  When using 802.11w, the frames of Disassociation, Reassociation, Deauthentication are signed by a key known only to authorized clients and legitimate access points.  As a result, the client can determine whether this frame was received from a legitimate point or not. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/035/987/3b4/0359873b46e949ad8a0711dcae94a515.png"></div><br><p>  <em>Enable 802.11w PMF in the Cisco Controller Web Interface</em> . </p><br><p>  <strong>Authentication by user certificates.</strong>  The essence of the method lies in the fact that the client is authenticated by a user certificate issued by a trusted certification authority.  This certificate is placed in the user certificate store of each wireless device.  When connected, an authentication server (AAA server) verifies the certificate presented by the device with the established policies. </p><br><p>  An attacker can penetrate a network with authentication under a client certificate only by stealing a device with a certificate and having a login / password to log on to the device.  But here too, the loophole quickly closes: when the theft becomes known, the certificate can be quickly withdrawn at the certification authority.  The authentication server is notified that the certificate has been revoked, so the attacker will not be able to connect to the target network using the certificate. </p><br><p>  Below is a diagram of how a WPA2-Enterprise wireless network with user certificate authentication is implemented with us. </p><br><img src="https://habrastorage.org/files/36a/bf5/2cd/36abf52cd8a74635a15b33ffc7c4638a.PNG"><br><p>  Let us consider in more detail the following components of this scheme. </p><br><p>  <strong>RADIUS server.</strong>  Accepts requests from devices to connect wireless devices (radius-clients). </p><br><p>  <a href="https://technet.microsoft.com/ru-ru/library/cc732912(v%3Dws.11).aspx"><strong>Network Policy Server, NPS</strong></a> .  Performs authentication and authentication.  The conditions for connecting to a wireless network are also configured here.  For example: </p><br><ul><li>  certificate request; </li><li>  certificate issuer; </li><li>  connection schedule. </li></ul><br><p>  <strong>Active Directory Domain Server ( <a href="https://technet.microsoft.com/en-us/library/cc770946(v%3Dws.10).aspx">AD DS</a> ).</strong>  Contains database with user accounts and user groups.  In order for NPS to receive user data, you must register NPS with AD DS. </p><br><p>  <strong>Active Directory Certificate services.</strong>  Public Key Infrastructure (PKI). </p><br><ul><li><p>  Root server.  Root certifying center.  Here, the certificate of the certificate authority is generated on the basis of the private key.  With this certificate, a certificate is signed for the intermediate certification authority. <br>  Usually, this certificate, together with the key, is exported to a USB flash drive, hidden in the basement, in a safe, so that there is no physical access to outsiders.  The server itself is disabled. </p><br></li><li>  Subordinate server.  Intermediate Certification Authority.  The certificate of the intermediate certifying center is stored here.  In the future, client certificates are issued here, which are signed by an intermediate certificate.  Using Active Directory group policies, it instructs client devices to request a certificate for a user.  The certificate is issued and goes to the user device storage. </li></ul><br><p>  The scheme with a subordinate server is advantageous in that when the intermediate certificate is compromised, the root certificate will not be affected in any way.  In this case, the compromised certificate is simply revoked through the root server, and the subordinate server is deleted. </p><br><p>  That's all for today, ask your questions in the comments. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/327542/">https://habr.com/ru/post/327542/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../327530/index.html">Bash scripts, part 7: sed and word processing</a></li>
<li><a href="../327532/index.html">ITMO University Digest: business projects, initiatives and advice to entrepreneurs</a></li>
<li><a href="../327534/index.html">‚ÄúFriday format‚Äù: demotivation, or love [for work] cannot be bought for money</a></li>
<li><a href="../327536/index.html">What is a service mesh and why do I need it [for a cloud microservice application]?</a></li>
<li><a href="../327540/index.html">Apple Music: not trying to hide the pain</a></li>
<li><a href="../327544/index.html">Friday JS: the only true way to calculate factorial</a></li>
<li><a href="../327546/index.html">As we "Miss Russia" in the hands of endured</a></li>
<li><a href="../327548/index.html">How to take care of sites during the holidays</a></li>
<li><a href="../327550/index.html">Trend Hyper Convergence: Cisco HyperFlex</a></li>
<li><a href="../327552/index.html">What I learned from the 90s games</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>