<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Integration of Symfony2 authentication and Jira tracker</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habrosoobschestvu. In this article I want to tell you how you can make friends with the well-known Symfony2 framework and the equally well-know...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Integration of Symfony2 authentication and Jira tracker</h1><div class="post__text post__text-html js-mediator-article">  Hello, Habrosoobschestvu.  In this article I want to tell you how you can make friends with the well-known Symfony2 framework and the equally well-known Jira tracker. <br><br><h4>  Why bind Jira and Symfony2? </h4><br>  In the company where I work, it became necessary to link the support system and the task tracker through the API so that applications from customers can be easily converted into tickets.  The primary problem that stood in our way was the integration of Jira authentication (using the ‚ÄúBasic Authentication‚Äù mechanism) and the Symfony2 security system.  To understand the framework authentication and authorization mechanisms, you should read the official documentation: <a href="http://symfony.com/doc/current/book/security.html">http://symfony.com/doc/current/book/security.html</a> . <br><a name="habracut"></a><br><br><h4>  What do you need to create a new type of authorization in Symfony2? </h4><br><ol><li>  Token, which will store user-entered information during authentication. </li><li>  Listener, required to verify user authorization. </li><li>  Provider directly implementing authentication through Jira. </li><li>  User Provider, which will be requested by Symfony2 Security to retrieve user information </li><li>  Factory, which will register a new authentication and authorization method. </li></ol>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Create Token </h4><br>  Symfony uses tokens that are inherited from the AbstractToken class to save information entered during user authentication and its subsequent use.  In the task in question, it is necessary to store 2 fields - this is the username and password of the user, on the basis of which the authorization check in Jira will be performed.  The implementation code for the token class is shown below. <br><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DG</span></span>\<span class="hljs-title"><span class="hljs-title">JiraAuthBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Authentication</span></span>\<span class="hljs-title"><span class="hljs-title">Token</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Authentication</span></span>\<span class="hljs-title"><span class="hljs-title">Token</span></span>\<span class="hljs-title"><span class="hljs-title">AbstractToken</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JiraToken</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractToken</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $jira_login; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $jira_password; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $roles = array</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">'ROLE_USER'</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">)</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::__construct($roles); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;setAuthenticated(count($roles) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getJiraLogin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;jira_login; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setJiraLogin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($jira_login)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;jira_login = $jira_login; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getJiraPassword</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;jira_password; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setJiraPassword</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($jira_password)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;jira_password = $jira_password; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> serialize(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;jira_login, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;jira_password, <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::serialize())); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unserialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($serialized)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">list</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;jira_login, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;jira_password, $parent_data) = unserialize($serialized); <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::unserialize($parent_data); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCredentials</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>; } }</code> </pre> <br><br><h4>  Listener implementation </h4><br>  Now that we have user data stored, it should be possible to check for correctness.  If the data is outdated, you need to inform the framework about this.  To do this, you must implement a Listener inherited from AbstractAuthenticationListener. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DG</span></span>\<span class="hljs-title"><span class="hljs-title">JiraAuthBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Firewall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">DG</span></span>\<span class="hljs-title"><span class="hljs-title">JiraAuthBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Authentication</span></span>\<span class="hljs-title"><span class="hljs-title">Token</span></span>\<span class="hljs-title"><span class="hljs-title">JiraToken</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">EventDispatcher</span></span>\<span class="hljs-title"><span class="hljs-title">EventDispatcherInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">HttpFoundation</span></span>\<span class="hljs-title"><span class="hljs-title">Request</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">HttpFoundation</span></span>\<span class="hljs-title"><span class="hljs-title">Response</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Psr</span></span>\<span class="hljs-title"><span class="hljs-title">Log</span></span>\<span class="hljs-title"><span class="hljs-title">LoggerInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Authentication</span></span>\<span class="hljs-title"><span class="hljs-title">AuthenticationManagerInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Authentication</span></span>\<span class="hljs-title"><span class="hljs-title">Token</span></span>\<span class="hljs-title"><span class="hljs-title">TokenInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Exception</span></span>\<span class="hljs-title"><span class="hljs-title">AuthenticationException</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">SecurityContextInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Firewall</span></span>\<span class="hljs-title"><span class="hljs-title">AbstractAuthenticationListener</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JiraListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractAuthenticationListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attemptAuthentication</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Request $request)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;options[<span class="hljs-string"><span class="hljs-string">'post_only'</span></span>] &amp;&amp; <span class="hljs-string"><span class="hljs-string">'post'</span></span> !== strtolower($request-&gt;getMethod())) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> !== <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger-&gt;debug(sprintf(<span class="hljs-string"><span class="hljs-string">'Authentication method not supported: %s.'</span></span>, $request-&gt;getMethod())); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } $username = trim($request-&gt;get(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;options[<span class="hljs-string"><span class="hljs-string">'username_parameter'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)); $password = $request-&gt;get(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;options[<span class="hljs-string"><span class="hljs-string">'password_parameter'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $request-&gt;getSession()-&gt;set(SecurityContextInterface::LAST_USERNAME, $username); $request-&gt;getSession()-&gt;set(<span class="hljs-string"><span class="hljs-string">'jira_auth'</span></span>, base64_encode($username.<span class="hljs-string"><span class="hljs-string">':'</span></span>.$password)); $token = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JiraToken(); $token-&gt;setJiraLogin($username); $token-&gt;setJiraPassword($password); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;authenticationManager-&gt;authenticate($token); } }</code> </pre><br><br><h4>  Log in to Jira.  Provider </h4><br>  The time has come for the most important thing - to send data directly to Jira.  To work with the rest api tracker, a simple class is written that connects as a service.  The Buzz library is used to work with the Jira API. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DG</span></span>\<span class="hljs-title"><span class="hljs-title">JiraAuthBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Jira</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Buzz</span></span>\<span class="hljs-title"><span class="hljs-title">Message</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Buzz</span></span>\<span class="hljs-title"><span class="hljs-title">Client</span></span>\<span class="hljs-title"><span class="hljs-title">Curl</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JiraRest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $jiraUrl = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($jiraUrl)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;jiraUrl = $jiraUrl; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($username, $password)</span></span></span></span>{ $request = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Message\Request( <span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'/rest/api/2/user?username='</span></span> . $username, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;jiraUrl ); $request-&gt;addHeader(<span class="hljs-string"><span class="hljs-string">'Authorization: Basic '</span></span> . base64_encode($username . <span class="hljs-string"><span class="hljs-string">':'</span></span> . $password) ); $request-&gt;addHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type: application/json'</span></span>); $response = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Message\Response(); $client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Curl(); $client-&gt;setTimeout(<span class="hljs-number"><span class="hljs-number">10</span></span>); $client-&gt;send($request, $response); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $response; } }</code> </pre><br><br>  The provider must implement the AuthenticationProviderInterface interface and look like this: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DG</span></span>\<span class="hljs-title"><span class="hljs-title">JiraAuthBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Authentication</span></span>\<span class="hljs-title"><span class="hljs-title">Provider</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">DG</span></span>\<span class="hljs-title"><span class="hljs-title">JiraAuthBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">DG</span></span>\<span class="hljs-title"><span class="hljs-title">JiraAuthBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Jira</span></span>\<span class="hljs-title"><span class="hljs-title">JiraRest</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">DG</span></span>\<span class="hljs-title"><span class="hljs-title">JiraAuthBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Authentication</span></span>\<span class="hljs-title"><span class="hljs-title">Token</span></span>\<span class="hljs-title"><span class="hljs-title">JiraToken</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Authentication</span></span>\<span class="hljs-title"><span class="hljs-title">Provider</span></span>\<span class="hljs-title"><span class="hljs-title">AuthenticationProviderInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Authentication</span></span>\<span class="hljs-title"><span class="hljs-title">Token</span></span>\<span class="hljs-title"><span class="hljs-title">TokenInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Exception</span></span>\<span class="hljs-title"><span class="hljs-title">AuthenticationException</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>\<span class="hljs-title"><span class="hljs-title">UserProviderInterface</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JiraProvider</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthenticationProviderInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $userProvider; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $jiraRest; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UserProviderInterface $userProvider, $providerKey, JiraRest $jiraRest)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userProvider = $userProvider; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;jiraRest = $jiraRest; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">supports</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TokenInterface $token)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $token <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> JiraToken; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">authenticate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TokenInterface $token)</span></span></span><span class="hljs-function"> </span></span>{ $user = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;checkUserAuthentication($token); $token-&gt;setUser($user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $token; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkUserAuthentication</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JiraToken $token)</span></span></span></span>{ $response = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;jiraRest-&gt;getUserInfo($token-&gt;getJiraLogin(), $token-&gt;getJiraPassword()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!in_array(<span class="hljs-string"><span class="hljs-string">'HTTP/1.1 200 OK'</span></span>, $response-&gt;getHeaders())){ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AuthenticationException( <span class="hljs-string"><span class="hljs-string">'Incorrect email and/or password'</span></span> ); } $userInfo = json_decode($response-&gt;getContent()); $user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(); $user-&gt;setUsername($userInfo-&gt;name); $user-&gt;setBase64Hash(base64_encode($token-&gt;getJiraLogin() . <span class="hljs-string"><span class="hljs-string">':'</span></span> . $token-&gt;getJiraPassword())); $user-&gt;setEmail($userInfo-&gt;emailAddress); $user-&gt;addRole(<span class="hljs-string"><span class="hljs-string">'ROLE_USER'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $user; } }</code> </pre><br><br>  As you can see from the implementation, user data is stored in the User entity.  You can not do this, so that Doctrine does not create an extra table in the database, but in the future you can add information about users from Jira to this table in order to protect yourself against the temporary unavailability of the tracker.  Such ‚Äúinsurance‚Äù is beyond the scope of the article, but can be very useful. <br><br><h4>  Providing information about the authorized user </h4><br>  Security in the framework requests user information to verify authorization.  It is clear that such information is in Jira, so we should receive it from the tracker.  You can, of course, cache the answers from Jira, but for now we will not take this into account.  The provider code is shown below. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DG</span></span>\<span class="hljs-title"><span class="hljs-title">JiraAuthBundle</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">DG</span></span>\<span class="hljs-title"><span class="hljs-title">JiraAuthBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">DG</span></span>\<span class="hljs-title"><span class="hljs-title">JiraAuthBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Jira</span></span>\<span class="hljs-title"><span class="hljs-title">JiraRest</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">HttpFoundation</span></span>\<span class="hljs-title"><span class="hljs-title">Request</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">HttpFoundation</span></span>\<span class="hljs-title"><span class="hljs-title">Session</span></span>\<span class="hljs-title"><span class="hljs-title">Session</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Exception</span></span>\<span class="hljs-title"><span class="hljs-title">UnsupportedUserException</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Exception</span></span>\<span class="hljs-title"><span class="hljs-title">UsernameNotFoundException</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>\<span class="hljs-title"><span class="hljs-title">UserInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>\<span class="hljs-title"><span class="hljs-title">UserProviderInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">SecurityContextInterface</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JiraUserProvider</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserProviderInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $jiraRest; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JiraRest $jiraRest)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;jiraRest = $jiraRest; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadUserByUsername</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($username)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">refreshUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UserInterface $user)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$user <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> User) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UnsupportedUserException(sprintf(<span class="hljs-string"><span class="hljs-string">'Instances of "%s" are not supported.'</span></span>, get_class($user))); } $decodedUserData = base64_decode($user-&gt;getBase64Hash()); <span class="hljs-keyword"><span class="hljs-keyword">list</span></span>($username, $password) = explode(<span class="hljs-string"><span class="hljs-string">':'</span></span>, $decodedUserData); $userInfoResponse = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;jiraRest-&gt;getUserInfo($username, $password); $userInfo = json_decode($userInfoResponse-&gt;getContent()); $user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(); $user-&gt;setUsername($user-&gt;getUsername()); $user-&gt;setEmail($userInfo-&gt;emailAddress); $user-&gt;setBase64Hash($user-&gt;getBase64Hash()); $user-&gt;addRole(<span class="hljs-string"><span class="hljs-string">'ROLE_USER'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $user; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">supportsClass</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($class)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $class === <span class="hljs-string"><span class="hljs-string">'DG\JiraAuthBundle\Entity\User'</span></span>; } }</code> </pre><br><br><h4>  Filling configuration </h4><br>  To use the created classes, you must register them in the configuration as services.  An example of services.yml is shown below.  I note that the jira_url parameter must be defined in parameters.yml and contain the url address before Jira. <br><pre> <code class="python hljs">parameters: dg_jira_auth.user_provider.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>: DG\JiraAuthBundle\User\JiraUserProvider dg_jira_auth.listener.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>: DG\JiraAuthBundle\Security\Firewall\JiraListener dg_jira_auth.provider.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>: DG\JiraAuthBundle\Security\Authentication\Provider\JiraProvider dg_jira_auth.handler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>: DG\JiraAuthBundle\Security\Authentication\Handler\JiraAuthenticationHandler dg_jira.rest.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>: DG\JiraAuthBundle\Jira\JiraRest services: dg_jira.rest: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">:</span></span> %dg_jira.rest.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>% arguments: - <span class="hljs-string"><span class="hljs-string">'%jira_url%'</span></span> dg_jira_auth.user_provider: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">:</span></span> %dg_jira_auth.user_provider.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>% arguments: - @dg_jira.rest dg_jira_auth.authentication_success_handler: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">:</span></span> %dg_jira_auth.handler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>% dg_jira_auth.authentication_failure_handler: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">:</span></span> %dg_jira_auth.handler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>% dg_jira_auth.authentication_provider: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">:</span></span> %dg_jira_auth.provider.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>% arguments: [@dg_jira_auth.user_provider, <span class="hljs-string"><span class="hljs-string">''</span></span>, @dg_jira.rest] dg_jira_auth.authentication_listener: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">:</span></span> %dg_jira_auth.listener.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>% arguments: - @security.context - @security.authentication.manager - @security.authentication.session_strategy - @security.http_utils - <span class="hljs-string"><span class="hljs-string">''</span></span> - @dg_jira_auth.authentication_success_handler - @dg_jira_auth.authentication_failure_handler - <span class="hljs-string"><span class="hljs-string">''</span></span> - @logger - @event_dispatcher</code> </pre><br><br><h4>  Registering a new authentication and authorization method in symfony </h4><br>  For all of the above to work, you need to describe the authentication behavior in the form of a factory and register it in a bundle. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DG</span></span>\<span class="hljs-title"><span class="hljs-title">JiraAuthBundle</span></span>\<span class="hljs-title"><span class="hljs-title">DependencyInjection</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Factory</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Bundle</span></span>\<span class="hljs-title"><span class="hljs-title">SecurityBundle</span></span>\<span class="hljs-title"><span class="hljs-title">DependencyInjection</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Factory</span></span>\<span class="hljs-title"><span class="hljs-title">AbstractFactory</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Config</span></span>\<span class="hljs-title"><span class="hljs-title">Definition</span></span>\<span class="hljs-title"><span class="hljs-title">Builder</span></span>\<span class="hljs-title"><span class="hljs-title">NodeDefinition</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">DependencyInjection</span></span>\<span class="hljs-title"><span class="hljs-title">ContainerBuilder</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">DependencyInjection</span></span>\<span class="hljs-title"><span class="hljs-title">DefinitionDecorator</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">DependencyInjection</span></span>\<span class="hljs-title"><span class="hljs-title">Reference</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JiraFactory</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractFactory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;addOption(<span class="hljs-string"><span class="hljs-string">'username_parameter'</span></span>, <span class="hljs-string"><span class="hljs-string">'_username'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;addOption(<span class="hljs-string"><span class="hljs-string">'password_parameter'</span></span>, <span class="hljs-string"><span class="hljs-string">'_password'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;addOption(<span class="hljs-string"><span class="hljs-string">'intention'</span></span>, <span class="hljs-string"><span class="hljs-string">'authenticate'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;addOption(<span class="hljs-string"><span class="hljs-string">'post_only'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createAuthProvider</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContainerBuilder $container, $id, $config, $userProviderId)</span></span></span><span class="hljs-function"> </span></span>{ $provider = <span class="hljs-string"><span class="hljs-string">'dg_jira_auth.authentication_provider.'</span></span>.$id; $container -&gt;setDefinition($provider, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefinitionDecorator(<span class="hljs-string"><span class="hljs-string">'dg_jira_auth.authentication_provider'</span></span>)) -&gt;replaceArgument(<span class="hljs-number"><span class="hljs-number">1</span></span>, $id) ; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $provider; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getListenerId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'dg_jira_auth.authentication_listener'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPosition</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'form'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'jira-form'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createListener</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($container, $id, $config, $userProvider)</span></span></span><span class="hljs-function"> </span></span>{ $listenerId = <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::createListener($container, $id, $config, $userProvider); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($config[<span class="hljs-string"><span class="hljs-string">'csrf_provider'</span></span>])) { $container -&gt;getDefinition($listenerId) -&gt;addArgument(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Reference($config[<span class="hljs-string"><span class="hljs-string">'csrf_provider'</span></span>])) ; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $listenerId; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createEntryPoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($container, $id, $config, $defaultEntryPoint)</span></span></span><span class="hljs-function"> </span></span>{ $entryPointId = <span class="hljs-string"><span class="hljs-string">'security.authentication.form_entry_point.'</span></span>.$id; $container -&gt;setDefinition($entryPointId, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefinitionDecorator(<span class="hljs-string"><span class="hljs-string">'security.authentication.form_entry_point'</span></span>)) -&gt;addArgument(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Reference(<span class="hljs-string"><span class="hljs-string">'security.http_utils'</span></span>)) -&gt;addArgument($config[<span class="hljs-string"><span class="hljs-string">'login_path'</span></span>]) -&gt;addArgument($config[<span class="hljs-string"><span class="hljs-string">'use_forward'</span></span>]) ; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $entryPointId; } }</code> </pre><br><br>  To register in a bundle, you need to add a line to the build method of the bundle class <br><br><pre> <code class="php hljs">$extension-&gt;addSecurityListenerFactory(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JiraFactory());</code> </pre><br><br><h4>  Final implementation </h4><br>  Everything, now we are ready to test work with Jira.  Add the created JiraUserProvider to security.yml in the providers section as strings <br><br><pre> <code class="python hljs"> jira_auth_provider: id: dg_jira_auth.user_provider</code> </pre><br><br>  Next, you need to add a new section to the firewalls, assuming that all pages whose addresses begin with / jira / are closed from unauthorized users by default: <br><br><pre> <code class="python hljs"> jira_secured: provider: jira_auth_provider switch_user: false context: user pattern: /jira/.* jira_form: check_path: dg_jira_auth_check_path login_path: dg_jira_auth_login_path default_target_path: dg_jira_auth_private logout: path: dg_jira_auth_logout target: dg_jira_auth_public anonymous: true</code> </pre><br><br>  The final touch is adding lines to the access_controls section, defining the user roles needed to view the pages.  An approximate view of the lines may be <br><br><pre> <code class="python hljs">- { path: ^/jira/public, role: IS_AUTHENTICATED_ANONYMOUSLY } - { path: ^/jira/private/login$, role: IS_AUTHENTICATED_ANONYMOUSLY } - { path: ^/jira/private(.*)$, role: ROLE_USER }</code> </pre><br><br><h4>  PS </h4><br>  All the code given in the article can be installed as a bundle from the ‚Äúdg / jira-auth-bundle‚Äù package in the composer or with <a href="https://github.com/GrizliK1988/symfony2-jira">github</a> .  To work the bundle, you need to register it in AppKernel.php and add a section <br><br><pre> <code class="python hljs">_jira_auth: resource: <span class="hljs-string"><span class="hljs-string">"@DGJiraAuthBundle/Resources/config/routing.yml"</span></span> prefix: /jira/</code> </pre><br><br>  in routing.yml.  After that, you can go to the / jira / public page and test authorization via Jira. <br><br><h4>  To secure the material </h4><br>  In Symfony Cookbook, there is also an <a href="http://symfony.com/doc/current/cookbook/security/custom_authentication_provider.html">instruction</a> on how to implement authentication through a third-party web service. <br><br>  <b>I hope the article will be useful to you!</b> </div><p>Source: <a href="https://habr.com/ru/post/206888/">https://habr.com/ru/post/206888/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../206870/index.html">Knowledge of language and Yandex. Why do we have cases? Lecture of a small school of data analysis</a></li>
<li><a href="../206876/index.html">Asterisk 12 released</a></li>
<li><a href="../206880/index.html">TV on the Internet</a></li>
<li><a href="../206884/index.html">Alpha Mio - wrist heart rate monitor without chest strap</a></li>
<li><a href="../206886/index.html">Dozen design jambs</a></li>
<li><a href="../206892/index.html">Introduction to parallel computing in R</a></li>
<li><a href="../206894/index.html">Tree list on ASP.NET MVC 4</a></li>
<li><a href="../206896/index.html">All that merge: ribosomal software architecture</a></li>
<li><a href="../206898/index.html">Backing up web projects on Yandex.Disk without OOP and models</a></li>
<li><a href="../206900/index.html">Is Telegram Safe? Or as I was looking for a bookmark in MTProto</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>