<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fix bugs in 1988 style</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I grew up in the 80s, in the decade, when home computers turned from a curiosity to a mainstream. In my elementary school there were several home comp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fix bugs in 1988 style</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/92a/d27/632/92ad2763262c4a6488418852727015b0.png"><br><br>  I grew up in the 80s, in the decade, when home computers turned from a curiosity to a mainstream.  In my elementary school there were several home computers Phillips P2000T and a pair of Apple Macintosh.  My friend had a Commodore 64, in which we played games, and once my father bought Commodore 128 for managing finances. close approach "did not break - do not fix it.") <br><br>  Almost immediately after the C128, we bought the C64.  C128 used for business, and C64 - for entertainment.  I clearly remember playing Space Taxi, Super Cycle, Velocipede, Last Ninja II, Electrix and other games.  In addition, on this computer, I began to learn programming. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Before the invention of the World Wide Web, there was still a couple of years, so the study of programming basically consisted in reading books and magazines.  Computer magazines often published source code listings that the reader needed to reprint.  The result could be any: a game, a utility for copying a disk, a drawing program for GEOS or, more often than we would like, something that works somehow due to <i>typos</i> .  At some point, the journals began to publish listings with a checksum next to each line.  They had special programs that checked the checksum of each input string.  Such programs helped a lot.  But still it was one of the slowest and error-prone ways to copy computer programs in the history of computers.  Nevertheless, the process was quite interesting (at least, it seemed to me so). <br><a name="habracut"></a><br>  One of these magazines was <i>Commodore Dossier</i> , a ‚Äúpractical magazine for active Commodore owners,‚Äù which was produced from 1984 to 1988.  In the seventeenth, which was the last, the release contained a listing of a rather interesting game.  It was called <i>Blindganger</i> , which in Dutch means ‚Äúsly‚Äù, but here the meaning of the word blind was also used. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0b2/f2f/baa/0b2f2fbaa57d63f86bb0ea063813f8d2.png" alt="image"><br>  <i>Cover of the seventeenth edition of Commodore Dossier</i> <br><br>  After a <i>well-</i> spent night, the blind hero of the game wakes up and discovers that he somehow fell into the city sewer.  The player's task is to bring him back to the street, using only the sounds made by his cane. <br><br>  City sewer services, overly concerned about the cleanliness of pipes, drain water every five <i>minutes</i> .  At each discharge, our blind hero throws another sewer, from where he must begin his search for a way out again.  After the third drain the game ends.  The player can see the sewage map showing the location of the exit and the location he visited. <br><br>  Around the autumn of 1988, having entered into the computer listing, I started the game.  It had a sprite animation of a bat flying on a completely black screen in front of a full moon, which seemed to me great.  However, I could not figure out how to manage.  The sewer map certainly helped, but there was something wrong with it.  Locations marked on the map as visited did not resemble the path I traveled.  Moreover, even walls were often visited by visitors. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/845/e63/822/845e638224fec9d2fc1d84d0177152ff.png" alt="image"><br>  <i>Sample sewer map from the original game</i> <br><br>  After a couple of attempts, I gave up and did something else, but the problem of the map and unintelligible management was remembered to me.  So when I came across a scan of this <i>Commodore Dossier</i> release, I realized that it was time to deal with it once and for all. <br><br>  Of course, before I started, I had <i>to</i> drive the whole listing <i>again</i> .  Then, in 1988, I did not have the checksum verification utility published in <i>Commodore Dossier</i> .  Maybe the sewer map was confused because of my carelessness and typos? <br><br>  A quick search in Google brought me to the disk image with the program "CHECKSUM DOSSIER".  It sounds promising!  To check, I launched the program and printed a short line from the listing of <i>Blindganger</i> : ‚Äú240 RETURN‚Äù, next to which was the checksum ‚Äú7E‚Äù.  Then I tried to insert a <i>typo</i> in the string itself, and in the checksum.  In both cases, the message ‚ÄúFOUT IN REGEL‚Äù, that is, ‚ÄúERROR IN THE LINE‚Äù, was displayed on the screen.  Fine! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5ad/666/222/5ad6662220a1cf8bbd049ee5646ec795.png" alt="image"><br>  <i>Isn't that cute?</i> <br><br>  With this program, I entered the entire listing.  Some lines of the scanned journal were poorly read, so the utility turned out to be irreplaceable.  Often I had to select different variants of combinations of strings and checksums, until they matched.  Well, so far everything is going well.  Now I had a copy of the original, in which there were definitely no typos.  Of course, in this copy should not be those bugs that arose in me in 1988.  But ... <i>they were</i> ! <br><br>  To find out the reason, I needed to find a code showing a map of the sewer on the screen.  The card is shown at the end of the game, that is, when the player finds a way out or after the third water drain.  I focused on the second case and started searching in the listing on BASIC for the numbers 0 or 3. <br><br>  In line 1780, the variable <i>MAAL</i> was found, which was compared to zero.  This variable was initialized with a value of 3 in line 1550 and decreased with each drain. <br><br><pre><code class="hljs ruby"><span class="hljs-number"><span class="hljs-number">1780</span></span> MAAL=MAAL-<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">:IFMAAL=</span></span>0THENGOTO181<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  The code block in lines 1810-1840 is executed if the <i>MAAL</i> is zero.  Line 1840 is an infinite loop.  Looking at the remaining three lines of BASIC, I realized that our next goal is a routine in machine code located at a memory address of 16540 ($ 409C). <br><br><pre> <code class="hljs vhdl"><span class="hljs-number"><span class="hljs-number">1810</span></span> POKECROSS+<span class="hljs-number"><span class="hljs-number">4096</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span> :<span class="hljs-keyword"><span class="hljs-keyword">REM</span></span> MARK <span class="hljs-keyword"><span class="hljs-keyword">EXIT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> THE <span class="hljs-keyword"><span class="hljs-keyword">MAP</span></span> <span class="hljs-number"><span class="hljs-number">1820</span></span> SYS16540 :<span class="hljs-keyword"><span class="hljs-keyword">REM</span></span> COPY <span class="hljs-keyword"><span class="hljs-keyword">MAP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> SCREEN <span class="hljs-number"><span class="hljs-number">1830</span></span> POKESID+<span class="hljs-number"><span class="hljs-number">11</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>:POKE53248+<span class="hljs-number"><span class="hljs-number">21</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">REM</span></span> STOP SOUND <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> DISABLE SPRITES <span class="hljs-number"><span class="hljs-number">1840</span></span> GOTO1840 :<span class="hljs-keyword"><span class="hljs-keyword">REM</span></span> ENDLESS <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span></code> </pre> <br>  This subprogram consists of two parts.  The first copies 1000 bytes from the memory area, starting at $ 6000, into screen memory ($ 0400- $ 07E7).  It fills the entire screen (40 columns for 25 lines = 1000 bytes) with a sewer map. <br><br>  As it turned out, there are no bugs in this part.  The map may <i>seem</i> strange until you notice that all the solid parts are walls, the horizontal sections of pipes are marked with "@", the vertical sections are marked with "A", the characters from "B" to "J" denote different types of angles and intersections The ‚ÄúK‚Äù is the pit, and the ‚ÄúL‚Äù is the exit.  These characters are not accidental.  They correspond to screen codes from 0 to 12. The map is just a dump to the screen of the internal map view in the game. <br><br>  The second part of the subroutine copies 1000 bytes from the memory area, starting at $ 7,000, into the color RAM ($ D800- $ DBE7).  So all visited locations are painted yellow. <br><br><pre> <code class="hljs mel">L40CB: LDA #$FF ; &gt;--  -- STA $FB ; | LDA #$6F ; | STA $FC ; | LDA #$F4 ; | STA $FD ; | LDA #$D7 ; | STA $FE ; &lt;-------------------- LDX #$04 ; &gt;--   ----------------- L40DD: LDY #$FA ; &gt;-- .  I --- | L40DF: LDA ($FB),Y ; ( ) | | STA ($FD),Y ; | | DEY ; | | BNE L40DF ; &lt;------------------- | LDY #$FA ; &gt;-- .  II ----------- | L40E8: INC $FB ; (  ) | | BNE L40EE ; | | INC $FC ; | | L40EE: INC $FD ; | | BNE L40F4 ; | | INC $FE ; | | L40F4: DEY ; | | BNE L40E8 ; &lt;---------------------------- | DEX ; | BNE L40DD ; &lt;-------------------------------</code> </pre> <br>  Bytes are copied in four blocks of 250 bytes.  The outer loop uses register X as a counter from 4 to 0. <br><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">LDX</span></span> <span class="hljs-comment"><span class="hljs-comment">#$04 ; ;   ; DEX BNE L40DD</span></span></code> </pre> <br>  The first inner loop uses the Y register as a counter from # $ FA (250) to 0. <br><br><pre> <code class="hljs mel">L40DD: LDY #$FA L40DF: LDA ($FB),Y STA ($FD),Y DEY BNE L40DF</code> </pre> <br>  Indirect indexing is used to copy bytes in the internal loop.  In this addressing mode, the Y register is used as the offset added to the 16-bit starting address stored in the <a href="https://www.c64-wiki.com/wiki/Zeropage">zero page</a> . <br><br>  For example, the <code>LDA ($FB),Y</code> command <code>LDA ($FB),Y</code> is executed as follows: <br><br><ul><li>  A 16-bit starting address <i>is</i> read <i>in direct byte order</i> , stored in the $ FB and $ FC sections of the zero page.  Direct byte ordering means that the least significant byte is stored in the lowest address ($ FB).  $ FB is initialized to # $ FF, and $ FC is initialized to # $ 6F, so the 16-bit starting address will be $ 6FFF. </li><li>  To calculate the real address, the value of the register Y is added to the starting address. The register Y is initialized at the beginning of the cycle in # $ FA.  Adding to $ 6FFF, we get a valid address of $ 70F9. </li><li>  The drive (register A) is loaded bytes from a valid address. </li></ul><br>  The Y register counts down from 250 to 0. Note that the minimum Y value used as an index is 1. (When the DEY command reduces Y to zero, the next branch command BNE passes by and exits the internal loop.) <br><br>  The first downloadable byte is located at $ 7000.  Since the minimum value of Y is 1, the starting address of the <i>source</i> must be initialized to $ 7000 - 1 = $ 6FFF.  Similarly, the first byte to be stored is located at $ D800, so the <i>target</i> start address must be initialized to $ D800 - 1 = $ D7FF.  Instead, it is initialized to $ D7F4! <br><br>  Random typing and typing # $ F4 instead of # $ FF is unlikely.  But in decimal notation, this corresponds to entering 244 instead of 255. It seems that the author of the game accidentally clicked on 4 instead of 5 when entering the constant 255!  This shifted the colors used in the map by 11 positions relative to the map itself.  In turn, this means that the locations visited were incorrectly marked on the map. <br><br>  The fault byte is in the data set statement in line 3670 of the BASIC listing: <br><br><pre> <code class="hljs">3670 DATA 252,169,244,133,253</code> </pre> <br>  After replacing it with the correct value (255), the sewer map starts to be displayed correctly.  And that means ... that we fixed a mistake 29 years ago! <br><br>  To celebrate this, I compiled a version of the original game of 2017 with this fix, as well as corrections of some other errors found while studying the code: <br><br><ul><li>  Visited locations are now correctly displayed on the map shown at the end of the game. </li><li>  When calculating the remaining time, the penalty for falling into the pit is taken into account. </li><li>  The volume of noise from the streets is changed in such a way that now depends on the distance to the exit (as the game authors intended). </li><li>  Translation into English.  (Press and hold the H key to view help.) </li></ul><br>  Blindganger 2017 is also available in BASIC listing form, <i>including checksums</i> .  To feel yourself in the 80s, download and run the Commodore Dossier checksum utility (see link below), and then start typing! <br><br>  Later, I also made improvements to the (already correct) sewer map to make it easier to read (see example below). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/557/01b/a37/55701ba37ec111bb77f4ae00cdfb6ed1.png"><br>  <i>Cross marked the exit!</i> <br><br><h4>  Links </h4><br><ul><li>  <a href="https://docs.google.com/uc%3Fexport%3Ddownload%26amp%3Bid%3D0Bxn3n-746lA8b0EtVG80RndCbUE">A copy of the pages</a> from Commodore Dossier, issue 17, 1988. </li><li>  The original version of Blindganger 1988 in the <a href="https://docs.google.com/uc%3Fexport%3Ddownload%26amp%3Bid%3D0Bxn3n-746lA8Q3UyTmJadi1fQUE">listing on BASIC</a> or <a href="https://docs.google.com/uc%3Fexport%3Ddownload%26amp%3Bid%3D0Bxn3n-746lA8M1hSZFJvMXliRU0">disk image D64</a> . </li><li>  The updated version of Blindganger 2017 as a <a href="https://docs.google.com/uc%3Fexport%3Ddownload%26amp%3Bid%3D0Bxn3n-746lA8WlR0MDZjaUtNZVE">listing on BASIC</a> or <a href="https://docs.google.com/uc%3Fexport%3Ddownload%26amp%3Bid%3D0Bxn3n-746lA8c0dfZ2ZIWE5ZbjA">a disk image D64</a> . </li><li>  Commodore Dossier checksum utility in the form <a href="https://docs.google.com/uc%3Fexport%3Ddownload%26amp%3Bid%3D0Bxn3n-746lA8clNHSjl5TENwczA">of a D64 disk image</a> . </li></ul></div><p>Source: <a href="https://habr.com/ru/post/332586/">https://habr.com/ru/post/332586/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../332574/index.html">AliveScript - a programming language for children 12+</a></li>
<li><a href="../332578/index.html">Vs interface</a></li>
<li><a href="../332580/index.html">Protecting your site with ZIP bombs</a></li>
<li><a href="../332582/index.html">Yet another tutorial: launch dotnet core docker application on Linux</a></li>
<li><a href="../332584/index.html">Making an image recognition service using TensorFlow Serving</a></li>
<li><a href="../332588/index.html">How to create your own metro</a></li>
<li><a href="../332594/index.html">Let's Encrypt will start issuing wildcard certificates in January 2018</a></li>
<li><a href="../332596/index.html">We remove and deposit cash at an ATM using a smartphone. World's first</a></li>
<li><a href="../332598/index.html">What I learned by converting a project to Kotlin using Android Studio</a></li>
<li><a href="../332600/index.html">Tuning typical roles of Windows. Part One: Files and Printing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>