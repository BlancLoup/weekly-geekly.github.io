<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Juniper tincture: Prepare Juniper SRX. Part 3: Virtual Routers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="juniper - juniper (eng.) 

 We continue to prepare the tincture of juniper. About how we started, you can read here and here . Today, we‚Äôll touch a ha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Juniper tincture: Prepare Juniper SRX. Part 3: Virtual Routers</h1><div class="post__text post__text-html js-mediator-article">  <em>juniper - juniper (eng.)</em> <br><br>  We continue to prepare the tincture of juniper.  About how we started, you can read <a href="http://habrahabr.ru/company/billing/blog/227317/">here</a> and <a href="http://habrahabr.ru/company/billing/blog/230267/">here</a> .  Today, we‚Äôll touch a handy thing like Virtual Routers and think about how to use it with the greatest benefit. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/710/918/ede/710918edef5b1631e7fd0dd60ed974d7.jpg" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Content: <br><br>  <a href="http://habrahabr.ru/company/billing/blog/227317/">Part 1: Introduction</a> <br>  <a href="http://habrahabr.ru/company/billing/blog/230267/">Part 2: IPSec</a> <br>  Part 3: Virtual Routers <br><br>  Juniper has a type of entity, Routing Instance, designed to manipulate traffic (routing and encapsulation).  RIs allow you to ‚Äúsplit‚Äù one router into several smaller ones, with each instance processing traffic ‚Äúin its own way,‚Äù independently of the others and with different capabilities.  This is useful for organizing all sorts of VPNs when you need to isolate several clients from each other and resolve them according to different rules.  At the same time, you can exchange VPN information with other routers (for example, when organizing an MPLS VPN). <br><a name="habracut"></a><br><h2>  Routing Instances Types </h2><br>  * <i>Forwarding</i> - Used to build special filter-based forwarding applications (or policy-based routing in Cisco terminology).  In this case, the interfaces are not tied to the RI, but remain in the default RI. <br>  * <i>Layer 2 virtual private network (VPN)</i> - Used to organize MPLS L2VPN. <br>  * <i>Nonforwarding</i> - All routes and interfaces are placed in the main routing instance, but it is possible to "divide" the main routing table into several smaller ones. <br>  * <i>VPN routing and forwarding (VRF)</i> - Used to organize L3VPN.  It contains not only the routing table (routing table), but also the switching table (forwarding table).  At the same time, traffic from the interface is displayed in the RI one-to-one, which allows you to send routing labels and receive them, receiving a distributed VPN.  Using dynamic routing protocols (BGP, OSPF or ISIS), you can organize the exchange of information between PE (provider edge) and CE (client edge) in such a way that each of them will receive (and send) routes only within its own VPN. <br>  * <i>Virtual router</i> - Similar to VRF, but does not have options such as VRF import, VRF export, VRF target, or route distinguisher.  Accordingly, it is not suitable for creating L3VPN, since  A separate routing table "lives" only within one router.  Due to simplicity, it is used much more often than its ‚Äúbig brother‚Äù. <br>  * <i>Virtual private LAN service (VPLS)</i> - An entity for organizing multipoint distributed L2VPN over MPLS.  To the client it will look like a virtual switch, to the ports of which its border (CE) devices are connected. <br><br>  At once we will not look at all this magnificence, and we will be engaged only in VR.  What is it all about?  From the description it is clear that this is a slightly simplified version of VRF, in fact - VRF-lite from the world of Cisco.  Supported logical tunnels and rib-groups for the exchange of routes and VR communication between them.  Of course, the routing protocols (ospf, bgp, isis) are configured separately for each VR.  Each VR requires its own Security zone (interfaces from different VR cannot be placed in the zone). <br><br>  Why is all this necessary?  Exactly then, why VRFs are usually done - isolating networks (clients) from each other and simplifying routing.  For example, it is possible to divide the routing of branches, IPSec tunnels to customers and the routing of service devices and the traffic of the router itself (default routing table).  With a bonus (weighty!), We get convenience in compiling routing table, security policies, and also get rid of the swelling of the ospf database. <br><br><h2>  We briefly describe the contents of VR </h2><br>  - routing table; <br>  - interfaces; <br>  - routing protocol settings (for example, OSPF, ISIS, BGP); <br>  - routing-options settings (for example static) <br><br><h2>  VR restrictions </h2><br>  - Dynamic VPN or remote access VPN inside VR <br>  - Public key infrastructure (PKI) inside VR <br>  - Chassis cluster active / active with VPN inside VR <br>  As you can see, the restrictions either relate to very exotic configurations (for example, PKI), or things that in our case are not supported by hardware (working in active / active is possible only in older versions of the SRX, intended for data centers).  The restriction on Dynamic VPN is, of course, offensive (there is such a plan), but you can survive it. <br><br><h2>  And what do we do with these VR? </h2><br>  We turn to the most interesting: to practice.  Let's see how this is all configured and what happens in the end. <br><br><h3>  GRE </h3><br>  There are two possible scenarios: when gre himself is located in VR: <br><br><pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces gr-0/0/0 unit 1 description cs3925-1-smr--tun13 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces gr-0/0/0 unit 1 point-to-point <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces gr-0/0/0 unit 1 tunnel <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> 192.168.0.13 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces gr-0/0/0 unit 1 tunnel destination 192.168.0.21 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces gr-0/0/0 unit 1 tunnel routing-instance destination BRANCH_VR <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces gr-0/0/0 unit 1 family inet mtu 1448 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces gr-0/0/0 unit 1 family inet address 192.168.77.12/31</code> </pre> <br><br>  Or when in VR there are only interfaces on top of which a GRE tunnel is built: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces gr-0/0/0 unit 8 description cs3925-1-smr--tun15 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces gr-0/0/0 unit 8 point-to-point <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces gr-0/0/0 unit 8 tunnel <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> 1.2.3.4 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces gr-0/0/0 unit 8 tunnel destination 2.3.4.2 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces gr-0/0/0 unit 8 family inet mtu 1446 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> interfaces gr-0/0/0 unit 8 family inet address 192.168.77.26/31 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> routing-instances BRANCH_VR routing-options static route 2.3.4.2/32 next-table inet.0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> routing-instances BRANCH_VR routing-options static route 192.168.0.21/32 next-hop 192.168.0.14</code> </pre><br><h3>  Ipsec </h3><br>  The setting is no different from the <a href="http://nixman.info/%3Fp%3D2356">usual</a> .  The main thing is to correctly identify the external interface, which can also be in another VR.  After that, add st0 to the desired VR, configure routing and policy.  In our case, 10.6.6.0/24 is the network behind our partner's ipsec gateway. <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> routing-instances VR1 <span class="hljs-keyword"><span class="hljs-keyword">instance</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>-router <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> routing-instances VR1 <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> routing-instances VR1 <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> st0<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> routing-instances VR1 routing-options <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> route <span class="hljs-number"><span class="hljs-number">10.6</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span>-hop st0<span class="hljs-number"><span class="hljs-number">.0</span></span></code> </pre><br><h3>  NAT </h3><br>  There is also no additional configuration required, the main thing, as is the case with IPSec, is to correctly configure routing and permissive policies. <br><br><h3>  Routing </h3><br>  With routing inside VR, everything is quite simple: protocol (routing-options in the case of static routing) are specified directly in the VR settings.  It's more interesting when we need to exchange routes between VRs.  Here we come to the rescue: <br><br>  <strong>a.</strong>  <strong>Static routing</strong> <br>  It works only in one direction (you cannot set up "counter" routes between VR). <br><br><pre> <code class="bash hljs">admin@jpsrx550<span class="hljs-comment"><span class="hljs-comment"># show routing-instances SAMPLE_VR routing-options static route abcd/32 next-table inet.0;</span></span></code> </pre><br>  Here we indicate to VR that the abcd address should be searched in the default routing table (inet.0). <br><br>  <strong>b.</strong>  <strong>rib-groups</strong> <br>  Allows you to import routing tables from one VR to another.  And not completely, but those parts that are needed.  For example, static routes, interface routes (direct connected networks), or routes from a dynamic routing protocol. <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">set</span></span> routing-options rib-groups IPSEC_to_default_RIB import-rib IPSEC_VR.inet.0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> routing-options rib-groups IPSEC_to_default_RIB import-rib inet.0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> routing-instances IPSEC_VR routing-options static rib-group IPSEC_to_default_RIB <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> routing-options rib-groups default_to_IPSEC_RIB import-rib inet.0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> routing-options rib-groups default_to_IPSEC_RIB import-rib IPSEC_VR.inet.0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> protocols ospf rib-group default_to_IPSEC_RIB</code> </pre><br>  At the same time, you can configure "counter" routing between VR (different rib-groups), or, for example, make a static route in one direction and a rib-group in the opposite direction.  Routes imported in this way are perceived as ‚Äúnative‚Äù by VR, i.e.  they can be, for example, exported to OSPF / BGP. <br><br>  <strong>c.</strong>  <strong>logical-tunnels</strong> <br>  The option is transparent in implementation and convenient in some cases (for example, when it is necessary to exchange BGP tables between different VRs).  Virtual interfaces are created, in appearance - just like the real ones.  They can be added to the security zone, routing instances, policies can be applied to them, addresses can be hung, etc.  But the traffic does not come out of the router. <br><br>  The setup is pretty simple.  Note that when configuring lt, the id of the neighbor is specified.  Those.  tunnels may be more than two (which is logical). <br><br><div class="spoiler">  <b class="spoiler_title">Long piece of config</b> <div class="spoiler_text"><pre> <code class="bash hljs">interfaces { lt-0/0/0 { unit 1 { encapsulation ethernet; peer-unit 2; family inet { address 10.20.30.1/30; } } unit 2 { encapsulation ethernet; peer-unit 1; family inet { address 10.20.30.2/30; } } } policy-options { policy-statement p1 { from { instance R1; protocol direct; } <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> accept; } policy-statement p2 { from { instance R2; protocol direct; } <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> accept; } } security { zones { security-zone Z1 { host-inbound-traffic { system-services { all; } protocols { all; } } interfaces { ge-0/0/1.0; lt-0/0/0.1; } } security-zone Z2 { host-inbound-traffic { system-services { all; } protocols { all; } } interfaces { ge-0/0/2.0; lt-0/0/0.2; } } } policies { from-zone Z1 to-zone Z1 { policy Z1-Z1 { match { <span class="hljs-built_in"><span class="hljs-built_in">source</span></span>-address any; destination-address any; application any; } <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> { permit; } } } from-zone Z2 to-zone Z2 { policy Z2-Z2 { match { <span class="hljs-built_in"><span class="hljs-built_in">source</span></span>-address any; destination-address any; application any; } <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> { permit; } } } } flow { traceoptions { file lt-testing; flag basic-datapath; packet-filter 1 { <span class="hljs-built_in"><span class="hljs-built_in">source</span></span>-prefix 192.168.1.2/32; destination-prefix 192.168.2.2/32; } } } } routing-instances { R1 { instance-type virtual-router; interface lt-0/0/0.1; interface ge-0/0/1.0; protocols { ospf { traceoptions { file R1; flag all; } <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> p1; area 0.0.0.0 { interface lt-0/0/0.1; } } } } R2 { instance-type virtual-router; interface lt-0/0/0.2; interface ge-0/0/2.0; protocols { ospf { <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> p2; area 0.0.0.0 { interface lt-0/0/0.2; } } } } }</code> </pre><br></div></div><br>  From the minuses - you need to create interfaces, add them to the VR, security-zone, take into account when setting up dynamic routing, etc. <br><br>  That's all.  I will be glad to answer questions and comments in the comments. <br><br>  Links (some of them may be available only if there is a service contract): <br>  <a href="http://www.juniper.net/techpubs/en_US/junos11.4/information-products/topic-collections/config-guide-routing/config-guide-routing.pdf">Junos OS Routing Protocols Configuration Guide PDF Document</a> <br>  <a href="http://www.juniper.net/techpubs/en_US/junos12.1/information-products/topic-collections/security/software-all/security/junos-security-swconfig-security.pdf">Junos OS Security Configuration Guide PDF Document</a> <br>  <a href="http://www.juniper.net/techpubs/en_US/junos11.4/information-products/topic-collections/security/software-all/mpls/junos-security-swconfig-mpls.pdf">Junos OS MPLS Configuration Guide for Security Devices PDF Document</a> <br>  <a href="http://www.juniper.net/techpubs/en_US/junos12.1/topics/example/virtual-router-configuring-st0-interface-example.html">Example: Configuring an st0 Interface in a Virtual Router</a> <br>  <a href="http://kb.juniper.net/InfoCenter/index%3Fpage%3Dcontent%26id%3DKB23912">[SRX] Static NAT using Virtual-Routing Instance</a> <br>  <a href="http://kb.juniper.net/InfoCenter/index%3Fpage%3Dcontent%26id%3DKB24592">[SRX] Configuration of the GRE tunnel in a routing-instance</a> <br>  <a href="http://kb.juniper.net/InfoCenter/index%3Fpage%3Dcontent%26id%3DKB27819">[SRX] Configuration Example: Destination NAT</a> <br>  <a href="http://kb.juniper.net/InfoCenter/index%3Fpage%3Dcontent%26id%3DKB19787">[SRX, J Series] Example - Importing Routes on the SRX and J Series</a> <br>  <a href="http://kb.juniper.net/InfoCenter/index%3Fpage%3Dcontent%26id%3DKB21260">Understanding Logical Tunnel Interface (lt-0/0/0) on SRX branch series platforms</a> <br><br>  KDPV taken <i><a href="http://posadisam.ru/948-mozhzhevelnik.html">from here</a></i> </div><p>Source: <a href="https://habr.com/ru/post/253315/">https://habr.com/ru/post/253315/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253305/index.html">Online translation of the opening of the Microsoft Developer Tour technology expedition</a></li>
<li><a href="../253307/index.html">First look at VMware 6</a></li>
<li><a href="../253309/index.html">JavaScript and Reverse Engineering Contact Points</a></li>
<li><a href="../253311/index.html">‚ÄúHackers and artists‚Äù, ‚ÄúOn Lisp‚Äù and essay in Russian. Learning to write like Paul Graham</a></li>
<li><a href="../253313/index.html">Optimum continuous archive sorting</a></li>
<li><a href="../253317/index.html">RabbitMQ tutorials in C ++</a></li>
<li><a href="../253319/index.html">Introduction to what3words API: Basic Procedures and Samples</a></li>
<li><a href="../253321/index.html">We write ARP Spoofer for Android. Development of Root tools for Android</a></li>
<li><a href="../253323/index.html">Creating a custom matcher for unit testing in Jasmine 2.0</a></li>
<li><a href="../253327/index.html">Google will increase the security of its Android app store</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>