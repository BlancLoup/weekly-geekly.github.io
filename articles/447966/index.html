<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to connect GitLab and Pantheon and optimize Drupal and WordPress workflows</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Our guest, creator of Pantheon developer tools, tells how to automate WordPress deployments using GitLab CI / CD. 


 In Pantheon, I‚Äôm involved in dev...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to connect GitLab and Pantheon and optimize Drupal and WordPress workflows</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/ja/h2/ef/jah2efouevm2la2v9vkt3vuojm8.png"></p><br><p>  Our guest, creator of Pantheon developer tools, tells how to automate WordPress deployments using GitLab CI / CD. </p><br><p>  In <a href="https://pantheon.io/">Pantheon,</a> I‚Äôm involved in developer relations, so I‚Äôm always looking for new ways to help WordPress and Drupal developers solve automation problems in their workflows.  For this, I like to experiment with new tools and combine them with each other to work effectively. </p><br><p>  <strong>I often see developers suffering with a single development server.</strong> </p><br><p>  So it‚Äôs a pleasure to wait for your turn to use the server or to send a URL to your customers with the note: ‚ÄúLook here and not look here.‚Äù </p><br><p>  <a href="https://pantheon.io/docs/multidev/">The multidev environments</a> - one of the coolest Pantheon tools - solve this problem, because with them you can create Git environments on demand.  Each multidev environment has its own URL and database, so developers work calmly, check quality and get approval without stepping on each other‚Äôs heels. </p><br><p>  But in Pantheon there are no tools for version control or continuous integration and deployment (CI / CD).  But this is a flexible platform from which you can integrate any tools. </p><br><p>  <strong>I also noticed that for the development team use some tools, and for assembly and deployment - others.</strong> </p><br><p>  For example, they have different tools for version control and CI / CD.  You have to mess around and switch between tools to edit the code and diagnose problems. </p><a name="habracut"></a><br><p>  <a href="https://about.gitlab.com/">GitLab</a> has a complete set of development tools: for version control, tickets, merge requests, best-in-class pipeline CI / CD, container registry and stuff like that.  I have not come across any applications in which there would be so much to manage the development workflow. </p><br><p>  I love automation, so I learned how to connect Pantheon to GitLab so that commits to the main branch on GitLab are deployed to the main development environment in Pantheon.  And merge requests for GitLab can create and deploy code in multidev environments in Pantheon. </p><br><p>  In this tutorial, I‚Äôll show you how to set up a connection between GitLab and Pantheon and optimize WordPress and Drupal workflows. </p><br><p>  You can, of course, <a href="https://docs.gitlab.com/ee/workflow/repository_mirroring.html">mirror the GitLab repository</a> , but we will all be doing pens to <a href="https://docs.gitlab.com/ee/ci/">delve</a> into <a href="https://docs.gitlab.com/ee/ci/">GitLab CI</a> and in the future use this tool not only for deployment. </p><br><h3 id="vvedenie">  Introduction </h3><br><p>  For this post you need to understand that Pantheon breaks each site into three elements: code, database and files. </p><br><p>  The code includes CMS files, such as the core, plugins, and WordPress themes.  These files are managed in <a href="https://git-scm.com/book/en/v2/Git-Basics-Getting-a-Git-Repository">the Git repository</a> hosted by Pantheon, that is, we can deploy the code from GitLab to Pantheon from Git. <br>  The files in Pantheon are media files, that is, pictures for the site.  Usually they are loaded by users, and Git ignores them. </p><br><p>  <a href="https://pantheon.io/register">Create a free account</a> , learn more about <a href="https://pantheon.io/docs/pantheon-workflow">the Pantheon workflow,</a> or <a href="https://pantheon.io/live-demo">sign up</a> for the pantheon.io <a href="https://pantheon.io/live-demo">demo</a> . </p><br><h3 id="predpolozheniya">  Assumptions </h3><br><p> My project on Pantheon and GitLab is called <code>pantheon-gitlab-blog-demo</code> .  The project name must be unique.  Here we will work with the WordPress site.  You can take and Drupal, but will need to change something. </p><br><p>  I will use the <a href="https://git-scm.com/book/en/v2/Getting-Started-The-Command-Line">Git command line</a> , and you can work in the <a href="https://git-scm.com/book/en/v2/Appendix-A%253A-Git-in-Other-Environments-Graphical-Interfaces">GUI</a> if you want. </p><br><h3 id="sozdaem-proekt">  Create a project </h3><br><p>  To begin, create a <a href="https://docs.gitlab.com/ee/gitlab-basics/create-project.html">project GitLab</a> (to this we will come back). </p><br><p>  Now <a href="https://pantheon.io/docs/launch-wordpress/">create a WordPress site on Pantheon</a> .  Then install WordPress for the dashboard site. </p><br><blockquote>  If your hands itch to change something, for example, plug-ins to remove and add, be patient.  The site is not yet connected to GitLab, and we want all code changes to go through GitLab. </blockquote><p>  When we install WordPress, we return to the Pantheon site dashboard and change the development mode to Git. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/up/zf/50/upzf50ocuma107rer9uxiybvjnc.png"></a> </p><br><h3 id="nachalnyy-kommit-na-gitlab">  Initial commit on GitLab </h3><br><p>  Now you need to transfer the initial WordPress code from Pantheon to GitLab.  To do this, we clone the code from the Git repository of the Pantheon site locally, and then send it to the GitLab repository. </p><br><p>  To make it easier and safer, <a href="https://pantheon.io/docs/ssh-keys/">we will add an SSH key to Pantheon</a> and will not enter the password every time we clone the Pantheon Git repository.  At the same time <a href="https://docs.gitlab.com/ee/ssh/README.html">we</a> will <a href="https://docs.gitlab.com/ee/ssh/README.html">add an SSH key to GitLab</a> . </p><br><p>  To do this, we clone the Pantheon site locally by copying the command from the Clone with Git field on the site's dashboard. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/em/qz/ga/emqzgamloafdlzbj3xp0ssrt2o0.png"></a> <br>  <em>If you need help, read the <a href="https://pantheon.io/docs/git/">Git Getting Started</a> documentation <a href="https://pantheon.io/docs/git/">for Pantheon</a> .</em> </p><br><p>  Now we‚Äôll change <code>git remote origin</code> to point to GitLab instead of Pantheon.  This can be done <a href="https://git-scm.com/docs/git-remote"><code> git remote</code></a> . </p><br><p>  Let's go to the GitLab project and copy the repository URL from the Clone drop-down list on the project details page.  Choose the option Clone with SSH, because we have already configured an SSH-key. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/6m/4o/ea/6m4oeailmhmcggywg27uptq7aio.png"></a> </p><br><p>  By default, <code>git remote</code> for the local copy of the code repository is <code>origin</code> .  This can be changed with <code>git remote set-url origin [URL  GitLab]</code> , where instead of brackets we enter the actual URL. </p><br><p>  Finally, run <code>git push origin master --force</code> to send the WordPress code from Pantheon to GitLab. </p><br><blockquote>  The ‚Äìforce option is needed only once.  Then in the <code>git push</code> commands on GitLab it will not be. </blockquote><br><h3 id="nastraivaem-uchetnye-dannye-i-peremennye">  Configuring credentials and variables </h3><br><p>  Remember how we locally added an SSH key to log in to Pantheon and GitLab?  SSH token can be used to authorize GitLab and Pantheon. </p><br><p>  GitLab has excellent documentation.  Let's take a look at the <a href="https://docs.gitlab.com/ee/ci/ssh_keys/README.html">section on SSH keys when using the Docker executor in the document on using SSH keys with GitLab CI / CD</a> . </p><br><p>  Now we will perform the first two steps: <em>create a new pair of SSH keys locally with ssh-keygen and add the private key as a variable to the project</em> . </p><br><p>  Then we set <code>SSH_PRIVATE_KEY</code> as a <a href="https://docs.gitlab.com/ee/ci/variables/README.html">GitLab CI / CD environment variable</a> in the project parameters. <br>  In the third and fourth steps, create a <code>.gitlab-ci.yml</code> with the following contents: </p><br><pre> <code class="plaintext hljs">before_script: # See https://docs.gitlab.com/ee/ci/ssh_keys/README.html - eval $(ssh-agent -s) - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - &gt; /dev/null - mkdir -p $HOME/.ssh &amp;&amp; echo "StrictHostKeyChecking no" &gt;&gt; "$HOME/.ssh/config" - git config --global user.email "$GITLAB_USER_EMAIL" - git config --global user.name "Gitlab CI"</code> </pre> <br><p>  Until we commit the <code>.gitlab-ci.yml</code> , then we will need to add something else to it. </p><br><p>  Now we perform the fifth step and <em>add the public key, which was created in the first step, to the services to which you need access in the build environment</em> . </p><br><p>  In our case, we want to access Pantheon from GitLab.  Follow the instructions in the Pantheon document for <a href="https://pantheon.io/docs/ssh-keys/">adding an SSH key to Pantheon</a> and perform this step. </p><br><blockquote>  Remember: closed SSH - in GitLab, open - in Pantheon. </blockquote><p>  Set up some more environment variables.  The first is called PANTHEON_SITE.  Its meaning is the name of the site Pantheon on your car. </p><br><p>  The name on the machine is listed at the end of the Clone with Git command.  You have already cloned the site locally, so this will be the name of the local repository directory. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/rf/3p/gb/rf3pgbmo_2u0xsri8d1hq5f-xxw.png"></a> </p><br><p>  Next, set up the environment variable <code>PANTHEON_GIT_URL</code> .  This is the Git repository URL for the Pantheon site that we already used. </p><br><blockquote>  We enter only the URL of the SSH repository, without <code>git clone</code> and the name of the site on the machine at the end. </blockquote><p>  Fuh.  This is done, now we can finish our <code>.gitlab-ci.yml</code> . </p><br><h3 id="sozdaem-zadachu-deploya">  Create deployment task </h3><br><p>  What we initially do with GitLab CI is very similar to what we did with Git repositories before.  But this time we will add the Pantheon repository as the second remote source of Git, and then send the code from GitLab to Pantheon. </p><br><p>  To do this, set up <a href="https://docs.gitlab.com/ee/ci/yaml/">the</a> <code>deploy</code> <a href="https://docs.gitlab.com/ee/ci/yaml/">stage</a> and the <a href="https://docs.gitlab.com/ee/ci/yaml/">task</a> <code>deploy:dev</code> , because we will deploy to the development environment on Pantheon.  As a result, the <code>.gitlab-ci.yml</code> will look like this: </p><br><pre> <code class="plaintext hljs">stages: - deploy before_script: # See https://docs.gitlab.com/ee/ci/ssh_keys/README.html - eval $(ssh-agent -s) - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - &gt; /dev/null - mkdir -p $HOME/.ssh &amp;&amp; echo "StrictHostKeyChecking no" &gt;&gt; "$HOME/.ssh/config" - git config --global user.email "$GITLAB_USER_EMAIL" - git config --global user.name "Gitlab CI" deploy:dev: stage: deploy environment: name: dev url: https://dev-$PANTHEON_SITE.pantheonsite.io/ script: - git remote add pantheon $PANTHEON_GIT_URL - git push pantheon master --force only: - master</code> </pre> <br><p>  The variables <code>SSH_PRIVATE_KEY, PANTHEON_SITE</code> and <code>PANTHEON_GIT_URL</code> should look familiar - we set up these environment variables before.  With these variables, we will be able to use the values ‚Äã‚Äãin the <code>.gitlab-ci.yml</code> many times and only need to be updated in one place. </p><br><p>  Finally, add, commit and send the <code>.gitlab-ci.yml</code> to GitLab. </p><br><h3 id="proveryaem-deploy">  Check warm </h3><br><p>  If we did everything right, the task <code>deploy:dev</code> succeed in GitLab CI / CD and send the <code>.gitlab-ci.yml</code> to Pantheon.  Let's get a look. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ex/pu/to/exputo8aihdn0sxv1aavrpa-rg4.png"></a> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/2w/4_/zs/2w4_zszf0r6dxu8jvgo-ogfzzqi.png"></a> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/6z/tk/ir/6ztkirsm-22bbcegra12_lyx3zg.png"></a> </p><br><h3 id="otpravlyaem-vetki-merzh-rekvestov-v-pantheon">  Send Merge Requests to Pantheon </h3><br><p>  Here we will use my favorite Pantheon feature - <a href="https://pantheon.io/docs/multidev">multidev</a> , where you can create additional Pantheon environments for Git branches on demand. </p><br><p>  <a href="https://pantheon.io/docs/multidev-faq/">Access to multidev is limited</a> , so this section may not be performed.  But if you have access, you can seriously increase your productivity by setting up automatic creation of multidev environments on Pantheon from GitLab requests. </p><br><p>  First, make a new Git branch locally using <code>git checkout -b multidev-support</code> .  Now again, let's change something in <code>.gitlab-ci.yml</code> . </p><br><p>  I like to indicate the number of the merge-request in the name of the Pantheon environment.  For example, the first merge requester is <code>mr-1</code> , the second is <code>mr-2</code> and so on. </p><br><p>  The merge request changes, so we need to dynamically determine the names of the Pantheon branches.  On GitLab, this is easy - you need to use <a href="https://docs.gitlab.com/ee/ci/variables/README.html">predefined environment variables</a> . </p><br><p>  We can take <code>$CI_MERGE_REQUEST_IID</code> to indicate the number of the merge-request.  Let's apply all this together with the global environment variables that we specified earlier, and add a new deploy task: multidev at the end of the <code>.gitlab-ci.yml</code> . </p><br><pre> <code class="plaintext hljs">deploy:multidev: stage: deploy environment: name: multidev/mr-$CI_MERGE_REQUEST_IID url: https://mr-$CI_MERGE_REQUEST_IID-$PANTHEON_SITE.pantheonsite.io/ script: # Checkout the merge request source branch - git checkout $CI_COMMIT_REF_NAME # Add the Pantheon git repository as an additional remote - git remote add pantheon $PANTHEON_GIT_URL # Push the merge request source branch to Pantheon - git push pantheon $CI_COMMIT_REF_NAME:mr-$CI_MERGE_REQUEST_IID --force only: - merge_requests</code> </pre> <br><p>  It will be similar to our <code>deploy:dev</code> task, only the branch goes to Pantheon, not to <code>master</code> . </p><br><p>  We have added and committed the updated <code>.gitlab-ci.yml</code> , and now we will send a new branch to GitLab with <code>git push -u origin multidev-support</code> . </p><br><p>  Now we will create a new merge-request from the <code>multidev-support</code> branch by clicking <em>Create merge request</em> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/bi/bv/gt/bibvgthkwykacqew-cswygjdmig.png"></a> </p><br><p>  Having created a merge request, we look at how the CI / CD <code>deploy:multidev</code> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ck/ev/lq/ckevlqnrfbfanoj0dlmjt26wxpw.png"></a> </p><br><p>  See - a new branch has been sent to Pantheon.  But if we move to the multidev section on the Pantheon site dashboard, we will not see a new environment there </p><br><p> <a href=""><img src="https://habrastorage.org/webt/yy/yy/bz/yyyybzmedtphnsj-6humcyu2hmu.png"></a> </p><br><p>  Look at the Git Branches section. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/hp/_o/bl/hp_obl6r7pv4ihuot7i6gx4rqwm.png"></a> </p><br><p>  As a result, our <code>mr-1</code> branch reached Pantheon.  Create an environment from the <code>mr-1</code> branch. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/2v/xg/ez/2vxgez9ugraihe2bdyn-5cxevjm.png"></a> </p><br><p>  We created a multidev environment, and now we‚Äôll go back to GitLab and take a look at <em>Operations&gt; Environments</em> .  We will see entries for <code>dev</code> and <code>mr-1</code> . </p><br><p>  This is because we have added an <code>environment</code> entry with the name <code>name</code> and <code>url</code> to the CI / CD tasks.  If you click the open environment icon, we will go to the multidev environment URL to Pantheon. </p><br><h3 id="avtomatiziruem-sozdanie-multidev">  Automating the creation of multidev </h3><br><p>  In principle, you can stop at this and simply remember to create a multidev environment for each merge-request, but this process can be automated. </p><br><p>  Pantheon has a <a href="https://pantheon.io/docs/terminus/">Terminus</a> command line tool where you can work with the platform automatically.  In Terminus, you can create multidev environments from the command line ‚Äî ideal for <a href="https://docs.gitlab.com/ee/ci/">GitLab CI</a> . </p><br><p>  We need a new merge request to test it.  Create a new branch using <code>git checkout -b auto-multidev-creation</code> . </p><br><p>  To use Terminus in GitLab CI / CD tasks, you need a machine token for authentication with Terminus and an image of a container with Terminus. </p><br><p>  <a href="https://pantheon.io/docs/machine-tokens/">Create a Pantheon machine token</a> , save it in a safe place, and add it as a global environment variable in GitLab called <code>PANTHEON_MACHINE_TOKEN</code> . </p><br><blockquote>  If you forgot how to add GitLab environment variables, go back to where we defined <code>PANTHEON_SITE</code> . </blockquote><br><h3 id="sozdaem-dockerfile-s-terminus">  Create a Dockerfile with Terminus </h3><br><p>  If you are not using Docker or do not like <code>Dockerfile</code> files, take my image to <code>registry.gitlab.com/ataylorme/pantheon-gitlab-blog-demo:latest</code> and skip this section. </p><br><p>  <a href="https://docs.gitlab.com/ee/user/project/container_registry.html">GitLab has a container registry</a> where you can build and place a Dockerfile for our project.  Let's create a Dockerfile file from Terminus to work with Pantheon. </p><br><p>  Terminus is a PHP command line tool, so let's start with a PHP image.  I install Terminus through Composer, so I will take the <a href="https://hub.docker.com/_/composer">official image of Docker Composer</a> as the basis.  Create a <code>Dockerfile</code> in the local repository directory with the following contents: </p><br><pre> <code class="plaintext hljs"># Use the official Composer image as a parent image FROM composer:1.8 # Update/upgrade apk RUN apk update RUN apk upgrade # Make the Terminus directory RUN mkdir -p /usr/local/share/terminus # Install Terminus 2.x with Composer RUN /usr/bin/env COMPOSER_BIN_DIR=/usr/local/bin composer -n --working-dir=/usr/local/share/terminus require pantheon-systems/terminus:"^2"</code> </pre> <br><p>  Follow the instructions for building and submitting images from the <em>Build and push images</em> section in the <a href="https://gitlab.com/help/user/project/container_registry">container registry documentation</a> to build an image from the <code>Dockerfile</code> and send it to GitLab. </p><br><p>  Open the <em>Registry</em> section in the GitLab project.  If everything went according to plan, there will be our image.  Write a link to the image tag - we need it for the <code>.gitlab-ci.yml</code> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/_x/ta/yn/_xtayn5xz10hq5kuv7abvqvskgq.png"></a> </p><br><p>  The <code>script</code> section in the <code>deploy:multidev</code> begins to grow, so let's move it to a separate file.  Create a new <code>private/multidev-deploy.sh:</code> </p><br><pre> <code class="plaintext hljs">#!/bin/bash # Store the mr- environment name export PANTHEON_ENV=mr-$CI_MERGE_REQUEST_IID # Authenticate with Terminus terminus auth:login --machine-token=$PANTHEON_MACHINE_TOKEN # Checkout the merge request source branch git checkout $CI_COMMIT_REF_NAME # Add the Pantheon Git repository as an additional remote git remote add pantheon $PANTHEON_GIT_URL # Push the merge request source branch to Pantheon git push pantheon $CI_COMMIT_REF_NAME:$PANTHEON_ENV --force # Create a function for determining if a multidev exists TERMINUS_DOES_MULTIDEV_EXIST() { # Stash a list of Pantheon multidev environments PANTHEON_MULTIDEV_LIST="$(terminus multidev:list ${PANTHEON_SITE} --format=list --field=id)" while read -r multiDev; do if [[ "${multiDev}" == "$1" ]] then return 0; fi done &lt;&lt;&lt; "$PANTHEON_MULTIDEV_LIST" return 1; } # If the mutltidev doesn't exist if ! TERMINUS_DOES_MULTIDEV_EXIST $PANTHEON_ENV then # Create it with Terminus echo "No multidev for $PANTHEON_ENV found, creating one..." terminus multidev:create $PANTHEON_SITE.dev $PANTHEON_ENV else echo "The multidev $PANTHEON_ENV already exists, skipping creating it..." fi</code> </pre> <br><p>  The script is in a private directory and <a href="https://pantheon.io/docs/private-paths/">does not provide web access to Pantheon</a> .  We have a script for our multidev logic.  Let's now update the <code>deploy:multidev</code> the <code>.gitlab-ci.yml</code> file to <code>.gitlab-ci.yml</code> this: </p><br><pre> <code class="plaintext hljs">deploy:multidev: stage: deploy environment: name: multidev/mr-$CI_MERGE_REQUEST_IID url: https://mr-$CI_MERGE_REQUEST_IID-$PANTHEON_SITE.pantheonsite.io/ script: # Run the multidev deploy script - "/bin/bash ./private/multidev-deploy.sh" only: - merge_requests</code> </pre> <br><p>  We need to make sure that our tasks are performed in the created custom image, so we add the <code>image</code> definition from the registry URL to <code>.gitlab-ci.yml</code> .  As a result, we have such a <code>.gitlab-ci.yml</code> : </p><br><pre> <code class="plaintext hljs">image: registry.gitlab.com/ataylorme/pantheon-gitlab-blog-demo:latest stages: - deploy before_script: # See https://docs.gitlab.com/ee/ci/ssh_keys/README.html - eval $(ssh-agent -s) - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - &gt; /dev/null - mkdir -p $HOME/.ssh &amp;&amp; echo "StrictHostKeyChecking no" &gt;&gt; "$HOME/.ssh/config" - git config --global user.email "$GITLAB_USER_EMAIL" - git config --global user.name "Gitlab CI" deploy:dev: stage: deploy environment: name: dev url: https://dev-$PANTHEON_SITE.pantheonsite.io/ script: - git remote add pantheon $PANTHEON_GIT_URL - git push pantheon master --force only: - master deploy:multidev: stage: deploy environment: name: multidev/mr-$CI_MERGE_REQUEST_IID url: https://mr-$CI_MERGE_REQUEST_IID-$PANTHEON_SITE.pantheonsite.io/ script: # Run the multidev deploy script - "/bin/bash ./private/multidev-deploy.sh" only: - merge_requests</code> </pre> <br><p>  Add, commit and send <code>private/multidev-deploy.sh</code> and <code>.gitlab-ci.yml</code> .  Now go back to GitLab and wait for the CI / CD task to complete.  Be patient: multidev can take several minutes. </p><br><p>  Then we go to watch the multidev list on Pantheon.  Oh miracle!  Wednesday multidev <code>mr-2</code> is here. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/gx/jf/ab/gxjfabnawlvvtncrg268q7nwkiw.png"></a> </p><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>  My team earned much more fun when we began to open merge-requests and create environments automatically. </p><br><p>  With the powerful tools GitLab and Pantheon, you can connect GitLab to Pantheon automatically. </p><br><p>  Once we use GitLab CI / CD, our workflow will grow.  Here are a couple of ideas to get started: </p><br><ul><li>  Add an assembly step. </li><li>  Add automated testing. </li><li>  Add a task to ensure adherence to code standards. </li><li>  Add <a href="https://docs.gitlab.com/ee/ci/examples/dast.html">dynamic application security testing</a> . </li></ul><br><p>  Write what you think about GitLab, Pantheon and automation. </p><br><p>  PS Did you know that Terminus, the Pantheon command line tool, <a href="https://pantheon.io/docs/terminus/plugins/">can be extended via plugins</a> ? </p><br><p>  We at Pantheon did a good job on version 2 of our <a href="https://github.com/pantheon-systems/terminus-build-tools-plugin/">plug-in for Terminus build tools</a> with GitLab support.  If you do not want to bother with the setting for each project, try this plugin and help us test the beta v2.  For the Terminus <code>build:project:create</code> command, you only need the Pantheon token and the GitLab token.  It will deploy one of the sample projects with Composer and automated testing, create a new project in GitLab, the new Pantheon site, and connect them with environment variables and SSH keys. </p><br><h3 id="ob-avtore">  about the author </h3><br><p>  Andrew Taylor creates tools for developers in <a href="https://pantheon.io/">Pantheon</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/447966/">https://habr.com/ru/post/447966/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447954/index.html">How to publish a translation of an art book in Russia</a></li>
<li><a href="../447956/index.html">Quantum communications at ITMO University - a project for unbreakable data transmission systems</a></li>
<li><a href="../447960/index.html">Linux Backup from Veeam on OS Elbrus. Import Substitution ['?' | '.' | '!']</a></li>
<li><a href="../447962/index.html">Hackers can remotely control the Tesla Model S using the autopilot system</a></li>
<li><a href="../447964/index.html">Microcomputer testing for IoT</a></li>
<li><a href="../447968/index.html">We write on Rust + CUDA C</a></li>
<li><a href="../447970/index.html">Javascript logging is super simple - two decorators and ready</a></li>
<li><a href="../447976/index.html">Development and assembly of a photo-lamp</a></li>
<li><a href="../447982/index.html">Digest: 10 materials about home theater screens and projectors</a></li>
<li><a href="../447984/index.html">Uber filed documents for IPO</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>