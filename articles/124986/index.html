<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Phased creation of extensions for Magento using the example of a debug console</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. 
 It is noticeable that Habr is not spoiled by articles about Magento, despite the fact that the platform is quite popular and at the same time...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Phased creation of extensions for Magento using the example of a debug console</h1><div class="post__text post__text-html js-mediator-article"> Hello. <br>  It is noticeable that Habr is not spoiled by articles about Magento, despite the fact that the platform is quite popular and at the same time - not easy.  The article will show the way to create a real extension available for download.  This is not a hello world, rather the desire to provide the community with a free alternative to Commercebug (if you worked with Magento - you probably heard about it). <br><br><a name="habracut"></a>  So, what should be a ready extension?  This should be a plot on the page with data on the currently used blocks, templates, handles and other useful information.  It seemed to me that it would be most convenient to do this in the form of a collapsible "console" - a thing that we used to see in many games like Half-Life.  Naturally, no command line will be there because it is simply not needed there. <br><br>  The first thing to start with is the creation of a file structure.  Since I am describing a real extension, I ask permission to use in the article the real names of the namespace and classes. <br>  We will define our namespace (namespace) - this is the very first part of the name of any class, it is identified with the developer of the extension.  For example, all internal Magento classes developed internally have a namespace of "Mage."  We will have this ‚ÄúLinker‚Äù.  Create a directory with this name in app / code / community. <br>  Let me remind you that the platform has three standard code pools (code pool) - core, community and local.  The first one contains only code developed internally, the second one is what the community develops (it can be both paid and free extensions), and the third one contains changes for this particular site that you are not going to share. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Next, create inside a directory with the name of the module (Insider), and in it - the standard directory structure: <br><br> <code>Insider <br> |-- Block <br> |-- controllers <br> |-- etc <br> |-- ‚Äî config.xml <br> |-- Helper <br> |-- ‚Äî Data.php <br> |-- Model</code> <br> <br>  Data.php and config.xml are mandatory extension files, without them the code simply will not run. <br><br>  Add to config.xml the following things: <br><br><blockquote> <code><font color="black"><font color="#0000ff">&lt;?</font> <font color="#800000">xml</font> <font color="#ff0000">version</font> <font color="#0000ff">="1.0"</font> ? <font color="#0000ff">&gt;</font> <font>&lt;!-- ,  - XML! --&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">config</font> <font color="#0000ff">&gt;</font> <font>&lt;!--   root node     --&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">modules</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">Linker_Insider</font> <font color="#0000ff">&gt;</font> <font>&lt;!--  --&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">version</font> <font color="#0000ff">&gt;</font> 0.1.0.0 <font color="#0000ff">&lt;/</font> <font color="#800000">version</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">Linker_Insider</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">modules</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">config</font> <font color="#0000ff">&gt;</font> <br></font></code> </blockquote><br><br>  Here we simply informed the system that I am such a module and I have such a version.  So far, nothing substantial.  Here are the contents of Data.php: <br><br><blockquote> <code><a href="http://s-c.me/22487/s"></a> <a href="http://s-c.me/22487/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#cc6633">&lt;? php</font> </li><li>  <font color="#0000ff">class</font> Linker_Insider_Helper_Data <font color="#0000ff">extends</font> Mage_Core_Helper_Data {} </li></ol></blockquote><br><br>  This is a stub.  We are simply not going to use helper, but this file is necessary for the system. <br>  A bit about class naming conventions: it basically fits with Zend's, that is, by looking at the name of the class you can tell exactly where it is.  In fact, the name corresponds to the location in the file system if you replace "_" with "/". <br>  Now let's go and turn on our module in the general list.  To do this, open etc / modules / Mage_All.xml and add the following lines between the description of the last module and &lt;/ config&gt;: <br><br><blockquote> <code><font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">Linker_Insider</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">active</font> <font color="#0000ff">&gt;</font> true <font color="#0000ff">&lt;/</font> <font color="#800000">active</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">codePool</font> <font color="#0000ff">&gt;</font> community <font color="#0000ff">&lt;/</font> <font color="#800000">codePool</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">Linker_Insider</font> <font color="#0000ff">&gt;</font> <br></font></code> </blockquote><br><br>  Thus, we reported that we want to enable (&lt;active&gt; true &lt;/ active&gt;) a module called Linker_Insider, which is located in the community code pool (app / code / community). <br>  Great, turned on!  But we still can not see it on the site, because it still does nothing.  Let's make it happen. <br>  For this you need to create a template file.  Templates for frontend are stored in app / design / frontend / base / default / template.  There we create a directory with the name of our module (insider), and in it - the file disclose.phtml.  We write in it, for example ‚Äúhello‚Äù (for now we just need to see if the module works).  Now you need to tell the system where to insert it - this already applies to markup.  Layout templates are XML files and are located in app / design / frontend / base / default / layout.  Create a file named insider.xml there with the following content: <br><br><blockquote> <code><font color="black"><font color="#0000ff">&lt;?</font> <font color="#800000">xml</font> <font color="#ff0000">version</font> <font color="#0000ff">="1.0"</font> ? <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">layout</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">default</font> <font color="#0000ff">&gt;</font> <font>&lt;!--     --&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">block</font> <font color="#ff0000">type</font> <font color="#0000ff">="core/template"</font> <font color="#ff0000">name</font> <font color="#0000ff">="insider"</font> <font color="#ff0000">template</font> <font color="#0000ff">="insider/disclose.phtml"</font> <font color="#0000ff">/&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">default</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">layout</font> <font color="#0000ff">&gt;</font> <br></font></code> </blockquote><br><br>  The 'type' attribute tells which block will control the rendering of the 'template' template.  In this case, it will be a block with the name of the class Mage_Core_Block_Template.  type = "modulename / blockname" stands for Namespace_modulename_Block_blockname.  It is assumed that the namespace is already registered in the system and she knows where to look for blocks starting with modulename.  Mage, of course, is registered, and when we need to use our own block, we will need to add something to our configuration file, but more on that later. <br>  The attribute 'name' is needed so that other blocks could ‚Äúcling‚Äù to it using &lt;reference&gt; - this will be clearer, too, a little further. <br><br>  Insider.xml by itself does not catch up, we need to explicitly indicate that our module is going to make changes to the markup - for this we will create another node in the config.xml: <br><br><blockquote> <code><font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">frontend</font> <font color="#0000ff">&gt;</font> <font>&lt;!-- ,     --&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">layout</font> <font color="#0000ff">&gt;</font> <font>&lt;!--      -   --&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">updates</font> <font color="#0000ff">&gt;</font> <font>&lt;!-- ,  -     --&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">insider</font> <font color="#0000ff">&gt;</font> <font>&lt;!--    --&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">file</font> <font color="#0000ff">&gt;</font> insider.xml <font color="#0000ff">&lt;/</font> <font color="#800000">file</font> <font color="#0000ff">&gt;</font> <font>&lt;!-- ,    --&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">insider</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">updates</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">layout</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">frontend</font> <font color="#0000ff">&gt;</font> <br></font></code> </blockquote><br><br>  Now run back to the site and press F5 - our ‚Äúhello‚Äù should appear somewhere below on any page of the frontend.  He has not appeared?  Are you sure you don't use the cache?  Let me remind you that you can disable it in the admin area: System -&gt; Cache Management. <br>  I don‚Äôt know about you, but I, for example, don‚Äôt like that our record dangles at the very bottom.  Let's throw it higher?  In order to do this, you need to tell a little about the mechanism for creating markup - before displaying the page, Magento parses all the .xml files from the layout folder (of course, only those that directly affect the display of the current page) and collects one of them, but it is large.  Using the attributes 'before' and 'after' we can tell the parser, respectively before or after which block to insert ours.  If you place the block inside the &lt;reference&gt; node, then you can ‚Äúcling‚Äù to a specific block ‚Äî insert yourself inside.  Virtually every block has an attribute 'name' - this is how it defines itself in the general markup and it can be asked to ‚Äúmove over‚Äù or ‚Äúlet it sleep‚Äù. <br>  In order to know which block in which place determines how itself it is necessary to study the markup files of other modules.  For example, if we look at page.xml, we will see there a block with the name 'after_body_start' with the label ‚ÄúPage Top‚Äù.  It seems that this is what you need!  Perhaps we will cling to him.  To do this, put the block description in the insider.xml file inside the &lt;reference&gt; node: <br><br><blockquote> <code><font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">reference</font> <font color="#ff0000">name</font> <font color="#0000ff">="after_body_start"</font> <font color="#0000ff">&gt;</font> <font>&lt;!--  after_body_start,    ! --&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">block</font> <font color="#ff0000">type</font> <font color="#0000ff">="core/template"</font> <font color="#ff0000">name</font> <font color="#0000ff">="insider"</font> <font color="#ff0000">template</font> <font color="#0000ff">="insider/disclose.phtml"</font> <font color="#0000ff">/&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">reference</font> <font color="#0000ff">&gt;</font> <br></font></code> </blockquote><br><br>  Well, that's better.  But something our ‚Äúhello‚Äù stopped inspiring me.  Let's add some stupid &lt;div&gt; to our template, maybe we‚Äôll add some class, and we‚Äôll describe the style in .css, and then add some more dynamics via .js.  I leave the code to your taste, I describe only how to make it work.  Create a file in the skin / frontend / base / default / css / insider / insider.css folder and write some code there that should affect the display style disclose.phtml.  In order to add this file to the page, you need to edit the markup file (insider.xml) and add the following inside the &lt;default&gt; node: <br><br><blockquote> <code><font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">reference</font> <font color="#ff0000">name</font> <font color="#0000ff">="head"</font> <font color="#0000ff">&gt;</font> <font>&lt;!--   HTML  &lt;head&gt;   --&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">action</font> <font color="#ff0000">method</font> <font color="#0000ff">="addCss"</font> <font color="#0000ff">&gt;&lt;</font> <font color="#800000">stylesheet</font> <font color="#0000ff">&gt;</font> css/insider/insider.css <font color="#0000ff">&lt;/</font> <font color="#800000">stylesheet</font> <font color="#0000ff">&gt;&lt;/</font> <font color="#800000">action</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">reference</font> <font color="#0000ff">&gt;</font> <br></font></code> </blockquote><br><br>  What is this action?  The &lt;action&gt; node allows you to call the block method and pass parameters to it directly from the markup file.  This is a very powerful thing.  If you return to page.xml you will see that the block ‚Äúpage / html_head‚Äù has been signed by the name ‚Äúhead‚Äù, and this, in turn, is the class called Mage_Core_Page_Block_Html_Head.  If you look at its implementation, you can easily find the addCss () method.  Now you understand what a wild thing this is - &lt;action&gt;? <br>  Let's get JavaScript done.  Create a js / insider / insider.js file and spice it up with code to taste.  You need to add almost the same way as CSS - in the same &lt;reference&gt; node that refers to the ‚Äúhead‚Äù create the following entry: <br><br><blockquote> <code><font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">action</font> <font color="#ff0000">method</font> <font color="#0000ff">="addJs"</font> <font color="#0000ff">&gt;&lt;</font> <font color="#800000">script</font> <font color="#0000ff">&gt;</font> insider/insider.js <font color="#0000ff">&lt;/</font> <font color="#800000">script</font> <font color="#0000ff">&gt;&lt;/</font> <font color="#800000">action</font> <font color="#0000ff">&gt;</font> <br></font></code> </blockquote><br><br>  I think there is nothing to explain here - by analogy everything should be clear. <br><br>  All this, of course, is good, but our extension still does not make a damn good thing.  It's time to fix this situation!  In order to influence the behavior of the template and transfer information to it, we need our own block.  Create a file Linker / Insider / Block / Disclose.php.  Fill it with the following content: <br><br><blockquote> <code><a href="http://s-c.me/22489/s"></a> <a href="http://s-c.me/22489/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt; <font color="#cc6633">&lt;?php</font> &lt;br/&gt; <font color="#0000ff">class</font> Linker_Insider_Block_Disclose <font color="#0000ff">extends</font> Mage_Core_Block_Template&lt;br/&gt;{&lt;br/&gt; <font color="#696969">// Magento        __construct() (   "_")</font> &lt;br/&gt; <font color="#0000ff">function</font> _construct()&lt;br/&gt;    {&lt;br/&gt; <font color="#696969">//    (   Zend Framework)</font> &lt;br/&gt; <font color="#cc6633">$request</font> = <font color="#cc6633">$this</font> -&gt;getRequest();&lt;br/&gt; <font color="#696969">//    ,    </font> &lt;br/&gt; <font color="#cc6633">$this</font> -&gt;module = <font color="#cc6633">$request</font> -&gt;getModuleName();&lt;br/&gt; <font color="#cc6633">$this</font> -&gt;controller = <font color="#cc6633">$request</font> -&gt;getControllerName();&lt;br/&gt; <font color="#cc6633">$this</font> -&gt;action = <font color="#cc6633">$request</font> -&gt;getActionName();&lt;br/&gt;    }&lt;br/&gt;}&lt;br/&gt; &lt;br/&gt;</font></code> </blockquote> <br><br>  In order for it to be able to pass this information into a template, we need to change the block type in the insider.xml file: <br><br><blockquote> <code><font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">block</font> <font color="#ff0000">type</font> <font color="#0000ff">="insider/disclose"</font> <font color="#ff0000">name</font> <font color="#0000ff">="insider"</font> <font color="#ff0000">template</font> <font color="#0000ff">="insider/disclose.phtml"</font> <font color="#0000ff">/&gt;</font></font> <br></code> </blockquote><br><br>  But there is one caveat: it just does not work.  Remember, we have our own namespace, and we haven‚Äôt described it anywhere else?  You need to do this, otherwise the system will not be able to find the class of the block.  Make changes to config.xml: <br><br><blockquote> <code><font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">global</font> <font color="#0000ff">&gt;</font> <font>&lt;!-- ,      --&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">blocks</font> <font color="#0000ff">&gt;</font> <font>&lt;!--     --&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">insider</font> <font color="#0000ff">&gt;</font> <font>&lt;!--  ,    Mage::getModel('insider/') --&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">class</font> <font color="#0000ff">&gt;</font> Linker_Insider_Block <font color="#0000ff">&lt;/</font> <font color="#800000">class</font> <font color="#0000ff">&gt;</font> <font>&lt;!--  Linker_Insider_Block_ --&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">insider</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">blocks</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">global</font> <font color="#0000ff">&gt;</font> <br></font></code> </blockquote><br><br>  The template, in fact, is rendered by the method of the block itself, which means it has access to all the fields and methods of this block, even to the protected and private ones.  You can display the contents of variables in this way (write in disclose.phtml): <br><br><blockquote> <code><a href="http://s-c.me/22490/s"></a> <a href="http://s-c.me/22490/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt; &lt;br/&gt;Module: <font color="#cc6633">&lt;?php</font> <font color="#0000ff">echo</font> <font color="#cc6633">$this</font> -&gt;module; <font color="#cc6633">?&gt;</font> &lt;br/&gt;Controller: <font color="#cc6633">&lt;?php</font> <font color="#0000ff">echo</font> <font color="#cc6633">$this</font> -&gt;controller; <font color="#cc6633">?&gt;</font> &lt;br/&gt;Action : <font color="#cc6633">&lt;?php</font> <font color="#0000ff">echo</font> <font color="#cc6633">$this</font> -&gt;action; <font color="#cc6633">?&gt;</font> &lt;br/&gt; &lt;br/&gt;</font></code> </blockquote> <br><br>  Now imagine that we suddenly wanted to beautifully display and fill our block with data.  Basically, we will have a name = value scheme here, so the easiest way to do this is through the form.  For the form relies a separate file, it will be Linker / Insider / Block / Disclose / Form / Controller.php.  Let the name not confuse you - it will be just a form with information about the current controller / module / action, here is the file contents: <br><br><blockquote> <code><a href="http://s-c.me/22491/s"></a> <a href="http://s-c.me/22491/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt; &lt;br/&gt; <font color="#cc6633">&lt;?php</font> &lt;br/&gt; <font color="#0000ff">class</font> Linker_Insider_Block_Disclose_Form_Controller <font color="#0000ff">extends</font> Varien_Data_Form&lt;br/&gt;{&lt;br/&gt; <font color="#0000ff">public function</font> __construct()&lt;br/&gt;    {&lt;br/&gt; <font color="#696969">//     HTML id </font> &lt;br/&gt;        parent::__construct( <font color="#0000ff">array</font> ( <font color="#008000">'id'</font> =&gt; <font color="#008000">'insider-form-controller'</font> ));&lt;br/&gt; &lt;br/&gt; <font color="#696969">// HTML id ,   (  Varien_Data_Form_Element_*),</font> &lt;br/&gt; <font color="#696969">//    (ZF-   )</font> &lt;br/&gt; <font color="#cc6633">$this</font> -&gt;addField( <font color="#008000">'module'</font> , <font color="#008000">'text'</font> , <font color="#0000ff">array</font> ( <font color="#008000">'label'</font> =&gt; <font color="#008000">'Module'</font> ));&lt;br/&gt; <font color="#cc6633">$this</font> -&gt;addField( <font color="#008000">'controller'</font> , <font color="#008000">'text'</font> , <font color="#0000ff">array</font> ( <font color="#008000">'label'</font> =&gt; <font color="#008000">'Controller'</font> ));&lt;br/&gt; <font color="#cc6633">$this</font> -&gt;addField( <font color="#008000">'action'</font> , <font color="#008000">'text'</font> , <font color="#0000ff">array</font> ( <font color="#008000">'label'</font> =&gt; <font color="#008000">'Action'</font> ));&lt;br/&gt;    }&lt;br/&gt;}&lt;br/&gt; &lt;br/&gt;</font></code> </blockquote> <br><br>  Done, now let's fill it with data.  According to the MVC concept, the data should come from the model, so we will have to move the contents of our block into the model.  Create a file Linker / Insider / Model / Insider.php: <br><br><blockquote> <code><a href="http://s-c.me/22492/s"></a> <a href="http://s-c.me/22492/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt; &lt;br/&gt; <font color="#cc6633">&lt;?php</font> &lt;br/&gt; <font color="#0000ff">class</font> Linker_Insider_Model_Insider <font color="#0000ff">extends</font> Mage_Core_Model_Abstract&lt;br/&gt;{&lt;br/&gt; <font color="#0000ff">public function</font> _construct()&lt;br/&gt;    {&lt;br/&gt; <font color="#696969">//    ,      getRequest(),     :</font> &lt;br/&gt; <font color="#cc6633">$request</font> = Mage::app()-&gt;getRequest();&lt;br/&gt; <font color="#cc6633">$module</font> = <font color="#cc6633">$request</font> -&gt;getModuleName();&lt;br/&gt; <font color="#cc6633">$controller</font> = <font color="#cc6633">$request</font> -&gt;getControllerName();&lt;br/&gt; <font color="#cc6633">$action</font> = <font color="#cc6633">$request</font> -&gt;getActionName();&lt;br/&gt; &lt;br/&gt; <font color="#696969">// setData()    protected  $_data</font> &lt;br/&gt; <font color="#696969">// ,     id ,</font> &lt;br/&gt; <font color="#696969">//   ,      </font> &lt;br/&gt; <font color="#cc6633">$this</font> -&gt;setData( <font color="#008000">'controller'</font> , <font color="#0000ff">array</font> (&lt;br/&gt; <font color="#008000">'module'</font> =&gt; <font color="#cc6633">$module</font> ,&lt;br/&gt; <font color="#008000">'controller'</font> =&gt; <font color="#cc6633">$controller</font> ,&lt;br/&gt; <font color="#008000">'action'</font> =&gt; <font color="#cc6633">$action</font> ,&lt;br/&gt;        ));&lt;br/&gt;    }&lt;br/&gt;} &lt;br/&gt;</font></code> </blockquote> <br><br>  Now we can fill the form with data from the model: <br><br><blockquote> <code><a href="http://s-c.me/22493/s"></a> <a href="http://s-c.me/22493/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt;...&lt;br/&gt; <font color="#cc6633">$this</font> -&gt;addField( <font color="#008000">'action'</font> , <font color="#008000">'text'</font> , <font color="#0000ff">array</font> ( <font color="#008000">'label'</font> =&gt; <font color="#008000">'Action'</font> ));&lt;br/&gt; <font color="#cc6633">$model</font> = Mage::getSingleton( <font color="#008000">'insider/insider'</font> );&lt;br/&gt; <font color="#cc6633">$this</font> -&gt;addValues( <font color="#cc6633">$model</font> -&gt;getData( <font color="#008000">'controller'</font> ));&lt;br/&gt; &lt;br/&gt;</font></code> </blockquote> <br><br>  But this will not work either.  The system, although it knows where to look for blocks starting at 'insider', but does not know where to look for such models.  We explain to it in the config.xml file, the &lt;global&gt; node: <br><br><blockquote> <code><font color="black"><font>&lt;!--       --&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">models</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">insider</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">class</font> <font color="#0000ff">&gt;</font> Linker_Insider_Model <font color="#0000ff">&lt;/</font> <font color="#800000">class</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">insider</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">models</font> <font color="#0000ff">&gt;</font></font> <br></code> </blockquote><br><br>  Now we can turn to the model, but now we need to bring our form to the eyes.  To do this, change the contents of Disclose.php as follows: <br><br><blockquote> <code><a href="http://s-c.me/22494/s"></a> <a href="http://s-c.me/22494/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt; &lt;br/&gt; <font color="#cc6633">&lt;?php</font> &lt;br/&gt; <font color="#0000ff">class</font> Linker_Insider_Block_Disclose <font color="#0000ff">extends</font> Mage_Core_Block_Template&lt;br/&gt;{&lt;br/&gt; <font color="#0000ff">public</font> <font color="#cc6633">$forms</font> = <font color="#0000ff">array</font> ();&lt;br/&gt; &lt;br/&gt; <font color="#0000ff">protected function</font> _construct()&lt;br/&gt;    {&lt;br/&gt; <font color="#cc6633">$this</font> -&gt;forms = <font color="#0000ff">array</font> (&lt;br/&gt; <font color="#008000">'controller'</font> =&gt; <font color="#0000ff">new</font> Linker_Insider_Block_Disclose_Form_Controller(),&lt;br/&gt;        );&lt;br/&gt;    }&lt;br/&gt;}&lt;br/&gt; &lt;br/&gt;</font></code> </blockquote> <br><br>  And in the template, delete the three lines that we added earlier and replace it with something simpler: <br><br><blockquote> <code><a href="http://s-c.me/22495/s"></a> <a href="http://s-c.me/22495/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt; &lt;br/&gt; <font color="#cc6633">&lt;?php</font> <font color="#0000ff">echo</font> <font color="#cc6633">$this</font> -&gt;forms[ <font color="#008000">'controller'</font> ]-&gt;toHtml(); <font color="#cc6633">?&gt;</font> &lt;br/&gt;</font></code> </blockquote> <br><br>  Okay, everything is ready.  In order to give the form a "console" view, you can write your renderer.  This is not a very difficult task and everything should be clear from the source code, so I‚Äôll skip this step here. <br>  Now let's do something more serious - it would be useful to get a list of all the blocks that are involved in displaying the current page.  You can do this from the model like this: <br><br><blockquote> <code><a href="http://s-c.me/22496/s"></a> <a href="http://s-c.me/22496/h"></a> <a href="http://www.php.net/manual/en/function.get-class.php"></a> <a href="http://www.php.net/manual/en/function.method-exists.php"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt; <font color="#696969">//     ,    </font> &lt;br/&gt; <font color="#cc6633">$layout</font> = Mage::app()-&gt;getLayout();&lt;br/&gt; <font color="#0000ff">foreach</font> ( <font color="#cc6633">$layout</font> -&gt;getAllBlocks() <font color="#0000ff">as</font> <font color="#cc6633">$name</font> =&gt; <font color="#cc6633">$block</font> ) {&lt;br/&gt; <font color="#cc6633">$class</font> = get_class( <font color="#cc6633">$block</font> );&lt;br/&gt; <font color="#696969">//    ,  , Mage_Core_Block_Abstract,     </font> &lt;br/&gt; <font color="#0000ff">if</font> (method_exists( <font color="#cc6633">$block</font> , <font color="#008000">'getTemplate'</font> )) {&lt;br/&gt; <font color="#696969">/* @var $block Mage_Core_Block_Template */</font> &lt;br/&gt; <font color="#cc6633">$template</font> = <font color="#cc6633">$block</font> -&gt;getTemplate();&lt;br/&gt;    } <font color="#0000ff">else</font> {&lt;br/&gt; <font color="#cc6633">$template</font> = <font color="#0000ff">false</font> ;&lt;br/&gt;    }&lt;br/&gt; &lt;br/&gt; <font color="#cc6633">$blocks</font> [] = <font color="#0000ff">array</font> (&lt;br/&gt; <font color="#696969">// eg Mage_Catalog_Product_List</font> &lt;br/&gt; <font color="#008000">'class'</font> =&gt; <font color="#cc6633">$class</font> ,&lt;br/&gt; <font color="#696969">// eg catalog/product_list.phtml</font> &lt;br/&gt; <font color="#008000">'template'</font> =&gt; <font color="#cc6633">$template</font> ,&lt;br/&gt; <font color="#696969">// eg "head"</font> &lt;br/&gt; <font color="#008000">'name'</font> =&gt; <font color="#cc6633">$name</font> ,&lt;br/&gt; <font color="#696969">// eg /home/user/magento/app/code/core/Mage/Catalog/Product/List.php</font> &lt;br/&gt; <font color="#008000">'blockFile'</font> =&gt; mageFindClassFile( <font color="#cc6633">$class</font> ),&lt;br/&gt; <font color="#696969">// eg /home/user/magento/app/design/frontend/base/default/template/catalog/product_list.phtml</font> &lt;br/&gt; <font color="#008000">'templateFile'</font> =&gt; <font color="#cc6633">$template</font> ? <font color="#cc6633">$block</font> -&gt;getTemplateFile() : <font color="#008000">''</font> ,&lt;br/&gt;    );&lt;br/&gt;}&lt;br/&gt; &lt;br/&gt;</font></code> </blockquote> <br><br>  Create a form, fill it with this data and render it in the template I trust you.  Well, that is, it's all available in the source code.  Why then is this piece here?  In order for you to see the inconsistency of this approach.  In the list of blocks we will get ourselves (ok, not great sadness), but also we will not get it all (stop-stop, this is why?).  At least because our block is one of the first to render, almost immediately after the &lt;body&gt; tag.  Consequently, the model will be able to pull out information only about blocks that are already there, and this is nothing at all.  How to overcome this obstacle?  The first thing that comes to mind is to see which block is rendered last, and follow it with the help of 'after'.  But if you think about it, it will not work, if only because another block may appear - which will be rendered even later, or it will simply cling to us with the help of 'after' - and we will not see it.  No, another level is needed here.  During the processing of a request, Magento generates a sufficiently large number of events for which it is also possible to ‚Äúcatch hold of‚Äù (almost like blocks).  What about the event that is reported literally before the page is sent to the browser?  Sounds great!  All blocks are rendered, they have already done everything they could and in our hands, in fact, ready HTML.  It remains only to pull out (now completely accurate) information about all the blocks involved and add your HTML to the final output.  What is needed for this?  First, to prohibit the rendering automatically (in the list of blocks we are somehow in a row, but we are standing there - and the system will definitely try to render us properly at some stage).  The easiest way is to insert a stub instead of the method that is called to generate and return HTML code.  Update our Disclose.php with a new method: <br><br><blockquote> <code><a href="http://s-c.me/22497/s"></a> <a href="http://s-c.me/22497/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt; &lt;br/&gt; <font color="#0000ff">public function</font> renderView()&lt;br/&gt;{&lt;br/&gt; <font color="#0000ff">return</font> <font color="#A31515">''</font> ;&lt;br/&gt;}&lt;br/&gt; &lt;br/&gt;</font></code> </blockquote> <br><br>  And now we will create our own, which we will be able to call upon request - exactly when we need: <br><br><blockquote> <code><a href="http://s-c.me/22498/s"></a> <a href="http://s-c.me/22498/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt; &lt;br/&gt; <font color="#0000ff">public function</font> renderSelf()&lt;br/&gt;{&lt;br/&gt; <font color="#0000ff">return</font> parent::renderView();&lt;br/&gt;}&lt;br/&gt; &lt;br/&gt;</font></code> </blockquote> <br><br>  Well, now we will make it to be called at a strictly specific moment - according to the event about which we spoke.  The event has a name that sounds like 'controller_front_send_response_before'.  In order to ‚Äúcling‚Äù to it, we need to create our own observer.  Create a file Linker / Insider / Model / Observer.php with the following contents: <br><br><blockquote> <code><a href="http://s-c.me/22499/s"></a> <a href="http://s-c.me/22499/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt; &lt;br/&gt; <font color="#0000ff">class</font> Linker_Insider_Model_Observer&lt;br/&gt;{&lt;br/&gt; <font color="#0000ff">public function</font> renderSelf(Varien_Event_Observer <font color="#cc6633">$observer</font> )&lt;br/&gt;    {&lt;br/&gt; <font color="#696969">// ,       -        - ?</font> &lt;br/&gt; <font color="#696969">//      ,      ( -   fire')</font> &lt;br/&gt; <font color="#0000ff">if</font> ( <font color="#cc6633">$block</font> = Mage::app()-&gt;getLayout()-&gt;getBlock( <font color="#008000">'insider'</font> )) {&lt;br/&gt; <font color="#696969">//  HTML-  </font> &lt;br/&gt; <font color="#cc6633">$insiderHtml</font> = <font color="#cc6633">$block</font> -&gt;renderSelf();&lt;br/&gt; <font color="#696969">//     front controller,     HTML  </font> &lt;br/&gt; <font color="#cc6633">$front</font> = <font color="#cc6633">$observer</font> -&gt;getData( <font color="#008000">'front'</font> );&lt;br/&gt; <font color="#696969">//   </font> &lt;br/&gt; <font color="#cc6633">$front</font> -&gt;getResponse()-&gt;append( <font color="#008000">'insider'</font> , <font color="#cc6633">$insiderHtml</font> );&lt;br/&gt;        }&lt;br/&gt;    }&lt;br/&gt;}&lt;br/&gt; &lt;br/&gt;</font></code> </blockquote> <br><br>  Now we have to describe what our observer should respond to.  This is done in config.xml, the &lt;global&gt; node: <br><br><blockquote> <code><font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">events</font> <font color="#0000ff">&gt;</font> <font>&lt;!--    --&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">controller_front_send_response_before</font> <font color="#0000ff">&gt;</font> <font>&lt;!--  -    --&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">observers</font> <font color="#0000ff">&gt;</font> <font>&lt;!--      ! --&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">insider_renderself</font> <font color="#0000ff">&gt;</font> <font>&lt;!--    --&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">class</font> <font color="#0000ff">&gt;</font> insider/observer <font color="#0000ff">&lt;/</font> <font color="#800000">class</font> <font color="#0000ff">&gt;</font> <font>&lt;!--   ... --&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">method</font> <font color="#0000ff">&gt;</font> renderSelf <font color="#0000ff">&lt;/</font> <font color="#800000">method</font> <font color="#0000ff">&gt;</font> <font>&lt;!--    --&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">insider_renderself</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">observers</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">controller_front_send_response_before</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">events</font> <font color="#0000ff">&gt;</font> <br></font></code> </blockquote><br><br>  That's all I wanted to talk about.  I hope this will help someone to understand some of the internal schemes of the work of Magento. <br>  In order to avoid reproaches in samopiare, I do not cite any references.  Those who want to evaluate the usefulness of the extension can find it on Magento Connect. </div><p>Source: <a href="https://habr.com/ru/post/124986/">https://habr.com/ru/post/124986/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../124978/index.html">Clustering Algorithm a-quasi-equivalence</a></li>
<li><a href="../124980/index.html">Which Ruby do you prefer to use for Rails 2.3 projects?</a></li>
<li><a href="../124981/index.html">Infinite Mario on HTML5</a></li>
<li><a href="../124982/index.html">The fate of old electronics</a></li>
<li><a href="../124984/index.html">How not to get into the issuance of Yandex</a></li>
<li><a href="../124990/index.html">Started Humble Bundle # 3</a></li>
<li><a href="../124991/index.html">Participation in the competition developers Evernote - Notex.me, post-mortem</a></li>
<li><a href="../124992/index.html">6 reasons to start with exchanges</a></li>
<li><a href="../124993/index.html">Avoid common HTML5 markup errors.</a></li>
<li><a href="../124996/index.html">Google indexed gov.ru</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>