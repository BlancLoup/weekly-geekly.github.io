<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>HotMilk is a library for conveniently organizing Mustache templates.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Post during the week ^ W month JavaScript on Habr√©. 

 After an article on the development of a one-page web application, I bookmarked ICanHaz with th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>HotMilk is a library for conveniently organizing Mustache templates.</h1><div class="post__text post__text-html js-mediator-article">  Post during the week ^ W month JavaScript on Habr√©. <br><br>  After an <a href="http://habrahabr.ru/blogs/webdev/123130/">article</a> on the development of a one-page web application, I bookmarked <a href="http://icanhazjs.com/">ICanHaz</a> with the aim of tearing it in and slightly finishing it up with how they would reach it.  And, as usual, put it in the back box. <br><br>  And so, having caught a cold right before the last weekend and, accordingly, unexpectedly having received two free days at the computer, I returned to this idea.  As a result, instead of cosmetic finishing, it turned out its modest bicycle with a motor. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Recall that ICanHaz is an easy way to slightly organize Mustache templates used by javascript in the browser.  Rendering templates using this library is reduced to a simple function call.  It also eliminates the need to screen half of the template, because  its text can be written directly in the HTML &lt;script&gt; tag <br><br><a name="habracut"></a><br><br><h2>  What for? </h2><br>  Actually, ICanHaz is simple: there is a template engine (mustache.js), there are templates (full-fledged and partial), written directly in HTML code in &lt;script&gt; tags with names in ID attributes and there is a global ich object, which when the page loads methods with template names are added.  Next, passing the object to the appropriate method, we get the rendered text at the output: <br><pre><code class="javascript hljs">$(<span class="hljs-string"><span class="hljs-string">'#myDiv'</span></span>).html(ich.myTemplateName(objModel));</code> </pre> <br>  I also wanted a somewhat more subtle mental ^ W organization of templates.  For example, in the simplest online store there can be several types of goods (let it be books, magazines, films and music).  For each of them there should be a list template (list), for each list an item, for item, a price with assigned currency (price).  And then we add a column on the right with discounts and we want to show the price in a slightly different way ... <br><br>  In general, it is possible, of course, to work with a flat collection of templates, but it would be nice to somehow organize them, for example, into a hierarchy, and even with the inheritance of partial'ov (for example, for all types of goods to determine the price format, for all templates with books - a way to format the names of the authors).  It would also be great to be able to add one template to several places without having to copy the &lt;script&gt; block (for example, make an exit date template for magazines and newspapers containing the week number of the year, and only a year for books and films). <br><br>  From these ideas and something was born. <br><br><h2>  Description HotMilk </h2><br>  The library is based on the <a href="https://github.com/pvande/Milk">Milk</a> template engine, which is a <a href="https://github.com/jashkenas/coffee-script">CoffeeScript</a> implementation of <a href="http://mustache.github.com/">Mustache</a> .  Milk was chosen a long time ago and I don‚Äôt remember for what reasons, it seems like because of the best support for the Mustache specification.  The name, respectively, from Milk'a and went (plus a hint of the templates that are embedded in HTML). <br><br>  HotMilk versions for jQuery, MooTools and a browser without a framework, as well as the basic version without loading templates from the DOM (they can be used on the server if desired) can be assembled. <br><br>  Before use, just like in ICanHaz, you need to fill out the template library.  This is done using the $ addTemplate method: <br><pre> <code class="javascript hljs"> HotMilk.$addTemplate(<span class="hljs-string"><span class="hljs-string">'path/to/template'</span></span>, <span class="hljs-string"><span class="hljs-string">'template {{text}}'</span></span>); HotMilk.$addTemplate(<span class="hljs-string"><span class="hljs-string">'path/to#partial'</span></span>, <span class="hljs-string"><span class="hljs-string">'...'</span></span>);</code> </pre><br>  Templates can be added and removed in any order, so in which case they can be asynchronously pull up from the server.  Templates can also be automatically compiled from &lt;script&gt; tags when the page finishes loading.  In order for the template to be loaded, you need to set the ‚Äútext / x-mustache-template‚Äù type to it and provide it with the data-hotmilk-path attribute (by the way, the HTML5 specification does not prohibit the use of data- * attributes for scripts, so that even validity is observed ): <br><pre> <code class="html hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/x-mustache-template"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-hotmilk-path</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"books/list#item"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"books/{{id}}"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">b</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">{{title}}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">b</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> by {{#author}}{{&gt;author}}{{/author}}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  The sample template is partial, i.e.  it is used as part of the drawing of the books / list template. <br><br>  In the data-hotmilk-path attribute, you can add several paths separated by a colon (several independent copies will be created). <br><br>  All the principles of the organization of templates can be put into a few simple theses: <br><ul><li>  Templates are organized into a hierarchical structure like a file system, where templates are analogous to files (a template in a tree is always a sheet); </li><li>  The path to the template is written through slashes: path / to / template.  Then this pattern can be called as <pre> <code class="javascript hljs">HotMilk.path.to.template(objData);</code> </pre> </li><li>  To any node (template or group), you can bind partial: path / to / node # partialName.  It will be accessible to this node and all its children; </li><li>  Parental partiales can be ‚Äúoverloaded‚Äù with their own names; </li><li>  Partials can also be rendered separately: <pre> <code class="javascript hljs">HotMilk.path.to.template.$.partial(objData);</code> </pre>  With such a call, the template will have access to the partial accessible by its parent node (in the example, to the ‚Äútemplate‚Äù node); </li><li>  Template names must be valid javascript IDs: consist of letters, numbers, underscores, and a dollar sign, but must not begin with numbers or a dollar. </li></ul><br><br>  A small demo is in <a href="https://github.com/lxyd/HotMilk">the HotMilk repository on github</a> . <br><br>  If someone suddenly wants to use the library in business, pay attention that at least some sane test suite is not available yet and it may not be for a long time, so there may be bugs. <br><br><h2>  Under the hood: implementation features </h2><br>  I'll run through some source code fragments with a few comments. <br><br>  Partial collection class.  It is due to this construction that the parental template subtext patterns are inherited. <br><pre> <code class="javascript hljs"> PartialsCollection = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">parentPartialsCollection</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ctor = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{}; ctor.prototype = parentPartialsCollection || PartialsCollection.prototype; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ctor(); };</code> </pre><br>  It works simply: with each call, it creates a new class with the previous set of partial's as a prototype.  When you first start takes your prototype.  Accordingly, each object created in this way will be quite an instance of the PartialsCollection class, possessing, moreover, the properties of all collections in the parent chain: <br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PartialsCollection(); a.t1 = <span class="hljs-string"><span class="hljs-string">"template 1"</span></span> <span class="hljs-comment"><span class="hljs-comment">// a.t1 === 'template 1'; a.hasOwnProperty('t1') === true; var b = new PartialsCollection(a); // b.t1 === 'template 1'; b.hasOwnProperty('t1') === false;</span></span></code> </pre><br>  Factory template functions.  Virtually the heart of the library.  Gets a template and an instance of the PartialCollection class and returns a function that takes a model and returns a rendered string. <br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> createTemplatingFunction = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">template, partialsCollection</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Milk.render(template, data, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">partialName</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(partialsCollection[partialName] &amp;&amp; partialsCollection[partialName].$value != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> partialsCollection[partialName].$value; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">"Unknown partial: "</span></span> + partialName); } }); }; };</code> </pre><br>  The functions Milk.render are passed to the template, model, and subtemplate search function by name, which simply looks to see if the collection has such a field and whether it has $ value. <br><br>  And then, using this function factory, a full-fledged node of our tree is created: <br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> createTemplateNode = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">template, partialsCollection</span></span></span><span class="hljs-function">) </span></span>{ partialsCollection = partialsCollection || <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PartialsCollection(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> templatingFunction = createTemplatingFunction(template, partialsCollection); templatingFunction.$ = partialsCollection; <span class="hljs-comment"><span class="hljs-comment">//    Function.prototype      ... templatingFunction.$addTemplate = addTemplate; templatingFunction.$removeTemplate = removeTemplate; return templatingFunction; };</span></span></code> </pre><br>  To implement the addition of templates in random order, I had to implement another trick.  For example, it is possible that a partial ‚Äúpath / to # partial‚Äù is added but no template exists yet and it is not clear if ‚Äúto‚Äù is a template or another group.  To resolve this situation, the path is always built from groups, and then, if it turned out that it was necessary to attach a template, the node is replaced with partial partial saving: <br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> addNormalTemplate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">root, path, template</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(path.length === <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">"Couldn't create template: name must not be empty"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> node = nodeBuildPath(root, path.slice(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">-1</span></span>)), name = path[path.length - <span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(hasOwnProperty(node, name)) { <span class="hljs-comment"><span class="hljs-comment">//   ,       , //  ,   partial' if(node[name] instanceof GroupNode &amp;&amp; nodeIsEmpty(node[name])) { node[name] = createTemplateNode(template, node[name].$); } else { //  -  (   ) throw new Error("Couldn't add template: node " + path.join('/') + " already exists"); } } else { //    ,      , //      node[name] = createTemplateNode(template, new PartialsCollection(node.$)); } };</span></span></code> </pre><br>  With subpatterns easier: <br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> addPartialTemplate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">root, path, partialName, template</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   ,   var node = nodeNavigatePath(root, path) || nodeBuildPath(root, path); if(hasOwnProperty(node.$, partialName)) { throw new Error("Couldn't add partial: node " + path.join('/') + "#" + partialName + " already exists"); } // , : .. partial     , //       , //        node.$[partialName] = createPartialTemplate(template, node.$); };</span></span></code> </pre><br>  If a template is created by creating a group and then replacing it, then deletion is the opposite: first, the template is replaced with a group, preserving the collection of subpatterns, and then the path is cleaned from the end (groups that are left without templates and partial'es are deleted). <br><br>  Attentive readers have noticed the curve way to call hasOwnProperty.  This is done again for reinsurance so as not to break from the template named hasOwnProperty.  The situation, of course, is delusional, but oh well, at the same time it should have a positive effect on compression. <br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hasOwnProperty = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj, propName</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.prototype.hasOwnProperty.call(obj, propName); };</code> </pre><br>  In general, the main points considered, anyone can explore the remainder on github.  Download the finished assembly can be there. <br><br>  I hope someone will come in handy.  Thanks for attention! <br><br><h2>  Links </h2><br><ul><li>  <a href="https://github.com/lxyd/HotMilk">HotMilk repository on github</a> </li><li>  <a href="http://icanhazjs.com/">ICanHaz - Prototype and Mastermind</a> </li><li>  <a href="http://mustache.github.com/">Mustache - format logic-less templates</a> </li><li>  <a href="https://github.com/jashkenas/coffee-script">CoffeeScript is a compiled javascript language.</a> </li><li>  <a href="https://github.com/pvande/Milk">Milk - implementation of Mustache on CoffeeScript</a> </li></ul><br><br>  <b>UPD:</b> It was enough to write an article, exposes that nakosyachil in the strongest way when trying to make inheritance from Function (is it even possible ???). <br>  In general, fixed.  After editing, the functionality was not affected, only the insides redid and updated the post in the affected places. </div><p>Source: <a href="https://habr.com/ru/post/125605/">https://habr.com/ru/post/125605/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../125594/index.html">50 more Nokia N950 are waiting for developers</a></li>
<li><a href="../125596/index.html">Software RAID-6 under Linux: 16TB array recovery experience</a></li>
<li><a href="../125597/index.html">Writing PHP extension</a></li>
<li><a href="../125599/index.html">Node.JS for Windows: node.exe</a></li>
<li><a href="../125603/index.html">The second breath of a budget Android-smartphone</a></li>
<li><a href="../125607/index.html">Quality assurance management</a></li>
<li><a href="../125608/index.html">Solution of the problem of the second contest CUBRID it!</a></li>
<li><a href="../125610/index.html">Online game based on real estate data</a></li>
<li><a href="../125611/index.html">DISLIN - high-level user data visualization library</a></li>
<li><a href="../125612/index.html">6 tips for motivating a team</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>