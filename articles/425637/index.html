<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Algorithm for establishing a connection in the SSH protocol</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="(The initial title of the article ‚ÄúSSH protocol operation algorithm‚Äù was changed according to the recommendations of Vindicar , Karroplan and other me...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Algorithm for establishing a connection in the SSH protocol</h1><div class="post__text post__text-html js-mediator-article">  <i>(The initial title of the article ‚ÄúSSH protocol operation algorithm‚Äù was changed according to the recommendations of <a href="https://habr.com/users/vindicar/" class="user_link">Vindicar</a> , <a href="https://habr.com/users/karroplan/" class="user_link">Karroplan</a> and other members of the habrosocommunity)</i> <br><br>  Periodically reading articles on SSH, I noticed that their authors sometimes have no idea how this protocol works.  In most cases, they are limited to considering the topic of key generation and the description of options for the main commands.  Even experienced system administrators often carry complete nonsense when discussing SSH operation issues, giving out opus in the style: the transmitted data is encrypted with the client's open SSH key, and decrypted as a private one, or: the RSA algorithm is used to encrypt the data. <br><br>  I will try to bring some clarity to the work of the SSH protocol, and at the same time consider the role of the RSA algorithm and user authorization keys ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/nh/ea/cr/nheacr1id9mw1cn3-bqnkuibjom.png" alt="image"><br><a name="habracut"></a><br>  The SSH protocol algorithm can be divided into three levels, each of which is located above the previous one: transport (opening a secure channel), authentication, connection.  For the integrity of the picture, I will also add the network connection setup level, although officially this level is below SSH. <br><br><h4>  1. Establish a TCP connection </h4><br>  I will not dwell on the principle of operation of the TCP / IP stack, since this topic is well documented in RuNet.  If necessary, you can easily find information. <br><br>  At this stage, the client connects to the server on the TCP port specified in the Port option (default: 22) in the server configuration file / etc / ssh / sshd_config. <br><br><h4>  2. Opening a secure channel </h4><br>  <b>2.1 Identity Exchange</b> <br><br>  After the TCP connection is established, the client and the server (hereinafter referred to as the parties) exchange the versions of the SSH protocol and other auxiliary data necessary for determining the compatibility of the protocols and for selecting the operation algorithms. <br><br>  <b>2.2 Selection of algorithms: key exchange, encryption, compression, etc.</b> <br><br>  When SSH is used, quite a few algorithms are used, some of them are used for encryption, the second for key exchange, the third for compressing transmitted data, etc.  At this step, the parties send each other lists of supported algorithms, the highest priority is given to the algorithms at the top of each list.  Then compare the algorithms in the received lists with the algorithms available in the system, and select the first matched one in each list. <br><br>  The list of available client-side key exchange algorithms (used to obtain a session key) can be viewed with the command: <br><br><pre><code class="bash hljs">ssh -Q kex</code> </pre> <br>  The list of symmetric algorithms available in the system (used to encrypt the channel): <br><br><pre> <code class="bash hljs">ssh -Q cipher</code> </pre> <br>  The list of key types for authorization at the client: <br><br><pre> <code class="bash hljs">ssh -Q key-cert</code> </pre> <br>  <i>Added by remark <a href="https://habr.com/users/onix74/" class="user_link">onix74</a> :</i> <br>  All the commands used in the publication are relevant for the version of OpenSSH 7.6 from Ubuntu 18.04 LTS. <br><br>  <b>2.3 Obtaining session encryption key</b> <br><br>  The process of obtaining a session key may differ depending on the version of the algorithm, but in general terms it comes down to the following: <br><br><ul><li>  The server sends its key to the client (DSA, RSA or the like according to the agreement between the parties produced in clause 2.2). </li><li>  If the client connects to this server for the first time (as indicated by the absence of an entry in the /home/username/.ssh/known_hosts file at the client), then the user will be asked to trust the server key.  If the connection to this server has already been established, the client compares the sent key with the key recorded in /home/username/.ssh/known_hosts.  If the keys do not match, the user will receive a warning about a possible hacking attempt.  However, you can skip this check if you call ssh with the StrictHostKeyChecking option: <br><pre> <code class="bash hljs">ssh -o StrictHostKeyChecking=no username@servername</code> </pre>  Also, if the user needs to delete the old server key (for example, when there is an exact certainty that the key has been changed on the server), the command is used: <br><pre> <code class="bash hljs">ssh-keygen -R servername</code> </pre> <br></li><li>  As soon as the client has decided on trust in the server key, using one of the implementations (the version is defined in clause 2.2) of the Diffie-Hellman algorithm, the client and server generate a session key that will be used for symmetric channel encryption. <br></li></ul><br>  The session key is created exclusively for the period of the channel's life and is destroyed when the connection is closed. <br><br><h4>  3. Client Authentication </h4><br>  And only now, when the client and the server have established a channel for encrypted data transfer, can they authenticate by password or key. <br><br>  In general, authentication using keys is as follows: <br><br><ul><li>  The client sends the username (username) and its public key to the server. </li><li>  The server checks in the file /home/username/.ssh/authorized_keys the presence of the public key sent by the client.  If the public key is found, the server generates a random number and encrypts it with the client's public key, after which the result is sent to the client. </li><li>  The client decrypts the message with its private key and sends the result to the server. </li><li>  The server checks the result for a match with the number that it originally encrypted with the client‚Äôs public key, and if a match occurs, it considers the authentication successful. </li></ul><br><h4>  4. Connection Level </h4><br>  After carrying out all the above procedures, the user is able to send commands to the server or copy files. <br><br>  At this level, the following is provided: channel multiplication (the ability of multiple channels to work on a single server by combining them into one channel), tunneling, etc. <br><br><h2>  From theory to practice </h2><br>  Well, now, I think, readers have quite a legitimate question: why do we need to know all these subtleties of the SSH protocol, if for everyday work there is enough knowledge of key creation commands (ssh-keygen), opening a terminal session (ssh), transferring files ( scp)? <br><br>  As a response, you can recall the topic of changing the standard SSH port to another one, which constantly becomes the cause of holivar on Habr ... <br><br>  In my own practice, I don‚Äôt remember a single server looking to the external network that would not be daily slapped to port 22.  In a situation if SSH works on a standard port for you (and is not additionally protected by anything), even if authentication using keys only and no password selections do not frighten you, the server is still forced to do a lot of useless work because of constant requests from unscrupulous clients: establish a TCP connection, select algorithms, generate a session key, send authentication requests, write a log file. <br><br>  In a situation where there is nothing on port 22, or the port is protected using iptables (or add-ons of the fail2ban type), then the attacker will be dropped at the stage of establishing a TCP connection. <br><br>  The most interestingly described looks like a table * <br><table><tbody><tr><th>  Configuration </th><th>  Probability of hacking </th><th>  Losses from flooding ** </th></tr><tr><td>  Port 22, <br>  password authentication, <br>  without protection </td><td>  high </td><td>  high </td></tr><tr><td>  Port 22, <br>  key authorization <br>  without protection </td><td>  average *** </td><td>  high </td></tr><tr><td>  Port 22, <br>  key authorization <br>  protection based on limiting failed authorization attempts </td><td>  low </td><td>  average **** </td></tr><tr><td>  Custom port, <br>  password authentication, <br>  without protection </td><td>  high </td><td>  low </td></tr><tr><td>  Custom port, <br>  key authorization <br>  without protection </td><td>  average *** </td><td>  low </td></tr><tr><td>  Custom port, <br>  key authorization <br>  protection based on limiting failed authorization attempts </td><td>  low </td><td>  low </td></tr></tbody></table><br>  * - the values ‚Äã‚Äãof the parameters (high, medium, low) are relative and serve only to compare indicators. <br>  ** - meaning the consumption of server resources (processor, disk, network channel, etc.) for processing an avalanche of requests, usually going to port 22. <br>  *** - hacking, if RSA-keys are used for authorization, is very difficult, but an unlimited number of authorization attempts makes this possible. <br>  **** - the number of authorization attempts is limited, but the server still has to process them from a large number of intruders. <br><br><h2>  Additional materials </h2><br><ul><li>  <a href="http://www.openssh.com/portable.html">SSH Sources</a> </li><li>  <a href="http://www.openssh.com/specs.html">SSH protocol specifications (en)</a> </li><li>  <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25BE%25D1%2582%25D0%25BE%25D0%25BA%25D0%25BE%25D0%25BB_%25D0%2594%25D0%25B8%25D1%2584%25D1%2584%25D0%25B8_%25E2%2580%2594_%25D0%25A5%25D0%25B5%25D0%25BB%25D0%25BB%25D0%25BC%25D0%25B0%25D0%25BD%25D0%25B0">Diffie-Hellman Algorithm</a> </li><li>  <a href="https://ru.wikipedia.org/wiki/RSA">RSA algorithm</a> </li><li>  <a href="https://habr.com/post/418533/">How ssh appeared on port 22</a> </li><li>  <a href="https://habr.com/post/421477/">What is written in the .ssh / known_hosts file</a> </li><li>  <a href="https://habr.com/post/122445/">Memo to ssh users</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/425637/">https://habr.com/ru/post/425637/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../425627/index.html">IaaS for developing services: who and why switched to virtual infrastructure</a></li>
<li><a href="../425629/index.html">How we made a board game with a remote control</a></li>
<li><a href="../425631/index.html">The social network "Vkontakte" told about how and why it provides user data</a></li>
<li><a href="../425633/index.html">Volkswagen + Microsoft = Internet technology for a comfortable ride</a></li>
<li><a href="../425635/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ333 (October 1 - 7, 2018)</a></li>
<li><a href="../425641/index.html">Residents of the Canadian city have developed a "Uber-service" with buses, not cars</a></li>
<li><a href="../425643/index.html">Digital events in Moscow from 8 to 14 October</a></li>
<li><a href="../425645/index.html">SpaceX and SAOCOM - 1A New mission. Done</a></li>
<li><a href="../425647/index.html">UI testing: checking the system at different resolutions</a></li>
<li><a href="../425649/index.html">BDSM, Gore and the Drupal developer chase</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>