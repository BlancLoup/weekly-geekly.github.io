<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Kali Linux: system protection and monitoring exercises</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚Üí Part 1. Kali Linux: security policy, protecting computers and network services 
 ‚Üí Part 2. Kali Linux: filtering traffic using netfilter 
 ‚Üí Part 3....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Kali Linux: system protection and monitoring exercises</h1><div class="post__text post__text-html js-mediator-article">  ‚Üí Part 1. <a href="https://habrahabr.ru/company/ruvds/blog/338338/">Kali Linux: security policy, protecting computers and network services</a> <br>  ‚Üí Part 2. <a href="https://habrahabr.ru/company/ruvds/blog/338480/">Kali Linux: filtering traffic using netfilter</a> <br>  ‚Üí Part 3. <a href="https://habrahabr.ru/company/ruvds/blog/338668/">Kali Linux: monitoring and logging</a> <br><br>  In the previous three materials, we talked about protecting Kali Linux, about filtering traffic, and about monitoring.  Today we will summarize and present to your attention a few exercises.  Here is a translation of Sections 7.6 and ‚ÄúExercises‚Äù in Chapter 7 of the book ‚Äú <a href="https://kali.training/introduction/kali-linux-revealed-book/">Kali Linux Revealed</a> ‚Äù. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/19d/13e/851/19d13e851f764246b6b3a1e95cfe9035.jpg"></div><a name="habracut"></a><br><h2>  <font color="#3AC1EF">7.6.</font>  <font color="#3AC1EF">Results</font> </h2><br>  In this chapter, we looked at the concepts of creating security policies, talked about what you should pay attention to when creating such a policy, and described some of the threats that are directed both at computers and at information security specialists themselves.  We discussed measures to protect laptops and desktops, and showed how to set up the <code>netfilter</code> firewall built into the Linux kernel.  Finally, we looked at the tools and strategies for monitoring Kali, showed how to implement them in order to be able to detect potential threats in time.  Now let's summarize, remember the most important. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Take time to formulate a security policy. </li><li>  If you use Kali Linux on a public server, change all standard passwords for services that can be configured (for more details see section 7.3. ‚Äú <a href="https://kali.training/chapter-7/7-6-summary/7-securing-and-monitoring-kali/securing-network-services/">Protecting network services</a> ‚Äù) and restrict access to them using a firewall (for more details see section 7.4. ‚Äú <a href="https://kali.training/chapter-7/7-6-summary/7-securing-and-monitoring-kali/firewall-or-packet-filtering/">Firewall or packet filtering</a> ").  This should be done before starting the services. <br></li><li>  Use <code>fail2ban</code> to repel password guessing attacks or remote password attacks using brute force. <br></li><li>  If you support web services, organize work with them via HTTPS to prevent traffic interception, which may include authentication cookies, by third parties. <br></li><li>  The real risk often arises if you travel from client to client.  For example, your laptop may be stolen or removed at customs.  Prepare for this development using full disk encryption (for details, see section 4.2.2. ‚Äú <a href="https://kali.training/chapter-7/7-6-summary/4-installing-kali-linux/installing-to-hard-drive/">Installation on a fully encrypted file system</a> ‚Äù).  Consider setting up a self-destruct feature (for details, see ‚Äú <a href="https://kali.training/chapter-7/7-6-summary/9-advanced-usage/adding-persistence-to-the-live-iso/">Setting a self-destruct password to increase security</a> ‚Äù).  This will allow you to securely protect customer data. <br></li><li>  Configure firewall rules (section 7.4. ‚Äú <a href="https://kali.training/chapter-7/7-6-summary/7-securing-and-monitoring-kali/firewall-or-packet-filtering/">Firewall or packet filtering</a> ‚Äù) to block any outgoing traffic, except for the one that your VPN connection generates.  As a result, you will organize a secure network connection for yourself, and if it turns out to be broken, you will immediately find out about it (and do not switch to Internet access via the local network). <br></li><li>  Disable unused services.  Kali simplifies this task, since all external network services are disabled by default. <br></li><li>  The <code>netfilter</code> firewall is built into the Linux kernel.  There are no universal rules for configuring firewalls that are suitable for all occasions, as users may have different requirements for networks and network services.  You can configure the firewall as you need it, from user space, using the <code>iptables</code> and <code>ip6tables</code> commands. <br></li><li>  The <code>logcheck</code> program <code>logcheck</code> able to monitor log files, viewing them, by default, hourly, and send to the administrator reports containing unusual records for further analysis. <br></li><li>  The <code>top ‚Äî</code> utility <code>top ‚Äî</code> an interactive tool that lists the running processes. <br></li><li>  The <code>dpkg --verify</code> (or <code>dpkg -V</code> ) command allows you to display a report on system files that have been modified (possibly by an attacker).  Its disadvantage is that comparing files, it relies on their checksums, which can be changed by a well-trained attacker. <br></li><li>  The Advanced Intrusion Detection Environment (AIDE) tool allows you to check the integrity of files, it detects any changes when comparing existing files with a previously saved reference system image. <br></li><li>  The <code>tripwire</code> tool <code>tripwire</code> very similar to AIDE, but it uses the technique of signing the configuration file, so the attacker cannot change it so that it points to the version of the reference database he needs. <br></li><li>  Consider using the <code>rkhunter</code> , <code>checksecurity</code> , and <code>chkrootkit</code> that are designed to scan for rootkits. <br></li></ul><br><h2>  <font color="#3AC1EF">Exercises</font> </h2><br>  Below are a few exercises that will allow you to practice your Kali Linux security. <br><br><h3>  <font color="#3AC1EF">‚ñçExercise number 1: protection when working in the network</font> </h3><br><ol><li>  Identify all open ports in your Kali Linux installation. <br></li><li>  Configure the Kali firewall to allow TCP connections only to ports 22, 80 and 443. <br></li><li>  Check if all other ports are blocked using a utility like <code>netcat</code> . <br></li><li>  Configure the system so that the firewall rules are saved after the reboot.  Restart the computer to check it. <br></li></ol><br>  Note: if there is such an opportunity, it would be good to make answers to the questions in the collapsible block.  Similarly, the answers to other questions. <br><br><h3>  <font color="#3AC1EF">‚ñç Answers to exercise number 1</font> </h3><br><div class="spoiler">  <b class="spoiler_title">Look</b> <div class="spoiler_text"><ol><li>  Check open ports: <br><br><pre> <code class="hljs ruby">root@kali<span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment"># netstat -tulpen root</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@kali</span></span></span><span class="hljs-comment">:~# iptables -n -L INPUT</span></span></code> </pre> <br>  If some ports are already blocked on your system, or there are previously established <code>iptables</code> rules, you can get rid of all this: <br><br><pre> <code class="hljs ruby">root@kali<span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment"># iptables -F INPUT root</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@kali</span></span></span><span class="hljs-comment">:~# iptables -P INPUT ACCEPT root</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@kali</span></span></span><span class="hljs-comment">:~# iptables -P FORWARD ACCEPT root</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@kali</span></span></span><span class="hljs-comment">:~# iptables -P OUTPUT ACCEPT</span></span></code> </pre> <br>  Now check if you can connect to port 4444 on your computer using <code>netcat</code> as follows: <br><br><pre> <code class="hljs ruby">root@kali<span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment"># nc -lnvp 4444 listening on [any] 4444 ...</span></span></code> </pre> <br>  From your host (if Kali is running on a virtual machine), or from another computer, try connecting to the <code>netcat</code> instance that is listening on port 4444. After connecting, type in something from the keyboard.  The text should appear where <code>netcat</code> running: <br><br><pre> <code class="hljs ruby">root@HOST_MACHINE<span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment">#  nc -v 172.16.161.136 4444 aaaaaaaa</span></span></code> </pre> <br>  Please note that if you enter text from the keyboard, but it does not appear on the screen, it means that something went wrong.  Understand this before continuing.  If Kali is installed on a virtual machine, switch to using a network bridge instead of NAT.  Get network connectivity up and running. <br></li><li>  You can configure the firewall using the following commands: <br><br><pre> <code class="hljs perl">iptables -P INPUT DROP iptables -A INPUT -i lo -j ACCEPT iptables -A INPUT -<span class="hljs-keyword"><span class="hljs-keyword">m</span></span> <span class="hljs-keyword"><span class="hljs-keyword">state</span></span> --<span class="hljs-keyword"><span class="hljs-keyword">state</span></span> ESTABLISHED,RELATED -j ACCEPT iptables -A INPUT -<span class="hljs-keyword"><span class="hljs-keyword">m</span></span> <span class="hljs-keyword"><span class="hljs-keyword">state</span></span> --<span class="hljs-keyword"><span class="hljs-keyword">state</span></span> NEW -p tcp --dport <span class="hljs-number"><span class="hljs-number">22</span></span> -j ACCEPT iptables -A INPUT -<span class="hljs-keyword"><span class="hljs-keyword">m</span></span> <span class="hljs-keyword"><span class="hljs-keyword">state</span></span> --<span class="hljs-keyword"><span class="hljs-keyword">state</span></span> NEW -p tcp --dport <span class="hljs-number"><span class="hljs-number">80</span></span> -j ACCEPT iptables -A INPUT -<span class="hljs-keyword"><span class="hljs-keyword">m</span></span> <span class="hljs-keyword"><span class="hljs-keyword">state</span></span> --<span class="hljs-keyword"><span class="hljs-keyword">state</span></span> NEW -p tcp --dport <span class="hljs-number"><span class="hljs-number">443</span></span> -j ACCEPT</code> </pre> <br>  Now check whether it is possible to reconnect to port 4444 on a firewall-protected machine: <br><br><pre> <code class="hljs ruby">root@kali<span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment"># nc -lvp 4444 listening on [any] 4444 ...</span></span></code> </pre> </li><li>  Try, from the host computer, to connect to <code>netcat</code> .  The connection attempt should fail. <br><br><pre> <code class="hljs ruby">root@HOST_MACHINE<span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment"># nc -v 172.16.161.136 4444 nc: connectx to 172.16.161.136 port 4444 (tcp) failed: Operation timed out</span></span></code> </pre> </li><li>  Now create an <code>iptables</code> script from the previously defined rules: <br><br><pre> <code class="hljs ruby">root@kali<span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment"># iptables-save  &gt; /usr/local/etc/myconfig.fw</span></span></code> </pre> <br>  Register the configuration script in the <code>pre-up</code> directive of the <code>/etc/network/interfaces</code> file.  Reboot the system to make sure that the firewall settings are saved. <br><br><pre> <code class="hljs pgsql">auto lo iface lo <span class="hljs-type"><span class="hljs-type">inet</span></span> loopback auto eth0 iface eth0 <span class="hljs-type"><span class="hljs-type">inet</span></span> dhcp pre-up iptables-restore &lt; /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/etc/myconfig.fw</code> </pre> </li></ol><br>  ‚Üí <a href="https://asciinema.org/a/ENHvLEz9rLVm3LarsnpyqOtKC">Here is</a> the Asciinema solution (the text from the video cannot be copied). <br><br>  <a href="https://asciinema.org/a/KgJ0I7P6VebmIhhtlD2sHOwVG">This is how it looks</a> from the point of view of the host system from which you are connecting to the virtual machine with Kali Linux. </div></div><br><h3>  <font color="#3AC1EF">‚ñçExercise number 2: monitoring services</font> </h3><br><ol><li>  Install <code>logcheck</code> . <br></li><li>  Try to attack, using brute force, your own SSH service, and see if it <code>logcheck</code> , if it <code>logcheck</code> you an attack report. <br></li><li>  Schedule a <code>cron</code> job to run <code>logcheck</code> every hour so that, after analyzing the log files, it will create a log file in <code>/data/$(date-time).log</code> . <br></li></ol><br><h3>  <font color="#3AC1EF">‚ñç Answers to exercise number 2</font> </h3><br><div class="spoiler">  <b class="spoiler_title">Look</b> <div class="spoiler_text"><ol><li>  Install <code>logcheck</code> and run it for the first time: <br><br><pre> <code class="hljs swift">apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install logcheck sudo -u logcheck logcheck -o</code> </pre> </li><li>  Download the password list, attack your own SSH service with the help of the <code>hydra</code> bruteforcer, see what <code>logcheck</code> about it: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">wget</span></span> https://raw.githubusercontent.com/danielmiessler/SecLists/master/Passwords/500-worst-passwords.txt hydra -l root -P <span class="hljs-number"><span class="hljs-number">500</span></span>-worst-passwords.txt <span class="hljs-number"><span class="hljs-number">127.0.0.1</span></span> ssh tail -f /var/log/auth.log sudo -u logcheck logcheck -o</code> </pre> </li><li>  Write a bash script with the following content: <br><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">mkdir</span></span> -p /data/ sudo -u logcheck logcheck -o &gt; <span class="hljs-regexp"><span class="hljs-regexp">/data/</span></span>$(date +<span class="hljs-string"><span class="hljs-string">"%m-%d-%Y-%T"</span></span>).log</code> </pre> <br>  Make it executable and place it in the <code>/etc/cron.hourly</code> directory. </li></ol><br>  ‚Üí <a href="https://asciinema.org/a/WdB5MeWMWHIHz3krMOzZ4OcMz">Here is</a> the Asciinema solution (text can be copied from the video). </div></div><br><h3>  <font color="#3AC1EF">‚ñçExercise number 3: file system protection</font> </h3><br><ol><li>  Install <code>tripwire</code> .  Start monitoring changes to files in the <code>/var/www/html/</code> directory. <br></li><li>  If you did everything correctly, you will encounter a lot of ‚ÄúFile system error‚Äù errors.  Maybe you hacked?  In any case, correct the situation. <br></li></ol><br><h3>  <font color="#3AC1EF">‚ñç Answers to exercise number 3</font> </h3><br><div class="spoiler">  <b class="spoiler_title">Look</b> <div class="spoiler_text"><ol><li>  Install <code>tripwire</code> and set the files you want to protect: <br><br><pre> <code class="hljs sql">apt-get <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> tripwire <span class="hljs-comment"><span class="hljs-comment"># yes, yes, yes, yes nano /etc/tripwire/twpol.txt  # list the directories and files you want to protect</span></span></code> </pre> <br>  Add the following code block to the <code>tripwire</code> policy <code>tripwire</code> : <br><br><pre> <code class="hljs mel"># Webserver <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> and folder monitoring ( rulename = <span class="hljs-string"><span class="hljs-string">"Web server file and directories"</span></span>, severity = $(SIG_HI) ) {       /var/www/html   -&gt; $(SEC_BIN); }</code> </pre> <br>  Now make <code>tripwire</code> react to changes in files in the <code>/var/www/html</code> directory: <br><br><pre> <code class="hljs pgsql">twadmin -m P /etc/tripwire/twpol.txt #<span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Policy</span></span> File tripwire <span class="hljs-comment"><span class="hljs-comment">--init #Initialize database tripwire --check #Initial integrity check touch /var/www/html/shell_backdoor.php tripwire --check tripwire --update-policy -Z low /etc/tripwire/twpol.txt tripwire --check</span></span></code> </pre> </li></ol></div></div><br>  ‚Üí <a href="https://asciinema.org/a/A4cRubQyLVmdPS9Dbwjgi0NbT">Here is</a> the Asciinema solution (the text cannot be copied from the video). <br><br><h3>  <font color="#3AC1EF"> Thought information</font> </h3><br><ul><li>  Here is an interesting example of using <code>iptables</code> .  You can turn any wireless computer into a wireless access point with <code>hostapd</code> .  Here is the source of this idea: <br><br><pre> <code class="hljs ruby">iptables -t nat -F iptables -F iptables -t nat -A POSTROUTING -o eth<span class="hljs-number"><span class="hljs-number">0</span></span> -j MASQUERADE iptables -A FORWARD -i wlan<span class="hljs-number"><span class="hljs-number">0</span></span> -o eth<span class="hljs-number"><span class="hljs-number">0</span></span> -j ACCEPT echo <span class="hljs-string"><span class="hljs-string">'1'</span></span> &gt; <span class="hljs-regexp"><span class="hljs-regexp">/proc/sys</span></span><span class="hljs-regexp"><span class="hljs-regexp">/net/ipv</span></span>4/ip_forward (DNS, dhcp still required)</code> </pre> </li><li>  Take a look at this awesome <a href="https://www.digitalocean.com/community/tutorials/iptables-essentials-common-firewall-rules-and-commands">iptables guide</a> . <br></li></ul><br><h3>  <font color="#3AC1EF"> Results</font> </h3><br>  We hope that what you learned from the series of materials in which we published translations of fragments of the seventh chapter of the book ‚Äú <a href="https://kali.training/introduction/kali-linux-revealed-book/">Kali Linux Revealed</a> ‚Äù will help you to make your system safer and more reliable. <br><br>  Dear readers!  Did you do the exercises, or did you have to pry into the answers? </div><p>Source: <a href="https://habr.com/ru/post/338712/">https://habr.com/ru/post/338712/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338698/index.html">Its build system on Linux</a></li>
<li><a href="../338700/index.html">Riddles and Myths SPF</a></li>
<li><a href="../338702/index.html">"Open Sunday" at the partner seminar "1C"</a></li>
<li><a href="../338704/index.html">On the classification of Fourier transform methods by examples of their software implementation by means of Python</a></li>
<li><a href="../338710/index.html">Energy efficient data center: familiarity with international experience</a></li>
<li><a href="../338714/index.html">How to get to ITMO University Technopark</a></li>
<li><a href="../338716/index.html">As we celebrated 256 day of the year and drew pixels through the API</a></li>
<li><a href="../338718/index.html">Understanding the new sync.Map in Go 1.9</a></li>
<li><a href="../338720/index.html">Use PubNub: Emotional Talking Chat Do It Yourself</a></li>
<li><a href="../338722/index.html">The second version of the Air Quality Monitor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>