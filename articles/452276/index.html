<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reverse engineering client Dropbox</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TL; DR. The article describes the reverse development of the Dropbox client, hacking the obfuscation and decompiling of the client in Python, as well ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reverse engineering client Dropbox</h1><div class="post__text post__text-html js-mediator-article">  <i>TL; DR.</i>  <i>The article describes the reverse development of the Dropbox client, hacking the obfuscation and decompiling of the client in Python, as well as changing the program to activate debugging functions that are hidden in normal mode.</i>  <i>If you are only interested in the relevant code and instructions, scroll to the end.</i>  <i>At the time of this writing, the code is compatible with the latest versions of Dropbox, based on the CPython 3.6 interpreter.</i> <br><br><h3>  Introduction </h3><br>  Dropbox fascinated me right from the moment it appeared.  The concept is still deceptively simple.  Here is the folder.  Put files there.  It is synchronized.  Go to another device.  It is synchronized again.  The folder and files are now there! <br><br>  The amount of hidden background work is really amazing.  First, all the problems that have to be dealt with when creating and maintaining a cross-platform application for major desktop operating systems (OS X, Linux, Windows) do not disappear anywhere.  Add to this support for various web browsers, various mobile operating systems.  And we are talking only about the client part.  I am also interested in the Dropbox backend, which allowed me to achieve such scalability and low latency with the insanely heavy workload that half a billion users create. <br><a name="habracut"></a><br>  It is for these reasons that I have always liked to see what Dropbox is doing under the hood and how it has evolved over the years.  About eight years ago, I first tried to figure out how the Dropbox client actually works when I noticed a broadcast of unknown traffic while in a hotel.  The investigation revealed that this is part of the Dropbox feature called LanSync, which allows you to synchronize faster if Dropbox nodes on the same local network have access to the same files.  However, the protocol was not documented, and I wanted to know more.  Therefore, I decided to take a closer look, and as a result I did reverse engineering of almost the entire program.  This study was never published, although I sometimes shared notes with some people. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When we opened Anvil Ventures, Chris and I evaluated a number of tools for document storage, sharing and collaboration.  One of them, obviously, was Dropbox, but for me this is another reason to dig out old research and check them on the current version of the client. <br><br><h3>  Decryption and deobfuscation </h3><br>  First, I downloaded a client for Linux and quickly found out that it was written in Python.  Since the Python license is quite permissive, people can easily modify and distribute the Python interpreter along with other dependencies as commercial software.  Then I started reverse engineering to understand how the client works. <br><br>  At that time, the bytecode files were in a zip file combined with an executable binary.  The main binary file was simply a modified Python interpreter, which was loaded by capturing Python import mechanisms.  Each subsequent import call was redirected to this binary with parsing the ZIP file.  Of course, it is easy to extract this ZIP from a binary.  For example, the useful <a href="https://github.com/ReFirmLabs/binwalk">binwalk</a> tool retrieves it with all byte-compiled .pyc files. <br><br>  Then I could not break the encryption for the .pyc files, but in the end I took the general object of the standard Python library and recompiled it, inserting a backdoor inside.  Now that the Dropbox client loaded this object, I could easily execute arbitrary Python code in a working interpreter.  Although I discovered this on my own, Florian Ledoux and Nicolas Ruff used the same method in a <a href="http://archive.hack.lu/2012/Dropbox%2520security.pdf">presentation</a> at Hack.lu in 2012. <br><br>  The ability to explore and manipulate running code in Dropbox made it possible to figure out a lot.  The code used several defensive tricks to make it difficult to dump <a href="https://docs.python.org/3.6/library/functions.html">code objects</a> .  For example, in a conventional CPython interpreter, it is easy to restore the compiled bytecode representing a function.  A simple example: <br><br><pre><code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> i * i ... &gt;&gt;&gt; f.__code__ &lt;code object f at <span class="hljs-number"><span class="hljs-number">0x109deb540</span></span>, file <span class="hljs-string"><span class="hljs-string">"&lt;stdin&gt;"</span></span>, line <span class="hljs-number"><span class="hljs-number">1</span></span>&gt; &gt;&gt;&gt; f.__code__.co_code <span class="hljs-string"><span class="hljs-string">b'|\x00|\x00\x14\x00S\x00'</span></span> &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> dis &gt;&gt;&gt; dis.dis(f) <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> LOAD_FAST <span class="hljs-number"><span class="hljs-number">0</span></span> (i) <span class="hljs-number"><span class="hljs-number">2</span></span> LOAD_FAST <span class="hljs-number"><span class="hljs-number">0</span></span> (i) <span class="hljs-number"><span class="hljs-number">4</span></span> BINARY_MULTIPLY <span class="hljs-number"><span class="hljs-number">6</span></span> RETURN_VALUE &gt;&gt;&gt;</code> </pre> <br>  But in the compiled version of <i>Objects / codeobject.c, the co_code</i> property <code>co_code</code> removed from the open list.  This member list usually looks like this: <br><br><pre> <code class="python hljs"> static PyMemberDef code_memberlist[] = { ... {<span class="hljs-string"><span class="hljs-string">"co_flags"</span></span>, T_INT, OFF(co_flags), READONLY}, {<span class="hljs-string"><span class="hljs-string">"co_code"</span></span>, T_OBJECT, OFF(co_code), READONLY}, {<span class="hljs-string"><span class="hljs-string">"co_consts"</span></span>, T_OBJECT, OFF(co_consts), READONLY}, ... };</code> </pre> <br>  The disappearance of the <code>co_code</code> property makes it impossible to dump these code objects. <br><br>  In addition, other libraries have been removed, such as the standard Python <a href="https://docs.python.org/3.6/library/dis.html">disassembler</a> .  As a result, I still managed to dump the code objects into files, but I still could not decompile them.  It took some time before I realized that the opcodes used by the Dropbox interpreter do not match the standard Python opcodes.  Thus, it was necessary to understand the new opcodes in order to rewrite the code objects back into the original Python bytecode. <br><br>  One option is to <i>broadcast opcodes</i> (opcode remapping).  As far as I know, this technique was developed by Rich Smith and presented at <a href="https://www.youtube.com/watch%3Fv%3DtYHsv7Mzv5g">Defcon 18</a> .  In that speech, he also showed the <a href="https://github.com/MyNameIsMeerkat/pyREtic">pyREtic</a> tool for reverse engineering Python bytecode in memory.  The pyREtic code seems to be poorly supported, and the tool targets the ‚Äúold‚Äù Python 2.x binaries.  To get acquainted with the techniques that came up with Rich, it is highly recommended to watch his performance. <br><br>  The opcode translation method takes all the code objects of the standard Python library and compares them with the objects extracted from the Dropbox binary.  For example, code objects from <i>hashlib.pyc</i> or <i>socket.pyc</i> , which are in the standard library.  For example, if each time the opcode <code>0x43</code> corresponds to the de-encapsulated opcode <code>0x21</code> , you can gradually build a translation table for rewriting code objects.  These code objects can then be moved through the Python decompiler.  To make dumps, you still need a fixed interpreter with the correct <code>co_code</code> object. <br><br>  Another option is to hack the serialization format.  In Python, serialization is called <a href="https://docs.python.org/3.6/library/marshal.html">marshaling</a> .  Deserialization of obfuscated files in the usual way did not work.  When backing up a binary file in IDA Pro, I discovered a decryption step.  As far as I know, the first to publish something publicly on this topic is Hagen Fritsch on <a href="https://itooktheredpill.irgendwo.org/2012/dropbox-decrypt/">his blog</a> .  There, he refers to changes in new versions of Dropbox (when Dropbox switched from Python 2.5 to Python 2.7).  The algorithm works as follows: <br><br><ul><li>  When unpacking the pyc file, the header is read to determine the marshaling version.  This format is not documented, except for the CPython implementation itself. <br></li><li>  The format defines a list of types that are encoded in it.  The types are <code>True</code> , <code>False</code> , <code>floats</code> , etc., but the most important is the type for the above-mentioned objects of the Python <code>code object</code> , the <code>code object</code> . <br></li><li>  When loading a <code>code object</code> , two additional values ‚Äã‚Äãare first read from the input file. <br></li><li>  The first one is the 32-bit value of <code>random</code> . <br></li><li>  The second is a 32-bit <code>length</code> value indicating the size of the serialized code object. <br></li><li>  Then the <code>rand</code> and <code>length</code> values ‚Äã‚Äãare fed to a simple RNG function that generates a <code>seed</code> . <br></li><li>  This seed is supplied to the <a href="https://en.wikipedia.org/wiki/Mersenne_Twister">Mersenne vortex</a> , which generates four 32-bit values. <br></li><li>  Combined together, these four values ‚Äã‚Äãgive the encryption key for serialized data.  The encryption algorithm then decrypts the data using the <a href="https://en.wikipedia.org/wiki/Tiny_Encryption_Algorithm">Tiny Encryption Algorithm</a> . </li></ul><br>  In my code, I wrote a demarshaling procedure in Python from scratch.  The part that decodes the code objects looks something like a fragment below.  It should be noted that this method will have to be called recursively.  The top-level object for the pyc file is a code object that itself contains code objects, which can be classes, functions, or lambdas.  In turn, they can also contain methods, functions, or lambdas.  These are all code objects down the hierarchy! <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load_code</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> rand = self.r_long() length = self.r_long() seed = rng(rand, length) mt = MT19937(seed) key = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>): key.append(mt.extract_number()) <span class="hljs-comment"><span class="hljs-comment"># take care of padding for size calculation sz = (length + 15) &amp; ~0xf words = sz / 4 # convert data to list of dwords buf = self._read(sz) data = list(struct.unpack("&lt;%dL" % words, buf)) # decrypt and convert back to stream of bytes data = tea.tea_decipher(data, key) data = struct.pack("&lt;%dL" % words, *data)</span></span></code> </pre> <br>  The ability to decrypt code objects means that after deserialization of the procedures, the actual bytecode needs to be rewritten.  Code objects contain information about line numbers, constants, and other information.  The actual bytecode is in the <code>co_code</code> object.  When we built the opcode translation table, we can simply replace the obfuscated Dropbox values ‚Äã‚Äãwith standard Python 3.6 equivalents. <br><br>  Now the code objects are in the usual Python 3.6 format, and can be passed to the decompiler.  The quality of Python decompilers has increased significantly due to the R. Bernstein <a href="https://github.com/rocky/python-uncompyle6">uncompyle6</a> project.  Decompilation gave a pretty good result, and I was able to put everything together in a tool that, to the best of its ability, decompiles the current version of the Dropbox client. <br><br>  If you clone this <a href="https://github.com/anvilventures/lookinsidethebox">repository</a> and follow the instructions, the result will be something like this: <br><br><pre>  ...
     __main__ - INFO - Successfully decompiled dropbox / client / features / browse_search / __ init __. pyc
     __main__ - INFO - Decrypting, patching and decompiling _bootstrap_overrides.pyc
     __main__ - INFO - Successfully decompiled _bootstrap_overrides.pyc
     __main__ - INFO - Processed 3713 files (3591 succesfully decompiled, 122 failed)
     opcodemap - WARNING - NOT writing opcodemap as force overwrite not set </pre><br>  This means that you now have an <code>out/</code> directory with a decompiled version of the Dropbox source code. <br><br><h3>  Enable Dropbox Tracing </h3><br>  In the open source, I started looking for something interesting, and my attention was drawn to the following fragment.  Trace handlers in <code>out/dropbox/client/high_trace.py</code> are installed only if the assembly is not frozen or in the line <code>1430</code> restrictive ‚Äúmagic key‚Äù functionality or the cookie file is not set. <br><br><pre> <code class="python hljs"> <span class="hljs-number"><span class="hljs-number">1424</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">install_global_trace_handlers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(flags=None, args=None)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-number"><span class="hljs-number">1425</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> _tracing_initialized <span class="hljs-number"><span class="hljs-number">1426</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> _tracing_initialized: <span class="hljs-number"><span class="hljs-number">1427</span></span> TRACE(<span class="hljs-string"><span class="hljs-string">'!! Already enabled tracing system'</span></span>) <span class="hljs-number"><span class="hljs-number">1428</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1429</span></span> _tracing_initialized = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-number"><span class="hljs-number">1430</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> build_number.is_frozen() <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> magic_trace_key_is_set() <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> limited_support_cookie_is_set(): <span class="hljs-number"><span class="hljs-number">1431</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> os.getenv(<span class="hljs-string"><span class="hljs-string">'DBNOLOCALTRACE'</span></span>): <span class="hljs-number"><span class="hljs-number">1432</span></span> add_trace_handler(db_thread(LtraceThread)().trace) <span class="hljs-number"><span class="hljs-number">1433</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> os.getenv(<span class="hljs-string"><span class="hljs-string">'DBTRACEFILE'</span></span>): <span class="hljs-number"><span class="hljs-number">1434</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre> <br>  The mention of frozen builds refers to Dropbox internal debug builds.  A little higher in the same file you can find the following lines: <br><br><pre> <code class="python hljs"> <span class="hljs-number"><span class="hljs-number">272</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_valid_time_limited_cookie</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cookie)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-number"><span class="hljs-number">273</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-number"><span class="hljs-number">274</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-number"><span class="hljs-number">275</span></span> t_when = int(cookie[:<span class="hljs-number"><span class="hljs-number">8</span></span>], <span class="hljs-number"><span class="hljs-number">16</span></span>) ^ <span class="hljs-number"><span class="hljs-number">1686035233</span></span> <span class="hljs-number"><span class="hljs-number">276</span></span> <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> ValueError: <span class="hljs-number"><span class="hljs-number">277</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-number"><span class="hljs-number">278</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-number"><span class="hljs-number">279</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> abs(time.time() - t_when) &lt; SECONDS_PER_DAY * <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> md5(make_bytes(cookie[:<span class="hljs-number"><span class="hljs-number">8</span></span>]) + <span class="hljs-string"><span class="hljs-string">b'traceme'</span></span>).hexdigest()[:<span class="hljs-number"><span class="hljs-number">6</span></span>] == cookie[<span class="hljs-number"><span class="hljs-number">8</span></span>:]: <span class="hljs-number"><span class="hljs-number">280</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-number"><span class="hljs-number">281</span></span> <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception: <span class="hljs-number"><span class="hljs-number">282</span></span> report_exception() <span class="hljs-number"><span class="hljs-number">283</span></span> <span class="hljs-number"><span class="hljs-number">284</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-number"><span class="hljs-number">285</span></span> <span class="hljs-number"><span class="hljs-number">286</span></span> <span class="hljs-number"><span class="hljs-number">287</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">limited_support_cookie_is_set</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-number"><span class="hljs-number">288</span></span> dbdev = os.getenv(<span class="hljs-string"><span class="hljs-string">'DBDEV'</span></span>) <span class="hljs-number"><span class="hljs-number">289</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dbdev <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> is_valid_time_limited_cookie(dbdev) build_number/environment.py</code> </pre> <br>  As can be seen from the <code>limited_support_cookie_is_set</code> method on line <code>287</code> , tracing is enabled only if the environment variable called <code>DBDEV</code> correctly set in a cookie with a limited lifetime.  Well, this is interesting!  And now we know how to generate such time-limited cookies.  Judging by the name, Dropbox engineers can generate such cookies, and then temporarily enable tracing in certain cases when it is required for customer support.  After you restart Dropbox or restart your computer, even if the specified cookie is still in place, it automatically expires.  I assume that this should prevent, for example, performance degradation due to continuous tracing.  It also makes it difficult to reverse develop Dropbox. <br><br>  However, a small script can simply constantly generate and set these cookies.  Something like that: <br><br><pre> <code class="python hljs"> <span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python3 def output_env(name, value): print("%s=%s; export %s" % (name, value, name)) def generate_time_cookie(): t = int(time.time()) c = 1686035233 s = "%.8x" % (t ^ c) h = md5(s.encode("utf-8?") + b"traceme").hexdigest() ret = "%s%s" % (s, h[:6]) return ret c = generate_time_cookie() output_env("DBDEV", c)</span></span></code> </pre> <br>  Then a time based cookie is created: <br><br><pre> <code class="python hljs"> $ python3 setenv.py DBDEV=<span class="hljs-number"><span class="hljs-number">38</span></span>b28b3f349714; export DBDEV;</code> </pre> <br>  Then correctly load the output of this script into the environment and run the Dropbox client. <br><br><pre> <code class="python hljs"> $ eval `python3 setenv.py` $ ~/.dropbox-dist/dropbox-lnx_64<span class="hljs-number"><span class="hljs-number">-71.4</span></span><span class="hljs-number"><span class="hljs-number">.108</span></span>/dropbox</code> </pre> <br>  This includes tracing output, with multi-colored formatting and all that.  It looks something like this unregistered client: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e83/d0a/a4f/e83d0aa4f475709108cb1cfc0cb16d74.png"><br><br><h3>  Introduction of a new code </h3><br>  All this is slightly amusing.  Studying further the decompiled code, we find <code>out/build_number/environment.pyc</code> .  There is a function that checks whether a certain magic key is installed.  This key is not hard coded in the code, but is compared with SHA-256 hash.  Here is the corresponding fragment. <br><br><pre> <code class="python hljs"> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> hashlib, os <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> typing <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Optional, Text <span class="hljs-number"><span class="hljs-number">3</span></span> _MAGIC_TRACE_KEY_IS_SET = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">magic_trace_key_is_set</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> _MAGIC_TRACE_KEY_IS_SET <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> _MAGIC_TRACE_KEY_IS_SET <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span> dbdev = os.getenv(<span class="hljs-string"><span class="hljs-string">'DBDEV'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(dbdev, Text): <span class="hljs-number"><span class="hljs-number">10</span></span> bytes_dbdev = dbdev.encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>) <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-number"><span class="hljs-number">12</span></span> bytes_dbdev = dbdev <span class="hljs-number"><span class="hljs-number">13</span></span> dbdev_hash = hashlib.sha256(bytes_dbdev).hexdigest() <span class="hljs-number"><span class="hljs-number">14</span></span> _MAGIC_TRACE_KEY_IS_SET = dbdev_hash == <span class="hljs-string"><span class="hljs-string">'e27eae61e774b19f4053361e523c771a92e838026da42c60e6b097d9cb2bc825'</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _MAGIC_TRACE_KEY_IS_SET</code> </pre> <br>  This method is repeatedly called from different places in the code to check if the magic key for tracing is installed.  I tried to crack the SHA-256 hash with <a href="https://www.openwall.com/john/">John the Ripper</a> brute force, but the brute force was taking too long, but I couldn‚Äôt reduce the number of options because there was no guesswork about the content.  In Dropbox, developers can have a specific hard-coded development key, which they install if necessary, by activating the client's mode with a ‚Äúmagic key‚Äù for tracing. <br><br>  It annoyed me because I wanted to find a quick and easy way to launch Dropbox with this key set for tracing.  Therefore, I wrote a marshaling procedure that generates pyc encrypted files according to Dropbox encryption.  Thus, I was able to enter my own code or simply replace the above hash.  This code in the repository on Github is in the <code>patchzip.py</code> file.  As a result, the hash is replaced by the SHA-256 hash <code>ANVILVENTURES</code> .  Then the code object is re-encrypted and placed in a zip where all obfuscated code is stored.  This allows you to do the following: <br><br><pre>  $ DBDEV = ANVILVENTURES;  export DBDEV;
     $ ~ / .dropbox-dist / dropbox-lnx_64-71.4.108 / dropbox </pre><br>  Now all debugging functions are displayed when you right-click on the Dropbox icon in the system tray. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/619/c68/385/619c6838574ff7023a0dbdf27b880b2d.png"></div><br><br>  Studying further decompiled sources, in the <code>dropbox/webdebugger/server.py</code> I found a method called <code>is_enabled</code> .  It looks like it checks to enable the built-in web debugger.  First of all, he checks the aforementioned magic key.  Since we replaced the SHA-256 hash, we can simply set the value of <code>ANVILVENTURES</code> .  The second part in lines <code>201</code> and <code>202</code> checks whether there is an environment variable named <code>DB&lt;x&gt;</code> , which has <code>x</code> equal to the SHA-256 hash.  The value of the environment sets cookies with a time limit, as we have already seen. <br><br><pre> <code class="python hljs"> <span class="hljs-number"><span class="hljs-number">191</span></span> @classmethod <span class="hljs-number"><span class="hljs-number">192</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_enabled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-number"><span class="hljs-number">193</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cls._magic_key_set: <span class="hljs-number"><span class="hljs-number">194</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cls._magic_key_set <span class="hljs-number"><span class="hljs-number">195</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-number"><span class="hljs-number">196</span></span> cls._magic_key_set = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-number"><span class="hljs-number">197</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> magic_trace_key_is_set(): <span class="hljs-number"><span class="hljs-number">198</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-number"><span class="hljs-number">199</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> var <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> os.environ: <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> var.startswith(<span class="hljs-string"><span class="hljs-string">'DB'</span></span>): <span class="hljs-number"><span class="hljs-number">201</span></span> var_hash = hashlib.sha256(make_bytes(var[<span class="hljs-number"><span class="hljs-number">2</span></span>:])).hexdigest() <span class="hljs-number"><span class="hljs-number">202</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> var_hash == <span class="hljs-string"><span class="hljs-string">'5df50a9c69f00ac71f873d02ff14f3b86e39600312c0b603cbb76b8b8a433d3ff0757214287b25fb01'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> is_valid_time_limited_cookie(os.environ[var]): <span class="hljs-number"><span class="hljs-number">203</span></span> cls._magic_key_set = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-number"><span class="hljs-number">204</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-number"><span class="hljs-number">205</span></span> <span class="hljs-number"><span class="hljs-number">206</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre> <br>  Using the exact same technique, replacing this hash with SHA-256, which was used before, we can now change the previously written <code>setenv</code> script to something like this: <br><br><pre> <code class="python hljs"> $ cat setenv.py ‚Ä¶ c = generate_time_cookie() output_env(<span class="hljs-string"><span class="hljs-string">"DBDEV"</span></span>, <span class="hljs-string"><span class="hljs-string">"ANVILVENTURES"</span></span>) output_env(<span class="hljs-string"><span class="hljs-string">"DBANVILVENTURES"</span></span>, c) $ python3 setenv.py DBDEV=ANVILVENTURES; export DBDEV; DBANVILVENTURES=<span class="hljs-number"><span class="hljs-number">38</span></span>b285c4034a67; export DBANVILVENTURES $ eval `python3 setenv.py` $ ~/.dropbox-dist/dropbox-lnx_64<span class="hljs-number"><span class="hljs-number">-71.4</span></span><span class="hljs-number"><span class="hljs-number">.108</span></span>/dropbox</code> </pre> <br>  As you can see, after the client starts, a new TCP port is opened for listening.  It will not open if the environment variables are not set correctly. <br><br><pre>  $ netstat --tcp -lnp |  grep dropbox
     tcp 0 0 127.0.0.1:4242 0.0.0.0:* LISTEN 1517 / dropbox </pre><br>  Further in the code, you can find the WebSocket interface in the <code>webpdb.pyc</code> file.  This is a wrapper for standard Python utilities <a href="https://docs.python.org/3.6/library/pdb.html">pdb</a> .  Access to the interface is provided via an HTTP server on this port.  Let's install <a href="https://github.com/vi/websocat">the websocket client</a> and test it: <br><br><pre>  $ websocat -t ws: //127.0.0.1: 4242 / pdb
     --Return--
    
     &gt; /home/gvb/dropbox/webdebugger/webpdb.pyc(101)run()-&gt;None
     &gt;
     (Pdb) from build_number.environment import magic_trace_key_is_set as ms
     (Pdb) ms ()
     True </pre><br>  Thus, we now have a full-fledged debugger in the client, which in all other respects works as before.  We can execute arbitrary Python code, we managed to turn on the internal debugging menu and trace functions.  All this will greatly help in the further analysis of the Dropbox client. <br><br><h3>  Conclusion </h3><br>  We managed to do the reverse development of Dropbox, write decryption and code injection tools that work with current Dropbox clients based on Python 3.6.  We did reverse engineering of separate hidden functions and activated them.  Obviously, the debugger will really help in further hacking.  Especially with a number of files that can not be successfully decompiled due to the shortcomings of decompyle6. <br><br><h3>  Code </h3><br>  The code can be found <a href="https://github.com/anvilventures/lookinsidethebox">on Github</a> .  Instructions for use there.  This repository also contains my old code, written in 2011.  It should work with only a few modifications, provided that someone has older versions of Dropbox based on Python 2.7. <br><br>  The repository also contains scripts for broadcasting opcodes, instructions for setting the Dropbox environment variables and everything you need to change the zip file. <br><br><h3>  Acknowledgments </h3><br>  Thanks to Brian from Anvil Ventures for reviewing my code.  Work on this code lasted for several years, from time to time I updated it, introduced new methods and rewrote fragments in order to restore its work on new versions of Dropbox. <br><br>  As mentioned earlier, an excellent starting point for reverse engineering applications in Python is the work of Rich Smith, Florian Ledoux and Nicolas Raff, as well as Hagen Fritsch.  Especially their work is relevant for the reverse development of one of the largest Python applications in the world - the Dropbox client. <br><br>  It should be noted that the decompilation of the Python code was greatly advanced thanks to the uncompyle6 project headed by R. Bernstein.  This decompiler builds and improves many different Python decompilers. <br><br>  Thanks also to colleagues Brian, Austin, Stefan and Chris for reviewing this article. </div><p>Source: <a href="https://habr.com/ru/post/452276/">https://habr.com/ru/post/452276/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../452258/index.html">Corda - open source blockchain for business</a></li>
<li><a href="../452262/index.html">Angular: library creation and publishing</a></li>
<li><a href="../452264/index.html">How we made the site for the Mascots auto award</a></li>
<li><a href="../452266/index.html">Serverless racks</a></li>
<li><a href="../452272/index.html">Girl under the waterfall</a></li>
<li><a href="../452278/index.html">Bluetooth LE is not so scary, or How to improve user experience effortlessly</a></li>
<li><a href="../452280/index.html">PostgreSQL 11: The Evolution of Partitioning from Postgres 9.6 to Postgres 11</a></li>
<li><a href="../452282/index.html">Elementary, Watson: you integrate with Voximplant</a></li>
<li><a href="../452284/index.html">The classification of land cover using eo-learn. Part 1</a></li>
<li><a href="../452288/index.html">Situation: US mobile operators accused of illegal sale of subscribers geodata</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>