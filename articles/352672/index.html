<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JVM contract programming</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! I present to your attention the translation of the article " Programming by contract on the JVM " by Nicolas Fr√§nkel. 

 This week I would l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JVM contract programming</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr!  I present to your attention the translation of the article " <a href="https://blog.frankel.ch/programming-by-contract-jvm/">Programming by contract on the JVM</a> " by Nicolas Fr√§nkel. <br><a name="habracut"></a><br>  This week I would like to take an interesting approach that I rarely saw, but it is very useful. <br><br><div class="spoiler">  <b class="spoiler_title">Wikipedia</b> <div class="spoiler_text"><blockquote>  Contract design, also known as contract programming, is an approach to software development.  It requires software developers to define formal, accurate, and proven interface specifications for software components that extend the usual definition of abstract data types with preconditions, postconditions, and invariants.  These specifications are called "contracts", in accordance with the conceptual metaphor with the terms and obligations of business contracts. <br>  <a href="https://en.wikipedia.org/wiki/Design_by_contract">Wikipedia</a> <br></blockquote><br></div></div><br>  In essence, the conditions interrupt work.  It makes no sense to run the code, if at the end, the calculation fails due to an incorrect assumption. <br><br>  Let's look at an example of a transfer operation between two bank accounts.  Here are some conditions: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Pre-conditions:</b> <br><br><ul><li>  The amount transferred must be positive. </li></ul><br>  <b>Constants:</b> <br><br><ul><li>  The original bank account must have a positive balance. </li></ul><br>  <b>Post conditions:</b> <br><br><ul><li>  The balance of the original bank account must be equal to the initial balance, minus the amount of the transfer. </li><li>  The balance of the target bank account must be equal to the initial balance plus the amount transferred. </li></ul><br><h3>  "Manual" implementation </h3><br>  It is easy to implement pre-and post-conditions "manually": <br><br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transfer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Account source, Account target, BigDecimal amount)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (amount.compareTo(BigDecimal.ZERO) &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgument(<span class="hljs-string"><span class="hljs-string">"Amount transferred must be higher than zero ("</span></span> + amount + <span class="hljs-string"><span class="hljs-string">")"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (source.getBalance().compareTo(BigDecimal.ZERO) &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgument(<span class="hljs-string"><span class="hljs-string">"Source account balance must be higher than zero ("</span></span> + source.getBalance() + <span class="hljs-string"><span class="hljs-string">")"</span></span>; } source.transfer(target, amount); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (source.getBalance().compareTo(BigDecimal.ZERO) &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalState(<span class="hljs-string"><span class="hljs-string">"Source account balance must be higher than zero ("</span></span> + source.getBalance() + <span class="hljs-string"><span class="hljs-string">")"</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// Other post-conditions... }</span></span></code> </pre> <br>  Such code is cumbersome and difficult to read. <br><br><h3>  Java implementation </h3><br>  You may have already worked with pre and post conditions using the <b>assert</b> keyword <b>:</b> <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transfer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Account source, Account target, BigDecimal amount)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> (amount.compareTo(BigDecimal.ZERO) &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> (source.getBalance().compareTo(BigDecimal.ZERO) &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>); source.transfer(target, amount); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> (source.getBalance().compareTo(BigDecimal.ZERO) &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">// Other post-conditions... }</span></span></code> </pre> <br>  There are several problems with the Java approach: <br><br><ol><li>  There is no difference between pre and post conditions. </li><li>  The code must be run using the <code><b>-ea</b></code> start <code><b>-ea</b></code> </li></ol><br>  <a href="https://docs.oracle.com/cd/E19683-01/806-7930/assert-13/index.html">Oracle's documentation</a> clearly indicates this: <br><blockquote>  Although the assert construct is not a complete contract construct, it can help support informal contract programming style. </blockquote><h3>  Alternative Java implementation </h3><br>  Starting in Java 8, the <code><b>Objects</b></code> class offers three methods that impose restrictions on contract programming: <br><br><ol><li><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requireNonNull</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T obj)</span></span></span></span></code> </pre> </li><li><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requireNonNull</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T obj, String message)</span></span></span></span></code> </pre> </li><li><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requireNonNull</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T obj, Supplier&lt;String&gt; messageSupplier)</span></span></span></span></code> </pre> </li></ol><br><blockquote>  The <code>Supplier</code> argument in the last method returns an error message. </blockquote>  All 3 methods throw a <code>NullPointerException</code> if <code>obj</code> is <code>null</code> . <br><br>  More interesting is what they return if <code>obj</code> not <code>null</code> .  This leads to the following code view: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transfer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Account source, Account target, BigDecimal amount)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (requireNonNull(amount).compareTo(BigDecimal.ZERO) &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgument(<span class="hljs-string"><span class="hljs-string">"Amount transferred must be higher than zero ("</span></span> + amount + <span class="hljs-string"><span class="hljs-string">")"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (requireNonNull(source).getBalance().compareTo(BigDecimal.ZERO) &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgument(<span class="hljs-string"><span class="hljs-string">"Source account balance must be higher than zero ("</span></span> + source.getBalance() + <span class="hljs-string"><span class="hljs-string">")"</span></span>; } source.transfer(target, amount); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (requireNonNull(source).getBalance().compareTo(BigDecimal.ZERO) &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalState(<span class="hljs-string"><span class="hljs-string">"Source account balance must be higher than zero ("</span></span> + source.getBalance() + <span class="hljs-string"><span class="hljs-string">")"</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// Other post-conditions... }</span></span></code> </pre> <br>  Not only does this impose limitations, it also degrades the readability of the code, especially if you add the error message argument. <br><br><h3>  Implementations for certain frameworks </h3><br>  <b><a href="https://projects.spring.io/spring-framework/">The Spring Framework</a></b> provides the <code>Assert</code> class, which offers a variety of state checking methods: <br><br><img src="https://habrastorage.org/webt/ij/ce/1s/ijce1skwzxw6wqcavydzfkxfu9m.png"><br><br>  In accordance with custom implementations, pre-conditions checks raise an <code>IllegalArgumentException</code> if the condition is not met, while checks after the state throw an <code>IllegalStateException</code> exception. <br><br>  The Wikipedia page above also lists several contract programming frameworks: <br><br><ul><li>  <a href="http://oval.sourceforge.net/">Oval</a> </li><li>  <a href="https://github.com/nhatminhle/cofoja">Contracts for Java</a> </li><li>  <a href="https://en.wikipedia.org/wiki/Java_Modeling_Language">Java Modeling Language</a> </li><li>  <a href="https://en.wikipedia.org/wiki/Bean_Validation">Bean validation</a> </li><li>  <a href="http://www.valid4j.org/">valid4j</a> </li></ul><br>  Most of the above frameworks are based on annotations. <br><br><h3>  Pros and cons of annotations </h3><br>  Let's start with the pros: annotations make the conditions obvious. <br><br>  On the other hand, annotations are not without flaws: <br><br><ul><li>  They require bytecode manipulation either at compile time or at run time. </li><li>  They are quite limited in scope (e.g. <a href="https://habrahabr.ru/users/email/" class="user_link">Email</a> ) </li><li>  Translate to an external language that is configured as an attribute of the annotation string </li></ul><br><h3>  Kotlin approach </h3><br>  Contract programming on <b>Kotlin</b> is based on simple method calls, grouped in the <code>Preconditions.kt:</code> file <code>Preconditions.kt:</code> <br><br><img src="https://habrastorage.org/webt/w7/pq/uv/w7pquvpeuse82t9seloavpedip4.png"><br><br><ul><li>  <code>require</code> methods implement preconditions, and if not, then <code>IllegalArgumentException</code> will be thrown. </li><li>  <code>check</code> methods implement post-conditions, and if not, then <code>IllegalStateException</code> will be thrown <code>IllegalStateException</code> </li></ul><br>  Rewriting the parent fragment with <b>Kotlin is</b> quite simple: <br><br><pre> <code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transfer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(source: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Account</span></span></span></span><span class="hljs-function"><span class="hljs-params">, target: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Account</span></span></span></span><span class="hljs-function"><span class="hljs-params">, amount: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">BigDecimal</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { require(amount &lt;= BigDecimal.ZERO) require(source.getBalance() &lt;= BigDecimal.ZERO) source.transfer(target, amount); check(source.getBalance() &lt;= BigDecimal.ZERO) <span class="hljs-comment"><span class="hljs-comment">// Other post-conditions... }</span></span></code> </pre> <br><h3>  Conclusion </h3><br>  Since this is a frequent case, the simpler the better.  Simply by wrapping the check and throwing exceptions into the method, you can easily use contract-based programming.  Although these shells are not available in <b>Java, valid4j</b> and <b>Kotlin</b> offer them. <br><br>  Thank you for your attention, see you soon! </div><p>Source: <a href="https://habr.com/ru/post/352672/">https://habr.com/ru/post/352672/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352662/index.html">Startups and Microsoft: Venture, Hubs, and That's All</a></li>
<li><a href="../352664/index.html">Gradient text length limit</a></li>
<li><a href="../352666/index.html">Use of arbitrary DataFlash of the 25th series instead of expensive Altera FPGA configurators without additional hardware</a></li>
<li><a href="../352668/index.html">"The Internet has become a bit safer": IETF approved TLS 1.3</a></li>
<li><a href="../352670/index.html">How HFT trading contributes to stock market crashes</a></li>
<li><a href="../352674/index.html">Election logo for 37 million VS. for 75 thousand</a></li>
<li><a href="../352676/index.html">Hidden order in color chaos</a></li>
<li><a href="../352678/index.html">NumPy in Python. Part 1</a></li>
<li><a href="../352680/index.html">9 paid, shareware and free programs for tracking application code</a></li>
<li><a href="../352682/index.html">Rsyslog 8. Centralized logging</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>