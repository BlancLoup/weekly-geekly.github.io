<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Materialized views as a means of controlling data integrity.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Data integrity control is one of the most important functions of a DBMS. The more carefully this control is organized, the easier it is to implement t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Materialized views as a means of controlling data integrity.</h1><div class="post__text post__text-html js-mediator-article">  Data integrity control is one of the most important functions of a DBMS.  The more carefully this control is organized, the easier it is to implement the applied logic, because the more restrictions are controlled by the database, the fewer ‚Äúwhat if‚Äù variations should be foreseen when implementing the logic.  At the same time, integrity monitoring is quite convenient to use and to verify the correctness of the application layer.  Something like unit tests.  ‚ÄúExtra‚Äù verification, sometimes can serve a very good service. <br><br>  The traditional set of restrictions - the restriction of primary, foreign keys, uniqueness when using normalization allows to satisfy the vast majority of cases of control needs.  However, in the case where the restriction is dependent on the values ‚Äã‚Äãin several tables and rows, these tools are not enough.  Such constraints have to be implemented by trigger logic.  And implementation is not always simple.  The developer has to keep in mind that data modification can be carried out in a competitive environment, so you need to take care of locking resources yourself, while also trying to avoid mutual locks.  Implementing a row constraint may require access to other rows of the same table, which in turn is a platform constraint ‚Äî Oracle does not allow access to the currently mutable data set. <br><br>  But there is another way.  In some cases, it is possible to use restrictions imposed on materialized views that are updated upon the completion of transactions (fast refresh on commit).  Such restrictions will work as deferred and will not allow the transaction to be committed if the integrity of the data is suddenly violated.  In the context of a modifying transaction, restrictions may be violated.  On the one hand, this simplifies data modification, on the other hand, it makes it difficult to identify the source of the error.  In this article I would like to give a couple of simple examples of the implementation of such restrictions. <br><a name="habracut"></a><br><h4>  Formulation of the problem </h4><br>  I would like to show the implementation of the approach on a simplified fictional example.  It turned out to be quite difficult to find such an example so that it was simple enough for perception, but at the same time, so that the application of the approach was justified, do not blame me if something suddenly happened wrong. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Suppose we have the need to account for the goods in the context of the placement zone.  The location in this case is the store (S) or warehouse (W). <br><br>  Zone - physical or logical territory of each specific location.  For example, a trading hall, or even shelves of a trading hall, a material room, a refrigerator, a zone of lost goods.  Each location can have more than one zone of each type, but one zone of each type must necessarily be marked as primary.  It will be used by default if the zone of operation is not explicitly defined.  The main zone must be one and only one for each type of zone.  This will be the first kind of restriction that we will try to implement. <br><br>  The second type of restriction is the composition of the zones.  In our example, we limit ourselves to setting the rules for the three types of zones: <br><ul><li>  Storage zone (K) - the zone in which the goods are stored; this zone is mandatory for the warehouse, but can also be defined for the store. </li><li>  The area of ‚Äã‚Äãthe sales area (S) is mandatory for the store and cannot be determined for the warehouse </li><li>  The zone of the lost commodity (L) - the logical zone to which the commodity will move, the status of which is not clear, needs clarification.  Mandatory for both warehouse and store </li></ul><br>  Each posting record can be in three states - draft (W), active (A), not active (I).  When the record is in the ‚ÄúDraft‚Äù state, we give the user the greatest freedom of action and allow violating this restriction. <br><br><h4>  Implementation </h4><br><h5>  tables </h5><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> location ( loc <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> ,loc_type varchar2(<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> (loc_type <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-string"><span class="hljs-string">'S'</span></span>,<span class="hljs-string"><span class="hljs-string">'W'</span></span>)) ,<span class="hljs-keyword"><span class="hljs-keyword">status</span></span> varchar2(<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">status</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-string"><span class="hljs-string">'W'</span></span>,<span class="hljs-string"><span class="hljs-string">'A'</span></span>,<span class="hljs-string"><span class="hljs-string">'I'</span></span>)) ,loc_desc varchar2(<span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> zone( zone <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> ,loc <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">references</span></span> location(loc) ,is_pirmary <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> (is_pirmary <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-string"><span class="hljs-string">'Y'</span></span>,<span class="hljs-string"><span class="hljs-string">'N'</span></span>)) ,zone_type varchar2(<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> ,zone_desc varchar2(<span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> location <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">'S'</span></span>,<span class="hljs-string"><span class="hljs-string">'W'</span></span>,<span class="hljs-string"><span class="hljs-string">' 1  '</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> zone <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">'Y'</span></span>,<span class="hljs-string"><span class="hljs-string">'K'</span></span>,<span class="hljs-string"><span class="hljs-string">'   1'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> zone <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">'Y'</span></span>,<span class="hljs-string"><span class="hljs-string">'S'</span></span>,<span class="hljs-string"><span class="hljs-string">'   1'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> zone <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">'Y'</span></span>,<span class="hljs-string"><span class="hljs-string">'L'</span></span>,<span class="hljs-string"><span class="hljs-string">'    1'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>;</code> </pre> <br><br><h4>  Limiting the number of main zones </h4><br>  To implement this restriction, we will create a materialized representation that will calculate the main zones for each type of placement zone, and from above we will impose a restriction that controls strict equality to the unit of the calculated value.  For queries, on the basis of which the materialized views are built, a number of <a href="http://download.oracle.com/docs/cd/E11882_01/server.112/e25554/basicmv.htm">restrictions are defined</a> , which, in addition, is strongly tightened by imposing the <a href="http://download.oracle.com/docs/cd/E11882_01/server.112/e25554/basicmv.htm">requirements for updating the fast method</a> .  In our case, we have an aggregate materialized view, and therefore we need to create a materialized view log for the zone table, including rowid and new values, the list of fields of which should include all values ‚Äã‚Äãthat can affect the query result <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">materialized</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> zone <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rowid</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> (zone,loc,zone_type,is_primary) <span class="hljs-keyword"><span class="hljs-keyword">including</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span></code> </pre><br>  We are also obliged to include in the result returned by the query the value of "count (*)" <br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">materialized</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> mv$zoneloc_pimary$chk <span class="hljs-keyword"><span class="hljs-keyword">refresh</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fast</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> loc ,zone_type ,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">decode</span></span>(is_primary,<span class="hljs-string"><span class="hljs-string">'Y'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>)) primary_count ,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) cnt <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> zone <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> loc,zone_type;</code> </pre><br>  It should be noted here: in order to evaluate whether a materialized view built on demand can be used to update the fast method, there is a <a href="http://download.oracle.com/docs/cd/E11882_01/server.112/e25554/basicmv.htm">dbms_mivew.explain_mview</a> procedure.  It is highly desirable to use it to control whether the fast update method is available for presentation.  For example, if we had forgotten to specify count (*) in the query, the materialized view would have been successfully created and worked correctly when performing an insert operation.  However, if modified, deleted, the value of primary_count would not be recalculated, which would violate the logic of our restriction.  However, if we use explain_mview, oracle will helpfully tell us our miscalculation. <br><pre> <code class="sql hljs"> SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> serveroutput <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">result</span></span> SYS.ExplainMVArrayType; 3 <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> dbms_mview.explain_mview(mv =&gt; <span class="hljs-string"><span class="hljs-string">'select loc 5 ,zone_type 6 ,count(decode(is_primary,''Y'',1)) primary_counnt 7 --,count(*) cnt 8 from zone 9 group by loc,zone_type'</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> ,msg_array =&gt; <span class="hljs-keyword"><span class="hljs-keyword">result</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> ); 12 for i in 1..result.count 13 loop 14 dbms_output.put(rpad(result(i).capability_name,30,' ')); 15 dbms_output.put(' '||result(i).POSSIBLE); 16 dbms_output.put(' '||result(i).MSGTXT); 17 dbms_output.put_line(null); 18 <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; 19 <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; 20 / PCT F REFRESH_COMPLETE T REFRESH_FAST T REWRITE T PCT_TABLE F relation is not a partitioned table REFRESH_FAST_AFTER_INSERT T REFRESH_FAST_AFTER_ONETAB_DML F COUNT(*) is not present in the <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> REFRESH_FAST_AFTER_ANY_DML F see the reason why REFRESH_FAST_AFTER_ONETAB_DML <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> disabled REFRESH_FAST_PCT F PCT <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the detail <span class="hljs-keyword"><span class="hljs-keyword">tables</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">materialized</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> REWRITE_FULL_TEXT_MATCH T REWRITE_PARTIAL_TEXT_MATCH T REWRITE_GENERAL T REWRITE_PCT F <span class="hljs-keyword"><span class="hljs-keyword">general</span></span> rewrite <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> PCT <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the detail <span class="hljs-keyword"><span class="hljs-keyword">tables</span></span> PCT_TABLE_REWRITE F relation <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> a partitioned <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> PL/<span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> successfully completed</code> </pre><br>  So, the materialized view is created, it remains only to add the restriction <br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> mv$zoneloc_pimary$chk <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> zone_loc_primary$chk <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> (primary_count=<span class="hljs-number"><span class="hljs-number">1</span></span>) deferrable <span class="hljs-keyword"><span class="hljs-keyword">initially</span></span> <span class="hljs-keyword"><span class="hljs-keyword">deferred</span></span>;</code> </pre><br>  Please note that the restriction is created by deferred.  The fact is that in the process of updating the view of the Oracle, at some intermediate stage, it may turn out that the restriction will be temporarily violated.  To avoid such false positives, it is better to set such restrictions deliberately delayed. <br><br>  Check the work of this restriction. <br><pre> <code class="sql hljs"> SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> location <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-string"><span class="hljs-string">'S'</span></span>,<span class="hljs-string"><span class="hljs-string">'W'</span></span>,<span class="hljs-string"><span class="hljs-string">' 2     '</span></span>); 1 row inserted SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">Commit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">complete</span></span></code> </pre><br>  Let's try to create a zone with a type that does not have a ‚Äúprimary‚Äù mark. <br><pre> <code class="sql hljs"> SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> zone <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-string"><span class="hljs-string">'N'</span></span>,<span class="hljs-string"><span class="hljs-string">'S'</span></span>,<span class="hljs-string"><span class="hljs-string">'    '</span></span>); 1 row inserted SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>; ORA-02091: transaction rolled back ORA-02290: <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> (ZTXN.ZONE_LOC_PRIMARY$CHK) violated</code> </pre><br>  We will try to identify two main areas for placement with the same type. <br><pre> <code class="sql hljs"> SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> zone <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-string"><span class="hljs-string">'Y'</span></span>,<span class="hljs-string"><span class="hljs-string">'L'</span></span>,<span class="hljs-string"><span class="hljs-string">'    '</span></span>); 1 row inserted SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">Commit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">complete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> zone <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-string"><span class="hljs-string">'Y'</span></span>,<span class="hljs-string"><span class="hljs-string">'L'</span></span>,<span class="hljs-string"><span class="hljs-string">'    '</span></span>); 1 row inserted SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>; ORA-02091: transaction rolled back ORA-02290: <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> (ZTXN.ZONE_LOC_PRIMARY$CHK) violated</code> </pre><br><h4>  Restriction of the composition of the zones of placement </h4><br>  This limitation differs from the previous one in that it relies on the values ‚Äã‚Äãof not one table, but two.  Those.  At the same time, it is necessary to satisfy the requirements of the fast update method for <a href="http://download.oracle.com/docs/cd/E11882_01/server.112/e25554/basicmv.htm">views with connections</a> and <a href="http://download.oracle.com/docs/cd/E11882_01/server.112/e25554/basicmv.htm">aggregate views</a> .  But this is impossible.  We cannot simultaneously output the rowid of the attached row and count (*) into the result.  For this reason, it is necessary to build a cascade of materialized views.  In one, the data sets will be joined, in the other - aggregation. <br><br>  First you need to create a materialized veiw log for the placement table.  For the zone table, the previously created log will be used. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">materialized</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> location <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rowid</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> (loc,loc_type,<span class="hljs-keyword"><span class="hljs-keyword">status</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">including</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>;</code> </pre><br>  Next, create join mivew.  Unfortunately, the ANSI syntax here does not perceive oracle, use the old-style join. <br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">materialized</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> mv$location$zone$<span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">refresh</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fast</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> l.loc ,l.loc_type ,z.zone ,z.zone_type ,l.rowid l_rowid ,z.rowid z_rowid <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> location l ,zone z <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> z.loc(+) = l.loc <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> l.status <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-string"><span class="hljs-string">'A'</span></span>,<span class="hljs-string"><span class="hljs-string">'I'</span></span>)</code> </pre><br>  Create a materialized veiw log for the join view. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">materialized</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> mv$location$zone$<span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rowid</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> (loc,loc_type,zone_type) <span class="hljs-keyword"><span class="hljs-keyword">including</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>;</code> </pre><br>  Create an aggregated materialized view <br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">materialized</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> mv$location$zone$agg <span class="hljs-keyword"><span class="hljs-keyword">refresh</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fast</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> loc ,loc_type ,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">decode</span></span>(zone_type,<span class="hljs-string"><span class="hljs-string">'K'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>)) K_cnt ,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">decode</span></span>(zone_type,<span class="hljs-string"><span class="hljs-string">'S'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>)) S_cnt ,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">decode</span></span>(zone_type,<span class="hljs-string"><span class="hljs-string">'L'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>)) L_cnt ,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) cnt <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> mv$location$zone$<span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> loc,loc_type;</code> </pre><br>  Well, the limitations themselves <br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> mv$location$zone$agg <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> wh_zones_chk <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>(loc_type != <span class="hljs-string"><span class="hljs-string">'W'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> K_cnt &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> S_cnt = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> L_cnt &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) deferrable <span class="hljs-keyword"><span class="hljs-keyword">initially</span></span> <span class="hljs-keyword"><span class="hljs-keyword">deferred</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> mv$location$zone$agg <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> store_zones_chk <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>(loc_type != <span class="hljs-string"><span class="hljs-string">'S'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> K_cnt &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> S_cnt &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> L_cnt &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) deferrable <span class="hljs-keyword"><span class="hljs-keyword">initially</span></span> <span class="hljs-keyword"><span class="hljs-keyword">deferred</span></span>;</code> </pre><br>  Check for restrictions: <br><br><pre> <code class="sql hljs"> SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> location (loc,loc_type,<span class="hljs-keyword"><span class="hljs-keyword">status</span></span>,loc_desc) <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-string"><span class="hljs-string">'S'</span></span>,<span class="hljs-string"><span class="hljs-string">'W'</span></span>,<span class="hljs-string"><span class="hljs-string">' 3    '</span></span>); 1 row inserted SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">Commit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">complete</span></span></code> </pre><br>  Placement successfully created in the status of "draft".  Let's try to activate it: <br><pre> <code class="sql hljs"> SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> location <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-string"><span class="hljs-string">'A'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> loc = <span class="hljs-number"><span class="hljs-number">3</span></span>; 1 row updated SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>; ORA-02091: transaction rolled back ORA-02290: <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> (ZTXN.STORE_ZONES_CHK) violated</code> </pre><br>  Not.  You cannot activate a location if the necessary zones for its type are not defined for it. <br><pre> <code class="sql hljs"> SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> zone(zone,loc,is_primary,zone_type) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-string"><span class="hljs-string">'Y'</span></span>,<span class="hljs-string"><span class="hljs-string">'S'</span></span>); 1 row inserted SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> zone(zone,loc,is_primary,zone_type) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-string"><span class="hljs-string">'Y'</span></span>,<span class="hljs-string"><span class="hljs-string">'L'</span></span>); 1 row inserted SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> location <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-string"><span class="hljs-string">'A'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> loc = <span class="hljs-number"><span class="hljs-number">3</span></span>; 1 row updated <span class="hljs-keyword"><span class="hljs-keyword">Commit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">complete</span></span></code> </pre><br><br><h4>  Conclusion </h4><br><h5>  When to use it </h5>  First of all, when the connection is so complicated that there is a high risk that the application developer will not be able to take everything into account, but the mismatch is critical.  I used this approach for the first time when I designed a structure that was looped to itself by foreign keys through seven tables.  Moreover, these tables are maintained by different business units.  This restriction stands to this day.  To this day, users find loopholes, send screenshots when this restriction works, and it‚Äôs impossible to reproduce to close the loophole in the application module, it requires a combination of circumstances from several users. <br><br>  It is very convenient to have such restrictions at the stage of testing, starting, stabilizing projects, when there is not enough confidence in the correctness of the logic, and the data can be modified by the application link. <br><br><h5>  When not to use it </h5><br>  Obviously, this approach should not be used in cases where it gives a noticeable performance drop. <br><br>  In case of modification, refinement of the data scheme, the contents of the views may not be reliable and will require a complete update.  If the time for a complete update of the materialized view can jeopardize the implementation of technical work regulations, you probably should not use this approach either. </div><p>Source: <a href="https://habr.com/ru/post/132727/">https://habr.com/ru/post/132727/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../132720/index.html">Content providers. Interaction with contacts</a></li>
<li><a href="../132721/index.html">Games, squeezed out of the NES maximum (part 3, final)</a></li>
<li><a href="../132723/index.html">Panasonic KX-TGP500 DECT</a></li>
<li><a href="../132725/index.html">Coin keeper. C # iPhone Application</a></li>
<li><a href="../132726/index.html">Manage a large group of hosts using http requests</a></li>
<li><a href="../132728/index.html">A practical example of using Backbone</a></li>
<li><a href="../132729/index.html">Introduction to ASP.NET MVC 4 New Features</a></li>
<li><a href="../132730/index.html">Slowly but surely Cleverbot bypasses Suzette</a></li>
<li><a href="../132731/index.html">SMS templates for programmers</a></li>
<li><a href="../132733/index.html">Project Moonshot: 2800 servers in one rack</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>