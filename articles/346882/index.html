<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Autopilot simulation on a flight simulator</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Is it possible to use a longitudinally located semiconductor gyroscope, which measures the angular speed of the turn of the aircraft, to keep the roll...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Autopilot simulation on a flight simulator</h1><div class="post__text post__text-html js-mediator-article"><p>  Is it possible to use a longitudinally located semiconductor gyroscope, which measures the angular speed of the turn of the aircraft, to keep the roll?  Let's check it on the flight simulator with an external autopilot.  And I would also like to check the aircraft control algorithms.  This capability is provided by the XPLANE flight simulator. </p><br><img src="https://habrastorage.org/webt/km/68/yb/km68ybdyglongwl4wmop2igxwl8.png"><br><p>  Pic1 </p><br><p>  Why XPLANE?  It allows you to output data from the sensors of a simulated aircraft <a name="habracut"></a>  into other programs or computers by various means.  I chose the UDP protocol for this.  In fig.  1 shows a block diagram of a simulation complex.  An example of one flight can be seen in the <a href="https://youtu.be/RyEb5jrwmR0">video</a> .  The video shows a manual take-off, the withdrawal of an aircraft from a corkscrew during a fall, a flight along the route, turns with loss of height and climb, the landing of the aircraft, manual control of the course and height, and also contains instructions for setting up the X-Plane simulator and autopilot program. </p><br><h2 id="ppjoy-i-vspe">  PPJOY and VSPE </h2><br><p>  To control the aircraft in simulators is usually used a joystick.  For training in the management of radio-controlled aircraft are also used appropriate simulators.  For interfacing standard remote controls with simulators, there is a PPJOY program that converts the input data stream of an RS232 interface created by certain rules into control signals of a virtual joystick.  The program also contains the driver, which is defined in the system as a joystick.  Program description PPJOY can be found in the public domain on the Internet.  <a href="https://yadi.sk/d/m_bviJxl3RSAQf">Here</a> you can find a program that can work with Win7.  Unfortunately, the driver (64b) included in the program does not have a digital signature and therefore has to run the system in test mode.  The standard stream for PPJOY is usually formed by a special module on some controller (for example, PIC), which is connected to the output of the ‚Äútrainer‚Äù of the remote control, where the PPM protocol is used.  In this project, the autopilot program forms the stream in accordance with the RS232 standard.  The development began with the closure of the OS loop through the external physical COM ports of the computer.  At the same time it is possible to use different computers for the simulator and autopilot, which is important for very weak computers.  Now, due to the massive absence of COM ports on computers and a sufficiently high power of computers, when even the weakest computers are able to work in such a system, the <a href="https://yadi.sk/d/BkXdM8Qw3RE7So">VSPE</a> (Virtual Serial Port Emulator) program is used.  The program allows you to create a pair of ports inside the computer, and not use external ports.  For normal operation of the program, you will probably first have to create the appropriate COM ports using Windows tools, and then you can use them in the VSPE and PPJOY programs.  Hardware converters for radio remote controls appeared with different conversion rules, therefore it is necessary to select the mode with a frequency of 19200 bps in the PPJOY program.  This option is implemented in the autopilot program. </p><br><h2 id="udp">  UDP </h2><br><p>  To receive data from the sensors of the X-Plane aircraft, the simulator is configured in the mode of issuing data via a network UDP protocol.  To do this, as shown in the <a href="https://youtu.be/RyEb5jrwmR0">movie</a> , configure the simulator to output data from the aircraft‚Äôs ‚Äúsensors‚Äù via the network to the selected IP address and the specified port.  In this case, the local IP address is 127.0.0.1 and port 49001 and data is output at a rate of 20 times per second.  In addition to this setting, you must correctly select the sensors from which you want to transfer data to the autopilot.  It is necessary in the simulator to establish the output field 02 (speed, vertical speed), 16 (angular velocity), 17 (pitch, roll, courses) and 18 (latitude, longitude, altitude).  You can also customize the display of these parameters on the screen. </p><br><h2 id="avtopilot">  Autopilot </h2><br><p>  <a href="https://yadi.sk/d/0GfviFgA3REpXY">The autopilot program is</a> written in the Borland C ++ Builder 6 environment. The "Instruments" field (Fig.11) shows the initial data from the sensors, which are updated 20 times per second.  Here we see the Pitch (Pitch, degrees), which is calculated by the accelerometer in the radio-controlled aircraft, Roll (Roll, degrees), which is calculated by the longitudinal gyro measuring the turn speed of the aircraft.  It should be noted here that the pitch in the simulator I take here is real, and not from the accelerometer, although in a real airplane I calculate the pitch from the accelerometer, which means that the sharp acceleration during acceleration will ‚Äúfeel‚Äù as an additive to the positive pitch.  This is clearly seen in the <a href="https://www.youtube.com/watch%3Fv%3D1JnekoKoK_g">video fragments of the</a> tests: when it accelerates, the plane immediately raises its tail.  This is different from reality.  But the roll is really calculated by the angular velocity of the turn of the aircraft.  The calculated value of the roll and is shown in the form of a conditional artificial horizon in the lower right corner of the program.  (Fig.2) The pitch value shows the slider in the center of the artificial horizon.  The next window is the air speed, the value of which is usually obtained from the Pitot tube, the next window is the course we receive from the magnetic compass, the next field is the height.  Below is a GPS panel. </p><br><img src="https://habrastorage.org/webt/vf/an/vj/vfanvjn_xawveassjfq5y_hdjea.jpeg"><br><p>  Fig.  2 </p><br><p>  Checkbox GPS includes flight on the route recorded in the table.  At the same time, the fields Requested Heading, Requested Altitude and Requested Speed ‚Äã‚Äãare automatically filled from the structure <br>  typedef struct WPNT {int pid;  int speed;  int altitude;  int heading;  int latitude;  int longitude;  } WPNT; </p><br><p>  In the demo, the structure contains an example of a route near Los Angeles Airport.  (Pic 3) <br>  To change the route, you need to change the structure and recompile the <a href="https://yadi.sk/d/eAAKxHUm3REmtN">project</a> .  If GPS is off, these fields can be filled in manually.  Activation of the value in the field occurs when you double-click the mouse.  Checkbox Return allows you to return to the point memorized when you press the Store Point button. </p><br><img src="https://habrastorage.org/webt/aj/fa/uv/ajfauvggebz-oqiy4_c701vnrxa.jpeg"><br><p>  Pic.3 </p><br><p>  WayPoint - the number of the route point;  Distance - distance to the next waypoint;  Calculated Time is an approximate time to reach the next point (approximately because the wind speed is not taken into account), and then the GPS coordinates are latitude-longitude.  Top right, the UDP server panel.  Below is the RS232 port control panel.  Here you should change only the port number.  The remaining parameters are strictly defined by the interaction with the virtual joystick. </p><br><p>  Autopilot panel options: </p><br><p>  Legend: RW - change allowed, RO - only for look, RWP- change allowed partially <br>  Kst_roll (RW) - static OS loop gain (feedback) for roll <br>  Kast_roll (RW) -astatic OS Loop Gain <br>  Kfar_roll (RW) - roll trimming ratio <br>  Kst_hdg (RW) - static gain for keeping course <br>  Kast_hdg (RW) ‚ÄîAstatic Gain Retention Gain <br>  Time (RO) - flight time, seconds. <br>  Requested Heading (RWP) - requested course, degrees (Manual or from the table if GPS is on) <br>  Head_Err (RO) - Course error, degrees <br>  RollTrim (RO) - roll trimming amendment <br>  HVariation (RO) - rate of change of course Gardus / sec. <br>  Keep_Roll (RO) - roll held, degrees <br>  Ailerons (RO) - aircraft aileron position <br>  Requested Altitude (RWP) - requested altitude, feet (Manual or from a table if GPS is on) <br>  Alt_Err (RO) - Error in height, feet <br>  PitchTrim (RO) - Pitch Trim Amendment <br>  AVariation (RO) - the rate of change of height of feet / sec. <br>  Keep_Pitch (RO) - pitch held (degrees) <br>  Elevator (RO) - aircraft elevator position <br>  Kst <em>pitch (RW) - static gain of the OS loop in pitch</em> <em><br></em>  <em>Kast</em> pitch (RW) -astatic OS loop pitch gain <br>  Kfar_ pitch (RW) - pitch trimming coefficient <br>  Kst_alt (RW) - static gain for height retention <br>  Kast_alt (RW) - astatic gain for height retention <br>  Rudder (RO) - aircraft rudder position <br>  Requested Speed ‚Äã‚Äã(RWP) - requested speed, miles / hour (knots) (Manually or from a table (GPS on)) <br>  Speed_Err (RO) - speed error (knots) <br>  SVariation (RO) - rate of change of speed (knots) <br>  Keep_Throttle (RO) - held speed (knots) <br>  Throttle (RO) - RUD Position <br>  Kst_speed (RW) - static gain for speed retention <br>  Kast_speed (RW) ‚ÄîAstatic Gain for Holding Speed <br>  Calibrate - ChechBox Joystick Calibration Enable <br>  AP0 - CheckBox Autopilot Mode 0 - Hold Roll = 0 and Pitch = 0 <br>  AP1- CheckBox Mode 1 - Hold the current height and current course <br>  AP2- CheckBox mode 2 - keeping heading and altitude on the table (GPS on) or on set values ‚Äã‚Äã(GPS off) <br>  AT - CheckBox - traction machine </p><br><p>  Around "artificial horizon" there are sliders, with their help, you can manually control the aircraft in case of disconnection of the autopilot or traction machine.  There are three more sliders to the right from the edge, these are the components of the elevator control: (output for debugging) </p><br><p>  top - the static component of TrackAltErr <br>  medium - astatic component of TrackVarErr <br>  middle - trimming component TrackTrim </p><br><p>  The current log is displayed in the field below: </p><br><p>  DST - distance to the next point in feet (CB in Fig. 13) <br>  HDG - heading directly to the next waypoint (C-B in Figure 13) <br>  THDG - the course with which you should fly up to the next point (A-B in Figure 13) <br>  OFF - offset from the desired trajectory in feet (the distance from point C to the AB line Fig.13) <br>  SP - required airspeed <br>  ALT - required flight altitude <br>  WP - the next waypoint </p><br><h2 id="gps">  GPS </h2><br><p>  Figure 4 shows the algorithm of the autopilot to maintain the course.  Suppose that the task is to fly from point A to point B. Suppose that for some reason the plane was at point ‚ÄúC‚Äù.  There are various options to reach point B. For example, you can fly directly to her course HDG, but then the approach to the point will be performed with the wrong course.  If, for example, there is a landing strip, then landing will definitely not work.  Therefore, an algorithm is implemented here, in which, if the plane is very far from a given trajectory, then it flies at the shortest distance perpendicular to THDG (True HDG).  As soon as he approaches a certain distance of the turning circle to THDG, the autopilot will begin to change this course (Requested Heading), which will gradually become equal to THDG.  Thus, by the time the deviation from the route (OFF) becomes zero, all four courses: Current Heading (the current aircraft course on the Instruments panel), Requested Heading, THDG and HDG on the bottom panel should converge and show the same thing.  Such an algorithm now leads to the fact that until the plane reaches a given point, it ‚Äúdoes not think‚Äù of the next one, and a large unnecessary loop is obtained.  The solution may be the transition to the next point at a distance of double radius of the aircraft.  At the moment, the conditions for making a decision about reaching a point begin to be checked when the aircraft approaches a given point at a distance shorter than </p><br><img src="https://habrastorage.org/webt/s-/_s/3v/s-_s3vmgeezvxfkbfsqd9jlz78y.png"><br><p>  Pic.4 </p><br><p>  radius of turn RadRazv.  The decision to move to the next point is made either when approaching it less than 50 ft or at the beginning of the distance from this point, if the plane did not fall into a circle with a radius of 50 ft.  These are the most interesting moments of the program. </p><br><h2 id="trimmirovanie">  Trimming </h2><br><p>  As it turned out, the phrase "remove the force from the steering wheel" was not an empty sound.  All attempts to make the feedback system in pitch so as to accurately maintain altitude, and at the same time cover the entire range of changes in flight modes, were in vain.  Either the plane enters an unstable mode with fluctuations in height with a large gain of the OS loop, or does not accurately maintain the altitude.  In addition, at high speed, the lift force can become so large that the elevator cannot cope (due to insufficient gain of the operating system loop), and the plane starts to gain altitude all the time.  Or it decreases, not having the opportunity to reach large angles of attack at low speed.  Thus, the elevator trimming system is applied with the following algorithm: </p><br><ul><li>  If there is a task to increase the height and the height really grows, then trimming is not performed. </li><li>  If there is a task to increase the height, but it falls, or does not change, then the stabilizer will be trimmed into the set until the climb begins. </li><li>  If a reduction is required and a reduction occurs, then trimming is not performed. </li><li>  If a reduction is required, but at the same time the height does not change or is climbing, then the elevator is trimmed down. </li></ul><br><p>  Trimming is much slower than the control of autopilot 0, so the self-excitation of the feedback loop does not occur. </p><br><h2 id="posadka">  Landing </h2><br><p>  As you know, the most difficult element of the flight is landing.  Since my autopilot is for a radio-controlled model, landing requirements can be simplified.  Here, landing is performed in planning mode.  In this case, the autopilot is given a task when approaching the landing site (the landing course is held by GPS) to keep the speed 0 and the height, for example, about 200 ft - a bit more than the height of the strip.  At the same time, the autopilot keeps the aircraft in the correct flight position, gradually increasing while reducing the angle of attack.  Such a landing is not suitable for heavy aircraft, they need not require a zero speed, but the minimum for a given aircraft configuration, while not reaching supercritical angles of attack.  In the <a href="https://youtu.be/RyEb5jrwmR0">film,</a> you can see the landing and also see how the autopilot algorithms work when trimming and flying along the route.  This is in the simulator.  Landing real aircraft can be seen in the test <a href="https://www.youtube.com/watch%3Fv%3DVHIyx_ljnzI%26t%3D39s">10/17/2017</a> .  It did not occur normally due to the discharge of the battery, but it is quite beautiful, i.e.  as intended. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/346882/">https://habr.com/ru/post/346882/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../346870/index.html">How to replace the restaurant director with a robot?</a></li>
<li><a href="../346872/index.html">Things that cause mistrust and alienate your customers from the site</a></li>
<li><a href="../346876/index.html">How to take notes as a programmer</a></li>
<li><a href="../346878/index.html">Which diagram to use?</a></li>
<li><a href="../346880/index.html">Flask Mega-Tutorial, Part 7: Error Handling (Edition 2018)</a></li>
<li><a href="../346884/index.html">How we chose between Elastic and Tarantool, and made our (fastest) in-memory database. With Join and Full-Text Search</a></li>
<li><a href="../346888/index.html">Azure ML Workbench: Getting Started</a></li>
<li><a href="../346890/index.html">Writing code in the docker environment</a></li>
<li><a href="../346892/index.html">Lua. Brief introduction to metatables for dummies</a></li>
<li><a href="../346896/index.html">Experiment to account for time, or What I learned by analyzing a whole month of my life</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>