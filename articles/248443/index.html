<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple solutions. We pump pictures</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We all love simple solutions. There is an opinion that we value religion so much, trainings on personal growth and succumb to divorces because the bra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple solutions. We pump pictures</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/company/mailru/blog/248443/"><img src="https://habrastorage.org/files/f9e/036/05d/f9e03605d5cc47e886099323bcfae45c.jpg"></a> <br><br>  We all love simple solutions.  There is an opinion that we value religion so much, trainings on personal growth and succumb to divorces because the brain with great pleasure makes simple decisions instead of complex ones, generously rewarding us with dopamine.  In this article I will talk about such a decision on one of our projects.  There is nothing complicated in it, nothing especially witty, but it works reliably, it is relatively simple to implement and it solves many problems at once.  I really hope that it will bring you practical benefits or push you to the idea of ‚Äã‚Äãthe further development of your project. <br><a name="habracut"></a><br><h1>  Initial requirements </h1><br>  The bottom line was this: our project <a href="https://cars.mail.ru/">ars Mail.Ru</a> has a lot of ads, several of which are attached to each of them.  Photos can be uploaded by users manually, or they can be downloaded by the crawler from partner sites and attached to ads automatically.  At the same time, the photos themselves are quite large (up to 10 MB), and there are almost always several pieces per ad.  The photos themselves are stored on several synchronous DAVs, cut into several sizes, and watermark can be supplied.  Those.  processing a single photo (crop-resize-split-upload) is very expensive and requires time and resources (CPU, disks, grid). <br><br>  An almost ideal architecture for us should minimize the use of these resources and be able to solve the following tasks: <br><ul><li>  be able to store multiple photos in different sizes for one ad </li><li>  store the photo in a single copy, even if it is tied to multiple ads </li><li>  do not perform unnecessary actions when uploading a photo that is already in the database, for example, if a user uploaded a photo, then left the form, and then got on the form again and uploaded the same photo, do not perform crop-resize-split-upload, but use what you did 5 minutes ago </li><li>  don't download a photo from the same URL once again if we downloaded it recently </li><li>  Do not leave garbage on the disk if the user uploaded the photo and left the site without posting an advertisement. </li><li>  to speed up the removal as much as possible, plus adding a large number of ads, saving it from loading and deleting large arrays of photos </li><li>  make the storage of rotten pictures as fast as possible </li></ul><br>  If you wrote a vertical search or import from partners many entities with attached pictures, then the situation is undoubtedly familiar to you. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  Solution to the forehead </h1><br>  Direct solution is quite traditional.  When submitting an ad manually, we make a POST form with <code>&lt;input type=¬´file¬ª ...&gt;</code> , the user sends all pictures to POST, they are uploaded to the project, and their <code>id</code> attached to the ad if it is successfully added to the database.  We can use a preloader, and put temporary photos into temporary files, memory, a table, etc.  When automatically importing photos, download photos, upload them to the project, attach them to ads, perhaps use download caching (if the photo from this URL has already been downloaded, we take it from the disk and not from the partner).  Removing the ad, we first remove all the pictures of this ad from the project and only then we demolish the ad itself. <br><br>  We list some of the disadvantages of this solution. <br><ul><li>  Long add ads (if not used preloader). </li><li>  It is necessary to implement a separate mechanism for pre-uploading photos in the form of the announcement. </li><li>  User preloading of a photo (with preview output) and the actual addition of a photo to a project (crop-resize-split-upload) are different algorithms, and the success of the first does not mean the success of the second. </li><li>  Long removal of ads - when deleting, you must delete all related pictures from the disk-DAV-a. </li><li>  The total effects of these minuses, fully manifest themselves in large volumes and parallelization of imports. </li></ul><br><h1>  Easier - better </h1><br>  We really didn‚Äôt like all this, and we decided to slap all these hares at once.  Previously, each photo was tied to a specific ad, while the existence of unbound photos was not allowed, and the table that stores information about the photos had a structure like this: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> Images ( image_id: <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, <span class="hljs-comment"><span class="hljs-comment">-- id ,    , ,       .. offer_id: int unsigned NOT NULL FOREIGN KEY REFERENCES offers_table(id) ON DELETE RESTRICT, --        url_hash: char(32) NULL, -- md5  ,     body_hash: char(32) NULL, -- md5    num: tinyint unsigned NOT NULL, --      last_update: timestamp NOT NULL, --     );</span></span></code> </pre><br>  As I promised, the solution is very simple - we just let the photos exist that are not tied to the ads, and the records about them are duplicated.  Those.  simply made the <code>offer_id</code> foreign key <code>offer_id</code> , and removed <code>UNIQUE</code> from <code>image_id</code> .  Like this: <br><br><pre> <code class="sql hljs"> image_id: char(32), <span class="hljs-comment"><span class="hljs-comment">--  image_id ,    offer_id: int unsigned NULL FOREIGN KEY REFERENCES Offers(id) ON DELETE SET NULL</span></span></code> </pre><br>  Now any entry in the table corresponds to the existing, processed photo, but some of them are not tied to any of the ads and are used in deferred mode or deleted by the garbage collector.  Processing photos separately, communication with ads - separately. <br>  To do this, we implemented the following scripts: <br><br><h1>  1. User add ads </h1><br>  The form of adding ads does not contain <code><code>    POST   .        ,          id .      ajax url,       ,     image_id : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code></code> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> <pre> <code class="hljs xml"><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-photo-num</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo_upload"</span></span></span><span class="hljs-tag">&gt;</span></span>  1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-photo-num</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo_upload"</span></span></span><span class="hljs-tag">&gt;</span></span>  2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> $(</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">).ready(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ $(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">".photo_upload"</span></span></span><span class="javascript">).click(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">//    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0cc175b9c0f1b6a831c399e269772661"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"92eb5ffee6ae2fec3ad71c777531578f"</span></span></span><span class="hljs-tag">&gt;</span></span></code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) <span class="hljs-tag"><span class="hljs-tag">&lt; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NOW</span></span></span><span class="hljs-tag">();</span></span></code><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  ,               </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">N</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">      ,     ,       , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">   ,      ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       ,          </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">image_id</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag"> ,   </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> ,     ,     ,  ,  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  ,    ,           ,        </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    ,     ,         (        </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crop-resize-split-upload</span></span></span><span class="hljs-tag">)</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">N-</span></span></span><span class="hljs-tag"> ¬´¬ª , , , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">5.</span></span></span><span class="hljs-tag">    </span></span><br><span class="hljs-tag"><span class="hljs-tag"> , ,  ,     ! </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">, , , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">      ,  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> ,     ,    ,    ,   </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">      ,     ,    ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    , ,         </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">             </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> ,   ‚Äî     ,       </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    ,       ,              </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag">     ,    ,   , ,      ,    ‚Äî  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag">   ,   ,        ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag">               ,   ,    ,     ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       ,        ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">        ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">  ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">        ,     ( </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">url_hash</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag">  </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">body_hash</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag"> )    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">  ,     ,       </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">image_id</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag"> ‚Äî      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">   ,          ,       ,          ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">         </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">        ‚Äî                    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">             </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">debug</span></span></span><span class="hljs-tag">,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">  , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">             </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    ,   ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  </span></span><br><span class="hljs-tag"><span class="hljs-tag">           </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">      ¬´¬ª (  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">N</span></span></span><span class="hljs-tag">      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crop-resize-split-upload</span></span></span><span class="hljs-tag">     )    ( </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">memcached</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">)     (  ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crop-resize-split-upload</span></span></span><span class="hljs-tag">)         ,                           ,      , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    </span></span><br><span class="hljs-tag"><span class="hljs-tag">   !</span></span></code> </pre> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> <pre> <code class="hljs xml"><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-photo-num</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo_upload"</span></span></span><span class="hljs-tag">&gt;</span></span>  1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-photo-num</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo_upload"</span></span></span><span class="hljs-tag">&gt;</span></span>  2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> $(</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">).ready(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ $(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">".photo_upload"</span></span></span><span class="javascript">).click(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">//    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0cc175b9c0f1b6a831c399e269772661"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"92eb5ffee6ae2fec3ad71c777531578f"</span></span></span><span class="hljs-tag">&gt;</span></span></code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) <span class="hljs-tag"><span class="hljs-tag">&lt; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NOW</span></span></span><span class="hljs-tag">();</span></span></code><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  ,               </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">N</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">      ,     ,       , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">   ,      ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       ,          </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">image_id</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag"> ,   </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> ,     ,     ,  ,  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  ,    ,           ,        </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    ,     ,         (        </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crop-resize-split-upload</span></span></span><span class="hljs-tag">)</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">N-</span></span></span><span class="hljs-tag"> ¬´¬ª , , , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">5.</span></span></span><span class="hljs-tag">    </span></span><br><span class="hljs-tag"><span class="hljs-tag"> , ,  ,     ! </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">, , , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">      ,  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> ,     ,    ,    ,   </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">      ,     ,    ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    , ,         </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">             </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> ,   ‚Äî     ,       </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    ,       ,              </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag">     ,    ,   , ,      ,    ‚Äî  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag">   ,   ,        ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag">               ,   ,    ,     ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       ,        ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">        ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">  ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">        ,     ( </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">url_hash</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag">  </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">body_hash</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag"> )    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">  ,     ,       </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">image_id</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag"> ‚Äî      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">   ,          ,       ,          ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">         </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">        ‚Äî                    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">             </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">debug</span></span></span><span class="hljs-tag">,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">  , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">             </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    ,   ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  </span></span><br><span class="hljs-tag"><span class="hljs-tag">           </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">      ¬´¬ª (  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">N</span></span></span><span class="hljs-tag">      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crop-resize-split-upload</span></span></span><span class="hljs-tag">     )    ( </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">memcached</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">)     (  ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crop-resize-split-upload</span></span></span><span class="hljs-tag">)         ,                           ,      , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    </span></span><br><span class="hljs-tag"><span class="hljs-tag">   !</span></span></code> </pre> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> <pre> <code class="hljs xml"><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-photo-num</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo_upload"</span></span></span><span class="hljs-tag">&gt;</span></span>  1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-photo-num</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo_upload"</span></span></span><span class="hljs-tag">&gt;</span></span>  2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> $(</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">).ready(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ $(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">".photo_upload"</span></span></span><span class="javascript">).click(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">//    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0cc175b9c0f1b6a831c399e269772661"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"92eb5ffee6ae2fec3ad71c777531578f"</span></span></span><span class="hljs-tag">&gt;</span></span></code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) <span class="hljs-tag"><span class="hljs-tag">&lt; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NOW</span></span></span><span class="hljs-tag">();</span></span></code><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  ,               </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">N</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">      ,     ,       , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">   ,      ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       ,          </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">image_id</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag"> ,   </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> ,     ,     ,  ,  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  ,    ,           ,        </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    ,     ,         (        </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crop-resize-split-upload</span></span></span><span class="hljs-tag">)</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">N-</span></span></span><span class="hljs-tag"> ¬´¬ª , , , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">5.</span></span></span><span class="hljs-tag">    </span></span><br><span class="hljs-tag"><span class="hljs-tag"> , ,  ,     ! </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">, , , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">      ,  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> ,     ,    ,    ,   </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">      ,     ,    ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    , ,         </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">             </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> ,   ‚Äî     ,       </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    ,       ,              </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag">     ,    ,   , ,      ,    ‚Äî  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag">   ,   ,        ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag">               ,   ,    ,     ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       ,        ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">        ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">  ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">        ,     ( </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">url_hash</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag">  </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">body_hash</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag"> )    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">  ,     ,       </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">image_id</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag"> ‚Äî      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">   ,          ,       ,          ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">         </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">        ‚Äî                    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">             </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">debug</span></span></span><span class="hljs-tag">,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">  , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">             </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    ,   ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  </span></span><br><span class="hljs-tag"><span class="hljs-tag">           </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">      ¬´¬ª (  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">N</span></span></span><span class="hljs-tag">      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crop-resize-split-upload</span></span></span><span class="hljs-tag">     )    ( </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">memcached</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">)     (  ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crop-resize-split-upload</span></span></span><span class="hljs-tag">)         ,                           ,      , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    </span></span><br><span class="hljs-tag"><span class="hljs-tag">   !</span></span></code> </pre> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> <pre> <code class="hljs xml"><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-photo-num</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo_upload"</span></span></span><span class="hljs-tag">&gt;</span></span>  1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-photo-num</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo_upload"</span></span></span><span class="hljs-tag">&gt;</span></span>  2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> $(</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">).ready(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ $(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">".photo_upload"</span></span></span><span class="javascript">).click(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">//    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0cc175b9c0f1b6a831c399e269772661"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"92eb5ffee6ae2fec3ad71c777531578f"</span></span></span><span class="hljs-tag">&gt;</span></span></code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) <span class="hljs-tag"><span class="hljs-tag">&lt; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NOW</span></span></span><span class="hljs-tag">();</span></span></code><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  ,               </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">N</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">      ,     ,       , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">   ,      ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       ,          </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">image_id</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag"> ,   </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> ,     ,     ,  ,  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  ,    ,           ,        </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    ,     ,         (        </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crop-resize-split-upload</span></span></span><span class="hljs-tag">)</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">N-</span></span></span><span class="hljs-tag"> ¬´¬ª , , , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">5.</span></span></span><span class="hljs-tag">    </span></span><br><span class="hljs-tag"><span class="hljs-tag"> , ,  ,     ! </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">, , , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">      ,  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> ,     ,    ,    ,   </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">      ,     ,    ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    , ,         </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">             </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> ,   ‚Äî     ,       </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    ,       ,              </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag">     ,    ,   , ,      ,    ‚Äî  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag">   ,   ,        ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag">               ,   ,    ,     ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       ,        ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">        ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">  ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">        ,     ( </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">url_hash</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag">  </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">body_hash</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag"> )    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">  ,     ,       </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">image_id</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag"> ‚Äî      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">   ,          ,       ,          ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">         </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">        ‚Äî                    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">             </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">debug</span></span></span><span class="hljs-tag">,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">  , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">             </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    ,   ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  </span></span><br><span class="hljs-tag"><span class="hljs-tag">           </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">      ¬´¬ª (  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">N</span></span></span><span class="hljs-tag">      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crop-resize-split-upload</span></span></span><span class="hljs-tag">     )    ( </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">memcached</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">)     (  ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crop-resize-split-upload</span></span></span><span class="hljs-tag">)         ,                           ,      , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    </span></span><br><span class="hljs-tag"><span class="hljs-tag">   !</span></span></code> </pre> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> <pre> <code class="hljs xml"><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-photo-num</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo_upload"</span></span></span><span class="hljs-tag">&gt;</span></span>  1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-photo-num</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo_upload"</span></span></span><span class="hljs-tag">&gt;</span></span>  2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> $(</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">).ready(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ $(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">".photo_upload"</span></span></span><span class="javascript">).click(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">//    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0cc175b9c0f1b6a831c399e269772661"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"92eb5ffee6ae2fec3ad71c777531578f"</span></span></span><span class="hljs-tag">&gt;</span></span></code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) <span class="hljs-tag"><span class="hljs-tag">&lt; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NOW</span></span></span><span class="hljs-tag">();</span></span></code><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  ,               </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">N</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">      ,     ,       , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">   ,      ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       ,          </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">image_id</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag"> ,   </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> ,     ,     ,  ,  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  ,    ,           ,        </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    ,     ,         (        </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crop-resize-split-upload</span></span></span><span class="hljs-tag">)</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">N-</span></span></span><span class="hljs-tag"> ¬´¬ª , , , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">5.</span></span></span><span class="hljs-tag">    </span></span><br><span class="hljs-tag"><span class="hljs-tag"> , ,  ,     ! </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">, , , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">      ,  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> ,     ,    ,    ,   </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">      ,     ,    ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    , ,         </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">             </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> ,   ‚Äî     ,       </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    ,       ,              </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag">     ,    ,   , ,      ,    ‚Äî  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag">   ,   ,        ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag">               ,   ,    ,     ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       ,        ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">        ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">  ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">        ,     ( </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">url_hash</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag">  </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">body_hash</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag"> )    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">  ,     ,       </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">image_id</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag"> ‚Äî      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">   ,          ,       ,          ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">         </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">        ‚Äî                    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">             </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">debug</span></span></span><span class="hljs-tag">,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">  , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">             </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    ,   ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  </span></span><br><span class="hljs-tag"><span class="hljs-tag">           </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">      ¬´¬ª (  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">N</span></span></span><span class="hljs-tag">      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crop-resize-split-upload</span></span></span><span class="hljs-tag">     )    ( </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">memcached</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">)     (  ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crop-resize-split-upload</span></span></span><span class="hljs-tag">)         ,                           ,      , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    </span></span><br><span class="hljs-tag"><span class="hljs-tag">   !</span></span></code> </pre> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> <h1> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> </h1> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> <pre> <code class="hljs xml"><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-photo-num</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo_upload"</span></span></span><span class="hljs-tag">&gt;</span></span>  1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-photo-num</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo_upload"</span></span></span><span class="hljs-tag">&gt;</span></span>  2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> $(</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">).ready(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ $(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">".photo_upload"</span></span></span><span class="javascript">).click(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">//    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0cc175b9c0f1b6a831c399e269772661"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"92eb5ffee6ae2fec3ad71c777531578f"</span></span></span><span class="hljs-tag">&gt;</span></span></code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) <span class="hljs-tag"><span class="hljs-tag">&lt; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NOW</span></span></span><span class="hljs-tag">();</span></span></code><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  ,               </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">N</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">      ,     ,       , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">   ,      ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       ,          </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">image_id</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag"> ,   </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> ,     ,     ,  ,  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  ,    ,           ,        </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    ,     ,         (        </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crop-resize-split-upload</span></span></span><span class="hljs-tag">)</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">N-</span></span></span><span class="hljs-tag"> ¬´¬ª , , , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">5.</span></span></span><span class="hljs-tag">    </span></span><br><span class="hljs-tag"><span class="hljs-tag"> , ,  ,     ! </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">, , , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">      ,  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> ,     ,    ,    ,   </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">      ,     ,    ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    , ,         </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">             </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> ,   ‚Äî     ,       </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    ,       ,              </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag">     ,    ,   , ,      ,    ‚Äî  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag">   ,   ,        ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag">               ,   ,    ,     ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       ,        ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">        ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">  ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">        ,     ( </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">url_hash</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag">  </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">body_hash</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag"> )    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">  ,     ,       </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">image_id</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag"> ‚Äî      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">   ,          ,       ,          ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">         </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">        ‚Äî                    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">             </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">debug</span></span></span><span class="hljs-tag">,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">  , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">             </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    ,   ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  </span></span><br><span class="hljs-tag"><span class="hljs-tag">           </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">      ¬´¬ª (  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">N</span></span></span><span class="hljs-tag">      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crop-resize-split-upload</span></span></span><span class="hljs-tag">     )    ( </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">memcached</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">)     (  ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crop-resize-split-upload</span></span></span><span class="hljs-tag">)         ,                           ,      , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    </span></span><br><span class="hljs-tag"><span class="hljs-tag">   !</span></span></code> </pre> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> <h1> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> </h1> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> <pre> <code class="hljs xml"><code class="sql"><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-photo-num</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo_upload"</span></span></span><span class="hljs-tag">&gt;</span></span>  1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-photo-num</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo_upload"</span></span></span><span class="hljs-tag">&gt;</span></span>  2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> $(</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">).ready(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ $(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">".photo_upload"</span></span></span><span class="javascript">).click(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">//    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0cc175b9c0f1b6a831c399e269772661"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"92eb5ffee6ae2fec3ad71c777531578f"</span></span></span><span class="hljs-tag">&gt;</span></span></code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> DELETE FROM Offers WHERE id=? <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) <span class="hljs-tag"><span class="hljs-tag">&lt; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NOW</span></span></span><span class="hljs-tag">();</span></span></code><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  ,               </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">N</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">      ,     ,       , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">   ,      ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       ,          </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">image_id</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag"> ,   </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> ,     ,     ,  ,  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  ,    ,           ,        </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    ,     ,         (        </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crop-resize-split-upload</span></span></span><span class="hljs-tag">)</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">N-</span></span></span><span class="hljs-tag"> ¬´¬ª , , , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">5.</span></span></span><span class="hljs-tag">    </span></span><br><span class="hljs-tag"><span class="hljs-tag"> , ,  ,     ! </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">, , , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">      ,  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> ,     ,    ,    ,   </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">      ,     ,    ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    , ,         </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">             </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> ,   ‚Äî     ,       </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    ,       ,              </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag">     ,    ,   , ,      ,    ‚Äî  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag">   ,   ,        ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag">               ,   ,    ,     ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       ,        ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">        ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">  ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">        ,     ( </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">url_hash</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag">  </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">body_hash</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag"> )    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">  ,     ,       </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">image_id</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag"> ‚Äî      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">   ,          ,       ,          ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">         </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">        ‚Äî                    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">             </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">debug</span></span></span><span class="hljs-tag">,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">  , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">             </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    ,   ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  </span></span><br><span class="hljs-tag"><span class="hljs-tag">           </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">      ¬´¬ª (  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">N</span></span></span><span class="hljs-tag">      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crop-resize-split-upload</span></span></span><span class="hljs-tag">     )    ( </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">memcached</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">)     (  ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crop-resize-split-upload</span></span></span><span class="hljs-tag">)         ,                           ,      , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    </span></span><br><span class="hljs-tag"><span class="hljs-tag">   !</span></span></code></code> </pre> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> <h1> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> </h1> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> <pre> <code class="hljs xml"><code class="sql"><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-photo-num</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo_upload"</span></span></span><span class="hljs-tag">&gt;</span></span>  1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-photo-num</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo_upload"</span></span></span><span class="hljs-tag">&gt;</span></span>  2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> $(</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">).ready(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ $(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">".photo_upload"</span></span></span><span class="javascript">).click(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">//    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0cc175b9c0f1b6a831c399e269772661"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"92eb5ffee6ae2fec3ad71c777531578f"</span></span></span><span class="hljs-tag">&gt;</span></span></code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) <span class="hljs-tag"><span class="hljs-tag">&lt; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NOW</span></span></span><span class="hljs-tag">(); </span></span><br><span class="hljs-tag"><span class="hljs-tag">  ,               </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">N</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">      ,     ,       , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">   ,      ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       ,          </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">image_id</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag"> ,   </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> ,     ,     ,  ,  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  ,    ,           ,        </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    ,     ,         (        </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crop-resize-split-upload</span></span></span><span class="hljs-tag">)</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">N-</span></span></span><span class="hljs-tag"> ¬´¬ª , , , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">5.</span></span></span><span class="hljs-tag">    </span></span><br><span class="hljs-tag"><span class="hljs-tag"> , ,  ,     ! </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">, , , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">      ,  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> ,     ,    ,    ,   </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">      ,     ,    ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    , ,         </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">             </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> ,   ‚Äî     ,       </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    ,       ,              </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag">     ,    ,   , ,      ,    ‚Äî  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag">   ,   ,        ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag">               ,   ,    ,     ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       ,        ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">        ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">  ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">        ,     ( </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">url_hash</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag">  </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">body_hash</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag"> )    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">  ,     ,       </span></span><code><span class="hljs-tag"><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">image_id</span></span></span></span></code><span class="hljs-tag"><span class="hljs-tag"> ‚Äî      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">   ,          ,       ,          ,     </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">         </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">        ‚Äî                    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">             </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">debug</span></span></span><span class="hljs-tag">,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">  , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">             </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    ,   ,      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">  </span></span><br><span class="hljs-tag"><span class="hljs-tag">           </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag"> </span></span><br><span class="hljs-tag"><span class="hljs-tag">      ¬´¬ª (  </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">N</span></span></span><span class="hljs-tag">      </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crop-resize-split-upload</span></span></span><span class="hljs-tag">     )    ( </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">memcached</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag">)     (  ,    </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">crop-resize-split-upload</span></span></span><span class="hljs-tag">)         ,                           ,      , </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag"></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">    </span></span><br><span class="hljs-tag"><span class="hljs-tag">   !</span></span></code></code> </pre> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> <h1> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> </h1> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> <h1> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> </h1> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> <ul><li> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> </li> <li> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> </li> <li> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> </li> <li> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> </li> <li> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> </li> <li> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> </li> </ul> <code><code>    POST   .        ,          id .      ajax url,       ,     image_id</code> : <br> <br> <code class="html">&lt;a href="#" data-photo-num="1" class="photo_upload"&gt;  1&lt;/a&gt; &lt;input type="hidden" name="photo1" value=""&gt; &lt;a href="#" data-photo-num="2" class="photo_upload"&gt;  2&lt;/a&gt; &lt;input type="hidden" name="photo2" value=""&gt; &lt;script type="text/javascript"&gt; $(document).ready(function() { $(".photo_upload").click(function() { //    //    URL /pre-upload-photo/ //   ,     image_id var image_id = pre_upload_result.image_id; var num = $(this).attr("data-photo-num"); $("input[name="photo" + num + "]").val(image_id); return false; }); }); &lt;/script&gt;</code> <br>  URL /pre-upload-photo/ (     )  : <br> <br> <code class="html">       this_body_hash(md5   );      body_hash == this_body_hash; IF (  ) {  last_update   ;           offer_id    image_id; } ELSE {  crop-resize-spilt-upload;     body_hash,  last_update,  offer_id   image_id; }  image_id  ;</code> <br> ,   ,     <code>image_id</code> ,       input: <br> <br> <code class="html"> &lt;input type="hidden" name="photo1" value="0cc175b9c0f1b6a831c399e269772661"&gt; &lt;input type="hidden" name="photo2" value="92eb5ffee6ae2fec3ad71c777531578f"&gt;</code> <br>         : <br> <br> <code> photo1: 0cc175b9c0f1b6a831c399e269772661 photo2: 92eb5ffee6ae2fec3ad71c777531578f photo3: 4a8a08f09d37b73795649038408b5f33</code> <br>            ,         ,   ‚Äî  ,      .. <br> <br> <code> offer_id: NULL, num: 0, image_id: 4a8a08f09d37b73795649038408b5f33 offer_id: 1234, num: 3, image_id: 92eb5ffee6ae2fec3ad71c777531578f offer_id: 1234, num: 1, image_id: 0cc175b9c0f1b6a831c399e269772661</code> <br>      ,        . <br> <br> ,          , ,      ,    ,  ..,   crop-resize-split-upload        .  ,        .    <code>rate-limit</code>  URL   ‚Äî      DoS-. <br> <br> 2.   <br>       ,   . ..           ,  <code>body_hash</code>  <code>url_hash</code> (md5  URL ).  ,              . ..       N  ,   ,     ,           crop-resize-split-upload. <br> <br>      ,      <code>offer_id</code>   URL,    .      URL : <br> <br> <code class="html">  this_url_hash   URL;     ,   url_hash == this_url_hash; IF ( ) { #    crop-resize-spilt-upload;      c  offer_id, url_hash, num, last_update; } ELSIF (  ,   ,  offer_id) { #   ,           c   image_id,   offer_id, url_hash, num  last_update; } ELSE { #    ,    ,       offer_id  num,   last_update; }</code> <br>  ,     URL   ‚Äî    ,    . <br> <br> 3.   <br> <code class="sql"> DELETE FROM Offers WHERE id=?</code> <br> . <code>ON DELETE SET NULL</code>  <code>offer_id</code>     ,   N          ,     . ,           ,   . <br> <br> 4.    <br> <code class="sql"> SELECT image_id FROM ImagesTable i WHERE offer_id IS NULL AND (last_update + INTERVAL ? DAY) &lt; NOW();</code> <br>  ,               N . <br> <br>    -      ,     ,       , ..   ,      ,    .       ,          <code>image_id</code> ,   .       ,      .     , .. ,     ,     ,  ,  . <br> <br>  ,    ,           ,        .    ,     ,         (        crop-resize-split-upload).      N- ¬´¬ª , , , . <br> <br> 5.    <br> , ,  ,     ! -, , , -      ,  . ,     ,    ,    ,   .      ,     ,    ,     .    , ,         .             . <br> <br> ,   ‚Äî     ,       .    ,       ,              .     ,     . <br> <br>  :     ,    ,   , ,      ,    ‚Äî  . :   ,   ,        ,    . <br> <br>     :               ,   ,    ,     ,     .     .       ,        ,    .        ,      .  ,      .     . <br> <br>        ,     ( <code>url_hash</code>  <code>body_hash</code> )    .  ,     ,       <code>image_id</code> ‚Äî      .   ,          ,       ,          ,     .         .        ‚Äî                    . <br> <br>             debug,    .  , ..             .       , ..    ,   ,      .. <br> <br>  <br>           : <br> <br>      ¬´¬ª (  N      crop-resize-split-upload     )    ( memcached -)     (  ,    crop-resize-split-upload)         ,                           ,      , ..    <br>   !</code> </div><p>Source: <a href="https://habr.com/ru/post/248443/">https://habr.com/ru/post/248443/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../248429/index.html">Urban legends about slow calls to virtual functions</a></li>
<li><a href="../248431/index.html">New game development bugs</a></li>
<li><a href="../248435/index.html">NSA Curious Look: What is the War for Internet Security (Part 1)</a></li>
<li><a href="../248439/index.html">Mobile App Distribution Services for iOS. Part 1: TestFlight</a></li>
<li><a href="../248441/index.html">8 varieties of muda in your web studio</a></li>
<li><a href="../248445/index.html">Deploy an OpenVPN server with an InfoboxCloud control panel in the cloud and set up access for clients</a></li>
<li><a href="../248449/index.html">(Kiev) from 3 to 6 February, the course "Advanced Switch Operation, Configuration and Management"</a></li>
<li><a href="../248451/index.html">(Belarus) Foundation for data center: Juniper MetaFabric architecture</a></li>
<li><a href="../248453/index.html">Automated testing of services using the MQ protocol using JMeter</a></li>
<li><a href="../248455/index.html">CrystaX NDK 10.1 release</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>