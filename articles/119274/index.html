<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Transmission - we introduce buns into it</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. 
 I changed the system on my home server, and the software itself also needed to be rearranged. 
 Therefore, for the sake of the test, I loo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Transmission - we introduce buns into it</h1><div class="post__text post__text-html js-mediator-article">  Good day. <br>  I changed the system on my home server, and the software itself also needed to be rearranged. <br>  Therefore, for the sake of the test, I looked through several of the most popular torrent clients running on * nix (rTorrent, Deluge, MLDonkey, Transmission). <br>  I liked the latter the most, but for me there was a significant drawback - it is impossible to rename the names of the torrents sewn into the .torrent file. <br>  That is, we will have all sorts of different folders on the disc, for example, ‚ÄúKrovavaja gora‚Äù, ‚ÄúCrime Scene New York‚Äù, or simply ‚ÄúSeason 7‚Äù. <br>  I don‚Äôt like it, I love order, respectively, I organize my film library (or rather its serial part) in the form of "% SERIAL_NAME% / Season N". <br>  Transmission, alas, does not allow this.  But since basically everything was fine, I undertook to customize the client for myself. <br><a name="habracut"></a><br><h4>  Transmission.  Rename </h4><br><br>  The first subtask is the ability to rename the folder with the contents of the torrent in the file system, and continue to work correctly. <br>  I was not the first to visit such a simple idea that it is necessary for the client.  In bugtracking system there is a ticket three years ago <a href="https://trac.transmissionbt.com/ticket/1220"># 1220</a> .  Unfortunately, the developers somehow sluggishly react to it, but comrade <b>juxda</b> kindly wrote a <a href="https://trac.transmissionbt.com/attachment/ticket/1220/rename-torrent_v3.patch">patch</a> that adds this functionality to the samples. <br>  However, the radius of curvature of my hands did not allow the patch to be correctly even applied to the revision (11895) for which it was made.  In addition, I still wanted to have the latest version of the torrent client with this chip, because about 500 commits have passed since that revision. <br><br>  Therefore, I chose the path of thoughtful patching, with an analysis of what we are doing specifically, so that you can correct it yourself if something happens, and finish clients to the demon. <br>  Everything begins simply: <br> <code>svn co svn://svn.transmissionbt.com/Transmission/trunk Transmission</code> <br>  We are taking the HEAD-revision from the SVN-server.  The list of necessary packages is in the <a href="https://trac.transmissionbt.com/wiki/Building">truck</a> , I note that if you do not need a gtk-client, then you can also not install some of the lib (libgtk2.0-dev, libnotify-dev, libglib2.0-dev can be played).  libevent-dev needs fresh (2.0.10 at the moment), I had to compile from <a href="http://monkey.org/~provos/libevent/">source</a> , since I could not find the -dev packages in the repository.  The preparatory part is finished, you can go digging into the sources. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We start with the basics - the kernel ( <b>libtransmission</b> folder).  Rule header - <b>transmission.h</b> . <br>  Add a field to the description structure of the torrent metadata <b>tr_info</b> field " <b>char * rename</b> ".  This structure contains data obtained from .torrent.  Actually, if there is no such data, then renaming is not possible, so it is logical to fill in this structure. The added field will contain the name of the torrent in the file system after the renaming. <br><br>  In addition, we add a description of our new feature: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tr_torrentRename</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( tr_torrent * torrent, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * newname )</span></span></span></span>;</code> </pre> <br><br>  It's time to mention one difficulty - the file names are based on the original name. <br>  Of course, you can patch everything up, but there are quite a few such places, and it‚Äôs better just to ‚Äúreload‚Äù these names after downloading. <br>  Therefore, we use the built-in data recovery mechanism - we add a field that contains this very list of paths to save, and when we boot we ‚Äúremember‚Äù everything we need. <br><br>  For now, let us postpone this moment for a while, but do not forget about it. <br>  We turn to the main thing - the very function of moving.  We will edit <b>torrent.h</b> / <b>torrent.c</b> . <br>  First we add a function to the header file that will write to overwrite the paths for the files in the internal structure of the torrent; this function will be needed in the same mechanism: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tr_torrentInitFileName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( tr_torrent * tor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">tr_file_index_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fileIndex, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * name )</span></span></span></span>;</code> </pre> <br>  Well, in the <b>torrents.c</b> itself her body: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tr_torrentInitFileName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( tr_torrent * tor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">tr_file_index_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fileIndex, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * name )</span></span></span><span class="hljs-function"> </span></span>{ tr_file * file; assert( tr_isTorrent( tor ) ); assert( fileIndex &lt; tor-&gt;info.fileCount ); assert( name != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ); assert( name[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-string"><span class="hljs-string">'\0'</span></span> ); file = &amp;tor-&gt;info.files[fileIndex]; tr_free( file-&gt;name ); file-&gt;name = tr_strdup( name ); }</code> </pre><br>  Everything is primitive - we release the old path, write the new one.  Such a small helper. <br>  Next we find the <b>fileExists</b> () function and after it we write the main code: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dirExists</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * path )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stat</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sb</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> stat( path, &amp;sb ) == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; S_ISDIR( sb.st_mode ); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tr_torrentRename</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( tr_torrent * tor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * newname )</span></span></span><span class="hljs-function"> </span></span>{ tr_info * info; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * root, * p, * oldname, * base; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * oldpath = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, * newpath = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, * subpath = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> err = <span class="hljs-number"><span class="hljs-number">0</span></span>; assert( tr_isTorrent( tor ) ); tr_torrentLock( tor ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !tr_torrentHasMetadata( tor ) ) { err = ENOENT; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> OUT; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !newname || !newname[<span class="hljs-number"><span class="hljs-number">0</span></span>] || <span class="hljs-built_in"><span class="hljs-built_in">strchr</span></span>( newname, TR_PATH_DELIMITER ) || !<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>( newname, <span class="hljs-string"><span class="hljs-string">"."</span></span> ) || !<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>( newname, <span class="hljs-string"><span class="hljs-string">".."</span></span> ) ) { err = EINVAL; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> OUT; } info = &amp;tor-&gt;info; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info-&gt;rename) oldname = info-&gt;rename; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> oldname = info-&gt;name; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( p = <span class="hljs-built_in"><span class="hljs-built_in">strchr</span></span>( oldname, TR_PATH_DELIMITER ) ) ) { <span class="hljs-comment"><span class="hljs-comment">/* Should not happen, but just in case. */</span></span> err = EISDIR; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> OUT; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>( newname, oldname ) ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> OUT; root = tr_torrentGetCurrentDir( tor ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( info-&gt;fileCount &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">tr_file_index_t</span></span> fi; oldpath = tr_buildPath( root, oldname, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( dirExists( oldpath ) ) { newpath = tr_buildPath( root, newname, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( fileExists( newpath, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) ) { err = EEXIST; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> OUT; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( rename( oldpath, newpath ) == <span class="hljs-number"><span class="hljs-number">-1</span></span> ) { err = errno; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> OUT; } } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( fi = <span class="hljs-number"><span class="hljs-number">0</span></span>; fi &lt; info-&gt;fileCount; ++fi ) { tr_file * file = &amp;info-&gt;files[fi]; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * newfnam; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !( p = <span class="hljs-built_in"><span class="hljs-built_in">strchr</span></span>( file-&gt;name, TR_PATH_DELIMITER ) ) ) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; newfnam = tr_buildPath( newname, p + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ); tr_free( file-&gt;name ); file-&gt;name = newfnam; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( tr_torrentFindFile2( tor, <span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;base, &amp;subpath, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) ) { oldpath = tr_buildPath( base, subpath, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ); newpath = tr_buildPath( base, newname, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( fileExists( newpath, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) ) { err = EEXIST; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> OUT; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( rename( oldpath, newpath ) == <span class="hljs-number"><span class="hljs-number">-1</span></span> ) { err = errno; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> OUT; } } tr_free( info-&gt;files[<span class="hljs-number"><span class="hljs-number">0</span></span>].name ); info-&gt;files[<span class="hljs-number"><span class="hljs-number">0</span></span>].name = tr_strdup( newname ); } tr_free( info-&gt;rename ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>( newname, info-&gt;name ) ) info-&gt;rename = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> info-&gt;rename = tr_strdup( newname ); tr_torrentSetDirty( tor ); OUT: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( err ) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * es = tr_strerror( err ), * fmt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( oldpath &amp;&amp; newpath ) { <span class="hljs-comment"><span class="hljs-comment">/* %1$s is the original file path. * %2$s is the new file path. * %3$s is the error message. */</span></span> fmt = _( <span class="hljs-string"><span class="hljs-string">"Cannot rename \"%1$s\" to \"%2$s\": %3$s"</span></span> ); tr_torerr( tor, fmt, oldpath, newpath, es ); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( oldpath ) { <span class="hljs-comment"><span class="hljs-comment">/* %1$s is the existing file name. * %2$s is the error message. */</span></span> fmt = _( <span class="hljs-string"><span class="hljs-string">"Cannot rename \"%1$s\": %2$s"</span></span> ); tr_torerr( tor, fmt, oldpath, es ); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { fmt = _( <span class="hljs-string"><span class="hljs-string">"Cannot rename torrent: %s"</span></span> ); tr_torerr( tor, fmt, es ); } } tr_torrentUnlock( tor ); tr_free( oldpath ); tr_free( newpath ); tr_free( subpath ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err; }</code> </pre> <br>  Most of the code is simple checks, the <b>main</b> part is actually the <b>rename</b> () call itself, and editing <b>info-&gt; files</b> .  Well, do not forget to fill <b>info-&gt; rename</b> . <br><br>  Now you need to let everyone know that the name has changed.  In fact, this can be done by direct edits.  Despite the fact that the author of most of the code went the way of modifying <b>tr_torrentName</b> (), I chose a different path.  Modifying that function is only useful if you are going to use the gtk client, then yes, it is better to replace a single line of code with: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tor-&gt;info.rename ? tor-&gt;info.rename : tor-&gt;info.name;</code> </pre> <br>  So that everything was in openwork for gtk, but since I do not use this gui, I thought it unnecessary to spoil a bunch of other things like building a magnet link (the original patch, of course, spoils).  In fact, I need the <b>rename</b> field only to build the path to the files, and in order to give via RPC, so that the RPC client can, for example, open the folder with the torrent.  We have the first (so far half), the second is also easy to solve (go to the RPC implementation - <b>rpcimpl.c</b> ). <br><br>  We are looking for the <b>addField</b> () function, which is responsible for the formation of torrent information fields for the answer.  That is, we can request a certain set of fields about the torrent, and using this function, Transmission will generate this information.  We are interested in the " <b>name</b> " field; we replace the " <b>tr_torrentName (tor)</b> " parameter with <br><pre> <code class="cpp hljs">tor-&gt;info.rename ? tor-&gt;info.rename : tor-&gt;info.name</code> </pre> <br>  Is done.  Now RPC knows about our new status. <br>  Since RPC has come to rule, then you need to add the rename command itself. <br>  The interlayer function to insert before <b>torrentSet</b> (): <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">renameTorrent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( tr_torrent * tor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * str )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> err = tr_torrentRename( tor, str ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err == <span class="hljs-number"><span class="hljs-number">0</span></span> ? <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> : tr_strerror( err ); }</code> </pre> <br>  Now we add the command itself, for this we edit the <b>torrentSet</b> () function: <br>  Add a variable description to the block - <b>const char * str</b> ; <br>  And check on the rename command: <br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !errmsg &amp;&amp; tr_bencDictFindStr( args_in, <span class="hljs-string"><span class="hljs-string">"rename"</span></span>, &amp;str ) ) errmsg = renameTorrent( tor, str );</code> </pre> <br><br>  What have we not done?  And we forgot about the mechanism of saving the state of the torrent! <br>  It is necessary to fill this gap, this module is contained in files ( <b>resume.c</b> / <b>resume.h</b> ). <br>  First, add the checkboxes for the saved fields.  There is only one enumeration in the header file, it is difficult to get confused. <br>  We will need to save information about the current location of the torrent ( <b>inf-&gt; rename</b> ) and the list of files that I mentioned earlier. <br>  So 2 checkboxes: <br><pre> <code class="cpp hljs"> TR_FR_FILE_NAMES = ( <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">20</span></span> ), TR_FR_RENAME = ( <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">21</span></span> )</code> </pre> <br>  Despite the presence of the header file, there is a list of defay keys in resume.c (the key describes each state entity that is saved to disk). <br>  We also need to ‚Äúfit in‚Äù there: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> KEY_FILE_NAMES </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> KEY_RENAME </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"rename"</span></span></span></span></code> </pre> <br>  The original " <b>name</b> " field is not saved, as it is taken directly from .torrent.  Therefore, we can use this identifier as a key, and this will not cause any confusion in the future. <br>  Add path saving functions: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveFileNames</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( tr_benc * dict, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> tr_torrent * tor )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tr_info * inf = tr_torrentInfo( tor ); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">tr_file_index_t</span></span> n = inf-&gt;fileCount; <span class="hljs-keyword"><span class="hljs-keyword">tr_file_index_t</span></span> i; tr_benc * <span class="hljs-built_in"><span class="hljs-built_in">list</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">list</span></span> = tr_bencDictAddList( dict, KEY_FILE_NAMES, n ); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; n; ++i ) tr_bencListAddStr( <span class="hljs-built_in"><span class="hljs-built_in">list</span></span>, inf-&gt;files[i].name ); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> uint64_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadFileNames</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( tr_benc * dict, tr_torrent * tor )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> ret = <span class="hljs-number"><span class="hljs-number">0</span></span>; tr_info * inf = &amp;tor-&gt;info; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">tr_file_index_t</span></span> n = inf-&gt;fileCount; tr_benc * <span class="hljs-built_in"><span class="hljs-built_in">list</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( tr_bencDictFindList( dict, KEY_FILE_NAMES, &amp;<span class="hljs-built_in"><span class="hljs-built_in">list</span></span> ) &amp;&amp; tr_bencListSize( <span class="hljs-built_in"><span class="hljs-built_in">list</span></span> ) == n ) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * name; <span class="hljs-keyword"><span class="hljs-keyword">tr_file_index_t</span></span> i; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; n; ++i ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( tr_bencGetStr( tr_bencListChild( <span class="hljs-built_in"><span class="hljs-built_in">list</span></span>, i ), &amp;name ) ) tr_torrentInitFileName( tor, i, name ); ret = TR_FR_FILE_NAMES; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; }</code> </pre> <br>  And we add to the interface functions our wish to save. <br>  <b>tr_torrentSaveResume ()</b> , immediately after checking <b>if (tr_torrentHasMetadata (tor))</b> : <br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( tor-&gt;info.rename ) tr_bencDictAddStr( &amp;top, KEY_RENAME, tor-&gt;info.rename ); saveFileNames( &amp;top, tor );</code> </pre> <br>  And the load code in <b>loadFromFile</b> (): <br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( fieldsToLoad &amp; TR_FR_FILE_NAMES ) fieldsLoaded |= loadFileNames( &amp;top, tor ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( fieldsToLoad &amp; TR_FR_RENAME ) &amp;&amp; tr_bencDictFindStr( &amp;top, KEY_RENAME, &amp;str ) &amp;&amp; str &amp;&amp; str[<span class="hljs-number"><span class="hljs-number">0</span></span>] ) { tr_free( tor-&gt;info.rename ); tor-&gt;info.rename = tr_strdup( str ); }</code> </pre> <br>  It can be noted that we do not set these flags anywhere (TR_FR_ *), but only check them, how does the manager learn about what to load? <br>  The answer is that the module uses the rule ‚Äúeverything is allowed, which is not prohibited‚Äù, that is, something like this: <b>flags &amp; = ~ deniedFieilds;</b> <br>  Boolean logic kindly tells us that our 20 and 21 bits will be set anyway. <br><br>  In fact, that's all.  In the patch indicated at the beginning of the topic there is the gtk and transmission-remote editing code, with the addition of this function, but everything is trivial there because these are actually simple clients redirecting requests to the server (directly to libtransmission for gtk, and through rpc for -remote) with a drop of business -logics. <br><br><h4>  Transmission.  Display Name. </h4><br>  So, with the main problem figured out, now there is a second subtask. <br>  I want to see in the client not a bunch of ‚ÄúSeason N‚Äù as names (namely, they will be given to us by the rpc server, because, as I explained at the beginning of the topic, my torrents are stored according to this scheme), but quite meaningful lines.  Therefore, we make a very small edit - just add a new property " <b>displayName</b> " and a set of getters / setters in the RPC interface. <br>  This is a very small and simple edit - we need to do the same thing as with the field <b>rename</b> , only without business logic and with the modification of rpc-return. <br><br>  The points: <br><ul><li>  Add a field to the <b>tr_torrent</b> structure in <b>transmission.h</b> </li><li>  In the <b>torrentSet</b> () function, <b>we</b> add a simple modification of <b>tor-&gt; displayName</b> using <b>tr_strdup</b> () and the " <b>displayName</b> " command, for example. </li><li>  Add a new field to <b>addField</b> (). </li><li>  The state manager also introduces a new key " <b>displayName</b> " with all the consequences. </li></ul><br><br>  When we change this field, it is necessary to mark the fact that the torrent is ‚Äúdirty‚Äù, that is, its state has been changed since the last save. <br><br>  In general, everything.  You can compile. <br><br> <code>./autogen.sh --disable-gtk <br> make <br> make install prefix=/usr <br></code> <br>  Now transmission has learned to perform this task, however, customers do not know about it. <br>  But it does not matter.  There are not so many modifications needed, and I have quite successfully corrected the dotNet Transmission GUI. <br>  I do not think that with other clients will be more difficult. <br><br><h4>  Links </h4><br><ul><li>  <a href="">Modified sources Transmission, rev 12431</a> </li><li>  <a href="">Modified Transmission Remote .NET sources</a> </li><li>  <a href="">Binary Transmission Remote .NET</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/119274/">https://habr.com/ru/post/119274/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../119264/index.html">Tariff "For Life" from Megaphone</a></li>
<li><a href="../119268/index.html">Dev Generation 2011: four nominations and $ 100 thousand</a></li>
<li><a href="../119269/index.html">Desktop decoration in Windows 7</a></li>
<li><a href="../119270/index.html">Caution: when updating / cleaning iOS devices ‚Äúdevice may be damaged‚Äù</a></li>
<li><a href="../119271/index.html">Unlocked Froyo for Huawei IDEOS S7 tablets</a></li>
<li><a href="../119275/index.html">Solar Impulse Solar Plane Made International Flight</a></li>
<li><a href="../119277/index.html">Smallest HD display: just 4.8 inches</a></li>
<li><a href="../119279/index.html">The book "Working with Postgresql: setting, scaling", version 2</a></li>
<li><a href="../119280/index.html">Spam - as a means of transmitting encryption?</a></li>
<li><a href="../119281/index.html">Spree 0.60.0 released</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>