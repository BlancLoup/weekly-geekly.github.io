<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Building a RESTful web API on the InterSystems platform - 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 


 Four years ago I wrote my first article on Habr√© and it was devoted to creating a RESTful web API on the InterSystems platform . A lo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Building a RESTful web API on the InterSystems platform - 2</h1><div class="post__text post__text-html js-mediator-article"><h2 id="vvedenie">  Introduction </h2><br><p>  Four years ago I wrote my first article on Habr√© and it was devoted to <a href="https://habrahabr.ru/company/intersystems/blog/204576/">creating a RESTful web API on the InterSystems platform</a> .  A lot of time has passed since then and several new releases have been released, which have significantly simplified the work on creating a RESTful web API.  Here I also want to tell about these changes in this article, and also to give some councils for creation of RESTful web API on the InterSystems platform. </p><a name="habracut"></a><br><h2 id="soderzhanie">  Content </h2><br><ul><li>  RESTful web API architecture </li><li>  Brokers </li><li>  Broker split </li><li>  Brokers parameters </li><li>  Code summary </li><li>  CORS </li><li>  Authentication </li><li>  Debugging and Testing Tools </li><li>  Examples </li><li>  Json </li><li>  findings </li><li>  Links </li></ul><br><h2 id="arhitektura-restful-web-api">  RESTful web API architecture </h2><br><p>  I hope that the reader is familiar with what RESTful web API is and the basics of its implementation on the InterSystems platform (available since version 2014.1).  Many articles / webinars / training courses in particular and <a href="https://habrahabr.ru/company/intersystems/blog/204576/">my previous article are</a> devoted to this.  In any case, the first thing I would like to start is the overall high-level architecture of your application, including the RESTful web API.  It can look like this: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/aw/_w/jo/aw_wjotau3pqc_omrc8h_piwyk0.png"></div><br><p>  This diagram presents the main levels of your solution: </p><br><h3 id="dannye">  Data </h3><br><p>  Stored classes on the InterSystems platform. </p><br><h3 id="terminalnoe-api">  Terminal API </h3><br><p>  The layer of interaction with the data.  Data should not be changed otherwise than through this API. <br>  The methods of this API are not written to the device.  The terminal API may return: </p><br><ul><li>  An object </li><li>  Status or exception (depending on your preference) </li></ul><br><h3 id="web-api">  Web API </h3><br><p>  Converts an incoming request to a form understood by the terminal API and calls the methods of the terminal API.  The result of the terminal API execution is returned to the client. <br>  The web API does not interact with the data directly.  I use the term Web API and not the RESTful web API, since  The Web API can be implemented using a different architecture, for example, based on the WebSocket protocol which is also supported by the InterSystems platform, which has already been <a href="https://habrahabr.ru/company/intersystems/blog/181113/">written on Habr√© more</a> <a href="https://habrahabr.ru/company/intersystems/blog/144311/">than once</a> . </p><br><h3 id="klient">  Customer </h3><br><p>  Typically, a JavaScript (but not necessarily) application is available to the end user.  This level should not have direct connections to the database, be loaded with basic business logic, and store the state of the application.  Only the simplest business logic is usually brought to this level: an authorization interface, validation of input values ‚Äã‚Äãfor validity and compliance with the format, simple data operations (sorting, grouping, counting values) already loaded on the client. </p><br><p>  This separation increases the configurability of the application, making it easier to debug, find and fix errors.  In essence, this is a <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D1%2580%25D1%2591%25D1%2585%25D1%2583%25D1%2580%25D0%25BE%25D0%25B2%25D0%25BD%25D0%25B5%25D0%25B2%25D0%25B0%25D1%258F_%25D0%25B0%25D1%2580%25D1%2585%25D0%25B8%25D1%2582%25D0%25B5%25D0%25BA%25D1%2582%25D1%2583%25D1%2580%25D0%25B0">three-tier</a> application building <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D1%2580%25D1%2591%25D1%2585%25D1%2583%25D1%2580%25D0%25BE%25D0%25B2%25D0%25BD%25D0%25B5%25D0%25B2%25D0%25B0%25D1%258F_%25D0%25B0%25D1%2580%25D1%2585%25D0%25B8%25D1%2582%25D0%25B5%25D0%25BA%25D1%2582%25D1%2583%25D1%2580%25D0%25B0">architecture</a> . </p><br><h2 id="brokery">  Brokers </h2><br><p>  Brokers are classes that contain the logic of your RESTful web API.  They: </p><br><ul><li> Inherited from <code>%CSP.REST</code> </li><li>  Contains paths ‚Äî matching URIs and callable methods </li></ul><br><p>  Example path: </p><br><pre> <code class="hljs pgsql">&lt;Route Url="/path/:param1/:param2" <span class="hljs-keyword"><span class="hljs-keyword">Method</span></span>="GET" <span class="hljs-keyword"><span class="hljs-keyword">Call</span></span>="Package.Class:ClassMethod" /&gt;</code> </pre> <br><p>  Where <code>ClassMethod</code> is any class method. </p><br><h2 id="razdelenie-brokerov">  Broker split </h2><br><h3 id="fizicheskoe-razdelenie">  "Physical" separation </h3><br><p>  Since there can be many ways in the RESTful web API - methods, one broker will soon be overloaded with methods.  To avoid this, divide the brokers into several classes as follows: <br><img src="https://habrastorage.org/webt/mj/kz/h7/mjkzh7smxkjblmufguoapmdna6m.png" alt="Broker split"></p><br><p>  Where: </p><br><ul><li>  An abstract broker is responsible for query conversion, CORS, and other technical issues not related to the RESTful web API logic. </li><li>  Brokers 1..N actually contains methods that process requests (calling terminal API methods and returning responses from the terminal API to the client). </li></ul><br><h3 id="logicheskoe-razdelenie-i-versionirovanie">  "Logical" separation and versioning </h3><br><p>  Brokers usually contain paths - URI mappings and called methods, but in addition to paths, brokers can ‚Äúsend‚Äù requests to each other.  It looks like this: </p><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Map</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Prefix</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/form"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Forward</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Destination.Broker"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre> <br><p>  This allows for the separation of brokers by subject areas with which they are associated, as well as to ensure API versioning: </p><br><p><img src="https://habrastorage.org/webt/6g/xk/ig/6gxkig-av8mf-was2j4ydjv1ogu.png" alt="Logical division of brokers"></p><br><h2 id="parametry-brokerov">  Brokers parameters </h2><br><p>  Here are the parameters that are recommended to set in the brokers of your RESTful web API: </p><br><pre> <code class="hljs pgsql">Parameter CONTENTTYPE = {..#CONTENTTYPEJSON}; Parameter CHARSET = "UTF-8"; Parameter UseSession <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-type"><span class="hljs-type">BOOLEAN</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><p>  That is what they are responsible for: </p><br><ul><li>  CONTENTTYPE - adds to all server responses information that the response will be in JSON format. </li><li>  CHARSET - converts the response to UTF8. </li><li>  UseSession - uses session for user requests.  Read more about this in the authentication section. </li></ul><br><p>  Since all brokers are inherited from one abstract broker, it is enough to specify these parameters once in an abstract broker (only the parameters of the first superclass are inherited). </p><br><h2 id="obobschenie-koda">  Code summary </h2><br><p>  One of the problems often encountered when writing a RESTful web API is copy-paste code from a broker to a broker, which creates a large number of paths and lines of code.  To avoid this, I recommend using <a href="">code generation in</a> conjunction with the <a href="">% Dictionary package</a> containing all the meta information necessary for writing the generator method.  An example of active use of code generation is <a href="https://habrahabr.ru/company/intersystems/blog/330822/">the RESTForms library</a> .  In addition, using code generation allows you to achieve greater uniformity in your RESTful web API. </p><br><h2 id="cors">  CORS </h2><br><p>  <a href="https://ru.wikipedia.org/wiki/Cross-origin_resource_sharing">The technology of</a> modern browsers, which allows you to provide a web page with access to resources of another domain.  To enable access to your RESTful web API using CORS, add a parameter to the broker: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">Parameter</span></span> HandleCorsRequest = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><p>  What will provide access from any other domain.  This is unsafe and therefore you must also override the <code>OnHandleCorsRequest</code> method, its signature: </p><br><pre> <code class="hljs delphi">ClassMethod OnHandleCorsRequest(pUrl <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %Status <span class="hljs-comment"><span class="hljs-comment">{}</span></span></code> </pre> <br><p>  This method should check the origin of the request, for example, it must match the host name of the web application.  To obtain Origin, you can use this method: </p><br><pre> <code class="hljs mel">ClassMethod GetOrigins() As %String { set url = %request.GetCgiEnv(<span class="hljs-string"><span class="hljs-string">"HTTP_REFERER"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $p(url,<span class="hljs-string"><span class="hljs-string">"/"</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-comment"><span class="hljs-comment">// get http(s)://origin.com:port }</span></span></code> </pre> <br><h2 id="autentifikaciya">  Authentication </h2><br><p>  In order for one user to consume one license and work within one session, you need to configure your REST and CSP applications in the System Management Portal so that the following conditions are met: </p><br><ol><li>  In all brokers <code>Parameter UseSession = 1;</code>  . </li><li>  All web applications are only available with authentication. </li><li>  All web applications have a session timeout (900, 3600). </li><li>  All applications have the same <code>GroupById</code> value. </li><li>  All applications have the same <code>Cookie Path</code> value. </li></ol><br><h2 id="instrumenty-otladki-i-testirovaniya">  Debugging and Testing Tools </h2><br><p>  For debugging, you can use external tools such as: </p><br><ul><li>  REST client (for example, Postman) - the primary debugging tool RESTful web API allows you to save and document requests, format JSON responses, execute requests to several environments, and provides many other conveniences to the developer. </li><li>  Interception proxy server (for example, Fiddler) - allows you to intercept, display, edit and duplicate requests to the RESTful web API. </li><li>  Traffic analyzer (for example, WireShark) - helps in cases of broken packets, problems with encodings, the need to analyze a remote system and other situations when the above tools are not enough. </li></ul><br><p>  I strongly recommend not using command line tools such as curl and wget. </p><br><p>  External and internal debugging tools are described in detail in a series of articles ( <a href="https://community.intersystems.com/post/debugging-web">Part 1 - external tools</a> , <a href="https://community.intersystems.com/post/debugging-web-part-2">Part 2 - internal tools</a> ) on the <a href="https://community.intersystems.com/">InterSystems Developer Community</a> . </p><br><h2 id="primery">  Examples </h2><br><p>  I will give a few examples of RESTful web API. </p><br><h3 id="mdx2json-i-klient-deepseeweb">  MDX2JSON and DeepSeeWeb client </h3><br><p>  <a href="https://github.com/intersystems-ru/Cache-MDX2JSON">MDX2JSON</a> - RESTful web API provides information about cubes, pivots, dashboards and many other DeepSee elements, in particular, the results of MDX queries, which allows you to embed the user interface of the analytical solution on DeepSee into any modern Web or mobile application.  Works since version 2014.1. <br>  <a href="https://github.com/intersystems-ru/DeepSeeWeb">DeepSeeWeb</a> - AngularJS application that provides an alternative implementation of the DeepSee user portal.  Can be easily customized.  Uses MDX2JSON as a backend.  Here is an example of a dashboard rendered in DeepSeeWeb: </p><br><p><img src="https://habrastorage.org/web/815/5ab/c73/8155abc739b64bb1a4a90978f2ad2a18.png" alt="DeepSeeWeb"></p><br><p>  Detailed article about <a href="https://habrahabr.ru/company/intersystems/blog/335586/">DeepSee</a> . </p><br><h3 id="ensembleworkflow-i-klient-ensembleworkflowui">  EnsembleWorkflow and the EnsembleWorkflowUI client </h3><br><p>  The InterSystems integration platform has an <a href="https://habrahabr.ru/company/intersystems/blog/251611/">Ensemble Workflow</a> subsystem that allows people to participate in automated business processes.  <a href="https://github.com/intersystems-ru/EnsembleWorkflow">Ensemble Workflow RESTful web API</a> and <a href="https://github.com/intersystems-ru/EnsembleWorkflowUI">EnsembleWorkflowUI</a> client.  RESTful web API provides access to user tasks.  Works since version 2014.1.  Here is the visualization: </p><br><p><img src="https://habrastorage.org/files/1b1/5ea/25c/1b15ea25ccbb41c89e3a4be6f3b35cfb.png" alt="EnsembleWorkflowUI"></p><br><p><img src="https://habrastorage.org/files/f70/355/030/f703550305be4c3d85ed2202019f196c.png" alt="EnsembleWorkflowUI"></p><br><h3 id="restforms">  RESTForms </h3><br><p>  <a href="https://habrahabr.ru/company/intersystems/blog/330822/">RESTForms</a> is a universal RESTful web API backend of working with data on the InterSystems 2016 platform 2016+ for modern web applications. </p><br><p>  Here are some of the paths available in RESTForms: </p><br><table><thead><tr><th>  URL </th><th>  Description </th></tr></thead><tbody><tr><td>  info </td><td>  Class list </td></tr><tr><td>  info / all </td><td>  Meta-information of all classes </td></tr><tr><td>  info /: class </td><td>  Meta-information of one class </td></tr><tr><td>  object /: class /: id </td><td>  Get object </td></tr><tr><td>  object /: class /: id /: property </td><td>  Get object property </td></tr><tr><td>  object /: class </td><td>  Create object </td></tr><tr><td>  object /: class /: id </td><td>  Update object from dynamic object </td></tr><tr><td>  object /: class </td><td>  Update object from class object </td></tr><tr><td>  object /: class /: id </td><td>  Delete object </td></tr><tr><td>  objects /: class /: query </td><td>  Execute SQL query </td></tr></tbody></table><br><p>  In this project, code compilation is actively used (using code generation and using the <code>%Dictionary</code> package). </p><br><p>  <a href="https://github.com/intersystems-ru/RESTFormsUI">Angular</a> and <a href="https://github.com/intersystems-ru/RESTFromsUI-react">React</a> clients are available, it looks like this: </p><br><p><img src="https://habrastorage.org/web/402/b4b/e02/402b4be02e8e48779c7a925aa706e5fd.png" alt="class list"></p><br><h2 id="json">  Json </h2><br><p>  JavaScript Object Notation is a text-based data exchange format used in conjunction with the RESTful web API.  JSON support on the InterSystems platform has appeared since version 2009.2, but has been significantly improved to version 2016.2.  Read more about using JSON in the <a href="">documentation</a> . </p><br><h2 id="vyvody">  findings </h2><br><ul><li>  REST today - the main and generally accepted method of constructing an API for the Internet </li><li>  By providing a RESTful web API, you get the opportunity to choose from a huge set of technologies to build client applications, including: <br><ul><li>  JavaScript (AngularJS, React, extJS, ...) </li><li>  Mobile applications (Cordova and the like, Native) </li></ul></li><li>  InterSystems technologies allow you to easily create a RESTful web API. </li></ul><br><h2 id="ssylki">  Links </h2><br><ul><li>  <a href="https://habrahabr.ru/company/intersystems/blog/204576/">Part I</a> </li><li>  <a href="https://www.youtube.com/watch%3Fv%3DPISLMjpmIvY">Webinar about RESTful web API architecture</a> </li><li>  <a href="https://www.youtube.com/watch%3Fv%3DQ7xqqKEwv7U">Webinar about developing RESTful web API</a> </li><li>  <a href="">Documentation</a> </li><li>  <a href="https://community.intersystems.com/post/lets-write-angular-1x-app-cach%25C3%25A9-rest-backend-start-here">RESTful web API development series</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/345532/">https://habr.com/ru/post/345532/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345522/index.html">UE4 and mobile development: myths and reality</a></li>
<li><a href="../345524/index.html">How the concept helps not to get stuck in the development of a new product for years</a></li>
<li><a href="../345526/index.html">Modify Python in 6 minutes</a></li>
<li><a href="../345528/index.html">Personal Financial Management System</a></li>
<li><a href="../345530/index.html">Avito X: people - people</a></li>
<li><a href="../345534/index.html">As I wrote my own ERP system, ver. 2.0</a></li>
<li><a href="../345538/index.html">40-year-old taxi driver from Tambov became a programmer</a></li>
<li><a href="../345542/index.html">How changing two lines of code can take several days</a></li>
<li><a href="../345546/index.html">Asynchronous loading of large datasets into Tensorflow</a></li>
<li><a href="../345550/index.html">How EdTech Leaders Earn</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>