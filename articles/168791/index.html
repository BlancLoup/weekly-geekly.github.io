<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Installing and configuring KVM running CentOS 6</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings, Habrazhiteli! 

 Today I want to share with you one of my established manuals, which are perfected by multiple use, about which I can say w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Installing and configuring KVM running CentOS 6</h1><div class="post__text post__text-html js-mediator-article">  Greetings, Habrazhiteli! <br><br>  Today I want to share with you one of my established manuals, which are perfected by multiple use, about which I can say with confidence that ‚Äúit works for sure!‚Äù Without any extra dancing with a tambourine. <br>  <b>The</b> article <b>focuses</b> more <b>on novice</b> system administrators than on gurus (for them there is nothing new here :)), and in it I will try to uncover a working and fairly quick option for deploying a virtual machine server, while trying to cover as many nuances and pitfalls as possible. <br><br>  However, I will be glad to the attention of knowledgeable and experienced admins, who may give good advice and help correct errors, if any. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Disclaimer</b> <div class="spoiler_text">  Correct, if not, but in the search I did not find the implementation of this task on CentOS with a detailed description of all steps for beginners. <br>  A good series of articles written by <a href="http://habrahabr.ru/users/librarian/" class="user_link">librarian</a> , but they are for Debian. <br>  Naturally, for experienced admins, this is no problem, but I repeat, my task is to describe detailed instructions for newbies. <br><br>  <b>Question:</b> There are many guides on the Internet for installing Qemu KVM under CentOS, you will argue, and what is this article going to be interesting for? <br>  <b>Answer:</b> it describes the complete cycle of installing and configuring components necessary for virtualization, installing guest virtual machines (VM), setting up a white and gray network for VMs, as well as some aspects that will help simplify VM management using forwarding graphics from a remote server to your PC and launching virt-manager. <br></div></div><br><br>  Remember the <a href="http://habrahabr.ru/post/157899/">7 steps?</a> <br><a name="habracut"></a><br><br>  To begin with, if you are reading this, then you already have CentOS 6 OS (I used version 6.3), and to install guest VMs of different bitness (32 or 64), the host server (the physical server on which we will install KVM along with VM) should be exactly with a 64-bit OS. <br>  All actions are performed as <i>root.</i> <br><br>  <b>So let's get down to leadership.</b> <br><br>  <b>1. Step - Preparation</b> <br><br>  Check if the CPU supports hardware virtualization: <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># egrep '(vmx|svm)' /proc/cpuinfo</span></span></code> </pre> <br>  If the output is not empty, then the processor supports hardware virtualization. <br>  Who cares, all actions were performed on the configuration of Intel Xeon Quad Core E3-1230 3.20 GHz / 8GB / 2x 1TB. <br><br>  Install KVM and virtualization libraries: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># yum install kvm libvirt</span></span></code> </pre><br>  We start the KVM service <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># service libvirtd start</span></span></code> </pre><br>  See if the KVM module is loaded. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># lsmod | grep kvm</span></span></code> </pre><br>  Should get a conclusion: <br><pre> <code class="bash hljs">kvm_intel 52890 16 kvm 314739 1 kvm_intel</code> </pre><br>  In this case, we see that the <b>kvm_intel</b> module is <b>loaded</b> , since the CPU <b>arbitrator</b> is Intel. <br><br>  Check KVM connectivity <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># virsh sysinfo</span></span></code> </pre><br>  Should get a conclusion: <br><pre> <code class="bash hljs">&lt;sysinfo <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">'smbios'</span></span>&gt; &lt;bios&gt; &lt;entry name=<span class="hljs-string"><span class="hljs-string">'vendor'</span></span>&gt;HP&lt;/entry&gt; &lt;entry name=<span class="hljs-string"><span class="hljs-string">'version'</span></span>&gt;J01&lt;/entry&gt; .....</code> </pre><br><br>  <b>2. Step - Creating Storage for Virtual Machines (Storage Pool)</b> <br><br>  <a href="https://access.redhat.com/knowledge/docs/en-US/Red_Hat_Enterprise_Linux/6/html/Virtualization_Administration_Guide/chap-Virtualization_Administration_Guide-Storage_Pools-Storage_Pools.html">Here</a> is a description of how to configure different types of storage. <br>  In this example, a simple type of storage is described - for each VM, a new * .img file is created for the virtual hard disk (or disks - if you add several), they will be placed in the / guest_images directory. <br>  Only we have this directory will be the mount point of a separate hard disk host server, specially designated for these needs. <br>  The security of data storage and the fact that you need to create at least a mirror raid array, so as not to lose VM data in the event of a hard disk failure, we will not, as this is a separate topic. <br><br>  Let's look at the list of physical disks on the host server: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># fdisk -l</span></span></code> </pre><br>  The result was: <br><pre> <code class="bash hljs">Disk /dev/sda: 1000.2 GB, 1000204886016 bytes ...... Disk /dev/sdb: 1000.2 GB, 1000204886016 bytes ......</code> </pre><br>  There is an OS installed on the <b>sda</b> hard disk, we don‚Äôt touch it, but on <b>sdb</b> we create a partition for all free space on the <b>ext4</b> file system: <br>  (more details about the following operations can be read <a href="http://w.abcd.bz/web-servers/ustanovka-dopolnitelnogo-zhestkogo-diska-v-centos.html">here</a> ) <br><br>  We select a disk for editing <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># fdisk /dev/sdb</span></span></code> </pre><br>  Create a new section <br><pre> <code class="bash hljs">Command (m <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">help</span></span>): n Command action e extended p primary partition (1-4) p Partition number (1-4): 1</code> </pre><br>  Save changes <br><pre> <code class="bash hljs">Command (m <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">help</span></span>): w The partition table has been altered!</code> </pre><br>  Create an ext4 file system on the entire free space of the disk / dev / sdb <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mkfs.ext4 /dev/sdb1</span></span></code> </pre><br>  Create a mount point for our hard disk for virtual machine files: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mkdir /guest_images # chmod 700 /guest_images # ls -la /guest_images total 8 drwx------. 2 root root 4096 May 28 13:57 . dr-xr-xr-x. 26 root root 4096 May 28 13:57 ..</span></span></code> </pre><br>  Many advise you to disable <a href="http://ru.wikipedia.org/wiki/SELinux">Selinux altogether</a> , but we will choose a different path.  We will set it up correctly. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># semanage fcontext -a -t virt_image_t /guest_images</span></span></code> </pre><br>  If the execution of this command is not successful, you need to install an additional package.  First, find out which package provides this command. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># yum provides /usr/sbin/semanage</span></span></code> </pre><br>  We get the output: <br><pre> <code class="bash hljs">Loaded plugins: rhnplugin policycoreutils-python-2.0.83-19.8.el6_0.x86_64 : SELinux policy core python utilities Repo : rhel-x86_64-server-6 Matched from: Filename : /usr/sbin/semanage policycoreutils-python-2.0.83-19.1.el6.x86_64 : SELinux policy core python utilities Repo : rhel-x86_64-server-6 Matched from: Filename : /usr/sbin/semanage</code> </pre><br>  Install policycoreutils-python <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># yum -y install policycoreutils-python</span></span></code> </pre><br>  After that again: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># semanage fcontext -a -t virt_image_t /guest_images</span></span></code> </pre><br>  Mount the / dev / sdb1 partition in / guest_images <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mount -t ext4 /dev/sdb1 /guest_images</span></span></code> </pre><br>  Edit the <b>/ etc / fstab file</b> so that when the host server is restarted, the partition with the VM will be mounted automatically <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vi /etc/fstab</span></span></code> </pre><br>  Add a line following the example of those already in the file. <br><pre> <code class="bash hljs">/dev/sdb1 /guest_images ext4 defaults 1 1</code> </pre><br>  Save the file and continue to create the repository: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># virsh pool-define-as guest_images_dir dir - - - - "/guest_images" Pool guest_images_dir defined</span></span></code> </pre><br>  Check if it was created: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># virsh pool-list --all Name State Autostart ----------------------------------------- default active yes guest_images_dir inactive no</span></span></code> </pre><br>  Further: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># virsh pool-build guest_images_dir Pool guest_images_dir built</span></span></code> </pre><br>  We start storage: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># virsh pool-start guest_images_dir Pool guest_images_dir started # virsh pool-list --all Name State Autostart ----------------------------------------- default active yes guest_images_dir active no</span></span></code> </pre><br>  Add to autoload: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># virsh pool-autostart guest_images_dir Pool guest_images_dir marked as autostarted # virsh pool-list --all Name State Autostart ----------------------------------------- default active yes guest_images_dir active yes</span></span></code> </pre><br>  Checking: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># virsh pool-info guest_images_dir</span></span></code> </pre><br><br>  <b>3. Step - Setting up the network on the host server</b> <br><br>  <b>!!!</b>  <b>IMPORTANT!!!</b> <br>  Before performing this step, you need to make sure that the host server has the <b>bridge-utils</b> package installed, <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># rpm -qa | grep bridge-utils</span></span></code> </pre><br>  otherwise, when performing operations with a network, you risk losing communication with the server, especially offensive if it is remote and you do not have physical access to it.  If the output of the previous command is empty, then: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># yum -y install bridge-utils</span></span></code> </pre><br>  Suppose that the interface <b>eth0 was</b> used to exit "into the world" and it was configured accordingly. <br>  It is configured with the IP address 10.110.10.15 of the / 24 network, the mask - 255.255.255.0, the gateway 10.110.10.1. <br>  We continue, we create the network interface like "bridge" on a host server <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vi /etc/sysconfig/network-scripts/ifcfg-br0</span></span></code> </pre><br>  <i>File contents</i> <br><pre> <code class="bash hljs">DEVICE=<span class="hljs-string"><span class="hljs-string">"br0"</span></span> NM_CONTROLLED=<span class="hljs-string"><span class="hljs-string">"no"</span></span> ONBOOT=<span class="hljs-string"><span class="hljs-string">"yes"</span></span> TYPE=<span class="hljs-string"><span class="hljs-string">"Bridge"</span></span> BOOTPROTO=<span class="hljs-string"><span class="hljs-string">"static"</span></span> IPADDR=<span class="hljs-string"><span class="hljs-string">"10.110.10.15"</span></span> GATEWAY=<span class="hljs-string"><span class="hljs-string">"10.110.10.1"</span></span> DNS1=<span class="hljs-string"><span class="hljs-string">"8.8.8.8"</span></span> DNS2=<span class="hljs-string"><span class="hljs-string">"8.8.4.4"</span></span> MTU=<span class="hljs-string"><span class="hljs-string">"1500"</span></span> NETMASK=<span class="hljs-string"><span class="hljs-string">"255.255.255.0"</span></span> DEFROUTE=<span class="hljs-string"><span class="hljs-string">"yes"</span></span> IPV4_FAILURE_FATAL=<span class="hljs-string"><span class="hljs-string">"yes"</span></span> IPV6INIT=<span class="hljs-string"><span class="hljs-string">"no"</span></span> NAME=<span class="hljs-string"><span class="hljs-string">"System br0"</span></span></code> </pre><br>  Here is the main network interface, which was used to enter the "world", to the form: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vi /etc/sysconfig/network-scripts/ifcfg-eth0 DEVICE="eth0" BOOTPROTO="none" HOSTNAME="localhost.localdomain" HWADDR="00:9C:02:97:86:70" IPV6INIT="no" MTU="1500" NM_CONTROLLED="no" ONBOOT="yes" TYPE="Ethernet" NAME="System eth0" BRIDGE="br0"</span></span></code> </pre><br>  <b>!!!</b>  <b>Important!!!</b> <br>  DEVICE = "eth0" The interface name must remain as it was on the system.  If you use the eth1 interface to access the Internet, then you need to edit it. <br>  <i>HWADDR = "00: 2C: C2: 85: 29: A3" The</i> MAC address must also remain the same as it was in the system <br><br>  When everything is checked, restart the network: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># service network restart</span></span></code> </pre><br>  Check the status of the connection type "bridge": <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># brctl show</span></span></code> </pre><br>  We get something like this <br><pre> <code class="bash hljs">bridge name bridge id STP enabled interfaces br0 8000.002cc28529a3 no eth0</code> </pre><br>  We make settings in <b>iptables</b> so that virtualok traffic ‚Äúgoes‚Äù through a <i>bridge</i> connection <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># iptables -I FORWARD -m physdev --physdev-is-bridged -j ACCEPT # service iptables save # service iptables restart</span></span></code> </pre><br>  <i>Optionally:</i> you can improve the speed of the bridge connection by adjusting the settings in <b>/etc/sysctl.conf</b> <br><pre> <code class="bash hljs">net.bridge.bridge-nf-call-ip6tables = 0 net.bridge.bridge-nf-call-iptables = 0 net.bridge.bridge-nf-call-arptables = 0</code> </pre><br>  Thereafter <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># sysctl -p /etc/sysctl.conf # service libvirtd reload</span></span></code> </pre><br><br>  <b>4. Step - Installing a new virtual machine</b> <br><br>  <i>Installing CentOS on a guest VM:</i> <br><pre> <code class="bash hljs">virt-install -n VMName_2 --ram 1024 --arch=x86_64 \ --vcpus=1 --cpu host --check-cpu \ --extra-args=<span class="hljs-string"><span class="hljs-string">"vnc sshd=1 sshpw=secret ip=static reboot=b selinux=0"</span></span> \ --os-type linux --os-variant=rhel6 --boot cdrom,hd,menu=on \ --disk pool=guest_images_dir,size=50,bus=virtio \ --network=bridge:br0,model=virtio \ --graphics vnc,listen=0.0.0.0,keymap=ru,password=some.password.here \ --noautoconsole --watchdog default,action=reset --virt-type=kvm \ --autostart --location http://mirror.yandex.ru/centos/6.3/os/x86_64/</code> </pre><br>  <i>Note 1:</i> <br>  <b>VMName_2</b> - the name of the new virtual machine <br>  <b>‚ÄìRam 1024</b> - number of virtual memory <br>  <b>‚ÄìArch = x86_64</b> - <b>Virtual</b> OS OS Architecture <br>  <b>‚ÄìVcpus = 1</b> - number of virtual processors <br>  <b>‚ÄìOs-type linux</b> - OS type <br>  <b>‚ÄìDisk pool = guest_images_dir, size = 50</b> - storage location, Wirth size.  disk <br>  <b>‚ÄìNetwork = bridge: br0</b> <br><br>  <i>Note 2:</i> <br>  If the VM needs a ‚Äúwhite network‚Äù, then set <br>  <b>--network = bridge: br0</b> <br>  If the VM requires a ‚Äúgray network‚Äù, then set <br>  <b>--network = bridge: virbr0</b> <br>  In this case, the VM will be assigned a gray IP via <i>DHCP</i> from the host server. <br>  <b>--graphics vnc, listen = 0.0.0.0, keymap = ru, password = some.password.here</b> <br>  Here we specify the password to connect to the VM by vnc <br><br>  <i>Installing Windows on a guest VM:</i> <br><pre> <code class="bash hljs">virt-install --connect qemu:///system --arch=x86_64 \ -n VMName_1 -r 1024 --vcpus=1 \ --disk pool=guest_images_dir,size=50,bus=virtio,cache=none \ -c /iso/Windows2008R2RU.ISO --graphics vnc,listen=0.0.0.0,keymap=ru,password=some.password.here \ --noautoconsole --os-type windows --os-variant win2k8 \ --network=bridge:br0,model=e1000 --disk path=/iso/virtio-win.iso,device=cdrom,perms=ro</code> </pre><br>  <i>Note:</i> <br>  The parameters are the same as in the CentOS installation example.  But there are differences. <br>  When installing, Windows will not see the virtual hard disk, so you need to load the additional virtual <b>cdrom</b> with the drivers / iso / virti-win.iso - the location of the ISO file with the drivers of the virtual disk.  You can <a href="">get from here</a> . <br><br>  We execute the command to install the new VM, then connect via <a href="http://www.uvnc.com/downloads.html">vnc</a> to the host server to continue installing the OS.  In order to find out the port for the connection, perform: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># netstat -nltp | grep q tcp 0 0 0.0.0.0:5900 0.0.0.0:* LISTEN 64141/qemu-kvm tcp 0 0 0.0.0.0:5903 0.0.0.0:* LISTEN 63620/qemu-kvm tcp 0 0 0.0.0.0:5904 0.0.0.0:* LISTEN 6971/qemu-kvm tcp 0 0 0.0.0.0:5905 0.0.0.0:* LISTEN 57780/qemu-kvm</span></span></code> </pre><br>  When installing a new VM, the vnc server port will increase by 1. When you remove a VM, the port is released, <br>  and then issued a new VM.  That is, the port number of the latest VM is not necessarily the largest of the 590 ... <br>  To find out which vnc port virtualka with a specific name, enter: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># virsh vncdisplay VMName_1 :3</span></span></code> </pre><br>  where <b>VMName_1</b> is the name of the VM <b>,:</b> <b>3</b> is the number in order of the port starting from 5900, that is, you need to connect to port 5903, but in the UltraVNC program it will work as well <b>10.110.10.15.15</b> <br><img src="https://habrastorage.org/storage2/1f6/3d0/f3f/1f63d0f3f27bb6952c679cba97ace390.jpg"><br><br>  <i>Note</i> <br>  If the <b>Permission denied</b> error crashes while creating a VM, kvm cannot open the VM disk file * .img, <br>  This means you need to allow qemu-kvm actions to be performed as <b>root</b> (it is assumed that <br>  VM is produced from under a user specially created for this purpose, for example, <i>libvirt</i> ).  But we will manage also the <i>root user</i> . <br><br>  We fix the config: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vi /etc/libvirt/qemu.conf</span></span></code> </pre><br>  We find and uncomment the lines in it: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># The user ID for QEMU processes run by the system instance. user = "root" # The group ID for QEMU processes run by the system instance. group = "root"</span></span></code> </pre><br><br>  <b>Good to know:</b> <br>  VM configs are located here <b>/ etc / libvirt / qemu /</b> <br>  In order to edit the parameters (add a processor, RAM or something else), <br>  look for the VM config with the desired name, edit: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vi /etc/libvirt/qemu/VMName_1.xml</span></span></code> </pre><br>  For example, you can specify a static vnc port for a specific VM in order to always connect to the correct port. <br><pre> <code class="bash hljs">&lt;graphics <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">'vnc'</span></span> port=<span class="hljs-string"><span class="hljs-string">'5914'</span></span> autoport=<span class="hljs-string"><span class="hljs-string">'no'</span></span> listen=<span class="hljs-string"><span class="hljs-string">'0.0.0.0'</span></span> passwd=<span class="hljs-string"><span class="hljs-string">'some.password.here'</span></span>&gt; &lt;listen <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">'address'</span></span> address=<span class="hljs-string"><span class="hljs-string">'0.0.0.0'</span></span>/&gt; &lt;/graphics&gt;</code> </pre><br>  Now this VM has vnc port - 5914. Do not forget to reload libvirtd to apply the changes.  The VM itself should also be rebooted.  Therefore, change the VM configuration file while it is turned off, then perform service libvirtd reload, then start the VM. <br><br>  <b>Commands to control VM:</b> <br><pre> <code class="bash hljs">virsh -c qemu:///system <span class="hljs-built_in"><span class="hljs-built_in">help</span></span>     virsh -c qemu:///system list --all     virsh -c qemu:///system start vsrv1   vsrv1 virsh -c qemu:///system shutdown vsrv1      virsh -c qemu:///system destroy vsrv1     virsh -c qemu:///system undefine vsrv1  </code> </pre><br><br>  <b>5. Step - Network configuration in case of ‚Äúgray‚Äù IP addresses in the VM</b> <br><br>  If at the 4th step you selected a gray network for the new VM (--network = bridge: virbr0), then you need to perform the following actions ( <b>on the host server!</b> ) To forward the traffic to the VM <br>  Allow forwarding traffic at the kernel level: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># sysctl net.ipv4.ip_forward=1 # iptables -I FORWARD -j ACCEPT # iptables -t nat -I PREROUTING -p tcp -d 10.110.10.15 --dport 5910 -j DNAT --to-destination 192.168.122.170:5901</span></span></code> </pre><br>  Here 10.110.10.15 is the white (external) IP of the host server.  192.168.122.170 - gray IP-address of the guest OS. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># iptables -t nat -I POSTROUTING -p tcp -s 192.168.122.170 --sport 5901 -j SNAT --to-source 10.110.10.15:5910</span></span></code> </pre><br>  <i>On the example of installing CentOS OS on a guest machine, when the installation went into graphics mode, and offers to connect to the local port 5901 of the guest OS.</i> <br>  Connecting from the PC you are sitting at, by <i>vnc</i> to 10.110.10.15:5910 or 10.110.10.15:10 will also work in UltraVNC. <br><br>  By the same principle, you can throw the port (standard) RDP 3389 or SSH 22 in the guest OS. <br><br>  <b>6. Step - Preparation for managing virtual machines of a remote server with a convenient graphical interface (using virt-manager)</b> <br><br>  There are many ways to propel the graphics of a remote server on a PC, for which you perform administration actions.  We will focus on ssh tunneling. <br>  Suppose that you are performing actions from a local PC running Windows (on Linux operating systems, this is much easier :), you need to execute just one <i>ssh -X username@12.34.56.78</i> command, of course, with the proviso that on a remote <b>X11</b> server <b>forwarding is</b> enabled and you are sitting at the local Linux PC with a graphical shell), then we need <br><br>  1. Everyone knows <a href="">PuTTY</a> , <br>  2. X Server Port for Windows - <a href="http://sourceforge.net/projects/xming/">Xming</a> <br>  3. In the PuTTY settings, enable ‚ÄúEnable X11 Forwarding‚Äù <br>  Make as shown in the picture: <br><img src="https://habrastorage.org/storage2/86b/843/a08/86b843a08d86a30365e8655a372c3ab7.jpg"><br><br>  At the time of connecting to a remote server, Xming should already be running. <br>  On the CentOS for SSH host server, enable <b>X11 Forwarding</b> , to do this, edit the <b>sshd_config</b> file: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vi /etc/ssh/sshd_config X11Forwarding yes X11DisplayOffset 10 X11UseLocalhost yes</span></span></code> </pre><br>  Thereafter <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /etc/init.d/sshd restart</span></span></code> </pre><br>  Install virt-manager on the host server: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># yum install virt-manager</span></span></code> </pre><br>  Another component <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># yum -y install xorg-x11-xauth</span></span></code> </pre><br>  To display windows without kryakozyabr <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># yum install liberation-sans-fonts</span></span></code> </pre><br><br>  <b>7. Step - Immediately launch virt-manager</b> <br><br>  After that, you need to restart via SSH to the remote server.  Xming must be running. <br>  We start the graphic management utility of virtual computers <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># virt-manager</span></span></code> </pre><br>  The virt-manager window opens. <br><img src="https://habrastorage.org/storage2/79d/42f/03c/79d42f03cb8668d60462eafb48e2c697.jpg"><br><br>  VM Management Console <br><img src="https://habrastorage.org/storage2/21c/2a3/f3b/21c2a3f3bda29b88ae6baf9c1daae2e7.jpg"><br><br>  VM configuration and its change <br><img src="https://habrastorage.org/storage2/76a/9bd/298/76a9bd2984730ecc1298ccfc47a01d7c.jpg"><br><br>  I hope the reader liked the article.  Personally, I would have read a similar in my time, would have dramatically reduced the time spent in order to shovel a lot of manuals from different admins for different operating systems;  would save a lot of time spent on googling when more and more nuances appeared. <br><br>  I would be happy for comments, suggestions on this topic. </div><p>Source: <a href="https://habr.com/ru/post/168791/">https://habr.com/ru/post/168791/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../168773/index.html">Manage Windows services using PowerShell. Part 4. Changing services using WMI</a></li>
<li><a href="../168783/index.html">Simple power monitoring device</a></li>
<li><a href="../168785/index.html">Nokia and the Elop effect: continued</a></li>
<li><a href="../168787/index.html">The simple answer to the difficult question: Why does not work?</a></li>
<li><a href="../168789/index.html">TPB AFK</a></li>
<li><a href="../168795/index.html">Autopsy Meizu MX2</a></li>
<li><a href="../168797/index.html">DOOM under DOSBox for a small company</a></li>
<li><a href="../168799/index.html">Vasily Voropaev resigned as CEO of Free-lance.ru</a></li>
<li><a href="../168801/index.html">The digest of interesting news and materials from the world of ayti for the last week ‚Ññ43 (February 2 - 8, 2013)</a></li>
<li><a href="../168807/index.html">Playstation: how it was</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>