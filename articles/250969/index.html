<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Collect and analyze logs from Fluentd</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Any system administrator in his daily activities has to deal with the collection and analysis of logs. Collected logs need to be stored - they may be ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Collect and analyze logs from Fluentd</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/0e7/67b/cc0/0e767bcc0f97ffa70ed57f2b1d4f1093.png" alt="fluentd" width="100%" height="100%"><br><br>  Any system administrator in his daily activities has to deal with the collection and analysis of logs.  Collected logs need to be stored - they may be needed for a variety of purposes: for debugging programs, for analyzing incidents, as an aid to technical support services, etc.  In addition, it is necessary to provide the ability to search the entire data array. <br><a name="habracut"></a><br><br>  Organizing the collection and analysis of logs is not as simple as it might seem at first glance.  Let's start with the fact that you have to aggregate the logs of different systems, which among themselves may have nothing at all in common.  The collected data is also very desirable to link to a single timeline in order to track the connections between events.  Implementing a log search is a separate and complex problem. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Over the past few years, interesting software tools have appeared that allow us to solve the problems described above.  Solutions that allow storing and processing logs online are becoming increasingly popular: <a href="http://www.splunk.com/" rel="nofollow">Splunk</a> , <a href="http://www.loggly.com/" rel="nofollow">Loggly</a> , <a href="http://papertrailapp.com/" rel="nofollow">Papertrail</a> , <a href="http://logentries.com/" rel="nofollow">Logentries,</a> and others.  Among the undoubted advantages of these services should be called a user-friendly interface and low cost of use (and they provide quite good opportunities within the framework of basic free tariffs).  But when working with large numbers of logs, they often do not cope with the tasks assigned to them.  In addition, their use for working with large amounts of information is often unprofitable from a purely financial point of view. <br><br>  A much more preferred option is to deploy a standalone solution.  We thought about this issue when we faced the need to collect and analyze the <a href="http://storage.selectel.ru/">cloud storage</a> logs. <br><br>  We began to look for a suitable solution and chose <a href="http://www.fluentd.org/" rel="nofollow">Fluentd</a> , an interesting tool with rather wide functionality, about which there are almost no detailed publications in Russian.  About the capabilities of Fluentd, we will describe in detail in this article. <br><br><h2>  general information </h2><br><br>  Fluend was developed by Sadayuki Furuhashi, co-founder of <a href="http://www.treasuredata.com/" rel="nofollow">Treasure Data</a> (she is one of the sponsors of the project), in 2011.  It is written in Ruby.  Fluentd is actively developing and improving (see the repository on GitHub, where updates are consistently displayed every few days). <br><br>  Fluentd users include such famous companies as Nintendo, Amazon, Slideshare, and others. <br>  Fluentd collects logs from various sources and sends them to other applications for further processing.  Schematically, the process of collecting and analyzing logs using Fluentd can be represented as follows: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a50/9a0/c82/a509a0c8241e3b4b0fff881501b8f2c9.png" alt="Fluentd" width="100%" height="100%"><br><br>  The main advantages of Fluentd are the following: <br><br><ul><li>  <b>Low requirements for system resources.</b>  For normal operation, Fluentd is quite enough 30 - 40 MB of RAM;  the processing speed is 13,000 events per second. </li><li>  <b>Using a unified logging format.</b>  Fluentd translates data from various sources into JSON.  This helps to solve the problem of collecting logs from various systems and opens up wide opportunities for integration with other software solutions. </li><li>  <b>Comfortable architecture.</b>  The Fluentd architecture allows you to extend the existing set of functions with the help of numerous plug-ins (to date, more than 300 of them have been created).  With the help of plug-ins, you can connect new data sources and display data in various formats. </li><li>  <b>Ability to integrate with various programming languages.</b>  Fluentd can receive logs from applications in Python, Ruby, PHP, Perl, Node.JS, Java, Scala. </li></ul><br><br>  Fluentd is distributed free under the Apache 2.0 license.  The project is documented in sufficient detail;  on the official website and in the blog published a lot of useful educational materials. <br><br><h2>  Installation </h2><br><br>  In this article, we describe the installation procedure for Ubuntu OS 14.04.  Installation instructions for other operating systems can be found here. <br><br>  The installation and initial configuration of Fluentd is performed using a special script.  Run the commands: <br><br><pre> $ wget http://packages.treasuredata.com/2/ubuntu/trusty/pool/contrib/t/td-agent/td-agent_2.0.4-0_amd64.deb

 $ sudo dpkg -i td-agent_2.0.4-0_amd64.deb
</pre><br><br>  When installation is complete, run Fluentd: <br><br><pre> $ /etc/init.d/td-agent restart
</pre><br><br><h2>  Configuration </h2><br><br>  The principle of operation of Fluentd is as follows: it collects data from various sources, checks for compliance with certain criteria, and then sends them to specified locations for storage and further processing.  Clearly all this can be represented in the form of the following scheme: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/eea/207/eec/eea207eec9b61d0cd79bbb994c5d8da2.png" alt="Fluentd" width="100%" height="100%"><br><br>  The settings for fluentd (what data and where to get, what criteria they must meet, where to send them) are written in the configuration file /etc/td-agent/td-agent.conf, which is built from the following blocks: <br><br><ul><li>  source - contains information about the data source; </li><li>  match - contains information about where the received data should be sent; </li><li>  include - contains information about file types; </li><li>  system - contains system settings. </li></ul><br><br>  Consider the structure and content of these blocks in more detail. <br><br><h3>  Source: where to get the data </h3><br><br>  The source block contains information on where to get the data.  Fluentd can receive data from various sources: these are application logs in various programming languages ‚Äã‚Äã(Python, PHP, Ruby, Scala, Go, Perl, Java), database logs, logs from various hardware devices, monitoring utilities data ... With a full list of possible sources data is available here.  For connecting sources, specialized plugins are used. <br>  The standard plugins include http (used to receive HTTP messages) and forward (used to receive TCP packets).  You can use both of these plugins at the same time. <br>  Example: <br><br><pre> # Receive events from port 24224 / tcp
 &lt;source&gt;
   type forward
   port 24224
 &lt;/ source&gt;

 # http://this.host:9880/myapp.access?json={"event":"data "}
 &lt;source&gt;
   type http
   port 9880
 &lt;/ source&gt;
</pre><br><br>  As can be seen from the above example, the type of the plugin is specified in the type directive, and the port number is specified in the port directive. <br>  The number of data sources is unlimited.  Each data source is described in a separate &lt;source&gt; block. <br>  All events received from sources are sent to the message router.  Each event has three attributes: tag, time and record.  Based on the tag attribute, a decision is made about where the events should be redirected (more on this later in this article).  The time attribute indicates the time (this is done automatically), and the record attribute specifies the data in JSON format. <br>  Here is an example of the event description: <br><br><pre> # generated by http://this.host:9880/myapp.access?json={"event":"data "}
 tag: myapp.access
 time: (current time)
 record: {"event": "data"}
</pre><br><br><h3>  Match: what to do with the data </h3><br><br>  In the Match section, it is indicated on which grounds events will be selected for further processing.  Specialized plugins are used for this. <br><br>  Standard output plugins include match and forward: <br><pre> # We receive events from port 24224
 &lt;source&gt;
   type forward
   port 24224
 &lt;/ source&gt;

 # http://this.host:9880/myapp.access?json={"event":"data "}
 &lt;source&gt;
   type http
   port 9880
 &lt;/ source&gt;

 # Take events marked with tags "myapp.access" 
 # and save them in the file / var / log / fluent / access.% Y-% m-% d
 # data can be broken into chunks using the time_slice_format option.

 &lt;match myapp.access&gt;
   type file
   path / var / log / fluent / access
 &lt;/ match&gt;
</pre><br><br>  The above fragment indicates that all events marked with myapp and access tags should be saved in the file, the path to which is specified in the path directive.  Note that events that, in addition to the myapp and access tags, are also marked by other tags, will not be sent to the file. <br>  Briefly consider the syntax features of the match directive: <br><br><ul><li>  the * symbol means the match of any part of the tag (if you specify &lt;match a. *&gt;, then ab will match the specified condition, but abc will not); </li><li>  ** means match any tag (if you specify &lt;match **&gt;, then a, and ab, and abc will match the specified condition); </li><li>  {x, y, z} means match at least one of the tags specified in curly brackets (if you specify &lt;match {a, b}&gt;, then a and b will match the specified condition, but c will not); </li><li>  braces can be used in conjunction with the characters * and **, for example: &lt;match {a, b}.  c. *&gt; or &lt;match {a. *, b} .c&gt; *; </li><li>  &lt;match a b&gt; means matching tags a and b at the same time; </li><li>  &lt;match a. ** b. *&gt; means matching the tags a, ab and abc (first part) and bd (second part). </li></ul><br><br>  Fluentd checks events for matching tags in the order in which match blocks follow each other in the configuration file.  First, matches of a particular nature are indicated, and then more general matches.  If this rule is violated, Fluentd will not work correctly.  So, a fragment of the form <br><br><pre> &lt;match **&gt;
   type blackhole_plugin
 &lt;/ match&gt;

 &lt;match myapp.access&gt;
   type file
   path / var / log / fluent / access
 &lt;/ match&gt;

</pre><br><br>  contains an error: first, it contains extremely general matches (&lt;match **&gt; means that events marked with any tag must be written to the file), and then private ones.  The made error will lead to the fact that events with the tags myapp and access will not be recorded at all.  For everything to work as it should, the fragment should look like this: <br><br><pre> &lt;match myapp.access&gt;
   type file
   path / var / log / fluent / access
 &lt;/ match&gt;

 &lt;match **&gt;
   type blackhole_plugin
 &lt;/ match&gt;
</pre><br><br><h3>  Include: merge configuration files </h3><br><br>  Directives can be imported from one configuration file to another and merged.  This operation is performed in the include block: <br><br><pre> include config.d / *. conf
</pre><br><br>  In this directive, you can specify the path to one or more files with a mask or URL: <br><br><pre> # absolute file path
 include /path/to/config.conf

 # you can also specify a relative path
 include extra.conf

 # mask
 include config.d / *. conf

 # http
 include http://example.com/fluent.conf
</pre><br><br><h3>  System: install additional settings </h3><br><br>  In the System block, you can set additional settings, for example, set the logging level (for more details, see <a href="http://docs.fluentd.org/articles/logging" rel="nofollow">here</a> ), enable and disable the option to delete duplicate records from logs, etc. <br><br><h2>  Supported data types </h2><br><br>  Each plugin for Fluentd has a specific set of parameters.  Each parameter in turn is associated with a specific data type. <br>  Here is a list of data types supported in Fluentd: <br><br><ul><li>  string - string; </li><li>  integer is an integer; </li><li>  float is a floating point number; </li><li>  size - the number of bytes;  The following recording options are possible: <br><ul><li>  &lt;integer&gt; k - size in kilobytes; </li><li>  &lt;integer&gt; g - size in gigabytes; </li><li>  &lt;integer&gt; t is the size of terabytes; </li><li>  if no unit is specified, the value in the size field will be interpreted as the number of bytes. </li></ul><br></li><li>  time - time;  The following recording options are possible: <br><ul><li>  &lt;integer&gt; s - time in seconds; </li><li>  &lt;integer&gt; m - time in minutes; </li><li>  &lt;integer&gt; h - time in hours; </li><li>  &lt;integer&gt; d - time in days; </li><li>  if no unit is specified, the value in the time field will be interpreted as the number of seconds. </li></ul><br></li><li>  array - JSON array; </li><li>  hash is a JSON object. </li></ul><br><br><h2>  Fluentd Plugins: Expanding Features </h2><br><br>  Fluentd uses 5 types of plugins: output plugins, input plugins, buffering plugins, form plugins and parsing plugins. <br><br><h3>  Input plugins </h3><br><br>  Input plugins are used to get contracts from external sources.  Typically, such a plugin creates a thread socket (thread socket) and a listening socket (listen socket).  You can also configure the plugin so that it will receive data from an external source with a certain frequency. <br>  Input plugins include: <br><ul><li>  in_forward - listens on a TCP socket; </li><li>  in_http - receives messages transmitted in POST requests; </li><li>  in_tail - reads messages recorded in the last lines of text files (works in the same way as the command tail -F); </li><li>  in_exec - using this plugin, you can run a third-party program and receive its event log;  JSON, TSV and MessagePack formats are supported; </li><li>  in_syslog - using this plugin, you can receive syslog messages using UDP protocol; </li><li>  in_scribe - allows to receive messages in the Scribe format (Scribe is also a log collector developed by Facebook). </li></ul><br><br><h2>  Output plugins </h2><br><br>  Output plugins are divided into three groups: <br><br><ul><li>  unbuffered plugins - do not save the results in the buffer and instantly write them to the standard output; </li><li>  with buffering - divide events into groups and record alternately;  You can set limits on the number of stored events, as well as on the number of events placed in the queue; </li><li> separated by time intervals - these plug-ins are essentially a kind of buffering plug-in, only events are divided into groups by time intervals. </li></ul><br><br>  Non-buffering plugins include: <br><br><ul><li>  out_copy - copies events to a specified place (or several places); </li><li>  out_null - this plugin just throws packets; </li><li>  out_roundrobin ‚Äî records events in various output locations that are selected using the round-robin method; </li><li>  out_stdout - instantly writes events to standard output (or to a log file, if it is running in daemon mode). </li></ul><br><br>  The number of plugins with buffering includes: <br><ul><li>  out_exec_filter - starts an external program and reads an event from its output; </li><li>  out_forward - sends events to other fluentd nodes; </li><li>  out_mongo (or out_mongo_replset) - transfers records to the MongoDB database. </li></ul><br><br><h3>  Buffering plugins </h3><br><br>  Buffering plugins are used as auxiliary for output plugins that use buffers.  This group of plugins includes: <br><ul><li>  buf_memory - changes the amount of memory used to store buffered data (for more details, see the official documentation); </li><li>  buf_file - allows you to store the contents of the buffer in a file on your hard disk. </li></ul><br>  More details on how buffering plugins work can be found <a href="http://docs.fluentd.org/articles/buffer-plugin-overview" rel="nofollow">here</a> . <br><br><h3>  Formatting plugins </h3><br><br>  With the help of formatting plugins, you can change the format of the data obtained from the logs.  Standard plugins in this group include: <br><br><ul><li>  out_file - allows you to customize the data presented in the form of "time - tag - record in json format"; </li><li>  json - removes the ‚Äútime‚Äù or ‚Äútag‚Äù field from the record in the json format; </li><li>  ltsv - converts the record to LTSV format; </li><li>  single_value - displays the value of one field instead of the whole record; </li><li>  csv - displays an entry in CSV / TSV format. </li></ul><br><br>  More details about formatting plugins can be found <a href="http://docs.fluentd.org/articles/formatter-plugin-overview" rel="nofollow">here</a> . <br><br><h3>  Parsing plugins </h3><br><br>  These plugins are used to parse specific input data formats in cases where this cannot be done using standard tools.  Detailed information about parsing plugins can be found <a href="http://docs.fluentd.org/articles/parser-plugin-overview" rel="nofollow">here</a> . <br><br>  Naturally, all the fluentd plug-ins cannot be described within the framework of the review article - this is a topic for a separate publication.  A complete list of all existing plugins to date can be found <a href="http://www.fluentd.org/plugins" rel="nofollow">on this page</a> . <br><br><h3>  General options for all plugins </h3><br><br>  The following parameters are also specified for all plugins: <br><br><ul><li>  type - type; </li><li>  id - identification number; </li><li>  log_level - logging level (see above). </li></ul><br><br>  On the official website of fluentd there are ready-made configuration files, adapted for different usage scenarios (see <a href="http://docs.fluentd.org/categories/recipes" rel="nofollow">here</a> ). <br><br><h2>  Data output and integration with other solutions </h2><br><br>  Fluentd collected can be transferred for storage and further processing to distributed databases (MySQL, PostgreSQL, CouchBase, CouchDB, MongoDB, OpenTSDB, InfluxDB) (see also the article about integrating Fluentd with Hadoop) cloud services (AWS) , Google BigQuery), search tools (Elasticsearch, Splunk, Loggly). <br>  Fluentd + Elasticsearc + Kibana is often used to provide data search and visualization capabilities (for detailed installation and configuration instructions, see, for example, <a href="https://www.digitalocean.com/community/tutorials/elasticsearch-fluentd-and-kibana-open-source-log-search-and-visualization" rel="nofollow">here</a> ). <br><br>  A full list of services and tools that Fluentd can transmit data on is available <a href="http://www.fluentd.org/dataoutputs" rel="nofollow">here</a> .  The official website also contains <a href="http://www.fluentd.org/guides" rel="nofollow">instructions</a> for using Fluentd in conjunction with other solutions. <br><br><h2>  Conclusion </h2><br><br>  In this article, we presented an overview of the capabilities of the Fluentd log collector that we use to solve our own problems.  If you are interested and you have a desire to try Fluentd in practice, we have prepared the <a href="https://github.com/clickfreak/ansible-fluentd-role" rel="nofollow">Ansible role</a> , which will help simplify the installation and deployment process. <br><br>  The problem of collecting and analyzing logs probably faced many of you.  It would be interesting to know what tools you use to solve it and why you chose them.  And if you use Fluentd - share your experience in the comments. <br>  If for one reason or another you cannot leave comments here - welcome to our <a href="http://blog.selectel.ru/sbor-i-analiz-logov-s-fluentd/">blog</a> . </div><p>Source: <a href="https://habr.com/ru/post/250969/">https://habr.com/ru/post/250969/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../250953/index.html">Car Tutorial Guide (Unity3d): Exploring an Alternative Physical Model (part 2 of 3)</a></li>
<li><a href="../250955/index.html">Objective-C Runtime for Si-Schnick. Part 1</a></li>
<li><a href="../250957/index.html">SMS mailing with Google Sheets API</a></li>
<li><a href="../250959/index.html">2015: End of Contact Center</a></li>
<li><a href="../250963/index.html">55 million users moving on</a></li>
<li><a href="../250971/index.html">JDBC Curriculum</a></li>
<li><a href="../250973/index.html">Speech at the conference: what is important to know</a></li>
<li><a href="../250975/index.html">Selenium for Python. Chapter 4. Search for items</a></li>
<li><a href="../250977/index.html">Objective-C Runtime for Si-Schnick. Part 2</a></li>
<li><a href="../250979/index.html">CxxMock - Mock Objects in C ++</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>