<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to deploy multiple versions of sites on the same YII instance</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article we will describe how we organized the work of our sites in one project on the yii framework. In the first part, we give a little theor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to deploy multiple versions of sites on the same YII instance</h1><div class="post__text post__text-html js-mediator-article">  In this article we will describe how we organized the work of our sites in one project on the yii framework.  In the first part, we give a little theory of in what cases this may be needed and what is needed for that.  And in the second part we proceed to the technical implementation. <br><br><h4>  Part 1 </h4><br><h5>  Introduction </h5><br>  Many companies support the work of several sites to promote their products in different markets.  So do we.  We have websites for Russian, American, European and other markets, separate websites for mobile devices, and websites of partner programs, which are also different for different countries.  In development, we use the yii framework, to which we transferred our main site Alawar.ru last year, and this year also Alawar.com, Alawar.pl and sites of iOS devices.  One of the features of the deployment of our sites on yii is that they all work on the same instance of this wonderful framework. <br><br>  There are no problems in solving this problem; we will consider one specific implementation. <br><a name="habracut"></a><br><h5>  Site Differences </h5><br>  To understand how to arrange multiple sites on one platform, you need to figure out what they have in common and how they differ.  Just want to note that by different sites we mean the difference not only in localization, which is ruled by elementary <code>Yii::t('messageFile', 'messageCode')</code> in views and different <code>messageFile</code> for different locales. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A different site may be the following: <br><ul><li>  filling; </li><li>  functional frontend modules; </li><li>  themes / skins; </li><li>  language / localization. </li></ul><br>  Let us examine in detail each item. <br><br><h6>  Filling </h6><br>  By content, we mean different content for different sites.  Since sites differ for different countries, and therefore they sell goods in different markets, the goods offered for sale in one market sometimes need to be removed from sale in another.  Different sites may have different special offers and different discounts for their visitors. <br><br>  In the end, even static pages of information can be different.  Thus, we should be able to resolve these discrepancies by one instance of the framework. <br><br><h6>  Functionality of individual frontend units / modules </h6><br>  For example, on the site Alawar.com there is a functional Unlimited - subscriptions to all games for the time chosen by the user for the corresponding cost.  Alawar.pl also provides this functionality to users, but subscription options offer different from the English site.  On the Russian site, the work Unlimited is not provided at all. <br><br><h6>  Themes / Skins </h6><br>  At this point, different variants of tasks are possible: <br><ol><li>  Different themes of sites (for example, a mobile site has a separate theme from the main one). </li><li>  Same theme sites, but different design options (for example, a festive skin on May 9 on Alawar.ru or a skin on July 4 on Alawar.com). </li></ol><br>  Learning how to create themes for the Yii engine is not a tricky business.  The division of topics structurally in the framework addresses the issue of separation of design on sites. <br><br><h6>  Language / localization </h6><br>  And only in the last place is localization, which was mentioned above. <br><br><h5>  Site Similarities </h5><br>  And now let's take a look at what all sites can have in common. <br><br>  The most important similarity and the only important and sufficient reason why it is worth doing different sites on the same platform is the same backend.  If your sites have different backends, then you probably should not mix them into one project.  Yes, we choose different products for sale on different sites.  But all the products are in the same database and are available in the same admin panel.  We draw different skins for different sites, but they can all be bolted to the same topic.  Especially if the backend is not limited to mysql-admin. <br><br>  In our case, the backend means: <br><ul><li>  complex mysql-admin, located on a separate server, written on another CMS; </li><li>  sending data from this admin through rabbitmq to the back-end of the yii project; </li><li>  the formation of the yii backend of the data stored in both mysql and nosql; </li><li>  sphinx indexing data. </li></ul><br>  Imagine that for each new site would have to raise all these technologies from scratch. <br><br><h5>  Assigned tasks </h5><br>  Summarizing the comparison of similarities and differences between our sites, we will determine what tasks the separation of sites should solve: <br><ol><li>  Display of various and / or unique content on different sites while maintaining the overall backend. </li><li>  Ability to customize the functionality of different modules of sites separately from each other. </li><li>  Support for different themes or different skin themes, different text localizations. </li></ol><br><h4>  Part 2 </h4><br><h5>  Config to determine the site </h5><br>  In this article we will show the division of the application into two sites: Russian and English.  In reality, this way you can divide as many sites as you need. <br><br>  Determine in what situation what site to show, we can on the following parameters: <br><ul><li>  by domain from which the user came; </li><li>  by device user-agent; </li><li>  on the history of navigating sites from data in the COOKIE / session. </li></ul><br>  Create a config file <code>protected/config/sites.php</code> with the following content: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'mywebsite.ru'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'host'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'mywebsite.ru'</span></span>, <span class="hljs-string"><span class="hljs-string">'www.mywebsite.ru'</span></span>, ), <span class="hljs-string"><span class="hljs-string">'userAgent'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, ), <span class="hljs-string"><span class="hljs-string">'mywebsite.com'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'host'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'mywebsite.com'</span></span>, <span class="hljs-string"><span class="hljs-string">'www.mywebsite.com'</span></span>, ), <span class="hljs-string"><span class="hljs-string">'userAgent'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, ), );</code> </pre><br><br>  In this example, we will analyze the definition of the site by domain only.  In our case, the definition for the user agent is not used, so we specify <code>'userAgent' =&gt; false</code> .  This key is set for the case when you need to show different versions of sites for the same domain. <br><br><h5>  Separate configs for individual sites </h5><br>  Let's make for each site a separate configuration file with its unique settings.  And we give these files the names corresponding to the keys in the above array.  That is, create files: <br> <code>protected/config/mywebsite.ru.php</code> <br> <code>protected/config/mywebsite.com.php</code> <br> <br>  Here is the contents of the <code>protected/config/mywebsite.ru.php</code> : <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CMap::mergeArray( <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'basePath'</span></span>=&gt;dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>).DIRECTORY_SEPARATOR.<span class="hljs-string"><span class="hljs-string">'..'</span></span>, <span class="hljs-string"><span class="hljs-string">'name'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'Application name'</span></span>, <span class="hljs-string"><span class="hljs-string">'theme'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'mywebsite'</span></span>, <span class="hljs-string"><span class="hljs-string">'language'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'ru'</span></span>, <span class="hljs-string"><span class="hljs-string">'modules'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( ), <span class="hljs-string"><span class="hljs-string">'controllerMap'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'site'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'application.sites.common.controllers.SiteController'</span></span>, <span class="hljs-string"><span class="hljs-string">'promo'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'application.sites.mywebsite-ru.controllers.PromoController'</span></span>, <span class="hljs-string"><span class="hljs-string">'viewPrefix'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'/mywebsite-ru/promo/'</span></span>, ), <span class="hljs-string"><span class="hljs-string">'support'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'application.sites.common.controllers.SupportController'</span></span>, <span class="hljs-string"><span class="hljs-string">'viewPrefix'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'/mywebsite-ru/support/'</span></span>, ), ), <span class="hljs-string"><span class="hljs-string">'components'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'urlManager'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'urlFormat'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'path'</span></span>, <span class="hljs-string"><span class="hljs-string">'showScriptName'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-string"><span class="hljs-string">'urlSuffix'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'/'</span></span>, <span class="hljs-string"><span class="hljs-string">'rules'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">''</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'site/index'</span></span>, <span class="hljs-string"><span class="hljs-string">'promo/'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'promo/index'</span></span>, <span class="hljs-string"><span class="hljs-string">'support/'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'support/index'</span></span>, ), ), <span class="hljs-string"><span class="hljs-string">'errorHandler'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'errorAction'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'site/error'</span></span>, ), ), <span class="hljs-string"><span class="hljs-string">'params'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'adminEmail'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'admin@mywebsite.ru'</span></span>, <span class="hljs-string"><span class="hljs-string">'arCustomParams'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'customBannerPath'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'/promo/mywebsite.ru/promo-banner.png'</span></span> ), ), ), <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span>(dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>).<span class="hljs-string"><span class="hljs-string">'/main.php'</span></span>) );</code> </pre><br><br>  As you can see, we transferred all site-dependent settings to separate files, which are configs of specific sites.  Site name, subject, locale are defined in this config. <br><br>  In order to implement a special site content or to process special requests, we will make separate controllers containing custom logic.  We will determine the ways in which common for all sites and site-specific controllers will be available.  The controllers used by this site are listed in the <code>controllerMap</code> parameter: <br><pre> <code class="php hljs"> <span class="hljs-string"><span class="hljs-string">'controllerMap'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'site'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'application.sites.common.controllers.SiteController'</span></span>, <span class="hljs-string"><span class="hljs-string">'promo'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'application.sites.mywebsite-ru.controllers.PromoController'</span></span>, <span class="hljs-string"><span class="hljs-string">'viewPrefix'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'/mywebsite-ru/promo/'</span></span>, ), <span class="hljs-string"><span class="hljs-string">'support'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'application.sites.common.controllers.SupportController'</span></span>, <span class="hljs-string"><span class="hljs-string">'viewPrefix'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'/mywebsite-ru/support/'</span></span>, ), ),</code> </pre><br>  Here we see that mywebsite.ru uses a <code>SiteController</code> controller, common to both sites.  The display path for this controller will be standard, it is not required to specify it additionally. <br>  <code>PromoController</code> , on the contrary, refers only to this site, since  may contain data on various promotions applicable only on a specific site.  <code>SupportController</code> used common to both sites, but custom maps are used for this controller. <br><br>  To achieve correct processing of the <code>viewPrefix</code> property in all frontend controllers without defining this property with further overriding by the <code>render</code> function in each, create a class <code>protected/components/AController.php</code> inherited from the CController class: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * Controller is the customized base controller class. * All controller classes for this application should extend from this base class. */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string the default layout for the controller view. Defaults to '//layouts/column1', * meaning using a single column layout. See 'protected/views/layouts/column1.php'. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $layout=<span class="hljs-string"><span class="hljs-string">'//layouts/main'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $baseHref=<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $viewPrefix=<span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> array context menu items. This property will be assigned to {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> CMenu::items}. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $menu=<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> array the breadcrumbs of the current page. The value of this property will * be assigned to {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> CBreadcrumbs::links}. Please refer to {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> CBreadcrumbs::links} * for more details on how to specify this property. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $breadcrumbs=<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string page description */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $pageDescription = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($view,$data=null,$return=false)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::render(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;viewPrefix.$view,$data,$return); } }</code> </pre><br>  All frontend controllers in our application will inherit from this class.  In it, we defined the <code>viewPrefix</code> property and, with due regard for it, redefined the <code>render($view,$data=null,$return=false)</code> method <code>render($view,$data=null,$return=false)</code> , which will allow us to structurally separate the controller mappings by the given prefix. <br><br>  This is a flexible system that allows you to take out only those displays / controllers that differ so much that it is worth using separate files for them.  Since all our sites use one backend, we should only share front-end logic, i.e.  controllers and views, and models, forms, components, extensions and everything else are always common to all sites.  Also, dispatching urls will differ on different sites.  Therefore, we place the <code>urlManager</code> in a separate config.  Well, all the other settings common to all sites are stored, as usual, in the <code>main.php</code> file, which is current with <code>CMap::mergeArray</code> <br><br><h5>  SiteDispatcher </h5><br>  Create all controllers and displays that will be used by our sites.  We create the following files and folders required for them: <br> <code>protected/sites/common/controllers/SiteController.php</code> <br> <code>protected/sites/common/controllers/SupportController.php</code> <br> <code>protected/sites/mywebsite-ru/controllers/PromoController.php</code> <br> <code>protected/sites/mywebsite-com/controllers/PromoController.php</code> <br> <code>public/themes/mywebsite/views/site/index.php</code> <br> <code>public/themes/mywebsite/views/mywebsite-ru/promo/index.php</code> <br> <code>public/themes/mywebsite/views/mywebsite-ru/support/index.php</code> <br> <code>public/themes/mywebsite/views/mywebsite-com/promo/index.php</code> <br> <code>public/themes/mywebsite/views/mywebsite-com/support/index.php</code> <br> <br>  Each controller created must be inherited from the <code>AController</code> class.  Thus, we break the standard structure YII a bit, but there is nothing to worry about.  We have maintained the logical structure of the project. <br><br>  To teach yii to run the necessary controllers using the config files we created, we will create a separate component class, <code>protected/omponents/SiteDispatcher</code> , whose task is to select the necessary config file for a specific situation: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SiteDispatcher</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      public static function setCurrentSiteConfig( $configName ) { @session_start(); $_SESSION['CURRENT_SITE_CONFIG'] = array( 'host' =&gt; $_SERVER['HTTP_HOST'], 'configName' =&gt; $configName ); @session_write_close(); @session_destroy(); } //       public static function getCurrentSiteConfig() { @session_start(); $res = isset( $_SESSION['CURRENT_SITE_CONFIG'] ) ? $_SESSION['CURRENT_SITE_CONFIG'] : false; @session_write_close(); @session_destroy(); return $res; } public static function getConfigPath() { $arSites = self::getAvailableConfigs(); /*      ,     ,   ,   -          */ if ( ($arCurrent = self::getCurrentSiteConfig()) &amp;&amp; $arCurrent['host'] == $_SERVER['HTTP_HOST'] &amp;&amp; isset($arSites[$arCurrent['configName']]) ) { return 'protected/config/' . $arCurrent['configName'] . '.php'; } foreach ( $arSites as $configName =&gt; $arSiteConfig ) { $res = true; $res &amp;= in_array( $_SERVER['HTTP_HOST'], $arSiteConfig['host'] ); if ( $res &amp;&amp; $arSiteConfig['userAgent'] &amp;&amp; isset( $_SERVER['HTTP_USER_AGENT'] ) ) { $m = false; $res &amp;= preg_match( $arSiteConfig['userAgent'], $_SERVER['HTTP_USER_AGENT'], $m); } if ( $res ) { return 'protected/config/' . $configName . '.php'; } } error_log('Can\'t determine config to site: ' . var_export( array( 'host' =&gt; $_SERVER['HTTP_HOST'], 'userAgent' =&gt; $_SERVER['HTTP_HOST'], ), 1)); throw new Exception('Can\'t determine config to site'); } /** * * @static * @return mixed */ protected static function getAvailableConfigs() { return require( dirname(dirname(__FILE__)) . '/config/sites.php' ); } }</span></span></code> </pre><br>  Now we are able to determine which config to launch in which case.  The <code>getConfigPath()</code> method returns the path to the selected configuration.  At the same time, the selected config is saved to the session for ease of further access. <br><br>  To invoke this method, at the beginning of the <code>index.php</code> file, replace the string <br><br><pre> <code class="php hljs">$config=dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>).<span class="hljs-string"><span class="hljs-string">'/../protected/config/main.php'</span></span>;</code> </pre>  on <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>).<span class="hljs-string"><span class="hljs-string">'/../protected/components/SiteDispatcher.php'</span></span>; $config=dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>).<span class="hljs-string"><span class="hljs-string">'/../'</span></span>.SiteDispatcher::getConfigPath();</code> </pre><br><br>  Thus, by separating configs, some controllers and mappings for different sites, we solved the first two tasks set in the first part. <br><br><h5>  Split skins </h5><br>  Using your own skins for different sites is decided by specifying the locale in the site config.  As a rule, skin is separate css and js files of themes and images.  In our project we use some global css and js files that define the structural layout of the theme common to all sites.  As well as individual local css and js, which determine the design of this structure.  All these styles and scripts are collected as a result of one file with our own minifiers and are connected in the layout as follows: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"&lt;?php echo Yii::app()-&gt;theme-&gt;baseUrl . '/css/'. Yii::app()-&gt;getLanguage() .'/main.minified.css'; ?&gt;"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"&lt;?php echo Yii::app()-&gt;theme-&gt;baseUrl . '/js/' . Yii::app()-&gt;getLanguage() . '/main_minified.js'; ?&gt;"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Since <code>Yii::app()-&gt;getLanguage()</code> returns the locale defined in a separate config file of a specific site, by creating folders of the same name in the theme structure, we can save our css and js files there.  It remains only to modify the minifier, which collects all the files into one, so that it supports working with the locale.  But this is a topic for a separate article. <br><br>  Separately, I would like to mention the issue of placing meters on our sites.  There are many different scripts, google analytics, yandex metrika, addthis and others.  Different sites use different counters.  To get rid of the crutches with the <code>Yii::app()-&gt;getLanguage()</code> switch in the views to correctly display the desired counter on a specific site, we decided to put the counters into localization files. <br><br>  Create files: <br> <code>protected/messages/ru/scripts.php</code> <br> <code>protected/messages/en/scripts.php</code> <br> <br>  Add the following code to them: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span> ( <span class="hljs-string"><span class="hljs-string">'GoogleAnalitics'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' &lt;!-- GoogleAnalitics begin --&gt; &lt;script type="text/javascript"&gt; //    RU &lt;/script&gt; &lt;!-- GoogleAnalitics end --&gt; '</span></span>, );</code> </pre><br>  Now it is enough to call <code>echo Yii::t('scripts', 'GoogleAnalitics')</code> in the mapping files to display the necessary code for the desired site. <br><br><h5>  Conclusion </h5><br>  We will be happy to hear comments on our method of sharing sites, as well as other ways that you use yourself. <br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/157877/">https://habr.com/ru/post/157877/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../157861/index.html">PBX in 5 minutes</a></li>
<li><a href="../157863/index.html">VGA adapter on FPGA Altera Cyclone III</a></li>
<li><a href="../157867/index.html">Synology¬Æ Announces DiskStation DS713 + Release</a></li>
<li><a href="../157869/index.html">Jam with chrome</a></li>
<li><a href="../157871/index.html">Control of mobile communication expenses within the organization: implementation</a></li>
<li><a href="../157883/index.html">Incremental GPS track mapping algorithm to a road graph</a></li>
<li><a href="../157885/index.html">Monitor with a 21: 9 aspect ratio from LG</a></li>
<li><a href="../157889/index.html">Webinar: ‚ÄúHR branding for startups‚Äù right now!</a></li>
<li><a href="../157891/index.html">MasterCard payment cards with display and keyboard</a></li>
<li><a href="../157895/index.html">Domain me.ga no longer belongs to Kim Dotky</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>