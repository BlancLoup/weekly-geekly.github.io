<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About building JDK 8 on Ubuntu, the quality of Hotspot code, and why everything is felled in C ++</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I wanted to sleep today, but again failed. In the Telegram there was a message that someone was not going to Java ... and we woke up only after a coup...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About building JDK 8 on Ubuntu, the quality of Hotspot code, and why everything is felled in C ++</h1><div class="post__text post__text-html js-mediator-article"><p>  I wanted to sleep today, but again failed.  In the Telegram there was a message that someone was not going to Java ... and we woke up only after a couple of hours, tired and satisfied. </p><br><img src="https://habrastorage.org/webt/ti/ov/lf/tiovlf2wctfucdlsql2-avqmkwe.png"><br><br>  Who can this post be useful for?  Yes, probably, to anyone except those who also collect JDK8 or just like to read horrible horrors.  In general, I warned you, close the article urgently. <br><p>  Three problems: </p><br><ul><li>  Not going ( <a href="https://habr.com/company/jugru/blog/422861/">level one</a> ) <br>  Very boring part you can skip.  Only needed for those who want to fully restore the history of events; </li><li>  Not going ( <a href="https://habr.com/company/jugru/blog/422861/">level two</a> ) <br>  More interesting, because there are a couple of common mistakes, necromancy, necrophilia, what BSD is better than GNU / Linux and why it is worth switching to new versions of the JDK. </li><li>  Even if going, <a href="https://habr.com/company/jugru/blog/422861/">falls into the crust</a> <br>  More interesting.  Yahuuu, JVM fell into the crust, let's kick it with your feet! </li></ul><br><p>  Under the cut is shown a detailed course of solving problems, with different side thoughts about life. </p><br><p>  There will be a lot of C ++, there will be no Java code at all.  In the end, any javist starts writing only in C ++ ... </p><a name="habracut"></a><br><h1 id="ne-sobiraetsya">  Not going </h1><br><p>  Anyone who has collected Java at all, knows that it looks something like this: </p><br><pre><code class="bash hljs">hg <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> http://hg.openjdk.java.net/jdk8u/jdk8u <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> jdk8u sh ./get_source.sh sh ./configure \ --with-debug-level=fastdebug \ --with-target-bits=64 \ --with-native-debug-symbols=internal \ --with-boot-jdk=/home/me/opt/jdk1.8.0_161 make images</code> </pre> <br><p>  (All my users are simply called ‚Äúme‚Äù, so that the virtual user can at any time give to any person and not create a rejection from using it not by their username) </p><br><p>  The problem, of course, is that it does not work.  And quite cynical way. </p><br><a name="one"></a><br><h2 id="pervyy-uroven-pogruzheniya">  First level of immersion </h2><br><p>  Let's try to run: </p><br><pre> <code class="bash hljs">/home/me/git/jdk8u/hotspot/src/os/linux/vm/os_linux.inline.hpp:127:18: warning: <span class="hljs-string"><span class="hljs-string">'int readdir_r(DIR*, dirent*, dirent**)'</span></span> is deprecated [-Wdeprecated-declarations] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((status = ::readdir_r(dirp, dbuf, &amp;p)) != 0) { ^~~~~~~~~</code> </pre> <br><p>  Initially, for you to understand, I have installed this: </p><br><pre> <code class="hljs pgsql">$ g++ <span class="hljs-comment"><span class="hljs-comment">--version g++ (Ubuntu 7.3.0-16ubuntu3) 7.3.0 Copyright (C) 2017 Free Software Foundation, Inc.</span></span></code> </pre> <br><p>  The compiler is not the first freshness, not 8.2, but this one should come up. </p><br><p>  C ++ developers love to test software only on the version of the compiler that they have installed.  Usually the desire to test on different platforms ends somewhere around the difference between gcc and clang in a general sense.  Therefore, it is quite normal at first to introduce <code>-Werror</code> (‚Äúread warnings as errors‚Äù) and then write such code, which in all other versions will be considered to be vornings. </p><br><p>  The problem is known, and it is clear how to solve it.  You need to set your environment variable CXX_FLAGS, in which to prescribe the correct level of error. </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> CXX_FLAGS=-Wno-error=deprecated-declarations -Wno-error-deprecated-declarations</code> </pre> <br><p>  And then we see the miraculous: </p><br><pre> <code class="hljs pgsql">Ignoring CXXFLAGS <span class="hljs-built_in"><span class="hljs-built_in">found</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> environment. Use <span class="hljs-comment"><span class="hljs-comment">--with-extra-cxxflags</span></span></code> </pre> <br><p>  Okay, build system, whatever you want!  We substitute configure for this: </p><br><pre> <code class="bash hljs">hg <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> http://hg.openjdk.java.net/jdk8u/jdk8u <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> jdk8u sh ./configure \ --with-extra-cflags=<span class="hljs-string"><span class="hljs-string">'-Wno-cpp -Wno-error=deprecated-declarations'</span></span> \ --with-extra-cxxflags=<span class="hljs-string"><span class="hljs-string">'-Wno-cpp -Wno-error=deprecated-declarations'</span></span> \ --with-debug-level=fastdebug \ --with-target-bits=64 \ --with-native-debug-symbols=internal \ --with-boot-jdk=/home/me/opt/jdk1.8.0_161 make images</code> </pre> <br><p>  And the error remains the same! <br>  Go to the heavy artillery: grepe sources. </p><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> -rl <span class="hljs-string"><span class="hljs-string">"Werror"</span></span> .</code> </pre> <br><p>  A huge amount of any auto-generated hat falls out, among which there are glimpses of meaningful files: </p><br><pre> <code class="hljs go">./common/autoconf/flags.m4 ./hotspot/<span class="hljs-built_in"><span class="hljs-built_in">make</span></span>/bsd/makefiles/gcc.<span class="hljs-built_in"><span class="hljs-built_in">make</span></span> ./hotspot/<span class="hljs-built_in"><span class="hljs-built_in">make</span></span>/solaris/makefiles/gcc.<span class="hljs-built_in"><span class="hljs-built_in">make</span></span> ./hotspot/<span class="hljs-built_in"><span class="hljs-built_in">make</span></span>/aix/makefiles/xlc.<span class="hljs-built_in"><span class="hljs-built_in">make</span></span></code> </pre> <br><p>  In <code>flags.m4</code> we easily find the previous message about ‚ÄúIgnoring CXXFLAGS‚Äù and the more hard-coded hard-coded flag <code>CCXX_FLGS</code> (yes, two letters C), which immediately acts instead of <code>CFLAGS</code> , and instead of <code>XX_FLAGS</code> .  Conveniently!  Two facts are interesting: </p><br><ul><li>  This flag is not passed through the configure parameters; </li><li>  The default values ‚Äã‚Äãare meaningful and suspiciously similar to the real parameters: </li></ul><br><pre> <code class="bash hljs"> <span class="hljs-comment"><span class="hljs-comment"># Setup compiler/platform specific flags to CFLAGS_JDK, # CXXFLAGS_JDK and CCXXFLAGS_JDK (common to C and CXX?) if test "x$TOOLCHAIN_TYPE" = xgcc; then # these options are used for both C and C++ compiles CCXXFLAGS_JDK="$CCXXFLAGS $CCXXFLAGS_JDK -Wall -Wno-parentheses -Wextra -Wno-unused -Wno-unused-parameter -Wformat=2 \ -pipe -D_GNU_SOURCE -D_REENTRANT -D_LARGEFILE64_SOURCE"</span></span></code> </pre> <br><p>  This question looks very nice in the comments - is it a common flag?  True? </p><br><p>  Let's not play democracy and authoritarian zhudkudim <code>-w</code> ("show no errors"): </p><br><pre> <code class="bash hljs"> CCXXFLAGS_JDK=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$CCXXFLAGS</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$CCXXFLAGS_JDK</span></span></span><span class="hljs-string"> -w -ffreestanding -fno-builtin -Wno-parentheses -Wno-unused -Wno-unused-parameter -Wformat=2 \</span></span></code> </pre> <br><p>  And - hooray!  - we passed the first mistake.  She is no longer reporting, and in general everything is fine.  It would seem that. </p><br><a name="two"></a><br><h2 id="vtoroy-uroven-pogruzheniya">  Second level of immersion </h2><br><p>  But now it falls in a bunch of other new places! </p><br><p>  It turns out that our <code>-w</code> works, but it is not forwarded to all parts of the assembly.  Carefully read the makefiles and don‚Äôt understand how this parameter can even be forwarded.  Have you forgotten about him? </p><br><p>  Knowing the right question to google (‚Äúwhy does cxx not get to build ?!‚Äù), we quickly get to the bug page with the saying <strong>‚Äúconfigure --with-extra-cxxflags doesn't affect hotspot‚Äù</strong> ( <a href="https://bugs.openjdk.java.net/browse/JDK-8156967">JDK-8156967</a> ). </p><br><p>  Which promise to fix in JDK 12. Maybe.  Wonderful - the most important build option is not used in the assembly! </p><br><p>  The first idea - well, let's roll up our sleeves and correct mistakes! </p><br><h2 id="oshibka-1-xn12">  Error 1. xn [12] </h2><br><pre> <code class="hljs pgsql">dependencies.cpp: <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-string"><span class="hljs-string">'static void Dependencies::write_dependency_to(xmlStream*, Dependencies::DepType, GrowableArray&lt;Dependencies::DepArgument&gt;*, Klass*)'</span></span>: dependencies.cpp:<span class="hljs-number"><span class="hljs-number">498</span></span>:<span class="hljs-number"><span class="hljs-number">6</span></span>: error: <span class="hljs-string"><span class="hljs-string">'%d'</span></span> directive writing <span class="hljs-keyword"><span class="hljs-keyword">between</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> a region <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> size <span class="hljs-number"><span class="hljs-number">9</span></span> [-Werror=<span class="hljs-keyword"><span class="hljs-keyword">format</span></span>-overflow=] <span class="hljs-type"><span class="hljs-type">void</span></span> Dependencies::write_dependency_to(xmlStream* xtty, ^~~~~~~~~~~~ dependencies.cpp:<span class="hljs-number"><span class="hljs-number">498</span></span>:<span class="hljs-number"><span class="hljs-number">6</span></span>: note: directive argument <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the range [<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">2147483647</span></span>]</code> </pre> <br><p>  Well, we probably need to increase the region.  One hundred pounds someone calculated the buffer by pressing the "I'm feeling lucky!" Button in Google. </p><br><p>  But how to understand how much is necessary?  Below is a clarification of another kind: </p><br><pre> <code class="hljs pgsql">stdio2.h:<span class="hljs-number"><span class="hljs-number">34</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>: note: <span class="hljs-string"><span class="hljs-string">'__builtin___sprintf_chk'</span></span> output <span class="hljs-keyword"><span class="hljs-keyword">between</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> a destination <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> size <span class="hljs-number"><span class="hljs-number">10</span></span> __bos (__s), __fmt, __va_arg_pack ());</code> </pre> <br><p>  Position 12 looks like something worthwhile, with which you can now break your dirty feet into the source. </p><br><p>  We climb in <code>dependencies.cpp</code> and observe the following picture: </p><br><pre> <code class="cpp hljs">DepArgument arg = args-&gt;at(j); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (j == <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (arg.is_oop()) { xtty-&gt;object(<span class="hljs-string"><span class="hljs-string">"x"</span></span>, arg.oop_value()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { xtty-&gt;object(<span class="hljs-string"><span class="hljs-string">"x"</span></span>, arg.metadata_value()); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> xn[<span class="hljs-number"><span class="hljs-number">10</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(xn, <span class="hljs-string"><span class="hljs-string">"x%d"</span></span>, j); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (arg.is_oop()) { xtty-&gt;object(xn, arg.oop_value()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { xtty-&gt;object(xn, arg.metadata_value()); } }</code> </pre> <br><p>  Pay attention to the problem line: </p><br><pre> <code class="hljs perl">char xn[<span class="hljs-number"><span class="hljs-number">10</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">sprintf</span></span>(xn, <span class="hljs-string"><span class="hljs-string">"x%d"</span></span>, j);</code> </pre> <br><p>  We change 10 for 12, we rebuild and ... the assembly has gone! </p><br><p>  But am I really the only one so smart and fixed the bug of all times and peoples?  Not a question, again we drive our megapatch into Google: <code>char xn[12];</code> </p><br><p>  And we see ... yes, that's right.  The <a href="https://bugs.openjdk.java.net/browse/JDK-8184309">JDK-8184309 bug</a> , made by Vladimir Ivanov, contains exactly the same fix. </p><br><p>  But the point is that it is fixed only in JDK 10 and it is not backported to jdk8u.  This is the question of why we need new versions of Java. </p><br><h2 id="oshibka-2-strcmp">  Error 2. strcmp </h2><br><pre> <code class="hljs pgsql">fprofiler.cpp: <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> member <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-string"><span class="hljs-string">'void ThreadProfiler::vm_update(TickPosition)'</span></span>: /home/me/git/jdk8ut/hotspot/src/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/vm/runtime/fprofiler.cpp:<span class="hljs-number"><span class="hljs-number">638</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span>: error: argument <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> non-<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> expected [-Werror=nonnull] <span class="hljs-type"><span class="hljs-type">bool</span></span> vm_match(const <span class="hljs-type"><span class="hljs-type">char</span></span>* <span class="hljs-type"><span class="hljs-type">name</span></span>) const { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> strcmp(<span class="hljs-type"><span class="hljs-type">name</span></span>, _name) == <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><p>  Taught by previous bitter experience, we immediately go to see what is in this place in JDK 11. And ... this file is not there.  The directory structure also underwent some refactoring. </p><br><p>  But it‚Äôs not so easy to leave us! </p><br><p>  Any javist has a bit of a necromancer in his soul, and maybe even a necrophil.  Therefore, now there will be NONCOMANTAINMENT IN ACTION! </p><br><p>  First you need to appeal to the soul of the dead and find out when he died: </p><br><pre> <code class="hljs bash">$ hg <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> --template <span class="hljs-string"><span class="hljs-string">"File(s) deleted in rev {rev}: {file_dels % '\n {file}'}\n\n"</span></span> -r <span class="hljs-string"><span class="hljs-string">'removes("**/fprofiler.cpp")'</span></span> File(s) deleted <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> rev 47106: hotspot/src/share/vm/runtime/fprofiler.cpp hotspot/src/share/vm/runtime/fprofiler.hpp hotspot/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/runtime/MinimalVM/Xprof.java</code> </pre> <br><p>  Now you need to find out the cause of his death: </p><br><pre> <code class="hljs pgsql">hg <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> -r <span class="hljs-number"><span class="hljs-number">47106</span></span> changeset: <span class="hljs-number"><span class="hljs-number">47106</span></span>:bed18a111b90 parent: <span class="hljs-number"><span class="hljs-number">47104</span></span>:<span class="hljs-number"><span class="hljs-number">6</span></span>bdc0c9c44af <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: gziemski <span class="hljs-type"><span class="hljs-type">date</span></span>: Thu Aug <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">26</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span> <span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">-0500</span></span> <span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>: <span class="hljs-number"><span class="hljs-number">8173715</span></span>: Remove FlatProfiler</code> </pre><br><p>  So, we have a killer: <strong>gziemski</strong> .  Let's find out why he nailed this unfortunate file. </p><br><p>  To do this, go through the fat in the ticket specified in the summary of the commit.  This is <a href="https://bugs.openjdk.java.net/browse/JDK-8173715">JDK-8173715</a> : </p><br><p>  Remove FlatProfiler: <br>  This is a concept for the GC. </p><br><p>  For-shi-be.  In fact, now we are offered to repair the corpse just so that the build is ready.  Which has decomposed so much that even our necromancer colleagues from OpenJDK have abandoned. </p><br><p>  Let's revive the dead man and try to ask him what he remembered last.  He was already dead in revision 47106, so in revision, one less is ‚Äúa second before‚Äù: </p><br><pre> <code class="bash hljs">hg cat <span class="hljs-string"><span class="hljs-string">"~/git/jdk11/hotspot/src/share/vm/runtime/fprofiler.cpp"</span></span> -r 47105 &gt; ~/tmp/fprofiler_new.cpp cp ~/git/jdk8u/hotspot/src/share/vm/runtime/fprofiler.cpp ~/tmp/fprofiler_old.cpp <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/tmp diff fprofiler_old.cpp fprofiler_new.cpp</code> </pre> <br><p>  Unfortunately, absolutely nothing about <code>return strcmp(name, _name) == 0;</code>  Diff no.  Potsienta died of a blow with a blunt sharp object (rm utility), but at the time of death he was incurably ill. </p><br><p>  Let's dig into the essence of the error. </p><br><p>  This is what the author of the code would like to tell us: </p><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">name</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _name; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_compiled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vm_match</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* name)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>(name, _name) == <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><p>  Now a little philosophy. </p><br><p>  The C11 standard in clause 7.1.4, ‚ÄúUse of library functions‚Äù, explicitly says: </p><br><blockquote>  The following is a statement of value (such as [...] a null pointer [...]) [...] the behavior is undefined. </blockquote><p>  That is, now the whole question is whether there is some kind of <em>‚Äúexplicitly stated otherwise‚Äù</em> .  In the description of <code>strcmp</code> in section 7.24.4, nothing like this is written, and I have no other sections for you. </p><br><p>  That is, we have an undefined behavior here. </p><br><p>  Of course, you can take and rewrite this piece of code, surrounding it with a check.  But I'm not at all sure that I correctly understand the logic of people who use UB where it should not be.  For example, some systems generate SIGSERV zero dereferencing, and a hacker lover can get involved in this, but this behavior is optional and can bang on another platform. </p><br><p>  Yes, of course, someone will say that you are your own fool, that you are using GCC 7.3, but in GCC 4 everything would be fine.  But undefined behavior! = Unspecified! = Implementation defined.  This is for the last two can be laid to work in the old compiler.  And UB in the sixth version was UB. </p><br><p>  In short, I was very sad over this complex philosophical question (whether to crawl with my assumptions into the code) when I suddenly realized that it was possible and different. </p><br><h1 id="est-drugoy-put">  There is another way </h1><br><p>  As you know, good heroes always go around. </p><br><p>  Even apart from our philosophy about UB, there are an incredible amount of problems there.  Not the fact that they can be repaired until the morning.  Not the fact that I do not nakosyachu my crooked hands.  Even less, the fact that it will be accepted upstream: the last patch in jdk8u was 6 weeks ago, and it was the global merge of the new tag. </p><br><p>  Just imagine that the code above is actually written correctly.  All that stands between us and its execution is a kind of warning that was perceived as an error due to a bug in the build system.  But we can build the assembly system. </p><br><p>  The Witcher Geralt of Rivia once said: </p><br><blockquote>  ‚ÄúEvil is evil, Stregobor,‚Äù the Witcher said seriously, getting up.  - The smaller, the larger, the average ‚Äî everything is one, the proportions are conditional, and the boundaries are blurred.  I am not a holy hermit, not only one good did in life.  But if you have to choose between one evil and another, I prefer not to choose at all. <br><br>  - Z≈Ço to z≈Ço, Stregoborze - rzek≈Ç powa≈ºnie wied≈∫min wstajƒÖc.  - Mniejsze, wiƒôksze, ≈õrednie, wszystko jedno, proporcje sƒÖ umowne a granice zatarte.  Nie jestem ≈õwiƒÖtobliwym pustelnikiem, nie samo dobro czyni≈Çem w ≈ºyciu.  Ale je≈ºeli mam wybieraƒá pomiƒôdzy jednym z≈Çem a drugim, to wol nie wybieraƒá wcale. </blockquote><p>  This is a quote from the book "Last Wish," the story "Lesser Evil."  We know that Geralt almost never could play the role of a truly neutral character until the end, and even died due to the regular classical chaotic good behavior. </p><br><p>  So let's zashkvarimsya about the lesser evil.  Loosen the assembly system. </p><br><p>  At the very beginning, we already saw this exhaust: </p><br><pre> <code class="hljs go">grep -rl <span class="hljs-string"><span class="hljs-string">"Werror"</span></span> . ./common/autoconf/flags.m4 ./hotspot/<span class="hljs-built_in"><span class="hljs-built_in">make</span></span>/linux/makefiles/gcc.<span class="hljs-built_in"><span class="hljs-built_in">make</span></span> ./hotspot/<span class="hljs-built_in"><span class="hljs-built_in">make</span></span>/bsd/makefiles/gcc.<span class="hljs-built_in"><span class="hljs-built_in">make</span></span> ./hotspot/<span class="hljs-built_in"><span class="hljs-built_in">make</span></span>/solaris/makefiles/gcc.<span class="hljs-built_in"><span class="hljs-built_in">make</span></span> ./hotspot/<span class="hljs-built_in"><span class="hljs-built_in">make</span></span>/aix/makefiles/xlc.<span class="hljs-built_in"><span class="hljs-built_in">make</span></span></code> </pre> <br><p>  Comparing these two files, I broke the whole face with a facepalm and realized the difference in the culture of the two platforms: </p><br><p>  BSD is a story about freedom and choices: </p><br><pre> <code class="hljs lisp"># Compiler warnings are treated as errors ifneq ($(<span class="hljs-name"><span class="hljs-name">COMPILER_WARNINGS_FATAL</span></span>),false) WARNINGS_ARE_ERRORS = -Werror endif</code> </pre> <br><p>  GNU / Linux is an authoritarian purist mode: </p><br><pre> <code class="hljs sql"><span class="hljs-comment"><span class="hljs-comment"># Compiler warnings are treated as errors WARNINGS_ARE_ERRORS = -Werror</span></span></code> </pre> <br><p>  Well, it would still be forwarded to linux via <code>XX_FLAGS</code> , this variable is not taken into account when calculating <code>WARNINGS_ARE_ERRORS</code> !  In the GNU / Linux build, we simply have no choice but to follow defaults lowered over. </p><br><p>  Well, or you can make it easier and change the value of <code>WARNINGS_ARE_ERRORS</code> for a short, but no less powerful <code>-w</code> .  How do you like that, Ilon Musk? </p><br><p>  As you might have guessed, this completely solves this build problem. </p><br><p>  When the code is collected, you see a bunch of strange, creepy looking problems flying by.  Sometimes it was so scary that I really wanted to press ctrl + C and try to figure it out.  But no, it is impossible, it is impossible ... </p><br><p>  It seems that everything has gathered and has not brought any additional problems.  Although I, of course, did not dare to start testing.  Still, the night, the eyes begin to stick together, but somehow I don‚Äôt want to switch to the last resort - the four banks of energy from the refrigerator. </p><br><a name="three"></a><br><h1 id="padaet-v-korku">  Falls into the crust </h1><br><p>  The build has passed, the executables have been generated, we are great. </p><br><p>  And here we are at the finish line.  Or did not come? </p><br><p>  Our assembly is in the following way: </p><br><pre> <code class="hljs bash"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> JAVA_HOME=~/git/jdk8u/build/linux-x86_64-normal-server-fastdebug/jdk <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> PATH=<span class="hljs-variable"><span class="hljs-variable">$JAVA_HOME</span></span>/bin:<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span></code> </pre> <br><p>  When you try to run the <code>java</code> executable file, it instantly falls into the crust.  For those who are not familiar - it looks like this: </p><br><p><img src="https://habrastorage.org/webt/n2/3p/ep/n23pepls-unfomopiqb1zgkx5eq.png"><br></p><br><p>  At the same time, Alex has Debian 9.5, and I have Ubuntu.  Two different versions of GCC, two differently looking crusts.  I have innocent pranks with a manual strcmp patch and a few more places, Alex doesn‚Äôt.  What is the problem? </p><br><p>  This story is worthy of a separate story, but here let's go straight to dry conclusions, otherwise I will never finish this post. </p><br><p>  The problem is that our favorite C ++ - pogromists again used undefined behavior. </p><br><p>  (And where it depends on the implementation of the compiler in an unknown way. However, we must remember that UB is always UB, even on a known version of the compiler, it cannot be laid on it) </p><br><p>  In one place, we turn to the field of an undeconstructed class there, and everything breaks down.  Do not ask how it happened, everything is difficult. </p><br><p>  It is very difficult for a javista to imagine how you can refer to an underconstructed class, except by releasing a link to it directly from the constructor.  Fortunately, the wonderful C ++ language can do everything or almost everything.  I will write an example with some kind of pseudocode: </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> {</span></span> A() { _b.Show(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> B _b; }; A a; BA::_b; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ }</code> </pre> <br><p>  Have a nice debug! </p><br><p>  If you look at C ++ 98 [class.cdtor]: </p><br><blockquote>  For an object of the non-POD class type ... </blockquote><p>  Starting with some version of GCC (and I have 7.3), optimization of ‚Äúlifetime dead store elimination‚Äù has appeared, which considers that we only turn to the object during its lifetime, and mounts it outside of lifetime. </p><br><p>  The solution is to disable new optimizations and return them as they were in the old GCC: </p><br><pre> <code class="hljs pgsql">CFLAGS += -fno-<span class="hljs-keyword"><span class="hljs-keyword">strict</span></span>-aliasing -fno-lifetime-dse -fno-<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>-pointer-checks</code> </pre> <br><p>  <a href="https://bugzilla.redhat.com/show_bug.cgi%3Fid%3D1306558">There</a> is a discussion about this <a href="https://bugzilla.redhat.com/show_bug.cgi%3Fid%3D1306558">here</a> . <br>  For some reason, the panelists decided that this would not be included in the upstream.  But you still need to try to send. </p><br><p>  Add these options to our <code>./hotspot/make/linux/makefiles/gcc.make</code> , rebuild everything again and see the cherished lines: </p><br><pre> <code class="hljs pgsql">t$ ~/git/jdk8u/build/linux-x86_64-normal-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>-fastdebug/jdk/bin/java -<span class="hljs-keyword"><span class="hljs-keyword">version</span></span> openjdk <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> "1.8.0-internal-fastdebug" OpenJDK Runtime Environment (build <span class="hljs-number"><span class="hljs-number">1.8</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>-<span class="hljs-type"><span class="hljs-type">internal</span></span>-fastdebug-me_2018_09_10_08_14-b00) OpenJDK <span class="hljs-number"><span class="hljs-number">64</span></span>-<span class="hljs-type"><span class="hljs-type">Bit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span> VM (build <span class="hljs-number"><span class="hljs-number">25.71</span></span>-b00-fastdebug, mixed mode)</code> </pre> <br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  You probably thought that the output would be the following: ‚ÄúJava is some kind of hell, there is no garbage in the code, there is no support, everything is bad.‚Äù </p><br><p>  This is not true!  On the contrary, the examples above show from what terrible evil our friends, necromancers from OpenJDK, keep us. </p><br><p>  And despite the fact that they have to live and use C ++, tremble from each UB and change the compiler version and learn the details of the platforms, the final user code in Java is insanely stable, and on the builds posted on the official websites of companies such as Azul, Red Hat and Oracle, it is hardly possible to run into a crust in the simple case. </p><br><p>  The only sad thing is that most likely the errors found are unlikely to be accepted in jdk8u.  We took JDK 8 simply because it's easier for us to patch it right here and now, and we will have to deal with JDK 11.  Nevertheless, to use JDK 8 in 2018 - IMHO, this is a very bad practice, and we are not doing this from a good life.  Perhaps in the future our life will improve, and you will read many more incredible stories from the world of JDK 11 and JDK 12. </p><br><p>  Thank you for the attention paid to such a boring text without pictures :-) </p><br><blockquote>  Minute advertising.  The Joker 2018 conference will take place very soon, featuring many prominent Java and JVM specialists.  View the full list of speakers and reports can be <a href="https://jokerconf.com/">on the official site</a> .  I'll be there too, it will be possible to meet and grind for life and OpenJDK. </blockquote></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/422861/">https://habr.com/ru/post/422861/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../422843/index.html">Introducing the World of Counterfeit ICs: Counterfeit Detection Techniques</a></li>
<li><a href="../422845/index.html">How to make TV really smart?</a></li>
<li><a href="../422851/index.html">Why the future of data storage is still behind the tape</a></li>
<li><a href="../422857/index.html">Implementing your IoC container</a></li>
<li><a href="../422859/index.html">The Ministry of Communications offered to switch to SIM cards with encryption from the FSB</a></li>
<li><a href="../422863/index.html">Tribes, guilds, build train and no TDD: how does mobile development work in Uber, Spotify, Odnoklassniki and Avito</a></li>
<li><a href="../422865/index.html">Java Enterprise open lesson "CDI in action"</a></li>
<li><a href="../422867/index.html">Determination of the number of floors of the house by its photos without machine learning</a></li>
<li><a href="../422869/index.html">We master new programming languages, based on the already studied</a></li>
<li><a href="../422871/index.html">Identifying content profiles in VK</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>