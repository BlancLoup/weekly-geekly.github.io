<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JPHP - How it works. History of creation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I will tell in more detail about the history of the JPHP project and how it was developed from the technical side. The text will be of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JPHP - How it works. History of creation</h1><div class="post__text post__text-html js-mediator-article">  <i>In this article I will tell in more detail about the history of the <a href="https://github.com/dim-s/jphp">JPHP</a> project and how it was developed from the technical side.</i>  <i>The text will be of interest to both simple PHP developers and compiler lovers.</i>  <i>I tried to describe everything in simple language.</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a11/bf3/039/a11bf303982a965ffcd6b2d6ff9cdf20.png" alt="image"><br><br><blockquote>  JPHP is a PHP language compiler for Java VM.  Two weeks ago I wrote <a href="http://habrahabr.ru/post/216651/">an article about the project</a> .  Related projects - JRuby for ruby, Jython for python.  After the publication of the first article about JPHP, the project scored 500 stars on a githaba in two days and managed to light up not only in Runet, but also on foreign resources, managed to be in first place in the github ranking. </blockquote><a name="habracut"></a><br>  And before the start of a little news. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Latest project news </h4><br><ul><li>  The project has got its own news twitter - <a href="https://twitter.com/jphpcompiler">https://twitter.com/jphpcompiler</a> </li><li>  Hooray!  Were implemented traits from PHP 5.4 as I promised </li><li> The goto from PHP 5.3 has been implemented and the quotes <code>``</code> </li><li>  A kind person <a href="https://habrahabr.ru/users/popsul/" class="user_link">popsul</a> realized binary numbers <code>0b</code> </li><li>  The implemented functions from zend runtime were separated from the kernel into a separate jphp-zend-ext module (all except Reflection, spl autoloading, iterators) </li><li>  Significant compiler refactoring performed </li><li>  Another kind person, <a href="https://habrahabr.ru/users/vistall/" class="user_link">VISTALL</a> , who is familiar with the IDEA plugin system, gave a lot of practical advice and is now exploring the possibility of integrating the JVM for JPHP debugger into this well-known environment, there are already successes </li></ul><br><br>  Soon, the project will have a separate site and it will be very easy to try JPHP, various compiled versions of the engine will be laid out.  So, let's move on to the topic ... <br><br><h4>  Project start </h4><br>  The project began spontaneously.  Before that, I was looking for similar projects, i.e.  php implementation for JVM.  There is such a project as Quercus from Resin, it is a translator into Java code written in Java.  This state of affairs did not suit me, the more so the authors of the project stated that their implementation works with the same speed as Zend PHP + APC.  Until a certain time, there were other PHP implementations for the JVM (p8 and projectzero for example), but they all died and closed. <br><br>  The main motivation for starting the project was performance and JIT.  I have been talking to Java for quite some time now, JVM high performance, cookies, a huge community and high-quality libraries are what attracts me to it.  And after thinking a little bit, I had an idea - to take the best of Java and implement the PHP engine on it.  Having collected my sprawled thoughts, I started writing a test version, deciding that if jphp is at least 2 times faster than the original Zend PHP, I will continue to develop. <br><br>  First of all, I walked through the repositories of all known JVM languages ‚Äã‚Äã(groovy, jruby, scala) and found out which set of libraries they use to generate JVM bytecode.  As it turned out, there is a well-known third-party library - <a href="http://asm.ow2.org/">ASM</a> .  It is developing quite actively, has sufficient documentation in PDF, and it seems to support even Dalvik (Android) bytecode (more on this below). <br><br><h4>  Introduction to the Java VM </h4><br>  The Java Virtual Machine (JVM) is quite a powerful tool.  How the JVM bytecode is organized can be found in the ASM library documentation.  Briefly describe all the features of VM in the following paragraphs: <br><br>  1. Virtual stack machine <br>  2. It is possible to store local variables by indices (something like registers) <br>  3. GC (garbage collector) is implemented at the VM level <br>  4. Objects and classes are implemented at the VM level <br>  5. A large number of standard operations - POP, PUSH, DUP, INVOKE, JMP, etc. <br>  6. For Try Catch there are instructions bytecode, for finally - partially <br>  7. For VM, there are several types of values: int32, int64, float, double, objects, arrays of scalars, arrays of objects, for bool, short, byte, char, int32 is used. <br><br>  Thus, I realized that I would not have to implement the GC itself and the object class system from scratch. <br><br><h4>  Selection of goals and priorities </h4><br>  Before starting development, I thoroughly understood the main advantages of PHP, not only as a language, but also as a platform.  The following things turned out to be the most obvious to me: <br><br><ul><li>  <b>Isolated environments</b> - this is almost a phi axiom, when the execution of scripts takes place in a separate environment for each request.  This scheme of work allows not to think about the division of resources between requests. </li><li>  <b>HOT Reloading</b> is a traditional php workflow, when, when changing sources, reopening the page, we see a new result. </li></ul><br><br>  These advantages are also disadvantages.  With each request, all classes are loaded again and this is not very good.  The problem is partially solved by bytecode caches, but not completely.  I thought that I could solve this problem by retaining the advantages that I listed above.  What I got in the end: <br><br><ul><li>  <b>Environment</b> objects - isolated environments for engine operation, each such environment has its own set of functions, classes, global variables and settings </li><li>  <b>CompileScope</b> objects ‚Äî they store compiled classes and functions that implement a caching mechanism for classes, functions, and modules.  Environment objects use scope to search for classes and functions; if they have already been compiled for CompileScope, they are instantly loaded into the Environment. </li></ul><br><br><h4>  Dynamic typing </h4><br>  At the Java VM level, there is no dynamic typing, but in PHP it is needed.  This will seem like a big problem to many, but it is not. <br><br>  To store values, I implemented the abstract class <b>Memory</b> .  Values ‚Äã‚ÄãJPHP stores as Memory objects.  Next, I implemented the StringMemory, NullMemory, DoubleMemory, LongMemory, TrueMemory, FalseMemory, ArrayMemory, and ObjectMemory classes.  As you probably understood by the class names, each of them is responsible for a certain type - numbers, strings, etc.  All of them were inherited from Memory. <br><br>  Memory consists of abstract methods that are needed to implement value operations, for example, for plus and minus operators, there are <code>plus()</code> and <code>minus()</code> methods that must be implemented in each Memory class.  These are virtual methods.  There are a lot of these methods, but there is a reason for this - various optimizations.  To understand how this works, here‚Äôs the pseudo-code: <br><br><div class="spoiler">  <b class="spoiler_title">Pseudo code example</b> <div class="spoiler_text"><pre> <code class="php hljs">$var + <span class="hljs-number"><span class="hljs-number">20</span></span>; <span class="hljs-comment"><span class="hljs-comment">//     //   $var    Memory $var-&gt;plus(20); //   plus      Memory $x + 20 - $y /*   */ $x-&gt;plus(20)-&gt;minus($y);</span></span></code> </pre><br>  Naturally, this is a pseudo-code, not a real php-code.  This all happens under the hood, in baytkod. <br></div></div><br><br>  The Memory object does not exceed zval objects from Zend PHP in memory consumption, and this is partly why JPHP and Zend PHP are roughly equivalent in terms of memory consumption.  For many values ‚Äã‚Äã(for example, false, true, null, small numbers), objects are cached in memory and not duplicated.  Does it make sense with every <code>true</code> create a new TrueMemory object?  Of course not. <br><br><h4>  Dynamic typing failure and fix </h4><br>  As I described above, all values ‚Äã‚Äãare objects of the Memory class.  At the very beginning I implemented autoboxing for simple constant values, i.e.  for example, if: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//    $y = $x + 2; //     (  ) $y-&gt;assign( $x-&gt;plus( new LongMemory(2) ) );</span></span></code> </pre><br><br>  As you see, ‚Äú2‚Äù turned into an object.  It was convenient from the point of view of programming, but from the point of view of performance, it was a nightmare.  This implementation worked for me no faster than Zend PHP. <br><br>  I decided to go to the end.  To avoid initiating such a large number of objects for simple values ‚Äã‚Äã(and present this code in a loop?), I decided to implement the plus () method and other similar ones for basic Java types - double, long, boolean, etc., and not just for Memory.  I admit, it was a routine and smacked of govnokodom.  I redid the compiler and he began to understand the types and what to do with them.  The compiler has learned to substitute different types and different methods for operations depending on the type of elements in the stack.  Yes, the stack is calculated at compile time.  Although it would be possible to keep these constant values ‚Äã‚Äãin the table of constants, it would still be overhead, although not so big. <br><br>  As it turned out, I started it all for good reason and the performance on synthetic tests began to overtake Zend PHP already more than 2-3-4-10 times, for example, on cycles, variables, etc. <br><br><h4>  Magic of variables </h4><br>  PHP is truly a magic language, I'm not exactly sure, but in what other language at runtime can you access the variable by name from a string?  A simple example: <br><br><pre> <code class="php hljs">$var = <span class="hljs-string"><span class="hljs-string">"foobar"</span></span>; ${<span class="hljs-string"><span class="hljs-string">'var'</span></span>} = <span class="hljs-number"><span class="hljs-number">100500</span></span>; $name = <span class="hljs-string"><span class="hljs-string">'var'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $$name;</code> </pre><br><br>  To implement this magic, you must use a named table of variables - a hash table.  JVM provides the ability to store variables by indices, of course, turning variable names into indexes at compile time is a more logical step, it provides very quick access to variables, faster than in the hash table.  Compare what will be faster - searching the hash table or accessing an index on an array? <br><br>  I first forgot about it and implemented the variables on the indexes.  The performance of addressing variables was up to par.  When I remembered such magic, I had to redo the table into a hash and ... everything was bad.  The performance of work with variables fell literally 2-3 times. <br><br>  Without hesitation, I decided to implement in the compiler 2 compilation modes of variables - in indices and with a hash table.  The analyzer helps to reveal the code in which it is necessary to refer to variables by string.  This happens on the following grounds: <br><br><ol><li>  If the code contains expressions: <code>$$var</code> , <code>${...}</code> </li><li>  There are functions eval, include, require, get_defined_vars, extract, compact </li><li>  Global scope </li></ol><br><br>  Why do I need to save variable names in a hash table in the code that contains require and include?  Yes, everything is simple, PHP should transfer variables inside the included scripts, the same with eval.  And the rest of the functions work with variable names. <br><br>  Very often, you do not need such magic of variables, which means your code will run faster in JPHP.  There is also a global scope for variables.  In this area, the storage mechanism of variables in the hash table is automatically used, since  it is assumed that global variables can be accessed through the <code>$GLOBALS</code> array by name and at any time. <br><br>  <b>Super - Global Variables</b> <br> <code>$GLOBALS, $_SERVER, $_ENV  ..</code>  , for such variables it is not necessary to prescribe the <b>global keyword</b> .  Their implementation is quite simple, the compiler knows in advance the names of super-global variables and, if such occur, then another code, an example of a pseudo-code, substitutes for access to such a variable: <br><br><div class="spoiler">  <b class="spoiler_title">Example of a super-global variable</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $a = $GLOBALS[<span class="hljs-string"><span class="hljs-string">'a'</span></span>]; ... $GLOBALS[<span class="hljs-string"><span class="hljs-string">'x'</span></span>] = <span class="hljs-number"><span class="hljs-number">33</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//        function test() { $GLOBALS =&amp; getGlobalVar('GLOBALS'); //   $a-&gt;assign($GLOBALS['a']); ... $GLOBALS['x']-&gt;assign(33); }</span></span></code> </pre><br></div></div><br><br><h4>  Arrays, Links and Immutable Values, GC </h4><br>  In PHP, arrays are copied, not passed by reference.  However, copying an array does not occur at the moment of assignment <b>=</b> , since  it would create a big overhead.  Inside the JPHP engine, and even in Zend PHP, arrays are copied by reference, but at the time of changing the array it is copied (in the event that the number of references to the array is&gt; 1). <br><br>  JPHP does not use reference counting, it uses standard GC from Java, which can delete circular references as well.  This creates problems when implementing such arrays.  Therefore, I implemented a special mechanism for turning any Memory value into an immutable value.  I will show the pseudo-code first: <br><br><pre> <code class="php hljs">$x = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>); $y = $x; $y[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    $y ,     $x //       (-): $x-&gt;assign( array(1,2,3) ); $y-&gt;assign($x-&gt;toImmutable()); //     $x $y[0]-&gt;assign(100); //    : $y =&amp; $x; //   -&gt;toImmutable    $y-&gt;assign($x);</span></span></code> </pre><br>  JPHP has another type of Memory object - ReferenceMemory, these objects simply store a reference to another Memory object.  However, variables are not always stored as Reference objects, in some cases local variables can do without such references and use bytecode directly to write a new value to a cell, this works naturally faster than the usual method <code>-&gt;assign().</code> <br><br>  Reference objects return their real value from the <code>toImmutable</code> method, and the arrays in turn return a special reference copy of the array, which is copied at the first change.  Therefore, to assign a variable a reference to another variable to the compiler, it is enough not to use the <code>toImmutable</code> method. <br><br><h4>  Implementing classes and functions </h4><br>  Classes already exist at the JVM level.  Generally speaking, Java, Scala, Groovy, JRuby generate the same classes with different signatures within the JVM.  JPHP when compiling php classes uses JVM classes with a special signature: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">Memory </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">methodName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Environment env, Memory[] args)</span></span></span></span></code> </pre><br>  The Environment object is passed to each method and function; this object allows you to learn a lot about the environment in which the method runs.  Classes and functions are compiled equally for all environments.  <b>Memory []</b> is an array of arguments passed to the method.  The method should always return something, not void, because in PHP, even if the function returns nothing, it returns null, this is a tautology. <br><br>  The php functions are also compiled into classes, since  there is no such thing as a function in the JVM.  At the output, we get a class with one static method, which in essence is our function.  Why functions are not compiled into methods of one class?  This is a good question, and most likely it is necessary to redo it in order not to produce extra classes, but so far it is more convenient. <br><br>  JVM can easily load classes from memory at runtime, just write your Java class loader.  Therefore, JPHP compiles at runtime and can load classes at run time and not all at once. <br><br><h4>  Long start and problem solving </h4><br>  The engine also implemented the ability to write classes on Java itself.  However, not all so simple.  All methods of such classes should have the required signature and be marked with some auxiliary annotations (for example, for type hinting), one of the examples of this class: <br><br><div class="spoiler">  <b class="spoiler_title">php \ lang \ System class</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> php.runtime.Memory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> php.runtime.env.Environment; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> php.runtime.lang.BaseObject; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> php.runtime.reflection.ClassEntity; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> php.runtime.annotation.Reflection.*; <span class="hljs-meta"><span class="hljs-meta">@Name</span></span>(<span class="hljs-string"><span class="hljs-string">"php\\lang\\System"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WrapSystem</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseObject</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WrapSystem</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Environment env, ClassEntity clazz)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(env, clazz); } <span class="hljs-meta"><span class="hljs-meta">@Signature</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Memory </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Environment env, Memory... args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Memory.NULL; } <span class="hljs-meta"><span class="hljs-meta">@Signature</span></span>(<span class="hljs-meta"><span class="hljs-meta">@Arg</span></span>(<span class="hljs-string"><span class="hljs-string">"status"</span></span>)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Memory </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">halt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Environment evn, Memory... args)</span></span></span><span class="hljs-function"> </span></span>{ System.exit(args[<span class="hljs-number"><span class="hljs-number">0</span></span>].toInteger()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Memory.NULL; } }</code> </pre></div></div><br><br>  As the number of new native classes for JPHP increased, I noticed that the time spent on registering classes increased.  The more extensions and classes there were, the longer was the delay before the engine was launched.  It bothered me.  And the idea came - how to fix it. <br><br>  PHP as a language has a lazy class loading mechanism, everyone knows about it.  I just used the lazy class loading mechanism to register native classes.  When the native java class is registered, it is simply registered in the table of names, and de facto registration occurs at the time of the first use of this class.  Having implemented this mechanism, I got good results, the engine initialization time decreased by 2-3 times, and the test passing time decreased from 24 seconds to 13 seconds.  Due to this, the number of native classes will have almost no effect on the initialization speed of the engine. <br><br>  The speed of starting the engine is especially important in GUI applications. <br><br><h4>  Problems with JVM </h4><br>  <b>1. Naming JVM classes.</b>  JVM enforces class naming standards.  If you write a class file path in bytecode, the JVM checks the naming convention of this class as in the Java language.  This is a bit like the PSR-0 standard.  However, if the class is placed in the global jvm package, this check does not occur.  PHP can store as many classes and functions in one file, and they can have any fancy names.  Therefore, I had to unbind the binding of php class names to the names of JVM classes inside bytecode.  But this is not the only reason for this choice ... <br><br>  <b>2. Unique class names.</b>  JPHP should be able to save the received bytecode to a file and upload it to any environment, therefore all classes at the jvm level must have unique names so that there are no conflicts.  While loading jvm bytecode, you cannot change the class name, at least I haven't tried it yet.  For now, as a workaround, I generate a random class name for the JVM based on UUID + some things.  I think this is not a very elegant solution, in the future I hope there will be better.  You cannot use the name of the file in which the class is located, because  the code may not be located in the class at all, but the bytecode file may be transferred from computer to computer and its name may change. <br><br>  <b>3. Limitations of reflection.</b>  Through Java reflection it is impossible to call a method in the context of a parent's class, i.e.  something like <code>super.call()</code> , and in php <code>parent::</code> .  Of course, invokeDynamic was introduced in Java 7, which allows this to happen, but it works surprisingly slower than reflection.  The failure of invokeDynamic was primarily due to poor performance in Java 7, although this problem was solved in Java 8 and now they are the same in speed (maybe I‚Äôm not preparing it correctly?).  In addition, I wanted support for Java 6 and more easy adaptation for Android, in which I suspect no invokeDynamic, but there is reflection. <br><br>  I solved this problem not quite elegantly, I had to abandon the standard mechanism for redefining the methods of the jvm classes, and therefore the names of the inherited methods at the level of the jvm classes are different - by the algorithm <code>method_name + $ + index</code> .  This solution did not create and does not create any problems, but it solves the above described problem. <br><br><h4>  How Traits were implemented </h4><br>  Traits are a multiple inheritance mechanism introduced in PHP since version 5.4.  In fact, it works as a copy-paste.  In the implementation of JPHP, it also happens, though not copying the AST tree, but copying the compiled bytecode.  Of course, there are no traits in the JVM, but JPHP compiles traits into regular JVM classes and it controls the trait limits itself, for example, it does not allow creating objects from the traits or inheriting from the traits. <br><br>  Thus, you can easily re-use the JVM-compiled bytecode treit without having the original source code.  There is nothing complicated about copying at the JVM level, the ASM library is easy to handle.  The only thing is that in some places it is necessary to generate a slightly different bytecode than in regular classes.  For example, this happens with the constant <code>__CLASS__</code> in treytah. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">trait</span></span> Foobar { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-keyword"><span class="hljs-keyword">__CLASS__</span></span>; } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Foobar</span></span>; } $a = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> A(); $a-&gt;test();</code> </pre><br><br>  JPHP normally replaces the constant <code>__CLASS__</code> at compile time with a string with the name of the class in which the code is located.  It is impossible to do this with traits, and you have to calculate the value of this constant dynamically at run time, if it occurs in traits.  But <code>__TRAIT__</code> constant in treyta works the same as <code>__CLASS__</code> in classes.  It also comes up with <code>self</code> and <code>self::class</code> expressions.  Copying properties is quite simple, so it makes no sense to describe it. <br><br><h4>  Denial of the Zend runtime libraries </h4><br>  Here, by libraries, I mean extensions written in C using zend api, including the standard PHP functions.  Somewhere in the month I implemented them - functions for strings, arrays, etc.  as in php.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The most annoying thing is that even after reading the description of some functions I couldn‚Äôt drive in 1-2-3 times, what will happen when passing various options of arguments, what a result to expect. In php, functions are too universal, a huge amount of functionality is crammed into one function and this makes it very difficult to implement such functions. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At some stage, I realized that I did not implement these functions at such a level that wordpress or symfony could be run on JPHP, for example. And the attitude to the project from the side would be approximately as follows:</font></font><br><br><blockquote> <u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A conservative developer</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúWhy do I need JPHP if you cannot run wordpress, symfony, yii or another well-known project on it, but when you implement all the zend libraries, then I will think about it. </font><font style="vertical-align: inherit;">In the meantime, I'd rather look at HHVM. ‚Äù </font></font><br></i> <br> <u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Progressive developer</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúYou implemented JPHP and repeated the entire php curve and ugly runtime, all inconsistent functions and classes, and why did you have to spend time on it?‚Äù.</font></font></i> <br></blockquote><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I realized that giving up Zend Runtime is a very good idea. </font><font style="vertical-align: inherit;">PHP is often blamed for runtime curves, curves and inconsistent functions. </font><font style="vertical-align: inherit;">And it was decided to write my own runtime, I think active developers who like to try something new and experiment will not turn away from the project.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> New features and classes to replace Zend Runtime </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I decided to select all core classes and functions that will necessarily go out of the box in JPHP into a separate namespace </font></font><code>php</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">so as not to clutter up the global namespace.</font></font> Among them are the following: <br><br><ol><li> <code>php\lang\Module</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- The mechanism for loading sources without include and require. </font><font style="vertical-align: inherit;">Allows you to download a file (like include), but not executing it immediately, but only at the request of the programmer. </font><font style="vertical-align: inherit;">In addition, the class provides the opportunity to get information about which classes and functions are inside. </font><font style="vertical-align: inherit;">It will be able to download source codes from any Stream objects. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">With the advent of the class autoloader mechanism, I see no reason to use include and require, except in the class loader handler.</font></font></li><li> <code>php\io\Stream</code> ‚Äî    fopen, fwrite,  ..    ,   typehinting   ,      Stream      , ,   .. </li><li> <code>php\lang\Thread, php\lang\ThreadGroup</code> ‚Äî     .           ,        2 . </li><li> <code>php\io\File</code> ‚Äî     ,        ,         File  Java,    </li><li>     Java ,  ,       ,  ,   java      Java </li><li> <code>php\lang\Environment</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">isolated environments for code execution, support options: </font></font><code>HOT_RELOAD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for hot-swapping code and </font></font><code>CONCURRENT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for using the same environment in several streams.</font></font></li></ol><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> This list is not yet complete, there was no time to think about it properly, therefore there are so few classes. </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> JPHP testing </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I think many wonder how such a complex project can be done alone and so that nothing breaks as it is developed. This problem is almost 100% solved by unit tests. It is very easy to test the programming language engine, you can immediately see what and how to test. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first time I wrote my own simple tests, at that time I could not use complex zend language tests. But as JPHP developed, I began to gradually introduce zend tests, which can be found in the source code of php itself. They are also not perfect, sometimes you had to edit them, because third-party functions were used in the tests. You will understand, here is an example: a test for testing </font></font><code>set_error_handler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, a function is used inside the test</font></font><code>fopen</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In my opinion this is very wrong, why should the extension function take part in a test for one of the basic parts of the language? </font><font style="vertical-align: inherit;">A typical unit test from zend consists of several sections, for example:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unit test for traits</font></font></b> <div class="spoiler_text"><pre> <code class="php hljs">--TEST-- <span class="hljs-keyword"><span class="hljs-keyword">Use</span></span> <span class="hljs-title"><span class="hljs-title">instead</span></span> <span class="hljs-title"><span class="hljs-title">to</span></span> <span class="hljs-title"><span class="hljs-title">solve</span></span> <span class="hljs-title"><span class="hljs-title">a</span></span> <span class="hljs-title"><span class="hljs-title">conflict</span></span>. --<span class="hljs-title"><span class="hljs-title">FILE</span></span>-- &lt;?<span class="hljs-title"><span class="hljs-title">php</span></span> <span class="hljs-title"><span class="hljs-title">error_reporting</span></span>(<span class="hljs-title"><span class="hljs-title">E_ALL</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">trait</span></span> Hello { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saySomething</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'Hello'</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">trait</span></span> World { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saySomething</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'World'</span></span>; } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyHelloWorld</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Hello</span></span>, <span class="hljs-title"><span class="hljs-title">World</span></span> { <span class="hljs-title"><span class="hljs-title">Hello</span></span>::<span class="hljs-title"><span class="hljs-title">saySomething</span></span> <span class="hljs-title"><span class="hljs-title">insteadof</span></span> <span class="hljs-title"><span class="hljs-title">World</span></span>; } } $o = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyHelloWorld(); $o-&gt;saySomething(); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> --EXPECTF-- Hello</code> </pre><br><br>   ,   : <code>--TEST--</code> , <code>--FILE--</code> , <code>--EXPECTF--</code> ‚Äî  ,       . <br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">With the help of Zend tests, I was able to fix a huge number of bugs and inconsistencies with the PHP language, especially in OOP (and there believe, a lot of non-trivial behavior). </font><font style="vertical-align: inherit;">The implementation of the traits also occurred through the introduction of zend tests and when I write that such a feature was implemented, this means that it passes jphp and zend unit tests.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Android and Dalvik </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dalvik is a completely different type of virtual machine than a JVM, it performs a different bytecode format and is itself a register one, not a stack one. </font><font style="vertical-align: inherit;">JPHP is a compiler for a JVM machine and of course it compiles a bytecode incompatible with Dalvik. </font><font style="vertical-align: inherit;">However, Google has kindly provided an interesting utility for developers to convert JVM bytecode to Dalvik bytecode. </font><font style="vertical-align: inherit;">There is a Ruboto project from JRuby, which can also help with reference points - where to go. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android is certainly a promising direction, but until it is time to port JPHP to this platform. </font><font style="vertical-align: inherit;">Only when the project reaches version 1.0, when it becomes stable, only then will it make sense to me.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Where to go next? </font></font></h4><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WEB</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Yes, it is possible. JPHP allows you to write your web-server entirely in php, just as it is written in Node.js, Ruby and in other languages. At the same time, he will provide out of the box a flexible and customizable hot-reloading mode for hot-swapping the code. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JPHP will allow you to write very productive servers, giving mechanisms for accessing shared memory between requests. This will allow writing a completely different plan in php. If you have heard of Phalcon, then this is something similar, it is only written in C. JPHP will provide you with the opportunity to write such a framework, with complex logic, with high performance in php, and not in the form of a complex C or C ++ extension. In a pinch, you can write a Java extension for bottlenecks, which is much easier than writing an extension in C or C ++. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GUI</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yes, many write off desktops, because </font><font style="vertical-align: inherit;">everything goes to the web. </font><font style="vertical-align: inherit;">But this area is still relevant and in demand. </font><font style="vertical-align: inherit;">JPHP will allow you to write gui applications, it already allows, there is an extension for Swing, in the future it may appear for JavaFX, which supports HTML5 and CSS3.</font></font><br><br>  <b>Android</b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of course, this is still a distant prospect, but it is. </font><font style="vertical-align: inherit;">In addition, JPHP may already run on ARM devices where there is an Oracle VM, for example, on Raspberry Pi.</font></font><br><br><h4>  Conclusion </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP turned out to be quite a capricious patient, but in the end the operation was successful =). </font><font style="vertical-align: inherit;">I understand that many third-party developers do not like this language, that it is often criticized, but it is worth looking at the language from the other side. </font><font style="vertical-align: inherit;">I myself use PHP when I need to quickly do some kind of prototype, a front end for something, and I often use it to write functional tests.</font></font><br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/218021/">https://habr.com/ru/post/218021/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../218009/index.html">New Nimbus Clipper, as well as passwords for public notes</a></li>
<li><a href="../218011/index.html">Impressions of the Human-Computer Interaction course on Coursera</a></li>
<li><a href="../218013/index.html">What can be done with ITEAD IBOX. Part 1</a></li>
<li><a href="../218015/index.html">Space exit 23: conquering the new frontier</a></li>
<li><a href="../218019/index.html">A couple of words about Epson Moverio BT-200</a></li>
<li><a href="../218023/index.html">The comet landing module "Fila" successfully woke up aboard the probe "Rosette"</a></li>
<li><a href="../218025/index.html">Psychological component of the speed of interaction in mobile interfaces</a></li>
<li><a href="../218027/index.html">Purpose of gyroscopic sensors and their use in modern navigation systems</a></li>
<li><a href="../218029/index.html">Like a car gyro on the steering wheel, measured</a></li>
<li><a href="../218031/index.html">SAP ABAP: Crossing Checkpoint Charlie in a SAAB (translated from scn.sap.com)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>