<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hot code replacement (code hot swapping) in PHP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The weather outside the window just requires something hot, so taking advantage of the opportunity to explore something in my spare time, I decided to...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hot code replacement (code hot swapping) in PHP</h1><div class="post__text post__text-html js-mediator-article">  The weather outside the window just requires something hot, so taking advantage of the opportunity to explore something in my spare time, I decided to think - is it possible, without stopping the script, to change the function that is being performed?  I met this demand a little earlier when developing our startup.  We had one of the internal servers, which managed all the actions between users in real time.  This is a common PHP daemon router that processed requests from client requests (inside the server), but there was one difficulty ‚Äî when I changed something in the server code or handlers of individual commands, the daemon had to be rebooted, which meant that current clients were disconnected and loss of information about the state of the server (this issue is solved, of course).  The same was in case of an error in the code - all connected users immediately felt it on themselves (well, that they are all the same developers, and not real customers).  Can this be avoided? <br><br>  Of course, you can, for example, rejecting the demon scripts, as we did.  However, this problem did not disappear, it just moved it to another plane.  After all, there are other services demons, which also have to work continuously, even though their significance is less, however, I don‚Äôt really want to reboot each time.  Therefore, I decided to look for an opportunity to connect a new code on the fly and immediately execute it.  The minimum code will be a function, but it is quite possible to include class methods. <a name="habracut"></a><br><br>  Another point is not quite clean replacement.  First, the old method remains in memory and is still available for execution, on a par with the new one.  Secondly, the function can be changed only at the moment of its calling, in the process of execution it will not work anymore. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There are languages ‚Äã‚Äãin which hot-swappable code is embedded at the language or platform level.  The most famous representative is probably you guessed it - Erlang / OTP.  This possibility is also present in other languages ‚Äã‚Äã- Smalltalk, Lisp and Java (albeit with a number of restrictions).  In Visual Studio, this is possible when using debug mode and is supported in C #, VB.NET, and C / C ++.  However, we have the same PHP ... <br><br><div style="text-align:center;"><img src="http://abrdev.com/wp-content/uploads/2010/01/hotswap.jpg" alt="hotswap"></div><br><br>  At once I will make a reservation that this is just an experiment, checking the very possibility of such a trick, although I do not rule out a real use.  Of course, the speed in this mode is reduced, but if the overhead of each call is tolerable, we will be able to transparently update the working PHP-daemon without affecting the entire code.  In addition, it is possible to first create an application framework, run it, and then gradually build on the implementation of each method. <br><br>  Let's start.  The first thing that comes to mind is - what if just simply calling the connection of the file with the function text again?  Unfortunately, this will not work directly - caching accelerators can interfere, but this is the least of all problems.  The main thing is that PHP generates an error when trying to connect a function with the same name as the existing one at the time of connection.  Conclusion?  Changing the name of our function each time we update its code, for example, adding a suffix with the version number: if the original function has the form function _my_test (), then in the case of editing a new function should already be called _my_test_v1 ().  But the rest of the code does not know that we have connected a new implementation. <br><br>  One of the ways is that the script at runtime can get a list of all functions defined in scripts (separately system and user-defined) and look in this list, all of a sudden there is an updated function (that is, ordinary string methods).  But this is not the best method, and besides, there is enough invoice for the costs of processing an array of functions, in large projects it can be significant.  But it works, which was tested on the first evening of the study. <br><br>  And later the thought came to mind how to further improve the method of determining a new method.  Let him inform the rest of the code that he has been updated - because who, apart from the function itself, knows this best of all? <br><br>  The opportunity to set the return value in the source code file, which is connected with include / require, came to the rescue.  Through return, you can send and receive any information at the time of connection.  Including the table of certain functions and their versions, as well as aliases - to hide a specific version name we use an alias, which is already resolved inside to a specific name of the function that is called. <br><br>  This is followed by another magic property of PHP - namely, __call () - the magic method of objects, which is called if we turn to an unknown class method.  And now we do this - we define a special proxy class, which has only one method - this very __call ().  In the surrounding code, all calls to functions that change without reloading the script are rewritten to calls to the methods of our proxy class.  Of course, aliases of real methods are called.  This means that no matter how much we change the name of the method, _my_test1, _my_test99, in our code we simply refer to a common alias, _my_test, which hides the real call. <br><br>  The __call method, when called, checks first of all whether the file has been updated since the last access.  To do this, we first clear the internal cache of the file system information (using the clearstatcache function), then we get the time stamp of the file change via filemtime.  If the file is updated, you need to connect it through require.  It is important here - the file will give us a table of the functions and their versions defined there, so we will first check if the method we need is implemented there.  The name of the requested method is passed to the __call magic method by the first parameter, so it is enough just to check for the presence of such a key in the resulting array.  If it is, then check the version number of the current code and the connected one.  Our version is an integer or fractional number - so that you can find out by simple comparison which version is greater.  Of course, versions should monotonously increase with each edit of the source code of the function. <br><br>  If we find the desired function and its version is larger than the current one, we execute.  The transferred array contains a string with the real name of the new function, so you need to call it via call_user_func, passing as a parameter the real name of the new function and the parameters with which the proxy class method was called.  Before that, we will definitely keep all information inside the proxy - the timestamp of the connected file, the table of functions and their versions.  Now we will have a table about which versions of the functions are relevant at the current moment and we can simply compare them with the next call to decide what to call.  Note that the source file is only connected if it has been changed, but if you do not change the name of the functions, there will be an error (Fatal error: Cannot redeclare _myfn_1 () (previously declared in ...), because PHP will see that we are trying to connect an existing function. Therefore, it is imperative to change the names of functions and increase the version number every time the file is changed. The problem may be to define several functions in one file - you have to rename all methods regardless of whether their code was actually changed. However, if you rename only the function, but  in the method table, do not touch anything, then everything is OK, the previous method that is already in the interpreter‚Äôs memory will be called anyway, so changing the name in the function table is possible only when it has really changed. <br><br>  This is how you can substitute methods in a running daemon on PHP without the need to stop it.  Each time the method is called, it will be checked if there were any code changes and if something has changed, we try to call the new version of the function. <br><br>  I would like to see the loss of productivity at check.  This is not a real test, just for the sake of "eye evaluation". <br><br>  An example of a normal call: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> <font color="#008000">* Total: 28.779473 sec;</font> <font color="#008000">* Per call: 0.002878 sec</font> <font color="#008000">*/</font></font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <ol><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> <font color="#008000">* Total: 28.779473 sec;</font> <font color="#008000">* Per call: 0.002878 sec</font> <font color="#008000">*/</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> <font color="#008000">* Total: 28.779473 sec;</font> <font color="#008000">* Per call: 0.002878 sec</font> <font color="#008000">*/</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> <font color="#008000">* Total: 28.779473 sec;</font> <font color="#008000">* Per call: 0.002878 sec</font> <font color="#008000">*/</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> <font color="#008000">* Total: 28.779473 sec;</font> <font color="#008000">* Per call: 0.002878 sec</font> <font color="#008000">*/</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> <font color="#008000">* Total: 28.779473 sec;</font> <font color="#008000">* Per call: 0.002878 sec</font> <font color="#008000">*/</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> <font color="#008000">* Total: 28.779473 sec;</font> <font color="#008000">* Per call: 0.002878 sec</font> <font color="#008000">*/</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> <font color="#008000">* Total: 28.779473 sec;</font> <font color="#008000">* Per call: 0.002878 sec</font> <font color="#008000">*/</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> <font color="#008000">* Total: 28.779473 sec;</font> <font color="#008000">* Per call: 0.002878 sec</font> <font color="#008000">*/</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> <font color="#008000">* Total: 28.779473 sec;</font> <font color="#008000">* Per call: 0.002878 sec</font> <font color="#008000">*/</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> <font color="#008000">* Total: 28.779473 sec;</font> <font color="#008000">* Per call: 0.002878 sec</font> <font color="#008000">*/</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> <font color="#008000">* Total: 28.779473 sec;</font> <font color="#008000">* Per call: 0.002878 sec</font> <font color="#008000">*/</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> <font color="#008000">* Total: 28.779473 sec;</font> <font color="#008000">* Per call: 0.002878 sec</font> <font color="#008000">*/</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> <font color="#008000">* Total: 28.779473 sec;</font> <font color="#008000">* Per call: 0.002878 sec</font> <font color="#008000">*/</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> <font color="#008000">* Total: 28.779473 sec;</font> <font color="#008000">* Per call: 0.002878 sec</font> <font color="#008000">*/</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> <font color="#008000">* Total: 28.779473 sec;</font> <font color="#008000">* Per call: 0.002878 sec</font> <font color="#008000">*/</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> <font color="#008000">* Total: 28.779473 sec;</font> <font color="#008000">* Per call: 0.002878 sec</font> <font color="#008000">*/</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> <font color="#008000">* Total: 28.779473 sec;</font> <font color="#008000">* Per call: 0.002878 sec</font> <font color="#008000">*/</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> <font color="#008000">* Total: 28.779473 sec;</font> <font color="#008000">* Per call: 0.002878 sec</font> <font color="#008000">*/</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> <font color="#008000">* Total: 28.779473 sec;</font> <font color="#008000">* Per call: 0.002878 sec</font> <font color="#008000">*/</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> <font color="#008000">* Total: 28.779473 sec;</font> <font color="#008000">* Per call: 0.002878 sec</font> <font color="#008000">*/</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; /* <font color="#008000">* Total: 28.779473 sec;</font> <font color="#008000">* Per call: 0.002878 sec</font> <font color="#008000">*/</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> * Total: 28.779473 sec; <font color="#008000">* Per call: 0.002878 sec</font> <font color="#008000">*/</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> <font color="#008000">* Total: 28.779473 sec;</font> * Per call: 0.002878 sec <font color="#008000">*/</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> <font color="#008000">* Total: 28.779473 sec;</font> <font color="#008000">* Per call: 0.002878 sec</font> */ <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> </ol> <code><font color="gray"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">class</font> Test_1 { <font color="#0000ff">public</font> <font color="#0000ff">function</font> _myFn($mv){ $_rand = rand(0, 99999999); $_arr = get_defined_functions(); <font color="#0000ff">return</font> sha1($_rand . $mv . implode( <font color="#A31515">','</font> , $_arr[ <font color="#A31515">'internal'</font> ])); } } $i = 0; $max = 10000; $_st = microtime( <font color="#0000ff">true</font> ); $test = <font color="#0000ff">new</font> Test_1(); <font color="#0000ff">while</font> ($i &lt; $max) { $test-&gt;_myFn($i); $i++; } $_ft = microtime( <font color="#0000ff">true</font> ); echo <font color="#A31515">"\n Total: "</font> . round(($_ft - $_st), 6) . <font color="#A31515">" sec; \n"</font> ; echo <font color="#A31515">"Per call: "</font> . round((($_ft - $_st)/$max), 6) . <font color="#A31515">" sec \n"</font> ; <font color="#008000">/*</font> <font color="#008000">* Total: 28.779473 sec;</font> <font color="#008000">* Per call: 0.002878 sec</font> <font color="#008000">*/</font></font> * This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Without code substitution at runtime (but through our proxy class, with checks): <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#008000">/ *</font> </li><li>  <font color="#008000">* Total: 28.914997 sec;</font> </li><li>  <font color="#008000">* Per call: 0.002891 sec</font> </li><li>  <font color="#008000">* /</font> </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  And now the result with the substitution of the source function at runtime (I just edit the file and upload it to the server in parallel with the script running in the console): <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li></li><li>  <font color="#008000">/ *</font> </li><li>  <font color="#008000">* Total: 32.493496 sec;</font> </li><li>  <font color="#008000">* Per call: 0.00065 sec</font> </li><li>  <font color="#008000">* /</font> </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  Although the given estimate of the time for one call increased almost twice, the total time for performing the same test (calling 10 thousand times of the method) increased slightly - by about 13 percent.  Probably because during the test the method was changed only once, all before and subsequent executions in the cycle were without accessing the file with the code, so the frequency of updating the source codes and the intensity of their call inside the application will play a major role in slowing down.  But for normal cases, when the code is relatively rare (that is, time measured by seconds between calls), and the calculations themselves inside the code being replaced are more or less significant (for example, receiving a file from a remote server), the losses will be almost imperceptible, but the flexibility of the application will increase . <br><br>  Of course, there are many nuances and objections - and in the real practice of fault-tolerant systems, I would carefully apply this, but the fact remains that hot-code replacement in PHP applications is quite possible!  What I wanted to find out. <br><br>  PS And here is the source code itself: a proxy class and a plug-in file with the function: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li></li><li>  <font color="#008000">/ *</font> </li><li>  <font color="#008000">* Proxy class and test code</font> </li><li>  <font color="#008000">* /</font> </li><li></li><li></li><li>  <font color="#0000ff">class</font> HotCode </li><li>  { </li><li>  <font color="#0000ff">protected</font> $ _current_v = <font color="#0000ff">null</font> ;  <font color="#008000">// current code version</font> </li><li>  <font color="#0000ff">protected</font> $ _current_timestamp = 0;  <font color="#008000">// timestamp of the function that is executed</font> </li><li>  <font color="#0000ff">protected</font> $ _current_fn = <font color="#0000ff">null</font> ;  <font color="#008000">// name of the current function</font> </li><li>  <font color="#0000ff">public</font> <font color="#0000ff">function</font> __call ($ fnmame, $ fparam) </li><li>  { </li><li>  <font color="#0000ff">if</font> (($ <font color="#0000ff">this</font> -&gt; _ current_fn! = <font color="#0000ff">null</font> ) &amp;&amp; ($ <font color="#0000ff">this</font> -&gt; _ current_timestamp! = <font color="#0000ff">null</font> )) </li><li>  { </li><li>  echo $ <font color="#0000ff">this</font> -&gt; _ current_fn.  <font color="#A31515">"from"</font> .  date ( <font color="#A31515">'jmY H: i s'</font> , $ <font color="#0000ff">this</font> -&gt; _ current_timestamp).  <font color="#A31515">"is current function \ n"</font> ; </li><li>  } </li><li></li><li>  clearstatcache (); </li><li></li><li>  <font color="#008000">// check, can there be current code?</font> </li><li>  $ _file_last = filemtime ( <font color="#A31515">'/var/www/deamon/hot_swap_fn.php'</font> ); </li><li></li><li>  <font color="#0000ff">if</font> ($ _file_last === FALSE) </li><li>  { </li><li>  <font color="#008000">// what = something wrong</font> </li><li>  <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception ( <font color="#A31515">'Including file does not exist'</font> ); </li><li>  } </li><li></li><li>  echo <font color="#A31515">"Last modif of file:"</font> .  date ( <font color="#A31515">'jmY H: i s'</font> , $ _file_last).  <font color="#A31515">"\ n"</font> ; </li><li>  echo <font color="#A31515">"Now:"</font> .  date ( <font color="#A31515">'jmY H: i s'</font> , time ()).  <font color="#A31515">"\ n"</font> ; </li><li></li><li>  <font color="#0000ff">if</font> (($ <font color="#0000ff">this</font> -&gt; _ current_v == <font color="#0000ff">null</font> ) || ((is_integer ($ _ file_last))) &amp;&amp; ($ _file_last&gt; $ <font color="#0000ff">this</font> -&gt; _ current_timestamp))) </li><li>  { </li><li>  <font color="#008000">// forcefully connect</font> </li><li>  $ _xfn = require ( <font color="#A31515">'hot_swap_fn.php'</font> ); </li><li></li><li>  <font color="#008000">// we got an array of functions defined there, their versions and aliases</font> </li><li>  <font color="#0000ff">if</font> (array_key_exists ($ fnmame, $ _xfn)) </li><li>  { </li><li>  <font color="#008000">// method is</font> </li><li>  <font color="#0000ff">if</font> ($ <font color="#0000ff">this</font> -&gt; _ current_v == <font color="#0000ff">null</font> ) </li><li>  { </li><li>  <font color="#008000">// first time, yeah</font> </li><li>  $ <font color="#0000ff">this</font> -&gt; _ current_v = $ _xfn [$ fnmame] [ <font color="#A31515">'v'</font> ];  <font color="#008000">// remember the version</font> </li><li>  $ <font color="#0000ff">this</font> -&gt; _ current_fn = $ _xfn [$ fnmame] [ <font color="#A31515">'fn'</font> ]; </li><li>  $ <font color="#0000ff">this</font> -&gt; _ current_timestamp = $ _file_last; </li><li>  } </li><li>  <font color="#0000ff">else</font> </li><li>  { </li><li>  <font color="#008000">// compare versions</font> </li><li>  <font color="#0000ff">if</font> ($ _xfn [$ fnmame] [ <font color="#A31515">'v'</font> ]&gt; $ <font color="#0000ff">this</font> -&gt; _ current_v) </li><li>  { </li><li>  <font color="#008000">// newer version</font> </li><li>  $ <font color="#0000ff">this</font> -&gt; _ current_v = $ _xfn [$ fnmame] [ <font color="#A31515">'v'</font> ];  <font color="#008000">// remember the version</font> </li><li>  $ <font color="#0000ff">this</font> -&gt; _ current_fn = $ _xfn [$ fnmame] [ <font color="#A31515">'fn'</font> ]; </li><li>  $ <font color="#0000ff">this</font> -&gt; _ current_timestamp = $ _file_last; </li><li>  } </li><li>  <font color="#008000">// otherwise I use the old one</font> </li><li>  } </li><li></li><li>  <font color="#008000">// Call with parameters</font> </li><li>  <font color="#0000ff">if</font> ($ <font color="#0000ff">this</font> -&gt; _ current_fn! = <font color="#0000ff">null</font> ) </li><li>  <font color="#0000ff">return</font> call_user_func ($ <font color="#0000ff">this</font> -&gt; _ current_fn, $ fparam [0]); </li><li>  <font color="#0000ff">else</font> </li><li>  <font color="#0000ff">return</font> $ <font color="#0000ff">this</font> -&gt; defaultEmptyFnCall ($ fparam);  <font color="#008000">// otherwise default "stub"</font> </li><li></li><li>  } </li><li>  <font color="#0000ff">else</font> </li><li>  <font color="#0000ff">return</font> $ <font color="#0000ff">this</font> -&gt; defaultEmptyFnCall ($ fparam); </li><li></li><li>  } </li><li>  <font color="#0000ff">else</font> </li><li>  <font color="#0000ff">if</font> ($ <font color="#0000ff">this</font> -&gt; _ current_fn! = <font color="#0000ff">null</font> ) </li><li>  <font color="#0000ff">return</font> call_user_func ($ <font color="#0000ff">this</font> -&gt; _ current_fn, $ fparam [0]); </li><li>  <font color="#0000ff">else</font> </li><li>  <font color="#0000ff">return</font> $ <font color="#0000ff">this</font> -&gt; defaultEmptyFnCall ($ fparam);  <font color="#008000">// otherwise default "stub"</font> </li><li>  } </li><li></li><li>  <font color="#008000">// call if requested a function that does not exist</font> </li><li>  <font color="#0000ff">private</font> <font color="#0000ff">function</font> defaultEmptyFnCall ($ param = <font color="#0000ff">null</font> ) </li><li>  { </li><li>  var_dump ($ param); </li><li>  } </li><li>  } </li><li>  $ _my_hot_class = <font color="#0000ff">new</font> HotCode (); </li><li></li><li></li><li>  &lt;? php </li><li></li><li>  <font color="#008000">/ * File: hot_swap_fn.php</font> </li><li>  <font color="#008000">* Plugin file with function for Hot swap</font> </li><li>  <font color="#008000">* /</font> </li><li></li><li>  <font color="#0000ff">function</font> _myFn_2 ($ param) </li><li>  { </li><li>  $ _rand = rand (0, 99999999); </li><li>  $ _arr = get_defined_functions (); </li><li></li><li>  <font color="#0000ff">return</font> sha1 ($ _ rand. $ param. implode ( <font color="#A31515">','</font> , $ _arr [ <font color="#A31515">'internal'</font> ])); </li><li>  } </li><li>  <font color="#0000ff">return</font> array ( </li><li>  <font color="#A31515">'_myFn'</font> =&gt; array ( <font color="#A31515">'v'</font> =&gt; 2, </li><li>  <font color="#A31515">'fn'</font> =&gt; <font color="#A31515">'_myFn_2'</font> ) </li><li>  ); </li><li>  ?&gt; </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote></div><p>Source: <a href="https://habr.com/ru/post/81783/">https://habr.com/ru/post/81783/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../81768/index.html">And you work in a specialty obtained in the university?</a></li>
<li><a href="../81769/index.html">Enterprise Library 5.0 and Unity 2.0 Roadmap</a></li>
<li><a href="../81778/index.html">World Wide Web, when ‚Äúthe Internet is low and slow‚Äù is at hand) Step 1</a></li>
<li><a href="../81779/index.html">How to do well at the same time to students, teachers, employers and the country as a whole (idealistic and naive version of the modernization of higher education)</a></li>
<li><a href="../81780/index.html">Lebedev Studio has made a site for an Internet pyramid</a></li>
<li><a href="../81784/index.html">Update for the ‚Äúpage for happy owners of IE6‚Äù</a></li>
<li><a href="../81785/index.html">Airplanes on electric motors - the reality of today</a></li>
<li><a href="../81786/index.html">Jahia Enterprise Portal - Architecture Overview (Part 1)</a></li>
<li><a href="../81787/index.html">Internet 2009 in facts and figures</a></li>
<li><a href="../81792/index.html">Free PSP 3008 how to implement?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>