<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Recipes against deadlocks on signal variables</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, dear Habrayuzer! 

 With this post I continue a series of articles aimed at fighting for the purity and safety of the developed multi-thread...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Recipes against deadlocks on signal variables</h1><div class="post__text post__text-html js-mediator-article">  Good day, dear Habrayuzer! <br><br>  With this post I continue a series of articles aimed at fighting for the purity and safety of the developed multi-threaded programs. <br><img src="https://habrastorage.org/storage2/e61/72d/730/e6172d730c71b58a18d965cf4a1443c0.png"><br>  Figure 1 - Interlocking 1st kind with the participation of the signal variable. <br><br>  As part of this post, we will look at the problems that arise when using signal variables, and show how to avoid them. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      With your permission, I will miss the long introductions, hoping that you are already familiar with the <a href="http://habrahabr.ru/company/nordavind/blog/176541/">previous post</a> and we equally understand: <br><ol><li>  What is interlocking. </li><li>  How is the ‚Äútransition model‚Äù of a multi-threaded program constructed and read? </li><li>  How to avoid deadlocks when using mutexes. </li></ol><br>  So, the signal variable (or condition variable, the English condition condition) is a synchronization tool that ensures that one thread can wait for a certain condition to be met by another thread. <br><br><h4>  Extension of the multithreaded program transition model </h4><br>  When describing a multithreaded program that operates only with the operations of capturing and releasing mutexes, we only needed the notation - L (lock) and U (unlock).  It is time to expand our transition model with new operations: <br><ul><li>  W (wait, waiting) - puts the subject (stream) that caused this operation into the state of waiting for a signal from the corresponding signal variable.  For the same signal variable, there may be an unlimited number of pending flows. </li><li>  E (emit, send) - sends a single signal on the signal variable.  A signal can only be received by one of the threads waiting for it, regardless of the total number of waiting, it does not matter which thread performed the emit operation. </li><li>  B (broadcast, broadcast) - sends a signal to all streams waiting for a signal on the corresponding signal variable, and it does not matter which stream performed the broadcast operation. </li></ul><br>  The streams that receive the signal wake up and continue their execution further along the chain.  If at the moment of sending the signal there is no waiting consumer stream, then the signal is simply ignored, and the fact that the signal was sent is not remembered.  Therefore, if any thread performs the operation W, then it will be transferred to the waiting state until a new signal is sent. <br><br>  It is possible to draw an analogy with the previously considered operations L and U. Operation W has common features with the operation of capturing mutex L, except that L blocks the flow only in case of an attempt to re-capture the already captured mutex, and W blocks the flow always.  Operations E and B have common features with the release operation of the mutex U. Thus, the signal variable can be represented as a normal mutex, except that the capture operation is performed by one thread and the release by another. <br><br>  Note that in practice, the signal variable is often used in conjunction with a mutex (for example, in the libpthread library).  When building a model, we will assume that the mutex, which is inextricably linked with the use of the signal variable, is taken into account in the logic of the execution of operations W, E and B. <br><br><h4>  Where is the danger? </h4><br>  A signaling variable can cause a deadlock in one of two cases. <br><br>  <b>The signaling variable causes the occurrence of interlocking of the 1st kind</b> if the Kth thread waits for a signal on the Ith signaling variable, while the Kth thread has captured a mutex, which (directly or indirectly) blocks sending the signal for the Ith variable condition on the part of other subjects (Figure 1). <br><br>  <b>A signal variable causes a 2nd kind of interlock to occur</b> if the K-th stream waits for a signal at the I-th signal variable, and streams that can send this signal wait for a signal at the J-th signal variable that K should send th stream (Figure 2). <br><br><img src="https://habrastorage.org/storage2/bc5/892/064/bc58920647dffce9ed8dd697f8d250f4.png"><br>  Figure 2 - Interlocking of the 2nd kind with the participation of a signal variable. <br><br><h4>  Two rules for safe use of signal variables </h4><br>  According to the already established tradition, we formulate two rules that will avoid the situations described above. <br><br><h5>  Rule 1 </h5><br>  A signal variable cannot cause a 2nd kind of interlock to occur if each stream that is a source stream for any signal variable is not a consumer stream for any signal variable. <br><br>  We call <b>a consumer flow</b> for some signal variable a flow in the execution chain of which there is at least one operation W waiting for a signal for this signal variable. <br><br>  Let us call <b>a source stream</b> for some condition variable a stream in the execution chain of which there is at least one operation E or B sending a signal on this signal variable. <br><br><h5>  Rule 2 </h5><br>  Frankly, I had some difficulty in formulating the second rule, because  In our studies, it contained concepts and definitions that I did not introduce for the sake of simplicity in this post.  Here's what happened: <br><br>  The signal variable cannot cause a mutual blocking of the 1st kind of multi-threaded program that complies with the <a href="http://habrahabr.ru/company/nordavind/blog/176541/">rules of safe use of mutexes</a> , if with any dynamics of any execution variant of each thread where a signal from a certain signal variable is expected, all the mtexts captured by this thread by the time of access to this signal variable is not related by the order of "more" with any mutex at least one stream that sends the signal for this signal variable. <br><br>  This, in essence, means that until the moment our thread ‚Äúfell asleep‚Äù on the W call, it did not capture any mutexes that may be required to send E or B to ‚Äúwake up‚Äù. <br><br><h4>  Expansion of a scope </h4><br>  In conclusion, let me draw your attention to the fact that it is not necessary to perceive a signal variable solely as a kind of language primitive, for example, pthread_cond (the libpthread library).  A signal variable is a functional design that allows you to organize the waiting in one thread for the fulfillment of a condition by another thread. <br><br>  An important special case of such a functional structure is to call wait (or join) to wait for the completion of another thread.  This wait is often a member of the mutual blocking chain, but if this synchronization primitive is excluded from consideration, it is simply impossible to cure such a lock.  This must be taken into account when building the transition model of your multi-threaded program! <br><br><h4>  Soon "on the screen" </h4><br>  Thanks to the respected Habrayusers for their interest in our series of posts about multi-threaded programming.  For me, this is another confirmation of the relevance of the problem and the importance of our research.  It gives strength to write all new and new articles.  In our plans: <br><ol><li>  Consideration of issues of ‚Äúdynamic locks‚Äù using ‚Äúsoft synchronization tools‚Äù (non-blocking attempt to capture a mutex, waiting for a signal on a signal variable with timeout, etc.). </li><li>  Consideration of mathematical foundations and evidence of theses presented in previous articles. </li><li>  Consideration of alternative models of multi-threaded programs, in addition to the "transition model", for example, automata or Petri nets. </li></ol><br>  And much more, if it will still be interesting for Habr's audience.  Thank you for your attention and interest!  Program safely! </div><p>Source: <a href="https://habr.com/ru/post/178623/">https://habr.com/ru/post/178623/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../178611/index.html">Mobile web development: gestures, frameworks, numbers</a></li>
<li><a href="../178613/index.html">How do Google's robots "see" the world?</a></li>
<li><a href="../178615/index.html">SubRip Subtitle Extension (.srt)</a></li>
<li><a href="../178617/index.html">Published program of the conference Google I / O 2013</a></li>
<li><a href="../178621/index.html">The new MIT design allows you to "overlay" the interface on the objects of the real world</a></li>
<li><a href="../178625/index.html">IT Brunch Free Online Conferencing Platform - ".NET brunch" May 18</a></li>
<li><a href="../178629/index.html">Let's make "Roscosmos" a little kinder</a></li>
<li><a href="../178633/index.html">6 buttons</a></li>
<li><a href="../178635/index.html">Valve has released Portal for Linux</a></li>
<li><a href="../178637/index.html">Correcting memory leaks in the Python application</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>