<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We make video conferences in the browser in 10 minutes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Video conferencing via Skype has long taken its place in daily communications, users appreciate the convenience of this communication format and more ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We make video conferences in the browser in 10 minutes</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/752/a06/7e1/752a067e191646eb982f1b92ea4cab5b.jpg" align="left">  Video conferencing via Skype has long taken its place in daily communications, users appreciate the convenience of this communication format and more and more companies are trying to hold meetings in this format.  But Skype has a big disadvantage: it is a separate application that is difficult to integrate into another service.  And there are a lot of services where you can embed video conferencing with benefit, starting from business automation systems and ending with services for group learning a foreign language.  Today I will show you how to build a video conferencing engine that works directly from the browser on webRTC and allows you to connect to the conference from regular phones in 10 minutes with the help of available tools and voximplant. <br><br><a name="habracut"></a><br><br>  Voximplant uses user profiles that can be created using the HTTP API.  To demonstrate the video conference, we made a small application that, at the url-invitation, requests the name of the participant, creates a user profile and returns the authentication parameters <a href="https://github.com/voximplant">https://github.com/voximplant</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Unlike sound, voximplant transfers video between participants, peer-to-peer, which corresponds to the mechanics of webRTC.  To organize a conference, participants need to make video connections to each other - this will work well for up to ten users, which, with a margin, covers most of the work scenarios.  And the sound will be automatically mixed with standard voximplant mechanisms.  For correct sound mixing, we will create two internal conferences: # 1 for video calls and # 2 for participants from regular phones: <br><br><img src="https://habrastorage.org/files/761/e6b/733/761e6b7332a746a18efbe0eca006f405.png"><br><br>  Red arrows show audio and video streams between conference participants in the browser, and blue arrows show audio streams for participants from phones.  One of the advantages of voximplant is the flexibility to work with different streams on the cloud side, which allows you to create a variety of solutions. <br><br>  To get started, register with voximplant.com and create a new application called ‚Äúvideoconf‚Äù. <br><br>  Then in the settings of this application we will create the first, simplest scenario.  It will be responsible for sending p2p audio / video between web clients and is called ‚ÄúVideoConferenceP2P‚Äù: <br><br><div class="spoiler">  <b class="spoiler_title">code</b> <div class="spoiler_text"><pre><code class="javascript hljs">VoxEngine.forwardCallToUserDirect();</code> </pre> <br></div></div><br><br>  The next scenario in telephony is called ‚Äúgatekeeper‚Äù - it processes the call from the web client and then redirects it to the conference with the corresponding conferenceID received from the webSDK, plus provides for sending text messages between the conference and the client to notify about the connection of new participants.  Let's call this script ‚ÄúVideoConferenceGatekeeper‚Äù: <br><br><div class="spoiler">  <b class="spoiler_title">code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Video Conference Gatekeeper * Handle inbound calls and route them to the conference */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> call, conferenceId, conf; <span class="hljs-comment"><span class="hljs-comment">/** * Inbound call handler */</span></span> VoxEngine.addEventListener(AppEvents.CallAlerting, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Get conference id from headers conferenceId = e.headers['X-Conference-Id']; Logger.write('User '+e.callerid+' is joining conference '+conferenceId); call = e.call; /** * Play some audio till call connected event */ call.startEarlyMedia(); call.startPlayback("http://cdn.voximplant.com/bb_remix.mp3", true); /** * Add event listeners */ call.addEventListener(CallEvents.Connected, sdkCallConnected); call.addEventListener(CallEvents.Disconnected, function (e) { VoxEngine.terminate(); }); call.addEventListener(CallEvents.Failed, function (e) { VoxEngine.terminate(); }); call.addEventListener(CallEvents.MessageReceived, function(e) { Logger.write("Message Received: "+e.text); try { var msg = JSON.parse(e.text); } catch(err) { Logger.write(err); } if (msg.type == "ICE_FAILED") { conf.sendMessage(e.text); } else if (msg.type == "CALL_PARTICIPANT") { conf.sendMessage(e.text); } }); // Answer the call call.answer(); }); /** * Connected handler */ function sdkCallConnected(e) { // Stop playing audio call.stopPlayback(); Logger.write('Joining conference'); // Call conference with specified id conf = VoxEngine.callConference('conf_'+conferenceId, call.callerid(), call.displayName(), {"X-ClientType": "web"}); Logger.write('CallerID: '+call.callerid()+' DisplayName: '+call.displayName()); // Add event listeners conf.addEventListener(CallEvents.Connected, function (e) { Logger.write("VideoConference Connected"); VoxEngine.sendMediaBetween(conf, call); }); conf.addEventListener(CallEvents.Disconnected, VoxEngine.terminate); conf.addEventListener(CallEvents.Failed, VoxEngine.terminate); conf.addEventListener(CallEvents.MessageReceived, function(e) { call.sendMessage(e.text); }); }</span></span></code> </pre><br></div></div><br><br>  The next scenario is for incoming calls from ordinary phones to the conference phone number, which can be rented in a couple of clicks through the voximplant interface.  After the connection, the voice synthesizer prompts the caller to enter the conference ID and makes the connection.  Let's call this script ‚ÄúVideoConferencePSTNgatekeeper‚Äù: <br><br><div class="spoiler">  <b class="spoiler_title">code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pin = <span class="hljs-string"><span class="hljs-string">""</span></span>, call; VoxEngine.addEventListener(AppEvents.CallAlerting, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ call = e.call; e.call.addEventListener(CallEvents.Connected, handleCallConnected); e.call.addEventListener(CallEvents.Disconnected, handleCallDisconnected); e.call.answer(); }); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleCallConnected</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ e.call.say(<span class="hljs-string"><span class="hljs-string">"Hello, please enter your conference pin using keypad and press pound key to join the conference."</span></span>, Language.UK_ENGLISH_FEMALE); e.call.addEventListener(CallEvents.ToneReceived, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ e.call.stopPlayback(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.tone == <span class="hljs-string"><span class="hljs-string">"#"</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// Try to call conference according the specified pin var conf = VoxEngine.callConference('conf_'+pin, e.call.callerid(), e.call.displayName(), {"X-ClientType": "pstn_inbound"}); conf.addEventListener(CallEvents.Connected, handleConfConnected); conf.addEventListener(CallEvents.Failed, handleConfFailed); } else { pin += e.tone; } }); e.call.handleTones(true); } function handleConfConnected(e) { VoxEngine.sendMediaBetween(e.call, call); } function handleConfFailed(e) { VoxEngine.terminate(); } function handleCallDisconnected(e) { VoxEngine.terminate(); }</span></span></code> </pre><br></div></div><br><br>  The latest and largest scenario is responsible for creating two conferences, connecting and disconnecting participants, manages audio streams and removes disconnected user profiles that are no longer needed.  Let's call this script ‚ÄúVideoConference‚Äù, if you copy the code from the example - do not forget to substitute your values ‚Äã‚Äã‚Äúaccount_name‚Äù and ‚Äúapi_key‚Äù: <br><br><div class="spoiler">  <b class="spoiler_title">code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Require Conference module to get conferencing functionality */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(Modules.Conference); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> videoconf, pstnconf, calls = [], pstnCalls = [], clientType, <span class="hljs-comment"><span class="hljs-comment">/** * HTTP API Access Info for user auto delete */</span></span> apiURL = <span class="hljs-string"><span class="hljs-string">"https://api.voximplant.com/platform_api"</span></span>, account_name = <span class="hljs-string"><span class="hljs-string">"your_voximplant_account_name"</span></span>, api_key = <span class="hljs-string"><span class="hljs-string">"your_voximplant_api_key"</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Add event handler for session start event VoxEngine.addEventListener(AppEvents.Started, handleConferenceStarted); function handleConferenceStarted(e) { // Create 2 conferences right after session to manage audio in the right way videoconf = VoxEngine.createConference(); pstnconf = VoxEngine.createConference(); } /** * Handle inbound call */ VoxEngine.addEventListener(AppEvents.CallAlerting, function (e) { // get caller's client type clientType = e.headers["X-ClientType"]; // Add event handlers depending on the client type if (clientType == "web") { e.call.addEventListener(CallEvents.Connected, handleParticipantConnected); e.call.addEventListener(CallEvents.Disconnected, handleParticipantDisconnected); } else { pstnCalls.push(e.call); e.call.addEventListener(CallEvents.Connected, handlePSTNParticipantConnected); e.call.addEventListener(CallEvents.Disconnected, handlePSTNParticipantDisconnected); } e.call.addEventListener(CallEvents.Failed, handleConnectionFailed); e.call.addEventListener(CallEvents.MessageReceived, handleMessageReceived); // Answer the call e.call.answer(); }); /** * Message handler */ function handleMessageReceived(e) { Logger.write("Message Recevied: " + e.text); try { var msg = JSON.parse(e.text); } catch (err) { Logger.write(err); } if (msg.type == "ICE_FAILED") { // P2P call failed because of ICE problems - sending notification to retry var caller = msg.caller.substr(0, msg.caller.indexOf('@')); caller = caller.replace("sip:", ""); Logger.write("Sending notification to " + caller); var call = getCallById(caller); if (call != null) call.sendMessage(JSON.stringify({ type: "ICE_FAILED", callee: msg.callee, displayName: msg.displayName })); } else if (msg.type == "CALL_PARTICIPANT") { // Conference participant decided to add PSTN participant (outbound call) for (var k = 0; k &lt; calls.length; k++) calls[k].sendMessage(e.text); Logger.write("Calling participant with number " + msg.number); var call = VoxEngine.callPSTN(msg.number); pstnCalls.push(call); call.addEventListener(CallEvents.Connected, handleOutboundCallConnected); call.addEventListener(CallEvents.Disconnected, handleOutboundCallDisconnected); call.addEventListener(CallEvents.Failed, handleOutboundCallFailed); } } /** * PSTN participant connected */ function handleOutboundCallConnected(e) { e.call.say("You have joined a conference", Language.UK_ENGLISH_FEMALE); e.call.addEventListener(CallEvents.PlaybackFinished, function (e) { for (var k = 0; k &lt; calls.length; k++) calls[k].sendMessage(JSON.stringify({ type: "CALL_PARTICIPANT_CONNECTED", number: e.call.number() })); VoxEngine.sendMediaBetween(e.call, pstnconf); e.call.sendMediaTo(videoconf); }); } /** * PSTN participant disconnected */ function handleOutboundCallDisconnected(e) { Logger.write("PSTN participant disconnected " + e.call.number()); removePSTNparticipant(e.call); for (var k = 0; k &lt; calls.length; k++) calls[k].sendMessage(JSON.stringify({ type: "CALL_PARTICIPANT_DISCONNECTED", number: e.call.number() })); } /** * Call to PSTN participant failed */ function handleOutboundCallFailed(e) { Logger.write("Call to PSTN participant " + e.call.number() + " failed"); removePSTNparticipant(e.call); for (var k = 0; k &lt; calls.length; k++) calls[k].sendMessage(JSON.stringify({ type: "CALL_PARTICIPANT_FAILED", number: e.call.number() })); } function removePSTNparticipant(call) { for (var i = 0; i &lt; pstnCalls.length; i++) { if (pstnCalls[i].number() == call.number()) { Logger.write("Caller with number " + call.number() + " disconnected"); pstnCalls.splice(i, 1); } } } function handleConnectionFailed(e) { Logger.write("Participant couldn't join the conference"); } function participantExists(callerid) { for (var i = 0; i &lt; calls.length; i++) { if (calls[i].callerid() == callerid) return true; } return false; } function getCallById(callerid) { for (var i = 0; i &lt; calls.length; i++) { if (calls[i].callerid() == callerid) return calls[i]; } return null; } /** * Web client connected */ function handleParticipantConnected(e) { if (!participantExists(e.call.callerid())) calls.push(e.call); e.call.say("You have joined the conference.", Language.UK_ENGLISH_FEMALE); e.call.addEventListener(CallEvents.PlaybackFinished, function (e) { videoconf.sendMediaTo(e.call); e.call.sendMediaTo(pstnconf); sendCallsInfo(); }); } function sendCallsInfo() { var info = { peers: [], pstnCalls: [] }; for (var k = 0; k &lt; calls.length; k++) { info.peers.push({ callerid: calls[k].callerid(), displayName: calls[k].displayName() }); } for (k = 0; k &lt; pstnCalls.length; k++) { info.pstnCalls.push({ callerid: pstnCalls[k].number() }); } for (var k = 0; k &lt; calls.length; k++) { calls[k].sendMessage(JSON.stringify(info)); } } /** * Inbound PSTN call connected */ function handlePSTNParticipantConnected(e) { e.call.say("You have joined the conference .", Language.UK_ENGLISH_FEMALE); e.call.addEventListener(CallEvents.PlaybackFinished, function (e) { VoxEngine.sendMediaBetween(e.call, pstnconf); e.call.sendMediaTo(videoconf); for (var k = 0; k &lt; calls.length; k++) calls[k].sendMessage(JSON.stringify({ type: "CALL_PARTICIPANT_CONNECTED", number: e.call.callerid(), inbound: true })); }); } /** * Web client disconnected */ function handleParticipantDisconnected(e) { Logger.write("Disconnected:"); for (var i = 0; i &lt; calls.length; i++) { if (calls[i].callerid() == e.call.callerid()) { /** * Make HTTP request to delete user via HTTP API */ var url = apiURL + "/DelUser/?account_name=" + account_name + "&amp;api_key=" + api_key + "&amp;user_name=" + e.call.callerid(); Net.httpRequest(url, function (res) { Logger.write("HttpRequest result: " + res.text); }); Logger.write("Caller with id " + e.call.callerid() + " disconnected"); calls.splice(i, 1); } } if (calls.length == 0) VoxEngine.terminate(); } function handlePSTNParticipantDisconnected(e) { removePSTNparticipant(e.call); for (var k = 0; k &lt; calls.length; k++) calls[k].sendMessage(JSON.stringify({ type: "CALL_PARTICIPANT_DISCONNECTED", number: e.call.callerid() })); }</span></span></code> </pre><br></div></div><br><br>  To make the voximplant cloud know when to run which script, the scripts connect to the application using <strong>rules</strong> .  We will need the following rules: <br><ul><li>  <strong>InboundFromPSTN</strong> , in the Pattern we indicate the conference phone number, in the script we indicate ‚ÄúVideoConferencePSTNgatekeeper‚Äù </li><li>  <strong>InboundCall</strong> , in the Pattern we specify the string ‚Äújoinconf‚Äù (this is the number that we will dial from the Web SDK when connecting to the conference), in the script we indicate ‚ÄúVideoConferenceGatekeeper‚Äù </li><li>  <strong>Fwd</strong> , in the Pattern we specify the string ‚Äúconf_ [A-Za-z0-9] +‚Äù, in the script we indicate ‚ÄúVideoConference‚Äù - this rule will be triggered when calling the conference via ‚ÄúcallConference‚Äù. </li><li>  <strong>P2P</strong> , in the Pattern we leave ‚Äú. *‚Äù, In the script we specify </li><li>  ‚ÄúVideoConferenceP2P‚Äù </li></ul><br>  <strong>The order of the rules is important!</strong>  <strong>You can use drag'n'drop to drag (change priority)</strong> . <br><br>  As a result, the settings for the application should look like this: <br><br><img src="https://habrastorage.org/files/f4c/630/801/f4c6308014fb4c54a0374c6a4fbed00a.jpg"><br><br>  This is all you need to configure in the cloud.  The frontend part of the service is done using our web sdk and is quite simple.  After connecting, you need to make a call to ‚Äújoinconf‚Äù and pass in the title ‚Äúconferenceid‚Äù.  When a user becomes a conference participant, in the MessageReceived event, they will receive a list of web clients and you can initiate outgoing peer-to-peer calls using the ‚ÄúP2P‚Äù script to receive videos from those clients that are not yet connected.  To enable P2P mode, a special ‚ÄúX-DirectCall‚Äù header is transmitted in the ‚Äúcall‚Äù method.  Also, the Frontend section places video transmission rectangles on the screen and allows you to invite a participant to make an outgoing call from the conference scenario.  The source code for all scripts and client applications is available on our <a href="https://github.com/voximplant/videoconference">GitHub account.</a> </div><p>Source: <a href="https://habr.com/ru/post/261037/">https://habr.com/ru/post/261037/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../261029/index.html">Tail recursion in C ++ using 64-bit variables - Part 2</a></li>
<li><a href="../26103/index.html">Electric memory on wikis</a></li>
<li><a href="../261031/index.html">Reactive extensions</a></li>
<li><a href="../261033/index.html">Turing's Cathedral: the origin of the digital universe</a></li>
<li><a href="../261035/index.html">MiTM Mobile Contest: How Mobile Phone Broke on PHDays V</a></li>
<li><a href="../261039/index.html">Inside the antivirus for Virusday sites - Part 1</a></li>
<li><a href="../26104/index.html">Why I do not buy an apartment on credit</a></li>
<li><a href="../261041/index.html">Children's camp: Bisectral-Pythagorean triangles, brain reprogramming, radar detector and breaking handcuffs</a></li>
<li><a href="../261043/index.html">D for beginners, part 1</a></li>
<li><a href="../261045/index.html">Is the Internet of Things a Myth or a Reality?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>