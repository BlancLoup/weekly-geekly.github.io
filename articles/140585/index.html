<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>.Net, UTF-16 and regular expressions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Somehow I needed to check if the XML name was correct. What could be easier? We look at the standard , where it is clearly described, with what charac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>.Net, UTF-16 and regular expressions</h1><div class="post__text post__text-html js-mediator-article"> Somehow I needed to check if the XML name was correct.  What could be easier?  We look at the <a href="http://www.w3.org/TR/REC-xml/">standard</a> , where it is clearly described, with what characters the name can begin, and with which - to continue, everything is simple and clear: <br><br> <code>[4] NameStartChar ::= ":" | [AZ] | "_" | [az] | [#xC0-#xD6] | [#xD8-#xF6] | [#xF8-#x2FF] | [#x370-#x37D] | [#x37F-#x1FFF] | [#x200C-#x200D] | [#x2070-#x218F] | [#x2C00-#x2FEF] | [#x3001-#xD7FF] | [#xF900-#xFDCF] | [#xFDF0-#xFFFD] | [#x10000-#xEFFFF] <br> [4a] NameChar ::= NameStartChar | "-" | "." | [0-9] | #xB7 | [#x0300-#x036F] | [#x203F-#x2040] <br> [5] Name ::= NameStartChar (NameChar)* <br></code> <br><br>  Almost ready regular expression, easy file processing Ctrl + H ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">const</font> <font color="#0000ff">string</font> NameStartCharPattern = <font color="#A31515">@"\:|[AZ]|_|[az]|[\u00C0-\u00D6]|[\u00D8-\u00F6]|[\u00F8-\u02FF]|[\u0370-\u037D]|[\u037F-\u1FFF]|[\u200C-\u200D]|[\u2070-\u218F]|[\u2C00-\u2FEF]|[\u3001-\uD7FF]|[\uF900-\uFDCF]|[\uFDF0-\uFFFD]|[\u10000-\uEFFFF]"</font> ; <br> <font color="#0000ff">public</font> <font color="#0000ff">const</font> <font color="#0000ff">string</font> NameCharPattern = NameStartCharPattern + <font color="#A31515">@"|-|\.|[0-9]|\u00B7|[\u0300-\u036F]|[\u203F-\u2040]"</font> ; <br> <font color="#0000ff">public</font> <font color="#0000ff">const</font> <font color="#0000ff">string</font> NamePattern = <font color="#A31515">@"(?:"</font> + NameStartCharPattern + <font color="#A31515">@")(?:"</font> + NameCharPattern + <font color="#A31515">@")*"</font> ;</font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Writing a test ... <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">Assert.That(Regex.Match( <font color="#A31515">"4a"</font> , Patterns.NamePattern), Is.False); <br></font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Clean, simple, understandable ... Fell! <a name="habracut"></a><br><br>  The root of the evil was the last component in the first line: [\ u10000- \ uEFFFF].  He catches all the characters, although he shouldn't ... Stop, how does he catch?  We have the same UTF-16, the character is limited to two bytes? .. Or not limited? .. <br><br>  I had to urgently deal with the elimination of their own illiteracy in the field of encodings, and I present the results of my education in short form here.  If these facts will be familiar to someone for a long time - feel free to skip the next paragraph. <br><br>  It turns out that Unicode has the ability to encode much more than 65,536 characters.  Unicode characters are divided into so-called planes, and each of them has a capacity of 0x10000 characters.  In total, the standard defines them 17. And such a ‚Äúcrooked‚Äù from the programmer‚Äôs point of view, the number here is not for nothing: in fact, we have one plane, which is processed in one way, and 16 - in another.  The first, the so-called base multilanguage plane, also known by the abbreviation BMP, contains the vast majority of all the symbols used today.  When encoding to UTF-16, all characters from it are written in two bytes, in one word, directly corresponding to the character code in them.  In the same plane, a special code range, 0xD800-0xDFFF, is defined.  It contains 2048 values, which are called surrogates.  By themselves, these values ‚Äã‚Äãin UTF-16 cannot be met, only in pairs ‚Äî two words (two bytes each) set the value of the following sixteen panels as follows: 0x10000 is subtracted from the character code, which gives us a clear twenty-bit number.  These 20 bits are written 10 each in the first and second word, thus occupying 2048 dedicated codes.  Moreover, since the first word is written with the prefix 0b110110 (giving the values ‚Äã‚Äã0xD800-0xDBFF, called the high or leading surrogate), and the second 0b110111 (0xDC00-0xDFFF, respectively, the final or low surrogate), this guarantees a unique definition of the purpose of each word outside context dependent. <br><br>  ... So, it would seem to have nothing .Net?  And despite the fact that although it provides tools for working with surrogates, the regular expression engine ignores them.  Ie ignores altogether, working with them as pairs of characters.  As usual in such cases, I was not the first to find this <a href="http://connect.microsoft.com/VisualStudio/feedback/details/357780/extend-regex-to-process-unicode-characters-not-utf-16-code-units">problem</a> .  Again, as usual, the Microsoft verdict is Won't fix. <br><br>  So, you have to somehow live with it.  As suggested in the bugreport to call a third-party engine through PInvoke - from the cannon on sparrows.  The second idea is to throw the hell out of all support for these surrogates was seductive, but I decided not to give up ... And then I suddenly realized that the bug can be used as a feature! <br><br>  The structure of the group that should work with surrogates in our case is very simple - in fact it resolves any characters from the first 14 planes, prohibiting the last two ... Ie, prohibits a certain range of values ‚Äã‚Äãfrom the high surrogate area, and we can replace our expression with the following: <br> <code>[\u10000-\uEFFFF] -&gt; (?:[\uD800-\uDB7F][\uDC00-\uDFFF]) <br></code> <br>  This method is not very universal, and it will be terribly inconvenient to ask them narrower ranges of characters, it seemed to me beautiful, and therefore I decided to share it with you. </div><p>Source: <a href="https://habr.com/ru/post/140585/">https://habr.com/ru/post/140585/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../140579/index.html">Canobuvosti, 136th edition</a></li>
<li><a href="../140580/index.html">GlobalsDB Challenge. 4th run</a></li>
<li><a href="../140581/index.html">Stop writing classes</a></li>
<li><a href="../140582/index.html">IPad 3 disassembly</a></li>
<li><a href="../140583/index.html">New version of GlobalsDB 2012</a></li>
<li><a href="../140586/index.html">Mini-desktop review: Dell Alienware X51</a></li>
<li><a href="../140587/index.html">PTR record vs. Mail.ru</a></li>
<li><a href="../140588/index.html">Batteries charge an hour longer than they seem</a></li>
<li><a href="../140590/index.html">Microsoft StreamInsight - real-time data stream processing</a></li>
<li><a href="../140591/index.html">‚ÄúHow to make money on mobile phones?‚Äù - podcast with Leonid Bugaev and Darya Batukhtina</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>