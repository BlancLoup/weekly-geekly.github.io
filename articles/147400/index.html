<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The secret of excess CMP, or why Volodya shaved his mustache?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous article devoted to the performance analysis of integer multiplication, surprising results were obtained that required interpretation, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The secret of excess CMP, or why Volodya shaved his mustache?</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/storage2/949/415/c11/949415c116aa7a4adc70059f83927505.jpeg">  In the <a href="http://habrahabr.ru/post/147272/">previous article</a> devoted to the performance analysis of integer multiplication, surprising results were obtained that required interpretation, namely, why the speed of code generation in VS2012 significantly (5.5 times) decreases, and this is not the case in VS2010, what is the secret of the fast code? <br><br>  It turns out that it was a matter of using the remarkable ADC command, which is simply necessary when adding (or multiplying) numbers of high capacity.  It allows you to use the transfer flag and eliminates the need for tricky bit manipulations to calculate the transfer in other ways. <br><br>  But compilers do not like the ADC command for some reason, and they do not like it so much that there is no easy way to force the compiler to start using the ADC command together with the Carry flag.  You can, of course, write it in assembler.  But writing fast code manually is an impossible task, it‚Äôs almost impossible to foresee all the details and do something faster than the optimizing compiler.  Another problem is that in Visual Studio C ++ x64 for some reason they abandoned the _asm built-in command, and to use assembler inserts, you need to create a separate ASM file, which you really don't want to do. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In fact, an explicit intrinsic add-with-carry command would be very useful to us, but the Microsoft hard-working compiler creators, <a href="http://connect.microsoft.com/VisualStudio/feedback/details/529176/implement-a-64-bit-add-with-carry-intrinsic">when they were asked about it directly,</a> stated that add-with-carry intrinsic has limited use and therefore in the current compiler not.  Very, very vain. <br><a name="habracut"></a><br>  For example, consider the code on C of adding two numbers of high resolution.  When multiplying, a similar code with the participation of ADC is also found, but in an implicit form. <br><div class="spoiler">  <b class="spoiler_title">We look code on Si</b> <div class="spoiler_text"><pre><code class="hljs swift">#include &lt;stdio.h&gt; typedef unsigned long long <span class="hljs-type"><span class="hljs-type">BN_WORD</span></span>; int <span class="hljs-type"><span class="hljs-type">Add</span></span>(<span class="hljs-type"><span class="hljs-type">BN_WORD</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>[<span class="hljs-number"><span class="hljs-number">8</span></span>], <span class="hljs-type"><span class="hljs-type">BN_WORD</span></span> a[<span class="hljs-number"><span class="hljs-number">8</span></span>], <span class="hljs-type"><span class="hljs-type">BN_WORD</span></span> b[<span class="hljs-number"><span class="hljs-number">8</span></span>]) { <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>] = a[<span class="hljs-number"><span class="hljs-number">0</span></span>] + b[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>[<span class="hljs-number"><span class="hljs-number">1</span></span>] = a[<span class="hljs-number"><span class="hljs-number">1</span></span>] + b[<span class="hljs-number"><span class="hljs-number">1</span></span>] + (<span class="hljs-built_in"><span class="hljs-built_in">c</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>] &lt; a[<span class="hljs-number"><span class="hljs-number">0</span></span>]); <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>] = a[<span class="hljs-number"><span class="hljs-number">2</span></span>] + b[<span class="hljs-number"><span class="hljs-number">2</span></span>] + (<span class="hljs-built_in"><span class="hljs-built_in">c</span></span>[<span class="hljs-number"><span class="hljs-number">1</span></span>] &lt; a[<span class="hljs-number"><span class="hljs-number">1</span></span>]); <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>[<span class="hljs-number"><span class="hljs-number">3</span></span>] = a[<span class="hljs-number"><span class="hljs-number">3</span></span>] + b[<span class="hljs-number"><span class="hljs-number">3</span></span>] + (<span class="hljs-built_in"><span class="hljs-built_in">c</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>] &lt; a[<span class="hljs-number"><span class="hljs-number">2</span></span>]); <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>[<span class="hljs-number"><span class="hljs-number">4</span></span>] = a[<span class="hljs-number"><span class="hljs-number">4</span></span>] + b[<span class="hljs-number"><span class="hljs-number">4</span></span>] + (<span class="hljs-built_in"><span class="hljs-built_in">c</span></span>[<span class="hljs-number"><span class="hljs-number">3</span></span>] &lt; a[<span class="hljs-number"><span class="hljs-number">3</span></span>]); <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>[<span class="hljs-number"><span class="hljs-number">5</span></span>] = a[<span class="hljs-number"><span class="hljs-number">5</span></span>] + b[<span class="hljs-number"><span class="hljs-number">5</span></span>] + (<span class="hljs-built_in"><span class="hljs-built_in">c</span></span>[<span class="hljs-number"><span class="hljs-number">4</span></span>] &lt; a[<span class="hljs-number"><span class="hljs-number">4</span></span>]); <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>[<span class="hljs-number"><span class="hljs-number">6</span></span>] = a[<span class="hljs-number"><span class="hljs-number">6</span></span>] + b[<span class="hljs-number"><span class="hljs-number">6</span></span>] + (<span class="hljs-built_in"><span class="hljs-built_in">c</span></span>[<span class="hljs-number"><span class="hljs-number">5</span></span>] &lt; a[<span class="hljs-number"><span class="hljs-number">5</span></span>]); <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>[<span class="hljs-number"><span class="hljs-number">7</span></span>] = a[<span class="hljs-number"><span class="hljs-number">7</span></span>] + b[<span class="hljs-number"><span class="hljs-number">7</span></span>] + (<span class="hljs-built_in"><span class="hljs-built_in">c</span></span>[<span class="hljs-number"><span class="hljs-number">6</span></span>] &lt; a[<span class="hljs-number"><span class="hljs-number">6</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">c</span></span>[<span class="hljs-number"><span class="hljs-number">7</span></span>] &lt; a[<span class="hljs-number"><span class="hljs-number">7</span></span>]); } int main(void) { int i; <span class="hljs-type"><span class="hljs-type">BN_WORD</span></span> a[<span class="hljs-number"><span class="hljs-number">8</span></span>], b[<span class="hljs-number"><span class="hljs-number">8</span></span>], <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>[<span class="hljs-number"><span class="hljs-number">8</span></span>], <span class="hljs-type"><span class="hljs-type">Carry</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ,   inline    Add   main int (*add)(BN_WORD c[8], BN_WORD a[8], BN_WORD b[8]) = Add; for( i=0; i&lt;8; i++) { a[i] = b[i] = 0x8000000000000000; } Carry = add(c, a, b); //  for( i=0; i&lt;8; ++i) { if (Carry!=1 || c[i]!=(i!=0)) { printf("Something wrong\n"); return 1; } } printf("Ok!\n", Carry); return 0; }</span></span></code> </pre> <br></div></div><br>  This code, after compiling Visual Studio 10.0 SP1, becomes an assembler listing: <br><div class="spoiler">  <b class="spoiler_title">We look code on Asm</b> <div class="spoiler_text"><pre> <code class="hljs cs">?Add@@YAXQEA_K00@Z PROC ; Add, COMDAT ; Line <span class="hljs-number"><span class="hljs-number">6</span></span> $LN3: mov QWORD PTR [rsp+<span class="hljs-number"><span class="hljs-number">8</span></span>], rbx mov QWORD PTR [rsp+<span class="hljs-number"><span class="hljs-number">16</span></span>], rdi ; Line <span class="hljs-number"><span class="hljs-number">7</span></span> mov r10, QWORD PTR [rdx] ; Line <span class="hljs-number"><span class="hljs-number">15</span></span> mov rdi, QWORD PTR [rsp+<span class="hljs-number"><span class="hljs-number">16</span></span>] mov rbx, rdx <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> r10, QWORD PTR [r8] mov r11, r8 mov QWORD PTR [rcx], r10 cmp r10, QWORD PTR [rdx] mov r8, QWORD PTR [r8+<span class="hljs-number"><span class="hljs-number">8</span></span>] adc r8, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> r8, QWORD PTR [rdx+<span class="hljs-number"><span class="hljs-number">8</span></span>] mov QWORD PTR [rcx+<span class="hljs-number"><span class="hljs-number">8</span></span>], r8 cmp r8, QWORD PTR [rdx+<span class="hljs-number"><span class="hljs-number">8</span></span>] mov rdx, QWORD PTR [r11+<span class="hljs-number"><span class="hljs-number">16</span></span>] adc rdx, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rdx, QWORD PTR [rbx+<span class="hljs-number"><span class="hljs-number">16</span></span>] mov QWORD PTR [rcx+<span class="hljs-number"><span class="hljs-number">16</span></span>], rdx cmp rdx, QWORD PTR [rbx+<span class="hljs-number"><span class="hljs-number">16</span></span>] mov rdx, QWORD PTR [r11+<span class="hljs-number"><span class="hljs-number">24</span></span>] adc rdx, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rdx, QWORD PTR [rbx+<span class="hljs-number"><span class="hljs-number">24</span></span>] mov QWORD PTR [rcx+<span class="hljs-number"><span class="hljs-number">24</span></span>], rdx cmp rdx, QWORD PTR [rbx+<span class="hljs-number"><span class="hljs-number">24</span></span>] mov rdx, QWORD PTR [r11+<span class="hljs-number"><span class="hljs-number">32</span></span>] adc rdx, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rdx, QWORD PTR [rbx+<span class="hljs-number"><span class="hljs-number">32</span></span>] mov QWORD PTR [rcx+<span class="hljs-number"><span class="hljs-number">32</span></span>], rdx cmp rdx, QWORD PTR [rbx+<span class="hljs-number"><span class="hljs-number">32</span></span>] mov rdx, QWORD PTR [r11+<span class="hljs-number"><span class="hljs-number">40</span></span>] adc rdx, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rdx, QWORD PTR [rbx+<span class="hljs-number"><span class="hljs-number">40</span></span>] mov QWORD PTR [rcx+<span class="hljs-number"><span class="hljs-number">40</span></span>], rdx cmp rdx, QWORD PTR [rbx+<span class="hljs-number"><span class="hljs-number">40</span></span>] mov rdx, QWORD PTR [r11+<span class="hljs-number"><span class="hljs-number">48</span></span>] adc rdx, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rdx, QWORD PTR [rbx+<span class="hljs-number"><span class="hljs-number">48</span></span>] mov QWORD PTR [rcx+<span class="hljs-number"><span class="hljs-number">48</span></span>], rdx cmp rdx, QWORD PTR [rbx+<span class="hljs-number"><span class="hljs-number">48</span></span>] mov rax, QWORD PTR [rbx+<span class="hljs-number"><span class="hljs-number">56</span></span>] adc rax, QWORD PTR [r11+<span class="hljs-number"><span class="hljs-number">56</span></span>] mov rbx, QWORD PTR [rsp+<span class="hljs-number"><span class="hljs-number">8</span></span>] mov QWORD PTR [rcx+<span class="hljs-number"><span class="hljs-number">56</span></span>], rax ret <span class="hljs-number"><span class="hljs-number">0</span></span> ?Add@@YAXQEA_K00@Z ENDP ; Add _TEXT ENDS</code> </pre><br></div></div><br>  The presence of a repeating set of commands ADD + CMP + ADC is clearly visible, for example: <pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r8</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">QWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rdx+8]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">QWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rcx+8]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r8</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">QWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rdx+8]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rdx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">QWORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[r11+16]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">adc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rdx</span></span>, 0</code> </pre>  But why do we need an extra CMP?  Excess CMP we do not need.  It is used no more than to re-set the Carry flag, which itself has already been previously set by the ADD command and therefore you can safely delete the CMP.  Let's try to take the liberty and shave off the ‚Äúprotruding mustache‚Äù in the form of extra CMPs by directly modifying the binary code in memory and measuring speed again. <br><br>  Modifying the binary code of the program is as follows: <br><ul><li>  First, the parsing is the listing of the Add function, we find all the cmp and their length. </li><li>  Then, right inside the real Add code, we delete all the found cmps, moving the remainder to the place of Cmp until the end of the function, since the code is completely linear, that is, there are no jmp in the code. </li></ul><br><div class="spoiler">  <b class="spoiler_title">We look at the C code that removes the whiskers and measures the execution time.</b> <div class="spoiler_text"><pre> <code class="hljs lua">#include &lt;stdio.h&gt; #include &lt;windows.h&gt; typedef unsigned long long BN_WORD; int Add(BN_WORD c[<span class="hljs-number"><span class="hljs-number">8</span></span>], BN_WORD a[<span class="hljs-number"><span class="hljs-number">8</span></span>], BN_WORD b[<span class="hljs-number"><span class="hljs-number">8</span></span>]) { c[<span class="hljs-number"><span class="hljs-number">0</span></span>] = a[<span class="hljs-number"><span class="hljs-number">0</span></span>] + b[<span class="hljs-number"><span class="hljs-number">0</span></span>]; c[<span class="hljs-number"><span class="hljs-number">1</span></span>] = a[<span class="hljs-number"><span class="hljs-number">1</span></span>] + b[<span class="hljs-number"><span class="hljs-number">1</span></span>] + (c[<span class="hljs-number"><span class="hljs-number">0</span></span>] &lt; a[<span class="hljs-number"><span class="hljs-number">0</span></span>]); c[<span class="hljs-number"><span class="hljs-number">2</span></span>] = a[<span class="hljs-number"><span class="hljs-number">2</span></span>] + b[<span class="hljs-number"><span class="hljs-number">2</span></span>] + (c[<span class="hljs-number"><span class="hljs-number">1</span></span>] &lt; a[<span class="hljs-number"><span class="hljs-number">1</span></span>]); c[<span class="hljs-number"><span class="hljs-number">3</span></span>] = a[<span class="hljs-number"><span class="hljs-number">3</span></span>] + b[<span class="hljs-number"><span class="hljs-number">3</span></span>] + (c[<span class="hljs-number"><span class="hljs-number">2</span></span>] &lt; a[<span class="hljs-number"><span class="hljs-number">2</span></span>]); c[<span class="hljs-number"><span class="hljs-number">4</span></span>] = a[<span class="hljs-number"><span class="hljs-number">4</span></span>] + b[<span class="hljs-number"><span class="hljs-number">4</span></span>] + (c[<span class="hljs-number"><span class="hljs-number">3</span></span>] &lt; a[<span class="hljs-number"><span class="hljs-number">3</span></span>]); c[<span class="hljs-number"><span class="hljs-number">5</span></span>] = a[<span class="hljs-number"><span class="hljs-number">5</span></span>] + b[<span class="hljs-number"><span class="hljs-number">5</span></span>] + (c[<span class="hljs-number"><span class="hljs-number">4</span></span>] &lt; a[<span class="hljs-number"><span class="hljs-number">4</span></span>]); c[<span class="hljs-number"><span class="hljs-number">6</span></span>] = a[<span class="hljs-number"><span class="hljs-number">6</span></span>] + b[<span class="hljs-number"><span class="hljs-number">6</span></span>] + (c[<span class="hljs-number"><span class="hljs-number">5</span></span>] &lt; a[<span class="hljs-number"><span class="hljs-number">5</span></span>]); c[<span class="hljs-number"><span class="hljs-number">7</span></span>] = a[<span class="hljs-number"><span class="hljs-number">7</span></span>] + b[<span class="hljs-number"><span class="hljs-number">7</span></span>] + (c[<span class="hljs-number"><span class="hljs-number">6</span></span>] &lt; a[<span class="hljs-number"><span class="hljs-number">6</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (c[<span class="hljs-number"><span class="hljs-number">7</span></span>] &lt; a[<span class="hljs-number"><span class="hljs-number">7</span></span>]); } void ReadMem(__int64 pos, <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *patch, int <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>) { DWORD my_id = GetCurrentProcessId(); HANDLE p_hand = OpenProcess(PROCESS_VM_READ | PROCESS_VM_OPERATION, NULL, my_id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ReadProcessMemory(p_hand, (LPDWORD)pos, patch, <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>, NULL)==<span class="hljs-number"><span class="hljs-number">0</span></span>) { printf(<span class="hljs-string"><span class="hljs-string">"Error %d read from memory\n"</span></span>, GetLastError()); } CloseHandle(p_hand); } void WriteMem(__int64 pos, <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *patch, int <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>) { DWORD my_id = GetCurrentProcessId(); HANDLE p_hand = OpenProcess(PROCESS_VM_WRITE | PROCESS_VM_OPERATION, NULL, my_id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (WriteProcessMemory(p_hand, (LPDWORD)pos, patch, <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>, NULL)==<span class="hljs-number"><span class="hljs-number">0</span></span>) { printf(<span class="hljs-string"><span class="hljs-string">"Error %d write to memory\n"</span></span>, GetLastError()); } CloseHandle(p_hand); } void udalit_usi(int pos, int size, int full_size) { <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *mem = (<span class="hljs-built_in"><span class="hljs-built_in">char</span></span>*)malloc(full_size-pos); __int64 pos_add = (__int64)Add; //       ReadMem(pos_add + pos, mem, full_size-pos); // ,    ,   size WriteMem(pos_add + pos, mem+size, full_size-pos-size); free(mem); } <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *add_listing = <span class="hljs-string"><span class="hljs-string">" 00000000 ?Add@@YAHQEA_K00@Z PROC ; Add, COMDAT\n"</span></span> <span class="hljs-string"><span class="hljs-string">" ; Line 7\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000000 $LN3:\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000000 48/ 89 5C 24 mov QWORD PTR [rsp+8], rbx\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 08\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000005 48/ 89 7C 24 mov QWORD PTR [rsp+16], rdi\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 10\n"</span></span> <span class="hljs-string"><span class="hljs-string">" ; Line 8\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 0000000A 4C/ 8B 12 mov r10, QWORD PTR [rdx]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" ; Line 17\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 0000000D 48/ 8B 5C 24 mov rbx, QWORD PTR [rsp+8]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 08\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000012 48/ 8B FA mov rdi, rdx\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000015 4D/ 03 10 add r10, QWORD PTR [r8]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000018 4D/ 8B D8 mov r11, r8\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 0000001B 4C/ 89 11 mov QWORD PTR [rcx], r10\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 0000001E 4C/ 3B 12 cmp r10, QWORD PTR [rdx]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000021 4D/ 8B 40 08 mov r8, QWORD PTR [r8+8]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000025 49/ 83 D0 00 adc r8, 0\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000029 4C/ 03 42 08 add r8, QWORD PTR [rdx+8]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 0000002D 4C/ 89 41 08 mov QWORD PTR [rcx+8], r8\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000031 4C/ 3B 42 08 cmp r8, QWORD PTR [rdx+8]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000035 49/ 8B 53 10 mov rdx, QWORD PTR [r11+16]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000039 48/ 83 D2 00 adc rdx, 0\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 0000003D 48/ 03 57 10 add rdx, QWORD PTR [rdi+16]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000041 48/ 89 51 10 mov QWORD PTR [rcx+16], rdx\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000045 48/ 3B 57 10 cmp rdx, QWORD PTR [rdi+16]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000049 49/ 8B 53 18 mov rdx, QWORD PTR [r11+24]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 0000004D 48/ 83 D2 00 adc rdx, 0\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000051 48/ 03 57 18 add rdx, QWORD PTR [rdi+24]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000055 48/ 89 51 18 mov QWORD PTR [rcx+24], rdx\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000059 48/ 3B 57 18 cmp rdx, QWORD PTR [rdi+24]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 0000005D 49/ 8B 53 20 mov rdx, QWORD PTR [r11+32]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000061 48/ 83 D2 00 adc rdx, 0\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000065 48/ 03 57 20 add rdx, QWORD PTR [rdi+32]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000069 48/ 89 51 20 mov QWORD PTR [rcx+32], rdx\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 0000006D 48/ 3B 57 20 cmp rdx, QWORD PTR [rdi+32]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000071 49/ 8B 53 28 mov rdx, QWORD PTR [r11+40]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000075 48/ 83 D2 00 adc rdx, 0\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000079 48/ 03 57 28 add rdx, QWORD PTR [rdi+40]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 0000007D 48/ 89 51 28 mov QWORD PTR [rcx+40], rdx\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000081 48/ 3B 57 28 cmp rdx, QWORD PTR [rdi+40]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000085 49/ 8B 53 30 mov rdx, QWORD PTR [r11+48]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000089 48/ 83 D2 00 adc rdx, 0\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 0000008D 48/ 03 57 30 add rdx, QWORD PTR [rdi+48]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000091 48/ 89 51 30 mov QWORD PTR [rcx+48], rdx\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000095 48/ 3B 57 30 cmp rdx, QWORD PTR [rdi+48]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 00000099 49/ 8B 53 38 mov rdx, QWORD PTR [r11+56]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 0000009D 48/ 83 D2 00 adc rdx, 0\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 000000A1 33 C0 xor eax, eax\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 000000A3 48/ 03 57 38 add rdx, QWORD PTR [rdi+56]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 000000A7 48/ 89 51 38 mov QWORD PTR [rcx+56], rdx\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 000000AB 48/ 3B 57 38 cmp rdx, QWORD PTR [rdi+56]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 000000AF 48/ 8B 7C 24 mov rdi, QWORD PTR [rsp+16]\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 10\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 000000B4 0F 92 C0 setb al\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 000000B7 C3 ret 0\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 000000B8 ?Add@@YAHQEA_K00@Z ENDP ; Add\n"</span></span> <span class="hljs-string"><span class="hljs-string">" 000000B8 _TEXT ENDS\n"</span></span>; int full_size_add_listing = <span class="hljs-number"><span class="hljs-number">0x000000B8</span></span>; #define MAX_USI <span class="hljs-number"><span class="hljs-number">100</span></span> int usi_pos[MAX_USI]; int usi_len[MAX_USI]; int kol_usi; void sbrivaem_usi(void) { <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *p; int i, j; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( kol_usi=<span class="hljs-number"><span class="hljs-number">0</span></span>, p=add_listing;;) //   { // cmp p = strstr(p, <span class="hljs-string"><span class="hljs-string">"cmp"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p==NULL) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(;;p<span class="hljs-comment"><span class="hljs-comment">--) //   2  { if (p[0]==' ' &amp;&amp; p[1]==' ') break; } p-=2; //   sscanf(p, "%x", &amp;(usi_pos[kol_usi])); p+=4; for(i=0;;i++) { if (p[0]&lt;0x20) break; p+=2; if (p[0]=='/') p++; if (p[0]==' ') p++; } usi_len[kol_usi]=i; kol_usi++; if (kol_usi&gt;=MAX_USI) { printf("too much"); exit(0); } p = strstr(p, "cmp"); //   cmp p++; // } //     for( i=kol_usi-1; i&gt;=0; --i) { udalit_usi(usi_pos[i], usi_len[i], full_size_add_listing); full_size_add_listing -= usi_len[i]; } } int main(void) { LARGE_INTEGER lFrequency, lStart, lEnd; double dfTime1; int i, j, k, usi; BN_WORD a[8], b[8], c[8], Carry; // ,   inline    Add   main int (*add)(BN_WORD c[8], BN_WORD a[8], BN_WORD b[8]) = Add; for( i=0; i&lt;8; i++) { a[i] = b[i] = 0x8000000000000000; } for( usi=0; usi&lt;=1; ++usi) { QueryPerformanceFrequency(&amp;lFrequency); QueryPerformanceCounter(&amp;lStart); for( i=0; i&lt;1000; ++i) { for( j=0; j&lt;1000000; ++j) { Carry = add(c, a, b); } for( k=0; k&lt;8; ++k) { if (Carry!=1 || c[k]!=(k!=0)) { printf("Something wrong\n"); return 1; } } } QueryPerformanceCounter(&amp;lEnd); dfTime1 = (double)(lEnd.QuadPart - lStart.QuadPart) / (double)lFrequency.QuadPart; if (usi==0) { //    printf("Time = %g sec\n", dfTime1); //     sbrivaem_usi(); } else { //    printf("Time(without cmp) = %g sec\n", dfTime1); } } return 0; }</span></span></code> </pre> <br></div></div><br>  You need to compile on Visual Studio 2010 SP1 with the -O2 optimization option enabled and do not forget the x64 settings: <br><pre> <code class="hljs tex">call "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Program</span></span></span></span> Files (x86)<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Microsoft</span></span></span></span> Visual Studio 10.0<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VC</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">vcvarsall</span></span></span></span>.bat" amd64 cl.exe -O2 /Faadd_with_carry.asm add_with_carry.cpp</code> </pre><br>  Total work time: <br>  Time = 7.07075 sec <br>  Time (without cmp) = 5.36317 sec <br><br>  It turned out well, is not it?  Almost 30% faster. </div><p>Source: <a href="https://habr.com/ru/post/147400/">https://habr.com/ru/post/147400/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../147391/index.html">Droider Show # 48. iPad Mini and Droider OS</a></li>
<li><a href="../147393/index.html">Using the RS485 interface and saving legs</a></li>
<li><a href="../147396/index.html">Facebook to lay underwater cable in Asia</a></li>
<li><a href="../147398/index.html">Samsung Smart TV and Windows Azure</a></li>
<li><a href="../147399/index.html">The concept of a cloud service, which remained a concept</a></li>
<li><a href="../147401/index.html">PVS-Studio: reviews</a></li>
<li><a href="../147402/index.html">Tracks Flow: goals, objectives, principles</a></li>
<li><a href="../147404/index.html">Porting Qt Quick Components to S60 5th edition</a></li>
<li><a href="../147408/index.html">Some poorly known rules of thumb</a></li>
<li><a href="../147409/index.html">Samsung Galaxy S III Review</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>