<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PVS-Studio rummaged in the FreeBSD kernel</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="About a year ago we were able to test the Linux kernel. It was one of the most talked about checking open source projects of all time. Proposals to pa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PVS-Studio rummaged in the FreeBSD kernel</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/559/511/580/559511580dacd6797ab8cb144e60cb88.png" align="left">  About a year ago we were able to test the Linux kernel.  It was one of the most talked about checking open source projects of all time.  Proposals to pay attention to FreeBSD were then actively received, but only now enough time has come to do it. <br><a name="habracut"></a><br><h2>  About the checked project </h2><br>  <a href="https://www.freebsd.org/">FreeBSD</a> is a modern operating system for servers, desktops, and embedded computer platforms.  Its code has gone through more than thirty years of continuous development, improvement and optimization.  It has proven itself as a system for building intranets and Internet networks and servers.  It provides reliable network services and efficient memory management. <br><br>  Despite the fact that <a href="https://scan.coverity.com/projects/freebsd">Coverity</a> regularly <a href="https://scan.coverity.com/projects/freebsd">checks</a> FreeBSD, I don‚Äôt regret that I worked with this project because  I found a lot of suspicious places.  In the article about 40 of them will be presented, and for developers (who received a verification report even before writing this article) I prepared a list of ~ 1000 serious analyzer warnings. <br><br>  In my opinion, many of the places issued by the analyzer warnings are real errors, but I can‚Äôt say anything about criticality, because  I am not an operating system developer.  I think this is a good occasion for discussions and communication with the authors of the project. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The source code for verification was taken from <a href="https://github.com/freebsd/freebsd">GitHub</a> from the 'master' branch.  The repository contains ~ 23000 files and two dozen configurations for building for different platforms, but I checked only the kernel, which I put together like this: <br><br><pre><code class="bash hljs">make buildkernel KERNCONF=MYKERNEL</code> </pre> <br><h2>  How did you check </h2><br>  To check the kernel, we used the <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> static code analyzer version 6.01. <br><br>  For convenience, I installed PC-BSD and wrote a small C ++ utility that preserved the working environment of compiler launches during the kernel build.  The information obtained was used to obtain <a href="http://www.viva64.com/ru/t/0076/">preprocessed files</a> and analyze them using PVS-Studio.  This method allowed me to quickly check the project without studying the assembly system unfamiliar to me to integrate the analyzer.  And checking preprocessed files allows you to make a deeper analysis of the code and find more complex and interesting errors, for example, in macros.  The article will provide several such examples. <br><br>  The Linux kernel was tested in the same way, and for Windows users, this verification mode is available in the <a href="http://www.viva64.com/ru/b/0243/">Standalone</a> utility included in the PVS-Studio distribution.  But for developers who want to integrate the analyzer into their project, usually there are no problems with this.  They use some kind of integration described in the documentation.  The advantage of monitoring utilities is that they allow you to quickly try the analyzer if the project has a non-standard assembly system. <br><br><h2>  Unusual luck </h2><br>  I found the first possible error even before starting the analyzer, even before I assembled the kernel, because the link was interrupted by the link.  Moving to the file specified in the error, I saw the following: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/29b/a4c/62b/29ba4c62bf7f55b47d7a97202eae7850.png"></div><br><br>  Pay attention to the selection.  For formatting indents, the tab character is used and two operators have been moved under the condition.  But the last statement is not really related to the condition and will always be executed.  Perhaps you forgot to add braces here. <br><br>  One article had a comment that we simply rewrite analyzer warnings, but this is not the case.  Before checking the project, you need to make sure that it is compiled correctly, and after receiving the report, the analyzer‚Äôs warnings must be examined / disassembled and explained to the reader.  Exactly the same work is done by the analyzer user support team, responding to emails.  It is not uncommon for users to send examples of false positives, in their opinion, but in reality this turns out to be the most real mistake. <br><br><h2>  Capy-poste and ochepyatki </h2><br>  The PVS-Studio analyzer is a powerful static analysis tool that finds a variety of errors in the code, but the first diagnostics were simple and made to find the most common errors associated with typos and copy-paste programming.  When viewing the analyzer report, I sort it by error code and usually begin my story with this type of diagnostic rules. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f09/09f/a10/f0909fa10b3c37f41d9180f9fdd784fe.png"></div><br><br>  <a href="http://www.viva64.com/ru/d/0090/">V501</a> There are identical sub-expressions '(uintptr_t) b-&gt; handler' to the left.  ip_fw_sockopt.c 2893 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compare_sh</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *_a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *_b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ipfw_sopt_handler</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">, *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b</span></span></span><span class="hljs-class">;</span></span> a = (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> struct ipfw_sopt_handler *)_a; b = (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> struct ipfw_sopt_handler *)_b; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>)a-&gt;handler &lt; (<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>)b-&gt;handler) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-number"><span class="hljs-number">-1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>)b-&gt;handler &gt; (<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>)b-&gt;handler) <span class="hljs-comment"><span class="hljs-comment">// &lt;= return (1); return (0); }</span></span></code> </pre> <br>  A small example of how harmful it is to call variables short and uninformative.  Now, because of a typo in the letter 'b', part of the condition will never be fulfilled.  Thus, the function returns a null status not always as intended. <br><br>  <a href="http://www.viva64.com/ru/d/0090/">V501</a> There are identical sub-expressions to the left and the right! ‚Äù= 'Operator: m-&gt; m_pkthdr.len! = M-&gt; m_pkthdr.len key.c 7208 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">key_parse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct mbuf *m, struct socket *so)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((m-&gt;m_flags &amp; M_PKTHDR) == <span class="hljs-number"><span class="hljs-number">0</span></span> || m-&gt;m_pkthdr.len != m-&gt;m_pkthdr.len) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... goto senderror; } .... }</span></span></code> </pre> <br>  One of the structure fields is compared with itself, therefore, the result of this logical operation will always be equal to False. <br><br>  <a href="http://www.viva64.com/ru/d/0090/">V501</a> There are identical sub-expressions to the left and to the right of the '|'  operator: PIM_NOBUSRESET |  PIM_NOBUSRESET sbp_targ.c 1327 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> { PIM_EXTLUNS = <span class="hljs-number"><span class="hljs-number">0x100</span></span>, PIM_SCANHILO = <span class="hljs-number"><span class="hljs-number">0x80</span></span>, PIM_NOREMOVE = <span class="hljs-number"><span class="hljs-number">0x40</span></span>, PIM_NOINITIATOR = <span class="hljs-number"><span class="hljs-number">0x20</span></span>, PIM_NOBUSRESET = <span class="hljs-number"><span class="hljs-number">0x10</span></span>, <span class="hljs-comment"><span class="hljs-comment">// &lt;= PIM_NO_6_BYTE = 0x08, PIM_SEQSCAN = 0x04, PIM_UNMAPPED = 0x02, PIM_NOSCAN = 0x01 } pi_miscflag; static void sbp_targ_action1(struct cam_sim *sim, union ccb *ccb) { .... struct ccb_pathinq *cpi = &amp;ccb-&gt;cpi; cpi-&gt;version_num = 1; /* XXX??? */ cpi-&gt;hba_inquiry = PI_TAG_ABLE; cpi-&gt;target_sprt = PIT_PROCESSOR | PIT_DISCONNECT | PIT_TERM_IO; cpi-&gt;transport = XPORT_SPI; cpi-&gt;hba_misc = PIM_NOBUSRESET | PIM_NOBUSRESET; // &lt;= .... }</span></span></code> </pre> <br>  In this example, the same PIM_NOBUSRESET variable is involved in the bit operation, which does not affect the result.  Most likely they wanted to use a constant with a different value, but forgot to rename the variable. <br><br>  <a href="http://www.viva64.com/ru/d/0112/">V523</a> The 'then' statement is equivalent to the 'else' statement.  saint.c 2023 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">GLOBAL </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">siSMPRespRcvd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (agNULL == frameHandle) { <span class="hljs-comment"><span class="hljs-comment">/* indirect mode */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* call back with success */</span></span> (*(ossaSMPCompletedCB_t)(pRequest-&gt;completionCB))(agRoot, pRequest-&gt;pIORequestContext, OSSA_IO_SUCCESS, payloadSize, frameHandle); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* direct mode */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* call back with success */</span></span> (*(ossaSMPCompletedCB_t)(pRequest-&gt;completionCB))(agRoot, pRequest-&gt;pIORequestContext, OSSA_IO_SUCCESS, payloadSize, frameHandle); } .... }</code> </pre> <br>  Two branches of the condition are signed by different comments: / * indirect mode * / and / * direct mode * /, but they are implemented in the same way, which is very suspicious. <br><br>  <a href="http://www.viva64.com/ru/d/0112/">V523</a> The 'then' statement is equivalent to the 'else' statement.  smsat.c 2848 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">osGLOBAL </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">smsatInquiryPage89</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (oneDeviceData-&gt;satDeviceType == SATA_ATA_DEVICE) { pInquiry[<span class="hljs-number"><span class="hljs-number">40</span></span>] = <span class="hljs-number"><span class="hljs-number">0x01</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* LBA Low */</span></span> pInquiry[<span class="hljs-number"><span class="hljs-number">41</span></span>] = <span class="hljs-number"><span class="hljs-number">0x00</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* LBA Mid */</span></span> pInquiry[<span class="hljs-number"><span class="hljs-number">42</span></span>] = <span class="hljs-number"><span class="hljs-number">0x00</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* LBA High */</span></span> pInquiry[<span class="hljs-number"><span class="hljs-number">43</span></span>] = <span class="hljs-number"><span class="hljs-number">0x00</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Device */</span></span> pInquiry[<span class="hljs-number"><span class="hljs-number">44</span></span>] = <span class="hljs-number"><span class="hljs-number">0x00</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* LBA Low Exp */</span></span> pInquiry[<span class="hljs-number"><span class="hljs-number">45</span></span>] = <span class="hljs-number"><span class="hljs-number">0x00</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* LBA Mid Exp */</span></span> pInquiry[<span class="hljs-number"><span class="hljs-number">46</span></span>] = <span class="hljs-number"><span class="hljs-number">0x00</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* LBA High Exp */</span></span> pInquiry[<span class="hljs-number"><span class="hljs-number">47</span></span>] = <span class="hljs-number"><span class="hljs-number">0x00</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Reserved */</span></span> pInquiry[<span class="hljs-number"><span class="hljs-number">48</span></span>] = <span class="hljs-number"><span class="hljs-number">0x01</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Sector Count */</span></span> pInquiry[<span class="hljs-number"><span class="hljs-number">49</span></span>] = <span class="hljs-number"><span class="hljs-number">0x00</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Sector Count Exp */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { pInquiry[<span class="hljs-number"><span class="hljs-number">40</span></span>] = <span class="hljs-number"><span class="hljs-number">0x01</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* LBA Low */</span></span> pInquiry[<span class="hljs-number"><span class="hljs-number">41</span></span>] = <span class="hljs-number"><span class="hljs-number">0x00</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* LBA Mid */</span></span> pInquiry[<span class="hljs-number"><span class="hljs-number">42</span></span>] = <span class="hljs-number"><span class="hljs-number">0x00</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* LBA High */</span></span> pInquiry[<span class="hljs-number"><span class="hljs-number">43</span></span>] = <span class="hljs-number"><span class="hljs-number">0x00</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Device */</span></span> pInquiry[<span class="hljs-number"><span class="hljs-number">44</span></span>] = <span class="hljs-number"><span class="hljs-number">0x00</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* LBA Low Exp */</span></span> pInquiry[<span class="hljs-number"><span class="hljs-number">45</span></span>] = <span class="hljs-number"><span class="hljs-number">0x00</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* LBA Mid Exp */</span></span> pInquiry[<span class="hljs-number"><span class="hljs-number">46</span></span>] = <span class="hljs-number"><span class="hljs-number">0x00</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* LBA High Exp */</span></span> pInquiry[<span class="hljs-number"><span class="hljs-number">47</span></span>] = <span class="hljs-number"><span class="hljs-number">0x00</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Reserved */</span></span> pInquiry[<span class="hljs-number"><span class="hljs-number">48</span></span>] = <span class="hljs-number"><span class="hljs-number">0x01</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Sector Count */</span></span> pInquiry[<span class="hljs-number"><span class="hljs-number">49</span></span>] = <span class="hljs-number"><span class="hljs-number">0x00</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Sector Count Exp */</span></span> } .... }</code> </pre> <br>  This example is even more suspicious than the previous one.  Copied such a large piece of code, but then no changes were made. <br><br>  <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression is always true.  Probably the '&amp;&amp;' operator should be used here.  qla_hw.c 799 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">qla_tx_tso</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">qla_host_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ha, struct mbuf *mp, ....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((*tcp_opt != <span class="hljs-number"><span class="hljs-number">0x01</span></span>) || (*(tcp_opt + <span class="hljs-number"><span class="hljs-number">1</span></span>) != <span class="hljs-number"><span class="hljs-number">0x01</span></span>) || (*(tcp_opt + <span class="hljs-number"><span class="hljs-number">2</span></span>) != <span class="hljs-number"><span class="hljs-number">0x08</span></span>) || (*(tcp_opt + <span class="hljs-number"><span class="hljs-number">2</span></span>) != <span class="hljs-number"><span class="hljs-number">10</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= return -1; } .... }</span></span></code> </pre> <br>  Here, the analyzer found that the condition "(* (tcp_opt + 2)! = 0x08) || (* (tcp_opt + 2)! = 10)" is always true and this is true if you build a truth table.  But, most likely, the '&amp;&amp;' operator is not needed here, but simply made a typo in the address offset.  Perhaps the function code should have been like this: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">qla_tx_tso</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">qla_host_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ha, struct mbuf *mp, ....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((*tcp_opt != <span class="hljs-number"><span class="hljs-number">0x01</span></span>) || (*(tcp_opt + <span class="hljs-number"><span class="hljs-number">1</span></span>) != <span class="hljs-number"><span class="hljs-number">0x01</span></span>) || (*(tcp_opt + <span class="hljs-number"><span class="hljs-number">2</span></span>) != <span class="hljs-number"><span class="hljs-number">0x08</span></span>) || (*(tcp_opt + <span class="hljs-number"><span class="hljs-number">3</span></span>) != <span class="hljs-number"><span class="hljs-number">10</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } .... }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0169/">V571</a> Recurring check.  This condition was already verified in line 1946. sahw.c 1949 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">GLOBAL bit32 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">siHDAMode_V</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( saRoot-&gt;memoryAllocated.agMemory[i].totalLength &gt; biggest) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(biggest &lt; saRoot-&gt;memoryAllocated.agMemory[i].totalLength) { save = i; biggest = saRoot-&gt;memoryAllocated.agMemory[i].totalLength; } } .... }</code> </pre> <br>  Very strange code, if it is conditionally simplified, we will see the following: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( A &gt; B ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (B &lt; A) { .... } }</code> </pre> <br>  The same condition is checked twice in a row.  Most likely, they wanted to write another code here. <br><br>  Another similar place: <ul><li>  V571 Recurring check.  This condition was already verified in line 1940. if_rl.c 1941 </li></ul><br><h2>  Dangerous Macros </h2><br>  <a href="http://www.viva64.com/ru/d/0112/">V523</a> The 'then' statement is equivalent to the 'else' statement.  agtiapi.c 829 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (osti_strncmp(buffer, <span class="hljs-string"><span class="hljs-string">"0x"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { maxTargets = osti_strtoul (buffer, &amp;pLastUsedChar, <span class="hljs-number"><span class="hljs-number">0</span></span>); AGTIAPI_PRINTK( <span class="hljs-string"><span class="hljs-string">".... maxTargets = osti_strtoul 0 \n"</span></span> ); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { maxTargets = osti_strtoul (buffer, &amp;pLastUsedChar, <span class="hljs-number"><span class="hljs-number">10</span></span>); AGTIAPI_PRINTK( <span class="hljs-string"><span class="hljs-string">".... maxTargets = osti_strtoul 10\n"</span></span> ); }</code> </pre> <br>  I first skipped this analyzer warning, having decided that this is a false positive.  But after checking the project, false positives need to be studied and improved by the analyzer.  What I did, after which I met this macro: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> osti_strtoul(nptr, endptr, base) \ strtoul((char *)nptr, (char **)endptr, 0)</span></span></code> </pre> <br>  The 'base' parameter is not used at all, and the value of '0' is always passed as the last parameter to the ‚Äústrtoul‚Äù function.  Although the values ‚Äã‚Äãin the macro are '0' and '10'.  In the preprocessed file, all macros are expanded, and the code is the same.  This macro is used in this way several dozen times.  I sent the whole list of such places to the developers. <br><br>  <a href="http://www.viva64.com/ru/d/0380">V733</a> It is possible that macro expansion in incorrect evaluation order.  Check expression: chan - 1 * 20. isp.c 2301 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isp_fibre_init_2400</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ispsoftc_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *isp)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ISP_CAP_VP0(isp)) off += ICB2400_VPINFO_PORT_OFF(chan); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> off += ICB2400_VPINFO_PORT_OFF(chan - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... }</span></span></code> </pre> <br>  At first glance there is nothing suspicious in this code snippet.  Sometimes the value 'chan' is used, sometimes one less: 'chan - 1', but let's look at the definition of a macro: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ICB2400_VPOPT_WRITE_SIZE 20 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ICB2400_VPINFO_PORT_OFF(chan) \ (ICB2400_VPINFO_OFF + \ sizeof (isp_icb_2400_vpinfo_t) + \ (chan * ICB2400_VPOPT_WRITE_SIZE)) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// &lt;=</span></span></span></span></code> </pre> <br>  When passing a binary expression to a macro, the calculation logic changes drastically there.  The supposed expression "(chan - 1) * 20" turns into "chan - 1 * 20", i.e.  in ‚Äúchan - 20‚Äù, and then the wrong size is used in the program. <br><br><h2>  About priorities of operations </h2><br>  In this section, I will tell you how important it is to know the priorities of operations, use extra brackets if you are not sure, and sometimes check yourself by building a truth table of a logical expression. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/531/122/ff3/531122ff373bd771bc6d603e2394a906.png"></div><br><br>  <a href="http://www.viva64.com/ru/d/0091/">V502</a> Perhaps the '?:' Operator was different.  The '?:' Operator has a lower than the '|'  operator.  ata-serverworks.c 166 <br><pre> <code class="cpp hljs">ata_serverworks_chipinit(<span class="hljs-keyword"><span class="hljs-keyword">device_t</span></span> dev) { .... pci_write_config(dev, <span class="hljs-number"><span class="hljs-number">0x5a</span></span>, (pci_read_config(dev, <span class="hljs-number"><span class="hljs-number">0x5a</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; ~<span class="hljs-number"><span class="hljs-number">0x40</span></span>) | (ctlr-&gt;chip-&gt;cfg1 == SWKS_100) ? <span class="hljs-number"><span class="hljs-number">0x03</span></span> : <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); } .... }</code> </pre> <br>  The priority of the operator '?:' Below bitwise OR '|'.  As a result, the result of the expression "(ctlr-&gt; chip-&gt; cfg1 == SWKS_100)", which unexpectedly changes the logic of calculations, participates in bit operations, in addition to numeric constants.  Probably, in this place a result similar to the truth is often obtained, therefore such an error has not yet been noticed. <br><br>  <a href="http://www.viva64.com/ru/d/0091/">V502</a> Perhaps the '?:' Operator was different.  The '?:' Operator has a lower than the '|'  operator.  in6.c 1318 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">in6_purgeaddr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct ifaddr *ifa)</span></span></span><span class="hljs-function"> </span></span>{ .... error = rtinit(&amp;(ia-&gt;ia_ifa), RTM_DELETE, ia-&gt;ia_flags | (ia-&gt;ia_dstaddr.sin6_family == AF_INET6) ? RTF_HOST : <span class="hljs-number"><span class="hljs-number">0</span></span>); .... }</code> </pre> <br>  In another file, there was also a place with a similar error with the ternary operator. <br><br>  <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression 'cdb [0]! = 0x28 ||  cdb [0]! = 0x2A 'is always true.  Probably the '&amp;&amp;' operator should be used here.  mfi_tbolt.c 1110 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mfi_tbolt_send_frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct mfi_softc *sc, struct mfi_command *cm)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cdb[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-number"><span class="hljs-number">0x28</span></span> || cdb[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-number"><span class="hljs-number">0x2A</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// &lt;=' if ((req_desc = mfi_tbolt_build_mpt_cmd(sc, cm)) == NULL) { device_printf(sc-&gt;mfi_dev, "Mapping from MFI " "to MPT Failed \n"); return 1; } } else device_printf(sc-&gt;mfi_dev, "DJA NA XXX SYSPDIO\n"); .... }</span></span></code> </pre> <br>  Here the first conditional expression is always true, which is why the 'else' branch never gets control.  To prove the error in this and the following examples, I will give a truth table for controversial logical expressions.  An example for this case: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4f4/acd/3a0/4f4acd3a0bc722f9ca7d06b784a11ae9.png"></div><br><br>  <a href="http://www.viva64.com/ru/d/0194/">V590</a> Consider inspecting the 'error == 0 ||  error! = - 1 'expression.  The expression is misprint.  nd6.c 2119 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nd6_output_ifp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-comment"><span class="hljs-comment">/* Use the SEND socket */</span></span> error = send_sendso_input_hook(m, ifp, SND_OUT, ip6len); <span class="hljs-comment"><span class="hljs-comment">/* -1 == no app on SEND socket */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error == <span class="hljs-number"><span class="hljs-number">0</span></span> || error != <span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-comment"><span class="hljs-comment">// &lt;= return (error); .... }</span></span></code> </pre> <br>  The problem with this code snippet is that the conditional expression does not depend on the result of ‚Äúerror == 0‚Äù.  Most likely, something is wrong here: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a78/fad/7cd/a78fad7cd95ced9d8557b02a31ecb727.png"></div><br><br>  Three more cases: <ul><li>  V590 Consider inspecting the 'error == 0 ||  error! = 35 'expression.  The expression is misprint.  if_ipw.c 1855 </li><li>  V590 Consider inspecting the 'error == 0 ||  error! = 27 'expression.  The expression is misprint.  if_vmx.c 2747 </li><li>  V547 Expression is always true.  Probably the '&amp;&amp;' operator should be used here.  igmp.c 1939 </li></ul><br>  V590 Consider inspecting this expression.  The expression is misprint.  sig_verify.c 94 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> uni_ieact { UNI_IEACT_CLEAR = <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-comment"><span class="hljs-comment">/* clear call */</span></span> .... } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> uni_mandate_epref(struct uni *uni, struct uni_ie_epref *epref) { .... maxact = <span class="hljs-number"><span class="hljs-number">-1</span></span>; FOREACH_ERR(e, uni) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e-&gt;ie == UNI_IE_EPREF) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e-&gt;act == UNI_IEACT_CLEAR) maxact = UNI_IEACT_CLEAR; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e-&gt;act == UNI_IEACT_MSG_REPORT) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (maxact == <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; maxact != UNI_IEACT_CLEAR) <span class="hljs-comment"><span class="hljs-comment">// &lt;= maxact = UNI_IEACT_MSG_REPORT; } else if (e-&gt;act == UNI_IEACT_MSG_IGNORE) { if (maxact == -1) maxact = UNI_IEACT_MSG_IGNORE; } } .... }</span></span></code> </pre> <br>  Here the result of the entire conditional expression does not depend on the calculation of the value ‚Äúmaxact! = UNI_IEACT_CLEAR‚Äù.  Here is how it looks in the table: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a19/8ae/e30/a198aee3071f6fef759486374920b47c.png"></div><br><br>  In this chapter I have given as many as 3 ways how you can be mistaken in seemingly simple formulas.  Think about it ... <br><br>  <a href="http://www.viva64.com/ru/d/0197/">V593</a> Consider reviewing the A = B! = C 'kind.  The expression is calculated as the following: 'A = (B! = C)'.  aacraid.c 2854 <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> EINVAL 22 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Invalid argument */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> EFAULT 14 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Bad address */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> EPERM 1 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Operation not permitted */</span></span></span><span class="hljs-meta"> static int aac_ioctl_send_raw_srb(struct aac_softc *sc, caddr_t arg) { .... int </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">, transfer_data = 0; .... </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ((</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta"> = copyin((void *)&amp;user_srb-&gt;data_len, &amp;fibsize, sizeof (u_int32_t)) != 0)) goto out; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (fibsize &gt; (sc-&gt;aac_max_fib_size-sizeof(....))) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta"> = EINVAL; goto out; } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ((</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta"> = copyin((void *)user_srb, srbcmd, fibsize) != 0)) goto out; .... out: .... return(</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">); }</span></span></code> </pre> <br>  This function corrupts the error code when assignment is performed in the 'if' statement.  Those.  in the expression ‚Äúerror = copyin (...)! = 0‚Äù, first the ‚Äúcopyin (...)! = 0‚Äù is calculated, and then the result (value 0 or 1) is written into the variable 'error'. <br><br>  The documentation for the 'copyin' function says that in case of an error, it returns the EFAULT code (value 14), and after such a check, the result of the logical operation, which is equal to '1', will be stored in the error code, and this is EPERM - a completely different error status. <br><br>  Unfortunately, there are many such places: <ul><li>  V593 Consider reviewing the A = B! = C 'kind.  The expression is calculated as the following: 'A = (B! = C)'.  aacraid.c 2861 </li><li>  V593 Consider reviewing the A = B! = C 'kind.  The expression is calculated as the following: 'A = (B! = C)'.  if_age.c 591 </li><li>  V593 Consider reviewing the A = B! = C 'kind.  The expression is calculated as the following: 'A = (B! = C)'.  if_alc.c 1535 </li><li>  V593 Consider reviewing the A = B! = C 'kind.  The expression is calculated as the following: 'A = (B! = C)'.  if_ale.c 606 </li><li>  V593 Consider reviewing the A = B! = C 'kind.  The expression is calculated as the following: 'A = (B! = C)'.  if_jme.c 807 </li><li>  V593 Consider reviewing the A = B! = C 'kind.  The expression is calculated as the following: 'A = (B! = C)'.  if_msk.c 1626 </li><li>  V593 Consider reviewing the A = B! = C 'kind.  The expression is calculated as the following: 'A = (B! = C)'.  if_stge.c 511 </li><li>  V593 Consider reviewing the A = B! = C 'kind.  The expression is calculated as the following: 'A = (B! = C)'.  hunt_filter.c 973 </li><li>  V593 Consider reviewing the A = B! = C 'kind.  The expression is calculated as the following: 'A = (B! = C)'.  if_smsc.c 1365 </li><li>  V593 Consider reviewing the A = B! = C 'kind.  The expression is calculated as the following: 'A = (B! = C)'.  if_vte.c 431 </li><li>  V593 Consider reviewing the A = B! = C 'kind.  The expression is calculated as the following: 'A = (B! = C)'.  zfs_vfsops.c 498 </li></ul><br><h2>  Strings </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ab1/efc/b71/ab1efcb71b9263febcd5845db4590e3c.png"></div><br><br>  <a href="http://www.viva64.com/ru/d/0130/">V541</a> It is dangerous to print the string 'buffer' into itself.  ata-highpoint.c 102 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ata_highpoint_probe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">device_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dev)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buffer[<span class="hljs-number"><span class="hljs-number">64</span></span>]; .... <span class="hljs-built_in"><span class="hljs-built_in">strcpy</span></span>(buffer, <span class="hljs-string"><span class="hljs-string">"HighPoint "</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">strcat</span></span>(buffer, idx-&gt;text); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (idx-&gt;cfg1 == HPT_374) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pci_get_function(dev) == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">strcat</span></span>(buffer, <span class="hljs-string"><span class="hljs-string">" (channel 0+1)"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pci_get_function(dev) == <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">strcat</span></span>(buffer, <span class="hljs-string"><span class="hljs-string">" (channel 2+3)"</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buffer, <span class="hljs-string"><span class="hljs-string">"%s %s controller"</span></span>, buffer, ata_mode2str(idx-&gt;max_dma)); .... }</code> </pre> <br>  Here form a certain line in the buffer.  Then they want to get a new line, keeping the previous value of the line, and add two more words to it.  It seems simple. <br><br>  To explain why an unexpected result will be obtained here, I will quote a simple and understandable example from the documentation for this diagnostic: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> s[<span class="hljs-number"><span class="hljs-number">100</span></span>] = <span class="hljs-string"><span class="hljs-string">"test"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(s, <span class="hljs-string"><span class="hljs-string">"N = %d, S = %s"</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, s);</code> </pre> <br>  As a result of this code, I want to get the line: <br><pre> <code class="cpp hljs">N = <span class="hljs-number"><span class="hljs-number">123</span></span>, S = test</code> </pre> <br>  But in practice, the string will be formed in the buffer: <br><pre> <code class="cpp hljs">N = <span class="hljs-number"><span class="hljs-number">123</span></span>, S = N = <span class="hljs-number"><span class="hljs-number">123</span></span>, S =</code> </pre> <br>  In other situations, a similar code can lead not only to the output of incorrect text, but also to the program crash.  The code can be corrected by using a new buffer to save the result.  Correct option: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> s1[<span class="hljs-number"><span class="hljs-number">100</span></span>] = <span class="hljs-string"><span class="hljs-string">"test"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> s2[<span class="hljs-number"><span class="hljs-number">100</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(s2, <span class="hljs-string"><span class="hljs-string">"N = %d, S = %s"</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, s1);</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0101/">V512</a> A call to the 'strcpy' function will lead to the overflow of the buffer 'p-&gt; vendor'.  aacraid_cam.c 571 <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SID_VENDOR_SIZE 8 char vendor[SID_VENDOR_SIZE]; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SID_PRODUCT_SIZE 16 char product[SID_PRODUCT_SIZE]; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SID_REVISION_SIZE 4 char revision[SID_REVISION_SIZE]; static void aac_container_special_command(struct cam_sim *sim, union ccb *ccb, u_int8_t *cmdp) { .... </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* OEM Vendor defines */</span></span></span><span class="hljs-meta"> strcpy(p-&gt;vendor,</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Adaptec "</span></span></span><span class="hljs-meta">); </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// &lt;= strcpy(p-&gt;product,"Array "); // &lt;= strcpy(p-&gt;revision,"V1.0"); // &lt;= .... }</span></span></span></span></code> </pre> <br>  All three lines here are filled incorrectly.  In arrays there is no place for a <a href="http://www.viva64.com/ru/t/0088/">null-terminal character</a> , which can cause serious problems with further work with such strings.  In the case of "p-&gt; vendor" and "p-&gt; product" you can remove one space.  Then the terminal zero will fit, which the strcpy () function adds to the end of the line.  But for "p-&gt; revision" there is absolutely no room for the end-of-line character, so you need to increase the value of SID_REVISION_SIZE by at least one. <br><br>  I, of course, difficult to judge this code.  Perhaps the terminal zero is not needed, and everything is designed for a specific buffer size.  Then the strcpy () function is incorrectly selected.  In this case, you should write something like this: <br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(p-&gt;vendor, <span class="hljs-string"><span class="hljs-string">"Adaptec "</span></span>, SID_VENDOR_SIZE); <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(p-&gt;product, <span class="hljs-string"><span class="hljs-string">"Array "</span></span>, SID_PRODUCT_SIZE); <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(p-&gt;revision, <span class="hljs-string"><span class="hljs-string">"V1.0"</span></span>, SID_REVISION_SIZE);</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0186/">V583</a> The '?:' Operator, regardless of its conditional expression, always returns one and the same value: td-&gt; td_name.  subr_turnstile.c 1029 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print_thread</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct thread *td, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *prefix)</span></span></span><span class="hljs-function"> </span></span>{ db_printf(<span class="hljs-string"><span class="hljs-string">"%s%p (tid %d, pid %d, ...."</span></span>, prefix, td, td-&gt;td_tid, td-&gt;td_proc-&gt;p_pid, td-&gt;td_name[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-string"><span class="hljs-string">'\0'</span></span> ? td-&gt;td_name : td-&gt;td_name); }</code> </pre> <br>  Suspicious place.  Despite checking ‚Äútd-&gt; td_name [0]! = '\ 0'‚Äù, this line is still printed. <br><br>  All such places: <ul><li>  V583 The '?:' Operator, regardless of its conditional expression, always returns one and the same value: td-&gt; td_name.  subr_turnstile.c 1112 </li><li>  V583 The '?:' Operator, regardless of its conditional expression, always returns one and the same value: td-&gt; td_name.  subr_turnstile.c 1196 </li></ul><br><h2>  Memory operations </h2><br>  In this section, I will discuss the misuse of the following functions: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bzero</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *b, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len)</span></span></span></span>;</code> </pre> <br>  The bzero () function fills zeros with 'len' bytes at the 'b' pointer. <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copyout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *kaddr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *uaddr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len)</span></span></span></span>;</code> </pre> <br>  The copyout () function copies 'len' bytes from 'kaddr' to 'uaddr'. <br><br>  <a href="http://www.viva64.com/ru/d/0181/">It is a V579</a> .  It is possibly a mistake.  Inspect the second argument.  osapi.c 316 <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* Autosense storage */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scsi_sense_data</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sense_data</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ostiInitiatorIOCompleted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... bzero(&amp;csio-&gt;sense_data, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(&amp;csio-&gt;sense_data)); .... }</code> </pre> <br>  To reset the structure, the bzero () function must pass a pointer to the structure and size of the reset memory in bytes, but here the pointer size, not the structure size, is passed to the function. <br><br>  The correct version should look like this: <br><pre> <code class="cpp hljs">bzero(&amp;csio-&gt;sense_data, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(csio-&gt;sense_data));</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0181/">It is a V579</a> .  It is possibly a mistake.  Inspect the second argument.  acpi_package.c 83 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">acpi_PkgStr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...., </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *dst, ....)</span></span></span><span class="hljs-function"> </span></span>{ .... bzero(dst, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(dst)); .... }</code> </pre> <br>  In this example, a similar situation: in the 'bzero' function the size of the pointer was transferred again, not of the object. <br><br>  The correct version should look like this: <br><pre> <code class="cpp hljs">bzero(dst, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(*dst));</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0181/">It is a V579</a> .  It is possibly a mistake.  Inspect the third argument.  if_nxge.c 1498 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xge_ioctl_stats</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">xge_lldev_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *lldev, struct ifreq *ifreqp)</span></span></span><span class="hljs-function"> </span></span>{ .... *data = (*data == XGE_SET_BUFFER_MODE_1) ? <span class="hljs-string"><span class="hljs-string">'Y'</span></span>:<span class="hljs-string"><span class="hljs-string">'N'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(copyout(data, ifreqp-&gt;ifr_data, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(data)) == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">// &lt;= retValue = 0; break; .... }</span></span></code> </pre> <br>  In this example, the memory is copied from 'data' to 'ifreqp-&gt; ifr_data', while the size of the copied memory is equal to sizeof (data), i.e.  4 or 8 bytes depending on the capacity of the architecture. <br><br><h2>  Pointers </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9ba/19a/9cb/9ba19a9cbd2ef8c414255107797e978e.png"></div><br><br>  <a href="http://www.viva64.com/ru/d/0148/">V557</a> Array overrun is possible.  The '2' index is pointing beyond array bound.  if_spppsubr.c 4348 <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> AUTHKEYLEN 16 struct sauth { u_short proto; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* authentication protocol to use */</span></span></span><span class="hljs-meta"> u_short flags; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> AUTHFLAG_NOCALLOUT 1 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* callouts */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> AUTHFLAG_NORECHALLENGE 2 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* do not re-challenge CHAP */</span></span></span><span class="hljs-meta"> u_char name[AUTHNAMELEN]; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* system identification name */</span></span></span><span class="hljs-meta"> u_char secret[AUTHKEYLEN]; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* secret password */</span></span></span><span class="hljs-meta"> u_char challenge[AUTHKEYLEN]; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* random challenge */</span></span></span><span class="hljs-meta"> }; static void sppp_chap_scr(struct sppp *sp) { u_long *ch, seed; u_char clen; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Compute random challenge. */</span></span></span><span class="hljs-meta"> ch = (u_long *)sp-&gt;myauth.challenge; read_random(&amp;seed, sizeof seed); ch[0] = seed ^ random(); ch[1] = seed ^ random(); ch[2] = seed ^ random(); </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// &lt;= ch[3] = seed ^ random(); // &lt;= clen = AUTHKEYLEN; .... }</span></span></span></span></code> </pre> <br>  The size of the 'u_char' type is 1 byte in 32-bit and 64-bit applications, and the size of the 'u_long' type is 4 bytes in a 32-bit application and 8 bytes in a 64-bit application.  Then, in a 32-bit application, when performing the operation ‚Äúu_long * ch = (u_long *) sp-&gt; myauth.challenge‚Äù, the array 'ch' will consist of 4 elements of 4 bytes each.  And in a 64-bit application, the array 'ch' will consist of 2 elements of 8 bytes each.  Therefore, if we assemble a 64-bit kernel, then when accessing ch [2] and ch [3] occurs, the output goes beyond the array boundaries. <br><br>  <a href="http://www.viva64.com/ru/d/0092/">V503</a> This is a nonsensical comparison: pointer&gt; = 0. geom_vinum_plex.c 173 <br><pre> <code class="cpp hljs">gv_plex_offset(...., <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *sdno, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> growing) { .... *sdno = stripeno % sdcount; .... KASSERT(sdno &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>, (<span class="hljs-string"><span class="hljs-string">"gv_plex_offset: sdno &lt; 0"</span></span>)); .... }</code> </pre> <br>  A very interesting place was found with the help of the 503rd diagnostics.  There is no practical reason to check that the pointer value is greater than or equal to 0. Most likely, they forgot to dereference the ‚Äúsdno‚Äù pointer in order to compare the value stored there. <br><br>  Two more pointer comparisons with zero: <ul><li>  V503 This is a nonsensical comparison: pointer&gt; = 0. geom_vinum_raid5.c 602 </li><li>  V503 This is a nonsensical comparison: pointer&gt; = 0. geom_vinum_raid5.c 610 </li></ul><br>  <a href="http://www.viva64.com/ru/d/0111/">V522</a> Dereferencing of the null pointer 'sc' might take place.  mrsas.c 4027 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mrsas_aen_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct mrsas_softc *sc)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!sc) { device_printf(sc-&gt;mrsas_dev, <span class="hljs-string"><span class="hljs-string">"invalid instance!\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sc-&gt;evt_detail_mem) { .... }</code> </pre> <br>  If the ‚Äúsc‚Äù pointer is zero, the function is exited.   ,       ¬´sc-&gt;mrsas_dev¬ª. <br><br>   : <ul><li> V522 Dereferencing of the null pointer 'sc' might take place. mrsas.c 1279 </li><li> V522 Dereferencing of the null pointer 'sc' might take place. tws_cam.c 1066 </li><li> V522 Dereferencing of the null pointer 'sc' might take place. blkfront.c 677 </li><li> V522 Dereferencing of the null pointer 'dev_priv' might take place. radeon_cs.c 153 </li><li> V522 Dereferencing of the null pointer 'ha' might take place. ql_isr.c 728 </li></ul><br> <a href="http://www.viva64.com/ru/d/0354/">V713</a> The pointer m was utilized in the logical expression before it was verified against nullptr in the same logical expression. ip_fastfwd.c 245 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">struct mbuf * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ip_tryforward</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct mbuf *m)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pfil_run_hooks( &amp;V_inet_pfil_hook, &amp;m, m-&gt;m_pkthdr.rcvif, PFIL_IN, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) || m == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> drop; .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The ‚Äúm == NULL‚Äù check is in the wrong place. </font><font style="vertical-align: inherit;">First you need to check the pointer, and only then call the function pfil_run_hooks ().</font></font><br><br><h2>  Cycles </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9c7/828/4dc/9c78284dc6f20afc9911f7f52ad749c6.png"></div><br><br> <a href="http://www.viva64.com/ru/d/0238/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V621</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Consider inspecting the 'for' operator. </font><font style="vertical-align: inherit;">It is possible that you will not be executed at all. </font><font style="vertical-align: inherit;">if_ae.c 1663</font></font><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> AE_IDLE_TIMEOUT 100 static void ae_stop_rxmac(ae_softc_t *sc) { int i; .... </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* * Wait for IDLE state. */</span></span></span><span class="hljs-meta"> for (i = 0; i &lt; AE_IDLE_TIMEOUT; i--) { </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// &lt;= val = AE_READ_4(sc, AE_IDLE_REG); if ((val &amp; (AE_IDLE_RXMAC | AE_IDLE_DMAWRITE)) == 0) break; DELAY(100); } .... }</span></span></span></span></code> </pre> <br>    FreeBSD      .  ,      ,  ,   . ,      ,   AE_IDLE_TIMEOUT,     'break'. <br><br>      ,      'i'.      ,    .      ,   .        : " <a href="http://www.viva64.com/ru/b/0374/">Undefined behavior ,   </a> ". <br><br>   .      <a href="http://www.viva64.com/ru/b/0317/"></a>      Haiku (.  ¬´ #17, #18¬ª).  ,      ¬´if_ae.c¬ª,      :). <br><br> <a href="http://www.viva64.com/ru/d/0124/">V535</a> The variable 'i' is being used for this loop and for the outer loop. Check lines: 182, 183. mfi_tbolt.c 183 <br><pre> <code class="cpp hljs">mfi_tbolt_adp_reset(struct mfi_softc *sc) { .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10000</span></span>; i++); } .... }</code> </pre> <br>         ,     10000 ,   10*10000,     ? <br><br>     , ..    ,             . <br><br> <a href="http://www.viva64.com/ru/d/0124/">V535</a> The variable 'i' is being used for this loop and for the outer loop. Check lines: 197, 208. linux_vdso.c 208 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __elfN(linux_vdso_reloc)(struct sysentvec *sv, <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> vdso_adjust) { .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; ehdr-&gt;e_shnum; i++) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= if (!(shdr[i].sh_flags &amp; SHF_ALLOC)) continue; shdr[i].sh_addr += vdso_adjust; if (shdr[i].sh_type != SHT_SYMTAB &amp;&amp; shdr[i].sh_type != SHT_DYNSYM) continue; sym = (Elf_Sym *)((caddr_t)ehdr + shdr[i].sh_offset); symcnt = shdr[i].sh_size / sizeof(*sym); for(i = 0; i &lt; symcnt; i++, sym++) { // &lt;= if (sym-&gt;st_shndx == SHN_UNDEF || sym-&gt;st_shndx == SHN_ABS) continue; sym-&gt;st_value += vdso_adjust; } } .... }</span></span></code> </pre> <br>     ,  ,    .       ,        . <br><br> <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression 'j &gt;= 0' is always true. Unsigned type value is always &gt;= 0. safe.c 1596 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">safe_mcopy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct mbuf *srcm, struct mbuf *dstm, u_int offset)</span></span></span><span class="hljs-function"> </span></span>{ u_int j, dlen, slen; <span class="hljs-comment"><span class="hljs-comment">// &lt;= caddr_t dptr, sptr; /* * Advance src and dst to offset. */ j = offset; while (j &gt;= 0) { // &lt;= if (srcm-&gt;m_len &gt; j) break; j -= srcm-&gt;m_len; // &lt;= srcm = srcm-&gt;m_next; if (srcm == NULL) return; } sptr = mtod(srcm, caddr_t) + j; slen = srcm-&gt;m_len - j; j = offset; while (j &gt;= 0) { // &lt;= if (dstm-&gt;m_len &gt; j) break; j -= dstm-&gt;m_len; // &lt;= dstm = dstm-&gt;m_next; if (dstm == NULL) return; } dptr = mtod(dstm, caddr_t) + j; dlen = dstm-&gt;m_len - j; .... }</span></span></code> </pre> <br>       .  Since  'j' ( )   ,   ¬´j &gt;= 0¬ª      ¬´¬ª.     ,       , ,      ,   'j'    . <br><br> <a href="http://www.viva64.com/ru/d/0352/">V711</a> It is dangerous to create a local variable within a loop with a same name as a variable controlling this loop. powernow.c 733 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pn_decode_pst</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">device_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dev)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pst_header</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pst</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... p = ((uint8_t *) psb) + sizeof(struct psb_header); pst = (struct pst_header*) p; maxpst = 200; do { struct pst_header *pst = (struct pst_header*) p; // &lt;= .... p += sizeof(struct pst_header) + (2 * pst-&gt;numpstates); } while (cpuid_is_k7(pst-&gt;cpuid) &amp;&amp; maxpst--); // &lt;= .... }</span></span></code> </pre> <br>      ,   ,    .    ,  -        'pst',      'pst'  . ,    do....while()       ¬´pst-&gt;cupid¬ª.           . <br><br><h2>  miscellanea </h2><br> <a href="http://www.viva64.com/ru/d/0164/">V569</a> Truncation of constant value -96. The value range of unsigned char type: [0, 255]. if_rsu.c 1516 <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ieee80211_rx_stats</span></span></span><span class="hljs-class"> {</span></span> .... <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> nf; <span class="hljs-comment"><span class="hljs-comment">/* global NF */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> rssi; <span class="hljs-comment"><span class="hljs-comment">/* global RSSI */</span></span> .... }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rsu_event_survey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct rsu_softc *sc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len)</span></span></span><span class="hljs-function"> </span></span>{ .... rxs.rssi = le32toh(bss-&gt;rssi) / <span class="hljs-number"><span class="hljs-number">2</span></span>; rxs.nf = <span class="hljs-number"><span class="hljs-number">-96</span></span>; .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is very suspicious that the unsigned variable "rxs.nf" is assigned a negative value of '-96'. </font><font style="vertical-align: inherit;">As a result, the variable will have the value '160'. </font></font><br><br> <a href="http://www.viva64.com/ru/d/0376/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V729</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Function body contains the 'done' label. </font><font style="vertical-align: inherit;">zfs_acl.c 2023</font></font><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">zfs_setacl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">znode_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *zp, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">vsecattr_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *vsecp, ....)</span></span></span><span class="hljs-function"> </span></span>{ .... top: mutex_enter(&amp;zp-&gt;z_acl_lock); mutex_enter(&amp;zp-&gt;z_lock); .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error == ERESTART) { dmu_tx_wait(tx); dmu_tx_abort(tx); <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> top; } .... done: <span class="hljs-comment"><span class="hljs-comment">// &lt;= mutex_exit(&amp;zp-&gt;z_lock); mutex_exit(&amp;zp-&gt;z_acl_lock); return (error); }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The code contains functions that contain labels, but there is no call to the 'goto' operator for these labels. </font><font style="vertical-align: inherit;">For example, in this code snippet, the label 'top' is used, but 'done' is not used anywhere. </font><font style="vertical-align: inherit;">Perhaps, you have forgotten to add the transition to the label or have deleted it in time, and the label was left at random.</font></font><br><br>  <a href="http://www.viva64.com/ru/d/0265/">V646</a> Consider inspecting the application's logic.  It's possible that 'else' keyword is missing.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mac_process.c 352 </font></font><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mac_proc_vm_revoke_recurse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct thread *td, struct ucred *cred, struct vm_map *</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">map</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!mac_mmap_revocation_via_cow) { vme-&gt;max_protection &amp;= ~VM_PROT_WRITE; vme-&gt;protection &amp;= ~VM_PROT_WRITE; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((revokeperms &amp; VM_PROT_READ) == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">// &lt;= vme-&gt;eflags |= MAP_ENTRY_COW | MAP_ENTRY_NEEDS_COPY; .... }</span></span></code> </pre> <br>      ,         .     ,     'else'  . <br><br> <a href="http://www.viva64.com/ru/d/0344/">V705</a> It is possible that 'else' block was forgotten or commented out, thus altering the program's operation logics. scsi_da.c 3231 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dadone</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct cam_periph *periph, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">union</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ccb *done_ccb)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-comment"><span class="hljs-comment">/* * If we tried READ CAPACITY(16) and failed, * fallback to READ CAPACITY(10). */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((state == DA_CCB_PROBE_RC16) &amp;&amp; .... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-comment"><span class="hljs-comment">// &lt;= /* * Attach to anything that claims to be a * direct access or optical disk device, * as long as it doesn't return a "Logical * unit not supported" (0x25) error. */ if ((have_sense) &amp;&amp; (asc != 0x25) // &lt;= .... } else { .... } .... }</span></span></code> </pre> <br>      ,  -   .      'else',   ,  -     ,         . <br><br><h2>  Conclusion </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/be7/0f3/df8/be70f3df8fe8399dcbfc73bc10b2a695.png"></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The FreeBSD project was tested with a special version of PVS-Studio, which showed excellent results! </font><font style="vertical-align: inherit;">All the material received was impossible to fit in this one article. </font><font style="vertical-align: inherit;">However, the FreeBSD development team has received the entire list of analyzer warnings that you should pay attention to. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I suggest everyone to try </font></font><a href="http://www.viva64.com/ru/pvs-studio/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on their projects. </font><font style="vertical-align: inherit;">The analyzer works in the Windows environment. </font><font style="vertical-align: inherit;">To use the analyzer in developing projects for Linux / FreeBSD, we do not have a public version. </font><font style="vertical-align: inherit;">But we can discuss possible options for concluding a contract on the adaptation of PVS-Studio for your projects and tasks.</font></font><br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0377/"><img src="https://habrastorage.org/getpro/habr/post_images/35e/064/ddf/35e064ddf91f5d99b620384893909ff7.png"></a> </div><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Svyatoslav Razmyslov. <a href="http://www.viva64.com/en/b/0377/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio has delved into the FreeBSD kernel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/277439/">https://habr.com/ru/post/277439/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../277429/index.html">You never finish your game</a></li>
<li><a href="../277431/index.html">The first release of Kotlin 1.0 has been released.</a></li>
<li><a href="../277433/index.html">All vertical alignment methods in CSS</a></li>
<li><a href="../277435/index.html">Mikrotik - Advanced settings for Yota</a></li>
<li><a href="../277437/index.html">Microsoft fixed multiple bugs in the system components of Windows 8.1 and Server 2012</a></li>
<li><a href="../277445/index.html">Use OpenShift (deployment example)</a></li>
<li><a href="../277447/index.html">We return ICQ to life (ICQ). Designer's opinion</a></li>
<li><a href="../277449/index.html">Web file manager Sprut.IO in OpenSource</a></li>
<li><a href="../277451/index.html">Dynamic data binding in HTML and JS</a></li>
<li><a href="../277453/index.html">Neon: Node + Rust</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>