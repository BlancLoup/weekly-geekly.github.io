<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Speedometer / odometer on IN14</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! 
 Once again, creativity attacked. I decided to update the old speedometer in the battle tank VAZ 2121. Having made a revision of the bins, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Speedometer / odometer on IN14</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/223/573/535/223573535e4a4d2ab59998d867645ddf.jpg" align="left"><br>  Good day! <br>  Once again, creativity attacked.  I decided to update the old speedometer in the battle tank VAZ 2121. Having made a revision of the bins, I found 3 pieces of IN14.  For hours - a little, for a thermometer - a lot.  Neither there - nor here.  In the speedometer - the most it. <a name="habracut"></a><br>  For a start, the standard speedometer was removed and gutted.  The current mileage is saved on a piece of paper, so that everything is fair.  The speed sensor was acquired 10 pulses per revolution (DSA-3).  As indicators of speed ‚Äî the aforementioned IN14, for displaying run, hours and other things ‚Äî widely known in narrow circles of the Caller ID on z80 - ALS318. <br><img src="https://habrastorage.org/files/a40/11d/9fb/a4011d9fb4ab4ef082540dbdbf74a2a7.jpg"><br>  Initially, the PIC18F452 was chosen as the core of the device for the abundance of GPIO.  Then I got an i2c port extender mcp23017, which I have long wanted to get to.  With it, the need for a lot of GPIO disappeared, and was chosen close to me in the latest designs, msp430g2452.  Also found RTC - i2c watch ds1307. <br>  IN14 requires 170 volts for normal operation.  Boost DC-DC was assembled according to a proven scheme on the MC34063 + IRF740.  I will describe some of the nuances that appeared in the process of creation. <br>  <b>1. Round case</b> .  Not very convenient form for placement inside the electronics and display.  I had to make the internal design of a modular with multiple connectors.  The task was also to make the hull airtight (or almost sealed), as the waterline in connection with the operating conditions of the vehicle is above the roof.  This was decided by pouring extra holes with epoxy glue and installing a single connector to communicate with the outside world.  Actually design: <br><img src="https://habrastorage.org/files/765/1db/deb/7651dbdebe4b410cbd74102edf6f7713.jpg"><br>  and connector: <br><img src="https://habrastorage.org/files/c95/3b9/7a6/c953b97a6ddc4139b4aa30efde6990e4.jpg"><br>  <b>2. Dynamic indication</b> .  In order not to notice the switching of digits during dynamic display, so infuriating certain people, the update rate of each digit should be at least 100 Hz.  True, there are those who see 100 Hz, but I do not ride them on this car.  Of the two indicators, the most difficult from this point of view is the 9-bit ALS318.  It turns out that the frequency of updating the readings should be at least 9 * 100 Hz.  To simplify the calculation of the intervals - the update frequency of 1kHz was chosen.  Circuitry ALS318 is connected to the port extender mcp23017.  Port A - segments, port B - discharges.  The 9th digit is controlled directly from the GPIO microcontroller.  It turns out that once a millisecond, i2c needs to update the state of ports A and B of the expander.  From here came out the next nuance. <br>  <b>3. Slow exchange on i2c from ds1307</b> .  In our case, two slaves hang on the i2c bus.  Port Expander and Clock.  The latter do not keep up with the SCL frequency above 100kHz, while the extender can operate at frequencies up to 1.7 MHz.  To update the ports of the expander, it is necessary to write to i2c once in 1 ms 4 8-Mbit words (the address of the expander, the address of port A, the data for port A, the data for port B).  During the initialization, the expander is programmed to autoincrement the addresses of the internal registers during reading / writing.  And the port B address immediately follows the port A address, which saves on the transmission of the additional port address B. To ensure a short processing time of the display update procedure, the clocking frequency SCL - 500 kHz was chosen.  Moreover, the clock status is polled once per 100 indication update cycles, i.e.  once in 100ms  The clock polling procedure sets the SCL frequency to 100kHz permissible for ds1307.  When debugging the i2c exchange, the SaleaeLogic USB logic analyzer (8 channels, up to 24 MHz sampling) helped a lot.  Soft to it can decode various protocols, including i2c. <br><img src="https://habrastorage.org/files/051/7c0/dff/0517c0dffb2c4fd4b477b76b2a6e6be8.PNG"><br>  <b>4. Power</b> .  The speedometer for storing time is continuously powered from the battery and for work - the voltage applied when the ignition is turned on.  The DC-DC converter and decoder for IN14, the port expander are powered last.  In the absence of ignition voltage - the device is transferred to the storage mode.  If the ignition key is on, the display starts, and the interrupts from the speed sensor are enabled.  When the ignition is turned off - odometer readings are recorded in the non-volatile memory of the microcontroller. <br>  <b>5. Management</b> To set the clock, reset odometer readings (there are two, except for the main odometer), an encoder with a button is used (the picture honestly plucked in the network. Your encoder is already filled with hot-melt adhesive for waterproofing): <br><img src="https://habrastorage.org/files/02b/5de/2bc/02b5de2bc88e4bc785de3bf6a15041f1.jpg"><br>  <b>6. Logic levels of i2c slaves</b> .  Since the ds1307 clock is powered by 5V, and the microcontroller and the port expander from 3.3V - pull-up resistors of the i2c bus are connected to 3.3V.  According to ds1307, the voltage of a logical unit is 2.2V, then 3.3V will be completely normal. <br>  <b>7. Watchdog</b> The system uses hardware i2c interface, while waiting for sending / receiving bytes the processor is ‚Äúasleep‚Äù.  In case of failure / disconnection of the ignition at this time - the microcontroller may not wait for the slave‚Äôs response and remain in ‚Äúsleep‚Äù mode.  To eliminate such hangs, the hardware watchdog of the microcontroller is used.  In the main loop, the watchdog is constantly reset.  In the event of a hangup, the main loop stops and the watchdog overflows, sending a reset to the microcontroller.  To determine the nature of the reset (power on or watchdog), a variable is entered into the program that is not initialized during a reset (#pragma NOINIT).  If it is equal to the known value, there was a reset by watchdog. <br>  <b>8. Calibration</b> In principle, calibration can be done already in battle, for example, go at a certain speed over gps.  Typing, for example, 30 km / h - click on the mouthguard, and the speedometer will memorize the measured frequency of the pulses, corresponding to 30 km / h.  But on the back wall there was an interesting inscription: <br><img src="https://habrastorage.org/files/3f7/2dc/0e4/3f72dc0e432f40a3894c0a17381f6e1a.jpg"><br>  Thus 10 pulses of the speed sensor will correspond to one meter traveled by the car.  If there are significant differences in fact - I will make the necessary adjustments. <br>  <b>9. Vibration resistance.</b>  The device is intended for operation in conditions difficult from the point of view of vibration.  On the Internet, I did not find information about the vibration resistance of IN14.  Time, as they say, will tell.  Electrical connections are made by the good old MGTF.  After checking the modules - they were filled with epoxy glue.  By the way, I found in fixprice quite a glue in the double syringe form factor. <br><div class="spoiler">  <b class="spoiler_title">Here are the design elements:</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/b7a/65d/60f/b7a65d60f7cd4ff294e761a868731b44.jpg"><br><img src="https://habrastorage.org/files/201/cde/81d/201cde81d4b64804a0a5df0940baecd6.jpg"><br><img src="https://habrastorage.org/files/916/413/7cf/9164137cfdb6485e8ec133a0075354b8.jpg"><br><img src="https://habrastorage.org/files/c65/887/2c2/c658872c26004c44983010aa6f44f6dd.jpg"><br></div></div><br>  <b>10. Miscellaneous.</b>  Existing mileage saved previously with the above mentioned papers in non-volatile memory.  Speaking of her.  In msp430, nonvolatile memory is organized page by page.  For the user, the first three are available.  The fourth one stores the calibration data of the clock generator.  Saving the readings of the main run meter and two additional reset odometers is done sequentially, filling in alternately the first three pages of flash.  When the end of the third page is reached - the first three pages are erased and the recording starts again from the beginning of the first one.  Thus, the flash resource increases, although the ignition lock resource (saving occurs when the ignition is turned off) is, of course, less than the resource of erasing the flash record. <br>  In the instrument panel: <br><img src="https://habrastorage.org/files/50c/eed/209/50ceed209cdc409fa61bfd0623f369a1.JPG"><br>  In principle, everything.  Waiting for comments and comments.  Archive with source code and the scheme in diptrace <s>by tradition in the picture</s> : <br>  Unfortunately, the updated habrastorage recognizes the archive in the picture and does not allow it to be saved, so here‚Äôs the source code and the schema: <br>  <a href="">dl.dropboxusercontent.com/u/974924/nivaCon2.rar</a> <br>  PS And yes, these IN14 lamps are really 44 years old. <br>  PPS Video on the move could not be removed.  Not enough hands.  Determining the speed checked by GPS.  Deviations ¬± 4 km / h at a speed of 40km / h.  Adequate accuracy. <br><br>  Here's a video: <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/tVqEW57Az5k%3Ffeature%3Doembed&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhue-KO8G3Tm_zAYA_MHmjJp2VZHQ" frameborder="0" allowfullscreen=""></iframe><br>  Filmed like this: <br><img src="https://habrastorage.org/files/e44/cbb/dc8/e44cbbdc80c04407ae47425c5b560c90.jpg"></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/396433/">https://habr.com/ru/post/396433/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../396423/index.html">Why startups fail</a></li>
<li><a href="../396425/index.html">X-rays helped find a hidden medieval library</a></li>
<li><a href="../396427/index.html">Redmi Pro - the first dual camera smartphone from XIAOMI</a></li>
<li><a href="../396429/index.html">Lockheed Martin is developing a minisubmarine to deliver special forces to the battlefield.</a></li>
<li><a href="../396431/index.html">Is it possible to find pokemon in nature?</a></li>
<li><a href="../396435/index.html">The first patient in the USA who was transplanted with both hands wants to get rid of them.</a></li>
<li><a href="../396437/index.html">22 messages of hope (and science) for creationists</a></li>
<li><a href="../396439/index.html">Why are brown dwarfs so dim?</a></li>
<li><a href="../396441/index.html">Because of the lack of confidence in scientists, Italy may lose its olive trees.</a></li>
<li><a href="../396443/index.html">"The Elders of Zion" became another reason for blocking Wikipedia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>