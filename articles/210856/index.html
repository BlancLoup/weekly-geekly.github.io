<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About the performance of Thin Provision in LVM2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Since RHEL 6.4, thin provisioning support has been included in LVM2. I would translate it into Russian as a ‚Äúsubtle reservation‚Äù, although the transla...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About the performance of Thin Provision in LVM2</h1><div class="post__text post__text-html js-mediator-article">  Since RHEL 6.4, thin provisioning support has been included in LVM2.  I would translate it into Russian as a ‚Äúsubtle reservation‚Äù, although the translation is inaccurate and completely inconsistent with reality, therefore, the English spelling will be used along with the Russian. <br><br>  <b>Thin provisioning</b> is the creation of logical volumes that initially use a bit of space and grow as data is written to them.  In ZFS, this has been implemented a long time ago by the very philosophy of this file system.  In VMware, this is used in every product.  It came to LVM2, widely used in Linux today.  Also one of the main innovations is thin snapshots, when for snapshots there is no need to reserve a place in advance, and it ‚Äúgrows‚Äù along with the changed data.  Nested snapshots (snapshots of snapshots with any depth) are also allowed and encouraged, while declaring that there is no performance drop.  A few nuances of use will be discussed in the article. <br><br>  For stable operation, thin provision in LVM2 requires kernel 3.4.  Red Hat is backported and works on their ‚Äúclassic‚Äù 2.6.32. <br>  In close to me, Debian Wheezy thin provisioning is unavailable due to the lack of a key when compiling lvm2 - with-thin = internal and other difficulties.  If necessary, for the purposes of the test, you can compile this package from source. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I was more interested not in the snapshots, but in the performance of ‚Äúthin logical volumes‚Äù (Thin Logical Volume) for use on servers.  For the impatient, I will say straight away - a drop in performance is observed, and a significant one.  Details below. <br><a name="habracut"></a><br>  On the same server with CentOS 6.4 2.6.32-279.2.1.el6.x86_64 on RAID1 made with the help of mdadm, we create a ‚Äúthin pool‚Äù (thin pool): <br><br><pre><code class="bash hljs">lvcreate -L 50G -T /dev/VG/thin_pool</code> </pre> <br>  and the usual logical volume (LV): <br><br><pre> <code class="bash hljs">lvcreate -L 50G /dev/VG/thick_vol</code> </pre> <br><br>  Let's measure the performance of linear reading and writing to these devices: <br><br><h5>  Thin pool: </h5><br><br><h6>  Record: </h6><br><pre> <code class="bash hljs">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/zero of=/dev/mapper/VG-thin_pool bs=1M count=1000 oflag=direct 1000+0 records <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 1000+0 records out 1048576000 bytes (1.0 GB) copied, 15.9126 s, 65.9 MB/s</code> </pre> <br><br><h6>  Reading: </h6><br><pre> <code class="bash hljs">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/mapper/VG-thin_pool of=/dev/null bs=1M count=1000 iflag=direct 1000+0 records <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 1000+0 records out 1048576000 bytes (1.0 GB) copied, 4.19247 s, 250 MB/s</code> </pre> <br><br><h5>  LV: </h5><br><br>  - Record: <pre> <code class="bash hljs">FIO: : iodepth=2, bw=943120 B/s, iops=230, avg=8645.48 usec</code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># dd if=/dev/zero of=/dev/VG/thick_vol bs=1M count=1000 oflag=direct 1000+0 records in 1000+0 records out 1048576000 bytes (1.0 GB) copied, 15.8432 s, 66.2 MB/s</span></span></code> </pre> <br><br>  - Reading: <br><pre> <code class="bash hljs">FIO: : iodepth=2, bw=775490 B/s, iops=189, avg=10536.95 usec</code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># dd if=/dev/VG/thick_vol of=/dev/null bs=1M count=1000 iflag=direct 1000+0 records in 1000+0 records out 1048576000 bytes (1.0 GB) copied, 4.04925 s, 259 MB/s</span></span></code> </pre> <br><br>  As you can see, the performance is the same for LV and thin pool. <br><br><h4>  Create a thin volume (thin logical volume) in the thin pool </h4><br><pre> <code class="bash hljs">lvcreate -V 100G -T -n thin_vol /dev/mapper/VG-thin_pool</code> </pre> <br><br>  Check performance: <br><br><h6>  Record: </h6><br><pre> <code class="bash hljs">FIO: : iodepth=2, bw=1100.5KB/s, iops=275, avg=7241.55 usec</code> </pre> <br><pre> <code class="bash hljs">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/zero of=/dev/mapper/VG-thin_vol bs=1M count=1000 oflag=direct 1000+0 records <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 1000+0 records out 1048576000 bytes (1.0 GB) copied, 38.7505 s, 27.1 MB/s</code> </pre> <br><br><h6>  Reading: </h6><br><pre> <code class="bash hljs">FIO: : iodepth=256, bw=86100KB/s, iops=21524, avg=11860.53 usec</code> </pre> <br><pre> <code class="bash hljs">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/mapper/VG-thin_vol of=/dev/null bs=1M count=1000 iflag=direct 1000+0 records <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 1000+0 records out 1048576000 bytes (1.0 GB) copied, 4.45363 s, 235 MB/s</code> </pre> <br><br>  It is very well seen that the linear recording on the thin volume is 2 times slower than on a regular LV (27.1 MB / s against 66.2 MB / s).  At the same time, the speed of random writing even increases, but for random reading it was not possible to measure the real performance at all - it shows only the level of reading from the cache, while resetting the cache did not help. <br><br>  The drop in performance of the linear recording is alarming and there is a possibility that this is due to the presence of RAID1 from mdadm, so I had to test it on another machine, and also look at the performance at the file system level.  VMware Workstation Debian Wheezy 7.3 3.10-0.bpo.3-amd64 SSD Disk. <br><br>  Check performance: <br><br><h4>  LV: </h4><br><br><h6>  Record: </h6><br><pre> <code class="bash hljs">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/zero of=/delete.img bs=1M count=1000 oflag=direct 1000+0 records <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 1000+0 records out 1048576000 bytes (1.0 GB) copied, 3.49623 s, 300 MB/s</code> </pre> <br><br><h6>  Reading: </h6><br><pre> <code class="bash hljs">FIO: : iodepth=384, bw=158839KB/s, iops=39709, avg= 9.64 msec</code> </pre> <br><pre> <code class="bash hljs">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/delete.img of=/dev/null bs=1M count=1000 iflag=direct 1000+0 records <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 1000+0 records out 1048576000 bytes (1.0 GB) copied, 2.31352 s, 453 MB/s</code> </pre> <br><br><h4>  Thin LV: </h4><br><br><h6>  Record: </h6><br><pre> <code class="bash hljs">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/zero of=/mnt/thin/delete.img bs=1M count=1000 oflag=direct 1000+0 records <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 1000+0 records out 1048576000 bytes (1.0 GB) copied, 7.15546 s, 147 MB/s</code> </pre> <br><br><h6>  Reading: </h6><br><pre> <code class="bash hljs">FIO: : iodepth=384, bw=176574KB/s, iops=44143, avg=8675.36 usec</code> </pre> <br><pre> <code class="bash hljs">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/mnt/thin/delete.img of=/dev/null bs=1M count=1000 iflag=direct 1000+0 records <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 1000+0 records out 1048576000 bytes (1.0 GB) copied, 2.33435 s, 449 MB/s</code> </pre> <br><br>  Random record performance could not be measured. <br>  And again, we observe a drop in the speed of a linear recording twice, as in the previous test.  Perhaps this is due to the nuances of the virtual machine. <br><br>  <b><i>UPDATE:</i></b> Made another test on a ‚Äúclean‚Äù server without RAID and virt.mashin.  There is no drop in linear recording performance!  I apologize to the distinguished audience for misleading the one-sided testing in the first two tests.  As a result, I consider it necessary to test the performance for each specific case. <br><br><h4>  RESULTS: </h4><br><ol><li>  When using thin volume in each particular case, it is necessary to perform linear recording performance testing, since, for example, for RAID 1 with mdadm and VMware virtual machines, the linear recording speed on it drops by 2 times compared to the ‚Äúclassic‚Äù LV; </li><li>  At the same time, a random recording on a thin volume of such a drop did not even notice the speed at the same level as for LV; </li><li>  On Debian, I‚Äôll not use production in the meantime due to the lack of standard repositories; </li></ol></div><p>Source: <a href="https://habr.com/ru/post/210856/">https://habr.com/ru/post/210856/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../210844/index.html">Writing high-load corporate solutions on SharePoint</a></li>
<li><a href="../210846/index.html">Russian domain space: results of 2013</a></li>
<li><a href="../210850/index.html">Benefits of Cloud Hosting - Infographics</a></li>
<li><a href="../210852/index.html">New Garmin: for dogs, thrill-seekers and motorists</a></li>
<li><a href="../210854/index.html">Google has provided a tool to transfer Chrome applications to Android</a></li>
<li><a href="../210858/index.html">Disabling ASLR when debugging third-party iOS apps</a></li>
<li><a href="../210860/index.html">Work with a basket. ImageCMS Cart API</a></li>
<li><a href="../210862/index.html">Video recordings of the Happu New Front-End conference reports: On the frontend in a new way</a></li>
<li><a href="../210864/index.html">How to read a patent in one minute</a></li>
<li><a href="../210866/index.html">PHDays CTF Quals Summary</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>