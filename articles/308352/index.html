<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Testing RESTful API on NodeJS with Mocha and Chai</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Translation guide Samuele Zaza . The text of the original article can be found here . 


 I still remember the delight of the possibility of finally w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Testing RESTful API on NodeJS with Mocha and Chai</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/a77/659/c69/a77659c696e644949d91dcc81f16caec.png"></p><br><p>  Translation guide <a href="https://pub.scotch.io/%40samuxyz">Samuele Zaza</a> .  The text of the original article can be found <a href="https://scotch.io/tutorials/test-a-node-restful-api-with-mocha-and-chai">here</a> . </p><br><p>  I still remember the delight of the possibility of finally writing the backend of a large project on a node, and I am sure that many people share my feelings. </p><br><p>  What's next?  We must be sure that our application behaves as we expect.  One of the most common ways to achieve this is with tests.  Testing is an incredibly useful thing when we add a new feature to the application: the presence of an already installed and configured test environment, which can be started by one team, helps to understand where a new fig will generate new bugs. <a name="habracut"></a><br>  We have previously discussed the development of the <a href="https://scotch.io/tutorials/build-a-restful-api-using-node-and-express-4">RESTful Node API</a> and <a href="https://scotch.io/tutorials/authenticate-a-node-js-api-with-json-web-tokens">Node API authentication</a> .  In this tutorial, we will write a simple RESTful API and use <a href="https://mochajs.org/">Mocha</a> and <a href="http://chaijs.com/">Chai</a> to test it.  We will test CRUD for the book deposit app. </p><br><p>  As always, you can do everything in steps, reading the manual, or download the source code on <a href="https://github.com/samuxyz/bookstore">github</a> . </p><br><h1>  Mocha: Test Environment </h1><br><p>  Mocha is a javascript framework for Node.js, which allows asynchronous testing.  Let's just say: it creates an environment in which we can use our favorite assert libraries. </p><br><p><img src="https://habrastorage.org/files/378/f79/68c/378f7968cf424bacb8169767a0ec9db4.png"></p><br><p>  Mocha comes with a huge amount of features.  The site has a huge list of them.  Most of all I like the following: </p><br><ul><li>  simple asynchronous support, including promise </li><li>  support for asynchronous execution timeouts </li><li> <code>after</code> , <code>after</code> , <code>after</code> <code>before each</code> , <code>after each</code> hooks (very useful for cleaning the environment before the tests) </li><li>  use any assertion library you visit (in our case Chai) </li></ul><br><h1>  Chai: assertion library </h1><br><p>  So, with Mocha, we have an environment to perform our tests, but how will we test HTTP requests, for example?  Moreover, how to verify that the GET request returned the expected JSON to the response, depending on the parameters passed?  We need an assertion library, because mocha is obviously not enough. </p><br><p>  For this tutorial, I chose Chai: </p><br><p><img src="https://habrastorage.org/files/d8c/fa1/a9c/d8cfa1a9c5854362a42cf7746d1d0d09.png"></p><br><p>  Chai gives us a set of interface choices: "should", "expect", "assert".  I personally use should, but you can choose any.  In addition, Chai has a plugin Chai HTTP, which allows you to easily test HTTP requests. </p><br><h2>  PREREQUISITES </h2><br><ul><li>  <em>Node.js</em> : a basic understanding of node.js and a basic understanding of the RESTful API (I won't go deep into the implementation details) is recommended. </li><li>  <em>POSTMAN</em> to execute API requests. </li><li>  <em>Syntax ES6</em> : I decided to use the latest version of Node (6 <em>..</em> ), In which the integration of ES6 features is well implemented for better readability of the code.  If you are not yet very friendly with ES6, you can read excellent articles ( <a href="https://scotch.io/tutorials/better-node-with-es6-pt-i">Pt.1</a> , <a href="https://scotch.io/tutorials/better-javascript-with-es6-pt-ii-a-deep-dive-into-classes">Pt.2</a> and <a href="https://scotch.io/tutorials/better-javascript-with-es6-pt-iii-cool-collections-slicker-strings">Pt.3</a> ).  But do not worry, I will give explanations when some special syntax is encountered. </li></ul><br><p>  It is time to set up our book depository. </p><br><h1>  Project Setup </h1><br><h2>  Folder structure </h2><br><p>  The project structure will be as follows: </p><br><pre> <code class="bash hljs">-- controllers ---- models ------ book.js ---- routes ------ book.js -- config ---- default.json ---- dev.json ---- test.json -- <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> ---- book.js package.json server.json</code> </pre> <br><p>  Please note that the <code>/config</code> folder contains 3 JSON files: as the name implies, they contain settings for different environments. </p><br><p>  In this tutorial, we will switch between two databases ‚Äî one for development, the other for testing.  Thus, the files will contain mongodb URI in JSON format: </p><br><p>  <code>dev.json</code> and <code>default.json</code> : </p><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"DBHost"</span></span>: <span class="hljs-string"><span class="hljs-string">"YOUR_DB_URI"</span></span> }</code> </pre> <br><p>  <code>test.json</code> : </p><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"DBHost"</span></span>: <span class="hljs-string"><span class="hljs-string">"YOUR_TEST_DB_URI"</span></span> }</code> </pre> <br><p>  More about the configuration files (config folder, file order, file format) can be read [here] ( <a href="https://github.com/lorenwest/node-config/wiki/Configuration-Files">https://github.com/lorenwest/node-config/wiki/Configuration-Files</a> ). </p><br><p>  Pay attention to the file <code>/test/book.js</code> , which will be all our tests. </p><br><h2>  package.json </h2><br><p>  Create a <code>package.json</code> file and paste in the following: </p><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"bookstore"</span></span>, <span class="hljs-string"><span class="hljs-string">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"A bookstore API"</span></span>, <span class="hljs-string"><span class="hljs-string">"main"</span></span>: <span class="hljs-string"><span class="hljs-string">"server.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"author"</span></span>: <span class="hljs-string"><span class="hljs-string">"Sam"</span></span>, <span class="hljs-string"><span class="hljs-string">"license"</span></span>: <span class="hljs-string"><span class="hljs-string">"ISC"</span></span>, <span class="hljs-string"><span class="hljs-string">"dependencies"</span></span>: { <span class="hljs-string"><span class="hljs-string">"body-parser"</span></span>: <span class="hljs-string"><span class="hljs-string">"^1.15.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"config"</span></span>: <span class="hljs-string"><span class="hljs-string">"^1.20.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"express"</span></span>: <span class="hljs-string"><span class="hljs-string">"^4.13.4"</span></span>, <span class="hljs-string"><span class="hljs-string">"mongoose"</span></span>: <span class="hljs-string"><span class="hljs-string">"^4.4.15"</span></span>, <span class="hljs-string"><span class="hljs-string">"morgan"</span></span>: <span class="hljs-string"><span class="hljs-string">"^1.7.0"</span></span> }, <span class="hljs-string"><span class="hljs-string">"devDependencies"</span></span>: { <span class="hljs-string"><span class="hljs-string">"chai"</span></span>: <span class="hljs-string"><span class="hljs-string">"^3.5.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"chai-http"</span></span>: <span class="hljs-string"><span class="hljs-string">"^2.0.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"mocha"</span></span>: <span class="hljs-string"><span class="hljs-string">"^2.4.5"</span></span> }, <span class="hljs-string"><span class="hljs-string">"scripts"</span></span>: { <span class="hljs-string"><span class="hljs-string">"start"</span></span>: <span class="hljs-string"><span class="hljs-string">"SET NODE_ENV=dev &amp;&amp; node server.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"test"</span></span>: <span class="hljs-string"><span class="hljs-string">"mocha --timeout 10000"</span></span> } }</code> </pre> <br><p>  Again, nothing new for someone who has written at least one server on node.js.  The <code>mocha</code> , <code>chai</code> , <code>chai-http</code> packages required for testing are installed in the <code>dev-dependencies</code> block (the <code>--save-dev</code> flag from the command line). <br>  The <code>scripts</code> block contains two ways to start the server. </p><br><p>  For mocha, I added the <code>--timeout 10000</code> flag, because I am picking up data from the base located on mongolab and being released two seconds by default may not be enough. </p><br><p>  Hooray!  We finished the boring part of the manual and it‚Äôs time to write a server and test it. </p><br><h1>  Server </h1><br><p>  Let's create a <code>server.js</code> file and <code>server.js</code> following code: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> express = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'express'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> app = express(); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> mongoose = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'mongoose'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> morgan = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'morgan'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> bodyParser = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'body-parser'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> port = <span class="hljs-number"><span class="hljs-number">8080</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> book = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./app/routes/book'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'config'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//      //  let options = { server: { socketOptions: { keepAlive: 1, connectTimeoutMS: 30000 } }, replset: { socketOptions: { keepAlive: 1, connectTimeoutMS : 30000 } } }; //   mongoose.connect(config.DBHost, options); let db = mongoose.connection; db.on('error', console.error.bind(console, 'connection error:')); //      if(config.util.getEnv('NODE_ENV') !== 'test') { //morgan      app.use(morgan('combined')); //'combined'     apache } // application/json app.use(bodyParser.json()); app.use(bodyParser.urlencoded({extended: true})); app.use(bodyParser.text()); app.use(bodyParser.json({ type: 'application/json'})); app.get("/", (req, res) =&gt; res.json({message: "Welcome to our Bookstore!"})); app.route("/book") .get(book.getBooks) .post(book.postBook); app.route("/book/:id") .get(book.getBook) .delete(book.deleteBook) .put(book.updateBook); app.listen(port); console.log("Listening on port " + port); module.exports = app; //  </span></span></code> </pre> <br><p>  Highlights: </p><br><ul><li>  We need a <code>config</code> module to access the configuration file in accordance with the environment variable NODE_ENV.  From it we get the mongo db URI to connect to the database.  This will allow us to keep the main database clean, and conduct tests on a separate base, hidden from users. </li><li>  The environment variable NODE_ENV is checked for the value "test" to disable the <a href="https://www.npmjs.com/package/morgan">morgan</a> logs on the command line, otherwise they will appear in the output when running the tests. </li><li>  The last line exports the server for tests. </li><li>  Pay attention to the declaration of variables through the <code>let</code> .  It makes the variable visible only within the closure block or globally if it is outside the block. </li></ul><br><p>  The rest is nothing new: we simply connect the necessary modules, define the settings for interacting with the server, create entry points and start the server on a specific port. </p><br><h2>  Models and Routing </h2><br><p>  It is time to describe the model of the book.  Create a <code>book.js</code> file in the <code>/app/model/</code> folder with the following contents: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> mongoose = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'mongoose'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> Schema = mongoose.Schema; <span class="hljs-comment"><span class="hljs-comment">//   let BookSchema = new Schema( { title: { type: String, required: true }, author: { type: String, required: true }, year: { type: Number, required: true }, pages: { type: Number, required: true, min: 1 }, createdAt: { type: Date, default: Date.now }, }, { versionKey: false } ); //   createdAt    BookSchema.pre('save', next =&gt; { now = new Date(); if(!this.createdAt) { this.createdAt = now; } next(); }); //    . module.exports = mongoose.model('book', BookSchema);</span></span></code> </pre> <br><p>  Our book has a title, author, number of pages, year of publication and date of creation in the database.  I set the <code>versionKey</code> option to <code>false</code> , since it is not needed in this guide. </p><br><p>  An unusual callback in .pre () is a shooter function, a function with a shorter syntax.  According to the definition of <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions">MDN</a> : "binds to the current value of <code>this</code> (does not have its own <code>this</code> , <code>arguments</code> , <code>super</code> , or <code>new.target</code> ). The arrow functions are always anonymous." </p><br><p>  Great, now we know everything we need about the model and go to the routes. </p><br><p>  In the folder <code>/app/routes/</code> create a <code>book.js</code> file <code>book.js</code> following contents: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> mongoose = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'mongoose'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> Book = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../models/book'</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* * GET /book      . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBooks</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    ,   ,     let query = Book.find({}); query.exec((err, books) =&gt; { if(err) res.send(err); //  ,   res.json(books); }); } /* * POST /book    . */ function postBook(req, res) { //   var newBook = new Book(req.body); //  . newBook.save((err,book) =&gt; { if(err) { res.send(err); } else { //  ,    res.json({message: "Book successfully added!", book }); } }); } /* * GET /book/:id      ID. */ function getBook(req, res) { Book.findById(req.params.id, (err, book) =&gt; { if(err) res.send(err); //  ,    res.json(book); }); } /* * DELETE /book/:id      ID. */ function deleteBook(req, res) { Book.remove({_id : req.params.id}, (err, result) =&gt; { res.json({ message: "Book successfully deleted!", result }); }); } /* * PUT /book/:id      ID */ function updateBook(req, res) { Book.findById({_id: req.params.id}, (err, book) =&gt; { if(err) res.send(err); Object.assign(book, req.body).save((err, book) =&gt; { if(err) res.send(err); res.json({ message: 'Book updated!', book }); }); }); } //   module.exports = { getBooks, postBook, getBook, deleteBook, updateBook };</span></span></code> </pre> <br><p>  Highlights: </p><br><ul><li>  All routes are standard GET, POST, DELETE, PUT to perform CRUD. </li><li>  In the updatedBook () function, we use <code>Object.assign</code> , a new ES6 function that overwrites the general properties of <code>book</code> and <code>req.body</code> and leaves the <code>req.body</code> intact. </li><li>  In the end, we export the object using the syntax "short property" (in Russian you can read <a href="http://learn.javascript.ru/es-object">here</a> , approx. Translator) so as not to do repetitions. </li></ul><br><p>  We finished this part and got the finished application! </p><br><h1>  Naive testing </h1><br><p>  Let's run our application, open POSTMAN to send HTTP requests to the server and check that everything works as expected. </p><br><p>  On the command line, we will </p><br><pre> <code class="bash hljs">npm start</code> </pre> <br><h2>  GET / BOOK </h2><br><p>  In POSTMAN, we will execute a GET request and, if we assume that there are books in the database, we will get the answer: <br><img src="https://habrastorage.org/files/a20/5e0/d74/a205e0d743874328bd88f1fd9959131f.png">  : </p><br><p>  Server without errors returned books from the database. </p><br><h2>  POST / BOOK </h2><br><p>  Let's add a new book: </p><br><p><img src="https://habrastorage.org/files/116/5bb/06a/1165bb06ab8640c9b1ccd52602958c05.png"></p><br><p>  It looks like the book has been added.  The server returned the book and a message confirming that it was added.  Is it so?  Perform another GET request and see the result: </p><br><p><img src="https://cdn.scotch.io/144/DMfg6tELQ3uqMRC4cbuD_getbook2.png"></p><br><p>  Works! </p><br><h2>  PUT / BOOK /: ID </h2><br><p>  Let's change the number of pages in the book and look at the result: </p><br><p><img src="https://habrastorage.org/files/51e/d23/ccd/51ed23ccdcb247489b3a997cec4c4dc8.png"></p><br><p>  Fine!  PUT also works, so you can perform another GET request to check </p><br><p><img src="https://habrastorage.org/files/6b9/3e4/29c/6b93e429c3be4c71bcc91723bca3ccc1.png"></p><br><p>  Everything is working... </p><br><h2>  GET / BOOK /: ID </h2><br><p>  Now we will get one book by ID in the GET request and then delete it: </p><br><p><img src="https://habrastorage.org/files/b03/2e0/da6/b032e0da69814e8b874ba6666facf93e.png"></p><br><p>  Received the correct answer and now delete this book: </p><br><h2>  DELETE / BOOK /: ID </h2><br><p>  Let's look at the removal result: </p><br><p><img src="https://habrastorage.org/files/192/9b7/ae0/1929b7ae07674926966fd8f474630507.png"></p><br><p>  Even the last request works as planned and we don‚Äôt even need to make another GET request for verification, since we sent the client a response from mongo (result property), which indicates that the book was really deleted. </p><br><p>  When running a test through POSTMAN, the application behaves as expected, right?  So you can use it on the client? </p><br><p>  Let me answer you: <strong>NO</strong> !! </p><br><p>  I call our actions naive testing, because we performed only a few operations without taking into account controversial cases: POST request without expected data, DELETE with invalid id or no id at all. </p><br><p>  Obviously this is a simple application and, if we are lucky, we have not made any mistakes, but what about real applications?  Moreover, we spent time launching some test HTTP requests in POSTMAN.  And what happens if one day we decide to change the code of one of them?  Again, check everything in POSTMAN? </p><br><p>  These are just a few situations that you may encounter or have already encountered as a developer.  Fortunately, we have the tools to create tests that are always available;  they can be run by a single command from the console. </p><br><p>  Let's do something better to test our application. </p><br><h1>  Good testing </h1><br><p>  First, let's create the <code>books.js</code> file in the <code>/test</code> folder: </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//During the test the env variable is set to test process.env.NODE_ENV = 'test'; let mongoose = require("mongoose"); let Book = require('../app/models/book'); // dev-dependencies let chai = require('chai'); let chaiHttp = require('chai-http'); let server = require('../server'); let should = chai.should(); chai.use(chaiHttp); //   describe('Books', () =&gt; { beforeEach((done) =&gt; { //     Book.remove({}, (err) =&gt; { done(); }); }); /* *   /GET */ describe('/GET book', () =&gt; { it('it should GET all the books', (done) =&gt; { chai.request(server) .get('/book') .end((err, res) =&gt; { res.should.have.status(200); res.body.should.be.a('array'); res.body.length.should.be.eql(0); done(); }); }); }); });</span></span></code> </pre> <br><p>  How many new pieces!  Let's figure it out: </p><br><ul><li>  Be sure to pay attention to the variable NODE_ENV which we assigned the value test.  This will allow the server to load the config for the test database and not output <code>morgan</code> logs to the console. </li><li>  We connected dev-dependencies and the server itself (we exported it via module.exports). </li><li>  We connected <code>chaiHttp</code> to <code>chai</code> . </li></ul><br><p>  It all starts with the <code>describe</code> block, which is used to improve the structuring of our statements.  This will affect the output, as we will see later. </p><br><p>  <code>beforeEach</code> is the block that will be executed for each block described in this <code>describe</code> block.  What are we doing this for?  We delete all books from the database so that the base is empty at the beginning of each test. </p><br><h2>  Testing / GET </h2><br><p>  So, we have the first test.  Chai executes the GET request and checks that the variable <code>res</code> satisfies the first parameter (statement) of the <code>it</code> "it should GET all the books" block.  Namely, for this empty book depository, the answer should be as follows: </p><br><ul><li>  Status 200. </li><li>  The result must be an array. </li><li>  Since the base is empty, we expect the size of the array to be 0. </li></ul><br><p>  Note that the should syntax is intuitive and very similar to spoken language. </p><br><p>  Terer command line vypon: </p><br><pre> <code class="bash hljs">npm <span class="hljs-built_in"><span class="hljs-built_in">test</span></span></code> </pre> <br><p>  and get: <br><img src="https://habrastorage.org/files/5c7/981/382/5c7981382cd348418f260fb55d4a4edb.png"></p><br><p>  The test passed and the output reflects the structure we described using the <code>describe</code> blocks. </p><br><h2>  Testing / POST </h2><br><p>  Now let's check how good our API is.  Suppose we are trying to add a book without the `pages: field: the server should not return an appropriate error. </p><br><p>  Add this code to the end of the <code>describe('Books')</code> block: </p><br><pre> <code class="javascript hljs">describe(<span class="hljs-string"><span class="hljs-string">'/POST book'</span></span>, () =&gt; { it(<span class="hljs-string"><span class="hljs-string">'it should not POST a book without pages field'</span></span>, (done) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> book = { <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">"The Lord of the Rings"</span></span>, <span class="hljs-attr"><span class="hljs-attr">author</span></span>: <span class="hljs-string"><span class="hljs-string">"JRR Tolkien"</span></span>, <span class="hljs-attr"><span class="hljs-attr">year</span></span>: <span class="hljs-number"><span class="hljs-number">1954</span></span> } chai.request(server) .post(<span class="hljs-string"><span class="hljs-string">'/book'</span></span>) .send(book) .end(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, res</span></span></span><span class="hljs-function">) =&gt;</span></span> { res.should.have.status(<span class="hljs-number"><span class="hljs-number">200</span></span>); res.body.should.be.a(<span class="hljs-string"><span class="hljs-string">'object'</span></span>); res.body.should.have.property(<span class="hljs-string"><span class="hljs-string">'errors'</span></span>); res.body.errors.should.have.property(<span class="hljs-string"><span class="hljs-string">'pages'</span></span>); res.body.errors.pages.should.have.property(<span class="hljs-string"><span class="hljs-string">'kind'</span></span>).eql(<span class="hljs-string"><span class="hljs-string">'required'</span></span>); done(); }); }); });</code> </pre><br><p>  Here we added a test for incomplete / POST request.  Let's look at the checks: </p><br><ul><li>  Status must be 200. </li><li>  The response body must be an object. </li><li>  One of the properties of the response body should be <code>errors</code> . </li><li>  The <code>errors</code> field should have a <code>pages</code> property missing in the request. </li><li>  <code>pages</code> must have a <code>kind</code> property equal to <code>required</code> to show the reason why we received a negative response from the server. </li></ul><br><p>  Note that we sent the book data using the .send () method. </p><br><p>  Let's execute the command again and look at the output: </p><br><p><img src="https://habrastorage.org/files/0ee/989/0b9/0ee9890b9fcf45f989f58ebc77b32a1d.png"></p><br><p>  The test works !! </p><br><p>  Before writing the following test, let's clarify a couple of things: </p><br><ul><li>  First, why does the response from the server have such a structure?  If you read the <code>callback</code> for the route / POST, then you saw that in case of an error, the server sends an error from <code>mongoose</code> in response.  Try it through POSTMAN and look at the answer. </li><li>  In the event of an error, we still respond with code 200. This is done for simplicity, as we are just learning to test our API. </li></ul><br><p>  However, I would suggest giving back the status of <em>206 Partial Content instead</em> </p><br><p>  Let's send the correct request.  Paste the following code at the end of the <code>describe(''/POST book'')</code> block <code>describe(''/POST book'')</code> : </p><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">'it should POST a book '</span></span>, (done) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> book = { <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">"The Lord of the Rings"</span></span>, <span class="hljs-attr"><span class="hljs-attr">author</span></span>: <span class="hljs-string"><span class="hljs-string">"JRR Tolkien"</span></span>, <span class="hljs-attr"><span class="hljs-attr">year</span></span>: <span class="hljs-number"><span class="hljs-number">1954</span></span>, <span class="hljs-attr"><span class="hljs-attr">pages</span></span>: <span class="hljs-number"><span class="hljs-number">1170</span></span> } chai.request(server) .post(<span class="hljs-string"><span class="hljs-string">'/book'</span></span>) .send(book) .end(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, res</span></span></span><span class="hljs-function">) =&gt;</span></span> { res.should.have.status(<span class="hljs-number"><span class="hljs-number">200</span></span>); res.body.should.be.a(<span class="hljs-string"><span class="hljs-string">'object'</span></span>); res.body.should.have.property(<span class="hljs-string"><span class="hljs-string">'message'</span></span>).eql(<span class="hljs-string"><span class="hljs-string">'Book successfully added!'</span></span>); res.body.book.should.have.property(<span class="hljs-string"><span class="hljs-string">'title'</span></span>); res.body.book.should.have.property(<span class="hljs-string"><span class="hljs-string">'author'</span></span>); res.body.book.should.have.property(<span class="hljs-string"><span class="hljs-string">'pages'</span></span>); res.body.book.should.have.property(<span class="hljs-string"><span class="hljs-string">'year'</span></span>); done(); }); });</code> </pre><br><p>  This time we expect an object telling us that the book has been added successfully and the book itself.  You should already be familiar with the checks, so there is no need to go into details. </p><br><p>  Run the command again and get: </p><br><p><img src="https://habrastorage.org/files/633/26b/7f1/63326b7f1df949998ef4ed700e8545be.png"></p><br><h2>  Testing / GET /: ID </h2><br><p>  Now we will create a book, save it in the database and use the id to execute the GET request.  Add the following block: </p><br><pre> <code class="javascript hljs">describe(<span class="hljs-string"><span class="hljs-string">'/GET/:id book'</span></span>, () =&gt; { it(<span class="hljs-string"><span class="hljs-string">'it should GET a book by the given id'</span></span>, (done) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> book = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Book({ <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">"The Lord of the Rings"</span></span>, <span class="hljs-attr"><span class="hljs-attr">author</span></span>: <span class="hljs-string"><span class="hljs-string">"JRR Tolkien"</span></span>, <span class="hljs-attr"><span class="hljs-attr">year</span></span>: <span class="hljs-number"><span class="hljs-number">1954</span></span>, <span class="hljs-attr"><span class="hljs-attr">pages</span></span>: <span class="hljs-number"><span class="hljs-number">1170</span></span> }); book.save(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, book</span></span></span><span class="hljs-function">) =&gt;</span></span> { chai.request(server) .get(<span class="hljs-string"><span class="hljs-string">'/book/'</span></span> + book.id) .send(book) .end(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, res</span></span></span><span class="hljs-function">) =&gt;</span></span> { res.should.have.status(<span class="hljs-number"><span class="hljs-number">200</span></span>); res.body.should.be.a(<span class="hljs-string"><span class="hljs-string">'object'</span></span>); res.body.should.have.property(<span class="hljs-string"><span class="hljs-string">'title'</span></span>); res.body.should.have.property(<span class="hljs-string"><span class="hljs-string">'author'</span></span>); res.body.should.have.property(<span class="hljs-string"><span class="hljs-string">'pages'</span></span>); res.body.should.have.property(<span class="hljs-string"><span class="hljs-string">'year'</span></span>); res.body.should.have.property(<span class="hljs-string"><span class="hljs-string">'_id'</span></span>).eql(book.id); done(); }); }); }); });</code> </pre><br><p>  Through asserts we made sure that the server returned all the fields and the required book (the id in the response from the north coincides with the requested one): </p><br><p><img src="https://habrastorage.org/files/28b/2ca/0ac/28b2ca0acd664da392bdbff7cfd78605.png"></p><br><p>  Have you noticed that in testing individual routes inside independent blocks we got a very clean conclusion?  Besides, this is effective: we wrote several tests that can be repeated using one command. </p><br><h2>  Testing / PUT /: ID </h2><br><p>  It is time to check the editing of one of our books.  First, we will save the book in the database, and then we will issue a query to change the year of its publication. </p><br><pre> <code class="javascript hljs">describe(<span class="hljs-string"><span class="hljs-string">'/PUT/:id book'</span></span>, () =&gt; { it(<span class="hljs-string"><span class="hljs-string">'it should UPDATE a book given the id'</span></span>, (done) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> book = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Book({<span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">"The Chronicles of Narnia"</span></span>, <span class="hljs-attr"><span class="hljs-attr">author</span></span>: <span class="hljs-string"><span class="hljs-string">"CS Lewis"</span></span>, <span class="hljs-attr"><span class="hljs-attr">year</span></span>: <span class="hljs-number"><span class="hljs-number">1948</span></span>, <span class="hljs-attr"><span class="hljs-attr">pages</span></span>: <span class="hljs-number"><span class="hljs-number">778</span></span>}) book.save(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, book</span></span></span><span class="hljs-function">) =&gt;</span></span> { chai.request(server) .put(<span class="hljs-string"><span class="hljs-string">'/book/'</span></span> + book.id) .send({<span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">"The Chronicles of Narnia"</span></span>, <span class="hljs-attr"><span class="hljs-attr">author</span></span>: <span class="hljs-string"><span class="hljs-string">"CS Lewis"</span></span>, <span class="hljs-attr"><span class="hljs-attr">year</span></span>: <span class="hljs-number"><span class="hljs-number">1950</span></span>, <span class="hljs-attr"><span class="hljs-attr">pages</span></span>: <span class="hljs-number"><span class="hljs-number">778</span></span>}) .end(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, res</span></span></span><span class="hljs-function">) =&gt;</span></span> { res.should.have.status(<span class="hljs-number"><span class="hljs-number">200</span></span>); res.body.should.be.a(<span class="hljs-string"><span class="hljs-string">'object'</span></span>); res.body.should.have.property(<span class="hljs-string"><span class="hljs-string">'message'</span></span>).eql(<span class="hljs-string"><span class="hljs-string">'Book updated!'</span></span>); res.body.book.should.have.property(<span class="hljs-string"><span class="hljs-string">'year'</span></span>).eql(<span class="hljs-number"><span class="hljs-number">1950</span></span>); done(); }); }); }); });</code> </pre> <br><p>  We want to make sure the <code>message</code> field is <code>Book updated!</code>  and the <code>year</code> field has really changed. </p><br><p><img src="https://habrastorage.org/files/14d/e4c/c44/14de4cc44f0a4b0594d25dd5be70f9be.png"></p><br><p>  We are almost done. </p><br><p>  Test / DELETE /: ID. </p><br><p>  The template is very similar to the previous test: first we create a book, then we delete it using the request and check the answer: </p><br><pre> <code class="javascript hljs">describe(<span class="hljs-string"><span class="hljs-string">'/DELETE/:id book'</span></span>, () =&gt; { it(<span class="hljs-string"><span class="hljs-string">'it should DELETE a book given the id'</span></span>, (done) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> book = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Book({<span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">"The Chronicles of Narnia"</span></span>, <span class="hljs-attr"><span class="hljs-attr">author</span></span>: <span class="hljs-string"><span class="hljs-string">"CS Lewis"</span></span>, <span class="hljs-attr"><span class="hljs-attr">year</span></span>: <span class="hljs-number"><span class="hljs-number">1948</span></span>, <span class="hljs-attr"><span class="hljs-attr">pages</span></span>: <span class="hljs-number"><span class="hljs-number">778</span></span>}) book.save(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, book</span></span></span><span class="hljs-function">) =&gt;</span></span> { chai.request(server) .delete(<span class="hljs-string"><span class="hljs-string">'/book/'</span></span> + book.id) .end(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, res</span></span></span><span class="hljs-function">) =&gt;</span></span> { res.should.have.status(<span class="hljs-number"><span class="hljs-number">200</span></span>); res.body.should.be.a(<span class="hljs-string"><span class="hljs-string">'object'</span></span>); res.body.should.have.property(<span class="hljs-string"><span class="hljs-string">'message'</span></span>).eql(<span class="hljs-string"><span class="hljs-string">'Book successfully deleted!'</span></span>); res.body.result.should.have.property(<span class="hljs-string"><span class="hljs-string">'ok'</span></span>).eql(<span class="hljs-number"><span class="hljs-number">1</span></span>); res.body.result.should.have.property(<span class="hljs-string"><span class="hljs-string">'n'</span></span>).eql(<span class="hljs-number"><span class="hljs-number">1</span></span>); done(); }); }); }); });</code> </pre><br><p>  Again the server will return to us the answer from <code>mongoose</code> , which we check.  The console will have the following: </p><br><p><img src="https://habrastorage.org/files/d36/f42/da4/d36f42da44854bb184eacfb1130f9abd.png"></p><br><p>  Amazing!  Our tests pass and we have an excellent base for testing our API with the help of more sophisticated checks. </p><br><h1>  Conclusion </h1><br><p>  In this lesson, we faced the challenge of testing our routes in order to provide our users with a stable API. </p><br><p>  We went through all the steps of creating a RESTful API, doing naive tests with POSTMAN, and then offered the best way to test our main goal. </p><br><p>  Writing tests is a good habit to ensure server stability.  Unfortunately, this is often underestimated. </p><br><h1>  Bonus: Mockgoose </h1><br><p>  There will always be someone who says that two bases are not the best solution, but there is no other.  And what to do?  The alternative is: Mockgoose. </p><br><p>  In essence, <a href="https://github.com/mccormicka/Mockgoose">Mockgoose</a> creates a wrapper for Mongoose, which intercepts calls to the database and instead uses in-memory storage.  It also integrates easily with mocha. </p><br><p>  <em>Note: Mockgoose requires mongodb to be installed on the machine where the tests are run.</em> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/308352/">https://habr.com/ru/post/308352/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../308340/index.html">What to prefer: own resources, purchase or outsourcing?</a></li>
<li><a href="../308342/index.html">One day in the life of a local positioning system tester</a></li>
<li><a href="../308346/index.html">Optimizing the comparison of this with a null pointer in gcc 6.1</a></li>
<li><a href="../308348/index.html">Problem solution: how to fix a ‚Äúbroken‚Äù VPS on Linux</a></li>
<li><a href="../308350/index.html">Hyper-V or KVM?</a></li>
<li><a href="../308356/index.html">[Poll] And that's about neural networks, AI, etc.</a></li>
<li><a href="../308360/index.html">British Higher School of Design and MBLTdev will present a track for designers</a></li>
<li><a href="../308362/index.html">How Emoji can improve your code (actually)</a></li>
<li><a href="../308366/index.html">New players in the Russian online ad marketplace are trying to compete with Avito</a></li>
<li><a href="../308368/index.html">Simple technology that increases conversion from mobile traffic</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>