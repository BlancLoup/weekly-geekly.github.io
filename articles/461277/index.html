<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Overview of the free SQLIndexManager tool</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As you know, indexes play an important role in the DBMS, providing a quick search of the necessary records. Therefore, it is so important to service t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Overview of the free SQLIndexManager tool</h1><div class="post__text post__text-html js-mediator-article">  As you know, indexes play an important role in the DBMS, providing a quick search of the necessary records.  Therefore, it is so important to service them in a timely manner.  Quite a lot of material has been written about analysis and optimization, including on the Internet.  For example, a recent review of this topic in <a href="https://towardsdatascience.com/sql-server-index-analysis-and-optimization-1edd84d9da">this publication was made</a> . <br><br>  There are many both paid and free solutions for this.  For example, there is a turnkey <a href="https://github.com/Microsoft/tigertoolbox/tree/master/AdaptiveIndexDefrag">solution</a> based on an adaptive index optimization method. <br><br>  Next, consider the free <a href="https://github.com/sergeysyrovatchenko/SQLIndexManager">SQLIndexManager</a> utility, authored by <a href="https://habr.com/ru/users/alandenton/" class="user_link">AlanDenton</a> . <br><a name="habracut"></a><br>  The main technical difference between SQLIndexManager and a number of other analogues is made by the author himself <a href="https://habr.com/ru/post/459914/">here</a> and <a href="https://www.codeproject.com/Articles/5162340/SQL-Index-Manager-Free-GUI-Tool-for-Index-Maintena">here</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the same article, we take a look at the project and the possibilities of using this software solution. <br><br>  Discuss this utility <a href="https://www.sql.ru/forum/1312218-1/sql-index-manager-besplatnaya-utilita-po-obsluzhivaniu-indeksov-dlya-sql-server-i-azure">here</a> . <br>  Over time, most of the comments and bugs have been fixed. <br><br>  So, now let's move on to the SQLIndexManager utility itself. <br><br>  The application is written in C # .NET Framework 4.5 in Visual Studio 2017 and uses DevExpress for forms: <br><br> <a href=""><img src="https://habrastorage.org/webt/i0/wo/do/i0wodozvszemgmmash24snfzrgk.jpeg"></a> <br><br>  and looks like this: <br><br> <a href=""><img src="https://habrastorage.org/webt/xc/mf/ac/xcmfacmb7wxiz5pfvg5m2ybyet4.jpeg"></a> <br><br>  All requests are generated in the following files: <br><br><ol><li>  Index </li><li>  Query </li><li>  Queryengine </li><li>  ServerInfo </li></ol><br> <a href=""><img src="https://habrastorage.org/webt/ya/ox/fo/yaoxfojk1yhfujv5nhu8wxfjx64.jpeg"></a> <br><br>  When connecting to the database and sending requests to the DBMS, the application is signed as follows: <br><br><pre><code class="1c hljs">ApplicationName=‚ÄùSQLIndexManager‚Äù</code> </pre> <br>  When the application starts, a modal window opens to add a connection: <br> <a href=""><img src="https://habrastorage.org/webt/77/kw/uh/77kwuhjmxnartbvfvmpnk8fpi7k.jpeg"></a> <br><br>  Here loading of the complete list of all instances of MS SQL Server available over local networks does not work yet. <br><br>  You can also add a connection using the leftmost button on the main menu: <br><br> <a href=""><img src="https://habrastorage.org/webt/id/l0/w_/idl0w_a4afakmyqmegzbrbomksc.jpeg"></a> <br><br>  Next, the following DBMS queries will be launched: <br><br><ol><li><div class="spoiler">  <b class="spoiler_title">Obtaining DBMS Information</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ProductLevel = SERVERPROPERTY(<span class="hljs-string"><span class="hljs-string">'ProductLevel'</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">Edition</span></span> = SERVERPROPERTY(<span class="hljs-string"><span class="hljs-string">'Edition'</span></span>) , ServerVersion = SERVERPROPERTY(<span class="hljs-string"><span class="hljs-string">'ProductVersion'</span></span>) , IsSysAdmin = <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(IS_SRVROLEMEMBER(<span class="hljs-string"><span class="hljs-string">'sysadmin'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span>)</code> </pre><br></div></div></li><li><div class="spoiler">  <b class="spoiler_title">Getting a list of available databases with their brief properties</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DatabaseName = t.[<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>] , d.DataSize , DataUsedSize = <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>) , d.LogSize , LogUsedSize = <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>) , RecoveryModel = t.recovery_model_desc , LogReuseWait = t.log_reuse_wait_desc <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.databases t <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span>(NOLOCK) <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [database_id] , DataSize = <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) , LogSize = <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>] = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.master_files <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span>(NOLOCK) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> [database_id] ) d <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> d.[database_id] = t.[database_id] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t.[state] = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t.[database_id] != <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>(HAS_DBACCESS(t.[<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>]), <span class="hljs-number"><span class="hljs-number">1</span></span>) = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br></div></div></li></ol><br>  After executing the above scripts, a window appears containing brief information about the databases of the selected instance of MS SQL Server: <br><br> <a href=""><img src="https://habrastorage.org/webt/bc/fy/gz/bcfygzsztslx32ll82uxflshfhi.jpeg"></a> <br><br>  It is worth noting that extended information is displayed based on rights.  If there is <a href="https://docs.microsoft.com/ru-ru/sql/relational-databases/security/authentication-access/server-level-roles%3Fview%3Dsql-server-2017">sysadmin</a> , then you can select data from the <a href="https://docs.microsoft.com/ru-ru/sql/relational-databases/system-catalog-views/sys-master-files-transact-sql%3Fview%3Dsql-server-2017">sys.master_files view</a> .  If there are no such rights, then less data is returned so as not to slow down the request. <br><br>  Here you need to select the database of interest and click on the ‚ÄúOK‚Äù button. <br><br>  Next, the following script will be executed for each selected database to analyze the status of indexes: <br><br><div class="spoiler">  <b class="spoiler_title">Index Status Analysis</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @Fragmentation <span class="hljs-built_in"><span class="hljs-built_in">float</span></span>=<span class="hljs-number"><span class="hljs-number">15</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @MinIndexSize <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>=<span class="hljs-number"><span class="hljs-number">768</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @MaxIndexSize <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>=<span class="hljs-number"><span class="hljs-number">1048576</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @PreDescribeSize <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>=<span class="hljs-number"><span class="hljs-number">32768</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ARITHABORT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NUMERIC_ROUNDABORT <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> OBJECT_ID(<span class="hljs-string"><span class="hljs-string">'tempdb.dbo.#AllocationUnits'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-comment"><span class="hljs-comment">#AllocationUnits CREATE TABLE #AllocationUnits ( ContainerID BIGINT PRIMARY KEY , ReservedPages BIGINT NOT NULL , UsedPages BIGINT NOT NULL ) INSERT INTO #AllocationUnits (ContainerID, ReservedPages, UsedPages) SELECT [container_id] , SUM([total_pages]) , SUM([used_pages]) FROM sys.allocation_units WITH(NOLOCK) GROUP BY [container_id] HAVING SUM([total_pages]) BETWEEN @MinIndexSize AND @MaxIndexSize IF OBJECT_ID('tempdb.dbo.#ExcludeList') IS NOT NULL DROP TABLE #ExcludeList CREATE TABLE #ExcludeList (ID INT PRIMARY KEY) INSERT INTO #ExcludeList SELECT [object_id] FROM sys.objects WITH(NOLOCK) WHERE [type] IN ('V', 'U') AND ( [is_ms_shipped] = 1 ) IF OBJECT_ID('tempdb.dbo.#Partitions') IS NOT NULL DROP TABLE #Partitions SELECT [object_id] , [index_id] , [partition_id] , [partition_number] , [rows] , [data_compression] INTO #Partitions FROM sys.partitions WITH(NOLOCK) WHERE [object_id] &gt; 255 AND [rows] &gt; 0 AND [object_id] NOT IN (SELECT * FROM #ExcludeList) IF OBJECT_ID('tempdb.dbo.#Indexes') IS NOT NULL DROP TABLE #Indexes CREATE TABLE #Indexes ( ObjectID INT NOT NULL , IndexID INT NOT NULL , IndexName SYSNAME NULL , PagesCount BIGINT NOT NULL , UnusedPagesCount BIGINT NOT NULL , PartitionNumber INT NOT NULL , RowsCount BIGINT NOT NULL , IndexType TINYINT NOT NULL , IsAllowPageLocks BIT NOT NULL , DataSpaceID INT NOT NULL , DataCompression TINYINT NOT NULL , IsUnique BIT NOT NULL , IsPK BIT NOT NULL , FillFactorValue INT NOT NULL , IsFiltered BIT NOT NULL , PRIMARY KEY (ObjectID, IndexID, PartitionNumber) ) INSERT INTO #Indexes SELECT ObjectID = i.[object_id] , IndexID = i.index_id , IndexName = i.[name] , PagesCount = a.ReservedPages , UnusedPagesCount = CASE WHEN ABS(a.ReservedPages - a.UsedPages) &gt; 32 THEN a.ReservedPages - a.UsedPages ELSE 0 END , PartitionNumber = p.[partition_number] , RowsCount = ISNULL(p.[rows], 0) , IndexType = i.[type] , IsAllowPageLocks = i.[allow_page_locks] , DataSpaceID = i.[data_space_id] , DataCompression = p.[data_compression] , IsUnique = i.[is_unique] , IsPK = i.[is_primary_key] , FillFactorValue = i.[fill_factor] , IsFiltered = i.[has_filter] FROM #AllocationUnits a JOIN #Partitions p ON a.ContainerID = p.[partition_id] JOIN sys.indexes i WITH(NOLOCK) ON i.[object_id] = p.[object_id] AND p.[index_id] = i.[index_id] WHERE i.[type] IN (0, 1, 2, 5, 6) AND i.[object_id] &gt; 255 DECLARE @files TABLE (ID INT PRIMARY KEY) INSERT INTO @files SELECT DISTINCT [data_space_id] FROM sys.database_files WITH(NOLOCK) WHERE [state] != 0 AND [type] = 0 IF @@ROWCOUNT &gt; 0 BEGIN DELETE FROM i FROM #Indexes i LEFT JOIN sys.destination_data_spaces dds WITH(NOLOCK) ON i.DataSpaceID = dds.[partition_scheme_id] AND i.PartitionNumber = dds.[destination_id] WHERE ISNULL(dds.[data_space_id], i.DataSpaceID) IN (SELECT * FROM @files) END DECLARE @DBID INT , @DBNAME SYSNAME SET @DBNAME = DB_NAME() SELECT @DBID = [database_id] FROM sys.databases WITH(NOLOCK) WHERE [name] = @DBNAME IF OBJECT_ID('tempdb.dbo.#Fragmentation') IS NOT NULL DROP TABLE #Fragmentation CREATE TABLE #Fragmentation ( ObjectID INT NOT NULL , IndexID INT NOT NULL , PartitionNumber INT NOT NULL , Fragmentation FLOAT NOT NULL , PRIMARY KEY (ObjectID, IndexID, PartitionNumber) ) INSERT INTO #Fragmentation (ObjectID, IndexID, PartitionNumber, Fragmentation) SELECT i.ObjectID , i.IndexID , i.PartitionNumber , r.[avg_fragmentation_in_percent] FROM #Indexes i CROSS APPLY sys.dm_db_index_physical_stats(@DBID, i.ObjectID, i.IndexID, i.PartitionNumber, 'LIMITED') r WHERE i.PagesCount &lt;= @PreDescribeSize AND r.[index_level] = 0 AND r.[alloc_unit_type_desc] = 'IN_ROW_DATA' AND i.IndexType IN (0, 1, 2) IF OBJECT_ID('tempdb.dbo.#Columns') IS NOT NULL DROP TABLE #Columns CREATE TABLE #Columns ( ObjectID INT NOT NULL , ColumnID INT NOT NULL , ColumnName SYSNAME NULL , SystemTypeID TINYINT NULL , IsSparse BIT , IsColumnSet BIT , MaxLen INT , PRIMARY KEY (ObjectID, ColumnID) ) INSERT INTO #Columns SELECT ObjectID = [object_id] , ColumnID = [column_id] , ColumnName = [name] , SystemTypeID = [system_type_id] , IsSparse = [is_sparse] , IsColumnSet = [is_column_set] , MaxLen = [max_length] FROM sys.columns WITH(NOLOCK) WHERE [object_id] IN (SELECT DISTINCT i.ObjectID FROM #Indexes i) IF OBJECT_ID('tempdb.dbo.#IndexColumns') IS NOT NULL DROP TABLE #IndexColumns CREATE TABLE #IndexColumns ( ObjectID INT NOT NULL , IndexID INT NOT NULL , OrderID INT NOT NULL , ColumnID INT NOT NULL , IsIncluded BIT NOT NULL , PRIMARY KEY (ObjectID, IndexID, ColumnID) ) INSERT INTO #IndexColumns SELECT ObjectID = [object_id] , IndexID = [index_id] , OrderID = CASE WHEN [is_included_column] = 0 THEN [key_ordinal] ELSE [index_column_id] END , ColumnID = [column_id] , IsIncluded = ISNULL([is_included_column], 0) FROM sys.index_columns ic WITH(NOLOCK) WHERE EXISTS( SELECT * FROM #Indexes i WHERE i.ObjectID = ic.[object_id] AND i.IndexID = ic.[index_id] AND i.IndexType IN (1, 2) ) IF OBJECT_ID('tempdb.dbo.#Lob') IS NOT NULL DROP TABLE #Lob CREATE TABLE #Lob ( ObjectID INT NOT NULL , IndexID INT NOT NULL , IsLobLegacy BIT , IsLob BIT , PRIMARY KEY (ObjectID, IndexID) ) INSERT INTO #Lob (ObjectID, IndexID, IsLobLegacy, IsLob) SELECT c.ObjectID , IndexID = ISNULL(i.IndexID, 1) , IsLobLegacy = MAX(CASE WHEN c.SystemTypeID IN (34, 35, 99) THEN 1 END) , IsLob = 0 FROM #Columns c LEFT JOIN #IndexColumns i ON c.ObjectID = i.ObjectID AND c.ColumnID = i.ColumnID WHERE c.SystemTypeID IN (34, 35, 99) GROUP BY c.ObjectID , i.IndexID IF OBJECT_ID('tempdb.dbo.#Sparse') IS NOT NULL DROP TABLE #Sparse CREATE TABLE #Sparse (ObjectID INT PRIMARY KEY) INSERT INTO #Sparse SELECT DISTINCT ObjectID FROM #Columns WHERE IsSparse = 1 OR IsColumnSet = 1 IF OBJECT_ID('tempdb.dbo.#AggColumns') IS NOT NULL DROP TABLE #AggColumns CREATE TABLE #AggColumns ( ObjectID INT NOT NULL , IndexID INT NOT NULL , IndexColumns NVARCHAR(MAX) , IncludedColumns NVARCHAR(MAX) , PRIMARY KEY (ObjectID, IndexID) ) INSERT INTO #AggColumns SELECT t.ObjectID , t.IndexID , IndexColumns = STUFF(( SELECT ', [' + c.ColumnName + ']' FROM #IndexColumns i JOIN #Columns c ON i.ObjectID = c.ObjectID AND i.ColumnID = c.ColumnID WHERE i.ObjectID = t.ObjectID AND i.IndexID = t.IndexID AND i.IsIncluded = 0 ORDER BY i.OrderID FOR XML PATH(''), TYPE).value('(./text())[1]', 'NVARCHAR(MAX)'), 1, 2, '') , IncludedColumns = STUFF(( SELECT ', [' + c.ColumnName + ']' FROM #IndexColumns i JOIN #Columns c ON i.ObjectID = c.ObjectID AND i.ColumnID = c.ColumnID WHERE i.ObjectID = t.ObjectID AND i.IndexID = t.IndexID AND i.IsIncluded = 1 ORDER BY i.OrderID FOR XML PATH(''), TYPE).value('(./text())[1]', 'NVARCHAR(MAX)'), 1, 2, '') FROM ( SELECT DISTINCT ObjectID, IndexID FROM #Indexes WHERE IndexType IN (1, 2) ) t SELECT i.ObjectID , i.IndexID , i.IndexName , ObjectName = o.[name] , SchemaName = s.[name] , i.PagesCount , i.UnusedPagesCount , i.PartitionNumber , i.RowsCount , i.IndexType , i.IsAllowPageLocks , u.TotalWrites , u.TotalReads , u.TotalSeeks , u.TotalScans , u.TotalLookups , u.LastUsage , i.DataCompression , f.Fragmentation , IndexStats = STATS_DATE(i.ObjectID, i.IndexID) , IsLobLegacy = ISNULL(lob.IsLobLegacy, 0) , IsLob = ISNULL(lob.IsLob, 0) , IsSparse = CAST(CASE WHEN p.ObjectID IS NULL THEN 0 ELSE 1 END AS BIT) , IsPartitioned = CAST(CASE WHEN dds.[data_space_id] IS NOT NULL THEN 1 ELSE 0 END AS BIT) , FileGroupName = fg.[name] , i.IsUnique , i.IsPK , i.FillFactorValue , i.IsFiltered , a.IndexColumns , a.IncludedColumns FROM #Indexes i JOIN sys.objects o WITH(NOLOCK) ON o.[object_id] = i.ObjectID JOIN sys.schemas s WITH(NOLOCK) ON s.[schema_id] = o.[schema_id] LEFT JOIN #AggColumns a ON a.ObjectID = i.ObjectID AND a.IndexID = i.IndexID LEFT JOIN #Sparse p ON p.ObjectID = i.ObjectID LEFT JOIN #Fragmentation f ON f.ObjectID = i.ObjectID AND f.IndexID = i.IndexID AND f.PartitionNumber = i.PartitionNumber LEFT JOIN ( SELECT ObjectID = [object_id] , IndexID = [index_id] , TotalWrites = NULLIF([user_updates], 0) , TotalReads = NULLIF([user_seeks] + [user_scans] + [user_lookups], 0) , TotalSeeks = NULLIF([user_seeks], 0) , TotalScans = NULLIF([user_scans], 0) , TotalLookups = NULLIF([user_lookups], 0) , LastUsage = ( SELECT MAX(dt) FROM ( VALUES ([last_user_seek]) , ([last_user_scan]) , ([last_user_lookup]) , ([last_user_update]) ) t(dt) ) FROM sys.dm_db_index_usage_stats WITH(NOLOCK) WHERE [database_id] = @DBID ) u ON i.ObjectID = u.ObjectID AND i.IndexID = u.IndexID LEFT JOIN #Lob lob ON lob.ObjectID = i.ObjectID AND lob.IndexID = i.IndexID LEFT JOIN sys.destination_data_spaces dds WITH(NOLOCK) ON i.DataSpaceID = dds.[partition_scheme_id] AND i.PartitionNumber = dds.[destination_id] JOIN sys.filegroups fg WITH(NOLOCK) ON ISNULL(dds.[data_space_id], i.DataSpaceID) = fg.[data_space_id] WHERE o.[type] IN ('V', 'U') AND ( f.Fragmentation &gt;= @Fragmentation OR i.PagesCount &gt; @PreDescribeSize OR i.IndexType IN (5, 6) )</span></span></code> </pre><br></div></div><br>  As you can see from the queries themselves, temporary tables are often used.  This was done so that there would be no recompilation, and in the case of a large scheme, the plan could be generated parallel when inserting data, since inserting with table variables is possible in only one stream. <br><br>  After executing the above script, a window with the index table will appear: <br><br> <a href=""><img src="https://habrastorage.org/webt/yd/rl/oh/ydrlohqwbtggc8n8equratfkkr0.jpeg"></a> <br><br>  Here you can also display other detailed information, such as: <br><br><ol><li>  database </li><li>  number of sections </li><li>  date and time of last call </li><li>  compression </li><li>  filegroup </li></ol><br>  etc. <br>  The columns themselves can be customized: <br><br> <a href=""><img src="https://habrastorage.org/webt/7z/qw/jf/7zqwjfox2zagl5ox0oji648jnta.jpeg"></a> <br><br>  In the cells of the Fix column, you can choose what action will be performed during optimization.  Also, when scanning is completed, the default action is selected based on the selected settings: <br><br> <a href=""><img src="https://habrastorage.org/webt/yp/c9/o2/ypc9o2ooiylu7n0pw7zbdo97tbi.jpeg"></a> <br><br>  You must select the desired indexes for processing. <br><br>  Using the main menu, you can save the script (the same button starts the index optimization process itself): <br><br> <a href=""><img src="https://habrastorage.org/webt/tt/tu/fn/tttufnve3kmo_siz_d0ahcxfew8.jpeg"></a> <br><br>  save the table in different formats (the same button allows you to open detailed settings for analysis and optimization of indices): <br><br> <a href=""><img src="https://habrastorage.org/webt/tt/8w/gv/tt8wgvpzqx1cl0a1qvkdfxf1ffm.jpeg"></a> <br><br>  Also, information can be updated by clicking on the third button on the left in the main menu next to the magnifying glass. <br><br>  A button with a magnifying glass allows you to select the desired database for consideration. <br><br>  There is currently no complete help system.  Therefore, clicking on the ‚Äú?‚Äù Button will simply cause a modal window to appear containing basic information about the software product: <br><br> <a href=""><img src="https://habrastorage.org/webt/e5/p_/mq/e5p_mqbcsumjihbb3qnwurxyqdk.jpeg"></a> <br><br>  In addition to all of the above, the main menu has a search bar: <br><br> <a href=""><img src="https://habrastorage.org/webt/bm/1c/nn/bm1cnnxagvohdo3a4qtprhvpqbe.jpeg"></a> <br><br>  When starting the index optimization process: <br><br> <a href=""><img src="https://habrastorage.org/webt/qn/xa/en/qnxaenzm91ifrvoc2l0aipezq5o.jpeg"></a> <br><br>  Also at the bottom of the window you can see the log of the actions performed: <br><br> <a href=""><img src="https://habrastorage.org/webt/wc/aq/zs/wcaqzsz72m6dbuwe3bv1fxqm_3k.jpeg"></a> <br><br>  In the window for detailed analysis and optimization of indexes, you can configure more subtle options: <br><br> <a href=""><img src="https://habrastorage.org/webt/kc/6x/gp/kc6xgpndlhe19ueeehpobprsomc.jpeg"></a> <br><br>  <b>Suggestions for the application:</b> <br><br><ol><li>  make it possible to selectively update statistics not only for indexes, but also in different ways (fully update or partially) </li><li>  make it possible not only to select the database, but also different servers (this is very convenient when there are many instances of MS SQL Server) </li><li>  for greater flexibility in use, it is proposed to wrap commands in libraries, and output them to PowerShell commands, as is done, for example, here: </li><li>  <a href="https://dbatools.io/commands/">dbatools.io/commands</a> </li><li>  make it possible to save and change personal settings both for the entire application and, if necessary, for each instance of MS SQL Server and each database </li><li>  from clauses 2 and 4 it follows the desire to make groups on databases and groups on instances of MS SQL Server, for which the settings are the same </li><li>  search for duplicate indexes (full and incomplete, which either differ slightly or differ only in the included columns) </li><li>  Since SQLIndexManager is used only for MS SQL Server DBMS, you need to reflect this in the name, for example, as follows: SQLIndexManager for MS SQL Server </li><li>  Remove all parts of the application from the GUI into separate modules and rewrite them to .NET Core 2.1 </li></ol><br>  At the time of writing, article 6 of the wishes is actively being developed and there is already support in the form of a search for complete and similar duplicates: <br><br> <a href=""><img src="https://habrastorage.org/webt/zk/bw/d3/zkbwd3hem7xtdtj_5yuqhctasac.jpeg"></a> <br><br><h3>  Sources </h3><br><ul><li>  <a href="https://github.com/Microsoft/tigertoolbox/tree/master/AdaptiveIndexDefrag">adaptive index optimization method</a> </li><li>  <a href="https://github.com/sergeysyrovatchenko/SQLIndexManager">SQLIndexManager utility</a> </li><li>  <a href="https://habr.com/ru/post/459914/">a brief technical overview of the SQLIndexManager utility</a> </li><li>  <a href="https://www.sql.ru/forum/1312218-1/sql-index-manager-besplatnaya-utilita-po-obsluzhivaniu-indeksov-dlya-sql-server-i-azure">discussion of SQLIndexManager utility</a> </li><li>  <a href="https://www.codeproject.com/Articles/5162340/SQL-Index-Manager-Free-GUI-Tool-for-Index-Maintena">SQL Index Manager - Free GUI Tool for Index Maintenance on SQL Server and Azure</a> </li><li>  <a href="https://towardsdatascience.com/sql-server-index-analysis-and-optimization-1edd84d9da">SQL Server Index Analysis and Optimization</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/461277/">https://habr.com/ru/post/461277/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../461265/index.html">About the abuse of the use of the operating system in projects for microcontrollers</a></li>
<li><a href="../461269/index.html">Problem solving with pwnable.kr 08 is leg and 10 is shellshock. ARM assembler. Bash vulnerability</a></li>
<li><a href="../46127/index.html">8 ways to turn a new site visitor into a regular visitor</a></li>
<li><a href="../461271/index.html">How to promote a mobile application in 2019: 4 practical ways + useful tools</a></li>
<li><a href="../461273/index.html">Greedy approach and slot machines. Analysis of the tasks of the ML-track of the programming championship</a></li>
<li><a href="../461279/index.html">How to create a simple microservice on Golang and gRPC and containerize it using Docker</a></li>
<li><a href="../461281/index.html">Walkthrough for setting up a BIND DNS server in a chroot environment for Red Hat (RHEL / CentOS) 7</a></li>
<li><a href="../461283/index.html">Software architecture and systems design: a big picture and resource guide</a></li>
<li><a href="../461285/index.html">5 main sampling algorithms</a></li>
<li><a href="../461289/index.html">CLion 2019.2 released: embedded development support, debugger for MSVC, search for unused header files</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>