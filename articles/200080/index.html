<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How Yandex clouds are arranged: Elliptics</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Over the past few years, a fashionable trend has emerged in the IT world - the use of everything ‚Äúcloudy‚Äù to develop new products. Public cloud provid...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How Yandex clouds are arranged: Elliptics</h1><div class="post__text post__text-html js-mediator-article">  Over the past few years, a fashionable trend has emerged in the IT world - the use of everything ‚Äúcloudy‚Äù to develop new products.  Public cloud providers are not many, the most popular among them - Amazon.  However, many companies are not willing to trust private data to anyone, while they want to store them securely, and therefore raise small private clouds. <br><br>  Any cloud consists of two main components: Single Entry Point (ETV) and Cloud Magic (OM).  Consider the <a href="http://en.wikipedia.org/wiki/Amazon_S3">Amazon S3</a> cloud storage: the RTV API is used in the role of ETV, and the elves working on dollars provide Cloud Magic.  Companies wishing to place small video files or a database in S3 preliminarily calculate on the calculator the amount they will pay per month at the planned load. <br><br>  This article is about another cloud storage, in which the elves feed on the Spirit of Freedom, electricity, and they still need a little bit of " <a href="http://api.yandex.ru/cocaine/">cocaine</a> ." <br> <a href="http://habrahabr.ru/company/yandex/blog/200080/"><img src="https://habrastorage.org/getpro/habr/post_images/422/da6/b87/422da6b874cf56c47120116349ca8eb8.jpg"></a> <br>  This repository is called <a href="http://api.yandex.ru/elliptics/">Elliptics</a> . <br><a name="habracut"></a><br>  The history of its creation dates back to 2007 as part of <a href="http://en.wikipedia.org/wiki/POHMELFS">POHMELFS</a> .  The following year, Elliptics was put into a separate project, and many different approaches to distributed data storage were tried in it, many of them did not work because of the complexity, because of too little practicality in real life.  In the end, its author, Yevgeny Polyakov, came to the creation of Elliptics in its modern form. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  fault tolerance </h4><br>  This is the first of the Five Elements, for the preservation of which Elliptics is directed.  Machines are constantly breaking down, hard drives fail, and elves from time to time go on strike and throw bark.  The data center can also fall out of our world at any time, by virtue of Black Magic and Sorcery.  The most obvious of these are Cable Break and Electricity Loss. <br><img src="https://habrastorage.org/getpro/habr/post_images/f47/233/31d/f4723331d5787805a22e8b5c42d08523.jpg"><br><div class="spoiler">  <b class="spoiler_title">One sad story</b> <div class="spoiler_text">  One day, in the rain, one little kitten felt cold, and he decided to warm himself.  Nearby there was not a single room, except for the transformer box, which was made strictly according to GOST, with an opening of 10 centimeters from the bottom. The transformer was short-circuited, and one kitten was smaller, and the data center was without electricity.  It happened on a weekend, on Saturday, and therefore full-time electricians were not in the workplace and could not restore electricity.  Of course, the diesel generator was available and worked, but the fuel was enough for only a few hours.  The security service refused to allow an operatively called fuel truck into the data center.  In the end, everything was solved safely, but no one is immune from such situations. </div></div><br>  Everyone has long known what to do in case the disk or server is disconnected.  But no one wonders what will happen to their system if the data center fails, the Amazon region or another major event occurs.  Elliptics was originally planned to solve this class of problems. <br><br>  In Elliptics, all documents are stored on 512-bit keys, which are obtained as a result of the sha512 function of the document name.  All keys can be represented as <a href="http://en.wikipedia.org/wiki/Distributed_hash_table">Distributed Hash Table</a> (DHT), rings with a range of values ‚Äã‚Äãfrom 0 to <sup>2,512</sup> .  The ring is randomly divided between all the machines of one group, and each key can be simultaneously stored in several different groups.  We can roughly assume that one group is one data center.  As a rule, Yandex keeps 3 copies of all documents, and in the event of the failure of a machine, we lose only one copy of a part of the ring.  Even if the entire data center fails, the information is not lost, we still have all the documents in at least two copies, and so the elves still can bring joy to people. <br><br><h4>  Extensibility </h4><br>  Administrator elves always wanted to be able to connect additional machines, and Elliptics can do it!  When a new computer is connected to the group, it takes away random intervals from those <sup>2,512</sup> keys, and all subsequent requests for these keys will come to this machine. <br><img src="https://habrastorage.org/getpro/habr/post_images/78f/741/49e/78f74149e706750724b7393aab6b4c7d.jpg"><br>  If we have three groups consisting of hundreds of machines each, then adding new ones will entail rebalancing and, as a result, large amounts of data will have to be poured over the network to restore them.  For those to whom this is not suitable, we have developed a load balancing system - <a href="https://github.com/toshic/mastermind">Mastermind</a> , which runs on the <a href="http://api.yandex.ru/cocaine/">Cocaine</a> cloud platform.  Mastermind is a set of peer super-nodes that determine in which groups a particular file will be stored based on the load on each of the servers.  Here, too, there is a difficult Mathematical Magic - the free space, disk load, CPU load, switch load, drop rate and much more are taken into account.  In case of failure of any of the Mastermind nodes, everything continues to work as before.  If the group size is kept small, then when new machines are added, it is enough for them to issue a new group and let the Mastermind know about it.  In this case, the information about the groups in which it should be searched is added to the file identifier.  This mechanism allows for a truly infinite and very simple storage expansion. <br><br><h4>  Data integrity </h4><br>  Let's take a look at what the system does with old data that were not on those machines after balancing or were completely lost. <br><img src="https://habrastorage.org/getpro/habr/post_images/fe2/91f/d58/fe291fd5836f0e9848bb38cf939cc40d.jpg"><br>  In this case, Elliptics provides a recovery system.  The scheme of its work is as follows: it goes through all the machines and, if the data is on your own machine, moves them to the right one.  If it turns out that some document is not in three copies, then during this procedure the document will be reproduced on the necessary machines.  Moreover, if the system works with Mastermind, the group number of the file location is taken from the meta-information.  The recovery speed depends on many factors and the exact key recovery speed cannot be called, but, as load testing shows, the bottleneck is the network channel between the machines, which is used to transfer data. <br><br><h4>  Speed </h4><br>  Elliptics has little overhead and is capable of performing up to 240,000 read operations per second on a single machine while working with the cache.  When working with a disk, the speed naturally drops and rests on the speed of reading data from the disk. <br><br>  On the basis of Elliptics implemented project HistoryDB.  With it, we keep logs coming from various external events.  During testing, a group of three machines quietly and smoothly coped with a load of 10 thousand requests per second, when logs from 30 million users were written.  Moreover, 10% of them generated 80% of all data.  In total, 30 million users had about 500 million updates every day.  However, simply storing this data would be too easy.  Therefore, the system was tested in such a way that, working under load, it allowed to get a list of all users who were active during a certain period (day / month), to see the logs of any user for any day and it was possible to add any other secondary indexes to user data. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/062/b6c/450/062b6c450d614710a595263e8d0378df.jpg"><br><br>  Also, on the basis of Elliptics, Yandex has built the work of such services as Yandex.Music, Photos, Maps, Market, vertical searches, people search, mail backups.  Preparing for the move and Yandex.Disk. <br><br><h4>  Simplicity of architecture </h4><br>  In Elliptics, clients connect directly to servers, and this allows: <br><ul><li>  have a simple architecture; </li><li>  ensure that transactions are performed correctly; </li><li>  always know which machine in the group is responsible for a particular key. </li></ul><br>  For users of the data storage service, there are the following APIs with which you can easily write, delete, read and process data: <br><ul><li>  asynchronous library in C ++ 11 </li><li>  Python Binding </li><li>  FastCGI and TheVoid HTTP Frontends (using boost :: asio) </li></ul><br>  However, a silver bullet does not exist, and Elliptics has its limitations and problems: <br><ul><li>  Eventual consistency.  Since Elliptics is fully distributed, for various problems the server may give the file version older than the current one.  In some cases, this may not be applicable, then by declining the response time, you can use more reliable methods for querying data. </li><li>  Due to the fact that client data is written in parallel to several servers, the network between the client and servers can become a bottleneck. </li><li>  The API may not be very convenient for high-level queries.  At the moment we do not provide convenient SQL-like data queries. </li><li>  Also in Elliptics there is no high-level transaction support, so it is impossible to guarantee that a group of commands will either complete everything, or not at all. </li></ul><br>  In the following articles we will give an example of using Elliptics and will describe more technical details: the internal structure of the cache, the work of our backend eblob, data streaming, secondary indexes and much more. </div><p>Source: <a href="https://habr.com/ru/post/200080/">https://habr.com/ru/post/200080/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../200062/index.html">China and the post of Ukraine - why so long?</a></li>
<li><a href="../200064/index.html">It's time to pay: non-standard ways to monetize software and digital content</a></li>
<li><a href="../200074/index.html">Counts for the smallest: DFS</a></li>
<li><a href="../200076/index.html">Usability food court</a></li>
<li><a href="../200078/index.html">(Archive) Matreshka.js - Inheritance</a></li>
<li><a href="../200082/index.html">[Advertising] UPS based on kinetic energy storage</a></li>
<li><a href="../200084/index.html">High Level Programming in 1975</a></li>
<li><a href="../200086/index.html">Corona SDK will support Windows Phone 8 and Windows Store</a></li>
<li><a href="../200088/index.html">Color selection / niche search</a></li>
<li><a href="../200094/index.html">Creating informative graphics in CorelDraw X6</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>