<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Monitor communication links on HP MSR NG routers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="- Meet! Alice, this is pudding! Pudding, this is Alice! Blow it! ... 
 Well, you just introduced, and you have him with a knife!  (c) Lewis Carroll. A...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Monitor communication links on HP MSR NG routers</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  - Meet!  Alice, this is pudding!  Pudding, this is Alice!  Blow it! ... <br>  Well, you just introduced, and you have him with a knife! </blockquote>  (c) Lewis Carroll.  Alice in Wonderland <br><br>  A year has passed since HP has updated the HP MSR enterprise-class router line.  The new routers called this the new generation of routers or MSR NG.  These are absolutely new devices from the hardware point of view, using multi-core processors with built-in encryption accelerator, PCIE 2.0 bus and a noticeably larger amount of both operational and flash memory.  First of all, the new hardware platform made it possible to obtain a multiple increase in productivity, which helped HP overtake many distinguished ‚Äúshop colleagues‚Äù.  Of course, to implement this performance, it was necessary to seriously rework and the operating system, it is still called HP Comware, but the version is already 7. With the advent of this OS, in addition to improving reliability and performance, a lot of new features have appeared, such as: improved technology for creating dynamic VPNs - HP ADVPN, support for fault-tolerant IRF stacking of routers, built-in EAA automation system, firewall with zones and many other useful functions in the network economy. <br>  With this article, we begin to introduce our blog readers to HP MSR NG routers and the new functionality of the HP Comware 7 operating system. The first article in this series is devoted to an example of solving a common task of monitoring communication channels using the HP MSR NG router. <br><a name="habracut"></a><br>  So, we solve the problem of monitoring the availability of a communication channel using ICMP echo requests, or, in simple terms, using ‚Äúpings‚Äù.  If the service is unavailable, we inform the administrator about the state change by all available means - we send an SNMP trap to the management system, a syslog message with arbitrary content to the syslog server and write an email via the ESMTP server.  Other actions, such as switching to the backup channel and changing the configuration can be added as salt and sugar - to taste.  The configuration can be run-in on the <a href="http://habrahabr.ru/company/hp/blog/229203/">HP Network Simulator</a> , we, for a change, will use the <a href="https://h10145.www1.hp.com/downloads/SoftwareReleases.aspx%3FProductNumber%3DJG811AAE">HP</a> Virtual Router <a href="https://h10145.www1.hp.com/downloads/SoftwareReleases.aspx%3FProductNumber%3DJG811AAE">VSR1000</a> , which anyone can download.  The router supports VMware ESXi and Linux KVM virtualization platforms, but, for our purposes, it can be run on VMware Workstation 10 version and even on VMware Player.  Virtual machine requirements: <br><ul><li>  Processor One vCPU (main frequency‚â• 2.0 GHz); </li><li>  Memory 1 GB; </li><li>  Hard disk One vHD, 8 GB; </li><li>  Network interface card Two virtual NICs at least.  Up to 16 virtual NICs are supported; </li><li>  Virtual NIC types: E1000 (VMware ESXi and Linux KVM), VMXNET3 (VMware ESXi), VirtIO (Linux KVM), InteI 82599 VF (VMware ESXi and Linux KVM). </li></ul>  Requirements, as we see, by modern standards are far from sky-high, which will allow us to run a couple of routers to work out the configuration right on a working laptop.  As part of the downloaded distribution, we will find three files with extensions: <br><ul><li>  ‚Äú.Ipe‚Äù - Comware 7 software for upgrading an already functioning router; </li><li>  ‚Äú.Iso‚Äù - an image for installing the software on a virtual machine yourself; </li><li>  ‚Äú.Ova‚Äù is a ready-made virtual machine image with an already installed HP VSR 1000. </li></ul>  We will use the ready OVA image and create the following network diagram in a virtual environment: <img src="https://habrastorage.org/files/23b/0d2/1d8/23b0d21d8655424682f25a9925e5deda.png" alt="image"><br>  The installation process of the HP VSR1000 Router on VMware Player is extremely simple and intuitive. <br>  After installing the routers and setting up the VMware network environment, according to our scheme, we start the virtual machines and perform the initial settings that will allow us to get the usual access from the terminal program using the SSH protocol.  How to install HP VSR, create a booth using VMware Player software and perform the preliminary settings shown in the <a href="http://youtu.be/9USQpNwkK9Y">video</a> . <br>  Now, having received the usual access via SSH, we proceed to solving our problem.  We will need to configure two functions - Network quality analyzer (or NQA for short) and Embedded Automation Architecture (EAA). <br>  Network quality analyzer (NQA) is a functional that allows measuring data transmission network parameters for various types of applications.  Monitoring of the following applications is supported: <br><ul><li>  ICMP echo; </li><li>  DHCP; </li><li>  DNS; </li><li>  FTP; </li><li>  HTTP; </li><li>  UDP jitter; </li><li>  SNMP; </li><li>  TCP; </li><li>  UDP echo; </li><li>  Voice; </li><li>  Path jitter; </li><li>  DLSw. </li></ul><br>  This functionality works as follows: a router-probe, or NQA Client in terms of HP, creates a request packet and sends it to a remote device (NQA destination device), which responds to probe requests.  For monitoring functions with TCP, UDP echo, UDP jitter and voice packets, the HP router (NQA Server) must be the NQA of the responder, other network devices can respond to other types of requests. <br>  In our example, we consider the operation of NQA in the channel test mode using ICMP echo requests.  The VSR1000-1 router, which monitors the channel, ‚Äúpings‚Äù the specified IP address (in our case, the HP VSR1000-2) and, on the basis of the responses received, concludes that the channel is operational. <br>  The router allows you to set the following parameters: <img src="https://habrastorage.org/files/802/2b2/0d5/8022b20d574e4e0faf83c721e17f1600.png" alt="image"><br>  Configure the NQA probe, which will send every 30 seconds 5 ICMP echo messages to the IP address 192.168.1.2 with the IP ToS field set to ‚ÄúA0‚Äù (DSCP 40), 1024 bytes each, and wait for a response within 0.5 seconds on the router as follows: <br><br>  [VSR1000-1] nqa entry icmp 1 <br>  [VSR1000-1-nqa-icmp-1] type icmp-echo <br>  [VSR1000-1-nqa-icmp-1-icmp-echo] <br>  [VSR1000-1-nqa-icmp-1-icmp-echo] description === Test1 === <br>  [VSR1000-1-nqa-icmp-1-icmp-echo] destination ip 192.168.1.2 <br>  [VSR1000-1-nqa-icmp-1-icmp-echo] frequency 30000 <br>  [VSR1000-1-nqa-icmp-1-icmp-echo] data-size 1024 <br>  [VSR1000-1-nqa-icmp-1-icmp-echo] tos 160 <br>  [VSR1000-1-nqa-icmp-1-icmp-echo] probe count 5 <br>  [VSR1000-1-nqa-icmp-1-icmp-echo] probe timeout 500 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Next, we need to set the router's reaction to the test results of the communication channel.  In our example, we will consider the failure of the communication channel to consistently fail to receive three replies to the pings sent.  Here we will solve the first task, namely, we will force the router to generate SNPM trap both when the threshold is exceeded in 3 consecutively lost responses, and when the number of losses falls below the specified value: <br><br>  [VSR1000-1-nqa-icmp-1-icmp-echo] reaction 1 checked-element probe-fail threshold-type consecutive 3 action-type trap-only <br>  We have the following NQA configuration: <br><br>  [VSR1000-1] display current-configuration configuration nqa <br>  # <br>  nqa entry icmp 1 <br>  type icmp-echo <br>  data-size 1024 <br>  description === Test1 === <br>  destination ip 192.168.1.2 <br>  frequency 30000 <br>  probe count 5 <br>  probe timeout 500 <br>  reaction 1 checked-element probe-fail threshold-type consecutive 3 action-type trap-only <br>  source ip 192.168.1.1 <br>  tos 160 <br>  # <br>  In order for the router to send an SNMP trap, you must specify the version of the SNMP protocol, the IP address of the management station and securityname: <br><br>  [VSR1000-1] snmp-agent sys-info version v2c <br>  [VSR1000-1] snmp-agent target-host trap address udp-domain 172.16.1.100 params securityname public v2c <br><br>  We will configure the SNMP community to read; we will need this for subsequent actions related to finding the SNMP object responsible for this NQA record: <br><br>  [VSR1000-1] snmp-agent community read simple public <br><br>  You can run our probe: <br><br>  [VSR1000-1] nqa schedule icmp 1 start-time now lifetime forever <br><br>  Now, when a change in the link state is detected, the router will send an SNMP message to the IP address 172.16.1.100. <br>  You can see the live configuration process by following the <a href="http://youtu.be/LnSOWVEDi-M">link</a> . <br>  We proceed to the solution of the second part of the task - let our device generate a syslog message duplicating the SNMP trap.  For this we will use the embedded automation system - HP EAA (Embedded Automation Architecture).  The overall EAA architecture is shown in the figure: <img src="https://habrastorage.org/files/626/351/b46/626351b4622242b0afcd0bebd366af8f.png" alt="image"><br>  This functionality allows the device to register various events, such as entering a command, the appearance of a given syslog message, installing a new module into a router, and many others.  Based on the registered event, the router allows you to perform various actions: <br><ul><li>  execute a set of commands; </li><li>  send syslog message; </li><li>  switch between primary and backup control modules; </li><li>  reboot the router with / without saving the configuration. </li></ul> To perform these actions, both a CLI script and a script written in TCL version 8.5 can be used. <br>  To generate syslog messages we will use two TCL scripts.  The first will register the change in SNMP OID of the corresponding NQA probe from the state ‚ÄúoverThreshold (2)‚Äù to the state ‚ÄúbelowThreshold (3)‚Äù, which corresponds to the transition of the communication channel from the non-operational to the operational state and send a syslog message that our channel is available.  The second will register the reverse evolution of the NQA probe, namely the transition from the state ‚ÄúbelowThreshold (3)‚Äù to the state ‚ÄúoverThreshold (2)‚Äù which corresponds to the transition of the communication channel from the working state to the non-working state and send a syslog message that our channel has failed . <br>  The first problem faced by an inquisitive administrator on the way to implementing his plan is, in fact, the search for an SNMP OID responsible for the state of the configured NQA.  To solve this problem, we need the MIB library, available for download at <a href="https://h10145.www1.hp.com/Downloads/DownloadSoftware.aspx%3FSoftwareReleaseUId%3D11177%26ProductNumber%3DJG811AAE%26lang%3Den%26cc%3Dus%26prodSeriesId%3D5443163%26SerialNumber%3D%26PurchaseDate%3D">MIBs_V7</a> , and any MIB browser (I used the free version of <a href="http://ireasoning.com/downloadmibbrowserlicense.shtml">Ireasoning MIB Browser Personal Edition</a> ).  From this library we load into the MIB a browser MIB with the name ‚Äúhh3c-nqa.mib‚Äù.  In the MIB browser, we find the ‚Äúhh3cNqaReactCurrentStatus‚Äù object and execute the ‚ÄúGet Subtree‚Äù command after specifying the IP address of our router (172.16.1.1) and community (‚Äúpublic‚Äù).  In response, we will get the desired object, in my case it is SNMP OID .1.3.6.1.4.1.25506.8.3.1.13.1.11.4.105.99.109.112.1.49.1. <br>  Now in the text editor we write the first script and call it, for example, up.tcl.  This script will, once every 10 seconds, poll the state of our SNMP OID, record the change in OID value from ‚Äú3‚Äù to ‚Äú2‚Äù (which corresponds to the restoration of the communication channel) and generate a syslog with the message ‚ÄúVSR1000-2 Dest IP 192.168.1.2 is available‚Äù .  Let's take the script for 30 seconds: <br><br>  :: comware :: rtm :: event_register snmp oid 1.3.6.1.4.1.25506.8.3.1.13.1.11.4.105.99.109.112.1.49.1 monitor-obj get start-op eq start-val 3 restart-op eq restart- val 2 interval 10 running-time 30 user-role network-admin <br>  :: comware :: rtm :: action syslog priority 5 facility local4 msg "VSR1000-2 Dest IP 192.168.1.2 is available" <br><br>  Similarly, we write the second script, which will track the ‚Äúdrop‚Äù of the channel and output a syslog of the form ‚ÄúVSR1000-2 Dest IP 192.168.1.2 is unavailable‚Äù: <br><br>  :: comware :: rtm :: event_register snmp oid 1.3.6.1.4.1.25506.8.3.1.13.1.11.4.105.99.109.112.1.49.1 monitor-obj get start-op eq start-val 2 restart-op eq restart- val 3 interval 10 running-time 30 user-role network-admin <br>  :: comware :: rtm :: action syslog priority 5 facility local4 msg "VSR1000-2 Dest IP 192.168.1.2 is unavailable" <br><br>  Then we load the received files ‚Äúup.tcl‚Äù and ‚Äúdown.tcl‚Äù into the flash memory of the router and register them: <br><br>  [VSR1000-1] rtm tcl-policy up flash: /up.tcl <br>  [VSR1000-1] rtm tcl-policy down flash: /down.tcl <br><br>  It remains only to set the IP address of the syslog server in the router configuration: <br><br>  [VSR1000-1] info-center loghost 172.16.1.100 <br>  <a href="http://youtu.be/F5nz5edqpoc">Video showing this part of the config</a> . <br>  We taught our router to send a syslog message in addition to the SNMP trap. <br>  We proceed to the final part of our task - sending an email message through an ESMTP server. <br>  To solve this problem, we will use a ready-made script, which can be downloaded from <a href="http://wiki.tcl.tk/417">http://wiki.tcl.tk/417</a> .  Save it to the sendmail.tcl file and write it to the root directory of the router‚Äôs flash memory.  The script describes the procedure, and requires the definition of the following variables: <br><ul><li>  smtphost - the IP address of the ESMTP server; </li><li>  toList - email addresses of recipients; </li><li>  from - the address of the sender e-mail; </li><li>  subject - the subject of the letter; </li><li>  body - the contents of the letter; </li><li>  {trace 0} - enable / disable debugging information. </li></ul><br>  Part of the variables, namely, the address of the mail server and the recipient of the messages, we set in the router configuration: <br><br>  [VSR1000-1] rtm environment smtphost 172.16.1.100 <br>  [VSR1000-1] rtm environment toList ADMIN@company.org <br><br>  The remaining variables are defined in the body of our scripts: <br><br>  variable from VSR1000-1@test.org <br>  variable subject ‚ÄúVSR1000-2 availability‚Äù <br>  variable body ‚ÄúVSR1000-2 Dest IP 192.168.1.2 is available‚Äù <br><br>  Also, in the body of the up.tcl and down.tcl scripts add a line that registers the library responsible for sending mail: <br><br>  source sendmail.tcl <br><br>  And the line that calls this procedure: <br><br>  sendmail $ smtphost $ toList $ from $ subject $ body <br><br>  Who cares, watch the <a href="http://youtu.be/IkWW8e58LJI">video of</a> this process. <br>  That's all you need to set up. <br>  The resulting configurations and scripts can be said here: <br>  HP <a href="">VSR1000-1</a> Router Configuration <br>  HP <a href="">VSR1000-2</a> Router Configuration <br>  Script <a href="">up.tcl</a> <br>  Script <a href="">down.tcl</a> <br>  Sendmail.tcl script <br>  This article does not pretend to be the ultimate truth, does not call for solving your tasks in this way, and rather is a demonstration of the tools available to owners of HP MSR NG routers.  I hope this information will help our readers to develop their own configuration, solving their unique production problems. <br>  In the process of solving the problem materials were used: <br>  <a href="http://h20628.www2.hp.com/km-ext/kmcsdirect/emr_na-c03941433-3.pdf">HP VSR1000 Virtual Services Router Installation and Getting Started Guide</a> <br>  <a href="http://h20628.www2.hp.com/km-ext/kmcsdirect/emr_na-c04341994-1.pdf">HP VSR1000 Virtual Services Router Network Management and Monitoring Configuration Guide</a> <a href="http://h20628.www2.hp.com/km-ext/kmcsdirect/emr_na-c04341994-1.pdf"><br></a>  <a href="http://h20628.www2.hp.com/km-ext/kmcsdirect/emr_na-c04341994-1.pdf">R0202-HP VSR1000 Virtual Services Router Network Management and Monitoring Command Reference</a> </div><p>Source: <a href="https://habr.com/ru/post/232447/">https://habr.com/ru/post/232447/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../232427/index.html">How many hours a day can a programmer work? Versions of the answer from Yandex</a></li>
<li><a href="../232433/index.html">Justin.tv closed</a></li>
<li><a href="../232439/index.html">Where to go to study: ranking of universities based on reference ranking</a></li>
<li><a href="../232443/index.html">Two examples of commercial censorship: the hotel fines visitors for negative reviews, and the restaurant wins in court</a></li>
<li><a href="../232445/index.html">Why is mobile unsafe by default</a></li>
<li><a href="../232449/index.html">Anonymous interview with a former participant in the cutting scene - 2</a></li>
<li><a href="../232451/index.html">Developer Updates for Windows</a></li>
<li><a href="../232453/index.html">We build in local notifications</a></li>
<li><a href="../232455/index.html">Properly choose a cloud call center</a></li>
<li><a href="../232459/index.html">How not to stay hungry or unlimited passage to the dining room</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>