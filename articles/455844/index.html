<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a Roslyn analyzer using the encapsulation test as an example</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What is Roslyn? 


 Roslyn is a set of open source compilers and an API for analyzing code for C # and VisualBasic .NET from Microsoft. 


 Roslyn ana...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a Roslyn analyzer using the encapsulation test as an example</h1><div class="post__text post__text-html js-mediator-article"><h2 id="chto-takoe-roslyn">  What is Roslyn? </h2><br><p>  Roslyn is a set of open source compilers and an API for analyzing code for C # and VisualBasic .NET from Microsoft. </p><br><p>  Roslyn analyzer is a powerful tool for analyzing code, finding errors and fixing them. </p><br><h2 id="sintaksicheskoe-derevo-i-semanticheskaya-model">  Syntax tree and semantic model </h2><br><p>  To analyze the code, you need to have an idea of ‚Äã‚Äãthe syntactic tree and the semantic model, since these are the two main components for static analysis. </p><br><p>  A syntax tree is an element that is built on the basis of the source code of a program, and is necessary for analyzing the code.  During the analysis of the code it moves. </p><br><p>  Each code has a syntax tree.  For the next class object </p><br><pre><code class="plaintext hljs">class A { void Method() { } }</code> </pre> <br><p>  The syntax tree will look like this: </p><br><p><img src="https://habrastorage.org/webt/pw/p1/pj/pwp1pjih_rj1ihawhpdn6iouax8.png" alt="Tree"></p><a name="habracut"></a><br><p>  An object of type SyntaxTree is a syntax tree.  There are three main elements in the tree: SyntaxNodes, SyntaxTokens, SyntaxTrivia. </p><br><p>  Syntaxnodes describe syntactic constructions, namely: declarations, operators, expressions, etc.  In C #, syntax constructs represent a class of type SyntaxNode. </p><br><p>  Syntaxtokens describes such elements as: identifiers, keywords, special characters.  In C #, this is the type of the SyntaxToken class. </p><br><p>  Syntaxtrivia describes elements that will not be compiled, namely: spaces, newline characters, comments, preprocessor directives.  In C #, it is defined by a SyntaxTrivia class. </p><br><p>  The semantic model represents information about objects and their types.  Thanks to this tool you can conduct a deep and complex analysis.  In C #, it is defined by a class of type SemanticModel. </p><br><h2 id="sozdanie-analizatora">  Creating an analyzer </h2><br><p>  To create a static analyzer, you need to install the following .NETCompilerPlatformSDK component. </p><br><p>  The main functions included in any analyzer include: </p><br><ol><li>  Registration action. <br>  Actions are code changes that the analyzer must initiate to check the code for violations.  When VisualStudio detects code changes corresponding to a registered action, it calls the registered analyzer method. </li><li>  Creating a diagnosis. <br>  When a violation is detected, the analyzer creates a diagnostic object used by VisualStudio to notify the user of the violation. </li></ol><br><p>  There are several steps to create and test the analyzer: </p><br><ol><li>  Create a solution. </li><li>  Register the name and description of the analyzer. </li><li>  Warnings and recommendations of the report analyzer. </li><li>  Execute correction code to accept recommendations. </li><li>  Improved analysis with unit tests. </li></ol><br><p>  Actions are registered in the override of the method DiagnosticAnalyzer.Initialize (AnalysisContext), where the AnalysisContext method in which the search for the object being analyzed is fixed. </p><br><p>  The analyzer may provide one or more code fixes.  A code fix identifies changes that address the reported problem.  The user chooses the changes from the user interface (lights in the editor), and VisualStudio changes the code.  The RegisterCodeFixesAsync method describes a code change. </p><br><h2 id="primer">  Example </h2><br><p>  For example, let's write a public field analyzer.  This application should alert the user about public fields and provide the ability to encapsulate a field with a property. </p><br><p>  This is what should happen: </p><br><p><img src="https://habrastorage.org/webt/_5/0p/io/_50pioos1kxrwrvwfyksx9zclsi.png" alt="work example"></p><br><h3 id="razberem-chto-dlya-etogo-nuzhno-sdelat">  Let's look at what you need to do. </h3><br><p>  First you need to create a solution. </p><br><p><img src="https://habrastorage.org/webt/ed/qj/kk/edqjkkb3ylmcrdh23srehvotg2u.png" alt="solution creation"></p><br><p>  After creating the solution, we see that there are already three projects. </p><br><p><img src="https://habrastorage.org/webt/gk/ci/1s/gkci1scfwxad-72vmtxouv20k5u.png" alt="decision tree"></p><br><p>  We need two classes: </p><br><p>  1) Class AnalyzerPublicFieldsAnalyzer, in which we specify the criteria for analyzing the code for finding public fields and a description of the warning for the user. </p><br><p>  We indicate the following properties: </p><br><pre> <code class="plaintext hljs">public const string DiagnosticId = "PublicField"; private const string Title = "Filed is public"; private const string MessageFormat = "Field '{0}' is public"; private const string Category = "Syntax"; private static DiagnosticDescriptor Rule = new DiagnosticDescriptor(DiagnosticId, Title, MessageFormat, Category, DiagnosticSeverity.Warning, isEnabledByDefault: true); public override ImmutableArray&lt;DiagnosticDescriptor&gt; SupportedDiagnostics { get { return ImmutableArray.Create(Rule); } }</code> </pre> <br><p>  After that, we will indicate the criteria for analyzing public fields. </p><br><pre> <code class="plaintext hljs">private static void AnalyzeSymbol(SymbolAnalysisContext context) { var fieldSymbol = context.Symbol as IFieldSymbol; if (fieldSymbol != null &amp;&amp; fieldSymbol.DeclaredAccessibility == Accessibility.Public &amp;&amp; !fieldSymbol.IsConst &amp;&amp; !fieldSymbol.IsAbstract &amp;&amp; !fieldSymbol.IsStatic &amp;&amp; !fieldSymbol.IsVirtual &amp;&amp; !fieldSymbol.IsOverride &amp;&amp; !fieldSymbol.IsReadOnly &amp;&amp; !fieldSymbol.IsSealed &amp;&amp; !fieldSymbol.IsExtern) { var diagnostic = Diagnostic.Create(Rule, fieldSymbol.Locations[0], fieldSymbol.Name); context.ReportDiagnostic(diagnostic); } }</code> </pre> <br><p>  We get an object field of type IFieldSymbol, which has properties for defining field modifiers, its name and location.  What we need for diagnosis. </p><br><p>  It remains to initialize the analyzer, specifying in the overridden method </p><br><pre> <code class="plaintext hljs">public override void Initialize(AnalysisContext context) { context.RegisterSymbolAction(AnalyzeSymbol, SymbolKind.Field); }</code> </pre> <br><p>  2) Now we proceed to change the proposed code by the user based on code analysis.  This happens in the AnalyzerPublicFieldsCodeFixProvider class. </p><br><p>  To do this, specify the following: </p><br><pre> <code class="plaintext hljs">private const string title = "Encapsulate field"; public sealed override ImmutableArray&lt;string&gt; FixableDiagnosticIds { get { return ImmutableArray.Create(AnalyzerPublicFieldsAnalyzer.DiagnosticId); } } public sealed override FixAllProvider GetFixAllProvider() { return WellKnownFixAllProviders.BatchFixer; } public sealed override async Task RegisterCodeFixesAsync(CodeFixContext context) { var root = await context.Document.GetSyntaxRootAsync(context.CancellationToken) .ConfigureAwait(false); var diagnostic = context.Diagnostics.First(); var diagnosticSpan = diagnostic.Location.SourceSpan; var initialToken = root.FindToken(diagnosticSpan.Start); context.RegisterCodeFix( CodeAction.Create(title, c =&gt; EncapsulateFieldAsync(context.Document, initialToken, c), AnalyzerPublicFieldsAnalyzer.DiagnosticId), diagnostic); }</code> </pre> <br><p>  And we define the ability to encapsulate a field with a property in the EncapsulateFieldAsync method. </p><br><pre> <code class="plaintext hljs">private async Task&lt;Document&gt; EncapsulateFieldAsync(Document document, SyntaxToken declaration, CancellationToken cancellationToken) { var field = FindAncestorOfType&lt;FieldDeclarationSyntax&gt;(declaration.Parent); var fieldType = field.Declaration.Type; ChangeNameFieldAndNameProperty(declaration.ValueText, out string fieldName, out string propertyName); var fieldDeclaration = CreateFieldDecaration(fieldName, fieldType); var propertyDeclaration = CreatePropertyDecaration(fieldName, propertyName, fieldType); var root = await document.GetSyntaxRootAsync(); var newRoot = root.ReplaceNode(field, new List&lt;SyntaxNode&gt; { fieldDeclaration, propertyDeclaration }); var newDocument = document.WithSyntaxRoot(newRoot); return newDocument; }</code> </pre> <br><p>  For this you need to create a private field. </p><br><pre> <code class="plaintext hljs">private FieldDeclarationSyntax CreateFieldDecaration(string fieldName, TypeSyntax fieldType) { var variableDeclarationField = SyntaxFactory.VariableDeclaration(fieldType) .AddVariables(SyntaxFactory.VariableDeclarator(fieldName)); return SyntaxFactory.FieldDeclaration(variableDeclarationField) .AddModifiers(SyntaxFactory.Token(SyntaxKind.PrivateKeyword)); }</code> </pre> <br><p>  Then create a public property that returns and accepts this private field. </p><br><pre> <code class="plaintext hljs">private PropertyDeclarationSyntax CreatePropertyDecaration(string fieldName, string propertyName, TypeSyntax propertyType) { var syntaxGet = SyntaxFactory.ParseStatement($"return {fieldName};"); var syntaxSet = SyntaxFactory.ParseStatement($"{fieldName} = value;"); return SyntaxFactory.PropertyDeclaration(propertyType, propertyName) .AddModifiers(SyntaxFactory.Token(SyntaxKind.PublicKeyword)) .AddAccessorListAccessors( SyntaxFactory.AccessorDeclaration(SyntaxKind.GetAccessorDeclaration).WithBody(SyntaxFactory.Block(syntaxGet)), SyntaxFactory.AccessorDeclaration(SyntaxKind.SetAccessorDeclaration).WithBody(SyntaxFactory.Block(syntaxSet))); }</code> </pre> <br><p>  At the same time save the type and name of the source field.  The name of the field is constructed as follows ‚Äú_name‚Äù, and the name of the property ‚ÄúName‚Äù. </p><br><h2 id="ssylki">  Links </h2><br><ol><li>  <a href="https://github.com/Nemo-Illusionist/Roslyn-Encapsulation-check">Sources on GitHub</a> </li><li>  <a href="https://docs.microsoft.com/en-us/dotnet/csharp/roslyn-sdk/">The .NET Compiler Platform SDK</a> </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/455844/">https://habr.com/ru/post/455844/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../455832/index.html">The story of a single SQL investigation</a></li>
<li><a href="../455834/index.html">Benchmarks for Linux servers: 5 open tools</a></li>
<li><a href="../45584/index.html">Amarok 2 RC1 came out and is in the repositories.</a></li>
<li><a href="../455840/index.html">How to work with multiple queries. Composition, Reducer, OP</a></li>
<li><a href="../455842/index.html">Double-page list rotation. Swift Edition</a></li>
<li><a href="../455846/index.html">Distributed computing in Julia</a></li>
<li><a href="../455852/index.html">Sinus lifting and simultaneous implantation</a></li>
<li><a href="../455854/index.html">How to implement context menus (Context Menu) in iOS 13</a></li>
<li><a href="../455856/index.html">Wireless temperature, humidity and atmospheric pressure sensor on the nRF52832</a></li>
<li><a href="../455862/index.html">What's New in AWS: DATA API, Kinesis Data Analytics, S3 Path</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>