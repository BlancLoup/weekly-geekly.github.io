<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We force the php-fpm 5.6 service running through systemd to read global environment variables</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is a short how-to for implementing the configuration of a php service dependent on the environment in which it is running. I will be glad if some...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We force the php-fpm 5.6 service running through systemd to read global environment variables</h1><div class="post__text post__text-html js-mediator-article">  <i>This is a short how-to for implementing the configuration of a php service dependent on the environment in which it is running.</i>  <i>I will be glad if someone prompts a more elegant solution or corrects in the details.</i> <br><br><h4>  main idea </h4><br>  Run a service, microservices and dependent applications within a single ecosystem, <a href="http://12factor.net/config">configured using environment variables</a> . <br><br><h5>  Problem </h5><br>  <s>In this article, ‚Äúenvironment variables‚Äù are repeated too many times.</s> <br>  Out of the box, php-fpm ignores global environment variables ( <a href="http://php.net/manual/en/function.getenv.php">getenv function</a> ), while php cli can get them. <br><a name="habracut"></a><br><h5>  Prehistory </h5><br><blockquote>  You can skip this section if you have already worked with .env </blockquote><br>  I'm currently working on a project written in ZF2.  For configuration of the project, <a href="http://framework.zend.com/manual/current/en/tutorials/config.advanced.html">config files for different environments were used</a> .  This generates a large number of duplicate configurations in a project repository of the following form: <br><ul><li>  session.global.php </li><li>  session.local.php.dist </li><li>  session.unittest.php.dist </li><li>  db.global.php </li><li>  db.local.php.dist </li><li>  db.unittest.php.dist </li><li>  ... </li></ul><br>  These duplicates have to constantly synchronize with each other.  In addition, they store a certain php-logic within themselves, which creates duplicate code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I added a <a href="https://github.com/vlucas/phpdotenv">library</a> to the project that can read the environment from the .env file and load it into $ _ENV (simplified). <br><br><div class="spoiler">  <b class="spoiler_title">Connecting the library vlucas / phpdotenv to ZF2</b> <div class="spoiler_text"><code>composer require vlucas/phpdotenv <br></code> <br>  Open public / index.php <br>  After require 'init_autoloader.php' add: <br><pre> <code class="php hljs">$dotenv = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dotenv\Dotenv(<span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/../'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// $dotenv-&gt;required('SOME_IMPORTANT'); //      $dotenv-&gt;load(); //   overload(),   .env   ,     ( )</span></span></code> </pre><br></div></div><br>  In addition (this is completely optional), I added the laravel env () helper function, which is a wrapper for php getenv (). <br><br><div class="spoiler">  <b class="spoiler_title">Add the env method ($ key, $ default = null) to ZF2</b> <div class="spoiler_text">  Create a file, for example <b>library / Common / Config / env.php</b> , with the contents: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( ! function_exists(<span class="hljs-string"><span class="hljs-string">'value'</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">/** * Return the default value of the given value. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> mixed $value * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $value <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Closure ? $value() : $value; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( ! function_exists(<span class="hljs-string"><span class="hljs-string">'env'</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">/** * Gets the value of an environment variable. Supports boolean, empty and null. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $key * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> mixed $default * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">env</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($key, $default = null)</span></span></span><span class="hljs-function"> </span></span>{ $value = getenv($key); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($value === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value($default); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (strtolower($value)) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'true'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'(true)'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'false'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'(false)'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'empty'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'(empty)'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'null'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'(null)'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $value; } }</code> </pre><br><br>  In <b>composer.json</b> add to the ‚Äúautoload‚Äù section: <br><pre> <code class="hljs objectivec"><span class="hljs-string"><span class="hljs-string">"autoload"</span></span> : { ..., <span class="hljs-string"><span class="hljs-string">"files"</span></span>: [<span class="hljs-string"><span class="hljs-string">"library/Common/Config/env.php"</span></span>] },</code> </pre><br>  Then run <b>composer dumpautoload</b> . <br></div></div><br>  This step allowed to throw out from the repository all unnecessary duplicate config files (local.php, unittest.php, * .php.dist).  Instead, a .env.global appeared at the root of the project with a list of all the available variables that are involved in the configs. <br><br><div class="spoiler">  <b class="spoiler_title">How to configure now?</b> <div class="spoiler_text">  <b>Not the environment knows about the service variables, but the service takes into account the environment in which it is running.</b> <br>  1. Since  on a working machine, environment variables may not have anything, and it is inconvenient to exchange a project between different machines, the phpdotenv library reads the .env file and runs its variables in $ _ENV [$ name] = $ value before launching the application. <br>  2. Configuration files call the env () method, which is a wrapper for the getenv () php function, and reads environment variables, substituting the default value as needed. <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//  : $config['emails']['from'] = env('APP_EMAIL', 'info@myemail.com'); $config['is_production'] = ( 'production' == env('APP_ENV') ); if (env('ZF_DEBUG_TOOLS', false)) { $config['modules'][] = 'ZendDeveloperTools'; }</span></span></code> </pre><br>  3. The .env file does <i>not have to be filled</i> .  You can use global environment variables or default values ‚Äã‚Äãin the configuration.  In the absence of a .env file, exception is thrown (a feature of the library, not the most correct one), you can not connect it at all to the production server.  To avoid the exception, the file just needs to be created in the project root (touch .env). <br>  4. The .env file does not need to store all available project variables.  If default values ‚Äã‚Äãare set in configs, it is enough to write only variables that are different in this environment into .env. <br>  5. The .env file does <i>not need to be committed</i> to the repository.  It should be added to ignore for a version control system. <br>  6. To make the environment variable mandatory, add the following construction to index.php: <br><pre> <code class="php hljs">$dotenv-&gt;required(<span class="hljs-string"><span class="hljs-string">'APP_ENV'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  APP_ENV          .env   </span></span></code> </pre> <br>  7. In the project repository, you can commit files of the form .env. * (.Env.phpunit, .env.develop).  This is nothing but bookmarks with a set of variables for different environments.  The orchestrator or CI system simply copies the template (or variables from it) when the project is deployed where the project is deployed in several copies within one system or it is not possible to operate with global environment variables.  Bookmarks convenient to compare with each other.  These bookmarks do not participate in the service logic. <br><blockquote>  Important: .env.production should not be stored in the project repository. <br>  It is convenient to create .env.default - a file that contains all the environment variables supported in the project at the moment (the maximum possible template for .env). </blockquote><br><br>  - <i>So, now all configs need to be duplicated in .env?</i>  <i>When to add a new environment variable?</i> <br><br>  It is worth taking the configuration to the environment if this option may differ on different hosts. <br>  There is nothing wrong with writing something into environment variables. <br><pre> <code class="php hljs">$config[<span class="hljs-string"><span class="hljs-string">'csv_separator] = '</span></span> | <span class="hljs-string"><span class="hljs-string">'; //      ,    . $config['</span></span>like_panel<span class="hljs-string"><span class="hljs-string">'] = true; //   ,    env('</span></span>APP_LIKE_PANEL<span class="hljs-string"><span class="hljs-string">', false) $config['</span></span>facebook_app_id<span class="hljs-string"><span class="hljs-string">'] = 88888888881; //    </span></span></code> </pre><br><br>  - <i>What about passwords and sensitive data?</i> <br><br>  Store production data in a separate repository, in a password repository, or, for example, <a href="http://docs.ansible.com/ansible/playbooks_vault.html">in an orchestra secure storage</a> . <br></div></div><br><br><h4>  So, the project now takes into account the environment, but ... </h4><br>  While the development was done on working machines, the project read the .env file and everything worked.  But when I deployed the test environment, it turned out that if you set the actual system environment variables, php-fpm ignores them.  Various recipes from Google and StackOverflow boiled down to one or another automation using two well-known methods: <br><br>  1. Passing variables via nginx with the parameter fastcgi_param SOMEENV test; <br>  2. Setting variables in the env [SOME_VAR] format <a href="http://stackoverflow.com/a/30822781/1929406">in the php-fpm workflow pool configuration</a> . <br><br>  Both the first and second options are convenient for some special situations.  But if you think in the paradigm of ‚Äúconfiguring an environment, not an application‚Äù, then such methods are much more difficult than, for example, simply putting an .env file in a folder with a project.  But the orchestrator, the CI system, or just the system administrator should not know the details of the project, it is not elegant. <br><br><h5>  Proposed solution </h5><br>  Combining various recipes from the network, I groped the following working solution. <br>  Tested under Centos 7, PHP 5.6.14. <br><br><pre> <code class="bash hljs">1.  /etc/php.ini -  variables_order = <span class="hljs-string"><span class="hljs-string">"GPCS"</span></span>  variables_order = <span class="hljs-string"><span class="hljs-string">"EGPCS"</span></span> <span class="hljs-comment"><span class="hljs-comment">#   PHP       # http://php.net/manual/ru/ini.core.php#ini.variables-order 2.  /etc/php-fpm.d/www.conf,    /etc/php-fpm.conf (       ,   www-   php-fpm. -  ( ,   ): clear_env = no #        3.      /etc/environment (  A=B) 4. ln -fs /etc/environment /etc/sysconfig/php-fpm #      php-fpm       5. systemctl daemon-reload &amp;&amp; service php-fpm restart</span></span></code> </pre><br><br>  The same approach with symlink, in theory, is applicable to other services. <br><br>  <b>Pros of the proposed solution:</b> <br>  - Variables stored in / etc / environment are available to different applications.  You can call echo $ MYSQL_HOST in the shell or getenv ('MYSQL_HOST') in php. <br>  - Environment variables that are not explicitly set in / etc / environment will not fall into php-fpm.  This allows using the orchestrator to control the environment from outside the isolated system in which the service is running. <br><br>  <b>Minuses:</b> <br>  ‚ÄúUnfortunately, I did not find a working command for reload in php-fpm by analogy with nginx, so if you change / etc / environment, you must do <i>systemctl daemon-reload &amp;&amp; service php-fpm restart</i> . <br><br><blockquote>  <b>Important</b> : if your application does not work in an isolated environment (server, virtual machine, container), the definition of environment variables can unpredictably affect neighboring services in the system due to the coincidence of names in the global space. </blockquote><br><br>  References: <br>  - <a href="http://stackoverflow.com/a/33576149/1929406">For those who have not read the article</a> <br>  - The methodology of the twelve factors of the development of SAAS: <a href="http://12factor.net/config">keep the configuration in the environment</a> (eng.) <br>  - Loading <a href="https://github.com/vlucas/phpdotenv">environment</a> variables <a href="https://github.com/vlucas/phpdotenv">using .env-files</a> for the development environment in php-projects. </div><p>Source: <a href="https://habr.com/ru/post/270359/">https://habr.com/ru/post/270359/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../270339/index.html">Observer vs Pub-Sub</a></li>
<li><a href="../270343/index.html">Building native applications in ExtJS 6</a></li>
<li><a href="../270347/index.html">How is the profession "Data Scientist"</a></li>
<li><a href="../270351/index.html">Pure architecture in a go app. Part 2</a></li>
<li><a href="../270353/index.html">Overview of ES6 at 350 points. Part one</a></li>
<li><a href="../270361/index.html">Animation of transitions between two fragments</a></li>
<li><a href="../270363/index.html">Game with a list of conditions</a></li>
<li><a href="../270365/index.html">Evaluation of test coverage on the project</a></li>
<li><a href="../270367/index.html">How I won the Beeline BigData Contest</a></li>
<li><a href="../270369/index.html">Using websocket in Extjs applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>