<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development of chat bots for Telegram and Slack using PHP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="general information 


 This article describes how to create simple chat bots for Telegram and Slack services using the example of checking IP | Email...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development of chat bots for Telegram and Slack using PHP</h1><div class="post__text post__text-html js-mediator-article"><h5>  general information </h5><br><p>  This article describes how to create simple chat bots for Telegram and Slack services using the example of checking IP | Email for spam using the <a href="https://cleantalk.org/">CleanTalk</a> anti-spam service. </p><a name="habracut"></a><br><h5>  Telegram </h5><br><p>  The first step is to create your bot (in our case, @CleanTalkBot) - for this, there is the @BotFather bot in Telegram.  Add it to your Telegram account and set the / newbot command.  The bot will ask you to enter the name of the bot - enter the name.  After that we enter the bot's username - we have made the bot's name and bot's username the same - while the username must end in bot or Bot - for example, HabrArticleBot or CleanTalkBot.  After entering the username, the bot will be created and you will be given a token, which will be used later for identification. </p><br><img src="https://habrastorage.org/getpro/habr/post_images/a28/1ed/4d3/a281ed4d389db4e129455408b540fd9d.png"><br><p>  The second step is to install the so-called webhook - in other words, the request handler that comes into the chat bot from users.  When a user sets a command to your chat bot, Telegram addresses the address that was set as the webhook, sends the user message and service information, your handler generates a response and sends back Telegram, after which Telegram responds to the user.  This is done using the curl command in the terminal - </p><br><pre><code class="hljs objectivec">curl -d <span class="hljs-string"><span class="hljs-string">"url=https://example.com/telegramwaiter.php"</span></span> https:<span class="hljs-comment"><span class="hljs-comment">//api.telegram.org/botYOUR_TELEGRAM_TOKEN/setWebhook</span></span></code> </pre> <br><p>  where YOUR_TELEGRAM_TOKEN is the same token that was given to you by the @BotFather bot earlier, and <a href="https://example.com/telegramwaiter.php">https://example.com/telegramwaiter.php</a> is the address that Telegram will address with requests.  In response, Telegram should return a json type string </p><br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"ok"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>,<span class="hljs-attr"><span class="hljs-attr">"result"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>,<span class="hljs-attr"><span class="hljs-attr">"description"</span></span>:<span class="hljs-string"><span class="hljs-string">"Webhook is set"</span></span>}</code> </pre> <br><p>  which means - the handler for your chat bot has been successfully installed. </p><br><p>  Here you need to add that Telegram works only on https - if you have a certificate issued by special organizations (not self-signed), then everything is fine, if you want to use self-signed certificates - please refer to the documentation here <a href="https://core.telegram.org/bots/self-signed">https://core.telegram.org/ bots / self-signed</a> . </p><br><p>  The third step is to write the request handler from Telegram telegramwaiter.php - a sample script in PHP looks like this </p><br><pre> <code class="hljs ruby">&lt;?php set_time_limit(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   $botToken = <span class="hljs-string"><span class="hljs-string">"YOUR_TELEGRAM_TOKEN"</span></span>; $website = <span class="hljs-string"><span class="hljs-string">"https://api.telegram.org/bot"</span></span>.$botToken; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    Telegram $content = file_get_contents(<span class="hljs-string"><span class="hljs-string">"php://input"</span></span>); $update = json_decode($content, TRUE); $message = $update[<span class="hljs-string"><span class="hljs-string">"message"</span></span>]; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     Telegram  ,     $chatId = $message[<span class="hljs-string"><span class="hljs-string">"chat"</span></span>][<span class="hljs-string"><span class="hljs-string">"id"</span></span>]; $text = $message[<span class="hljs-string"><span class="hljs-string">"text"</span></span>]; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    /start <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($text == <span class="hljs-string"><span class="hljs-string">'/start'</span></span>) { $welcomemessage = <span class="hljs-string"><span class="hljs-string">'Welcome!!! Check IP/Email for spam giving "check IP/Email" command'</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      Telegram  file_get_contents($website.<span class="hljs-string"><span class="hljs-string">"/sendmessage?chat_id="</span></span>.$chatId.<span class="hljs-string"><span class="hljs-string">"&amp;text="</span></span>.$welcomemessage); } ?&gt;</code> </pre> <br><p>  The order is as follows: in the $ text variable, we receive a command from the user in the chat, form a message according to the required logic, and give it back to the user using the file_get_contents () function. </p><br><p>  How all this works can be done by adding the @CleanTalkBot bot to the Telegram - enter the command <strong>check IP | Email</strong> and get information about whether the specified IP | Email is spam. </p><br><p>  Response example </p><br><pre> <code class="hljs kotlin">Email <span class="hljs-symbol"><span class="hljs-symbol">stop_email@</span></span>example.com <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> BLACKLISTED. Frequency <span class="hljs-number"><span class="hljs-number">999</span></span>. Updated Apr <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">2019</span></span>. https:<span class="hljs-comment"><span class="hljs-comment">//cleantalk.org/blacklists/stop_email@example.com.</span></span></code> </pre> <br><h4>  Slack </h4><br><p>  The Slack service has a slightly different approach to creating chat bots. </p><br><p>  Go here - <a href="https://api.slack.com/apps/new">https://api.slack.com/apps/new</a> - and create a new Slack application. </p><br><img src="https://habrastorage.org/getpro/habr/post_images/2ed/74c/27e/2ed74c27e785fab27d67052a97d25190.png"><br><p>  <strong>AppName</strong> is the name of the application. <br>  <strong>Short description</strong> - a short description of the application. <br>  <strong>Describe what your app does on Slack</strong> - a complete description of the application. <br>  <strong>Link to clear instructions for your Slack app.</strong> <strong><br></strong>  <strong>Link to support for your Slack app</strong> - two links to pages with a description of the installation and use of this application. </p><br><p>  In the list of applications <a href="https://api.slack.com/apps">https://api.slack.com/apps,</a> select our application and go to the menu on the right by the link Slash Commands and click the button Create new command. </p><br><img src="https://habrastorage.org/getpro/habr/post_images/84e/698/603/84e6986030ac43b7da7fb3f38dfdf33e.png"><br><p>  In the form that appears, the following fields </p><br><img src="https://habrastorage.org/getpro/habr/post_images/892/441/400/892441400f5de4970b6a260ff7b3ea09.png"><br><p>  <strong>Command</strong> - enter the command starting with / - for example / ctcheck. </p><br><p>  <strong>Request URL</strong> - the URL of the command request handler is analogous to a webhook Telegram (for example <a href="https://cleantalk.org/slackwaiter.php">https://cleantalk.org/slackwaiter.php</a> ). </p><br><p>  <strong>Short description</strong> - a short description of what can be done with the help of the command created. </p><br><p>  Save the command.  Please note - your site should work on https - while self-signed certificates are NOT SUPPORTED by the Slack service. </p><br><p>  You can get the identification token on the command list page - under the list of commands there is the Verification token field - then it appears as YOUR_SLACK_TOKEN. </p><br><p>  Writing slackwaiter.php handler in PHP </p><br><pre> <code class="hljs bash">&lt;?php set_time_limit(0); //    Slack        Slack <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$_POST</span></span>[<span class="hljs-string"><span class="hljs-string">'token'</span></span>] == <span class="hljs-string"><span class="hljs-string">'YOUR_SLACK_TOKEN'</span></span>) { // <span class="hljs-variable"><span class="hljs-variable">$param</span></span> -   ,     //    /ctcheck 127.0.0.1 //  <span class="hljs-variable"><span class="hljs-variable">$param</span></span> = 127.0.0.1 <span class="hljs-variable"><span class="hljs-variable">$param</span></span> = <span class="hljs-variable"><span class="hljs-variable">$_POST</span></span>[<span class="hljs-string"><span class="hljs-string">'text'</span></span>]; //         <span class="hljs-variable"><span class="hljs-variable">$slackresponse</span></span> = <span class="hljs-string"><span class="hljs-string">'   '</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-variable"><span class="hljs-variable">$slackresponse</span></span> = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-variable"><span class="hljs-variable">$response</span></span> = array(); <span class="hljs-variable"><span class="hljs-variable">$response</span></span>[<span class="hljs-string"><span class="hljs-string">'text'</span></span>] = <span class="hljs-variable"><span class="hljs-variable">$slackresponse</span></span>; header(<span class="hljs-string"><span class="hljs-string">'Content-Type: application/json'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> json_encode(<span class="hljs-variable"><span class="hljs-variable">$response</span></span>); ?&gt;</code> </pre> <br><p>  Next we go here <a href="https://api.slack.com/docs/slack-button">https://api.slack.com/docs/slack-button</a> and in the <strong>Add the Slack button</strong> section we tick the incoming webhook and commands - Slack forms the html-code of the button, by clicking on which other teams can integrate your application into your Slack account. </p><br><p>  The above button is placed on your site - by pressing it, the following picture opens </p><br><img src="https://habrastorage.org/getpro/habr/post_images/46d/5f7/69a/46d5f769a63558ab8f0c9b7669ecdd79.png"><br><p>  For authorization, you need to select the channel where you can use the application. </p><br><p>  By clicking on the Authorize Slack button redirect the user to the Redirect URI (s) page, which is set by you (the developer) here - <a href="https://api.slack.com/apps">https://apilack.com/apps</a> , select your application and follow the link App Credentials - we see the following picture </p><br><img src="https://habrastorage.org/getpro/habr/post_images/f95/817/960/f95817960c662d9fad3b28b2d480f862.png"><br><p>  Slack does not just redirect the user to this page, but adds a GET-variable code with a value that should later be processed by a script - for example </p><br><pre> <code class="hljs objectivec">https:<span class="hljs-comment"><span class="hljs-comment">//cleantalk.org/authscript.php?code=Slack_Code</span></span></code> </pre> <br><p>  Below is the sample script code authscript.php.  CLIENT_ID and CLIENT_SECRET are taken from the corresponding fields in the previous image. </p><br><pre> <code class="hljs xml"><span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?php</span></span></span><span class="php"> </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">if</span></span></span><span class="php"> (</span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">isset</span></span></span><span class="php">($_GET[</span><span class="hljs-string"><span class="php"><span class="hljs-string">'code'</span></span></span><span class="php">])) { $client_id = </span><span class="hljs-string"><span class="php"><span class="hljs-string">'CLIENT_ID'</span></span></span><span class="php">; $client_secret = </span><span class="hljs-string"><span class="php"><span class="hljs-string">'CLIENT_SECRET'</span></span></span><span class="php">; $code = $_GET[</span><span class="hljs-string"><span class="php"><span class="hljs-string">'code'</span></span></span><span class="php">]; $response = file_get_contents(</span><span class="hljs-string"><span class="php"><span class="hljs-string">"https://slack.com/api/oauth.access?client_id="</span></span></span><span class="php">.$client_id.</span><span class="hljs-string"><span class="php"><span class="hljs-string">"&amp; client_secret="</span></span></span><span class="php">.$client_secret.</span><span class="hljs-string"><span class="php"><span class="hljs-string">"&amp;code="</span></span></span><span class="php">.$code); $responsearr = json_decode($response, </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">true</span></span></span><span class="php">); </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">if</span></span></span><span class="php"> (</span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">isset</span></span></span><span class="php">($responsearr[</span><span class="hljs-string"><span class="php"><span class="hljs-string">'team_name'</span></span></span><span class="php">])){ header(</span><span class="hljs-string"><span class="php"><span class="hljs-string">'Location: https://'</span></span></span><span class="php">.$responsearr[</span><span class="hljs-string"><span class="php"><span class="hljs-string">'team_name'</span></span></span><span class="php">].</span><span class="hljs-string"><span class="php"><span class="hljs-string">'.slack.com'</span></span></span><span class="php">); </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">exit</span></span></span><span class="php">(); } </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">else</span></span></span><span class="php"> { </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">echo</span></span></span><span class="php"> </span><span class="hljs-string"><span class="php"><span class="hljs-string">'.'</span></span></span><span class="php">; </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">exit</span></span></span><span class="php">(); } } </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">else</span></span></span><span class="php"> </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">exit</span></span></span><span class="php">(); </span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre> <br><p>  The order is this - we get the code variable from Slack GET and with two more parameters - client_id and client_secret - we send GET with a request to <a href="https://slack.com/api/oauth.access">https://slack.com/api/oauth.access</a> .  In response, Slack will send a json string with multiple fields - something like this </p><br><pre> <code class="hljs cs">{<span class="hljs-string"><span class="hljs-string">'ok'</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">'team_name'</span></span>: <span class="hljs-string"><span class="hljs-string">'your_team_name'</span></span>}</code> </pre> <br><p>  after which we just get the name of the command and redirect the user to the main page of his team <a href="https://your_team_name.slack.com/">https://your_team_name.slack.com</a> - the application is authorized, you can use the application commands. </p><br><p>  The <a href="https://cleantalk.org/">Cleantalk</a> service <a href="https://cleantalk.org/">team</a> hopes that this information will be useful for anyone interested in chat bots development. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/302870/">https://habr.com/ru/post/302870/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302860/index.html">Create arkanoid in pure javascript from scratch. CANVAS</a></li>
<li><a href="../302862/index.html">What to do in a large company with incompetent management</a></li>
<li><a href="../302864/index.html">Watch the recording of the opening of the virtual forum ‚ÄúData. Technology. SQL Server 2016 ¬ª</a></li>
<li><a href="../302866/index.html">Should I give a discount on the software and how to do it correctly</a></li>
<li><a href="../302868/index.html">How to choose hard drives for servers?</a></li>
<li><a href="../302872/index.html">Azure-IaaS-Digest number 7 (May-June)</a></li>
<li><a href="../302874/index.html">Facebook Messenger was vulnerable to an attack that required basic HTML knowledge.</a></li>
<li><a href="../302880/index.html">Online casinos are gaining popularity</a></li>
<li><a href="../302882/index.html">On which CMS are the websites of law firms?</a></li>
<li><a href="../302884/index.html">GitLab released version 8.8</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>