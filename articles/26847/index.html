<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Naked truth</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tedious technical details, without which it can not do, are highlighted with a paragraph sign: ¬∂. I hope you can skip them without losing the meaning ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Naked truth</h1><div class="post__text post__text-html js-mediator-article">  <i>Tedious technical details, without which it can not do, are highlighted with a paragraph sign: ¬∂.</i>  <i>I hope you can skip them without losing the meaning of the presentation.</i> <br><br><h2>  Part one.  Landing </h2><br>  As it happens often, recently, new viruses come straight to the mail - quickly, conveniently and do not have to strain at all.  The last virus sent itself in this letter: <br><blockquote>  From: "Shauna Hoover" &lt;olwen.davie@mairie-paris.fr&gt; <br>  To: &lt;xxx@xxx.xx&gt; <br>  Subject: Paris Hilton <br><br>  Good afternoon, buddy. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I found nude Angelina Jolie! <br>  See in attachment! <br>  Bye. </blockquote><br>  At first, of course, he confuses why the topic of the letter is about P. Hilton, and inside - about A. Jolie, but ... let's get into the position of network villains!  Their work is nervous, sometimes they make mistakes.  It‚Äôs good that at all letters reach the addressees, they tried. <br><br>  The attached file is called xjolie.scr.zip, and inside it contains a ‚Äúlike‚Äù screensaver xjolie.scr.  The file is suspicious: there is little code, only three functions, almost no data either.  The screensaver does not pull, and for the virus is not enough.  Kaspersky‚Äôs online scanner designates a file as infected by the ‚ÄúTrojan.Win32.Pakes.cyu‚Äù virus. <br><a name="habracut"></a><br><blockquote>  <font color="#666666"><font>¬∂</font> At the very beginning of execution, we come across a surprise: the program calls the NtDeleteValueKey function (using KiFastCallEntry, which is essentially a sysenter instruction), and passes to it as arguments uninitialized local variables in which any garbage lies.</font>  <font color="#666666">Therefore, NtDeleteValueKey in 99.9 percent of cases should return STATUS_INVALID_HANDLE.</font>  <font color="#666666">This value (0xC0000008) is used as a starting value, from which by long calculations (numerous ‚Äúgarbage‚Äù arithmetic operations), the program gets some address it needs.</font>  <font color="#666666">The task of the system call here, apparently, is to trick automatic analyzers and other antiviruses.</font> <br></blockquote><br>  By the way, Simantek, who was working at that moment, did not even utter a word, and stubbornly repeated ‚ÄúClean‚Äù;  so once again I am sure that it is not worth hoping for a heuristic analysis in the next twelve years. <br><br>  The program extracts a data block from its body and decodes it.  After that, it copies it in small parts (apparently, so as not to arouse suspicion) into a dynamically allocated memory area for this purpose. <br><blockquote>  <font color="#666666"><font>¬∂ The</font> address on which the encrypted data is located initially leads, seemingly, to where it is not clear where.</font>  <font color="#666666">But in fact it turns out - in the application resources:</font> <font color="#666666"><br><img src="https://habrastorage.org/getpro/habr/olpictures/d79/b44/549/d79b44549980c6fbaca75580209ac78f.gif" width="450" height="115" hspace="10" vspace="10"><br></font>  <font color="#666666">After the program has deciphered itself, we do a dump:</font> <pre>  .writemem unpacked0.dmp 00402088 L00009400 </pre>  , writing the decrypted file to disk. </blockquote><br><br>  This data block is actually also a full-fledged executable file, which we will call <b>unpacked0</b> .  This program is already a real dropper whose goal is to install malware on the victim's computer. <br><br>  The structure of the dropper code is quite clear and simple, apparently written in "C".  The file inside contains the line "d: \ programs \ siberia \ install \ objfre_wxp_x86 \ i386 \ Install.pdb".  This is hardly an unfortunate omission.  Maybe the author is trying in this way to inform the anti-virus companies, the manufacturer-recommended official name of the virus? <br><br><img src="https://habrastorage.org/getpro/habr/olpictures/56b/194/66d/56b19466d60683db8938d4968f144a36.gif" width="450" height="110" hspace="10" vspace="10"><br><br><h2>  Installation </h2><br>  <b>Check OS version.</b>  To be honest, this piece of code surprised me. <br><blockquote> <font color="#666666">In pseudocode, it looks like this:</font> <font color="#666666"><br> <code>if Version.Major = 5 <br> if Version.Minor = 0 <br> is_win2k = 1 <br> else <br> is_win2k = 0 <br> else <br> is_win2k = 0 <br> is_win2k_temp = is_win2k</code> <br></font>  <font color="#666666">After that, there are three more blocks one-on-one: for XP and 2003 server.</font>  <font color="#666666">Why so many variables and how many comparisons?</font>  <font color="#666666">In short, I did not understand these dances with a tambourine.</font> <font color="#666666"><br></font> </blockquote><br>  The program checks the current version of the OS, and finishes its work if it is not a Windows 2000, XP or 2003 server. <br><br>  <b>Base address</b> .  <b>unpacked0</b> , as befits a proper paratrooper, finds out where he finally ended up.  For this purpose, one of the simplest search methods is used, based on the fact that the beginning of the loaded image coincides with the beginning of the memory page.  Its default size on our regular x86 computers is four kilobytes.  The current place in the code is taken, from it we go to the beginning of the current page, we look for the MZ signature at the beginning, if not found, go to the previous page. <br><br>  <b>Import table</b> .  Since <b>unpacked0</b> cannot rely on a fixed base address specified during compilation, the import table must also be updated.  To do this, the program parses its own header (which is located at the very beginning of the downloaded image, and its address was found at the last step), parses the header of the kernel32 library in the same way, finds its export table, and finds two main functions by simple string matching: LoadLibraryA and GetProcAddress, using them, loads all other functions necessary for its black case. <br><br>  <b>Extract Driver</b> .  Yes, damn it, driver again.  Viruses without a driver, it seems, already just suckers write.  As some have already guessed, the driver body is contained in the resources at <b>unpacked0</b> .  By the way, the driver file contains the string "d: \ programs \ siberia \ protect \ objfre_wxp_x86 \ i386 \ protect.pdb".  The trend however ... <br><br><img src="https://habrastorage.org/getpro/habr/olpictures/fc2/a3e/c04/fc2a3ec049acee1ca8964d64057d441c.gif" width="450" height="95" hspace="10" vspace="10"><br><br>  The body of the driver is copied to the dynamically allocated memory area, after which its checksum is checked. <br><br>  <b>Extract winnt32.dll</b> .  And now, - attention, - feint ears.  <b>Another component is extracted</b> from the newly extracted driver.  From resources, but what about.  Now the number of components of our virus is four: the initial xjolie file, the unzipped installer (unpacked0), the driver and the library with the modest name winnt32.dll. <br>  The general unpacking scheme is shown in the figure (blue is the code, brown is the resources). <br><img src="https://habrastorage.org/getpro/habr/olpictures/865/797/1d3/8657971d3dd2eb38ed19f9a55b3937cc.gif" width="378" height="671" alt="Sequential unpacking of programs" hspace="10" vspace="10"><br><br>  The name ‚Äúwinnt32.dll‚Äù is not randomly chosen from ‚Äúscary‚Äù, even advanced users are unlikely to decide to delete such a file. <br><blockquote>  <font color="#666666"><font>¬∂</font></font> <pre> kernel32! CreateFileA:
 7c801a24 8bff mov edi, edi
 0: 000&gt; da poi (esp + 4)
 0012feac "C: \ WINDOWS \ System32 \ WinNt32.dll" </pre></blockquote><br><br>  If for some reason it is impossible to create such a file, the dropper adds an underscore at the end of the name.  This file with an underscore will be renamed to the desired one after a reboot - the MoveFileEx function with the MOVEFILE_DELAY_UNTIL_REBOOT flag is called for this.  This will be done again under the system account and the probability of success is very high. <br><br>  <b>Setup winnt32.dll</b> .  Actually, using the library as the main Trojan file is an interesting move.  Antiviruses and users practically do not pay attention to them, and in principle, reasonably: after all, not an executable file, which is there.  Still, there are ways to force the system to load the library and transfer control to it.  The method used by this trojan is rather original: it uses the winlogon process notification mechanism. <br><br>  In order to enable this mechanism, the dropper adds the following values ‚Äã‚Äãto the HKEY_LOCAL_MACHINE \ SOFTWARE \ Microsoft \ Windows NT \ CurrentVersion \ Winlogon \ Notify registry key <br><blockquote>  DLLName: winnt32.dll <br>  StartShell: WLEventStartShell <br>  Impersonate: 0 <br>  Asynchronous: 0 </blockquote><br>  (A list of possible parameters with a description is given here: <a href="http://msdn.microsoft.com/en-us/library/aa379402.aspx">msdn.microsoft.com/en-us/library/aa379402.aspx</a> ) <br><br>  This briefly means that Winlogon, when logging in to the user, is obliged to load winnt32.dll, call the WLEventStartShell function in it, synchronously, without using impersonalization ‚Äî under the same account under which winlogon itself, that is, SYSTEM, works.  For the user who will log in, it means Scary Things. <br><br>  At this point, the installation of winnt32.dll is complete, and the dropper returns to the driver. <br><br>  <b>Driver installation</b> .  First of all, the dropper tries to connect to the already installed driver using the device name "" \\. \ Prot2 ". If it fails to connect, it saves the driver's body to a file with a random name like% SystemRoot% \ System32 \ drivers \ Wwwdd.sys where W is capitalized, w - lowercase letters, d - numbers. <br><blockquote> <code>kernel32!CreateFileA: <br> 7c801a24 8bff mov edi,edi <br> 0:000&gt; da poi(esp+4) <br> 0012fc94 "C:\WINDOWS\System32\drivers\Hwo84.sys"</code> </blockquote> <br><br>  After this, the driver is registered and started by the CreateService-StartService API functions.  Also, the dropper adds the necessary registry lines to the sections. <br><blockquote>  SYSTEM \ CurrentControlSet \ Control \ SafeBoot \ Network \ <br>  SYSTEM \ CurrentControlSet \ Control \ SafeBoot \ Minimal \ <br>  SYSTEM \ ControlSet002 \ Services \ <br>  SYSTEM \ ControlSet001 \ Services \ </blockquote><br>  That is, when you return to the last successful configuration or boot in safe mode, the driver will still load.  Very mean. <br><br>  Then it calls cmd.exe with the command line <b>/ c del FILENAME &gt;&gt; NULL</b> , deleting itself from the user's computer. <br><br><h2>  Conclusion </h2><br>  Under the guise of a naked diva hides not just a trojan.  This is a whole program complex of three programs - an installer, a rootkit driver, and a dynamic user mode library.  The techniques used to introduce malicious code are simple, effective and not without originality.  But, as always, I will note that with a banned entry in% SYSTEMROOT% \ system32, the installer breaks off in full. <br><br>  In the second part, we will look at the malicious functionality of the dropped-down library winnt32.dll and its dark defender driver. </div><p>Source: <a href="https://habr.com/ru/post/26847/">https://habr.com/ru/post/26847/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../26846/index.html">What is Greasemonkey and how will it improve your internet life?</a></li>
<li><a href="../268461/index.html">Checklist: How to load pages faster</a></li>
<li><a href="../268463/index.html">Kotlin ‚ù§ FP</a></li>
<li><a href="../268467/index.html">4 rules of content management interfaces that no one observes</a></li>
<li><a href="../268469/index.html">Battle for time: how the upgrade of the processor, software and video card affects the acceleration of video post-processing</a></li>
<li><a href="../268471/index.html">Microsoft will soon close support for outdated versions of Internet Explorer</a></li>
<li><a href="../268473/index.html">NutanixOS 4.5: Important Update and Big Plans</a></li>
<li><a href="../26848/index.html">Sending SMS Via Jabber</a></li>
<li><a href="../268483/index.html">VII Hi-Tech Tour Inoventica Cloud Center: "Cloud Oktoberfest"</a></li>
<li><a href="../268485/index.html">PostgreSQL and related tasks on HighLoad ++</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>