<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Custom instruments: when signpost is not enough</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Instruments for Apple's Xcode are tools for analyzing the performance of an iOS application. They are used to collect and display data that is needed ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Custom instruments: when signpost is not enough</h1><div class="post__text post__text-html js-mediator-article">  Instruments for Apple's Xcode are tools for analyzing the performance of an iOS application.  They are used to collect and display data that is needed in debugging code.  Last year, Apple <a href="https://developer.apple.com/videos/play/wwdc2018/410/">presented</a> Custom Instruments.  This is an opportunity to expand the standard set of tools for profiling applications.  When the existing tools are not enough, you can create new ones yourself - they will collect, analyze and display the data as you need. <br><br>  A year has passed, and there are almost no new public tools and information on their creation in the network.  So we decided to correct the situation and share how we created our own Custom Instrument, which determines the reason for the weak isolation of the unit tests.  It is based on signpost technology (we wrote about it <a href="https://habr.com/ru/company/sberbank/blog/443414/">in the previous article</a> ) and allows you to quickly and accurately determine the place where the test flashes. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/09b/036/450/09b0364507aac3a8e15ca618f772c329.png"><br><a name="habracut"></a><br><h2>  Theoretical minimum </h2><br>  To create a new tool for Xcode, you need an understanding of two theoretical blocks.  Those who want to figure it out on their own will immediately give the necessary links: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  <a href="https://help.apple.com/instruments/developer/mac/current/">on the structure of the markup file</a> tool .instrpkg <br></li><li>  <a href="http://www.clipsrules.net/Documentation.html">about CLIPS</a> for programming tool logic <br></li></ul><br>  For the rest - below a brief summary on the necessary topics. <br><br>  First select File -&gt; New -&gt; Project -&gt; category macOS -&gt; Instruments package.  The created project includes a file with the .instrpkg extension, in which a new tool is declared declaratively in the xml format.  Let's look at the markup elements: <br><br><table><tbody><tr><td width="100">  <b>what</b> </td><td width="100">  <b>Attributes</b> </td><td>  <b>Description</b> <br></td></tr><tr><td>  Data schemas <br></td><td>  interval-schema, point-schema, etc. <br></td><td>  Describes a data structure in the form of a table like sql schemas.  Schemes are used in other markup elements to determine the type of data in the input and output of the model, for example, when describing a display (UI). <br></td></tr><tr><td>  Import data schemas <br></td><td>  import-schema <br></td><td>  Import ready-made schemes.  It allows you to use data structures that are defined by Apple. <br></td></tr><tr><td>  Tool model <br></td><td>  modeler <br></td><td>  Associates a tool with a .clp file in which the tool logic is defined, and declares the expected data scheme at the input and output of the model. <br></td></tr><tr><td>  Tool description <br></td><td>  instrument <br></td><td>  Describes the data model and determines how events will be displayed in the UI.  The data model is described using the create-table, create-parameter, and other attributes.  Tool plots are defined by graph attributes, and the details table is list, narrative, etc. <br></td></tr></tbody></table><br>  If we want to supplement the logic of the new tool, then create a .clp file with CLIPS code.  Basic entities of the language: <br><br><ul><li>  ‚ÄúFact‚Äù is a certain event registered in the system using the assert command; <br></li><li>  "Rule" is an if-block with a specific syntax, containing the condition under which the set of actions is performed. <br></li></ul><br>  Which rules and in what sequence will be activated is determined by CLIPS itself on the basis of incoming facts, priorities of the rules and the mechanism of conflict resolution. <br><br>  The language supports the creation of data types based on primitives, the use of arithmetic, logical operations and functions.  As well as full-fledged object-oriented programming (OOP) with the definition of classes, sending messages, multiple inheritance. <br><br>  Consider the basic syntax of the language, which allows you to create logic for custom tools. <br><br>  1. To create a <code>fact</code> , use the <code>assert</code> construct: <br><br><pre> <code class="plaintext hljs">CLIPS&gt; (assert (duck))</code> </pre> <br>  Thus, we get the <code>duck</code> entry in the fact table, which can be viewed using the <code>facts</code> command: <br><br><pre> <code class="plaintext hljs">CLIPS&gt; (facts)</code> </pre> <br>  To delete a fact, use the command <code>retract</code> : <code>(retract duck)</code> <br><br>  2. To create a <code>rule</code> , use the <code>defrule</code> construction: <br><br><pre> <code class="plaintext hljs">CLIPS&gt; (defrule duck) ‚Äî     duck (animal-is duck)&lt;/i&gt; ‚Äî  animal-is duck     =&gt; (assert (sound-is quack))) ‚Äî     sound-is quack</code> </pre> <br>  3. To create and use variables, use the following syntax (the name of the variable is preceded by the required "?"): <br><br><pre> <code class="plaintext hljs">?&lt;variable-name&gt;</code> </pre> <br>  4. You can create new data types with: <br><br><pre> <code class="plaintext hljs">CLIPS&gt; (deftemplate prospect (slot name (type STRING) (default ?DERIVE)) (slot assets (type SYMBOL) (default rich)) (slot age (type NUMBER) (default 80)))</code> </pre> <br>  So, we defined a structure called prospect and three attributes name, assets and age of the corresponding type and a default value. <br><br>  5. Arithmetic and logical operations have a prefix syntax.  That is, to add 2 and 3, you must use the following structure: <br><br><pre> <code class="plaintext hljs">CLIPS&gt; (+ 2 3)</code> </pre> <br>  Or to compare two variables x and y: <br><br><pre> <code class="plaintext hljs">CLIPS&gt; (&gt; ?x ?y)</code> </pre> <br><h2>  Practical example </h2><br>  In our project, we use the <a href="http://ocmock.org/">OCMock</a> library to create stub objects.  However, there are situations when the mock lives longer than the test for which it was created, and affects the isolation of other tests.  In the end, this leads to "flashing" (instability) unit-tests.  To track the lifetime of tests and mocks, create your own tool.  Below is the algorithm of action. <br><br><h3>  Step 1. Make markup signpost events </h3><br>  To detect problem mocks, two categories of interval events are needed - the time of creation and destruction of the mock, the time of start and end of the test.  To get these events, go to the <code>OCMock</code> library and <code>OCMock</code> them using <code>signpost</code> in the <code>init</code> and <code>stopMocking</code> methods of the <code>stopMocking</code> class. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1b6/5bf/777/1b65bf777d1e5df8e3f172e628e982c3.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/c53/4c2/9a6/c534c29a6bf6e72066a3e25a71db2bf5.jpg"><br><br>  Next, go to the project under study, make markup in unit tests, <code>setUp</code> and <code>tearDown</code> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/eb1/735/0e0/eb17350e0ef68bb0892382064ad10440.jpg"><br><br><h3>  Step 2. Create a new instrument from the Instrument Package. </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/764/8bc/cec/7648bccecdbae756b7d5bf6bf116f9c6.jpg"><br><br>  First we determine the type of data at the input.  To do this, in the <code>.instrpkg</code> file <code>.instrpkg</code> import the <code>signpost</code> scheme.  Now the events created by <code>signpost</code> will fall into the tool: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/586/227/80b/58622780b3b064241766cc8035a39ec3.jpg"><br><br>  Next, determine the type of data at the output.  In this example, we will output one-time events.  Each event will have a time and description.  To do this, declare the scheme: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d99/ed9/904/d99ed990423be50e65a2a9abba4e4ae6.jpg"><br><br><h3>  Step 3. Describe the logic of the tool </h3><br>  We create a separate file with the <code>.clp</code> extension, in which we set rules using the CLIPS language.  To let the new tool know in which file the logic is defined, add the <code>modeler</code> block: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d57/1e8/6ee/d571e86ee091947afc51d90afb796b6a.jpg"><br><br>  In this block, using the <code>production-system</code> attribute, specify the relative path to the file with logic.  In the attributes <code>output</code> and <code>required-input</code> define the data schemes for input and output, respectively. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/878/e14/c8a/878e14c8a5354ee00f80fd646991e8e6.jpg"><br><br><h3>  Step 4. Describe the specifics of the representation of the tool (UI) </h3><br>  In the <code>.instrpkg</code> file, <code>.instrpkg</code> remains to describe the tool itself, that is, the display of the results.  Create a table for the data in the <code>create-table</code> attribute using the previously declared <code>detected-mocks-narrative</code> scheme in the <code>schema-ref</code> attribute.  And configure the type of information output - narrative (descriptive): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/934/fae/927/934fae927ead3e65219a2385373b1470.jpg"><br><br><h3>  Step 5. Write the logic code </h3><br>  Moving on to the <code>.clp</code> file, which defines the logic of the expert system.  The logic will be as follows: if the start time of the test intersects with the interval of the life of the mock, then we believe that this time came from another test - which breaks the isolation of the current unit test.  In order to eventually create an event with the information of interest, you need to do the following steps: <br><br>  1. We define the mock and unitTest structures with fields ‚Äî the time of the event, the event identifier, the name of the test, and the class of the mock. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/160/6fe/369/1606fe36993cbd7592ae56c81b963682.jpg"><br><br>  2. Define the rules that will create facts with <code>mock</code> and <code>unitTest</code> types <code>unitTest</code> on <code>unitTest</code> inbound events: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5af/470/a70/5af470a70c9ee1c387ccedc116c71ffa.jpg"><br><br>  You can read these rules as follows: if at the input we get a fact like ospostpost with the required <code>subsystem</code> , <code>category</code> , <code>name</code> and <code>event-type</code> , then we create a new fact with the type that was defined above (unitTest or mock) and fill it with values.  It is important to remember here - CLIPS is a case-sensitive language and the values ‚Äã‚Äãof the subsystem, category, name and event-type must match the one used in the code of the project under study. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4b4/cd5/723/4b4cd572322313efde53e0fa65d502cd.jpg"><br><br>  The values ‚Äã‚Äãof variables from signpost events are transmitted as follows: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bc3/952/1dd/bc39521dd8ec5000f3c98653971173d2.jpg"><br><br>  3. We determine the rules that release the completed events (they are redundant, since they do not affect the result). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5b9/6cd/33e/5b96cd33eb906e4acce8072a8f652786.jpg"><br><br><h3>  Step 6. Define a rule that will generate results. </h3><br>  You can read the rule like this. <br><br>  <b>If a</b> <br><br>  1) there is a unitTest and mock; <br><br>  2) at the same time the beginning of the test comes later than the existing mock; <br><br>  3) there is a table for storing results with a detected-mocks-narrative scheme; <br><br>  <b>that</b> <br><br>  4) create a new record; <br><br>  5) fill with time; <br><br>  6) ... and description. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dcf/c30/682/dcfc30682ea50a0d391ae1702bcde9c1.jpg"><br><br>  As a result, we see the following picture when using a new tool: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bc0/b3b/4cf/bc0b3b4cf1d0d99f2359814c7881d22c.jpg"><br><br>  The source code custom instrument and a sample project for using the tool can be viewed <a href="https://github.com/Regno/xcode-custom-instruments">on GitHub</a> . <br><br><h2>  Debugging tools </h2><br>  A debugger is used to debug custom tools. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/966/265/db7/966265db7bf5d7eeebbe69359b63cd06.jpg"><br><br>  He allows <br><br>  1. See the compiled code based on the description in instrpkg. <br>  2. See detailed information about what happens to the tool at run time. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7d4/c2e/6bf/7d4c2e6bfb531a31b4b69a3f4eb9974d.jpg"><br><br>  3. Display a complete list and description of the system data schemas that can be used as input data in new tools. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a13/895/4da/a138954daa535c02dba79f79291338bf.jpg"><br><br>  4. Run arbitrary commands in the console.  For example, display a list of rules with the ‚Äúlist-defrules‚Äù command or facts with the ‚Äúfacts‚Äù command. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/485/8d0/033/4858d00333fb89957892560f37d5c17f.jpg"><br><br><h2>  Setup on the CI server </h2><br>  You can run the tools from the command line ‚Äî profile the application during unit-execution or UI tests on the CI server.  This will allow, for example, to catch the memory leak as soon as possible.  For profiling tests in the pipeline we use the following commands: <br><br>  1. Launch tools with attributes: <br><br><pre> <code class="plaintext hljs">xcrun instruments -t &lt;template_name&gt; -l &lt;average_duration_ms&gt; -w &lt;device_udid&gt;</code> </pre> <br><ul><li>  where <code>template_name</code> is the path to the template with tools or the name of the template.  <code>xcrun instruments -s</code> with <code>xcrun instruments -s</code> ; </li><li>  <code>average_duration_ms</code> - recording time in milliseconds, must be greater than or equal to the test execution time; </li><li>  <code>device_udid</code> - simulator id.  Available with xcrun instruments -s.  Must match the identifier of the simulator on which tests will be performed. </li></ul><br>  2. Run tests on the same simulator with the command: <br><br><pre> <code class="plaintext hljs">xcodebuild -workspace &lt;path_to_workspace&gt;-scheme &lt;scheme_with_tests&gt; -destination &lt;device&gt; test-without-building</code> </pre><br><ul><li>  where <code>path_to_workspace</code> is the path to the Xcode workspace; </li><li>  <code>scheme_with_tests</code> - scheme with tests; </li><li>  <code>device</code> - simulator ID. </li></ul><br>  As a result, a report with the .trace extension will be created in the working directory, which can be opened by the Instruments application or by right-clicking on the file and selecting Show Package Contents. <br><br><h2>  findings </h2><br>  We looked at an example of a signpost upgrade to a full-fledged tool and told how to automatically apply it on CI server ‚Äúruns‚Äù and use it in solving ‚Äúflashing‚Äù (unstable) tests. <br><br>  As you immerse yourself in the capabilities of custom instruments, you will understand better in what other cases the instruments can be used.  For example, they also help us to understand the problems of multithreading - where and when to use thread-safe data access. <br>  Create a new tool was quite simple.  But the main thing is that after spending a few days studying the mechanics and documentation for creating it today, you will be able to avoid several sleepless nights trying to fix bugs. <br><br><h2>  Sources </h2><br><ul><li>  <a href="https://developer.apple.com/videos/play/wwdc2018/410/">https://developer.apple.com/videos/play/wwdc2018/410/</a> <br></li><li>  <a href="https://developer.apple.com/videos/play/wwdc2018/405/">https://developer.apple.com/videos/play/wwdc2018/405/</a> <br></li><li>  <a href="https://help.apple.com/instruments/developer/mac/current/">https://help.apple.com/instruments/developer/mac/current/</a> <br></li><li>  <a href="https://help.apple.com/instruments/mac/current/">https://help.apple.com/instruments/mac/current/#/devb14 aa5</a> <br></li><li>  <a href="http://www.clipsrules.net/Documentation.html">http://www.clipsrules.net/Documentation.html</a> <br></li><li>  <a href="https://medium.com/appspector/building-custom-instruments-package-9d84fd9339b6">https://medium.com/appspector/building-custom-instruments-package-9d84fd9339b6</a> <br></li><li>  <a href="http://desappstre.com/how-to-custom-instruments-xcode/">http://desappstre.com/how-to-custom-instruments-xcode/</a> <br></li></ul><br>  <i>The article was written along with <a href="https://habr.com/ru/users/regno/">@regno</a> - Anton Vlasov, an iOS developer.</i> </div><p>Source: <a href="https://habr.com/ru/post/447594/">https://habr.com/ru/post/447594/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447582/index.html">Rusatom: 3D metal printing in Russia</a></li>
<li><a href="../447584/index.html">Anatomy of the "Space Data Center". Sky-high server: look under the hood</a></li>
<li><a href="../447586/index.html">Advanced string interpolation in Swift 5.0</a></li>
<li><a href="../447588/index.html">How to make the application more stable with the help of 2 types of unit tests</a></li>
<li><a href="../447592/index.html">WhatsApp in the palm of your hand: where and how can you detect forensic artifacts?</a></li>
<li><a href="../447598/index.html">We write the game "Memory Cards" on Swift</a></li>
<li><a href="../447604/index.html">Equal teeth, C ++ and math - how are they related? Talk with Align</a></li>
<li><a href="../447606/index.html">CLRium # 5 Garbage Collector: Peter - Sold Out</a></li>
<li><a href="../447608/index.html">The evolution of CI in the mobile development team</a></li>
<li><a href="../447610/index.html">How to take control of network infrastructure. Chapter three Network security Part three</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>