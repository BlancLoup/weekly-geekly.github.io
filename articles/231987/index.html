<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Platform on Three.js</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The other day, Mr. Oak accepted my first pull request with an example in Three.js , and to my joy I decided to write about him a habroost. If you sudd...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Platform on Three.js</h1><div class="post__text post__text-html js-mediator-article">  The other day, Mr. Oak accepted my first pull request with an example in <a href="http://habrahabr.ru/search/%3Fq%3D%5Bthree.js%5D%26target_type%3Dposts">Three.js</a> , and to my joy I decided to write about him a habroost.  If you suddenly want to write a three-dimensional platformer on Three.js, but you don‚Äôt have much idea how to do <a href="http://makc.github.io/three.js.fork/examples/misc_fps.html">this</a> , <a href="http://makc.github.io/three.js.fork/examples/misc_fps.html">this example</a> is for you: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/9cb/86f/ac7/9cb86fac75484d9f832dd8b37fbab600.jpg"></div><br><br>  The entire code of the example is less than 300 lines, generously diluted with hyphenation, which it will not be difficult to figure out on your own.  However, to further alleviate your fate, I will write a few words below about key points. <br><a name="habracut"></a><br><h4>  Prehistory </h4><br>  We all heard about people who can <a href="http://habrahabr.ru/post/164003/">write a shooter in two days</a> , but can we ourselves be on a par with the legends?  To test my strength, I was surrounded by <s>lessons on Three.js by</s> Google and began to sculpt my 2-day masterpiece.  However, after an hour or two I got bored, I committed what was there and went <s>to get some fresh air to</s> read the Internet.  It was the same every time I returned to this venture.  Days passed, then weeks.  But the drop continued to sharpen the stone, and somewhere in a month I still carved my shooter, in which you can run in and shoot caravans of monsters from a shotgun. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">All throw and go shoot a couple of monsters</b> <div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/files/d37/7f1/54a/d377f154adc845419d1f16f63081d98c.jpg"></div></div></div><br>  Now it was time to look back on the road and think what I did well, and where I turned the wrong way.  Actually, the example of a platformer, which is discussed in this article is one of the things that I think falls into the first category. <br><br><h4>  So shooter or platformer? </h4><br>  Maybe you ask me why I persistently call the essentially simplified version of my shooter platformer.  Mr. Oak not only asked, but also made me rename the example back to the shooter before accepting a pull request.  And yet, I do not consider this example a shooter.  At least because in it it is impossible to shoot at anyone.  But you can run and jump on a three-dimensional platform.  The example code can be easily altered to a third-person game by adding a player model and manipulating it instead of a camera, but it seems to me that it doesn't matter. <br><br><div class="spoiler">  <b class="spoiler_title">No one will argue that, for example, Mario is a platformer?</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/KBb9wFP7uZM%3Ffeature%3Doembed&amp;xid=17259,15700002,15700019,15700186,15700190,15700253,15700256&amp;usg=ALkJrhiSpqFAfW_iTJ1j6J9jVeiTfV0CuQ" frameborder="0" allowfullscreen=""></iframe></div></div><br><br><h4>  In short, Sklifosovsky! </h4><br>  Yes, I'm a little distracted from the topic.  So, to make a platformer, first of all we have to add at least one platform to the game world.  This is a simple matter, I took a 3D model, exported it to my favorite format (from among babylon, ctm, dae, obj, ply, stl, vtk or wrl), uploaded to <a href="http://threejs.org/editor/">Three.js editor</a> , exported again, and upload to your health.  There are two options: <br><br><ol><li>  First load the platform, then create a scene and add a platform there. </li><li>  Create a scene and add a platform to it, and then load it in the background </li></ol><br>  The first option is, of course, ideologically more correct, but most of the examples of Three.js (including this one) do not bother and work according to the second scenario.  It should be noted that there is no special difference in the code between 1 and 2 - just in the first case, you should transfer the scene initialization call to the load handler, and in the second case, add a check on the platform state in the main loop so as not to fly far down until it boots.  I went exactly along this path, and in order to correctly implement the first variant, in the case of preloading a multitude of resources, it would still require a lot more code and / or third-party libraries. <br><br><div class="spoiler">  <b class="spoiler_title">View platform load code?</b> <div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makePlatform</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> jsonUrl, textureUrl, textureQuality </span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> placeholder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.Object3D(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> texture = THREE.ImageUtils.loadTexture( textureUrl ); texture.anisotropy = textureQuality; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> loader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.JSONLoader(); loader.load( jsonUrl, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> geometry </span></span></span><span class="hljs-function">) </span></span>{ geometry.computeFaceNormals(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> platform = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.Mesh( geometry, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.MeshBasicMaterial({ <span class="hljs-attr"><span class="hljs-attr">map</span></span> : texture }) ); platform.name = <span class="hljs-string"><span class="hljs-string">"platform"</span></span>; placeholder.add( platform ); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> placeholder; };</code> </pre> <br><br>  To speed up loading, I deleted the normals from the json file - so you see the computeFaceNormals call here - and platform.name is set for the platform check mentioned above.  Without this, all the code would look like this: <br><br><pre> <code class="javascript hljs">loader.load( jsonUrl, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> geometry </span></span></span><span class="hljs-function">) </span></span>{ placeholder.add( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.Mesh( geometry, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.MeshBasicMaterial({ <span class="hljs-attr"><span class="hljs-attr">map</span></span> : texture }) ) ); });</code> </pre><br></div></div><br>  Okay, let's say you <a href="http://habrahabr.ru/post/225199/">created the scene yourself, added a camera</a> and a platform to it.  Further, you must force the game character to move along it somehow, without flying through and without falling through it.  The <a href="http://threejs.org/docs/">Raycaster</a> class will help you in this.  As it is easy to guess from the name, it calculates the intersection of a given beam with the selected geometry. In this case, we simply direct the beam down, and find the nearest intersection with the platform: <div style="text-align:center;"><img src="https://habrastorage.org/files/91d/066/9a7/91d0669a701345cc9aebeb140829109f.jpg"></div><br>  Simple, but there are nuances.  For example, you cannot use the character‚Äôs position as the beginning of the beam - in this case you cannot find the intersection with the platform if the character for any reason fails at least a millimeter, and send it to free fall instead of pushing it back onto the platform.  Accordingly, the beginning of the beam should be on top, at the height of "bird flight." <br><br><div class="spoiler">  <b class="spoiler_title">In this place in more detail, please ...</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> raycaster = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.Raycaster(); raycaster.ray.direction.set( <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> birdsEye = <span class="hljs-number"><span class="hljs-number">100</span></span>; ... <span class="hljs-comment"><span class="hljs-comment">// ,   raycaster.ray.origin.copy( playerPosition ); raycaster.ray.origin.y += birdsEye; var hits = raycaster.intersectObject( platform );</span></span></code> </pre><br></div></div><br>  In the case of multi-storey level architecture, this height is obviously limited by the minimum vertical distance between the platforms.  Next, you should carefully consider when to make a decision about pushing a failed character up.  If you do not limit the maximum allowable depth of the "failure", the character will instantly teleport to the platform, simply by entering (or flying) under it;  if you limit it too much, the character will be able to easily pass through the platform when landing after jumping. <br><br><div class="spoiler">  <b class="spoiler_title">How does this in code look like then?</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> kneeDeep = <span class="hljs-number"><span class="hljs-number">0.4</span></span>; ... <span class="hljs-comment"><span class="hljs-comment">// ,   // ,   ,           if( ( hits.length &gt; 0 ) &amp;&amp; ( hits[0].face.normal.y &gt; 0 ) ) { var actualHeight = hits[0].distance - birdsEye; //    ,    if( ( playerVelocity.y &lt;= 0 ) &amp;&amp; ( Math.abs( actualHeight ) &lt; kneeDeep ) ) { playerPosition.y -= actualHeight; playerVelocity.y = 0; } }</span></span></code> </pre><br>  An attentive reader will ask why there is a check for playerVelocity.y &lt;= 0?  Answer: in order not to create problems with separation from the platform when jumping. <br></div></div><br>  Now, in fact, it is necessary to force the character to move in space, obeying the basic laws of the school physics course.  Suppose that at any time the character knows the speed of the <code>playerVelocity</code> and position in the <code>playerPosition</code> space;  then the calculation of the movement of the character at first glance might look like this (pseudocode): <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(   ) playerVelocity.y -= gravity * time; playerPosition += playerVelocity * time; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(   ) playerVelocity *= damping ^ time;</code> </pre><br>  Alas, and everything is not so simple.  Readers with non-school education or veterans igrostroya this pseudocode is known as the "Euler method", and it is also known that this method - just sucks.  And that's why (the picture is steal from <a href="http://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B5%25D1%2582%25D0%25BE%25D0%25B4_%25D0%25AD%25D0%25B9%25D0%25BB%25D0%25B5%25D1%2580%25D0%25B0">Wikipedia</a> ): <br><div style="text-align:center;"><img src="http://i.imgur.com/gmCf4CI.jpg"></div><br>  As you can see, the calculated trajectory with time increasingly diverges from the expected result.  In itself, this circumstance is not so scary - one modest variable, <code>time</code> makes it terrible.  Imagine how this picture will change if <code>time</code> reduced by 10% (transfer to a faster browser, for example): <br><div style="text-align:center;"><img src="http://i.imgur.com/geuriLd.jpg"></div><br>  As you can see, by running the game in firefox, we get one dynamic, and by running it in the chrome, a completely different one.  The behavior of the character will "float" depending on the intensity of the background tasks and the location of the stars.  What to do? <br><br>  There is a solution, and quite simple.  It is necessary to replace the calculation with a long variable <code>time</code> step by several calculations with a short fixed step.  For example, if two consecutive rendering intervals are 19 and 21 ms, we must calculate 3 steps of 5 ms for the first drawing and, adding the remaining 4 ms to 21, calculate 5 steps of 5 ms for the second. <br><br><div class="spoiler">  <b class="spoiler_title">Uh, what?</b> <div class="spoiler_text">  somewhere like this: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> timeStep = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> timeLeft = timeStep + <span class="hljs-number"><span class="hljs-number">1</span></span>; ... function( dt ) { <span class="hljs-comment"><span class="hljs-comment">//    ;) var platform = scene.getObjectByName( "platform", true ); if( platform ) { timeLeft += dt; //     dt = 5; while( timeLeft &gt;= dt ) { //   ... timeLeft -= dt; } } }</span></span></code> </pre><br></div></div><br>  At this almost everything, you just have to set the movement parameters of the character ( <code>playerVelocity</code> for example) in response to WASD or something like that. <br><br>  Oh yeah, I completely forgot.  The striped ledges in the example send the character to jump across the entire platform.  How?  Everything is very simple - when a character approaches a ledge, a pre-selected vertical-inclined component is added to <code>playerVelocity</code> , which is guaranteed (thanks to the above-described scheme with a fixed step) to take it to a given point, like an artillery shell.  No special tricks are needed - everything is already working. <br><br>  Now for sure.  Read mine, write your own, criticism is welcome.  Before communication! <br><br>  <b>Update</b> : once again links at the end according to the wishes of the lazy workers: <br><ul><li>  <a href="https://github.com/mrdoob/three.js/blob/dev/examples/misc_fps.html">Sample code</a> </li><li>  <a href="http://makc.github.io/three.js.fork/examples/misc_fps.html">Example itself</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/231987/">https://habr.com/ru/post/231987/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../231971/index.html">Introduction to sbt</a></li>
<li><a href="../231973/index.html">20 excellent quotes about the conversion of the "guru"</a></li>
<li><a href="../231979/index.html">Simulation of the procedure for connecting bluetooth devices and whether there is a need for models of this kind</a></li>
<li><a href="../231981/index.html">From idea to Google Play in 30 hours</a></li>
<li><a href="../231985/index.html">Choosing an LED lamp</a></li>
<li><a href="../231989/index.html">AppVeyor</a></li>
<li><a href="../231991/index.html">Flight to the moon landing on the lunar base</a></li>
<li><a href="../231997/index.html">How we ‚Äútrained the fire monkey‚Äù or our experience with FMX</a></li>
<li><a href="../232005/index.html">The Role of Elon Mask in PayPal History</a></li>
<li><a href="../232007/index.html">Math, STA? !! 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>