<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Async in C # and SynchronizationContext</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continued: part III . 

 The last note about async ( part I ) was an introduction. In this, I will continue the topic I have started: I will talk abou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Async in C # and SynchronizationContext</h1><div class="post__text post__text-html js-mediator-article">  Continued: <a href="http://habrahabr.ru/blogs/nemerle/108184/">part III</a> . <br><br>  The last note about async ( <a href="http://habrahabr.ru/blogs/net/107498/">part I</a> ) was an introduction.  In this, I will continue the topic I have started: I will talk about how async interacts with SynchronizationContext, and how this affects the development of asynchronous graphical applications. <br><br>  The test site will be an example of DiningPhilosophers, which comes with an asynchronous programming extension.  This program is a visualization of Dijkstra‚Äôs famous task of the dining philosophers ( <a href="http://en.wikipedia.org/wiki/Dining_philosophers_problem">link</a> ).  Before reading further, it is better to get acquainted with the conditions of the problem. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/b6b/1c5/749/b6b1c57497cb8d005ed6df396a0b7692.png" alt="image"><a name="habracut"></a><br><br>  The program is short, so look at it.  At the very beginning, classes are defined that represent the main essence of the task: the state of the philosopher, the philosopher and the fork. <br><br>  The forks use the BufferBlock class, which lies in the System.Threading.Tasks.Dataflow namespace.  This space allows you to write multi-threaded applications based on data flow.  The simplest example of this approach is the channels that are used in Limbo, Go, Axum;  their essence is that two streams interact through channels (analogue queues), in which you can write and read, if the stream tries to read from the channel, and the channel is empty, then the stream is blocked until data appears in the channel.  The refusal of common objects and the use of channels for data exchange and synchronization tools allows you to write more understandable and secure code.  BufferBlock is such a channel, the Post method adds data, Receive receives, and ReceiveAsync is an extension method that receives data asynchronously.  The essence of the task is ideally to fall on this class: an accessible fork is described by a channel in which something is there, a occupied fork is an empty channel, if the philosopher is a stream of execution, he will continue to perform when addressed to a free fork (channel) to wait. <br><br>  In the program, the class Philosopher represents not the philosopher himself, but his condition, which is visualized.  In this case, it is the standard WPF primitive - Ellipse and the different state of the philosopher is represented by different colors.  It is important that since this is a graphic object, it can only be accessed from one stream. <br><br>  As I already wrote, the philosopher himself will represent the flow of execution (the RunPhilosopherAsync method). <br><br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Philosopher = Ellipse; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Fork = BufferBlock&lt;<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;;</code> </pre> <br>  The MainWindow method is practically not interesting, it is the initialization of class structures.  The only thing that can be noticed about him is that he calls a method whose signature contains async void, calling such methods we start an asynchronous operation and lose control over it, for example, we cannot wait for its completion. <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> MainWindow() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; philosophers.Length; i++) { diningTable.Children.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(philosophers[i] = CreatePhilosopher()); forks[i] = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Fork(); forks[i].Post(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } //      <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; philosophers.Length; i++) { RunPhilosopherAsync( philosophers[i], i &lt; philosophers.Length - <span class="hljs-number"><span class="hljs-number">1</span></span> ? forks[i] : forks[<span class="hljs-number"><span class="hljs-number">1</span></span>], i &lt; philosophers.Length - <span class="hljs-number"><span class="hljs-number">1</span></span> ? forks[i + <span class="hljs-number"><span class="hljs-number">1</span></span>] : forks[i] ); } }</code> </pre> <br>  The RunPhilosopherAsync code describes the actions of the action of the philosopher, it is quite straightforward especially for the asynchronous: we think, wait for the fork, eat, put the fork back and think again.  Pauses (TaskEx.Delay) are set so that you can watch different stages. <br><br><pre> <code class="hljs ruby">private async void RunPhilosopherAsync(Philosopher philosopher, Fork fork1, Fork fork2) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ,  , ,     <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  () philosopher.Fill = Brushes.Yellow; await TaskEx.Delay(_rand.Next(<span class="hljs-number"><span class="hljs-number">10</span></span>) * TIMESCALE); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   () philosopher.Fill = Brushes.Red; await fork1.ReceiveAsync(); await fork2.ReceiveAsync(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  () philosopher.Fill = Brushes.Green; await TaskEx.Delay(_rand.Next(<span class="hljs-number"><span class="hljs-number">10</span></span>) * TIMESCALE); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>       fork1.Post(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); fork2.Post(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); } }</code> </pre><br><h4>  What can you say about this code? </h4><br>  Firstly, it does not work (deadlock) in the case when the number of philosophers is two because of the line: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">i</span></span> &lt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">philosophers</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Length</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 1 ? <span class="hljs-selector-tag"><span class="hljs-selector-tag">forks</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[i]</span></span> : <span class="hljs-selector-tag"><span class="hljs-selector-tag">forks</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span></code> </pre> <br>  It is necessary to replace forks [1] with forks [0].  But they are cavils, even if the number of philosophers is five. <br><br>  Secondly, the code should not work, since we are accessing the gui element from another thread, but the strangest thing is that it works.  If you get rid of async / await in the code, replacing everywhere ‚Äúawait x‚Äù with ‚Äúx.Wait ()‚Äù and ‚ÄúRunPhilosopherAsync (...)‚Äù with ‚Äúnew Task (() =&gt; RunPhilosopherAsync (...)). Start () ‚Äùand removing the async token, then we get the expected InvalidOperationException. <br><br><img src="http://rystsov.s3.amazonaws.com/habrahabr/exception.png" alt="image"><br><br>  Now it's clear that all the magic is in await. <br><br><h5>  Interaction with gui-streams in .Net Framework </h5><br>  Recall how to interact with gui-threads in the .Net Framework. <br><br>  In the case of WinForms, it is enough for any control to call the Invoke method and pass a delegate to it with the code that needs to be executed in the gui stream.  In the case of WPF, you need to refer to the Dispatcher property of any control and call the Invoke method, again passing a delegate to it. <br><br>  This is reminiscent of the beginning of the classic definition of the pattern by Christopher: the problem is repeated again and again.  The problem itself can be described as the need to execute code in a specific thread, when the initializer of execution is code from another thread.  In fact, this problem is not specific to gui, it also pops up in COM and WCF ... It is logical that it should have a solution, the stream should provide a means to run code in it, just like WinForms and WPF controls do. .  There is such a solution; an object of the SynchronizationContext type provides the Send and Post (asynchronous) methods for executing code on another thread.  To gain access to an object of the SynchronizationContext type of any thread, you need to refer to SynchronizationContext.Current (per thread singleton) in this thread. <br><br>  It is important that the SynchronizationContext and the thread are consistent, for example, if the stream runs on an event loop, the SynchronizationContext must have access to the event queue.  That is, each event loop implementation needs to inherit and override the SynchronizationContext methods.  If you create a SynchronizationContext object, it will use a thread from ThreadPool when calling Send and Post. <br><br>  Now we can assume that the result of the asynchronous operation is performed by await using the SynchronizationContext object, which it receives on the first call.  This hypothesis is easy to test: we will install our SynchronizationContext: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyContext</span></span> : <span class="hljs-title"><span class="hljs-title">SynchronizationContext</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SendOrPostCallback d, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> state</span></span></span><span class="hljs-function">)</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"MyContext.Post"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.Post(d, state); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Send</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SendOrPostCallback d, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> state</span></span></span><span class="hljs-function">)</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"MyContext.Send"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.Send(d, state); } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SavePage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> file, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stream = File.AppendText(file)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> html = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebClient().DownloadStringTaskAsync(a); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> stream.WriteAsync(html); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { SynchronizationContext.SetSynchronizationContext(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyContext()); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> task = SavePage(<span class="hljs-string"><span class="hljs-string">"habrahabr"</span></span>, <span class="hljs-string"><span class="hljs-string">"http://habrahabr.ru"</span></span>); task.Wait(); } }</code> </pre> <br>  At startup, the ‚ÄúMyContext.Post‚Äù will be displayed several times, hence await actually refers to the SynchronizationContext. <br><br><h5>  Conclusion </h5><br>  The fact that await uses SynchronizationContext at work makes writing asynchronous graphical applications even easier, since you don‚Äôt need to worry about the flow in which we are accessing graphic elements. <br><br>  By the way, SynchronizationContext is a good example when singleton is not an absolute evil. <br><br>  I was prompted to write this post by a blog post on <a href="http://weblog.ikvm.net/">ikvm.net</a> on November 1.  And the article ‚ÄúUnderstanding SynchronizationContext‚Äù ( <a href="http://www.codeproject.com/KB/threads/SynchronizationContext.aspx">Part I</a> , <a href="http://www.codeproject.com/KB/threads/SynchronizationContext2.aspx">Part II</a> and <a href="http://www.codeproject.com/KB/threads/SynchronizationContext3.aspx">Part III</a> ) helped me understand the topic. </div><p>Source: <a href="https://habr.com/ru/post/107583/">https://habr.com/ru/post/107583/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../107575/index.html">Switching css (clearance) "on the fly"</a></li>
<li><a href="../107576/index.html">Personal Information (Short FAQ)</a></li>
<li><a href="../107578/index.html">Xbox 360 Kinect: demonstration of video chat with Windows users</a></li>
<li><a href="../107581/index.html">Not computers uniform</a></li>
<li><a href="../107582/index.html">Microsoft Strategy - Silverlight and HTML5</a></li>
<li><a href="../107585/index.html">CLR and .NET Myths and Misconceptions</a></li>
<li><a href="../107586/index.html">iPhone vs. Android vs. Blackberry</a></li>
<li><a href="../107588/index.html">Search urban routes in 15 cities and 3 widgets for sites - See Kartu.ru</a></li>
<li><a href="../107589/index.html">Android-based gadgets gradually come to the fore</a></li>
<li><a href="../107590/index.html">Europe wants more control over personal information on the web</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>