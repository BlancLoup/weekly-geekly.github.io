<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hosting mercurial repositories using nginx, gunicorn and supervisor</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are plenty of ways to host mercurial repositories, but I composed this option for the following reasons: 


1. nginx: eats little, works fast - ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hosting mercurial repositories using nginx, gunicorn and supervisor</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/979/c53/e5b/979c53e5b58d484de72786396b3d3296.png" alt="image" align="left">  There are plenty of ways to host mercurial repositories, but I composed this option for the following reasons: <br><ol><li>  nginx: eats little, works fast - <u>speed</u> </li><li>  supervisor: monitors the process, restarts if that - <u>reliability</u> </li><li>  gunicorn: wsgi, great tuning options - <u>efficiency</u> </li></ol>  In addition, because  I am developing on django, and I launch websites under the same bundle, there is a fourth reason - unification, and it is a very useful thing. <br><br>  If you are interested in the topic, then specific instructions and configs are under the cut. <a name="habracut"></a><br><br>  Further it is assumed that you already have mercurial, nginx, gunicorn and supervisor installed.  I use Ubuntu 10.04, for it mercurial, nginx and supervisor are available in standard repositories, and for gunicorn there is <a href="https://launchpad.net/~bchesneau/%2Barchive/gunicorn">ppa</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The main script for working with repositories is <a href="http://mercurial.selenic.com/wiki/PublishingRepositories">hgweb</a> , which is supplied as part of mercurial, and we dance from it. <br><br>  I store the repositories in the directory / home / hgdata.  The reason is to simplify the setup of backups.  The entire / home is saved, and you do not need to specify individual directories, for example.  <u>All described scripts and configs are stored in the same directory</u> , / home / hgdata. <br><br>  The first file is hgweb.config, the config of hgweb itself, as the name suggests: <br><blockquote><code><a href="http://s-c.me/24600/s"></a> <a href="http://s-c.me/24600/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt;[collections]&lt;br/&gt;/ = /home/hgdata &lt;br/&gt;</font></code> </blockquote>  it tells hgweb that the repositories are stored in / home / hgdata, and you need to look for them there. <br><br>  Further, because  we raise the wsgi server, then the hgweb mercurial script needs to be converted to wsgi.  To do this, use the hgwebapp.py script: <br><blockquote> <code><a href="http://s-c.me/24598/s"></a> <a href="http://s-c.me/24598/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt; <font color="#696969">#!/usr/bin/env python</font> &lt;br/&gt; <font color="#0000ff">import</font> os&lt;br/&gt; <font color="#0000ff">import</font> sys&lt;br/&gt; <font color="#0000ff">from</font> mercurial.hgweb.hgwebdir_mod <font color="#0000ff">import</font> hgwebdir&lt;br/&gt; <font color="#0000ff">from</font> mercurial.hgweb.request <font color="#0000ff">import</font> wsgiapplication&lt;br/&gt; <b>os</b> .environ[ <font color="#008000">"HGENCODING"</font> ] = <font color="#008000">"UTF-8"</font> &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">make_web_app</font> ():&lt;br/&gt; <font color="#0000ff">return</font> hgwebdir( <font color="#008000">"/home/hgdata/hgweb.config"</font> )&lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">application</font> (environ, start_response):&lt;br/&gt;    environ[ <font color="#008000">'wsgi.url_scheme'</font> ] = environ.get( <font color="#008000">'HTTP_X_URL_SCHEME'</font> , <font color="#008000">'http'</font> )&lt;br/&gt; <font color="#696969"># nginx wrap proxy headers with HTTP</font> &lt;br/&gt;    environ[ <font color="#008000">'REMOTE_USER'</font> ] = environ.get( <font color="#008000">'HTTP_REMOTE_USER'</font> , <font color="#008000">''</font> )&lt;br/&gt;    app = wsgiapplication( <font color="#cc6633">make_web_app</font> )&lt;br/&gt; <font color="#0000ff">return</font> app(environ, start_response) &lt;br/&gt;</font></code> </blockquote>  This script, we can already start under gunicorn.  The config for gunicorn is called hgweb.conf: <blockquote> <code><a href="http://s-c.me/24601/s"></a> <a href="http://s-c.me/24601/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt;[program:hgweb]&lt;br/&gt;command=/usr/bin/gunicorn -b 127.0.0.1:8080 hgwebapp:application&lt;br/&gt;environment=PYTHONPATH= <font color="#A31515">'/home/hgdata'</font> &lt;br/&gt;directory=/home/hgdata&lt;br/&gt; <font color="#0000ff">user</font> =www- <font color="#0000ff">data</font> &lt;br/&gt;autostart= <font color="#0000ff">true</font> &lt;br/&gt;autorestart= <font color="#0000ff">true</font> &lt;br/&gt;startsecs=10&lt;br/&gt;redirect_stderr= <font color="#0000ff">true</font> &lt;br/&gt;stdout_logfile=/ <font color="#0000ff">var</font> /log/supervisor/hgweb.gunicorn.log&lt;br/&gt;</font></code> </blockquote>  we put the symlink to this config in /etc/supervisor/conf.d and we can already run it.  Go to the "control panel" supervisor: sudo supervisorctl and give the update command.  supervisor reviews the configs directory, finds a new one, and launches the gunicorn server with the hgwebapp script.  After that, the port 8080 of the address 127.0.0.1 will hang the mercurial server, and it remains to expose it using nginx. <br><br>  In the nginx config file, I registered the whole thing for a third-level domain, and my name is: hg.somewebsite.com <br><blockquote> <code><a href="http://s-c.me/24602/s"></a> <a href="http://s-c.me/24602/h"></a> <a href=""></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt;upstream app_server_hgweb {&lt;br/&gt;        server 127.0.0.1:8080 fail_timeout=0;&lt;br/&gt;}&lt;br/&gt;server {&lt;br/&gt;    listen XXXX:80;&lt;br/&gt;    server_name hg.somewebsite.com;&lt;br/&gt;    location / {&lt;br/&gt;            auth_basic "Mercurial repository";&lt;br/&gt;            auth_basic_user_file /home/hgdata/auth;&lt;br/&gt;            proxy_set_header X-Forwarded- <font color="#0000ff">For</font> $proxy_add_x_forwarded_for;&lt;br/&gt;            proxy_set_header <font color="#0000ff">Host</font> $http_host;&lt;br/&gt;            proxy_set_header remote_addr $remote_addr;&lt;br/&gt;            proxy_set_header remote_user $remote_user;&lt;br/&gt;            proxy_redirect <font color="#0000ff">off</font> ;&lt;br/&gt; <font color="#0000ff">if</font> (!-f $request_filename) {&lt;br/&gt;                proxy_pass app_server_hgweb;&lt;br/&gt; <font color="#0000ff">break</font> ;&lt;br/&gt;            }&lt;br/&gt;        }&lt;br/&gt;}&lt;br/&gt;</font></code> </blockquote>  As can be seen from the config, for authentication of users, the file / home / hgdata / auth is used, in it the <a href="http_auth_basic_module.html">usual user-password hash pairs are used</a> .  The user name is passed down to the wsgi server, and hgweb is used to determine what access to give the user. <br><br>  This is configured in the hgrc file (which lies in the .hg repository subdirectory) in the web section.  It is written very simply: <br><blockquote> <code><a href="http://s-c.me/24603/s"></a> <a href="http://s-c.me/24603/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt;[web]&lt;br/&gt;contact = Organization name&lt;br/&gt;description = Repository description&lt;br/&gt;style = gitweb&lt;br/&gt;allow_read = user1 user2 user3&lt;br/&gt;allow_push = user1&lt;br/&gt;push_ssl = <font color="#0000ff">false</font> &lt;br/&gt;allow_archive = bz2 gz zip &lt;br/&gt;</font></code> </blockquote>  In this case, only user1 can upload to the repository, and three can read.  From Anonymus this repository is closed.  <a href="http://mercurial.selenic.com/wiki/HgWebDirStepByStep">More information on access settings here</a> . <br><br>  In conclusion, you need to create a symlink from the /home/hgdata/hg.somewebsite.com file to the / etc / nginx / sites-enabled directory and restart nginx, after that everything should work.  It is necessary to consider that  www-data is registered in the nginx config file, then www-data must have all repository rights in / home / hgdata, otherwise it will not be able to write there. <br><br>  That's it, repositories should be accessible via http.  I hope this article will be useful in your work.  I will be glad to hear comments and suggestions. </div><p>Source: <a href="https://habr.com/ru/post/136431/">https://habr.com/ru/post/136431/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../136425/index.html">Hey google you what</a></li>
<li><a href="../136427/index.html">Internet will appear on long-distance trains.</a></li>
<li><a href="../136428/index.html">Map web service with your own hands. Part 1: Toolkit Overview</a></li>
<li><a href="../136429/index.html">ABBYY Lingvo usability testing</a></li>
<li><a href="../136430/index.html">We create our own framework based on symfony2. (Part 2)</a></li>
<li><a href="../136432/index.html">So.cl - an overview of the interface</a></li>
<li><a href="../136433/index.html">Google instructions to properly disable sites January 18</a></li>
<li><a href="../136434/index.html">Russian, English and Chinese enter the program ...</a></li>
<li><a href="../136437/index.html">Vandalism of Google‚Äôs OpenStreetMap Project Maps</a></li>
<li><a href="../136438/index.html">Using Zend_Form_Element_File in CRUD</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>