<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Modifying the Vanilla Music Player for Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sometimes we lack the functionality of the applications that we use every day. With this programming skills, I want to do something of my own: a produ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Modifying the Vanilla Music Player for Android</h1><div class="post__text post__text-html js-mediator-article">  Sometimes we lack the functionality of the applications that we use every day.  With this programming skills, I want to do something of my own: a product that will have all the necessary functions that you need.  So I decided to write my own android player, but I ran into serious difficulty - to make a more or less usable player requires a lot of programming time, and even more debugging.  Googling a little on the topic of open-source players for Android, I quickly found the Vanilla Music project on Google Play, and then on Github.  After downloading the source code, I soon soon began to modify it to fit my needs. <br><br>  I have been trying to master Android programming for a long time and write applications for my own needs, sometimes putting them on Google Play.  This time I wanted the player to switch songs on the volume keys.  This is of course inconvenient if you need to change the volume ‚Äî therefore, the second version of the idea sounded like this: switching the songs with the volume keys should occur only when the phone is in your pocket, otherwise just adjust the volume.  The second thing I would like to have in the player's functionality is the ability to shift the playback stop time if the device was actively used.  So let's get down to practice! <br><a name="habracut"></a><br>  Having opened the source of the player, I began to understand where and how the music playback is managed.  As it turned out, this is a PlaybackService class, judging by the presence of functions for playing, stopping, switching tracks.  This functionality was incorporated into the performAction function of this class: <br><br><div class="spoiler">  <b class="spoiler_title">public void performAction (Action action, PlaybackActivity receiver)</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Execute the given action. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> action The action to execute. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> receiver Optional. If non-null, update the PlaybackActivity with * new song or state from the executed action. The activity will still be * updated by the broadcast if not passed here; passing it just makes the * update immediate. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">performAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Action action, PlaybackActivity receiver)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (action) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Nothing: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Library: Intent intent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, LibraryActivity.class); intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_NEW_TASK); startActivity(intent); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> PlayPause: { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> state = playPause(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (receiver != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) receiver.setState(state); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> NextSong: { Song song = shiftCurrentSong(SongTimeline.SHIFT_NEXT_SONG); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (receiver != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) receiver.setSong(song); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> PreviousSong: { Song song = shiftCurrentSong(SongTimeline.SHIFT_PREVIOUS_SONG); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (receiver != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) receiver.setSong(song); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> NextAlbum: { Song song = shiftCurrentSong(SongTimeline.SHIFT_NEXT_ALBUM); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (receiver != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) receiver.setSong(song); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> PreviousAlbum: { Song song = shiftCurrentSong(SongTimeline.SHIFT_PREVIOUS_ALBUM); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (receiver != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) receiver.setSong(song); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Repeat: { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> state = cycleFinishAction(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (receiver != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) receiver.setState(state); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Shuffle: { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> state = cycleShuffle(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (receiver != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) receiver.setState(state); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> EnqueueAlbum: enqueueFromCurrent(MediaUtils.TYPE_ALBUM); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> EnqueueArtist: enqueueFromCurrent(MediaUtils.TYPE_ARTIST); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> EnqueueGenre: enqueueFromCurrent(MediaUtils.TYPE_GENRE); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ClearQueue: clearQueue(); Toast.makeText(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, R.string.queue_cleared, Toast.LENGTH_SHORT).show(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ShowQueue: Intent intentShowQueue = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, ShowQueueActivity.class); intentShowQueue.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_NEW_TASK); startActivity(intentShowQueue); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ToggleControls: <span class="hljs-comment"><span class="hljs-comment">// Handled in FullPlaybackActivity.performAction break; case SeekForward: if (mCurrentSong != null) { mPendingSeekSong = mCurrentSong.id; mPendingSeek = getPosition() + 10000; // We 'abuse' setCurrentSong as it will stop the playback and restart it // at the new position, taking care of the ui update setCurrentSong(0); } break; case SeekBackward: if (mCurrentSong != null) { mPendingSeekSong = mCurrentSong.id; mPendingSeek = getPosition() - 10000; if (mPendingSeek &lt; 1) mPendingSeek = 1; // must at least be 1 setCurrentSong(0); } break; default: throw new IllegalArgumentException("Invalid action: " + action); } }</span></span></code> </pre> <br></div></div><br>  As you can see, the names of the commands sound very clearly.  Select the commands NextSong (next track), PreviousSong (previous track) and PlayPause we need (set a pause during playback or play during a pause).  In order to catch the volume keys pressed inside the server (this is more difficult than inside the Activity), we will create a function for estimating the volume change.  For this we need <a href="http://developer.android.com/reference/android/database/ContentObserver.html">ContentObserver</a> .  We add a class to the PlaybackService space: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">public class SettingsContentObserver extends ContentObserver</b> <div class="spoiler_text"><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SettingsContentObserver</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContentObserver</span></span></span><span class="hljs-class"> </span></span>{ Context context; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SettingsContentObserver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context c, Handler handler)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(handler); context = c; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deliverSelfNotifications</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.deliverSelfNotifications(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onChange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> selfChange)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onChange(selfChange); } }</code> </pre><br></div></div><br>  In order for SettingsContentObserver to work, you must associate it with the Playbackservice.  To do this, in the onCreate () function of the SettingsContentObserver class, we write the following lines: <br><br><pre> <code class="java hljs"> SettingsContentObserver mSettingsContentObserver = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SettingsContentObserver(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Handler()); getApplicationContext().getContentResolver().registerContentObserver(android.provider.Settings.System.CONTENT_URI, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, mSettingsContentObserver);</code> </pre><br>  In order for the SettingsContentObserver class to determine the volume key presses, we will read and analyze the volume changes from the mAudioManager object that has already been declared and initialized in the Playbackservice class. <br><br>  Here is the code for the modified SettingsContentObserver class: <br><div class="spoiler">  <b class="spoiler_title">public class SettingsContentObserver extends ContentObserver</b> <div class="spoiler_text"><pre> <code class="java hljs"> <span class="hljs-comment"><span class="hljs-comment">// for a catch volume change public class SettingsContentObserver extends ContentObserver { int previousVolume; Context context; int prevdelta=0; public SettingsContentObserver(Context c, Handler handler) { super(handler); context = c; AudioManager audio = mAudioManager; previousVolume = audio.getStreamVolume(AudioManager.STREAM_MUSIC); } @Override public boolean deliverSelfNotifications() { return super.deliverSelfNotifications(); } @Override public void onChange(boolean selfChange) { super.onChange(selfChange); AudioManager audio = mAudioManager; int currentVolume = audio.getStreamVolume(AudioManager.STREAM_MUSIC); if(isproximity &amp;&amp; enable_vol_track_select) { // isproximity , enable_vol_track_select -      //         long now = SystemClock.elapsedRealtime(); if (now - mLastVolChangeTime &gt; MIN_SHAKE_PERIOD * 8) { //   handler ,      undo_volume_change(); delta = previousVolume - currentVolume; mLastVolChangeTime = now; if (delta &gt; 0) { performAction(Action.NextSong, null); //     previousVolume = currentVolume; } else if (delta &lt;= 0) { performAction(Action.PreviousSong, null); //     previousVolume = currentVolume; } prevdelta = delta; } else { int difvol = currentVolume - audio.getStreamVolume(AudioManager.STREAM_MUSIC); previousVolume = difvol + currentVolume; } }else delta=0; } }</span></span></code> </pre><br></div></div><br>  SettingsContentObserver also uses the following variables of the PlaybackService class (which must be declared): <br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> isproximity = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-comment"><span class="hljs-comment">//     boolean enable_vol_track_select = true; //     long mLastVolChangeTime=0; //     int delta = 0; //       </span></span></code> </pre><br>  .  Since  We work with volume estimation, if the user switches the tracks - the volume will change, so we will run a separate background task that will set the volume to the past value if it has changed (this task can be found in the code block above, it is highlighted with a comment): <br><br><div class="spoiler">  <b class="spoiler_title">void undo_volume_change ()</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">undo_volume_change</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// undo volume change afer next-prev comand android.os.Handler h = new Handler() { int currentVolume; public void handleMessage(android.os.Message msg) { switch (msg.what) { case 1: currentVolume = mAudioManager.getStreamVolume(AudioManager.STREAM_MUSIC); break; case 2: if(isproximity) { if(mMediaPlayer.isPlaying() ) { if(Math.abs(delta)==1) { mAudioManager.setStreamVolume(AudioManager.STREAM_MUSIC, currentVolume + delta, AudioManager.FLAG_SHOW_UI); Log.d("PLEER", " setStreamVolume Volume=" + String.valueOf(currentVolume)); } } } else { delta=0; currentVolume = mAudioManager.getStreamVolume(AudioManager.STREAM_MUSIC); } break; } }; }; h.sendEmptyMessage(1); h.sendEmptyMessageDelayed(2,1000); }</span></span></code> </pre><br></div></div><br>  So, the functionality for switching tracks is ready.  In order for the tracks to switch when the smartphone is in your pocket, we will need to set the variable isproximity = true (see the SettingsContentObserver class, onChange method), when evaluating data from the proximity sensor.  To enable it to work, we will find the <i>private void setupSensor ()</i> method and modify it as follows, adding a listener for the proximity sensor: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setupSensor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mSensorManager == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) mSensorManager = (SensorManager) getSystemService(SENSOR_SERVICE); mSensorManager.registerListener(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, mSensorManager.getDefaultSensor(Sensor.TYPE_ACCELEROMETER),SensorManager.SENSOR_DELAY_GAME); mSensorManager.registerListener(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, mSensorManager.getDefaultSensor(Sensor.TYPE_PROXIMITY),SensorManager.SENSOR_DELAY_NORMAL); }</code> </pre><br>  To receive and evaluate data from sensors, use the already present method <i>public void onSensorChanged (SensorEvent event)</i> and add the following code to its beginning: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (event.sensor.getType() == Sensor.TYPE_PROXIMITY) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( event.values[<span class="hljs-number"><span class="hljs-number">0</span></span>] == <span class="hljs-number"><span class="hljs-number">0</span></span>)isproximity = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> isproximity = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> </pre><br>  In this section of the code, we change the global class variable Playbackservice <i>isproximity</i> in accordance with the data from the proximity sensor and, thus, enable or disable the ability to switch tracks on when the phone is in your pocket.  If we consider this method, then below we will see the reading and processing of data from the accelerometer, and this is what we need to assess whether the user took the smartphone in his hands, for deferring stopping playback.  To determine the activity, I experimentally determined the trigger threshold for the accelerometer, if the user took the smartphone in his hands, adding the following piece of code (it is marked with a comment) in the onSensorChanged method: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (event.sensor.getType() == Sensor.TYPE_ACCELEROMETER) <span class="hljs-comment"><span class="hljs-comment">//      { { double x = event.values[0]; double y = event.values[1]; double z = event.values[2]; double accel = Math.sqrt(x * x + y * y + z * z); double delta = accel - mAccelLast; mAccelLast = accel; double filtered = mAccelFiltered * 0.9f + delta; mAccelFiltered = filtered; //    Log.d("PLEER", " filtered = " + String.valueOf(filtered)); if (filtered &gt; 3.5 ) //      { //    } }</span></span></code> </pre><br>  So, we chose the value at which the accelerometer shows that the user took the phone in his hands, now it remains only to execute the code for the shutdown delay.  Since  the timeout has already been implemented in Vanilla Music, it was not difficult to find the lines of code that perform the timeout: they are in the <i>public void userActionTriggered ()</i> function: <br><br><pre> <code class="java hljs">mHandler.removeMessages(MSG_FADE_OUT); mHandler.removeMessages(MSG_IDLE_TIMEOUT); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mIdleTimeout != <span class="hljs-number"><span class="hljs-number">0</span></span>) mHandler.sendEmptyMessageDelayed(MSG_IDLE_TIMEOUT, mIdleTimeout * <span class="hljs-number"><span class="hljs-number">1000</span></span>);</code> </pre><br>  The mIdleTimeout value is the off time read from the settings.  Put this code in the event handler from the accelerometer, while taking it in your hands (enable_defer_stop == true - enable the option to delay playback stop): <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (se.sensor.getType() == Sensor.TYPE_ACCELEROMETER) { <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> x = se.values[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> y = se.values[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> z = se.values[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> accel = Math.sqrt(x * x + y * y + z * z); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> delta = accel - mAccelLast; mAccelLast = accel; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> filtered = mAccelFiltered * <span class="hljs-number"><span class="hljs-number">0.9f</span></span> + delta; mAccelFiltered = filtered; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (filtered &gt; mShakeThreshold &amp;&amp; mShakeAction !=Action.Nothing); { <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> now = SystemClock.elapsedRealtime(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (now - mLastShakeTime &gt; MIN_SHAKE_PERIOD) { mLastShakeTime = now; performAction(mShakeAction, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (filtered &gt; <span class="hljs-number"><span class="hljs-number">3.5</span></span> &amp;&amp; enable_defer_stop) <span class="hljs-comment"><span class="hljs-comment">//  c { mHandler.removeMessages(MSG_FADE_OUT); mHandler.removeMessages(MSG_IDLE_TIMEOUT); if (mIdleTimeout != 0) mHandler.sendEmptyMessageDelayed(MSG_IDLE_TIMEOUT, mIdleTimeout * 1000); } ... }</span></span></code> </pre><br>  To summarize: we modified the <a href="https://github.com/vanilla-music/vanilla">source code of Vanilla Music</a> , with these changes it can switch tracks in a pocket and debug its sleep for a specified time, if the user took the phone in hand, the result was to make the application for themselves with minimal time costs, in this and there is a big benefit of open source.  The code obtained as a result of the modification you can see <a href="https://github.com/wkoroy/vanilla-smart-switch-of-tracks/tree/05b639350a2530b7f8664c0ee177c2e081165811">here</a> , as well as download the <a href="https://github.com/wkoroy/vanilla-smart-switch-of-tracks/commit/340a7a3633afebb35bf3cf232451562c6166b5d4">source code of the project</a> . <br>  UPD: <a href="https://habrahabr.ru/post/352562/">The next article is</a> about adding another interesting feature. </div><p>Source: <a href="https://habr.com/ru/post/268923/">https://habr.com/ru/post/268923/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268909/index.html">CRM is a mockingbird. We integrate amoCRM, telephony and cellular communication</a></li>
<li><a href="../268911/index.html">Interview with Audrey Tan, Part 1</a></li>
<li><a href="../268915/index.html">Accordion about architecture and localization</a></li>
<li><a href="../268917/index.html">Visualization of static and dynamic networks on R, part 6</a></li>
<li><a href="../268921/index.html">Steam Files. Part 2 - BLOB, CDR, VDF, PAK, VPK</a></li>
<li><a href="../268925/index.html">From participating in the hackathon to winning the Imagine Cup</a></li>
<li><a href="../268929/index.html">Event-oriented Python backtesting step by step. Part 4</a></li>
<li><a href="../268931/index.html">5 internships for programmers abroad</a></li>
<li><a href="../268933/index.html">Megahakaton IoT Russia from Intel and Microsoft</a></li>
<li><a href="../268935/index.html">Programming Philosophy 10 - AI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>