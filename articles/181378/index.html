<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Merge Duplicates in Oracle</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Just a few days ago, I described a set of procedures that help combat duplicates in a PostgreSQL database. Let me remind you that by duplicates I unde...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">🔎</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">📜</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">⬆️</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">⬇️</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Merge Duplicates in Oracle</h1><div class="post__text post__text-html js-mediator-article">  Just a few days ago, I <a href="http://habrahabr.ru/post/179789/">described a</a> set of procedures that help combat duplicates in a PostgreSQL database.  Let me remind you that by duplicates I understand the entries made in reference books again, for example, by mistake.  As it turned out, a similar tool might also be useful for Oracle. <br><a name="habracut"></a><br>  To begin with, we will create the “reference” tables needed for debugging and testing our functionality: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cd0/b6a/4ab/cd0b6a4abe877c815434e9375bd02ffb.png" alt="image"><br><br><div class="spoiler">  <b class="spoiler_title">Test tables</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> city ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> varchar2(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> city_pk <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> city(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> city <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> city_pk primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> street ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, city_id <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> varchar2(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> street_pk <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> street(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> street_fk <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> street(city_id); <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> street <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> street_pk primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> street <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> fk_street <span class="hljs-keyword"><span class="hljs-keyword">foreign</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> (city_id) <span class="hljs-keyword"><span class="hljs-keyword">references</span></span> city(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> address ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, street_id <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, house varchar2(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, apartment varchar2(<span class="hljs-number"><span class="hljs-number">10</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> address_pk <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> address(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> address_fk <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> address(street_id); <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> address <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> address_pk primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> address <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> fk_address <span class="hljs-keyword"><span class="hljs-keyword">foreign</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> (street_id) <span class="hljs-keyword"><span class="hljs-keyword">references</span></span> street(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>);</code> </pre> <br></div></div><br>  ... and fill them with data: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Test data</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> city(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> street(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, city_id, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> street(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, city_id, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> address(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, street_id, house, apartment) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'10'</span></span>, <span class="hljs-string"><span class="hljs-string">'1'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> address(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, street_id, house, apartment) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'10'</span></span>, <span class="hljs-string"><span class="hljs-string">'2'</span></span>);</code> </pre><br></div></div><br>  Now let's think about what actions need to be done to “merge” duplicates?  We have two entries that we consider “duplicates.”  It is required to delete one of them, and all references to it to change so that they point to the second.  Of course, all this must be done in such a way that this action can be rolled back, if necessary.  Thus, it is necessary to record all the information required for rollback in the service tables: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/824/f64/28a/824f6428ae54612c1f41fbcc10c748eb.png" alt="image"><br><br><div class="spoiler">  <b class="spoiler_title">Utility tables</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> mg_table ( <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> varchar2(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> mg_table_pk <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> mg_table(<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> mg_table <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> mg_table_pk primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> mg_merge_seq; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> mg_merge ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, table_name varchar2(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, old_id <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, new_id <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> mg_merge_pk <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> mg_merge(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> mg_merge_uk <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> mg_merge(table_name, old_id); <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> mg_merge <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> mg_merge_pk primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> mg_merge <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> fk_mg_merge <span class="hljs-keyword"><span class="hljs-keyword">foreign</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> (table_name) <span class="hljs-keyword"><span class="hljs-keyword">references</span></span> mg_table(<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> mg_ref_seq; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> mg_ref ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, merge_id <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, table_name varchar2(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, pk_name varchar2(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, column_name varchar2(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, object_id <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> mg_ref_pk <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> mg_ref(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> mg_ref_fk <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> mg_ref(merge_id); <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> mg_ref <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> mg_ref_pk primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> mg_ref <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> fk_mg_ref <span class="hljs-keyword"><span class="hljs-keyword">foreign</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> (merge_id) <span class="hljs-keyword"><span class="hljs-keyword">references</span></span> mg_merge(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>);</code> </pre><br></div></div><br>  To save the deleted record, we will use a table that repeats the structure of the original.  This table will be created automatically during the first merge of duplicates of the corresponding directory.  We will form the name by adding the prefix “mg_” to the reference table name (for example, if for the first time we need to merge duplicates in the street reference book, we must create the mg_street table to save the deleted records). <br><br>  In the mg_table table, the names of the tables processed in this way will be recorded.  In mg_merge, we will store the keys of the merged records, and in mg_ref, the identifiers of the records referring to the old value.  It is easy to see that such a structure of reference tables allows you to work only with single-column numeric keys.  For this reason, the first thing we need to do is to check whether we can work with the selected directory: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(cn) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> b.constraint_name, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) cn <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> user_constraints a <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> user_constraints b <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (b.r_constraint_name = a.constraint_name) <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> user_cons_columns c <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (c.constraint_name = b.constraint_name) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> a.table_name = <span class="hljs-keyword"><span class="hljs-keyword">upper</span></span>(p_name) <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> b.constraint_name );</code> </pre><br>  With this query, we determine the maximum number of columns in foreign keys that refer to the table specified by the name p_name.  It should be noted that compiling such queries in Oracle is very simple.  You do not need to memorize the names of all Oracle system views.  We can always refresh our memory by running the following simple query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dictionary</code> </pre><br>  Further, all actions to perform a merge are fairly obvious, although they require active use of <a href="http://docs.oracle.com/cd/B19306_01/appdev.102/b14261/executeimmediate_statement.htm">execute immediate</a> (the full source code of the package is given at the end of the article). <br><br>  Some comments are required on the procedure for rolling back changes.  In addition to the possibility of rolling back the last change, the described package allows you to roll back a single change by specifying its ID.  Obviously, not any merge can be rolled back this way.  The ability to roll back a change is checked using the following query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> mg_merge <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> old_id = l_new;</code> </pre><br>  The point of this check is simple - we cannot roll back the merge of records if the record remaining after its execution was subsequently deleted by another merge. <br><br>  The package implementation looks like this: <br><br><div class="spoiler">  <b class="spoiler_title">mg_merge_pkg.sql</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> mg_merge_pkg <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> <span class="hljs-keyword"><span class="hljs-keyword">merge</span></span>(p_name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> varchar2, p_old <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, p_new <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>); procedure undo(p_id in number); procedure undo; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> mg_merge_pkg; / <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">errors</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> <span class="hljs-keyword"><span class="hljs-keyword">body</span></span> mg_merge_pkg <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e_unsupported_error <span class="hljs-keyword"><span class="hljs-keyword">EXCEPTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">pragma</span></span> EXCEPTION_INIT(e_unsupported_error, <span class="hljs-number"><span class="hljs-number">-20001</span></span>); cursor c_col(p_name varchar2, p_pk varchar2) is <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> column_name <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> user_tab_columns <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> table_name = <span class="hljs-keyword"><span class="hljs-keyword">upper</span></span>(p_name) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> column_name &lt;&gt; p_pk; procedure <span class="hljs-keyword"><span class="hljs-keyword">merge</span></span>(p_name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> varchar2, p_old <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, p_new <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span> c_fk <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> b.table_name, c.column_name, e.column_name pk_name <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> user_constraints a <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> user_constraints b <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (b.r_constraint_name = a.constraint_name) <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> user_cons_columns c <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (c.constraint_name = b.constraint_name) <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> user_constraints d <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (d.table_name = b.table_name <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> d.constraint_type = <span class="hljs-string"><span class="hljs-string">'P'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> user_cons_columns e <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (e.constraint_name = d.constraint_name) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> a.table_name = <span class="hljs-keyword"><span class="hljs-keyword">upper</span></span>(p_name); r_fk c_fk%rowtype; r_col c_col%rowtype; l_id number default null; l_cn number default null; l_pk varchar2(30) default null; l_sql varchar2(500) default null; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(cn) <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> l_cn <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> b.constraint_name, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) cn <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> user_constraints a <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> user_constraints b <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (b.r_constraint_name = a.constraint_name) <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> user_cons_columns c <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (c.constraint_name = b.constraint_name) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> a.table_name = <span class="hljs-keyword"><span class="hljs-keyword">upper</span></span>(p_name) <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> b.constraint_name ); if l_cn &gt; 1 then RAISE_APPLICATION_ERROR(-20001, 'Can''t support multicolumn FK'); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.column_name <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> l_pk <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> user_constraints a <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> user_cons_columns c <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (c.constraint_name = a.constraint_name) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> a.table_name = <span class="hljs-keyword"><span class="hljs-keyword">upper</span></span>(p_name) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.constraint_type = <span class="hljs-string"><span class="hljs-string">'P'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> l_cn <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> mg_table <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">upper</span></span>(p_name); if l_cn = 0 then <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> mg_table(<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">upper</span></span>(p_name)); <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">immediate</span></span> <span class="hljs-string"><span class="hljs-string">'create table mg_'</span></span> || p_name || <span class="hljs-string"><span class="hljs-string">' as select * from '</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">upper</span></span>(p_name) || <span class="hljs-string"><span class="hljs-string">' '</span></span> || <span class="hljs-string"><span class="hljs-string">'where rownum = 0'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">immediate</span></span> <span class="hljs-string"><span class="hljs-string">'create unique index mg_'</span></span> || p_name || <span class="hljs-string"><span class="hljs-string">'_pk on mg_'</span></span> || p_name || <span class="hljs-string"><span class="hljs-string">'('</span></span> || l_pk || <span class="hljs-string"><span class="hljs-string">')'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> mg_merge(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, table_name, old_id, new_id) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (mg_merge_seq.nextval, <span class="hljs-keyword"><span class="hljs-keyword">upper</span></span>(p_name), p_old, p_new) <span class="hljs-keyword"><span class="hljs-keyword">returning</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> l_id; open c_fk; loop fetch c_fk into r_fk; exit when c_fk%notfound; <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">immediate</span></span> <span class="hljs-string"><span class="hljs-string">'insert into mg_ref(id, merge_id, table_name, pk_name, column_name, object_id) '</span></span> || <span class="hljs-string"><span class="hljs-string">'select mg_ref_seq.nextval, :merge_id, :tab_name, :pk_name, :col_name, '</span></span> || r_fk.pk_name || <span class="hljs-string"><span class="hljs-string">' '</span></span> || <span class="hljs-string"><span class="hljs-string">'from '</span></span> || r_fk.table_name || <span class="hljs-string"><span class="hljs-string">' where '</span></span> || r_fk.column_name || <span class="hljs-string"><span class="hljs-string">' = :old_id'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> l_id, r_fk.table_name, r_fk.pk_name, r_fk.column_name, p_old; <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">immediate</span></span> <span class="hljs-string"><span class="hljs-string">'update '</span></span> || r_fk.table_name || <span class="hljs-string"><span class="hljs-string">' set '</span></span> || r_fk.column_name || <span class="hljs-string"><span class="hljs-string">' = :new_id '</span></span> || <span class="hljs-string"><span class="hljs-string">'where '</span></span> || r_fk.column_name || <span class="hljs-string"><span class="hljs-string">' = :old_id'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> p_new, p_old; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; close c_fk; l_sql := '<span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> mg_<span class="hljs-string"><span class="hljs-string">' || p_name || '</span></span>(<span class="hljs-string"><span class="hljs-string">' || l_pk; open c_col(p_name, l_pk); loop fetch c_col into r_col; exit when c_col%notfound; l_sql := l_sql || '</span></span>,<span class="hljs-string"><span class="hljs-string">' || r_col.column_name; end loop; close c_col; l_sql := l_sql || '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'|| l_pk; open c_col(p_name, l_pk); loop fetch c_col into r_col; exit when c_col%notfound; l_sql := l_sql || '</span></span>,<span class="hljs-string"><span class="hljs-string">' || r_col.column_name; end loop; close c_col; l_sql := l_sql || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">' || p_name || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-string"><span class="hljs-string">' || l_pk || '</span></span> = :old_id<span class="hljs-string"><span class="hljs-string">'; execute immediate l_sql using p_old; execute immediate '</span></span><span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">' || p_name || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-string"><span class="hljs-string">' || l_pk || '</span></span> = :<span class="hljs-keyword"><span class="hljs-keyword">id</span></span><span class="hljs-string"><span class="hljs-string">' using p_old; commit; exception when others then if c_fk%isopen then close c_fk; end if; if c_col%isopen then close c_col; end if; rollback; raise; end; procedure undo(p_id in number) as cursor c_fk is select table_name, pk_name, column_name from mg_ref where merge_id = p_id group by table_name, pk_name, column_name; r_fk c_fk%rowtype; r_col c_col%rowtype; l_name varchar2(30) default null; l_old number default null; l_new number default null; l_cn number default null; l_pk varchar2(30) default null; l_sql varchar2(500) default null; begin select table_name, old_id, new_id into l_name, l_old, l_new from mg_merge where id = p_id; select count(*) into l_cn from mg_merge where old_id = l_new; if l_cn &gt; 0 then RAISE_APPLICATION_ERROR(-20001, '</span></span>Can<span class="hljs-string"><span class="hljs-string">''</span></span>t <span class="hljs-keyword"><span class="hljs-keyword">undo</span></span><span class="hljs-string"><span class="hljs-string">'); end if; select c.column_name into l_pk from user_constraints a inner join user_cons_columns c on (c.constraint_name = a.constraint_name) where a.table_name = upper(l_name) and a.constraint_type = '</span></span>P<span class="hljs-string"><span class="hljs-string">'; l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-string"><span class="hljs-string">' || l_name || '</span></span>(<span class="hljs-string"><span class="hljs-string">' || l_pk; open c_col(l_name, l_pk); loop fetch c_col into r_col; exit when c_col%notfound; l_sql := l_sql || '</span></span>,<span class="hljs-string"><span class="hljs-string">' || r_col.column_name; end loop; close c_col; l_sql := l_sql || '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'|| l_pk; open c_col(l_name, l_pk); loop fetch c_col into r_col; exit when c_col%notfound; l_sql := l_sql || '</span></span>,<span class="hljs-string"><span class="hljs-string">' || r_col.column_name; end loop; close c_col; l_sql := l_sql || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> mg_<span class="hljs-string"><span class="hljs-string">' || l_name || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-string"><span class="hljs-string">' || l_pk || '</span></span> = :old_id<span class="hljs-string"><span class="hljs-string">'; execute immediate l_sql using l_old; open c_fk; loop fetch c_fk into r_fk; exit when c_fk%notfound; execute immediate '</span></span><span class="hljs-keyword"><span class="hljs-keyword">merge</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-string"><span class="hljs-string">' || r_fk.table_name || '</span></span> d <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> mg_ref s <span class="hljs-string"><span class="hljs-string">'|| '</span></span><span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (s.object_id = d.<span class="hljs-string"><span class="hljs-string">' || r_fk.pk_name || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> s.merge_id = :<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> s.table_name = :tab_name <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> s.column_name = :col_name) <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">matched</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> d.<span class="hljs-string"><span class="hljs-string">' || r_fk.column_name || '</span></span> = :old_id<span class="hljs-string"><span class="hljs-string">' using p_id, r_fk.table_name, r_fk.column_name, l_old; end loop; close c_fk; execute immediate '</span></span><span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> mg_<span class="hljs-string"><span class="hljs-string">' || l_name || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-string"><span class="hljs-string">' || l_pk || '</span></span> = :<span class="hljs-keyword"><span class="hljs-keyword">id</span></span><span class="hljs-string"><span class="hljs-string">' using l_old; delete from mg_ref where merge_id = p_id; delete from mg_merge where id = p_id; commit; exception when others then if c_fk%isopen then close c_fk; end if; if c_col%isopen then close c_col; end if; rollback; raise; end; procedure undo as l_id number default null; begin select max(id) into l_id from mg_merge; undo(l_id); end; end mg_merge_pkg; / show errors;</span></span></code> </pre><br></div></div><br>  We can merge dictionary values ​​by running the following query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> mg_merge_pkg.merge(<span class="hljs-string"><span class="hljs-string">'street'</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br><br>  And roll back the changes with the query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> mg_merge_pkg.undo; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br></div><p>Source: <a href="https://habr.com/ru/post/181378/">https://habr.com/ru/post/181378/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../181362/index.html">Overview of the Philips Shoqbox SB7300 Portable Audio System</a></li>
<li><a href="../181366/index.html">Runetology (200): Maxim Spiridonov, CEO of the Netology Education Center</a></li>
<li><a href="../181368/index.html">The secret ingredient is a good architect.</a></li>
<li><a href="../181372/index.html">You are dangerously incompetent in cryptography</a></li>
<li><a href="../181374/index.html">Installing an Openfire server on Debian in the AD2008 domain with transparent user authorization</a></li>
<li><a href="../181384/index.html">Again "sea battle". Count the number of possible ship locations</a></li>
<li><a href="../181386/index.html">In the video editor Youtube function appeared intellectual slowing down time</a></li>
<li><a href="../181388/index.html">Convenient "chips" to work with designers</a></li>
<li><a href="../181392/index.html">Are you registered on public services?</a></li>
<li><a href="../181394/index.html">StackOverflow Survey</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>