<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Consul.io Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When developing applications, special attention should be paid to architecture. If this is not done initially, scaling problems may appear suddenly (a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Consul.io Part 1</h1><div class="post__text post__text-html js-mediator-article">  When developing applications, special attention should be paid to architecture.  If this is not done initially, scaling problems may appear suddenly (and sometimes they may not have a solution).  The scaling of the application and the efficient use of resources at the initial stage are the saved months of work in the future. <br>  To prevent such problems, a distributed architecture is often used, that is, an architecture with the possibility of horizontal scaling of all components.  But unfortunately, with the implementation of SOA, new problems arise, namely, the coherence and complexity of service configuration. <br><br><img src="https://habrastorage.org/files/9c4/e2c/5bf/9c4e2c5bfad64555816d9f6485341ed9.png"><br><br>  In this article we will talk about one of the discovery services called Consul, with which you can solve the above problems and make the architecture more transparent and understandable. <br><a name="habracut"></a><br><h4>  Distributed architectures (SOA) and problems of their construction </h4><br>  When designing an application as a set of loosely coupled components, we initially get the ability to scale any component. <br>  SOA ( <a href="https://en.wikipedia.org/wiki/Service-oriented_architecture">Service Oriented Architecture</a> ) is an architectural pattern that describes the architecture of an application as autonomous components with weak connectivity, communicating with each other using standard protocols (for example, REST).  The logical continuation (or subset) of SOA is the microservice architecture.  It is based on increasing the number of services instead of increasing the functionality of a specific service (a reflection of the principle of Single Responsibility in the architecture) and deep integration with continuous processes. <br>  If we are engaged in the implementation of the microservice architecture, then undoubtedly, the responsibility for the interaction of our services moves towards the infrastructure solution of our application.  Services that comply with the principle of Single Responsibility, can only accept the request and return the answer.  At the same time, it is necessary to balance the traffic between the nodes of the system, you need to connect, albeit weakly, but all the same, the services dependent on each other.  And of course, we need to respond to changes in the configuration of our system: <br><ul><li>  Services are constantly being added. </li><li>  Some services stop responding to healthcheck. </li><li>  New components appear in the system and you need to spread information about them as efficiently as possible. </li><li>  Versions of individual components are updated - backward compatibility breaks. </li></ul><br>  In any system, this is a continuous and complex process, but with the help of the discovery service we will be able to control it and make it more transparent. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  What is discovery? </h4><br>  Discovery is a tool (or toolkit) for connecting the components of an architecture.  Using discovery, we provide <i>connectivity</i> between application components, but not <i>connectivity</i> .  Discovery can be viewed as a registry of meta-information about a distributed architecture, which stores all the data about components.  This allows for the interaction of components with minimal manual intervention (that is, in accordance with the <a href="https://en.wikipedia.org/wiki/Zero-configuration_networking">principle of ZeroConf</a> ). <br><br><h4>  The role of discovery in the process of building a distributed architecture </h4><br>  Discovery service provides three main functions on which connectivity is based within a distributed architecture: <br><ul><li>  The consistency of the meta information about the services within the cluster. </li><li>  A mechanism for registering and monitoring component availability. </li><li>  A mechanism for detecting components. </li></ul><br>  Expand the values ‚Äã‚Äãof each item in detail: <br><br>  <i>Consistency</i> <br>  Distributed architecture implies that components can be scaled horizontally, while they must have relevant information on the status of the cluster.  Discovery-service provides (de) centralized storage and access to it for any node.  Components can save their data and information will be delivered to all interested members of the cluster. <br><br>  <i>Registration and monitoring</i> <br>  Newly added services must inform about themselves, and already running must pass a constant check for accessibility.  This is a prerequisite for automatic cluster configuration.  Traffic balancers and dependent nodes must have information about the current cluster configuration in order to use resources efficiently. <br><br>  <i>Detection</i> <br>  Detection means a search engine for services, for example, by the roles they perform.  We can request a location for all services of a specific role, not knowing their exact number and specific addresses, but knowing only the address of the discovery service. <br><br><h4>  Consul.io as discovery implementation </h4><br>  This article discusses the implementation of discovery based on Consul. <br>  Consul is a decentralized, fault-tolerant discovery service from HashiCorp (which develops products such as Vagrant, TerraForm, Otto, Atlas, and others). <br><br>  Consul is a decentralized service, that is, the Consul agent is installed on each host and is a full member of the cluster.  Thus, services do not need to know the discovery address in our network; all discovery requests are made to the local address 127.0.0.1. <br><br><h5>  What else you need to know about Consul: </h5><br>  To disseminate information, it uses algorithms that are based on the <a href="https://en.wikipedia.org/wiki/Eventual_consistency">eventual consistency</a> model. <br>  Agents use <a href="https://en.wikipedia.org/wiki/Gossip_protocol">the gossip protocol</a> to distribute information. <br>  Servers to select a leader use <a href="https://raft.github.io/">the Raft algorithm</a> . <br>  A leader is a server that accepts all requests to change information.  If we draw an analogy with the database, then this is master in the context of master / slave replication.  All other servers replicate data from the leader.  The key difference from DB replication is that if a leader fails, all other servers launch the mechanism for electing a new leader and after the elections automatically begin to replicate from it.  The switching mechanism is fully automatic and does not require administrator intervention. <br>  Each instance can work in two modes: agent and server.  The difference is that the agent is a distribution point, and the server is a registration point.  Those.  agents accept requests only for reading, and the server can perform changes to existing information (registration and deletion of services).  In fact, we, in any case, make a request to the local address, the only difference is that the read request will be processed by the agent on the local host, and the data change request will be forwarded to the leader, who will save and distribute the data throughout the cluster.  If our local agent is not the leader at the moment, then our change request will be fully processed locally and distributed across the cluster. <br><br><h4>  Using Consul in a cluster </h4><br>  Consul cluster is a network of connected nodes that are running services registered in discovery.  Consul guarantees that cluster information will be distributed to all cluster members and is available upon request.  Also, support is provided not only for a peer-to-peer, but also for a multi-rank, divided by zones, cluster, which in the terminology of Consul are called data centers.  With Consul, you can work with a specific data center, and perform actions on any other.  Data centers are not isolated from each other within the discovery.  An agent in one DC can get information from another DC, which can help in building an effective solution for a distributed system. <br><br><img src="https://habrastorage.org/files/e74/233/d94/e74233d9472a4265a259170ce39b264f.png"><br><br>  Consul agents running in server mode, in addition to their primary role, also get the role of a potential cluster leader.  It is recommended to use at least three agents in a cluster in server mode for fault tolerance.  Using server mode does not impose any restrictions on the main functionality of the agent. <br>  When entering a new node into the cluster, we need to know the address of any node in the cluster.  Running the command: <br> <code>consul join node_ip_address</code> <br>  we register a new node in the cluster and, after a short time, information about the state of the entire cluster will be available to this node.  Accordingly, the new node will be available for requests from other nodes. <br><br><h4>  Types of nodes: internal, external </h4><br>  In Consul, we can register our service in two ways: <br><ul><li>  Use HTTP API or agent configuration file, but only if your service can communicate with Consul on its own. </li><li>  Register the service as a 3d-party component, in case the service cannot communicate with Consul. </li></ul><br>  Consider both cases in more detail. <br>  Using the HTTP API provided by Consul, it is possible to make a correct registration of the component and remove the service in discovery.  In addition to these two states, you can use the <code>maintenance</code> state.  In this mode, the service is marked as inaccessible and is no longer displayed in DNS and API requests. <br><br>  Consider an example of a component registration request (JSON must be transmitted in a PUT request): <br><pre> <code class="bash hljs">http://localhost:8500/v1/agent/service/register { <span class="hljs-string"><span class="hljs-string">"ID"</span></span>: <span class="hljs-string"><span class="hljs-string">"redis1"</span></span>, <span class="hljs-string"><span class="hljs-string">"Name"</span></span>: <span class="hljs-string"><span class="hljs-string">"redis"</span></span>, <span class="hljs-string"><span class="hljs-string">"Tags"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"master"</span></span>, <span class="hljs-string"><span class="hljs-string">"v1"</span></span> ], <span class="hljs-string"><span class="hljs-string">"Address"</span></span>: <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"Port"</span></span>: 8000, <span class="hljs-string"><span class="hljs-string">"Check"</span></span>: { <span class="hljs-string"><span class="hljs-string">"Script"</span></span>: <span class="hljs-string"><span class="hljs-string">"/usr/local/bin/check_redis.py"</span></span>, <span class="hljs-string"><span class="hljs-string">"HTTP"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://localhost:5000/health"</span></span>, <span class="hljs-string"><span class="hljs-string">"Interval"</span></span>: <span class="hljs-string"><span class="hljs-string">"10s"</span></span>, <span class="hljs-string"><span class="hljs-string">"TTL"</span></span>: <span class="hljs-string"><span class="hljs-string">"15s"</span></span> } }</code> </pre><br>  An example of a request to remove a component from the catalog: <br> <code>http://localhost:8500/v1/agent/service/deregister/[ServiceID] <br></code> <br>  An example of a request to put a service into maintenance mode: <br> <code>http://localhost:8500/v1/agent/service/maintenanse/[ServiceID]?enable=true|false <br></code> <br>  Using the enable flag, we can switch the state and add an optional parameter, reason, which contains a text description of the reason for switching the component to maintenance mode. <br><br>  If we need to register any external service and we do not have the opportunity to ‚Äúteach‚Äù it to register with Consul on our own, then we can register it not as a service provider, but as an external service.  After registration, we will be able to obtain external service data via DNS: <br><pre> <code class="bash hljs">$ curl -X PUT -d <span class="hljs-string"><span class="hljs-string">'{"Datacenter": "dc1", "Node": "google", "Address": "www.google.com", "Service": {"Service": "search", "Port": 80}}'</span></span> http://127.0.0.1:8500/v1/catalog/register</code> </pre><br>  In addition to the HTTP API, you can use agent configuration files with a description of services. <br><br>  In the <a href="https://habrahabr.ru/post/278101/">second part</a> we will complete the story about the Consul service, namely, we will tell about its following functions: <br><ul><li>  <b>DNS interface.</b> </li><li>  <b>HTTP API</b> </li><li>  <b>Health Checks.</b> </li><li>  <b>K / V storage.</b> </li></ul><br>  And of course, let's summarize the work with Consul. </div><p>Source: <a href="https://habr.com/ru/post/278085/">https://habr.com/ru/post/278085/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../278069/index.html">Machine Learning: Questions and Answers</a></li>
<li><a href="../278071/index.html">Citrix Tech Exchange Moscow 2016: how it changed my attitude to Xen</a></li>
<li><a href="../278073/index.html">[ScanDoc] preprocessing scans</a></li>
<li><a href="../278075/index.html">How I reinvented dictionaries in Python</a></li>
<li><a href="../278083/index.html">Docker-compose switch to version 2</a></li>
<li><a href="../278087/index.html">DIY: SQL JOIN in Java</a></li>
<li><a href="../278089/index.html">How does split-testing in Badoo work?</a></li>
<li><a href="../278091/index.html">Funny tabs on MAC OS X or a story about that Tab View</a></li>
<li><a href="../278095/index.html">How board and various other games are balanced - a brief overview of the ways</a></li>
<li><a href="../278099/index.html">The digest of interesting materials for the mobile developer # 142 (February 24-28)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>