<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development for copters</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, copters from toys and flying cameras are becoming Big Business. Copters deliver cargoes, take pictures of the terrain, guard the perimeter, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development for copters</h1><div class="post__text post__text-html js-mediator-article">  Recently, copters from toys and flying cameras are becoming Big Business.  Copters deliver cargoes, take pictures of the terrain, guard the perimeter, spray chemicals in the fields and even paint, in general, perform various kinds of tasks.  Of course, most actions are not done manually, from the console, but are performed programmatically. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/sUAxJuVC7UY%3Ffeature%3Doembed&amp;xid=17259,15700002,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhtNmF1lQBnR9xK2i_AYTu2M63QOg" frameborder="0" allowfullscreen=""></iframe><br><a name="habracut"></a><br>  Copters are different.  There is no uniform standard.  At the heart of any copter is a flight controller that accumulates data from sensors, controls stabilization and position in space.  Controlling from the console you send commands to the flight controller, as a result of which the engine revolutions change, which allows you to move in the air.  In more advanced copters other than the console, control is available from the Ground Station (Ground Station).  Using an on-board mini-computer with a connection directly to the flight controller combines the advantages of a hand-held control unit and a ground station, allows you to automate the flight and interact with the outside world. <br><br>  My project required a ready-made platform with the possibility of expansion.  At the same time, I would like everything to work out of the box.  It is necessary to lift 500-600 grams of cargo, including the on-board mini-computer for data processing directly in flight.  And of course the price should be within reasonable limits.  At that time, <a href="https://3dr.com/solo-drone/">Solo</a> was released - a new model from 3DR on <a href="https://pixhawk.org/">Pixhawk 2</a> , in which, in addition to ‚Äúfull stuffing,‚Äù a mini-computer running Linux was installed, communicating via WiFi, and the ability to connect directly to the flight controller and to the onboard computer.  Load capacity up to 700 grams.  In general, what is needed and after a while he was with me. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/files/0cc/859/f68/0cc859f68b184a9085f53c052589135b.jpg"></div><br><br><div class="spoiler">  <b class="spoiler_title">About DJI and self-collection</b> <div class="spoiler_text">  Ready-made platforms can be divided into DJI and mavlink.  Last year, DJI released the onboard SDK for the Matrice 100, but the price is very high.  Another very controversial point in the production of DJI is the registration of applications on the type of Apple Store.  In industrial applications, this is not only a binding to the platform, but also a serious limitation. <br>  For Phantom, official support for third-party software and hardware is not provided.  Mobile SDK does not count, because  do not fit into my tasks. <br><br>  At the same time, mavlink is supported by a large number of available flight controllers and there is every opportunity not only to build any platform for a task, but also to switch to another controller without rewriting the entire code. <br><br>  Assembling a kopter from individual parts is now becoming too expensive, the competition in the kopter market is very high and prices for factory models are rapidly falling.  Modifying the finished model to the required level is often cheaper and faster than collecting everything from scratch. <br></div></div><br>  When enabled, the controller creates a WiFi network, the copter is available at 10.1.1.10, and the controller is 10.1.1.1.  in either case, there is ssh access: <br><blockquote>  ssh root@10.1.1.10 <br>  password TjSDBkAu <br></blockquote><br>  Inside, Linux is used, which is based on the <a href="https://www.yoctoproject.org/">Yocto Project</a> 1.5.1 on the ARM Cortex A9 / Freescale i.MX6.  The system is reduced by an 8Gb microSD card, of which 7.2Gb occupies the section for flight logs.  By default, for the OS and the code is the minimum.  If you are going to change something in the system, then be sure to make a backup.  You will have to remove the engines, open the case and get the main board.  The size of the microSD partitions in this case will have to change or replace the card with a larger one before copying the data through ddresque and changing the size of the ext3 partitions. <br><br>  At the bottom of the Solo there is a connector through which USB, <a href="http://uavcan.org/">UAVCAN</a> , <a href="https://ru.wikipedia.org/wiki/%25D0%25A3%25D0%25BD%25D0%25B8%25D0%25B2%25D0%25B5%25D1%2580%25D1%2581%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25B0%25D1%2581%25D0%25B8%25D0%25BD%25D1%2585%25D1%2580%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BF%25D1%2580%25D0%25B8%25D1%2591%25D0%25BC%25D0%25BE%25D0%25BF%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B4%25D0%25B0%25D1%2582%25D1%2587%25D0%25B8%25D0%25BA">UART</a> outputs for accessing imx6 and Pixhawk are output.  Additional conclusions are available from the board, including those from under Pixhawk, but you will have to pick up a soldering iron.  For example, a USB cable is used to connect third-party devices and works in OTG host mode, for connecting external devices when closing a jumper, or as a device when connecting to an external computer.  For those who do not want to mess around with a soldering iron, we developed the Accessory Breakout Board on which most of the findings already exist, it remains only to use the appropriate connectors. <br><br><div style="text-align:center;"><img width="40%" src="https://habrastorage.org/files/773/4ff/823/7734ff8239c04629bcbd3830f5bd3695.jpg"></div><br><br>  When there is no interference, the signal from the controller to the copter reaches more than 500 meters, 800 according to the specification, which allows you to control it online from a laptop through a WiFi network.  In good weather, the copter is observed at a distance of up to 300-400 meters, everything that further turns into a point and manual control is available only with the help of FPV or automation.  For long and complex distances, it is better to fill the control scripts directly on Solo to eliminate problems with communication and visibility.  By default, scripts can be loaded via sftp, rsync, as well as through the <a href="http://dev.3dr.com/starting-utils.html">solo</a> utility.  For scripts, it is highly desirable to use virtualenv, otherwise versions of packages may conflict with the system ones. <br><br>  <a href="http://qgroundcontrol.org/mavlink/start">Mavlink</a> (Micro Air Vehicle Communication Protocol) is an open communication protocol that most open flight controllers support: APM / Pixhawk, MultiWii, Navio, and others.  With mavlink, you can send control commands, set missions and receive telemetry.  From the time of its appearance, it began to be used not only for micro aviation (copter, plane), but also for controlling micro cars, boats and even submarines.  Depending on the type of vehicle and controller used, the functionality is slightly different. <br><br>  For python, the mavlink protocol is implemented in the pymavlink module.  Directly using it is not very comfortable and partially implemented its wrapper in <a href="http://dronekit.io/">DroneKit</a> .  Partly, because in practice, far from everything has been done, and we constantly have to contact mavlink.  Unrealized mavlink features are in flight controllers, i.e.  the presence of one or another functional has to be checked and tested.  Some commands and modes may be not only not implemented, but also have different names from others.  Therefore, it is better to develop a specific controller and be confident in its future support. <br><br>  Solo is large enough, 46 cm between the motors, with screws even more, i.e.  in a small room it is better not to run it.  Navigation in the room via GPS does not work, so we go further into the street.  Before the flight, look at the current parameters of the copter: <br><br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python #-*- coding: utf-8 -*- from dronekit import connect #    #       DroneKit. vehicle = connect('udpin:0.0.0.0:14550', wait_ready=True) #   print "Vehicle state:" #    , ,    . #     ,       . print " Global Location: %s" % vehicle.location.global_frame print " Global Location (relative altitude): %s" % vehicle.location.global_relative_frame print " Local Location: %s" % vehicle.location.local_frame #    pitch, yaw, roll print " Attitude: %s" % vehicle.attitude #  ,      print " Battery: %s" % vehicle.battery #       . print " Last Heartbeat: %s" % vehicle.last_heartbeat # ,     print " Heading: %s" % vehicle.heading #    print " Groundspeed: %s" % vehicle.groundspeed #    print " Airspeed: %s" % vehicle.airspeed #      print " Is Armable?: %s" % vehicle.is_armable #    print " Armed: %s" % vehicle.armed #      print " Mode: %s" % vehicle.mode.name vehicle.close() print "Done."</span></span></code> </pre> <br>  <a href="http://copter.ardupilot.com/wiki/flight-modes/">Modes</a> are a set of predefined actions and available functionality.  So in ALT_HOLD the set height will be saved and the movement functions are available, AUTO starts the missions, and LAND sets the rotor and turns off the motors.  In some modes, GPS and GPS Lock are required before starting, others work without it.  If necessary, you can make your own modes and program the desired behavior. <br><br>  It's time to take off: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python #-*- coding: utf-8 -*- import time from dronekit import connect, VehicleMode, LocationGlobalRelative #  vehicle = connect('unpin:10.1.1.10:14550', wait_ready=True) def arm_and_takeoff(aTargetAltitude): """       aTargetAltitude """ print " " while not vehicle.is_armable: print " ..." time.sleep(1) print " " #  GUIDED  vehicle.mode = VehicleMode("GUIDED") #   vehicle.armed = True #    . #      ,         . while not vehicle.armed: print "  ..." time.sleep(1) print "!" #     vehicle.simple_takeoff(aTargetAltitude) #       # ‚Ä¶   . while True: print "  : ", vehicle.location.global_relative_frame.alt #     ,      if vehicle.location.global_relative_frame.alt&gt;=aTargetAltitude*0.95: print "  %d " % vehicle.location.global_relative_frame.alt break time.sleep(1) print "  " #     20  arm_and_takeoff(20)</span></span></code> </pre><br>  After the connection, we wait until all the preflight checks are completed and the vehicle.is_armable becomes True.  Next, switch to GUIDED mode which allows you to consistently set points when reaching which the copter will wait for "further instructions."  A coefficient of 0.95 is not necessary, but the accuracy of the sensors is not ideal, and this has to be taken into account.  On the other hand, this allows not to lose time, because there is inertia and speed in flight is not uniform.  The last centimeters will take a few extra seconds, but our battery quickly sits down and ¬± the extra meter of height is not critical. <br><br>  It is time to <s>fly</s> off somewhere.  We set the latitude, longitude and height of the place where we send the copter. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#     a_location = LocationGlobalRelative(-27.114346, -109.357912, 20) #  vehicle.simple_goto(a_location)</span></span></code> </pre><br>  Do not forget to change the coordinates to yours!  If you suddenly forget, you can take over the control of the Solo by pressing the Pause button on the remote control or by lifting both sticks to the upper right corner.  As a last resort, I hope that you connect the tablet and get data from gps, and on board you can consider the phone number for communication. <br><br>  In flight, you can control some parameters, such as speed: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#  , / vehicle.groundspeed = 7.5</span></span></code> </pre><br>  In this case, there is no notification mechanism about the achievement of a given goal ... remember that we made a mavlink connection via UDP?  Our message can go nowhere, and this sometimes happens, especially at long distances. <br><br>  Knowing the speed and distance to calculate the arrival time and set the timer is not a problem.  Ideally, this will work.  For a copter, any wind, headwind, tailwind, side wind makes its own adjustments.  The calm ‚Äúon the ground‚Äù does not mean at all that there is no wind at 30-50-100 meters, so the linear calculation will be very, very approximate. <br><br><div class="spoiler">  <b class="spoiler_title">Weather conditions</b> <div class="spoiler_text">  The wind is of course one of the most obvious factors, but all variables affect the flight.  For example, the thrust force of the engines depends on the magnitude of the pressure and temperature of the atmospheric air.  Low pressure as well as high temperature reduce thrust.  Temperatures below -10-20 ¬∞ C have a very negative effect on batteries, optics and electronics. <br></div></div><br>  A more accurate way is of course to check the position on the GPS / Glonass / Gallileo / Beidou.  Depending on the chip used and its settings, the check makes sense no more than 1-10 times per second, sometimes the interval is longer.  In this case, the accuracy of the location can be plus or minus a few meters. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_arrived</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(lat, lon, alt, precision=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.3</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#   veh_loc = vehicle.location.global_relative_frame #     diff_lat_m = (lat - veh_loc.lat) * 1.113195e5 diff_lon_m = (lon - veh_loc.lon) * 1.113195e5 diff_alt_m = alt - veh_loc.alt #  dist_xyz = math.sqrt(diff_lat_m**2 + diff_lon_m**2 + diff_alt_m**2) if dist_xyz &lt; precision: print "  " return True else: print "  " return False #      while not is_arrived(lat, lon, alt): #   3  time.sleep(3) #      -  time.sleep(10)</span></span></code> </pre><br>  Reaching a given point, we return home.  By analogy, to set a coordinate and to land using LAND mode on arrival as well is a difficult way.  The fact is that at the start, the initial position data is stored for the entire duration of the flight, and there is an RTL (Return To Launch) mode for returning home.  In RTL, the copter first rises to the ‚Äúreturn height‚Äù RTL_ALT, this eliminates the possibility of colliding with trees and high-altitude objects, returns the copter to the starting point, automatically puts the device and turns off the motors. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> vehicle.mode = VehicleMode(<span class="hljs-string"><span class="hljs-string">"RTL"</span></span>)</code> </pre><br>  After some time, the copter will arrive and after landing, happily scribing about the arrival.  You can breathe out ... all is well!  Result on video: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/9K9W0UB0Cqc%3Ffeature%3Doembed&amp;xid=17259,15700002,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiVeLSkKumVDhWW8vMuclNy5qJtKg" frameborder="0" allowfullscreen=""></iframe><br><br><div class="spoiler">  <b class="spoiler_title">Result in the terminal</b> <div class="spoiler_text">  &gt;&gt;&gt; APM: Copter V3.4-dev (6358876f) <br>  &gt;&gt;&gt; Frame: QUAD <br>  Preflight checks <br>  We start the engines <br>  We are waiting for the motors ... <br>  &gt;&gt;&gt; Arming motors <br>  &gt;&gt;&gt; Initialising APM <br>  Takeoff! <br>  Current height: 0.01 <br>  Current height: 0.01 <br>  Current height: 0.15 <br>  Current height: 1.78 <br>  Current height: 3.69 <br>  Current height: 5.79 <br>  Current height: 8.0 <br>  Current height: 10.26 <br>  Current height: 12.52 <br>  Current height: 15.37 <br>  Current height: 17.57 <br>  Current height: 19.12 <br>  Climbed 19 meters <br>  Reached a given height <br>  Not yet flown <br>  Not yet flown <br>  Not yet flown <br>  Not yet flown <br>  Not yet flown <br>  Not yet flown <br>  Not yet flown <br>  Not yet flown <br>  Not yet flown <br>  Not yet flown <br>  Arrived at the scene <br>  Come back <br></div></div><br>  The problem is that it may not fly, not fly, or fly the wrong way.  Any mistake is expensive.  And this is not only a kopter, but also a load on it.  In addition to purely software errors and problems with the equipment, there are problems with the service.  For example, it is desirable to have an even and clean platform for takeoff / landing, you can sit with one foot on a rock ... and roll over.  Even with takeoff, certain problems appear, for example, if you need to take off from a yacht swinging on the waves. <br><br>  Whatever the pain of falls and other troubles, we test scripts in <a href="http://dev.ardupilot.com/wiki/sitl-simulator-software-in-the-loop/">SITL</a> (Software in the Loop).  SITL is a flight simulator that allows you to work out various situations, including some weather conditions, terrain features, GPS malfunction, loss of signal, etc.  SITL does not always work correctly, but overall not bad.  Full testing replace in any case will not work.  For 3D visualization, use SITL with <a href="http://www.flightgear.org/">FlightGear</a> or <a href="https://github.com/PX4/jMAVSim">jMAVSim</a> . <br><br>  Take off, check in and return - it's easy.  Many useful functions have already been implemented for missions, flying along a radius, following an object, controlling standard equipment: a camera and a suspension.  However, the kopter flies "blind", does not see and does not analyze the situation.  We have to set the maximum parameters as in RTL or use various sensors, cameras, additional equipment for calculations, eventually making our own sensors and situation assessment systems.  Therefore, it is desirable to have at least a general idea of ‚Äã‚Äãelectronics, robotics, level matching, data transfer protocols, and sensors.  All this will be needed anyway if you go deep into this topic. </div><p>Source: <a href="https://habr.com/ru/post/281591/">https://habr.com/ru/post/281591/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../281573/index.html">Hackers sold the FBI the secret of hacking the iPhone</a></li>
<li><a href="../281575/index.html">Skype for Business - Cloud Connector Edition (CCE) released</a></li>
<li><a href="../281581/index.html">Infographics: fraud in RuNet</a></li>
<li><a href="../281583/index.html">SparrowHub - repository of ready-made utilities for system administration</a></li>
<li><a href="../281589/index.html">A piece of space in a 3D case</a></li>
<li><a href="../281593/index.html">v3.14.1592-beta2: everything you wanted to know about semantic versioning</a></li>
<li><a href="../281595/index.html">Reverse Engineering Visual Stories</a></li>
<li><a href="../281597/index.html">We write the Slack bot to get comments from VK in Python</a></li>
<li><a href="../281599/index.html">An introduction to shader programming: part 2</a></li>
<li><a href="../281601/index.html">bash + logger application warrants</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>