<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Delayed processing of commands in a social game</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 Today I want to share with you the solution of the problem that we faced when developing a social game. The game client was written in flash...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Delayed processing of commands in a social game</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br><br>  Today I want to share with you the solution of the problem that we faced when developing a social game.  The game client was written in flash, and php was chosen for the back-end.  The game belongs to the time management games. <br>  The scheme of work was chosen as follows: <br><ol><li>  the player performs an action on the client </li><li>  the client checks the possibility of an action </li><li>  sends command to server </li><li>  the server checks whether the action is performed, executes the command, making changes in the database </li><li>  the client is notified that everything is OK or is informed about the error </li></ol><br><br>  Everything worked fine until a sharp increase in the number of players occurred. <br>  First started the brakes from php.  The main problem with this implementation was that for every action a player is jerking a server that performs quite a lot of calculations on calculating objects on the map before executing the command.  This problem was solved by adding additional servers with php handlers. <br>  Then we came up against the performance of mysql.  There were too many requests.  Since the sharding was not incorporated into the system, they were twisted as best they could.  Something moved in mongodb, somewhere improved the work with the cache. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote>  By the way, mongodb was not such a simple repository, as it may seem at first glance.  Considering the fact that we have sharding turned on and the correct indexes were set, we still caught the brakes there, which we could not figure out at that time.  Periodically, just a packet of requests spilled out of the log, which suddenly blunted.  Although a second later the same requests worked fine with the same number of requests.  But this is a topic for a separate post. <br></blockquote><br><br>  Actually for a new similar project, it was decided to use a different scheme of interaction between the client and server. <br>  That's what I want to tell you. <br><br><a name="habracut"></a><br><br>  The principle of operation is as follows: <br><ol><li>  when you start the game receives the full player state of the player and the current game balance </li><li>  the player performs actions on the client </li><li>  the client validates them, but does not send them to the server, but accumulates them </li><li>  upon reaching a condition, the client sends all these commands to the server in a packet </li><li>  the server verifies that the commands are in the correct format and simply informs the client that everything is ok </li><li>  while all the commands are saved in the queue </li><li>  a daemon is also running on the server, which periodically pulls out a stack of commands from this queue and executes them </li></ol><br><br>  It turns out the scheme with deferred processing commands, which has the following advantages: <br><ol><li>  the number of server requests is much reduced </li><li>  decreases the number of calls to mysql when processing commands, since saving to the database occurs only after processing all commands from the pack </li></ol><br><br>  Of course there are also disadvantages, which are more likely solvable problems.  And here you need to look at the requirements of the project. <br>  Our list was as follows: <br><ol><li>  getting the current game state at the moment, until the whole queue for this user is processed </li><li>  some teams require execution in realtime (for example, buying real) </li><li>  players cheating on the client (the command was executed on the client, but failed on the server) </li><li>  multi-thread processing </li></ol><br><br>  Gearman is used as the queuing server on the project.  Otherwise, everything is standard: php + mysql + memcached. <br>  A sharding for mysql and memcached is laid into the current implementation (there is a small number of memcached servers). <br><br>  Let's talk about how to solve the above problems. <br><br><h5>  On the server went packs of commands.  The player closed the game and immediately launched again.  The queue is not processed yet. </h5><br>  Since Gearman is not a DB and it doesn‚Äôt allow to somehow search for data stored inside it, a module was written in php that allows you to connect the database to command processing and always know what state the processing of a particular user is in: how many packs commands in processing and whether there were any errors in processing. <br>  When a client requests a profile for a player for whom the entire queue has not yet been disassembled, he receives in response a message asking him to wait and request a profile after 10 seconds.  This is repeated until the profile is received. <br>  On fitting, it will take up to 20 seconds to execute all the player‚Äôs commands, which is permissible. <br><br><h5>  Execution of certain commands in realtime </h5><br>  It is probably not even a problem.  Just implemented the ability to execute certain commands here and now.  It is necessary so that the player does not lose the money that he brings into the game in case of problems in processing the queue. <br><br><h5>  Cheating player on the client.  Errors due to the difference in logic on the server and client </h5><br>  Situation: the player spun the client and threw money to himself.  The client then allows him to buy the building.  Then the player performs some actions with the building.  It creates a chain of events that could not occur, because the player actually has no money. <br>  The server receives 4 packs of commands.  In the second, there is a team buying a building. <br>  Queue processing begins.  The first pack of commands is processed successfully, and in the second there will be a logical error, which leads to the fact that the building cannot be bought. <br>  At this moment for the user in the database is put a timestamp when an error occurred.  Since all the command packs contain information about when they arrived, at the moment when the handler receives 3 and 4 packs, he will miss them, since their creation time is shorter than the error time. <br>  At this point, the client sends 5 pack of commands, but instead of answering that everything is ok, it receives a request to restart the game state.  We know when the client last received the game state.  And if this time is less than the time of the last error, then the server does not refuse to accept commands for processing. <br><br><h5>  Processing in multiple threads </h5><br>  We have 3 threads.  And 3 packs of teams in the queue for different users.  Handlers simply select these bundles at the same time and process them.  All perfectly. <br>  The situation becomes more complicated when we have 3 packets in a queue for one user and more than 1 free handler.  In order to avoid a situation in which parallel processing of two or more packs of teams of one player begins (they need to be processed sequentially) a kind of traffic light is implemented, which allows you to say that the user is currently being processed.  And if so, then the second handler will put the data back into the queue, but with a <b>higher priority</b> .  The priority is changed so that the 2 task remains ahead 3. Otherwise, after processing 1 pack, the handler will receive 3 pack.  This traffic light is handled by handlers.  At the moment after receiving the commands, we say that the user is processed, and at the end of processing - ready. <br><br>  This is actually all that I wanted to tell.  I do not want to delve into the implementation, as there is nothing nontrivial. <br>  As a framework, the Yii framework is used.  For the daemon, use the command for yiic, which runs as follows <br>  nohup ./yiic que work&gt; / dev / null &amp; <br><br>  The team monitors the number of descendants.  Launches new ones if they fall for some reason. <br>  Descendants register GearmanWork to parse the queue. <br><br>  Thanks for attention!  Put your thumbs up and subscribe :) </div><p>Source: <a href="https://habr.com/ru/post/176497/">https://habr.com/ru/post/176497/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../176481/index.html">Vulnerability on Habrahabr or how to steal an invite</a></li>
<li><a href="../176483/index.html">Aerospace and safety</a></li>
<li><a href="../176485/index.html">Habrainterview with the developers of "Space Rangers"</a></li>
<li><a href="../176487/index.html">Wide Web World</a></li>
<li><a href="../176495/index.html">Ripple: the world's first distributed global currency exchange</a></li>
<li><a href="../176503/index.html">Doorway, Plato and the quality of search in Yandex</a></li>
<li><a href="../176505/index.html">‚ÄúStrategy Pattern. Just a simple "or why I go to the interview" PHP Junior "for fun'a</a></li>
<li><a href="../176507/index.html">The notorious "experience"</a></li>
<li><a href="../176509/index.html">How we created "Hotel for this night!"</a></li>
<li><a href="../176511/index.html">New York police officers equipped with Android-smartphones with "police" applications for quick access to databases</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>