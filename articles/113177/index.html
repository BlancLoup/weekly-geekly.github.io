<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Improving client side forum engine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many of us are aware of the possibility of changing the appearance of websites by local means, without modifying the files on the server. There are va...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Improving client side forum engine</h1><div class="post__text post__text-html js-mediator-article">  Many of us are aware of the possibility of changing the appearance of websites by local means, without modifying the files on the server.  There are various ways to do this, the most popular ones are custom scripts and styles that are automatically applied by the browser to the loaded page.  Of course, the possibilities of such editing are very limited, and to solve some serious problem that requires a non-standard query to the database, this way will not work. <br><br>  However, even in this case, it may turn out that not everything is so hopeless.  In this article I want to talk about my own experience of creating a local add-on for the phpBB2 forum engine, which corrects the display of the read status for topics and posts.  Although the result of this attempt was quite a workable product, which I now constantly use, the purpose of writing this article is still not a product presentation, but a description of the approach to solving the problem.  I spread the code of the received program, but due to the specifics of the task, it is not universal enough and cannot be used as it is, without prior (and rather painstaking) settings for the engine of a particular site.  I decided to warn about this beforehand so that there would be no disappointment. <br><a name="habracut"></a><br>  Well, now in more detail about the formulation of the problem. <br><br>  Despite the fact that the third version of phpBB has long been considered the latest, the second is still quite often found on the Internet.  Here is a list of phpBB2 flaws that my tool is meant to fight: <br><ol><li>  After relogining or restarting the browser, as well as after a certain period of inactivity, all unread topics are automatically marked as read. </li><li>  When you open a topic, it becomes read all over, no matter what page you open. </li><li>  The read status is stored in the cookies as a serialized array.  The maximum size of cookies is usually limited to 4 Kb, which allows storing status only for ~ 140 topics.  For an active forum this is very little. </li></ol>  Some may shrug their shoulders: and what is the problem?  And the problem is that if you strive to be aware of all the cases, then marking the unread topics and messages with an orange leaf (in the base skin) helps to quickly see which topics are updated and which are not.  If you, say, decide to go to the forum now and quickly reply to some message, and read the rest of the updated topics to postpone until later, the next time you see the unread status will be reset, and you will have to search for new messages manually, remembering when it was last visited. specific topic, and looking for dates or texts of posts, what appeared in it from that moment.  And even if you always read all the threads at once, this is not a guarantee: after all, browsers can sometimes crash, the computer can fail, and the light can turn off (and not everyone has a UPS). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Of course, the most appropriate solution to the problem would be to modify the forum engine, but in practice this is not always possible to implement.  Therefore, I decided to try to solve this problem on my own, on the client side.  Of course, there can be no talk of a complete ideal solution without direct access to the database on the server.  In particular, in most cases it is impossible to unambiguously determine the presence / absence of unread topics in a single sub-forum in order to correctly display its icon on the main page (unless you download and analyze the full set of all pages with its topics, but this is a long time).  However, some significant improvements are quite realistic. <br><br>  The overall architecture of the add-in looks like this: a local database is stored on the client machine, which stores the timestamp of the last visit for each topic, plus a proxy server runs that passes all forum pages through itself, correcting the labels for topics and messages in accordance with the actual status readings taken from the local database (and, of course, updating this database as needed). <br><br>  As the base format, I chose a text file with a set of lines like "00000000000000".  Each line corresponds to one topic, the line number (counted from zero) is the topic identifier, and the timestamp of the last visit in the UNIX-time format is recorded as the content of the line.  The zero topic does not exist, so the zero line is used in a special way: it stores the date / time for the forum as a whole, so that you can quickly mark all the forum topics with readings at once.  Thus, for each topic, the real time of the last visit is considered the maximum of two values: general forum and specifically this topic. <br><br>  Why I stopped on the text format?  First, it was convenient to correct errors if necessary, without getting into the binary editor.  Secondly, my proxy server is written in Perl, and in it it is more convenient to work with text files than with binary ones.  Parsing numbers from a text string is not such a resource-intensive operation, and thanks to the fixed length of the string, you can go directly to the desired record by index, without reading the entire file line by line. <br><br>  As for the proxy server implementation, the Pearl language was chosen for the reason that it is very convenient to work with text on it (and HTML parsing will, of course, be the key part).  The resulting speed, by my standards, turned out to be quite acceptable (in any case, the potential performance gain from switching to another language looks less significant to me than wasting time and effort).  The proxy server listens to its port and, upon receiving a request from the browser, sends the request to the target server, reads the response and sends the contents of the received page to the browser.  On its way, the page passes through a filter whose behavior depends on the target address.  If this is one of the forums we need, and not just anything, but one of the scripts <b>viewtopic.php</b> , <b>viewforum.php</b> , <b>index.php</b> (or just the root URL of the forum), then the filter starts parsing the page, replacing the labels of topics and messages based on the date / time of the last visit, taken from the local database.  Otherwise, the filter does not work, but simply sends the unmodified content to the browser. <br><br>  The most difficult and unpredictable part is parsing.  The problem is that different themes and extensions can be installed on each specific forum, so that the HTML-code of the pages received from the server varies widely.  To take into account the peculiarities of different forums, I only use the key structural features of the phpBB2 engine, and specific signal lines are rendered into separate modules that are loaded by the proxy server at the start and allow each forum to be processed according to their own sets of rules.  Of course, if you need to add support for a new forum, you will have to do all the work on selecting and setting up signal lines manually, by analyzing the HTML page received from the server.  If the changes in the engine are small, everything will be limited to this.  But it may also be that the engine has been seriously reworked, and the HTML structure has become completely different.  Then the entire main module will have to be redone, and it‚Äôs not a fact that the ‚Äúmulti-forum‚Äù will be kept at all.  It is possible that it will be easier to keep a separate version of the proxy server, sharpened specifically for one of the "clever" forums. <br><br>  For proper parsing, you will also have to make changes to your forum profile.  The fact is that by default the engine gives the date / time of messages without specifying seconds, and since the time to take us nowhere else, it turns out that the error in placing marks will be one minute, which of course is too much.  Therefore, it is necessary to choose a more complete time format, with seconds, in your profiles [settings].  I dwelled on the ‚ÄúD dmY, G: i: s‚Äù format, which will allow displaying the date in the form of ‚ÄúMon 02/14/2011, 10:57:44 AM‚Äù (of course, the proxy server is not needed for the day of the week, but the convenience of a loved one too Do not forget).  If you prefer a different format, you will need to make the appropriate corrections to the timestamp function.  We should not forget about the modifications of phpBB, which instead of the date can insert the words "today" or "yesterday."  Unfortunately, all this will also require the completion of the code. <br><br>  Well, it remains to mention a few features. <br><ul><li>  Perhaps the main problem is that it is extremely inconvenient to use such a proxy server on an ongoing basis.  If the braking work when working with a single forum can be experienced, then it will be very unpleasant to endure the brakes in everyday work.  I solved this problem for myself in the following way: I have long used Proxomitron as an advertisement cutter and adding all sorts of buns.  Among other things, he has the ability to use different proxy servers depending on the requested address.  I just created rules in it so that the forums I needed were loaded through my proxy (and not entirely, but only the pages being processed), and everything else would work directly, so this lack of inconvenience does not give me.  Those who do not use Proxcitron can look for some alternative options or simply set up in the browser the possibility of fast manual switching of proxies (if, of course, the browser has such an opportunity). </li><li>  I did not want to implement a full-fledged HTTP server or search for a ready-made implementation, so I limited myself to a simple, self-written, but rather limited version (only HTTP / 1.0 is supported with the forced shutdown of gzip-compression).  Personally, this is enough for me, but it may not seem enough to someone. </li><li> In phpBB there is another problem that I managed to podzadolbat.  If I open or update several forum pages at the same time, the engine throws me out of the forum (which, in combination with resetting the read status of the topics, simply infuriated me).  I have not yet figured out the reasons for this behavior, but my proxy server at the same time made it possible to get around this problem.  Initially, it was multithreaded, so that the processing of one page did not slow down the processing of other pages.  I commented out the code responsible for multithreading, and I received slower, but sequential processing of pages, so now I can open a bunch of links in the background tabs at once, almost without worrying that I‚Äôll log out (of course, this is not so fatal, but too much once I enter my login / password and I don‚Äôt feel like updating a bunch of already opened pages).  The drawbacks of this solution, of course, are also there: if one of the pages hangs for some reason, the rest will not load, and you will have to either wait for the departure time out or restart the proxy server.  And when working with several forums, it is wrong to wait for one because of loading another.  The solution may be to run several independent threads, one for each forum, or to launch several instances of proxy servers on different ports.  Just in case, I did not delete the multithreading code, but simply commented it out, so that you can uncomment it and use the normal multithreaded version. </li><li>  The proxy server does not know how to keep track of the number of rows in the database and add new ones as needed (to be honest: it was just too lazy to implement), so it is necessary for it to first create a file filled with zero lines.  The number of lines depends on the forum (more precisely, on the number of topics in it).  To avoid problems, it is better to create a file immediately with a good margin. </li><li>  In the proxy server, there is also support for the "View a single message" phpBB mod ( <b>viewpoint.php</b> script).  When viewing a separate post, the time to visit a topic in the database is not updated, because  in this case, it is easy to miss unread messages that precede the one you are viewing.  If someone thinks this is wrong, the code is easy to correct by removing one <b>if</b> . </li></ul><br>  Well, if someone has not scared away all this confusion yet, the server itself can be downloaded <a href="">from here</a> (archive, 5 Kb).  Included is a set of rules for the official forum Total Commander, which I took as a basis for my experiments and for the sake of which, basically, this whole bodyaga was started. </div><p>Source: <a href="https://habr.com/ru/post/113177/">https://habr.com/ru/post/113177/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../113168/index.html">Lenovo will replace the motherboard in computers with Intel's "problem" chipset for free</a></li>
<li><a href="../113170/index.html">Ubuntu Cyrillic Font</a></li>
<li><a href="../113171/index.html">CarWoo car purchase service announced the launch of a new version</a></li>
<li><a href="../113172/index.html">Toshiba Dynabook Qosmio T750</a></li>
<li><a href="../113175/index.html">Problems with browser games or clone attacks</a></li>
<li><a href="../113178/index.html">Hotmail distributes disposable email addresses</a></li>
<li><a href="../113179/index.html">Unbound Jailbreak for iOS 4.2.1 released</a></li>
<li><a href="../113180/index.html">75,000 application forms in one week</a></li>
<li><a href="../113183/index.html">Learning to count</a></li>
<li><a href="../113184/index.html">The study confirmed the positive impact of online piracy on anime sales.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>