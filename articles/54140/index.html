<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tricks with logging in single-threaded non-blocking servers.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to talk about the next result of my research in the field of optimizing the performance of Web-servers. 
 This time we will discuss the optimiz...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tricks with logging in single-threaded non-blocking servers.</h1><div class="post__text post__text-html js-mediator-article">  I want to talk about the next result of my research in the field of optimizing the performance of Web-servers. <br>  This time we will discuss the optimization of complex logging in a single-threaded non-blocking web server. <br><a name="habracut"></a><br><h4>  Introduction </h4><br>  Everyone has heard more than once how lighttpd (hereinafter ‚Äúlashi‚Äù) is productive and undemanding of resources.  In the last prerelease version 1.5, many innovations have appeared: in particular, the performance has been increased for the return of heavy files on very busy servers (more than 2,000 streams with a total speed of 50-200 MB / s).  I, as the manager of a very large web-storage, could not get past such opportunities.  A test machine with a fast raid and two GigabitEthernet adapters tied into a bond interface with load sharing was delivered to the Debian Linux distribution.  After a couple of hours of trial and error, the link has been compiled and tuned for optimal performance; bang + php_fcgi.  The files were really delivered very quickly and 2000 streams for laity did not turn out to be difficulties.  But then I came across a serious problem. <br>  The fact is that one of the requirements for the web server to work on the file storage is that it can send log lines through the pipe to a specialized program that would process them in a special way.  In this program, the data about the connection is processed (what the user has downloaded, how many bytes are really pumped out for this connection, etc.) and are sent to the database for storage.  Light is able to redirect data through a pipe to a logging program, but the problem lies in its single-threaded non-blocking architecture.  Because  Laiti works in one stream (process) and only sends data to sockets in non-blocking mode ‚Äî then its main thread waits for the write block to be removed until the auxiliary program processes the previous log entry.  And this program can hang up - since the connection to the database is not a constant thing: the request will hang up due to a table or line lock, the connection itself will be lost for unknown reasons and you will have to reconnect.  And it turns out that with each such delay, the Laiti will stop sending data to the sockets and will look as if the server is working in jerks ‚Äî it is running at full speed, then it suddenly hangs. <br><br><h4>  Idea </h4><br>  This problem can be solved by buffering the log entries and parallelizing the processing task of this log.  I implemented it this way: I divided the whole logging subsystem into two parts - an aggregator and a handler.  The aggregator will be responsible for instantly reading logs from the pipe (pipe) (so that the server does not idle), writing this data to the queue (FIFO), spawning child handlers (described later), and actually distributing log lines from the queue to these handlers.  The handler is simply the final processor of log lines, which reads them from the stdin channel and writes to the database, then signals the aggregator that it is free and ready for a new piece of data. <br><br><h4>  Implementation </h4><br>  I will begin with the implementation of the simplest part - the handler.  All it has to do is open stdin in blocking mode and loop through lines from it, sending the character '1' at the end of each iteration.  It should finish its work on detecting eof in the stdin channel (the channel is closed and there is no more data).  Here is the code for this program: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  processor.php: </h5><blockquote><code><a href="http://s-c.me/1234/s"></a> <a href="http://s-c.me/1234/h"></a> <a href="http://www.php.net/manual/en/function.fopen.php"></a> <a href="http://www.php.net/manual/en/function.fgets.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.mysql-connect.php"></a> <a href="http://www.php.net/manual/en/function.mysql-query.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.fclose.php"></a> <font color="black">Copy Source | Copy HTML <font color="#696969">#!/usr/bin/php</font> <font color="#cc6633">&lt;?php</font> <font color="#cc6633">$in</font> = fopen( <font color="#008000">'php://stdin'</font> , <font color="#008000">'r'</font> ); <font color="#696969">//  </font> <font color="#cc6633">$db</font> = NULL; <font color="#0000ff">while</font> ( <font color="#cc6633">$in_str</font> = fgets( <font color="#cc6633">$in</font> )) { <font color="#696969">//    </font> <font color="#0000ff">if</font> (@mysql_ping( <font color="#cc6633">$db</font> ) !== <font color="#0000ff">true</font> ) { <font color="#696969">//      - </font> @mysql_close( <font color="#cc6633">$db</font> ); <font color="#cc6633">$db</font> = mysql_connect(); } mysql_query( <font color="#008000">'   $in_str  '</font> ); <font color="#696969">//    </font> <font color="#0000ff">echo</font> <font color="#008000">'1'</font> ; <font color="#696969">//  ,     </font> } mysql_close( <font color="#cc6633">$db</font> ); fclose( <font color="#cc6633">$in</font> ); <font color="#cc6633">?&gt;</font></font></code> <ol> <li> <code><font color="black"><font color="#696969"><a href="http://s-c.me/1234/s"></a> <a href="http://s-c.me/1234/h"></a> <a href="http://www.php.net/manual/en/function.fopen.php"></a> <a href="http://www.php.net/manual/en/function.fgets.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.mysql-connect.php"></a> <a href="http://www.php.net/manual/en/function.mysql-query.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.fclose.php"></a> Copy Source | Copy HTML #!/usr/bin/php <font color="#cc6633">&lt;?php</font> <font color="#cc6633">$in</font> = fopen( <font color="#008000">'php://stdin'</font> , <font color="#008000">'r'</font> ); <font color="#696969">//  </font> <font color="#cc6633">$db</font> = NULL; <font color="#0000ff">while</font> ( <font color="#cc6633">$in_str</font> = fgets( <font color="#cc6633">$in</font> )) { <font color="#696969">//    </font> <font color="#0000ff">if</font> (@mysql_ping( <font color="#cc6633">$db</font> ) !== <font color="#0000ff">true</font> ) { <font color="#696969">//      - </font> @mysql_close( <font color="#cc6633">$db</font> ); <font color="#cc6633">$db</font> = mysql_connect(); } mysql_query( <font color="#008000">'   $in_str  '</font> ); <font color="#696969">//    </font> <font color="#0000ff">echo</font> <font color="#008000">'1'</font> ; <font color="#696969">//  ,     </font> } mysql_close( <font color="#cc6633">$db</font> ); fclose( <font color="#cc6633">$in</font> ); <font color="#cc6633">?&gt;</font></font></font></code> </li> <li> <code><font color="black"><font color="#cc6633"><a href="http://s-c.me/1234/s"></a> <a href="http://s-c.me/1234/h"></a> <a href="http://www.php.net/manual/en/function.fopen.php"></a> <a href="http://www.php.net/manual/en/function.fgets.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.mysql-connect.php"></a> <a href="http://www.php.net/manual/en/function.mysql-query.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.fclose.php"></a> Copy Source | Copy HTML <font color="#696969">#!/usr/bin/php</font> &lt;?php <font color="#cc6633">$in</font> = fopen( <font color="#008000">'php://stdin'</font> , <font color="#008000">'r'</font> ); <font color="#696969">//  </font> <font color="#cc6633">$db</font> = NULL; <font color="#0000ff">while</font> ( <font color="#cc6633">$in_str</font> = fgets( <font color="#cc6633">$in</font> )) { <font color="#696969">//    </font> <font color="#0000ff">if</font> (@mysql_ping( <font color="#cc6633">$db</font> ) !== <font color="#0000ff">true</font> ) { <font color="#696969">//      - </font> @mysql_close( <font color="#cc6633">$db</font> ); <font color="#cc6633">$db</font> = mysql_connect(); } mysql_query( <font color="#008000">'   $in_str  '</font> ); <font color="#696969">//    </font> <font color="#0000ff">echo</font> <font color="#008000">'1'</font> ; <font color="#696969">//  ,     </font> } mysql_close( <font color="#cc6633">$db</font> ); fclose( <font color="#cc6633">$in</font> ); <font color="#cc6633">?&gt;</font></font></font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/1234/s"></a> <a href="http://s-c.me/1234/h"></a> <a href="http://www.php.net/manual/en/function.fopen.php"></a> <a href="http://www.php.net/manual/en/function.fgets.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.mysql-connect.php"></a> <a href="http://www.php.net/manual/en/function.mysql-query.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.fclose.php"></a> Copy Source | Copy HTML <font color="#696969">#!/usr/bin/php</font> <font color="#cc6633">&lt;?php</font> <font color="#cc6633">$in</font> = fopen( <font color="#008000">'php://stdin'</font> , <font color="#008000">'r'</font> ); <font color="#696969">//  </font> <font color="#cc6633">$db</font> = NULL; <font color="#0000ff">while</font> ( <font color="#cc6633">$in_str</font> = fgets( <font color="#cc6633">$in</font> )) { <font color="#696969">//    </font> <font color="#0000ff">if</font> (@mysql_ping( <font color="#cc6633">$db</font> ) !== <font color="#0000ff">true</font> ) { <font color="#696969">//      - </font> @mysql_close( <font color="#cc6633">$db</font> ); <font color="#cc6633">$db</font> = mysql_connect(); } mysql_query( <font color="#008000">'   $in_str  '</font> ); <font color="#696969">//    </font> <font color="#0000ff">echo</font> <font color="#008000">'1'</font> ; <font color="#696969">//  ,     </font> } mysql_close( <font color="#cc6633">$db</font> ); fclose( <font color="#cc6633">$in</font> ); <font color="#cc6633">?&gt;</font></font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/1234/s"></a> <a href="http://s-c.me/1234/h"></a> <a href="http://www.php.net/manual/en/function.fopen.php"></a> <a href="http://www.php.net/manual/en/function.fgets.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.mysql-connect.php"></a> <a href="http://www.php.net/manual/en/function.mysql-query.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.fclose.php"></a> Copy Source | Copy HTML <font color="#696969">#!/usr/bin/php</font> <font color="#cc6633">&lt;?php</font> <font color="#cc6633">$in</font> = fopen( <font color="#008000">'php://stdin'</font> , <font color="#008000">'r'</font> ); <font color="#696969">//  </font> <font color="#cc6633">$db</font> = NULL; <font color="#0000ff">while</font> ( <font color="#cc6633">$in_str</font> = fgets( <font color="#cc6633">$in</font> )) { <font color="#696969">//    </font> <font color="#0000ff">if</font> (@mysql_ping( <font color="#cc6633">$db</font> ) !== <font color="#0000ff">true</font> ) { <font color="#696969">//      - </font> @mysql_close( <font color="#cc6633">$db</font> ); <font color="#cc6633">$db</font> = mysql_connect(); } mysql_query( <font color="#008000">'   $in_str  '</font> ); <font color="#696969">//    </font> <font color="#0000ff">echo</font> <font color="#008000">'1'</font> ; <font color="#696969">//  ,     </font> } mysql_close( <font color="#cc6633">$db</font> ); fclose( <font color="#cc6633">$in</font> ); <font color="#cc6633">?&gt;</font></font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/1234/s"></a> <a href="http://s-c.me/1234/h"></a> <a href="http://www.php.net/manual/en/function.fopen.php"></a> <a href="http://www.php.net/manual/en/function.fgets.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.mysql-connect.php"></a> <a href="http://www.php.net/manual/en/function.mysql-query.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.fclose.php"></a> Copy Source | Copy HTML <font color="#696969">#!/usr/bin/php</font> <font color="#cc6633">&lt;?php</font> <font color="#cc6633">$in</font> = fopen( <font color="#008000">'php://stdin'</font> , <font color="#008000">'r'</font> ); <font color="#696969">//  </font> <font color="#cc6633">$db</font> = NULL; <font color="#0000ff">while</font> ( <font color="#cc6633">$in_str</font> = fgets( <font color="#cc6633">$in</font> )) { <font color="#696969">//    </font> <font color="#0000ff">if</font> (@mysql_ping( <font color="#cc6633">$db</font> ) !== <font color="#0000ff">true</font> ) { <font color="#696969">//      - </font> @mysql_close( <font color="#cc6633">$db</font> ); <font color="#cc6633">$db</font> = mysql_connect(); } mysql_query( <font color="#008000">'   $in_str  '</font> ); <font color="#696969">//    </font> <font color="#0000ff">echo</font> <font color="#008000">'1'</font> ; <font color="#696969">//  ,     </font> } mysql_close( <font color="#cc6633">$db</font> ); fclose( <font color="#cc6633">$in</font> ); <font color="#cc6633">?&gt;</font></font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/1234/s"></a> <a href="http://s-c.me/1234/h"></a> <a href="http://www.php.net/manual/en/function.fopen.php"></a> <a href="http://www.php.net/manual/en/function.fgets.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.mysql-connect.php"></a> <a href="http://www.php.net/manual/en/function.mysql-query.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.fclose.php"></a> Copy Source | Copy HTML <font color="#696969">#!/usr/bin/php</font> <font color="#cc6633">&lt;?php</font> <font color="#cc6633">$in</font> = fopen( <font color="#008000">'php://stdin'</font> , <font color="#008000">'r'</font> ); <font color="#696969">//  </font> <font color="#cc6633">$db</font> = NULL; <font color="#0000ff">while</font> ( <font color="#cc6633">$in_str</font> = fgets( <font color="#cc6633">$in</font> )) { <font color="#696969">//    </font> <font color="#0000ff">if</font> (@mysql_ping( <font color="#cc6633">$db</font> ) !== <font color="#0000ff">true</font> ) { <font color="#696969">//      - </font> @mysql_close( <font color="#cc6633">$db</font> ); <font color="#cc6633">$db</font> = mysql_connect(); } mysql_query( <font color="#008000">'   $in_str  '</font> ); <font color="#696969">//    </font> <font color="#0000ff">echo</font> <font color="#008000">'1'</font> ; <font color="#696969">//  ,     </font> } mysql_close( <font color="#cc6633">$db</font> ); fclose( <font color="#cc6633">$in</font> ); <font color="#cc6633">?&gt;</font></font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/1234/s"></a> <a href="http://s-c.me/1234/h"></a> <a href="http://www.php.net/manual/en/function.fopen.php"></a> <a href="http://www.php.net/manual/en/function.fgets.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.mysql-connect.php"></a> <a href="http://www.php.net/manual/en/function.mysql-query.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.fclose.php"></a> Copy Source | Copy HTML <font color="#696969">#!/usr/bin/php</font> <font color="#cc6633">&lt;?php</font> <font color="#cc6633">$in</font> = fopen( <font color="#008000">'php://stdin'</font> , <font color="#008000">'r'</font> ); <font color="#696969">//  </font> <font color="#cc6633">$db</font> = NULL; <font color="#0000ff">while</font> ( <font color="#cc6633">$in_str</font> = fgets( <font color="#cc6633">$in</font> )) { <font color="#696969">//    </font> <font color="#0000ff">if</font> (@mysql_ping( <font color="#cc6633">$db</font> ) !== <font color="#0000ff">true</font> ) { <font color="#696969">//      - </font> @mysql_close( <font color="#cc6633">$db</font> ); <font color="#cc6633">$db</font> = mysql_connect(); } mysql_query( <font color="#008000">'   $in_str  '</font> ); <font color="#696969">//    </font> <font color="#0000ff">echo</font> <font color="#008000">'1'</font> ; <font color="#696969">//  ,     </font> } mysql_close( <font color="#cc6633">$db</font> ); fclose( <font color="#cc6633">$in</font> ); <font color="#cc6633">?&gt;</font></font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/1234/s"></a> <a href="http://s-c.me/1234/h"></a> <a href="http://www.php.net/manual/en/function.fopen.php"></a> <a href="http://www.php.net/manual/en/function.fgets.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.mysql-connect.php"></a> <a href="http://www.php.net/manual/en/function.mysql-query.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.fclose.php"></a> Copy Source | Copy HTML <font color="#696969">#!/usr/bin/php</font> <font color="#cc6633">&lt;?php</font> <font color="#cc6633">$in</font> = fopen( <font color="#008000">'php://stdin'</font> , <font color="#008000">'r'</font> ); <font color="#696969">//  </font> <font color="#cc6633">$db</font> = NULL; <font color="#0000ff">while</font> ( <font color="#cc6633">$in_str</font> = fgets( <font color="#cc6633">$in</font> )) { <font color="#696969">//    </font> <font color="#0000ff">if</font> (@mysql_ping( <font color="#cc6633">$db</font> ) !== <font color="#0000ff">true</font> ) { <font color="#696969">//      - </font> @mysql_close( <font color="#cc6633">$db</font> ); <font color="#cc6633">$db</font> = mysql_connect(); } mysql_query( <font color="#008000">'   $in_str  '</font> ); <font color="#696969">//    </font> <font color="#0000ff">echo</font> <font color="#008000">'1'</font> ; <font color="#696969">//  ,     </font> } mysql_close( <font color="#cc6633">$db</font> ); fclose( <font color="#cc6633">$in</font> ); <font color="#cc6633">?&gt;</font></font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/1234/s"></a> <a href="http://s-c.me/1234/h"></a> <a href="http://www.php.net/manual/en/function.fopen.php"></a> <a href="http://www.php.net/manual/en/function.fgets.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.mysql-connect.php"></a> <a href="http://www.php.net/manual/en/function.mysql-query.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.fclose.php"></a> Copy Source | Copy HTML <font color="#696969">#!/usr/bin/php</font> <font color="#cc6633">&lt;?php</font> <font color="#cc6633">$in</font> = fopen( <font color="#008000">'php://stdin'</font> , <font color="#008000">'r'</font> ); <font color="#696969">//  </font> <font color="#cc6633">$db</font> = NULL; <font color="#0000ff">while</font> ( <font color="#cc6633">$in_str</font> = fgets( <font color="#cc6633">$in</font> )) { <font color="#696969">//    </font> <font color="#0000ff">if</font> (@mysql_ping( <font color="#cc6633">$db</font> ) !== <font color="#0000ff">true</font> ) { <font color="#696969">//      - </font> @mysql_close( <font color="#cc6633">$db</font> ); <font color="#cc6633">$db</font> = mysql_connect(); } mysql_query( <font color="#008000">'   $in_str  '</font> ); <font color="#696969">//    </font> <font color="#0000ff">echo</font> <font color="#008000">'1'</font> ; <font color="#696969">//  ,     </font> } mysql_close( <font color="#cc6633">$db</font> ); fclose( <font color="#cc6633">$in</font> ); <font color="#cc6633">?&gt;</font></font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/1234/s"></a> <a href="http://s-c.me/1234/h"></a> <a href="http://www.php.net/manual/en/function.fopen.php"></a> <a href="http://www.php.net/manual/en/function.fgets.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.mysql-connect.php"></a> <a href="http://www.php.net/manual/en/function.mysql-query.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.fclose.php"></a> Copy Source | Copy HTML <font color="#696969">#!/usr/bin/php</font> <font color="#cc6633">&lt;?php</font> <font color="#cc6633">$in</font> = fopen( <font color="#008000">'php://stdin'</font> , <font color="#008000">'r'</font> ); <font color="#696969">//  </font> <font color="#cc6633">$db</font> = NULL; <font color="#0000ff">while</font> ( <font color="#cc6633">$in_str</font> = fgets( <font color="#cc6633">$in</font> )) { <font color="#696969">//    </font> <font color="#0000ff">if</font> (@mysql_ping( <font color="#cc6633">$db</font> ) !== <font color="#0000ff">true</font> ) { <font color="#696969">//      - </font> @mysql_close( <font color="#cc6633">$db</font> ); <font color="#cc6633">$db</font> = mysql_connect(); } mysql_query( <font color="#008000">'   $in_str  '</font> ); <font color="#696969">//    </font> <font color="#0000ff">echo</font> <font color="#008000">'1'</font> ; <font color="#696969">//  ,     </font> } mysql_close( <font color="#cc6633">$db</font> ); fclose( <font color="#cc6633">$in</font> ); <font color="#cc6633">?&gt;</font></font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/1234/s"></a> <a href="http://s-c.me/1234/h"></a> <a href="http://www.php.net/manual/en/function.fopen.php"></a> <a href="http://www.php.net/manual/en/function.fgets.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.mysql-connect.php"></a> <a href="http://www.php.net/manual/en/function.mysql-query.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.fclose.php"></a> Copy Source | Copy HTML <font color="#696969">#!/usr/bin/php</font> <font color="#cc6633">&lt;?php</font> <font color="#cc6633">$in</font> = fopen( <font color="#008000">'php://stdin'</font> , <font color="#008000">'r'</font> ); <font color="#696969">//  </font> <font color="#cc6633">$db</font> = NULL; <font color="#0000ff">while</font> ( <font color="#cc6633">$in_str</font> = fgets( <font color="#cc6633">$in</font> )) { <font color="#696969">//    </font> <font color="#0000ff">if</font> (@mysql_ping( <font color="#cc6633">$db</font> ) !== <font color="#0000ff">true</font> ) { <font color="#696969">//      - </font> @mysql_close( <font color="#cc6633">$db</font> ); <font color="#cc6633">$db</font> = mysql_connect(); } mysql_query( <font color="#008000">'   $in_str  '</font> ); <font color="#696969">//    </font> <font color="#0000ff">echo</font> <font color="#008000">'1'</font> ; <font color="#696969">//  ,     </font> } mysql_close( <font color="#cc6633">$db</font> ); fclose( <font color="#cc6633">$in</font> ); <font color="#cc6633">?&gt;</font></font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/1234/s"></a> <a href="http://s-c.me/1234/h"></a> <a href="http://www.php.net/manual/en/function.fopen.php"></a> <a href="http://www.php.net/manual/en/function.fgets.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.mysql-connect.php"></a> <a href="http://www.php.net/manual/en/function.mysql-query.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.fclose.php"></a> Copy Source | Copy HTML <font color="#696969">#!/usr/bin/php</font> <font color="#cc6633">&lt;?php</font> <font color="#cc6633">$in</font> = fopen( <font color="#008000">'php://stdin'</font> , <font color="#008000">'r'</font> ); <font color="#696969">//  </font> <font color="#cc6633">$db</font> = NULL; <font color="#0000ff">while</font> ( <font color="#cc6633">$in_str</font> = fgets( <font color="#cc6633">$in</font> )) { <font color="#696969">//    </font> <font color="#0000ff">if</font> (@mysql_ping( <font color="#cc6633">$db</font> ) !== <font color="#0000ff">true</font> ) { <font color="#696969">//      - </font> @mysql_close( <font color="#cc6633">$db</font> ); <font color="#cc6633">$db</font> = mysql_connect(); } mysql_query( <font color="#008000">'   $in_str  '</font> ); <font color="#696969">//    </font> <font color="#0000ff">echo</font> <font color="#008000">'1'</font> ; <font color="#696969">//  ,     </font> } mysql_close( <font color="#cc6633">$db</font> ); fclose( <font color="#cc6633">$in</font> ); <font color="#cc6633">?&gt;</font></font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/1234/s"></a> <a href="http://s-c.me/1234/h"></a> <a href="http://www.php.net/manual/en/function.fopen.php"></a> <a href="http://www.php.net/manual/en/function.fgets.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.mysql-connect.php"></a> <a href="http://www.php.net/manual/en/function.mysql-query.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.fclose.php"></a> Copy Source | Copy HTML <font color="#696969">#!/usr/bin/php</font> <font color="#cc6633">&lt;?php</font> <font color="#cc6633">$in</font> = fopen( <font color="#008000">'php://stdin'</font> , <font color="#008000">'r'</font> ); <font color="#696969">//  </font> <font color="#cc6633">$db</font> = NULL; <font color="#0000ff">while</font> ( <font color="#cc6633">$in_str</font> = fgets( <font color="#cc6633">$in</font> )) { <font color="#696969">//    </font> <font color="#0000ff">if</font> (@mysql_ping( <font color="#cc6633">$db</font> ) !== <font color="#0000ff">true</font> ) { <font color="#696969">//      - </font> @mysql_close( <font color="#cc6633">$db</font> ); <font color="#cc6633">$db</font> = mysql_connect(); } mysql_query( <font color="#008000">'   $in_str  '</font> ); <font color="#696969">//    </font> <font color="#0000ff">echo</font> <font color="#008000">'1'</font> ; <font color="#696969">//  ,     </font> } mysql_close( <font color="#cc6633">$db</font> ); fclose( <font color="#cc6633">$in</font> ); <font color="#cc6633">?&gt;</font></font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/1234/s"></a> <a href="http://s-c.me/1234/h"></a> <a href="http://www.php.net/manual/en/function.fopen.php"></a> <a href="http://www.php.net/manual/en/function.fgets.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.mysql-connect.php"></a> <a href="http://www.php.net/manual/en/function.mysql-query.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.fclose.php"></a> Copy Source | Copy HTML <font color="#696969">#!/usr/bin/php</font> <font color="#cc6633">&lt;?php</font> <font color="#cc6633">$in</font> = fopen( <font color="#008000">'php://stdin'</font> , <font color="#008000">'r'</font> ); <font color="#696969">//  </font> <font color="#cc6633">$db</font> = NULL; <font color="#0000ff">while</font> ( <font color="#cc6633">$in_str</font> = fgets( <font color="#cc6633">$in</font> )) { <font color="#696969">//    </font> <font color="#0000ff">if</font> (@mysql_ping( <font color="#cc6633">$db</font> ) !== <font color="#0000ff">true</font> ) { <font color="#696969">//      - </font> @mysql_close( <font color="#cc6633">$db</font> ); <font color="#cc6633">$db</font> = mysql_connect(); } mysql_query( <font color="#008000">'   $in_str  '</font> ); <font color="#696969">//    </font> <font color="#0000ff">echo</font> <font color="#008000">'1'</font> ; <font color="#696969">//  ,     </font> } mysql_close( <font color="#cc6633">$db</font> ); fclose( <font color="#cc6633">$in</font> ); <font color="#cc6633">?&gt;</font></font></code> </li> <li> <code><font color="black"><font color="#cc6633"><a href="http://s-c.me/1234/s"></a> <a href="http://s-c.me/1234/h"></a> <a href="http://www.php.net/manual/en/function.fopen.php"></a> <a href="http://www.php.net/manual/en/function.fgets.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.mysql-connect.php"></a> <a href="http://www.php.net/manual/en/function.mysql-query.php"></a> <a href="http://www.php.net/manual/en/function.mysql-close.php"></a> <a href="http://www.php.net/manual/en/function.fclose.php"></a> Copy Source | Copy HTML <font color="#696969">#!/usr/bin/php</font> <font color="#cc6633">&lt;?php</font> <font color="#cc6633">$in</font> = fopen( <font color="#008000">'php://stdin'</font> , <font color="#008000">'r'</font> ); <font color="#696969">//  </font> <font color="#cc6633">$db</font> = NULL; <font color="#0000ff">while</font> ( <font color="#cc6633">$in_str</font> = fgets( <font color="#cc6633">$in</font> )) { <font color="#696969">//    </font> <font color="#0000ff">if</font> (@mysql_ping( <font color="#cc6633">$db</font> ) !== <font color="#0000ff">true</font> ) { <font color="#696969">//      - </font> @mysql_close( <font color="#cc6633">$db</font> ); <font color="#cc6633">$db</font> = mysql_connect(); } mysql_query( <font color="#008000">'   $in_str  '</font> ); <font color="#696969">//    </font> <font color="#0000ff">echo</font> <font color="#008000">'1'</font> ; <font color="#696969">//  ,     </font> } mysql_close( <font color="#cc6633">$db</font> ); fclose( <font color="#cc6633">$in</font> ); ?&gt;</font></font></code> </li> </ol></blockquote><br>  The aggregator is implemented somewhat more complicated.  First I will describe a few of the standard PHP features that were used. <br>  When reading from threads, non-blocking calls were used.  To translate the stream into non-blocking mode, it is enough to call the function stream_set_blocking with the stream itself as the first element and with zero as the second element.  After that, any reading or writing to the stream will be completed immediately, without waiting for the actual reading or writing.  The result of these operations will depend on the actual number of bytes that could be written or read. <br>  The presence of data in streams was monitored using the stream_select function, a full description of which can be found in the PHP manual.  Briefly, its essence is as follows: three arrays are passed to it, each of which contains stream descriptors, the first for reading, the second for writing, the third for special cases.  The call to this function ends when something interesting happens in one of the transferred threads (in general, the blocking of the operation of the corresponding function parameter disappears, that is, you can read data without blocking in one of the read handles, etc.).  Also, this function can be completed by timeout, which is transmitted in the form of the fourth and fifth parameters, where the fourth is seconds and the fifth is microseconds. <br>  Now about the algorithm of work: <br><ol><li>  First of all, the aggregator creates child processes of handlers and organizes channels for communication with them. </li><li>  Then the handler in non-blocking mode reads data from the standard input and writes it to the end of the queue. </li><li>  Checking the presence of a unit on the reading channels from the handlers (again, in non-blocking mode), the necessary flags are coded in the readiness array of the handlers. </li><li>  If there is raw data in the queue and there is a free handler, send the data to it and drop its readiness flag in the corresponding array. </li><li>  We write all the descriptors of interest to the array and wait on them using stream_select with a timeout of one second. </li><li>  We check the queue for records and standard input at the end of the data.  If the queue is not empty or there is new data - go to step 2. </li></ol>  Here is the source code of the aggregator: <br><br><h5>  aggregator.php: </h5><blockquote> <code><a href="http://s-c.me/1236/s"></a> <a href="http://s-c.me/1236/h"></a> <a href="http://www.php.net/manual/en/function.define.php"></a> <a href="http://www.php.net/manual/en/function.define.php"></a> <a href="http://www.php.net/manual/en/function.fopen.php"></a> <a href="http://www.php.net/manual/en/function.count.php"></a> <a href="http://www.php.net/manual/en/function.fgets.php"></a> <a href="http://www.php.net/manual/en/function.fgets.php"></a> <a href="http://www.php.net/manual/en/function.count.php"></a> <a href="http://www.php.net/manual/en/function.array-shift.php"></a> <a href="http://www.php.net/manual/en/function.fwrite.php"></a> <a href="http://www.php.net/manual/en/function.feof.php"></a> <a href="http://www.php.net/manual/en/function.count.php"></a> <a href="http://www.php.net/manual/en/function.fclose.php"></a> <a href="http://www.php.net/manual/en/function.fclose.php"></a> <a href="http://www.php.net/manual/en/function.fclose.php"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#696969">#! / usr / bin / php</font> </li><li>  <font color="#cc6633">&lt;? php</font> </li><li>  <font color="#696969">// number of handlers</font> </li><li>  define ( <font color="#008000">'PROCESSORS_TO_SPAWN'</font> , <font color="#008000">5</font> ); </li><li>  <font color="#696969">// full path to the handler</font> </li><li>  define ( <font color="#008000">'PROCESSOR_PATH'</font> , <font color="#008000">'/path/to/processor.php'</font> ); </li><li></li><li>  <font color="#cc6633">$ in</font> = fopen ( <font color="#008000">"php: // stdin"</font> , <font color="#008000">'r'</font> ); </li><li>  <font color="#696969">// transfer the standard input to non-blocking mode</font> </li><li>  stream_set_blocking ( <font color="#cc6633">$ in</font> , 0); </li><li></li><li>  <font color="#696969">// list of handler readiness flags</font> </li><li>  <font color="#cc6633">$ processors_states</font> = array_fill (0, PROCESSORS_TO_SPAWN, <font color="#0000ff">true</font> ); </li><li>  <font color="#cc6633">$ processors</font> = <font color="#0000ff">array</font> (); </li><li>  <font color="#cc6633">$ proc_signal_pipes</font> = <font color="#0000ff">array</font> (); </li><li>  <font color="#cc6633">$ proc_data_pipes</font> = <font color="#0000ff">array</font> (); </li><li>  <font color="#cc6633">$ descriptorspec</font> = <font color="#0000ff">array</font> ( </li><li>  <font color="#008000">0</font> =&gt; <font color="#0000ff">array</font> ( <font color="#008000">"pipe"</font> , <font color="#008000">"r"</font> ), </li><li>  <font color="#008000">1</font> =&gt; <font color="#0000ff">array</font> ( <font color="#008000">"pipe"</font> , <font color="#008000">"w"</font> ), </li><li>  <font color="#008000">2</font> =&gt; <font color="#0000ff">array</font> ( <font color="#008000">"file"</font> , <font color="#008000">"/ dev / null"</font> , <font color="#008000">"a"</font> ) </li><li>  ); </li><li>  <font color="#cc6633">$ buffer</font> = <font color="#0000ff">array</font> (); </li><li></li><li>  <font color="#696969">// run the handlers and translate the reading channel into non-blocking mode</font> </li><li>  <font color="#0000ff">while</font> (count ( <font color="#cc6633">$ processors</font> ) &lt;PROCESSORS_TO_SPAWN) { </li><li>  <font color="#cc6633">$ processors</font> [] = proc_open (PROCESSOR_PATH, <font color="#cc6633">$ descriptorspec</font> , <font color="#cc6633">$ pipes</font> , NULL, NULL); </li><li>  stream_set_blocking ( <font color="#cc6633">$ pipes</font> [ <font color="#008000">1</font> ], <font color="#008000">0</font> ); </li><li>  <font color="#cc6633">$ proc_data_pipes</font> [] = <font color="#cc6633">$ pipes</font> [0]; </li><li>  <font color="#cc6633">$ proc_signal_pipes</font> [] = <font color="#cc6633">$ pipes</font> [ <font color="#008000">1</font> ]; </li><li>  } </li><li></li><li>  <font color="#0000ff">while</font> ( <font color="#0000ff">true</font> ) { </li><li>  <font color="#cc6633">$ in_str</font> = fgets ( <font color="#cc6633">$ in</font> ); </li><li>  <font color="#0000ff">if</font> ( <font color="#cc6633">$ in_str</font> ! == <font color="#0000ff">false</font> ) { </li><li>  <font color="#696969">// here you can check the validity of the log line</font> </li><li>  <font color="#0000ff">if</font> ( <font color="#0000ff">true</font> ) { </li><li>  <font color="#cc6633">$ buffer</font> [] = <font color="#cc6633">$ in_str</font> ; </li><li>  } </li><li>  } </li><li>  <font color="#0000ff">foreach</font> ( <font color="#cc6633">$ processors_states</font> <font color="#0000ff">as</font> <font color="#cc6633">$ proc_num</font> =&gt; <font color="#cc6633">$ processor_state</font> ) { </li><li>  <font color="#696969">// in non-blocking mode, check the handler readiness</font> </li><li>  <font color="#0000ff">if</font> (fgets ( <font color="#cc6633">$ proc_signal_pipes</font> [ <font color="#cc6633">$ proc_num</font> ]) == <font color="#008000">'1'</font> ) { </li><li>  <font color="#cc6633">$ processors_states</font> [ <font color="#cc6633">$ proc_num</font> ] = <font color="#0000ff">true</font> ; </li><li>  } </li><li>  } </li><li>  <font color="#696969">// while there are free handlers and the queue is not empty - we feed them data</font> </li><li>  <font color="#0000ff">while</font> (count ( <font color="#cc6633">$ buffer</font> )&gt; <font color="#008000">0</font> <font color="#0000ff">and</font> </li><li>  ( <font color="#cc6633">$ selected_proc</font> = array_search ( <font color="#0000ff">true</font> , <font color="#cc6633">$ processors_states</font> ))! == <font color="#0000ff">false</font> ) { </li><li>  <font color="#cc6633">$ item</font> = array_shift ( <font color="#cc6633">$ buffer</font> ); </li><li>  fwrite ( <font color="#cc6633">$ proc_data_pipes</font> [ <font color="#cc6633">$ selected_proc</font> ], <font color="#cc6633">$ item</font> ); </li><li>  <font color="#cc6633">$ processors_states</font> [ <font color="#cc6633">$ selected_proc</font> ] = <font color="#0000ff">false</font> ; </li><li>  } </li><li>  <font color="#696969">// if the standard input is closed and the queue is empty - finish the work</font> </li><li>  <font color="#0000ff">if</font> (feof ( <font color="#cc6633">$ in</font> ) <font color="#0000ff">and</font> count ( <font color="#cc6633">$ buffer</font> ) == <font color="#008000">0</font> ) { </li><li>  <font color="#0000ff">break</font> ; </li><li>  } </li><li>  <font color="#cc6633">$ check_list</font> = <font color="#cc6633">$ proc_signal_pipes</font> ; </li><li>  <font color="#cc6633">$ check_list</font> [] = <font color="#cc6633">$ in</font> ; </li><li>  <font color="#696969">// wait for data to be read on the standard input or from one of the handlers</font> </li><li>  stream_select ( <font color="#cc6633">$ check_list</font> , <font color="#cc6633">$ w</font> = NULL, <font color="#cc6633">$ e</font> = NULL, <font color="#008000">1</font> ); </li><li>  } </li><li></li><li>  <font color="#696969">// close handlers and tidy up</font> </li><li>  <font color="#0000ff">foreach</font> ( <font color="#cc6633">$ processors</font> <font color="#0000ff">as</font> <font color="#cc6633">$ proc_num</font> =&gt; <font color="#cc6633">$ proc</font> ) { </li><li>  fclose ( <font color="#cc6633">$ proc_data_pipes</font> [ <font color="#cc6633">$ proc_num</font> ]); </li><li>  fclose ( <font color="#cc6633">$ proc_signal_pipes</font> [ <font color="#cc6633">$ proc_num</font> ]); </li><li>  proc_close ( <font color="#cc6633">$ proc</font> ); </li><li>  } </li><li>  fclose ( <font color="#cc6633">$ in</font> ); </li><li></li><li>  <font color="#cc6633">?&gt;</font> </li></ol></blockquote><br><br><h4>  Afterword </h4><br>  As a result, we received an excellent tool for organizing arbitrarily complex logging for single-threaded servers, which gives us the opportunity to use all the advantages of the server without lingering on saving log records. </div><p>Source: <a href="https://habr.com/ru/post/54140/">https://habr.com/ru/post/54140/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../54134/index.html">Control robots via the Internet</a></li>
<li><a href="../54135/index.html">Gota - office dishwasher concept</a></li>
<li><a href="../54136/index.html">Another social sphere? Yes! Niche for students and studies: Scribbler.ru</a></li>
<li><a href="../54137/index.html">raid of 24 ssd with fantastic speed</a></li>
<li><a href="../54139/index.html">Internet on my EEE PC via Bluetooth-GPRS</a></li>
<li><a href="../54143/index.html">Burning Disks to Unprivileged Users in Windows XP</a></li>
<li><a href="../54146/index.html">Will legal music be sold in runet?</a></li>
<li><a href="../54147/index.html">Deluxe Studio and iTrack created a flash-portal on Zend Framework</a></li>
<li><a href="../54148/index.html">Rambler has updated the mobile version of the portal</a></li>
<li><a href="../54150/index.html">Kay Generator for Gift Cards iTunes Store</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>