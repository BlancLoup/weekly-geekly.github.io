<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Binding session to server in nginx. Nginx-sticky-module</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sticky session is a load balancing method in which client requests are sent to the same server in a group. 

 The easiest way to assign user sessions ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Binding session to server in nginx. Nginx-sticky-module</h1><div class="post__text post__text-html js-mediator-article">  Sticky session is a load balancing method in which client requests are sent to the same server in a group. <br><br>  The easiest way to assign user sessions to a specific server in Nginx is to use the <a href="http_upstream_module.html">ip-hash</a> method: <a name="habracut"></a><br><br><pre><code class="hljs pgsql">upstream backend { ip_hash; <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> backend1.example.com; <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> backend2.example.com; }</code> </pre> <br>  When using this method, requests are distributed across servers based on client IP addresses.  The first three octets of the client's IPv4 address or the entire client's IPv6 address are used as the key for hashing.  The method guarantees that requests of the same client will always be transmitted to the same server.  If this server is considered unavailable, then the requests of this client will be transferred to another server <a href="http_upstream_module.html">(s)</a> .  Its disadvantages from the balancing method include: session support problems when a client uses a dynamic IP;  not equilibrium balancing, if a large number of requests, for example, passes through one proxy server.  Using cookies solves these problems. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In Nginx, there is a <a href="http_upstream_module.html">sticky</a> method that uses a cookie for balancing, though only in the commercial version.  There is a more free way - using external modules. <br><br><h5>  Nginx-sticky-module </h5><br>  <a href="https://code.google.com/p/nginx-sticky-module/">The module</a> creates a cookie - which makes each browser unique - and then uses it to redirect requests to the same server.  If there is no cookie, for example, on the first request, the server is randomly selected.  The project has been forked, the original version is no longer supported, the supported branch is called nginx-sticky-module-ng and is located <a href="https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng/overview">here</a> .  Both links are given because  at google request ‚Äústicky session nginx‚Äù first in the list, after links to the official nginx website, it turns out that the link is exactly to the original project website.  And if you, like me, didn‚Äôt pay attention to the barely noticeable subtitle written in capital letters and bold: <b>DEPRECATED</b> and below the link to the supported version - before installing the module you will need to make some changes to the source code.  The fact is that <a href="https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng/issue/1/nginx-158-api-change-for-ngx_sock_ntop">since the version of nginx 1.5.8, the ngx_sock_ntop () nginx method of the nginx method has been changed</a> , so the nginx-sticky-module file has the ngx_http_sticky_misc.c archive <br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">digest</span></span>-&gt;len = ngx_sock_ntop(<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>, digest-&gt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">, len, 1);</span></span></code> </pre> <br>  worth replacing with <br><pre> <code class="hljs rust">digest-&gt;len = ngx_sock_ntop(<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sockaddr_in</span></span></span></span>), digest-&gt;data, len, <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br>  To install this module, you need to compile Nginx with this module.  <a href="http://blog.ianspence.com/2014/03/30/build-nginx-from-source-on-redhatcentos/">To do this</a> , if not, install the C / C ++ compiler and the libraries used by nginx (for RedHat / CentOS): <br><pre> <code class="bash hljs">yum install gcc gcc-c++ pcre pcre-devel openssl openssl-devel zlib zlib-devel</code> </pre> <br>  Download the latest <a href="http://wiki.nginx.org/Install">version of Nginx sources</a> , unpack it into an inaccessible place, find the nrx-sticky-module or nginx-sticky-module-ng archive in the unpacked src folder and then decide on the <a href="http://nginx.org/ru/docs/configure.html">nginx options</a> you need to compile <br><pre> <code class="bash hljs">./configure --other-install-options --add-module=/path/to/name-of-folder-with-nginx-sticky-module make &amp;&amp; make install</code> </pre> <br>  init.d script can be found <a href="http://wiki.nginx.org/RedHatNginxInitScript">here</a> , which you need to copy to the file: <br><pre> <code class="bash hljs">vi /etc/init.d/nginx</code> </pre> <br>  and give him run rights <br><pre> <code class="bash hljs">chmod a+x /etc/init.d/nginx</code> </pre> <br>  after which you can use the service commands and configure the automatic launch after a reboot: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># nginx service nginx start #  nginx   chkconfig nginx on</span></span></code> </pre> <br>  Configuring a sticky session is no more difficult than for the ip_hash method: <br><pre> <code class="hljs pgsql">upstream backend { sticky; <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> backend1.example.com; <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> backend2.example.com; }</code> </pre><br>  By default, a cookie will be created with the name route and a lifetime of 1 hour.  The method can take several arguments that can be found on the sites of the modules. <br><br>  For lovers of perversions and do without third-party modules, you can use the sticky session setting presented <a href="http://dgtool.blogspot.ru/2013/02/nginx-as-sticky-balancer-for-ha-using.html">here</a> . <br><br>  PS: additions, comments, comments, suggestions, complaints, parting words are welcome. </div><p>Source: <a href="https://habr.com/ru/post/231523/">https://habr.com/ru/post/231523/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../231505/index.html">Unboxing NetApp FAS8040</a></li>
<li><a href="../231511/index.html">What languages ‚Äã‚Äãshould I translate my product into?</a></li>
<li><a href="../231513/index.html">Creating audio plugin, part 14</a></li>
<li><a href="../231519/index.html">How to respond to freelancing projects</a></li>
<li><a href="../231521/index.html">The Head of the Ministry of Communications and Mass Media proposed Apple and SAP to disclose their source codes to Russian specialists.</a></li>
<li><a href="../231525/index.html">We write on Kotlin for Android</a></li>
<li><a href="../231527/index.html">SERP Yandex and Google: Analyzing competitors, researching industries - advodka.com</a></li>
<li><a href="../231529/index.html">cool-old-term - good old terminal</a></li>
<li><a href="../231531/index.html">The evolution of search engine algorithms</a></li>
<li><a href="../231533/index.html">Cumulus Linux for the network in the data center</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>