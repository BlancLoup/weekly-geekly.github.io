<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FBD game ‚Äú2048‚Äù per hour</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. 

 This post is devoted to a brief analysis of how to write the simplest toy ‚Äú2048‚Äù on FBD. 

 Immediately put the picture with the result: 

 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FBD game ‚Äú2048‚Äù per hour</h1><div class="post__text post__text-html js-mediator-article">  Hello. <br><br>  This post is devoted to a brief analysis of how to write the simplest toy ‚Äú2048‚Äù on FBD. <br><br>  Immediately put the picture with the result: <br><img height="364" src="https://habrastorage.org/files/7cf/8bd/7f5/7cf8bd7f5c214f7a8f7ebb72d791088e.png"><img height="364" src="https://habrastorage.org/files/75e/95a/bf3/75e95abf33cb40348034c7de71f3e8aa.png"><br>  If you are interested in how this is done, welcome under cat. <br><a name="habracut"></a><br><h3>  Initial data </h3><br>  The game "2048".  Rules. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      1. In each round, a tile of face value ‚Äú2‚Äù (with a probability of 90%) or ‚Äú4‚Äù (with a probability of 10%) appears. <br>  2. By pressing the arrow the player can throw off all the tiles of the playing field to one of 4 sides.  If, when dropping two tiles of one denomination, they "fly over" one on another, then they stick together into one, the nominal of which is equal to the sum of the joined tiles.  After each move on the free section of the field, a new tile with a face value of "2" or "4" appears.  If at the touch of a button the location of the tiles or their denomination does not change, then the move is not made. <br>  3. The game ends in defeat, if after the next turn it is impossible to make an action. <br><br>  As we can see, the rules are extremely simple.  We start the implementation of the algorithm. <br><br><h3>  Random number generator </h3><br>  To solve this problem, we make the ‚ÄúRandom‚Äù macro.  Since  There is no pure ‚Äúrandom‚Äù in the controller, we are following the old and proven path: <br>  We make a macro, the outputs of which will form random coordinates of the cell (row and column) as well as a sign that a quadruple should be placed in this cell. <br><img height="113" src="https://habrastorage.org/files/bcd/e03/130/bcde031304ae41a3ab4e59fb95bcd543.png"><br><div class="spoiler">  <b class="spoiler_title">Random number generator</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/1d5/c82/6df/1d5c826dfaa44185ab280d0aea369c6b.png"><br>  Short description. <br>  Algorithms 2, 3 and 4 are used to obtain the value constantly changing according to the ‚Äúsaw‚Äù.  The ‚ÄúNow‚Äù algorithm outputs the current time of the controller.  Next, divide these two quantities by each other.  We take the remainder in the fourth decimal place.  We compare with ‚Äú0.1‚Äù (probability 10%) and form the corresponding sign (a sign that we have chosen the four).  We take the remainder in the sixth decimal place.  Multiply by 16, round down to integers and divide with the remainder by 4. Thus, we get random coordinates of the cell, where the fraction from the division is a row, and the remainder from the division is a column.  The unit is added so that the values ‚Äã‚Äãare displayed ‚Äúbeautifully‚Äù in the range from 1 to 4. This completes our random number generator. </div></div><br><h3>  Macro "Installation" </h3><br>  So, just above, we got random coordinates of the cell, in which we have to put a new value (2 or 4).  We translate this value into sixteen logical features using the ‚ÄúInstall‚Äù macro. <br><img height="342" src="https://habrastorage.org/files/20b/ce0/fdb/20bce0fdb3014b6390d97124e175b4d7.png"><br><div class="spoiler">  <b class="spoiler_title">Installation</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/db0/15e/8ee/db015e8eeb8d45a88ac0ea5ec38488f8.png"><br>  Short description. <br>  The macro itself is extremely simple and is needed only in order not to litter the main task.  There are sixteen algorithms "And" on which three signs are collected according to the logical "And": the sign "work", signaling that it is possible to give a signal to set the cell, and two signs of the coordinates "row" and "column".  As soon as all three signs on one of the ‚ÄúAnd‚Äù algorithms have gathered, we give a logical unit to the corresponding output, using which we make an attempt to set a new value to an empty cell. </div></div><br><h3>  Macro "Cell" </h3><br>  As the name implies, this is the main macro that will display the state of the cell.  There are 16 such macros in total.  But this is the whole point, that they are all absolutely identical (this was achieved with the help of the removal of value setting algorithms and also separate processing of commands from the user).  Thus, the program is quickly and easily remade.  when the logic changes, it is enough to change only one macro algorithm, and everything else will change automatically. <br><img height="189" src="https://habrastorage.org/files/2aa/51a/9fb/2aa51a9fbc3340f886a758eabfaf1c6a.png"><br><div class="spoiler">  <b class="spoiler_title">Cell</b> <div class="spoiler_text">  Short description. <br>  The macro has six inputs and two outputs: <br><br>  Inputs: <br><ul><li>  Established - as we said earlier, this is the input for the logical indication that a new value should be set in this cell. </li><li>  The four is a logical sign that a four, not two, must be written in this cell. </li><li>  Clear - resets all values ‚Äã‚Äãin the program to start a new game. </li><li>  Go is a sign that the processing of all values ‚Äã‚Äãafter the command is completed and the cell can be rewritten. </li><li>  Input is the value after processing the next command to be written to the cell. </li><li>  Start is a logical sign that the game has just begun, all cells are empty and the first value can be written to any of them. </li></ul><br>  Outputs: <br><ul><li>  The value is the current value of the cell. </li><li>  Done - a sign that the cell has been processed. </li></ul><br>  Macro Stuffing: <br><img src="https://habrastorage.org/files/499/b26/b71/499b26b7198d486f9e5cf0aecf27756f.png"><br>  The basis of the macro is the algorithm "Memory", which stores the current value of the cell.  The value written to this algorithm is selected by means of four sequential ‚ÄúSelect‚Äù algorithms.  With the first ‚ÄúChoice‚Äù algorithm we check which value should be written into the cell - ‚Äútwo‚Äù or ‚Äúfour‚Äù.  The second ‚ÄúSelection‚Äù algorithm checks whether it is an empty cell.  If the cell is empty, then we write there the selected deuce or four.  The third ‚ÄúChoice‚Äù algorithm checks the start of this game or not.  If this is the beginning of the game, then the value chosen earlier is written without any checks.  The fourth algorithm "Choice" is the highest priority.  We check if the sign ‚ÄúClear‚Äù has come, and if it does, then we force the recording to zero by clearing the cell.  The algorithm "Comparison" forms a sign of whether this cell is empty or not.  Then, using two algorithms "AND" and "OR", we check that if we received the command to install a new random value in the cell and this cell is empty, or it is generally the beginning of the game, then we set a sign that the cell has been processed and the move is completed. <br></div></div><br><h3>  Macro "Processing" </h3><br>  This macro is the basis of all the logic implemented in the game. <br><img height="189" src="https://habrastorage.org/files/5a9/d00/16d/5a9d0016d239483b812f63b54b424567.png"><br>  The macro has two inputs and three outputs.  The ‚ÄúCommand‚Äù input is a logical indication that the macro needs to process 4 input elements and output the output values.  The macro is universal and is used to process all four commands.  It is made under the ‚Äúright‚Äù command, but in order to process the ‚Äúleft‚Äù command, it is enough to input the elements of the string in the reverse order and in the same reverse order pick them up from the output.  To process the commands "up" and "down", the corresponding values ‚Äã‚Äãfrom different rows are formed at the input, forming a column. <br><div class="spoiler">  <b class="spoiler_title">General view and principle of operation</b> <div class="spoiler_text"> General view of the contents of the macro: <br><img src="https://habrastorage.org/files/a46/578/d65/a46578d656d8463fbec5e1f4c3dc26b2.png"><br>  Principle of operation: <br>  At the input are 4 elements and the command to start processing (the command works on the shift of elements from the first to the fourth, that is, the command to the right). <br>  On the leading edge of the command, elements are stored in memory.  Next, it is verified that the row of 4 elements does not contain empty cells in the direction of shift.  If this check is not performed, then a cyclic shift of all elements, before which an empty cell is found, passes one cell down.  The resulting sequence is checked again for the presence of empty cells in the direction of the shift and the cyclic shift of the elements continues until the check is completed. <br><br>  This is the weakest point of the algorithm.  To process a line, you have to run the program three times (in the limit).  Due to the fact that the check can be performed during the first pass of the program, and maybe only at the third, and all 16 cells must work at the same time, it is necessary to install a large number of memory elements and triggers in the program.  But for the time being, I have not thought of a simple and beautiful way to implement sorting in one pass.  But it's not over yet.  When there is time, I will work on it more closely and perhaps the whole program will be simplified every two times. <br><br>  When the check is finally done, and all the elements are arranged in order without gaps, an impulse is formed, which starts a pairwise comparison of the elements, starting from the bottom.  Compare the fourth and third elements.  If they are equal, then in the fourth cell we write their sum, and all other elements are shifted down one cell.  Next, we compare the second and the first elements between us and proceed in a similar way.  If the fourth and third elements are not compared with each other, then we compare the third and second elements, and so on.  Here the algorithm is simple due to the fact that we have already sorted out all non-zero cells and know for sure that between the filled cells we do not have empty cells.  This sorting is done in one pass.  At the end, the resulting element values ‚Äã‚Äãare written to the output and the ‚ÄúReady‚Äù output signal is generated. <br><br>  At the same time, we need to check that when submitting a command at least one set of elements has changed.  Otherwise, this command is not a move and there is nothing to do when submitting it.  For this test, there are elements at the bottom of the macro, which at the source sequence check that at least one permutation is needed and at least one pair of cells ‚Äúcollapsed‚Äù.  In this case, the output signal "worked". <br></div></div><br><h3>  Common words </h3><br>  That's all.  The main elements of the program are ready.  It remains only to link them together.  A few words about the remaining auxiliary elements. <br><div class="spoiler">  <b class="spoiler_title">Control block</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/baa/d76/a6e/baad76a6ef2d4072b6f62472aecbabb0.png"><br>  These are the main controls of the game. <br>  Manual selector, an algorithm that generates outputs according to the ‚Äúone of n‚Äù scheme, serves for giving all 6 commands.  1 - ‚Äúmove up‚Äù command, 2 - ‚Äúto the right‚Äù, 3 - ‚Äúdown‚Äù, 4 - ‚Äúto the left‚Äù, 5 - ‚Äústart of a new game‚Äù, 6 - ‚Äúreset‚Äù. <br>  The block serves to block the user's commands (as I said earlier, it was not possible to do the processing of the command in one cycle, which means that while the command is being processed it is necessary to block the supply of new commands).  Experience has shown that the maximum processing time of a command with a cycle time of 5 ms was about 150 ms.  And although all processing is carried out in a maximum of 5 cycles (there are two more cycles added ‚Äúin reserve‚Äù at the expense of feedback), which is only 25 ms, the rest of the time is spent on setting a new value in the cell.  Indeed, as the field is filled, the chance to get into an empty cell decreases.  In the limit, the waiting time can be infinite.  Mat.  80 ms wait.  A recorded maximum of 150 ms.  It is possible to correct a random value ejection algorithm in order to reduce the time spent on the full processing of a move.  Since  we have only 16 cells, then we can make 16 elements with memorized values ‚Äã‚Äãfrom 1 to 16. Next, read the values ‚Äã‚Äãfrom the cells of the playing field and the nonzero cells move back, and all the zero with the numbers of their elements leave at the beginning of the row.  Count the number of zero cells and throw out a random number in this range.  But this adds a bunch of algorithms, but I really didn‚Äôt like to complicate the already complicated program. <br></div></div><br><h3>  Final program: </h3><br>  We reviewed all the elements of the program.  Now it‚Äôs enough to combine them and everything will work. <br><div class="spoiler">  <b class="spoiler_title">Big picture with the final program.</b> <div class="spoiler_text">  General view of the program.  Link to another hosting because the picture is very big. <br> <a href="http://radikal.ru/fp/8cb37e7131d9417b9bb9559d12fa765e"><img src="https://habrastorage.org/getpro/habr/post_images/04b/47e/4e6/04b47e4e649ec038b7f0732a82c8f527.jpg"></a> <br>  The picture clearly shows the division of the program into 4 main blocks. <br>  The top left is the control unit.  There is a selector that forms commands, a random number generator, locks, etc. <br>  The bottom left is a block of cells.  There are 16 cells, the value of which is displayed in the graphic part. <br>  The top right is the command processing block.  Consists of 4 parts  Each command ("right", "left", "up" and "down") is processed separately because  our macro is universal. <br>  The bottom right is ancillary elements for transforming the order of elements and forming a sign that the game is over (provided that all the fields are occupied and there are no two adjacent cells with the same value). <br></div></div><br><h3>  We attach the graphic part </h3><br>  Well, everything is simple and done in 5 minutes. <br>  We draw one small square.  We give it a value equal to the value of the corresponding cell.  Change the background color depending on the value of the cell.  Next, copy the square fifteen times and get the finished field.  We make several signatures, add the ‚Äústart‚Äù and ‚ÄúReset‚Äù buttons and a large inscription over the ‚ÄúGame over‚Äù field. <br><br>  View of the window in the "drawing" mode. <br><img height="364" src="https://habrastorage.org/files/7a5/4f1/5a0/7a54f15a02954935bf977bfbb2202b8b.png"><br>  That's all ready.  Run and play. <br><br><h3>  UPD.1 </h3><br>  While drinking coffee for lunch, I thought: ‚Äúwhat the fuck?‚Äù And decided to redo the processing macro.  Remember, I said that the processing of the line takes place in several cycles and this is the weakest point of the whole program.  I decided to get rid of this and put all the checks in one sequence.  On the one hand, we get extra checks if even at the start we have the condition fulfilled.  But on the other hand, this solution (albeit cumbersome and ugly looking) allows us to get rid of pornography with a bunch of triggers, a bunch of memory cells and the need to synchronize the whole thing.  Next, under the cut a new macro processing and the general view of the program.  You can pay attention to how the macro processing has been simplified (there is not a single feedback) and the mounted crutches from the elements for synchronizing the features that appear in different program execution cycles have become redundant. <br><div class="spoiler">  <b class="spoiler_title">New Macro Processing</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/018/bb0/893/018bb08938944e929988d2cfead07e15.png"><br>  The upper half is sorting the row "in the forehead."  All options are simply checked in succession and appropriate permutations are made when the conditions are met.  The lower half remained unchanged.  Please note that, compared with the previous version, all memory elements and feedbacks have been removed.  The ‚ÄúMemory 54 - 57‚Äù blocks at the end are actually not needed for the program, since  processing takes place in one cycle.  Left them solely for the convenience of displaying the values ‚Äã‚Äãat the output of the macro.  Since  the cycle time is 5 ms, then without these blocks the real values ‚Äã‚Äãat the macro output will only skip by 1 cycle (5 ms, it is almost impossible to notice), and the rest of the time at the outputs will hang "-1". <br></div></div><br><div class="spoiler">  <b class="spoiler_title">New General view of the program</b> <div class="spoiler_text">  Link to another hosting because the picture is very large. <br> <a href="http://radikal.ru/fp/8ef8169e072046109612361a747079ef"><img src="https://habrastorage.org/getpro/habr/post_images/47c/a48/b3a/47ca48b3a005f582cdba0e5eb50490a3.jpg"></a> <br>  Here you need to pay attention to the harness (or rather its absence) of the Processing macro.  If you look at the previous version of the program, you can see that the output is triggered for each ready signal, the trigger for the general trigger signal, the selection of fronts and resetting these triggers by feedback.  Now all this horror becomes unnecessary, and the general view of the program we have turned out clean and not littered with all sorts of crutches.  All other elements of the program remained unchanged. <br></div></div><br><br><h3>  Summarizing </h3><br>  Once again, we have made a toy, though useless, but very interesting from the point of view of algorithm implementation.  Moreover, I deliberately did not rewrite the post and replace the old macros with new ones in order to show how quickly you can redo the program without affecting the rest.  As for the simplicity of writing programs in the FBD language, I think the most eloquent here is the fact that I spent 2-3 times more time writing this post than writing a program. <br><br>  What remains unrealized. <br>  1. Scoring.  I'm not special in this game.  Moreover, I played it only at the time of writing this post in my program, and then it was not possible to reach a record of 256.  So, making points is easy.  Simply in the ‚ÄúProcessing‚Äù macro, when summing up the values ‚Äã‚Äãof cells with the same denomination, it is necessary to additionally issue this amount to the macro output, and outside calculate the total amount of these values.  But I do not see any point in this, because  the goal of the game is ‚Äúto get the tile with the maximum nominal value‚Äù. <br>  2. "Smart" algorithm for selecting a random value, to install a two or four in an empty cell.  I wrote a little higher on how this can be done.  But since  there is nothing interesting there, then we leave it to everyone. <br><br>  That's all.  I hope it was interesting. </div><p>Source: <a href="https://habr.com/ru/post/277203/">https://habr.com/ru/post/277203/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../277191/index.html">Ballad about SharePoint</a></li>
<li><a href="../277193/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ198 (February 7 - 14, 2016)</a></li>
<li><a href="../277195/index.html">Excellent data types in the language "Author"</a></li>
<li><a href="../277197/index.html">PHP Digest number 79 - interesting news, materials and tools (February 1 - 14, 2016)</a></li>
<li><a href="../277201/index.html">Yii 2.0.7</a></li>
<li><a href="../277209/index.html">Installing and configuring Yii2 on a shared hosting</a></li>
<li><a href="../277221/index.html">Nominal rows for JavaScript and GOST-28884-90</a></li>
<li><a href="../277229/index.html">Professional programming for artificial intelligence systems in PROLOG</a></li>
<li><a href="../277231/index.html">Training courses. Training</a></li>
<li><a href="../277233/index.html">How graph databases help fight e-commerce fraud</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>