<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Wateri: Transferring readings of water to the phone via Wi-Fi (4 years from batteries)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once I got tired of taking readings of water meters. It was possible to settle a magnet near the meter and calm down on this, but I found this way uns...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Wateri: Transferring readings of water to the phone via Wi-Fi (4 years from batteries)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/cu/cm/id/cucmidscnzwyjeto65obezfzjgw.jpeg"><br><br>  Once I got tired of taking readings of water meters.  It was possible to settle a magnet near the meter and calm down on this, but I found this way unsporting. <br><br>  My path was not easy and ornate.  But the result was a device that transmits readings of water via Wi-Fi to the phone.  Simple and clear to use and configure at least a student, even though the <s>humanities</s> retired.  And familiar with the word "Arduino" is also easy to make.  The device is able to work on batteries for four years (longer than the relationship with your ex).  It is also the first open source project with such characteristics.  <a href="https://github.com/dontsovcmc/waterius/issues/10">I wrote out</a> factory analogues, there are few of them, and well with them. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, we have a little money and a big, but honest desire to simplify our lives without violating the Criminal Code.  And so that none of your 220V, servers and heaps of buttons!  We look at the readings on the smartphone in the Blynk application or a similar service. <br><br>  Now sit back in a chair, eat more of these soft French buns and drink some tea.  See beautiful photos and listen to my story about what to consider when creating stand-alone devices.  But first, a brief description of Waterius. <br><a name="habracut"></a><br><h3>  Requirements </h3><br><ul><li>  meter with wire (output "dry contact") </li><li>  Wi-Fi router with internet </li></ul><br><h3>  Specifications </h3><br><ul><li>  Power supply: 3 AA batteries </li><li>  work time 4 years or longer </li><li>  2 water meters </li><li>  one single button to configure </li><li>  non-volatile memory for readings and network settings </li></ul><br><h3>  Daily Wi-Fi Transfer </h3><br><ul><li>  current readings </li><li>  water consumption per day </li><li>  supply voltage </li><li>  email  Letters (body and title can be changed) </li></ul><br>  Implemented TCP server support and Blynk applications.  Add HTTP, MQTT, Modbus TCP, Cayenne clouds, IFTTT, etc.  (here is a place for the manifestation of your creative genius). <br><br><h2>  Customization </h2><br>  When you click on the button, Waterius turns on a Wi-Fi access point.  Connect, fill out the form, three times bow to the east and say "thank you" to the developers of <a href="https://github.com/tzapu/WiFiManager">WiFiManager</a> .  You can mentally. <br><br><img width="750" src="https://habrastorage.org/webt/du/9k/jn/du9kjni_1m0qlxthmhvagpl1fvg.jpeg" alt="Setting up Waterius with Wifimanager"><br><br><h2>  Entertaining electronics </h2><br>  A scattering of radio elements for the assembly of Waterius <br><br><img src="https://habrastorage.org/webt/g3/or/q4/g3orq43vvb6jmy2ow3m04n1dldg.jpeg"><br><br>  The only way to achieve units of microamps consumption during pulse counting is to use an economical microcontroller, rather than what you think.  The heart of Waterius is the Attiny85 microcontroller (its analogs are MSP430, STM8L).  Flush without problems with any Arduino board with any hands that grow above the belt.  Attiny85 operates at a frequency of 1 MHz from the internal generator and counts pulses, periodically checking 2 inputs for a short circuit and a button.  Sleep current <a href="">4 ŒºA at 3V</a> .  Fairy tale. <br><br>  I use ESP8266-01 for Wi-Fi.  Consumption during operation 75mA, pulses up to 250mA.  Two microcontrollers communicate via i2c bus.  The correctness of the choice was confirmed by the <a href="https://www.cron.dk/esp8266-on-batteries-for-years-part-5/">project of the meteorological station</a> .  ESP8266 is constantly in a dream: the EN pin is pulled to GND through a resistor.  The current consumption is less than 10 uA (I came across copies with 0 uA).  Once a day, Attiny85 delivers HIGH, ESP8266 wakes up, gets readings from Attiny85, connects to home Wi-Fi and sends data in ~ 4 seconds - which, according to British scientists, is much faster than you usually get manually to these counters. <br><br><img align="right" src="https://habrastorage.org/webt/y6/ov/aa/y6ovaaeka77kd0inlhivxv3cd_k.jpeg">  <i>In the photo a good ESP, consumption jumps 7-11¬µA.</i>  <i>Usually the numbers are 19-23¬µA.</i> <br><br>  Other types of sleep Wateriu will not do, although sprinkle it with melatonin to the sounds of a lullaby: Infinite deepsleep with instant wake up on impulse to External reset consumes 20¬µA and is suitable for frequent data sending.  The most economical option: a complete outage of the ESP8266, but field-effect transistors that are afraid of static electricity, will be needed. <br><br>  The setup button is located on the SCL line.  All Attiny85 pins are busy!  For this reason, Waterius does not support ‚ÄúNamur‚Äù meter outputs and does not have a leakage sensor. <br>  The LED is connected to an ESP TX pin and is on when ESP is running.  Connect the TTL-USB adapter to see the log (interestingly!).  At the beginning of development, I thought that in order to indicate an error, you need to blink an LED, but you will manage - this will only complicate the code. <br>  If you successfully connect to the Wi-Fi router after 3-10 seconds, the LED will go out, and if it continues to light up, connect the phone to Wateri again.  Sophisticated technology, nanotechnology, developments of NASA, the teachings of ancient China. <br><br>  Any one of us knows: a feature of low-power devices is exposure to electromagnetic interference.  Therefore, I turned to a familiar electronics engineer and studied <a href="https://github.com/dontsovcmc/waterius/issues/19">literature</a> (+ the most beautiful course <a href="https://www.murata.com/en-eu/products/emc/emifil/knowhow/basic">Murata</a> ).  All pins at ESP and Attiny are pulled to power or GND.  Installed capacitors for power.  The ‚Äúdirty‚Äù ground of the meters is connected to the ‚Äúclean‚Äù through a 300 ohm resistor, and the outputs themselves through a 3k3 resistor.  Everyone would be like that! <br><br><h3>  Housing </h3><br>  We take a plastic bottle ... a joke.  I used the compartment on 4 AA batteries.  A hole is cut in the cover for the connector, on the side for the LED and the button. <br><br><img src="https://habrastorage.org/webt/yl/dt/e2/yldte2s4juxluytorqdld8eumrs.jpeg"><br><br>  You can use the wiring box (with a 3D printer and other shamanism, experiment yourself, if nnnada). <br><br>  In <a href="https://github.com/dontsovcmc/waterius/tree/master/Board">github</a> is a single-layer board for LUT and a two-layer board for factory production.  Wateri can even make a schoolboy!  True, if he does not have a hoverboard and has never twisted a spinner. <br><br>  The ideal fee does not work right away.  The first prototype looked like this: <br><br><img src="https://habrastorage.org/webt/wd/3c/tw/wd3ctw183ioynjkuqnxhszttjee.jpeg"><br><br>  But the fourth version that has been built is almost ‚Äúperfect‚Äù: <br><br><img src="https://habrastorage.org/webt/t3/uw/m4/t3uwm48xqxlcuef8u1nrgq3clkm.jpeg"><br><br>  I could not resist and ordered a pack of boards in Rezonite.  It's a thrill! <br><br><img src="https://habrastorage.org/webt/ok/hm/-n/okhm-nnvs0vnjlpdqiiezw_tts0.jpeg"><br><br><h3>  Nutrition </h3><br>  In Waterius there is a stabilizer <a href="https://eu.mouser.com/datasheet/2/268/20001826D-737536.pdf">MCP1700</a> on 3B with a very low minimum consumption (several ¬µA).  Three AA 1.5V alkaline batteries <a href="https://github.com/dontsovcmc/waterius/issues/3">can discharge</a> almost completely to 3.2 V. Plus, the Attiny85 will have a stable voltage (and less <a href="">floating frequency</a> , which is good, although in this project it doesn't matter). <br><br>  The circuit will work without a stabilizer from two AA batteries.  Attiny85 should buy version V (powered up to 1.8V).  ESP worked "on the Internet" to 2.5V.  We will be able to use 40% of the capacity of the batteries (if you do not believe it, see <a href="https://habr.com/company/madrobots/blog/364773/">A. Nadezhin‚Äôs</a> testing).  If you buy two AA 1.5V 3 A lithium lithium batteries, Waterius will work up to 10 years and at a low temperature, and there - you see - we will build communism. <br><br>  The lack of tools does not allow me to accurately measure Wateri consumption.  At home, he has been working for 45 days, sending readings every 30 minutes (to speed up the discharge).  The supply voltage dropped by 0.17V from 4.68V to 4.51V (UPD: 100 days 4.38V).  If this goes on, then the batteries will last for 1.5 years.  Sending readings once a day is 3 times more economical, so 4 years of work.  Yes, I know about the self-discharge of batteries.  <a href="http://data.energizer.com/pdfs/alkaline_appman.pdf">Datashit energizer</a> and expiration date on packages say it is not strong. <br><br>  Here is the calculation of battery consumption and the cost of components for the most curious ( <a href="https://docs.google.com/spreadsheets/d/1fBV8hDb4R7eH10uAEd9G-35D6rSsODIu7HmnhNsZueg/edit%3Fusp%3Dsharing">Google Table</a> ). <br><br><h2>  Programmer details (for those who are not tired) </h2><br>  The implementation of counting pulses on interrupts is not suitable, since  water can be blocked at the time of the reed switch closure (zone ~ 3 l), and the current will flow through the pull-up resistors.  Protection against bounce of contacts will be required: a microcircuit or a delay in the code.  I implemented a periodic poll every 250ms and increment (beautiful word, right?) The value only when re-closing.  Nothing needs to be soldered, although if you really want, then you can. <br><br>  To protect against Attiny reload, I save all values ‚Äã‚Äãto its EEPROM memory.  To exceed the 100k record limit, I wrote a <a href="">ring buffer</a> with a ring label of the current cell.  Now I sleep peacefully, which I wish for you.  The code provides for the inclusion of logging for debugging.  Connect the TTL-USB to the connector of the second counter. <br><br><h2>  Data export </h2><br>  At first I wrote a Telegram bot, but Roskomnadzor blocked Telegram.  I had to refuse this decision in order not to launch the proxy server and not to rock the boat.  Using Blynk turned out to be optimal (fearless developers struggle with locks).  Here is the <a href="">project QR code</a> .  In addition to his application for the phone is the project Cayenne. <br><br>  Automatic sending to Mosvodokanal is not implemented, since  project non-profit, but what our years.  Or yours.  I do not have the means to maintain my server and "legitimize" the sending procedure, but you ask around friends, all of a sudden ... I will be glad of your help and free thoughts. <br><br>  Muscovites send readings via SMS, which means that a web server is enough to receive Wateri data and a page from SMS ( <a href="https://github.com/smeeckaert/sms-link">github</a> ).  Moscow Fiddler experts, who use the Moscow State Service application, should be interested in my <a href="https://github.com/dontsovcmc/emp_mos_api">Python script for</a> sending water readings. <br><br><h2>  Development </h2><br>  One of the main brakes in creating a new product is perfectionism, as you understand.  There is no need to make a new function without checking whether it is needed by consumers.  Simple code is easier to develop. <br><br>  The path to perfectionism is through <br><br><ul><li>  Updating ESP and Attiny firmware via the Internet </li><li>  support https or encryption </li><li>  server where the user could upload his script to send readings of water. </li><li>  use of STM8L / MSP430 (they are more economical and more pins) </li><li>  visual check of contact with the meter when connected </li><li>  specify the period of sending email.  letters </li><li>  support outputs "Namur" at the counter </li><li>  leakage sensor </li><li>  crane control </li><li>  electricity meter support </li></ul><br><h2>  Thanks </h2><br>  Thanks to <a href="https://www.linkedin.com/in/ivan-kovalenko-a5b326131/">Ivan Kovalenko</a> and Ivan Ganzha for advice on electrical engineering, Aigul, Lapinu E.N.  for the correct approach to life and dad for the fact that I can not only program, but also solder, and you - for attention! <br><br><img src="https://habrastorage.org/webt/bi/rs/dg/birsdgh0skpa69dhb-q2mltxffs.jpeg"><br><br>  I would welcome any suggestions, pool requests and criticism! <br><br>  We heat up a soldering iron!  <a href="https://github.com/dontsovcmc/waterius">Project on github</a> </div><p>Source: <a href="https://habr.com/ru/post/418573/">https://habr.com/ru/post/418573/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../418561/index.html">State machines in the service of MVP. Yandex lecture</a></li>
<li><a href="../418563/index.html">The digest of interesting materials for the mobile developer # 263 (July 23 - July 29)</a></li>
<li><a href="../418565/index.html">On the way to 100% of code coverage by tests in Go using the example of sql-dumper</a></li>
<li><a href="../418567/index.html">Dell will cease to be a private company and for the first time in 5 years will place shares on the exchange.</a></li>
<li><a href="../418569/index.html">New satellites - new bugs: The GOES-17 satellite's infrared sensor does not cool well</a></li>
<li><a href="../418575/index.html">"Do not take off": 6 unusual audio gadgets</a></li>
<li><a href="../418577/index.html">Manage your bookmarks with tags - to the delight of yourself and colleagues</a></li>
<li><a href="../418579/index.html">How the virtual environment libraries work</a></li>
<li><a href="../418581/index.html">Basics of React (textbook, 2nd edition)</a></li>
<li><a href="../418585/index.html">Building a local map of the robot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>