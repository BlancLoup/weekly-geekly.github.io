<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Manual stream cloning. When Assembler + C # or Java = Love</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I will go straight to the point. Task: at any point in the code by calling specials. method to create a second thread that will start from the point o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Manual stream cloning. When Assembler + C # or Java = Love</h1><div class="post__text post__text-html js-mediator-article">  I will go straight to the point.  Task: at any point in the code by calling specials.  method to create a second thread that will start from the point of calling this method in the parent thread, while retaining the possibility of debugging and the values ‚Äã‚Äãof all local variables at all levels of method calls. <br><br>  The implementation does not depend on the final platform (.Net / Java), because  written in C ++ / Asm, however, custom code is made in C #, since  I write on it. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/af6/22c/3c7/af622c3c729973a6b6d7d81ada9910d5.png" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now that I have finally stabilized the example for 32-bit systems, I have the courage to show it to the public as completely ready.  And yes, I repeat: when adapting it will work on any platform <br><br> <a href="http://habrahabr.ru/company/luxoft/blog/246665/"><img src="https://habrastorage.org/files/7a4/07b/46e/7a407b46e6d14bdf99d72dc4c90d2226.png"></a> <br><div class="spoiler">  <b class="spoiler_title">To begin with, the full list of articles posted on this cycle in Habr√©</b> <div class="spoiler_text"> <a href="http://habrahabr.ru/company/luxoft/blog/247491/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/247491/">We make shipped assemblies: we interact between domains without marshalling</a> <br> <a href="http://habrahabr.ru/company/luxoft/blog/219619/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/219619/">Getting a pointer to a .Net object</a> <br> <a href="http://habrahabr.ru/company/luxoft/blog/238947/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/238947/">Manual stream cloning.</a>  <a href="http://habrahabr.ru/company/luxoft/blog/238947/">When Assembler + C # or Java = Love</a> <br> <a href="http://habrahabr.ru/company/luxoft/blog/239005/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/239005/">Changing the code of system assemblies or "leak". Net Framework 5.0</a> <br> <a href="http://habrahabr.ru/company/luxoft/blog/244095/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/244095/">How does decompilation in .Net or Java using the example .Net</a> <br> <a href="http://habrahabr.ru/company/luxoft/blog/247433/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/247433/">Continuing to shred CLR: .Net object pool outside SOH / LOH heaps</a> <br> <a href="http://habrahabr.ru/company/luxoft/blog/247447/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/247447/">Remove objects dump from .Net application memory</a> <br></div></div><br><a name="habracut"></a><br><h2>  <font color="#0e3d78">Goals</font> </h2><br>  The aim of the work is to build a functional associated with threads, which is not provided by the operating system.  For example, the Fork () method of the Linux operating system, corrected for Windows OS realizations, was taken. <br><br>  So, if we have the Original method, within which the Fork.CloneThread () method is called in some part of it, a second execution thread should occur, the beginning of which will be equal to the call point of the Fork.CloneThread () method and which will be completed at the output of the method Original so that all values ‚Äã‚Äãof the local variables of the source stream are saved in the second execution thread.  In other words, for the CloneThread () call to split the current thread into two. <br><br><h2>  <font color="#0e3d78">What is required from the reader</font> </h2><br><ul><li>  Lack of fear to read assembler.  It's just =) Where something is not clear, use google </li><li>  Understanding that a thread stack is one per thread.  Understanding what it is for </li></ul><br>  Materials for preparation: <br><ul><li>  <a href="https://en.wikipedia.org/wiki/Call_stack">Call Stack (wiki)</a> </li><li>  <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25BE%25D0%25B3%25D0%25BB%25D0%25B0%25D1%2588%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25BE_%25D0%25B2%25D1%258B%25D0%25B7%25D0%25BE%25D0%25B2%25D0%25B5">Calling conventions (wiki)</a> </li></ul><br><br><h2>  <font color="#0e3d78">Stream cloning</font> </h2><br>  What do we have initially?  There is our stream.  It is also possible to create a new thread or schedule a task in the thread pool by executing your code there.  We also understand that information on nested calls is stored in the call stack and that, if desired, we can manipulate it (for example, using C ++ / CLI).  Moreover, if we follow the agreements and enter the value of the EBP register, the return address for the ret ret and allocate space for the local ones (if necessary) to the top of the stack, this can simulate the method call. <br>  What needs to be done to clone the flow? <br><ul><li>  <b>Preservation</b> <br><ul><li>  Inside the CloneThread method (C #) we get the address of any local variable </li><li>  Make a call to the C ++ method, passing it this address.  At this stage, the call stack looks like this: <br><img src="https://habrastorage.org/files/8fd/ce9/93c/8fdce993c33a42efbaeee9784c6ea75e.png"><br>  Well, or in an abbreviated manner, like this: <br><img src="https://habrastorage.org/files/6b4/ac6/1ab/6b4ac61ab35c4ad8b1492a9c31a680b7.png"></li><li>  Inside, we get the value of EBP - a pointer to our call frame and by chain, dereferencing the pointer, go to the CloneThread method, checking the current EBP with the address of a local variable in CloneThread.  This is necessary in order to go through all the proxy calls between C # and C ++, which are generated by JITter. </li><li>  We add 1 to exit the CloneThread frame and get into the code that calls our library function.  Everything from the received address to the ESP is a chain of calls from the user code.  We save it to the buffer, create a stream (or take it from the pool) and pass it the address of this buffer ‚Äî copies of the stack. </li></ul><br></li><li>  <b>Recovery</b> .  In order for the new thread to continue working from the copy point in the parent, it is necessary to imitate the CloneThread () call from the user method that was called in the new thread (which no one actually called).  To do this, we need to add a saved piece of the stack of the parent thread to the top of our call stack, fix the EBP chain that forms the stack of frames, and run the code. <br><ul><li>  Initially, when our code just started working in the second thread, we have this kind of call stacks: <br><img src="https://habrastorage.org/files/566/607/31e/56660731ea914e9289b64ecf9de6efb6.png"></li><li>  We get the address of the ESP. </li><li>  Push to the stack the address of the body of the current method - to return from the user method, which will be simulated </li><li>  We push EBP - to maintain the integrity of the stackframes.  Together with the stack copy on the heap, we have the following form of call stacks: <br><img src="https://habrastorage.org/files/3e2/6cf/42c/3e26cf42c3f843319c369a00a05f3515.png"></li><li>  We fix the saved EBP chains in a copy of the stack (you can't do it in place) before copying <br><img src="https://habrastorage.org/files/983/622/2f3/9836222f300645f4a8c53fd382119002.png"></li><li>  Using the push commands, insert into the current stack a copy of the stack of the parent thread (simulate calling the user-defined method that called CloneThread, which called the many proxies and the C ++ method as a result) <br><img src="https://habrastorage.org/files/b5a/34f/74c/b5a34f74cfe744b5b209a7897597d7ba.png"></li><li>  We do the far JMP in C ++ method CloneThread, in which we ensure the launch of return </li><li>  This leads to an output in CloneThread (C #), which goes into a custom method </li><li>  Voila - in both streams the code is executed from the same point.  Flow branching over. </li></ul><br></li></ul><br><h2>  <font color="#0e3d78">Why do it</font> </h2><br>  The most important thing for what it is done is to consolidate understanding of how everything works and that if you know, you can begin to manipulate it. <br><br><h4>  Resources </h4><br><ul><li>  <a href="https://github.com/mumusan/dotnetex">DotNetEx project GitHub</a> : the project in it is called AdvancedThreadingLibrary, to start using RocketScience / 01-forkingThread.  <b>By the way</b> , in the same library there are examples with sizeof (ReferenceType), IoC with the shipped assembly and a pool of objects in its heap. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/238947/">https://habr.com/ru/post/238947/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../238937/index.html">Future and present telemedicine</a></li>
<li><a href="../238939/index.html">Head to project or wide open in the studio</a></li>
<li><a href="../238941/index.html">The first metap for mobile developers at Microsoft</a></li>
<li><a href="../238943/index.html">How we went to FbStart from Facebook, and what it is eaten with</a></li>
<li><a href="../238945/index.html">Ciklum Odessa Speakers' Corners: 5 Dimensions of developing BIG REAL-WORLD CLOUD products</a></li>
<li><a href="../238949/index.html">The ideal theory. The battle for the general theory of relativity</a></li>
<li><a href="../238951/index.html">IB in American. Part 2. Is it possible to learn more about NIST 800-53 and where does risk management go?</a></li>
<li><a href="../238953/index.html">Nanodegrees after online training are recognized by large IT companies</a></li>
<li><a href="../238955/index.html">IBM has improved nanotube manufacturing for Racetrack Memory</a></li>
<li><a href="../238957/index.html">11 basic principles of effective landing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>