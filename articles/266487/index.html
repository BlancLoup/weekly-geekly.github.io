<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to organize database testing in dUnit</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As is known, in xUnit frameworks, the simplest test-case consists of a sequence of calls to SetUp, TestSomething, TearDown. And quite often in unit te...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to organize database testing in dUnit</h1><div class="post__text post__text-html js-mediator-article">  As is known, in xUnit frameworks, the simplest test-case consists of a sequence of calls to SetUp, TestSomething, TearDown.  And quite often in unit testing it is required to prepare some resources before the main tests.  A typical example of this is a database connection.  And the logic tells us that it would be very expensive, running several tests, before each establish a connection with the database in SetUp, and disconnect in TearDown. <br><br><div class="spoiler">  <b class="spoiler_title">Module example</b> <div class="spoiler_text"><pre><code class="delphi hljs">... <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-title"><span class="hljs-title">TTestDB1</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TTestCase) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetUp</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TearDown</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">published</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestDB1_1</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestDB1_2</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">implementation</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TTestDB1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetUp</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">inherited</span></span>; <span class="hljs-comment"><span class="hljs-comment">// connect to DB end; procedure TTestDB1.TearDown; begin // disconnect from DB inherited; end; ... initialization RegisterTest(TTestDB1.Suite); end.</span></span></code> </pre> <br><img src="https://habrastorage.org/files/fa1/d30/099/fa1d30099658418abaacfd185d3052ce.png"><br></div></div><br>  Call scheme will be as follows: <br><br><pre> <code class="delphi hljs">-- TTestDB1.SetUp ---- TTestDB1.TestDB1_1 -- TTestDB1.TearDown -- TTestDB1.SetUp ---- TTestDB1.TestDB1_2 -- TTestDB1.TearDown</code> </pre><br>  <i>In addition, with a database it may be that, before connecting to a database, it must be created with the required structure.</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To solve this problem in <a href="http://dunit.sourceforge.net/">dUnit</a> is a class TTestSetup (described in the module TTestExtensions). <br><a name="habracut"></a><br>  It essentially implements the same <code>ITest</code> interface as TTestCase, that is, the same scheme: SetUp, Test ..., TearDown, only instead of calling the tests, the entire test-case specified during its creation is called.  Those.  modifying the module: <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> ... TestExtensions; <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-title"><span class="hljs-title">TTestDBSetup</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TTestSetup) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetUp</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TearDown</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-comment"><span class="hljs-comment">// published-  TTestSetup   end; TTestDB1 = ... ... implementation ... initialization RegisterTest(TTestDBSetup.Create(TTestDB1.Suite)); end.</span></span></code> </pre><br>  get the call pattern: <br><pre> <code class="delphi hljs">-- TTestDBSetup.SetUp ---- TTestDB1.SetUp ------ TTestDB1.TestDB1_1 ---- TTestDB1.TearDown ---- TTestDB1.SetUp ------ TTestDB1.TestDB1_2 ---- TTestDB1.TearDown -- TTestDBSetup.TearDown</code> </pre><br><img src="https://habrastorage.org/files/268/fd1/eb6/268fd1eb6a6f4469b8a4df5d25710a42.png"><br><br>  In essence, this is the suite + test-cases scheme.  Thus, establishing a connection to the database in TTestDBSetup.SetUp, we will do this only once before running TestDB1_1 and TestDB1_2. <br><br>  This is understandable when we have only one test-case with tests that requires connecting to the database.  But what to do when we want to create a second test-case, which also needs a connection to the database (let's call it TTestDB2 with the methods TestDB2_1, TestDB2_2, etc.)? <br><br>  The constructor of <code>TTestSetup.Create</code> described as follows: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TTestSetup</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ATest: ITest; AName: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">;</span></span></code> </pre><br>  That is, only one test-case can be "included" in the suite.  If we write this: <br><br><pre> <code class="delphi hljs"> RegisterTest(TTestDBSetup.Create(TTestDB1.Suite)); RegisterTest(TTestDBSetup.Create(TTestDB2.Suite));</code> </pre><br>  Then we get calls by the scheme: <br><pre> <code class="delphi hljs">-- TTestDBSetup.SetUp ---- TTestDB1.SetUp ------ TTestDB1.TestDB1_1 ---- TTestDB1.TearDown ---- TTestDB1.SetUp ------ TTestDB1.TestDB1_2 ---- TTestDB1.TearDown -- TTestDBSetup.TearDown -- TTestDBSetup.SetUp ---- TTestDB2.SetUp ------ TTestDB2.TestDB2_1 ---- TTestDB2.TearDown ---- TTestDB2.SetUp ------ TTestDB2.TestDB2_2 ---- TTestDB2.TearDown -- TTestDBSetup.TearDown</code> </pre><br><img src="https://habrastorage.org/files/b46/bed/d0e/b46bedd0ec0a4bc19b21a42afcd69c8c.png"><br><br>  This is not what we want.  We want to connect to the database only once. <br><br>  Here begins, in fact, what prompted me to write this article.  Let's pay attention to the second variant of the RegisterTest method: <br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegisterTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SuitePath: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">; test: ITest)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> assert(assigned(test)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __TestRegistry = <span class="hljs-keyword"><span class="hljs-keyword">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> CreateRegistry; RegisterTestInSuite(__TestRegistry, SuitePath, test); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br>  What is <code>SuitePath</code> ?  We look <code>RegisterTestInSuite</code> : <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegisterTestInSuite</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rootSuite: ITestSuite; path: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">; test: ITest)</span></span></span><span class="hljs-function">;</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (path = <span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-comment"><span class="hljs-comment">// End any recursion rootSuite.addTest(test); end else begin // Split the path on the dot (.) dotPos := Pos('.', Path); if (dotPos &lt;= 0) then dotPos := Pos('\', Path); if (dotPos &lt;= 0) then dotPos := Pos('/', Path); if (dotPos &gt; 0) then begin suiteName := Copy(path, 1, dotPos - 1); pathRemainder := Copy(path, dotPos + 1, length(path) - dotPos); end else begin suiteName := path; pathRemainder := ''; end; ...</span></span></code> </pre><br></div></div><br>  And we see that the SuitePath is divided into parts, and the separator of these parts is a period, i.e.  this is a certain ‚Äúsuite path‚Äù to which the registered test-case is added. <br><br>  We try to register TestDB2 like this (to add TTestDB2 as a ‚Äúchild node‚Äù to TTestDBSetup): <br><pre> <code class="delphi hljs">RegisterTest(<span class="hljs-string"><span class="hljs-string">'Setup decorator ((d) TTestDB1)'</span></span>, TTestDB2.Suite);</code> </pre><br>  Did not work out: <br><br><img src="https://habrastorage.org/files/604/0e5/282/6040e5282b334545b66bdff0b32f4752.png"><br><br>  We look again at the <code>RegisterTestInSuite</code> code: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegisterTestInSuite</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rootSuite: ITestSuite; path: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">; test: ITest)</span></span></span><span class="hljs-function">;</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ... currentTest.queryInterface(ITestSuite, suite); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Assigned(suite) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ...</code> </pre><br></div></div><br>  We see that the test-case is added to ITestSuite, and TTestSetup does not implement this interface.  How to be? <br><br>  Here we look, for example, into the IndySoap library (it has dUnit tests organized in groups) and <a href="">we see there</a> something like this (we will write down immediately with reference to our tests): <br><br><pre> <code class="delphi hljs">... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DBSuite</span></span></span><span class="hljs-function">:</span></span> ITestSuite; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := TTestSuite.Create(<span class="hljs-string"><span class="hljs-string">'DB tests'</span></span>); Result.AddTest(TTestDB1.Suite); Result.AddTest(TTestDB2.Suite); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">initialization</span></span> RegisterTest(TTestDBSetup.Create(DBSuite));</code> </pre><br>  That is, we create a suite from our test cases, and already add this suite to TTestSetup. <br><br><img src="https://habrastorage.org/files/0c3/810/6eb/0c38106eb69640838cb5d970e8dabf9b.png"><br><br>  And, it seems, everything works, and everything is fine.  On this one could finish. <br><br>  But if (more precisely, ‚Äúwhen‚Äù) we will add more database tests (let's call them TTestDB3), then we will have to add them to DBSuite: <br><br><pre> <code class="delphi hljs">... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DBSuite</span></span></span><span class="hljs-function">:</span></span> ITestSuite; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ... Result.AddTest(TTestDB3.Suite); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; ...</code> </pre><br>  In addition, in a good way, they must be placed in a separate module, and this module should be added to the module with the DBSuite function.  I personally don‚Äôt really like this DBSuite change (besides, the ‚Äúextra‚Äù DB tests ‚Äùnode is added to the test hierarchy visually, although TTestDB1 / TTestDB2 could‚Äú belong ‚Äùto TTestDBSetup right away).  I just want to add the test module to the project and they would ‚Äúautomatically‚Äù be added to TTestDBSetup. <br><br>  Well, let's do as we want.  First of all, I don‚Äôt like the Setup name in the form ‚ÄúSetup decorator ((d) ...‚Äù. Besides, then when we register other tests in this Setup, we will use this name. We‚Äôll change it. For this pay attention to the following: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TTestSetup</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetName</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := Format(sSetupDecorator, [<span class="hljs-keyword"><span class="hljs-keyword">inherited</span></span> GetName]); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br>  And on the parameter <code>AName</code> in <br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TTestSetup</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ATest: ITest; AName: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">;</span></span></code> </pre><br>  Which is eventually assigned <br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TAbstractTest</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AName: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">;</span></span> ... FTestName := AName; ...</code> </pre><br>  So if we override <br><pre> <code class="delphi hljs">... TTestDBSetup = ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetName</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">implementation</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TTestDBSetup</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetName</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := FTestName; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">initialization</span></span> RegisterTest(TTestDBSetup.Create(DBSuite, <span class="hljs-string"><span class="hljs-string">'DB'</span></span>));</code> </pre><br>  Then we get: <br><br><img src="https://habrastorage.org/files/d95/619/91a/d9561991ad5540008500215b158e5863.png"><br><br>  Now I want to register test-cases immediately when the module is connected to the project.  That is so: <br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">unit</span></span> uTestDB3; ... <span class="hljs-keyword"><span class="hljs-keyword">initialization</span></span> RegisterTest(<span class="hljs-string"><span class="hljs-string">'DB'</span></span>, TTestDB3.Suite));</code> </pre><br>  For this you need (remember <code>RegisterTestInSuite</code> ) for TTestDBSetup to implement the ITestSuite interface. <br><br><pre> <code class="delphi hljs">... ITestSuite = <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>(ITest) [<span class="hljs-string"><span class="hljs-string">'{C20E38EF-7369-44D9-9D84-08E84EC1DCF0}'</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(test: ITest)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddSuite</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(suite : ITestSuite)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br>  There are only two methods: <br><br><pre> <code class="delphi hljs">... <span class="hljs-title"><span class="hljs-title">TTestDBSetup</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TTestSetup, ITestSuite) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(test: ITest)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddSuite</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(suite : ITestSuite)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">implementation</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TTestDBSetup</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(test: ITest)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Assert(Assigned(test)); FTests.Add(test); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TTestDBSetup</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddSuite</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(suite: ITestSuite)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> AddTest(suite); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; ...</code> </pre><br><img src="https://habrastorage.org/files/bba/c96/f9d/bbac96f9dd674cd4add610d4300ed5af.png"><br><br>  Happened! <br><br>  However, at startup (F9, by the way), it turns out that TTestDB3 tests are not performed: <br><br><img src="https://habrastorage.org/files/0df/0f5/430/0df0f543094f42b395bec6fa8a3a88c3.png"><br><br>  To understand why, look at the implementation: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TTestDecorator</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RunTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ATestResult: TTestResult)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> FTest.RunWithFixture(ATestResult); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br>  Those.  tests run only ( <code>FTest</code> ), which were set when creating TTestDBSetup: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TTestDecorator</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ATest: ITest; AName: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ... FTest := ATest; FTests:= TInterfaceList.Create; FTests.Add(FTest); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br></div></div><br>  And which we added later ( <code>FTests</code> ) - no.  Launch them by redefining RunTest: <br><br><pre> <code class="delphi hljs">... TTestDBSetup = ... <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RunTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ATestResult: TTestResult)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>. ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TTestDBSetup</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RunTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ATestResult: TTestResult)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: Integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">inherited</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   , ..  FTest for i := 1 to FTests.Count - 1 do (FTests[i] as ITest).RunWithFixture(ATestResult); end;</span></span></code> </pre><br>  Run: <br><br><img src="https://habrastorage.org/files/6fa/d9d/802/6fad9d802d7a4983a2693fcc6c4259eb.png"><br><br>  Now, it seems, everything is OK.  However, if you look closely, we will see that in statistics the number of tests is 4, and it was launched - 6. Obviously, our added tests are not counted.  Disorder. <br><br>  Bring beauty: <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="delphi hljs">... TTestDBSetup = ... <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CountTestInterfaces</span></span></span><span class="hljs-function">:</span></span> Integer; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CountEnabledTestInterfaces</span></span></span><span class="hljs-function">:</span></span> Integer; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CountTestCases</span></span></span><span class="hljs-function">:</span></span> Integer; <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CountEnabledTestCases</span></span></span><span class="hljs-function">:</span></span> Integer; <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TTestDBSetup</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CountTestCases</span></span></span><span class="hljs-function">:</span></span> Integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := <span class="hljs-keyword"><span class="hljs-keyword">inherited</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Enabled <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> Inc(Result, CountTestsInterfaces); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TTestDBSetup</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CountTestInterfaces</span></span></span><span class="hljs-function">:</span></span> Integer; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: Integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// skip FIRST test case (it is FTest) for i := 1 to FTests.Count - 1 do Inc(Result, (FTests[i] as ITest).CountTestCases); end; function TTestDBSetup.CountEnabledTestCases: Integer; begin Result := inherited; if Enabled then Inc(Result, CountEnabledTestInterfaces); end; function TTestDBSetup.CountEnabledTestInterfaces: Integer; var i: Integer; begin Result := 0; // skip FIRST test case (it is FTest) for i := 1 to FTests.Count - 1 do if (FTests[i] as ITest).Enabled then Inc(Result, (FTests[i] as ITest).CountTestCases); end; ...</span></span></code> </pre><br>  <i>Here, CountEnabledTestCases and CountEnabledTestInterfaces are auxiliary functions.</i> <br><br>  <b>Nota bene.</b>  In the GUI variant, CountEnabledTestCases is considered, and in the console version - CountTestCases. <br></div></div><br><img src="https://habrastorage.org/files/29d/9a0/84f/29d9a084f85d4da8bb655c36de102421.png"><br><br><img src="https://habrastorage.org/files/620/e01/061/620e010613e744f6b49c6200aa15a6ab.png"><br><br>  Now order. <br><br>  A reader who has read to the end may ask, is it worth it to bother so instead of using the function of the type described above DBSuite?  I myself thought about it now.  But for me, one of the advantages of this solution is that reworking one of my projects, in which I, even before I figured out so much with dUnit, did a little differently.  And to bring it to such beauty, there will only need to correct one pair of methods (well, add the above to the base class). <br><br>  PS: Source code of the example - <a href="https://github.com/ashumkin/habr-dunit-ttestsetup-demo">github.com/ashumkin/habr-dunit-ttestsetup-demo</a> <br><br>  Upd.  The source code of the resulting class <code>TTestDBSetup</code> (renamed to <code>TTestSetupEx</code> ) is moved to a separate project <a href="https://github.com/ashumkin/dUnitEx">dUnitEx</a> (see <a href="">TestSetupEx.pas</a> ) </div><p>Source: <a href="https://habr.com/ru/post/266487/">https://habr.com/ru/post/266487/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266477/index.html">Install JBoss BPM Suite</a></li>
<li><a href="../266479/index.html">Happy tickets up to 300 digits</a></li>
<li><a href="../266481/index.html">Work with Ansible - tasks with several unknowns</a></li>
<li><a href="../266483/index.html">How to attract users, select the icon of your application and earn the first million? Read in the news of the week for a mobile developer</a></li>
<li><a href="../266485/index.html">CVSS 3.0 Vulnerability Assessment</a></li>
<li><a href="../266489/index.html">Cyberband Carbanak returns with a new arsenal of malware</a></li>
<li><a href="../266491/index.html">"Sweet" encrypted VPN traffic or How we "protected" ice cream</a></li>
<li><a href="../266495/index.html">Predicting pages: Using dns-prefetch, preconnect, prefetch, preload and prerender to improve page performance</a></li>
<li><a href="../266497/index.html">Publish DITA to PDF using the DITA Open Toolkit. Page layout - layout-master overview</a></li>
<li><a href="../266499/index.html">New version of Node.js v4.0.0 released</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>