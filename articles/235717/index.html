<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we fought the brakes in AndEngine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, our team completed the development of a two-dimensional Android shooter on the AndEngine engine. In the process, some experience was gained ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we fought the brakes in AndEngine</h1><div class="post__text post__text-html js-mediator-article">  Recently, our team completed the development of a two-dimensional Android shooter on the AndEngine engine.  In the process, some experience was gained in solving performance problems and some features of the engine that I want to share with Habr's readers.  For the seed, I will insert a screenshot of the game from the game, and I will remove all the technical details and code examples under the cat. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c72/9ab/f40/c729abf40bc2903930795a35024d05ed.jpg"><br><a name="habracut"></a><br>  There is a lot of information about AndEngine.  This is one of the most popular engines for developing 2D games for Android.  It is written in Java, distributed under a free license, and all code is available on <a href="https://github.com/nicolasgramlich/AndEngine">github</a> .  Of the goodies that have become decisive for us when choosing the engine, it is worth noting: quick drawing of graphics (including animated sprites), handling collisions with full-fledged physics (using box2d) and support for the Tiled editor. <br><br>  // Tiled is a fairly convenient level editor and deserves a separate article.  Here is one of our levels: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/2f2/a03/a81/2f2a03a81c57456785bb3558d778a419.png" alt="2d Tile editor - Tiled"><br><br>  But back to AndEngine.  We started quite cheerfully and after a month of work we already had a playable prototype with several levels, cannons and monsters.  And here, when testing new levels, brakes began to slip at large clusters of monsters.  The problem was that we created many physical objects (monsters, bullets, etc.) the total amount of which could not be foreseen (for example, the spider's nest creates a new spider every few seconds) and even if you allocate memory for them in advance, then all Equally the garbage collector will periodically cause strong FPS subsidence. <br><br>  There was no time to cut out physics, and we started looking for ways to optimize the existing code.  As a result, we found and fixed many problem areas in the code, and also significantly improved our work with memory.  Then I will talk about specific approaches to solving problems.  Perhaps these tips may seem trivial to someone, but a few months ago such an article would save us a lot of time. <br><br><h4>  Culling </h4><br>  In AndEngine there is an option that allows you to skip rendering for sprites that are not in the camera's field of view - Culling.  Actual for games with levels that are much larger than the game screen.  In our case, the inclusion of Culling significantly increased the speed, but a problem appeared: as soon as the sprite at least partially goes beyond the camera, it is no longer drawn.  Thus it seemed that the game objects suddenly appear and disappear on the borders of the screen. <br><br>  To get around this problem, we used our method to determine the conditions for termination of rendering.  It looks like this: <br><br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">optimize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ setVisible(RectangularShapeCollisionChecker.isVisible(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Camera(ResourcesManager.getInstance().camera.getXMin() - mFullWidth, ResourcesManager.getInstance().camera.getYMin() - mFullHeight, ResourcesManager.getInstance().camera.getWidth() + mFullWidth, ResourcesManager.getInstance().camera.getHeight() + mFullHeight), <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)); }</code> </pre> <br>  After profiling, it turned out that checking the sprite‚Äôs entry into the camera‚Äôs field of view also consumes a lot of time.  Therefore, they wrote their method in the camera class, which significantly accelerated the overall speed: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">contains</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pX, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pY, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pW, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pH)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> w = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getWidth() + pW * <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> h = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getHeight() + pH * <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((w | h | pW | pH) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getXMin() - pW; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getYMin() - pH; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pX &lt; x || pY &lt; y) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } w += x; pW += pX; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pW &lt;= pX) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (w &gt;= x || pW &gt; w) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (w &gt;= x &amp;&amp; pW &gt; w) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } h += y; pH += pY; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pH &lt;= pY) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (h &gt;= y || pH &gt; h) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (h &gt;= y &amp;&amp; pH &gt; h) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }</code> </pre><br><br><h4>  Work with memory </h4><br>  We had a common practice to constantly create new objects for absolutely all classes, including effects, monsters, bullets, bonuses.  During the creation of objects and after some time (when the allocated memory will be freed by the garbage collector of the Java-machine), noticeable FPS drawdowns are observed up to several frames per second even on the most powerful smartphones. <br><br>  To eliminate this problem, you need to use object pools (object pool) - a special class for storing and reusing objects.  During the level load instances of all the necessary game classes are created and placed in pools.  When you need to create a new monster, instead of allocating a new portion of memory, we get it from the ‚Äústorage‚Äù.  When the monster is killed, we put it back in the pool.  Since the new memory is not allocated for the garbage collector, there is simply no new work. <br><br>  AndEngine includes a class for working with pools.  Let's look at its implementation on the example of bullets.  Since the game uses many types of bullets, we will use MultiPool.  All classes that are created through the pool are inherited from the PoolSprite class: <br><br><div class="spoiler">  <b class="spoiler_title">Lot of code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PoolSprite</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnimatedSprite</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> poolType; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PoolSprite</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pX, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pY, ITiledTextureRegion pTextureRegion, VertexBufferObjectManager pVertexBufferObjectManager)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(pX, pY, pTextureRegion, pVertexBufferObjectManager); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onRemoveFromWorld</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre><br>  In the class of a bullet, we remove all initialization from the constructor to the init () method.  Override onRemoveFromWorld (): <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onRemoveFromWorld</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { mBody.setActive(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); mBody.setAwake(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); mPhysicsWorld.unregisterPhysicsConnector(mBulletConnector); mPhysicsWorld.destroyBody(mBody); detachChildren(); detachSelf(); mIsAlive = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { Log.e(<span class="hljs-string"><span class="hljs-string">"Bullet"</span></span>, <span class="hljs-string"><span class="hljs-string">"Recycle Exception"</span></span>, e); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Error e) { Log.e(<span class="hljs-string"><span class="hljs-string">"Bullet"</span></span>, <span class="hljs-string"><span class="hljs-string">"Recycle Error"</span></span>, e); } }</code> </pre><br>  The superclass for all pools looks like this: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ObjectPool</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GenericPool</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PoolSprite</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> type; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ObjectPool</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pType)</span></span></span><span class="hljs-function"> </span></span>{ type = pType; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onHandleRecycleItem</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> PoolSprite pObject)</span></span></span><span class="hljs-function"> </span></span>{ pObject.onRemoveFromWorld(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onHandleObtainItem</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> PoolSprite pBullet)</span></span></span><span class="hljs-function"> </span></span>{ pBullet.reset(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> PoolSprite </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onAllocatePoolItem</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getType(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> PoolSprite </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre><br>  Superclass for constructor that uses multipool: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ObjectConstructor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> MultiPool&lt;PoolSprite&gt; pool; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ObjectConstructor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> PoolSprite </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pool.obtainPoolItem(type); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">recycle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PoolSprite poolSprite)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pool.recyclePoolItem(poolSprite.poolType, poolSprite); } }</code> </pre><br>  Types of bullets: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> TYPE { SIMPLE, ZOMBIE, LASER, BFG, ENEMY_ROCKET, FIRE, GRENADE, MINE, WEB, LAUNCHER_GRENADE }</code> </pre><br>  Bullet Designer: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BulletConstructor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ObjectConstructor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BulletConstructor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pool = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MultiPool&lt;PoolSprite&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pool.registerPool(SimpleBullet.TYPE.SIMPLE.ordinal(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BulletPool(SimpleBullet.TYPE.SIMPLE.ordinal())); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pool.registerPool(SimpleBullet.TYPE.ZOMBIE.ordinal(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BulletPool(SimpleBullet.TYPE.ZOMBIE.ordinal())); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pool.registerPool(SimpleBullet.TYPE.LASER.ordinal(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BulletPool(SimpleBullet.TYPE.LASER.ordinal())); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pool.registerPool(SimpleBullet.TYPE.BFG.ordinal(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BulletPool(SimpleBullet.TYPE.BFG.ordinal())); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pool.registerPool(SimpleBullet.TYPE.ENEMY_ROCKET.ordinal(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BulletPool(SimpleBullet.TYPE.ENEMY_ROCKET.ordinal())); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pool.registerPool(SimpleBullet.TYPE.FIRE.ordinal(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BulletPool(SimpleBullet.TYPE.FIRE.ordinal())); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pool.registerPool(SimpleBullet.TYPE.GRENADE.ordinal(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BulletPool(SimpleBullet.TYPE.GRENADE.ordinal())); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pool.registerPool(SimpleBullet.TYPE.MINE.ordinal(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BulletPool(SimpleBullet.TYPE.MINE.ordinal())); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pool.registerPool(SimpleBullet.TYPE.WEB.ordinal(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BulletPool(SimpleBullet.TYPE.WEB.ordinal())); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pool.registerPool(SimpleBullet.TYPE.LAUNCHER_GRENADE.ordinal(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BulletPool(SimpleBullet.TYPE.LAUNCHER_GRENADE.ordinal())); } }</code> </pre><br>  Bullet Pool Class: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BulletPool</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ObjectPool</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BulletPool</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pType)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(pType); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> PoolSprite </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.type) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleBullet(); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ZombieBullet(); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LaserBullet(); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BfgBullet(); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EnemyRocket(); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FireBullet(); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Grenade(); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mine(); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebBullet(); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Grenade(ResourcesManager.getInstance().grenadeBulletRegion); <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } }</code> </pre><br>  Creating a bullet object looks like this: <br><pre> <code class="java hljs">SimpleBullet simpleBullet = (SimpleBullet) GameScene.getInstance().bulletConstructor.createObject(SimpleBullet.TYPE.SIMPLE.ordinal()); simpleBullet.init(targetCoords[<span class="hljs-number"><span class="hljs-number">0</span></span>], targetCoords[<span class="hljs-number"><span class="hljs-number">1</span></span>], mDamage, mSpeed, mOwner, mOwner.getGunSprite().getRotation() + disperse);</code> </pre><br>  Uninstall: <br><pre> <code class="java hljs">gameScene.bulletConstructor.recycle(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>);</code> </pre><br></div></div><br>  By the same principle, pools were created for other types of objects.  The frame rate has stabilized, but the brakes started on weak devices in the first seconds of each level.  Therefore, we first fill the pools with ready-to-use objects and only after that hide the level loading screen. <br><br><h4>  TouchEventPool and BaseTouchController </h4><br>  During the profiling of the game on weak smartphones, significant performance slowdowns were observed during the memory allocation engine in TouchEventPool.  What was clear from the corresponding logger messages: <br><br> <code>TouchEventPool was exhausted, with 2 item not yet recycled. Allocated 1 more.</code> <br> <br>  and <br><br> <code>org.andengine.util.adt.pool.PoolUpdateHandler$1 was exhausted, with 2 item not yet recycled. Allocated 1 more.</code> <br> <br>  Therefore, we slightly changed the engine code and initially expanded these pools.  In the org.andengine.input.touch.TouchEvent class, we select 20 objects in the constructor: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> TouchEventPool TOUCHEVENT_POOL = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TouchEventPool(<span class="hljs-number"><span class="hljs-number">20</span></span>);</code> </pre><br>  And also in the internal class of TouchEventPool we add a constructor: <br><br><pre> <code class="java hljs">TouchEventPool(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> size) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(size); }</code> </pre><br>  In the org.andengine.input.touch.controller.BaseTouchController class, when mTouchEventRunnablePoolUpdateHandler is initialized, we add an argument to the constructor: <br><br><pre> <code class="java hljs">‚Ä¶ = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RunnablePoolUpdateHandler&lt;TouchEventRunnablePoolItem&gt;(&lt;b&gt;<span class="hljs-number"><span class="hljs-number">20</span></span>&lt;/b&gt;)</code> </pre><br>  After these manipulations, the allocation of memory to the classes responsible for touching has become much more modest. <br><br><h4>  What to do when you lose focus </h4><br><br>  At this, the optimization of the gameplay itself ended and we switched to other aspects of the game.  Serious problems appeared after connecting Google Play Service and Tapjoy.  When a player interacts with the screens of these services, the activity of the game loses focus.  After returning to activity, the texture is reloaded; for a short time, everything hangs.  To solve this problem, add the following code in the main application activity: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mRenderSurfaceView.setPreserveEGLContextOnPause(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>);</code> </pre><br><br><h4>  We reduce the amount of memory occupied </h4><br>  For some textures, it makes sense to use a trimmed color range: RGBA4444 instead of RGB8888.  TexturePacker allows you to do this through the Image format option.  If the graphic part is made in the style with a small number of colors (for example, for cartoon graphics), then this will significantly save memory and slightly increase the speed. <br><br><img src="https://habrastorage.org/files/381/f47/222/381f472224a142cfbc83a03683159b21.png" alt="Texture packer"><br><br><h4>  Long compilation time </h4><br>  One of the most annoying things when developing on AndEngine is the wait time from the start of the compilation to the testing of the game.  In addition to the assembly of the apk-file, you also need time to copy it from a computer to an Android device.  At the end of the development we had to wait around one minute.  We have lost a lot of time on this issue.  In this regard, other engines like Unity seemed like a paradise to us - the assembly takes place very quickly and can be tested immediately on the desktop.  This problem is solved only by switching to another engine, which we did during the development of the next game. <br><br><h4>  The absence of the development of AndEngine </h4><br>  The last commit in the repository is dated December 11, 2013, the entry in the official blog is January 22.  Obviously, the project is frozen. <br><br><h4>  What is the result? </h4><br>  After the development, we decided that we would no longer work with AndEngine.  It is good for small games, but it has some drawbacks that are not found in alternative engines. <br><br>  We compared the most popular engines and chose libGDX.  The community is huge, engines are actively developing, good documentation + many examples.  The big plus was that libGDX was written in Java.  Since there is an opportunity to collect the game on the desktop, the development and testing of the game is greatly accelerated.  I'm not talking about the fact that the development is carried out immediately on all popular mobile platforms.  Of course, there are some nuances and you will need to write some specific code for each platform, but it is much faster and cheaper than full development for a new platform.  Now we are finishing work on the second game on libGDX and so far it only pleases us. <br><br>  Thank you all for your attention! </div><p>Source: <a href="https://habr.com/ru/post/235717/">https://habr.com/ru/post/235717/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../235703/index.html">Noise Security Bit # 9 (about Black Hat 2014 and Defcon 22)</a></li>
<li><a href="../235707/index.html">Raise SOC: ARM + FPGA</a></li>
<li><a href="../235711/index.html">Button gouging and pedaling Vim</a></li>
<li><a href="../235713/index.html">SMS virus under the Android OS or "Hello :) You photo ..."</a></li>
<li><a href="../235715/index.html">Sony's latest news at IFA 2014</a></li>
<li><a href="../235719/index.html">Battle Arsenal of Erlang Developer</a></li>
<li><a href="../235721/index.html">Biological sensory surfaces as a new step in the evolution of gadgets</a></li>
<li><a href="../235723/index.html">Creating plug-ins for AutoCAD using the .NET API (part 1 - first steps)</a></li>
<li><a href="../235725/index.html">OOBD without OOP</a></li>
<li><a href="../235727/index.html">Uploading sketches to Arduino via Bluetooth</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>