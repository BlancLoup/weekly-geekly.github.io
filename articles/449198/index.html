<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FFmpeg getting started with Visual Studio</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! To begin with, I am developing a program for identifying car numbers on a cheap low-power processor like Intel ATOM Z8350. We obtained quite go...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FFmpeg getting started with Visual Studio</h1><div class="post__text post__text-html js-mediator-article">  Hello!  To begin with, I am developing a program for identifying car numbers on a cheap low-power processor like Intel ATOM Z8350.  We obtained quite good results in determining the Russian numbers on a static picture (up to 97%) with good speed without using neural networks.  The case is left for small - work with IP-camera Fig 1. <br><br><img src="https://habrastorage.org/webt/il/ds/hv/ildshvj4y94npstenmkw5yle_xg.jpeg" alt="image"><br>  <i>pic.1 Intel ATOM Z83II computer and ATIS IP camera</i> <br><br>  <b>FFmpeg</b> is a library for creating video applications or even general purpose utilities that takes care of all the hard work of video processing, performing all the decoding, encoding, multiplexing and demultiplexing for you. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Task</b> : Full HD IP camera in standard h.264 transmits RTSP stream.  The size of the unpacked frame is 1920x1080 pixels, the frequency is 25 frames per second.  It is necessary to receive decoded frames into RAM and save every 25 frames to disk. <br><br>  In this example, we will decode frames programmatically.  The goal is to learn how to use FFmpeg and further compare the results obtained using hardware decoding.  You will see FFmpeg - it's easy! <br><a name="habracut"></a><br>  <b>Installing FFmpeg</b> : many people suggest building FFmpeg for their hardware.  I propose to use <i>zeranoe</i> assemblies, it greatly simplifies the task.  It is very important that <i>zeranoe</i> assemblies include support for DXVA2, which will come in handy later for hardware decoding. <br><br>  Go to the site <a href="https://ffmpeg.zeranoe.com/builds/">https://ffmpeg.zeranoe.com/builds/</a> and download 2 shared archives and dev before choosing 32 or 64 bits.  The dev archive stores libraries (.lib) and include.  The shared archive contains the necessary .dll which will need to be copied to the folder with your future program. <br><br>  So, create a C: \ ffmpeg folder on the C: \ drive.  In it we will rewrite the files from the archive dev. <br><br>  Connecting FFmpeg to Visual Studio 2017: create a new project.  Go to the project properties (Project - properties).  Next C / C ++ and select "Additional directories include files."  Set the value: "C: \ ffmpeg \ dev \ include;".  After that, go to Linker-Additional Library Directories and set the value "C: \ ffmpeg \ dev \ lib;".  Everything.  FFmpeg is connected to our project. <br><cut></cut><br>  The first project with FFmpeg: software video decoding and recording every 25 frames per disc.  The principle of working with video file in FFmpeg is presented in the flowchart of Fig.2 <br><br><img src="https://habrastorage.org/webt/ki/u6/og/kiu6ogj56lb4boxdznsb2ueluwe.png" alt="image"><br>  <i>Fig.2 Block diagram of working with a video file.</i> <br><br><div class="spoiler">  <b class="spoiler_title">Here is the C ++ project code.</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// 21  2019 //  ,  ,   http://dranger.com/ffmpeg/tutorial01.html // #include "pch.h" extern "C" { #include &lt;libavcodec/avcodec.h&gt; #include &lt;libavformat/avformat.h&gt; #include &lt;libswscale/swscale.h&gt; #include &lt;libavformat/avio.h&gt; #include &lt;libavutil/pixdesc.h&gt; #include &lt;libavutil/hwcontext.h&gt; #include &lt;libavutil/opt.h&gt; #include &lt;libavutil/avassert.h&gt; #include &lt;libavutil/imgutils.h&gt; #include &lt;libavutil/motion_vector.h&gt; #include &lt;libavutil/frame.h&gt; } &lt;cut /&gt; #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #pragma comment(lib, "avcodec.lib") #pragma comment(lib, "avformat.lib") #pragma comment(lib, "swscale.lib") #pragma comment(lib, "avdevice.lib") #pragma comment(lib, "avutil.lib") #pragma comment(lib, "avfilter.lib") #pragma comment(lib, "postproc.lib") #pragma comment(lib, "swresample.lib") #define _CRT_SECURE_NO_WARNINGS #pragma warning(disable : 4996) // compatibility with newer API #if LIBAVCODEC_VERSION_INT &lt; AV_VERSION_INT(55,28,1) #define av_frame_alloc avcodec_alloc_frame #define av_frame_free avcodec_free_frame #endif void SaveFrame(AVFrame *pFrame, int width, int height, int iFrame) { FILE *pFile; char szFilename[32]; int y; //        sprintf(szFilename, "frame%d.ppm", iFrame); pFile = fopen(szFilename, "wb"); if (pFile == NULL) return; //    fprintf(pFile, "P6\n%d %d\n255\n", width, height); //    for (y = 0; y &lt; height; y++) fwrite(pFrame-&gt;data[0] + y * pFrame-&gt;linesize[0], 1, width * 3, pFile); //   fclose(pFile); } &lt;cut /&gt; int main(int argc, char *argv[]) { AVFormatContext *pFormatCtx = NULL; int i, videoStream; AVCodecContext *pCodecCtxOrig = NULL; AVCodecContext *pCodecCtx = NULL; AVCodec *pCodec = NULL; AVFrame *pFrame = NULL; AVFrame *pFrameRGB = NULL; AVPacket packet; int frameFinished; int numBytes; uint8_t *buffer = NULL; struct SwsContext *sws_ctx = NULL; if (argc &lt; 2) { printf("Please provide a movie file\n"); return -1; } //      av_register_all(); //     if (avformat_open_input(&amp;pFormatCtx, argv[1], NULL, NULL) != 0) return -1; //     //      if (avformat_find_stream_info(pFormatCtx, NULL) &lt; 0) return -1; //     : , ,    av_dump_format(pFormatCtx, 0, argv[1], 0); //    videoStream = -1; for (i = 0; i &lt; pFormatCtx-&gt;nb_streams; i++) if (pFormatCtx-&gt;streams[i]-&gt;codec-&gt;codec_type == AVMEDIA_TYPE_VIDEO) { videoStream = i; break; } if (videoStream == -1) return -1; //   &lt;cut /&gt; //      pCodecCtxOrig = pFormatCtx-&gt;streams[videoStream]-&gt;codec; //      pCodec = avcodec_find_decoder(pCodecCtxOrig-&gt;codec_id); if (pCodec == NULL) { fprintf(stderr, "Unsupported codec!\n"); return -1; //    } //   pCodecCtx = avcodec_alloc_context3(pCodec); if (avcodec_copy_context(pCodecCtx, pCodecCtxOrig) != 0) { fprintf(stderr, "Couldn't copy codec context"); return -1; //   } //   if (avcodec_open2(pCodecCtx, pCodec, NULL) &lt; 0) return -1; //     //     pFrame = av_frame_alloc(); //      RGB pFrameRGB = av_frame_alloc(); if (pFrameRGB == NULL) return -1; //        numBytes = avpicture_get_size(AV_PIX_FMT_RGB24, pCodecCtx-&gt;width, pCodecCtx-&gt;height); buffer = (uint8_t *)av_malloc(numBytes * sizeof(uint8_t)); //      . avpicture_fill((AVPicture *)pFrameRGB, buffer, AV_PIX_FMT_RGB24, pCodecCtx-&gt;width, pCodecCtx-&gt;height); //  SWS context       RGB sws_ctx = sws_getContext(pCodecCtx-&gt;width, pCodecCtx-&gt;height, pCodecCtx-&gt;pix_fmt, pCodecCtx-&gt;width, pCodecCtx-&gt;height, AV_PIX_FMT_RGB24, SWS_BILINEAR, NULL, NULL, NULL ); &lt;cut /&gt; //     25    i = 0; while (av_read_frame(pFormatCtx, &amp;packet) &gt;= 0) { //    ? if (packet.stream_index == videoStream) { //    avcodec_decode_video2(pCodecCtx, pFrame, &amp;frameFinished, &amp;packet); //    ? if (frameFinished) { //    RGB sws_scale(sws_ctx, (uint8_t const * const *)pFrame-&gt;data, pFrame-&gt;linesize, 0, pCodecCtx-&gt;height, pFrameRGB-&gt;data, pFrameRGB-&gt;linesize); //     if (++i % 25 == 0) SaveFrame(pFrameRGB, pCodecCtx-&gt;width, pCodecCtx-&gt;height,i); } } //   av_free_packet(&amp;packet); } //      av_free(buffer); av_frame_free(&amp;pFrameRGB); av_frame_free(&amp;pFrame); avcodec_close(pCodecCtx); avcodec_close(pCodecCtxOrig); avformat_close_input(&amp;pFormatCtx); return 0; }</span></span></code> </pre> <br></div></div><br>  Because  I have an IP camera with IP 192.168.1.168, then the program call: <br><br><pre> <code class="plaintext hljs">decode.exe rtsp://192.168.1.168</code> </pre> <br>  Also, this example is able to decode video files, it is enough to indicate its location. <br><br>  And so, in this example, we learned how to programmatically decode video files and save the received frames to disk.  Frames are saved in .ppm format.  To open these files you can use IrfanView 64 or GIMP in Windows. <br><br>  <b>Conclusion:</b> software decoding of the RTSP Full HD H.264 stream takes up to two Intel ATOM Z8350 cores, moreover, packet loss occurs periodically, due to which some frames are decoded incorrectly.  This method is more applicable for decoding recorded video files, because there is no need for real-time operation. <br><br>  In the next article I will explain how to hardware decode an RTSP stream. <br><br>  <b><a href="">Archive with the project</a></b> <b><br><br></b>  <b><a href="">Working program</a></b> <br><br><h4>  Links to materials on FFmpeg: </h4><br>  1. <a href="http://dranger.com/ffmpeg/tutorial01.html">The FFmpeg tutorial is a bit out of date.</a> <br>  2. <a href="https://trac.ffmpeg.org/wiki">Various useful information on FFmpeg.</a> <br>  3. <a href="https://ffmpeg.org/doxygen/4.1/index.html">Information on the use of various libraries provided by FFmpeg.</a> </div><p>Source: <a href="https://habr.com/ru/post/449198/">https://habr.com/ru/post/449198/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../44914/index.html">19 inventions that make life easier ... or not</a></li>
<li><a href="../449142/index.html">Microbiota What bacteria live in the intestines of Russians</a></li>
<li><a href="../44915/index.html">And what is it?</a></li>
<li><a href="../449186/index.html">Botnets in 2019: actual dangers and harm caused to small and medium businesses</a></li>
<li><a href="../449190/index.html">Computer architecture. Digital logic level</a></li>
<li><a href="../4492/index.html">Opera 9.02 - fast, but buggy?</a></li>
<li><a href="../44920/index.html">Minor cross-platform issues</a></li>
<li><a href="../449200/index.html">Highlights of the past Moscow Python Conf ++ 2019: transformation into a platform for communication</a></li>
<li><a href="../449202/index.html">As an IT specialist, move to the US: a comparison of work visas, useful services and links to help</a></li>
<li><a href="../449204/index.html">How we consider the metrics of development and support of documentation. Yandex report</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>