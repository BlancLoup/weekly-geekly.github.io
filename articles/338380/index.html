<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Abstraction of the network layer using "strategies"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From all my previous implementations of the network layer, there was an impression that there is still room for growth. This publication aims to provi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Abstraction of the network layer using "strategies"</h1><div class="post__text post__text-html js-mediator-article"><p>  From all my previous implementations of the network layer, there was an impression that there is still room for growth.  This publication aims to provide one of the architectural solutions for building the network layer of the application.  This is not about the next way to use the next network framework. </p><br><h2 id="chast-1-vzglyad-na-suschestvuyuschie-podhody">  Part 1. A look at existing approaches </h2><br><p>  To start, the <a href="https://github.com/artsy/eidolon"><u>Artsy</u></a> application is taken from the publication <a href="https://medium.mybridge.co/21-amazing-open-source-ios-apps-written-in-swift-5e835afee98e"><u>21 Amazing Open Source iOS Apps Written in Swift</u></a> .  It uses the popular <a href="https://github.com/Moya/Moya"><u>Moya</u></a> framework, on the basis of which the entire network layer is built.  I will note a number of major flaws that I have encountered in this project and I often meet in other applications and publications. </p><a name="habracut"></a><br><h4 id="povtory-cepochek-preobrazovaniya-otveta">  Repetition Response Chain Repetitions </h4><br><pre><code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> endpoint: <span class="hljs-type"><span class="hljs-type">ArtsyAPI</span></span> = <span class="hljs-type"><span class="hljs-type">ArtsyAPI</span></span>.activeAuctions provider.request(endpoint) .filterSuccessfulStatusCodes() .mapJSON() .mapTo(arrayOf: <span class="hljs-type"><span class="hljs-type">Sale</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>)</code> </pre> <br><p>  The developer has identified a logical chain with this code, in which the response to the <u>activeAuctions</u> query <u>is</u> converted into an array of <u>Sale</u> objects.  When you reuse this query in another <u>ViewModel</u> or <u>ViewController, the</u> developer will have to copy the query along with the response conversion chain.  To avoid copying duplicate conversion logic, the request and the response can be linked with some kind of contract that will be described exactly once. </p><br><h4 id="bolshoe-kolichestvo-zavisimostey">  A large number of dependencies </h4><br><p>  Frequently, <a href="https://github.com/Alamofire/Alamofire"><u>Alamofire</u></a> , <u>Moya</u> and other frameworks are used to work with the network. Ideally, the application should be minimally dependent on these frameworks.  If in search for <u>Artsy</u> repository you type <u>import Moya</u> , you can see dozens of matches.  If suddenly the project decides to abandon the use of <u>Moya</u> - a lot of code will have to refactor. </p><br><p>  It is not difficult to estimate how much each project depends on the network framework, if you remove this dependency and try to modify the application to a healthy state. </p><br><h4 id="obschiy-klass-menedezhera-zaprosov">  General query manager class </h4><br><p>  A possible way out of the situation with dependencies will be to create a special class, which will be one to know about frameworks and about all possible ways to get data from the network.  These methods will be described by functions with strictly typed input and output parameters, which in turn will be the contract mentioned above and will help to cope with the problem of <u>repeating response transformation chains</u> .  This approach is also quite common.  Its practical application can also be found in apps from the list of <a href="https://medium.mybridge.co/21-amazing-open-source-ios-apps-written-in-swift-5e835afee98e"><u>21 iOS Apps Written in Swift</u></a> .  For example, in the <a href="https://github.com/MengTo/DesignerNewsApp"><u>DesignerNewsApp</u></a> application.  This class looks like this: </p><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DesignerNewsService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">storiesForSection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(..., response: </span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">([Story])</span></span></span></span></span></span> -&gt; ()) { <span class="hljs-comment"><span class="hljs-comment">// parameters Alamofire.request(...).response { _ in // parsing } } static func loginWithEmail(..., response: (token: String?) -&gt; ()) { // parameters Alamofire.request(...).response { _ in // parsing } } }</span></span></code> </pre> <br><p>  This approach also has disadvantages.  The number of responsibilities assigned to this class is more than required by the principle of sole responsibility.  It will have to be changed when changing the way requests are executed (replacing <u>Alamofire</u> ), when changing the parsing framework, when changing request parameters.  In addition, such a class can grow into a <a href="https://ru.wikipedia.org/wiki/%25D0%2591%25D0%25BE%25D0%25B6%25D0%25B5%25D1%2581%25D1%2582%25D0%25B2%25D0%25B5%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BE%25D0%25B1%25D1%258A%25D0%25B5%25D0%25BA%25D1%2582"><u>god object</u></a> or be used as a <a href=""><u>singleton</u></a> with all the ensuing consequences. </p><br><blockquote>  Do you know the feeling of despondency when you need to integrate a project with another RESTful API?  This is when once again you need to create some APIManager and fill it with Alamofire requests ... <a href="https://habrahabr.ru/post/332570/">(link)</a> </blockquote><br><h2 id="chast-2-podhod-osnovannyy-na-strategiyah">  Part 2. Strategy-based approach </h2><br><p>  Considering all the shortcomings described in the 1st part of the publication, I formulated for myself a number of requirements for the future layer of work with the network: </p><br><ul><li>  Reduce dependency on external network frameworks </li><li>  Provide the ability to quickly and easily replace network frameworks with each other. </li><li>  Use maximal universal classes / structures and protocols with <a href="http://swiftbook.ru/doc/generics/associated-types">related types.</a> </li><li>  Prevent repetition of conversion chains and minimize code repetition </li></ul><br><p>  What happened in the end: </p><br><h4 id="bazovye-protokoly-setevogo-sloya">  Basic Network Layer Protocols </h4><br><p>  The <u>ApiTarget</u> protocol defines all the data that is needed to form a request (parameters, path, method ..., etc.) </p><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApiTarget</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parameters: [<span class="hljs-type"><span class="hljs-type">String</span></span> : <span class="hljs-type"><span class="hljs-type">String</span></span>] { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> } }</code> </pre> <br><p>  The <u>generic ApiResponseConvertible</u> protocol determines how to convert the resulting object (in this case, <u>Data</u> ) into an object of the <a href="http://swiftbook.ru/doc/generics/associated-types">associated type</a> . </p><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApiResponseConvertible</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">associatedtype</span></span> <span class="hljs-type"><span class="hljs-type">ResultType</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">map</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data: Data)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ResultType</span></span> }</code> </pre> <br><p>  The <u>ApiService</u> protocol defines the way requests are sent.  Typically, a function declared in a protocol accepts a closure containing the response object and possible errors.  In the current implementation, the function returns <u>Observable</u> - an object of the <a href="https://github.com/ReactiveX/RxSwift">RxSwift</a> reactive framework. </p><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApiService</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-function">&lt;T&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(with target: T)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Observable</span></span>&lt;<span class="hljs-type"><span class="hljs-type">T</span></span>.<span class="hljs-type"><span class="hljs-type">ResultType</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-type"><span class="hljs-type">T</span></span>: <span class="hljs-type"><span class="hljs-type">ApiResponseConvertible</span></span>, <span class="hljs-type"><span class="hljs-type">T</span></span>: <span class="hljs-type"><span class="hljs-type">ApiTarget</span></span> }</code> </pre> <br><h4 id="strategii">  Strategies </h4><br><p>  I call the strategy the contract mentioned at the beginning of the publication, which links together several types of data.  The strategy is a protocol and in the simplest case looks like this: </p><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Strategy</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">associatedtype</span></span> <span class="hljs-type"><span class="hljs-type">ObjectType</span></span> <span class="hljs-keyword"><span class="hljs-keyword">associatedtype</span></span> <span class="hljs-type"><span class="hljs-type">ResultType</span></span> }</code> </pre> <br><p>  For the needs of the network layer, the strategy should be able to create an object that can be passed to an instance of the class corresponding to the <u>ApiService</u> protocol.  Add an object creation function to the <u>ApiStrategy</u> protocol. </p><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApiStrategy</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">associatedtype</span></span> <span class="hljs-type"><span class="hljs-type">ObjectType</span></span> <span class="hljs-keyword"><span class="hljs-keyword">associatedtype</span></span> <span class="hljs-type"><span class="hljs-type">ResultType</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">target</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(with object: ObjectType)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">AnyTarget</span></span>&lt;<span class="hljs-type"><span class="hljs-type">ResultType</span></span>&gt; }</code> </pre> <br><p>  The introduction of the new universal structure <u>AnyTarget</u> is due to the fact that we cannot use the generalized <u>ApiResponseConvertible</u> protocol as the type of the object returned by the function, because the protocol has an <a href="http://swiftbook.ru/doc/generics/associated-types">associated type</a> . </p><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnyTarget</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt;: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApiResponseConvertible</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApiTarget</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> _map: (<span class="hljs-type"><span class="hljs-type">Data</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">T</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> parameters: [<span class="hljs-type"><span class="hljs-type">String</span></span> : <span class="hljs-type"><span class="hljs-type">String</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>&lt;<span class="hljs-type"><span class="hljs-type">U</span></span>&gt;(with target: <span class="hljs-type"><span class="hljs-type">U</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-type"><span class="hljs-type">U</span></span>: <span class="hljs-type"><span class="hljs-type">ApiResponseConvertible</span></span>, <span class="hljs-type"><span class="hljs-type">U</span></span>: <span class="hljs-type"><span class="hljs-type">ApiTarget</span></span>, <span class="hljs-type"><span class="hljs-type">U</span></span>.<span class="hljs-type"><span class="hljs-type">ResultType</span></span> == <span class="hljs-type"><span class="hljs-type">T</span></span> { _map = target.<span class="hljs-built_in"><span class="hljs-built_in">map</span></span> parameters = target.parameters } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">map</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data: Data)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">T</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> _map(data) } }</code> </pre> <br><p>  Here is the most primitive implementation of the strategy: </p><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleStrategy</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApiStrategy</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">ObjectType</span></span> = <span class="hljs-type"><span class="hljs-type">Int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">ResultType</span></span> = <span class="hljs-type"><span class="hljs-type">String</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">target</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(with object: Int)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">AnyTarget</span></span>&lt;<span class="hljs-type"><span class="hljs-type">String</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> target = <span class="hljs-type"><span class="hljs-type">Target</span></span>(value: object) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">AnyTarget</span></span>(with: target) } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Target</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> value: <span class="hljs-type"><span class="hljs-type">Int</span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Target</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApiTarget</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parameters: [<span class="hljs-type"><span class="hljs-type">String</span></span> : <span class="hljs-type"><span class="hljs-type">String</span></span>] { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [:] } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Target</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApiResponseConvertible</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">map</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data: Data)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">String</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"\(value)"</span></span> <span class="hljs-comment"><span class="hljs-comment">// map value from data } }</span></span></code> </pre> <br><p>  It should be noted that the structure of <u>Target</u> is private, because  it will not be used outside the file.  It is needed only to initialize the universal structure of <u>AnyTarget</u> . </p><br><p>  The object conversion also takes place within the file, so <u>ApiService</u> will not know anything about the tools used during parsing. </p><br><h4 id="ispolzovanie-strategiy-i-servisa">  Using strategies and service </h4><br><pre> <code class="hljs vbscript"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> service: ApiService = ... <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> target = SimpleStrategy.target(<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>: ...) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-built_in"><span class="hljs-built_in">request</span></span> = service.<span class="hljs-built_in"><span class="hljs-built_in">request</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>: target)</code> </pre> <br><p>  The strategy will tell you which object is needed to make the request and which object will be output.  Everything is strictly typed by the strategy and there is no need to specify types as in the case of universal functions. </p><br><h4 id="realizaciya-apiservice">  ApiService implementation </h4><br><p>  As you can see, in this approach, the network framework remained outside the basic logic of building the service.  At first, it can not be used at all.  For example, if in the implementation of the <u>map</u> function of the <u>ApiResponseConvertible</u> protocol <u>to</u> return a mock-object, then the service can be quite a primitive class: </p><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MockService</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApiService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-function">&lt;T&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(with target: T)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Observable</span></span>&lt;<span class="hljs-type"><span class="hljs-type">T</span></span>.<span class="hljs-type"><span class="hljs-type">ResultType</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-type"><span class="hljs-type">T</span></span> : <span class="hljs-type"><span class="hljs-type">ApiResponseConvertible</span></span>, <span class="hljs-type"><span class="hljs-type">T</span></span> : <span class="hljs-type"><span class="hljs-type">ApiTarget</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">Observable</span></span> .just(<span class="hljs-type"><span class="hljs-type">Data</span></span>()) .<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>({ [<span class="hljs-built_in"><span class="hljs-built_in">map</span></span> = target.<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>] (data) -&gt; <span class="hljs-type"><span class="hljs-type">T</span></span>.<span class="hljs-type"><span class="hljs-type">ResultType</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(data) }) } }</code> </pre> <br><p>  The test implementation and use of the <u>ApiService</u> protocol <u>based</u> on the real <u>Moya</u> network framework can be seen on the spoiler: </p><br><div class="spoiler">  <b class="spoiler_title">ApiService + Moya + Implementation</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">extension</span></span> Api { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Service { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> enum Kind { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> failing(Api.Error) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> normal <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> test } let kind: Api.Service.Kind let logs: <span class="hljs-type"><span class="hljs-type">Bool</span></span> fileprivate lazy var provider: MoyaProvider&lt;Target&gt; = self.getProvider() <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> init(kind: Api.Service.Kind, logs: <span class="hljs-type"><span class="hljs-type">Bool</span></span>) { self.kind = kind self.logs = logs } fileprivate func getProvider() -&gt; MoyaProvider&lt;Target&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MoyaProvider&lt;Target&gt;( stubClosure: stubClosure, plugins: plugins ) } private var plugins: [PluginType] { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> logs ? [RequestPluginType()] : [] } private func stubClosure(_ target: Target) -&gt; Moya.StubBehavior { switch kind { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> .failing, .normal: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Moya.StubBehavior.never <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> .test: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Moya.StubBehavior.<span class="hljs-keyword"><span class="hljs-keyword">immediate</span></span> } } } } <span class="hljs-keyword"><span class="hljs-keyword">extension</span></span> Api.Service: ApiService { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> func dispose() { // } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> func request&lt;T&gt;(headers: [Api.<span class="hljs-keyword"><span class="hljs-keyword">Header</span></span>: String], scheduler: ImmediateSchedulerType, target: T) -&gt; Observable&lt;T.ResultType&gt; <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T: ApiResponseConvertible, T: ApiTarget { switch kind { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> .failing(let error): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Observable.error(error) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Observable .just((), scheduler: scheduler) .map({ [weak self] _ -&gt; MoyaProvider&lt;Target&gt;? <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self?.provider }) .filterNil() .flatMap({ [headers, target] provider -&gt; Observable&lt;Moya.Response&gt; <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> let api = Target(headers: headers, target: target) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> provider.rx .request(api) .asObservable() }) .map({ [map = target.map] (response: Moya.Response) -&gt; T.ResultType <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> switch response.statusCode { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> try map(response.data) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">401</span></span>: throw Api.Error.invalidToken <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">404</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { let <span class="hljs-type"><span class="hljs-type">json</span></span>: <span class="hljs-type"><span class="hljs-type">JSON</span></span> = try response.data.materialize() let message: String = try <span class="hljs-type"><span class="hljs-type">json</span></span>["ErrorMessage"].materialize() throw Api.Error.failedWithMessage(message) } catch let error { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> .<span class="hljs-keyword"><span class="hljs-keyword">some</span></span>(let error) = error <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>? Api.Error, <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> .failedWithMessage = error { throw error } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { throw Api.Error.failedWithMessage(nil) } } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">500</span></span>: throw Api.Error.serverInteralError <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">501</span></span>: throw Api.Error.appUpdateRequired <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: throw Api.Error.unknown(nil) } }) .catchError({ (error) -&gt; Observable&lt;T.ResultType&gt; <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> switch error <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>? Api.Error { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> .<span class="hljs-keyword"><span class="hljs-keyword">some</span></span>(let error): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Observable.error(error) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: let error = Api.Error.unknown(error) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Observable.error(error) } }) } } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">ApiService + Moya + Usage</b> <div class="spoiler_text"><pre> <code class="hljs vbscript">func observableRequest(_ observableCancel: Observable&lt;Void&gt;, _ observableTextPrepared: Observable&lt;<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>&gt;) -&gt; Observable&lt;Result&lt;Objects, Api.<span class="hljs-keyword"><span class="hljs-keyword">Error</span></span>&gt;&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> factoryApiService = base.factoryApiService <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> factoryIndicator = base.factoryIndicator <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> factorySchedulerConcurrent = base.factorySchedulerConcurrent return observableTextPrepared .observeOn(base.factorySchedulerConcurrent()) .flatMapLatest(observableCancel: observableCancel, observableFactory: { (text) -&gt; Observable&lt;Result&lt;Objects, Api.<span class="hljs-keyword"><span class="hljs-keyword">Error</span></span>&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> return Observable .using(factoryApiService) { (service: Api.Service) -&gt; Observable&lt;Result&lt;Objects, Api.<span class="hljs-keyword"><span class="hljs-keyword">Error</span></span>&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> object = Api.<span class="hljs-built_in"><span class="hljs-built_in">Request</span></span>.Categories.Name(text: text) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> target = Api.Strategy.Categories.Auto.target(<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>: object) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> headers = [Api.Header.authorization: <span class="hljs-string"><span class="hljs-string">""</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-built_in"><span class="hljs-built_in">request</span></span> = service .<span class="hljs-built_in"><span class="hljs-built_in">request</span></span>(headers: headers, scheduler: factorySchedulerConcurrent(), target: target) .map({ Objects(text: text, manual: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, objects: $<span class="hljs-number"><span class="hljs-number">0</span></span>) }) .map({ Result&lt;Objects, Api.<span class="hljs-keyword"><span class="hljs-keyword">Error</span></span>&gt;(value: $<span class="hljs-number"><span class="hljs-number">0</span></span>) }) .shareReplayLatestWhileConnected() switch factoryIndicator() { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> .some(<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> activityIndicator): return <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>.trackActivity(activityIndicator) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: return <span class="hljs-built_in"><span class="hljs-built_in">request</span></span> } } .catchError({ (<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>) -&gt; Observable&lt;Result&lt;Objects, Api.<span class="hljs-keyword"><span class="hljs-keyword">Error</span></span>&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> switch <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> as? Api.<span class="hljs-keyword"><span class="hljs-keyword">Error</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> .some(<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">error</span></span>): return Observable.just(Result&lt;Objects, Api.<span class="hljs-keyword"><span class="hljs-keyword">Error</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">error</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: return Observable.just(Result&lt;Objects, Api.<span class="hljs-keyword"><span class="hljs-keyword">Error</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>: Api.<span class="hljs-keyword"><span class="hljs-keyword">Error</span></span>.unknown(nil))) } }) }) .observeOn(base.factorySchedulerConcurrent()) .shareReplayLatestWhileConnected() }</code> </pre> </div></div><br><h2 id="vyvod">  Conclusion </h2><br><p>  The resulting network layer can successfully exist without strategies.  Likewise, strategies can be applied to other goals and objectives.  Their joint use made the network layer understandable and easy to use. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/338380/">https://habr.com/ru/post/338380/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338360/index.html">Approximate search methods for nearest neighbors</a></li>
<li><a href="../338362/index.html">Create an ‚Äúexternal outline‚Äù of an ecosystem with independent developers: the results of the Skyeng API contest</a></li>
<li><a href="../338366/index.html">ECMAScript 6. Regular expressions with Unicode support</a></li>
<li><a href="../338374/index.html">As I wrote a book on almost sotsinzhiniringu</a></li>
<li><a href="../338378/index.html">Computer forensics (forsensik): a selection of useful links</a></li>
<li><a href="../338382/index.html">Our method of calculating the stack of printed circuit boards</a></li>
<li><a href="../338384/index.html">First-line support bikes: great work if you have strong nerves</a></li>
<li><a href="../338386/index.html">Sheat-sheets "regular expressions"</a></li>
<li><a href="../338388/index.html">Kotlin in production, what did we get, and what did we lose?</a></li>
<li><a href="../338390/index.html">Is there an OpenVPN GUI for Linux?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>