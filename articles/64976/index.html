<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using composite keys to manipulate memcached data</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Often, when working with memcached , a situation arises when it is necessary to delete data in various places. For example, when adding a new comment,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using composite keys to manipulate memcached data</h1><div class="post__text post__text-html js-mediator-article">  Often, when working with <a href="http://ru.wikipedia.org/wiki/Memcached">memcached</a> , a situation arises when it is necessary to delete data in various places.  For example, when adding a new comment, you need to update not only the cache of the comments on this page, but also the comment feeds on the main page, the list of user comments, the user comments count, the total count of comments for the site, the article comments count, etc.  You can remember all the keys of this data and call delete () with these keys many times. <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">&lt;?php <br> $cache-&gt;delete( <font color="#A31515">'comments_art123'</font> ); <br> $cache-&gt;delete( <font color="#A31515">'comments_tape'</font> ); <br> $cache-&gt;delete( <font color="#A31515">'comments_user123'</font> ); <br> $cache-&gt;delete( <font color="#A31515">'comments_counters_art123'</font> ); <br> $cache-&gt;delete( <font color="#A31515">'comments_counters_user123'</font> ); <br> ...... <br> ?&gt;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  As you know, memcached keeps data flat, that is, one key always corresponds to one value.  Nested keys do not exist.  It is also not possible to delete a group of keys, say by mask.  It would be nice if you could, for example, do this: $ cache-&gt; delete ('comments *');  But it is impossible. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But if you can not, but really want, you can;) <br><a name="habracut"></a><br>  <b>Task</b> : Implement the ability to group delete data from the cache <br>  <b>Solution</b> : We will store the sign of remoteness of a group in a separate cache location, and the fact of the availability of data will be determined not by the fact of the availability of the data itself, but by the fact of the presence of the attribute.  Let's call this place <b>keskheader</b> .  For simplicity, we will store the usual hash there.  For an example with comments, the hash will look like this: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">array( <br> <font color="#A31515">'comments'</font> =&gt; array( <br> <font color="#A31515">'art123'</font> =&gt; array(), <br> <font color="#A31515">'tape'</font> =&gt; array(), <br> <font color="#A31515">'user123'</font> =&gt; array(), <br> <font color="#A31515">'counters'</font> =&gt; array( <font color="#A31515">'art123'</font> =&gt;array(), <font color="#A31515">'user123'</font> =&gt; array(),), <br> ) <br> );</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Thus, in order to mark a certain group as deleted, we just need to remove this branch from the cache.  For example, if we want to update the counters, remove the 'counters' key, and then our cache will look like this: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">array( <br> <font color="#A31515">'comments'</font> =&gt; array( <br> <font color="#A31515">'art123'</font> =&gt; array(), <br> <font color="#A31515">'tape'</font> =&gt; array(), <br> <font color="#A31515">'user123'</font> =&gt; array(), <br> ) <br> ); <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  This will be a sign that the data should be pulled out of the database, and put in the cache, adding, of course, the relevant information in the cache. <br><br>  If necessary, other information can be stored in the cache manager, for example, the size of the data, or even links to other related elements, which will expand the possibilities and realize data storage not only in the tree, but also in the form of a network. <br><br>  So, the code of the class that implements the above: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">&lt;?php <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*     memcached,    .</font> <br> <font color="#008000">*</font> <br> <font color="#008000">* @author rvk</font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">class</font> MemcacheCacher implements DataCacher { <br> <br> <font color="#0000ff">protected</font> $daemon = <font color="#0000ff">null</font> ; <br> <font color="#0000ff">protected</font> $key = <font color="#A31515">''</font> ; <br> <font color="#0000ff">protected</font> $header = array(); <br> <font color="#0000ff">const</font> HEADER_KEY_NAME = <font color="#A31515">'cacheheader'</font> ; <br> <br> <font color="#0000ff">public</font> function __construct($key) { <br> $ <font color="#0000ff">this</font> -&gt;key = explode( <font color="#A31515">'|'</font> , $key); <br> <br> $ <font color="#0000ff">this</font> -&gt;daemon = <font color="#0000ff">new</font> Memcache(); <br> $ <font color="#0000ff">this</font> -&gt;daemon-&gt;connect( <font color="#A31515">'localhost'</font> , 11211) or die ( <font color="#A31515">"Could not connect"</font> ); <br> <br> <font color="#008000">// .       </font> <br> $ <font color="#0000ff">this</font> -&gt;header = $ <font color="#0000ff">this</font> -&gt;daemon-&gt; <font color="#0000ff">get</font> (MemcacheCacher::HEADER_KEY_NAME); <br> <font color="#0000ff">if</font> (!is_array($ <font color="#0000ff">this</font> -&gt;header)) { <br> $ <font color="#0000ff">this</font> -&gt;daemon-&gt;add(MemcacheCacher::HEADER_KEY_NAME, array(), <font color="#0000ff">false</font> , 10000); <br> $ <font color="#0000ff">this</font> -&gt;header = $ <font color="#0000ff">this</font> -&gt;daemon-&gt; <font color="#0000ff">get</font> (MemcacheCacher::HEADER_KEY_NAME); <br> } <br> <br> } <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*</font> <br> <font color="#008000">*   </font> <br> <font color="#008000">*</font> <br> <font color="#008000">* @param mixed $data</font> <br> <font color="#008000">*/</font> <br> <br> <font color="#0000ff">public</font> function <font color="#0000ff">set</font> ($data) { <br> $ <font color="#0000ff">this</font> -&gt;createHeaderElement(); <br> $ <font color="#0000ff">this</font> -&gt;daemon-&gt; <font color="#0000ff">set</font> (implode( <font color="#A31515">'|'</font> ,$ <font color="#0000ff">this</font> -&gt;key), $data, <font color="#0000ff">false</font> , 10000) or die ( <font color="#A31515">"Failed to save data at the server"</font> ); <br> } <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*</font> <br> <font color="#008000">*    </font> <br> <font color="#008000">*</font> <br> <font color="#008000">* @return mixed</font> <br> <font color="#008000">*/</font> <br> <br> <font color="#0000ff">public</font> function <font color="#0000ff">get</font> () { <br> <font color="#0000ff">if</font> ($ <font color="#0000ff">this</font> -&gt;exists()) { <br> <font color="#0000ff">return</font> $ <font color="#0000ff">this</font> -&gt;daemon-&gt; <font color="#0000ff">get</font> (implode( <font color="#A31515">'|'</font> ,$ <font color="#0000ff">this</font> -&gt;key)); <br> } <br> <br> <font color="#0000ff">return</font> <font color="#0000ff">null</font> ; <br> } <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*</font> <br> <font color="#008000">*   </font> <br> <font color="#008000">*</font> <br> <font color="#008000">* @return bool</font> <br> <font color="#008000">*/</font> <br> <br> <font color="#0000ff">public</font> function exists() { <br> $element = $ <font color="#0000ff">this</font> -&gt;getHeaderElement(); <br> <font color="#0000ff">return</font> is_array($element); <br> } <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*  .       ,      .</font> <br> <font color="#008000">* ,      </font> <br> <font color="#008000">*/</font> <br> <br> <font color="#0000ff">public</font> function del() { <br> <font color="#0000ff">if</font> ($ <font color="#0000ff">this</font> -&gt;exists()) { <br> $element = $ <font color="#0000ff">this</font> -&gt;setHeaderElement( <font color="#0000ff">null</font> ); <br> $ <font color="#0000ff">this</font> -&gt;daemon-&gt; <font color="#0000ff">set</font> (MemcacheCacher::HEADER_KEY_NAME, $ <font color="#0000ff">this</font> -&gt;header, <font color="#0000ff">false</font> , 10000); <br> } <br> } <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*  </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">public</font> function flush() { <br> $ <font color="#0000ff">this</font> -&gt;daemon-&gt;flush(); <br> } <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*</font> <br> <font color="#008000">*       </font> <br> <font color="#008000">*</font> <br> <font color="#008000">* @return mixed</font> <br> <font color="#008000">*/</font> <br> <br> <font color="#0000ff">protected</font> function &amp; getHeaderElement() { <br> $header = &amp; $ <font color="#0000ff">this</font> -&gt;header; <br> <br> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;key <font color="#0000ff">as</font> $subkey) { <br> <font color="#0000ff">if</font> (!isset ($header[$subkey])) { <br> <font color="#0000ff">return</font> $header[$subkey]; <br> } <br> $header = &amp; $header[$subkey]; <br> } <br> <font color="#0000ff">return</font> $header; <br> } <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*</font> <br> <font color="#008000">*    </font> <br> <font color="#008000">*</font> <br> <font color="#008000">* @param mixed $value</font> <br> <font color="#008000">* @return mixed</font> <br> <font color="#008000">*/</font> <br> <br> <font color="#0000ff">protected</font> function setHeaderElement($ <font color="#0000ff">value</font> ) { <br> $element = &amp; $ <font color="#0000ff">this</font> -&gt;getHeaderElement(); <br> $element = $ <font color="#0000ff">value</font> ; <br> $ <font color="#0000ff">this</font> -&gt;daemon-&gt; <font color="#0000ff">set</font> (MemcacheCacher::HEADER_KEY_NAME, $ <font color="#0000ff">this</font> -&gt;header, <font color="#0000ff">false</font> , 10000); <br> } <br> <br> <font color="#008000">/**</font> <br> <font color="#008000">*         </font> <br> <font color="#008000">*/</font> <br> <br> <font color="#0000ff">protected</font> function createHeaderElement() { <br> $header = &amp; $ <font color="#0000ff">this</font> -&gt;header; <br> <br> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;key <font color="#0000ff">as</font> $subkey) { <br> <font color="#0000ff">if</font> (!isset ($header[$subkey])) { <br> $header[$subkey] = array(); <br> } <br> $header = &amp; $header[$subkey]; <br> } <br> $ <font color="#0000ff">this</font> -&gt;daemon-&gt; <font color="#0000ff">set</font> (MemcacheCacher::HEADER_KEY_NAME, $ <font color="#0000ff">this</font> -&gt;header, <font color="#0000ff">false</font> , 10000); <br> } <br> <br> } <br> ?&gt; <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  To update everything that relates to comments you need to execute only such code: <br><br>  $ cache-&gt; delete ('comments'); <br><br>  or update only counters <br><br>  $ cache-&gt; delete ('comments | counters'); <br><br>  well, or just a user counter <br><br>  $ cache-&gt; delete ('comments | counters | user123'); <br><br>  The best thing about the work of the class will tell the unit test (they are often better than any documentation): <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">&lt;?php <br> <font color="#0000ff">class</font> TestOfMemcacheCacher extends UnitTestCase { <br> <br> <font color="#0000ff">public</font> function setUp() { <br> $ <font color="#0000ff">this</font> -&gt;cache = <font color="#0000ff">new</font> MemcacheCacher( <font color="#A31515">'key'</font> ); <br> $ <font color="#0000ff">this</font> -&gt;cache-&gt; <font color="#0000ff">set</font> (1); <br> } <br> <br> <font color="#0000ff">public</font> function testOfCacheExists() { <br> $cache = <font color="#0000ff">new</font> MemcacheCacher( <font color="#A31515">'key'</font> ); <br> $ <font color="#0000ff">this</font> -&gt;assertTrue($cache-&gt;exists()); <br> $cache = <font color="#0000ff">new</font> MemcacheCacher( <font color="#A31515">'key1'</font> ); <br> $ <font color="#0000ff">this</font> -&gt;assertFalse($cache-&gt;exists()); <br> } <br> <br> <font color="#0000ff">public</font> function testOfCacheDelete() { <br> $cache = <font color="#0000ff">new</font> MemcacheCacher( <font color="#A31515">'key'</font> ); <br> $ <font color="#0000ff">this</font> -&gt;assertTrue($cache-&gt;exists()); <br> $cache-&gt;del(); <br> $ <font color="#0000ff">this</font> -&gt;assertFalse($cache-&gt;exists()); <br> <br> } <br> <br> <font color="#0000ff">public</font> function testOfCacheGet() { <br> $cache = <font color="#0000ff">new</font> MemcacheCacher( <font color="#A31515">'key'</font> ); <br> $ <font color="#0000ff">this</font> -&gt;assertEqual($cache-&gt; <font color="#0000ff">get</font> (), <font color="#A31515">'1'</font> ); <br> $ <font color="#0000ff">this</font> -&gt;assertNotEqual($cache-&gt; <font color="#0000ff">get</font> (), <font color="#A31515">'2'</font> ); <br> } <br> <br> <font color="#0000ff">public</font> function testOfTreeCacheExists() { <br> $cache = <font color="#0000ff">new</font> MemcacheCacher( <font color="#A31515">'key|key1'</font> ); <br> $cache-&gt; <font color="#0000ff">set</font> (123); <br> $ <font color="#0000ff">this</font> -&gt;assertEqual($cache-&gt; <font color="#0000ff">get</font> (), <font color="#A31515">'123'</font> ); <br> $ <font color="#0000ff">this</font> -&gt;assertTrue($cache-&gt;exists()); <br> $cache = <font color="#0000ff">new</font> MemcacheCacher( <font color="#A31515">'key'</font> ); <br> $cache-&gt;del(); <br> $cache = <font color="#0000ff">new</font> MemcacheCacher( <font color="#A31515">'key|key1'</font> ); <br> $ <font color="#0000ff">this</font> -&gt;assertFalse($cache-&gt;exists()); <br> } <br> <br> <font color="#0000ff">public</font> function tearDown() { <br> $ <font color="#0000ff">this</font> -&gt;cache-&gt;flush(); <br> } <br> <br> } <br> <br> ?&gt; <br> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  A similar approach successfully worked on the photofile.ru project under the load of about 4 million hits per day. <br><br>  <b>PS</b> You should not treat the code above as completely finished.  This is an example, it can and should be optimized. </div><p>Source: <a href="https://habr.com/ru/post/64976/">https://habr.com/ru/post/64976/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../64964/index.html">Refactoring: mission (not) possible?</a></li>
<li><a href="../64965/index.html">Digital drugs came up with record companies ... probably</a></li>
<li><a href="../64971/index.html">In Zend We Trust</a></li>
<li><a href="../64972/index.html">Feature position: fixed, or why I had to block side vertical buttons like "Leave your review"</a></li>
<li><a href="../64975/index.html">Pluralization</a></li>
<li><a href="../64977/index.html">How not to do a startup or how to squander $ 160,000</a></li>
<li><a href="../64981/index.html">DataTraveler 300 from Kingston</a></li>
<li><a href="../64982/index.html">Webkit announces support for three-dimensional CSS-transformations</a></li>
<li><a href="../64986/index.html">Microsoft wants to bring its code into the Linux kernel - let's see</a></li>
<li><a href="../64987/index.html">On this day, the first time a walk on the moon was made!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>