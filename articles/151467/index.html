<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Work with data in WinRT. Part 1. Storing Settings and Files</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In WinRT, work with data and the file system has changed and it is slightly different from both desktop .NET and Silverlight. 

 To access user files ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Work with data in WinRT. Part 1. Storing Settings and Files</h1><div class="post__text post__text-html js-mediator-article">  In WinRT, work with data and the file system has changed and it is slightly different from both desktop .NET and Silverlight. <br><br>  To access user files in the system, you need appropriate permissions and you need to use contracts and extensions to work with files (which will be discussed in a separate article).  However, each application has access to isolated storage for storing service data and settings.  All that is needed to store data is in the Windows.Storage namespace in the ApplicationData object. <br><br>  In this article we will consider working with the following objects: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Store simple data in LocalSettings and RoamingSettings.</b>  <b>(Storage of simple data)</b> <b><br><br></b>  <b>Storage of binary data in LocalFolder, TemporaryFolder, RoamingFolder.</b>  <b>(File storage in file system)</b> <b><br><br></b>  <b>Features of working with RoamingSettings and RoamingFolder (Storing data in the cloud. Synchronize data between devices).</b> <b><br><br></b>  <b>Versioning of data in roaming.</b> <b><br><br></b>  <b>Direct data access via Uri.</b> <br><br>  The next <a href="http://habrahabr.ru/post/151479/">part</a> will be considered work with the database. <br><a name="habracut"></a><br><br>  The official example for working with local data can be downloaded at: <a href="http://code.msdn.microsoft.com/windowsapps/ApplicationData-sample-fb043eb2">code.msdn.microsoft.com/windowsapps/ApplicationData-sample-fb043eb2</a> <br><br>  This article will look at an example of how local data works with FileStorage.zip. <br><br><h4>  1. Storage of simple data in LocalSettings and RoamingSettings </h4><br>  Working with LocalSettings and RoamingSettings is identical.  Distinctive features of RoamingSettings will be discussed below. <br><br>  First of all, these objects are intended for storing simple data with simple types.  It can store data of type string, bool, int, float, etc.  These objects are useful for storing settings like sound volume, etc. <br><br>  The API is implemented very simply.  The following code saves the text with the ‚ÄúcustomKey‚Äù key: <br><br><pre><code class="cs hljs">ApplicationData.Current.LocalSettings.Values[<span class="hljs-string"><span class="hljs-string">"customKey"</span></span>] = <span class="hljs-string"><span class="hljs-string">"mytext"</span></span>;</code> </pre> <br>  Reading the data is as simple as saving (since values ‚Äã‚Äãof the object type must be transferred to the original type): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> customText = (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) ApplicationData.Current.LocalSettings.Values[<span class="hljs-string"><span class="hljs-string">"customKey"</span></span>];</code> </pre><br>  It is also advisable to check the presence of the key before extracting it, so as not to get a NullReferenceException error for meaningful data types (bool, int, float, etc.). <br><br>  var settings = ApplicationData.Current.LocalSettings; <br>  if (settings.Values.ContainsKey ("pageNumber")) <br>  { <br>  var number = (int) settings.Values ‚Äã‚Äã["pageNumber"]; <br>  } <br><br>  Often we need to store more complex data types and / or binary data.  In this case, we can use xFolder objects. <br><br><h4>  2. Storage of binary data in LocalFolder, TemporaryFolder, RoamingFolder. </h4><br>  xFolder objects are designed to store data in the file system.  Working with them is almost identical with small features. <br><br>  LocalFolder is intended for storing service files necessary for an application, such as a database or for data downloaded from a network that must be on the client. <br><br>  TemproryFolder is well suited for temporary data.  For example, for a social networking client application, this folder is well suited for caching photos. <br><br>  RoamingFolder as well as RoamingSettings can be used for data that needs to be synchronized between devices and / or stored in the cloud.  The work with it will be discussed in detail later, but it is possible to store small data (up to 100 kb) in it. <br><br>  To work with files, you can also use methods of the FileIO object, which simplifies working with data. <br><br>  For example, the following code creates a text file my.txt with the contents of Hello!  World! <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> storageFolder = ApplicationData.Current.LocalFolder; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> file = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> storageFolder.CreateFileAsync(<span class="hljs-string"><span class="hljs-string">"my.txt"</span></span>, CreationCollisionOption.ReplaceExisting); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> FileIO.WriteTextAsync(file, <span class="hljs-string"><span class="hljs-string">"Hello! World!"</span></span>);</code> </pre><br>  Similarly, you can read a text file: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> storageFolder = ApplicationData.Current.LocalFolder; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> file = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> storageFolder.GetFileAsync(<span class="hljs-string"><span class="hljs-string">"my.txt"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> text = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> FileIO.ReadTextAsync(file);</code> </pre><br>  In those cases when we need to save complex data types, we can use some kind of serializer.  For example, DataContractSerializer (in the System.Runtime.Serialization namespace) or third-party library Json.net. <br><br>  In the example attached to the article there is an example of saving and reading a book using the Json.NET library: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Save</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Book book</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> serializedString = JsonConvert.SerializeObject(book); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> storageFolder = ApplicationData.Current.LocalFolder; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> file = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> storageFolder.CreateFileAsync(<span class="hljs-string"><span class="hljs-string">"book.dat"</span></span>, CreationCollisionOption.ReplaceExisting); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> FileIO.WriteTextAsync(file, serializedString); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;Book&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetBook</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> file = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> ApplicationData.Current.LocalFolder.GetFileAsync(<span class="hljs-string"><span class="hljs-string">"book.dat"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> serializedString = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> FileIO.ReadTextAsync(file); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> JsonConvert.DeserializeObjectAsync&lt;Book&gt;(serializedString); }</code> </pre><br>  Now that we have looked at how to work with Settings and Folder, we can consider the features when working with Roaming data. <br><br><h4>  3. Features of working with RoamingSettings and RoamingFolder </h4><br>  RoamingSettings and RoamingFolder are designed to store small amounts of data in the cloud.  It should not attempt to store the full database of your application.  For example, if you have an application for reading books, you should not try to store the texts of books in it, instead you can store the last open file and the page that the user is reading now.  For the game, you can store the current state of passing the game (for example, information about unlocked levels). <br><br>  These objects provide a free opportunity to keep passing the game, not only between reinstalling applications, but also between different devices, without having to maintain your own server infrastructure! <br><br>  In addition, as mentioned above, since the data that is stored in these objects is stored between application installations, you should carefully design the logic for working with data in these storages, since if your application, for example, falls with incorrect values ‚Äã‚Äãin these objects, then it will continue to fall even after reinstallation.  That can lead to the fact that the user will lose any opportunity to work with your application. <br><br><h5>  3.1.  Restrictions </h5><br>  The amount of available data is limited and its value can be obtained from the RoamingStorageQuota property (the value is specified in kilobytes - the default is 100 kb) <br><br><pre> <code class="cs hljs">ApplicationData.Current.RoamingStorageQuota</code> </pre><br>  Also, when saving data to the RoamingFolder, you cannot use spaces in file names. <br><br><h5>  3.2.  Sync time </h5><br>  When designing an application that works through the Roaming Folder, it is necessary to take into account that the time of data synchronization between devices is about 10-15 minutes.  However, for RoamingSettings there is a service key that should be used for data with high sync priority: <br><br><pre> <code class="cs hljs">HighPriority</code> </pre><br><br>  Data synchronization time for this key is somewhere 15-30 seconds. <br><br><pre> <code class="cs hljs">ApplicationData.Current.LocalSettings.Values[<span class="hljs-string"><span class="hljs-string">"HighPriority"</span></span>] = <span class="hljs-string"><span class="hljs-string">"high priority data"</span></span>;</code> </pre><br>  You can also intercept the DataChanged: data change event while the application is running. <br><br><pre> <code class="cs hljs">ApplicationData.Current.DataChanged += Current_DataChanged;</code> </pre><br>  Since the event is not called in the UI thread, updating the UI should be done through the dispatcher: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Current_DataChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ApplicationData sender, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> args</span></span></span><span class="hljs-function">)</span></span> { Dispatcher.RunAsync(CoreDispatcherPriority.Normal, () =&gt; { MyTextBox.Text = (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)ApplicationData.Current.RoamingSettings.Values[<span class="hljs-string"><span class="hljs-string">"HighPriority"</span></span>]; }); }</code> </pre><br>  To debug an application, we can call the ApplicationData.Current.SignalDataChanged () method;  which will trigger the DataChanged event. <br><br>  What to do when, in the new version of the application, a new data structure is required, which is not compatible with the data structure of the previous application? <br><br><h4>  4. Versioning of data in roaming. </h4><br>  Any application that continues to evolve over time requires a new data structure.  For data that is stored locally, we can provide our own version control and update mechanisms. <br><br>  For data in roaming, the potential problem is that if in new applications we can provide for the processing logic of the old format, then the already installed and working applications will not be able to process the data of the new format. <br><br>  WinRT provides a ready-made API for splitting data into different versions.  Roaming data in the application will receive data only from versions with the same number.  The DataChanged event is triggered only in those applications where the identical version of data is installed. <br><br>  The current version can be obtained from the ApplicationData.Version property: <br><br><pre> <code class="cs hljs">ApplicationData.Current.Version</code> </pre><br>  By default, the version number is 0. <br><br>  It is strongly recommended to initially provide for the possibility of changes in the future and start not with the default version but with version 1. <br><br>  You can install the new version of the data through the SetVersionAsync method: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">await</span></span> ApplicationData.Current.SetVersionAsync(versinoNumber, UpgradeToVersionHandler); TextBlockDataVersion.Text = ApplicationData.Current.Version.ToString();</code> </pre><br><br>  Where: <br><br>  versionNumber - integer version number <br><br>  UpgradeToVersionHandler - data update handler: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpgradeToVersionHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SetVersionRequest setversionrequest</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> defferal = setversionrequest.GetDeferral(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (setversionrequest.DesiredVersion &gt; setversionrequest.CurrentVersion) { <span class="hljs-comment"><span class="hljs-comment">//UpgradeCodeFromOldToNewVersion(); } defferal.Complete(); }</span></span></code> </pre><br>  Since when we install a new version of the application, we also need to update the data, we must use the GetDefferral () method to ensure that the application is not closed at the time of updating the data. <br><br>  As with roaming data, the data version remains even after reinstalling the application.  Version number is not synchronized between devices (For each device, its own version number). <br><br>  Often, applications need to directly access data in a folder.  In the next section, we will look at how to do this. <br><br><h4>  5. Direct access to data through Uri and Path. </h4><br><br>  WinRT has prefixes for direct access to data.  To do this, you can use the following prefixes: <br><br>  ms-appx: /// - access files included in the project. <br><br>  ms-appdata: /// local / - access files stored in the LocalFolder folder <br><br>  ms-appdata: /// roaming / - access to files saved in the RoamingFolder folder <br><br>  ms-appdata: /// temp / - access to files in the TemporaryFolder folder <br><br>  In official examples there is an example of access to pictures using these prefixes: <br><br><pre> <code class="cs hljs">LocalImage.Source = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapImage(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(<span class="hljs-string"><span class="hljs-string">"ms-appdata:///local/appDataLocal.png"</span></span>)); RoamingImage.Source = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapImage(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(<span class="hljs-string"><span class="hljs-string">"ms-appdata:///roaming/appDataRoaming.png"</span></span>)); TempImage.Source = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapImage(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(<span class="hljs-string"><span class="hljs-string">"ms-appdata:///temp/appDataTemp.png"</span></span>));</code> </pre><br>  If necessary, we can also access the folder where the application is stored.  The path to the folder can be obtained from the Path property for all xFolder objects.  For example, the path to the local folder can be obtained from the property: <br><br><pre> <code class="cs hljs">ApplicationData.Current.LocalFolder.Path</code> </pre><br>  In this case, the path to the folder looks like this: <br><br>  c: \ users \ UserName \ AppData \ Local \ Packages \ e965c8d4-0dff-4f2e-8340-24041aabca05_5mvwcwnjebzdj \ LocalState \ <br><br>  Where <br><br>  UserName - username in the system <br><br>  e965c8d4-0dff-4f2e-8340-24041aabca05 - application identifier. <br><br>  Accordingly, the full path to the file in this folder can be obtained either by simple string concatenation or using the Path.Combine helper method (System.IO Namespace).  So, the path to the file my.txt will look like this: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fullPath=Path.Combine(ApplicationData.Current.RoamingFolder.Path, <span class="hljs-string"><span class="hljs-string">"my.txt"</span></span>);</code> </pre><br>  Direct file access can be conveniently used to work with databases to indicate the path to the database file, the work with which will be discussed in the next section. <br><br><h4>  Results </h4><br>  As we can see, Microsoft has significantly simplified the ability to work with data by providing ready-made tools for storing local and temporary data and providing a simple and free mechanism for synchronizing application state between devices (which can be used as a cloud backup for small data, if necessary).  Now you can provide users with the opportunity to save the passage of their favorite game.  :) </div><p>Source: <a href="https://habr.com/ru/post/151467/">https://habr.com/ru/post/151467/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../151457/index.html">eBay changed logo</a></li>
<li><a href="../151458/index.html">HostingCommunity considers it normal to raise prices three times when changing its legal entity</a></li>
<li><a href="../151462/index.html">The experience of obtaining a private key token for the Unified Portal of State Services</a></li>
<li><a href="../151463/index.html">What I love Yii + Twig for: dynamic connection of necessary scripts</a></li>
<li><a href="../151466/index.html">Google launches J2ObjC, an open source Java to Objective-C code converter for iOS applications.</a></li>
<li><a href="../151469/index.html">Black Mesa can already be downloaded for free!</a></li>
<li><a href="../151470/index.html">Apple has confirmed that it will not sell unlocked versions of the iPhone 5 in the US at the start of sales</a></li>
<li><a href="../151471/index.html">Flying robots contest</a></li>
<li><a href="../151472/index.html">Windows 8 Summit - the first partner conference on Windows 8</a></li>
<li><a href="../151474/index.html">S02.03 Gadgets and capitals</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>