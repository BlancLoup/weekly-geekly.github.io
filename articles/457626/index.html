<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Auditing user access levels using Power BI using the example of CMS Bitrix (BEADS)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article shows an example of using Power BI to analyze user access on a site running 1C-Bitrix. 

 Problem 
 Over time, the development of Internet...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Auditing user access levels using Power BI using the example of CMS Bitrix (BEADS)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.21-7683.png" alt="image"><br><br>  The article shows an example of using Power BI to analyze user access on a site running 1C-Bitrix. <br><a name="habracut"></a><br><h2>  Problem </h2><br>  Over time, the development of Internet resources is connected by more and more users in one way or another, having more rights than the ordinary user of the site. <br><br>  In this regard, it is increasingly difficult to control access to confidential functions.  Well, if written regulations that help control access at a more or less secure level.  But it often happens that colleagues go to work in other departments, go to the decrees :) or leave, and access remains. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Naturally, this carries different threats: a leak of the customer base and, right up to sabotage, etc. <br>  The age of projects with which I have been working has already been 10 years.  The database has hundreds of thousands of users, including hundreds with privileged rights. <br><br>  This article shows an example of how to simplify the audit of users to various objects of the site under the control of CMS Bitrix (BEADS). <br><br>  The problem is that the admin Beatrix does not allow to get a complete picture with accesses;  it is unpleasant to click on a bunch of links and wait for admin pages to load. <br><br>  As a main tool for this Power BI will be used (a bit not in its main purpose :) <br><br>  It is assumed that the reader is already familiar with Power BI at the basic level, knows the basics of SQL, and knows how to use the Bitrix admin panel too.  Standard Bitrix features in terms of access will be considered. <br><br><h2>  Disadvantages of the Beatrix admin </h2><br>  It is impossible to conduct a revision in a standard admin panel in a reasonable time due to the lack of a coherent picture with accesses - summary data on all modules / sections / info-blocks, etc., to which access is granted. <br><br>  Admin performance: <br><br><ol><li>  In the ‚ÄúUser Groups‚Äù section of the Bitrix admin box there is a feature that generates a SQL query to select all groups with counting the number of users.  All is well when the base is small.  But with a base of hundreds of thousands of users, with hundreds of user groups on a dedicated server with 128 GB of RAM, simply opening this section takes 8 seconds. </li><li>  In the group card there is also a request that for some reason selects all user groups, instead of receiving data only on the selected one.  Losses on waiting 3 sec. </li></ol><br><h2>  Solutions </h2><br>  Usually there are several solutions to the problem. <br><br><ol><li>  Write regulations on providing access to sites and clearly follow them. </li><li>  Periodically conduct an audit of accesses. </li><li>  Hope for the best and not spend the limited resources of the company. </li></ol><br>  This article will be considered just the second way. <br><br><h2>  Tasks </h2><br><ol><li>  Choose tools that will allow you to quickly obtain data on the access levels of each user with extended rights. </li><li>  Customize the tools so that they clearly show the picture with accesses in general with the necessary detail and interactivity. </li><li>  To conduct an access audit. </li></ol><br><h2>  Access storage in Bitrix </h2><br>  Bitrix allows you to flexibly configure the rights through user groups. <br>  Access settings are stored mainly in MySQL tables.  Some of the settings are stored in files.  For example, access to files and folders is stored in .access.php files. <br><br>  The analysis of the access of users and user groups to: <br><br><ul><li>  info blocks </li><li>  web forms with access level </li><li>  web form status with access level </li><li>  sections of the site </li><li>  Bitrix modules with access levels </li></ul><br><h2>  Instruments </h2><br><ol><li>  Power BI Desktop, which allows to visualize data well, get data from multiple sources (almost) out of the box.  Actually, Power BI can be replaced with regular Excel 2016 and higher - PowerQuery is already included in its delivery, through which all data can be selected for analysis.  However, Power BI allows you to interactively display data based on their relationships, and this allows you to quickly find hidden dependencies. </li><li>  MySQL Connector will need to be able to create a query through Power BI to a MySQL web server. </li><li>  Kitty or Putty for the organization of the tunnel to MySql, if access to the database is open only through SSH. </li></ol><br>  The following access scheme is obtained: Power BI ‚Üí MySQL Connector ‚Üí Kitty ‚Üí MySQL. <br><br><h3>  Power BI </h3><br>  Power BI Desktop allows you to visualize data well, get data from multiple sources (almost) out of the box.  Actually, Power BI can be replaced with regular Excel 2016 and higher - PowerQuery is already included in its delivery, through which all data can be selected for analysis.  However, Power BI allows you to interactively display data based on their relationships, and this allows you to quickly find hidden dependencies, which is what we need for auditing access. <br><br>  You can download it on the <a href="https://www.microsoft.com/en-us/download/details.aspx%3Fid%3D45331">official page</a> . <br><br><h3>  MySQL Connector </h3><br>  Go to the <a href="https://dev.mysql.com/downloads/connector/net/">page</a> .  Download and install.  Sometimes you have to restart your PC after installation. <br><br><h3>  Kitty / Putty </h3><br>  To perform SQL queries to the Bitrix database, you will need to configure the tunnel. <br><br><ol><li>  Enter the server IP and port <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.21-24929.png" alt="image"></li><li>  We hammer in login and the password on SSH <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.11-29155.png" alt="image"></li><li>  We do port forwarding: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.11-29289.png" alt="image"></li><li>  We save in the profile the settings made for future uses: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.21-24400.png" alt="image"></li><li>  We start. </li></ol><br>  You can also just download Putty and run it with the command: <br><br><pre><code class="bash hljs">putty.exe -ssh <span class="hljs-string"><span class="hljs-string">"USER@HOST"</span></span> -pw <span class="hljs-string"><span class="hljs-string">"PASSWORD"</span></span> -2 -v -P 22 -L 3306:127.0.0.1:3306</code> </pre> <br>  Naturally, Kitty / Putty should be running before updating data in Power BI. <br><br><h2>  Users and user groups </h2><br>  As in many CMS, Bitrix has a mechanism for differentiating access rights through user groups. <br><br>  Upload the following entities to the Power BI data model from the database: <br><br><ul><li>  Groups </li><li>  Users </li></ul><br>  ... as well as group and user relationships. <br><br><h3>  Groups </h3><br>  We confine ourselves only to active groups. <br><br>  The list of groups is stored in the b_group table. <br><br><ol><li>  Create a connection: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.21-22207.png" alt="image"></li><li>  Enter: <br><br><ol><li>  in the Server field: localhost: 3306 </li><li>  in the Database field: bitrix_db (the name of the database with which Bitrix works) </li><li>  SQL query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, timestamp_x, active, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, description, anonymous <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> b_group <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> active = <span class="hljs-string"><span class="hljs-string">'Y'</span></span>;</code> </pre> <br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.11-32597.png" alt="image"><br></li></ol><br></li><li>  Enter the username and password to the database and send the request: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.11-224.png" alt="image"><br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.11-355.png" alt="image"><br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.11-812.png" alt="image"><br></li><li>  Immediately give a friendly name request: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.21-18432.png" alt="image"></li><li>  We list the groups on a separate sheet in tabular form: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-2562.png" alt="image"><br></li></ol><br>  This method of extracting and presenting data will be similar for other queries related to the Bitrix database. <br><br><h3>  Users </h3><br>  Now unload all users who have extended rights.  But you should not upload users included only in groups that do not give them any additional rights, for example, ‚ÄúAll users, including unregistered ones‚Äù (it is worth noting that the connection of this group with users is stored for all users registered up to version 12. In newer versions, the group is considered to be systemic and no longer stores data about user connections.) <br><br>  We restrict ourselves to activated users. <br><br>  For this you need: <br><br><ol><li>  Select all group IDs that give extended rights.  This is necessary to save on traffic, because  The number of entries in b_user_group can reach millions, depending on the complexity of the project. </li><li>  Create a dynamic request to unload User-Group links </li><li>  Unload users who have a link from item 2. </li></ol><br>  Let's start: <br><br><ol><li>  Call the query editor: Home ‚Üí Edit Queries </li><li>  Create a link to the original request of the ‚ÄúGroup‚Äù: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.21-18742.png" alt="image"></li><li>  Rename the new request to ‚ÄúID groups‚Äù and filter select only those groups that are interesting from a security point of view. <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-5782.png" alt="image"></li><li>  Now we get a string containing the group ID separated by commas: <br><ul><li>  Add a custom column: AddColumn ‚Üí General ‚Üí Custom Column <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-6399.png" alt="image"></li><li>  Delete all columns except ID and Group: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-6647.png" alt="image"></li><li>  Group by ‚ÄúGrouping‚Äù column: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-6804.png" alt="image"><br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-6987.png" alt="image"></li><li>  Add one more column as follows: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-7947.png" alt="image"></li><li>  Let's open the list so that we get the values ‚Äã‚Äãseparated by commas: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-7601.png" alt="image"></li><li>  And fall into the resulting cell: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-8091.png" alt="image"></li><li>  Power BI then converts the query into a variable that can be used in dynamic SQL queries: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-8306.png" alt="image"></li></ul></li><li>  Create a query ‚ÄúUser-group‚Äù, containing the connection of the user with the group, in the same way as it is done in the section ‚ÄúGroups‚Äù. <br><br>  SQL query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ug.user_id, ug.group_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> b_user_group ug <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_group g <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> g.id = ug.group_id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_user u <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> u.id = ug.user_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> g.ACTIVE = <span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> u.ACTIVE = <span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ug.group_id <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ();</code> </pre> <br>  XXX will need to be replaced with group IDs separated by commas. <br></li><li>  Let's call the source code of the request for editing and replace it with the following: <br><br><pre> <code class="plaintext hljs">let sql = "SELECT ug.user_id, ug.group_id #(lf)FROM b_user_group ug #(lf)JOIN b_group g ON g.id = ug.group_id #(lf)JOIN b_user u ON u.id = ug.user_id #(lf)WHERE g.ACTIVE = 'Y' #(lf) AND u.ACTIVE = 'Y' #(lf) AND ug.group_id IN ("&amp;#"ID "&amp;");", Source = MySQL.Database("localhost:3306", "bitrix_db", [ReturnSingleDatabase=true, Query=sql, CreateNavigationProperties=false]) in Source</code> </pre> <br></li><li>  After that you can get the following warning: <br><br><pre> <code class="plaintext hljs">Formula.Firewall: Query '-' (step 'Source') references other queries or steps, so it may not directly access a data source. Please rebuild this data combination.</code> </pre> <br>  To get rid of it, you need to change the privacy level: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-11330.png" alt="image"><br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.21-19190.png" alt="image"><br><br>  After that, refresh requests. </li><li>  We make the variable ‚ÄúUser IDs‚Äù in the same way as it was done for ‚ÄúID groups‚Äù (that is, we make a link from the request Users, etc.).  With its help, we will generate a SQL query that will allow you to select only the users you need to analyze.  Pre-remove duplicate user_id: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-12072.png" alt="image"></li><li>  Create a request to select users, in the same way as it was done for the ‚ÄúUser-group‚Äù. <br><br><pre> <code class="sql hljs">SQL: <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, last_name, <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>, email, date_register, last_login <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> b_user <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> active = <span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ( );</code> </pre> <br>  XXX will need to replace user IDs. <br></li></ol><br><h3>  Configuring the relationship between requests </h3><br>  In order for Power BI to interactively filter data in different views, you must define the relationships between queries.  In our case, we need to link the fields: <br><br><ul><li>  ‚ÄúUser-Group‚Äù [group_id] ‚Üí ‚ÄúGroups‚Äù [id] </li><li>  ‚ÄúUser-group‚Äù [user_id] ‚Üí ‚ÄúUsers‚Äù [id] </li></ul><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-14028.png" alt="image"><br><br>  Similarly, we will link other queries. <br><br><h3>  Report on users and user groups </h3><br>  On the Reports tab, we will display a list of users and groups using the Table as the visualization element. <br><br>  From the query ‚ÄúUsers‚Äù select the fields: last_name, name, last_login, email. <br>  From the query ‚ÄúUser-group‚Äù select the field group_id. <br>  Because  we assigned links between queries, then Power BI will be able to correctly use the aggregate Count function to count the number of groups that each individual user belongs to. <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-23646.png" alt="image"><br><br>  Add another Table next to it and select the name field from the ‚ÄúGroup‚Äù request, and from the ‚ÄúUser-group‚Äù request the user_id field - set the ‚ÄúCount (Distinct)‚Äù aggregation for it to see the number of users in the group. <br><br>  Because  ‚ÄúGroup‚Äù and ‚ÄúUser‚Äù queries are connected through the ‚ÄúUser-group‚Äù associative query, then when you click on a user in the table, only those groups that include the selected user are displayed in the table with a list of groups.  And vice versa. <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-24194.png" alt="image"><br><br>  In this way, you can either click each user and see which groups he belongs to, or click on the groups and see which users belong to the group.  Well, and then make decisions regarding changes in access for the user. <br><br>  The following describes how to place the remaining tables in the overall Power BI report, since  this is done in a similar way. <br><br><h2>  .access.php </h2><br>  In Bitrix, it is possible to set access to folders and files by specifying group numbers and the required access level in the .access.php files. <br><br>  Our task is to bring the data from all .access.php files scattered across the project server into a tabular view. <br><br>  For this: <br><br><ol><li>  We search and archive all .access.php files from the server, saving paths to these files. <br>  I used terminalku to search, copy and archive files found.  Command example: <br><br><pre> <code class="bash hljs">find ‚ÄúBITRIX_PROJECT_DIR‚Äù -name <span class="hljs-string"><span class="hljs-string">'.access.php'</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> f &gt; ‚ÄúOUTPUT_DIR/.access.php.files.txt‚Äù&amp;&amp;tar cvfpz ‚ÄúOUTPUT_DIR/.access.php.files.tar‚Äù -T ‚ÄúOUTPUT_DIR/.access.php.files.txt‚Äù&amp;&amp;find ‚ÄúOUTPUT_DIR‚Äù -<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> d -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> chmod 775 {} \; &amp;&amp; find ‚ÄúOUTPUT_DIR‚Äù -<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> f -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> chmod 775 {} \;&amp;&amp;find ‚ÄúOUTPUT_DIR‚Äù -<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> d -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> chown bitrix:bitrix {} \; &amp;&amp; find ‚ÄúOUTPUT_DIR‚Äù/ -<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> f -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> chown bitrix:bitrix {} \;</code> </pre> <br>  Here: <br><br><ul><li>  BITRIX_PROJECT_DIR - folder with the project on Bitrix. </li><li>  OUTPUT_DIR - path to the folder where the .access.php.files.txt file will be placed with the list of found .access.php files, as well as the .access.php.files.tar archive containing copies of all found .access.php files. </li></ul><br>  Naturally, if there are a lot of projects (multisite is used), then we select a folder containing all the projects. </li><li>  Download and unpack the archive with .access.php somewhere near the Power BI project. <br>  I wrote a batch file that does this automatically: download is implemented via wget;  through 7zip - unzipping. <br><br>  Sample batch file: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-27936.png" alt="image"><br><br>  File containing settings for batch file: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-28309.png" alt="image"><br></li></ol><br>  Now create a request that will reduce the contents of all .access.php in a table form. <br><br><ol><li>  For convenience, create a parameter that will contain the path to the folder from which we will extract the contents of all .access.php <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-29768.png" alt="image"></li><li>  Select a query of the ‚ÄúFolder‚Äù type and select our parameter as the path: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-30043.png" alt="image"></li><li>  Expand the Content field: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-3956.png" alt="image"><br><br>   - this is a column delimiter, you need to have one column after importing data from all files. </li><li>  After that, Power BI will remove the column we need containing the path to .access.php.  Therefore, we need to edit the ‚ÄúRemove other columns1‚Äù step by selecting the ‚ÄúFolder Path‚Äù in it: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-2519.png" alt="image"></li><li>  We leave the column: Folder Path and Column1. </li><li>  To remove the absolute path to the local file from the Folder Path, use the replacement: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-32195.png" alt="image"></li><li>  The .access.php files contain access settings in the format: <br><br><pre> <code class="php hljs">$PERM[<span class="hljs-string"><span class="hljs-string">""</span></span>][<span class="hljs-string"><span class="hljs-string">"ID "</span></span>] = <span class="hljs-string"><span class="hljs-string">"&lt; &gt;"</span></span>;</code> </pre> <br>  Our task is to scatter the columns: Path, group ID, Access level.  This is done with the help of filters, Split Column and Custom column. </li><li>  The result should be the following table: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-7888.png" alt="image"><br><br>  As you can see in the group ID field there is a ‚Äú*‚Äù (access for all).  In order to be able to specify a connection with other queries, we need to make this field integer, while not losing information about ‚Äú*‚Äù (which means for all groups).  We make two requests, such as a ‚Äúlink‚Äù to the original DotAccessPhp request: <br><br><ul><li>  The first DotAccessPhpForRels will contain only integer group IDs (using a filter, removing * in the group ID column) - we will link it with the other requests: <br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-10824.png" alt="image"></li><li>  The second is DotAccessPhpForAll - only * (we use a filter). </li></ul></li></ol><br>  Relationship scheme: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-11242.png" alt="image"><br><br>  To select only the related data in other views when selecting a file from DotAccessForRels, you need to change the ‚ÄúCross filter direction‚Äù parameter to Both: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-13400.png" alt="image"><br><br>  For other requests that will be added below, this also needs to be done. <br><br><h2>  Info blocks </h2><br>  It is necessary to upload the list of info-blocks and the table of links between info-blocks and groups. <br><br>  We will upload information only about active info-blocks. <br><br><ol><li>  Create a query ‚ÄúInfo Blocks‚Äù.  SQL query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> i.id, i.NAME <span class="hljs-string"><span class="hljs-string">''</span></span>, i.TIMESTAMP_X <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GROUP_CONCAT</span></span>(ist.SITE_ID SEPARATOR <span class="hljs-string"><span class="hljs-string">', '</span></span>) <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> b_iblock i <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_iblock_site ist <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ist.IBLOCK_ID = i.id <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>;   ‚Äú-‚Äù: <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ig.iblock_id, ig.group_id, ig.permission <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> b_iblock_group ig <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_group g <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> g.id = ig.group_id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_iblock i <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> i.ID = ig.IBLOCK_ID <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> g.ACTIVE = <span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> i.ACTIVE = <span class="hljs-string"><span class="hljs-string">'Y'</span></span>;</code> </pre> </li><li>  We update the linking scheme, not forgetting to change the ‚ÄúCross filter direction‚Äù parameter on Both: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-31351.png" alt="image"></li></ol><br><h2>  Forms </h2><br>  In the case of forms, rights for user groups are issued both on the forms themselves and on the statuses in which the result of filling in the form resides. <br><br><ol><li>  Create a form request: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> f.ID, f.name <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GROUP_CONCAT</span></span>(f2s.SITE_ID SEPARATOR <span class="hljs-string"><span class="hljs-string">', '</span></span>) <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> b_form f <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_form_2_site f2s <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> f2s.FORM_ID = f.ID <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>;</code> </pre> </li><li>  Create a query ‚ÄúForm-group‚Äù: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> f2g.group_id, f2g.form_id, f2g.PERMISSION <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> b_form_2_site f2s <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_form_2_group f2g <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> f2g.FORM_ID = f2s.FORM_ID <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_group g <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> g.ID = f2g.group_ID <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> g.ACTIVE = <span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>;</code> </pre> </li><li>  Create a query ‚ÄúStatus Forms‚Äù. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> fs.ID, fs.TITLE <span class="hljs-string"><span class="hljs-string">''</span></span>, fs.form_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> b_form_status fs <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_form f <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> f.ID = fs.FORM_ID <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> fs.ACTIVE = <span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> f2s.FORM_ID <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> b_form_2_site f2s <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> f2s.FORM_ID = f.ID <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>;</code> </pre> </li><li>  Create a request ‚ÄúStatuses form group‚Äù <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> fs2g.status_id, fs2g.group_id, fs2g.PERMISSION <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> b_form_status_2_group fs2g <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_form_status fs <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fs.ID = fs2g.STATUS_ID <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_group g <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> g.ID = fs2g.group_ID <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_form f <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> f.ID = fs2g.GROUP_ID <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_form_2_site f2s <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> f2s.FORM_ID = f.ID <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> fs.ACTIVE = <span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (g.ACTIVE = <span class="hljs-string"><span class="hljs-string">'Y'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>;</code> </pre> </li><li>  We update the link scheme: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.18-25734.png" alt="image"></li></ol><br><h2>  Modules </h2><br><ol><li>  Create a query ‚ÄúModule-group‚Äù. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> mg.MODULE_ID <span class="hljs-string"><span class="hljs-string">''</span></span>, mg.group_id, mg.G_ACCESS <span class="hljs-string"><span class="hljs-string">''</span></span>, t.LETTER, t.NAME <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> b_module_group mg <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_group g <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> g.id = mg.GROUP_ID <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_task t <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t.MODULE_ID = mg.MODULE_ID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t.BINDING = <span class="hljs-string"><span class="hljs-string">'module'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> g.active = <span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> mg.G_ACCESS = t.LETTER;</code> </pre> </li><li>  Updating links: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.20-998.png" alt="image"></li></ol><br><h2>  Scoreboard </h2><br>  Customize table styles, use the usable space to the maximum. <br><br>  The result should be something similar to the following: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.18-28241.png" alt="image"><br><br>  Slightly modified board (number of elements in the tables): <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.20-1923.png" alt="image"><br><br>  By the way, it is convenient to first set up the appearance of one table, and then simply apply its view to other tables using Home ‚Üí Format Painter.  This function works the same way as in Word and Excel (Format on a sample). <br><br><h2>  Links to admin panel </h2><br>  So that you can quickly go to the site and make settings in the admin panel, you can add a custom column in the DAX language and make it ‚ÄúWeb URL‚Äù type.  To do this, select the created column and assign the appropriate type (Modeling ‚Üí Properties ‚Üí Data Category ‚Üí Web URL). <br><br>  Example for group request: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.19-196.png" alt="image"><br><br>  Add a column to the view: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.19-866.png" alt="image"><br>  Now you can simply click on the table cell and go to the group card in the Bitrix admin panel. <br><br><h2>  Report ‚ÄúFiles‚Äù </h2><br>  For convenience, you can make a separate report by placing on it tables relating to access to files and sections of an Internet resource: <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.20-30194.png" alt="image"><br><br>  This report also added links to edit all .access.php directly through the Bitrix admin panel. <br><br><h2>  Results </h2><br>  Bitrix is ‚Äã‚Äãa champion among cms monsters with obvious pros and cons, beautiful on the outside and terrible on the inside.  It does not have convenient access administration tools.  But this problem has been solved with the help of free tools, without involving valuable programmers in this process. <br><br>  The advantages of this approach also include the ability to quickly supplement the model in Power BI with additional information from Bitrix, for example, someone wants to know when .access.php and others were created or modified. <br><br>  Now, after building the model of access rights and its visualization in Power BI, it is enough: <br><br><ol><li>  sequentially click on users, groups, forms, files, and in real time to see all connections related to access; </li><li>  go quickly to the necessary admin pages to make edits; </li><li>  Update your data model with actual data from Bitrix directly into Power BI. </li></ol><br>  As a result, an audit was conducted and an adjustment was made in user access. <br><br>  PS In the marketplace there is a free module ‚ÄúAccess Control Center‚Äù, but it is very limited, and the last commentary is more than 5 years old.  Maybe someone will like the idea of ‚Äã‚Äãbuilding such a dashboard right in Bitrix and it implements it as a module ... <br><br>  PS2.  If anyone is interested in the topic of using Power BI to solve problems of finding hidden dependencies in different accounting systems, please write in the comments.  I will then write a few more articles on this topic. <br><br>  PS3.  Thanks to my colleagues for help in preparing this article: Alexander Voronkov, Yevgeny Shapochkin, Alexei Titov. </div><p>Source: <a href="https://habr.com/ru/post/457626/">https://habr.com/ru/post/457626/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../457616/index.html">My ‚ÄúWow, I didn't know that!‚Äù Moments with Jest</a></li>
<li><a href="../457618/index.html">Being a contemporary full-developer</a></li>
<li><a href="../45762/index.html">The golden era of Linux?</a></li>
<li><a href="../457622/index.html">Measuring Qt performance</a></li>
<li><a href="../457624/index.html">As we broke an old shack and built a skyscraper in its place</a></li>
<li><a href="../457628/index.html">Effective management of programs and projects using the P2M methodology</a></li>
<li><a href="../45763/index.html">Developer ammunition. Latest news.</a></li>
<li><a href="../457630/index.html">Experience in developing the requirements for a professional data scientist</a></li>
<li><a href="../457632/index.html">How much do unit tests cost?</a></li>
<li><a href="../457634/index.html">DDS Synthesizer on Verilog</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>