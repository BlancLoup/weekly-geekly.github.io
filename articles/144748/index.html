<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Android + Arduino + 4 wheels. Part 3 - Video and Audio Transmission</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Finally, moving forward. Everything, now house do not dare to call the robot Mitya "the radio-controlled machine"! 

 It turned out to be difficult to...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Android + Arduino + 4 wheels. Part 3 - Video and Audio Transmission</h1><div class="post__text post__text-html js-mediator-article">  Finally, moving forward.  Everything, now house do not dare to call the robot Mitya "the radio-controlled machine"! <br><br>  It turned out to be difficult to find a relatively easy and working way to transfer video and audio streams from an Android gadget to a remote control application on a PC.  Without this step, I categorically did not want to move on, so for quite a long time I was stuck in my stubbornness. <br><a name="habracut"></a><br><br>  Many thanks to all who helped me, without help I would not have mastered this puzzle.  Correspondence with like-minded people brought me to very pleasant and interesting people, I somehow did not consider this side of the hobby before.  It turned out the robot Mitya helped me find people close in spirit.  And it was a completely unexpected bonus for me.  Perhaps this is the main "profit" hobby?  Only now I realized that communication is more important to me than just ‚Äúhandicraft‚Äù.  Why is all this necessary, if not with whom to share, consult, boast? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I will wrap up with so beloved lyric component.  This article is a continuation of the story about the robot Mitya.  In the <a href="http://habrahabr.ru/post/135043/">first part</a> I described how I built my robot, in the <a href="http://habrahabr.ru/post/139304/">second I</a> described what it would take to program it.  In this article I will focus on the issue of video and sound transmission from the robot to the operator.  I will not repeat here about the project in general and its software architecture in particular - these issues are described in detail in the first part. <br><br>  The most exciting question: what is the result, how much will the picture and sound slow down?  Here is my video response: <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/06m8zcBzuus%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700190,15700253,15700256,15700259&amp;usg=ALkJrhhRjZXFcYLZDF3Uk9uLfAoO0KD8Ow" frameborder="0" allowfullscreen=""></iframe><br><br>  I apologize for the tips, but I definitely needed to demonstrate both the original sound and the sound reproduced on the PC.  The delay, of course, is.  Moreover, when playing, the sound is a little behind the picture.  The video lags slightly behind reality (after all, it‚Äôs necessary to take into account that this is not an analog system, and it‚Äôs the phone that runs the power, though powerful).  I tried to control the robot, and I did not experience discomfort with such a delay.  So I was completely satisfied with the result - with a slight lag of sound, I am quite ready to accept it. <br><br>  The quality of the picture displayed by the operator corresponds to what the front-facing camera on HTC Sensation is capable of.  I could use the main camera, but then I would have to abandon Miti's mimicry, and I can't go for that. <br><br>  For ease of navigation I will give a plan for the further content of the article: <br>  1. The <a href="https://habr.com/ru/post/144748/">evolution of the solution (only for the curious)</a> <br>  2. <a href="https://habr.com/ru/post/144748/">IP Webcam</a> <br>  3. <a href="https://habr.com/ru/post/144748/">Video playback in a Windows application</a> <br>  4. <a href="https://habr.com/ru/post/144748/">Playback sound in a Windows application</a> <br>  5. <a href="https://habr.com/ru/post/144748/">Summary</a> <br><br><a name="1"></a><h4>  Solution evolution (curious only) </h4><br>  So that I am not accused of ‚Äúmulti-lettering‚Äù I propose a compromise: people are curious, or sympathizing with the project, or simply compassionate (it‚Äôs not for nothing that I wrote all this) can read how I got out and what solutions I found and discarded. <br><br>  But seriously, I want to share, whenever possible, all the acquired experience, because I am sure that value is not only a positive experience, but also a negative one.  What if there are people who can learn from the mistakes of others?  In addition, I would be very grateful if someone found or showed a way out of the dead ends that I met.  And then it would be an exchange of experience. <br><br>  In this section, I am writing about dead ends.  If you are just looking for a recipe for transferring video and sound from a robot to a PC, you can skip to the next section. <br><br>  The idea was simple: to embed code that implements the translation of video and audio streams to the level of an Android application, and to embed code that receives and reproduces these streams to the Windows-level management application. <br><br>  I dismissed all kinds of ‚Äúknee‚Äù solutions using ready-made, non-integrable products into my code right away - ugly. <br><br>  I started with the video.  And for some reason he was deeply convinced that there would be no problems with the formation and translation of the video stream.  XXI century after all, someone already has four-core smartphones ... But no.  Despite the fact that each phone on board has two cameras, it is not so easy to make a webcam out of the phone.  Surprisingly, there are no ready-made software tools built into Android to solve this problem.  I don‚Äôt know what is the reason, as this task is not a problem for phone manufacturers, but I suspect that everything is explained by the complexity of certification in some countries of devices with such software.  Suddenly this is spyware?  This is the only explanation I could come up with.  But Mitya rings so like motors that a spy from him, like a balloon from a hippopotamus.  Therefore, conscience with insomnia does not torment me. <br><br>  Digging up google, code.google, stackoverflow, android developers and all-all-all, I found some very interesting, but I have not brought anywhere, solutions.  And I spent a lot of time on them.  In any case, I will describe them and why I refused each of them.  Experience may be helpful.  For some problems, these solutions are quite suitable, but I did not make friends with them.  I will omit the most dead-end options.  Leave only those who have a chance. <br><br>  Option one: use the MediaRecorder class, which is part of Android.  I had thought that this was the solution to all my problems - here both video and audio.  At the output, I will receive a 3gp stream, transfer it via UDP to PC.  But alas.  MediaRecorder will not work with streams so easily - it can only with files.  Googling, I found a very interesting <a href="https://groups.google.com/d/topic/android-developers/FiZZSXEFhd0/discussion">discussion</a> on the <a href="https://groups.google.com/forum/">groups.google.com</a> forum.  A similar problem was discussed here, and during its discussion a link to another interesting <a href="http://www.mattakis.com/blog/kisg/20090708/broadcasting-video-with-android-without-writing-to-the-file-system">post</a> came <a href="http://www.mattakis.com/blog/kisg/20090708/broadcasting-video-with-android-without-writing-to-the-file-system">up</a> .  It describes a sort of "hack", how to deceive MediaRecorder, so that he thinks he is working with the file, and actually slip him to write the output stream to the socket.  I will not repeat the implementation description, everything is written there.  This option is quite satisfied with the discussion participants.  The task was to record video from the phone to a file on a remote computer, bypassing the phone's memory card.  It was in the file - by studying this option deeper, I was convinced that it is not suitable for webcasting.  The fact is that MediaRecorder on my device works as follows: when a video recording starts, a file is created and a space is reserved in its head for recording the size of the stream.  This field is filled only upon completion of the video.  And for this, the output stream of MediaPlayer must support positioning (Seek operation).  A file stream, for example, is capable of this, and when broadcasting over a network, the stream, naturally, is strictly sequential and will not jump to its beginning to fill the field with the final size.  But the guys had a task to write to a file on a remote computer.  Therefore, they first "merged" their stream into a file, and then opened this file for writing and entered its size in the right place.  After that, such a file could already be played with anything. <br><br>  The task in my project is different: I do not have a moment to complete the recording.  And I can not determine the size of the video stream.  Those.  MediaPlayer output stream is not intended for webcast.  At least on my machine.  This option had to be thrown away. <br><br>  Well, I decided to try to do everything myself.  Android provides the ability to get raw footage from the camera of the device.  This function is described perfectly everywhere, the Internet is filled with examples of converting the received stream with a frame from the device‚Äôs camera to a jpeg-file and saving this file to a memory card.  In my case, the stream of jpeg-frames could be driven over UDP on a PC.  But what if the stream is broken (after all, this is UDP)?  It is necessary to somehow separate the frames with labels or use the jpeg header for this.  On the PC, you have to somehow extract the frames from the stream.  All this is somehow low-level, and therefore I did not like it at all.  Definitely need to use a ready-made codec.  And it would be great to use some standard media protocol.  And I began to collect information in this direction.  So the second option was dropped without being born and the third one appeared: use ffmpeg. <br><br>  ffmpeg is deservedly the most popular and popular product in this area.  Thanks to the developed community, it is quite possible to rely on it, and I decided that I decided on the direction of further work.  And then I suspended for two months.  It turns out, ffmpeg for Android will have to compile yourself.  At the same time, you will have to get acquainted with the Android NDK, since ffmpeg is written in C. Building ffmpeg for Android is extremely difficult in Windows.  ‚ÄúEmbarrassing‚Äù is not entirely sincere, in fact I have not met a single mention of a successful compilation in Windows.  There are a lot of questions on this topic, but they are recommended to deploy Linux in all forums in one voice.  Now, perhaps, the situation has changed: here is the <a href="http://dmitrydzz-hobby.blogspot.com/2012/04/ffmpeg-android.html%3FshowComment%3D1336384545529">question</a> for the article on my blog and my answer.  I had no experience with using Linux.  But I was curious about what kind of beast Linux was, I had to <a href="http://dmitrydzz-hobby.blogspot.com/2012/03/ubuntu.html">install Ubuntu</a> .  It turned out further that there is no actual information on the compilation of ffmpeg on the Internet.  Having suffered a lot, he managed to collect the coveted ffmpeg.  I <a href="http://dmitrydzz-hobby.blogspot.com/2012/04/ffmpeg-android.html">described the</a> assembly process in some <a href="http://dmitrydzz-hobby.blogspot.com/2012/04/ffmpeg-android.html">detail</a> in my blog. <br><br>  By this time, Mitya had long been gathering dust in the corner, abandoned and forgotten.  And in front of me loomed only new and completely bleak battles with the Android NDK, the complete lack of API documentation for ffmpeg, immersion in the mysteries of codecs and compiling ffserver (this is a streaming video server, part of the ffmpeg project).  With the help of ffserver, you can organize the broadcast of video and audio from the robot to any PC on the network.  My friends already thought that I had burned out with robotics, and I cried, injected, but continued to gnaw ffmpeg granite.  Not sure that I could go this way to the end. <br><br>  And then help came to me.  Remember I talked about the wonderful like-minded people with whom I shared a common hobby?  I must say that the robot Mitya was not alone by this moment.  In another city, he already appeared outwardly very similar, but internally in some places it was different and sometimes even for the better, a twin brother.  I correspond with <a href="https://geektimes.ru/users/luke_skypewalker/" class="user_link">Luke_Skypewalker</a> - the author of this robot.  In the next letter from him I see a tip to see an application for Android, called <a href="http://ip-webcam.appspot.com/">IP Webcam</a> .  I also find out that this application transmits HTTP video and sound from an Android device, has an API and can work in the background! <br><br>  I must admit that after the publication of the first part of the article about the robot Mityu, on the project site I received a <a href="http://code.google.com/p/robot-mitya/wiki/MyPlans%3Fts%3D1337277257%26updated%3DMyPlans">comment</a> from the user kib.demon with the advice to take a closer look at IP Webcam.  I looked, but I didn‚Äôt see the main thing - the fact that this application has a software API.  I thought that the application that implements the webcam itself does not need me and quickly forgot about its existence.  And there was also a <a href="http://habrahabr.ru/post/135043/">comment</a> on the article itself.  There was no information about the API, and I missed it too.  This mistake cost Mit√© three months in the corner. <br><br>  I do not think that I was in vain so much digging with ffmpeg.  After my posts (there was also an English version), they send me a lot of questions, apparently taking me for an expert in this field.  I try to respond to the best of my knowledge, but most of the questions still hang in the air.  The topic is still relevant.  I would be very happy if someone continued this work and described it.  Still, on the Internet, almost nothing about the software interaction with ffmpeg.  And that is, out of date for several years.  Thanks to the use of decent codecs, ffmpeg can allow a maximum of video to be squeezed out of a minimum of traffic.  For many projects this will be very useful. <br><br><a name="2"></a><h4>  Ip webcam </h4><br>  So, I decided on the level of the Android part of the robot Mitya: the <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.pas.webcam%26feature%3Dsearch_result">IP Webcam</a> application will be used to broadcast video and audio. <br>  On <a href="http://ip-webcam.appspot.com/">the developer‚Äôs website</a> there is a page describing the functions available in the API.  You can also download the source code of a tiny Android project that demonstrates how to programmatically interact with IP Webcam. <br><br>  Actually, here is the key part of this example: <br><br><pre><code class="java hljs">Intent launcher = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent().setAction(Intent.ACTION_MAIN).addCategory(Intent.CATEGORY_HOME); Intent ipwebcam = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent() .setClassName(<span class="hljs-string"><span class="hljs-string">"com.pas.webcam"</span></span>, <span class="hljs-string"><span class="hljs-string">"com.pas.webcam.Rolling"</span></span>) .putExtra(<span class="hljs-string"><span class="hljs-string">"cheats"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[] { <span class="hljs-string"><span class="hljs-string">"set(Photo,1024,768)"</span></span>, <span class="hljs-comment"><span class="hljs-comment">// set photo resolution to 1024x768 "set(DisableVideo,true)", // Disable video streaming (only photo and immediate photo) "reset(Port)", // Use default port 8080 "set(HtmlPath,/sdcard/html/)", // Override server pages with ones in this directory }) .putExtra("hidebtn1", true) // Hide help button .putExtra("caption2", "Run in background") // Change caption on "Actions..." .putExtra("intent2", launcher) // And give button another purpose .putExtra("returnto", new Intent().setClassName(ApiTest.this,ApiTest.class.getName())); // Set activity to return to startActivity(ipwebcam);</span></span></code> </pre> <br>  It is remarkable that you can control the orientation of the broadcast video, its resolution, picture quality.  You can switch between the rear and front cameras, turn the flash LEDs off.  All this can be controlled in the settings before launching the broadcast or programmatically using the cheat codes given by the author of the project, as <br>  This is shown in the example. <br><br>  A little distracted: unfortunately with a flash (Mitya's headlight) I have a puncture.  This does not apply to IP Webcam.  I have already encountered this problem in my code earlier.  On my device, if you activate the front camera, you can no longer control the flash.  I suspect it's not just HTC Sensation. <br><br>  In the IP Webcam application after the start of the video broadcast, the video from the active camera starts to be displayed on the screen.  Above the video, two customizable buttons are displayed.  By default, one initiates a dialog with help, and the second opens a menu of available actions.  In the example, the author hides the first button, and the second sets up to translate the application in the background. <br><br>  You can check audio / video broadcasting, for example, in a browser or in the <a href="http://www.videolan.org/vlc/">VLC media player</a> application.  After launching the IP Webcam broadcast in the browser at http: // &lt;IP phone&gt;: &lt;port&gt;, the ‚ÄúSmartphone Camera Service‚Äù becomes available.  Here you can view individual frames, play video and sound.  To view a video stream, for example, in the VLC media player you need to open the URL http: // &lt;phone IP&gt;: &lt;port&gt; / videofeed.  Two URLs are available for audio playback: http: // &lt;ip phone&gt;: &lt;port&gt; /audio.wav and http: // &lt;ip phone&gt;: &lt;port&gt; /audio.ogg.  There is a significant delay in sound, but as it turned out later, this is due to caching during playback.  In the VLC media player, you can set caching to 20 ms and the lag will become insignificant. <br><br>  It was good news, but now bad: I, of course, found difficulties.  On my device in the background, IP Webcam stopped streaming video.  I read the comments on Google Play and found that this happens to all the lucky ones with the 4th Android.  About the 3rd I do not know.  And just before the ‚Äúdiscovery‚Äù of IP Webcam, I updated the Android version from 2.3.4 to 4.0.3.  The impossibility of the background work was fatal, because I could not leave the activating, broadcasting video working on top, opening up my activity with the face of Mitya, and also controlling it.  The activation of the face brought the IP Webcam activations into the background and the broadcast stopped.  Yes, I could organize that part of the application that controlled the robot as a service, but what about Mitya‚Äôs face? <br><br>  Not finding a way out by myself, I decided to write a letter to the author of the IP Webcam project.  The author "our", in the sense of writing, you can write in Russian.  Three things bothered me: <br><br><ol><li>  Stop broadcasting in the background. </li><li>  Sound lag from the picture. </li><li>  Incorrectly displayed the phone's IP address in IP Webcam.  This is not critical, but at first confusing.  Although this is nonsense, here the only question is the incorrect text on the phone screen. </li></ol><br>  I have to thank the author of IP Webcam (Pavel Khlebovich).  Another great acquaintance.  In the course of the correspondence, which we started, he not only answered all my questions, but also sent another demo project, which shows how to get out with the background mode and my Android 4.0.3. <br><br>  Most of all, of course, I was worried about the first two questions.  For the second, Pavel told me everything about audio caching in the browser and the VLC media player. <br><br>  But he wrote to me on the first question: ‚ÄúIt seems that all 4.x phones already use the V4L driver, which does not allow capturing video without a surface for displaying it.  Therefore, the video does not work in the background.  As a workaround, you can try to make your own on top of my Activity, describe it as translucent, so that the IP Webcam surface is not destroyed, but actually make it opaque and show what you need. ‚Äù <br><br>  It seems to be understandable, but how can one open one activity on the other and that both work?  I thought only one activation can be active at a time (sorry for the pun).  Conducted several experiments, but the "lower" activity always worked onPause.  Pavel helped again: he made a <a href="http://code.google.com/p/robot-mitya/downloads/detail%3Fname%3DIPWebcamVsAndroid4.zip">demo project</a> for me.  Surprisingly, the idea of ‚Äã‚Äãplacing one activity on top of another works!  I finished Paul's demo project a little bit (cosmetically) and uploaded Mitya's robot to the site. <br><br>  I will describe what has been done in this demonstration. <br><br>  1. Button1 is added to the layout of the main activity. <br>  2. Added another layout ‚Äúimageoverlay.xml‚Äù with the image ‚Äúsome_picture.png‚Äù.  There is nothing more in it. <br>  3. Added OverlayActivity.java, which displays imageoverlay.xml content.  It is this activity that will be displayed over the IP Webcam video.  In my main project at this place will be activating, controlling the robot.  She is Mitya's face. <br>  4. The following should be added to the manifest: <br><br>  a) Description OverlayActivity: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">activity</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"OverlayActivity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:launchMode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"singleInstance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:theme</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@android:style/Theme.Dialog"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">activity</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  The launchMode and theme attributes must be filled with the specified values. <br><br>  b) Rights for accessing the device camera: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.CAMERA"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre><br>  5. Supplement MainActivity.java: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> ru.ipwebcam.android4.demo; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.app.Activity; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.content.Intent; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.os.Bundle; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.os.Handler; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.util.Log; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.view.View; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.view.View.OnClickListener; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.widget.Button; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Activity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> String TAG = <span class="hljs-string"><span class="hljs-string">"IP Webcam demo"</span></span>; Handler h = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Handler(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setContentView(R.layout.main); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Button videoButton = (Button)findViewById(R.id.button1); videoButton.setOnClickListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OnClickListener() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View v)</span></span></span><span class="hljs-function"> </span></span>{ Intent launcher = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent().setAction(Intent.ACTION_MAIN).addCategory(Intent.CATEGORY_HOME); Intent ipwebcam = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent() .setClassName(<span class="hljs-string"><span class="hljs-string">"com.pas.webcam"</span></span>, <span class="hljs-string"><span class="hljs-string">"com.pas.webcam.Rolling"</span></span>) .putExtra(<span class="hljs-string"><span class="hljs-string">"hidebtn1"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) <span class="hljs-comment"><span class="hljs-comment">// Hide help button .putExtra("caption2", "Run in background") // Change caption on "Actions..." .putExtra("intent2", launcher); // And give button another purpose h.postDelayed(new Runnable() { public void run() { startActivity(new Intent(MainActivity.this, OverlayActivity.class)); Log.i(TAG, "OverlayActivity started"); } }, 4000); startActivityForResult(ipwebcam, 1); h.postDelayed(new Runnable() { public void run() { sendBroadcast(new Intent("com.pas.webcam.CONTROL").putExtra("action", "stop")); Log.i(TAG, "Video is stopped"); } }, 20000); Log.i(TAG, "Video is started"); } }); } }</span></span></code> </pre><br>  By clicking on the button, IP Webcam is launched, then after 4 seconds our activation with a picture opens on top of it.  The image size is specifically made smaller than the screen resolution (at least for HTC Sensation) so that both activations can be seen.  And 20 seconds after launch, the work of IP Webcam in the background stops, but our "main" activation continues to work. <br><br>  Here‚Äôs how it looks on the phone: <br><br><img src="https://habrastorage.org/storage2/921/fcc/c37/921fccc375884354870eba7810776a00.png" alt="Me and Rob Mitya"><br><br>  Then I had to change the Android application Mitya very slightly, and I could already see it with a camera and hear it with a microphone in a browser on a PC. <br><br><a name="3"></a><h4>  Play video in a Windows application </h4><br>  I did not think about it before, but only at this stage I realized that the video from IP Webcam is not exactly video.  This is <a href="http://ru.wikipedia.org/wiki/MJPG">MJPEG</a> .  Those.  The stream is a sequential transmission of frames in JPEG format.  I am quite weak in matters related to video transmission, so I did not expect agility from MJPEG.  And in vain - the result completely suited me. <br><br>  To play the MJPEG stream, I found the wonderful free product <a href="http://channel9.msdn.com/coding4fun/articles/MJPEG-Decoder">MJPEG Decoder</a> .  Finding a tool for displaying MJPEG was complicated by the fact that the Windows application that runs Mitya uses the XNA framework.  MJPEG Decoder supports XNA 4.0, and it also works with WinForms, WPF, Silverlight and Windows Phone 7 applications. <br><br>  Mitya's source code is still open, but there are a lot of things there, so here I will give my demo example of using MJPEG Decoder in an XNA application for playing a video stream from IP Webcam.  And in the next section, I will supplement this example with code for playing audio from IP Webcam. <br><br>  So, create a Windows Game (4.0) project.  In the links of this project, we add the library ‚ÄúMjpegProcessorXna4‚Äù (download it from <a href="http://mjpeg.codeplex.com/releases/view/65863">the project site</a> or from <a href="http://code.google.com/p/robot-mitya/downloads/detail%3Fname%3DMJPEG_bin.zip">me</a> ). <br><br>  In the Game1.cs file, we declare the use of the MjpegProcessor namespace: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> MjpegProcessor;</code> </pre><br>  Declare the mjpeg private field: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MjpegDecoder mjpeg;</code> </pre><br>  Declare texture for video output: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Texture2D videoTexture;</code> </pre><br>  We supplement the Initialize method: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mjpeg = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MjpegDecoder();</code> </pre><br>  Supplement the Update method: <br>  1. By pressing the spacebar, start the playback of the video stream: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mjpeg.ParseStream(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(<span class="hljs-string"><span class="hljs-string">@"http://192.168.1.40/videofeed"</span></span>));</code> </pre><br>  2. By pressing Esc, we stop playback: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mjpeg.StopStream();</code> </pre><br>  3. Accept the next frame when you call Update: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.videoTexture = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mjpeg.GetMjpegFrame(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GraphicsDevice);</code> </pre><br>  We supplement the Draw method: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.videoTexture != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.spriteBatch.Begin(); Rectangle rectangle = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Rectangle( <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.graphics.PreferredBackBufferWidth, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.graphics.PreferredBackBufferHeight); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.spriteBatch.Draw(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.videoTexture, rectangle, Color.White); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.spriteBatch.End(); }</code> </pre><br>  That's almost all.  Almost, because everything is already working, but frames during playback I change very rarely.  I have every 1-2 seconds.  To fix this, it remains to correct the class constructor as follows: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Game1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.IsFixedTimeStep = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.graphics = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GraphicsDeviceManager(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.graphics.SynchronizeWithVerticalRetrace = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; Content.RootDirectory = <span class="hljs-string"><span class="hljs-string">"Content"</span></span>; }</code> </pre><br>  I will give the contents of the Game1.cs file at the end of the next section, when I add it with the streaming audio playback code. <br><br><a name="4"></a><h4>  Sound playback in a Windows application </h4><br>  I did not manage to find a way how using standard XNA tools or even .NET you can play audio streams from IP Webcam.  Neither "audio.wav" nor "audio.ogg".  I found examples of where streaming audio was played using the static MediaPlayer class from the XNA framework, but our streams were too tough for him. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A lot of links on the web to open projects NAUDIO and SlimDX. But in the first one I launched a demo application and it also failed, and the second one I didn‚Äôt master. Roll up to the level of DirectX really did not want to. Quite by chance I found a wonderful way out. it turns out, along with all the same great VLC media player comes ActiveX-library!</font></font> Those.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">under Windows, I can work with VLC using COM interfaces. The interface description is very mean; the VLC project Wiki contains generally outdated information. It is unpleasant, but everything was possible. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To work with the ActiveX interfaces of the library, you must first register it. When installing the VLC media player, it is not registered and, as I understand it, it is a dead weight in the Vlc folder. To do this, run the console (cmd.exe) and type: </font></font><br><br> <code>regsvr32 "c:\Program Files (x86)\VideoLAN\VLC\axvlc.dll"</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Specify the path, of course. If you have Windows Vista or Windows 7, run the console as an administrator.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now the sound from IP Webcam we can play from anywhere. I trained on Excel. It is possible and on VBScript, but in VBA members of classes get out in hints. If you wish, here is a quick example. Open Excel, press Alt + F11. In the Microsoft Visual Basic for Applications window, the Tools menu -&gt; References ... Connect the link to ‚ÄúVideoLAN VLC ActiveX Plugin‚Äù. Now you can add a module and enter the macro text there:</font></font><br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Sub</span></span> TestAxLib() <span class="hljs-keyword"><span class="hljs-keyword">Dim</span></span> vlc As <span class="hljs-keyword"><span class="hljs-keyword">New</span></span> AXVLC.VLCPlugin2 vlc.Visible = <span class="hljs-literal"><span class="hljs-literal">False</span></span> vlc.playlist.items.Clear vlc.AutoPlay = <span class="hljs-literal"><span class="hljs-literal">True</span></span> vlc.Volume = <span class="hljs-number"><span class="hljs-number">200</span></span> vlc.playlist.Add <span class="hljs-string"><span class="hljs-string">"http://192.168.1.40:8080/audio.wav"</span></span>, <span class="hljs-literal"><span class="hljs-literal">Null</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(<span class="hljs-string"><span class="hljs-string">":network-caching=5"</span></span>) vlc.playlist.playItem (<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">MsgBox</span></span> <span class="hljs-string"><span class="hljs-string">"Hello world!"</span></span> vlc.playlist.<span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Sub</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Start IP Webcam, run the macro - there will be a sound! </font><font style="vertical-align: inherit;">By the way, you can also make video playback. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Returning to our test XNA-application, to play streaming audio, do the following: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add a reference to the VideoLAN VLC ActiveX Plugin COM component in the project. </font><font style="vertical-align: inherit;">In Solution Explorer, it will appear as ‚ÄúAXVLC‚Äù. </font><font style="vertical-align: inherit;">Select the ‚ÄúAXVLC‚Äù link and in the ‚ÄúProperties‚Äù window set the ‚ÄúEmbed interaction types‚Äù property to False. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Declare use of the AXVLC namespace:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> AXVLC;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Announce object: </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AXVLC.VLCPlugin2 audio;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Supplement the Initialize method: </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.audio = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AXVLC.VLCPlugin2Class();</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To add the Update method: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. By pressing the space bar, we start playing the audio stream:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.audio.Visible = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.audio.playlist.items.clear(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.audio.AutoPlay = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.audio.Volume = <span class="hljs-number"><span class="hljs-number">200</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] options = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">@":network-caching=20"</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.audio.playlist.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>( <span class="hljs-string"><span class="hljs-string">@"http://192.168.1.40:8080/audio.wav"</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, options); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.audio.playlist.playItem(<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2. By pressing Esc, we stop the playback of the audio stream: </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.audio.playlist.isPlaying) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.audio.playlist.stop(); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> So, this is what should happen: </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Xna.Framework; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Xna.Framework.Audio; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Xna.Framework.Content; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Xna.Framework.GamerServices; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Xna.Framework.Graphics; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Xna.Framework.Input; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Xna.Framework.Media; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> AXVLC; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> MjpegProcessor; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">WindowsGame1</span></span> { <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public class Game1 : Microsoft.Xna.Framework.Game { GraphicsDeviceManager graphics; SpriteBatch spriteBatch; </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> private Texture2D videoTexture; </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  MJPEG. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">      (, MJPEG),   IP Webcam. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;remarks&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   .NET  "MjpegProcessorXna4". </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/remarks&gt;</span></span></span><span class="hljs-comment"> private MjpegDecoder mjpeg; </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  VLC. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     ,   IP Webcam. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;remarks&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   ActiveX- VLC (www.videolan.org). </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   VLC,  ActiveX- axvlc.dll,       COM- "VideoLAN VLC ActiveX Plugin" (     "AXVLC"). </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/remarks&gt;</span></span></span><span class="hljs-comment"> private AXVLC.VLCPlugin2 audio; </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public Game1() { this.IsFixedTimeStep = false; this.graphics = new GraphicsDeviceManager(this); this.graphics.SynchronizeWithVerticalRetrace = false; Content.RootDirectory = "Content"; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> protected override void Initialize() { base.Initialize(); //   : this.mjpeg = new MjpegDecoder(); //  COM-   : this.audio = new AXVLC.VLCPlugin2Class(); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> LoadContent will be called once per game and is the place to load </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> all of your content. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> protected override void LoadContent() { // Create a new SpriteBatch, which can be used to draw textures. spriteBatch = new SpriteBatch(GraphicsDevice); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Allows the game to run logic such as updating the world, </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> checking for collisions, gathering input, and playing audio. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="gameTime"&gt;</span></span></span><span class="hljs-comment">Provides a snapshot of timing values.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> protected override void Update(GameTime gameTime) { //          : if (Keyboard.GetState().IsKeyDown(Keys.Space)) { //   : this.mjpeg.ParseStream(new Uri(@"http://192.168.1.40:8080/videofeed")); //   : this.audio.Visible = false; this.audio.playlist.items.clear(); this.audio.AutoPlay = true; this.audio.Volume = 200; string[] options = new string[] { @":network-caching=20" }; this.audio.playlist.add( @"http://192.168.1.40:8080/audio.wav", null, options); this.audio.playlist.playItem(0); } //    Esc   : if (Keyboard.GetState().IsKeyDown(Keys.Escape)) { //   : this.mjpeg.StopStream(); //   : if (this.audio.playlist.isPlaying) { this.audio.playlist.stop(); } } //  : this.videoTexture = this.mjpeg.GetMjpegFrame(this.GraphicsDevice); base.Update(gameTime); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> This is called when the game should draw itself. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="gameTime"&gt;</span></span></span><span class="hljs-comment">Provides a snapshot of timing values.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> protected override void Draw(GameTime gameTime) { GraphicsDevice.Clear(Color.CornflowerBlue); if (this.videoTexture != null) { this.spriteBatch.Begin(); Rectangle rectangle = new Rectangle( 0, 0, this.graphics.PreferredBackBufferWidth, this.graphics.PreferredBackBufferHeight); this.spriteBatch.Draw(this.videoTexture, rectangle, Color.White); this.spriteBatch.End(); } base.Draw(gameTime); } } }</span></span></code> </pre><br><a name="5"></a><h4>  Total </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Having closed this stage, I had both technical and non-technical conclusions. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now my friends can travel around my apartment ‚Äúin‚Äù Mitya, from the comfort of my home. More precisely could, if they had a gamepad. It seems that it is necessary to make management more popular input tools. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mitya sees and hears everything, but can say nothing. First you need to expand his facial expressions and train with some basic gestures, such as, ‚Äúyes‚Äù, ‚Äúno‚Äù, ‚Äúwag his tail‚Äù. Then it will be necessary to do the sound reproduction in the opposite direction - from the operator to the robot.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another question that has emerged is the constant buzzing-buzzing work of a vertical servo driving the head of Mitya. Due to the weight of the phone, the servo is forced to maintain a given angle and constantly buzzes and vibrates finely. It does not affect the video, but the microphone significantly scores. The operator, as a result, hears nothing but the buzz. In some positions of the head, the sound stops and then everything is perfectly audible. I do not even know how to solve this problem yet.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">My non-technical experience is that I discover new aspects of my hobby. Standing in the corner, the robot Mitya seems to be living his own life: he introduces me to interesting and in some people very similar to me, he manages to find me job offers and every evening I hurry home to hurry to do something still in this project. I hope there are no psychiatrists here ... In a word, I never expected such a return from the evening pastime (both from my side and with Mitina).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And here is another conclusion that I will try to remember. I understand perfectly well that nothing motivates so much as winning. And nothing kills interest like a long absence of victories. I think not everyone possesses such a degree of stubborn boredom as I do. And even I was on the verge of not throwing it all. I told myself that I would take another project for the time being, take a break from this, and then I would definitely come back. But deep down I knew what it meant and tried not to look at that angle. The solution of the problem of video transmission was for me a big step in the project, and I will try not to take big steps anymore. A big step is a big risk. I almost took up another job and it seemed more attractive to me, but now I don‚Äôt even remember about it. My mind is full of plans for Mitya. So now I will set less tasks for myself. I want a lot of victories, this is food for my pleasure!I will try in the future to do without big victories. I choose many, many small.</font></font></div><p>Source: <a href="https://habr.com/ru/post/144748/">https://habr.com/ru/post/144748/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../144741/index.html">The only way</a></li>
<li><a href="../144742/index.html">Self-education: let me invite you on a trip!</a></li>
<li><a href="../144743/index.html">One More Thing Conference 2012</a></li>
<li><a href="../144746/index.html">Coupons from people for people</a></li>
<li><a href="../144747/index.html">Data visualization</a></li>
<li><a href="../144750/index.html">Australian posted a photo of the money in Facebook, pointing the robbers at the mother‚Äôs house</a></li>
<li><a href="../144752/index.html">Volvo tested the robotic on a regular road</a></li>
<li><a href="../144753/index.html">Ukrainian railway. Tickets online. Quest</a></li>
<li><a href="../144754/index.html">How I did not buy a monitor</a></li>
<li><a href="../144757/index.html">We decide when to save the state of the object (to the database, any other storage) based on:</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>