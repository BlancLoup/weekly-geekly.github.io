<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a phone in a browser using WebRTC and Plivo service</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, the WebRTC standard was developed that allows streaming data transfer between browsers. Chrome 17, Opera 12, Firefox 18 (as well as the vers...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a phone in a browser using WebRTC and Plivo service</h1><div class="post__text post__text-html js-mediator-article">  Recently, the <a href="http://www.webrtc.org/">WebRTC</a> standard was developed that allows streaming data transfer between browsers.  Chrome 17, Opera 12, Firefox 18 (as well as the versions above mentioned) to some extent already support this standard.  There is also a webrtc4all extension that allows other browsers to work with WebRTC.  I will not describe here the advantages, disadvantages and prospects of the technology, I will go straight to practical use. <br><a name="habracut"></a><br>  There is also a <a href="http://plivo.com/">Plivo</a> service that allows you to manage calls in real time using the API.  To make calls, the client can create a SIP account or rent a number.  At the moment, the numbers are available in more than forty countries, among which Russia, unfortunately, is not.  Also through the API, you can create, modify and delete numbers and accounts.  Another important thing that plivo has is applications.  Applications allow you to combine numbers and SIP accounts.  In the application settings there is a mandatory option - Answer URL, and two optional - Fallback URL and Hungup URL.  Actually from these URLs, Plivo receives commands for managing calls. <br><br>  Details on the API can be found <a href="http://plivo.com/docs">here</a> .  I will describe only those parts that are used to create the phone.  To manage calls, you need to return XML with commands when you request the Answer URL.  Thus, you can redirect the call to a number, reject the call, play music, read the text.  Plivo always sends incoming and outgoing calls to the Answer URL.  API for managing numbers, accounts and applications - simple HTTP requests to certain URLs with specific parameters.  Plivo provides libraries to simplify working with the API <a href="https://github.com/plivo">https://github.com/plivo</a> .  I used plivo-php.  Do not forget to install dependencies for this library - php-curl, php-openssl, pear package HTTP_Request2.  Also Javascript API was used directly for the client side of the phone.  This API allows you to log in using a SIP account, make, accept, reject a call directly in the browser. <br>  I needed to create a telephone for the site where companies are registered as groups whose members are employees of companies.  Each employee or department has its own number, so it was necessary to link the number and SIP account.  You can do without rented numbers, but then calling from a regular phone to the browser will be problematic. <br><br>  Briefly explain how it will work.  Each user on the site has its own SIP account and a rented number.  All SIP accounts must be tied to one application (let's call it DirectDial Application), all numbers must be tied to another application (let's call it Number Application).  Different numbers can be tied to different applications, as I did, because there are different user groups on the site.  However, the Answer URL they may be the same.  When the user loads the page, using the js API, we will login using the appropriate SIP account.  Further, the user can make calls from the browser.  Data on such calls will be sent to the Answer URL DirectDial Application.  The answer URL should always return any XML response, since Plivo will not call the number dialed by the user if you do not send the appropriate command.  Data on an incoming call is sent to the Answer URL Number Application'a.  Here is the same situation - the answer must be sent anyway.  In my case, I simply searched the SIP database for the account corresponding to the dialed number and redirected the call to this account, then the user saw the incoming call in the browser. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      First you need to create a DirectDial Application.  Go to <a href="https://www.plivo.com/app/create/">https://www.plivo.com/app/create/</a> and create an application.  In Application name we write DirectDial Application (any other name is possible), in the Answer URL the corresponding URL (let it be <a href="http://site.com/dda_answer">site.com/dda_answer</a> ).  Check the Default endpoint application checkbox, then click Create.  Endpoint is the same as a SIP account.  I am not an expert in the SIP protocol, and I can not say which name is more correct.  When <a href="http://site.com/dda_answer">making an</a> outgoing call from a SIP account to <a href="http://site.com/dda_answer">site.com/dda_answer</a> , a POST request will arrive with approximately the following parameters: <br><br><pre><code class="php hljs">[Direction] =&gt; inbound [From] =&gt; sip:sipname8905@phone.plivo.com [CallerName] =&gt; sipname8905 [BillRate] =&gt; <span class="hljs-number"><span class="hljs-number">0.00400</span></span> [To] =&gt; called_number [CallUUID] =&gt; <span class="hljs-number"><span class="hljs-number">138</span></span>caf72<span class="hljs-number"><span class="hljs-number">-615</span></span>d<span class="hljs-number"><span class="hljs-number">-11e2</span></span><span class="hljs-number"><span class="hljs-number">-8</span></span>f6e<span class="hljs-number"><span class="hljs-number">-659</span></span>f0688e76c [CallStatus] =&gt; ringing [Event] =&gt; StartApp</code> </pre> <br><br>  Almost always Direction will be inbound.  Therefore, it is better to determine the type of call based on the parameters From and To.  The easiest answer to this query: <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Response</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Dial</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">callerId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rented_number"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Number</span></span></span><span class="hljs-tag">&gt;</span></span>called_number<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Number</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Dial</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Response</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  The result will be called the called_number number, in which rented_number will be displayed as the incoming number.  In my case, it was a rented number corresponding to the sipname8905 account.  XML can be created using plivo-php.  Called_number should be transmitted in the form of 795023423434, that is, without the ‚Äú+‚Äù sign in front of the number and must contain the code of the country, city and cellular operator. <br>  When the call is completed, a request for the Answer URL will also be sent (if you specified the Hangup URL when creating the application, the request will be sent to it).  Query parameters look like this: <br><br><pre> <code class="php hljs">[Direction] =&gt; inbound [BillDuration] =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span> [From] =&gt; sip:sipname8905@phone.plivo.com [CallerName] =&gt; sipname8905 [HangupCause] =&gt; USER_BUSY [BillRate] =&gt; <span class="hljs-number"><span class="hljs-number">0.00400</span></span> [To] =&gt; called_number [Duration] =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span> [CallUUID] =&gt; <span class="hljs-number"><span class="hljs-number">138</span></span>caf72<span class="hljs-number"><span class="hljs-number">-615</span></span>d<span class="hljs-number"><span class="hljs-number">-11e2</span></span><span class="hljs-number"><span class="hljs-number">-8</span></span>f6e<span class="hljs-number"><span class="hljs-number">-659</span></span>f0688e76c [CallStatus] =&gt; busy [Event] =&gt; Hangup</code> </pre><br><br>  CallStatus and HangupCause may be different.  This is the case when the number was busy. <br>  <a href="https://github.com/plivo/plivo-examples-php/blob/master/plivo_directdial.php">Here is</a> an example script for the Answer URL DirectDial Application.  I used this example by adding methods to it to save the history of outgoing calls.  The easiest answer is: <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Response</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Hangup</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Response</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  We now turn to Number Application.  You also need to create a new application, specifying a different Answer URL, you do not need to check the Default endpoint application checkbox.  If you have this is the only application for rented rooms, then you can note the Default number application.  Now, when someone calls the rented number that is associated with the Number Application, Plivo will send a request to the Answer URL of this application.  Query parameters will look something like this: <br><br><pre> <code class="php hljs">[Direction] =&gt; inbound [From] =&gt; calling_number [CallerName] =&gt; +calling_number [BillRate] =&gt; <span class="hljs-number"><span class="hljs-number">0.00900</span></span> [To] =&gt; rented_number [CallUUID] =&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>f26b9b5<span class="hljs-number"><span class="hljs-number">-4468</span></span><span class="hljs-number"><span class="hljs-number">-4</span></span>d95<span class="hljs-number"><span class="hljs-number">-8</span></span>f52-e24b084b8a76 [CallStatus] =&gt; ringing [Event] =&gt; StartApp</code> </pre><br><br>  The response to this request must also be necessarily sent.  In my case, I search for the SIP account corresponding to rented_number, and redirect the call to the SIP account.  The answer is: <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Response</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Dial</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">callerId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"calling_number"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">User</span></span></span><span class="hljs-tag">&gt;</span></span>related_endpoint<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">User</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Dial</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Response</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  The connection between the SIP account and the number is stored in my database, so do not try to search for how to do this through the API or in the settings for Plivo.  The script is very similar to the one used for the Answer URL DirectDial Application.  In this place, you can create an answering machine by sending answers with the necessary commands.  Also, if you did not specify the Hangup URL when creating the Number Application, then at the end of the call you will receive the same request as for the Answer URL DirectDial Application.  And the answer here may be the same. <br>  We now turn to the most interesting - to the phone.  An example can be found <a href="https://s3.amazonaws.com/plivowebrtc/phone.html">here</a> .  First, connect the js provided by Plivo <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://s3.amazonaws.com/plivoweb-sdk/plivo.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Now we can initialize the Plivo object. <br><pre> <code class="javascript hljs">Plivo.onWebrtcNotSupported = webrtcNotSupportedAlert; Plivo.onReady = onReady; Plivo.init();</code> </pre><br><br>  webrtcNotSupportedAlert is a user-defined function that will be called after initialization if the browser does not support webRTC technology.  onReady will be called if the browser supports webRTC.  In the onReady method, it is convenient to log in the user if the username and password are defined in advance, and to bind the methods to Plivo events.  I will give an example of the minimum required code. <br><br><pre> <code class="javascript hljs">onIncomingCall = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">acc_name</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     $('#answer-button').click(function(){Plivo.conn.answer();}); } onReady = function () { Plivo.conn.login(username, pass); Plivo.onIncommingCall = onIncommingCall; $('#button-call').click(function(){ var numb = $('#number-textfield').val().replace(/[\D,\s]/g, ''); Plivo.conn.call(numb); }); $('#button-hangup').click(function(){ Plivo.conn.hangup(); }); }</span></span></code> </pre><br><br>  A list of all events is available <a href="http://plivo.com/docs/sdk/web/">here</a> .  You can also set your own ringtone and something different instead of beeps. <br><br>  This service is convenient to use to create a hotline, or to enable customers from another country to easily and cheaply contact you by renting a number in this country. <br><br>  But it will not do without a fly in the ointment.  It works so far only in Chrome.  And there are problems with sound in versions 24 and 25. In Chrome 23, everything worked fine. </div><p>Source: <a href="https://habr.com/ru/post/171867/">https://habr.com/ru/post/171867/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../171851/index.html">Home server / NAS on Mini-ITX platform</a></li>
<li><a href="../171853/index.html">The best computer games of all times and peoples according to the version of habrasoobschestva 2013</a></li>
<li><a href="../171857/index.html">Google Play Celebrates Birthday</a></li>
<li><a href="../171861/index.html">Valve will introduce biometrics Steam Box this summer</a></li>
<li><a href="../171863/index.html">Multiplayer video chat</a></li>
<li><a href="../171869/index.html">Microsoft allowed to install Office 2013 on different computers</a></li>
<li><a href="../171871/index.html">Speakers' Corner in Dnepropetrovsk in March: Time management and planning in Agile</a></li>
<li><a href="../171873/index.html">Learn PHPBB3 to respond to HTTP_IF_MODIFIED_SINCE</a></li>
<li><a href="../171875/index.html">Debian Linux port to Samsung Galaxy Note 10.1 (with stylus support)</a></li>
<li><a href="../171877/index.html">An inside look: postgraduate study at EPFL. Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>