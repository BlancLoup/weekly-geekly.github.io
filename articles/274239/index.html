<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Working with the database in Google App Engine / Google Cloud Endpoints in Java: Objectify framework</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In previous articles ( ‚ÄúGoogle Cloud Endpoints in Java: A Guide. Part 1‚Äù , ‚ÄúGoogle Cloud Endpoints in Java: A Guide. Part 2 (Frontend)‚Äù , ‚ÄúGoogle Clou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Working with the database in Google App Engine / Google Cloud Endpoints in Java: Objectify framework</h1><div class="post__text post__text-html js-mediator-article">  In previous articles ( <a href="http://habrahabr.ru/post/268863/">‚ÄúGoogle Cloud Endpoints in Java: A Guide. Part 1‚Äù</a> , <a href="http://habrahabr.ru/post/270459/">‚ÄúGoogle Cloud Endpoints in Java: A Guide. Part 2 (Frontend)‚Äù</a> , <a href="http://habrahabr.ru/post/271385/">‚ÄúGoogle Cloud Endpoints in Java: A Guide. Part 3‚Äù</a> ) analyzed the creation of API on <a href="https://cloud.google.com/appengine/docs/java/endpoints/">Google Cloud Endpoints</a> and frontend to it on <a href="https://angularjs.org/">AngularJS</a> . <br><br>  However, a guide to creating an API would be incomplete without working with a database. <br><br>  In this article we will look at the <a href="https://github.com/objectify/objectify">Objectify</a> framework for working with the <a href="https://cloud.google.com/appengine/docs/java/datastore/">App Engine Datastore</a> database embedded in GAE. <br><a name="habracut"></a><br><h4>  App Engine Datastore </h4><br>  The App Engine Datastore is a non-relational NoSQL database (schemaless NoSQL datastore) of the Key-value database type. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Key </h5><br>  The key is the unique identifier of the ‚Äúobject‚Äù (in the App Engine datastore this is called ‚ÄúEntity‚Äù) in the database. <br><br>  The key consists of three components: <br><br>  <b>Kind</b> (type): which corresponds to the type of object in the database (using Objectify, we model kind as a Java class, that is, <i>conditionally speaking</i> in our case, kind means a class of an object placed in a database) <br><br>  <b>Identifier</b> : A unique identifier for an object, which can be either a string (String), in which case it is called <b>name</b> , or a number (Long) in this case, it is called <b>Id</b> .  Those.  the type identifier <code>"01234"</code> is the <i>name</i> , and the type <code>01234</code> is the <b><i>Id</i></b> .  The identifier must be unique among objects of the same type, objects of different types may have the same identifier, i.e.  we can have an object of the type "string" with the identifier "01", and an object of the type "column" with the identifier "01".  For a newly created object in the database, an identifier, if it is not explicitly specified, is automatically generated. <br><br>  <b>Parent</b> (group of objects): objects in the database can be combined into ‚Äúgroups of objects‚Äù; for this, the parent specifies either the key of the ‚Äúparent‚Äù object, or null (default) for objects not included in the groups. <br><br><h5>  Entity </h5><br>  The object (Entity) in the database has properties (properties) that can contain values ‚Äã‚Äã(Value type), their correspondence to Java data types (Java types) is given in the table: <br><table><tbody><tr><th>  Value type </th><th>  Java type (s) </th><th>  Sort order </th><th>  Notes </th></tr><tr><td>  Integer </td><td> <code>short</code> <br> <code>int</code> <br> <code>long</code> <br> <code>java.lang.Short</code> <br> <code>java.lang.Integer</code> <br> <code>java.lang.Long</code> </td> <td>  Numeric </td><td></td></tr><tr><td>  Floating-point number </td><td> <code>float</code> <br> <code>double</code> <br> <code>java.lang.Float</code> <br> <code>java.lang.Double</code> </td> <td>  Numeric </td><td>  64-bit double precision, <br>  IEEE 754 </td></tr><tr><td>  Boolean </td><td> <code>boolean</code> <br> <code>java.lang.Boolean</code> </td> <td>  <code>false</code> or <code>true</code> </td><td></td></tr><tr><td>  Text string (short) </td><td> <code>java.lang.String</code> </td> <td>  Unicode </td><td>  Up to 1500 bytes <br><br>  values ‚Äã‚Äãgreater than 1500 bytes throws an <code>IllegalArgumentException</code> exception </td></tr><tr><td>  Text string (long) </td><td> <a href="https://cloud.google.com/appengine/docs/java/javadoc/com/google/appengine/api/datastore/Text"><code>com.google.appengine.api.datastore.Text</code></a> </td> <td>  None </td><td>  Up to 1 megabyte <br><br>  Not indexed </td></tr><tr><td>  Byte string (short) </td><td> <a href="https://cloud.google.com/appengine/docs/java/javadoc/com/google/appengine/api/datastore/ShortBlob"><code>com.google.appengine.api.datastore.ShortBlob</code></a> </td> <td>  Byte order </td><td>  Up to 1500 bytes <br><br>  Values ‚Äã‚Äãgreater than 1500 bytes throw an <code>IllegalArgumentException</code> exception. </td></tr><tr><td>  Byte string (long) </td><td> <a href="https://cloud.google.com/appengine/docs/java/javadoc/com/google/appengine/api/datastore/Blob"><code>com.google.appengine.api.datastore.Blob</code></a> </td> <td>  None </td><td>  Up to 1 megabyte <br><br>  Not indexed </td></tr><tr><td>  Date and time </td><td> <code>java.util.Date</code> </td> <td>  Chronological </td><td></td></tr><tr><td>  Geographical point </td><td> <a href="https://cloud.google.com/appengine/docs/java/javadoc/com/google/appengine/api/datastore/GeoPt"><code>com.google.appengine.api.datastore.GeoPt</code></a> </td> <td>  By latitude, <br>  then longitude </td><td></td></tr><tr><td>  Postal address </td><td> <a href="https://cloud.google.com/appengine/docs/java/javadoc/com/google/appengine/api/datastore/PostalAddress"><code>com.google.appengine.api.datastore.PostalAddress</code></a> </td> <td>  Unicode </td><td></td></tr><tr><td>  Telephone number </td><td> <a href="https://cloud.google.com/appengine/docs/java/javadoc/com/google/appengine/api/datastore/PhoneNumber"><code>com.google.appengine.api.datastore.PhoneNumber</code></a> </td> <td>  Unicode </td><td></td></tr><tr><td>  Email address </td><td> <a href="https://cloud.google.com/appengine/docs/java/javadoc/com/google/appengine/api/datastore/Email"><code>com.google.appengine.api.datastore.Email</code></a> </td> <td>  Unicode </td><td></td></tr><tr><td>  Google Accounts user </td><td> <a href="https://cloud.google.com/appengine/docs/java/javadoc/com/google/appengine/api/users/User"><code>com.google.appengine.api.users.User</code></a> </td> <td>  Email address <br>  in unicode order </td><td></td></tr><tr><td>  Instant messaging handle </td><td> <a href="https://cloud.google.com/appengine/docs/java/javadoc/com/google/appengine/api/datastore/IMHandle"><code>com.google.appengine.api.datastore.IMHandle</code></a> </td> <td>  Unicode </td><td></td></tr><tr><td>  Link </td><td> <a href="https://cloud.google.com/appengine/docs/java/javadoc/com/google/appengine/api/datastore/Link"><code>com.google.appengine.api.datastore.Link</code></a> </td> <td>  Unicode </td><td></td></tr><tr><td>  Category </td><td> <a href="https://cloud.google.com/appengine/docs/java/javadoc/com/google/appengine/api/datastore/Category"><code>com.google.appengine.api.datastore.Category</code></a> </td> <td>  Unicode </td><td></td></tr><tr><td>  Rating </td><td> <a href="https://cloud.google.com/appengine/docs/java/javadoc/com/google/appengine/api/datastore/Rating"><code>com.google.appengine.api.datastore.Rating</code></a> </td> <td>  Numeric </td><td></td></tr><tr><td>  Datastore key </td><td> <a href="https://cloud.google.com/appengine/docs/java/javadoc/com/google/appengine/api/datastore/Key"><code>com.google.appengine.api.datastore.Key</code></a> <br>  or the referenced object (as a child) </td><td>  By path elements <br>  (kind, identifier, <br>  kind, identifier ...) </td><td>  Up to 1500 bytes <br><br>  Values ‚Äã‚Äãgreater than 1500 bytes throw an <code>IllegalArgumentException</code> exception. </td></tr><tr><td>  Blobstore key </td><td> <a href="https://cloud.google.com/appengine/docs/java/javadoc/com/google/appengine/api/blobstore/BlobKey"><code>com.google.appengine.api.blobstore.BlobKey</code></a> </td> <td>  Byte order </td><td></td></tr><tr><td>  <a href="https://cloud.google.com/">Embedded entity</a> </td><td> <a href="https://cloud.google.com/appengine/docs/java/datastore/entities"><code>com.google.appengine.api.datastore.EmbeddedEntity</code></a> </td> <td>  None </td><td>  not indexed </td></tr><tr><td>  Null </td><td> <code>null</code> </td> <td>  None </td><td></td></tr></tbody></table><br><h5>  Database operations </h5><br>  Objectify performs three basic operations: <br><br>  <b>save ()</b> : save object to database <br><br>  <b>delete ()</b> : delete an object from the database <br><br>  <b>load ()</b> : load an object or list of objects from a database. <br><br><h5>  Transactions (transactions) and groups of objects (Entity Groups) </h5><br>  In order to combine the objects into the group ‚Äúparent‚Äù object it is not necessary to exist in the database, it is enough to specify the object key.  Deleting the "parent object" does not delete the "child", they will continue to refer to its key. <br><br>  Using this mechanism, objects in the database can be organized in the form of hierarchical structures. <br>  Relationships ‚Äúparent object‚Äù - ‚Äúchild object‚Äù (parent ‚Äì ‚Äã‚Äãchild relationship) can be established between objects of the same type (for example, great-grandfather -&gt; grandfather -&gt; father -&gt; me -&gt; son) and objects of different types (for example, for objects of the type "car" child objects can be objects of the type "wheel", "engine") <br><br>  At the same time, each ‚Äúchild‚Äù object can have only one ‚Äúparent‚Äù object.  And, since the key of the parent object is part of the object key, we cannot add or remove it after the object is created - we do not change the key.  Therefore, the use of "parent key" must be approached with caution. <br><br>  As a rule, within a single <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D1%2580%25D0%25B0%25D0%25BD%25D0%25B7%25D0%25B0%25D0%25BA%25D1%2586%25D0%25B8%25D1%258F_%2528%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2582%25D0%25B8%25D0%25BA%25D0%25B0%2529">transaction,</a> we can access data from only one group of objects (but there is a way to use several groups in one transaction) <br>  When any object in a group changes for a group, the timestamp changes.  The time stamp is set for the whole group, and is updated when any object in the group changes. <br><br>  When we make a transaction, each group of objects that affects the transaction is marked as enlisted in the transaction.  When a transaction is committed (committed), all time stamps of the groups involved in the transaction are checked.  If any of the time stamps has changed (since the other transaction at this time has changed the object (s) in the group), then the entire transaction is canceled and a ConcurrentModificationException exception is thrown.  See <a href="https://github.com/objectify/objectify/wiki/Concepts">github.com/objectify/objectify/wiki/Concepts#optimistic-concurrency for</a> more details. <br>  Objectify handles these types of exceptions and repeats the transaction.  Therefore, transactions must be <a href="https://ru.wikipedia.org/wiki/%25D0%2598%25D0%25B4%25D0%25B5%25D0%25BC%25D0%25BF%25D0%25BE%25D1%2582%25D0%25B5%25D0%25BD%25D1%2582%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%258C">idempotent</a> , i.e.  we should be able to repeat the transaction any number of times and get the same result. <br><br>  Learn more about transactions at Objectify, see: <a href="https://github.com/objectify/objectify/wiki/Transactions">github.com/objectify/objectify/wiki/Transactions</a> <br><br><h4>  Objectify connection to the project </h4><br>  To use the framework, we need to add objectify.jar and <a href="https://github.com/google/guava/wiki">guava.jar</a> to the project. <br>  Objectify is in <a href="http://search.maven.org/">the Maven repository</a> , we just need to add to pom.xml: <br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependencies</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>com.googlecode.objectify<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>objectify<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>5.1.9<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependencies</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  - objectify.jar and guava.jar will be added to the project. <br>  Objectify uses a filter that must be registered in WEB-INF / web.xml: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter-name</span></span></span><span class="hljs-tag">&gt;</span></span>ObjectifyFilter<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter-name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter-class</span></span></span><span class="hljs-tag">&gt;</span></span>com.googlecode.objectify.ObjectifyFilter<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter-class</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter-mapping</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter-name</span></span></span><span class="hljs-tag">&gt;</span></span>ObjectifyFilter<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter-name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url-pattern</span></span></span><span class="hljs-tag">&gt;</span></span>/*<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url-pattern</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter-mapping</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Create a UserData class that will model an object (Entity) in the database: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.appspot.hello_habrahabr_api; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.googlecode.objectify.annotation.Entity; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.googlecode.objectify.annotation.Id; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.googlecode.objectify.annotation.Index; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.googlecode.objectify.annotation.Cache; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.Serializable; <span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-comment"><span class="hljs-comment">// indicates that this is an Entity @Cache // Annotate your entity classes with @Cache to make them cacheable. // The cache is shared by all running instances of your application // and can both improve the speed and reduce the cost of your application. // Memcache requests are free and typically complete in a couple milliseconds. // Datastore requests are metered and typically complete in tens of milliseconds. public class UserData implements Serializable { @Id // indicates that the userId is to be used in the Entity's key // @Id field can be of type Long, long, or String // Entities must have have at least one field annotated with @Id String userId; @Index // this field will be indexed in database private String createdBy; // email @Index private String firstName; @Index private String lastName; private UserData() { } // There must be a no-arg constructor // (or no constructors - Java creates a default no-arg constructor). // The no-arg constructor can have any protection level (private, public, etc). public UserData(String createdBy, String firstName, String lastName) { this.userId = firstName + lastName; this.createdBy = createdBy; this.firstName = firstName; this.lastName = lastName; } /* Getters and setters */ // You need getters and setters to have a serializable class if you need to send it from backend to frontend, // to avoid exception: // java.io.IOException: com.google.appengine.repackaged.org.codehaus.jackson.map.JsonMappingException: No serializer found for class ... // public String getUserId() { return userId; } public void setUserId(String userId) { this.userId = userId; } public String getCreatedBy() { return createdBy; } public void setCreatedBy(String createdBy) { this.createdBy = createdBy; } public String getFirstName() { return firstName; } public void setFirstName(String firstName) { this.firstName = firstName; } public String getLastName() { return lastName; } public void setLastName(String lastName) { this.lastName = lastName; } }</span></span></code> </pre><br><br>  Next, we should create a class in which we register the classes created for describing objects in the database, and which will contain the method issuing Objectify service object Objectify (methods that we will use to interact with the database).  Let's call it OfyService: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.appspot.hello_habrahabr_api; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.googlecode.objectify.Objectify; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.googlecode.objectify.ObjectifyFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.googlecode.objectify.ObjectifyService; <span class="hljs-comment"><span class="hljs-comment">/** * Custom Objectify Service that this application should use. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OfyService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// This static block ensure the entity registration. static { factory().register(UserData.class); } // Use this static method for getting the Objectify service factory. public static ObjectifyFactory factory() { return ObjectifyService.factory(); } /** * Use this static method for getting the Objectify service object in order * to make sure the above static block is executed before using Objectify. * * @return Objectify service object. */ @SuppressWarnings("unused") public static Objectify ofy() { return ObjectifyService.ofy(); } }</span></span></code> </pre><br><br>  Now create an API (let's call the file UserDataAPI.java): <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.appspot.hello_habrahabr_api; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.api.server.spi.config.Api; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.api.server.spi.config.ApiMethod; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.api.server.spi.config.ApiMethod.HttpMethod; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.api.server.spi.config.Named; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.api.server.spi.response.NotFoundException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.api.server.spi.response.UnauthorizedException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.appengine.api.users.User; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.googlecode.objectify.Key; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.googlecode.objectify.Objectify; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.Serializable; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.List; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.logging.Logger; <span class="hljs-comment"><span class="hljs-comment">/** * explore this API on: * hello-habrahabr-api.appspot.com/_ah/api/explorer * {project ID}.appspot.com/_ah/api/explorer */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Api</span></span>( name = <span class="hljs-string"><span class="hljs-string">"userDataAPI"</span></span>, <span class="hljs-comment"><span class="hljs-comment">// The api name must match '[az]+[A-Za-z0-9]*' version = "v1", scopes = {Constants.EMAIL_SCOPE}, clientIds = {Constants.WEB_CLIENT_ID, Constants.API_EXPLORER_CLIENT_ID}, description = "UserData API using OAuth2") public class UserDataAPI { private static final Logger LOG = Logger.getLogger(UserDataAPI.class.getName()); // Primitives and enums are not allowed as return type in @ApiMethod // So we create inner class (which should be a JavaBean) to serve as wrapper for String private class MessageToUser implements Serializable { private String message; public MessageToUser() { } public MessageToUser(String message) { this.message = message; } public String getMessage() { return message; } public void setMessage(String message) { this.message = message; } } @ApiMethod( name = "createUser", path = "createUser", httpMethod = HttpMethod.POST) @SuppressWarnings("unused") public MessageToUser createUser(final User gUser, @Named("firstName") final String firstName, @Named("lastName") final String lastName // instead of @Named arguments, we could also use // another JavaBean for modelling data received from frontend ) throws UnauthorizedException { if (gUser == null) { LOG.warning("User not logged in"); throw new UnauthorizedException("Authorization required"); } Objectify ofy = OfyService.ofy(); UserData user = new UserData(gUser.getEmail(), firstName, lastName); ofy.save().entity(user).now(); return new MessageToUser("user created: " + firstName + " " + lastName); } @ApiMethod( name = "deleteUser", path = "deleteUser", httpMethod = HttpMethod.DELETE) @SuppressWarnings("unused") public MessageToUser deleteUser(final User gUser, @Named("firstName") final String firstName, @Named("lastName") final String lastName ) throws UnauthorizedException { if (gUser == null) { LOG.warning("User not logged in"); throw new UnauthorizedException("Authorization required"); } Objectify ofy = OfyService.ofy(); String userId = firstName + lastName; Key&lt;UserData&gt; userDataKey = Key.create(UserData.class, userId); ofy.delete().key(userDataKey); return new MessageToUser("User deleted: " + firstName + " " + lastName); } @ApiMethod( name = "findUsersByLastName", path = "findUsersByLastName", httpMethod = HttpMethod.GET) @SuppressWarnings("unused") public List&lt;UserData&gt; findUsers(final User gUser, @Named("query") final String query ) throws UnauthorizedException, NotFoundException { if (gUser == null) { LOG.warning("User not logged in"); throw new UnauthorizedException("Authorization required"); } Objectify ofy = OfyService.ofy(); List&lt;UserData&gt; result = ofy.load().type(UserData.class).filter("lastName ==", query).list(); // for queries see: // https://github.com/objectify/objectify/wiki/Queries#executing-queries if (result.isEmpty()) { throw new NotFoundException("no results found"); } return result; // we need to return a serializable object } }</span></span></code> </pre><br><br>  Now, at {project ID} .appspot.com / _ah / api / explorer, we can use the web interface to test the API by adding, deleting and loading objects from the database. <br><img src="https://habrastorage.org/files/6d2/95c/96d/6d295c96db3c45e59dc32e4af867a1ca.png"><br><br>  In the developer‚Äôs <a href="https://console.developers.google.com/datastore/entities/query">console</a> , by selecting <a href="https://console.developers.google.com/datastore/entities/query">console.developers.google.com/datastore/entities/query</a> , by selecting the appropriate project, we get access to the web interface that allows you to work with the database, including creating, deleting, sorting objects: <br><img src="https://habrastorage.org/files/670/62a/30d/67062a30dd284ed4bc12b97d1d1ec1da.png"><br><br><h4>  References: </h4><br>  <a href="https://github.com/objectify/objectify/wiki">Objectify wiki</a> <br><br>  <a href="http://www.javadoc.io/doc/com.googlecode.objectify/objectify">Objectify javadoc</a> <br><br>  <a href="https://cloud.google.com/appengine/docs/java/datastore/">Java Datastore API</a> <br><br>  <a href="https://cloud.google.com/appengine/docs/java/gettingstarted/usingdatastore">Storing Data in Datastore</a> (Google Tutorial) <br><br>  A brief introduction to the framework from its creator <a href="https://github.com/stickfigure">Jeff Schnitzer</a> ( <a href="https://twitter.com/jeffschnitzer">@jeffschnitzer</a> ) on Google I / O 2011: <a href="https://youtu.be/imiquTOLl64%3Ft%3D3m40s">youtu.be/imiquTOLl64?t=3m40s</a> <br><br><h4>  UPD: </h4><br>  <a href="http://habrahabr.ru/post/275211/">Google Cloud Storage with Java: images and other files in the clouds</a> </div><p>Source: <a href="https://habr.com/ru/post/274239/">https://habr.com/ru/post/274239/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../274233/index.html">Hackathon and the winter scientific school on deep learning and question-answer systems</a></li>
<li><a href="../274237/index.html">The work of an ‚ÄúIT astronaut‚Äù: how we engineers go on a visit to bears and seals</a></li>
<li><a href="../274241/index.html">Security Scanners: Automatic Vulnerability Classification</a></li>
<li><a href="../274245/index.html">GlassRAT: Trojan analysis from China using RSA Security Analytics and RSA ECAT</a></li>
<li><a href="../274247/index.html">Sociology of algorithms: How financial markets and high-frequency trading are connected (Part 1)</a></li>
<li><a href="../274249/index.html">Authorization in Ubuntu through Microsoft Azure AD / Office 365</a></li>
<li><a href="../274251/index.html">Build and configure FreeRADIUS 3 with SQLITE support</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>