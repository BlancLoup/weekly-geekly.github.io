<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>NRF51822 in brief: Power saving and some peripherals</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. 

 In the last article, we briefly enough familiarized ourselves with the minimum set of BLE stack capabilities and created our first projec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>NRF51822 in brief: Power saving and some peripherals</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/wt/rx/i-/wtrxi-u28aidbf3e7nkdqsni8bi.png" alt="image" align="left" width="50%"><br>  <b>Good day.</b> <br><br>  In the last article, we briefly enough familiarized ourselves with the minimum set of BLE stack capabilities and created our first project for connecting two remote devices.  Now it's time to pay attention to the nRF51822 hardware, namely to a 32-bit microcontroller based on the ARM architecture with the Cortex M0 core (256kB / 128kB flash + 32kB / 16kB RAM). <br><br>  In this article, I would like to take the time to be probably one of the main features of Bluetooth Low Energy devices - energy saving, as well as consider the most frequently used peripherals, such as ADCs, timers, and interesting, I think PPI block.  The remaining commonly used peripheral units such as SPI, I2C, UART will be considered in the following articles. <br><a name="habracut"></a><br>  So, let's begin. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Power Saving Modes </h2><br>  As mentioned above, one of the key features of BLE chips is their low power consumption, which actually determines their use in various SMART devices.  Let us consider what one of the leaders of the BLE segment offers - Nordic Semiconductor with its nRF51822. <br>  According to the datasheet, nRF51822 has two main modes of operation, one of which is stationary with the possibility of switching sub-modes of energy saving, and one for achieving maximum energy savings. <br><br><h4>  System ON mode </h4><br>  System ON is the main mode in which the controller is fully functional and performs all the declared functions.  The controller enters sleep mode using the WFI and WFE instructions, the difference between which is that in the first case, the awakening occurs by interrupting the allowed in NVIC, and in the second from any event that is allowed in NVIC and not allowed.  System ON is notable for the fact that it can be in two states in sleep mode: Low power and Constant Latency. <br><br>  <i><font color="#0d3f66"><b>Low power</b></font></i> - low power mode, which is achieved by optimizing the power management system.  In this case, part of the regulators is disabled (more details can be found in the product specification) and the crystal resonator, which leads to an increase in the time interval required for the core to wake up, as well as the delay in responding to the PPI module request (see below for the PPI module). this gap is not always constant and may vary depending on the periphery that caused the interruption.  To enter Low Power you need to activate the task in the <font color="#c00000">LOWPWR</font> register.  This mode is standard and it is the controller after Reset. <br><br>  <i><font color="#0d3f66"><b>Constant Latency</b></font></i> is a mode generally similar to the previous one, the only difference is that the delays of the kernel and the response to the PPI module request are constant and minimal.  However, this entails a higher power consumption, since the quartz resonator remains on, although it is in the minimum consumption mode. <br>  To enter Constant Latency, you must activate the task in the <font color="#c00000">CONSTLAT</font> register. <br><br>  System ON consumption Low power directly depends on the number of active memory blocks and is: <br>  <font color="#0d3f66"><b>2.6 ¬µA</b></font> - 16 Kb RAM Active <br>  <font color="#0d3f66"><b>3.8 ¬µA</b></font> - 32 Kb RAM active <br><br>  Experts and Nordic advise to adhere to a number of rules for a significantly greater reduction in energy consumption in System On mode: <br>  - use built-in DC / DC (gain up to 30%); <br>  - increase the interval between advertising packages; <br>  - if possible, reduce the amount of advertising package; <br>  - if possible, reduce the power of the radio transmitter; <br>  - disable unused peripheral modules before switching to sleep mode; <br>  - disable SPI, TWI, UART modules after the end of the receive / transmit cycle. <br><br><h4>  System OFF mode </h4><br>  System OFF - the mode in which the most economical power consumption mode is achieved.  In this mode, the controller core is disabled and all processes are terminated.  In this case, one or more RAM blocks remain active.  Exit from this mode is possible by an external DETECT signal, by an ANADETECT signal from the built-in comparator LPCOMP, and also by a RESET signal.  After exit, a forced system reset is performed. <br><br>  To enter the System OFF mode, you must perform the following steps in the following registers: <br>  <b>1.</b> <font color="#c00000">RESETREAS</font> - define a wake-up event in the register; <br>  <b>2.</b> <font color="#c00000">RAMON</font> and <font color="#c00000">RAMONB</font> - determine the active RAM blocks in the register; <br>  <b>3.</b> <font color="#c00000">SYSTEMOFF</font> - activate the System OFF mode in the register; <br>  <b>4.</b> configure the unit responsible for waking the controller. <br><br><div class="spoiler">  <b class="spoiler_title">SystemOFF mode startup function</b> <div class="spoiler_text"><pre><code class="hljs rust">#define WAKEUP_PIN <span class="hljs-number"><span class="hljs-number">1</span></span> void SystemOFF_active(void){ <span class="hljs-comment"><span class="hljs-comment">/*   :    */</span></span> NRF_POWER-&gt;RESETREAS = POWER_RESETREAS_OFF_Detected; <span class="hljs-comment"><span class="hljs-comment">/*    RAM */</span></span> NRF_POWER-&gt;RAMON = POWER_RAMON_OFFRAM0_RAM0Off; <span class="hljs-comment"><span class="hljs-comment">/*   P0.01     */</span></span> NRF_GPIO-&gt;PIN_CNF[WAKEUP_PIN] = (GPIO_PIN_CNF_DIR_Input &lt;&lt; GPIO_PIN_CNF_DIR_Pos)| (GPIO_PIN_CNF_PULL_Pulldown &lt;&lt; GPIO_PIN_CNF_PULL_Pos)| (GPIO_PIN_CNF_SENSE_High &lt;&lt; GPIO_PIN_CNF_SENSE_Pos)| (GPIO_PIN_CNF_INPUT_Connect &lt;&lt; GPIO_PIN_CNF_INPUT_Pos); <span class="hljs-comment"><span class="hljs-comment">/*      P0.01*/</span></span> NRF_GPIOTE-&gt;CONFIG[<span class="hljs-number"><span class="hljs-number">0</span></span>] = (GPIOTE_CONFIG_MODE_Event &lt;&lt; GPIOTE_CONFIG_MODE_Pos)| (WAKEUP_PIN &lt;&lt; GPIOTE_CONFIG_PSEL_Pos)| (GPIOTE_CONFIG_POLARITY_LoToHi &lt;&lt; GPIOTE_CONFIG_POLARITY_Pos); <span class="hljs-comment"><span class="hljs-comment">/*    SystemOFF*/</span></span> NRF_POWER-&gt;SYSTEMOFF = <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br></div></div><br>  Consumption in this mode directly depends on the number of active memory blocks and is: <br>  <font color="#0d3f66"><b>0.6 ¬µA</b></font> - no active RAM blocks <br>  <font color="#0d3f66"><b>1.8 ¬µA</b></font> - 16 Kb RAM Active <br>  <font color="#0d3f66"><b>3.0 ¬µA</b></font> - 32 KB RAM active <br><br>  In general, an interesting energy saving mode, but not everyone will like it because of the meager list of possibilities to wake up the controller. <br><br><h2>  A / D Converter (ADC) </h2><br>  Analog-to-digital converter (ADC) is one of the most frequently used elements of the periphery of a microcontroller.  I see no point in describing the principle of his work, since a great number of third-party articles of varying degrees of depth have been written about this.  However, pay attention to the features of the ADC is worth.  The nRF51822 has one ADC and its characteristics are quite modest: <br>  - 8 channels + 2 external channels for supplying an external reference voltage; <br>  - resolution of 8.9.10 bits; <br><br><img src="https://habrastorage.org/webt/rd/jv/m5/rdjvm5yjascd8001muv-d2jb9yg.png"><br><br>  Actually, everything that can be said about the main characteristics.  It should be noted that the channels are multiplexed, i.e.  Sampling at a time can only occur from one channel, and the conversion mode, unfortunately, is only one - a one-time conversion.  You can implement uninterrupted using a timer and a PPI module, but we'll talk about this a little later. <br>  Also, an important parameter is the time of one conversion, which must be considered in the case of the implementation of continuous conversion of several channels with intermediate data processing. <br>  <font color="#0d3f66"><b>68 Œºs</b></font> - 10 bit ADC; <br>  <font color="#0d3f66"><b>36 ¬µs</b></font> - 9 bit ADC; <br>  <font color="#0d3f66"><b>20 Œºs</b></font> - 9 bit ADC. <br><br>  To activate the ADC in the single conversion mode, you must perform the following steps in the following registers: <br>  <b>1.</b> <font color="#c00000">CONFIG</font> - determine the ADC digit capacity in the register; <br>  <b>2.</b> <font color="#c00000">CONFIG</font> - determine the voltage divider in the register; <br>  <b>3.</b> <font color="#c00000">CONFIG</font> ‚Äî determine the channel number to be converted in the register; <br>  <b>4.</b> <font color="#c00000">POWER</font> - activate interrupts (optional) in the register; <br>  <b>5.</b> <font color="#c00000">ENABLE</font> - apply power to the ADC in the register. <br>  <b>6.</b> <font color="#c00000">TASKS_START</font> - start the conversion in the register. <br><br>  Below is an example of the initialization of the ADC for carrying out a single conversion with the subsequent processing of the result obtained in the interrupt. <br><br><div class="spoiler">  <b class="spoiler_title">ADC initialization function</b> <div class="spoiler_text"><pre> <code class="hljs php"><span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  - 10 ,   - 1/3,   - 2 */</span></span> NRF_ADC-&gt;CONFIG |= (ADC_CONFIG_RES_10bit &lt;&lt; ADC_CONFIG_RES_Pos)| (ADC_CONFIG_INPSEL_AnalogInputOneThirdPrescaling &lt;&lt; ADC_CONFIG_INPSEL_Pos)| (ADC_CONFIG_PSEL_AnalogInput2 &lt;&lt; ADC_CONFIG_PSEL_Pos); <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> NRF_ADC-&gt;INTENSET |= ADC_INTENSET_END_Enabled &lt;&lt; ADC_INTENSET_END_Pos; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> NRF_ADC-&gt;ENABLE |= ADC_ENABLE_ENABLE_Enabled &lt;&lt; ADC_ENABLE_ENABLE_Pos; <span class="hljs-comment"><span class="hljs-comment">/*    NVIC    */</span></span> NVIC_SetPriority(ADC_IRQn, <span class="hljs-number"><span class="hljs-number">1</span></span>); NVIC_EnableIRQ(ADC_IRQn); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> NRF_ADC-&gt;TASKS_START = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">ADC interrupt handler</b> <div class="spoiler_text"><pre> <code class="hljs vala"><span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> #define ADC_REF <span class="hljs-number"><span class="hljs-number">1200</span></span> #define ADC_PRESCALING <span class="hljs-number"><span class="hljs-number">3</span></span> uint16_t adc_value, adc_value_in_mV; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ADC_IRQHandler(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>){ <span class="hljs-comment"><span class="hljs-comment">/*  ,     */</span></span> NRF_ADC-&gt;EVENTS_END = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(NRF_ADC-&gt;CONFIG &gt;&gt; ADC_CONFIG_PSEL_Pos){ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (ADC_CONFIG_PSEL_AnalogInput2): adc_value = NRF_ADC-&gt;RESULT; adc_value_in_mV = ((adc_value*ADC_REF)/<span class="hljs-number"><span class="hljs-number">1024</span></span>)*ADC_PRESCALING <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*         */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }</code> </pre><br></div></div><br>  I don‚Äôt see a more detailed description, as for people who read datasheets, the setting will not be difficult (there are few registers, all are intuitive), and for those who don‚Äôt like to read them, this information (and the one described below) will be enough to run and use the ADC. <br><br><img src="https://habrastorage.org/webt/ad/su/bd/adsubdzjykdtbqmcm8trog2y1l8.png"><br><br><h2>  Timers (TIMER) </h2><br>  The nRF51822 has 3 timers that can operate in two modes: in timer mode (comparison) and counter (capture).  All timers are 8, 16, 24 and 32 bit. <br><br><img src="https://habrastorage.org/webt/-4/lq/dj/-4lqdj0ge0palt1onuec1npz0eo.png"><br><br>  <b><i><font color="#0d3f66">Timer mode (comparison):</font></i></b> The most common timer mode.  The current value of the counter is compared with the value in the <font color="#c00000">CC [n]</font> register and generates an event / interrupt when these two values ‚Äã‚Äãmatch.  The most commonly used mode, as with it you can count down time intervals. <br><br>  <b><i><font color="#0d3f66">Counter mode (signal capture):</font></i></b> When an external pulse arrives, the timer captures (captures) the current counter value in the <font color="#c00000">CC [n]</font> register.  At the next pulse, the timer again fixes the value of the counter in the same register.  Thus, we can get the period or the duration of the input pulse.  You can catch both the front of the pulse and the decline.  Very useful timer operation mode. <br><br>  The timer frequency is calculated using the following formula: <br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>f</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>T</mi><mi>I</mi><mi>M</mi><mi>E</mi><mi>R</mi></mrow></msub><mo>=</mo><mtext>&amp;#xA0;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>16</mn><mspace width=&quot;mediummathspace&quot; /><mi>M</mi><mi>H</mi><mi>z</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>p</mi><mi>r</mi><mi>e</mi><mi>s</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>e</mi><mi>r</mi></mrow></msup></mrow></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="32.345ex" height="2.901ex" viewBox="0 -987.6 13926.1 1249" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMATHI-66" x="0" y="0"></use><g transform="translate(490,-150)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMATHI-54" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMATHI-49" x="704" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMATHI-4D" x="1209" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMATHI-45" x="2260" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMATHI-52" x="3025" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMAIN-3D" x="3544" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMATHI-66" x="4850" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMATHI-72" x="5401" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMATHI-61" x="5852" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMATHI-63" x="6382" y="0"></use><g transform="translate(6815,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMAIN-36" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMATHI-4D" x="1223" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMATHI-48" x="2274" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMATHI-7A" x="3163" y="0"></use></g><g transform="translate(10447,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,412)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMATHI-70" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMATHI-72" x="503" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMATHI-65" x="955" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMATHI-73" x="1421" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMATHI-63" x="1891" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMATHI-61" x="2324" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMATHI-6C" x="2854" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMATHI-65" x="3152" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/345396/&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhivaBcBXPFHPaRqYKGBkld6ognv3A#MJMATHI-72" x="3619" y="0"></use></g></g></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msub><mi>f</mi><mrow class="MJX-TeXAtom-ORD"><mi>T</mi><mi>I</mi><mi>M</mi><mi>E</mi><mi>R</mi></mrow></msub><mo>=</mo><mtext>&nbsp;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><mn>16</mn><mspace width="mediummathspace"></mspace><mi>M</mi><mi>H</mi><mi>z</mi></mrow><mrow class="MJX-TeXAtom-ORD"><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mi>p</mi><mi>r</mi><mi>e</mi><mi>s</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>e</mi><mi>r</mi></mrow></msup></mrow></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-1"> f_ {TIMER} = \ frac {16 \: MHz} {2 ^ {prescaler}} </script></p><br>  To activate the timer in compare mode, you must perform the following steps in the following registers: <br>  <b>1.</b> <font color="#c00000">MODE</font> - determine the mode of the timer in the register; <br>  <b>2.</b> <font color="#c00000">PRESCALER</font> - define the clock divider in the register; <br>  <b>3.</b> <font color="#c00000">CC [n]</font> - determine the number of "ticks", up to which it is necessary to count in the register; <br>  <b>4.</b> <font color="#c00000">POWER</font> - activate the power of the timer in the register; <br>  <b>5.</b> <font color="#c00000">TASKS_START</font> - start the timer in the register. <br><br><img src="https://habrastorage.org/webt/9t/xe/kv/9txekvuqps5xypjexvghqtn44ni.png"><br><br>  Consider the initialization of the timer to count the time with an interval of 1 second.  Below is the timer initialization function, as well as the timer interrupt handler function, when the value set in the <font color="#c00000">CC [n]</font> register is reached: <br><br><div class="spoiler">  <b class="spoiler_title">Timer initialization function</b> <div class="spoiler_text"><pre> <code class="hljs php"> NRF_TIMER1-&gt;POWER = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> NRF_TIMER1-&gt;MODE = TIMER_MODE_MODE_Timer &lt;&lt; TIMER_MODE_MODE_Pos; <span class="hljs-comment"><span class="hljs-comment">/*     . :    (16 MHz)  2   9   31250 "" */</span></span> NRF_TIMER1-&gt;PRESCALER = <span class="hljs-number"><span class="hljs-number">9</span></span>; NRF_TIMER1-&gt;CC[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">31250</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> NRF_TIMER1-&gt;INTENSET = (TIMER_INTENSET_COMPARE0_Enabled &lt;&lt; TIMER_INTENSET_COMPARE0_Pos); <span class="hljs-comment"><span class="hljs-comment">/*    NVIC    */</span></span> NVIC_SetPriority(TIMER1_IRQn, NRF_APP_PRIORITY_HIGH); NVIC_EnableIRQ(TIMER1_IRQn); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> NRF_TIMER1-&gt;TASKS_START = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Timer interrupt handler function</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TIMER1_IRQHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*  ,    */</span></span> NRF_TIMER1-&gt;EVENTS_COMPARE[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> NRF_ADC-&gt;TASKS_CLEAR = <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre><br></div></div><br>  Yes, there are 4 registers for storing the Capture / Compare value of 4 <font color="#c00000">CC [0] - CC [3]</font> , but the counting register is one, so only 4 consecutive results can be counted, then clear the counting register and start counting again. <br><br><h2>  PPI module </h2><br>  Now we slowly approached why I so briefly and incompletely described the capabilities of the timer and ADC, because it was possible, as in most similar articles for other controllers (for example, STM32), to allocate a separate post for each module, to discuss each register, every bit ... And all this is boring and secondary, any of the articles about ADCs or timers will give you the necessary minimum knowledge base and there is no point in producing it again and again.  I propose to consider an interesting nRF51 module and with its help implement the standard TIMER + ADC bundle, thereby ensuring a continuous conversion mode with a given sampling rate. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ni/cr/c2/nicrc2nnnoxkplkl_fj3h-9xsey.png" width="80%"></div><br><br>  What is the need for a PPI module? <br>  A PPI module is needed to transfer event / interrupt data from one periphery to another without the involvement of the controller core.  For example, an RTC (Real Time Counter) interrupt can run any peripheral unit without a CPU.  In addition, communication via the PPI module between peripheral devices can occur when the CPU is sleeping or turned off. <br>  In our case, this module can be used to start ADC conversion, as a consequence of the event when the timer reaches the set value.  Thus, without the participation of the CPU, we will achieve the realization of a continuous conversion of the ADC. <br><br>  So, the PPI module has 16 channels available for programming grouped into 4 groups.  In addition, there are 12 channels already programmed by the system.  Below is the setup of these 12 channels ( <font color="#c00000">EEP</font> is the address of the periphery that triggered the event, <font color="#c00000">TEP</font> is the address of the task to be performed in the event of an event). <br><br><img src="https://habrastorage.org/webt/f7/xt/qp/f7xtqphykm4qfpjzdv4e1pxcgig.png"><br><br>  As mentioned earlier, the module for each channel has two registers - the event register and the task register executed in the event of an event. <br><br>  To activate the PPI module, you must perform the following steps in the following registers: <br>  <b>1.</b> <font color="#c00000">CHENSET</font> - activate the module required channel in the register; <br>  <b>2.</b> <font color="#c00000">CH [n] .EPP</font> - determine the address of the event in the register; <br>  <b>3.</b> <font color="#c00000">CH [n] .TEP</font> - determine the address of the task in the register; <br>  <b>4.</b> <font color="#c00000">CHG [n] .EN</font> - activate the group in which the given channel is in the register. <br><br>  Below is the initialization function of the PPI module for the TIMER + ADC bundle. <br><br><div class="spoiler">  <b class="spoiler_title">Timer initialization function</b> <div class="spoiler_text"><pre> <code class="hljs php"><span class="hljs-comment"><span class="hljs-comment">/*  .      NRF_TIMER1-&gt;EVENTS_COMPARE[0] */</span></span> NRF_PPI-&gt;CH[<span class="hljs-number"><span class="hljs-number">0</span></span>].EEP = <span class="hljs-number"><span class="hljs-number">0x40009140</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*  .      NRF_ADC-&gt;TASKS_START */</span></span> NRF_PPI-&gt;CH[<span class="hljs-number"><span class="hljs-number">0</span></span>].TEP = <span class="hljs-number"><span class="hljs-number">0x40007000</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> NRF_PPI-&gt;CHEN |= PPI_CHEN_CH0_Enabled; NRF_PPI-&gt;CHENSET |= PPI_CHENSET_CH0_Enabled; <span class="hljs-comment"><span class="hljs-comment">/*    PPI */</span></span> NRF_PPI-&gt;TASKS_CHG[<span class="hljs-number"><span class="hljs-number">0</span></span>].EN = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br></div></div><br>  A link to the project code of the TIMER + PPI + ADC bundle is in the appendix to the article. <br><br>  I would like to draw your attention to the fact that as people correctly suggested in the comments to the previous article, the nRF51822 is not the most stable chip.  There are a number of unobvious problems.  In addition, the chip itself, on the one hand, is rich on the periphery, on the other hand, it is rather poor.  The ADC is too slow, the lack of DMA for the part of the periphery for which it is most needed (SPIM, TWI, UART, ADC), the absence of FPU, all this limits this chip to use.  Many will say that this is nonsense, since with leaner characteristics you can make a lot of cool devices, as long as your hands are from that place.  And, in principle, they will be right.  BUT, at the moment there is a debugging board nRF52 with a chip nRF52832, devoid of all the listed disadvantages and much more stable than the 51st series, with the same price tag.  So be careful when choosing a controller for various tasks. <br>  In the next article, if it is, I will talk about the features of the implementation of various interfaces (SPIS, SPIM, TWI, UART), can capture the RTC and other peripherals. <br><br><h2>  Additional Information </h2><br>  <a href="https://drive.google.com/open%3Fid%3D1NtAiWvyfAVDj8_8zondVO0dGsJL3MmTw">Timer + PPI + ADC bundle implementation project</a> <br>  <a href="http://ultran.ru/interfeys-ppi-programmable-peripheral-interconnect">PPI interface</a> <br>  <a href="https://habrahabr.ru/post/343166/">NRF51822 in brief: Quick start</a> </div><p>Source: <a href="https://habr.com/ru/post/345396/">https://habr.com/ru/post/345396/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345384/index.html">The market for cryptocurrency caught up in terms of trading volume with the New York Stock Exchange</a></li>
<li><a href="../345386/index.html">How in TMemo to make vertical alignment, indents and TextHint</a></li>
<li><a href="../345388/index.html">HTML 5.2 in brief</a></li>
<li><a href="../345390/index.html">Synchronizing AssemblyVersion and Publish Version in a ClickOnce application</a></li>
<li><a href="../345392/index.html">Methods of simulation of probability distributions in the programming language Python</a></li>
<li><a href="../345402/index.html">Do not go to Fediverse, there you are in trouble. - Well, why not go there? They are waiting</a></li>
<li><a href="../345406/index.html">How and why we rethought the search input field of Yandex</a></li>
<li><a href="../345408/index.html">Who "goes to the clouds": Western IT startups that use virtual infrastructure</a></li>
<li><a href="../345410/index.html">Financial accounting for non-entrepreneurs</a></li>
<li><a href="../345412/index.html">Analyzing access logs using Splunk</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>