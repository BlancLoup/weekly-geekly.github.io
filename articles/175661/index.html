<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Windows Phone and continuous integration into TeamCity</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share my experience in setting up a continuous integration system for a Windows Phone 7 project in Team City. I hope to save those who go th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Windows Phone and continuous integration into TeamCity</h1><div class="post__text post__text-html js-mediator-article">  I want to share my experience in setting up a continuous integration system for a Windows Phone 7 project in Team City.  I hope to save those who go the same path, I spent time and nerves. <br><br>  <u>Given:</u> <br><ol><li>  A pretty massive Windows Phone 7 application with unit tests, implemented using <a href="http://silverlight.codeplex.com/">Silverlight Toolkit</a> . </li><li>  Customized build application in TeamCity without running unit tests.  The agent for the assembly is a ‚Äúphysical‚Äù (in the sense, not virtual) machine. </li></ol><br>  <u>It is necessary:</u> <br><ol><li>  Configure another TeamCity build agent on the VMWare virtual machine. </li><li>  Run unit tests for assemblies and collecting the results of their execution in TeamCity statistics. </li></ol><br><a name="habracut"></a><br><h4>  Setting up the build agent </h4><br>  A virtual machine with Windows Server 2008 R2 is used as a build agent.  At first, the setup seemed simple - we put Visual Studio, the Windows Phone SDK and the agent itself (the agent is downloaded directly from the site of the deployed TeamCity).  The test project without Silverlight ‚Äútook off‚Äù without problems - unit tests started right away, control of code coverage appeared using the built-in TeamCity dotCover: <br><img src="https://habrastorage.org/storage2/deb/a5b/c89/deba5bc89be9fed4ab7b9242431bdf5e.png"><br>  It was nice to get such a result in 5 minutes from scratch! <br><br><h4>  Running emulator </h4><br>  I caught fire, I took up the launch of the assembly of Windows Phone.  This is where the fun began. <br>  It must be said that in TeamCity we already had an assembly set up, during which we had to execute certain data preparation code.  This code was used in a ‚Äúlive‚Äù application, and it was too lazy to cut it off from the Silverlight Runtime.  Therefore, during assembly, the code was executed in the emulator called by the TeamCity agent.  This scheme worked on the existing build agent. <br>  However, it was possible to set up a similar assembly on the new build agent only after a couple of days, filled mostly with curses.  Here are the main shoals that I caught: <br><ul><li>  Windows Phone SDK was not installed - complained that he needed Windows 7, not recognizing the server OS.  Rescued <a href="http://blogs.msdn.com/b/astebner/archive/2010/05/02/10005980.aspx">Google and MSDN</a> .  Since I had a fully downloaded SDK, after editing baseline.dat according to the instructions, I ran setup.exe without the keys, while everything was installed as it should. </li><li>  The emulator did not start because <a href="http://www.kunal-chowdhury.com/2011/09/solution-for-program-can-start-because.html">Windows Media Player was not installed</a> .  Installing it under Windows Server 2008 was also not completely <a href="http://social.technet.microsoft.com/Forums/en-US/winservergen/thread/4db0c13a-9fb4-41a0-aebb-9c47df8a3536/">intuitive</a> . </li><li>  <a href="http://www.developer.nokia.com/Community/Wiki/Windows_Phone_8_SDK_on_a_Virtual_Machine_with_Working_Emulator">They say</a> that the emulator may not start without certain flags and manual (!) Editing configs of the virtual machine, but this has passed me away.  Perhaps because I needed the Windows Phone 7 emulator, and the dances with a tambourine are described for the Windows Phone 8 emulator. In addition, the administrator assured that the settings are all-inclusive. </li><li>  The emulator did not start until the RAM size of the virtual machine was increased from 1 GB to 2 GB.  It did not start silently - not a hint at the cause! </li></ul><br>  By the way, through the shortcut created when installing the SDK, the emulator does not start with me.  I did not understand why, because when I call it from the management utility, it starts normally. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The biggest problem surfaced at the end when the emulator finally started up.  The emulator warned when it started that for normal operation it <a href="">needs a</a> normal video card, which it was not possible to "forward" to the virtual machine.  Despite the fact that after such a formidable warning the emulator worked fine, the OK button had to be pressed by someone.  It was assumed that the emulator will be started by the TeamCity agent service and will not appear on the screen, so there was no one to press the button. <br>  In a desperate attempt, I tried to code with this unfortunate button, but it did not work when the emulator was started from the agent service. <br>  The only thing I could come up with in the end was to run the build agent not as a service, but as an application.  In this case, the emulator started up normally, and the button could be pressed manually (it is enough to do it only after the server is rebooted - once started, the emulator is used for all subsequent builds).  Nevertheless, I left the code for automatically pressing a button so that the reboot of the virtual machine was ‚Äúunattended‚Äù. <br>  Launching the agent as an application turned out to be simple - there is a good set of bat-files in the agent's bin directory (c: \ BuildAgent \ bin), which can be used to tear down the agent's service that is no longer needed, and also to run the agent as an application ( <a href="http://confluence.jetbrains.com/display/TCD7/Setting%2Bup%2Band%2BRunning%2BAdditional%2BBuild%2BAgents">there</a> is this topic). <br>  So, we register the necessary bat-file in autostart, we configure <a href="http://guruadmin.ru/page/how-to-enable-autologon-in-windows-7-windows-server-2008">automatic input after system start</a> (for "unattended" reboot) and voila!  Build works! <br>  The final touches were the launch of the emulator and the blocking of the workstation in the agent launch script.  Running the emulator was needed to eliminate the delay in the first build, performed after the virtual machine rebooted, and the lock - because the administrator asked (‚Äúno need when the console of the machine is open!‚Äù). <br>  The next step was to add unit tests to the build script.  Tests, as I said, were launched under the Unit Test Framework that comes with the Silverlight Toolkit.  The run on the emulator was already a passable stage, so the tests started up without problems: <br><img src="https://habrastorage.org/storage2/353/8b3/f93/3538b3f93a40f382ed3ffb22139dd8f6.png"><br><br><h4>  Transfer of test results to TeamCity </h4><br>  Further, it was logical that the tests would not just run, but ‚Äúcrash‚Äù the assembly if they failed.  To do this, it was necessary to transfer the results of the tests to TeamCity. <br>  Another retreat - we ran the emulator from the build scripts via the CoreCon API, thanks for <a href="http://justinangel.net/WindowsPhone7EmulatorAutomation">Justin Angel</a> and <a href="https://habrahabr.ru/users/arty87/" class="user_link">arty87</a> .  That is, in the build script, a console application was launched that actually controlled the emulator. <br>  The first solution that came to my head and was immediately tested was to ‚Äúcrash‚Äù the assembly with a fallen test, leaving the emulator control application with a nonzero exit code.  At the same time, you could still write something to the console - then it can be seen in the TeamCity build log. <br>  But I wanted beauty, so that TeamCity could keep statistics on the tests, and even during the course of the assembly it was obvious how they are being performed (very meditatively, by the way).  Therefore, the <a href="http://confluence.jetbrains.com/display/TCD7/Build%2BScript%2BInteraction%2Bwith%2BTeamCity">Service Message API</a> was excavated, which in fact turned out to "catch" a special kind of tags from the console output.  Two features emerged here: <br><ol><li>  Tags must be single line.  TeamCity perceives a line break as the end of a tag, so the tag turns out to be of the wrong format and is ignored.  The <a href="http://confluence.jetbrains.com/display/TCD7/Build%2BScript%2BInteraction%2Bwith%2BTeamCity">documentation</a> in the example shows the transfer of the translation of strings by the sequence "| n | r", but this did not work for me. </li><li> Tags should not be too long.  Attempting to cut the line breaks from the stektrais and pass it as details in the testFailed tag led TeamCity to arbitrarily split the resulting long string somewhere into 300 characters with all that it implies.  Interestingly, the rest of the string is clearly longer than 300 characters in length in the Build Log without any partitions.  I have not experimented in detail and decided to display the error frame just in Build Log <br></li></ol><br>  It remains to solve two tasks: to catch the fact of the start and end of tests and transfer it all from the code executed in the emulator to the emulator control utility (after all, the utility should write to the console, not the emulator on which the tests are run). <br>  The first task was solved simply.  In the Unit-test framework, it is possible to subscribe to the events of the start and end of tests, test classes and entire assemblies, in the handlers of which we can learn a lot of information (test result, Exception if the test fails, start and end times, etc.).  I didn‚Äôt look for any documentation on the framework, it turned out to be easier to learn using the ‚Äúspear method‚Äù. <br>  So, to run unit tests with output, we slightly modify the standard start code: <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainPage_Loaded</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, RoutedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> testPage = UnitTestSystem.CreateTestPage(GetSettings()) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IMobileTestPage; BackKeyPress += (x, xe) =&gt; xe.Cancel = testPage.NavigateBack(); (Application.Current.RootVisual <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> PhoneApplicationFrame).Content = testPage; }</code> </pre> <br>  The modification is to call the function GetSettings.  This is the very function: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> UnitTestSettings </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetSettings</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> settings = UnitTestSystem.CreateDefaultSettings(); settings.TestHarness.TestClassStarting += TestHarnessTestClassStarting; settings.TestHarness.TestClassCompleted += TestHarnessTestClassCompleted; settings.TestHarness.TestMethodStarting += TestHarnessTestMethodStarting; settings.TestHarness.TestMethodCompleted += TestHarnessTestMethodCompleted; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> settings; }</code> </pre><br>  Now we are closely following our tests.  The code of event handlers is trivial, I will not give it. <br>  Now we need to transfer the results of the surveillance to the emulator control program, where we can output them to the console as tags of the Message Message API. <br>  Isolated Storage was used as a transmission channel, as was actually described in the <a href="http://habrahabr.ru/post/117294/">article</a> .  However, in contrast to the proposed FileDeployer file sharing class was used RemoteIsolatedStorage. <br>  However, this method of transmission was not very good.  Since we wanted to send information about tests in real time, the test results were immediately recorded in the Isolated Storage file on the emulator, and the management utility periodically read this file and output the newly obtained results to the console.  Due to locks on the file, the record periodically ‚Äúfell‚Äù, which did not affect the tests being performed, but led to the loss of information about them.  Solved the problem with a ‚Äúcrutch‚Äù - catching recording errors and repeating errors.  Of course, according to Feng Shui, you need to use a more suitable method of data exchange with the emulator, for example, via IP.  However, I didn‚Äôt want to bother with this, because the long-awaited result had already been obtained: <br><img src="https://habrastorage.org/storage2/9c4/e19/ca3/9c4e19ca321080b3a1421fd40d7b9697.png"><br><br>  There remains an unfulfilled desire to control more and code coverage with unit tests.  As it turned out, normally it would not be possible to control the code coverage in the SIlverlight Runtime.  Big people <a href="http://channel9.msdn.com/posts/Code-Coverage-for-Silverlight-and-Windows-Phone-ViewModels">advise</a> recompiling test code in a regular .NET CLR to get coverage.  However, with the existing volume of tests, sometimes very rigidly tied to the Silverlight Runtime, it was considered to be impractical.  Nevertheless, the dream has remained, and I will try to realize it on the beginning of a small project.  I hope everything will turn out and I can share my joy. <br><br>  PS This is my first post, so I am ready for constructive criticism and suggestions. </div><p>Source: <a href="https://habr.com/ru/post/175661/">https://habr.com/ru/post/175661/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../175645/index.html">OwnCloud installation and configuration</a></li>
<li><a href="../175651/index.html">Problems of long PHP scripts</a></li>
<li><a href="../175655/index.html">How we improved the work of the support service in Yandex.Mail</a></li>
<li><a href="../175657/index.html">Code as an argument in Cach√© ObjectScript</a></li>
<li><a href="../175659/index.html">Globals MUMPS: Extreme Database Programming. Part 1</a></li>
<li><a href="../175663/index.html">Installing Nexus 1000V on vSphere 5.1 (Part One)</a></li>
<li><a href="../175665/index.html">Browser Games (Poll)</a></li>
<li><a href="../175669/index.html">PXE boot menu with System Center Configuration Manager</a></li>
<li><a href="../175671/index.html">Petman from Boston Dynamics is ready to serve</a></li>
<li><a href="../175677/index.html">Counter of individual time counting on pure JavaScript</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>