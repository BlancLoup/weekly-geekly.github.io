<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Moscow public transport fare collection system</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 Back in 2005, when I was still a small child, I first saw such a thing as a ‚ÄúMuscovite Social Card‚Äù. Looking at how pensioners put it on ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Moscow public transport fare collection system</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/f95/135/65f/f9513565fb1795d166f494351498ab05.jpg" alt="image"><br>  <b>Prehistory</b> <br>  Back in 2005, when I was still a small child, I first saw such a thing as a ‚ÄúMuscovite Social Card‚Äù. Looking at how pensioners put it on when they pass through the turnstiles of land transport and the underground, I began to think about how this whole thing works system.  But in childhood I did not have the opportunity to do this.  Later, when I myself began to earn money, I decided to seriously begin to study the system of payment for public transport. <br><br>  <b>RFID</b> <br>  Of course, I started by searching Google and effortlessly found the name of this one - <b>RFID</b> ( <b>R</b> adio <b>F</b> requency <b>ID</b> entification) or translated into Russian Radio Frequency Identification.  After reading the article on Wikipedia, I realized that the labels (maps) are divided into 3 work bands, <b>LF</b> Band Tags (125-134 kHz), <b>HF</b> Band Tags (13.56 MHz), <b>UHF</b> Band Tags (860-960 MHz).  In public transport used tags second range - <b>HF</b> . <br><a name="habracut"></a><br>  <b>Cards</b> <br>  The cards themselves are manufactured under the name of the brand <b>Mifare</b> , which combines several types of smartcard chips, reader chips and products based on them. <br>  At the moment 5 types of microcircuits for cards are produced: <br><br>  Mifare Classic 1k, Mifare Classic 4k <br>  Mifare ultralight <br>  Mifare ultralight c <br>  Mifare Plus <br>  Mifare DESFire EV1 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Our public transport uses the first and second types of maps. <br><br>  Muscovite social map is made on the basis of <b>Mifare 1k</b> <br>  Student social card is made on the basis of <b>Mifare 4k</b> <br>  Ticket for several trips on the subway made on the basis of <b>Mifare Ultralight</b> <br>  1k and 4k indicate the amount of memory on the card 1 and 4 kilobytes, respectively. <br>  I also had a social card of a resident of the Moscow region, which differed from the first only in name and design. <br><img src="https://habrastorage.org/getpro/habr/post_images/958/a9a/c28/958a9ac281ac9e7e0f5665c3894db5c4.jpg" alt="image"><img src="https://habrastorage.org/getpro/habr/post_images/e44/276/3d0/e442763d0b2e3b4b11b0bf2ff6fca1b9.jpg" alt="image"><img src="https://habrastorage.org/getpro/habr/post_images/def/a14/46c/defa1446cac934ec07504ced135e7722.jpg" alt="image"><img src="https://habrastorage.org/getpro/habr/post_images/a4e/cd4/75b/a4ecd475b7745086cf98e2a230b9144c.jpg" alt="image"><br><br>  <b>Practice</b> <br>  Naturally, to see the data recorded on the card and how to work with them, a reader was needed for these cards.  During the search, I came across a model called <b>ACR122U</b> .  For the price, it suited me perfectly, with delivery from an online auction ebay came out about $ 60. <br>  Finally, 3 weeks later, I received the cherished package, the reader itself lay in it, two empty white Mifare 1k cards and a CD with drivers and a distribution kit. <br><img src="https://habrastorage.org/getpro/habr/post_images/6d6/220/48c/6d622048c19b975ae69c2e0970e0c271.jpg" alt="image"><br>  Actually reader. <br><br>  I immediately connected it to the laptop, installed the necessary drivers, the reader identified the card, everything went as it should.  Now I have a question about how to count my card.  Initially, I thought that the disk will have all the necessary programs for this and it will be easier than ever, but it turned out to be not there.  From what was on the disk, only drivers turned out to be useful, no matter how funny it sounded.  I had to use the search again. <br><br>  <b>Soft</b> <br>  After several days of searching, I found such a development kit called <b>libNFC</b> .  Having studied it a little, I realized that this is exactly what is needed.  Simultaneously, I stumbled upon a <a href="http://dark-simpson.livejournal.com/">blog of</a> one person named Alexander <a href="http://habrahabr.ru/users/darksimpson/" class="user_link">darksimpson</a> Simonov, who spoke about the system of operation of the turnstiles of the metro, as well as about this project.  Moreover, he even collected all the necessary programs for Windows, which was very convenient.  Then I began to test.  But first, let me tell you about the structure of the map. <br><br>  <b>Map structure</b> <br>  Here I will look at the structure of the Mifare 1k and 4k maps.  The 1k card is divided into 16 sectors, from 0 to 15. The zero sector is the manufacturer‚Äôs unit, in which the individual serial number of the <b>UID</b> card is recorded; it is registered in production and cannot be changed.  The remaining 15 sectors are available for reading / writing.  Each sector has two keys of the form <b>A</b> and <b>B</b> , as well as <b>LOCK-bits</b> . <br>  The combination of the latter gives the reader information about whether read / write is allowed and then using what kind of keys it can be done.  Basically, reading occurs through keys of type <b>A</b> , writing through keys of type <b>B.</b>  On empty cards in all sectors there are <b>FFFFFFFFFFFF</b> keys. For 4k, the situation is the same, but instead of 16 sectors there are 40 on it. That is, to read the contents of the card on a computer, you need to know the keys from all 16 sectors, but since all of the tickets are changed, a logical question arises, how do you know these keys?  This was helped by the <b>MFCUK</b> utility <b>that was</b> modified and compiled for Windows by another blogger under the nickname <a href="http://habrahabr.ru/users/odinokij_kot/" class="user_link">Odinokij_kot</a> .  You can read about the work of this program in his <a href="http://odinokij-kot.livejournal.com/15429.html">article.</a> <br><img src="https://habrastorage.org/getpro/habr/post_images/8a0/e7b/6b5/8a0e7b6b5a4a19dd872deff8d3e1e7ee.png" alt="image"><br>  <b>MFCUK operation example</b> <br><br>  <b>Card reading</b> <br>  To read the card, I needed the downloaded program <b>mfclassic_d.exe</b> , the keys found for my social card of a resident of the Moscow region and the command line.  In the latter, I indicated the path to the program, the file with the keys from my card, the type of keys, the request for reading and the name of the file in which the card dump is written.  After pressing the cherished <b>Enter</b> button, the reading process started, after a couple of seconds it was over, as shown by the words <b>Done, 64 of 64 blocks read.</b>  <b>Writing data to file: card.mfd ... Done</b> .  After that, I tried to understand the data that was written on the card, but it didn‚Äôt lead to anything, since the file contained only a bunch of hexadecimal numbers, the only thing that was more or less clear was the passport data recorded in one of the sectors.  The card is recorded in the same way, only you need to specify the file with the keys for the card to which we are recording. <br><img src="https://habrastorage.org/getpro/habr/post_images/b01/86a/4d6/b0186a4d6301c07763e910920f2c7f71.png" alt="image"><br>  <b>Example of mfclassic_d</b> <br><br>  <b>Start of experiments.</b>  <b>Test number number 1</b> <br>  At first I counted the card before the passage through the turnstile of the bus, and after.  I did the same thing with the turnstile in the subway.  After comparing the dumps of the map, I found out that after the passage in buses, trams and trolleybuses only the data recorded in sector 4 changed, the remaining data remained the same, in the metro only the data of sector 1 changed.  From here a conclusion, <b>metal scissors</b> use 1 sector, <b>ground workers</b> 4. <br><br>  <b>Test number 2.</b>  <b>Land</b> <br>  The second question was the possibility of cloning my card to one of the two whites that came with the reader.  Having indicated the file of my card in the program, as well as the keys to the blank card, I began the recording process, it took a little more than reading, approximately 4 seconds.  The words ‚Äú <b>Done, 64 of 64 blocks written‚Äù</b> appeared in the command line window, which indicated successful writing to the card.  After that I went to the <b>baptism of fire</b> .  The bus came, at the bus stop there were 3 people, I came in last, so as not to create a queue in case of an unforeseen situation.  So, I walk up to the turnstile, attach the card I just recorded, and lo and behold, the turnstile showed the validity period of my social card, blinked with a green lamp and friendly missed me at the salon.  My happiness knew no bounds.  Later I checked the map on trolley buses and trams, the result was the same. <br><br>  <b>Test number 3.</b>  <b>Subway</b> <br>  Inspired by the success in ground transportation, I went to the subway.  Downstairs, I went to the turnstile, attached the same white card, on the monitor of the turnstile the inscription <b>Valid until: hh.mm.gg</b> , then I calmly passed through the turnstile.  For me, of course, the result was expected, but there were still notes of doubt.  I was pleased as an elephant, in my head was the thought of an unconditional victory over the public transport of the city of Moscow.  Having arrived at one place, about an hour later I had to go down to the subway again and then the biggest surprise awaited me.  Attaching a white card to the turnstile, I saw the ominous inscription <b>Ticket is not working</b> .  I attached it to another pair of turnstiles, the result was the same.  Then I got a real social card and only with its help I successfully passed through the turnstile.  In the subway, I kept thinking what happened after all.  Out on the street I went to the bus stop, got on the bus, attached a white card, it worked.  Strange, I thought.  Returning home, I began to find out what is wrong.  Finding no logical explanation, I went to bed.  The next morning I went down to the subway, put my original social map and saw that same notorious inscription. The <b>ticket is not working properly</b> .  After that, I proceeded to the cashier for an explanation of what was happening, where I was told that ‚Äúmaybe you handed over the card to another person who went through it and noticed it.  Because of this, your card was added to the <b>STOP list.</b> ‚ÄùThen they explained to me what to do and where to go in order to unblock the card.  After 2 weeks, according to my application, the card was unblocked and I continued to drive it. <br><img src="https://habrastorage.org/getpro/habr/post_images/958/b0d/73b/958b0d73be417e43fd7469e06805136c.jpg" alt="image"><br><br>  <b>STOP list</b> <br>  There is not so much information about this very sheet on the Internet, everything I know about it, I heard from people who know this system firsthand.  It contains the serial numbers of the cards ( <b>UID</b> ) of those cards that do not behave correctly, as well as, for example, the numbers of student cards whose owners have been deducted from the university.  This <b>STOP list</b> is stored in each turnstile on the subway and synchronizes with the common base approximately every 10 minutes.  If you attach a card with a <b>UID</b> listed on this sheet, the turnstile will not let you through, even if the card‚Äôs validity period has not yet expired.  Now an explanation of why my cards were blocked.  After I attached the white card, the turnstile sent the data to the database for verification, where the <b>UID</b> and the rest of the card information, the validity period and its number (not the UID) are compared.  During the test, the database finds out that there is no issued card for this <b>UID</b> , it searches for the real <b>UID</b> from this data and then sends both <b>UIDs</b> to the <b>STOP list</b> .  That is, the cards were blocked due to the fact that the serial number of the white card was different from the original one.  Why this did not happen on land transport?  Because all ground turnstiles do not have a common database in which data could be compared, it does not exist because it is impossible to put all the turnstiles together.  Thus, the turnstile reads only the card type and its validity, ignoring the <b>UID</b> , which in turn can be anything. <br><br>  <b>MIfare Zero</b> <br>  I couldn‚Äôt stop in my experiments, and I don‚Äôt think so much more.  And here I was visited by the thought that if suddenly, somehow, I changed the <b>UID</b> to the same as the original map.  And after searching in Google, I came across a <a href="http://mifare.livejournal.com/">blog of</a> another person named Andrew, who wrote about the method of cloning <b>Mifare</b> cards.  It turned out that there are unofficially produced cards called <b>Mifare Zero</b> .  In these same cards, the manufacturer‚Äôs block, that is, the <b>UID</b> can be changed to any other.  After talking with Andrew, I found out that he had the data cards, and that for experiments he was ready to sell me one of them.  We agreed to meet at one of the metro stations, where I got this card. <br><img src="https://habrastorage.org/getpro/habr/post_images/609/34c/679/60934c67935747033c4256d65529a111.jpg" alt="image"><br>  <b>Image of Mifare Zero from Andrey's blog</b> <br><br>  <b>Experiment number 5.</b>  <b>Return to the subway</b> <br>  Writing my card to the <b>Mifare Zero</b> card, using the <b>mfsetuid_d.exe</b> utility <b>,</b> I put the <b>UID of</b> my social card on it.  Now these were two identical cards that differed only in pattern, on one he was, on the other not.  Having gone down the subway, I successfully went through this map, but it was too early to rejoice, I had to repeat the passage after a while in order to make sure that the card was working and that it would not be blocked.  For a whole week I passed through the turnstile on a white card, everything was fine, it was not entered into the <b>STOP list</b> .  Success! <br><br>  <b>Experiment number 6</b> <br>  The next thing I wanted was to test if several people could pass at once, because it was possible to go through my map 1 time in 7 minutes.  Taking both cards, my friend and I went to the subway.  First, I went through the original map, then a friend on white at the neighboring turnstile, so far everything is fine, after sitting in McDuck, we went back, but unfortunately both cards were blocked.  The explanation for this is that after my passage the data about my map came to the database, they checked, everything converges, a friend passed and the data was again correct.  But the system saw that one card went through 2 times without having sustained the 7 minute interval, this can not be, the card behaves not correctly and therefore the system blocked it.  The conclusion from this is that you can still clone the map, but the protection system in the metro works fine and it is probably impossible to get around it.  But a couple of pans still remained. <br><br>  <b>Experiment No. 7</b> <br>  The subject of this test are student cards.  Once I suggested that if, for example, there are two student passes.  One of them is extended for this month, the second is not.  So, if it is trivial to copy 1 sector from an extended travel card to a non-renewed one, then what can be done? .. Beginning of the month.  I did not renew the student card and took my friend‚Äôs extended card for several hours, counted the contents of sector 1 and wrote it on my card.  After that, I went to the subway with my map, having attached it, I saw that the validity of the card until the end of this month.  As a result, I traveled on this map all day long, it was not blocked.  Then I thought again that it was a victory, the card is not blocked and it can be renewed from any extended student, but as usual it was not there.  The card was blocked the next morning.  Apparently this happens because at the end of each day the base checks whether the student card has really been renewed for the current month, in our case it does not, therefore the card in the <b>STOP list</b> <br><br>  <b>findings</b> <br>  The fare payment system in the Moscow metro was created with accurate knowledge of all the discoveries in the <b>Mifare</b> field.  No, of course you can go through a non-original ticket, but you can only do this a few times, after which it will be blocked.  The <b>STOP list system</b> works at the proper level.  As they say "free cheese only in a mousetrap." <br><br>  In the next article I will talk about my experiments on ground transportation, with various types of maps and types of travel.  Thanks for attention. <br><br>  <b>This article is written only for familiarization, and in no case does not call to engage in falsifying travel tickets, since this is contrary to article 327 of the Criminal Code of the Russian Federation.</b>  <b>The author is not responsible for any illegal actions committed by people under the influence of this article.</b> </div><p>Source: <a href="https://habr.com/ru/post/175557/">https://habr.com/ru/post/175557/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../175539/index.html">Bitcoin conquers television screens</a></li>
<li><a href="../175541/index.html">25% of the Danish energy sector in 2013 is wind turbines</a></li>
<li><a href="../175543/index.html">Note on entering American colleges</a></li>
<li><a href="../175551/index.html">Grabcad - announced a volunteer contest to create glasses that allow deaf people to see and read a speech, or maybe more</a></li>
<li><a href="../175553/index.html">A Brief History of Animals on O'Reilly Books</a></li>
<li><a href="../175559/index.html">As I wrote skad. Part five</a></li>
<li><a href="../175563/index.html">How to listen to the radio using powershell and node.js</a></li>
<li><a href="../175569/index.html">How Visa and Master Card Benefit from Working with Square</a></li>
<li><a href="../175571/index.html">Tree View with "CRUD operations", "drag and drop (DnD)" and "delayed loading" using Dojo Tree, Entity Framework, SQL Server and ASP.NET MVC</a></li>
<li><a href="../175575/index.html">Date mining and heuristics of finding places in restaurants: almost the same problem as with free parking</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>