<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We sharpen the old code under the new realities</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I will discuss one of the ways to transform the C / C ++ code into the code written in C # with the least effort. However, the princi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We sharpen the old code under the new realities</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/habraeffect/90/1a/901a6a5c50de09fbefc43fa6b6368549.jpg" alt="Sharp envelope knife" align="left">  In this article, I will discuss one of the ways to transform the C / C ++ code into the code written in C # with the least effort.  However, the principles described are suitable for other pairs of languages.  I want to immediately say that the method is not designed for the transformation of the code that implements the GUI. <br><br>  Why do it?  For example, I ported the well-known graphic library LibTiff (and LibJpeg at the same time) to C # in this way.  This made it possible to use the achievements of many people who created LibTiff in my program along with the .NET Framework class library.  Code examples in the article will be mainly from LibTiff and LibJpeg. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  1. Infrastructure </h4><br>  What is required: <br><ul><li>  The original code that you can collect "for one click." </li><li>  A set of tests, which can also be performed "one click". </li><li>  Version control system. </li><li>  Basic concepts of refactoring. </li></ul><br>  Requirements to collect for "one click" and perform "for one click" are needed in order to maximally speed up the cycle of "changed-compiled-launched tests".  The more effort it takes to perform one such cycle, the less often it will be executed.  This can lead to complex and large-scale rollbacks of unsuccessful changes. <br><br>  Version control system will suit any.  I use Subversion in my work - you, in turn, can use what is convenient for you.  The main thing is to use at least something other than folders on the disk. <br><br>  Tests will be required to ensure at any time that the code is still doing what it should, and just as before.  The assurance that the code does not functionally change is the main difference between the described method and the ‚Äúwrite everything from scratch in a new language‚Äù method.  Tests are not required to cover 100% of the code, but it is desirable to have tests for all the basic functionality.  It is desirable that the tests <u>do not</u> have access to the internal structure of the program, this will avoid the constant rewriting of tests. <br><br>  For example, to port LibTiff I used: <br><ul><li>  set of images in different versions of the TIFF format. </li><li>  a tiffcp console program that converts images from one TIFF to another. </li><li>  a set of scripts (bat-files) that call tiffcp to convert. </li><li>  set of expected output images. </li><li>  A program for binary comparison of images obtained after converting with expected images. </li></ul><br><br>  About refactoring it is enough to read only one book.  This is Martin Fowler's book Refactoring.  Improving existing code. ‚Äù  If you have not read it, be sure to read it - for any programmer, knowledge of refactoring principles is only useful.  The whole book is not necessary to read.  Enough to read about 130 pages from the beginning.  These are the first five parts and the beginning of the sixth part, before the ‚ÄúEmbedding Method‚Äù section. <br><br>  Of course, the better you know the languages ‚Äã‚Äãbetween which the code will be transformed, the easier it will be for you.  Note that the knowledge of the device of the original code is not required.  For a start, it‚Äôs enough to know <u>what the</u> source code does.  <u>How</u> he does this will become clear in the process of transformation. <br><br><h4>  2. The transfer process </h4><br>  The essence of the method is that the original code with a large number of simple and small changes is reduced to a simplified form, while maintaining its capabilities.  No need to try to immediately change a large piece of code and still optimize it in addition.  You need to move as small steps as possible and after each step, run tests and record successful changes.  That is, changed a little - checked.  If everything is in order, the changes are uploaded to the version system repository <br><br>  The transfer process can be divided into three major steps: <br><ol><li>  In the original code, everything that uses the specific capabilities of the source language is gradually replaced by a simpler, but equivalent in functionality.  This often leads to the fact that the code starts to work slower and does not look so beautiful.  Do not worry about it at this stage. </li><li>  The modified code is given to the form that will be able to build a new compiler. </li><li>  Tests are transferred, and the code in the new language is brought to coincidence in functionality with the original code. </li></ol><br>  Only after all these points have been completed is it worth remembering about the speed and beauty of the code. <br><br>  The main difficulty is the first stage.  At this stage, you need to convert the code in C / C ++ to the code in "pure C ++", as close as possible to the syntax for C #.  At this stage, you need to get rid of: <br><ul><li>  preprocessor directives </li><li>  goto operators </li><li>  typedef statements </li><li>  pointer arithmetic </li><li>  function pointers </li><li>  multiple inheritance </li><li>  ‚ÄúFree‚Äù functions </li></ul><br>  Let us proceed to the consideration of specific steps. <br><br><h5>  2.1 Delete unused code </h5><br>  The first step is to remove unused portions of the code.  For example, from LibTiff I first deleted all files that did not belong to the Windows version build.  Then, in the remaining files, I found conditional compilation statements, into which code ignored by the Visual Studio compiler was enclosed, and also deleted them.  Examples of such code: <br><br><blockquote> <code><font color="#008080">#if defined(__BORLANDC__) || defined(__MINGW32__)</font> &lt;br/&gt; <br> <font color="#008080"># define XMD_H 1</font> &lt;br/&gt; <br> <font color="#008080">#endif&lt;/code&gt;</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#008000">&lt;</font> code <font color="#008000">&gt;</font> <font color="#008080">#if 0</font> &lt;br/&gt; <br> <font color="#0600FF">extern</font> <font color="#0600FF">const</font> <font color="#FF0000">int</font> jpeg_zigzag_order <font color="#000000">[</font> <font color="#000000">]</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#008080">#endif</font> <br></code> </blockquote> <code><font color="#008080">#if defined(__BORLANDC__) || defined(__MINGW32__)</font> &lt;br/&gt; <br> <font color="#008080"># define XMD_H 1</font> &lt;br/&gt; <br> <font color="#008080">#endif&lt;/code&gt;</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#008000">&lt;</font> code <font color="#008000">&gt;</font> <font color="#008080">#if 0</font> &lt;br/&gt; <br> <font color="#0600FF">extern</font> <font color="#0600FF">const</font> <font color="#FF0000">int</font> jpeg_zigzag_order <font color="#000000">[</font> <font color="#000000">]</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#008080">#endif</font> <br></code> <br>  In many cases, unused functions can be found in the source code.  They also need to be sent to eternal rest. <br><br><h5>  2.2 Preprocessor and conditional compilation </h5><br>  Often conditional compilation is used to create specialized versions of a program.  This is when in one or several files with #define is configured that will be used during compilation, and the code in other files is enclosed in # ifdef / # endif.  Example: <br><br><blockquote> <code><font color="#008080">/*jconfig.h for Microsoft Visual C++ on Windows 95 or NT. */</font> &lt;br/&gt; <br> .....&lt;br/&gt; <br> <font color="#008080">#define BMP_SUPPORTED</font> &lt;br/&gt; <br> <font color="#008080">#define GIF_SUPPORTED</font> &lt;br/&gt; <br> .....&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#008080">/* wrbmp.c  */</font> &lt;br/&gt; <br> ....&lt;br/&gt; <br> <font color="#008080">#ifdef BMP_SUPPORTED</font> &lt;br/&gt; <br> ...&lt;br/&gt; <br> <font color="#008080">#endif /* BMP_SUPPORTED */</font> <br></code> </blockquote> <code><font color="#008080">/*jconfig.h for Microsoft Visual C++ on Windows 95 or NT. */</font> &lt;br/&gt; <br> .....&lt;br/&gt; <br> <font color="#008080">#define BMP_SUPPORTED</font> &lt;br/&gt; <br> <font color="#008080">#define GIF_SUPPORTED</font> &lt;br/&gt; <br> .....&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#008080">/* wrbmp.c  */</font> &lt;br/&gt; <br> ....&lt;br/&gt; <br> <font color="#008080">#ifdef BMP_SUPPORTED</font> &lt;br/&gt; <br> ...&lt;br/&gt; <br> <font color="#008080">#endif /* BMP_SUPPORTED */</font> <br></code> <br><br>  I recommend to immediately select what will be used and get rid of the conditional compilation.  For example, if you decide that support for BMP pictures is needed, then you need to remove the #ifdef BMP_SUPPORTED command from the entire code. <br><br>  If you need to save the creation of multiple versions of the program, then you need to make a set of tests for each version of the program.  I advise you to leave one of the most complete version and work with it.  After the transfer is complete, you can add the necessary conditional compilation commands again. <br><br>  This does not end the work with the preprocessor.  It is necessary to find preprocessor commands that emulate functions, and replace them with full-fledged functions. <br><br><blockquote> <code><font color="#008080">#define CACHE_STATE(tif, sp) do { \</font> &lt;br/&gt; <br> BitAcc <font color="#008000">=</font> sp <font color="#008000">-&gt;</font> data <font color="#008000">;</font> \&lt;br/&gt; <br> BitsAvail <font color="#008000">=</font> sp <font color="#008000">-&gt;</font> bit <font color="#008000">;</font> \&lt;br/&gt; <br> EOLcnt <font color="#008000">=</font> sp <font color="#008000">-&gt;</font> EOLcnt <font color="#008000">;</font> \&lt;br/&gt; <br> cp <font color="#008000">=</font> <font color="#000000">(</font> unsigned <font color="#FF0000">char</font> <font color="#008000">*</font> <font color="#000000">)</font> tif <font color="#008000">-&gt;</font> tif_rawcp <font color="#008000">;</font> \&lt;br/&gt; <br> ep <font color="#008000">=</font> cp <font color="#008000">+</font> tif <font color="#008000">-&gt;</font> tif_rawcc <font color="#008000">;</font> \&lt;br/&gt; <br> <font color="#000000">}</font> <font color="#0600FF">while</font> <font color="#000000">(</font> <font color="#FF0000">0</font> <font color="#000000">)</font> <br></code> </blockquote> <code><font color="#008080">#define CACHE_STATE(tif, sp) do { \</font> &lt;br/&gt; <br> BitAcc <font color="#008000">=</font> sp <font color="#008000">-&gt;</font> data <font color="#008000">;</font> \&lt;br/&gt; <br> BitsAvail <font color="#008000">=</font> sp <font color="#008000">-&gt;</font> bit <font color="#008000">;</font> \&lt;br/&gt; <br> EOLcnt <font color="#008000">=</font> sp <font color="#008000">-&gt;</font> EOLcnt <font color="#008000">;</font> \&lt;br/&gt; <br> cp <font color="#008000">=</font> <font color="#000000">(</font> unsigned <font color="#FF0000">char</font> <font color="#008000">*</font> <font color="#000000">)</font> tif <font color="#008000">-&gt;</font> tif_rawcp <font color="#008000">;</font> \&lt;br/&gt; <br> ep <font color="#008000">=</font> cp <font color="#008000">+</font> tif <font color="#008000">-&gt;</font> tif_rawcc <font color="#008000">;</font> \&lt;br/&gt; <br> <font color="#000000">}</font> <font color="#0600FF">while</font> <font color="#000000">(</font> <font color="#FF0000">0</font> <font color="#000000">)</font> <br></code> <br><br>  To correctly compile the function signature, you need to know the types of all variables.  Note that the variables BitAcc, BitsAvail, EOLcnt, cp and ep are assigned values.  These variables will become the parameters of the new function, and they must be passed by reference.  That is, for example, for BitAcc, you need to write uint32 &amp; in the function signature. <br><br>  Sometimes programmers abuse preprocessor commands.  Look at a real example of such abuse: <br><br><blockquote> <code><font color="#008080">#define HUFF_DECODE(result,state,htbl,failaction,slowlabel) \</font> &lt;br/&gt; <br> <font color="#000000">{</font> register <font color="#FF0000">int</font> nb, look <font color="#008000">;</font> \&lt;br/&gt; <br> <font color="#0600FF">if</font> <font color="#000000">(</font> bits_left <font color="#008000">&lt;</font> HUFF_LOOKAHEAD <font color="#000000">)</font> <font color="#000000">{</font> \&lt;br/&gt; <br> <font color="#0600FF">if</font> <font color="#000000">(</font> <font color="#008000">!</font> jpeg_fill_bit_buffer <font color="#000000">(</font> <font color="#008000">&amp;</font> state,get_buffer,bits_left, <font color="#FF0000">0</font> <font color="#000000">)</font> <font color="#000000">)</font> <font color="#000000">{</font> failaction <font color="#008000">;</font> <font color="#000000">}</font> \&lt;br/&gt; <br> get_buffer <font color="#008000">=</font> state. <font color="#0000FF">get_buffer</font> <font color="#008000">;</font> bits_left <font color="#008000">=</font> state. <font color="#0000FF">bits_left</font> <font color="#008000">;</font> \&lt;br/&gt; <br> <font color="#0600FF">if</font> <font color="#000000">(</font> bits_left <font color="#008000">&lt;</font> HUFF_LOOKAHEAD <font color="#000000">)</font> <font color="#000000">{</font> \&lt;br/&gt; <br> nb <font color="#008000">=</font> <font color="#FF0000">1</font> <font color="#008000">;</font> <font color="#0600FF">goto</font> slowlabel <font color="#008000">;</font> \&lt;br/&gt; <br> <font color="#000000">}</font> \&lt;br/&gt; <br> <font color="#000000">}</font> \&lt;br/&gt; <br> look <font color="#008000">=</font> PEEK_BITS <font color="#000000">(</font> HUFF_LOOKAHEAD <font color="#000000">)</font> <font color="#008000">;</font> \&lt;br/&gt; <br> <font color="#0600FF">if</font> <font color="#000000">(</font> <font color="#000000">(</font> nb <font color="#008000">=</font> htbl <font color="#008000">-&gt;</font> look_nbits <font color="#000000">[</font> look <font color="#000000">]</font> <font color="#000000">)</font> <font color="#008000">!=</font> <font color="#FF0000">0</font> <font color="#000000">)</font> <font color="#000000">{</font> \&lt;br/&gt; <br> DROP_BITS <font color="#000000">(</font> nb <font color="#000000">)</font> <font color="#008000">;</font> \&lt;br/&gt; <br> result <font color="#008000">=</font> htbl <font color="#008000">-&gt;</font> look_sym <font color="#000000">[</font> look <font color="#000000">]</font> <font color="#008000">;</font> \&lt;br/&gt; <br> <font color="#000000">}</font> <font color="#0600FF">else</font> <font color="#000000">{</font> \&lt;br/&gt; <br> nb <font color="#008000">=</font> HUFF_LOOKAHEAD <font color="#008000">+</font> <font color="#FF0000">1</font> <font color="#008000">;</font> \&lt;br/&gt; <br> slowlabel <font color="#008000">:</font> \&lt;br/&gt; <br> <font color="#0600FF">if</font> <font color="#000000">(</font> <font color="#000000">(</font> result <font color="#008000">=</font> jpeg_huff_decode <font color="#000000">(</font> <font color="#008000">&amp;</font> state,get_buffer,bits_left,htbl,nb <font color="#000000">)</font> <font color="#000000">)</font> <font color="#008000">&lt;</font> <font color="#FF0000">0</font> <font color="#000000">)</font> \&lt;br/&gt; <br> <font color="#000000">{</font> failaction <font color="#008000">;</font> <font color="#000000">}</font> \&lt;br/&gt; <br> get_buffer <font color="#008000">=</font> state. <font color="#0000FF">get_buffer</font> <font color="#008000">;</font> bits_left <font color="#008000">=</font> state. <font color="#0000FF">bits_left</font> <font color="#008000">;</font> \&lt;br/&gt; <br> <font color="#000000">}</font> \&lt;br/&gt; <br> <font color="#000000">}</font> <br></code> </blockquote> <code><font color="#008080">#define HUFF_DECODE(result,state,htbl,failaction,slowlabel) \</font> &lt;br/&gt; <br> <font color="#000000">{</font> register <font color="#FF0000">int</font> nb, look <font color="#008000">;</font> \&lt;br/&gt; <br> <font color="#0600FF">if</font> <font color="#000000">(</font> bits_left <font color="#008000">&lt;</font> HUFF_LOOKAHEAD <font color="#000000">)</font> <font color="#000000">{</font> \&lt;br/&gt; <br> <font color="#0600FF">if</font> <font color="#000000">(</font> <font color="#008000">!</font> jpeg_fill_bit_buffer <font color="#000000">(</font> <font color="#008000">&amp;</font> state,get_buffer,bits_left, <font color="#FF0000">0</font> <font color="#000000">)</font> <font color="#000000">)</font> <font color="#000000">{</font> failaction <font color="#008000">;</font> <font color="#000000">}</font> \&lt;br/&gt; <br> get_buffer <font color="#008000">=</font> state. <font color="#0000FF">get_buffer</font> <font color="#008000">;</font> bits_left <font color="#008000">=</font> state. <font color="#0000FF">bits_left</font> <font color="#008000">;</font> \&lt;br/&gt; <br> <font color="#0600FF">if</font> <font color="#000000">(</font> bits_left <font color="#008000">&lt;</font> HUFF_LOOKAHEAD <font color="#000000">)</font> <font color="#000000">{</font> \&lt;br/&gt; <br> nb <font color="#008000">=</font> <font color="#FF0000">1</font> <font color="#008000">;</font> <font color="#0600FF">goto</font> slowlabel <font color="#008000">;</font> \&lt;br/&gt; <br> <font color="#000000">}</font> \&lt;br/&gt; <br> <font color="#000000">}</font> \&lt;br/&gt; <br> look <font color="#008000">=</font> PEEK_BITS <font color="#000000">(</font> HUFF_LOOKAHEAD <font color="#000000">)</font> <font color="#008000">;</font> \&lt;br/&gt; <br> <font color="#0600FF">if</font> <font color="#000000">(</font> <font color="#000000">(</font> nb <font color="#008000">=</font> htbl <font color="#008000">-&gt;</font> look_nbits <font color="#000000">[</font> look <font color="#000000">]</font> <font color="#000000">)</font> <font color="#008000">!=</font> <font color="#FF0000">0</font> <font color="#000000">)</font> <font color="#000000">{</font> \&lt;br/&gt; <br> DROP_BITS <font color="#000000">(</font> nb <font color="#000000">)</font> <font color="#008000">;</font> \&lt;br/&gt; <br> result <font color="#008000">=</font> htbl <font color="#008000">-&gt;</font> look_sym <font color="#000000">[</font> look <font color="#000000">]</font> <font color="#008000">;</font> \&lt;br/&gt; <br> <font color="#000000">}</font> <font color="#0600FF">else</font> <font color="#000000">{</font> \&lt;br/&gt; <br> nb <font color="#008000">=</font> HUFF_LOOKAHEAD <font color="#008000">+</font> <font color="#FF0000">1</font> <font color="#008000">;</font> \&lt;br/&gt; <br> slowlabel <font color="#008000">:</font> \&lt;br/&gt; <br> <font color="#0600FF">if</font> <font color="#000000">(</font> <font color="#000000">(</font> result <font color="#008000">=</font> jpeg_huff_decode <font color="#000000">(</font> <font color="#008000">&amp;</font> state,get_buffer,bits_left,htbl,nb <font color="#000000">)</font> <font color="#000000">)</font> <font color="#008000">&lt;</font> <font color="#FF0000">0</font> <font color="#000000">)</font> \&lt;br/&gt; <br> <font color="#000000">{</font> failaction <font color="#008000">;</font> <font color="#000000">}</font> \&lt;br/&gt; <br> get_buffer <font color="#008000">=</font> state. <font color="#0000FF">get_buffer</font> <font color="#008000">;</font> bits_left <font color="#008000">=</font> state. <font color="#0000FF">bits_left</font> <font color="#008000">;</font> \&lt;br/&gt; <br> <font color="#000000">}</font> \&lt;br/&gt; <br> <font color="#000000">}</font> <br></code> <br><br>  In the above code, PEEK_BITS and DROP_BITS are also ‚Äúfunctions‚Äù created in the same way as HUFF_DECODE.  In this case, it may be wise to fully include the code of the ‚Äúfunctions‚Äù PEEK_BITS and DROP_BITS in HUFF_DECODE to simplify the transformation. <br><br>  You can proceed to the next stage of code refinement after only harmless preprocessor commands are left: <br><br> <code>#define DATATYPE_VOID 0</code> <br> <br><h5>  2.3 Operators switch and goto </h5><br>  It is possible to get rid of goto by introducing boolean variables and / or changing the function code.  For example, if a function has a loop in which goto is used outside of the loop, then such a construction can be changed to set a boolean, break and check the value of the variable after the loop. <br><br>  In the next step, I check all switch constructs for the presence of cases with missing breaks. <br><br><blockquote> <code><font color="#0600FF">switch</font> <font color="#000000">(</font> test1 <font color="#000000">(</font> buf <font color="#000000">)</font> <font color="#000000">)</font> &lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> <font color="#0600FF">case</font> <font color="#008000">-</font> <font color="#FF0000">1</font> <font color="#008000">:</font> &lt;br/&gt; <br> <font color="#0600FF">if</font> <font color="#000000">(</font> line <font color="#008000">!=</font> buf <font color="#008000">+</font> <font color="#000000">(</font> bufsize <font color="#008000">-</font> <font color="#FF0000">1</font> <font color="#000000">)</font> <font color="#000000">)</font> &lt;br/&gt; <br> continue <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#008080">/* falls through */</font> &lt;br/&gt; <br> <font color="#0600FF">default</font> <font color="#008000">:</font> &lt;br/&gt; <br> fputs <font color="#000000">(</font> buf, <font color="#0600FF">out</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> break <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> <br></code> </blockquote> <code><font color="#0600FF">switch</font> <font color="#000000">(</font> test1 <font color="#000000">(</font> buf <font color="#000000">)</font> <font color="#000000">)</font> &lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> <font color="#0600FF">case</font> <font color="#008000">-</font> <font color="#FF0000">1</font> <font color="#008000">:</font> &lt;br/&gt; <br> <font color="#0600FF">if</font> <font color="#000000">(</font> line <font color="#008000">!=</font> buf <font color="#008000">+</font> <font color="#000000">(</font> bufsize <font color="#008000">-</font> <font color="#FF0000">1</font> <font color="#000000">)</font> <font color="#000000">)</font> &lt;br/&gt; <br> continue <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#008080">/* falls through */</font> &lt;br/&gt; <br> <font color="#0600FF">default</font> <font color="#008000">:</font> &lt;br/&gt; <br> fputs <font color="#000000">(</font> buf, <font color="#0600FF">out</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> break <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> <br></code> <br>  This is allowed in C / C ++, but prohibited in C #.  Such switch statements can either be replaced with several if blocks, or, if the case with fallthrough consists of a pair of lines, duplicate the common code. <br><br><h5>  2.4 We collect stones </h5><br>  Everything described earlier requires a fairly small amount of time compared to further tasks.  The first such large-scale task is to collect data and functions into classes.  The goal is a situation where each function is a method of a class. <br><br>  If the code was originally written in C ++, then, most likely, there are not enough functions (not methods) in it.  In this case, you need to find a connection between existing classes and "free" functions.  It usually turns out that functions perform an auxiliary role for classes.  If the function is used only in one class, then it can be added to this class as a static method.  If the function is used from several classes, then you can make a new class and introduce the function by a static method into the newly created class. <br><br>  If the code was originally written in C, then the classes in it are not found.  You have to create them from scratch, grouping functions around the data they manage.  Fortunately, it is usually sufficient to simply understand which data and functions constitute one logical unit.  Especially if the code is written in C, but object-oriented. <br><br>  Consider the example below: <br><br><blockquote> <code><font color="#FF0000">struct</font> tiff&lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> <font color="#FF0000">char</font> <font color="#008000">*</font> tif_name <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#FF0000">int</font> tif_fd <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#FF0000">int</font> tif_mode <font color="#008000">;</font> &lt;br/&gt; <br> uint32 tif_flags <font color="#008000">;</font> &lt;br/&gt; <br> ......&lt;br/&gt; <br> <font color="#000000">}</font> <font color="#008000">;</font> &lt;br/&gt; <br> ......&lt;br/&gt; <br> <font color="#0600FF">extern</font> <font color="#FF0000">int</font> TIFFDefaultDirectory <font color="#000000">(</font> tiff <font color="#008000">*</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#0600FF">extern</font> <font color="#0600FF">void</font> _TIFFSetDefaultCompressionState <font color="#000000">(</font> tiff <font color="#008000">*</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#0600FF">extern</font> <font color="#FF0000">int</font> TIFFSetCompressionScheme <font color="#000000">(</font> tiff <font color="#008000">*</font> , <font color="#FF0000">int</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> ...... <br></code> </blockquote> <code><font color="#FF0000">struct</font> tiff&lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> <font color="#FF0000">char</font> <font color="#008000">*</font> tif_name <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#FF0000">int</font> tif_fd <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#FF0000">int</font> tif_mode <font color="#008000">;</font> &lt;br/&gt; <br> uint32 tif_flags <font color="#008000">;</font> &lt;br/&gt; <br> ......&lt;br/&gt; <br> <font color="#000000">}</font> <font color="#008000">;</font> &lt;br/&gt; <br> ......&lt;br/&gt; <br> <font color="#0600FF">extern</font> <font color="#FF0000">int</font> TIFFDefaultDirectory <font color="#000000">(</font> tiff <font color="#008000">*</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#0600FF">extern</font> <font color="#0600FF">void</font> _TIFFSetDefaultCompressionState <font color="#000000">(</font> tiff <font color="#008000">*</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#0600FF">extern</font> <font color="#FF0000">int</font> TIFFSetCompressionScheme <font color="#000000">(</font> tiff <font color="#008000">*</font> , <font color="#FF0000">int</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> ...... <br></code> <br>  It is easy to see that the tiff structure simply begs for becoming a class, and the three functions declared below are public methods of this class.  So, it is worth changing the struct to class and making the functions static class methods. <br><br>  As most functions become class methods, it will become easier to understand what to do with the remaining ‚Äúfree‚Äù functions.  Do not forget that not all functions will become public methods.  Usually there are a number of auxiliary functions not intended for external use.  Such support functions will become private methods. <br><br>  After the functions have become static class methods, I advise you to replace malloc / free with new / delete and add constructors with destructors.  Then we begin to turn static methods into full-fledged class methods.  As the methods cease to be static, it becomes clear that at least one parameter is superfluous.  This is a pointer to the original structure, which has become a class.  Of course, such redundancy must be eliminated.  It may also turn out that some parameters of private functions can be made variable by members of the class. <br><br><h5>  2.5 Again preprocessor and multiple inheritance </h5><br>  After a set of classes came out of a set of functions and structures, it‚Äôs time to return to the preprocessor.  Or rather, to define it like the one below (you shouldn‚Äôt have any other time by now): <br><br> <code>#define STRIP_SIZE_DEFAULT 8192</code> <br> <br>  Such defines should be turned into constants and pick up the class that will become their owner.  As with functions, for newly created constants you may need to create a class (for example, Constants).  Like functions, constants can become public or private. <br><br>  If the original code was written in C ++, then multiple inheritance can be used.  This is another thing that you need to get rid of for transfer to C #.  One way: to change the class hierarchy so that multiple inheritance is excluded.  Another way is that all classes that are used for multiple inheritance contain only pure virtual (virtual) methods and do not contain variables.  Example: <br><br><blockquote> <code><font color="#FF0000">class</font> A&lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> <font color="#0600FF">public</font> <font color="#008000">:</font> &lt;br/&gt; <br> <font color="#0600FF">virtual</font> <font color="#FF0000">bool</font> DoSomething <font color="#000000">(</font> <font color="#000000">)</font> <font color="#008000">=</font> <font color="#FF0000">0</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#FF0000">class</font> B&lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> <font color="#0600FF">public</font> <font color="#008000">:</font> &lt;br/&gt; <br> <font color="#0600FF">virtual</font> <font color="#FF0000">bool</font> DoAnother <font color="#000000">(</font> <font color="#000000">)</font> <font color="#008000">=</font> <font color="#FF0000">0</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#FF0000">class</font> C <font color="#008000">:</font> <font color="#0600FF">public</font> A, B&lt;br/&gt; <br> <font color="#000000">{</font> ...... <font color="#000000">}</font> <font color="#008000">;</font> <br></code> </blockquote> <code><font color="#FF0000">class</font> A&lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> <font color="#0600FF">public</font> <font color="#008000">:</font> &lt;br/&gt; <br> <font color="#0600FF">virtual</font> <font color="#FF0000">bool</font> DoSomething <font color="#000000">(</font> <font color="#000000">)</font> <font color="#008000">=</font> <font color="#FF0000">0</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#FF0000">class</font> B&lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> <font color="#0600FF">public</font> <font color="#008000">:</font> &lt;br/&gt; <br> <font color="#0600FF">virtual</font> <font color="#FF0000">bool</font> DoAnother <font color="#000000">(</font> <font color="#000000">)</font> <font color="#008000">=</font> <font color="#FF0000">0</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#FF0000">class</font> C <font color="#008000">:</font> <font color="#0600FF">public</font> A, B&lt;br/&gt; <br> <font color="#000000">{</font> ...... <font color="#000000">}</font> <font color="#008000">;</font> <br></code> <br><br>  Such multiple inheritance can be easily transferred to C # by declaring classes A and B as interfaces. <br><br><h5>  2.6 operator typedef </h5><br>  Before proceeding to the next large-scale task to get rid of pointer arithmetic, you should pay attention to the declarations of type synonyms (typedef operator).  Sometimes these ads are used to shorten the record.  For example: <br><br> <code>typedef vector&lt;Command*&gt; Commands;</code> <br> <br>  I prefer to embed such constructions, that is, change Commands to vector &lt;Command *&gt; in the code, and delete them. <br><br>  More interesting are the following typedef uses: <br><br><blockquote> <code>typedef signed <font color="#FF0000">char</font> int8 <font color="#008000">;</font> &lt;br/&gt; <br> typedef unsigned <font color="#FF0000">char</font> uint8 <font color="#008000">;</font> &lt;br/&gt; <br> typedef <font color="#FF0000">short</font> int16 <font color="#008000">;</font> &lt;br/&gt; <br> typedef unsigned <font color="#FF0000">short</font> uint16 <font color="#008000">;</font> &lt;br/&gt; <br> typedef <font color="#FF0000">int</font> int32 <font color="#008000">;</font> &lt;br/&gt; <br> typedef unsigned <font color="#FF0000">int</font> uint32 <font color="#008000">;</font> <br></code> </blockquote> <code>typedef signed <font color="#FF0000">char</font> int8 <font color="#008000">;</font> &lt;br/&gt; <br> typedef unsigned <font color="#FF0000">char</font> uint8 <font color="#008000">;</font> &lt;br/&gt; <br> typedef <font color="#FF0000">short</font> int16 <font color="#008000">;</font> &lt;br/&gt; <br> typedef unsigned <font color="#FF0000">short</font> uint16 <font color="#008000">;</font> &lt;br/&gt; <br> typedef <font color="#FF0000">int</font> int32 <font color="#008000">;</font> &lt;br/&gt; <br> typedef unsigned <font color="#FF0000">int</font> uint32 <font color="#008000">;</font> <br></code> <br><br>  Here you should pay attention to the generated type names.  It is obvious that typedef short int16;  and typedef int int32;  rather, interference, which means it is better to change the int16 code to short, and int32 to int.  But the remaining typedefs are very useful.  It makes sense to only slightly adjust their names so that they match the type names in C #.  That is, do so: <br><br><blockquote> <code>typedef signed <font color="#FF0000">char</font> sbyte <font color="#008000">;</font> &lt;br/&gt; <br> typedef unsigned <font color="#FF0000">char</font> byte <font color="#008000">;</font> &lt;br/&gt; <br> typedef unsigned <font color="#FF0000">short</font> <font color="#FF0000">ushort</font> &lt;br/&gt; <br> typedef unsigned <font color="#FF0000">int</font> uint <font color="#008000">;</font> <br></code> </blockquote> <code>typedef signed <font color="#FF0000">char</font> sbyte <font color="#008000">;</font> &lt;br/&gt; <br> typedef unsigned <font color="#FF0000">char</font> byte <font color="#008000">;</font> &lt;br/&gt; <br> typedef unsigned <font color="#FF0000">short</font> <font color="#FF0000">ushort</font> &lt;br/&gt; <br> typedef unsigned <font color="#FF0000">int</font> uint <font color="#008000">;</font> <br></code> <br><br>  Particular attention should be paid to such structures: <br><br> <code>typedef unsigned char JBLOCK[64]; /* one block of coefficients */</code> <br> <br>  This construction introduces the name JBLOCK for an array of 64 unsigned char elements.  I prefer to turn such constructions into classes.  That is, to make JBLOCK a class that contains an array within itself, and provides methods for accessing the elements of the array.  Such an approach greatly simplifies the understanding of how JBLOCK arrays are created and deleted (especially 2-D and 3-D), and also how they change during the work of the program. <br><br><h5>  2.7 Pointer arithmetic </h5><br>  Another major task is getting rid of pointer arithmetic (pointer-arithmetic).  Many C / C ++ programs rely heavily on this language feature.  For example: <br><br><blockquote> <code><font color="#0600FF">void</font> horAcc32 <font color="#000000">(</font> <font color="#FF0000">int</font> stride, <font color="#FF0000">uint</font> <font color="#008000">*</font> wp, <font color="#FF0000">int</font> wc <font color="#000000">)</font> &lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> <font color="#0600FF">if</font> <font color="#000000">(</font> wc <font color="#008000">&gt;</font> stride <font color="#000000">)</font> <font color="#000000">{</font> &lt;br/&gt; <br> wc <font color="#008000">-=</font> stride <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#0600FF">do</font> <font color="#000000">{</font> &lt;br/&gt; <br> wp <font color="#000000">[</font> stride <font color="#000000">]</font> <font color="#008000">+=</font> wp <font color="#000000">[</font> <font color="#FF0000">0</font> <font color="#000000">]</font> <font color="#008000">;</font> &lt;br/&gt; <br> wp <font color="#008000">++;</font> &lt;br/&gt; <br> wc <font color="#008000">-=</font> stride <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> <font color="#0600FF">while</font> <font color="#000000">(</font> <font color="#000000">(</font> <font color="#FF0000">int</font> <font color="#000000">)</font> wc <font color="#008000">&gt;</font> <font color="#FF0000">0</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> &lt;br/&gt; <br> <font color="#000000">}</font> <br></code> </blockquote> <code><font color="#0600FF">void</font> horAcc32 <font color="#000000">(</font> <font color="#FF0000">int</font> stride, <font color="#FF0000">uint</font> <font color="#008000">*</font> wp, <font color="#FF0000">int</font> wc <font color="#000000">)</font> &lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> <font color="#0600FF">if</font> <font color="#000000">(</font> wc <font color="#008000">&gt;</font> stride <font color="#000000">)</font> <font color="#000000">{</font> &lt;br/&gt; <br> wc <font color="#008000">-=</font> stride <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#0600FF">do</font> <font color="#000000">{</font> &lt;br/&gt; <br> wp <font color="#000000">[</font> stride <font color="#000000">]</font> <font color="#008000">+=</font> wp <font color="#000000">[</font> <font color="#FF0000">0</font> <font color="#000000">]</font> <font color="#008000">;</font> &lt;br/&gt; <br> wp <font color="#008000">++;</font> &lt;br/&gt; <br> wc <font color="#008000">-=</font> stride <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> <font color="#0600FF">while</font> <font color="#000000">(</font> <font color="#000000">(</font> <font color="#FF0000">int</font> <font color="#000000">)</font> wc <font color="#008000">&gt;</font> <font color="#FF0000">0</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> &lt;br/&gt; <br> <font color="#000000">}</font> <br></code> <br><br>  Such functions need to be changed, because pointer arithmetic is not available by default in C #.  You can use such arithmetic in unsafe code (unsafe code), but this code has its drawbacks.  Therefore, I prefer to modify this code by introducing ‚Äúindex arithmetic‚Äù.  That is, changing the code like this: <br><br><blockquote> <code><font color="#0600FF">void</font> horAcc32 <font color="#000000">(</font> <font color="#FF0000">int</font> stride, <font color="#FF0000">uint</font> <font color="#008000">*</font> wp, <font color="#FF0000">int</font> wc <font color="#000000">)</font> &lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> <font color="#FF0000">int</font> wpPos <font color="#008000">=</font> <font color="#FF0000">0</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#0600FF">if</font> <font color="#000000">(</font> wc <font color="#008000">&gt;</font> stride <font color="#000000">)</font> <font color="#000000">{</font> &lt;br/&gt; <br> wc <font color="#008000">-=</font> stride <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#0600FF">do</font> <font color="#000000">{</font> &lt;br/&gt; <br> wp <font color="#000000">[</font> wpPos <font color="#008000">+</font> stride <font color="#000000">]</font> <font color="#008000">+=</font> wp <font color="#000000">[</font> wpPos <font color="#000000">]</font> <font color="#008000">;</font> &lt;br/&gt; <br> wpPos <font color="#008000">++;</font> &lt;br/&gt; <br> wc <font color="#008000">-=</font> stride <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> <font color="#0600FF">while</font> <font color="#000000">(</font> <font color="#000000">(</font> <font color="#FF0000">int</font> <font color="#000000">)</font> wc <font color="#008000">&gt;</font> <font color="#FF0000">0</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> &lt;br/&gt; <br> <font color="#000000">}</font> <br></code> </blockquote> <code><font color="#0600FF">void</font> horAcc32 <font color="#000000">(</font> <font color="#FF0000">int</font> stride, <font color="#FF0000">uint</font> <font color="#008000">*</font> wp, <font color="#FF0000">int</font> wc <font color="#000000">)</font> &lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> <font color="#FF0000">int</font> wpPos <font color="#008000">=</font> <font color="#FF0000">0</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#0600FF">if</font> <font color="#000000">(</font> wc <font color="#008000">&gt;</font> stride <font color="#000000">)</font> <font color="#000000">{</font> &lt;br/&gt; <br> wc <font color="#008000">-=</font> stride <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#0600FF">do</font> <font color="#000000">{</font> &lt;br/&gt; <br> wp <font color="#000000">[</font> wpPos <font color="#008000">+</font> stride <font color="#000000">]</font> <font color="#008000">+=</font> wp <font color="#000000">[</font> wpPos <font color="#000000">]</font> <font color="#008000">;</font> &lt;br/&gt; <br> wpPos <font color="#008000">++;</font> &lt;br/&gt; <br> wc <font color="#008000">-=</font> stride <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> <font color="#0600FF">while</font> <font color="#000000">(</font> <font color="#000000">(</font> <font color="#FF0000">int</font> <font color="#000000">)</font> wc <font color="#008000">&gt;</font> <font color="#FF0000">0</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> &lt;br/&gt; <br> <font color="#000000">}</font> <br></code> <br><br>  The result is a function that does the same work, but does not use pointer arithmetic and can be easily transferred to C #.  Most likely, the modified code will run slower than the original one.  Let me remind you once again that at this stage it does not matter. <br><br>  Special attention should be paid to the functions that in the process of work change the pointers passed to them.  Option source function: <br><br> <code>void horAcc32(int stride, uint* &amp; wp, int wc)</code> <br> <br>  In this case, when wp changes in the horAcc32 function, the pointer also changes in the calling function.  The approach with the introduction of the index can be used in this case.  You just need to enter the index in the calling function and pass it to horAcc32. <br><br> <code>void horAcc32(int stride, uint* wp, int&amp; wpPos, int wc)</code> <br> <br>  It is often convenient to make int wpPos a class field (member variable). <br><br><h5>  2.8 Pointers to functions </h5><br>  After pointer arithmetic, it's time to take pointers to functions (if there are any in the code).  Cases of using pointers to functions can be divided into three fairly different subspecies: <br><ol><li>  function pointers are created and used within a single class / function </li><li>  function pointers are created and used by different program classes. </li><li>  function pointers are created by users and passed to the program (the program in this case is a static or dynamically loaded library) </li></ol><br>  An example for the first case: <br><br><blockquote> <code>typedef <font color="#FF0000">int</font> <font color="#000000">(</font> <font color="#008000">*</font> func <font color="#000000">)</font> <font color="#000000">(</font> <font color="#FF0000">int</font> x, <font color="#FF0000">int</font> y <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#FF0000">class</font> Calculator&lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> Calculator <font color="#000000">(</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#FF0000">int</font> <font color="#000000">(</font> <font color="#008000">*</font> func <font color="#000000">)</font> <font color="#000000">(</font> <font color="#FF0000">int</font> x, <font color="#FF0000">int</font> y <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#0600FF">static</font> <font color="#FF0000">int</font> sum <font color="#000000">(</font> <font color="#FF0000">int</font> x, <font color="#FF0000">int</font> y <font color="#000000">)</font> <font color="#000000">{</font> <font color="#0600FF">return</font> x <font color="#008000">+</font> y <font color="#008000">;</font> <font color="#000000">}</font> &lt;br/&gt; <br> <font color="#0600FF">static</font> <font color="#FF0000">int</font> mul <font color="#000000">(</font> <font color="#FF0000">int</font> x, <font color="#FF0000">int</font> y <font color="#000000">)</font> <font color="#000000">{</font> <font color="#0600FF">return</font> x <font color="#008000">*</font> y <font color="#008000">;</font> <font color="#000000">}</font> &lt;br/&gt; <br> <font color="#0600FF">public</font> <font color="#008000">:</font> &lt;br/&gt; <br> <font color="#0600FF">static</font> Calculator <font color="#008000">*</font> CreateSummator <font color="#000000">(</font> <font color="#000000">)</font> &lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> Calculator <font color="#008000">*</font> c <font color="#008000">=</font> <font color="#008000">new</font> Calculator <font color="#000000">(</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> c <font color="#008000">-&gt;</font> func <font color="#008000">=</font> sum <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#0600FF">return</font> c <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> &lt;br/&gt; <br> <font color="#0600FF">static</font> Calculator <font color="#008000">*</font> CreateMultiplicator <font color="#000000">(</font> <font color="#000000">)</font> &lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> Calculator <font color="#008000">*</font> c <font color="#008000">=</font> <font color="#008000">new</font> Calculator <font color="#000000">(</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> c <font color="#008000">-&gt;</font> func <font color="#008000">=</font> mul <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#0600FF">return</font> c <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> &lt;br/&gt; <br> <font color="#FF0000">int</font> Calc <font color="#000000">(</font> <font color="#FF0000">int</font> x, <font color="#FF0000">int</font> y <font color="#000000">)</font> <font color="#000000">{</font> <font color="#0600FF">return</font> <font color="#000000">(</font> <font color="#008000">*</font> func <font color="#000000">)</font> <font color="#000000">(</font> x,y <font color="#000000">)</font> <font color="#008000">;</font> <font color="#000000">}</font> &lt;br/&gt; <br> <font color="#000000">}</font> <font color="#008000">;</font> <br></code> </blockquote> <code>typedef <font color="#FF0000">int</font> <font color="#000000">(</font> <font color="#008000">*</font> func <font color="#000000">)</font> <font color="#000000">(</font> <font color="#FF0000">int</font> x, <font color="#FF0000">int</font> y <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#FF0000">class</font> Calculator&lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> Calculator <font color="#000000">(</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#FF0000">int</font> <font color="#000000">(</font> <font color="#008000">*</font> func <font color="#000000">)</font> <font color="#000000">(</font> <font color="#FF0000">int</font> x, <font color="#FF0000">int</font> y <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#0600FF">static</font> <font color="#FF0000">int</font> sum <font color="#000000">(</font> <font color="#FF0000">int</font> x, <font color="#FF0000">int</font> y <font color="#000000">)</font> <font color="#000000">{</font> <font color="#0600FF">return</font> x <font color="#008000">+</font> y <font color="#008000">;</font> <font color="#000000">}</font> &lt;br/&gt; <br> <font color="#0600FF">static</font> <font color="#FF0000">int</font> mul <font color="#000000">(</font> <font color="#FF0000">int</font> x, <font color="#FF0000">int</font> y <font color="#000000">)</font> <font color="#000000">{</font> <font color="#0600FF">return</font> x <font color="#008000">*</font> y <font color="#008000">;</font> <font color="#000000">}</font> &lt;br/&gt; <br> <font color="#0600FF">public</font> <font color="#008000">:</font> &lt;br/&gt; <br> <font color="#0600FF">static</font> Calculator <font color="#008000">*</font> CreateSummator <font color="#000000">(</font> <font color="#000000">)</font> &lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> Calculator <font color="#008000">*</font> c <font color="#008000">=</font> <font color="#008000">new</font> Calculator <font color="#000000">(</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> c <font color="#008000">-&gt;</font> func <font color="#008000">=</font> sum <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#0600FF">return</font> c <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> &lt;br/&gt; <br> <font color="#0600FF">static</font> Calculator <font color="#008000">*</font> CreateMultiplicator <font color="#000000">(</font> <font color="#000000">)</font> &lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> Calculator <font color="#008000">*</font> c <font color="#008000">=</font> <font color="#008000">new</font> Calculator <font color="#000000">(</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> c <font color="#008000">-&gt;</font> func <font color="#008000">=</font> mul <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#0600FF">return</font> c <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> &lt;br/&gt; <br> <font color="#FF0000">int</font> Calc <font color="#000000">(</font> <font color="#FF0000">int</font> x, <font color="#FF0000">int</font> y <font color="#000000">)</font> <font color="#000000">{</font> <font color="#0600FF">return</font> <font color="#000000">(</font> <font color="#008000">*</font> func <font color="#000000">)</font> <font color="#000000">(</font> x,y <font color="#000000">)</font> <font color="#008000">;</font> <font color="#000000">}</font> &lt;br/&gt; <br> <font color="#000000">}</font> <font color="#008000">;</font> <br></code> <br><br>  In this case, the function Calc in the created class depends on which of the CreateSummator or CreateMultiplicator methods is called.  I prefer to create an internal enum in the class, which describes all possible options for func, and a field that stores the value from enum.  Then, instead of a pointer to a function, I create a method consisting of a switch statement (or several if).  The created method selects which function to call, depending on the value of the field.  Modified version: <br><br><blockquote> <code><font color="#FF0000">class</font> Calculator&lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> <font color="#FF0000">enum</font> FuncType&lt;br/&gt; <br> <font color="#000000">{</font> ftSum, ftMul <font color="#000000">}</font> <font color="#008000">;</font> &lt;br/&gt; <br> FuncType type <font color="#008000">;</font> &lt;br/&gt; <br> &lt;br/&gt; <br> Calculator <font color="#000000">(</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#FF0000">int</font> func <font color="#000000">(</font> <font color="#FF0000">int</font> x, <font color="#FF0000">int</font> y <font color="#000000">)</font> &lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> <font color="#0600FF">if</font> <font color="#000000">(</font> type <font color="#008000">==</font> ftSum <font color="#000000">)</font> &lt;br/&gt; <br> <font color="#0600FF">return</font> sum <font color="#000000">(</font> x,y <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#0600FF">return</font> mul <font color="#000000">(</font> x,y <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#0600FF">static</font> <font color="#FF0000">int</font> sum <font color="#000000">(</font> <font color="#FF0000">int</font> x, <font color="#FF0000">int</font> y <font color="#000000">)</font> <font color="#000000">{</font> <font color="#0600FF">return</font> x <font color="#008000">+</font> y <font color="#008000">;</font> <font color="#000000">}</font> &lt;br/&gt; <br> <font color="#0600FF">static</font> <font color="#FF0000">int</font> mul <font color="#000000">(</font> <font color="#FF0000">int</font> x, <font color="#FF0000">int</font> y <font color="#000000">)</font> <font color="#000000">{</font> <font color="#0600FF">return</font> x <font color="#008000">*</font> y <font color="#008000">;</font> <font color="#000000">}</font> &lt;br/&gt; <br> <font color="#0600FF">public</font> <font color="#008000">:</font> &lt;br/&gt; <br> <font color="#0600FF">static</font> Calculator <font color="#008000">*</font> createSummator <font color="#000000">(</font> <font color="#000000">)</font> &lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> Calculator <font color="#008000">*</font> c <font color="#008000">=</font> <font color="#008000">new</font> Calculator <font color="#000000">(</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> c <font color="#008000">-&gt;</font> type <font color="#008000">=</font> ftSum <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#0600FF">return</font> c <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> &lt;br/&gt; <br> <font color="#0600FF">static</font> Calculator <font color="#008000">*</font> createMultiplicator <font color="#000000">(</font> <font color="#000000">)</font> &lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> Calculator <font color="#008000">*</font> c <font color="#008000">=</font> <font color="#008000">new</font> Calculator <font color="#000000">(</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> c <font color="#008000">-&gt;</font> type <font color="#008000">=</font> ftMul <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#0600FF">return</font> c <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> &lt;br/&gt; <br> <font color="#FF0000">int</font> Calc <font color="#000000">(</font> <font color="#FF0000">int</font> x, <font color="#FF0000">int</font> y <font color="#000000">)</font> <font color="#000000">{</font> <font color="#0600FF">return</font> func <font color="#000000">(</font> x,y <font color="#000000">)</font> <font color="#008000">;</font> <font color="#000000">}</font> &lt;br/&gt; <br> <font color="#000000">}</font> <font color="#008000">;</font> <br></code> </blockquote> <code><font color="#FF0000">class</font> Calculator&lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> <font color="#FF0000">enum</font> FuncType&lt;br/&gt; <br> <font color="#000000">{</font> ftSum, ftMul <font color="#000000">}</font> <font color="#008000">;</font> &lt;br/&gt; <br> FuncType type <font color="#008000">;</font> &lt;br/&gt; <br> &lt;br/&gt; <br> Calculator <font color="#000000">(</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#FF0000">int</font> func <font color="#000000">(</font> <font color="#FF0000">int</font> x, <font color="#FF0000">int</font> y <font color="#000000">)</font> &lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> <font color="#0600FF">if</font> <font color="#000000">(</font> type <font color="#008000">==</font> ftSum <font color="#000000">)</font> &lt;br/&gt; <br> <font color="#0600FF">return</font> sum <font color="#000000">(</font> x,y <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#0600FF">return</font> mul <font color="#000000">(</font> x,y <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#0600FF">static</font> <font color="#FF0000">int</font> sum <font color="#000000">(</font> <font color="#FF0000">int</font> x, <font color="#FF0000">int</font> y <font color="#000000">)</font> <font color="#000000">{</font> <font color="#0600FF">return</font> x <font color="#008000">+</font> y <font color="#008000">;</font> <font color="#000000">}</font> &lt;br/&gt; <br> <font color="#0600FF">static</font> <font color="#FF0000">int</font> mul <font color="#000000">(</font> <font color="#FF0000">int</font> x, <font color="#FF0000">int</font> y <font color="#000000">)</font> <font color="#000000">{</font> <font color="#0600FF">return</font> x <font color="#008000">*</font> y <font color="#008000">;</font> <font color="#000000">}</font> &lt;br/&gt; <br> <font color="#0600FF">public</font> <font color="#008000">:</font> &lt;br/&gt; <br> <font color="#0600FF">static</font> Calculator <font color="#008000">*</font> createSummator <font color="#000000">(</font> <font color="#000000">)</font> &lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> Calculator <font color="#008000">*</font> c <font color="#008000">=</font> <font color="#008000">new</font> Calculator <font color="#000000">(</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> c <font color="#008000">-&gt;</font> type <font color="#008000">=</font> ftSum <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#0600FF">return</font> c <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> &lt;br/&gt; <br> <font color="#0600FF">static</font> Calculator <font color="#008000">*</font> createMultiplicator <font color="#000000">(</font> <font color="#000000">)</font> &lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> Calculator <font color="#008000">*</font> c <font color="#008000">=</font> <font color="#008000">new</font> Calculator <font color="#000000">(</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> c <font color="#008000">-&gt;</font> type <font color="#008000">=</font> ftMul <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#0600FF">return</font> c <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> &lt;br/&gt; <br> <font color="#FF0000">int</font> Calc <font color="#000000">(</font> <font color="#FF0000">int</font> x, <font color="#FF0000">int</font> y <font color="#000000">)</font> <font color="#000000">{</font> <font color="#0600FF">return</font> func <font color="#000000">(</font> x,y <font color="#000000">)</font> <font color="#008000">;</font> <font color="#000000">}</font> &lt;br/&gt; <br> <font color="#000000">}</font> <font color="#008000">;</font> <br></code> <br><br>  You can do otherwise: do not change anything for now, and at the time of the transfer to C # use delegates. <br><br>  An example for the second case (function pointers are created and used by different classes of the program): <br><br><blockquote> <code>typedef <font color="#FF0000">int</font> <font color="#000000">(</font> <font color="#008000">*</font> TIFFVSetMethod <font color="#000000">)</font> <font color="#000000">(</font> TIFF <font color="#008000">*</font> , ttag_t, va_list <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> typedef <font color="#FF0000">int</font> <font color="#000000">(</font> <font color="#008000">*</font> TIFFVGetMethod <font color="#000000">)</font> <font color="#000000">(</font> TIFF <font color="#008000">*</font> , ttag_t, va_list <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> typedef <font color="#0600FF">void</font> <font color="#000000">(</font> <font color="#008000">*</font> TIFFPrintMethod <font color="#000000">)</font> <font color="#000000">(</font> TIFF <font color="#008000">*</font> , FILE <font color="#008000">*</font> , <font color="#FF0000">long</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#FF0000">class</font> TIFFTagMethods&lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> <font color="#0600FF">public</font> <font color="#008000">:</font> &lt;br/&gt; <br> TIFFVSetMethod  vsetfield <font color="#008000">;</font> &lt;br/&gt; <br> TIFFVGetMethod  vgetfield <font color="#008000">;</font> &lt;br/&gt; <br> TIFFPrintMethod  printdir <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> <font color="#008000">;</font> <br></code> </blockquote> <code>typedef <font color="#FF0000">int</font> <font color="#000000">(</font> <font color="#008000">*</font> TIFFVSetMethod <font color="#000000">)</font> <font color="#000000">(</font> TIFF <font color="#008000">*</font> , ttag_t, va_list <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> typedef <font color="#FF0000">int</font> <font color="#000000">(</font> <font color="#008000">*</font> TIFFVGetMethod <font color="#000000">)</font> <font color="#000000">(</font> TIFF <font color="#008000">*</font> , ttag_t, va_list <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> typedef <font color="#0600FF">void</font> <font color="#000000">(</font> <font color="#008000">*</font> TIFFPrintMethod <font color="#000000">)</font> <font color="#000000">(</font> TIFF <font color="#008000">*</font> , FILE <font color="#008000">*</font> , <font color="#FF0000">long</font> <font color="#000000">)</font> <font color="#008000">;</font> &lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#FF0000">class</font> TIFFTagMethods&lt;br/&gt; <br> <font color="#000000">{</font> &lt;br/&gt; <br> <font color="#0600FF">public</font> <font color="#008000">:</font> &lt;br/&gt; <br> TIFFVSetMethod  vsetfield <font color="#008000">;</font> &lt;br/&gt; <br> TIFFVGetMethod  vgetfield <font color="#008000">;</font> &lt;br/&gt; <br> TIFFPrintMethod  printdir <font color="#008000">;</font> &lt;br/&gt; <br> <font color="#000000">}</font> <font color="#008000">;</font> <br></code> <br><br>  I prefer to change this situation by turning vsetfield / vgetfield / printdir into virtual methods.  The code that used vsetfield / vgetfield / printdir will create descendant classes from TIFFTagMethods with the necessary implementation of virtual methods. <br><br>  An example for the third case (function pointers are created by users and passed to the program): <br><br> <code>typedef int (*PROC)(int, int); <br> int DoUsingMyProc (int, int, PROC lpMyProc, ‚Ä¶);</code> <br> <br>  This is where delegates are best suited.  That is, at this stage, while the original code is being polished, nothing needs to be done, and when transferring to a C # project, a delegate must be made instead of PROC, and the DoUsingMyProc function will receive a delegate instance. <br><br><h5>  2.9 Isolation of the "problem" code </h5><br>  The last change to the original code is to isolate everything that can cause problems when changing compilers.  This is, for example, code that actively uses the standard C / C ++ library (functions like fprintf, gets, atof, etc.) or WinAPI.  In C #, such code will need to be modified to use methods from the .NET Framework or, if necessary, p / invoke.  I advise in this case, look at the site <a href="http://www.pinvoke.net/">http://www.pinvoke.net</a> . <br><br>  "Problem code" should be localized as much as possible.  To do this, you can create a class with static methods that wraps around the standard C / C ++ library and WinAPI.  Then when transferring it will be necessary to change only this wrapper. <br><br><h5>  2.10 Changing the compiler </h5><br>  The ‚Äúmoment of truth‚Äù has arrived - it's time to transfer the modified code to the project compiled by the C # compiler.  It's all quite simple, albeit time-consuming.  You need to create an empty project, then add the necessary classes to it, copying code from similar original classes into these classes. <br><br>  In the process, you will have to delete unnecessary (various #include, for example) and make cosmetic changes.  "Standard" changes: <br><ul><li>  merge code from .h and .cpp files </li><li>  replacing obj-&gt; method () with obj.method () </li><li>  Replace Class :: StaticMethod with Class.StaticMethod </li><li>  delete * in func (A * anInstance) </li><li>  replacing func (int &amp; x) with func (ref int x) </li></ul><br><br>  Most of the changes are not really difficult, but sometimes you have to comment on a part of the code.  Basically, it is necessary to comment on the problem code, which was discussed in section 2.9.  The main goal is to get the <u>compiled</u> code in C #.  Most likely, it will not work, but everything has its time. <br><br><h5>  2.11 file processing </h5><br>  After the transferred code is compiled, it needs to be brought to coincide with the original in functionality.  Here you will need to create a second set of tests that will use the transferred code to work.  The previously commented methods need to carefully view and rewrite their body using the .NET Framework.  I think this stage can not particularly explain.  I just want to draw attention to a couple of moments. <br><br>  When creating strings from an array of bytes (and vice versa), you need to carefully select the encoding used.  You should not use Encoding.ASCII, since it is 7-bit and for bytes larger than 127 it will turn out '?'  instead of characters.  It is better to use the current Encoding.Default or Encoding.GetEncoding ("Latin1") encoding.  The choice of encoding depends on what happens next with the text or bytes.  If the text needs to be shown to the user, then it is better to use Encoding.Default, and if bytes are made of text for writing to a binary file, then it is better to use Encoding.GetEncoding ("Latin1"). <br><br>  Certain problems can be the output of formatted strings (family of printf functions in C / C ++).  The functionality of String.Format in .NET differs both in features (it is poorer) and the format string syntax.  This problem can be solved in two ways: <br><ul><li>  create a class that will do the same thing as the printf function </li><li>  change the formatting string so that String.Format gives similar results (not always possible) </li></ul><br>  If you follow the first path, you should pay attention to the already existing implementation of <a href="http://www.codeproject.com/KB/printing/PrintfImplementationinCS.aspx">‚ÄúA printf implementation in C #‚Äù</a> . <br><br>  I prefer the second way.  If you go on it, it will help Google on "c # format specifiers" (without quotes) and " <a href="http://oreilly.com/catalog/csharpnut/chapter/appb.pdf">Format Specifiers from C # in a Nutshell</a> ". <br><br>  After all the tests that use the ported code run successfully, you can safely say that the transfer is complete.  Now you can remember that the code is not yet completely ‚Äúin the spirit of C #‚Äù (for example, get- / set-methods are used instead of properties) and do refactoring of the transferred code.  You can use the profiler to look for "bottlenecks" and do optimization.  But that's another story. <br><br>  Good luck with porting! <br><br>  <b>PS The article is not mine, written by Sergius Bobrovsky, who still does not have an invitation to Habr.</b>  <b>If anyone has free and do not mind sharing, write in a personal, please.</b> </div><p>Source: <a href="https://habr.com/ru/post/101653/">https://habr.com/ru/post/101653/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../101644/index.html">The presentation of Internet Explorer 9 Beta will be held on September 15, the promotional site is open</a></li>
<li><a href="../101646/index.html">tweet-button</a></li>
<li><a href="../101647/index.html">The killer of your time</a></li>
<li><a href="../101650/index.html">Peter Zaitsev will answer all your questions.</a></li>
<li><a href="../101652/index.html">Saudi Arabia has become the second country to ban Blackberry</a></li>
<li><a href="../101654/index.html">Static storage, processing and release</a></li>
<li><a href="../101658/index.html">FBI demands to remove its emblem from the site of the free encyclopedia</a></li>
<li><a href="../101659/index.html">Improving forms with jqTransform</a></li>
<li><a href="../101661/index.html">Does porn have a future?</a></li>
<li><a href="../101663/index.html">Low-cost Internet and mobile communications in Europe - sharing experience</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>