<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We develop the utility on GraalVM</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Formulation of the problem 


 Periodically, I have the task to share files over a local network, for example, with a project colleague. 


 There can...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We develop the utility on GraalVM</h1><div class="post__text post__text-html js-mediator-article"><h2 id="postanovka-zadachi">  Formulation of the problem </h2><br><p>  Periodically, I have the task to share files over a local network, for example, with a project colleague. </p><br><p>  There can be a lot of solutions for this - Samba / FTP / scp.  You can simply upload the file to a publicly accessible public place like Google Drive, attach it to a task in Jira, or even send a letter. </p><br><p>  But all this is to some extent inflexible, somewhere it requires preliminary adjustment and has its limitations (for example, the maximum size of the attachment). </p><br><p>  And you want something more lightweight and flexible. </p><br><p>  I was always pleasantly surprised by the opportunity in Linux, using available tools, to quickly build a practical solution. </p><br><p>  Say, I often solved the above mentioned problem using the system python with the following one-liner </p><br><pre><code class="bash hljs">$ python3 -mhttp.server Serving HTTP on 0.0.0.0 port 8000 ...</code> </pre> <br><p>  This command starts the web server in the current folder and allows you to get a list of files through the web interface and download them.  More similar items can be <a href="https://gist.github.com/willurd/5720255">poured here</a> . </p><a name="habracut"></a><br><p>  There are several inconveniences.  Now to transfer the download link to your colleague, you need to know your IP address on the network. </p><br><p>  For this it is convenient to use the command </p><br><pre> <code class="bash hljs">$ ifconfig -a</code> </pre> <br><p>  And then from the received list of network interfaces, select the appropriate one and manually compile a link like <a href="http://ip:8000/">http: // IP: 8000</a> , which you should send. </p><br><p>  The second inconvenience: this server is single threaded.  This means that while one of your colleagues is downloading the file, the second one will not even be able to download the list of files. </p><br><p>  In the third - it is inflexible.  If you need to transfer only one file, it will be unnecessary to open the entire folder, i.e.  will have to perform such gestures (and after still cleaning the garbage): </p><br><pre> <code class="bash hljs">$ mkdir tmp1 $ cp file.zip tmp1 $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> tmp1 $ python3 -mhttp.server</code> </pre> <br><p>  The fourth inconvenience - there is no <em>easy</em> way to download the entire contents of the folder. </p><br><p>  To transfer the contents of the folder is usually used a technique called the <a href="https://docstore.mik.ua/orelly/unix3/upt/ch10_13.htm">tar pipe</a> . </p><br><p>  Do something like this: </p><br><pre> <code class="bash hljs">$ ssh user@host <span class="hljs-string"><span class="hljs-string">'cd /path/to/source &amp;&amp; tar cf - .'</span></span> | <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /path/to/destination &amp;&amp; tar xvf -</code> </pre> <br><p>  If suddenly it is not clear, I will explain how it works.  The first part of the <code>tar cf - .</code> command <code>tar cf - .</code>  Makes archive of the contents of the current folder and writes to the standard output.  Then this output through the pipe is transmitted via a secure ssh channel to the input of a similar <code>tar xvf -</code> which does the reverse procedure, i.e.  reads standard input and unzips to current folder.  In fact, there is a transfer of archive files, but without creating an intermediate file! </p><br><p>  Obviously, the inconvenience of this approach.  You need ssh access from one machine to another, which generally almost never does. </p><br><p>  Is it possible to achieve all of the above, but without these problems described? </p><br><p>  So, it's time to formalize what we will build: </p><br><ol><li>  Easy to install (static binary) </li><li>  Which will allow to transfer both the file and the folder with all contents </li><li>  With optional compression </li><li>  Which will allow the receiving party to download the file (s) using only standard * nix tools (wget / curl / tar) </li><li>  After launch, the program will immediately issue exact commands for downloading. </li></ol><br><h2 id="reshenie">  Decision </h2><br><p>  At the <a href="https://jeeconf.com/">JEEConf</a> conference, which I attended not so long ago, the topic of <a href="https://www.graalvm.org/">Graal was</a> raised repeatedly.  The topic is far from new, but for me it was a trigger to finally touch this beast with my own hand. </p><br><p>  For those who are not yet in the subject line (are there really any such? OO) let me remind you that GraalVM is such a pumped-up JVM from Oracle with additional features, the most notable of which are: </p><br><ol><li>  Polyglot JVM - the ability to seamlessly launch Java, Javascript, Python, Ruby, R, etc.  code </li><li>  Support AOT compilation - compile Java directly into the native binary </li><li>  A less noticeable, but very cool feature is that the C2 compiler has been rewritten from C ++ to Java for the purpose of more convenient further development.  This has already produced noticeable results.  This compiler makes much more optimizations at the stage of converting Java bytecode to native code.  For example, it is able to more effectively remove allocations.  Twitter was able to reduce CPU consumption by 11% simply by turning on this setting, which in their scale gave a noticeable saving of resources (and money). </li></ol><br><p>  Refresh the idea of ‚Äã‚ÄãGraal can, for example, <a href="https://habr.com/ru/company/haulmont/blog/433432/">in this article</a> . </p><br><p>  We will write in Java, so for us the most relevant feature will be an AOT compilation. </p><br><p>  Actually, the result of the development is presented <a href="https://github.com/xonixx/serv">in this Github repository</a> . </p><br><p>  An example of using to transfer a single file: </p><br><pre> <code class="bash hljs">$ serv <span class="hljs-string"><span class="hljs-string">'/path/to/report.pdf'</span></span> To download the file please use one of the commands below: curl http://192.168.0.179:17777/dl &gt; <span class="hljs-string"><span class="hljs-string">'report.pdf'</span></span> wget -O- http://192.168.0.179:17777/dl &gt; <span class="hljs-string"><span class="hljs-string">'report.pdf'</span></span> curl http://192.168.0.179:17777/dl?z --compressed &gt; <span class="hljs-string"><span class="hljs-string">'report.pdf'</span></span> wget -O- http://192.168.0.179:17777/dl?z | gunzip &gt; <span class="hljs-string"><span class="hljs-string">'report.pdf'</span></span></code> </pre> <br><p>  An example of use when transferring the contents of a folder (all files including nested!): </p><br><pre> <code class="bash hljs">$ serv <span class="hljs-string"><span class="hljs-string">'/path/to/folder'</span></span> To download the files please use one of the commands below. NB! All files will be placed into current folder! curl http://192.168.0.179:17777/dl | tar -xvf - wget -O- http://192.168.0.179:17777/dl | tar -xvf - curl http://192.168.0.179:17777/dl?z | tar -xzvf - wget -O- http://192.168.0.179:17777/dl?z | tar -xzvf -</code> </pre> <br><p>  Yes, so simple! </p><br><p>  Please note - the program itself determines the correct IP address on which files will be available for download. </p><br><h2 id="nablyudeniya--razmyshleniya">  Observations / Reflections </h2><br><p>  It is clear that one of the goals in creating the program was its compactness.  And here is the result achieved: </p><br><pre> <code class="bash hljs">$ du -hs `<span class="hljs-built_in"><span class="hljs-built_in">which</span></span> serv` 2.4M /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/serv</code> </pre> <br><p>  Incredibly, the entire JVM, along with the application code, fit in a measly few megabytes!  Of course, everything is somewhat wrong, but more on that later. </p><br><p>  In fact, the Graal compiler produces a binary of slightly more than 7 megabytes.  I decided to further <a href="https://github.com/upx/upx">compress it with UPX</a> . </p><br><p>  This turned out to be a good idea, since the launch time was very insignificant at the same time: </p><br><p>  Uncompressed version: </p><br><pre> <code class="bash hljs">$ time ./build/com.cmlteam.serv.serv -v 0.1 real 0m0.001s user 0m0.001s sys 0m0.000s</code> </pre> <br><p>  Compressed: </p><br><pre> <code class="bash hljs">$ time ./build/serv -v 0.1 real 0m0.021s user 0m0.021s sys 0m0.000s</code> </pre> <br><p>  For comparison, the start time in the "traditional way": </p><br><pre> <code class="bash hljs">$ time java -cp <span class="hljs-string"><span class="hljs-string">"/home/xonix/proj/serv/target/classes:/home/xonix/.m2/repository/commons-cli/commons-cli/1.4/commons-cli-1.4.jar:/home/xonix/.m2/repository/org/apache/commons/commons-compress/1.18/commons-compress-1.18.jar"</span></span> com.cmlteam.serv.Serv -v 0.1 real 0m0.040s user 0m0.030s sys 0m0.019s</code> </pre> <br><p>  As you can see, two times slower than the UPX-version. </p><br><p>  In general, a short start time is one of the strengths of GraalVM.  This, as well as the low memory consumption, caused a significant enthusiasm around using this technology for microservices and serverless. </p><br><p>  I tried to make the logic of the program as minimal as possible and use a minimum of libraries.  In principle, such an approach is generally justified, and in this case I had concerns that adding third-party maven dependencies would significantly ‚Äúweight down‚Äù the resulting program file. </p><br><p>  For example, therefore, I did not use third-party dependencies for a Java web server (there are a lot of them for every taste and color), but I used the implementation of the web server from the <code>com.sun.net.httpserver.*</code> Package built into the JDK.  Actually, using the <code>com.sun.*</code> Package is considered a moveton, but I found this to be valid in this case, since I compile it into native code, and therefore the issue of compatibility between the JVM is not worth it. </p><br><p>  However, my fears were completely in vain.  In the program, I used two dependencies for convenience. </p><br><ol><li>  <code>commons-cli</code> - for parsing command line arguments </li><li>  <code>commons-compress</code> - to generate a folder tarball and optional gzip compression </li></ol><br><p>  In this case, the file size has increased very slightly.  I would venture to suggest that the Graal compiler is very smart so as not to put all the connected jar-nicks into the executable file, but only the code of them that is actually used by the application code. </p><br><p>  Compiling into native code on Graal is performed by <a href="https://www.graalvm.org/docs/reference-manual/aot-compilation/">native-image</a> utility.  It is worth mentioning that this process is resource intensive.  Say, in my not very slow configuration with an Intel 7700K CPU on board, this process takes 19 seconds.  Therefore, I recommend to start the program in development as usual (via java), and collect the binary at the final stage. </p><br><h2 id="vyvody">  findings </h2><br><p>  The experiment, I think, turned out to be very successful.  When developing, using the Graal toolkit, I did not encounter any insurmountable or even significant problems.  Everything worked predictably and stably.  Although it will almost certainly not be so smooth if you try to collect something more complicated in this way, for example, an <a href="https://royvanrijn.com/blog/2018/09/part-2-native-microservice-in-graalvm/">application on Spring Boot</a> .  Nevertheless, a number of platforms in which native support for Graal is announced has already been presented.  Among them are <a href="https://micronaut.io/">Micronaut</a> , <a href="https://microprofile.io/">Microprofile</a> , <a href="https://quarkus.io/">Quarkus</a> . </p><br><p>  As for the further development of the project, the <a href="https://github.com/xonixx/serv/issues">list of improvements</a> planned for version 0.2 is already ready.  Also, the build of the final binaries for Linux x64 only is implemented.  I hope that this omission will be corrected in the future, especially since Graal <code>native-image</code> compiler supports MacOS and Windows.  Unfortunately, he does not yet support cross-compilation, which would greatly facilitate the work. </p><br><p>  I hope that the presented utility will be useful at least to someone from the respected Habra community.  I would be glad twice if there are those who wish to attribute <a href="https://github.com/xonixx/serv">to the project</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/451574/">https://habr.com/ru/post/451574/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../451544/index.html">Gathering of the system operators of the ‚ÄúMedium‚Äù network points in Moscow, on May 18 at 14:00 at the Patriarshie Prudy</a></li>
<li><a href="../451552/index.html">We build the network channels of sales of the gadget DO-RA</a></li>
<li><a href="../451562/index.html">How to escape from the sect?</a></li>
<li><a href="../451566/index.html">Operation TaskMasters: how we exposed the cyber grouping, the attacking organizations of Russia and the CIS</a></li>
<li><a href="../45157/index.html">Is it appropriate to give a link to a competitor's website?</a></li>
<li><a href="../451576/index.html">The book "Our code. Craft, profession, art "</a></li>
<li><a href="../45158/index.html">Whether it is logical to advertise or link to a competitor on the site.</a></li>
<li><a href="../451580/index.html">MODX Digest # 5 (April 22 - May 13, 2019)</a></li>
<li><a href="../451586/index.html">Welcome to BD & DWH Raiffeisen MeetUp</a></li>
<li><a href="../451588/index.html">A note on integration testing using Jenkins on Kubernetes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>