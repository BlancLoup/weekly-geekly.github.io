<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>"Entertaining XenAPI", or "New Adventures of Citrix XenServer"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello colleagues! 
 Today I would like to continue my narration about Citrix XenServer 5.6 and about various aspects of working with it. This time I h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>"Entertaining XenAPI", or "New Adventures of Citrix XenServer"</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/022/752/899/0227528998fed1a24ec1ab94972a42f1.png" align="left">  Hello colleagues! <br>  Today I would like to continue my narration about <b>Citrix XenServer 5.6</b> and about various aspects of working with it.  This time I had to solve a rather simple (seemingly!) Problem: executing commands in <b>dom0</b> without using <b>SSH</b> .  Exploring the possibilities for implementation led to the discovery of some of the fun nuances of the HTTP API of this OS: ways to get <b>/ etc / passwd</b> , remotely run <b>rsync,</b> and sketches <b>XenSource thin CLI protocol</b> .  Now I will tell you what is called the story of a single recourse ... <br><br><a name="habracut"></a><br><br>  First of all, I would like to explain how this problem arose.  In the <a href="http://habrahabr.ru/company/pt/blog/140886/">previous series,</a> I showed the public beta of the security guard for <b>XenServer</b> , which I ‚Äúsaw‚Äù in the hope of writing a coherent guide.  One of the recommendations (similar to the <a href="http://www.vmware.com/files/pdf/techpaper/VMware_vSphere_HardeningGuide_May10_EN.pdf">security hardening guide</a> for <b>VMWare ESXi</b> ) is disabling the SSH daemon.  The motivation is that in the corporate version of Xen it is possible to use the <b>RBAC system</b> with authentication through Active Directory.  According to the recommendations of the vendor, this way is preferable from the point of view of security.  After some modification of the console startup scripts on <b>dom0</b> , described in <a href="http://www.ptsecurity.com/download/XenServer-Free-5-6-SHG.pdf">my manual</a> , getting through it to the system without a password is excluded.  Accordingly, to get directly to the <b>dom0</b> console requires knowledge of not only the password of the user with <b>pool-admin</b> rights, but also the <b>root</b> account information. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      OK.  Now we are faced with the task of remotely auditing an operating system using automated tools.  All that we have at our disposal is <b>XML-RPC</b> leading to <b>XenAPI</b> , its documentation and Xen-org sources in the beautiful OCaml language.  We would like to execute commands in bash and receive their ‚Äúexhaust‚Äù for further processing.  How to do it? <br><br>  First you need to understand why the normal way (through the console provided by the API) will not do this.  Let us recall the client-side console call technology: do you connect to the console ( <code>https://&lt;xen_host&gt;/console?ref=OpaqueRef:console_id</code> ), having a valid session_id, and get to the <b>vncterm</b> <a href="http://en.wikipedia.org/wiki/RFB_protocol">RFB terminal</a> .  It is clear that this protocol allows you to send mouse actions and button presses to a remote server, and in response to receive raster screen images.  Further is obvious: modern versions of the RFB protocol allow, among other things, to transfer files.  It is enough to master the execution of commands as well - and there are no problems.  However, that would be too easy.  Citrix uses <a href="http://grox.net/doc/apps/vnc/rfbproto.pdf">the RFB protocol version 003.003</a> in its <a href="http://grox.net/doc/apps/vnc/rfbproto.pdf">vncterm terminals</a> : file transfer is not yet implemented. <br><br>  Given this sad news, our development team began to analyze possible methods for implementing vehicles through the <b>1998</b> RFB.  There are two ideas.  The first is integration with <a href="http://www.abbyy.ru/finereader/">ABBYY FineReader</a> (with text recognition on raster images obtained from <b>dom0</b> ).  The second is the emulation of mouse movements, which allow you to select text on the screen and send it to the clipboard that is available within the protocol.  <i>Both options on closer inspection resemble the ravings of a madman :)</i> <br><br>  The sad prospects made me go back to reading the documentation for <b>XenAPI</b> .  And I drew attention to what I had not encountered before, the plug-in architecture, namely the ability to access my own executable files via the RPC call <b>call_plugin</b> .  The modules are located in the <b>/etc/xapi.d/plugins/</b> directory. <img src="https://habrastorage.org/storage2/6ec/f5f/f02/6ecf5ff02daeae82edca2e74f76918b5.png" align="right">  Then everything is simple: the plugin created by us is invoked via <b>XML-RPC</b> and runs the corresponding <b>Python</b> script that implements the execution of the necessary commands by <b>subprocess</b> .  Fine!  The methodology for executing commands on dom0 and getting an answer from them has become clear. <br><br>  The next problem appeared by itself: how should our plugin get to the server?  When solving this problem, in fact, they discovered some <b>XenAPI</b> <i>‚Äúunderwater rakes‚Äù</i> . <br><br>  Of course, I was interested in the function, access to which can be obtained using the standard xe.exe utility, - <b>patch-upload</b> .  It allows you to remotely upload files to <b>XenServer</b> and install them on the entire pool of servers.  The format of the patch is quite simple: it is <b>shar</b> , packed in zip and signed (!) By Citrix.  You can read how to look into the patch and install it manually in a Selectel article.  When a patch is loaded, its signature is checked against the corresponding set of public keys in the <b>gpg keyring</b> .  Thus, it is enough to add your own signature to the common bundle - and the problem of pouring the plug-in disappears.  Assembling a similar design is not difficult, but to pour your key in the bundle you must have access to the console.  It turned out a vicious circle.  Therefore, I began to look for a way to flood my plugin bypassing standard methods. <br><br>  Using this call, I noted that the <code>https://&lt;xen_host&gt;/pool_patch_upload</code> is not in the official API description.  There is a logical explanation for this: it really is not part of the API.  Natural curiosity prompts the question: ‚Äú <i>What is it then?</i>  ".  The way to find the answer is very simple: <b>Wireshark</b> . <img src="https://habrastorage.org/storage2/0c9/8d1/bde/0c98d1bde55e9e645555935bd7cee144.png" align="left">  Perhaps you condemn me for such a straightforward approach, but the HTTP interface of the XenServer operating system API is described, unfortunately, a little less than nothing.  And by the time of work on this problem, I still did not understand <b>OCaml</b> at such a level as to analyze the source code quite effectively. <br><br>  Having used <b>Wireshark's</b> great opportunity to decrypt TLS and carefully left a certificate in <b>/ etc / xensource /</b> , I received a dump of the xe.exe utility (from XenCenter) communicating with the server. <img src="https://habrastorage.org/storage2/ec4/863/60e/ec486360e1acb036d100536bad93fecf.png" align="right">  I expected to see the <b>XML-RPC</b> communication described in the official documentation.  But it was not there!  Instead, ‚ÄúPOST / cli HTTP / 1.0‚Äù was lit up in the log.  The utility took the command, its attributes - and sent them to <code>https://&lt;xen_host&gt;/cli</code> .  " <i>It seems that something is missing in the soup</i> ."  From the decryption of the protocol it followed that there is a certain <b>XenSource thin CLI protocol</b> that the utility uses.  All paths led on <b>Github</b> to the <a href="https://github.com/xen-org/">XenAPI source</a> . <br><br>  After spending some time reading the source codes of this excellent component of the hypervisor, I found out that this ‚Äú <b>XenSource thin CLI protocol</b> ‚Äù API version 0.2 exists, which implements the execution of xe.exe helper commands on a remote host. <img src="https://habrastorage.org/storage2/5c1/0b7/d5b/5c10b7d5b82e0444bb59ee253a98516b.png" align="left">  It is described in the file <a href="">xapi / cli_protocol.ml</a> .  It is noteworthy that this is the ‚ÄúAPI of the future‚Äù, designed to make the xe.exe utility just a means for sending commands, and the handler to be embedded in XenAPI. <br><br>  In general, the discovery of this CLI API was fateful: it showed that at port 80 \ 443 there is not only an <b>XML-RPC</b> receiver and a switch <b>/ console</b> .  What other modules are available through a similar call - you accidentally found it in one of the source code files ( <a href="">xen-api / ocaml / idl / constants.ml</a> ).  As you can easily guess, there were a lot of calls that gave out very interesting information.  I was challenged by the <code>https://&lt;xen-host&gt;/syns_config_files</code> : with sufficient rights ( <b>pool-admin</b> ) you get <b>/ etc / passwd</b> (as I mentioned in your past articles, XenServer stores the password hash there.) <br><br>  Another interesting challenge is implemented via ‚Äú <code>CONNECT /remotecmd?cmd=rsync&amp;arg=some_nice_arg &amp;pool_secret=your_pool_secret</code> ‚Äù.  It allows, knowing the value of <b>/ etc / xensource / ptoken</b> , to remotely execute the <b>rsync</b> command on the server with <b>root privileges</b> .  This gives, in essence, full access to the file system.  But you probably ask: "But how to get <b>ptoken</b> ?". <br><br>  Here is still more trivial.  <b>Xensource</b> developers <b>have</b> created the ability to remotely retrieve the contents of the pool as an XML file.  If you make a request on the server like " <code>GET /pool/xmldbdump?session_id=</code> " then you will get a complete set of key-value pairs, among which you can easily find the necessary <b>pool_token</b> . <br><br>  Well and, actually, the remote download of patches is carried out through the call " <code>PUT /pool_patch_upload?session_id=</code> ".  In response, the server will write: "200, OK."  And it will wait when you start to fill in the socket information.  As soon as you upload the file, the validation of the patch will begin.  But there is one feature: as long as you keep the connection, the API considers that you are still uploading the file and does not touch it (although the file has already been created in <b>/ var / patch</b> ).  I did not find checks on file length.  Since <b>/ var / patch</b> is in the root of the server, DoS is inevitable if <b>/ dev / urandom</b> is sent there. <br><br>  Of course, this is not all.  Look at the challenges and the necessary rights <a href="">here</a> . <br>  All code is perfectly documented, and it seems to me that if there is an accurately formulated question, it will not be difficult to find the answer in it. <br><br>  In general, the composition of the methods I described was enough to successfully upload the patch to the system without verifying the signature.  I will not make a detailed description of the methodology, because it borders on the concept of ‚Äú <i>exploitation of vulnerability</i> ‚Äù, but I think that you yourself understood everything :) <br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/147736/">https://habr.com/ru/post/147736/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../147728/index.html">Syte - an engine for personal websites with the ability to integrate social services</a></li>
<li><a href="../147731/index.html">Protect your Dropbox account with two-step authentication</a></li>
<li><a href="../147732/index.html">Reverse engineering of the App Store protocol</a></li>
<li><a href="../147734/index.html">Perspective: DigiPen Student Game</a></li>
<li><a href="../147735/index.html">Facebook SDK 3.0 for iOS and iOS Dev Center released</a></li>
<li><a href="../147737/index.html">Worst-case thinking</a></li>
<li><a href="../147738/index.html">Mathematical model of communication</a></li>
<li><a href="../147739/index.html">Read more about the implementation of GCM support on the Android client</a></li>
<li><a href="../147741/index.html">How I became a Robocode Champion</a></li>
<li><a href="../147742/index.html">Poster app for iOS: buying movie tickets, viewing trailers, adding photos and places</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>