<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>[The Methanum project] Creating tools for building distributed systems with the ‚ÄúStar‚Äù topology</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The star is by far the most common topology of computer networks. This structure has several advantages: ease of scaling, reliability (the failure of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>[The Methanum project] Creating tools for building distributed systems with the ‚ÄúStar‚Äù topology</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/306/5f6/5e7/3065f65e7fee43d184d814e252f1cb47.png"></div><br><br>  The star is by far the most common topology of computer networks.  This structure has several advantages: ease of scaling, reliability (the failure of one machine does not affect the others) and ease of administration.  Of course, this solution from the physical layer has long been implemented at the program level.  Nevertheless, I present my version of the .Net toolkit for building distributed systems with a star topology to the readers. <a name="habracut"></a><br><br>  Systems built on the basis of such a topology can be structurally organized, for example, as in the image below. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/files/138/e41/f80/138e41f80eb34073aee1bec633898cbd.jpg"></div><br><br>  In this article, I will describe the creation of a minimal toolkit, without many useful features that I once used in my designs based on the architecture presented.  However, this is quite enough to build really useful systems. <br><br><h3>  Methanum </h3><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/1c1/d59/dba/1c1d59dba8fb45b499d2c364804e9d0a.jpg"></div><br><br>  The project received the code name Methanum solely because of the structural similarity of the topology with the methane molecule :).  The central node performing the role of a communicator is called "Core".  The rest of the network applications are connected to the kernel and subscribe to events.  Also, each network application can emit events.  Thus, data is exchanged through the network through events.  Events is a serializable Event class that can contain arbitrary data.  An event contains at least 2 fields - the string field Destination, which classifies the event, and the Data field, which contains the key value dictionary.  Key is a string, the name of the argument, Value is of type object and may contain primitives (int, double, bool ...).  For structures, it is necessary to help the system serialize them somewhat. <br><br>  To begin with, we will create a project ‚Äúmethanum‚Äù of the class library in C # and add files to it as the text goes. <br><br><h3>  Event </h3><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/356/f6e/a36/356f6ea361ce4418b04d862dbe6ffe91.jpg"></div><br><br>  As already mentioned, the data is transmitted through events.  An event is a class that includes a Data data field and a field to identify a Destination event.  I also left two more fields: Id - a unique identifier and DataTime containing the time of the event creation.  These additional fields are needed solely for convenience, for example, for parsing logs.  The event class also contains a number of methods designed to simplify the life of the programmer, I think their purpose will be clear from the code and does not need additional explanations. <br><br><div class="spoiler">  <b class="spoiler_title">Event.cs</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Runtime.Serialization; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web.Script.Serialization; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">methanum</span></span> { [DataContract] [KnownType(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(List&lt;DateTime&gt;))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Event</span></span> { <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> A unique id of the event </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [DataMember] public Guid Id { set; get; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> DateTime of event creation </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [DataMember] public DateTime DataTime { get; set; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Target </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [DataMember] public string Destination { get; set; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Data container </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [DataMember] public Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string, object&gt;</span></span></span><span class="hljs-comment"> Data { get; set; } public Event() { Init(); } public Event(string destination) { Init(); Destination = destination; } private void Init() { Data = new Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string, object&gt;</span></span></span><span class="hljs-comment">(); Id = Guid.NewGuid(); DataTime = DateTime.Now; } public override string ToString() { var properties = GetType().GetProperties(); var sb = new StringBuilder(); sb.AppendFormat("[{0}]", GetType().Name); foreach (var property in properties) { if (property.Name == "Data") { sb.Append("\nData = "); string s = string.Format(" {0}", '{'); s = Data.Keys.Aggregate(s, (current, key) =&gt; current + String.Format("\n {0}\t:{1}", key, Data[key])); sb.AppendFormat("{0}\n{1}", s, '}'); } else sb.AppendFormat("\n{0} = {1};", property.Name, property.GetValue(this, null)); } return sb.ToString(); } public void SetData(string key, object obj) { Data[key] = obj; } public object GetObj(string key) { return !Data.ContainsKey(key) ? null : Data[key]; } public double GetDbl(string key) { return !Data.ContainsKey(key) ? Double.NaN : Convert.ToDouble(Data[key]); } public int GetInt(string key) { return !Data.ContainsKey(key) ? Int32.MinValue : Convert.ToInt32(Data[key]); } public bool GetBool(string key) { return Data.ContainsKey(key) &amp;&amp; Convert.ToBoolean(Data[key]); } public string GetStr(string key) { return !Data.ContainsKey(key) ? null : Convert.ToString(Data[key]); } public void SetCustomData(string key, object value) { var serializer = new JavaScriptSerializer(); var str = serializer.Serialize(value); SetData(key, str); } public object GetCustom(string key, Type valueType) { if (!Data.ContainsKey(key)) return null; if (Data[key].GetType() != typeof(string)) return null; var serializer = new JavaScriptSerializer(); var str = (string) Data[key]; var obj = serializer.Deserialize(str, valueType); return obj; } } }</span></span></code> </pre> <br></div></div><br><br><h3>  Gate </h3><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/67c/1ad/397/67c1ad3977774724a11ffb1f567f03c6.jpg"></div><br><br>  The core of the core lies in the implementation of the interface, let's call it the ‚Äúgate interface‚Äù.  The main goal of the gate is to provide functionality for registering clients and asynchronously sending events in both directions (from the application to the core and back). <br><br><div class="spoiler">  <b class="spoiler_title">IGate.cs</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ServiceModel; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">methanum</span></span> { [ServiceContract(CallbackContract = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IListener))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IGate</span></span> { [OperationContract] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Subscribe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; [OperationContract] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KillConnection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; [OperationContract] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Fire</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Event evt</span></span></span><span class="hljs-function">)</span></span>; } }</code> </pre><br></div></div><br><br>  Our data contract is duplex, in the forward direction - from the application to the core - we shoot events through IGate by calling the void Fire (Event evt) method.  The callback ‚Äî from kernel to application ‚Äî occurs via the IListener interface, which will be covered later. <br>  Gates work on the following principle.  When the kernel starts, a Gate object inherited from the IGate interface is created.  Gate has a static _subscribers field in which all active connections to the kernel are stored.  When calling the Subscribe () method, we add the current connection, if it has not yet been added.  The KillConnection () method is used to remove the current connection.  The most interesting is the Fire method (Event evt), but there is nothing complicated in it either.  Half of the method we dig up to the IP address and port, only to display information in the console.  I left this part of the code solely in order to demonstrate how to access the connection address, for example, to filter or log events by allowed addresses.  The main work of this method is to bypass all existing connections and asynchronously call the Receive method from their IListener listeners.  If we find a closed connection, we immediately remove it from the list of active connections. <br><br><div class="spoiler">  <b class="spoiler_title">Gate.cs</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ServiceModel; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ServiceModel.Channels; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">methanum</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Gate</span></span> : <span class="hljs-title"><span class="hljs-title">IGate</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> List&lt;OperationContext&gt; _subscribers; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Gate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_subscribers == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) _subscribers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;OperationContext&gt;(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Subscribe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oc = OperationContext.Current; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_subscribers.Exists(c =&gt; c.SessionId == oc.SessionId)) { _subscribers.Add(oc); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"(subscribe \"{0}\")"</span></span>, oc.SessionId); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KillConnection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oc = OperationContext.Current; _subscribers.RemoveAll(c =&gt; c.SessionId == oc.SessionId); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"(kill \"{0}\")"</span></span>, oc.SessionId); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Fire</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Event evt</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currentOperationContext = OperationContext.Current; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> remoteEndpointMessageProperty = currentOperationContext.IncomingMessageProperties[RemoteEndpointMessageProperty.Name] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> RemoteEndpointMessageProperty; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ip = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> port = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (remoteEndpointMessageProperty != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { ip = remoteEndpointMessageProperty.Address; port = remoteEndpointMessageProperty.Port; } Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"(Fire (event . \"{0}\") (from . \"{1}:{2}\") (subscribers . {3}))"</span></span>, evt.Id, ip, port, _subscribers.Count); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = _subscribers.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>; i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; i--) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oc = _subscribers[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (oc.Channel.State == CommunicationState.Opened) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> channel = oc.GetCallbackChannel&lt;IListener&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ((DelegateReceive) (channel.Receive)).BeginInvoke(evt, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { Console.WriteLine(e.Message); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { _subscribers.RemoveAt(i); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"(dead . \"{0}\")"</span></span>, oc.SessionId); } } } } }</code> </pre><br></div></div><br><br><h3>  Listener </h3><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/023/839/be7/023839be78ae45a092487ec9c7db4c30.jpg"></div><br><br>  To send a message from the kernel to the client, only one Receive method is required, which is defined in the IListener interface. <br><br><div class="spoiler">  <b class="spoiler_title">IListener.cs</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ServiceModel; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">methanum</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">delegate</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DelegateReceive</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Event evt</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IListener</span></span> { [OperationContract(IsOneWay = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Receive</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Event evt</span></span></span><span class="hljs-function">)</span></span>; } }</code> </pre><br></div></div><br><br>  The Connector class is inherited from the IListener interface, which implements the entire logic of the interaction between the client application and the kernel.  When creating an instance of a class, a connection to the kernel is created, through which messages are sent and received.  Messages are sent and received in separate threads to prevent blocking of applications and the kernel.  To distinguish between events, they have the field Destination.  It is inconvenient to filter events using if-then-else or switch-case constructs, so a mechanism was implemented that allows a handler to be associated with each event of interest.  Such mapping is stored in the Dictionary Dictionary &lt;string, CbHandler&gt; _handlers ;.  When an event is accepted, a search is performed in the dictionary and, if a key is found, the corresponding handler is called. <br><br><div class="spoiler">  <b class="spoiler_title">Connector.cs</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Diagnostics; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ServiceModel; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">methanum</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">delegate</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CbHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Event evt</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Connector</span></span> : <span class="hljs-title"><span class="hljs-title">IListener</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, CbHandler&gt; _handlers; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> NetTcpBinding _binding; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> EndpointAddress _endpointToAddress; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> InstanceContext _instance; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DuplexChannelFactory&lt;IGate&gt; _channelFactory; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IGate _channel; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Thread _fireThread; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Event&gt; _eventQueue; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> CbHandler ReceiveEvent; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _isSubscribed; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> _channelSync = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnReceive</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Event evt</span></span></span><span class="hljs-function">)</span></span> { CbHandler handler = ReceiveEvent; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) handler.BeginInvoke(evt, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); } <span class="hljs-comment"><span class="hljs-comment">//localhost:2255 public Connector(string ipAddress) { init(ipAddress); } private void init(string ipAddress) { _handlers = new Dictionary&lt;string, CbHandler&gt;(); _binding = new NetTcpBinding(); _endpointToAddress = new EndpointAddress(string.Format("net.tcp://{0}", ipAddress)); _instance = new InstanceContext(this); Conect(); _eventQueue = new List&lt;Event&gt;(); _fireThread = new Thread(FireProc); _fireThread.IsBackground = true; _fireThread.Start(); } private void Conect() { _isSubscribed = false; while (!_isSubscribed) { try { _channelFactory = new DuplexChannelFactory&lt;IGate&gt;(_instance, _binding, _endpointToAddress); _channel = _channelFactory.CreateChannel(); _channel.Subscribe(); _isSubscribed = true; } catch (Exception e) { if (!(e is EndpointNotFoundException)) throw e; Thread.Sleep(1000); } } } private void ReConect() { lock (_channelSync) { try { _channel.KillConnection(); } catch (Exception e) { Console.WriteLine("(ReConect-exception \"{0}\"", e.Message); } Conect(); } } public void Fire(Event evt) { lock (_eventQueue) { _eventQueue.Add(evt); } } private void FireProc() { while (true) { var isHasEventsToFire = false; lock (_eventQueue) { isHasEventsToFire = _eventQueue.Any(); } if (_isSubscribed &amp;&amp; isHasEventsToFire) { Event evt; lock (_eventQueue) { evt = _eventQueue.First(); } try { lock (_eventQueue) { _eventQueue.Remove(evt); } _channel.Fire(evt); } catch (Exception) { if (_isSubscribed) _isSubscribed = false; ReConect(); } } else Thread.Sleep(10); } } public void SetHandler(string destination, CbHandler handler) { _handlers[destination] = handler; } public void DeleteHandler(string destination) { if(_handlers.ContainsKey(destination)) _handlers.Remove(destination); } public void Receive(Event evt) { if (_handlers.ContainsKey(evt.Destination)) { _handlers[evt.Destination].BeginInvoke(evt, null, null); } OnReceive(evt); } static public void HoldProcess() { var processName = Process.GetCurrentProcess().ProcessName; var defColor = Console.ForegroundColor; Console.ForegroundColor = ConsoleColor.Green; Console.WriteLine("The {0} is ready", processName); Console.WriteLine("Press &lt;Enter&gt; to terminate {0}", processName); Console.ForegroundColor = defColor; Console.ReadLine(); } } }</span></span></code> </pre><br></div></div><br><br>  For convenience, we will create another small class that starts the service. <br><br><div class="spoiler">  <b class="spoiler_title">SrvRunner.cs</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ServiceModel; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">methanum</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SrvRunner</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ServiceHost _sHost; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> port</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> uris = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"net.tcp://0.0.0.0:{0}"</span></span>, port)) }; _sHost = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServiceHost(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> (Gate), uris); _sHost.Open(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> uri2 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _sHost.BaseAddresses) { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Start on: {0}"</span></span>, uri2.ToString()); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Stop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _sHost.Close(); } } }</code> </pre><br></div></div><br><br><h3>  Core </h3><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/264/c2c/9c6/264c2c9c6d7f4ad0b8af34e00c3f7902.jpg"></div><br><br>  We implemented all the classes necessary for communicating our applications.  It remains to create a kernel to which our applications will connect.  To do this, in the solution we create a project ‚ÄúCore‚Äù of the console application, connect the methanum assembly to it.  In general, we have already written everything, it remains only to run. <br><br><div class="spoiler">  <b class="spoiler_title">CoreMain.cs</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> methanum; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Core</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CoreMain</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> port = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((!args.Any()) || (!<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.TryParse(args[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> port))) { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Usage:"</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Core.exe port"</span></span>); Environment.Exit(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> coreSrv = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SrvRunner(); coreSrv.Start(port); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"The Core is ready."</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Press &lt;ENTER&gt; to terminate Core."</span></span>); Console.ReadLine(); coreSrv.Stop(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { Console.WriteLine(e.Message); } } } }</code> </pre><br></div></div><br><br>  <b>Usage example</b> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/49b/040/6f9/49b0406f95c34bc1907fc5cc68c43b6a.jpg"></div><br><br>  For demostration, let's create a primitive messenger: create another console application, add a link to the methanum assembly, and paste the contents of the Program.cs file. <br><br><div class="spoiler">  <b class="spoiler_title">Program.cs</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> methanum; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ClentExamle</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((!args.Any())) { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Usage:"</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"ClentExample.exe coreAddress:port"</span></span>); Environment.Exit(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> userName = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (String.IsNullOrWhiteSpace(userName)) { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Please write user name:"</span></span>); userName = Console.ReadLine(); } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> maingate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Connector(args[<span class="hljs-number"><span class="hljs-number">0</span></span>]); maingate.SetHandler(<span class="hljs-string"><span class="hljs-string">"message"</span></span>, MsgHandler); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Hello {0}, now you can send messages"</span></span>, userName); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> msg = Console.ReadLine(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> evt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Event(<span class="hljs-string"><span class="hljs-string">"message"</span></span>); evt.SetData(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, userName); evt.SetData(<span class="hljs-string"><span class="hljs-string">"text"</span></span>, msg); maingate.Fire(evt); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { Console.WriteLine(e.Message); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MsgHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Event evt</span></span></span><span class="hljs-function">)</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"[{0}] &gt;&gt; {1}"</span></span>, evt.GetStr(<span class="hljs-string"><span class="hljs-string">"name"</span></span>), evt.GetStr(<span class="hljs-string"><span class="hljs-string">"text"</span></span>)); } } }</code> </pre><br></div></div><br><br>  Now we start the Core.exe application by specifying the port in the command line, for example ‚ÄúCore 2255‚Äù.  Then we start several instances of ClentExample.exe with the command ‚ÄúClentExample localhost: 2255‚Äù.  Applications offer to enter a username, and then connect to the kernel.  As a result, a broadcasting primitive chat is obtained: each new message is sent by calling maingate.Fire (evt), received in the MsgHandler (Event evt) handler. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/572/acd/00f/572acd00f7334be2bbfdb367787fdb33.jpg"></div><br><br>  The full source is available on methanum <a href="https://github.com/Beetle-ru/methanum">gihab</a> . </div><p>Source: <a href="https://habr.com/ru/post/280640/">https://habr.com/ru/post/280640/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280630/index.html">Fibbing: IT Routes</a></li>
<li><a href="../280632/index.html">Programming example in Puppet version 3.8 using Hiera and R10K</a></li>
<li><a href="../280634/index.html">Mandrill everything? As I was looking for a replacement and found 2 excellent alternatives to Mandrila</a></li>
<li><a href="../280636/index.html">How you can use responsive web components today</a></li>
<li><a href="../280638/index.html">Xamarin is now free. "In the debugger, I have an exception (vosk. Sign)"</a></li>
<li><a href="../280642/index.html">man! (D => Rust) .basics</a></li>
<li><a href="../280644/index.html">We look at the drying of paint: How I filled the game on the Steam Store without any approval from Valve</a></li>
<li><a href="../280646/index.html">Steganography in acroconstructions. Algorithm DANTSOVA</a></li>
<li><a href="../280648/index.html">Change source code (DDL) on the fly</a></li>
<li><a href="../280652/index.html">EMC relies on ReactOS for storing big data in the IoT sphere</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>