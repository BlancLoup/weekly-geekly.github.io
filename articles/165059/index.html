<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We collect, parsim and give logs using Logstash</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings. 

 It so happened that I had to spend a lot of time on the logs. This includes participation in the development of rules and policies for c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We collect, parsim and give logs using Logstash</h1><div class="post__text post__text-html js-mediator-article">  Greetings. <br><br>  It so happened that I had to spend a lot of time on the logs.  This includes participation in the development of rules and policies for collecting / storing / using logs, this is also the analysis of various incidents and the detection of anomalies.  During the day our programs, services and servers generate a VERY large number of logs.  And the need to dig in the logs is growing constantly. <br>  I happened to work with commercial log management products like ArcSight, RSA Envision, Q1 Labs.  These products have both advantages and disadvantages.  But the article is not about them. <br>  This is about <a href="http://www.logstash.net/">Logstash</a> . <br><br>  What is Logstash?  Why is it needed?  What does he do? <br><a name="habracut"></a><br>  Logstash is a tool for collecting, filtering and normalizing logs.  It is a free and open source application.  Apache license type 2.0. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      My first acquaintance with LS (Logstash) happened more than a year ago, and since that time I have become very close to him.  I like his idea and possibilities.  For me, Logstash is like a meat grinder.  It doesn‚Äôt matter what goes into it, but after not complicated manipulations, the output is always beautifully and clearly arranged information. <br><br>  The format of the Logstash configuration file is simple and straightforward.  It consists of three parts: <br><br><pre><code class="bash hljs">input { ... } filter { ... } output { ... }</code> </pre> <br>  Input, filtering and output (or outgoing?) Blocks can be any number.  It all depends on your needs and capabilities of iron. <br>  Blank lines and lines beginning with <b>#</b> - Logstash ignores.  So commenting on the configuration files will not cause any problems. <br><br><h4>  1. INPUT </h4>  This method is the entry point for logs.  It determines which channels the logs will get into Logstash. <br>  In this article I will try to introduce you to the basic types that I use - this is file, tcp and udp. <br><div class="spoiler">  <b class="spoiler_title">1.1 file</b> <div class="spoiler_text">  Configuration example, for working with local log files: <br><pre> <code class="bash hljs">input { file { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"some_access_log"</span></span> path =&gt; [ <span class="hljs-string"><span class="hljs-string">"/var/log/vs01/*.log"</span></span>, <span class="hljs-string"><span class="hljs-string">"/var/log/vs02/*.log"</span></span> ] exclude =&gt; [ <span class="hljs-string"><span class="hljs-string">"*.gz"</span></span>, <span class="hljs-string"><span class="hljs-string">"*.zip"</span></span>, <span class="hljs-string"><span class="hljs-string">"*.rar"</span></span> ] start_position =&gt; <span class="hljs-string"><span class="hljs-string">"end"</span></span> stat_interval =&gt; 1 discover_interval =&gt; 30 } }</code> </pre><br><br>  Line by line description of settings: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"some_access_log"</span></span></code> </pre>  type / description of the log.  When using multiple input blocks, it is convenient to separate them for subsequent actions in filter or output. <br><br><pre> <code class="bash hljs">path =&gt; [ <span class="hljs-string"><span class="hljs-string">"/var/log/vs01/*.log"</span></span>, <span class="hljs-string"><span class="hljs-string">"/var/log/vs02/*.log"</span></span> ]</code> </pre>  specify the path to the log files to be processed.  The path must be absolute (/ path / to / logs /), not relative (../../some/other/path/). <br><br><pre> <code class="bash hljs">exclude =&gt; [ <span class="hljs-string"><span class="hljs-string">"*.gz"</span></span>, <span class="hljs-string"><span class="hljs-string">"*.zip"</span></span>, <span class="hljs-string"><span class="hljs-string">"*.rar"</span></span> ]</code> </pre>  excludes files with appropriate extensions from processing. <br><br><pre> <code class="bash hljs">start_position =&gt; <span class="hljs-string"><span class="hljs-string">"end"</span></span></code> </pre>  waiting for new messages at the end of the file.  When processing already existing logs, you can set the "beginning", then the processing of logs will occur line by line from the beginning of the files. <br><br><pre> <code class="bash hljs">stat_interval =&gt; 1</code> </pre>  how often (in seconds) to check files for changes.  For large values, the frequency of system calls will decrease, but the time for reading new lines will also increase. <br><br><pre> <code class="bash hljs">discover_interval =&gt; 30</code> </pre>  time (in seconds) after which the list of processed files specified in the <b>path</b> will be updated. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">1.2 tcp</b> <div class="spoiler_text">  Configuration example for working with remote service logs: <br><pre> <code class="bash hljs">input { tcp { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"webserver_prod"</span></span> data_timeout =&gt; 10 mode =&gt; <span class="hljs-string"><span class="hljs-string">"server"</span></span> host =&gt; <span class="hljs-string"><span class="hljs-string">"192.168.3.12"</span></span> port =&gt; 3337 } }</code> </pre><br><br>  Line by line description of settings: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"webserver_prod"</span></span></code> </pre>  type / description of the log. <br><br><pre> <code class="bash hljs">data_timeout =&gt; 10</code> </pre>  the time (in seconds) after which the inactive tcp connection will be closed.  Value <b>-1</b> - connection will always be open. <br><br><pre> <code class="bash hljs">mode =&gt; <span class="hljs-string"><span class="hljs-string">"server"</span></span> host =&gt; <span class="hljs-string"><span class="hljs-string">"192.168.3.12"</span></span> port =&gt; 3337</code> </pre>  in this case, Logstash becomes the server, and starts listening at 192.168.3.12.73.  When setting <b>mode =&gt; ‚Äúclient‚Äù,</b> Logstash will join the remote ip: port for logging. </div></div><br><div class="spoiler">  <b class="spoiler_title">1.3 udp</b> <div class="spoiler_text">  For <b>udp</b> settings similar to tcp: <br><pre> <code class="bash hljs">input { udp { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"webserver_prod"</span></span> buffer_size =&gt; 4096 host =&gt; <span class="hljs-string"><span class="hljs-string">"192.168.3.12"</span></span> port =&gt; 3337 } }</code> </pre></div></div><br><h4>  2. FILTER </h4>  In this block, the basic log manipulations are configured.  This can be a breakdown by key = value, and the removal of unnecessary parameters, and the replacement of existing values, and the use of geoip or DNS queries for ip-addresses or host names. <br><br>  At first glance, the use of filters may seem complicated and illogical, but this is not entirely true. <br><div class="spoiler">  <b class="spoiler_title">2.1 grok</b> <div class="spoiler_text">  An example of a configuration file for basic log normalization: <br><pre> <code class="bash hljs">filter { grok { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"some_access_log"</span></span> patterns_dir =&gt; <span class="hljs-string"><span class="hljs-string">"/path/to/patterns/"</span></span> pattern =&gt; <span class="hljs-string"><span class="hljs-string">"%{IP:client} %{WORD:method} %{URIPATHPARAM:request} %{NUMBER:bytes} %{NUMBER:duration}"</span></span> } }</code> </pre><br><br>  Line by line description of settings: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"apache_access"</span></span></code> </pre>  type / description of the log.  Here you need to specify the type (type), which is registered in the <b>input</b> block for which processing will take place. <br><br><pre> <code class="bash hljs">patterns_dir =&gt; <span class="hljs-string"><span class="hljs-string">"/path/to/patterns/"</span></span></code> </pre>  path to the directory containing log processing templates.  All files in the specified folder will be loaded by Logstash, so that extra files are not desirable there. <br><br><pre> <code class="bash hljs">pattern =&gt; <span class="hljs-string"><span class="hljs-string">"%{IP:client} %{WORD:method} %{URIPATHPARAM:request} %{NUMBER:bytes} %{NUMBER:duration}"</span></span></code> </pre>  Indicates a template for dismantling logs.  The template can be used either in the configuration file or from a template file.  Not to be confused, I create a separate template file for each log format. <br><br><div class="spoiler">  <b class="spoiler_title">Read more about templates</b> <div class="spoiler_text">  Using the <b>grok</b> filter, you can structure most of the logs - syslog, apache, nginx, mysql, etc., recorded in a specific format. <br>  Logstash has over 120 ready-made regular expression patterns (regex).  So writing filters to handle most logs should not cause much fear or misunderstanding. <br><br>  The format of templates is relatively simple - <b>NAME PATTERN</b> , that is, the name of the template and its corresponding regular expression are specified line by line.  Example: <br><pre> <code class="bash hljs">NUMBER \d+ WORD \b\w+\b USERID [a-zA-Z0-9_-]+</code> </pre> <br>  You can use any previously created template: <br><pre> <code class="bash hljs">USER %{USERID}</code> </pre><br>  Templates can also be combined: <br><pre> <code class="bash hljs">CISCOMAC (?:(?:[A-Fa-f0-9]{4}\.){2}[A-Fa-f0-9]{4}) WINDOWSMAC (?:(?:[A-Fa-f0-9]{2}-){5}[A-Fa-f0-9]{2}) MAC (?:%{CISCOMAC}|%{WINDOWSMAC})</code> </pre><br><br>  Suppose we have the following log format: <br> <code>55.3.244.1 GET /index.html 15824 0.043</code> <br> <br>  Among the ready-made templates, fortunately there are already some regular expressions and there is no need to invent a wheeled vehicle driven by human muscle force through foot pedals or hand levers (I mean the bicycle if that). <br>  With this log example, it is enough to write the pattern as " <b>% {IP: client}% {WORD: method}% {URIPATHPARAM: request}% {NUMBER: bytes}% {NUMBER: duration}</b> ", in this case all logs with this format will already have a certain logical structure. <br>  After processing, our line will look like this: <br><blockquote>  client: 55.3.244.1 <br>  method: GET <br>  request: /index.html <br>  bytes: 15824 <br>  duration: 0.043 <br></blockquote><br><br>  A list of ready-made grok-templates can be found <a href="https://github.com/logstash/logstash/tree/v1.1.9/patterns">here</a> . <br><br></div></div><br></div></div><br><div class="spoiler">  <b class="spoiler_title">2.2 mutate</b> <div class="spoiler_text">  An example of a configuration file for changing / deleting entries from logs: <br><pre> <code class="bash hljs">filter { mutate { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"apache_access"</span></span> remove =&gt; [ <span class="hljs-string"><span class="hljs-string">"client"</span></span> ] rename =&gt; [ <span class="hljs-string"><span class="hljs-string">"HOSTORIP"</span></span>, <span class="hljs-string"><span class="hljs-string">"client_ip"</span></span> ] gsub =&gt; [ <span class="hljs-string"><span class="hljs-string">"message"</span></span>, <span class="hljs-string"><span class="hljs-string">"\\/"</span></span>, <span class="hljs-string"><span class="hljs-string">"_"</span></span> ] add_field =&gt; [ <span class="hljs-string"><span class="hljs-string">"sample1"</span></span>, <span class="hljs-string"><span class="hljs-string">"from %{clientip}"</span></span> ] } }</code> </pre><br>  Line by line description of settings: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"apache_access"</span></span></code> </pre>  type / description of the log.  The type (log) of logs with which the processing will take place is indicated. <br><br><pre> <code class="bash hljs">remove =&gt; [ <span class="hljs-string"><span class="hljs-string">"client"</span></span> ]</code> </pre>  deletion of all data with the name of the <b>client</b> field.  It is possible to specify several field names. <br><br><pre> <code class="bash hljs">rename =&gt; [ <span class="hljs-string"><span class="hljs-string">"HOSTORIP"</span></span>, <span class="hljs-string"><span class="hljs-string">"client_ip"</span></span> ]</code> </pre>  rename field name <b>HOSTORIP</b> to <b>client_ip</b> . <br><br><pre> <code class="bash hljs">gsub =&gt; [ <span class="hljs-string"><span class="hljs-string">"message"</span></span>, <span class="hljs-string"><span class="hljs-string">"\\/"</span></span>, <span class="hljs-string"><span class="hljs-string">"_"</span></span> ]</code> </pre>  replace all "/" with "_" in the <b>messages</b> field. <br><br><pre> <code class="bash hljs">add_field =&gt; [ <span class="hljs-string"><span class="hljs-string">"sample1"</span></span>, <span class="hljs-string"><span class="hljs-string">"from %{clientip}"</span></span> ]</code> </pre>  Adding a new field ‚Äúsample1‚Äù with the value ‚Äúfrom% {clientip}‚Äù.  The use of variable names is allowed. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">2.3 date</b> <div class="spoiler_text">  Sample configuration file: <br><pre> <code class="bash hljs">filter { date { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"apache_access"</span></span> match =&gt; [ <span class="hljs-string"><span class="hljs-string">"timestamp"</span></span>, <span class="hljs-string"><span class="hljs-string">"MMM dd HH:mm:ss"</span></span> ] } }</code> </pre><br>  Line by line description of settings: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"apache_access"</span></span></code> </pre>  type / description of the log.  The type (log) of logs with which the processing will take place is indicated. <br><br><pre> <code class="bash hljs">match =&gt; [ <span class="hljs-string"><span class="hljs-string">"timestamp"</span></span>, <span class="hljs-string"><span class="hljs-string">"MMM dd HH:mm:ss"</span></span> ]</code> </pre>  time stamp  An important setting for the further possibility of sorting or sampling logs.  If the time in the logs is specified in unix timestamp (squid), then match =&gt; ["timestamp", "UNIX"] <br></div></div><br><div class="spoiler">  <b class="spoiler_title">2.4 kv</b> <div class="spoiler_text">  An example of a configuration file for processing logs in the format key = value: <br><pre> <code class="bash hljs">filter { kv { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"custom_log"</span></span> value_split =&gt; <span class="hljs-string"><span class="hljs-string">"=:"</span></span> fields =&gt; [<span class="hljs-string"><span class="hljs-string">"reminder"</span></span>] field_split =&gt; <span class="hljs-string"><span class="hljs-string">"\t?&amp;"</span></span> } }</code> </pre><br>  Line by line description of settings: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"custom_log"</span></span></code> </pre>  type / description of the log.  The type (log) of logs with which the processing will take place is indicated. <br><br><pre> <code class="bash hljs">value_split =&gt; <span class="hljs-string"><span class="hljs-string">"=:"</span></span></code> </pre>  use the "=" and ":" characters to separate key-values. <br><br><pre> <code class="bash hljs">fields =&gt; [<span class="hljs-string"><span class="hljs-string">"reminder"</span></span>]</code> </pre>  the name of the field in which to look for 'key = value'.  By default, a breakdown will occur for the entire log line. <br><br><pre> <code class="bash hljs">field_split =&gt; <span class="hljs-string"><span class="hljs-string">"\t?&amp;"</span></span></code> </pre>  use "\ t? &amp;" characters to separate keys.  <i>\ t - tab character</i> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">2.5 multiline</b> <div class="spoiler_text">  An example of a configuration file for ‚Äúgluing‚Äù multi-line logs (for example, Java stack trace): <br><pre> <code class="bash hljs">filter { multiline { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"java_log"</span></span> pattern =&gt; <span class="hljs-string"><span class="hljs-string">"^\s"</span></span> what =&gt; <span class="hljs-string"><span class="hljs-string">"previous"</span></span> } }</code> </pre><br>  Line by line description of settings: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"java_log"</span></span></code> </pre>  type / description of the log.  The type (log) of logs with which the processing will take place is indicated. <br><br><pre> <code class="bash hljs">pattern =&gt; <span class="hljs-string"><span class="hljs-string">"^\s"</span></span></code> </pre>  regular expression <br><br><pre> <code class="bash hljs">what =&gt; <span class="hljs-string"><span class="hljs-string">"previous"</span></span></code> </pre>  when matching pattern, the string belongs to the previous (previous) string. <br><br></div></div><br><br><h4>  3. OUTPUT </h4>  The name of this block / method speaks for itself - it specifies settings for outgoing messages.  Like previous blocks, any number of outgoing sub-blocks can be specified here. <br><div class="spoiler">  <b class="spoiler_title">3.1 stdout</b> <div class="spoiler_text">  An example of a configuration file for outputting logs to standard output: <br><pre> <code class="bash hljs">output { stdout { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"custom_log"</span></span> message =&gt; <span class="hljs-string"><span class="hljs-string">"IP - %{clientip}. Full message: %{@message}. End of line."</span></span> } }</code> </pre><br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"custom_log"</span></span></code> </pre>  type / description of the log. <br><br><pre> <code class="bash hljs">message =&gt; <span class="hljs-string"><span class="hljs-string">"clIP - %{clientip}. Full message: %{@message}. End of line."</span></span></code> </pre>  indicates the format of the outgoing message.  It is acceptable to use variables after grok-filtering. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">3.2 file</b> <div class="spoiler_text">  An example of a configuration file for writing logs to a file: <br><pre> <code class="bash hljs">output { file { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"custom_log"</span></span> flush_interval =&gt; 5 gzip=&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span> path =&gt; <span class="hljs-string"><span class="hljs-string">"/var/log/custom/%{clientip}/%{type}"</span></span> message_format =&gt; <span class="hljs-string"><span class="hljs-string">"ip: %{clientip} request:%{requri}"</span></span> } }</code> </pre><br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"custom_log"</span></span></code> </pre>  type / description of the log. <br><br><pre> <code class="bash hljs">flush_interval =&gt; 5</code> </pre>  the recording interval for outgoing messages.  A value of <b>0</b> will record every message. <br><br><pre> <code class="bash hljs">gzip=&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre>  the outgoing message file will be compressed with gzip. <br><br><pre> <code class="bash hljs">path =&gt; <span class="hljs-string"><span class="hljs-string">"/var/log/custom/%{clientip}/%{type}"</span></span></code> </pre>  path and file name where outgoing messages will be saved.  You can use variables.  In this example, a separate folder will be created for each unique IP address and messages will be written to the file corresponding to the% {type} variable. <br><br><pre> <code class="bash hljs">message_format =&gt; <span class="hljs-string"><span class="hljs-string">"ip: %{clientip} request:%{requri}"</span></span></code> </pre>  outgoing message format. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">3.3 elasticsearch</b> <div class="spoiler_text">  An example of a configuration file for writing logs to the Elasticsearch database: <br><pre> <code class="bash hljs">output { elasticsearch { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"custom_log"</span></span> cluster =&gt; <span class="hljs-string"><span class="hljs-string">"es_logs"</span></span> embedded =&gt; <span class="hljs-literal"><span class="hljs-literal">false</span></span> host =&gt; <span class="hljs-string"><span class="hljs-string">"192.168.1.1"</span></span> port =&gt; <span class="hljs-string"><span class="hljs-string">"19300"</span></span> index =&gt; <span class="hljs-string"><span class="hljs-string">"logs-%{+YYYY.MM.dd}"</span></span> } }</code> </pre><br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"custom_log"</span></span></code> </pre>  type / description of the log. <br><br><pre> <code class="bash hljs">cluster =&gt; <span class="hljs-string"><span class="hljs-string">"es_logs"</span></span></code> </pre>  the name of the cluster specified in <b>cluster.name</b> in the <b>Elasticsearch</b> configuration file. <br><br><pre> <code class="bash hljs">embedded =&gt; <span class="hljs-literal"><span class="hljs-literal">false</span></span></code> </pre>  indicates which Elasticsearch database to use internal or third-party. <br><br><pre> <code class="bash hljs">port =&gt; <span class="hljs-string"><span class="hljs-string">"19300"</span></span></code> </pre>  transport port Elasticsearch. <br><br><pre> <code class="bash hljs">host =&gt; <span class="hljs-string"><span class="hljs-string">"192.168.1.1"</span></span></code> </pre>  Elasticsearch IP Address <br><br><pre> <code class="bash hljs">index =&gt; <span class="hljs-string"><span class="hljs-string">"logs-%{+YYYY.MM.dd}"</span></span></code> </pre>  index name where logs will be recorded. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">3.4 email</b> <div class="spoiler_text">  This plugin can be used for alerts.  The downside is that any changes to notifications (in principle, like any other settings) require restarting the logstash program, but the developer says that it may not be necessary in the future. <br>  Sample configuration file: <br><pre> <code class="bash hljs">output { email { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"custom_log"</span></span> from =&gt; <span class="hljs-string"><span class="hljs-string">"logstash@domain.com"</span></span> to =&gt; <span class="hljs-string"><span class="hljs-string">"admin1@domain.com"</span></span> cc =&gt; <span class="hljs-string"><span class="hljs-string">"admin2@domain.com"</span></span> subject =&gt; <span class="hljs-string"><span class="hljs-string">"Found '%{matchName}' Alert on %{@source_host}"</span></span> body =&gt; <span class="hljs-string"><span class="hljs-string">"Here is the event line %{@message}"</span></span> htmlbody =&gt; <span class="hljs-string"><span class="hljs-string">"&lt;h2&gt;%{matchName}&lt;/h2&gt;&lt;br/&gt;&lt;br/&gt;&lt;h3&gt;Full Event&lt;/h3&gt;&lt;br/&gt;&lt;br/&gt;&lt;div align='center'&gt;%{@message}&lt;/div&gt;"</span></span> via =&gt; <span class="hljs-string"><span class="hljs-string">"sendmail"</span></span> options =&gt; [ <span class="hljs-string"><span class="hljs-string">"smtpIporHost"</span></span>, <span class="hljs-string"><span class="hljs-string">"smtp.gmail.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"port"</span></span>, <span class="hljs-string"><span class="hljs-string">"587"</span></span>, <span class="hljs-string"><span class="hljs-string">"domain"</span></span>, <span class="hljs-string"><span class="hljs-string">"yourDomain"</span></span>, <span class="hljs-string"><span class="hljs-string">"userName"</span></span>, <span class="hljs-string"><span class="hljs-string">"yourSMTPUsername"</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span>, <span class="hljs-string"><span class="hljs-string">"PASS"</span></span>, <span class="hljs-string"><span class="hljs-string">"starttls"</span></span>, <span class="hljs-string"><span class="hljs-string">"true"</span></span>, <span class="hljs-string"><span class="hljs-string">"authenticationType"</span></span>, <span class="hljs-string"><span class="hljs-string">"plain"</span></span>, <span class="hljs-string"><span class="hljs-string">"debug"</span></span>, <span class="hljs-string"><span class="hljs-string">"true"</span></span> ] match =&gt; [ <span class="hljs-string"><span class="hljs-string">"response errors"</span></span>, <span class="hljs-string"><span class="hljs-string">"response,501,,or,response,301"</span></span>, <span class="hljs-string"><span class="hljs-string">"multiple response errors"</span></span>, <span class="hljs-string"><span class="hljs-string">"response,501,,and,response,301"</span></span> ] } }</code> </pre><br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"custom_log"</span></span></code> </pre>  type / description of the log. <br><br><pre> <code class="bash hljs">from =&gt; <span class="hljs-string"><span class="hljs-string">"logstash@domain.com"</span></span> to =&gt; <span class="hljs-string"><span class="hljs-string">"admin1@domain.com"</span></span> cc =&gt; <span class="hljs-string"><span class="hljs-string">"admin2@domain.com"</span></span></code> </pre>  if you have the strength to read this line up, then you can determine the meaning of these 3 settings by yourself :) <br><br><pre> <code class="bash hljs">subject =&gt; <span class="hljs-string"><span class="hljs-string">"Found '%{matchName}' Alert on %{@source_host}"</span></span></code> </pre>  subject letter of the notice.  You can use variables.  For example,% {matchName} is the name of the match condition from the ‚Äúmatch‚Äù setting. <br><br><pre> <code class="bash hljs">body =&gt; <span class="hljs-string"><span class="hljs-string">"Here is the event line %{@message}"</span></span> htmlbody =&gt; <span class="hljs-string"><span class="hljs-string">"&lt;h2&gt;%{matchName}&lt;/h2&gt;&lt;br/&gt;&lt;br/&gt;&lt;h3&gt;Full Event&lt;/h3&gt;&lt;br/&gt;&lt;br/&gt;&lt;div align='center'&gt;%{@message}&lt;/div&gt;"</span></span></code> </pre>  body of the letter. <br><br><pre> <code class="bash hljs">via =&gt; <span class="hljs-string"><span class="hljs-string">"sendmail"</span></span></code> </pre>  way of sending the letter.  One option is possible from two - smtp or sendmail. <br><br><pre> <code class="bash hljs">options =&gt; ...</code> </pre>  standard mail settings. <br><br><pre> <code class="bash hljs">match =&gt; [ <span class="hljs-string"><span class="hljs-string">"response errors"</span></span>, <span class="hljs-string"><span class="hljs-string">"response,501,,or,response,301"</span></span>, <span class="hljs-string"><span class="hljs-string">"multiple response errors"</span></span>, <span class="hljs-string"><span class="hljs-string">"response,501,,and,response,301"</span></span> ]</code> </pre>  "Response errors" - the name of the alert (recorded in the variable% {matchName}).  ‚ÄúResponse, 501,, or, response, 301‚Äù - alert triggering criteria.  In this example, if the response field contains the value 501 or 301, then the alert is considered triggered.  The second line uses the AND logic, i.e.  both conditions must be met. <br><br></div></div><br><br><h4>  4. Total </h4><br>  Create a habr.conf file: <br><pre> <code class="bash hljs">input { tcp { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"habr"</span></span> port =&gt; <span class="hljs-string"><span class="hljs-string">"11111"</span></span> } } filter { mutate { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"habr"</span></span> add_field =&gt; [ <span class="hljs-string"><span class="hljs-string">"habra_field"</span></span>, <span class="hljs-string"><span class="hljs-string">"Hello Habr"</span></span> ] } } output { stdout { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"habr"</span></span> message =&gt; <span class="hljs-string"><span class="hljs-string">"%{habra_field}: %{@message}"</span></span> } }</code> </pre><br><br>  Launch Logstash: <br> <code>java -jar logstash-1.1.9-monolithic.jar agent -f ./habr.conf</code> <br> <br>  Verify that Logstash is running: <br>  # netstat -nat | grep 11111 <br>  If port 11111 is present, then Logstash is ready to receive logs. <br><br>  In the new terminal window we write: <br> <code>echo "Logs are cool!" | nc localhost 11111</code> <br> <br>  See the result in the window where Logstash is running.  If a secret message appeared there, then everything works. <br><br>  Ps The latest version of Logstash can be downloaded <a href="http://logstash.net/">from here</a> . <br><br>  Thanks for attention, </div><p>Source: <a href="https://habr.com/ru/post/165059/">https://habr.com/ru/post/165059/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../165043/index.html">Multiklet: The first practical tests and performance</a></li>
<li><a href="../165047/index.html">Where are you, the dream player for Android?</a></li>
<li><a href="../165049/index.html">in. Part 1: Internet fantasies of the future</a></li>
<li><a href="../165053/index.html">PC "Microsha" - one of the clones of "Radio-86RK"</a></li>
<li><a href="../165057/index.html">NVIDIA introduced its own gaming console SHIELD</a></li>
<li><a href="../165061/index.html">What can be difficult in calculating the hypotenuse?</a></li>
<li><a href="../165063/index.html">A PC created with Valve will be shown this week.</a></li>
<li><a href="../165067/index.html">Prediction of information epidemics by analyzing the social graph</a></li>
<li><a href="../165069/index.html">PHP class for convenient and safe work with MySQL</a></li>
<li><a href="../165071/index.html">We write the application for Android on Ruby (Ruboto)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>