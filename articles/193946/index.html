<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Again the XMP tags are individuals. Everything is bad, but it is fixable</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On Habr√©, the question of storing meta tags of recognized faces for a photo archive has already been raised several times; unfortunately, none of the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Again the XMP tags are individuals. Everything is bad, but it is fixable</h1><div class="post__text post__text-html js-mediator-article">  On Habr√©, the question of storing meta tags of recognized faces for a photo archive has already been raised several times; unfortunately, none of the above recipes turned out to be sufficiently working, and googling did not help, so I had to write my bicycle. <br><br>  Original articles: <a href="http://habrahabr.ru/post/165899/">one</a> and <a href="http://habrahabr.ru/post/172217/">two</a> . <br><br>  Everything is written there well and correctly, but there is still no happiness. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Picture to attract attention: <br><img src="https://habrastorage.org/storage2/ff3/02f/f4f/ff302ff4f68933a037b1137bf3a3b664.jpg"><br><br>  The task is simple - to mark people in the photo and be able to use it in the maximum number of places in any way convenient for me. <br><br>  I will mark people in picas, because they are linked to Google contacts, cross-platform, auto-detecting, storing tags inside a file (with nuances).  But I want to watch and use these tags everywhere in gallery3 because she knows how, in the lightroom because I use it as a cataloguer, in microsoft explorer because I have it in Microsoft Live Photo Gallery, just because it is the second popular format and why not use it too. <br><br>  Who wants to be confused too - welcome under kat. <br><a name="habracut"></a><br>  Problem number 1 where picas stores face information? <br>  Three options: <br><ul><li>  Or it is a bunch of two files: contacts.xml in the user profile and picasa.ini in the folder with photos.  This option is correct if you tagged faces in a picas version less than 3.9 and in the last picas, about with the ‚ÄúStore name tags in photo‚Äù checkbox turned off. </li><li>  The second option is to store faces in XMP-mwg-rs if you used only the latest picas and turned on the ‚ÄúStore name tags in photo‚Äù checkbox before you started marking faces, you need to remember that it is turned on by default. </li><li>  And finally, the third option, the most common: the faces are stored here and there, and what to do about it is generally incomprehensible. </li></ul><br><br>  For obvious reasons, the second option is the most optimal, but as it turned out, not everything is so simple, picas can‚Äôt just be said: ‚ÄúWrite all the tags in the files‚Äù Google guzzled to put such a button.  There are several options to solve this problem, both purely picas and using external utilities. <br><br>  <a href="https://code.google.com/p/picface/">picface</a> <br>  almost works, has recently been updated, but I have repeatedly crashed before completing what I have started, and since I have about 60K photos in the archive, it all takes a long time and is dreary. <br><br>  most popular <a href="http://www.anvo-it.de/wiki/avpicfacexmptagger:main">avpicfacexmptagger</a> <br>  He knows how to do almost everything that is necessary, but rather one-sided, has not been updated for a long time, came up with his own scheme for xmp, you can think of the existing ones.  But in principle, to bring the archive to state two can be used. <br><br>  I used the recommendation from Google itself, you only need picas version 3.9 with the ‚ÄúStore name tags in photo‚Äù checkbox turned on.  To ensure that all persons are recorded in xmp, you must go through all the people and rename to something, and then rename it back.  Quick, easy, work.  On the people tab, double-click on the first name and rename it to 'x', then double-click on 'x' and rename it back.  All I have ottegirovano hundred and fifty people and it took just a couple of minutes.  After that, Picas is better not to close right away, but to give her some time to write data to disk, because she does not show any progress. <br><br>  The next step is to extract the names recorded by picas in xmp-mwg-rs in the RegionName tag and write it in the PersonInImage and RegionPersonDisplayName tags after that we can use these tags when searching in all catalogers and even microsoft explorer will show us the names of people in the photo .  The easiest way to do this is with exiftool, which can be downloaded <a href="">here.</a> <br><br><pre><code class="bash hljs">exiftool -RegionName&gt;PersonInImage photo.jpg exiftool -RegionName&gt;RegionPersonDisplayName photo.jpg</code> </pre> <br><br>  after that we see information about people in a variety of third-party programs <br><img src="https://habrastorage.org/storage2/e21/16e/f87/e2116ef877b9862dda2f1a101e265e02.jpg"><br><br>  It is also possible to convert information about the position of persons on the frame from standard picas to standard from microsoftware, they differ not only in names, but even in the way squares are considered, some set the length and height from the upper left corner of the square, and others from the center.  For conversion, we need a config for exiftool. <br><br>  ExifTool_config_convert_regions <br><pre> <code class="perl hljs">%Image::ExifTool::UserDefined = ( <span class="hljs-string"><span class="hljs-string">'Image::ExifTool::Composite'</span></span> =&gt; { <span class="hljs-string"><span class="hljs-string">MyRegion =&gt;</span></span> { <span class="hljs-string"><span class="hljs-string">Require =&gt;</span></span> { <span class="hljs-string"><span class="hljs-string">0 =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'RegionInfoMP'</span></span>, <span class="hljs-string"><span class="hljs-string">1 =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'ImageWidth'</span></span>, <span class="hljs-string"><span class="hljs-string">2 =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'ImageHeight'</span></span>, }, <span class="hljs-string"><span class="hljs-string">ValueConv =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">q{ my ($rgn, @newRgns); foreach $rgn (</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">@{$val[</span></span><span class="hljs-number"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-number">0</span></span></span></span><span class="hljs-string"><span class="hljs-subst">]</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">{Regions}</span></span></span></span><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="hljs-string">) { my @rect = split /\s*,\s*/, $$rgn{Rectangle}</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> %newRgn = ( <span class="hljs-string"><span class="hljs-string">Area =&gt;</span></span> { <span class="hljs-string"><span class="hljs-string">X =&gt;</span></span> $rect[<span class="hljs-number"><span class="hljs-number">0</span></span>] + $rect[<span class="hljs-number"><span class="hljs-number">2</span></span>]/<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">Y =&gt;</span></span> $rect[<span class="hljs-number"><span class="hljs-number">1</span></span>] + $rect[<span class="hljs-number"><span class="hljs-number">3</span></span>]/<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">W =&gt;</span></span> $rect[<span class="hljs-number"><span class="hljs-number">2</span></span>], <span class="hljs-string"><span class="hljs-string">H =&gt;</span></span> $rect[<span class="hljs-number"><span class="hljs-number">3</span></span>], <span class="hljs-string"><span class="hljs-string">Unit =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'normalized'</span></span>, }, <span class="hljs-string"><span class="hljs-string">Name =&gt;</span></span> $$rgn<span class="hljs-string"><span class="hljs-string">{PersonDisplayName}</span></span>, <span class="hljs-string"><span class="hljs-string">Type =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'Face'</span></span>, ); <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> @newRgns, \%newRgn; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-string"><span class="hljs-string">AppliedToDimensions =&gt;</span></span> { <span class="hljs-string"><span class="hljs-string">W =&gt;</span></span> $val[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-string"><span class="hljs-string">H =&gt;</span></span> $val[<span class="hljs-number"><span class="hljs-number">2</span></span>], <span class="hljs-string"><span class="hljs-string">Unit =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'pixel'</span></span> }, <span class="hljs-string"><span class="hljs-string">RegionList =&gt;</span></span> \@newRgns, }; }, }, <span class="hljs-string"><span class="hljs-string">MyRegionMP =&gt;</span></span> { <span class="hljs-string"><span class="hljs-string">Require =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'RegionInfo'</span></span>, <span class="hljs-string"><span class="hljs-string">ValueConv =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">q{ my ($rgn, @newRgns); foreach $rgn (</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">@{$val[</span></span><span class="hljs-number"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-number">0</span></span></span></span><span class="hljs-string"><span class="hljs-subst">]</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">{RegionList}</span></span></span></span><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="hljs-string">) { my @rect = </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">@{$$rgn</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">{Area}</span></span></span></span><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="hljs-string">{'X','Y','W','H'}</span></span>; $rect[<span class="hljs-number"><span class="hljs-number">0</span></span>] -= $rect[<span class="hljs-number"><span class="hljs-number">2</span></span>]/<span class="hljs-number"><span class="hljs-number">2</span></span>; $rect[<span class="hljs-number"><span class="hljs-number">1</span></span>] -= $rect[<span class="hljs-number"><span class="hljs-number">3</span></span>]/<span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> @newRgns, { <span class="hljs-string"><span class="hljs-string">PersonDisplayName =&gt;</span></span> $$rgn<span class="hljs-string"><span class="hljs-string">{Name}</span></span>, <span class="hljs-string"><span class="hljs-string">Rectangle =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(<span class="hljs-string"><span class="hljs-string">', '</span></span>, @rect), }; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-string"><span class="hljs-string">Regions =&gt;</span></span> \@newRgns }; }, }, }, ); <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">#end</span></span></code> </pre><br><br>  The config is found on the Internet and it allows you to convert the regions in both directions, but we need only one.  To do this, run exiftool with the following parameters: <br><br><pre> <code class="bash hljs">exiftool -config ExifTool_config_convert_regions <span class="hljs-string"><span class="hljs-string">"-regioninfomp\&lt;MyRegionMP"</span></span><span class="hljs-string"><span class="hljs-string">' photo.jpg</span></span></code> </pre><br><br>  After that, the face is correctly displayed in Microsoft Live Photo Gallery and other software that adheres to the same scheme. <br><img src="http://habrastorage.org/storage2/ab6/be8/3da/ab6be83da0d60fafd675dff56308fdd5.jpg"><br><br>  It is almost a profit, but I would also automate this business for all the necessary photos, and also write the names into the keywords: the tags Subject and HierarchialSuject yes, here, too, was not without double formats.  For these purposes, I wrote a plugin for lightroom, it gives you the opportunity to run it only on the right photos, and add keywords without fear of duplicating them or erasing existing ones, well, just because I use the lightroom as the cataloger of the entire archive. <br><br>  For the code, please do not beat, but rather tell me how to improve it, this is my first plugin for LR and generally the first time I saw lua. <br><br>  There are only two files in the plugin. <br><br>  Info.lua <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { LrSdkVersion = <span class="hljs-number"><span class="hljs-number">3.0</span></span>, LrSdkMinimumVersion = <span class="hljs-number"><span class="hljs-number">1.3</span></span>, <span class="hljs-comment"><span class="hljs-comment">-- minimum SDK version required by this plug-in LrToolkitIdentifier = 'com.adobe.lightroom.sdk.helloworld', LrPluginName = LOC "$$$/PicasaFaceToTag/PluginName=Picasa Faces to Tags", -- Add the menu item to the Library menu. LrLibraryMenuItems = { { title = "Write Picasa Faces to Tags", file = "PersonInImage.lua"}, }, VERSION = { major=4, minor=1, revision=0, build=831116, }, }</span></span></code> </pre><br><br>  PersonInImage.lua <br><br><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">--[[---------------------------------------------------------------------------- ------------------------------------------------------------------------------]]</span></span> <span class="hljs-comment"><span class="hljs-comment">-- Access the Lightroom SDK namespaces. local LrTasks = import 'LrTasks' local LrProgressScope = import 'LrProgressScope' local LrApplication = import 'LrApplication' local catalog = LrApplication.activeCatalog() local photos = catalog:getTargetPhotos() local LrPathUtils = import 'LrPathUtils' local logger = import 'LrLogger'("lr") logger:enable('print') local function faceToTag() --[[Convert faces from picasa xmp tag to microsoft xmp ]] exeFile = LrPathUtils.child( _PLUGIN.path, "exiftool.exe" ) cfgFile = LrPathUtils.child( _PLUGIN.path, "ExifTool_config_convert_regions" ) redirect = LrPathUtils.getStandardFilePath('temp') .. "exiftool.stdout" local total = ( # catalog:getTargetPhotos() ) local exifArgs = {"-b -RegionName \&gt;" .. redirect, --'-overwrite_original "-RegionName\&gt;PersonInImage"', '-overwrite_original "-RegionName\&gt;RegionPersonDisplayName"', '-config '..cfgFile..' -overwrite_original "-regioninfomp\&lt;MyRegionMP"'} local progressScope = LrProgressScope{ title = "Write Picasa Faces to Tags", caption = "Updateting " .. total .. " photos." , } progressScope:setCancelable( true ) local parrent catalog:withWriteAccessDo("Create parrent keyword", function () parrent = catalog:createKeyword("names", {}, false, nil, true) --logger:debug("parrent keyword created: " .. tostring(parrent)) end) for completed, photo in ipairs(photos) do progressScope:setPortionComplete(completed, total) progressScope:setCaption("Updated " .. tostring(completed) .. " of " .. tostring(total) .. " photos") if progressScope:isCanceled() then progressScope:done() break end local path = photo:getRawMetadata('path') logger:debug(path) -- write filename to debug log for i,exifArg in ipairs(exifArgs) do local exeCmd ='"' .. exeFile.." "..exifArg.." "..path .. '"' local status = LrTasks.execute(exeCmd) if io.open(redirect):read() == nil then break end --check is there any names in the file --logger:debug(exeCmd) if status ~= 0 then logger:debug("Error "..exeCmd) progressScope:done() end end for name in io.lines(redirect) do if name ~= nil then -- check is there any pleople on photo logger:debug(name) catalog:withWriteAccessDo("Adding name keywords", function () local keyword = catalog:createKeyword(name, {}, true, parrent, true) logger:debug("keyword created: " .. tostring(keyword)) photo:addKeyword(keyword) --photo:setRawMetadata('personShown', keyword) --doesn't work logger:debug("keyword added: " .. name) end) end end end progressScope:done() end LrTasks.startAsyncTask(faceToTag)</span></span></code> </pre><br><br>  All nominal tags are stored in a hierarchical structure inside the tag "names", programs that do not work with the xmp lightroom scheme will see them just a flat list + tags "names".  For the plugin to work in the folder must put exiftool.exe and its config.  All in a crowd can be downloaded from <a href="https://github.com/kefiiir/Write-Picasa-Faces-to-Tags">github</a> <br><br>  The plugin works, but it has flaws: <br><ul><li>  It is not possible to write PersonInImage, if exiftool is overwritten by the lightroom, and it is impossible to write it directly via the SDK for unknown reasons.  photo: setRawMetadata ('personShown', keyword) crashes.  You can break it into two different buttons and re-read the metadata manually, but this is also ugly. </li><li>  about 1 second is slow in the photo, with a larger archive it is a problem, perhaps if you rewrite through <a href="http://cookbooks.adobe.com/post_ExifTool___making_it_scream_-19501.html">cookbooks.adobe.com/post_ExifTool___making_it_scream_-19501.html</a> will be faster. </li><li>  Since the plugin writes simultaneously both through exiftool and through the lightroom SDK, at the end of the work, metadata conflicts regularly arise, and they must be manually saved Ctrl + s.  If someone knows how to make the lightroom write and read the metadata programmatically - unsubscribe.  So far I have come up with an option only with the emulation of lrBind, but this is not beautiful. </li><li>  This is not a problem of the plug-in, the whole system, if the rav is run, and after that it is exported, the information about the faces is lost, but the tags are saved, and this is already a profit. </li></ul><br><br>  Shl.  I was able to find two plugins that do _ almost the same thing, they take people from picas and write them in tags, but they all take people only from picasa.ini and do not work with people recorded in XMP. </div><p>Source: <a href="https://habr.com/ru/post/193946/">https://habr.com/ru/post/193946/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../193932/index.html">Customer advice to the tenderer</a></li>
<li><a href="../193936/index.html">Normal numbers: educational program</a></li>
<li><a href="../193938/index.html">GifCam - animated screenshot in two clicks</a></li>
<li><a href="../193942/index.html">Couchbase usage example in conjunction with PHP</a></li>
<li><a href="../193944/index.html">The story of a widget</a></li>
<li><a href="../193950/index.html">Wonderful speech by a real programmer</a></li>
<li><a href="../193954/index.html">Hardware Trojans: Now with Dope</a></li>
<li><a href="../193956/index.html">Microduino - what if everything is taken and divided?</a></li>
<li><a href="../193964/index.html">EVI technology for data center integration</a></li>
<li><a href="../193968/index.html">Sailfish OS has become fully compatible with the Android ecosystem</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>