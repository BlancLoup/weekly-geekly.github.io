<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>+ (AppStore *) Timera: application architecture and design features</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It is time to tell the public about our application timera. From today you can download it in the appstore. 
 Heximal (Pavel) , our ios developer, wil...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>+ (AppStore *) Timera: application architecture and design features</h1><div class="post__text post__text-html js-mediator-article"> It is time to tell the public about our application timera.  From today you can download it in the appstore. <br>  <a href="http://habrahabr.ru/users/heximal/">Heximal (Pavel)</a> , our ios developer, will tell about the <a href="http://habrahabr.ru/users/heximal/">timera</a> architecture, he has read only now, so I post his post. <br><br>  -&gt; In this post I will write about my modest participation in an interesting and promising project with a very original name Timera (from the words time and era).  By a lucky coincidence, I was in the active phase of searching for new development horizons at the very moment when the startup management was looking for a candidate for an iOS developer job.  The essence of the project is quite simple - its visual presentation and description of the architecture can be seen in the main illustration of the post, under the cut. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/a27/d98/054/a27d980546965e8b5738e7c2781ecaab.png" alt="image"><br><br>  The user is presented with a tool for creating a time tunnel, by combining a photograph from the past with a photograph taken by the camera of the smartphone.  I really liked the idea, and I immediately began to integrate into the development process, during which I had to face and overcome many difficult and interesting tasks. <br><br>  First of all, I would like to say a few words about the global architecture.  The central link is a server that performs the functions of back-end, front-end, data storage, web-api.  I will not describe the server stuffing in detail, since I have no relation to it.  I can only say that the production-version works on cloud hosting from Microsoft, and for the implementation of the server-side, the classic currently used stack is used: IIS + MSSQL + ASP.NET <br><br>  The front-end system (website <a href="http://www.timera.com/">www.timera.com</a> ) provides the user the ability to view photos of other users, as well as is equipped with the social network functionality: there is an opportunity to put likes, leave comments, there is a function Share on other social networks.  Also, the user of the website has the opportunity to upload an old photo.  What does this mean, and what is it for?  About this further. <br><br>  In addition to the website, an integral part of the architecture is the mobile application.  Today it is implemented for the two most popular platforms - this is of course Android and iOS.  The functionality of the application almost completely reproduces the functionality of the website, except for the only feature that the website cannot have.  It's about timeragraphy. <br><br>  The term ‚Äútimekeeping‚Äù is used to refer to the genre of historical collage.  He is not new.  After all, these works have long been walking on the Internet and many of them have become very viral.  One has only to recall the project ‚ÄúLink of Times‚Äù by Sergei Larenkov or Sean Claver with his slideshow about the 1906 San Francisco earthquake.  Actually, the name of the application was invented by David Webb, the founder of the project, simply by shortening the term ‚Äútimeragraphy‚Äù.  Now is the time to explain a little to the mechanics of timekeeping and how this process is implemented in the Timera mobile application. <br>  Suppose we have an old photograph of the Eiffel Tower.  I personally like the picture of 1889, on which the tower was built only up to the first level.  To create a timera-snapshot, you need to find the angle from which the old photograph was created, take a snapshot, ‚Äúovertake‚Äù to the computer, and in some graphic editor to make a combination using various filters and gradients.  The task, for example, is not for everyone.  But on the other hand, she is capable of every Timera user.  The whole process is as simple as possible and it may even seem quite funny (at least I personally consider it as such). <br><br>  The user opens a screen with a map on which blue pins show old photos available in one place or another.  Naturally, the application allows automatic location of the user and the display of objects around.  After the user has decided that he will timer-graph, the screen with the camera starts.  On this screen, there is simultaneously a live image from the camera and on top of it a translucent image of an old photograph (the degree of transparency can be changed).  The user can move the old photo across the screen, resize it using the capabilities of the touch-screen technology, thus making the primary aim.  After the snapshot is taken, a more accurate alignment screen opens. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/246/735/3f4/2467353f4571af308f85f5e6fd89fcda.jpg" alt="image"><img src="https://habrastorage.org/getpro/habr/post_images/32e/b05/cec/32eb05cec8450ac2051b4b5b5f28aa56.png" alt="image"><br><br>  The most interesting begins on the third screen, where you configure the time-tunnel (time-tunnel).  Here, a toolbar is available to the user with various tools, such as: <br>  - transparency and sharpness sliders of the time-tunnel border (transparency and softness) <br>  - turn of the time tunnel around the axis <br>  - a function called swap (swap old and new photos, that is, the old one goes to the background, and the new one goes to the front one) <br>  - change the shape of the time-tunnel: elliptical or rectangular <br>  - crop <br><br>  In all modes, it is possible to change the size and position of the time tunnel using on-screen gestures. <br><br>  It would seem sparsely?  Perhaps, but even with this set of tools very good compositions are created.  And plus to everything, it is planned to expand this functionality, there are enough ideas in this regard. <br>  After editing, the resulting image can be uploaded to the server and / or shared on the social network.  When downloading to the server, you can set the privacy flag if you do not want to make your work public. <br>  Here I would like to tell you a few nuances about the difficulties that have arisen in creating the main use-case (timer-graphing). <br><br>  First, an unpleasant surprise was the presence of two values ‚Äã‚Äãof type UIDeviceOrientation.  In the past, I have worked with the iOS accelerometer and the device orientation concept, and then the number of possible device orientations was four: UIDeviceOrientationPortrait, UIDeviceOrientationPortraitUpsideDown, UIDeviceOrientationLandscapeLeft, UIDeviceOrientationLandscapeRight.  On the screen of photographing, the orientation of the device is very critical, since the overlay image must be oriented accordingly, so that the old photo does not turn upside-down, or lying on its side.  As it turned out, there are two more device positions: UIDeviceOrientationFaceUp and UIDeviceOrientationFaceDown.  A lot of man-hours left to realize this fact and recognize in it the reason for the inappropriate behavior of the program. <br><br>  Another interesting point related to the photography screen was a problem with the volume buttons on the side of the device: in the standard Camera application, pressing the volume buttons triggers the shutter, which is very convenient. <br>  Next, the case of technology.  For some reason, on our screen of photographing these buttons did not cause any reaction, no matter what tricks we had made, even compulsory ‚Äúlistening‚Äù of notifications from the media system did not help. <br>  This is done something like this.  The ViewController is subscribed to receive volume change notifications. <br><br> <code>[[NSNotificationCenter defaultCenter] <br> addObserver:self <br> selector:@selector(volumeChanged:) <br> name:@"AVSystemController_SystemVolumeDidChangeNotification" <br> object:nil];</code> <br> <br>  As it turned out later, this is due to the fact that we use overlayView, in which the user can change the transparency of the old photo, and generally see it.  The same exact behavior has been found in other popular photo apps.  At the same time, applications that use standard controls for photographing do not suffer from a lack of response to pressing the volume buttons. <br>  The greatest development time spent on the implementation of the screen with the effects of time-tunnel.  The time-tunnel algorithm is based on the method of subtracting a gradient stencil from the original image: the darker the image pixel on the mask, the smaller the transparency value of the same-pixel of the masked image.  All magic is implemented using the standard CoreGraphics framework and the CGImageCreateWithMask function, which receives the above two images as CGImageRef objects. <br><br>  The formation of the timeragraphy occurs in three stages.  We agree to use the designation ‚ÄúImage A‚Äù for the image in the background, and ‚ÄúImage B‚Äù for the image in the foreground. <br><br>  1. A rectangular mask with gradient edges is drawn and applied to Image B. This was done so that the time tunnel did not abruptly break anywhere.  It should be mentioned that the user has the ability to rotate the ‚ÄúImage B‚Äù, for example, if the horizon is littered.  Thus, the mask is formed on the basis of the following parameters: the size of the ‚ÄúImage B‚Äù, the angle of rotation of the ‚ÄúImage B‚Äù, the amount of blurring of the border (adjusted by the slider).  The resulting mask is subtracted from the "Image B", in the end it turns out "Image B" with blurred edges. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8bd/25e/e42/8bd25ee42f164a98a3b37211c0cf7c46.jpg" alt="image"><br><br>  Pretty much had to tinker with the turn of the gradient, which was carried out with the help of the same CoreGraphics through the transformation of the coordinate matrix of the graphics context: <br><br> <code>CGFloat angleInRadians = angle * (M_PI / 180); <br> <br> CGContextRotateCTM(bmContext, angleInRadians); <br></code> <br><br>  At the same time, there was an unexpected effect, as it turned out later, due to the fact that by default the reversal is performed around the upper left corner of the image. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f01/85a/cd2/f0185acd243e6027e6df45f6645ebfea.png" alt="image"><br><br>  I even asked a question on stackoverflow, after unsuccessful searches for hints.  However, having received no answer, I found a solution empirically, and left an answer to my own question (http://stackoverflow.com/questions/19219855/uiimageview-get-transformed-uiimage) <br><br>  Another surprise was the lack of a ready-made way to draw a rectangular gradient for the mask (such as in the illustration).  CoreGraphics has a solution for an elliptical solution, but for rectangular, with rounded edges, it was necessary to invent it (http://stackoverflow.com/questions/18918382/coregraphics-rectangle-gradient - one more answer). <br><br>  2. A gradient mask is drawn and applied to the ‚ÄúImage B‚Äù obtained as a result of processing in the first stage.  Unlike the first stage, the user can specify the type of mask: rectangular or elliptical, plus the same dimensions of the mask, the rotation angle, the degree of blurring of the border.  The size of the mask and the position of the user changes the fingers on the screen.  Thus, an image of the time tunnel is formed. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f48/6a3/ef6/f486a3ef67ecf4e76ab9a94ac82374ca.jpg" alt="image"><br><br>  3. At the last stage, the resulting image of the time tunnel is drawn in the required coordinates on ‚ÄúImage A‚Äù <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5fd/819/aad/5fd819aad026e0da2eb12db005a4eb4e.jpg" alt="image"><br><br>  I must note that CoreGraphics is far from the most productive thing in the world, and this is especially noticeable on older devices, starting with the iPhone 4 and below.  In this regard, a number of measures have been taken to optimize the time-memory functional.  But about this and many other things in the second part. <br><br>  I hope I interested you.  <a href="https://itunes.apple.com/app/timera/id786222310%3Fmt%3D8">Download the app</a> , rate and write feedback. <br>  If you like, do not give up the invite.  I will respond to comments and publish from my account. <br>  Waiting for questions and comments. </div><p>Source: <a href="https://habr.com/ru/post/212497/">https://habr.com/ru/post/212497/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../212483/index.html">The history of smart watches</a></li>
<li><a href="../212487/index.html">Facebook is testing a water taxi to transport employees from San Francisco</a></li>
<li><a href="../212489/index.html">An important step has been taken towards laser fusion.</a></li>
<li><a href="../212491/index.html">TestCafe: A brief history of finding harmony in functional testing (with pictures)</a></li>
<li><a href="../212495/index.html">Samsung Galaxy S5 and Apple iPhone 6</a></li>
<li><a href="../212499/index.html">Brief instruction on working with a web-designer (for a project manager)</a></li>
<li><a href="../212501/index.html">Highscreen Boost 2 SE went on sale: details plus photo and first-hand opinion</a></li>
<li><a href="../212503/index.html">Creator Mt. Gox and eDonkey are working on a secret Bitcoin project</a></li>
<li><a href="../212507/index.html">Why language Verilog microcontroller programmer</a></li>
<li><a href="../212509/index.html">ASUS Transformer Book Trio: tested in humans</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>