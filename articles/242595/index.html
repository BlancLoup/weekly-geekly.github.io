<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Megatons of waste paper with a flick of the wrist</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. In this article we will tell about how print is arranged in our platform . 

 A bit of history 
 For understanding, it will be useful to tel...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Megatons of waste paper with a flick of the wrist</h1><div class="post__text post__text-html js-mediator-article">  Good day.  In this article we will tell about how print is arranged in <a href="http://www.ultimabusinessware.com/">our platform</a> . <br><br><h4>  A bit of history </h4><br>  For understanding, it will be useful to tell about the history of this function.  Initially, the decision that was called "in the forehead."  A screw spooler was used and printing was done through standard procedures.  Actually, this decision did not last long, exactly until the moment when it was necessary to implement printing from the application server, and not from the client application. <br>  Just in case, I will give the scheme from the first article: <br><br><img src="https://habrastorage.org/files/382/478/c87/382478c8771846f19a2b85f74decb20f.gif"><br><a name="habracut"></a><br>  As you can see, the application servers were in the data center.  And the offices were connected to a single network.  As soon as we implemented printing from the application server there were several problems: <br><ol><li>  Loading of communication channels has grown very significantly.  In some offices up to 100% </li><li>  The application server started to hang. </li><li>  Sometimes a piece of paper sent to print was simply not printed. </li><li>  System performance has dropped (users started complaining that they had to wait for the completion of operations for several minutes) </li><li>  Reversing the order of documents when printing </li></ol><br>  In fact, the investigation quickly showed that the reasons for the high load on the channels, as everyone probably guessed, were the transfer of the rendered printed form directly to the printer. <br>  I had to tinker with cause number 2, but it turned out that people also write printer drivers!  It was they (the drivers) that hung up under high load and pulled the entire application server behind them.  It was possible to remove it from the catatonic state only by its restart. <br>  Reasons 3 and 5 were found in the print spooler Windows. <br>  We managed to figure out problem 4 by carefully examining the expectations of the sessions.  The reasons, as it now seems, lie on the surface, but then we were young ... It turned out that because of printing from the application server, the access time to the printer had greatly increased - now we were printing via Internet channels, and not over the local network.  All this time, the transaction continued to block the objects of the system, which came across other server calls and gave us funny moments.  It would be possible, of course, to fix the transaction before printing off, but this is wrong from our point of view.  We apologize, but about this in another article about transaction management. <br>  According to acquaintances, I know that such problems were not only with us. <br>  Then we decided to do what is shown on the diagram as a print server. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Printed forms </h4><br>  We need to make a digression and tell us what we actually typed. <br>  For printing in the platform implemented such a thing as "Printing forms".  Sorry, we could not think of a more original name.  A printed form is a template for a report and a script that prepares a data plate based on some algorithm specified by the developer.  Yes, sometimes there are cases when it cannot be formulated as a single query.  It is necessary to clarify - not as a table in a database, but as an object of the ‚Äútype‚Äù DataTable.  In quotes - because it uses its own class for storing tables, less memory-consuming and more compact serializable. <br>  If we talk about the details, we use a report from DevExpress XtraReports. <br>  Both the script and the report template are available for editing at run-time through the GUI of the main client application. <br>  The script, I remind you, is always executed on the application server.  The overwhelming part of the papers printed by the trade organization are all kinds of invoices, invoices, invoices, sales receipts, set sheets in the warehouse, and so on and so forth.  At the same time, the pattern does not change, only the data changes! <br>  Thus, the first thing we did was to submit to the print server the task of rendering and sending a rendered form to the printer.  The application server only prepared the data and sent it to the print server.  Saving on traffic - from (on average) 2MB per document up to 40Kb, the print server caches templates locally. <br><br><h4>  Device and features </h4><br>  By consistently increasing the functionality of the print server, we were able to get rid of these problems. <br><br>  So, what we have now. <br><br><h5>  Synchronous and asynchronous printing. </h5><br>  As a rule, there is no need for time-guaranteed delivery of the printing form to the printer (i.e. print out right now).  And, on the other hand, the script that sends the document to print has already made some changes in the database and it is likely that another transaction might run into these locks.  In this case, you need to fix the changes as soon as possible.  For this, the application server can accept a print job to process it asynchronously.  In a separate transaction, run the data preparation script and send it to the appropriate print server.  Synchronous printing implies that the data preparation script will be executed in the current transaction. <br>  Illustrating scheme: <br><br><img src="https://habrastorage.org/files/29f/44c/917/29f44c9172ea4020a73948eae1c9c0dc.png"><br><br>  The PrintBuilder and PrintSender procedures, running in separate transactions (and streams) within the application server, process the queues of incoming jobs.  Technically, these are threads within the application server that perform an infinite loop.  The number of these threads is configured by the administrator depending on the load.  PrintBuilder processes the jobs received asynchronously, runs the scripts to prepare the printed form data and sends them to the next queue to PrintSender.  Synchronous print jobs are also included in the same queue. <br>  In turn, PrintSender pulls jobs from the queue and sends them to the print server. <br>  As you can see, with this approach, the blocking time is drastically reduced in Transaction 1, and the shorter the blocking time, the higher the number of transactions that the server can handle! <br><br><h5>  Batch printing </h5><br>  Guaranteed printing on the printer documents in a given sequence.  Regardless of other tasks, all documents in the package will be printed inseparably.  We needed the opportunity when implementing the printing of documents for drivers ( <a href="http://www.ultimaecommerceerp.com/results/just_in_time/">an example of</a> application in the practice of real business).  This is a task when you need to print the Itinerary (a document with a list of all addresses and a map) and then accounting documents for each order.  Everything was good until the drivers were over 100 and the Windows spooler did not get confused.  The situation worsened if someone else tried to print other documents on the same printer.  These documents for some reason were sometimes among the documents for the driver.  I had to abandon the spooler and make my own. <br><br><h5>  Guaranteed delivery </h5><br>  The document sent to print will be guaranteed to be sent to the printer.  If the printer is unavailable, or the office with the printer server is unavailable, the system will wait until the connection is restored and send SMS and email to administrators. <br><br>  Here is a diagram illustrating the print server operation: <br><br><img src="https://habrastorage.org/files/3a4/dd4/ab5/3a4dd4ab561d42d1874e607bdb9234d6.png"><br><br>  In this diagram, PrintWorker is a separate process launched for each connected printer.  If the printer driver freezes, the process stops responding, and when the timeout expires, the print server kills the process and restarts. <br><br><h5>  Print accounting </h5><br>  A side effect is taking into account who, when, what, and how much printed, well, users no longer have direct access to printers, which greatly reduced paper consumption for printing dissertations.  Whether this is a cool thing - decide for yourself. <br><br><h5>  Printer virtualization </h5><br>  Printers that can be printed from the system are listed in the system settings and are connected only to the print server.  This greatly simplifies the work of administrators - no need to connect the printer to each node of the cluster of application servers, and on each client machine, install drivers there and do other shamanism.  In addition, listing the printers in the system makes it easy to implement a UI to select a printer for regular users.  For example on which printer to print paper in stock. <br><br><img src="https://habrastorage.org/files/cb8/ae6/847/cb8ae68478094fc191bfe704f68c8896.png"><br><br>  Thus, each printer has its own identifier, which is saved when the printer is changed, and the code for printing looks like this: <br><br><img src="https://habrastorage.org/files/459/c70/7b4/459c707b49a44a21b00a77d4ef690448.png"><br><br>  In this example, the printout for the specified document is printed to the printer specified in the employee. <br><br><h4>  RDBMS Queues </h4><br>  They promised to tell you about the queue.  We tell. <br>  In the print subsystem, as can be seen, the queue mechanism is actively used.  Fortunately, in Oracle Database it is possible to organize them within the database, without resorting to special individual services.  They are implemented quite simply using the design <pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> .. <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">skip</span></span> <span class="hljs-keyword"><span class="hljs-keyword">locked</span></span></code> </pre>  .  Execution of such a query returns only rows not blocked by other transactions.  Some inconvenience is caused by the fact that it cannot be used together with rownum, i.e.  you can only get all the lines.  However, there is a workaround - all this is true only for executing the request from the client (in relation to the database) application!  So, you can write a procedure: <br><br><img src="https://habrastorage.org/files/d82/060/d4c/d82060d4c7e84d1db46680713f0417be.png"><br><br>  The main thing in this procedure is to declare the cursor and pull out one record.  Thus, without unnecessary locks and very conveniently, you can organize parallel processing of various queues. <br><br>  For example, the problem of recalculating prices for 400,000 goods is solved in the same way. <br><br>  Anticipating the question of why Oracle Advanced Queuing was not used, we answer: <br><br><ol><li>  We use Managed ODP.NET, but it still does not support AQ. </li><li>  Using your queues allows you to store data in a structured form, and implement built-in mechanisms for managing these queues: <br><img src="https://habrastorage.org/files/03b/5b8/eb7/03b5b8eb70ae40b99e309d32e0a0b785.png"></li></ol><br><br><h4>  Conclusion </h4><br>  Hopefully, we managed to roughly open up the implementation of the printing subsystem in our platform and push on ideas for solving problems in your applications.  Next, we will try to uncover the topic of managing transactions and related problems. </div><p>Source: <a href="https://habr.com/ru/post/242595/">https://habr.com/ru/post/242595/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../242585/index.html">Features of the Android TV box with multicast broadcasting</a></li>
<li><a href="../242587/index.html">New version of Veeam Backup & Replication v8 (paid and free editions)</a></li>
<li><a href="../242589/index.html">4SICS Conference: Vulnerable Collider, Havex Trojan, and Other ‚ÄúRussian Threats‚Äù</a></li>
<li><a href="../242591/index.html">Stun gun in section: 3.000.000 volts for educational purposes</a></li>
<li><a href="../242593/index.html">Designing a news feed in social networks</a></li>
<li><a href="../242601/index.html">Immersion cooling, underwater servers: Immersion-2 for 3M ‚Ñ¢ Novec ‚Ñ¢ delivers magical results, put into practice in Hong Kong</a></li>
<li><a href="../242603/index.html">Cryptographic solutions. From the cloud signature to the trusted environment</a></li>
<li><a href="../242609/index.html">Expressive javascript: search and error handling</a></li>
<li><a href="../242611/index.html">Career project manager vs organization</a></li>
<li><a href="../242613/index.html">Write clean code with Reactive Extensions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>