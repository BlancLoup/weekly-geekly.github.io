<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write our own miniature Redis server in Python</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The other day I got the idea that it would be great to write a simple Redis-like database server. Although I have significant experience with WSGI app...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write our own miniature Redis server in Python</h1><div class="post__text post__text-html js-mediator-article"><p>  The other day I got the idea that it would be great to write a simple Redis-like database server.  Although I have significant experience with WSGI applications, the database server presented a new challenge and turned out to be good practice in the process of learning how to work with sockets in Python.  This article will tell you what I learned in the process of research. </p><a name="habracut"></a><br><p>  The goal of my project was to write a simple server that I could use with a task queue called <a href="https://github.com/coleifer/huey" rel="follow">huey</a> .  Huey uses Redis as the default storage engine for tracking queued jobs, execution results, and other things.  In the article, I reduced the source code of the project to do without water;  You can easily add the missing code yourself, but if you're interested, you can look at the <a href="https://github.com/coleifer/huey/blob/master/huey/contrib/simple.py" rel="nofollow">final result</a> . </p><br><p>  The server that we will create will be able to respond to the following commands: </p><br><ul><li><code>GET &lt;key&gt;</code> </li> <li> <code>SET &lt;key&gt; &lt;value&gt;</code> </li> <li> <code>DELETE &lt;key&gt;</code> </li> <li> <code>FLUSH</code> </li> <li> <code>MGET &lt;key1&gt; ... &lt;keyn&gt;</code> </li> <li> <code>MSET &lt;key1&gt; &lt;value1&gt; ... &lt;keyn&gt; &lt;valuen&gt;</code> </li> </ul><br><p>  We will also support the following data types: </p><br><ul><li>  Strings and binary data. </li><li>  Numbers </li><li>  Null </li><li>  Arrays (can be nested). </li><li>  Dictionaries (can be nested). </li><li>  Error messages </li></ul><br><p>  To process multiple clients asynchronously, we will use <a href="https://gevent.org/" rel="nofollow">gevent</a> , but you can also use the standard library's <a href="https://docs.python.org/3/library/socketserver.html" rel="nofollow">SocketServer</a> module using <code>ForkingMixin</code> or <code>ThreadingMixin</code> . </p><br><h3 id="skelet-proekta">  Skeleton project </h3><br><p>  Let's create a skeleton for our server.  We will need the server itself and the callback function that will be executed when a new client is connected.  In addition, you need some kind of logic to process the request from the client and send him a response. </p><br><p>  Let's start: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> gevent <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> socket <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> gevent.pool <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Pool <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> gevent.server <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> StreamServer <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> collections <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> namedtuple <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> io <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> BytesIO <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> socket <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> error <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> socket_error <span class="hljs-comment"><span class="hljs-comment"># We'll use exceptions to notify the connection-handling loop of problems. class CommandError(Exception): pass class Disconnect(Exception): pass Error = namedtuple('Error', ('message',)) class ProtocolHandler(object): def handle_request(self, socket_file): # Parse a request from the client into it's component parts. pass def write_response(self, socket_file, data): # Serialize the response data and send it to the client. pass class Server(object): def __init__(self, host='127.0.0.1', port=31337, max_clients=64): self._pool = Pool(max_clients) self._server = StreamServer( (host, port), self.connection_handler, spawn=self._pool) self._protocol = ProtocolHandler() self._kv = {} def connection_handler(self, conn, address): # Convert "conn" (a socket object) into a file-like object. socket_file = conn.makefile('rwb') # Process client requests until client disconnects. while True: try: data = self._protocol.handle_request(socket_file) except Disconnect: break try: resp = self.get_response(data) except CommandError as exc: resp = Error(exc.args[0]) self._protocol.write_response(socket_file, resp) def get_response(self, data): # Here we'll actually unpack the data sent by the client, execute the # command they specified, and pass back the return value. pass def run(self): self._server.serve_forever()</span></span></code> </pre> <br><p>  The code above is hopefully clear enough.  We divided the tasks so that the protocol processing is in a class of its own with two public methods: <code>handle_request</code> and <code>write_response</code> .  The server itself uses a protocol handler to unpack client requests and repeat server responses to the client server.  The <code>get_response()</code> method will be used to execute a command initiated by the client. </p><br><p>  Looking at the <code>connection_handler()</code> method code in more detail, you will see that we get a wrapper around a socket object, similar to a file.  This shell allows you to abstract from some of the features that are usually encountered when working with clean sockets.  The function enters an infinite loop, reads requests from the client, sends responses, and finally exits the loop when the client disconnects (marked by the <code>read()</code> method, which returns an empty string). </p><br><p>  We use typed exceptions to handle cases where clients are disabled and to notify users about error handling commands.  For example, if a user sends an <code>CommandError</code> request to the server, we throw a <code>CommandError</code> , which is serialized in response to an error and sent to the client. </p><br><p>  Before we go further, let's discuss how the client and server will interact. </p><br><h3 id="provodnoy-protokol-svyazi">  Wired communication protocol </h3><br><p>  The first challenge I faced was how to handle sending binary data over a wired communication protocol.  Most of the examples I found on the Internet were meaningless echo servers that converted a socket into a file-like object and simply called <code>readline()</code> .  If I wanted to store some pickle-data or strings with new strings, I would need to have some kind of serialization format. </p><br><p>  Having spent time trying to come up with something suitable, I decided to read the documentation for the Redis protocol, which turned out to be very simple to implement and has the added advantage of supporting several different types of data. </p><br><p>  The Redis protocol uses a client request / response communication pattern.  Responses from the server will use the first byte to indicate the type of data, and then the data completed by carriage return / line. </p><br><table><thead><tr><th>  Data type </th><th>  Prefix </th><th>  Structure </th><th>  Example </th></tr></thead><tbody><tr><td>  Simple string </td><td>  + </td><td>  + {string data} \ r \ n </td><td>  + this is a simple string \ r \ n </td></tr><tr><td>  Mistake </td><td>  - </td><td>  - {error message} \ r \ n </td><td>  -ERR unknown command "FLUHS" \ r \ n </td></tr><tr><td>  Whole </td><td>  : </td><td>  : {the number} \ r \ n </td><td>  : 1337 \ r \ n </td></tr><tr><td>  Binary data </td><td>  $ </td><td>  $ {number of bytes} \ r \ n {data} \ r \ n </td><td>  $ 6 \ r \ n <br>  foobar \ r \ n </td></tr><tr><td>  Array </td><td>  * </td><td>  * {number of elements} \ r \ n {0 or more of above} \ r \ n </td><td>  * 3 \ r \ n <br>  + a simple string element \ r \ n <br>  : 12345 \ r \ n <br>  $ 7 \ r \ n <br>  testing \ r \ n </td></tr><tr><td>  Vocabulary </td><td>  % </td><td>  % {number of keys} \ r \ n {0 or more of above} \ r \ n </td><td>  % 3 \ r \ n <br>  + key1 \ r \ n <br>  + value1 \ r \ n <br>  + key2 \ r \ n <br>  * 2 \ r \ n <br>  + value2-0 \ r \ n <br>  + value2-1 \ r \ n <br>  : 3 \ r \ n <br>  $ 7 \ r \ n <br>  testing \ r \ n </td></tr><tr><td>  Null </td><td>  $ </td><td>  $ -1 \ r \ n (string of length -1) </td><td>  $ -1 \ r \ n </td></tr></tbody></table><br><p>  Let's fill in the protocol handler class so that it implements the Redis protocol. </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProtocolHandler</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.handlers = { <span class="hljs-string"><span class="hljs-string">'+'</span></span>: self.handle_simple_string, <span class="hljs-string"><span class="hljs-string">'-'</span></span>: self.handle_error, <span class="hljs-string"><span class="hljs-string">':'</span></span>: self.handle_integer, <span class="hljs-string"><span class="hljs-string">'$'</span></span>: self.handle_string, <span class="hljs-string"><span class="hljs-string">'*'</span></span>: self.handle_array, <span class="hljs-string"><span class="hljs-string">'%'</span></span>: self.handle_dict} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle_request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, socket_file)</span></span></span><span class="hljs-function">:</span></span> first_byte = socket_file.read(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> first_byte: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> Disconnect() <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-comment"><span class="hljs-comment"># Delegate to the appropriate handler based on the first byte. return self.handlers[first_byte](socket_file) except KeyError: raise CommandError('bad request') def handle_simple_string(self, socket_file): return socket_file.readline().rstrip('\r\n') def handle_error(self, socket_file): return Error(socket_file.readline().rstrip('\r\n')) def handle_integer(self, socket_file): return int(socket_file.readline().rstrip('\r\n')) def handle_string(self, socket_file): # First read the length ($&lt;length&gt;\r\n). length = int(socket_file.readline().rstrip('\r\n')) if length == -1: return None # Special-case for NULLs. length += 2 # Include the trailing \r\n in count. return socket_file.read(length)[:-2] def handle_array(self, socket_file): num_elements = int(socket_file.readline().rstrip('\r\n')) return [self.handle_request(socket_file) for _ in range(num_elements)] def handle_dict(self, socket_file): num_items = int(socket_file.readline().rstrip('\r\n')) elements = [self.handle_request(socket_file) for _ in range(num_items * 2)] return dict(zip(elements[::2], elements[1::2]))</span></span></code> </pre> <br><p>  In the protocol serialization part, we will do the opposite: move the Python objects into their serialized copies! </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProtocolHandler</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># ... above methods omitted ... def write_response(self, socket_file, data): buf = BytesIO() self._write(buf, data) buf.seek(0) socket_file.write(buf.getvalue()) socket_file.flush() def _write(self, buf, data): if isinstance(data, str): data = data.encode('utf-8') if isinstance(data, bytes): buf.write('$%s\r\n%s\r\n' % (len(data), data)) elif isinstance(data, int): buf.write(':%s\r\n' % data) elif isinstance(data, Error): buf.write('-%s\r\n' % error.message) elif isinstance(data, (list, tuple)): buf.write('*%s\r\n' % len(data)) for item in data: self._write(buf, item) elif isinstance(data, dict): buf.write('%%%s\r\n' % len(data)) for key in data: self._write(buf, key) self._write(buf, data[key]) elif data is None: buf.write('$-1\r\n') else: raise CommandError('unrecognized type: %s' % type(data))</span></span></code> </pre> <br><p>  An additional benefit of processing the protocol in our own class is that we can reuse the <code>handle_request</code> and <code>write_response</code> to create the client library. </p><br><h3 id="realizaciya-kommand">  Command implementation </h3><br><p>  Now the <code>Server</code> class we are designing should have a <code>get_response()</code> method.  Commands will be considered sent by the client as simple strings or an array of command arguments, so the data parameter passed to <code>get_response()</code> will be either a byte string or a list.  To simplify processing, if the data turns out to be a simple string, we convert it into a list by dividing it into spaces. </p><br><p>  The first argument will be the name of the command with any additional arguments belonging to the specified command.  As with the mapping of the first byte with the handlers in <code>ProtocolHandler</code> , let's create a command mapping with callback functions in the <code>Server</code> class: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Server</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, host=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'127.0.0.1'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, port=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">31337</span></span></span></span><span class="hljs-function"><span class="hljs-params">, max_clients=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">64</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> self._pool = Pool(max_clients) self._server = StreamServer( (host, port), self.connection_handler, spawn=self._pool) self._protocol = ProtocolHandler() self._kv = {} self._commands = self.get_commands() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_commands</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-string"><span class="hljs-string">'GET'</span></span>: self.get, <span class="hljs-string"><span class="hljs-string">'SET'</span></span>: self.set, <span class="hljs-string"><span class="hljs-string">'DELETE'</span></span>: self.delete, <span class="hljs-string"><span class="hljs-string">'FLUSH'</span></span>: self.flush, <span class="hljs-string"><span class="hljs-string">'MGET'</span></span>: self.mget, <span class="hljs-string"><span class="hljs-string">'MSET'</span></span>: self.mset} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_response</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, data)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> isinstance(data, list): <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: data = data.split() <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> CommandError(<span class="hljs-string"><span class="hljs-string">'Request must be list or simple string.'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> data: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> CommandError(<span class="hljs-string"><span class="hljs-string">'Missing command'</span></span>) command = data[<span class="hljs-number"><span class="hljs-number">0</span></span>].upper() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> command <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self._commands: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> CommandError(<span class="hljs-string"><span class="hljs-string">'Unrecognized command: %s'</span></span> % command) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self._commands[command](*data[<span class="hljs-number"><span class="hljs-number">1</span></span>:])</code> </pre> <br><p>  Our server is almost ready!  We just need to implement six methods for the commands defined in the <code>get_commands()</code> method: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Server</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, key)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self._kv.get(key) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, key, value)</span></span></span><span class="hljs-function">:</span></span> self._kv[key] = value <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, key)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self._kv: <span class="hljs-keyword"><span class="hljs-keyword">del</span></span> self._kv[key] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flush</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> kvlen = len(self._kv) self._kv.clear() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> kvlen <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mget</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, *keys)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [self._kv.get(key) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> keys] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, *items)</span></span></span><span class="hljs-function">:</span></span> data = zip(items[::<span class="hljs-number"><span class="hljs-number">2</span></span>], items[<span class="hljs-number"><span class="hljs-number">1</span></span>::<span class="hljs-number"><span class="hljs-number">2</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> key, value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> data: self._kv[key] = value <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> len(data)</code> </pre> <br><p>  Here he is!  Now our server is ready to begin processing requests.  In the next section, we will use the client to communicate with the server. </p><br><h3 id="klient">  Customer </h3><br><p>  To interact with the server, let's reuse the <code>ProtocolHandler</code> class to implement a simple client.  The client will connect to the server and send commands encoded as lists.  We will reuse both <code>write_response()</code> and <code>handle_request()</code> logic for requests for encoding and processing server responses, respectively. </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, host=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'127.0.0.1'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, port=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">31337</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> self._protocol = ProtocolHandler() self._socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM) self._socket.connect((host, port)) self._fh = self._socket.makefile(<span class="hljs-string"><span class="hljs-string">'rwb'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, *args)</span></span></span><span class="hljs-function">:</span></span> self._protocol.write_response(self._fh, args) resp = self._protocol.handle_request(self._fh) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(resp, Error): <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> CommandError(resp.message) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resp</code> </pre> <br><p>  Using the <code>execute()</code> method, we can pass an arbitrary list of parameters that will be encoded as an array and sent to the server.  The server response is analyzed and returned as a Python object.  For convenience, we can write client methods for individual commands: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># ... def get(self, key): return self.execute('GET', key) def set(self, key, value): return self.execute('SET', key, value) def delete(self, key): return self.execute('DELETE', key) def flush(self): return self.execute('FLUSH') def mget(self, *keys): return self.execute('MGET', *keys) def mset(self, *items): return self.execute('MSET', *items)</span></span></code> </pre> <br><p>  To test our client, let's configure a Python script to start the server directly from the command line: </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># Add this to bottom of module: if __name__ == '__main__': from gevent import monkey; monkey.patch_all() Server().run()</span></span></code> </pre> <br><h3 id="proverka-servera">  Server check </h3><br><p>  To test the server, simply run the server-side Python module from the command line.  In another terminal, open the Python interpreter and import the <code>Client</code> class from the server module.  When you create a client instance, the connection will be opened, and you can run commands! </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> server_ex <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Client &gt;&gt;&gt; client = Client() &gt;&gt;&gt; client.mset(<span class="hljs-string"><span class="hljs-string">'k1'</span></span>, <span class="hljs-string"><span class="hljs-string">'v1'</span></span>, <span class="hljs-string"><span class="hljs-string">'k2'</span></span>, [<span class="hljs-string"><span class="hljs-string">'v2-0'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'v2-2'</span></span>], <span class="hljs-string"><span class="hljs-string">'k3'</span></span>, <span class="hljs-string"><span class="hljs-string">'v3'</span></span>) <span class="hljs-number"><span class="hljs-number">3</span></span> &gt;&gt;&gt; client.get(<span class="hljs-string"><span class="hljs-string">'k2'</span></span>) [<span class="hljs-string"><span class="hljs-string">'v2-0'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'v2-2'</span></span>] &gt;&gt;&gt; client.mget(<span class="hljs-string"><span class="hljs-string">'k3'</span></span>, <span class="hljs-string"><span class="hljs-string">'k1'</span></span>) [<span class="hljs-string"><span class="hljs-string">'v3'</span></span>, <span class="hljs-string"><span class="hljs-string">'v1'</span></span>] &gt;&gt;&gt; client.delete(<span class="hljs-string"><span class="hljs-string">'k1'</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span> &gt;&gt;&gt; client.get(<span class="hljs-string"><span class="hljs-string">'k1'</span></span>) &gt;&gt;&gt; client.delete(<span class="hljs-string"><span class="hljs-string">'k1'</span></span>) <span class="hljs-number"><span class="hljs-number">0</span></span> &gt;&gt;&gt; client.set(<span class="hljs-string"><span class="hljs-string">'kx'</span></span>, {<span class="hljs-string"><span class="hljs-string">'vx'</span></span>: {<span class="hljs-string"><span class="hljs-string">'vy'</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'vz'</span></span>: [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>]}}) <span class="hljs-number"><span class="hljs-number">1</span></span> &gt;&gt;&gt; client.get(<span class="hljs-string"><span class="hljs-string">'kx'</span></span>) {<span class="hljs-string"><span class="hljs-string">'vx'</span></span>: {<span class="hljs-string"><span class="hljs-string">'vy'</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'vz'</span></span>: [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>]}} &gt;&gt;&gt; client.flush() <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br><p>  The code presented in this article is for demonstration purposes only.  I hope you enjoyed reading about this project the way I liked to write about it.  <a href="https://gist.github.com/coleifer/dbbedc287605dcc22990a6e549de9f36" rel="nofollow">Here</a> you can find a complete copy of the source code. </p><br><p>  Consider the following if you want to expand the project: </p><br><ul><li>  Add more teams! </li><li>  Use a protocol handler to implement a command log in add-only mode. </li><li>  More reliable error handling. </li><li>  Allow the client to close the connection and reconnect. </li><li>  Logging </li><li>  Rewrite the code so that you can use <code>SocketServer</code> from the standard library and <code>ThreadingMixin</code> . </li></ul><br><p>  The author of the publication is Charles Leifer.  Translation - Evgeny Zyatev. <br>  The <a href="http://charlesleifer.com/blog/building-a-simple-redis-server-with-python/" rel="nofollow">original</a> can be found on Charles' blog. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/346286/">https://habr.com/ru/post/346286/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../346270/index.html">We work with smart cards using Python (part 1)</a></li>
<li><a href="../346272/index.html">"Simple" python programming</a></li>
<li><a href="../346274/index.html">Web installer on pure WINAPI with Hi DPI support and vector logo</a></li>
<li><a href="../346276/index.html">Developing a cool GUI on esp8266 with the uGFX library</a></li>
<li><a href="../346284/index.html">We select passwords using Google Chrome</a></li>
<li><a href="../346290/index.html">Testing of software documentation</a></li>
<li><a href="../346292/index.html">We turn speakers into speakers # 2: analysis of the speech of Artem Danilov, Avito</a></li>
<li><a href="../346294/index.html">What does Product Marketing Manager in JetBrains do?</a></li>
<li><a href="../346296/index.html">Improving session control in Spring Security</a></li>
<li><a href="../346298/index.html">Which is better - 1 mobile development team or 15?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>