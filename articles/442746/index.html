<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fool app for Windows Store</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Paul Cezanne, "Card Players" 

 A long time ago, in Windows 95, there was a Microsoft Hearts game. The game of cards on the network, with opponents ar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fool app for Windows Store</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/7x/g3/iz/7xg3izubdk1ga_uynaprmjeeyuc.jpeg"><br>  <i>Paul Cezanne, "Card Players"</i> <br><br>  A long time ago, in Windows 95, there was a Microsoft Hearts game.  The game of cards on the network, with opponents around the world.  If my memory serves me, in Windows for Workgroups 3.11 (yes, I caught all these artifacts!) There was a version for playing on a local network, using the so-called NetDDE. <br><a name="habracut"></a><br>  Card game did not have to choose a long time.  As they say, the rich ... High bridge and preference have disappeared because of their complete ignorance.  There was only one thing <s>left</s> - to <s>disappear the</s> fool. <br><br>  The situation was complicated by the fact that so far I have never been involved in developing a ‚Äúbackend‚Äù.  Googling led me right to the right place - <a href="https://docs.microsoft.com/ru-ru/aspnet/signalr/overview/getting-started/introduction-to-signalr">SignalR</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Here I would like to say a few enthusiastic words to SignalR.  A well-documented library that best fit my needs.  Bores will say that it is only under Windows, well, let them grit their teeth with envy.  Although there seems to be her kolkhoz clients for iOS, I have not studied this question in detail. <br><br>  Next question hosting.  Then I did not think long, Azure was at hand. <br><br><h2>  So, what did I want? </h2><br><ul><li>  The way to connect players must repeat the way Microsoft Hearts.  Players connect one by one, as soon as the required number is reached - the game starts.  For myself, I decided to limit myself to a one-on-one game - and no draws! </li><li>  At the very beginning of the players will be a bit - how do they know about each other?  Then the idea arose of sending push notifications to anyone who wanted to play when someone launches the application and connects to the game server.  In order not to trot users by pushing them, he made a restriction ‚Äúno more than once in N minutes‚Äù. </li><li>  I want more detailed statistics, prizes, achievements, etc. </li><li>  I want cards of different designs </li><li>  I want to play with my friend, and not with whom "whom God sent." </li></ul><br><h2>  What do I use from Azure? </h2><br><ul><li>  AppService is actually an application to which all clients connect. </li><li>  SQL server + SQL database - for storing game statistics. </li></ul><br>  Everything. <br><br>  Recently, I also used their push notification service.  But it seemed expensive (10 bucks a month), moreover, it turned out that because of the Microsoft billing glitch I had been paying for more than a year for these two services!  Goring with support led to the fact that they admitted a mistake and offered a month of compensation.  After some time, I completely abandoned this service, adding another table to my database for storing signatories on the push and sending them myself from the main application. <br><br>  At a given time, the cost of hosting monthly is about 400 p.  This is only the cost of the SQL server.  I have a small outgoing traffic and it fits into the free 5 GB per month. <br><br><h2>  Development </h2><br>  The development took place at Visual Studio 2015, MVVM framework MVVM light was used for the client. <br><br><h4>  A little server "kitchen" (aesthetes and the faint of heart is better not to look) </h4><br><div class="spoiler">  <b class="spoiler_title">connecting users, sending out pushes</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnConnected</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (((DateTime.Now - LastPush).TotalSeconds) &gt; <span class="hljs-number"><span class="hljs-number">360</span></span>) { LastPush = DateTime.Now; Task.Run(() =&gt; SendNotifications()); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnConnected(); }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">create anonymous game</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   .        </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-comment">ID  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> async public Task</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;String&gt;</span></span></span><span class="hljs-comment"> ConnectAnonymous(PlayerInformation pi) { MainSemaphore.WaitOne(); try { string res = String.Empty; string p_ip = Context.Request.GetHttpContext().Request.UserHostAddress; if (NextAnonymGame == null) { NextAnonymGame = new FoolGame(Context.ConnectionId, pi, p_ip, false); res = NextAnonymGame.strGameID; } else { await NextAnonymGame.Start(Context.ConnectionId, pi, p_ip); ActiveGames.Add(NextAnonymGame.strGameID, NextAnonymGame); res = NextAnonymGame.strGameID; NextAnonymGame = null; } return res; } finally { MainSemaphore.Release(); } }</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">game room creation</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-comment">   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> public String CreatePrivateGame(PlayerInformation pi) { MainSemaphore.WaitOne(); try { string p_ip = Context.Request.GetHttpContext().Request.UserHostAddress; FoolGame game = new FoolGame(Context.ConnectionId, pi, p_ip, true); WaitingPrivateGames.Add(game.strGameID, game); return game.PrivatePass; } finally { MainSemaphore.Release(); } }</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">peep the top card in the deck</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     - </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="gameid"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> async public Task PeekCard(string gameid) { FoolGame game = null; game = ActiveGames.FirstOrDefault(games =&gt; games.Value.strGameID == gameid).Value; if (game != null) { game.GameSemaphore.Wait(); await Task.Delay(35); try { await Clients.Caller.PeekedCard(game.Deck.Peek()); } finally { game.GameSemaphore.Release(); } } }</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">send a message to your opponent</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="gameid"&gt;</span></span></span><span class="hljs-comment">ID  (  )</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="ChatMessage"&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> async public Task ChatMessage(string gameid, string ChatMessage) { FoolGame game = null; game = ActiveGames.FirstOrDefault(games =&gt; games.Value.strGameID == gameid).Value; if (game != null) { game.GameSemaphore.Wait(); await Task.Delay(35); try { await Clients.OthersInGroup(gameid).ChatMessage(ChatMessage); } finally { game.GameSemaphore.Release(); } } }</span></span></code> </pre><br></div></div><br><br><h4>  About client </h4><br>  To identify the players, the LiveId functionality was used initially, then the Graph API.  When you first start the application, the player is asked to provide access to his account (from it I take only the name and the so-called anonymous id, which looks something like this: "ed4dd29dda5f982a").  However, the player can play anonymously, but then the statistics of his games is not conducted. <br><br>  For each non-anonymous player are stored: <br><br>  1. date of the first game / date of the last game <br>  2. name / nickname of the player <br>  3. the number of games played / how many of them are won <br>  4. last IP address <br>  5. received prizes <br><br>  If there are two non-anonymous players in the game, then before it starts, I get the statistics of the games of these particular players (how many games they played with each other and who won how many).  For this purpose, the resulting anonymous id is used in the SQL query. <br><br>  In the screenshot at the top left you can see an example (clickable): <br><br> <a href=""><img src="https://habrastorage.org/webt/kf/f6/zy/kff6zyaelk9orpazyvgnvosfxg4.png"></a> <br><br>  Screenshot of general statistics (clickable): <br><br> <a href=""><img src="https://habrastorage.org/webt/rn/hi/fy/rnhifyxjr_frp_txbsjzeks4wsq.png"></a> <br><br>  In addition, there is a ‚Äúcompetition‚Äù across countries (anonymous players participate here, information is taken from the IP address): <br><br><img src="https://habrastorage.org/webt/_s/7h/hf/_s7hhfg4sog_aczekl47_crehii.png"><br><br>  Players can exchange short messages. <br><br><pre> <code class="cs hljs">FoolHubProxy.On&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(<span class="hljs-string"><span class="hljs-string">"ChatMessage"</span></span>, (chatmessage) =&gt; synchrocontext.Post(<span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span> { PlayChatSound(); ShowMessageToast(chatmessage); }, <span class="hljs-literal"><span class="hljs-literal">null</span></span>));</code> </pre> <br>  An example of a situation handler is ‚ÄúI take the cards, and the opponent adds me after the game‚Äù: <br><br><pre> <code class="cs hljs">FoolHubProxy.On&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;(<span class="hljs-string"><span class="hljs-string">"TakeOneMoreCard"</span></span>, (addedcard, lastcard) =&gt; synchrocontext.Post(<span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span> { CardModel card = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CardModel(addedcard, DeckIndex); CardsOnTable_Low.Add(card); OpponentsCards.Remove(OpponentsCards.Last()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastcard) { AppMode = AppModeEnum.defeated; } }, <span class="hljs-literal"><span class="hljs-literal">null</span></span>));</code> </pre> <br><h2>  About prizes, cookies, etc. </h2><br>  Every month, the top five players who have scored the most victories, receive a badge of <s>"For the capture of Berlin</s> . <s>"</s>  Top 50 participants are awarded badges for the best winning percentage (also five).  In addition, there are badges for winning ‚Äúexpress‚Äù (a situation where you have 2, 3 or 4, say, sixes or jacks on the last move).  Then they are laid out on the table all at once and you are a fine fellow.  There are cookies for victory, when an opponent gives you "in the list".  He also gets a consolation, with a skull and bones. <br><br><h2>  About any additional functionality </h2><br>  The application is free, but it has various additional "buns", designed as InApp Purchases: <br><br><ul><li>  grouping your cards by suit and hints during the game (when you need to beat or toss, suitable cards move up) </li><li>  the ability to not show your opponent how many cards you have in your hand.  Normally he sees it. </li><li>  the ability to always be the first to start the game.  Otherwise, the first move is played randomly. </li><li>  the opportunity to see the cards repelled in the game </li><li>  the opportunity to peek into the deck once a game and find out the next card </li><li>  opportunity to "cheat."  3 times per game you can fight back or throw the wrong card, generally any.  But the opponent has the opportunity, noticing this, to return the wrong card to you. </li></ul><br><h2>  Conclusion </h2><br>  As a result of the development of this application, I: <br><br><ul><li>  met with SignalR </li><li>  refreshed SQL (queries, stored procedures, functions) </li><li>  learned how to host apps in Azure </li><li>  Opupel from playing the "fool". </li></ul><br><h2>  Question </h2><br>  And how on Habr√© is the case with the <s>scattering of money from a helicopter</s> distribution in PM promotional codes to those who want it?  If you do not give a kick for it, please contact us. </div><p>Source: <a href="https://habr.com/ru/post/442746/">https://habr.com/ru/post/442746/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../442736/index.html">6 board games for upgrading English</a></li>
<li><a href="../442738/index.html">Profiling and tracing with perf</a></li>
<li><a href="../442740/index.html">Reverse engineering of the binary format using the Korg SNG files as an example. Part 2</a></li>
<li><a href="../442742/index.html">Laptop Compaq LTE 5000, part two and a half - bonus</a></li>
<li><a href="../442744/index.html">RIPE decision and its consequences on the elimination of two Russian LIRs (Netup, gcxc.net)</a></li>
<li><a href="../442748/index.html">The point: the top 10 reports of Heisenbug 2018 Moscow</a></li>
<li><a href="../442750/index.html">Virtual Djinn on March 8 - or how to surprise your female employees on the very spring day</a></li>
<li><a href="../442754/index.html">Operational vs analytical databases: column vs row-by-line data storage</a></li>
<li><a href="../442758/index.html">5 lifehacks optimize SQL queries in Greenplum</a></li>
<li><a href="../442760/index.html">An article on how CommVault makes PostgreSQL backups.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>