<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>AS3 Vector in AMF3: we lift the curtain</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Starting with the version of flash player 10.0, there is support for a new type of lists - vector. Vector is a typed, ordered list. More details can b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>AS3 Vector in AMF3: we lift the curtain</h1><div class="post__text post__text-html js-mediator-article"> Starting with the version of flash player 10.0, there is support for a new type of lists - vector.  Vector is a typed, ordered list.  More details can be found on <a href="http://help.adobe.com/ru_RU/FlashPlatform/reference/actionscript/3/Vector.html">the Adobe website</a> .  Tests show a good increase in read / write speed compared to simple arrays.  (Not so long ago, <a href="https://habrahabr.ru/users/soulburner/" class="user_link">soulburner</a> published its <a href="http://habrahabr.ru/blogs/Flash_Platform/122401/">tests</a> ).  Unfortunately, not a single PHP library (in other languages ‚Äã‚Äãother than AS3) supports this data type. <a name="habracut"></a><br><br>  A little googling, an <a href="http://jpauclair.net/2010/01/16/reverse-engineering-amf3-vector-for-java/">article</a> was found that describes the deserialization of vectors in java.  Everything turns out to be not so bad: there are four additional markers for <code>Vector.&lt;int&gt;</code> , <code>Vector.&lt;uint&gt;</code> , <code>Vector.&lt;Number&gt;</code> and <code>Vector.&lt;Object&gt;</code> .  But I never managed to completely port the code - the server could not in any way deserialize the vector of objects (everything was in order with the numeric types).  As a result, I had to put xdebug and start looking for myself ‚Äúwhere the dog is buried‚Äù.  As I suspected, the author of that article incorrectly implemented the parsing of a vector of objects and a little incorrect parsing of numerical vectors. <br><br><h5>  Vector specification </h5><br>  Adobe released <a href="http://opensource.adobe.com/wiki/download/attachments/1114283/amf3_spec_05_05_08.pdf">the AMF3 protocol specification</a> , but forgot (or did not want) to update it after the vectors appeared.  Below you can see the addition of the specification for vectors. <br><hr><pre> S32 = An signed 32-bit integer in big endian (network) byte order

 vector-type = vector-int-type |  vector-uint-type |  vector-number-type |
               vector-object-type |  vector-other-type

 value-type = |  vector-type

 vector-int-marker = 0x0D
 vector-uint-marker = 0x0E
 vector-number-marker = 0x0F
 vector-object-marker = 0x10

 U29V-len = U29;  The first (low) bit is a flag with value 1.
                ;  The remaining 1 to 28 significant bits are used to encode
                ;  the length of the vector
 vector-fixed-flag = U8

 vector-int-type = vector-int-marker (U29O-ref | U29V-length vector-fixed-flag * (S32))
 vector-uint-type = vector-uint-marker (U29O-ref | U29V-length vector-fixed-flag * (U32))
 vector-number-type = vector-number-marker (U29O-ref | U29V-length vector-fixed-flag * (DOUBLE))
 vector-object-type = vec tor-object-marker (U29O-ref | U29V-length vector-fixed-flag class-name
                       * (null-type | object-type))
 vector-other-type = vector-object-marker (U29O-ref | U29V-length vector-fixed-flag UTF-8-empty
                       * (null-type | false-type | true-type | array-type | string-type |
                       vector-type |  date-type |  byte-array-type))
</pre><hr><br>  As you can see, 4 additional markers were added: 3 special for numeric values ‚Äã‚Äãand one for the rest. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <em><b>Comment.</b></em>  <em>In fact, the specification is not entirely correct, namely the <code>vector-other-type</code> rule.</em>  <em>According to the specification it turns out that such a vector can simultaneously contain all of the listed types, but in fact only one of the listed types.</em>  <em>And only <code><nobr>null-type</nobr></code> can be used simultaneously with other types.</em>  <em>Unfortunately, I do not know how to specify such a rule using ABNF.</em> <br><br><h5>  Numeric Vectors </h5><br>  Everything is simple with them.  Read the length of the vector, the <code>fixed</code> flag, and N values ‚Äã‚Äã( <code>int</code> , <code>uint</code> or <code>double</code> ).  To be honest, I was surprised that these three vectors were rendered, especially against the background of the fact that the vectors of rows and boules are encoded as vectors of objects (more on this below). <br><br><h5>  Object Vector </h5><br>  Exactly the same as numerical vectors.  The only difference is the additional parameter <code>class-name</code> , the name of the class whose objects contain a vector.  <code>class-name</code> can be empty, meaning <code>Object</code> . <br><br><h5>  Vectors of strings, boules, arrays, vectors </h5><br>  I was unpleasantly surprised at how the vectors are encoded for the remaining ‚Äúspecial types‚Äù.  For them, a vector marker of objects with an empty string instead of a <code>class-name</code> .  So without data it is impossible to know what exactly the vector contains, i.e.  it is impossible to know what kind of vector arrived if it is empty. <br><br><h5>  Implementation </h5><br>  Because of these vectors for ‚Äúspecial data types,‚Äù I also had difficulty in implementing vectors for PHP.  The problem lies in the strict typing of vectors - a vector can store only one type of data.  Here I was torn between 2 ways of implementation: <br>  - simple but dumb container for arrays <br>  - typesafe vector <br>  With the first, everything is simple, but I want the second.  As a result, the patch for Zend_Amf was never written, because I left the company for which I worked.  And now there is no time to finish it.  Therefore, I decided to simply lay out the specification.  I am sure there are many who are willing to implement vector support in Zend_Amf, AMFPHP, WebORB, PyAMF, and others. <br><br><h5>  PS </h5><br>  The specification has not been thoroughly tested, so it may well not be complete.  I would welcome any amendments. </div><p>Source: <a href="https://habr.com/ru/post/122178/">https://habr.com/ru/post/122178/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../122171/index.html">Memory and tasks</a></li>
<li><a href="../122172/index.html">Home, Catalog and Lists in the online store</a></li>
<li><a href="../122174/index.html">The main thing is the tail! or opt-out 2</a></li>
<li><a href="../122175/index.html">The first coin with a QR code</a></li>
<li><a href="../122176/index.html">100,000 NektoMe users</a></li>
<li><a href="../122179/index.html">Making Linux From Scratch our universal distribution</a></li>
<li><a href="../122181/index.html">Microsoft has announced successes in the fight against autorun viruses</a></li>
<li><a href="../122182/index.html">i-garden</a></li>
<li><a href="../122183/index.html">Wireless chips from Renesas Electronics Corp can work without batteries</a></li>
<li><a href="../122184/index.html">Experienced trivia-4, or "Measuring backups?"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>