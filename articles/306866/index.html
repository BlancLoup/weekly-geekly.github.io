<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automate the installation of updates on the client machine with the elimination of erroneous updates</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once a year there is an update breaking the usual work. Windows tries to install it 3 times, and if there was a rollback 3 times, it boots without ins...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automate the installation of updates on the client machine with the elimination of erroneous updates</h1><div class="post__text post__text-html js-mediator-article">  Once a year there is an update breaking the usual work.  Windows tries to install it 3 times, and if there was a rollback 3 times, it boots without installation.  Users start calling in the morning.  If nothing is done, the situation will be repeated the next morning. <br><ul><li>  On the <b>WSUS</b> server, it makes no sense to move it to <b>Unapproved</b> .  the patch has already been downloaded to the client machine and is located in the <b>SoftwareDistribution</b> folder; it must be manually removed </li><li>  buggy patches can be many </li><li>  after half a year, the admin can approve it again when parked </li><li>  if we approve every six months or a year, it will take up to 1 day of work per machine (class of cars) to sift out bad ones from good ones </li><li>  updates to one configuration may not be suitable for another configuration, even if the OS is one </li><li>  update status <b>hidden</b> will be reset if you uninstall <b>SoftwareDistribution</b> </li><li>  <b>SoftwareDistribution</b> should be thrown off if the base is buggy, the search is taking too long, and it‚Äôs best to do it periodically </li></ul><br>  This is all inconvenient, so the admin will almost always do the same thing - he will turn off updates on the problem machine.  And in a year or two he will start rolling updates and face the same problem. <br><br>  Since  The glitch of updates causes an emergency mode, eats an incredible amount of staff time for absolutely meaningless garbage, and in order to move to a <a href="https://habrahabr.ru/post/301242/">smart infrastructure</a> it was decided to try to automate this process.  Along the way, a script was received that can install all updates on a freshly installed machine in automatic mode. <br><br>  Immediately make a reservation - this script does not know how to repair a system that does not load at all, it can install updates itself, automatically throw in updates causing a cyclic reboot, it can manually add bad updates to the list and signal the administrator about the problems with the installation. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  How to start it all, quick start </h2><br>  <a href="https://new.vk.com/doc281099435_437751611%3Fhash%3D95fe0a54b9267270e4%26dl%3D41784adf27d1b0420d">source for the article in one file</a> <br>  <b>0.</b> Enable the execution of scripts on your system.  <b>Set-ExecitionPolicy Unrestricted</b> or sign scripts with your certificate. <br>  <b>1.</b> copy the WUErrorreporting script to the disk of the controlled machine and add it to the task scheduler, for example, 12:30 of the day.  <a href="http://windowsnotes.ru/powershell-2/zapusk-powershell-skripta-po-raspisaniyu/">If anyone does not know how to create tasks on a schedule, click here.</a> <br><div class="spoiler">  <b class="spoiler_title">WUErrorreporting.ps1</b> <div class="spoiler_text"><pre><code class="cs hljs">&lt;<span class="hljs-meta"><span class="hljs-meta"># 2016.05.23 Windows Update Error reporter      .           20   . Pak NV #&gt; ############# # Variables # ############# #        [int]$DaysBefore = 5 #         $SaveLog = $false $LogPath = 'c:\WUError.txt' #   HTML [boolean]$SaveReport = $False [string]$ReportPath = 'C:\WUErrorReport.html' #  HTML  [boolean]$SendReport = $true [string]$ReportMail1 = 'admin@test.local' [string]$from = 'bot_abormot@test.local' [string]$SMTPServer = 'mail.test.local' ############################################################################# #      $Events = Get-EventLog -LogName System -EntryType Error -After (Get-Date).AddDays(-$DaysBefore) -InstanceId 20 -ErrorAction SilentlyContinue #          </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($Events.Count -eq 0) { Write-Host '   ,  ' -ForegroundColor Green Exit } #    $Log = @() #          foreach ($Event in $Events) { $regex = $Event.Message -match "KB\d+" $KB = $matches[0] $params = [ordered]@{ 'KB'=$KB #'EntryType'=$Event.EntryType 'Index'=$Event.Index 'MachineName'=$Event.MachineName 'Message'=$Event.Message 'Source'=$Event.Source 'TimeGenerated'=$Event.TimeGenerated 'TimeWritten'=$Event.TimeWritten 'UserName'=$Event.UserName } $obj = New-Object -TypeName PSObject -Property $params $Log += $obj } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($SaveLog -eq $true) { #      Add-Content -Path $LogPath -Value '' $Log | select -ExpandProperty KB | Add-Content -Path $LogPath } #,    #################################   ##################################### Write-Verbose 'HTML fragment producing' $ClientName = $env:COMPUTERNAME $TotalErrors = $log.Count $frag1 = $Log | ConvertTo-Html -As table -Fragment -PreContent "&lt;h2&gt;Windows Update </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta"> report. $ClientName &lt;/h2&gt;&lt;br&gt;&lt;h3&gt;Total $TotalErrors errors.&lt;/h3&gt;" | Out-String Write-Verbose 'definiting CSS' $head = @' &lt;style&gt; body { background-color:#ffffff; font-family:Tahoma; font-size:12pt; } td, th { border:1px solid black; border-collapse:collapse; } th { color:white; background-color:black; } table, tr, td, th { padding: 2px; margin: 0px } table { font-family: "Lucida Sans Unicode", "Lucida Grande", Sans-Serif; font-size: 14px; border-radius: 10px; border-spacing: 0; text-align: center; } th { background: #BCEBDD; color: white; text-shadow: 0 1px 1px #2D2020; padding: 10px 20px; } th, td { border-style: solid; border-width: 0 1px 1px 0; border-color: white; } th:first-child, td:first-child { text-align: left; } th:first-child { border-top-left-radius: 10px; } th:last-child { border-top-right-radius: 10px; border-right: none; } td { padding: 10px 20px; background: #F8E391; } tr:last-child td:first-child { border-radius: 0 0 0 10px; } tr:last-child td:last-child { border-radius: 0 0 10px 0; } tr td:last-child { border-right: none; } &lt;/style&gt; '@ $Date = Get-Date </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($SendReport -eq $true) { Write-Verbose 'SendEmail' $encoding = [System.Text.Encoding]::UTF8 $body = ConvertTo-HTML -head $head -PostContent $frag1 -PreContent "&lt;h1&gt;Windows Update </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta"> report. Client $ClientName. Date:$Date&lt;/h1&gt;" | Out-String $params = @{'To'=$ReportMail1 'From'=$from 'Subject'="$ClientName. Windows Update </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta"> $Date" 'Body'=$Body 'BodyAsHTML'=$True 'SMTPServer'=$SMTPServer} Send-MailMessage @params -Encoding $encoding }</span></span></code> </pre> </div></div><br>  <b>2.</b> Set the parameters for notifications of update errors, to do this, change the parameters <br>  <b>$ ReportMail1 = 'admin@test.local'</b> to your email <br>  <b>$ SMTPServer = 'mail.test.local'</b> to your mail server. <br><br>  <b>3.</b> copy the configuration reset script to the desired machine and run it.  It will create a directory with initial settings, if the directory is there will reset them to the initial state. <br><div class="spoiler">  <b class="spoiler_title">Rearm_Install-ClientUpdate.ps1</b> <div class="spoiler_text"><pre> <code class="cs hljs">&lt;<span class="hljs-meta"><span class="hljs-meta">#       #&gt; #         $Path = Split-Path ($MyInvocation.MyCommand.Path) -Parent </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ((Test-Path -Path "$Path\BadUpdates") -eq $false) { New-Item -Path "$Path\BadUpdates" -ItemType Directory -Force } #    $LastInstalledUpdatesFile = "$Path\BadUpdates\LastInstalledUpdates.txt" #     $BadUpdatesFile = "$Path\BadUpdates\BadUpdates.txt" # FastInstaller $KAFUFile = "$Path\BadUpdates\KAFU.txt" #      $KAFUDeltaFile = "$Path\BadUpdates\KAFUDelta.txt" # Fastinstaller watchdog $KAFUWatchDogFile = "$Path\BadUpdates\KAFUWatchDog.txt" # Fastinstaller update installer watchdog $KAFUWatchDog2File = "$Path\BadUpdates\KAFUWatchDog2.txt" # SlowInstaller $KASUFile = "$Path\BadUpdates\KASU.txt" #   $WorkLogFile = "$Path\BadUpdates\log.txt" #   $KAFile = "$Path\BadUpdates\KA.txt" Set-Content $LastInstalledUpdatesFile -Value '' Set-Content $KAFUFile -Value 0 Set-Content $KAFUDeltaFile -Value 5 Set-Content $KAFUWatchDogFile -Value 0 Set-Content $KAFUWatchDog2File -Value 0 Set-Content $KASUFile -Value 0 Set-Content $KAFile -Value 99 Set-Content $BadUpdatesFile -Value ''</span></span></code> </pre><br></div></div><br>  <b>4.</b> copy the update script to the directory with the previous script (note, below is a large script, 85kb), so as not to copy and paste, download it <a href="https://new.vk.com/doc281099435_437751608%3Fhash%3D2ce9542d2b5d03ce90%26dl%3D287497cda5cdfb74ab">from here</a> <br><img src="https://habrastorage.org/files/6a2/9f4/8cc/6a29f48cc51c4e81993571673b18a0ec.jpg"><br><div class="spoiler">  <b class="spoiler_title">Install-ClientUpdate.ps1</b> <div class="spoiler_text"><pre> <code class="cs hljs">&lt;<span class="hljs-meta"><span class="hljs-meta"># 2016.06.14 ver 2            .        .       (FastUpdate)       30%  ,      25%,      5  .    ,             ,                                 ,   ,         1.      2.    "\BadUpdates\KA.txt"   9,  11 3.            -  ,  6   -   powershell.exe -file "   \Install-ClientUpdate.ps1" 4.       5.       $RebootEnabled = $False                    1.      2.    "\BadUpdates\KA.txt"   9,  11 3.            -   (  ),   10   -   powershell.exe -file "   \Install-ClientUpdate.ps1" 4.       5.       $RebootEnabled = $true              :       SoftwareDistribution.                  Plugins.           .           ,          .        "    "      .          .      IsHidden=1            .        "4.      ".    .    win 7       .             : powershell 2.0 Pak Nikolay GEOM, Aqtobe   win 8.1/2012R2; win 7; win 2008R2 #&gt; ############# # Variables # ############# # Allow reboot.        .      #    .       10 ,   .    #    . #$RebootEnabled = $true $RebootEnabled = $False # Fast install          $FastInstallLimit = 45 #         $Path = Split-Path ($MyInvocation.MyCommand.Path) -Parent #    $LastInstalledUpdatesFile = "$Path\BadUpdates\LastInstalledUpdates.txt" #     $BadUpdatesFile = "$Path\BadUpdates\BadUpdates.txt" # FastInstaller $KAFUFile = "$Path\BadUpdates\KAFU.txt" #      $KAFUDeltaFile = "$Path\BadUpdates\KAFUDelta.txt" # Fastinstaller watchdog $KAFUWatchDogFile = "$Path\BadUpdates\KAFUWatchDog.txt" # Fastinstaller update installer watchdog $KAFUWatchDog2File = "$Path\BadUpdates\KAFUWatchDog2.txt" # SlowInstaller $KASUFile = "$Path\BadUpdates\KASU.txt" #   $WorkLogFile = "$Path\BadUpdates\log.txt" #   $KAFile = "$Path\BadUpdates\KA.txt" ########################## Report params ################################### [boolean]$SaveReport = $true [string]$ReportPath = 'C:\Report-InstallUpdates.html' [boolean]$SendReport = $true [string]$From = 'bot_abormot@test.local' [string]$SMTP = 'mail.test.local' [string]$ReportMail1 = 'admin1@test.local' [string]$ReportMail2 = 'admin2@test.local' [string]$ReportMail3 = 'admin3@test.local' function report { Param ( [string]$Text = 'test' ) $Date = Get-Date </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($SaveReport = $true) { $Text | Out-File $ReportPath } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($SendReport = $true) { $encoding = [System.Text.Encoding]::UTF8 $body = $Text $Subj = "install-updates script report $Date" $params = @{'To'=$ReportMail1 'From'=$From 'Subject'=$Subj 'Body'=$Body 'BodyAsHTML'=$True 'SMTPServer'=$SMTP} Send-MailMessage @params -Encoding $encoding $params = @{'To'=$ReportMail2 'From'=$From 'Subject'=$Subj 'Body'=$Body 'BodyAsHTML'=$True 'SMTPServer'=$SMTP} Send-MailMessage @params -Encoding $encoding $params = @{'To'=$ReportMail3 'From'=$From 'Subject'=$Subj 'Body'=$Body 'BodyAsHTML'=$True 'SMTPServer'=$SMTP} Send-MailMessage @params -Encoding $encoding } } ########################## Report params ################################### function Log { PARAM ( [parameter(Mandatory = $true)] [string]$Message ) $Date = Get-Date -Format "yyyy.MM.dd HH:mm:ss" [string]$Msg = $Date + "`t" + $Message Out-File -FilePath $WorkLogFile -InputObject $Msg -Append # -encoding unicode } function Clear-Log { $Date = Get-Date -Format "yyyy.MM.dd HH:mm:ss" $Msg = $Date + "`t" + '   Clear-Log' Set-Content -Path $WorkLogFile -Value $Msg } function Trim-Log { #    5    </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( (Get-Item -Path $WorkLogFile).Length -gt 5mb ) { Clear-Log } } &lt;#   SoftwareDistribution      ,  ,       WUAUSRV       .       #&gt; function ResetSoftwareDistribution { $WUServices = 'BITS','wuauserv' $windows = 0x24 Log 'call ResetSoftwareDistribution' Log 'stopping WU services' Write-Host " SoftwareDistribution" -ForegroundColor Green Write-Host "-------------------------------" -ForegroundColor Green Write-Host " " -ForegroundColor Green $WUServices | Stop-Service -Verbose Start-Sleep -Seconds 20 #      </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( ((Get-Service 'BITS').Status -eq 'stopped' ) -and ((Get-Service 'wuauserv').Status -eq 'stopped') ) { Log 'services stopped sucsessful' Write-Host '  ' -ForegroundColor Green $Folders = Get-ChildItem ( (New-Object -ComObject Shell.Application).Namespace( $windows ).Self.Path) -Directory | where { $_.Name -like '*SoftwareDistribution*' } Write-Host "   WU" -ForegroundColor Green $Folders Write-Host " ..." $Folders | Remove-Item -Recurse -Force -Verbose -Confirm:$false #   $Folders = Get-ChildItem ( (New-Object -ComObject Shell.Application).Namespace( $windows ).Self.Path) -Directory | where { $_.Name -like '*SoftwareDistribution*' } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($Folders -eq $null) { Log 'SoftwareDistribution folder deleted successful' Write-Host " SoftwareDistribution  " -ForegroundColor Green } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { Log 'SoftwareDistribution folder deleted NOT successful' Write-Host "SoftwareDistribution   !" -ForegroundColor Red #              Softwaredistrib #Exit } } Log 'starting WU services' Write-Host " " -ForegroundColor Green $WUServices | Start-Service -Verbose } &lt;#            KB      IsHidden  0,    Softwaredistribution    Hidden .         IsHidden = 1             '2976978', '3156418' | install-updates -Verbose #&gt; function install-updates { [CmdletBinding()] PARAM ( [Parameter( Position=0, Mandatory=$true, ValueFromPipeline=$true, ValueFromPipelineByPropertyName=$true) ] [string[]]$KB ) BEGIN { Log 'call install-updates' $session = New-Object -ComObject Microsoft.Update.Session $searcher = $session.CreateUpdateSearcher() $Updates = $searcher.Search("IsInstalled=0 and Type='Software' and ISHidden=0") #     </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($Updates.Updates.Count -eq 0) { $NoUpdates = $true } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { $NoUpdates = $false } #   Write-Verbose '---------------------------------------------------------------------' Write-Verbose "install-updates:   NoUpdates = $NoUpdates" </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($NoUpdates -eq $false) { Write-Verbose "   " $temp1 = $Updates.updates | select Title $temp1 | Write-Verbose $Count = $Updates.Updates.Count Write-Verbose "$Count   " Log "$Count   " foreach ( $temp in $temp1 ) { Log " $temp" } } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { Log "install-updates:      " Write-Verbose "install-updates:      " } Write-Verbose '---------------------------------------------------------------------' } PROCESS { Write-Verbose "install-updates:     process $KB" </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($NoUpdates -eq $true) { break } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($KB -match ' ' ) { break } $HotFix = $Updates.Updates | where { $_.Title -like "*$KB*" } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($HotFix -eq $null) { Write-Verbose "     " Log "     " break } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { $Title = $HotFix.Title Write-Verbose "    $Title" Log "    $Title" } #   $downloads = New-Object -ComObject Microsoft.Update.UpdateColl $downloads.Add( $HotFix ) #      80070005.        SYSTEM #                  #      Write-Verbose ' ' Log 'download update' $downloader = $session.CreateUpdateDownLoader() $downloader.Updates = $downloads $downloader.Download() </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($HotFix.IsDownloaded) { Log 'download successfull' Write-Verbose ' . (   downloads)' } $installs = New-Object -ComObject Microsoft.Update.UpdateColl </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($HotFix.IsDownloaded) { $installs.Add( $HotFix ) | Out-Null } log 'start instal' #      80070005.        SYSTEM #                  #      $installer = $session.CreateUpdateInstaller() $installer.Updates = $installs $installresult = $installer.Install() $installresult log 'installing successfull' } END { Write-Verbose 'install-updates:   ' log 'install-updates:   ' log '--------------------------------------------------------------' } } &lt;#         20-30     .    .               .            , ..  10-20                .      ,             .       $KAFUWatchDog     0       1/3          1       1/4          2       5         #&gt; #  [int]$KAFU = Get-Content $KAFUFile #      [int]$KAFUDelta = Get-Content $KAFUDeltaFile function Fast-Update { function Write-KAFU { PARAM ( $State ) Set-Content $KAFUFile -Value $State } Log "--- Fast-Update ---------------------------------------------------------" Log "Fast-Update    " switch ($KAFU) { 0 { Log "   0" #        $session = New-Object -ComObject Microsoft.Update.Session $searcher = $session.CreateUpdateSearcher() $temp = $searcher.Search("IsInstalled=0 and Type='Software'" ) $Count = $temp.Updates.Count #   ,              $KAFUWatchDog = Get-Content $KAFUWatchDogFile log "KAFUWatchDog = $KAFUWatchDog" switch ($KAFUWatchDog) { 0 { #  ,     2      $KAFUDelta = [Math]::Truncate( $Count / 3 ) Log " ,   1/3     $KAFUDelta" } 1 { #     4      $KAFUDelta = [Math]::Truncate( $Count / 4 ) Log " ,   1/4     $KAFUDelta" } 2 { #     -          #   5    $KAFUDelta = 5 log '    -            5' } default { Log '   ,   ' $KAFUWatchDog = 0 $KAFUDelta = [Math]::Truncate( $Count / 3 ) Set-Content $KAFUWatchDogFile -Value $KAFUWatchDog } } #     Set-Content $LastInstalledUpdatesFile -Value '' Set-Content $KAFUDeltaFile -Value $KAFUDelta Set-Content $KAFUWatchDog2File -Value 0 Write-KAFU 1 break } 1 { Log "enter in state 1" $LastInstalled = Get-Content $LastInstalledUpdatesFile $BadUpdates = Get-Content $BadUpdatesFile log '     ' $session = New-Object -ComObject Microsoft.Update.Session $searcher = $session.CreateUpdateSearcher() $temp = $searcher.Search("IsInstalled=0 and Type='Software'" ) $Updates = $temp.Updates | select title #        [string[]]$HotFixs = '' foreach ($temp in $Updates) { $regex = $temp.Title -match "KB\d+" $KB = $matches[0] $HotFixs += $KB Log "   : $KB" } $Count = $HotFixs.Count Log "    $Count" log ' ' $Upd = @() foreach ($temp in $HotFixs) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($temp -ne '') { $Upd += $temp } } $Upd #         </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($BadUpdates.Count -ne 0) { $temp = Compare-Object -ReferenceObject $HotFixs -DifferenceObject $BadUpdates $temp = $temp | where { $_.Sideindicator -like '&lt;=' } | select -ExpandProperty InputObject $HotFixs = $temp $Upd = @() foreach ($temp in $HotFixs) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($temp -ne '') { $Upd += $temp } } $HotFixs = $Upd $temp = $HotFixs Log "    :" foreach ( $temp1 in $temp ) { Log "    : $temp1" } $Count = $temp.Count Log ": $Count " } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { Log "   " } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($LastInstalled.Count -ne 0) { $temp = Compare-Object -ReferenceObject $HotFixs -DifferenceObject $LastInstalled $temp = $temp | where { $_.Sideindicator -like '&lt;=' } | select -ExpandProperty InputObject $HotFixs = $temp Log "     :" $Upd = @() foreach ($temp in $HotFixs) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($temp -ne '') { $Upd += $temp } } $HotFixs = $Upd $temp = $HotFixs foreach ( $temp1 in $temp ) { Log "     : $temp1" } $Count = $temp.Count Log ": $Count " } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { Log "     " } #     [int]$KAFUWatchDog2 = Get-Content $KAFUWatchDog2File </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($KAFUWatchDog2 -gt 20) { Log "   ,      1,  : $KAFUWatchDog2" Write-KAFU 2 Set-Content $KAFUWatchDog2File -Value 0 break } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($HotFixs.Count -eq 0) { #   log ' ,   .    2' Write-KAFU 2 break } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { #     $temp = $HotFixs | select -First $KAFUDelta $Count = $temp.Count </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($Count -eq 0) { log '  .    2' Write-KAFU 2 break } foreach ( $temp1 in $temp ) { Log "   : $temp1" } Log ": $Count " $HotFixs = $temp #   Add-Content -Path $LastInstalledUpdatesFile -Value '' Add-Content -Path $LastInstalledUpdatesFile -Value $HotFixs @(Get-Content $LastInstalledUpdatesFile) -match '\S' | out-file $LastInstalledUpdatesFile LOG "    " #    log '  ' $HotFixs | install-updates } Set-Content $KAFUWatchDog2File -Value ($KAFUWatchDog2 + 1) break } 2 { #           Log '   2.' $KAFUWatchDog = Get-Content $KAFUWatchDogFile $KAFUDelta = Get-Content $KAFUDeltaFile $LastInstalled = Get-Content $LastInstalledUpdatesFile log "KAFUWatchDog = $KAFUWatchDog" switch ($KAFUWatchDog) { 0 { #   .   ?      $session = New-Object -ComObject Microsoft.Update.Session $searcher = $session.CreateUpdateSearcher() $temp = $searcher.Search("IsInstalled=0 and Type='Software'" ) $Updates = $temp.Updates #       * 3 - 2 $Count1 = $Updates.Count </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($KAFUDelta -eq 0) { $KAFUDelta = 5 } $Count2 = $KAFUDelta * 3 - 2 </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($Count2 -lt $Count1) { #     .     $KAFUWatchDog = 1 Set-Content $KAFUWatchDogFile -Value 1 Write-KAFU 0 Log '    .   = 1.    0' break } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { log '    WatchDog = 0' log '   3' Write-KAFU 3 break } } 1 { #     $session = New-Object -ComObject Microsoft.Update.Session $searcher = $session.CreateUpdateSearcher() $temp = $searcher.Search("IsInstalled=0 and Type='Software'" ) $Updates = $temp.Updates | select title #       * 3 - 2 $Count1 = $Updates.Count $Count2 = $KAFUDelta * 4 - 2 </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($Count2 -gt $Count1) { #     - 4        25%  #      5 $KAFUWatchDog = 2 Set-Content $KAFUWatchDogFile -Value 2 Write-KAFU 0 Log '    .  = 2.    0' break } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { log '    WatchDog = 1' log '   3' Write-KAFU 3 break } } 2 { #     5    log '    WatchDog = 2' log '   3' Write-KAFU 3 break } default { Log '     0' Set-Content $KAFUWatchDogFile -Value 0 Write-KAFU 0 break } } } 3 { # ,  Write-KAFU 3 break } default { Set-Content $KAFUWatchDogFile -Value 0 Write-KAFU 0 Log "</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">warning</span></span></span><span class="hljs-meta">!!!   ,   0. KAFU = $KAFU" break } } Log "--- Fast-Update -- -------------------------------------------------------" } &lt;################################################################################################      .       .     ,      .    48      24   2  ,   1 .       3-6   ,      30-40    . ################################################################################################&gt; &lt;#                           #&gt; #  [int]$KASU = Get-Content $KASUFile function Slow-update { function Write-KASU { PARAM ( $State ) Set-Content $KASUFile -Value $State } Log "--- Slow Update ---------------------------------------------------------" Log "Slow Update " switch ($KASU) { 0 { #    log "   0,   " #     Set-Content $LastInstalledUpdatesFile -Value '' Set-Content $KAFUWatchDog2File -Value 0 Set-Content $KAFUWatchDog2File -Value 0 Write-KASU 1 break } 1 { log "   1" $LastInstalled = Get-Content $LastInstalledUpdatesFile $BadUpdates = Get-Content $BadUpdatesFile log '     ' $session = New-Object -ComObject Microsoft.Update.Session $searcher = $session.CreateUpdateSearcher() $temp = $searcher.Search("IsInstalled=0 and Type='Software'" ) $Updates = $temp.Updates | select title #        [string[]]$HotFixs = '' foreach ($temp in $Updates) { $regex = $temp.Title -match "KB\d+" $KB = $matches[0] $HotFixs += $KB Log "   : $KB" } $Count = $HotFixs.Count Log "    $Count" $Upd = @() foreach ($temp in $HotFixs) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($temp -ne '') { $Upd += $temp } } $PotentialBad = $Upd #         </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($BadUpdates.Count -ne 0) { $temp = Compare-Object -ReferenceObject $HotFixs -DifferenceObject $BadUpdates $temp = $temp | where { $_.Sideindicator -like '&lt;=' } | select -ExpandProperty InputObject $HotFixs = $temp Log "    :" $Upd = @() foreach ($temp in $HotFixs) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($temp -ne '') { $Upd += $temp } } $HotFixs = $Upd $temp = $HotFixs foreach ( $temp1 in $temp ) { Log "    : $temp1" } $Count = $temp.Count Log ": $Count " } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { Log "   " } $Upd = @() foreach ($temp in $HotFixs) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($temp -ne '') { $Upd += $temp } } $HotFixs = $Upd </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($LastInstalled.Count -ne 0) { $temp = Compare-Object -ReferenceObject $HotFixs -DifferenceObject $LastInstalled $temp = $temp | where { $_.Sideindicator -like '&lt;=' } | select -ExpandProperty InputObject $HotFixs = $temp Log "     :" $Upd = @() foreach ($temp in $HotFixs) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($temp -ne '') { $Upd += $temp } } $HotFixs = $Upd $temp = $HotFixs foreach ( $temp1 in $temp ) { Log "     : $temp1" } $Count = $temp.Count Log ": $Count " } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { Log "     " } $Upd = @() foreach ($temp in $HotFixs) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($temp -ne '') { $Upd += $temp } } $HotFixs = $Upd </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($HotFixs.Count -eq 0) { #   log ' ,   .     ' </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($PotentialBad -ne 0 ) { foreach ( $Bad in $PotentialBad ) { log "   : $Bad" } #   ..   ,         #Add-Content -Path $BadUpdatesFile -Value '' #Add-Content -Path $BadUpdatesFile -Value $LastInstalled } Write-KASU 2 break } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { #     $temp = $HotFixs | select -First 1 $Count = $temp.Count </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( $Count -eq 0 ) { log '   2' Write-KASU 2 break } foreach ( $temp1 in $temp ) { Log "   : $temp1" } Log ": $Count " $HotFixs = $temp #   Add-Content -Path $LastInstalledUpdatesFile -Value '' Add-Content -Path $LastInstalledUpdatesFile -Value $HotFixs @(Get-Content $LastInstalledUpdatesFile) -match '\S' | out-file $LastInstalledUpdatesFile LOG "    " #    log '  ' Write-Host $HotFixs -ForegroundColor Green $HotFixs | install-updates } Set-Content $KAFUWatchDog2File -Value ($KAFUWatchDog2 + 1) break } 2 { #  ,  Write-KASU 2 break } default { #   log " " Write-KASU 0 } } Log "--- Slow-Update -- -------------------------------------------------------" } [int]$KA = Get-Content $KAFile function Write-KA { PARAM ( $State ) Set-Content $KAFile -Value $State } Log ' ' Log " " Log ' ' Log ' ' Log ' ' Log '##############################' Log "### ---   --- ###" Log '##############################' switch ($KA) { 0 { #   log( ' = 0.         ' ) Set-Content $LastInstalledUpdatesFile -Value '' Set-Content $KAFUWatchDogFile -Value 0 Set-Content $KASUFile -Value 0 Set-Content $KAFUFile -Value 0 Write-KA 9 break } 1 { #   Log '  1.    ' [int]$KAFU = Get-Content $KAFUFile </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($KAFU -eq 3) { #    log '  ,    ' Write-KA 2 Set-Content $KASUFile -Value 0 break } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { log '  ' ResetSoftwareDistribution Fast-Update Trim-Log break } } 2 { #  log ' 2,  ' [int]$KASU = Get-Content $KASUFile </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($KASU -eq 2) { #    #                 Trim-Log ResetSoftwareDistribution log( ' = 2.    ' ) $BadUpdates = Get-Content $BadUpdatesFile $session = New-Object -ComObject Microsoft.Update.Session $searcher = $session.CreateUpdateSearcher() $temp = $searcher.Search("IsInstalled=0 and Type='Software'" ) $Updates = $temp.Updates | select title #        [string[]]$HotFixs = '' foreach ($temp in $Updates) { $regex = $temp.Title -match "KB\d+" $KB = $matches[0] $HotFixs += $KB Log "   : $KB" } $Count = $HotFixs.Count Log "    $Count" $PotentialBad = $HotFixs #    </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($BadUpdates.Count -ne 0) { $temp = Compare-Object -ReferenceObject $HotFixs -DifferenceObject $BadUpdates $temp = $temp | where { $_.Sideindicator -like '&lt;=' } | select -ExpandProperty InputObject $HotFixs = $temp Log "    :" foreach ( $temp1 in $temp ) { Log "    : $temp1" } $Count = $temp.Count Log ": $Count " } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { Log "   " } $Updates = @() foreach ($temp in $HotFixs) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($temp -ne '') { $Updates += $temp } } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($Updates.Count -ne 0) { #    log '        ' Add-Content -Path $BadUpdatesFile -Value '' Add-Content -Path $BadUpdatesFile -Value $Updates $Date = Get-Date $CompName = $env:COMPUTERNAME $body = "&lt;H1&gt;     $CompName,&lt;br&gt;&lt;br&gt;   &lt;/H1&gt;&lt;h3&gt;" foreach ($upd in $updates) { $body += "&lt;br&gt; $upd&lt;br&gt;" } $body += "&lt;br&gt;         .   ,        " report -text $body } Write-KA 9 break } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { log '        ' ResetSoftwareDistribution Trim-Log Slow-update break } } 9 { #     log( ' = 9.     ' ) Trim-Log ResetSoftwareDistribution $BadUpdates = Get-Content $BadUpdatesFile log '    ' $session = New-Object -ComObject Microsoft.Update.Session $searcher = $session.CreateUpdateSearcher() $temp = $searcher.Search("IsInstalled=0 and Type='Software'" ) $Updates = $temp.Updates | select title #        [string[]]$HotFixs = '' foreach ($temp in $Updates) { $regex = $temp.Title -match "KB\d+" $KB = $matches[0] $HotFixs += $KB Log "   : $KB" } $Count = $HotFixs.Count Log "    $Count" $PotentialBad = $HotFixs #    </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($BadUpdates.Count -ne 0) { $temp = Compare-Object -ReferenceObject $HotFixs -DifferenceObject $BadUpdates $temp = $temp | where { $_.Sideindicator -like '&lt;=' } | select -ExpandProperty InputObject $HotFixs = $temp Log "    :" $Upd = @() foreach ($temp in $HotFixs) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($temp -ne '') { $Upd += $temp } } $HotFixs = $Upd $temp = $HotFixs foreach ( $temp1 in $temp ) { Log "    : $temp1" } $Count = $temp.Count Log ": $Count " } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { Log "   " } log ' ' $Updates = @() foreach ($temp in $HotFixs) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($temp -ne '') { $Updates += $temp } } $Count = $Updates.Count Log "  $Count  " #     $FastInstallLimit    </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($Updates.Count -gt $FastInstallLimit) { #    log "updates more than $FastInstallLimit. Go to FastInstall" Write-KA 1 break } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($Updates.Count -gt 0) { log "Go to Slow Install" Write-KA 2 Set-Content $KASUFile -Value 0 break } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($Updates.Count -eq 0) { log '    ' Write-KA 9 break } } default { #   log( '   .    0' ) Write-KA 0 } } #ResetSoftwareDistribution #Fast-Update #Trim-Log #Slow-update Log '##############################' Log "### ---   --- ###" Log '##############################' </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ( $RebootEnabled -eq $true ) { Restart-Computer -Force Log ' &gt;&gt;&gt;' } &lt;# schtasks /run /tn "\My_Tasks\PSWindowsUpdate" [Console]::OutputEncoding = [System.Text.Encoding]::GetEncoding("cp866") #&gt;</span></span></code> </pre><br></div></div><br> <b>5.</b>       <b>SYSTEM</b>   1   .   ‚Äî         <b>SYSTEM</b> . (               ) <br><img src="https://habrastorage.org/files/96d/cf7/a55/96dcf7a552e7427b8f547c6e32dbae2d.jpg"><br><br>       6  <br><img src="https://habrastorage.org/files/c1c/b9a/510/c1cb9a5102c94f0681bc812923b4d250.jpg"><br><br> ,   . <br><br>  3       .         <b>\BadUpdates\log.txt</b>      .         ,    ,    . <br><br>      45 (   )      .         1\3  ,     3    ,     1/4,             5.     ,      6    ,       90    (90    ). <br><br><blockquote> <b>  :</b> <br> 1.   <b>WUErrorreporting</b>      20,                 . <br> 2.       <b>SoftwareDistribution</b> <br> 3.         .    : <br> 4.     45        ¬´¬ª   <br><ul><li>       ,      ,    <b>1/3</b> ,     <b>1/4</b> ,    <b>5</b> </li><li>                           </li><li>       ,      </li><li>         <b>BadUpdates\LastInstalledUpdates.txt</b>         </li><li>               </li></ul><br> 5.    45         <br> 6.      <br><ul><li>          </li><li>           ,                   .       </li></ul><br> 7.         </blockquote><br>         <b>SoftwareDistribution</b>   <b>SoftwareDistribution\Plugins</b> ,        . <br><blockquote>        : <br><ul><li>   <b>$RebootEnabled = $true</b> ,          </li><li>     10     </li><li>      </li><li>            ,   ,        . </li><li>          </li><li>         9 ( )  <b>$RebootEnabled = $false</b> </li><li>         </li></ul></blockquote><br><br>   <br><br><h1> WUErrorreporting </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Set your variables. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The most significant variable is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ DaysBefore</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - for how many days the log will be scanned, by default 5 days. If there was an error installing the update, you will receive an administrative notification for 5 days in a row about the same error. In principle, it is normal to set 1 or 2 days, it does not make sense, you can skip the report if someone left to work on the weekend. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ SaveLog variable</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is responsible for saving the current run log to disk. It is useful, you can come or connect to the client machine and look at the work which update was not installed. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The last 4 variables control who to send the report to. You need to leave </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ SendReport = $ true</font></font></b>       ,  <b>email</b>  <b>$ReportMail1 = 'admin@test.local'</b>      <b>$SMTPServer = 'mail.test.local'</b> .        <b>156</b>  <br><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">############# # Variables # ############# #        [int]$DaysBefore = 5 #         $SaveLog = $false $LogPath = 'c:\WUError.txt' #   HTML [boolean]$SaveReport = $False [string]$ReportPath = 'C:\WUErrorReport.html' #  HTML  [boolean]$SendReport = $true [string]$ReportMail1 = 'admin@test.local' $from = 'bot_abormot@test.local' [string]$SMTPServer = 'mail.test.local'</span></span></code> </pre><br></div></div><br><br> 2.     <br><br>     ID20   System <br><pre> <code class="cs hljs">$Events = Get-EventLog -LogName System -EntryType Error -After (Get-Date).AddDays(-$DaysBefore) -InstanceId <span class="hljs-number"><span class="hljs-number">20</span></span> -ErrorAction SilentlyContinue</code> </pre><br><br>        <br><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#    $Log = @() #          foreach ($Event in $Events) { $regex = $Event.Message -match "KB\d+" $KB = $matches[0] $params = [ordered]@{ 'KB'=$KB #'EntryType'=$Event.EntryType 'Index'=$Event.Index 'MachineName'=$Event.MachineName 'Message'=$Event.Message 'Source'=$Event.Source 'TimeGenerated'=$Event.TimeGenerated 'TimeWritten'=$Event.TimeWritten 'UserName'=$Event.UserName } $obj = New-Object -TypeName PSObject -Property $params $Log += $obj }</span></span></code> </pre><br>    <a href="https://habrahabr.ru/post/279005/">¬´¬ª </a> <br><pre> <code class="cs hljs"> $encoding = [System.Text.Encoding]::UTF8 $body = ConvertTo-HTML -head $head -PostContent $frag1 -PreContent <span class="hljs-string"><span class="hljs-string">"&lt;h1&gt;Windows Update error report. Client $ClientName. Date:$Date&lt;/h1&gt;"</span></span> | Out-String $<span class="hljs-keyword"><span class="hljs-keyword">params</span></span> = @{<span class="hljs-string"><span class="hljs-string">'To'</span></span>=$ReportMail1 <span class="hljs-string"><span class="hljs-string">'From'</span></span>=$<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'Subject'</span></span>=<span class="hljs-string"><span class="hljs-string">"$ClientName. Windows Update error $Date"</span></span> <span class="hljs-string"><span class="hljs-string">'Body'</span></span>=$Body <span class="hljs-string"><span class="hljs-string">'BodyAsHTML'</span></span>=$True <span class="hljs-string"><span class="hljs-string">'SMTPServer'</span></span>=$SMTPServer} Send-MailMessage @<span class="hljs-keyword"><span class="hljs-keyword">params</span></span> -Encoding $encoding</code> </pre><br>  CSS    outlook,     HTML   Word,      .           Outlook   . <br><div class="spoiler"> <b class="spoiler_title">CSS  </b> <div class="spoiler_text"><pre> <code class="css hljs">$<span class="hljs-selector-tag"><span class="hljs-selector-tag">head</span></span> = @' &lt;style&gt; body { <span class="hljs-selector-tag"><span class="hljs-selector-tag">background-color</span></span>:<span class="hljs-selector-id"><span class="hljs-selector-id">#ffffff</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">font-family</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Tahoma</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">font-size</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:12pt</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">td</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">th</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">border</span></span>:<span class="hljs-number"><span class="hljs-number">1px</span></span> solid black; <span class="hljs-attribute"><span class="hljs-attribute">border-collapse</span></span>:collapse; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">th</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">color</span></span>:white; <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>:black; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">table</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">tr</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">td</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">th</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">padding</span></span>: <span class="hljs-number"><span class="hljs-number">2px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">margin</span></span>: <span class="hljs-number"><span class="hljs-number">0px</span></span> } <span class="hljs-selector-tag"><span class="hljs-selector-tag">table</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">font-family</span></span>: <span class="hljs-string"><span class="hljs-string">"Lucida Sans Unicode"</span></span>, <span class="hljs-string"><span class="hljs-string">"Lucida Grande"</span></span>, Sans-Serif; <span class="hljs-attribute"><span class="hljs-attribute">font-size</span></span>: <span class="hljs-number"><span class="hljs-number">14px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border-radius</span></span>: <span class="hljs-number"><span class="hljs-number">10px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border-spacing</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">text-align</span></span>: center; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">th</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">background</span></span>: <span class="hljs-number"><span class="hljs-number">#BCEBDD</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">color</span></span>: white; <span class="hljs-attribute"><span class="hljs-attribute">text-shadow</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1px</span></span> <span class="hljs-number"><span class="hljs-number">1px</span></span> <span class="hljs-number"><span class="hljs-number">#2D2020</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">padding</span></span>: <span class="hljs-number"><span class="hljs-number">10px</span></span> <span class="hljs-number"><span class="hljs-number">20px</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">th</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">td</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">border-style</span></span>: solid; <span class="hljs-attribute"><span class="hljs-attribute">border-width</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1px</span></span> <span class="hljs-number"><span class="hljs-number">1px</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border-color</span></span>: white; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">th</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:first-child</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">td</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:first-child</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">text-align</span></span>: left; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">th</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:first-child</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">border-top-left-radius</span></span>: <span class="hljs-number"><span class="hljs-number">10px</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">th</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:last-child</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">border-top-right-radius</span></span>: <span class="hljs-number"><span class="hljs-number">10px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border-right</span></span>: none; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">td</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">padding</span></span>: <span class="hljs-number"><span class="hljs-number">10px</span></span> <span class="hljs-number"><span class="hljs-number">20px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">background</span></span>: <span class="hljs-number"><span class="hljs-number">#F8E391</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">tr</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:last-child</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">td</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:first-child</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">border-radius</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">10px</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">tr</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:last-child</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">td</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:last-child</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">border-radius</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">10px</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">tr</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">td</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:last-child</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">border-right</span></span>: none; } &lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">style</span></span>&gt; '@</code> </pre><br></div></div><br><br><h1> Install-ClientUpdate.ps1 </h1><br>    3  ,         . <br><br>   : <br> <b>$FastInstallLimit</b>       ,        . <br> <b>$RebootEnabled</b>      .      .     <b>$true</b> ,    10     . <br><br>      <br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">########################## Report params ################################### [boolean]$SaveReport = $true [string]$ReportPath = 'C:\Report-InstallUpdates.html' [boolean]$SendReport = $true [string]$From = 'bot_abormot@test.local' [string]$SMTP = 'mail.test.local' [string]$ReportMail1 = 'admin1@test.local' [string]$ReportMail2 = 'admin2@test.local' [string]$ReportMail3 = 'admin3@test.local'</span></span></code> </pre><br>               .      <br><pre> <code class="cs hljs">$session = New-Object -ComObject Microsoft.Update.Session $searcher = $session.CreateUpdateSearcher() $temp = $searcher.Search(<span class="hljs-string"><span class="hljs-string">"IsInstalled=0 and Type='Software'"</span></span> ) $Count = $temp.Updates.Count $Count <span class="hljs-string"><span class="hljs-string">''</span></span></code> </pre><br><br>  :         , ..        . <br> ,        ,    ¬´   ¬ª          . <br><br>      win 8.1; 2012R2;  win 7 x64 <br><br>  2016.08.03: <br>              <b>\BadUpdates\BadUpdates.txt</b>   <b>KB121212</b>             </div><p>Source: <a href="https://habr.com/ru/post/306866/">https://habr.com/ru/post/306866/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../306856/index.html">I / O tracer in the Linux kernel</a></li>
<li><a href="../306858/index.html">SObjectizer: from simple to complex. Part I</a></li>
<li><a href="../306860/index.html">GitLab 8.10 released</a></li>
<li><a href="../306862/index.html">All kernel mode drivers for Windows 10 (1607) should now be signed by Microsoft</a></li>
<li><a href="../306864/index.html">A brief reminder of the demiurge</a></li>
<li><a href="../306868/index.html">Connecting Intel Internet of Things Gateways to IBM Watson</a></li>
<li><a href="../306872/index.html">Results and analysis of tasks for the final of the Yandex. Algorithm 2016</a></li>
<li><a href="../306874/index.html">Uber does not always win</a></li>
<li><a href="../306876/index.html">As I wrote game design documentation for my game.</a></li>
<li><a href="../306878/index.html">The digest of interesting events from the world of Java, and around it # 7 (07/18/2016 - 07/31/2016)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>