<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SQL Language Tutorial (DDL, DML) on the example of MS SQL Server dialect. Part three</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Previous parts 


- Part One - habrahabr.ru/post/255361 
- Part Two - habrahabr.ru/post/255523 

 What will be discussed in this part 
 In this part w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SQL Language Tutorial (DDL, DML) on the example of MS SQL Server dialect. Part three</h1><div class="post__text post__text-html js-mediator-article"><h2>  Previous parts </h2><br><ul><li>  Part One - <a href="http://habrahabr.ru/post/255361/">habrahabr.ru/post/255361</a> </li><li>  Part Two - <a href="http://habrahabr.ru/post/255523/">habrahabr.ru/post/255523</a> </li></ul><br><br><h2>  What will be discussed in this part </h2><br>  In this part we will introduce: <br><ol><li>  with a CASE expression that allows conditional expressions to be included in the query; </li><li>  with aggregate functions that allow you to get all sorts of totals (aggregated values) calculated on the basis of detailed data obtained by the operator "SELECT ... WHERE ..."; </li><li>  with the GROUP BY clause, which, along with aggregate functions, allows you to get totals for detailed data by groups; </li><li>  with the HAVING clause, which allows filtering by grouped data. </li></ol><br><a name="habracut"></a><br><br><h2>  CASE expression is a conditional operator of the SQL language </h2><br>  This operator allows you to check the conditions and return, depending on the fulfillment of a particular condition, a particular result. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The CASE operator has 2 forms: <br><table><tbody><tr><th>  The first form: </th><th>  The second form: </th></tr><tr><td>  CASE <br>  WHEN condition_1 <br>  THEN return_value_1 <br>  ... <br>  WHEN condition_N <br>  THEN return_value_N <br>  [ELSE return_value] <br>  END </td><td>  CASE check_value <br>  WHEN compare_value_1 <br>  THEN return_value_1 <br>  ... <br>  WHEN Compare_Name <br>  THEN return_value_N <br>  [ELSE return_value] <br>  END </td></tr></tbody></table><br>  Here, expressions can also act as values. <br><br>  <b>Let us consider an example of the first form CASE:</b> <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>,Salary, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> Salary&gt;=<span class="hljs-number"><span class="hljs-number">3000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' &gt;= 3000'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> Salary&gt;=<span class="hljs-number"><span class="hljs-number">2000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'2000 &lt;=  &lt; 3000'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">' &lt; 2000'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> SalaryTypeWithELSE, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> Salary&gt;=<span class="hljs-number"><span class="hljs-number">3000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' &gt;= 3000'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> Salary&gt;=<span class="hljs-number"><span class="hljs-number">2000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'2000 &lt;=  &lt; 3000'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> SalaryTypeWithoutELSE <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees</code> </pre> <br><table><tbody><tr><th>  ID </th><th>  Name </th><th>  Salary </th><th>  SalaryTypeWithELSE </th><th>  SalaryTypeWithoutELSE </th></tr><tr><td>  1000 </td><td>  Ivanov I.I. </td><td>  5000 </td><td>  ZP&gt; = 3000 </td><td>  ZP&gt; = 3000 </td></tr><tr><td>  1001 </td><td>  Petrov P.P. </td><td>  1500 </td><td>  ZP &lt;2000 </td><td>  Null </td></tr><tr><td>  1002 </td><td>  Sidorov S.S. </td><td>  2500 </td><td>  2000 &lt;= ZP &lt;3000 </td><td>  2000 &lt;= ZP &lt;3000 </td></tr><tr><td>  1003 </td><td>  Andreev A.A. </td><td>  2000 </td><td>  2000 &lt;= ZP &lt;3000 </td><td>  2000 &lt;= ZP &lt;3000 </td></tr><tr><td>  1004 </td><td>  Nikolaev N.N. </td><td>  1500 </td><td>  ZP &lt;2000 </td><td>  Null </td></tr><tr><td>  1005 </td><td>  Aleksandrov A.A. </td><td>  2000 </td><td>  2000 &lt;= ZP &lt;3000 </td><td>  2000 &lt;= ZP &lt;3000 </td></tr></tbody></table><br>  WHEN conditions are checked sequentially, from top to bottom.  When the first condition satisfies, the further check is interrupted and the value specified after the word THEN related to the WHEN block is returned. <br><br>  If none of the WHEN conditions is fulfilled, the value specified after the word ELSE is returned (which in this case means ‚ÄúOTHER RETURN ...‚Äù). <br><br>  If the ELSE block is not specified and no WHEN condition is met, then NULL is returned. <br><br>  In both the first and second forms, the ELSE block goes at the very end of the CASE construction, i.e.  after all when conditions. <br><br>  <b>Let us consider an example of the second form CASE:</b> <br><br>  Suppose we decided to reward all employees for the new year and asked to calculate the bonus amount according to the following scheme: <br><ul><li>  Employees of the IT department to issue 15% of the salary; </li><li>  Accounting staff at 10% of the RFP; </li><li>  All the rest of 5% of the RFP. </li></ul><br><br>  Use the query with the CASE expression for this task: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>,Salary,DepartmentID, <span class="hljs-comment"><span class="hljs-comment">--        CASE DepartmentID --   WHEN 2 THEN '10%' -- 10%     WHEN 3 THEN '15%' -- 15%    - ELSE '5%' --    5% END NewYearBonusPercent, --     CASE,     Salary/100* CASE DepartmentID WHEN 2 THEN 10 -- 10%     WHEN 3 THEN 15 -- 15%    - ELSE 5 --    5% END BonusAmount FROM Employees</span></span></code> </pre><br><table><tbody><tr><th>  ID </th><th>  Name </th><th>  Salary </th><th>  DepartmentID </th><th>  NewYearBonusPercent </th><th>  BonusAmount </th></tr><tr><td>  1000 </td><td>  Ivanov I.I. </td><td>  5000 </td><td>  one </td><td>  five% </td><td>  250 </td></tr><tr><td>  1001 </td><td>  Petrov P.P. </td><td>  1500 </td><td>  3 </td><td>  15% </td><td>  225 </td></tr><tr><td>  1002 </td><td>  Sidorov S.S. </td><td>  2500 </td><td>  2 </td><td>  ten% </td><td>  250 </td></tr><tr><td>  1003 </td><td>  Andreev A.A. </td><td>  2000 </td><td>  3 </td><td>  15% </td><td>  300 </td></tr><tr><td>  1004 </td><td>  Nikolaev N.N. </td><td>  1500 </td><td>  3 </td><td>  15% </td><td>  225 </td></tr><tr><td>  1005 </td><td>  Aleksandrov A.A. </td><td>  2000 </td><td>  Null </td><td>  five% </td><td>  100 </td></tr></tbody></table><br>  This is a sequential check of the DepartmentID value with WHEN values.  When the first DepartmentID with the WHEN value is reached, the check is interrupted and the value returned after the word THEN for the WHEN block is returned. <br><br>  Accordingly, the value of the ELSE block is returned if the DepartmentID does not match any WHEN value. <br><br>  If the ELSE block is absent, then in case of a DepartmentID mismatch, none of the WHEN values ‚Äã‚Äãwill be returned NULL. <br><br>  It is easy to present the second CASE form using the first form: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>,Salary,DepartmentID, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> DepartmentID=<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'10%'</span></span> <span class="hljs-comment"><span class="hljs-comment">-- 10%     WHEN DepartmentID=3 THEN '15%' -- 15%    - ELSE '5%' --    5% END NewYearBonusPercent, --     CASE,     Salary/100* CASE WHEN DepartmentID=2 THEN 10 -- 10%     WHEN DepartmentID=3 THEN 15 -- 15%    - ELSE 5 --    5% END BonusAmount FROM Employees</span></span></code> </pre><br><br>  So, the second form is just a simplified notation for those cases where we need to make a comparison for equality of the same checked value with each WHEN value / expression. <br><br><blockquote>  <b>Note.</b>  The first and second forms of CASE are part of the standard SQL language, so most likely they should be applicable in many DBMSs. </blockquote><br><br>  With MS SQL version 2012, a simplified IIF notation appeared.  It can be used to simplify the CASE construction record, in case only 2 values ‚Äã‚Äãare returned.  The design of the IIF is as follows: <br><br><pre> <code class="sql hljs">IIF(, true_, false_)</code> </pre><br><br>  Those.  in essence, this is a wrapper for the following CASE construction: <br><br><pre> <code class="sql hljs">CASE WHEN  THEN true_ ELSE false_ <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br><br>  Let's look at an example: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>,Salary, <span class="hljs-keyword"><span class="hljs-keyword">IIF</span></span>(Salary&gt;=<span class="hljs-number"><span class="hljs-number">2500</span></span>,<span class="hljs-string"><span class="hljs-string">' &gt;= 2500'</span></span>,<span class="hljs-string"><span class="hljs-string">' &lt; 2500'</span></span>) DemoIIF, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> Salary&gt;=<span class="hljs-number"><span class="hljs-number">2500</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' &gt;= 2500'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">' &lt; 2500'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> DemoCASE <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees</code> </pre><br><br>  CASE, IIF constructs can be nested in each other.  Consider an abstract example: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>,Salary, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> DepartmentID <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'A'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> DepartmentID=<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> PositionID <span class="hljs-comment"><span class="hljs-comment">--  CASE WHEN 3 THEN 'B-1' WHEN 4 THEN 'B-2' END ELSE 'C' END Demo1, IIF(DepartmentID IN(1,2),'A', IIF(DepartmentID=3,CASE PositionID WHEN 3 THEN 'B-1' WHEN 4 THEN 'B-2' END,'C')) Demo2 FROM Employees</span></span></code> </pre><br><br>  Since the CASE and IIF constructs are expressions that return a result, we can use them not only in the SELECT block, but also in other blocks that allow the use of expressions, for example, in WHERE or ORDER BY blocks. <br><br>  For example, let us set a task - to create a list for issuing a salary certificate, as follows: <br><ul><li>  First of all, the RFP should receive employees from whom the salary is less than 2500 </li><li>  Those employees who have a salary greater than or equal to 2500, receive an RFP secondarily </li><li>  Within these two groups, you need to sort the lines by name (field Name) </li></ul><br><br>  Let's try to solve this problem by adding a CASE expression to the ORDER BY block: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>,Salary <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> Salary&gt;=<span class="hljs-number"><span class="hljs-number">2500</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>, <span class="hljs-comment"><span class="hljs-comment">--         2500 Name --      </span></span></code> </pre><br><table><tbody><tr><th>  ID </th><th>  Name </th><th>  Salary </th></tr><tr><td>  1005 </td><td>  Aleksandrov A.A. </td><td>  2000 </td></tr><tr><td>  1003 </td><td>  Andreev A.A. </td><td>  2000 </td></tr><tr><td>  1004 </td><td>  Nikolaev N.N. </td><td>  1500 </td></tr><tr><td>  1001 </td><td>  Petrov P.P. </td><td>  1500 </td></tr><tr><td>  1000 </td><td>  Ivanov I.I. </td><td>  5000 </td></tr><tr><td>  1002 </td><td>  Sidorov S.S. </td><td>  2500 </td></tr></tbody></table><br>  As we see, Ivanov and Sidorov will be the last to leave work. <br><br>  And an abstract example of using CASE in the WHERE clause: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>,Salary <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> Salary&gt;=<span class="hljs-number"><span class="hljs-number">2500</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-comment"><span class="hljs-comment">--       1</span></span></code> </pre><br><br>  You can try to remake the last 2 examples with the IIF function. <br><br>  And finally, remember once again about NULL-values: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>,Salary,DepartmentID, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> DepartmentID=<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'10%'</span></span> <span class="hljs-comment"><span class="hljs-comment">-- 10%     WHEN DepartmentID=3 THEN '15%' -- 15%    - WHEN DepartmentID IS NULL THEN '-' --     ( IS NULL) ELSE '5%' --    5% END NewYearBonusPercent1, --     NULL ,     NULL    CASE DepartmentID --   WHEN 2 THEN '10%' WHEN 3 THEN '15%' WHEN NULL THEN '-' -- !!!       CASE   ELSE '5%' END NewYearBonusPercent2 FROM Employees</span></span></code> </pre><br><table><tbody><tr><th>  ID </th><th>  Name </th><th>  Salary </th><th>  DepartmentID </th><th>  NewYearBonusPercent1 </th><th>  NewYearBonusPercent2 </th></tr><tr><td>  1000 </td><td>  Ivanov I.I. </td><td>  5000 </td><td>  one </td><td>  five% </td><td>  five% </td></tr><tr><td>  1001 </td><td>  Petrov P.P. </td><td>  1500 </td><td>  3 </td><td>  15% </td><td>  15% </td></tr><tr><td>  1002 </td><td>  Sidorov S.S. </td><td>  2500 </td><td>  2 </td><td>  ten% </td><td>  ten% </td></tr><tr><td>  1003 </td><td>  Andreev A.A. </td><td>  2000 </td><td>  3 </td><td>  15% </td><td>  15% </td></tr><tr><td>  1004 </td><td>  Nikolaev N.N. </td><td>  1500 </td><td>  3 </td><td>  15% </td><td>  15% </td></tr><tr><td>  1005 </td><td>  Aleksandrov A.A. </td><td>  2000 </td><td>  Null </td><td>  - </td><td>  five% </td></tr></tbody></table><br>  Of course, you could rewrite something like this: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>,Salary,DepartmentID, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>(DepartmentID,<span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-comment"><span class="hljs-comment">--     NULL  -1 WHEN 2 THEN '10%' WHEN 3 THEN '15%' WHEN -1 THEN '-' --   ,    ID  (-1)     ELSE '5%' END NewYearBonusPercent3 FROM Employees</span></span></code> </pre><br><br>  In general, the flight of fancy in this case is not limited. <br><br>  For example, let's see how using the CASE and IIF you can simulate the function ISNULL: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>,LastName, <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>(LastName,<span class="hljs-string"><span class="hljs-string">' '</span></span>) DemoISNULL, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> LastName <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> LastName <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> DemoCASE, <span class="hljs-keyword"><span class="hljs-keyword">IIF</span></span>(LastName <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>,<span class="hljs-string"><span class="hljs-string">' '</span></span>,LastName) DemoIIF <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees</code> </pre><br><br>  The CASE construct is a very powerful tool in the SQL language, which allows you to impose additional logic to calculate the values ‚Äã‚Äãof the result set.  In this part, possession of the CASE-construction is still useful to us, therefore, in this part, first of all, attention is paid to it. <br><br><h2>  Aggregate functions </h2><br>  Here we consider only the main and most frequently used aggregate functions: <br><table><tbody><tr><th width="300">  Title </th><th>  Description </th></tr><tr><td>  COUNT (*) </td><td>  Returns the number of rows received by the "SELECT ... WHERE ..." statement.  In the absence of WHERE, the number of all records in the table. </td></tr><tr><td>  COUNT (column / expression) </td><td>  Returns the number of values ‚Äã‚Äã(not equal to NULL) in the specified column / expression </td></tr><tr><td>  COUNT (DISTINCT column / expression) </td><td>  Returns the number of unique values ‚Äã‚Äãthat are not equal to NULL in the specified column / expression </td></tr><tr><td>  SUM (column / expression) </td><td>  Returns the sum of column / expression values. </td></tr><tr><td>  AVG (column / expression) </td><td>  Returns the average of the column / expression values.  NULL values ‚Äã‚Äãfor counting are not counted. </td></tr><tr><td>  MIN (column / expression) </td><td>  Returns the minimum value by column / expression value </td></tr><tr><td>  MAX (column / expression) </td><td>  Returns the maximum value by column / expression values </td></tr></tbody></table><br>  Aggregate functions allow us to make the calculation of the total value for a set of rows obtained using the SELECT statement. <br><br>  Consider each function by example: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) [ - ], <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> DepartmentID) [  ], <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> PositionID) [  ], <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(BonusPercent) [-     % ], <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(BonusPercent) [  ], <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(BonusPercent) [  ], <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(Salary/<span class="hljs-number"><span class="hljs-number">100</span></span>*BonusPercent) [  ], <span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(Salary/<span class="hljs-number"><span class="hljs-number">100</span></span>*BonusPercent) [  ], <span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(Salary) [  ] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees</code> </pre><br><table><tbody><tr><th>  Total number of employees </th><th>  The number of unique departments </th><th>  The number of unique posts </th><th>  Number of employees who have% bonus </th><th>  Maximum bonus percentage </th><th>  Min Bonus Percentage </th><th>  The sum of all bonuses </th><th>  Average bonus size </th><th>  Average size of salary </th></tr><tr><td>  6 </td><td>  3 </td><td>  four </td><td>  3 </td><td>  50 </td><td>  15 </td><td>  3325 </td><td>  1108.33333333333 </td><td>  2416.66666666667 </td></tr></tbody></table><br>  For greater clarity, I decided to make an exception here and used the syntax [...] to set the aliases of the columns. <br><br>  <b>Let us analyze how each returned value is obtained, and for one thing we recall the constructions of the basic syntax of the SELECT statement.</b> <br><br>  First, because  we did not specify WHERE conditions in the query, then the totals will be considered for the detailed data that is obtained by the query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees</code> </pre><br><br>  those.  for all rows in the Employees table. <br><br>  For clarity, select only the fields and expressions that are used in the aggregate functions: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DepartmentID, PositionID, BonusPercent, Salary/<span class="hljs-number"><span class="hljs-number">100</span></span>*BonusPercent [Salary/<span class="hljs-number"><span class="hljs-number">100</span></span>*BonusPercent], Salary <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees</code> </pre><br><table><tbody><tr><th>  DepartmentID </th><th>  PositionID </th><th>  BonusPercent </th><th>  Salary / 100 * BonusPercent </th><th>  Salary </th></tr><tr><td>  one </td><td>  2 </td><td>  50 </td><td>  2500 </td><td>  5000 </td></tr><tr><td>  3 </td><td>  3 </td><td>  15 </td><td>  225 </td><td>  1500 </td></tr><tr><td>  2 </td><td>  one </td><td>  Null </td><td>  Null </td><td>  2500 </td></tr><tr><td>  3 </td><td>  four </td><td>  thirty </td><td>  600 </td><td>  2000 </td></tr><tr><td>  3 </td><td>  3 </td><td>  Null </td><td>  Null </td><td>  1500 </td></tr><tr><td>  Null </td><td>  Null </td><td>  Null </td><td>  Null </td><td>  2000 </td></tr></tbody></table><br>  This is the initial data (detailed lines), according to which the results of the aggregated query will be considered. <br><br>  <b>Now analyze each aggregated value:</b> <br><br><table><tbody><tr><td>  <b>COUNT (*)</b> - because  we did not specify the filter conditions in the WHERE clause in the query, then COUNT (*) gave us the total number of records in the table, i.e.  this is the number of lines returned by the query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees</code> </pre><br><br><img src="//habrastorage.org/files/06f/264/c88/06f264c889ca40a6833ac582f73f9c58.png"><br></td></tr><tr><td>  <b>COUNT (DISTINCT DepartmentID)</b> - returned to us the value of 3, i.e.  This number corresponds to the number of unique department values ‚Äã‚Äãindicated in the DepartmentID column without taking null values ‚Äã‚Äãinto account.  Go through the values ‚Äã‚Äãof the DepartmentID column and color the same values ‚Äã‚Äãin one color (feel free to learn all the methods for learning): <br><br><img src="//habrastorage.org/files/c86/a94/f0d/c86a94f0dded48e4b1b812e521c9a35e.png"><br><br>  We throw away NULL, after which, we got 3 unique values ‚Äã‚Äã(1, 2 and 3).  Those.  the value obtained by COUNT (DISTINCT DepartmentID), in expanded form, can be represented by the following sample: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> DepartmentID <span class="hljs-comment"><span class="hljs-comment">-- 2.     FROM Employees WHERE DepartmentID IS NOT NULL -- 1.  NULL </span></span></code> </pre><br><br><img src="//habrastorage.org/files/090/a42/288/090a422880de4153a29f4fb1e11b56fd.png"><br></td></tr><tr><td>  <b>COUNT (DISTINCT PositionID)</b> - the same thing that was said about COUNT (DISTINCT DepartmentID), only to the PositionID field.  We look at the values ‚Äã‚Äãof the PositionID column and do not regret the colors: <br><br><img src="//habrastorage.org/files/ddc/d86/2b1/ddcd862b1ef24b239ba9f0c749f7ce2b.png"><br></td></tr><tr><td>  <b>COUNT (BonusPercent)</b> - returns the number of rows that have the BonusPercent value, i.e.  counts the number of entries for which BonusPercent IS NOT NULL.  Here it will be easier for us, because  no need to read unique values, just drop the records with NULL values.  Take the values ‚Äã‚Äãof the BonusPercent column and cross out all NULL values: <br><br><img src="//habrastorage.org/files/d0a/8fb/8a0/d0a8fb8a0c97415f84f8427255aa2aae.png"><br><br>  There are 3 values ‚Äã‚Äãleft.  Those.  In expanded form, the sample can be represented as follows: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> BonusPercent <span class="hljs-comment"><span class="hljs-comment">-- 2.    FROM Employees WHERE BonusPercent IS NOT NULL -- 1.  NULL </span></span></code> </pre><br><br><img src="//habrastorage.org/files/a9b/fcc/f98/a9bfccf9895c413bad0ed7d33e4472ae.png"><br><br>  Since  we did not use the words DISTINCT, then recurring BonusPercent, if any, without considering BonusPercent equal NULL, will be counted.  For example, let's make a comparison of the result with and without DISTINCT.  For greater clarity, we use the values ‚Äã‚Äãof the DepartmentID field: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*), <span class="hljs-comment"><span class="hljs-comment">-- 6 COUNT(DISTINCT DepartmentID), -- 3 COUNT(DepartmentID) -- 5 FROM Employees</span></span></code> </pre><br><br><img src="//habrastorage.org/files/1da/2ae/6cc/1da2ae6cc55d433db25b5c983e12fbba.png"><br></td></tr><tr><td>  <b>MAX (BonusPercent)</b> - returns the maximum value of BonusPercent, again without taking into account NULL values. <br>  We take the values ‚Äã‚Äãof the BonusPercent column and look for the maximum value among them, we don‚Äôt pay attention to the NULL values: <br><br><img src="//habrastorage.org/files/044/793/950/044793950b4c4e89a3d9de564305bb46.png"><br><br>  Those.  we get the following value: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">1</span></span> BonusPercent <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> BonusPercent <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> BonusPercent <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-comment"><span class="hljs-comment">--   </span></span></code> </pre><br></td></tr><tr><td>  <b>MIN (BonusPercent)</b> - returns the minimum BonusPercent value, again without null values.  As in the case of MAX, we only look for the minimum value, ignoring NULL: <br><br><img src="//habrastorage.org/files/d23/31f/1aa/d2331f1aae564beaba2ea424cbf9c00a.png"><br><br>  Those.  we get the following value: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">1</span></span> BonusPercent <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> BonusPercent <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> BonusPercent <span class="hljs-comment"><span class="hljs-comment">--   </span></span></code> </pre><br><br>  Visual presentation of MIN (BonusPercent) and MAX (BonusPercent): <br><br><img src="//habrastorage.org/files/4b3/d30/8bb/4b3d308bb62c49b9b353e7558ec66577.png"><br></td></tr><tr><td>  <b>SUM (Salary / 100 * BonusPercent)</b> - returns the sum of all non-NULL values.  Parse the values ‚Äã‚Äãof the expression (Salary / 100 * BonusPercent): <br><br><img src="//habrastorage.org/files/a91/b84/796/a91b847962b94ae992cbe9f623f4d441.png"><br><br>  Those.  the following values ‚Äã‚Äãare summed up: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> Salary/<span class="hljs-number"><span class="hljs-number">100</span></span>*BonusPercent <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> Salary/<span class="hljs-number"><span class="hljs-number">100</span></span>*BonusPercent <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span></code> </pre><br><br><img src="//habrastorage.org/files/114/924/46e/11492446e1a84f74b3c28b77e76373da.png"><br></td></tr><tr><td>  <b>AVG (Salary / 100 * BonusPercent)</b> - returns the average of the values.  NULL expressions are not taken into account, i.e.  this corresponds to the second expression: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(Salary/<span class="hljs-number"><span class="hljs-number">100</span></span>*BonusPercent), <span class="hljs-comment"><span class="hljs-comment">-- 1108.33333333333 SUM(Salary/100*BonusPercent)/COUNT(Salary/100*BonusPercent), -- 1108.33333333333 SUM(Salary/100*BonusPercent)/COUNT(*) -- 554.166666666667 FROM Employees</span></span></code> </pre><br><br><img src="//habrastorage.org/files/8f2/804/4af/8f28044af89348a693350918fe608c55.png"><br><br>  Those.  again, NULL values ‚Äã‚Äãare not taken into account when counting quantities. <br><br>  If you need to calculate the average for all employees, as in the third expression, which gives 554.166666666667, then use the preliminary conversion of NULL values ‚Äã‚Äãto zero: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>(Salary/<span class="hljs-number"><span class="hljs-number">100</span></span>*BonusPercent,<span class="hljs-number"><span class="hljs-number">0</span></span>)), <span class="hljs-comment"><span class="hljs-comment">-- 554.166666666667 SUM(Salary/100*BonusPercent)/COUNT(*) -- 554.166666666667 FROM Employees</span></span></code> </pre><br></td></tr><tr><td>  <b>AVG (Salary)</b> - in fact, here everything is the same as in the previous case, i.e.  if the Salary employee is NULL, then he will not be taken into account.  To account for all employees, respectively, do a preliminary conversion of NULL AVG values ‚Äã‚Äã(ISNULL (Salary, 0)) <br></td></tr></tbody></table><br>  Let's summarize some results: <br><ul><li>  COUNT (*) - used to count the total number of rows that are received by the operator "SELECT ... WHERE ..." </li><li>  in all other above-mentioned aggregate functions when calculating the total, NULL values ‚Äã‚Äãare not taken into account </li><li>  if we need to take into account all the lines, this is more relevant for the AVG function, then it is first necessary to process NULL values, for example, as shown above ‚ÄúAVG (ISNULL (Salary, 0))‚Äù </li></ul><br><br>  Accordingly, when specifying the additional condition in the WHERE block with the aggregate functions, only the totals that satisfy the condition in the rows will be calculated.  Those.  aggregate values ‚Äã‚Äãare calculated for the result set, which is obtained using the SELECT clause.  For example, let's do the same thing, but only in the context of the IT department: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) [ - ], <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> DepartmentID) [  ], <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> PositionID) [  ], <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(BonusPercent) [-     % ], <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(BonusPercent) [  ], <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(BonusPercent) [  ], <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(Salary/<span class="hljs-number"><span class="hljs-number">100</span></span>*BonusPercent) [  ], <span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(Salary/<span class="hljs-number"><span class="hljs-number">100</span></span>*BonusPercent) [  ], <span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(Salary) [  ] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> DepartmentID=<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-comment"><span class="hljs-comment">--   -</span></span></code> </pre><br><table><tbody><tr><th>  Total number of employees </th><th>  The number of unique departments </th><th>  The number of unique posts </th><th>  Number of employees who have% bonus </th><th>  Maximum bonus percentage </th><th>  Min Bonus Percentage </th><th>  The sum of all bonuses </th><th>  Average bonus size </th><th>  Average size of salary </th></tr><tr><td>  3 </td><td>  one </td><td>  2 </td><td>  2 </td><td>  thirty </td><td>  15 </td><td>  825 </td><td>  412.5 </td><td>  1666.66666666667 </td></tr></tbody></table><br>  I suggest you, for a greater understanding of the work of aggregate functions, to independently analyze each obtained value.  Calculations here are, respectively, for detailed data received by the query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DepartmentID, PositionID, BonusPercent, Salary/<span class="hljs-number"><span class="hljs-number">100</span></span>*BonusPercent [Salary/<span class="hljs-number"><span class="hljs-number">100</span></span>*BonusPercent], Salary <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> DepartmentID=<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-comment"><span class="hljs-comment">--   -</span></span></code> </pre><br><table><tbody><tr><th>  DepartmentID </th><th>  PositionID </th><th>  BonusPercent </th><th>  Salary / 100 * BonusPercent </th><th>  Salary </th></tr><tr><td>  3 </td><td>  3 </td><td>  15 </td><td>  225 </td><td>  1500 </td></tr><tr><td>  3 </td><td>  four </td><td>  thirty </td><td>  600 </td><td>  2000 </td></tr><tr><td>  3 </td><td>  3 </td><td>  Null </td><td>  Null </td><td>  1500 </td></tr></tbody></table><br><br>  Go ahead.  If the aggregate function returns NULL (for example, all employees do not have the Salary value), or there are no records in the sample, and in the report, for such a case we need to show 0, then the ISNULL function can wrap the aggregate expression: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(Salary), <span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(Salary), <span class="hljs-comment"><span class="hljs-comment">--     ISNULL ISNULL(SUM(Salary),0), ISNULL(AVG(Salary),0) FROM Employees WHERE DepartmentID=10 --     ,     </span></span></code> </pre><br><table><tbody><tr><th>  (No column name) </th><th>  (No column name) </th><th>  (No column name) </th><th>  (No column name) </th></tr><tr><td>  Null </td><td>  Null </td><td>  0 </td><td>  0 </td></tr></tbody></table><br><br>  I believe that it is very important to understand the purpose of each aggregate function and how they calculate, because  in SQL, this is the main tool for calculating totals. <br><br>  In this case, we looked at how each aggregate function behaves independently, i.e.  it was applied to the values ‚Äã‚Äãof the entire record set obtained by the SELECT command.  Next, we consider how the same functions are used to calculate the totals by groups, using the GROUP BY construct. <br><br><h2>  GROUP BY - data grouping </h2><br>  Before that, we already calculated the totals for a specific department, approximately as follows: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> PositionID) PositionCount, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) EmplCount, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(Salary) SalaryAmount <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> DepartmentID=<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-comment"><span class="hljs-comment">--     </span></span></code> </pre><br><br>  Now imagine that we were asked to get the same figures in the context of each department.  Of course, we can roll up our sleeves and fulfill the same request for each department.  So, it is said, done, we write 4 requests: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> Info, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> PositionID) PositionCount, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) EmplCount, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(Salary) SalaryAmount <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> DepartmentID=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-comment"><span class="hljs-comment">--    SELECT '' Info, COUNT(DISTINCT PositionID) PositionCount, COUNT(*) EmplCount, SUM(Salary) SalaryAmount FROM Employees WHERE DepartmentID=2 --    SELECT '' Info, COUNT(DISTINCT PositionID) PositionCount, COUNT(*) EmplCount, SUM(Salary) SalaryAmount FROM Employees WHERE DepartmentID=3 --     SELECT '' Info, COUNT(DISTINCT PositionID) PositionCount, COUNT(*) EmplCount, SUM(Salary) SalaryAmount FROM Employees WHERE DepartmentID IS NULL --       </span></span></code> </pre><br><br>  As a result, we get 4 data sets: <br><br><img src="//habrastorage.org/files/129/493/3b5/1294933b5ce1440396a7c18fa3cdfd4a.png"><br><br>  Please note that we can use the fields defined in the form of constants - "Administration", "Accounting", ... <br><br>  In general, we extracted all the numbers we were asked for, merged everything into Excel and gave it to the director. <br><br>  The director liked the report and he says: ‚Äúadd another column with information on the average salary‚Äù.  And as always it needs to be done very urgently. <br><br>  Hmm, what to do?  In addition, let's imagine that we have not 3, but 15 departments. <br><br>  This is just what the GROUP BY construct is about for such cases: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DepartmentID, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> PositionID) PositionCount, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) EmplCount, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(Salary) SalaryAmount, <span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(Salary) SalaryAvg <span class="hljs-comment"><span class="hljs-comment">--     FROM Employees GROUP BY DepartmentID</span></span></code> </pre><br><table><tbody><tr><th>  DepartmentID </th><th>  Positioncount </th><th>  Emplcount </th><th>  Salaryamount </th><th>  SalaryAvg </th></tr><tr><td>  Null </td><td>  0 </td><td>  one </td><td>  2000 </td><td>  2000 </td></tr><tr><td>  one </td><td>  one </td><td>  one </td><td>  5000 </td><td>  5000 </td></tr><tr><td>  2 </td><td>  one </td><td>  one </td><td>  2500 </td><td>  2500 </td></tr><tr><td>  3 </td><td>  2 </td><td>  3 </td><td>  5000 </td><td>  1666.66666666667 </td></tr></tbody></table><br>  We got all the same data, but now using only one request! <br><br>  For now, do not pay attention, to the fact that the departments have been derived from us in the form of numbers, then we will learn to derive everything beautifully. <br><br>  In the GROUP BY clause, you can specify several fields ‚ÄúGROUP BY field1, field2, ..., fieldN‚Äù, in this case the grouping will occur into groups that form the values ‚Äã‚Äãof these fields ‚Äúfield1, field2, ..., fieldN‚Äù. <br><br>  For example, let's group the data in the context of Departments and Positions: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DepartmentID,PositionID, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) EmplCount, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(Salary) SalaryAmount <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> DepartmentID,PositionID</code> </pre><br><table><tbody><tr><th>  DepartmentID </th><th>  PositionID </th><th>  Emplcount </th><th>  Salaryamount </th></tr><tr><td>  Null </td><td>  Null </td><td>  one </td><td>  2000 </td></tr><tr><td>  2 </td><td>  one </td><td>  one </td><td>  2500 </td></tr><tr><td>  one </td><td>  2 </td><td>  one </td><td>  5000 </td></tr><tr><td>  3 </td><td>  3 </td><td>  2 </td><td>  3000 </td></tr><tr><td>  3 </td><td>  four </td><td>  one </td><td>  2000 </td></tr></tbody></table><br><br>  <b>Let's now on this example, try to figure out how GROUP BY works</b> <br><br>  For the fields listed after GROUP BY from the Employees table, all unique combinations are defined by the DepartmentID and PositionID values, i.e.  something like this happens: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> DepartmentID,PositionID <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees</code> </pre><br><table><tbody><tr><th>  DepartmentID </th><th>  PositionID </th></tr><tr><td>  Null </td><td>  Null </td></tr><tr><td>  one </td><td>  2 </td></tr><tr><td>  2 </td><td>  one </td></tr><tr><td>  3 </td><td>  3 </td></tr><tr><td>  3 </td><td>  four </td></tr></tbody></table><br>  Then jogging is done for each combination and calculations of aggregate functions are done: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) EmplCount, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(Salary) SalaryAmount <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> DepartmentID <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> PositionID <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) EmplCount, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(Salary) SalaryAmount <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> DepartmentID=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> PositionID=<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-comment"><span class="hljs-comment">-- ... SELECT COUNT(*) EmplCount, SUM(Salary) SalaryAmount FROM Employees WHERE DepartmentID=3 AND PositionID=4</span></span></code> </pre><br><br>  And then all these results are combined together and given to us in the form of one set: <br><br><img src="//habrastorage.org/files/62e/cbd/e60/62ecbde60c1c4776bee0f6f6293698eb.png"><br><br>  From the main, it is worth noting that in the case of grouping (GROUP BY), in the list of columns in the SELECT block: <br><ul><li>  We can only use the columns listed in the GROUP BY clause. </li><li>  You can use expressions with fields from the GROUP BY block. </li><li>  You can use constants, since  they do not affect the result of grouping </li><li>  All other fields (not listed in the GROUP BY clause) can only be used with aggregate functions (COUNT, SUM, MIN, MAX, ...) </li><li>  It is not necessary to list all the columns from the GROUP BY block in the list of SELECT columns. </li></ul><br><br>  And a demonstration of all the above: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> Const1, <span class="hljs-comment"><span class="hljs-comment">--     1 Const2, --     --        CONCAT(' ‚Ññ ',DepartmentID) ConstAndGroupField, CONCAT(' ‚Ññ ',DepartmentID,',  ‚Ññ ',PositionID) ConstAndGroupFields, DepartmentID, --        -- PositionID, --    ,     COUNT(*) EmplCount, -- -     --        : COUNT, SUM, MIN, MAX, ‚Ä¶ SUM(Salary) SalaryAmount, MIN(ID) MinID FROM Employees GROUP BY DepartmentID,PositionID --    DepartmentID,PositionID</span></span></code> </pre><br><table><tbody><tr><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Const1 </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Const2 </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ConstAndGroupField </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ConstAndGroupFields </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DepartmentID </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Emplcount </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Salaryamount </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MinID </font></font></th></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> String constant </font></font></td><td>  one </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Department number </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Department number, Position number </font></font></td><td>  Null </td><td>  one </td><td>  2000 </td><td>  1005 </td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> String constant </font></font></td><td>  one </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Department number 2 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Department number 2, Position number 1 </font></font></td><td>  2 </td><td>  one </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2500 </font></font></td><td>  1002 </td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> String constant </font></font></td><td>  one </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Department number 1 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Department number 1, Position number 2 </font></font></td><td>  one </td><td>  one </td><td>  5000 </td><td>  1000 </td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> String constant </font></font></td><td>  one </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Department number 3 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Department number 3, Position number 3 </font></font></td><td>  3 </td><td>  2 </td><td>  3000 </td><td>  1001 </td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> String constant </font></font></td><td>  one </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Department number 3 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Department number 3, Position number 4 </font></font></td><td>  3 </td><td>  one </td><td>  2000 </td><td>  1003 </td></tr></tbody></table><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is also worth noting that grouping can be done not only by fields, but also by expressions. </font><font style="vertical-align: inherit;">For example, group the data by employee, by year of birth:</font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">'  - '</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">YEAR</span></span>(Birthday)) YearOfBirthday, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) EmplCount <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">YEAR</span></span>(Birthday)</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consider an example with a more complex expression. </font><font style="vertical-align: inherit;">For example, we get the gradation of employees by year of birth:</font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">YEAR</span></span>(Birthday)&gt;=<span class="hljs-number"><span class="hljs-number">2000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' 2000'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">YEAR</span></span>(Birthday)&gt;=<span class="hljs-number"><span class="hljs-number">1990</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'1999-1990'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">YEAR</span></span>(Birthday)&gt;=<span class="hljs-number"><span class="hljs-number">1980</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'1989-1980'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">YEAR</span></span>(Birthday)&gt;=<span class="hljs-number"><span class="hljs-number">1970</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'1979-1970'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> Birthday <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' 1970'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> RangeName, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) EmplCount <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">YEAR</span></span>(Birthday)&gt;=<span class="hljs-number"><span class="hljs-number">2000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' 2000'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">YEAR</span></span>(Birthday)&gt;=<span class="hljs-number"><span class="hljs-number">1990</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'1999-1990'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">YEAR</span></span>(Birthday)&gt;=<span class="hljs-number"><span class="hljs-number">1980</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'1989-1980'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">YEAR</span></span>(Birthday)&gt;=<span class="hljs-number"><span class="hljs-number">1970</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'1979-1970'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> Birthday <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' 1970'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br><table><tbody><tr><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> RangeName </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Emplcount </font></font></th></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1979-1970 </font></font></td><td>  one </td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1989-1980 </font></font></td><td>  2 </td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> not specified </font></font></td><td>  2 </td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> earlier 1970 </font></font></td><td>  one </td></tr></tbody></table><br>  Those.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in this case, the grouping is done according to a previously calculated CASE-expression for each employee: </font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">YEAR</span></span>(Birthday)&gt;=<span class="hljs-number"><span class="hljs-number">2000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' 2000'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">YEAR</span></span>(Birthday)&gt;=<span class="hljs-number"><span class="hljs-number">1990</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'1999-1990'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">YEAR</span></span>(Birthday)&gt;=<span class="hljs-number"><span class="hljs-number">1980</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'1989-1980'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">YEAR</span></span>(Birthday)&gt;=<span class="hljs-number"><span class="hljs-number">1970</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'1979-1970'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> Birthday <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' 1970'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees</code> </pre><br><br><img src="//habrastorage.org/files/eb1/551/12f/eb155112f18e4b3cae2af6aedb976cbc.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And of course you can combine expressions with fields in the GROUP BY block: </font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DepartmentID, <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">'  - '</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">YEAR</span></span>(Birthday)) YearOfBirthday, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) EmplCount <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">YEAR</span></span>(Birthday),DepartmentID <span class="hljs-comment"><span class="hljs-comment">--           SELECT ORDER BY DepartmentID,YearOfBirthday --       </span></span></code> </pre><br><br>     .    ,    ,       ,       . ,      Excel      ,  ,     ,    : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> DepartmentID <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> Info, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> PositionID) PositionCount, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) EmplCount, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(Salary) SalaryAmount, <span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(Salary) SalaryAvg <span class="hljs-comment"><span class="hljs-comment">--     FROM Employees GROUP BY DepartmentID ORDER BY Info --        Info</span></span></code> </pre><br><table><tbody><tr><th>  Info </th><th> PositionCount </th><th> EmplCount </th><th> SalaryAmount </th><th> SalaryAvg </th></tr><tr><td>  Administration </td><td>  one </td><td>  one </td><td>  5000 </td><td>  5000 </td></tr><tr><td>  Accounting </td><td>  one </td><td>  one </td><td> 2500 </td><td> 2500 </td></tr><tr><td>  IT </td><td>  2 </td><td>  3 </td><td>  5000 </td><td> 1666.66666666667 </td></tr><tr><td>  Other </td><td>  0 </td><td>  one </td><td>  2000 </td><td>  2000 </td></tr></tbody></table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Although from the side it may look scary, but still it is better than it was originally. The disadvantage is that if they start a new department and its employees, then we will need to add CASE to prevent the employees of the new department from falling into the ‚ÄúOthers‚Äù group. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But nothing, over time, we will learn to do everything beautifully so that the sample does not depend on the appearance of new data in the database, but is dynamic. A little ahead, to show to write what requests we are striving to come:</font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>(dep.Name,<span class="hljs-string"><span class="hljs-string">''</span></span>) DepName, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> emp.PositionID) PositionCount, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) EmplCount, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(emp.Salary) SalaryAmount, <span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(emp.Salary) SalaryAvg <span class="hljs-comment"><span class="hljs-comment">--     FROM Employees emp LEFT JOIN Departments dep ON emp.DepartmentID=dep.ID GROUP BY emp.DepartmentID,dep.Name ORDER BY DepName</span></span></code> </pre><br><br>  ,   ‚Äì    .        GROUP BY. <br><br> ,           GROUP BY. <br><br>     ,   ,       ,      : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DepartmentID, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> PositionID=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> Salary <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) [], <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> PositionID=<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> Salary <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) [], <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> PositionID=<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> Salary <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) [], <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> PositionID=<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> Salary <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) [ ], <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(Salary) [  ] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> DepartmentID</code> </pre><br><table><tbody><tr><th> DepartmentID </th><th>  </th><th>  </th><th>  Programmers </th><th>   </th><th>    </th></tr><tr><td>  Null </td><td>  Null </td><td>  Null </td><td>  Null </td><td>  Null </td><td>  2000 </td></tr><tr><td>  one </td><td>  Null </td><td>  5000 </td><td>  Null </td><td>  Null </td><td>  5000 </td></tr><tr><td>  2 </td><td> 2500 </td><td>  Null </td><td>  Null </td><td>  Null </td><td> 2500 </td></tr><tr><td>  3 </td><td>  Null </td><td>  Null </td><td>  3000 </td><td>  2000 </td><td>  5000 </td></tr></tbody></table><br>  Those.         . <br><br>       IIF: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DepartmentID, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IIF</span></span>(PositionID=<span class="hljs-number"><span class="hljs-number">1</span></span>,Salary,<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)) [], <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IIF</span></span>(PositionID=<span class="hljs-number"><span class="hljs-number">2</span></span>,Salary,<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)) [], <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IIF</span></span>(PositionID=<span class="hljs-number"><span class="hljs-number">3</span></span>,Salary,<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)) [], <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IIF</span></span>(PositionID=<span class="hljs-number"><span class="hljs-number">4</span></span>,Salary,<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)) [ ], <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(Salary) [  ] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> DepartmentID</code> </pre><br><br>     IIF     NULL,      . <br><br>        CASE   ELSE,     NULL.     ,    . <br><br>   ,         NULL . <br><br>  ,        : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DepartmentID, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> PositionID=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> Salary <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> [], <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> PositionID=<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> Salary <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> [], <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> PositionID=<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> Salary <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> [], <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> PositionID=<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> Salary <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> [ ], Salary [  ] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees</code> </pre><br><table><tbody><tr><th> DepartmentID </th><th>  </th><th>  </th><th>  Programmers </th><th>   </th><th>    </th></tr><tr><td>  one </td><td>  Null </td><td>  5000 </td><td>  Null </td><td>  Null </td><td>  5000 </td></tr><tr><td>  3 </td><td>  Null </td><td>  Null </td><td>  1500 </td><td>  Null </td><td>  1500 </td></tr><tr><td>  2 </td><td> 2500 </td><td>  Null </td><td>  Null </td><td>  Null </td><td> 2500 </td></tr><tr><td>  3 </td><td>  Null </td><td>  Null </td><td>  Null </td><td>  2000 </td><td>  2000 </td></tr><tr><td>  3 </td><td>  Null </td><td>  Null </td><td>  1500 </td><td>  Null </td><td>  1500 </td></tr><tr><td>  Null </td><td>  Null </td><td>  Null </td><td>  Null </td><td>  Null </td><td>  2000 </td></tr></tbody></table><br><br>    ,    NULL    ,     ,   .  For example: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DepartmentID, <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IIF</span></span>(PositionID=<span class="hljs-number"><span class="hljs-number">1</span></span>,Salary,<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)),<span class="hljs-number"><span class="hljs-number">0</span></span>) [], <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IIF</span></span>(PositionID=<span class="hljs-number"><span class="hljs-number">2</span></span>,Salary,<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)),<span class="hljs-number"><span class="hljs-number">0</span></span>) [], <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IIF</span></span>(PositionID=<span class="hljs-number"><span class="hljs-number">3</span></span>,Salary,<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)),<span class="hljs-number"><span class="hljs-number">0</span></span>) [], <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IIF</span></span>(PositionID=<span class="hljs-number"><span class="hljs-number">4</span></span>,Salary,<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)),<span class="hljs-number"><span class="hljs-number">0</span></span>) [ ], <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(Salary),<span class="hljs-number"><span class="hljs-number">0</span></span>) [  ] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> DepartmentID</code> </pre><br><table><tbody><tr><th> DepartmentID </th><th>  </th><th>  </th><th>  Programmers </th><th>   </th><th>    </th></tr><tr><td>  Null </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  2000 </td></tr><tr><td>  one </td><td>  0 </td><td>  5000 </td><td>  0 </td><td>  0 </td><td>  5000 </td></tr><tr><td>  2 </td><td> 2500 </td><td>  0 </td><td>  0 </td><td>  0 </td><td> 2500 </td></tr><tr><td>  3 </td><td>  0 </td><td>  0 </td><td>  3000 </td><td>  2000 </td><td>  5000 </td></tr></tbody></table><br>    ,  : <br><ul><li>      , ,   CASE  DepartmentID   SELECT </li><li>        ORDER BY </li></ul><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GROUP BY, mean with aggregate functions, is one of the fixed assets used to obtain summary data from the database, because data is usually used in this form, because usually we are required to provide summary reports, rather than detailed data (sheets). And of course, it all revolves around the knowledge of the basic design, because Before you summarize (aggregate) something, you first need to select it correctly, using "SELECT ... WHERE ...". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Practice has an important place here, so if you set a goal to understand the SQL language, do not learn, but understand - practice, practice and practice, going through the most varied options that you can think of.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At the initial pores, if you are not sure of the correctness of the aggregated data obtained, make a detailed sample, including all the values ‚Äã‚Äãfor which the aggregation takes place. </font><font style="vertical-align: inherit;">And check the correctness of the calculations manually for these detailed data. </font><font style="vertical-align: inherit;">In this case, using Excel can help a lot.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Let's say you got to this point </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suppose you are an accountant Sidorov S.S., who decided to learn how to write SELECT queries. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assume that you have already finished reading this textbook up to this point, and are already confident in using all the above basic structures, i.e. </font><font style="vertical-align: inherit;">you can:</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Select detailed data for the WHERE clause from a single table </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Know how to use aggregate functions and grouping from one table. </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since at work they thought that you already knew everything, you were given access to the database (and this sometimes happens), and now you have developed and pulled out that same weekly report for the director. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yes, but they did not take into account that you are not yet able to build queries from several tables, but only from one, i.e. </font><font style="vertical-align: inherit;">you can't do something like this:</font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> emp.*, <span class="hljs-comment"><span class="hljs-comment">--     Employees dep.Name DepartmentName, --      Name   Departments pos.Name PositionName --     Name   Positions FROM Employees emp LEFT JOIN Departments dep ON emp.DepartmentID=dep.ID LEFT JOIN Positions pos ON emp.PositionID=pos.ID</span></span></code> </pre><br><table><tbody><tr><th>  ID </th><th>  Name </th><th>  Birthday </th><th>  ... </th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Salary </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> BonusPercent </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DepartmentName </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PositionName </font></font></th></tr><tr><td>  1000 </td><td>  Ivanov I.I. </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 02/19/1955 </font></font></td><td></td><td>  5000 </td><td>  50 </td><td>  Administration </td><td>  Director </td></tr><tr><td>  1001 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Petrov P.P. </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 12/03/1983 </font></font></td><td></td><td>  1500 </td><td>  15 </td><td>  IT </td><td>  Programmer </td></tr><tr><td>  1002 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sidorov S.S. </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 06/07/1976 </font></font></td><td></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2500 </font></font></td><td>  Null </td><td>  Accounting </td><td>  Accountant </td></tr><tr><td>  1003 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Andreev A.A. </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 04/17/1982 </font></font></td><td></td><td>  2000 </td><td>  thirty </td><td>  IT </td><td>  Senior programmer </td></tr><tr><td>  1004 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nikolaev N.N. </font></font></td><td>  Null </td><td></td><td>  1500 </td><td>  Null </td><td>  IT </td><td>  Programmer </td></tr><tr><td>  1005 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Aleksandrov A.A. </font></font></td><td>  Null </td><td></td><td>  2000 </td><td>  Null </td><td>  Null </td><td>  Null </td></tr></tbody></table><br>   ,     , ,  ,  ,    . <br><br>  ,               ?!     ‚Äì   ,    , ..   ..,  ..   ..,   -       (VIEW   ¬´¬ª,   , ,   ),       Employees,      ¬´ ¬ª  ¬´ ¬ª,        ,     .. <br><br>  Since    ,  -,   ,      ,   ,    ViewEmployeesInfo. <br><br> ,      , ..   -: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> ViewEmployeesInfo <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> emp.*, <span class="hljs-comment"><span class="hljs-comment">--     Employees dep.Name DepartmentName, --      Name   Departments pos.Name PositionName --     Name   Positions FROM Employees emp LEFT JOIN Departments dep ON emp.DepartmentID=dep.ID LEFT JOIN Positions pos ON emp.PositionID=pos.ID</span></span></code> </pre><br><br>  Those.    ,    ,    ,  -      ¬´ViewEmployeesInfo¬ª,      (..      ). <br><br>       ,    : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ViewEmployeesInfo</code> </pre><br><table><tbody><tr><th>  ID </th><th>  Name </th><th>  Birthday </th><th>  ... </th><th> Salary </th><th> BonusPercent </th><th> DepartmentName </th><th> PositionName </th></tr><tr><td>  1000 </td><td>  Ivanov I.I. </td><td> 19.02.1955 </td><td></td><td>  5000 </td><td>  50 </td><td>  Administration </td><td>  Director </td></tr><tr><td>  1001 </td><td>  .. </td><td> 03.12.1983 </td><td></td><td>  1500 </td><td>  15 </td><td>  IT </td><td>  Programmer </td></tr><tr><td>  1002 </td><td>  .. </td><td> 07.06.1976 </td><td></td><td> 2500 </td><td>  Null </td><td>  Accounting </td><td>  Accountant </td></tr><tr><td>  1003 </td><td>  .. </td><td> 17.04.1982 </td><td></td><td>  2000 </td><td>  thirty </td><td>  IT </td><td>  Senior programmer </td></tr><tr><td>  1004 </td><td>  .. </td><td>  Null </td><td></td><td>  1500 </td><td>  Null </td><td>  IT </td><td>  Programmer </td></tr><tr><td>  1005 </td><td>  .. </td><td>  Null </td><td></td><td>  2000 </td><td>  Null </td><td>  Null </td><td>  Null </td></tr></tbody></table><br>  Since          ¬´¬ª (- ),         : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DepartmentName, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> PositionID) PositionCount, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) EmplCount, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(Salary) SalaryAmount, <span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(Salary) SalaryAvg <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ViewEmployeesInfo emp <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> DepartmentID,DepartmentName <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> DepartmentName</code> </pre><br><table><tbody><tr><th> DepartmentName </th><th> PositionCount </th><th> EmplCount </th><th> SalaryAmount </th><th> SalaryAvg </th></tr><tr><td>  Null </td><td>  0 </td><td>  one </td><td>  2000 </td><td>  2000 </td></tr><tr><td>  Administration </td><td>  one </td><td>  one </td><td>  5000 </td><td>  5000 </td></tr><tr><td>  Accounting </td><td>  one </td><td>  one </td><td> 2500 </td><td> 2500 </td></tr><tr><td>  IT </td><td>  2 </td><td>  3 </td><td>  5000 </td><td> 1666.66666666667 </td></tr></tbody></table><br>      ,       ,          , ..      ,            . <br><br>  Those.     ,      ,         (      ViewEmployeesInfo),      .   -,    DepartmentName  PositionName      .  Those.      ,    , ,      Employees. <br><br>      ,   ,         (      ): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>, Salary <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ViewEmployeesInfo <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> Salary <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> Salary&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span></code> </pre><br><table><tbody><tr><th>  ID </th><th>  Name </th><th> Salary </th></tr><tr><td>  1005 </td><td>  .. </td><td>  2000 </td></tr><tr><td>  1003 </td><td>  .. </td><td>  2000 </td></tr><tr><td>  1000 </td><td>  Ivanov I.I. </td><td>  5000 </td></tr><tr><td>  1004 </td><td>  .. </td><td>  1500 </td></tr><tr><td>  1001 </td><td>  .. </td><td>  1500 </td></tr><tr><td>  1002 </td><td>  .. </td><td> 2500 </td></tr></tbody></table><br> ,     . <br><br>     ,      ,    SELECT-.    ,          ( ,    OLAP,       OLAP-    ). <br><br><blockquote> <b>  .</b>  SQL       ,       ,     . <br></blockquote><br><br>  ,  ,  SQL  ,    .  ,      ,   . <br><br><h2> HAVING ‚Äì       </h2><br> ,   ,   ,   HAVING   . HAVING ‚Äì -  WHERE,   WHERE-    ,  HAVING-     .       HAVING       ,   ,  ,    . <br><br>  Consider an example: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DepartmentID, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(Salary) SalaryAmount <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> DepartmentID <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(Salary)&gt;<span class="hljs-number"><span class="hljs-number">3000</span></span></code> </pre><br><table><tbody><tr><th> DepartmentID </th><th> SalaryAmount </th></tr><tr><td>  one </td><td>  5000 </td></tr><tr><td>  3 </td><td>  5000 </td></tr></tbody></table><br>  Those.          ,        3000, .. ¬´SUM(Salary)&gt;3000¬ª. <br><br><img src="//habrastorage.org/files/641/41f/486/64141f48626c4bed864161ea57fb5044.png"><br><br>  Those.            : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DepartmentID, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(Salary) SalaryAmount <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> DepartmentID <span class="hljs-comment"><span class="hljs-comment">-- 1.      </span></span></code> </pre><br><br>           HAVING: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DepartmentID, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(Salary) SalaryAmount <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> DepartmentID <span class="hljs-comment"><span class="hljs-comment">-- 1.       HAVING SUM(Salary)&gt;3000 -- 2.     </span></span></code> </pre><br><br>  HAVING-         AND, OR  NOT: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DepartmentID, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(Salary) SalaryAmount <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> DepartmentID <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(Salary)&gt;<span class="hljs-number"><span class="hljs-number">3000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*)&lt;<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-comment"><span class="hljs-comment">--     2-</span></span></code> </pre><br><br><img src="//habrastorage.org/files/01f/432/cfa/01f432cfaa164c54a9f37ddd85ddafe2.png"><br><br>       (. ¬´COUNT(*)¬ª)       HAVING. <br><br>       ,   HAVING-: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DepartmentID <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> DepartmentID <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(Salary)&gt;<span class="hljs-number"><span class="hljs-number">3000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*)&lt;<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-comment"><span class="hljs-comment">--     2-</span></span></code> </pre><br><br>   HAVING-     GROUP BY: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DepartmentID, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(Salary) SalaryAmount <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> DepartmentID <span class="hljs-comment"><span class="hljs-comment">-- 1.   HAVING DepartmentID=3 -- 2.     </span></span></code> </pre><br><br>   , ..          WHERE-: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DepartmentID, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(Salary) SalaryAmount <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Employees <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> DepartmentID=<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-comment"><span class="hljs-comment">-- 1.     GROUP BY DepartmentID -- 2.      </span></span></code> </pre><br><br>  Those.      3,     . <br><br><blockquote>  <b>Note.</b>   ,   ,      -      . </blockquote><br><br> ,     HAVING-  . <br><br><h2>  Let's sum up </h2><br>                     : <br><table><tbody><tr><th> / </th><th>  Execution order </th><th>   </th></tr><tr><td> SELECT   </td><td>  four </td><td>     </td></tr><tr><td> FROM  </td><td>  0 </td><td>         </td></tr><tr><td> WHERE     </td><td>  one </td><td>   ,    </td></tr><tr><td> GROUP BY   </td><td>  2 </td><td>      .      ,   SELECT  HAVING  </td></tr><tr><td> HAVING     </td><td>  3 </td><td> ,     </td></tr><tr><td> ORDER BY    </td><td>  five </td><td>      </td></tr></tbody></table><br><br>  ,          DISTINCT  TOP,    . <br><br>         : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-comment"><span class="hljs-comment">-- 6.     SUM(Salary) SalaryAmount FROM Employees GROUP BY DepartmentID HAVING SUM(Salary)&gt;3000 ORDER BY DepartmentID -- 5.  </span></span></code> </pre><br><table><tbody><tr><th> SalaryAmount </th></tr><tr><td>  5000 </td></tr></tbody></table><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> <span class="hljs-comment"><span class="hljs-comment">--     SalaryAmount SUM(Salary) SalaryAmount FROM Employees GROUP BY DepartmentID</span></span></code> </pre><br><table><tbody><tr><th> SalaryAmount </th></tr><tr><td>  2000 </td></tr><tr><td> 2500 </td></tr><tr><td>  5000 </td></tr></tbody></table><br><br>      . <br><br><h2>  Conclusion </h2><br>         ‚Äì        . <br><br>         ,          ,        .  ,     , ..     ‚Äì       , ,   ,      . <br><br>       ,              .     (        )            .    SELECT          (     , ,    ‚Äì    , ,  ..). <br><br>  ,             SQL,  : <br><ul><li> GROUP BY ROLLUP(‚Ä¶), GROUP BY GROUPING SETS(‚Ä¶), ‚Ä¶ </li><li> PIVOT, UNPIVOT </li><li>  etc. </li></ul><br>           , ..    ,      SQL,       .   SQL      -   , ..        (         ). <br><br>       SQL,     ,     , ..  ,       ,     .    ,        SQL, ..         .        ‚Äì     ,        () . <br><br>        SQL. <br><br>  Part Four - <a href="http://habrahabr.ru/post/256045/">habrahabr.ru/post/256045</a> </div><p>Source: <a href="https://habr.com/ru/post/255825/">https://habr.com/ru/post/255825/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../255815/index.html">Centralized collection of Windows event logs, without installing an agent, followed by visualization using ELK</a></li>
<li><a href="../255817/index.html">Unlock Open Source 2GIS</a></li>
<li><a href="../255819/index.html">How-to: Rules for the layout of email-letters</a></li>
<li><a href="../255821/index.html">How a hybrid cloud works using VMware vCloud Connector</a></li>
<li><a href="../255823/index.html">Laboratory penetration testing "Test lab v.7". Challenge thrown</a></li>
<li><a href="../255827/index.html">3D MC3 Wizard v1.1 or how I assembled my first 3D printer</a></li>
<li><a href="../255829/index.html">Spring + Hibernate for beginners</a></li>
<li><a href="../255831/index.html">Free VID PID pairs for open source projects</a></li>
<li><a href="../255833/index.html">Multiuser chat using WebRTC</a></li>
<li><a href="../255835/index.html">Zhelezyachniki vs. Programmers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>