<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>EntityFramework: (anti) Repository pattern</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The repository is an intermediary between the data access layer and the domain layer, 
 working as an in-memory collection of domain objects. Clients ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>EntityFramework: (anti) Repository pattern</h1><div class="post__text post__text-html js-mediator-article"><img alt="Repository Pattern" width="564" height="182" src="https://habrastorage.org/web/c61/ec9/a6f/c61ec9a6f1cf4178b76f23f1e8a26cec.png"><br><blockquote>  The repository is an intermediary between the data access layer and the domain layer, <br>  working as an in-memory collection of domain objects.  Clients create declarative <br>  descriptions of requests and transfer them to the repository for execution. <br>  - free translation by Martin Fowler </blockquote><p>EntityFraemwork      Repository: <strong><code>DbSet&lt;T&gt;</code></strong>  UnitOfWork: <strong><code>DbContext</code></strong>.     ,             EntityFraemwork.</p><br>
<p>      :</p><br>
<ol>
<li>Generic Repository      ORM.</li>
<li>Repository        ( DAO).</li>
</ol><br>
<p>      .</p><a name="habracut"></a><br>
<h2 id="generic-repository">Generic Repository</h2><br>
<p>       : "     ORM?".       : "   Generic Repository,            ".</p><br>
<p>       ,   <strong></strong>,  <strong></strong>  <strong></strong> API  ORM   ,  " " API  .</p><br>
<p>    :</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IRepository</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt;
{
 &nbsp; &nbsp;<span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span>;
 &nbsp; &nbsp;<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T entity</span></span></span><span class="hljs-function">)</span></span>;
 &nbsp; &nbsp;<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Remove</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T entity</span></span></span><span class="hljs-function">)</span></span>;
 &nbsp; &nbsp;<span class="hljs-function"><span class="hljs-function">IEnumerable&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAll</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>;

 &nbsp; &nbsp;<span class="hljs-comment"><span class="hljs-comment">// + -   </span></span>
 &nbsp; &nbsp;<span class="hljs-function"><span class="hljs-function">IEnumerable&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Filter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ICriteria&lt;T&gt; criteria</span></span></span><span class="hljs-function">)</span></span>;
 &nbsp; &nbsp;<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Load</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T entity, Expression&lt;Func&lt;T, TProperty&gt;&gt; property</span></span></span><span class="hljs-function">)</span></span>;
}</code></pre><br>
<p>     ORM,    .</p><br>
<p>   ‚Äì !  ,    -      ORM?      ORM       -,  -  ,   ORM  " ".</p><br>
<p>,    ,           .</p><br>
<p> ,   Generic Repository :</p><br>
<ol>
<li>  .</li>
<li> .</li>
<li>      ORM.</li>
<li>    ORM.</li>
<li>       .</li>
<li>   ,          ORM.</li>
<li>    ORM   .    !</li>
<li> ,          .</li>
</ol><br>
<p>   ,      .         ORM,       .    <a href="https://aspnetboilerplate.com/">ASP.NET Boilerplate</a>.  <a href="https://aspnetboilerplate.com/Pages/Documents/Repositories">Repository</a>     <a href="https://aspnetboilerplate.com/Pages/Documents">  </a>.</p><br>
<p>     .  <strong><code>IDbSet&lt;T&gt;</code></strong>     CRUD .       (  )     <strong><code>IQueryable&lt;T&gt;</code></strong>.</p><br>
<h2 id="repository-kak-nabor-zaprosov">Repository   </h2><br>
<p>        ‚Äî Data Access Object.          .     CRUD-  : <strong><code>GetByLogin()</code></strong>, <strong><code>GetByName()</code></strong>, etc.</p><br>
<p>  ,    .     .  . ,    ,   .     .       .</p><br>
<p>  ,    ,   Data Transfer Object,    .   ,        ?   ,       ,     -,  SRP.</p><br>
<p>   ,  DAO    :</p><br>
<ul>
<li>  .</li>
</ul><br>
<p>  EF Core       in-memory <strong><code>DbContext</code></strong>.</p><br>
<ul>
<li>     .</li>
</ul><br>
<p>,      DAO:</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IPostsRepository</span></span>
{
    <span class="hljs-function"><span class="hljs-function">IEnumerable&lt;Post&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FilterByDate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DateTime date</span></span></span><span class="hljs-function">)</span></span>;
    <span class="hljs-function"><span class="hljs-function">IEnumerable&lt;Post&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FilterByTag</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> tag</span></span></span><span class="hljs-function">)</span></span>;
    <span class="hljs-function"><span class="hljs-function">IEnumerable&lt;Post&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FilterByDateAndTag</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DateTime date, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> tag</span></span></span><span class="hljs-function">)</span></span>;
}</code></pre><br>
<p>   <strong><code>FilterByDateAndTag()</code></strong>       .</p><br>
<h2 id="tak-chto-zhe-delat">   ?</h2><br>
<p>  <strong>Query Builder</strong>  <strong>Specification</strong>.</p><br>
<p>.NET     Query Builder: <strong><code>IQueryable&lt;T&gt;</code></strong>   - LINQ.</p><br>
<p>     .   , 80%  </p><br>
<ul>
<li>    id: <strong><code>context.Entities.Find(id)</code></strong>,</li>
<li>    :<br>
<strong><code>context.Entities.Where(e =&gt; e.Property == value)</code></strong>.</li>
</ul><br>
<p>  20%        -.        -.</p><br>
<p>           extension-  <strong><code>IQueryable&lt;T&gt;</code></strong>.    ‚Äî  .</p><br>
<h2 id="specification">Specification</h2><br>
<p>   -    ,     .  ,       .</p><br>
<p>     :</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ISpecification</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt;
{
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsSatisfiedBy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T entity</span></span></span><span class="hljs-function">)</span></span>;
}</code></pre><br>
<p>      <strong><code>IQueryable&lt;T&gt;</code></strong>.</p><br>
<p> LINQ to Entities     <strong><code>Expression&lt;Func&lt;T, bool&gt;&gt;</code></strong>.             LINQ to Objects.</p><br>
<p>   .   <strong><code>ToExpression()</code></strong>:</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ISpecification</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt;
{
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsSatisfiedBy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T entity</span></span></span><span class="hljs-function">)</span></span>;
    Expression&lt;Func&lt;T, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;&gt; ToExpression();
}</code></pre><br>
<p>   <strong><code>Specificaiton&lt;T&gt;</code></strong>:</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Specification</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">ISpecification</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt;
{
    <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Func&lt;T, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt; _function;

    <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Func&lt;T, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt; Function =&gt; _function
        ?? (_function = Predicate.Compile());

 &nbsp; &nbsp;<span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> Expression&lt;Func&lt;T, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;&gt; Predicate;

    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Specification</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { }

    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Specification</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Expression&lt;Func&lt;T, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;&gt; predicate</span></span></span><span class="hljs-function">)</span></span>
    {
        Predicate = predicate;
    }

    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsSatisfiedBy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T entity</span></span></span><span class="hljs-function">)</span></span>
    {
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Function.Invoke(entity);
    }

    <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Expression&lt;Func&lt;T, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;&gt; ToExpression()
    {
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Predicate;
    }
}</code></pre><br>
<p>      <strong>&amp;&amp;</strong>, <strong>||</strong>  <strong>!</strong>.       .  <a href="https://msdn.microsoft.com/en-us/library/aa691312(v%3Dvs.71).aspx">C# Language Specification [7.11.2]</a>,   : <strong>true</strong>, <strong>false</strong>, <strong>&amp;</strong>  <strong>|</strong>,   <strong>&amp;&amp;</strong>   <strong>&amp;</strong>,   <strong>||</strong>   <strong>|</strong>.</p><br>
<div class="spoiler"><b class="spoiler_title">Specification.cs</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> Func&lt;T, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;(Specification&lt;T&gt; spec)
{
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> spec.Function;
}

<span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> Expression&lt;Func&lt;T, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;&gt;(Specification&lt;T&gt; spec)
{
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> spec.Predicate;
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">operator</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">true</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Specification&lt;T&gt; spec</span></span></span><span class="hljs-function">)</span></span>
{
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">operator</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">false</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Specification&lt;T&gt; spec</span></span></span><span class="hljs-function">)</span></span>
{
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
}

<span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Specification&lt;T&gt; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> !(Specification&lt;T&gt; spec)
{
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Specification&lt;T&gt;(
        Expression.Lambda&lt;Func&lt;T, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;&gt;(
            Expression.Not(spec.Predicate.Body),
            spec.Predicate.Parameters));
}

<span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Specification&lt;T&gt; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> &amp;(Specification&lt;T&gt; left, Specification&lt;T&gt; right)
{
    <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> leftExpr = left.Predicate;
    <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rightExpr = right.Predicate;
    <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> leftParam = leftExpr.Parameters[<span class="hljs-number"><span class="hljs-number">0</span></span>];
    <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rightParam = rightExpr.Parameters[<span class="hljs-number"><span class="hljs-number">0</span></span>];

    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Specification&lt;T&gt;(
        Expression.Lambda&lt;Func&lt;T, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;&gt;(
            Expression.AndAlso(
                leftExpr.Body,
                <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ParameterReplacer(rightParam, leftParam).Visit(rightExpr.Body)),
            leftParam));
}

<span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Specification&lt;T&gt; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> |(Specification&lt;T&gt; left, Specification&lt;T&gt; right)
{
    <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> leftExpr = left.Predicate;
    <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rightExpr = right.Predicate;
    <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> leftParam = leftExpr.Parameters[<span class="hljs-number"><span class="hljs-number">0</span></span>];
    <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rightParam = rightExpr.Parameters[<span class="hljs-number"><span class="hljs-number">0</span></span>];

    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Specification&lt;T&gt;(
        Expression.Lambda&lt;Func&lt;T, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;&gt;(
            Expression.OrElse(
                leftExpr.Body,
                <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ParameterReplacer(rightParam, leftParam).Visit(rightExpr.Body)),
            leftParam));
}</code></pre></div></div><br>
<p>           <strong><code>ExpressionVisitor</code></strong>:</p><br>
<div class="spoiler"><b class="spoiler_title">ParameterReplacer.cs</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ParameterReplacer</span></span> : <span class="hljs-title"><span class="hljs-title">ExpressionVisitor</span></span>
{
    <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ParameterExpression _parameter;
    <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ParameterExpression _replacement;

    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ParameterReplacer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ParameterExpression parameter, ParameterExpression replacement</span></span></span><span class="hljs-function">)</span></span>
    {
        _parameter = parameter;
        _replacement = replacement;
    }

    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VisitParameter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ParameterExpression node</span></span></span><span class="hljs-function">)</span></span>
    {
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.VisitParameter(_parameter == node ? _replacement : node);
    }
}</code></pre></div></div><br>
<p>  <strong><code>Specification&lt;T&gt;</code></strong>  <strong><code>Expresison</code></strong>     :</p><br>
<div class="spoiler"><b class="spoiler_title">SpecificationExpander.cs</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SpecificationExpander</span></span> : <span class="hljs-title"><span class="hljs-title">ExpressionVisitor</span></span>
{
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VisitUnary</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">UnaryExpression node</span></span></span><span class="hljs-function">)</span></span>
    {
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.NodeType == ExpressionType.Convert)
        {
            MethodInfo method = node.Method;

            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (method != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; method.Name == <span class="hljs-string"><span class="hljs-string">"op_Implicit"</span></span>)
            {
                Type declaringType = method.DeclaringType;

                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (declaringType.GetTypeInfo().IsGenericType
                    &amp;&amp; declaringType.GetGenericTypeDefinition() == <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Specification&lt;&gt;))
                {
                    <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name = <span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(Specification&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;.ToExpression);

                    MethodInfo toExpression = declaringType.GetMethod(name);

                    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ExpandSpecification(node.Operand, toExpression);
                }
            }
        }

        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.VisitUnary(node);
    }

    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VisitMethodCall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MethodCallExpression node</span></span></span><span class="hljs-function">)</span></span>
    {
        MethodInfo method = node.Method;

        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (method.Name == <span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(ISpecification&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;.ToExpression))
        {
            Type declaringType = method.DeclaringType;
            Type[] interfaces = declaringType.GetTypeInfo().GetInterfaces();

            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (interfaces.Any(i =&gt; i.GetTypeInfo().IsGenericType
                &amp;&amp; i.GetGenericTypeDefinition() == <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ISpecification&lt;&gt;)))
            {
                <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ExpandSpecification(node.Object, method);
            }
        }

        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.VisitMethodCall(node);
    }

    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExpandSpecification</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Expression instance, MethodInfo toExpression</span></span></span><span class="hljs-function">)</span></span>
    {
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Visit((Expression)GetValue(Expression.Call(instance, toExpression)));
    }

    <span class="hljs-comment"><span class="hljs-comment">// http://stackoverflow.com/a/2616980/1402923</span></span>
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Expression expression</span></span></span><span class="hljs-function">)</span></span>
    {
        <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> objectMember = Expression.Convert(expression, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>));
        <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> getterLambda = Expression.Lambda&lt;Func&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;&gt;(objectMember);
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getterLambda.Compile().Invoke();
    }
}</code></pre></div></div><br>
<h3 id="teper-my-smozhem">  </h3><br>
<p>‚Äî   :</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UserIsActiveSpec</span></span> : <span class="hljs-title"><span class="hljs-title">Specification</span></span>&lt;<span class="hljs-title"><span class="hljs-title">User</span></span>&gt;
{
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UserIsActiveSpec</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>
    {
        Predicate = u =&gt; u.IsActive;
    }
}

<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> spec = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserIsActiveSpec();
<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User { IsActive = <span class="hljs-literal"><span class="hljs-literal">true</span></span> };

Assert.IsTrue(spec.IsSatisfiedBy(user));</code></pre><br>
<p>‚Äî   :</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UserByLoginSpec</span></span> : <span class="hljs-title"><span class="hljs-title">Specification</span></span>&lt;<span class="hljs-title"><span class="hljs-title">User</span></span>&gt;
{
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UserByLoginSpec</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> login</span></span></span><span class="hljs-function">)</span></span>
    {
        Predicate = u =&gt; u.Login == login;
    }
}

<span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UserCombinedSpec</span></span> : <span class="hljs-title"><span class="hljs-title">Specification</span></span>&lt;<span class="hljs-title"><span class="hljs-title">User</span></span>&gt;
{
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UserCombinedSpec</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> login</span></span></span><span class="hljs-function">)
        : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">new UserIsActive(</span></span></span><span class="hljs-function">) &amp;&amp; new </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UserByLogin</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">login</span></span></span><span class="hljs-function">))</span></span>
    {
    }
}</code></pre><br>
<p>‚Äî    LINQ to Entities:</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> spec = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserByLoginSpec(<span class="hljs-string"><span class="hljs-string">"admin"</span></span>);

context.Users.Where(spec.ToExpression());

<span class="hljs-comment"><span class="hljs-comment">//    (  implicit conversion  Expression)</span></span>
context.Uses.Where(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserByLoginSpec(<span class="hljs-string"><span class="hljs-string">"admin"</span></span>) || <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserByLoginSpec(<span class="hljs-string"><span class="hljs-string">"user"</span></span>));</code></pre><br>
<p>      ,      <a href="https://aspnetboilerplate.com/Pages/Documents/Specifications">Specification</a>  <a href="https://aspnetboilerplate.com/">ASP.NET Boilerplate</a>.   <a href="http://www.albahari.com/nutshell/predicatebuilder.aspx">PredicateBuilder</a>  <a href="http://www.albahari.com/nutshell/linqkit.aspx">LinqKit</a>.</p><br>
<h2 id="metody-rasshireniya-k-iqueryable">   IQueryable</h2><br>
<p>    -  <strong><code>IQueryable&lt;T&gt;</code></strong>. :</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IQueryable&lt;Post&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FilterByAuthor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">
    </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IQueryable&lt;Post&gt; posts, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> authorId</span></span></span><span class="hljs-function">)</span></span>
{
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> posts.Where(p =&gt; p.AuthorId = authorId);
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IQueryable&lt;Comment&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FilterTodayComments</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">
    </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IQueryable&lt;Comment&gt; comments</span></span></span><span class="hljs-function">)</span></span>
{
    DateTime today = DateTime.Now.Date;

    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> comments.Where(c =&gt; c.CreationTime &gt; today)
}

Comment[] comments = context.Posts
 &nbsp;  .FilterByAuthor(authorId) &nbsp; &nbsp;<span class="hljs-comment"><span class="hljs-comment">// it's OK</span></span>
 &nbsp;  .SelectMany(p =&gt; p.Comments
        .AsQueryable()
 &nbsp; &nbsp; &nbsp;  .FilterTodayComments()) &nbsp;<span class="hljs-comment"><span class="hljs-comment">// will throw Exception</span></span>
  &nbsp; .ToArray();</code></pre><br>
<p>   ,    extension-   ,      <strong><code>Exception</code></strong>.      Expression Tree   <strong><code>SelectMany()</code></strong>.  LINQ to Entities    .</p><br>
<p>  .    :</p><br>
<ul>
<li><strong><code>ExpressionVisitor</code></strong>,    extension-.</li>
<li>  <strong><code>IQueryable&lt;T&gt;</code></strong>,    <strong><code>ExpressionVisitor</code></strong>.</li>
<li>  <strong><code>AsExpandable()</code></strong>,   <strong><code>IQueryable&lt;T&gt;</code></strong>   .</li>
<li> <strong><code>[Expandable]</code></strong>,     extension-  .<br>
 <strong><code>Where()</code></strong>  <strong><code>Select()</code></strong>  extension-,     .</li>
</ul><br>
<pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">AttributeUsage(AttributeTargets.Method, AllowMultiple = false)</span></span>]
<span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ExpandableAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">Attribute</span></span> { }</code></pre><br>
<div class="spoiler"><b class="spoiler_title">QueryableExtensions.cs</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IQueryable&lt;T&gt; AsExpandable&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> IQueryable&lt;T&gt; queryable)
{
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> queryable.AsVisitable(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExtensionExpander());
}

<span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IQueryable&lt;T&gt; AsVisitable&lt;T&gt;(
    <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> IQueryable&lt;T&gt; queryable, <span class="hljs-keyword"><span class="hljs-keyword">params</span></span> ExpressionVisitor[] visitors)
{
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> queryable <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> VisitableQuery&lt;T&gt;
        ?? VisitableQueryFactory&lt;T&gt;.Create(queryable, visitors);
}</code></pre></div></div><br>
<p>     <strong><code>IQueryable&lt;T&gt;</code></strong>  <strong><code>IQueryProvider</code></strong>:</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IQueryable</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt;
{
    <span class="hljs-function"><span class="hljs-function">IEnumerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetEnumerator</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>;     <span class="hljs-comment"><span class="hljs-comment">// from IEnumerable</span></span>
    <span class="hljs-function"><span class="hljs-function">IEnumerator&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetEnumerator</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>;  <span class="hljs-comment"><span class="hljs-comment">// from IEnumerable&lt;T&gt;</span></span>
    Type ElementType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; }        <span class="hljs-comment"><span class="hljs-comment">// from IQueryable</span></span>
    Expression Expression { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; }   <span class="hljs-comment"><span class="hljs-comment">// from IQueryable</span></span>
    IQueryProvider Provider { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// from IQueryable</span></span>
}</code></pre><br>
<div class="spoiler"><b class="spoiler_title">VisitableQuery.cs</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">VisitableQuery</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">IQueryable</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">IOrderedQueryable</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">IOrderedQueryable</span></span>
{
    <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ExpressionVisitor[] _visitors;
    <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IQueryable&lt;T&gt; _queryable;
    <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> VisitableQueryProvider&lt;T&gt; _provider;

    <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> ExpressionVisitor[] Visitors =&gt; _visitors;
    <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> IQueryable&lt;T&gt; InnerQuery =&gt; _queryable;

    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VisitableQuery</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IQueryable&lt;T&gt; queryable, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">params</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ExpressionVisitor[] visitors</span></span></span><span class="hljs-function">)</span></span>
    {
        _queryable = queryable;
        _visitors = visitors;
        _provider = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VisitableQueryProvider&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>);
    }

    Expression IQueryable.Expression =&gt; _queryable.Expression;

    Type IQueryable.ElementType =&gt; <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T);

    IQueryProvider IQueryable.Provider =&gt; _provider;

    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IEnumerator&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetEnumerator</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>
    {
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _queryable.GetEnumerator();
    }

    IEnumerator IEnumerable.GetEnumerator()
    {
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _queryable.GetEnumerator();
    }
}</code></pre></div></div><br>
<pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IQueryProvider</span></span>
{
    <span class="hljs-function"><span class="hljs-function">IQueryable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateQuery</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Expression expression</span></span></span><span class="hljs-function">)</span></span>;
    IQueryable&lt;TElement&gt; CreateQuery&lt;TElement&gt;(Expression expression);
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Expression expression</span></span></span><span class="hljs-function">)</span></span>;
    TResult Execute&lt;TResult&gt;(Expression expression);
}</code></pre><br>
<div class="spoiler"><b class="spoiler_title">VisitableQueryProvider.cs</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">VisitableQueryProvider</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">IQueryProvider</span></span>
{
    <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> VisitableQuery&lt;T&gt; _query;

    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VisitableQueryProvider</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">VisitableQuery&lt;T&gt; query</span></span></span><span class="hljs-function">)</span></span>
    {
        _query = query;
    }

    IQueryable&lt;TElement&gt; IQueryProvider.CreateQuery&lt;TElement&gt;(Expression expression)
    {
        expression = _query.Visitors.Visit(expression);
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _query.InnerQuery.Provider
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .CreateQuery&lt;TElement&gt;(expression)
            .AsVisitable(_query.Visitors);
    }

    IQueryable IQueryProvider.CreateQuery(Expression expression)
    {
        expression = _query.Visitors.Visit(expression);
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _query.InnerQuery.Provider.CreateQuery(expression);
    }

    TResult IQueryProvider.Execute&lt;TResult&gt;(Expression expression)
    {
        expression = _query.Visitors.Visit(expression);
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _query.InnerQuery.Provider.Execute&lt;TResult&gt;(expression);
    }

    <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> IQueryProvider.Execute(Expression expression)
    {
        expression = _query.Visitors.Visit(expression);
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _query.InnerQuery.Provider.Execute(expression);
    }
}</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title">VisitorExtensions.cs</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">VisitorExtensions</span></span>
{
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Visit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ExpressionVisitor[] visitors, Expression node</span></span></span><span class="hljs-function">)</span></span>
    {
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (visitors != <span class="hljs-literal"><span class="hljs-literal">null</span></span>)
        {
            <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> visitor <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> visitors)
            {
                node = visitor.Visit(node);
            }
        }
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node;
    }
}</code></pre></div></div><br>
<p>     .    ,   <strong><code>ToListAsync()</code></strong>, EntityFramework  EF Core   : <strong><code>IDbAsyncEnumerable&lt;T&gt;</code></strong>  <strong><code>IAsyncEnumerable&lt;T&gt;</code></strong>.    <a href="https://github.com/gnaeus/EntityFramework.CommonTools/blob/master/EFCore.CommonTools/Querying"> </a>.     <a href="">ExpandableQuery</a>  <a href="http://www.albahari.com/nutshell/linqkit.aspx">LinqKit</a>,     <strong><code>ExpressionVisitor</code></strong>.</p><br>
<p>, ,  ExpressionVisitor:</p><br>
<div class="spoiler"><b class="spoiler_title">ExtensionExpander.cs</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ExtensionExpander</span></span> : <span class="hljs-title"><span class="hljs-title">ExpressionVisitor</span></span>
{
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VisitMethodCall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MethodCallExpression node</span></span></span><span class="hljs-function">)</span></span>
    {
        MethodInfo method = node.Method;

        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (method.IsDefined(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ExtensionAttribute), <span class="hljs-literal"><span class="hljs-literal">true</span></span>)
            &amp;&amp; method.IsDefined(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ExpandableAttribute), <span class="hljs-literal"><span class="hljs-literal">true</span></span>))
        {
            ParameterInfo[] methodParams = method.GetParameters();
            Type queryableType = methodParams.First().ParameterType;
            Type entityType = queryableType.GetGenericArguments().Single();

 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> inputQueryable = MakeEnumerableQuery(entityType);

            <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] arguments = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[methodParams.Length];

            arguments[<span class="hljs-number"><span class="hljs-number">0</span></span>] = inputQueryable;

            <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> argumentReplacements = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;KeyValuePair&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, Expression&gt;&gt;();

            <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; methodParams.Length; i++)
            {
                <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>
                {
                    arguments[i] = GetValue(node.Arguments[i]);
                }
                <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InvalidOperationException)
                {
                    ParameterInfo paramInfo = methodParams[i];
                    Type paramType = paramInfo.GetType();

                    arguments[i] = paramType.GetTypeInfo().IsValueType
                        ? Activator.CreateInstance(paramType) : <span class="hljs-literal"><span class="hljs-literal">null</span></span>;

                    argumentReplacements.Add(
                        <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyValuePair&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, Expression&gt;(paramInfo.Name, node.Arguments[i]));
                }
            }

            <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> outputQueryable = method.Invoke(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, arguments);

            Expression expression = ((IQueryable)outputQueryable).Expression;

 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  Expression realQueryable = node.Arguments[<span class="hljs-number"><span class="hljs-number">0</span></span>];

 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IQueryable).IsAssignableFrom(realQueryable.Type))
            {
                MethodInfo asQueryable = _asQueryable.MakeGenericMethod(entityType);
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  realQueryable = Expression.Call(asQueryable, realQueryable);
            }

            expression = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExtensionRebinder(
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  inputQueryable, realQueryable, argumentReplacements).Visit(expression);

            <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Visit(expression);
        }
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.VisitMethodCall(node);
    }

 &nbsp;  <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MakeEnumerableQuery</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type entityType</span></span></span><span class="hljs-function">)</span></span>
    {
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _queryableEmpty.MakeGenericMethod(entityType).Invoke(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>);
    }

    <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> MethodInfo _asQueryable = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Queryable)
        .GetMethods(BindingFlags.Static | BindingFlags.Public)
        .First(m =&gt; m.Name == <span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(Queryable.AsQueryable) &amp;&amp; m.IsGenericMethod);

    <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> MethodInfo _queryableEmpty = (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ExtensionExpander))
        .GetMethod(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(QueryableEmpty), BindingFlags.Static | BindingFlags.NonPublic);

    <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IQueryable&lt;T&gt; QueryableEmpty&lt;T&gt;()
    {
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Enumerable.Empty&lt;T&gt;().AsQueryable();
    }

    <span class="hljs-comment"><span class="hljs-comment">// http://stackoverflow.com/a/2616980/1402923</span></span>
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Expression expression</span></span></span><span class="hljs-function">)</span></span>
    {
        <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> objectMember = Expression.Convert(expression, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>));
        <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> getterLambda = Expression.Lambda&lt;Func&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;&gt;(objectMember);
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getterLambda.Compile().Invoke();
    }
}</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title">ExtensionRebinder.cs</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ExtensionRebinder</span></span> : <span class="hljs-title"><span class="hljs-title">ExpressionVisitor</span></span>
{
    <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> _originalQueryable;
    <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Expression _replacementQueryable;
    <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> List&lt;KeyValuePair&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, Expression&gt;&gt; _argumentReplacements;

    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExtensionRebinder</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">
        </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> originalQueryable, Expression replacementQueryable,
        List&lt;KeyValuePair&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Expression&gt;&gt; argumentReplacements</span></span></span><span class="hljs-function">)</span></span>
    {
        _originalQueryable = originalQueryable;
        _replacementQueryable = replacementQueryable;
        _argumentReplacements = argumentReplacements;
    }

    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VisitConstant</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ConstantExpression node</span></span></span><span class="hljs-function">)</span></span>
    {
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node.Value == _originalQueryable ? _replacementQueryable : node;
    }

    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VisitMember</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MemberExpression node</span></span></span><span class="hljs-function">)</span></span>
    {
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.NodeType == ExpressionType.MemberAccess
            &amp;&amp; node.Expression.NodeType == ExpressionType.Constant
            &amp;&amp; node.Expression.Type.GetTypeInfo().IsDefined(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(CompilerGeneratedAttribute)))
        {
            <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> argumentName = node.Member.Name;

            Expression replacement = _argumentReplacements
                .Where(p =&gt; p.Key == argumentName)
                .Select(p =&gt; p.Value)
                .FirstOrDefault();

            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (replacement != <span class="hljs-literal"><span class="hljs-literal">null</span></span>)
            {
                <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> replacement;
            }
        }
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.VisitMember(node);
    }
}</code></pre></div></div><br>
<h3 id="teper-my-smozhem-1">  </h3><br>
<p>‚Äî  extension-  Expression Tree:</p><br>
<pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Expandable</span></span>]
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IQueryable&lt;Post&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FilterByAuthor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">
    </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IEnumerable&lt;Post&gt; posts, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> authorId</span></span></span><span class="hljs-function">)</span></span>
{
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> posts.AsQueryable().Where(p =&gt; p.AuthorId = authorId);
}

[<span class="hljs-meta"><span class="hljs-meta">Expandable</span></span>]
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IQueryable&lt;Comment&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FilterTodayComments</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">
    </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IEnumerable&lt;Comment&gt; comments</span></span></span><span class="hljs-function">)</span></span>
{
    DateTime today = DateTime.Now.Date;

    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> comments.AsQueryable().Where(c =&gt; c.CreationTime &gt; today)
}

Comment[] comments = context.Posts
 &nbsp; &nbsp;.AsExpandable()
  &nbsp; .FilterByAuthor(authorId) &nbsp; &nbsp;<span class="hljs-comment"><span class="hljs-comment">// it's OK</span></span>
 &nbsp;  .SelectMany(p =&gt; p.Comments
 &nbsp; &nbsp; &nbsp;  .FilterTodayComments()) &nbsp;<span class="hljs-comment"><span class="hljs-comment">// it's OK too</span></span>
 &nbsp;  .ToArray();</code></pre><br>
<h2 id="tl-dr">TL; DR</h2><br>
<p> ,       !  ,      .     ?</p><br>
<hr><br>
<p>     GitHub: <a href="https://github.com/gnaeus/EntityFramework.CommonTools">EntityFramework.CommonTools</a>,   NuGet:</p><br>
<pre><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">PM</span></span>&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">Install-Package</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">EntityFramework</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.CommonTools</span></span>

<span class="hljs-selector-tag"><span class="hljs-selector-tag">PM</span></span>&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">Install-Package</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">EntityFrameworkCore</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.CommonTools</span></span></code></pre><br>
<hr><br>
<h2 id="update">Update</h2><br>
<p>  <a href=""></a>   .</p><br>
<div class="spoiler"><b class="spoiler_title">DatabaseQueryBenchmark.cs</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DatabaseQueryBenchmark</span></span>
{
    <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> DbConnection _connection = Context.CreateConnection();

    [<span class="hljs-meta"><span class="hljs-meta">Benchmark(Baseline = true)</span></span>]
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RawQuery</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>
    {
        <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Context(_connection))
        {
            DateTime today = DateTime.Now.Date;

            <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.Users
                .Where(u =&gt; u.Posts.Any(p =&gt; p.Date &gt; today))
                .FirstOrDefault();
        }
    }

    [<span class="hljs-meta"><span class="hljs-meta">Benchmark</span></span>]
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExpandableQuery</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>
    {
        <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Context(_connection))
        {
            <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.Users
                .AsExpandable()
                .Where(u =&gt; u.Posts.FilterToday().Any())
                .ToList();
        }
    }

    <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Random _random = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random();

    [<span class="hljs-meta"><span class="hljs-meta">Benchmark</span></span>]
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NotCachedQuery</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>
    {
        <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Context(_connection))
        {
            <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] postIds = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { _random.Next(), _random.Next() };

            <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.Users
                .Where(u =&gt; u.Posts.Any(p =&gt; postIds.Contains(p.Id)))
                .ToList();
        }
    }
}</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title">   </b><div class="spoiler_text"><pre><code class="hljs ruby">          Method <span class="hljs-params"><span class="hljs-params">|        Median |</span></span>     StdDev <span class="hljs-params"><span class="hljs-params">| Scaled |</span></span> Scaled-SD <span class="hljs-params"><span class="hljs-params">|
---------------- |</span></span>-------------- <span class="hljs-params"><span class="hljs-params">|----------- |</span></span>------- <span class="hljs-params"><span class="hljs-params">|---------- |</span></span>
        RawQuery <span class="hljs-params"><span class="hljs-params">|   555.6202 Œºs |</span></span> <span class="hljs-number"><span class="hljs-number">15.1837</span></span> Œºs <span class="hljs-params"><span class="hljs-params">|   1.00 |</span></span>      <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-params"><span class="hljs-params">|
 ExpandableQuery |</span></span>   <span class="hljs-number"><span class="hljs-number">644.6258</span></span> Œºs <span class="hljs-params"><span class="hljs-params">|  3.7793 Œºs |</span></span>   <span class="hljs-number"><span class="hljs-number">1.15</span></span> <span class="hljs-params"><span class="hljs-params">|      0.03 |</span></span> &lt;&lt;&lt;
  NotCachedQuery <span class="hljs-params"><span class="hljs-params">| 2,277.7138 Œºs |</span></span> <span class="hljs-number"><span class="hljs-number">10.9754</span></span> Œºs <span class="hljs-params"><span class="hljs-params">|   4.06 |</span></span>      <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-params"><span class="hljs-params">|</span></span></code></pre></div></div><br>
<p>,    .       15-30 %.</p><br>
<hr><br>
<div class="spoiler"><b class="spoiler_title">  </b><div class="spoiler_text"><ul>
<li><a href="https://martinfowler.com/eaaCatalog/repository.html">https://martinfowler.com/eaaCatalog/repository.html</a></li>
<li><a href="https://softwareengineering.stackexchange.com/questions/180851/why-shouldnt-i-use-the-repository-pattern-with-entity-framework">https://softwareengineering.stackexchange.com/questions/180851/why-shouldnt-i-use-the-repository-pattern-with-entity-framework</a></li>
<li><a href="http://enterprisecraftsmanship.com/2016/02/08/specification-pattern-c-implementation">http://enterprisecraftsmanship.com/2016/02/08/specification-pattern-c-implementation</a></li>
<li><a href="https://aspnetboilerplate.com/Pages/Documents/Repositories">https://aspnetboilerplate.com/Pages/Documents/Repositories</a></li>
<li><a href="https://aspnetboilerplate.com/Pages/Documents/Specifications">https://aspnetboilerplate.com/Pages/Documents/Specifications</a></li>
<li><a href="http://www.albahari.com/nutshell/linqkit.aspx">http://www.albahari.com/nutshell/linqkit.aspx</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/aa691312(v%3Dvs.71).aspx">https://msdn.microsoft.com/en-us/library/aa691312(v=vs.71).aspx</a></li>
</ul><br>
</div></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/335856/">https://habr.com/ru/post/335856/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335846/index.html">Logs as part of the product. How GrayLog Impacted Quality</a></li>
<li><a href="../335848/index.html">MIPSfpga - practical experience</a></li>
<li><a href="../335850/index.html">Taxes on IT-business in Russia</a></li>
<li><a href="../335852/index.html">‚ÄúJava-developers do not realize the problem with profilers‚Äù: Andrey Pangin and Nitsan Vakart about Java profiling</a></li>
<li><a href="../335854/index.html">The history of the development of machine learning in the LC</a></li>
<li><a href="../335858/index.html">Why not rely on user error reports</a></li>
<li><a href="../335866/index.html">Memoization and Currying (Python)</a></li>
<li><a href="../335868/index.html">Redux store: horizontal expansion</a></li>
<li><a href="../335870/index.html">What is DNSBL and how can you not get there</a></li>
<li><a href="../335872/index.html">HAProxy as LoadBalan—Åer for RDP truss. Reliable solution for $ 0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>