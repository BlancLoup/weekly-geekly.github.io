<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating audio plugin, part 9</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All posts series: 
 Part 1. Introduction and setup 
 Part 2. Learning Code 
 Part 3. VST and AU 
 Part 4. Digital Distortion 
 Part 5. Presets and GUI...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating audio plugin, part 9</h1><div class="post__text post__text-html js-mediator-article">  All posts series: <br>  <a href="http://habrahabr.ru/post/224911/">Part 1. Introduction and setup</a> <br>  <a href="http://habrahabr.ru/post/225019/">Part 2. Learning Code</a> <br>  <a href="http://habrahabr.ru/post/225457/">Part 3. VST and AU</a> <br>  <a href="http://habrahabr.ru/post/225751/">Part 4. Digital Distortion</a> <br>  <a href="http://habrahabr.ru/post/225755/">Part 5. Presets and GUI</a> <br>  <a href="http://habrahabr.ru/post/226439/">Part 6. Signal synthesis</a> <br>  <a href="http://habrahabr.ru/post/226573/">Part 7. Receive MIDI Messages</a> <br>  <a href="http://habrahabr.ru/post/226823/">Part 8. Virtual Keyboard</a> <br>  <a href="http://habrahabr.ru/post/227475/">Part 9. Envelopes</a> <br>  <a href="http://habrahabr.ru/post/227601/">Part 10. Refinement GUI</a> <br>  <a href="http://habrahabr.ru/post/227791/">Part 11. Filter</a> <br>  <a href="http://habrahabr.ru/post/227827/">Part 12. Low-frequency oscillator</a> <br>  <a href="http://habrahabr.ru/post/228267/">Part 13. Redesign</a> <br>  <a href="http://habrahabr.ru/post/231513/">Part 14. Polyphony 1</a> <br>  <a href="http://habrahabr.ru/post/231923/">Part 15. Polyphony 2</a> <br>  <a href="http://habrahabr.ru/post/232153/">Part 16. Antialiasing</a> <br><hr><br><br>  The sound is interesting when there are any changes in it.  Let's make an envelope generator that will change the volume of the sound. <br><a name="habracut"></a><br><br><h2>  Envelopes </h2>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Basic principles </h3><br><br>  If you are not familiar with the abbreviation <i>ADSR</i> ( <i>Attack, Decay, Sustain, Release</i> ), read <a href="http://ru.wikipedia.org/wiki/ADSR-%25D0%25BE%25D0%25B3%25D0%25B8%25D0%25B1%25D0%25B0%25D1%258E%25D1%2589%25D0%25B0%25D1%258F">this little article</a> on Wikipedia before continuing. <br>  In essence, the generator will be a <a href="http://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25B0%25D0%25B2%25D1%2582%25D0%25BE%25D0%25BC%25D0%25B0%25D1%2582">finite state machine</a> with the states <i>Off, Attack, Decay, Sustain</i> and <i>Release</i> .  This is such an abstruse way to say that at any given time the generator will be in only one of these five possible states.  In the terminology of the envelopes, these states are called stages.  The transition from one stage to another will be done by calling the <code>enterStage</code> member <code>enterStage</code> . <br>  A couple of key points regarding the stages: <br><br><ul><li>  The output of their stages ATTACK, DECAY and RELEASE will be carried out by the generator independently: after the time specified by the parameters it will call <code>enterStage</code> for the transition </li><li>  In the OFF and SUSTAIN states, it can remain indefinitely until an enterStage call is made from the outside. </li><li>  ATTACK, DECAY and RELEASE, as you already understood, are <i>time</i> variables, while SUSTAIN is a <i>signal level</i> variable <i>.</i> </li><li>  The generator can go to the RELEASE stage from ATTACK, DECAY and SUSTAIN </li><li>  Moving to the RELEASE stage, the amplitude of the signal begins to fade <i>from the current level</i> to zero. </li></ul><br><br>  For each signal sample, the generator will produce a <code>double</code> value between zero and one.  We will <i>multiply the</i> current value received from the envelope generator with the output signal of the oscillator.  This way the signal level will be determined by the envelope.  We will be able to do a variety of things with sound: it will float up slowly, subside abruptly, or be even as a log. <br><br>  In general, ADSR is the first approach to more advanced sound modeling.  On many modern soft and iron synthesizers, one can find envelopes with a large number of stages.  All of them, in fact, are simply an extension of the model that we will create now.  The number of states of such state machines is just a little more than five. <br><br><h3>  Class EnvelopeGenerator </h3><br><br>  Create a new <code>EnvelopeGenerator</code> class and add it to all the targets (on Mac) and projects (on Windows).  Paste the class declaration between <code>#define</code> and <code>#endif</code> into <i>EnvelopeGenerator.h</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;cmath&gt; class EnvelopeGenerator { public: enum EnvelopeStage { ENVELOPE_STAGE_OFF = 0, ENVELOPE_STAGE_ATTACK, ENVELOPE_STAGE_DECAY, ENVELOPE_STAGE_SUSTAIN, ENVELOPE_STAGE_RELEASE, kNumEnvelopeStages }; void enterStage(EnvelopeStage newStage); double nextSample(); void setSampleRate(double newSampleRate); inline EnvelopeStage getCurrentStage() const { return currentStage; }; const double minimumLevel; EnvelopeGenerator() : minimumLevel(0.0001), currentStage(ENVELOPE_STAGE_OFF), currentLevel(minimumLevel), multiplier(1.0), sampleRate(44100.0), currentSampleIndex(0), nextStageSampleIndex(0) { stageValue[ENVELOPE_STAGE_OFF] = 0.0; stageValue[ENVELOPE_STAGE_ATTACK] = 0.01; stageValue[ENVELOPE_STAGE_DECAY] = 0.5; stageValue[ENVELOPE_STAGE_SUSTAIN] = 0.1; stageValue[ENVELOPE_STAGE_RELEASE] = 1.0; }; private: EnvelopeStage currentStage; double currentLevel; double multiplier; double sampleRate; double stageValue[kNumEnvelopeStages]; void calculateMultiplier(double startLevel, double endLevel, unsigned long long lengthInSamples); unsigned long long currentSampleIndex; unsigned long long nextStageSampleIndex; };</span></span></span></span></code> </pre><br><br>  To begin with, we create an <code>enum</code> with all the stages.  <code>kNumEnvelopeStages</code> at the end tells us how many stages there are.  Please note that this <code>enum</code> is within the boundaries of the envelope class namespace, and will not be accessible from the outside, in the global namespace. <br>  We will look at member functions in more detail when we implement them.  The minimum level <code>minimumLevel</code> required, since the signal level calculations will not work with zero.  We initialize this variable with a very small value of <code>0.001</code> . <br>  In the initialization list, the envelope defaults to <code>OFF</code> .  The <code>stageValue</code> array <code>stageValue</code> also initialized with the preset values: the hundredth second of the attack, half a second of recession, a quiet level and a second for a complete attenuation. <br>  In the <code>private currentStage</code> section indicates the stage at which the generator is now located.  <code>urrentLevel</code> is the envelope volume value for this sample time.  <code>multiplyer</code> provides exponential decay, as will be seen later. <br>  At the ATTACK, DECAY and RELEASE stages, the generator must track its position in time to move to the next stage at the right moment.  For this we will use the variable <code>currentSampleIndex</code> .  In <i>EnvelopeGenerator.cpp</i> add the following function: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">double</span></span> EnvelopeGenerator::nextSample() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentStage != ENVELOPE_STAGE_OFF &amp;&amp; currentStage != ENVELOPE_STAGE_SUSTAIN) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentSampleIndex == nextStageSampleIndex) { EnvelopeStage newStage = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;EnvelopeStage&gt;( (currentStage + <span class="hljs-number"><span class="hljs-number">1</span></span>) % kNumEnvelopeStages ); enterStage(newStage); } currentLevel *= multiplier; currentSampleIndex++; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentLevel; }</code> </pre><br><br>  If the generator in the ATTACK, DECAY or RELEASE stages and <code>currentSampleIndex</code> reaches the value of the <code>nextStageSampleIndex</code> , we proceed to the next element in the <code>enum EnvelopeStage</code> .  Due to the division with the remainder ( <code>%</code> ) after <code>ENVELOPE_STAGE_RELEASE</code> generator will immediately go to <code>ENVELOPE_STAGE_OFF</code> , which is what we need.  This transition is made by calling <code>enterStage</code> . <br>  Then we compute the <code>currentLevel</code> level and update the <code>currentSampleIndex</code> to keep track of the generator‚Äôs position over time.  These calculations are not performed at the stages OFF and SUSTAIN, since the level should not change on them.  The same goes for <code>currentSampleIndex</code> : these two stages are not limited in time. <br><br><h3>  Transitions in time </h3><br><br>  In ATTACK, DECAY and RELEASE, the generator transitions between two values ‚Äã‚Äãin a given time.  The human ear <a href="http://en.wikibooks.org/wiki/Engineering_Acoustics/The_Human_Ear_and_Sound_Perception">perceives loudness</a> on a logarithmic scale.  Therefore, in order for a loudness change to be perceived by a linear ear, it must occur exponentially. <br>  There are different ways to build an exponential curve between two points.  The first thing that comes to mind is that each sample calls a relatively heavy <code>exp</code> function from the library. <code><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> void EnvelopeGenerator::calculateMultiplier(double startLevel, double endLevel, unsigned long long lengthInSamples) { multiplier = 1.0 + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp">void EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = 0; if (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = 0; } else { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { case ENVELOPE_STAGE_OFF: currentLevel = 0.0; multiplier = 1.0; break; case ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, 1.0, nextStageSampleIndex); break; case ENVELOPE_STAGE_DECAY: currentLevel = 1.0; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; case ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = 1.0; break; case ENVELOPE_STAGE_RELEASE: // We could go from ATTACK/DECAY to RELEASE, // so we're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</code> <br> <br>    <code>currentStage</code>     <code>currentSampleIndex</code> .       <i> </i> .   ,       ,   . <code>stageValue[currentStage]</code>   <code>double</code> (   ), ,       ,     . <code>Switch</code>     .  OFF         (  ,    ). ATTACK    <code>minimumLevel</code> ,  <code>multiplier</code>   <code>currentLevel</code>  <code>1.0</code> .   DECAY       <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code> ,  <code>fmax</code> ,      . RELEASE  <code>currentLevel</code> ,     ,  <code>minimumLevel</code> .    ,    RELEASE    <code>currentLevel</code> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code>    ,  <i> </i> .         <code>currentLevel</code> . <br> <br>   <br> <br>        : <br> <br> <code class="cpp">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</code> <br> <br>   <code>private</code>  <code>Synthesis</code> (  )   : <br> <br> <code class="cpp">EnvelopeGenerator mEnvelopeGenerator;</code> <br> <br>   <code>#include "EnvelopeGenerator.h"</code>   . <br> ,   <code>ProcessDoubleReplacing</code> <i>Synthesis.cpp</i>   <code>leftOutput[i]</code>  : <br> <br> <code class="cpp">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</code> <br> <br>    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . <br>     <code>mEnvelopeGenerator</code>     .   <code>Synthesis::Reset()</code> : <br> <br> <code class="cpp">mEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>       .     -    ‚Äî        ! . <br> <br>    Note On/Off <br> <br>    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. <code>mMIDIReceiver</code>     note on/off,  ,  -    . <br> <br>         <code>#include EnvelopeGenerator.h</code>  <i>MIDIReceiver.h</i> . ,  <i>Synthesis.h</i>          <code>mEnvelopeGenerator</code>  <code>mMIDIReceiver</code> ,      .  <code>MIDIReceiver</code>   <code>enterStage</code>   note on/off. <br>  , . . <code>MIDIReceiver</code>    <code>EnvelopeGenerator</code> .       ,      <code>MIDIReceiver</code>   ,    <code>EnvelopeGenerator</code> . <br> <br>   <a href="http://qt-project.org/doc/qt-5/signalsandslots.html"></a>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"></a> .      Qt.    , ,          ,      .    ,   .       ,  <code>setText()</code> ,        .    ,    ,      ,   . ,  ,  .          ( <code>Oscillator</code> , <code>EnvelopeGenerator</code> , <code>MIDIReceiver</code> ).    <i> </i> , . .   <code>Synthesis</code> . <br> <br>       Qt    .     <a href="https://github.com/pbhogan/Signals">Signals</a>  .   .  <i>Signal.h</i>  <i>GallantSignal.h</i> ,    .  <i>Delegate.h</i>  <i>GallantSignal.h</i>   ( ,   ,  <i>‚ÄúCopy items into destination group's folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#include "GallantSignal.h" using Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code>public</code> : <br> <br> <code class="cpp">Signal2&lt; int, int &gt; noteOn; Signal2&lt; int, int &gt; noteOff;</code> <br> <br>  ,        <code>int</code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides any previously pressed key: if (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// If the last note was released, nothing should play: if (noteNumber == mLastNoteNumber) { mLastNoteNumber = -1; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code>-1</code> ,   :      RELEASE.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.Connect(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.Connect(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code>if</code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       RELEASE,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins-011-envelopes</a></code> <pre> <code class="hljs pgsql"><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> <span class="hljs-type"><span class="hljs-type">void</span></span> EnvelopeGenerator::calculateMultiplier(<span class="hljs-type"><span class="hljs-type">double</span></span> startLevel, <span class="hljs-type"><span class="hljs-type">double</span></span> endLevel, unsigned long long lengthInSamples) { multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span> + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp"><span class="hljs-type"><span class="hljs-type">void</span></span> EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_OFF: currentLevel = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, nextStageSampleIndex); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_DECAY: currentLevel = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_RELEASE: // We could go <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ATTACK/DECAY <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>, // so w<span class="hljs-string"><span class="hljs-string">e're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    </span></span><code><span class="hljs-string"><span class="hljs-string">currentStage</span></span></code><span class="hljs-string"><span class="hljs-string">     </span></span><code><span class="hljs-string"><span class="hljs-string">currentSampleIndex</span></span></code><span class="hljs-string"><span class="hljs-string"> .       </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> .   ,       ,   . </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[currentStage]</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">double</span></span></code><span class="hljs-string"><span class="hljs-string"> (   ), ,       ,     . </span></span><code><span class="hljs-string"><span class="hljs-string">Switch</span></span></code><span class="hljs-string"><span class="hljs-string">     .  OFF         (  ,    ). ATTACK    </span></span><code><span class="hljs-string"><span class="hljs-string">minimumLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> ,  </span></span><code><span class="hljs-string"><span class="hljs-string">multiplier</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">1.0</span></span></code><span class="hljs-string"><span class="hljs-string"> .   DECAY       </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[ENVELOPE_STAGE_SUSTAIN]</span></span></code><span class="hljs-string"><span class="hljs-string"> ,  </span></span><code><span class="hljs-string"><span class="hljs-string">fmax</span></span></code><span class="hljs-string"><span class="hljs-string"> ,      . RELEASE  </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> ,     ,  </span></span><code><span class="hljs-string"><span class="hljs-string">minimumLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> .    ,    RELEASE    </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[ENVELOPE_STAGE_SUSTAIN]</span></span></code><span class="hljs-string"><span class="hljs-string">    ,  </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> .         </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">        : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">private</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis</span></span></code><span class="hljs-string"><span class="hljs-string"> (  )   : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator mEnvelopeGenerator;</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">#include "EnvelopeGenerator.h"</span></span></code><span class="hljs-string"><span class="hljs-string">   . </span></span><br><span class="hljs-string"><span class="hljs-string"> ,   </span></span><code><span class="hljs-string"><span class="hljs-string">ProcessDoubleReplacing</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><i><span class="hljs-string"><span class="hljs-string">Synthesis.cpp</span></span></i><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">leftOutput[i]</span></span></code><span class="hljs-string"><span class="hljs-string">  : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . </span></span><br><span class="hljs-string"><span class="hljs-string">     </span></span><code><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string">     .   </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis::Reset()</span></span></code><span class="hljs-string"><span class="hljs-string"> : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator.setSampleRate(GetSampleRate());</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">       .     -    ‚Äî        ! . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    Note On/Off </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. </span></span><code><span class="hljs-string"><span class="hljs-string">mMIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">     note on/off,  ,  -    . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">         </span></span><code><span class="hljs-string"><span class="hljs-string">#include EnvelopeGenerator.h</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">MIDIReceiver.h</span></span></i><span class="hljs-string"><span class="hljs-string"> . ,  </span></span><i><span class="hljs-string"><span class="hljs-string">Synthesis.h</span></span></i><span class="hljs-string"><span class="hljs-string">          </span></span><code><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">mMIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string"> ,      .  </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">enterStage</span></span></code><span class="hljs-string"><span class="hljs-string">   note on/off. </span></span><br><span class="hljs-string"><span class="hljs-string">  , . . </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">    </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> .       ,      </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">   ,    </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><a href="http://qt-project.org/doc/qt-5/signalsandslots.html"><span class="hljs-string"><span class="hljs-string"></span></span></a><span class="hljs-string"><span class="hljs-string">  </span></span><a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"><span class="hljs-string"><span class="hljs-string"></span></span></a><span class="hljs-string"><span class="hljs-string"> .      Qt.    , ,          ,      .    ,   .       ,  </span></span><code><span class="hljs-string"><span class="hljs-string">setText()</span></span></code><span class="hljs-string"><span class="hljs-string"> ,        .    ,    ,      ,   . ,  ,  .          ( </span></span><code><span class="hljs-string"><span class="hljs-string">Oscillator</span></span></code><span class="hljs-string"><span class="hljs-string"> , </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> , </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string"> ).    </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> , . .   </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">       Qt    .     </span></span><a href="https://github.com/pbhogan/Signals"><span class="hljs-string"><span class="hljs-string">Signals</span></span></a><span class="hljs-string"><span class="hljs-string">  .   .  </span></span><i><span class="hljs-string"><span class="hljs-string">Signal.h</span></span></i><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">GallantSignal.h</span></span></i><span class="hljs-string"><span class="hljs-string"> ,    .  </span></span><i><span class="hljs-string"><span class="hljs-string">Delegate.h</span></span></i><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">GallantSignal.h</span></span></i><span class="hljs-string"><span class="hljs-string">   ( ,   ,  </span></span><i><span class="hljs-string"><span class="hljs-string">‚ÄúCopy items into destination group'</span></span>s folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "GallantSignal.h" <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code><span class="hljs-built_in"><span class="hljs-built_in">public</span></span></code> : <br> <br> <code class="cpp">Signal2&lt; <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> &gt; noteOn; Signal2&lt; <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> &gt; noteOff;</code> <br> <br>  ,        <code><span class="hljs-type"><span class="hljs-type">int</span></span></code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> previously pressed key: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the last note was released, <span class="hljs-keyword"><span class="hljs-keyword">nothing</span></span> should play: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noteNumber == mLastNoteNumber) { mLastNoteNumber = <span class="hljs-number"><span class="hljs-number">-1</span></span>; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code><span class="hljs-number"><span class="hljs-number">-1</span></span></code> ,   :      <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp"><span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onNoteOn(const <span class="hljs-type"><span class="hljs-type">int</span></span> noteNumber, const <span class="hljs-type"><span class="hljs-type">int</span></span> velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onNoteOff(const <span class="hljs-type"><span class="hljs-type">int</span></span> noteNumber, const <span class="hljs-type"><span class="hljs-type">int</span></span> velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code><span class="hljs-keyword"><span class="hljs-keyword">if</span></span></code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins<span class="hljs-number"><span class="hljs-number">-011</span></span>-envelopes</a></code> </pre> <code><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> void EnvelopeGenerator::calculateMultiplier(double startLevel, double endLevel, unsigned long long lengthInSamples) { multiplier = 1.0 + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp">void EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = 0; if (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = 0; } else { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { case ENVELOPE_STAGE_OFF: currentLevel = 0.0; multiplier = 1.0; break; case ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, 1.0, nextStageSampleIndex); break; case ENVELOPE_STAGE_DECAY: currentLevel = 1.0; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; case ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = 1.0; break; case ENVELOPE_STAGE_RELEASE: // We could go from ATTACK/DECAY to RELEASE, // so we're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</code> <br> <br>    <code>currentStage</code>     <code>currentSampleIndex</code> .       <i> </i> .   ,       ,   . <code>stageValue[currentStage]</code>   <code>double</code> (   ), ,       ,     . <code>Switch</code>     .  OFF         (  ,    ). ATTACK    <code>minimumLevel</code> ,  <code>multiplier</code>   <code>currentLevel</code>  <code>1.0</code> .   DECAY       <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code> ,  <code>fmax</code> ,      . RELEASE  <code>currentLevel</code> ,     ,  <code>minimumLevel</code> .    ,    RELEASE    <code>currentLevel</code> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code>    ,  <i> </i> .         <code>currentLevel</code> . <br> <br>   <br> <br>        : <br> <br> <code class="cpp">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</code> <br> <br>   <code>private</code>  <code>Synthesis</code> (  )   : <br> <br> <code class="cpp">EnvelopeGenerator mEnvelopeGenerator;</code> <br> <br>   <code>#include "EnvelopeGenerator.h"</code>   . <br> ,   <code>ProcessDoubleReplacing</code> <i>Synthesis.cpp</i>   <code>leftOutput[i]</code>  : <br> <br> <code class="cpp">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</code> <br> <br>    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . <br>     <code>mEnvelopeGenerator</code>     .   <code>Synthesis::Reset()</code> : <br> <br> <code class="cpp">mEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>       .     -    ‚Äî        ! . <br> <br>    Note On/Off <br> <br>    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. <code>mMIDIReceiver</code>     note on/off,  ,  -    . <br> <br>         <code>#include EnvelopeGenerator.h</code>  <i>MIDIReceiver.h</i> . ,  <i>Synthesis.h</i>          <code>mEnvelopeGenerator</code>  <code>mMIDIReceiver</code> ,      .  <code>MIDIReceiver</code>   <code>enterStage</code>   note on/off. <br>  , . . <code>MIDIReceiver</code>    <code>EnvelopeGenerator</code> .       ,      <code>MIDIReceiver</code>   ,    <code>EnvelopeGenerator</code> . <br> <br>   <a href="http://qt-project.org/doc/qt-5/signalsandslots.html"></a>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"></a> .      Qt.    , ,          ,      .    ,   .       ,  <code>setText()</code> ,        .    ,    ,      ,   . ,  ,  .          ( <code>Oscillator</code> , <code>EnvelopeGenerator</code> , <code>MIDIReceiver</code> ).    <i> </i> , . .   <code>Synthesis</code> . <br> <br>       Qt    .     <a href="https://github.com/pbhogan/Signals">Signals</a>  .   .  <i>Signal.h</i>  <i>GallantSignal.h</i> ,    .  <i>Delegate.h</i>  <i>GallantSignal.h</i>   ( ,   ,  <i>‚ÄúCopy items into destination group's folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#include "GallantSignal.h" using Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code>public</code> : <br> <br> <code class="cpp">Signal2&lt; int, int &gt; noteOn; Signal2&lt; int, int &gt; noteOff;</code> <br> <br>  ,        <code>int</code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides any previously pressed key: if (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// If the last note was released, nothing should play: if (noteNumber == mLastNoteNumber) { mLastNoteNumber = -1; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code>-1</code> ,   :      RELEASE.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.Connect(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.Connect(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code>if</code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       RELEASE,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins-011-envelopes</a></code> <h3> <code><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> void EnvelopeGenerator::calculateMultiplier(double startLevel, double endLevel, unsigned long long lengthInSamples) { multiplier = 1.0 + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp">void EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = 0; if (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = 0; } else { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { case ENVELOPE_STAGE_OFF: currentLevel = 0.0; multiplier = 1.0; break; case ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, 1.0, nextStageSampleIndex); break; case ENVELOPE_STAGE_DECAY: currentLevel = 1.0; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; case ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = 1.0; break; case ENVELOPE_STAGE_RELEASE: // We could go from ATTACK/DECAY to RELEASE, // so we're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</code> <br> <br>    <code>currentStage</code>     <code>currentSampleIndex</code> .       <i> </i> .   ,       ,   . <code>stageValue[currentStage]</code>   <code>double</code> (   ), ,       ,     . <code>Switch</code>     .  OFF         (  ,    ). ATTACK    <code>minimumLevel</code> ,  <code>multiplier</code>   <code>currentLevel</code>  <code>1.0</code> .   DECAY       <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code> ,  <code>fmax</code> ,      . RELEASE  <code>currentLevel</code> ,     ,  <code>minimumLevel</code> .    ,    RELEASE    <code>currentLevel</code> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code>    ,  <i> </i> .         <code>currentLevel</code> . <br> <br>   <br> <br>        : <br> <br> <code class="cpp">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</code> <br> <br>   <code>private</code>  <code>Synthesis</code> (  )   : <br> <br> <code class="cpp">EnvelopeGenerator mEnvelopeGenerator;</code> <br> <br>   <code>#include "EnvelopeGenerator.h"</code>   . <br> ,   <code>ProcessDoubleReplacing</code> <i>Synthesis.cpp</i>   <code>leftOutput[i]</code>  : <br> <br> <code class="cpp">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</code> <br> <br>    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . <br>     <code>mEnvelopeGenerator</code>     .   <code>Synthesis::Reset()</code> : <br> <br> <code class="cpp">mEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>       .     -    ‚Äî        ! . <br> <br>    Note On/Off <br> <br>    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. <code>mMIDIReceiver</code>     note on/off,  ,  -    . <br> <br>         <code>#include EnvelopeGenerator.h</code>  <i>MIDIReceiver.h</i> . ,  <i>Synthesis.h</i>          <code>mEnvelopeGenerator</code>  <code>mMIDIReceiver</code> ,      .  <code>MIDIReceiver</code>   <code>enterStage</code>   note on/off. <br>  , . . <code>MIDIReceiver</code>    <code>EnvelopeGenerator</code> .       ,      <code>MIDIReceiver</code>   ,    <code>EnvelopeGenerator</code> . <br> <br>   <a href="http://qt-project.org/doc/qt-5/signalsandslots.html"></a>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"></a> .      Qt.    , ,          ,      .    ,   .       ,  <code>setText()</code> ,        .    ,    ,      ,   . ,  ,  .          ( <code>Oscillator</code> , <code>EnvelopeGenerator</code> , <code>MIDIReceiver</code> ).    <i> </i> , . .   <code>Synthesis</code> . <br> <br>       Qt    .     <a href="https://github.com/pbhogan/Signals">Signals</a>  .   .  <i>Signal.h</i>  <i>GallantSignal.h</i> ,    .  <i>Delegate.h</i>  <i>GallantSignal.h</i>   ( ,   ,  <i>‚ÄúCopy items into destination group's folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#include "GallantSignal.h" using Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code>public</code> : <br> <br> <code class="cpp">Signal2&lt; int, int &gt; noteOn; Signal2&lt; int, int &gt; noteOff;</code> <br> <br>  ,        <code>int</code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides any previously pressed key: if (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// If the last note was released, nothing should play: if (noteNumber == mLastNoteNumber) { mLastNoteNumber = -1; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code>-1</code> ,   :      RELEASE.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.Connect(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.Connect(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code>if</code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       RELEASE,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins-011-envelopes</a></code> </h3> <code><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> void EnvelopeGenerator::calculateMultiplier(double startLevel, double endLevel, unsigned long long lengthInSamples) { multiplier = 1.0 + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp">void EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = 0; if (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = 0; } else { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { case ENVELOPE_STAGE_OFF: currentLevel = 0.0; multiplier = 1.0; break; case ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, 1.0, nextStageSampleIndex); break; case ENVELOPE_STAGE_DECAY: currentLevel = 1.0; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; case ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = 1.0; break; case ENVELOPE_STAGE_RELEASE: // We could go from ATTACK/DECAY to RELEASE, // so we're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</code> <br> <br>    <code>currentStage</code>     <code>currentSampleIndex</code> .       <i> </i> .   ,       ,   . <code>stageValue[currentStage]</code>   <code>double</code> (   ), ,       ,     . <code>Switch</code>     .  OFF         (  ,    ). ATTACK    <code>minimumLevel</code> ,  <code>multiplier</code>   <code>currentLevel</code>  <code>1.0</code> .   DECAY       <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code> ,  <code>fmax</code> ,      . RELEASE  <code>currentLevel</code> ,     ,  <code>minimumLevel</code> .    ,    RELEASE    <code>currentLevel</code> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code>    ,  <i> </i> .         <code>currentLevel</code> . <br> <br>   <br> <br>        : <br> <br> <code class="cpp">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</code> <br> <br>   <code>private</code>  <code>Synthesis</code> (  )   : <br> <br> <code class="cpp">EnvelopeGenerator mEnvelopeGenerator;</code> <br> <br>   <code>#include "EnvelopeGenerator.h"</code>   . <br> ,   <code>ProcessDoubleReplacing</code> <i>Synthesis.cpp</i>   <code>leftOutput[i]</code>  : <br> <br> <code class="cpp">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</code> <br> <br>    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . <br>     <code>mEnvelopeGenerator</code>     .   <code>Synthesis::Reset()</code> : <br> <br> <code class="cpp">mEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>       .     -    ‚Äî        ! . <br> <br>    Note On/Off <br> <br>    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. <code>mMIDIReceiver</code>     note on/off,  ,  -    . <br> <br>         <code>#include EnvelopeGenerator.h</code>  <i>MIDIReceiver.h</i> . ,  <i>Synthesis.h</i>          <code>mEnvelopeGenerator</code>  <code>mMIDIReceiver</code> ,      .  <code>MIDIReceiver</code>   <code>enterStage</code>   note on/off. <br>  , . . <code>MIDIReceiver</code>    <code>EnvelopeGenerator</code> .       ,      <code>MIDIReceiver</code>   ,    <code>EnvelopeGenerator</code> . <br> <br>   <a href="http://qt-project.org/doc/qt-5/signalsandslots.html"></a>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"></a> .      Qt.    , ,          ,      .    ,   .       ,  <code>setText()</code> ,        .    ,    ,      ,   . ,  ,  .          ( <code>Oscillator</code> , <code>EnvelopeGenerator</code> , <code>MIDIReceiver</code> ).    <i> </i> , . .   <code>Synthesis</code> . <br> <br>       Qt    .     <a href="https://github.com/pbhogan/Signals">Signals</a>  .   .  <i>Signal.h</i>  <i>GallantSignal.h</i> ,    .  <i>Delegate.h</i>  <i>GallantSignal.h</i>   ( ,   ,  <i>‚ÄúCopy items into destination group's folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#include "GallantSignal.h" using Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code>public</code> : <br> <br> <code class="cpp">Signal2&lt; int, int &gt; noteOn; Signal2&lt; int, int &gt; noteOff;</code> <br> <br>  ,        <code>int</code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides any previously pressed key: if (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// If the last note was released, nothing should play: if (noteNumber == mLastNoteNumber) { mLastNoteNumber = -1; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code>-1</code> ,   :      RELEASE.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.Connect(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.Connect(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code>if</code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       RELEASE,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins-011-envelopes</a></code> <pre> <code class="hljs pgsql"><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> <span class="hljs-type"><span class="hljs-type">void</span></span> EnvelopeGenerator::calculateMultiplier(<span class="hljs-type"><span class="hljs-type">double</span></span> startLevel, <span class="hljs-type"><span class="hljs-type">double</span></span> endLevel, unsigned long long lengthInSamples) { multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span> + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp"><span class="hljs-type"><span class="hljs-type">void</span></span> EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_OFF: currentLevel = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, nextStageSampleIndex); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_DECAY: currentLevel = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_RELEASE: // We could go <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ATTACK/DECAY <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>, // so w<span class="hljs-string"><span class="hljs-string">e're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    </span></span><code><span class="hljs-string"><span class="hljs-string">currentStage</span></span></code><span class="hljs-string"><span class="hljs-string">     </span></span><code><span class="hljs-string"><span class="hljs-string">currentSampleIndex</span></span></code><span class="hljs-string"><span class="hljs-string"> .       </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> .   ,       ,   . </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[currentStage]</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">double</span></span></code><span class="hljs-string"><span class="hljs-string"> (   ), ,       ,     . </span></span><code><span class="hljs-string"><span class="hljs-string">Switch</span></span></code><span class="hljs-string"><span class="hljs-string">     .  OFF         (  ,    ). ATTACK    </span></span><code><span class="hljs-string"><span class="hljs-string">minimumLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> ,  </span></span><code><span class="hljs-string"><span class="hljs-string">multiplier</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">1.0</span></span></code><span class="hljs-string"><span class="hljs-string"> .   DECAY       </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[ENVELOPE_STAGE_SUSTAIN]</span></span></code><span class="hljs-string"><span class="hljs-string"> ,  </span></span><code><span class="hljs-string"><span class="hljs-string">fmax</span></span></code><span class="hljs-string"><span class="hljs-string"> ,      . RELEASE  </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> ,     ,  </span></span><code><span class="hljs-string"><span class="hljs-string">minimumLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> .    ,    RELEASE    </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[ENVELOPE_STAGE_SUSTAIN]</span></span></code><span class="hljs-string"><span class="hljs-string">    ,  </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> .         </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">        : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">private</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis</span></span></code><span class="hljs-string"><span class="hljs-string"> (  )   : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator mEnvelopeGenerator;</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">#include "EnvelopeGenerator.h"</span></span></code><span class="hljs-string"><span class="hljs-string">   . </span></span><br><span class="hljs-string"><span class="hljs-string"> ,   </span></span><code><span class="hljs-string"><span class="hljs-string">ProcessDoubleReplacing</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><i><span class="hljs-string"><span class="hljs-string">Synthesis.cpp</span></span></i><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">leftOutput[i]</span></span></code><span class="hljs-string"><span class="hljs-string">  : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . </span></span><br><span class="hljs-string"><span class="hljs-string">     </span></span><code><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string">     .   </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis::Reset()</span></span></code><span class="hljs-string"><span class="hljs-string"> : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator.setSampleRate(GetSampleRate());</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">       .     -    ‚Äî        ! . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    Note On/Off </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. </span></span><code><span class="hljs-string"><span class="hljs-string">mMIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">     note on/off,  ,  -    . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">         </span></span><code><span class="hljs-string"><span class="hljs-string">#include EnvelopeGenerator.h</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">MIDIReceiver.h</span></span></i><span class="hljs-string"><span class="hljs-string"> . ,  </span></span><i><span class="hljs-string"><span class="hljs-string">Synthesis.h</span></span></i><span class="hljs-string"><span class="hljs-string">          </span></span><code><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">mMIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string"> ,      .  </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">enterStage</span></span></code><span class="hljs-string"><span class="hljs-string">   note on/off. </span></span><br><span class="hljs-string"><span class="hljs-string">  , . . </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">    </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> .       ,      </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">   ,    </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><a href="http://qt-project.org/doc/qt-5/signalsandslots.html"><span class="hljs-string"><span class="hljs-string"></span></span></a><span class="hljs-string"><span class="hljs-string">  </span></span><a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"><span class="hljs-string"><span class="hljs-string"></span></span></a><span class="hljs-string"><span class="hljs-string"> .      Qt.    , ,          ,      .    ,   .       ,  </span></span><code><span class="hljs-string"><span class="hljs-string">setText()</span></span></code><span class="hljs-string"><span class="hljs-string"> ,        .    ,    ,      ,   . ,  ,  .          ( </span></span><code><span class="hljs-string"><span class="hljs-string">Oscillator</span></span></code><span class="hljs-string"><span class="hljs-string"> , </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> , </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string"> ).    </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> , . .   </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">       Qt    .     </span></span><a href="https://github.com/pbhogan/Signals"><span class="hljs-string"><span class="hljs-string">Signals</span></span></a><span class="hljs-string"><span class="hljs-string">  .   .  </span></span><i><span class="hljs-string"><span class="hljs-string">Signal.h</span></span></i><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">GallantSignal.h</span></span></i><span class="hljs-string"><span class="hljs-string"> ,    .  </span></span><i><span class="hljs-string"><span class="hljs-string">Delegate.h</span></span></i><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">GallantSignal.h</span></span></i><span class="hljs-string"><span class="hljs-string">   ( ,   ,  </span></span><i><span class="hljs-string"><span class="hljs-string">‚ÄúCopy items into destination group'</span></span>s folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "GallantSignal.h" <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code><span class="hljs-built_in"><span class="hljs-built_in">public</span></span></code> : <br> <br> <code class="cpp">Signal2&lt; <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> &gt; noteOn; Signal2&lt; <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> &gt; noteOff;</code> <br> <br>  ,        <code><span class="hljs-type"><span class="hljs-type">int</span></span></code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> previously pressed key: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the last note was released, <span class="hljs-keyword"><span class="hljs-keyword">nothing</span></span> should play: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noteNumber == mLastNoteNumber) { mLastNoteNumber = <span class="hljs-number"><span class="hljs-number">-1</span></span>; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code><span class="hljs-number"><span class="hljs-number">-1</span></span></code> ,   :      <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp"><span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onNoteOn(const <span class="hljs-type"><span class="hljs-type">int</span></span> noteNumber, const <span class="hljs-type"><span class="hljs-type">int</span></span> velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onNoteOff(const <span class="hljs-type"><span class="hljs-type">int</span></span> noteNumber, const <span class="hljs-type"><span class="hljs-type">int</span></span> velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code><span class="hljs-keyword"><span class="hljs-keyword">if</span></span></code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins<span class="hljs-number"><span class="hljs-number">-011</span></span>-envelopes</a></code> </pre> <code><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> void EnvelopeGenerator::calculateMultiplier(double startLevel, double endLevel, unsigned long long lengthInSamples) { multiplier = 1.0 + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp">void EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = 0; if (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = 0; } else { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { case ENVELOPE_STAGE_OFF: currentLevel = 0.0; multiplier = 1.0; break; case ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, 1.0, nextStageSampleIndex); break; case ENVELOPE_STAGE_DECAY: currentLevel = 1.0; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; case ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = 1.0; break; case ENVELOPE_STAGE_RELEASE: // We could go from ATTACK/DECAY to RELEASE, // so we're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</code> <br> <br>    <code>currentStage</code>     <code>currentSampleIndex</code> .       <i> </i> .   ,       ,   . <code>stageValue[currentStage]</code>   <code>double</code> (   ), ,       ,     . <code>Switch</code>     .  OFF         (  ,    ). ATTACK    <code>minimumLevel</code> ,  <code>multiplier</code>   <code>currentLevel</code>  <code>1.0</code> .   DECAY       <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code> ,  <code>fmax</code> ,      . RELEASE  <code>currentLevel</code> ,     ,  <code>minimumLevel</code> .    ,    RELEASE    <code>currentLevel</code> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code>    ,  <i> </i> .         <code>currentLevel</code> . <br> <br>   <br> <br>        : <br> <br> <code class="cpp">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</code> <br> <br>   <code>private</code>  <code>Synthesis</code> (  )   : <br> <br> <code class="cpp">EnvelopeGenerator mEnvelopeGenerator;</code> <br> <br>   <code>#include "EnvelopeGenerator.h"</code>   . <br> ,   <code>ProcessDoubleReplacing</code> <i>Synthesis.cpp</i>   <code>leftOutput[i]</code>  : <br> <br> <code class="cpp">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</code> <br> <br>    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . <br>     <code>mEnvelopeGenerator</code>     .   <code>Synthesis::Reset()</code> : <br> <br> <code class="cpp">mEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>       .     -    ‚Äî        ! . <br> <br>    Note On/Off <br> <br>    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. <code>mMIDIReceiver</code>     note on/off,  ,  -    . <br> <br>         <code>#include EnvelopeGenerator.h</code>  <i>MIDIReceiver.h</i> . ,  <i>Synthesis.h</i>          <code>mEnvelopeGenerator</code>  <code>mMIDIReceiver</code> ,      .  <code>MIDIReceiver</code>   <code>enterStage</code>   note on/off. <br>  , . . <code>MIDIReceiver</code>    <code>EnvelopeGenerator</code> .       ,      <code>MIDIReceiver</code>   ,    <code>EnvelopeGenerator</code> . <br> <br>   <a href="http://qt-project.org/doc/qt-5/signalsandslots.html"></a>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"></a> .      Qt.    , ,          ,      .    ,   .       ,  <code>setText()</code> ,        .    ,    ,      ,   . ,  ,  .          ( <code>Oscillator</code> , <code>EnvelopeGenerator</code> , <code>MIDIReceiver</code> ).    <i> </i> , . .   <code>Synthesis</code> . <br> <br>       Qt    .     <a href="https://github.com/pbhogan/Signals">Signals</a>  .   .  <i>Signal.h</i>  <i>GallantSignal.h</i> ,    .  <i>Delegate.h</i>  <i>GallantSignal.h</i>   ( ,   ,  <i>‚ÄúCopy items into destination group's folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#include "GallantSignal.h" using Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code>public</code> : <br> <br> <code class="cpp">Signal2&lt; int, int &gt; noteOn; Signal2&lt; int, int &gt; noteOff;</code> <br> <br>  ,        <code>int</code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides any previously pressed key: if (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// If the last note was released, nothing should play: if (noteNumber == mLastNoteNumber) { mLastNoteNumber = -1; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code>-1</code> ,   :      RELEASE.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.Connect(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.Connect(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code>if</code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       RELEASE,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins-011-envelopes</a></code> <h3> <code><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> void EnvelopeGenerator::calculateMultiplier(double startLevel, double endLevel, unsigned long long lengthInSamples) { multiplier = 1.0 + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp">void EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = 0; if (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = 0; } else { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { case ENVELOPE_STAGE_OFF: currentLevel = 0.0; multiplier = 1.0; break; case ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, 1.0, nextStageSampleIndex); break; case ENVELOPE_STAGE_DECAY: currentLevel = 1.0; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; case ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = 1.0; break; case ENVELOPE_STAGE_RELEASE: // We could go from ATTACK/DECAY to RELEASE, // so we're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</code> <br> <br>    <code>currentStage</code>     <code>currentSampleIndex</code> .       <i> </i> .   ,       ,   . <code>stageValue[currentStage]</code>   <code>double</code> (   ), ,       ,     . <code>Switch</code>     .  OFF         (  ,    ). ATTACK    <code>minimumLevel</code> ,  <code>multiplier</code>   <code>currentLevel</code>  <code>1.0</code> .   DECAY       <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code> ,  <code>fmax</code> ,      . RELEASE  <code>currentLevel</code> ,     ,  <code>minimumLevel</code> .    ,    RELEASE    <code>currentLevel</code> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code>    ,  <i> </i> .         <code>currentLevel</code> . <br> <br>   <br> <br>        : <br> <br> <code class="cpp">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</code> <br> <br>   <code>private</code>  <code>Synthesis</code> (  )   : <br> <br> <code class="cpp">EnvelopeGenerator mEnvelopeGenerator;</code> <br> <br>   <code>#include "EnvelopeGenerator.h"</code>   . <br> ,   <code>ProcessDoubleReplacing</code> <i>Synthesis.cpp</i>   <code>leftOutput[i]</code>  : <br> <br> <code class="cpp">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</code> <br> <br>    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . <br>     <code>mEnvelopeGenerator</code>     .   <code>Synthesis::Reset()</code> : <br> <br> <code class="cpp">mEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>       .     -    ‚Äî        ! . <br> <br>    Note On/Off <br> <br>    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. <code>mMIDIReceiver</code>     note on/off,  ,  -    . <br> <br>         <code>#include EnvelopeGenerator.h</code>  <i>MIDIReceiver.h</i> . ,  <i>Synthesis.h</i>          <code>mEnvelopeGenerator</code>  <code>mMIDIReceiver</code> ,      .  <code>MIDIReceiver</code>   <code>enterStage</code>   note on/off. <br>  , . . <code>MIDIReceiver</code>    <code>EnvelopeGenerator</code> .       ,      <code>MIDIReceiver</code>   ,    <code>EnvelopeGenerator</code> . <br> <br>   <a href="http://qt-project.org/doc/qt-5/signalsandslots.html"></a>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"></a> .      Qt.    , ,          ,      .    ,   .       ,  <code>setText()</code> ,        .    ,    ,      ,   . ,  ,  .          ( <code>Oscillator</code> , <code>EnvelopeGenerator</code> , <code>MIDIReceiver</code> ).    <i> </i> , . .   <code>Synthesis</code> . <br> <br>       Qt    .     <a href="https://github.com/pbhogan/Signals">Signals</a>  .   .  <i>Signal.h</i>  <i>GallantSignal.h</i> ,    .  <i>Delegate.h</i>  <i>GallantSignal.h</i>   ( ,   ,  <i>‚ÄúCopy items into destination group's folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#include "GallantSignal.h" using Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code>public</code> : <br> <br> <code class="cpp">Signal2&lt; int, int &gt; noteOn; Signal2&lt; int, int &gt; noteOff;</code> <br> <br>  ,        <code>int</code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides any previously pressed key: if (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// If the last note was released, nothing should play: if (noteNumber == mLastNoteNumber) { mLastNoteNumber = -1; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code>-1</code> ,   :      RELEASE.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.Connect(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.Connect(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code>if</code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       RELEASE,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins-011-envelopes</a></code> </h3> <code><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> void EnvelopeGenerator::calculateMultiplier(double startLevel, double endLevel, unsigned long long lengthInSamples) { multiplier = 1.0 + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp">void EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = 0; if (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = 0; } else { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { case ENVELOPE_STAGE_OFF: currentLevel = 0.0; multiplier = 1.0; break; case ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, 1.0, nextStageSampleIndex); break; case ENVELOPE_STAGE_DECAY: currentLevel = 1.0; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; case ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = 1.0; break; case ENVELOPE_STAGE_RELEASE: // We could go from ATTACK/DECAY to RELEASE, // so we're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</code> <br> <br>    <code>currentStage</code>     <code>currentSampleIndex</code> .       <i> </i> .   ,       ,   . <code>stageValue[currentStage]</code>   <code>double</code> (   ), ,       ,     . <code>Switch</code>     .  OFF         (  ,    ). ATTACK    <code>minimumLevel</code> ,  <code>multiplier</code>   <code>currentLevel</code>  <code>1.0</code> .   DECAY       <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code> ,  <code>fmax</code> ,      . RELEASE  <code>currentLevel</code> ,     ,  <code>minimumLevel</code> .    ,    RELEASE    <code>currentLevel</code> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code>    ,  <i> </i> .         <code>currentLevel</code> . <br> <br>   <br> <br>        : <br> <br> <code class="cpp">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</code> <br> <br>   <code>private</code>  <code>Synthesis</code> (  )   : <br> <br> <code class="cpp">EnvelopeGenerator mEnvelopeGenerator;</code> <br> <br>   <code>#include "EnvelopeGenerator.h"</code>   . <br> ,   <code>ProcessDoubleReplacing</code> <i>Synthesis.cpp</i>   <code>leftOutput[i]</code>  : <br> <br> <code class="cpp">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</code> <br> <br>    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . <br>     <code>mEnvelopeGenerator</code>     .   <code>Synthesis::Reset()</code> : <br> <br> <code class="cpp">mEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>       .     -    ‚Äî        ! . <br> <br>    Note On/Off <br> <br>    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. <code>mMIDIReceiver</code>     note on/off,  ,  -    . <br> <br>         <code>#include EnvelopeGenerator.h</code>  <i>MIDIReceiver.h</i> . ,  <i>Synthesis.h</i>          <code>mEnvelopeGenerator</code>  <code>mMIDIReceiver</code> ,      .  <code>MIDIReceiver</code>   <code>enterStage</code>   note on/off. <br>  , . . <code>MIDIReceiver</code>    <code>EnvelopeGenerator</code> .       ,      <code>MIDIReceiver</code>   ,    <code>EnvelopeGenerator</code> . <br> <br>   <a href="http://qt-project.org/doc/qt-5/signalsandslots.html"></a>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"></a> .      Qt.    , ,          ,      .    ,   .       ,  <code>setText()</code> ,        .    ,    ,      ,   . ,  ,  .          ( <code>Oscillator</code> , <code>EnvelopeGenerator</code> , <code>MIDIReceiver</code> ).    <i> </i> , . .   <code>Synthesis</code> . <br> <br>       Qt    .     <a href="https://github.com/pbhogan/Signals">Signals</a>  .   .  <i>Signal.h</i>  <i>GallantSignal.h</i> ,    .  <i>Delegate.h</i>  <i>GallantSignal.h</i>   ( ,   ,  <i>‚ÄúCopy items into destination group's folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#include "GallantSignal.h" using Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code>public</code> : <br> <br> <code class="cpp">Signal2&lt; int, int &gt; noteOn; Signal2&lt; int, int &gt; noteOff;</code> <br> <br>  ,        <code>int</code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides any previously pressed key: if (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// If the last note was released, nothing should play: if (noteNumber == mLastNoteNumber) { mLastNoteNumber = -1; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code>-1</code> ,   :      RELEASE.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.Connect(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.Connect(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code>if</code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       RELEASE,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins-011-envelopes</a></code> <pre> <code class="hljs pgsql"><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> <span class="hljs-type"><span class="hljs-type">void</span></span> EnvelopeGenerator::calculateMultiplier(<span class="hljs-type"><span class="hljs-type">double</span></span> startLevel, <span class="hljs-type"><span class="hljs-type">double</span></span> endLevel, unsigned long long lengthInSamples) { multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span> + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp"><span class="hljs-type"><span class="hljs-type">void</span></span> EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_OFF: currentLevel = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, nextStageSampleIndex); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_DECAY: currentLevel = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_RELEASE: // We could go <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ATTACK/DECAY <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>, // so w<span class="hljs-string"><span class="hljs-string">e're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    </span></span><code><span class="hljs-string"><span class="hljs-string">currentStage</span></span></code><span class="hljs-string"><span class="hljs-string">     </span></span><code><span class="hljs-string"><span class="hljs-string">currentSampleIndex</span></span></code><span class="hljs-string"><span class="hljs-string"> .       </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> .   ,       ,   . </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[currentStage]</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">double</span></span></code><span class="hljs-string"><span class="hljs-string"> (   ), ,       ,     . </span></span><code><span class="hljs-string"><span class="hljs-string">Switch</span></span></code><span class="hljs-string"><span class="hljs-string">     .  OFF         (  ,    ). ATTACK    </span></span><code><span class="hljs-string"><span class="hljs-string">minimumLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> ,  </span></span><code><span class="hljs-string"><span class="hljs-string">multiplier</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">1.0</span></span></code><span class="hljs-string"><span class="hljs-string"> .   DECAY       </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[ENVELOPE_STAGE_SUSTAIN]</span></span></code><span class="hljs-string"><span class="hljs-string"> ,  </span></span><code><span class="hljs-string"><span class="hljs-string">fmax</span></span></code><span class="hljs-string"><span class="hljs-string"> ,      . RELEASE  </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> ,     ,  </span></span><code><span class="hljs-string"><span class="hljs-string">minimumLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> .    ,    RELEASE    </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[ENVELOPE_STAGE_SUSTAIN]</span></span></code><span class="hljs-string"><span class="hljs-string">    ,  </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> .         </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">        : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">private</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis</span></span></code><span class="hljs-string"><span class="hljs-string"> (  )   : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator mEnvelopeGenerator;</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">#include "EnvelopeGenerator.h"</span></span></code><span class="hljs-string"><span class="hljs-string">   . </span></span><br><span class="hljs-string"><span class="hljs-string"> ,   </span></span><code><span class="hljs-string"><span class="hljs-string">ProcessDoubleReplacing</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><i><span class="hljs-string"><span class="hljs-string">Synthesis.cpp</span></span></i><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">leftOutput[i]</span></span></code><span class="hljs-string"><span class="hljs-string">  : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . </span></span><br><span class="hljs-string"><span class="hljs-string">     </span></span><code><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string">     .   </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis::Reset()</span></span></code><span class="hljs-string"><span class="hljs-string"> : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator.setSampleRate(GetSampleRate());</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">       .     -    ‚Äî        ! . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    Note On/Off </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. </span></span><code><span class="hljs-string"><span class="hljs-string">mMIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">     note on/off,  ,  -    . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">         </span></span><code><span class="hljs-string"><span class="hljs-string">#include EnvelopeGenerator.h</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">MIDIReceiver.h</span></span></i><span class="hljs-string"><span class="hljs-string"> . ,  </span></span><i><span class="hljs-string"><span class="hljs-string">Synthesis.h</span></span></i><span class="hljs-string"><span class="hljs-string">          </span></span><code><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">mMIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string"> ,      .  </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">enterStage</span></span></code><span class="hljs-string"><span class="hljs-string">   note on/off. </span></span><br><span class="hljs-string"><span class="hljs-string">  , . . </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">    </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> .       ,      </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">   ,    </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><a href="http://qt-project.org/doc/qt-5/signalsandslots.html"><span class="hljs-string"><span class="hljs-string"></span></span></a><span class="hljs-string"><span class="hljs-string">  </span></span><a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"><span class="hljs-string"><span class="hljs-string"></span></span></a><span class="hljs-string"><span class="hljs-string"> .      Qt.    , ,          ,      .    ,   .       ,  </span></span><code><span class="hljs-string"><span class="hljs-string">setText()</span></span></code><span class="hljs-string"><span class="hljs-string"> ,        .    ,    ,      ,   . ,  ,  .          ( </span></span><code><span class="hljs-string"><span class="hljs-string">Oscillator</span></span></code><span class="hljs-string"><span class="hljs-string"> , </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> , </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string"> ).    </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> , . .   </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">       Qt    .     </span></span><a href="https://github.com/pbhogan/Signals"><span class="hljs-string"><span class="hljs-string">Signals</span></span></a><span class="hljs-string"><span class="hljs-string">  .   .  </span></span><i><span class="hljs-string"><span class="hljs-string">Signal.h</span></span></i><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">GallantSignal.h</span></span></i><span class="hljs-string"><span class="hljs-string"> ,    .  </span></span><i><span class="hljs-string"><span class="hljs-string">Delegate.h</span></span></i><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">GallantSignal.h</span></span></i><span class="hljs-string"><span class="hljs-string">   ( ,   ,  </span></span><i><span class="hljs-string"><span class="hljs-string">‚ÄúCopy items into destination group'</span></span>s folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "GallantSignal.h" <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code><span class="hljs-built_in"><span class="hljs-built_in">public</span></span></code> : <br> <br> <code class="cpp">Signal2&lt; <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> &gt; noteOn; Signal2&lt; <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> &gt; noteOff;</code> <br> <br>  ,        <code><span class="hljs-type"><span class="hljs-type">int</span></span></code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> previously pressed key: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the last note was released, <span class="hljs-keyword"><span class="hljs-keyword">nothing</span></span> should play: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noteNumber == mLastNoteNumber) { mLastNoteNumber = <span class="hljs-number"><span class="hljs-number">-1</span></span>; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code><span class="hljs-number"><span class="hljs-number">-1</span></span></code> ,   :      <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp"><span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onNoteOn(const <span class="hljs-type"><span class="hljs-type">int</span></span> noteNumber, const <span class="hljs-type"><span class="hljs-type">int</span></span> velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onNoteOff(const <span class="hljs-type"><span class="hljs-type">int</span></span> noteNumber, const <span class="hljs-type"><span class="hljs-type">int</span></span> velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code><span class="hljs-keyword"><span class="hljs-keyword">if</span></span></code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins<span class="hljs-number"><span class="hljs-number">-011</span></span>-envelopes</a></code> </pre> <code><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> void EnvelopeGenerator::calculateMultiplier(double startLevel, double endLevel, unsigned long long lengthInSamples) { multiplier = 1.0 + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp">void EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = 0; if (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = 0; } else { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { case ENVELOPE_STAGE_OFF: currentLevel = 0.0; multiplier = 1.0; break; case ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, 1.0, nextStageSampleIndex); break; case ENVELOPE_STAGE_DECAY: currentLevel = 1.0; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; case ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = 1.0; break; case ENVELOPE_STAGE_RELEASE: // We could go from ATTACK/DECAY to RELEASE, // so we're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</code> <br> <br>    <code>currentStage</code>     <code>currentSampleIndex</code> .       <i> </i> .   ,       ,   . <code>stageValue[currentStage]</code>   <code>double</code> (   ), ,       ,     . <code>Switch</code>     .  OFF         (  ,    ). ATTACK    <code>minimumLevel</code> ,  <code>multiplier</code>   <code>currentLevel</code>  <code>1.0</code> .   DECAY       <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code> ,  <code>fmax</code> ,      . RELEASE  <code>currentLevel</code> ,     ,  <code>minimumLevel</code> .    ,    RELEASE    <code>currentLevel</code> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code>    ,  <i> </i> .         <code>currentLevel</code> . <br> <br>   <br> <br>        : <br> <br> <code class="cpp">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</code> <br> <br>   <code>private</code>  <code>Synthesis</code> (  )   : <br> <br> <code class="cpp">EnvelopeGenerator mEnvelopeGenerator;</code> <br> <br>   <code>#include "EnvelopeGenerator.h"</code>   . <br> ,   <code>ProcessDoubleReplacing</code> <i>Synthesis.cpp</i>   <code>leftOutput[i]</code>  : <br> <br> <code class="cpp">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</code> <br> <br>    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . <br>     <code>mEnvelopeGenerator</code>     .   <code>Synthesis::Reset()</code> : <br> <br> <code class="cpp">mEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>       .     -    ‚Äî        ! . <br> <br>    Note On/Off <br> <br>    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. <code>mMIDIReceiver</code>     note on/off,  ,  -    . <br> <br>         <code>#include EnvelopeGenerator.h</code>  <i>MIDIReceiver.h</i> . ,  <i>Synthesis.h</i>          <code>mEnvelopeGenerator</code>  <code>mMIDIReceiver</code> ,      .  <code>MIDIReceiver</code>   <code>enterStage</code>   note on/off. <br>  , . . <code>MIDIReceiver</code>    <code>EnvelopeGenerator</code> .       ,      <code>MIDIReceiver</code>   ,    <code>EnvelopeGenerator</code> . <br> <br>   <a href="http://qt-project.org/doc/qt-5/signalsandslots.html"></a>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"></a> .      Qt.    , ,          ,      .    ,   .       ,  <code>setText()</code> ,        .    ,    ,      ,   . ,  ,  .          ( <code>Oscillator</code> , <code>EnvelopeGenerator</code> , <code>MIDIReceiver</code> ).    <i> </i> , . .   <code>Synthesis</code> . <br> <br>       Qt    .     <a href="https://github.com/pbhogan/Signals">Signals</a>  .   .  <i>Signal.h</i>  <i>GallantSignal.h</i> ,    .  <i>Delegate.h</i>  <i>GallantSignal.h</i>   ( ,   ,  <i>‚ÄúCopy items into destination group's folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#include "GallantSignal.h" using Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code>public</code> : <br> <br> <code class="cpp">Signal2&lt; int, int &gt; noteOn; Signal2&lt; int, int &gt; noteOff;</code> <br> <br>  ,        <code>int</code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides any previously pressed key: if (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// If the last note was released, nothing should play: if (noteNumber == mLastNoteNumber) { mLastNoteNumber = -1; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code>-1</code> ,   :      RELEASE.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.Connect(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.Connect(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code>if</code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       RELEASE,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins-011-envelopes</a></code> <pre> <code class="hljs pgsql"><code class="cpp"><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> <span class="hljs-type"><span class="hljs-type">void</span></span> EnvelopeGenerator::calculateMultiplier(<span class="hljs-type"><span class="hljs-type">double</span></span> startLevel, <span class="hljs-type"><span class="hljs-type">double</span></span> endLevel, unsigned long long lengthInSamples) { multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span> + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp"><span class="hljs-type"><span class="hljs-type">void</span></span> EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_OFF: currentLevel = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, nextStageSampleIndex); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_DECAY: currentLevel = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_RELEASE: // We could go <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ATTACK/DECAY <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>, // so w<span class="hljs-string"><span class="hljs-string">e're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    </span></span><code><span class="hljs-string"><span class="hljs-string">currentStage</span></span></code><span class="hljs-string"><span class="hljs-string">     </span></span><code><span class="hljs-string"><span class="hljs-string">currentSampleIndex</span></span></code><span class="hljs-string"><span class="hljs-string"> .       </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> .   ,       ,   . </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[currentStage]</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">double</span></span></code><span class="hljs-string"><span class="hljs-string"> (   ), ,       ,     . </span></span><code><span class="hljs-string"><span class="hljs-string">Switch</span></span></code><span class="hljs-string"><span class="hljs-string">     .  OFF         (  ,    ). ATTACK    </span></span><code><span class="hljs-string"><span class="hljs-string">minimumLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> ,  </span></span><code><span class="hljs-string"><span class="hljs-string">multiplier</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">1.0</span></span></code><span class="hljs-string"><span class="hljs-string"> .   DECAY       </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[ENVELOPE_STAGE_SUSTAIN]</span></span></code><span class="hljs-string"><span class="hljs-string"> ,  </span></span><code><span class="hljs-string"><span class="hljs-string">fmax</span></span></code><span class="hljs-string"><span class="hljs-string"> ,      . RELEASE  </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> ,     ,  </span></span><code><span class="hljs-string"><span class="hljs-string">minimumLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> .    ,    RELEASE    </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[ENVELOPE_STAGE_SUSTAIN]</span></span></code><span class="hljs-string"><span class="hljs-string">    ,  </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> .         </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">        : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">private</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis</span></span></code><span class="hljs-string"><span class="hljs-string"> (  )   : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> EnvelopeGenerator mEnvelopeGenerator; </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">#include "EnvelopeGenerator.h"</span></span></code><span class="hljs-string"><span class="hljs-string">   . </span></span><br><span class="hljs-string"><span class="hljs-string"> ,   </span></span><code><span class="hljs-string"><span class="hljs-string">ProcessDoubleReplacing</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><i><span class="hljs-string"><span class="hljs-string">Synthesis.cpp</span></span></i><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">leftOutput[i]</span></span></code><span class="hljs-string"><span class="hljs-string">  : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . </span></span><br><span class="hljs-string"><span class="hljs-string">     </span></span><code><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string">     .   </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis::Reset()</span></span></code><span class="hljs-string"><span class="hljs-string"> : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator.setSampleRate(GetSampleRate());</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">       .     -    ‚Äî        ! . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    Note On/Off </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. </span></span><code><span class="hljs-string"><span class="hljs-string">mMIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">     note on/off,  ,  -    . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">         </span></span><code><span class="hljs-string"><span class="hljs-string">#include EnvelopeGenerator.h</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">MIDIReceiver.h</span></span></i><span class="hljs-string"><span class="hljs-string"> . ,  </span></span><i><span class="hljs-string"><span class="hljs-string">Synthesis.h</span></span></i><span class="hljs-string"><span class="hljs-string">          </span></span><code><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">mMIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string"> ,      .  </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">enterStage</span></span></code><span class="hljs-string"><span class="hljs-string">   note on/off. </span></span><br><span class="hljs-string"><span class="hljs-string">  , . . </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">    </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> .       ,      </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">   ,    </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><a href="http://qt-project.org/doc/qt-5/signalsandslots.html"><span class="hljs-string"><span class="hljs-string"></span></span></a><span class="hljs-string"><span class="hljs-string">  </span></span><a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"><span class="hljs-string"><span class="hljs-string"></span></span></a><span class="hljs-string"><span class="hljs-string"> .      Qt.    , ,          ,      .    ,   .       ,  </span></span><code><span class="hljs-string"><span class="hljs-string">setText()</span></span></code><span class="hljs-string"><span class="hljs-string"> ,        .    ,    ,      ,   . ,  ,  .          ( </span></span><code><span class="hljs-string"><span class="hljs-string">Oscillator</span></span></code><span class="hljs-string"><span class="hljs-string"> , </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> , </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string"> ).    </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> , . .   </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">       Qt    .     </span></span><a href="https://github.com/pbhogan/Signals"><span class="hljs-string"><span class="hljs-string">Signals</span></span></a><span class="hljs-string"><span class="hljs-string">  .   .  </span></span><i><span class="hljs-string"><span class="hljs-string">Signal.h</span></span></i><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">GallantSignal.h</span></span></i><span class="hljs-string"><span class="hljs-string"> ,    .  </span></span><i><span class="hljs-string"><span class="hljs-string">Delegate.h</span></span></i><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">GallantSignal.h</span></span></i><span class="hljs-string"><span class="hljs-string">   ( ,   ,  </span></span><i><span class="hljs-string"><span class="hljs-string">‚ÄúCopy items into destination group'</span></span>s folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "GallantSignal.h" <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code><span class="hljs-built_in"><span class="hljs-built_in">public</span></span></code> : <br> <br> <code class="cpp">Signal2&lt; <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> &gt; noteOn; Signal2&lt; <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> &gt; noteOff;</code> <br> <br>  ,        <code><span class="hljs-type"><span class="hljs-type">int</span></span></code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> previously pressed key: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the last note was released, <span class="hljs-keyword"><span class="hljs-keyword">nothing</span></span> should play: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noteNumber == mLastNoteNumber) { mLastNoteNumber = <span class="hljs-number"><span class="hljs-number">-1</span></span>; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code><span class="hljs-number"><span class="hljs-number">-1</span></span></code> ,   :      <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp"><span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onNoteOn(const <span class="hljs-type"><span class="hljs-type">int</span></span> noteNumber, const <span class="hljs-type"><span class="hljs-type">int</span></span> velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onNoteOff(const <span class="hljs-type"><span class="hljs-type">int</span></span> noteNumber, const <span class="hljs-type"><span class="hljs-type">int</span></span> velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code><span class="hljs-keyword"><span class="hljs-keyword">if</span></span></code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins<span class="hljs-number"><span class="hljs-number">-011</span></span>-envelopes</a></code></code> </pre> <code><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> void EnvelopeGenerator::calculateMultiplier(double startLevel, double endLevel, unsigned long long lengthInSamples) { multiplier = 1.0 + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp">void EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = 0; if (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = 0; } else { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { case ENVELOPE_STAGE_OFF: currentLevel = 0.0; multiplier = 1.0; break; case ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, 1.0, nextStageSampleIndex); break; case ENVELOPE_STAGE_DECAY: currentLevel = 1.0; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; case ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = 1.0; break; case ENVELOPE_STAGE_RELEASE: // We could go from ATTACK/DECAY to RELEASE, // so we're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</code> <br> <br>    <code>currentStage</code>     <code>currentSampleIndex</code> .       <i> </i> .   ,       ,   . <code>stageValue[currentStage]</code>   <code>double</code> (   ), ,       ,     . <code>Switch</code>     .  OFF         (  ,    ). ATTACK    <code>minimumLevel</code> ,  <code>multiplier</code>   <code>currentLevel</code>  <code>1.0</code> .   DECAY       <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code> ,  <code>fmax</code> ,      . RELEASE  <code>currentLevel</code> ,     ,  <code>minimumLevel</code> .    ,    RELEASE    <code>currentLevel</code> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code>    ,  <i> </i> .         <code>currentLevel</code> . <br> <br>   <br> <br>        : <br> <br> <code class="cpp">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</code> <br> <br>   <code>private</code>  <code>Synthesis</code> (  )   : <br> <br> <code class="cpp">EnvelopeGenerator mEnvelopeGenerator;</code> <br> <br>   <code>#include "EnvelopeGenerator.h"</code>   . <br> ,   <code>ProcessDoubleReplacing</code> <i>Synthesis.cpp</i>   <code>leftOutput[i]</code>  : <br> <br> <code class="cpp">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</code> <br> <br>    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . <br>     <code>mEnvelopeGenerator</code>     .   <code>Synthesis::Reset()</code> : <br> <br> <code class="cpp">mEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>       .     -    ‚Äî        ! . <br> <br>    Note On/Off <br> <br>    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. <code>mMIDIReceiver</code>     note on/off,  ,  -    . <br> <br>         <code>#include EnvelopeGenerator.h</code>  <i>MIDIReceiver.h</i> . ,  <i>Synthesis.h</i>          <code>mEnvelopeGenerator</code>  <code>mMIDIReceiver</code> ,      .  <code>MIDIReceiver</code>   <code>enterStage</code>   note on/off. <br>  , . . <code>MIDIReceiver</code>    <code>EnvelopeGenerator</code> .       ,      <code>MIDIReceiver</code>   ,    <code>EnvelopeGenerator</code> . <br> <br>   <a href="http://qt-project.org/doc/qt-5/signalsandslots.html"></a>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"></a> .      Qt.    , ,          ,      .    ,   .       ,  <code>setText()</code> ,        .    ,    ,      ,   . ,  ,  .          ( <code>Oscillator</code> , <code>EnvelopeGenerator</code> , <code>MIDIReceiver</code> ).    <i> </i> , . .   <code>Synthesis</code> . <br> <br>       Qt    .     <a href="https://github.com/pbhogan/Signals">Signals</a>  .   .  <i>Signal.h</i>  <i>GallantSignal.h</i> ,    .  <i>Delegate.h</i>  <i>GallantSignal.h</i>   ( ,   ,  <i>‚ÄúCopy items into destination group's folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#include "GallantSignal.h" using Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code>public</code> : <br> <br> <code class="cpp">Signal2&lt; int, int &gt; noteOn; Signal2&lt; int, int &gt; noteOff;</code> <br> <br>  ,        <code>int</code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides any previously pressed key: if (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// If the last note was released, nothing should play: if (noteNumber == mLastNoteNumber) { mLastNoteNumber = -1; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code>-1</code> ,   :      RELEASE.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.Connect(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.Connect(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code>if</code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       RELEASE,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins-011-envelopes</a></code> <pre> <code class="hljs pgsql"><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> <span class="hljs-type"><span class="hljs-type">void</span></span> EnvelopeGenerator::calculateMultiplier(<span class="hljs-type"><span class="hljs-type">double</span></span> startLevel, <span class="hljs-type"><span class="hljs-type">double</span></span> endLevel, unsigned long long lengthInSamples) { multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span> + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp"><span class="hljs-type"><span class="hljs-type">void</span></span> EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_OFF: currentLevel = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, nextStageSampleIndex); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_DECAY: currentLevel = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_RELEASE: // We could go <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ATTACK/DECAY <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>, // so w<span class="hljs-string"><span class="hljs-string">e're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    </span></span><code><span class="hljs-string"><span class="hljs-string">currentStage</span></span></code><span class="hljs-string"><span class="hljs-string">     </span></span><code><span class="hljs-string"><span class="hljs-string">currentSampleIndex</span></span></code><span class="hljs-string"><span class="hljs-string"> .       </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> .   ,       ,   . </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[currentStage]</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">double</span></span></code><span class="hljs-string"><span class="hljs-string"> (   ), ,       ,     . </span></span><code><span class="hljs-string"><span class="hljs-string">Switch</span></span></code><span class="hljs-string"><span class="hljs-string">     .  OFF         (  ,    ). ATTACK    </span></span><code><span class="hljs-string"><span class="hljs-string">minimumLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> ,  </span></span><code><span class="hljs-string"><span class="hljs-string">multiplier</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">1.0</span></span></code><span class="hljs-string"><span class="hljs-string"> .   DECAY       </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[ENVELOPE_STAGE_SUSTAIN]</span></span></code><span class="hljs-string"><span class="hljs-string"> ,  </span></span><code><span class="hljs-string"><span class="hljs-string">fmax</span></span></code><span class="hljs-string"><span class="hljs-string"> ,      . RELEASE  </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> ,     ,  </span></span><code><span class="hljs-string"><span class="hljs-string">minimumLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> .    ,    RELEASE    </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[ENVELOPE_STAGE_SUSTAIN]</span></span></code><span class="hljs-string"><span class="hljs-string">    ,  </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> .         </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">        : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">private</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis</span></span></code><span class="hljs-string"><span class="hljs-string"> (  )   : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator mEnvelopeGenerator;</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">#include "EnvelopeGenerator.h"</span></span></code><span class="hljs-string"><span class="hljs-string">   . </span></span><br><span class="hljs-string"><span class="hljs-string"> ,   </span></span><code><span class="hljs-string"><span class="hljs-string">ProcessDoubleReplacing</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><i><span class="hljs-string"><span class="hljs-string">Synthesis.cpp</span></span></i><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">leftOutput[i]</span></span></code><span class="hljs-string"><span class="hljs-string">  : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . </span></span><br><span class="hljs-string"><span class="hljs-string">     </span></span><code><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string">     .   </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis::Reset()</span></span></code><span class="hljs-string"><span class="hljs-string"> : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator.setSampleRate(GetSampleRate());</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">       .     -    ‚Äî        ! . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    Note On/Off </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. </span></span><code><span class="hljs-string"><span class="hljs-string">mMIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">     note on/off,  ,  -    . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">         </span></span><code><span class="hljs-string"><span class="hljs-string">#include EnvelopeGenerator.h</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">MIDIReceiver.h</span></span></i><span class="hljs-string"><span class="hljs-string"> . ,  </span></span><i><span class="hljs-string"><span class="hljs-string">Synthesis.h</span></span></i><span class="hljs-string"><span class="hljs-string">          </span></span><code><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">mMIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string"> ,      .  </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">enterStage</span></span></code><span class="hljs-string"><span class="hljs-string">   note on/off. </span></span><br><span class="hljs-string"><span class="hljs-string">  , . . </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">    </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> .       ,      </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">   ,    </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><a href="http://qt-project.org/doc/qt-5/signalsandslots.html"><span class="hljs-string"><span class="hljs-string"></span></span></a><span class="hljs-string"><span class="hljs-string">  </span></span><a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"><span class="hljs-string"><span class="hljs-string"></span></span></a><span class="hljs-string"><span class="hljs-string"> .      Qt.    , ,          ,      .    ,   .       ,  </span></span><code><span class="hljs-string"><span class="hljs-string">setText()</span></span></code><span class="hljs-string"><span class="hljs-string"> ,        .    ,    ,      ,   . ,  ,  .          ( </span></span><code><span class="hljs-string"><span class="hljs-string">Oscillator</span></span></code><span class="hljs-string"><span class="hljs-string"> , </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> , </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string"> ).    </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> , . .   </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">       Qt    .     </span></span><a href="https://github.com/pbhogan/Signals"><span class="hljs-string"><span class="hljs-string">Signals</span></span></a><span class="hljs-string"><span class="hljs-string">  .   .  </span></span><i><span class="hljs-string"><span class="hljs-string">Signal.h</span></span></i><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">GallantSignal.h</span></span></i><span class="hljs-string"><span class="hljs-string"> ,    .  </span></span><i><span class="hljs-string"><span class="hljs-string">Delegate.h</span></span></i><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">GallantSignal.h</span></span></i><span class="hljs-string"><span class="hljs-string">   ( ,   ,  </span></span><i><span class="hljs-string"><span class="hljs-string">‚ÄúCopy items into destination group'</span></span>s folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "GallantSignal.h" <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code><span class="hljs-built_in"><span class="hljs-built_in">public</span></span></code> : <br> <br> <code class="cpp">Signal2&lt; <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> &gt; noteOn; Signal2&lt; <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> &gt; noteOff;</code> <br> <br>  ,        <code><span class="hljs-type"><span class="hljs-type">int</span></span></code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> previously pressed key: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the last note was released, <span class="hljs-keyword"><span class="hljs-keyword">nothing</span></span> should play: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noteNumber == mLastNoteNumber) { mLastNoteNumber = <span class="hljs-number"><span class="hljs-number">-1</span></span>; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code><span class="hljs-number"><span class="hljs-number">-1</span></span></code> ,   :      <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp"><span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onNoteOn(const <span class="hljs-type"><span class="hljs-type">int</span></span> noteNumber, const <span class="hljs-type"><span class="hljs-type">int</span></span> velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onNoteOff(const <span class="hljs-type"><span class="hljs-type">int</span></span> noteNumber, const <span class="hljs-type"><span class="hljs-type">int</span></span> velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code><span class="hljs-keyword"><span class="hljs-keyword">if</span></span></code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins<span class="hljs-number"><span class="hljs-number">-011</span></span>-envelopes</a></code> </pre> <code><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> void EnvelopeGenerator::calculateMultiplier(double startLevel, double endLevel, unsigned long long lengthInSamples) { multiplier = 1.0 + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp">void EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = 0; if (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = 0; } else { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { case ENVELOPE_STAGE_OFF: currentLevel = 0.0; multiplier = 1.0; break; case ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, 1.0, nextStageSampleIndex); break; case ENVELOPE_STAGE_DECAY: currentLevel = 1.0; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; case ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = 1.0; break; case ENVELOPE_STAGE_RELEASE: // We could go from ATTACK/DECAY to RELEASE, // so we're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</code> <br> <br>    <code>currentStage</code>     <code>currentSampleIndex</code> .       <i> </i> .   ,       ,   . <code>stageValue[currentStage]</code>   <code>double</code> (   ), ,       ,     . <code>Switch</code>     .  OFF         (  ,    ). ATTACK    <code>minimumLevel</code> ,  <code>multiplier</code>   <code>currentLevel</code>  <code>1.0</code> .   DECAY       <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code> ,  <code>fmax</code> ,      . RELEASE  <code>currentLevel</code> ,     ,  <code>minimumLevel</code> .    ,    RELEASE    <code>currentLevel</code> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code>    ,  <i> </i> .         <code>currentLevel</code> . <br> <br>   <br> <br>        : <br> <br> <code class="cpp">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</code> <br> <br>   <code>private</code>  <code>Synthesis</code> (  )   : <br> <br> <code class="cpp">EnvelopeGenerator mEnvelopeGenerator;</code> <br> <br>   <code>#include "EnvelopeGenerator.h"</code>   . <br> ,   <code>ProcessDoubleReplacing</code> <i>Synthesis.cpp</i>   <code>leftOutput[i]</code>  : <br> <br> <code class="cpp">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</code> <br> <br>    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . <br>     <code>mEnvelopeGenerator</code>     .   <code>Synthesis::Reset()</code> : <br> <br> <code class="cpp">mEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>       .     -    ‚Äî        ! . <br> <br>    Note On/Off <br> <br>    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. <code>mMIDIReceiver</code>     note on/off,  ,  -    . <br> <br>         <code>#include EnvelopeGenerator.h</code>  <i>MIDIReceiver.h</i> . ,  <i>Synthesis.h</i>          <code>mEnvelopeGenerator</code>  <code>mMIDIReceiver</code> ,      .  <code>MIDIReceiver</code>   <code>enterStage</code>   note on/off. <br>  , . . <code>MIDIReceiver</code>    <code>EnvelopeGenerator</code> .       ,      <code>MIDIReceiver</code>   ,    <code>EnvelopeGenerator</code> . <br> <br>   <a href="http://qt-project.org/doc/qt-5/signalsandslots.html"></a>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"></a> .      Qt.    , ,          ,      .    ,   .       ,  <code>setText()</code> ,        .    ,    ,      ,   . ,  ,  .          ( <code>Oscillator</code> , <code>EnvelopeGenerator</code> , <code>MIDIReceiver</code> ).    <i> </i> , . .   <code>Synthesis</code> . <br> <br>       Qt    .     <a href="https://github.com/pbhogan/Signals">Signals</a>  .   .  <i>Signal.h</i>  <i>GallantSignal.h</i> ,    .  <i>Delegate.h</i>  <i>GallantSignal.h</i>   ( ,   ,  <i>‚ÄúCopy items into destination group's folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#include "GallantSignal.h" using Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code>public</code> : <br> <br> <code class="cpp">Signal2&lt; int, int &gt; noteOn; Signal2&lt; int, int &gt; noteOff;</code> <br> <br>  ,        <code>int</code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides any previously pressed key: if (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// If the last note was released, nothing should play: if (noteNumber == mLastNoteNumber) { mLastNoteNumber = -1; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code>-1</code> ,   :      RELEASE.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.Connect(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.Connect(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code>if</code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       RELEASE,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins-011-envelopes</a></code> <pre> <code class="hljs pgsql"><code class="cpp"><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> <span class="hljs-type"><span class="hljs-type">void</span></span> EnvelopeGenerator::calculateMultiplier(<span class="hljs-type"><span class="hljs-type">double</span></span> startLevel, <span class="hljs-type"><span class="hljs-type">double</span></span> endLevel, unsigned long long lengthInSamples) { multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span> + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp"><span class="hljs-type"><span class="hljs-type">void</span></span> EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_OFF: currentLevel = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, nextStageSampleIndex); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_DECAY: currentLevel = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_RELEASE: // We could go <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ATTACK/DECAY <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>, // so w<span class="hljs-string"><span class="hljs-string">e're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    </span></span><code><span class="hljs-string"><span class="hljs-string">currentStage</span></span></code><span class="hljs-string"><span class="hljs-string">     </span></span><code><span class="hljs-string"><span class="hljs-string">currentSampleIndex</span></span></code><span class="hljs-string"><span class="hljs-string"> .       </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> .   ,       ,   . </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[currentStage]</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">double</span></span></code><span class="hljs-string"><span class="hljs-string"> (   ), ,       ,     . </span></span><code><span class="hljs-string"><span class="hljs-string">Switch</span></span></code><span class="hljs-string"><span class="hljs-string">     .  OFF         (  ,    ). ATTACK    </span></span><code><span class="hljs-string"><span class="hljs-string">minimumLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> ,  </span></span><code><span class="hljs-string"><span class="hljs-string">multiplier</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">1.0</span></span></code><span class="hljs-string"><span class="hljs-string"> .   DECAY       </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[ENVELOPE_STAGE_SUSTAIN]</span></span></code><span class="hljs-string"><span class="hljs-string"> ,  </span></span><code><span class="hljs-string"><span class="hljs-string">fmax</span></span></code><span class="hljs-string"><span class="hljs-string"> ,      . RELEASE  </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> ,     ,  </span></span><code><span class="hljs-string"><span class="hljs-string">minimumLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> .    ,    RELEASE    </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[ENVELOPE_STAGE_SUSTAIN]</span></span></code><span class="hljs-string"><span class="hljs-string">    ,  </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> .         </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">        : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">private</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis</span></span></code><span class="hljs-string"><span class="hljs-string"> (  )   : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator mEnvelopeGenerator;</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">#include "EnvelopeGenerator.h"</span></span></code><span class="hljs-string"><span class="hljs-string">   . </span></span><br><span class="hljs-string"><span class="hljs-string"> ,   </span></span><code><span class="hljs-string"><span class="hljs-string">ProcessDoubleReplacing</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><i><span class="hljs-string"><span class="hljs-string">Synthesis.cpp</span></span></i><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">leftOutput[i]</span></span></code><span class="hljs-string"><span class="hljs-string">  : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . </span></span><br><span class="hljs-string"><span class="hljs-string">     </span></span><code><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string">     .   </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis::Reset()</span></span></code><span class="hljs-string"><span class="hljs-string"> : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> mEnvelopeGenerator.setSampleRate(GetSampleRate()); </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">       .     -    ‚Äî        ! . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    Note On/Off </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. </span></span><code><span class="hljs-string"><span class="hljs-string">mMIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">     note on/off,  ,  -    . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">         </span></span><code><span class="hljs-string"><span class="hljs-string">#include EnvelopeGenerator.h</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">MIDIReceiver.h</span></span></i><span class="hljs-string"><span class="hljs-string"> . ,  </span></span><i><span class="hljs-string"><span class="hljs-string">Synthesis.h</span></span></i><span class="hljs-string"><span class="hljs-string">          </span></span><code><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">mMIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string"> ,      .  </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">enterStage</span></span></code><span class="hljs-string"><span class="hljs-string">   note on/off. </span></span><br><span class="hljs-string"><span class="hljs-string">  , . . </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">    </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> .       ,      </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">   ,    </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><a href="http://qt-project.org/doc/qt-5/signalsandslots.html"><span class="hljs-string"><span class="hljs-string"></span></span></a><span class="hljs-string"><span class="hljs-string">  </span></span><a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"><span class="hljs-string"><span class="hljs-string"></span></span></a><span class="hljs-string"><span class="hljs-string"> .      Qt.    , ,          ,      .    ,   .       ,  </span></span><code><span class="hljs-string"><span class="hljs-string">setText()</span></span></code><span class="hljs-string"><span class="hljs-string"> ,        .    ,    ,      ,   . ,  ,  .          ( </span></span><code><span class="hljs-string"><span class="hljs-string">Oscillator</span></span></code><span class="hljs-string"><span class="hljs-string"> , </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> , </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string"> ).    </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> , . .   </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">       Qt    .     </span></span><a href="https://github.com/pbhogan/Signals"><span class="hljs-string"><span class="hljs-string">Signals</span></span></a><span class="hljs-string"><span class="hljs-string">  .   .  </span></span><i><span class="hljs-string"><span class="hljs-string">Signal.h</span></span></i><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">GallantSignal.h</span></span></i><span class="hljs-string"><span class="hljs-string"> ,    .  </span></span><i><span class="hljs-string"><span class="hljs-string">Delegate.h</span></span></i><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">GallantSignal.h</span></span></i><span class="hljs-string"><span class="hljs-string">   ( ,   ,  </span></span><i><span class="hljs-string"><span class="hljs-string">‚ÄúCopy items into destination group'</span></span>s folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "GallantSignal.h" <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code><span class="hljs-built_in"><span class="hljs-built_in">public</span></span></code> : <br> <br> <code class="cpp">Signal2&lt; <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> &gt; noteOn; Signal2&lt; <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> &gt; noteOff;</code> <br> <br>  ,        <code><span class="hljs-type"><span class="hljs-type">int</span></span></code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> previously pressed key: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the last note was released, <span class="hljs-keyword"><span class="hljs-keyword">nothing</span></span> should play: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noteNumber == mLastNoteNumber) { mLastNoteNumber = <span class="hljs-number"><span class="hljs-number">-1</span></span>; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code><span class="hljs-number"><span class="hljs-number">-1</span></span></code> ,   :      <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp"><span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onNoteOn(const <span class="hljs-type"><span class="hljs-type">int</span></span> noteNumber, const <span class="hljs-type"><span class="hljs-type">int</span></span> velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onNoteOff(const <span class="hljs-type"><span class="hljs-type">int</span></span> noteNumber, const <span class="hljs-type"><span class="hljs-type">int</span></span> velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code><span class="hljs-keyword"><span class="hljs-keyword">if</span></span></code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins<span class="hljs-number"><span class="hljs-number">-011</span></span>-envelopes</a></code></code> </pre> <code><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> void EnvelopeGenerator::calculateMultiplier(double startLevel, double endLevel, unsigned long long lengthInSamples) { multiplier = 1.0 + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp">void EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = 0; if (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = 0; } else { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { case ENVELOPE_STAGE_OFF: currentLevel = 0.0; multiplier = 1.0; break; case ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, 1.0, nextStageSampleIndex); break; case ENVELOPE_STAGE_DECAY: currentLevel = 1.0; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; case ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = 1.0; break; case ENVELOPE_STAGE_RELEASE: // We could go from ATTACK/DECAY to RELEASE, // so we're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</code> <br> <br>    <code>currentStage</code>     <code>currentSampleIndex</code> .       <i> </i> .   ,       ,   . <code>stageValue[currentStage]</code>   <code>double</code> (   ), ,       ,     . <code>Switch</code>     .  OFF         (  ,    ). ATTACK    <code>minimumLevel</code> ,  <code>multiplier</code>   <code>currentLevel</code>  <code>1.0</code> .   DECAY       <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code> ,  <code>fmax</code> ,      . RELEASE  <code>currentLevel</code> ,     ,  <code>minimumLevel</code> .    ,    RELEASE    <code>currentLevel</code> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code>    ,  <i> </i> .         <code>currentLevel</code> . <br> <br>   <br> <br>        : <br> <br> <code class="cpp">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</code> <br> <br>   <code>private</code>  <code>Synthesis</code> (  )   : <br> <br> <code class="cpp">EnvelopeGenerator mEnvelopeGenerator;</code> <br> <br>   <code>#include "EnvelopeGenerator.h"</code>   . <br> ,   <code>ProcessDoubleReplacing</code> <i>Synthesis.cpp</i>   <code>leftOutput[i]</code>  : <br> <br> <code class="cpp">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</code> <br> <br>    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . <br>     <code>mEnvelopeGenerator</code>     .   <code>Synthesis::Reset()</code> : <br> <br> <code class="cpp">mEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>       .     -    ‚Äî        ! . <br> <br>    Note On/Off <br> <br>    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. <code>mMIDIReceiver</code>     note on/off,  ,  -    . <br> <br>         <code>#include EnvelopeGenerator.h</code>  <i>MIDIReceiver.h</i> . ,  <i>Synthesis.h</i>          <code>mEnvelopeGenerator</code>  <code>mMIDIReceiver</code> ,      .  <code>MIDIReceiver</code>   <code>enterStage</code>   note on/off. <br>  , . . <code>MIDIReceiver</code>    <code>EnvelopeGenerator</code> .       ,      <code>MIDIReceiver</code>   ,    <code>EnvelopeGenerator</code> . <br> <br>   <a href="http://qt-project.org/doc/qt-5/signalsandslots.html"></a>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"></a> .      Qt.    , ,          ,      .    ,   .       ,  <code>setText()</code> ,        .    ,    ,      ,   . ,  ,  .          ( <code>Oscillator</code> , <code>EnvelopeGenerator</code> , <code>MIDIReceiver</code> ).    <i> </i> , . .   <code>Synthesis</code> . <br> <br>       Qt    .     <a href="https://github.com/pbhogan/Signals">Signals</a>  .   .  <i>Signal.h</i>  <i>GallantSignal.h</i> ,    .  <i>Delegate.h</i>  <i>GallantSignal.h</i>   ( ,   ,  <i>‚ÄúCopy items into destination group's folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#include "GallantSignal.h" using Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code>public</code> : <br> <br> <code class="cpp">Signal2&lt; int, int &gt; noteOn; Signal2&lt; int, int &gt; noteOff;</code> <br> <br>  ,        <code>int</code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides any previously pressed key: if (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// If the last note was released, nothing should play: if (noteNumber == mLastNoteNumber) { mLastNoteNumber = -1; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code>-1</code> ,   :      RELEASE.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.Connect(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.Connect(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code>if</code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       RELEASE,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins-011-envelopes</a></code> <h3> <code><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> void EnvelopeGenerator::calculateMultiplier(double startLevel, double endLevel, unsigned long long lengthInSamples) { multiplier = 1.0 + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp">void EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = 0; if (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = 0; } else { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { case ENVELOPE_STAGE_OFF: currentLevel = 0.0; multiplier = 1.0; break; case ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, 1.0, nextStageSampleIndex); break; case ENVELOPE_STAGE_DECAY: currentLevel = 1.0; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; case ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = 1.0; break; case ENVELOPE_STAGE_RELEASE: // We could go from ATTACK/DECAY to RELEASE, // so we're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</code> <br> <br>    <code>currentStage</code>     <code>currentSampleIndex</code> .       <i> </i> .   ,       ,   . <code>stageValue[currentStage]</code>   <code>double</code> (   ), ,       ,     . <code>Switch</code>     .  OFF         (  ,    ). ATTACK    <code>minimumLevel</code> ,  <code>multiplier</code>   <code>currentLevel</code>  <code>1.0</code> .   DECAY       <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code> ,  <code>fmax</code> ,      . RELEASE  <code>currentLevel</code> ,     ,  <code>minimumLevel</code> .    ,    RELEASE    <code>currentLevel</code> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code>    ,  <i> </i> .         <code>currentLevel</code> . <br> <br>   <br> <br>        : <br> <br> <code class="cpp">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</code> <br> <br>   <code>private</code>  <code>Synthesis</code> (  )   : <br> <br> <code class="cpp">EnvelopeGenerator mEnvelopeGenerator;</code> <br> <br>   <code>#include "EnvelopeGenerator.h"</code>   . <br> ,   <code>ProcessDoubleReplacing</code> <i>Synthesis.cpp</i>   <code>leftOutput[i]</code>  : <br> <br> <code class="cpp">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</code> <br> <br>    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . <br>     <code>mEnvelopeGenerator</code>     .   <code>Synthesis::Reset()</code> : <br> <br> <code class="cpp">mEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>       .     -    ‚Äî        ! . <br> <br>    Note On/Off <br> <br>    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. <code>mMIDIReceiver</code>     note on/off,  ,  -    . <br> <br>         <code>#include EnvelopeGenerator.h</code>  <i>MIDIReceiver.h</i> . ,  <i>Synthesis.h</i>          <code>mEnvelopeGenerator</code>  <code>mMIDIReceiver</code> ,      .  <code>MIDIReceiver</code>   <code>enterStage</code>   note on/off. <br>  , . . <code>MIDIReceiver</code>    <code>EnvelopeGenerator</code> .       ,      <code>MIDIReceiver</code>   ,    <code>EnvelopeGenerator</code> . <br> <br>   <a href="http://qt-project.org/doc/qt-5/signalsandslots.html"></a>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"></a> .      Qt.    , ,          ,      .    ,   .       ,  <code>setText()</code> ,        .    ,    ,      ,   . ,  ,  .          ( <code>Oscillator</code> , <code>EnvelopeGenerator</code> , <code>MIDIReceiver</code> ).    <i> </i> , . .   <code>Synthesis</code> . <br> <br>       Qt    .     <a href="https://github.com/pbhogan/Signals">Signals</a>  .   .  <i>Signal.h</i>  <i>GallantSignal.h</i> ,    .  <i>Delegate.h</i>  <i>GallantSignal.h</i>   ( ,   ,  <i>‚ÄúCopy items into destination group's folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#include "GallantSignal.h" using Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code>public</code> : <br> <br> <code class="cpp">Signal2&lt; int, int &gt; noteOn; Signal2&lt; int, int &gt; noteOff;</code> <br> <br>  ,        <code>int</code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides any previously pressed key: if (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// If the last note was released, nothing should play: if (noteNumber == mLastNoteNumber) { mLastNoteNumber = -1; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code>-1</code> ,   :      RELEASE.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.Connect(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.Connect(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code>if</code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       RELEASE,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins-011-envelopes</a></code> </h3> <code><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> void EnvelopeGenerator::calculateMultiplier(double startLevel, double endLevel, unsigned long long lengthInSamples) { multiplier = 1.0 + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp">void EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = 0; if (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = 0; } else { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { case ENVELOPE_STAGE_OFF: currentLevel = 0.0; multiplier = 1.0; break; case ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, 1.0, nextStageSampleIndex); break; case ENVELOPE_STAGE_DECAY: currentLevel = 1.0; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; case ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = 1.0; break; case ENVELOPE_STAGE_RELEASE: // We could go from ATTACK/DECAY to RELEASE, // so we're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</code> <br> <br>    <code>currentStage</code>     <code>currentSampleIndex</code> .       <i> </i> .   ,       ,   . <code>stageValue[currentStage]</code>   <code>double</code> (   ), ,       ,     . <code>Switch</code>     .  OFF         (  ,    ). ATTACK    <code>minimumLevel</code> ,  <code>multiplier</code>   <code>currentLevel</code>  <code>1.0</code> .   DECAY       <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code> ,  <code>fmax</code> ,      . RELEASE  <code>currentLevel</code> ,     ,  <code>minimumLevel</code> .    ,    RELEASE    <code>currentLevel</code> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code>    ,  <i> </i> .         <code>currentLevel</code> . <br> <br>   <br> <br>        : <br> <br> <code class="cpp">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</code> <br> <br>   <code>private</code>  <code>Synthesis</code> (  )   : <br> <br> <code class="cpp">EnvelopeGenerator mEnvelopeGenerator;</code> <br> <br>   <code>#include "EnvelopeGenerator.h"</code>   . <br> ,   <code>ProcessDoubleReplacing</code> <i>Synthesis.cpp</i>   <code>leftOutput[i]</code>  : <br> <br> <code class="cpp">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</code> <br> <br>    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . <br>     <code>mEnvelopeGenerator</code>     .   <code>Synthesis::Reset()</code> : <br> <br> <code class="cpp">mEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>       .     -    ‚Äî        ! . <br> <br>    Note On/Off <br> <br>    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. <code>mMIDIReceiver</code>     note on/off,  ,  -    . <br> <br>         <code>#include EnvelopeGenerator.h</code>  <i>MIDIReceiver.h</i> . ,  <i>Synthesis.h</i>          <code>mEnvelopeGenerator</code>  <code>mMIDIReceiver</code> ,      .  <code>MIDIReceiver</code>   <code>enterStage</code>   note on/off. <br>  , . . <code>MIDIReceiver</code>    <code>EnvelopeGenerator</code> .       ,      <code>MIDIReceiver</code>   ,    <code>EnvelopeGenerator</code> . <br> <br>   <a href="http://qt-project.org/doc/qt-5/signalsandslots.html"></a>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"></a> .      Qt.    , ,          ,      .    ,   .       ,  <code>setText()</code> ,        .    ,    ,      ,   . ,  ,  .          ( <code>Oscillator</code> , <code>EnvelopeGenerator</code> , <code>MIDIReceiver</code> ).    <i> </i> , . .   <code>Synthesis</code> . <br> <br>       Qt    .     <a href="https://github.com/pbhogan/Signals">Signals</a>  .   .  <i>Signal.h</i>  <i>GallantSignal.h</i> ,    .  <i>Delegate.h</i>  <i>GallantSignal.h</i>   ( ,   ,  <i>‚ÄúCopy items into destination group's folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#include "GallantSignal.h" using Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code>public</code> : <br> <br> <code class="cpp">Signal2&lt; int, int &gt; noteOn; Signal2&lt; int, int &gt; noteOff;</code> <br> <br>  ,        <code>int</code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides any previously pressed key: if (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// If the last note was released, nothing should play: if (noteNumber == mLastNoteNumber) { mLastNoteNumber = -1; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code>-1</code> ,   :      RELEASE.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.Connect(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.Connect(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code>if</code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       RELEASE,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins-011-envelopes</a></code> <pre> <code class="hljs pgsql"><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> <span class="hljs-type"><span class="hljs-type">void</span></span> EnvelopeGenerator::calculateMultiplier(<span class="hljs-type"><span class="hljs-type">double</span></span> startLevel, <span class="hljs-type"><span class="hljs-type">double</span></span> endLevel, unsigned long long lengthInSamples) { multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span> + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp"><span class="hljs-type"><span class="hljs-type">void</span></span> EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_OFF: currentLevel = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, nextStageSampleIndex); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_DECAY: currentLevel = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_RELEASE: // We could go <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ATTACK/DECAY <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>, // so w<span class="hljs-string"><span class="hljs-string">e're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    </span></span><code><span class="hljs-string"><span class="hljs-string">currentStage</span></span></code><span class="hljs-string"><span class="hljs-string">     </span></span><code><span class="hljs-string"><span class="hljs-string">currentSampleIndex</span></span></code><span class="hljs-string"><span class="hljs-string"> .       </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> .   ,       ,   . </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[currentStage]</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">double</span></span></code><span class="hljs-string"><span class="hljs-string"> (   ), ,       ,     . </span></span><code><span class="hljs-string"><span class="hljs-string">Switch</span></span></code><span class="hljs-string"><span class="hljs-string">     .  OFF         (  ,    ). ATTACK    </span></span><code><span class="hljs-string"><span class="hljs-string">minimumLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> ,  </span></span><code><span class="hljs-string"><span class="hljs-string">multiplier</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">1.0</span></span></code><span class="hljs-string"><span class="hljs-string"> .   DECAY       </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[ENVELOPE_STAGE_SUSTAIN]</span></span></code><span class="hljs-string"><span class="hljs-string"> ,  </span></span><code><span class="hljs-string"><span class="hljs-string">fmax</span></span></code><span class="hljs-string"><span class="hljs-string"> ,      . RELEASE  </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> ,     ,  </span></span><code><span class="hljs-string"><span class="hljs-string">minimumLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> .    ,    RELEASE    </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[ENVELOPE_STAGE_SUSTAIN]</span></span></code><span class="hljs-string"><span class="hljs-string">    ,  </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> .         </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">        : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">private</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis</span></span></code><span class="hljs-string"><span class="hljs-string"> (  )   : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator mEnvelopeGenerator;</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">#include "EnvelopeGenerator.h"</span></span></code><span class="hljs-string"><span class="hljs-string">   . </span></span><br><span class="hljs-string"><span class="hljs-string"> ,   </span></span><code><span class="hljs-string"><span class="hljs-string">ProcessDoubleReplacing</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><i><span class="hljs-string"><span class="hljs-string">Synthesis.cpp</span></span></i><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">leftOutput[i]</span></span></code><span class="hljs-string"><span class="hljs-string">  : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . </span></span><br><span class="hljs-string"><span class="hljs-string">     </span></span><code><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string">     .   </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis::Reset()</span></span></code><span class="hljs-string"><span class="hljs-string"> : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator.setSampleRate(GetSampleRate());</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">       .     -    ‚Äî        ! . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    Note On/Off </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. </span></span><code><span class="hljs-string"><span class="hljs-string">mMIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">     note on/off,  ,  -    . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">         </span></span><code><span class="hljs-string"><span class="hljs-string">#include EnvelopeGenerator.h</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">MIDIReceiver.h</span></span></i><span class="hljs-string"><span class="hljs-string"> . ,  </span></span><i><span class="hljs-string"><span class="hljs-string">Synthesis.h</span></span></i><span class="hljs-string"><span class="hljs-string">          </span></span><code><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">mMIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string"> ,      .  </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">enterStage</span></span></code><span class="hljs-string"><span class="hljs-string">   note on/off. </span></span><br><span class="hljs-string"><span class="hljs-string">  , . . </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">    </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> .       ,      </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">   ,    </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><a href="http://qt-project.org/doc/qt-5/signalsandslots.html"><span class="hljs-string"><span class="hljs-string"></span></span></a><span class="hljs-string"><span class="hljs-string">  </span></span><a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"><span class="hljs-string"><span class="hljs-string"></span></span></a><span class="hljs-string"><span class="hljs-string"> .      Qt.    , ,          ,      .    ,   .       ,  </span></span><code><span class="hljs-string"><span class="hljs-string">setText()</span></span></code><span class="hljs-string"><span class="hljs-string"> ,        .    ,    ,      ,   . ,  ,  .          ( </span></span><code><span class="hljs-string"><span class="hljs-string">Oscillator</span></span></code><span class="hljs-string"><span class="hljs-string"> , </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> , </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string"> ).    </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> , . .   </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">       Qt    .     </span></span><a href="https://github.com/pbhogan/Signals"><span class="hljs-string"><span class="hljs-string">Signals</span></span></a><span class="hljs-string"><span class="hljs-string">  .   .  </span></span><i><span class="hljs-string"><span class="hljs-string">Signal.h</span></span></i><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">GallantSignal.h</span></span></i><span class="hljs-string"><span class="hljs-string"> ,    .  </span></span><i><span class="hljs-string"><span class="hljs-string">Delegate.h</span></span></i><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">GallantSignal.h</span></span></i><span class="hljs-string"><span class="hljs-string">   ( ,   ,  </span></span><i><span class="hljs-string"><span class="hljs-string">‚ÄúCopy items into destination group'</span></span>s folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "GallantSignal.h" <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code><span class="hljs-built_in"><span class="hljs-built_in">public</span></span></code> : <br> <br> <code class="cpp">Signal2&lt; <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> &gt; noteOn; Signal2&lt; <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> &gt; noteOff;</code> <br> <br>  ,        <code><span class="hljs-type"><span class="hljs-type">int</span></span></code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> previously pressed key: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the last note was released, <span class="hljs-keyword"><span class="hljs-keyword">nothing</span></span> should play: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noteNumber == mLastNoteNumber) { mLastNoteNumber = <span class="hljs-number"><span class="hljs-number">-1</span></span>; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code><span class="hljs-number"><span class="hljs-number">-1</span></span></code> ,   :      <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp"><span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onNoteOn(const <span class="hljs-type"><span class="hljs-type">int</span></span> noteNumber, const <span class="hljs-type"><span class="hljs-type">int</span></span> velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onNoteOff(const <span class="hljs-type"><span class="hljs-type">int</span></span> noteNumber, const <span class="hljs-type"><span class="hljs-type">int</span></span> velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code><span class="hljs-keyword"><span class="hljs-keyword">if</span></span></code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins<span class="hljs-number"><span class="hljs-number">-011</span></span>-envelopes</a></code> </pre> <code><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> void EnvelopeGenerator::calculateMultiplier(double startLevel, double endLevel, unsigned long long lengthInSamples) { multiplier = 1.0 + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp">void EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = 0; if (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = 0; } else { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { case ENVELOPE_STAGE_OFF: currentLevel = 0.0; multiplier = 1.0; break; case ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, 1.0, nextStageSampleIndex); break; case ENVELOPE_STAGE_DECAY: currentLevel = 1.0; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; case ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = 1.0; break; case ENVELOPE_STAGE_RELEASE: // We could go from ATTACK/DECAY to RELEASE, // so we're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</code> <br> <br>    <code>currentStage</code>     <code>currentSampleIndex</code> .       <i> </i> .   ,       ,   . <code>stageValue[currentStage]</code>   <code>double</code> (   ), ,       ,     . <code>Switch</code>     .  OFF         (  ,    ). ATTACK    <code>minimumLevel</code> ,  <code>multiplier</code>   <code>currentLevel</code>  <code>1.0</code> .   DECAY       <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code> ,  <code>fmax</code> ,      . RELEASE  <code>currentLevel</code> ,     ,  <code>minimumLevel</code> .    ,    RELEASE    <code>currentLevel</code> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code>    ,  <i> </i> .         <code>currentLevel</code> . <br> <br>   <br> <br>        : <br> <br> <code class="cpp">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</code> <br> <br>   <code>private</code>  <code>Synthesis</code> (  )   : <br> <br> <code class="cpp">EnvelopeGenerator mEnvelopeGenerator;</code> <br> <br>   <code>#include "EnvelopeGenerator.h"</code>   . <br> ,   <code>ProcessDoubleReplacing</code> <i>Synthesis.cpp</i>   <code>leftOutput[i]</code>  : <br> <br> <code class="cpp">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</code> <br> <br>    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . <br>     <code>mEnvelopeGenerator</code>     .   <code>Synthesis::Reset()</code> : <br> <br> <code class="cpp">mEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>       .     -    ‚Äî        ! . <br> <br>    Note On/Off <br> <br>    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. <code>mMIDIReceiver</code>     note on/off,  ,  -    . <br> <br>         <code>#include EnvelopeGenerator.h</code>  <i>MIDIReceiver.h</i> . ,  <i>Synthesis.h</i>          <code>mEnvelopeGenerator</code>  <code>mMIDIReceiver</code> ,      .  <code>MIDIReceiver</code>   <code>enterStage</code>   note on/off. <br>  , . . <code>MIDIReceiver</code>    <code>EnvelopeGenerator</code> .       ,      <code>MIDIReceiver</code>   ,    <code>EnvelopeGenerator</code> . <br> <br>   <a href="http://qt-project.org/doc/qt-5/signalsandslots.html"></a>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"></a> .      Qt.    , ,          ,      .    ,   .       ,  <code>setText()</code> ,        .    ,    ,      ,   . ,  ,  .          ( <code>Oscillator</code> , <code>EnvelopeGenerator</code> , <code>MIDIReceiver</code> ).    <i> </i> , . .   <code>Synthesis</code> . <br> <br>       Qt    .     <a href="https://github.com/pbhogan/Signals">Signals</a>  .   .  <i>Signal.h</i>  <i>GallantSignal.h</i> ,    .  <i>Delegate.h</i>  <i>GallantSignal.h</i>   ( ,   ,  <i>‚ÄúCopy items into destination group's folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#include "GallantSignal.h" using Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code>public</code> : <br> <br> <code class="cpp">Signal2&lt; int, int &gt; noteOn; Signal2&lt; int, int &gt; noteOff;</code> <br> <br>  ,        <code>int</code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides any previously pressed key: if (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// If the last note was released, nothing should play: if (noteNumber == mLastNoteNumber) { mLastNoteNumber = -1; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code>-1</code> ,   :      RELEASE.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.Connect(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.Connect(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code>if</code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       RELEASE,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins-011-envelopes</a></code> <pre> <code class="hljs pgsql"><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> <span class="hljs-type"><span class="hljs-type">void</span></span> EnvelopeGenerator::calculateMultiplier(<span class="hljs-type"><span class="hljs-type">double</span></span> startLevel, <span class="hljs-type"><span class="hljs-type">double</span></span> endLevel, unsigned long long lengthInSamples) { multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span> + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp"><span class="hljs-type"><span class="hljs-type">void</span></span> EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_OFF: currentLevel = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, nextStageSampleIndex); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_DECAY: currentLevel = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_RELEASE: // We could go <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ATTACK/DECAY <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>, // so w<span class="hljs-string"><span class="hljs-string">e're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    </span></span><code><span class="hljs-string"><span class="hljs-string">currentStage</span></span></code><span class="hljs-string"><span class="hljs-string">     </span></span><code><span class="hljs-string"><span class="hljs-string">currentSampleIndex</span></span></code><span class="hljs-string"><span class="hljs-string"> .       </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> .   ,       ,   . </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[currentStage]</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">double</span></span></code><span class="hljs-string"><span class="hljs-string"> (   ), ,       ,     . </span></span><code><span class="hljs-string"><span class="hljs-string">Switch</span></span></code><span class="hljs-string"><span class="hljs-string">     .  OFF         (  ,    ). ATTACK    </span></span><code><span class="hljs-string"><span class="hljs-string">minimumLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> ,  </span></span><code><span class="hljs-string"><span class="hljs-string">multiplier</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">1.0</span></span></code><span class="hljs-string"><span class="hljs-string"> .   DECAY       </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[ENVELOPE_STAGE_SUSTAIN]</span></span></code><span class="hljs-string"><span class="hljs-string"> ,  </span></span><code><span class="hljs-string"><span class="hljs-string">fmax</span></span></code><span class="hljs-string"><span class="hljs-string"> ,      . RELEASE  </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> ,     ,  </span></span><code><span class="hljs-string"><span class="hljs-string">minimumLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> .    ,    RELEASE    </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[ENVELOPE_STAGE_SUSTAIN]</span></span></code><span class="hljs-string"><span class="hljs-string">    ,  </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> .         </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">        : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">private</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis</span></span></code><span class="hljs-string"><span class="hljs-string"> (  )   : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator mEnvelopeGenerator;</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">#include "EnvelopeGenerator.h"</span></span></code><span class="hljs-string"><span class="hljs-string">   . </span></span><br><span class="hljs-string"><span class="hljs-string"> ,   </span></span><code><span class="hljs-string"><span class="hljs-string">ProcessDoubleReplacing</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><i><span class="hljs-string"><span class="hljs-string">Synthesis.cpp</span></span></i><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">leftOutput[i]</span></span></code><span class="hljs-string"><span class="hljs-string">  : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . </span></span><br><span class="hljs-string"><span class="hljs-string">     </span></span><code><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string">     .   </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis::Reset()</span></span></code><span class="hljs-string"><span class="hljs-string"> : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator.setSampleRate(GetSampleRate());</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">       .     -    ‚Äî        ! . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    Note On/Off </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. </span></span><code><span class="hljs-string"><span class="hljs-string">mMIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">     note on/off,  ,  -    . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">         </span></span><code><span class="hljs-string"><span class="hljs-string">#include EnvelopeGenerator.h</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">MIDIReceiver.h</span></span></i><span class="hljs-string"><span class="hljs-string"> . ,  </span></span><i><span class="hljs-string"><span class="hljs-string">Synthesis.h</span></span></i><span class="hljs-string"><span class="hljs-string">          </span></span><code><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">mMIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string"> ,      .  </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">enterStage</span></span></code><span class="hljs-string"><span class="hljs-string">   note on/off. </span></span><br><span class="hljs-string"><span class="hljs-string">  , . . </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">    </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> .       ,      </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">   ,    </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><a href="http://qt-project.org/doc/qt-5/signalsandslots.html"><span class="hljs-string"><span class="hljs-string"></span></span></a><span class="hljs-string"><span class="hljs-string">  </span></span><a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"><span class="hljs-string"><span class="hljs-string"></span></span></a><span class="hljs-string"><span class="hljs-string"> .      Qt.    , ,          ,      .    ,   .       ,  </span></span><code><span class="hljs-string"><span class="hljs-string">setText()</span></span></code><span class="hljs-string"><span class="hljs-string"> ,        .    ,    ,      ,   . ,  ,  .          ( </span></span><code><span class="hljs-string"><span class="hljs-string">Oscillator</span></span></code><span class="hljs-string"><span class="hljs-string"> , </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> , </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string"> ).    </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> , . .   </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">       Qt    .     </span></span><a href="https://github.com/pbhogan/Signals"><span class="hljs-string"><span class="hljs-string">Signals</span></span></a><span class="hljs-string"><span class="hljs-string">  .   .  </span></span><i><span class="hljs-string"><span class="hljs-string">Signal.h</span></span></i><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">GallantSignal.h</span></span></i><span class="hljs-string"><span class="hljs-string"> ,    .  </span></span><i><span class="hljs-string"><span class="hljs-string">Delegate.h</span></span></i><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">GallantSignal.h</span></span></i><span class="hljs-string"><span class="hljs-string">   ( ,   ,  </span></span><i><span class="hljs-string"><span class="hljs-string">‚ÄúCopy items into destination group'</span></span>s folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "GallantSignal.h" <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code><span class="hljs-built_in"><span class="hljs-built_in">public</span></span></code> : <br> <br> <code class="cpp">Signal2&lt; <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> &gt; noteOn; Signal2&lt; <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> &gt; noteOff;</code> <br> <br>  ,        <code><span class="hljs-type"><span class="hljs-type">int</span></span></code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> previously pressed key: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the last note was released, <span class="hljs-keyword"><span class="hljs-keyword">nothing</span></span> should play: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noteNumber == mLastNoteNumber) { mLastNoteNumber = <span class="hljs-number"><span class="hljs-number">-1</span></span>; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code><span class="hljs-number"><span class="hljs-number">-1</span></span></code> ,   :      <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp"><span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onNoteOn(const <span class="hljs-type"><span class="hljs-type">int</span></span> noteNumber, const <span class="hljs-type"><span class="hljs-type">int</span></span> velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onNoteOff(const <span class="hljs-type"><span class="hljs-type">int</span></span> noteNumber, const <span class="hljs-type"><span class="hljs-type">int</span></span> velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code><span class="hljs-keyword"><span class="hljs-keyword">if</span></span></code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins<span class="hljs-number"><span class="hljs-number">-011</span></span>-envelopes</a></code> </pre> <code><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> void EnvelopeGenerator::calculateMultiplier(double startLevel, double endLevel, unsigned long long lengthInSamples) { multiplier = 1.0 + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp">void EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = 0; if (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = 0; } else { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { case ENVELOPE_STAGE_OFF: currentLevel = 0.0; multiplier = 1.0; break; case ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, 1.0, nextStageSampleIndex); break; case ENVELOPE_STAGE_DECAY: currentLevel = 1.0; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; case ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = 1.0; break; case ENVELOPE_STAGE_RELEASE: // We could go from ATTACK/DECAY to RELEASE, // so we're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</code> <br> <br>    <code>currentStage</code>     <code>currentSampleIndex</code> .       <i> </i> .   ,       ,   . <code>stageValue[currentStage]</code>   <code>double</code> (   ), ,       ,     . <code>Switch</code>     .  OFF         (  ,    ). ATTACK    <code>minimumLevel</code> ,  <code>multiplier</code>   <code>currentLevel</code>  <code>1.0</code> .   DECAY       <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code> ,  <code>fmax</code> ,      . RELEASE  <code>currentLevel</code> ,     ,  <code>minimumLevel</code> .    ,    RELEASE    <code>currentLevel</code> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code>    ,  <i> </i> .         <code>currentLevel</code> . <br> <br>   <br> <br>        : <br> <br> <code class="cpp">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</code> <br> <br>   <code>private</code>  <code>Synthesis</code> (  )   : <br> <br> <code class="cpp">EnvelopeGenerator mEnvelopeGenerator;</code> <br> <br>   <code>#include "EnvelopeGenerator.h"</code>   . <br> ,   <code>ProcessDoubleReplacing</code> <i>Synthesis.cpp</i>   <code>leftOutput[i]</code>  : <br> <br> <code class="cpp">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</code> <br> <br>    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . <br>     <code>mEnvelopeGenerator</code>     .   <code>Synthesis::Reset()</code> : <br> <br> <code class="cpp">mEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>       .     -    ‚Äî        ! . <br> <br>    Note On/Off <br> <br>    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. <code>mMIDIReceiver</code>     note on/off,  ,  -    . <br> <br>         <code>#include EnvelopeGenerator.h</code>  <i>MIDIReceiver.h</i> . ,  <i>Synthesis.h</i>          <code>mEnvelopeGenerator</code>  <code>mMIDIReceiver</code> ,      .  <code>MIDIReceiver</code>   <code>enterStage</code>   note on/off. <br>  , . . <code>MIDIReceiver</code>    <code>EnvelopeGenerator</code> .       ,      <code>MIDIReceiver</code>   ,    <code>EnvelopeGenerator</code> . <br> <br>   <a href="http://qt-project.org/doc/qt-5/signalsandslots.html"></a>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"></a> .      Qt.    , ,          ,      .    ,   .       ,  <code>setText()</code> ,        .    ,    ,      ,   . ,  ,  .          ( <code>Oscillator</code> , <code>EnvelopeGenerator</code> , <code>MIDIReceiver</code> ).    <i> </i> , . .   <code>Synthesis</code> . <br> <br>       Qt    .     <a href="https://github.com/pbhogan/Signals">Signals</a>  .   .  <i>Signal.h</i>  <i>GallantSignal.h</i> ,    .  <i>Delegate.h</i>  <i>GallantSignal.h</i>   ( ,   ,  <i>‚ÄúCopy items into destination group's folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#include "GallantSignal.h" using Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code>public</code> : <br> <br> <code class="cpp">Signal2&lt; int, int &gt; noteOn; Signal2&lt; int, int &gt; noteOff;</code> <br> <br>  ,        <code>int</code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides any previously pressed key: if (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// If the last note was released, nothing should play: if (noteNumber == mLastNoteNumber) { mLastNoteNumber = -1; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code>-1</code> ,   :      RELEASE.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.Connect(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.Connect(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code>if</code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       RELEASE,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins-011-envelopes</a></code> <pre> <code class="hljs pgsql"><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> <span class="hljs-type"><span class="hljs-type">void</span></span> EnvelopeGenerator::calculateMultiplier(<span class="hljs-type"><span class="hljs-type">double</span></span> startLevel, <span class="hljs-type"><span class="hljs-type">double</span></span> endLevel, unsigned long long lengthInSamples) { multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span> + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp"><span class="hljs-type"><span class="hljs-type">void</span></span> EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_OFF: currentLevel = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, nextStageSampleIndex); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_DECAY: currentLevel = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_RELEASE: // We could go <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ATTACK/DECAY <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>, // so w<span class="hljs-string"><span class="hljs-string">e're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    </span></span><code><span class="hljs-string"><span class="hljs-string">currentStage</span></span></code><span class="hljs-string"><span class="hljs-string">     </span></span><code><span class="hljs-string"><span class="hljs-string">currentSampleIndex</span></span></code><span class="hljs-string"><span class="hljs-string"> .       </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> .   ,       ,   . </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[currentStage]</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">double</span></span></code><span class="hljs-string"><span class="hljs-string"> (   ), ,       ,     . </span></span><code><span class="hljs-string"><span class="hljs-string">Switch</span></span></code><span class="hljs-string"><span class="hljs-string">     .  OFF         (  ,    ). ATTACK    </span></span><code><span class="hljs-string"><span class="hljs-string">minimumLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> ,  </span></span><code><span class="hljs-string"><span class="hljs-string">multiplier</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">1.0</span></span></code><span class="hljs-string"><span class="hljs-string"> .   DECAY       </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[ENVELOPE_STAGE_SUSTAIN]</span></span></code><span class="hljs-string"><span class="hljs-string"> ,  </span></span><code><span class="hljs-string"><span class="hljs-string">fmax</span></span></code><span class="hljs-string"><span class="hljs-string"> ,      . RELEASE  </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> ,     ,  </span></span><code><span class="hljs-string"><span class="hljs-string">minimumLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> .    ,    RELEASE    </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[ENVELOPE_STAGE_SUSTAIN]</span></span></code><span class="hljs-string"><span class="hljs-string">    ,  </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> .         </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">        : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">private</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis</span></span></code><span class="hljs-string"><span class="hljs-string"> (  )   : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator mEnvelopeGenerator;</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">#include "EnvelopeGenerator.h"</span></span></code><span class="hljs-string"><span class="hljs-string">   . </span></span><br><span class="hljs-string"><span class="hljs-string"> ,   </span></span><code><span class="hljs-string"><span class="hljs-string">ProcessDoubleReplacing</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><i><span class="hljs-string"><span class="hljs-string">Synthesis.cpp</span></span></i><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">leftOutput[i]</span></span></code><span class="hljs-string"><span class="hljs-string">  : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . </span></span><br><span class="hljs-string"><span class="hljs-string">     </span></span><code><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string">     .   </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis::Reset()</span></span></code><span class="hljs-string"><span class="hljs-string"> : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator.setSampleRate(GetSampleRate());</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">       .     -    ‚Äî        ! . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    Note On/Off </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. </span></span><code><span class="hljs-string"><span class="hljs-string">mMIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">     note on/off,  ,  -    . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">         </span></span><code><span class="hljs-string"><span class="hljs-string">#include EnvelopeGenerator.h</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">MIDIReceiver.h</span></span></i><span class="hljs-string"><span class="hljs-string"> . ,  </span></span><i><span class="hljs-string"><span class="hljs-string">Synthesis.h</span></span></i><span class="hljs-string"><span class="hljs-string">          </span></span><code><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">mMIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string"> ,      .  </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">enterStage</span></span></code><span class="hljs-string"><span class="hljs-string">   note on/off. </span></span><br><span class="hljs-string"><span class="hljs-string">  , . . </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">    </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> .       ,      </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">   ,    </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><a href="http://qt-project.org/doc/qt-5/signalsandslots.html"><span class="hljs-string"><span class="hljs-string"></span></span></a><span class="hljs-string"><span class="hljs-string">  </span></span><a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"><span class="hljs-string"><span class="hljs-string"></span></span></a><span class="hljs-string"><span class="hljs-string"> .      Qt.    , ,          ,      .    ,   .       ,  </span></span><code><span class="hljs-string"><span class="hljs-string">setText()</span></span></code><span class="hljs-string"><span class="hljs-string"> ,        .    ,    ,      ,   . ,  ,  .          ( </span></span><code><span class="hljs-string"><span class="hljs-string">Oscillator</span></span></code><span class="hljs-string"><span class="hljs-string"> , </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> , </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string"> ).    </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> , . .   </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">       Qt    .     </span></span><a href="https://github.com/pbhogan/Signals"><span class="hljs-string"><span class="hljs-string">Signals</span></span></a><span class="hljs-string"><span class="hljs-string">  .   .  </span></span><i><span class="hljs-string"><span class="hljs-string">Signal.h</span></span></i><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">GallantSignal.h</span></span></i><span class="hljs-string"><span class="hljs-string"> ,    .  </span></span><i><span class="hljs-string"><span class="hljs-string">Delegate.h</span></span></i><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">GallantSignal.h</span></span></i><span class="hljs-string"><span class="hljs-string">   ( ,   ,  </span></span><i><span class="hljs-string"><span class="hljs-string">‚ÄúCopy items into destination group'</span></span>s folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "GallantSignal.h" <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code><span class="hljs-built_in"><span class="hljs-built_in">public</span></span></code> : <br> <br> <code class="cpp">Signal2&lt; <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> &gt; noteOn; Signal2&lt; <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> &gt; noteOff;</code> <br> <br>  ,        <code><span class="hljs-type"><span class="hljs-type">int</span></span></code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> previously pressed key: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the last note was released, <span class="hljs-keyword"><span class="hljs-keyword">nothing</span></span> should play: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noteNumber == mLastNoteNumber) { mLastNoteNumber = <span class="hljs-number"><span class="hljs-number">-1</span></span>; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code><span class="hljs-number"><span class="hljs-number">-1</span></span></code> ,   :      <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp"><span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onNoteOn(const <span class="hljs-type"><span class="hljs-type">int</span></span> noteNumber, const <span class="hljs-type"><span class="hljs-type">int</span></span> velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onNoteOff(const <span class="hljs-type"><span class="hljs-type">int</span></span> noteNumber, const <span class="hljs-type"><span class="hljs-type">int</span></span> velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code><span class="hljs-keyword"><span class="hljs-keyword">if</span></span></code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins<span class="hljs-number"><span class="hljs-number">-011</span></span>-envelopes</a></code> </pre> <code><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> void EnvelopeGenerator::calculateMultiplier(double startLevel, double endLevel, unsigned long long lengthInSamples) { multiplier = 1.0 + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp">void EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = 0; if (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = 0; } else { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { case ENVELOPE_STAGE_OFF: currentLevel = 0.0; multiplier = 1.0; break; case ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, 1.0, nextStageSampleIndex); break; case ENVELOPE_STAGE_DECAY: currentLevel = 1.0; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; case ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = 1.0; break; case ENVELOPE_STAGE_RELEASE: // We could go from ATTACK/DECAY to RELEASE, // so we're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</code> <br> <br>    <code>currentStage</code>     <code>currentSampleIndex</code> .       <i> </i> .   ,       ,   . <code>stageValue[currentStage]</code>   <code>double</code> (   ), ,       ,     . <code>Switch</code>     .  OFF         (  ,    ). ATTACK    <code>minimumLevel</code> ,  <code>multiplier</code>   <code>currentLevel</code>  <code>1.0</code> .   DECAY       <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code> ,  <code>fmax</code> ,      . RELEASE  <code>currentLevel</code> ,     ,  <code>minimumLevel</code> .    ,    RELEASE    <code>currentLevel</code> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code>    ,  <i> </i> .         <code>currentLevel</code> . <br> <br>   <br> <br>        : <br> <br> <code class="cpp">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</code> <br> <br>   <code>private</code>  <code>Synthesis</code> (  )   : <br> <br> <code class="cpp">EnvelopeGenerator mEnvelopeGenerator;</code> <br> <br>   <code>#include "EnvelopeGenerator.h"</code>   . <br> ,   <code>ProcessDoubleReplacing</code> <i>Synthesis.cpp</i>   <code>leftOutput[i]</code>  : <br> <br> <code class="cpp">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</code> <br> <br>    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . <br>     <code>mEnvelopeGenerator</code>     .   <code>Synthesis::Reset()</code> : <br> <br> <code class="cpp">mEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>       .     -    ‚Äî        ! . <br> <br>    Note On/Off <br> <br>    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. <code>mMIDIReceiver</code>     note on/off,  ,  -    . <br> <br>         <code>#include EnvelopeGenerator.h</code>  <i>MIDIReceiver.h</i> . ,  <i>Synthesis.h</i>          <code>mEnvelopeGenerator</code>  <code>mMIDIReceiver</code> ,      .  <code>MIDIReceiver</code>   <code>enterStage</code>   note on/off. <br>  , . . <code>MIDIReceiver</code>    <code>EnvelopeGenerator</code> .       ,      <code>MIDIReceiver</code>   ,    <code>EnvelopeGenerator</code> . <br> <br>   <a href="http://qt-project.org/doc/qt-5/signalsandslots.html"></a>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"></a> .      Qt.    , ,          ,      .    ,   .       ,  <code>setText()</code> ,        .    ,    ,      ,   . ,  ,  .          ( <code>Oscillator</code> , <code>EnvelopeGenerator</code> , <code>MIDIReceiver</code> ).    <i> </i> , . .   <code>Synthesis</code> . <br> <br>       Qt    .     <a href="https://github.com/pbhogan/Signals">Signals</a>  .   .  <i>Signal.h</i>  <i>GallantSignal.h</i> ,    .  <i>Delegate.h</i>  <i>GallantSignal.h</i>   ( ,   ,  <i>‚ÄúCopy items into destination group's folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#include "GallantSignal.h" using Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code>public</code> : <br> <br> <code class="cpp">Signal2&lt; int, int &gt; noteOn; Signal2&lt; int, int &gt; noteOff;</code> <br> <br>  ,        <code>int</code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides any previously pressed key: if (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// If the last note was released, nothing should play: if (noteNumber == mLastNoteNumber) { mLastNoteNumber = -1; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code>-1</code> ,   :      RELEASE.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.Connect(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.Connect(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code>if</code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       RELEASE,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins-011-envelopes</a></code> <pre> <code class="hljs pgsql"><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> <span class="hljs-type"><span class="hljs-type">void</span></span> EnvelopeGenerator::calculateMultiplier(<span class="hljs-type"><span class="hljs-type">double</span></span> startLevel, <span class="hljs-type"><span class="hljs-type">double</span></span> endLevel, unsigned long long lengthInSamples) { multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span> + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp"><span class="hljs-type"><span class="hljs-type">void</span></span> EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_OFF: currentLevel = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, nextStageSampleIndex); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_DECAY: currentLevel = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_RELEASE: // We could go <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ATTACK/DECAY <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>, // so w<span class="hljs-string"><span class="hljs-string">e're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    </span></span><code><span class="hljs-string"><span class="hljs-string">currentStage</span></span></code><span class="hljs-string"><span class="hljs-string">     </span></span><code><span class="hljs-string"><span class="hljs-string">currentSampleIndex</span></span></code><span class="hljs-string"><span class="hljs-string"> .       </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> .   ,       ,   . </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[currentStage]</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">double</span></span></code><span class="hljs-string"><span class="hljs-string"> (   ), ,       ,     . </span></span><code><span class="hljs-string"><span class="hljs-string">Switch</span></span></code><span class="hljs-string"><span class="hljs-string">     .  OFF         (  ,    ). ATTACK    </span></span><code><span class="hljs-string"><span class="hljs-string">minimumLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> ,  </span></span><code><span class="hljs-string"><span class="hljs-string">multiplier</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">1.0</span></span></code><span class="hljs-string"><span class="hljs-string"> .   DECAY       </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[ENVELOPE_STAGE_SUSTAIN]</span></span></code><span class="hljs-string"><span class="hljs-string"> ,  </span></span><code><span class="hljs-string"><span class="hljs-string">fmax</span></span></code><span class="hljs-string"><span class="hljs-string"> ,      . RELEASE  </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> ,     ,  </span></span><code><span class="hljs-string"><span class="hljs-string">minimumLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> .    ,    RELEASE    </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[ENVELOPE_STAGE_SUSTAIN]</span></span></code><span class="hljs-string"><span class="hljs-string">    ,  </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> .         </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">        : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">private</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis</span></span></code><span class="hljs-string"><span class="hljs-string"> (  )   : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator mEnvelopeGenerator;</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">#include "EnvelopeGenerator.h"</span></span></code><span class="hljs-string"><span class="hljs-string">   . </span></span><br><span class="hljs-string"><span class="hljs-string"> ,   </span></span><code><span class="hljs-string"><span class="hljs-string">ProcessDoubleReplacing</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><i><span class="hljs-string"><span class="hljs-string">Synthesis.cpp</span></span></i><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">leftOutput[i]</span></span></code><span class="hljs-string"><span class="hljs-string">  : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . </span></span><br><span class="hljs-string"><span class="hljs-string">     </span></span><code><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string">     .   </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis::Reset()</span></span></code><span class="hljs-string"><span class="hljs-string"> : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator.setSampleRate(GetSampleRate());</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">       .     -    ‚Äî        ! . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    Note On/Off </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. </span></span><code><span class="hljs-string"><span class="hljs-string">mMIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">     note on/off,  ,  -    . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">         </span></span><code><span class="hljs-string"><span class="hljs-string">#include EnvelopeGenerator.h</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">MIDIReceiver.h</span></span></i><span class="hljs-string"><span class="hljs-string"> . ,  </span></span><i><span class="hljs-string"><span class="hljs-string">Synthesis.h</span></span></i><span class="hljs-string"><span class="hljs-string">          </span></span><code><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">mMIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string"> ,      .  </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">enterStage</span></span></code><span class="hljs-string"><span class="hljs-string">   note on/off. </span></span><br><span class="hljs-string"><span class="hljs-string">  , . . </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">    </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> .       ,      </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">   ,    </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><a href="http://qt-project.org/doc/qt-5/signalsandslots.html"><span class="hljs-string"><span class="hljs-string"></span></span></a><span class="hljs-string"><span class="hljs-string">  </span></span><a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"><span class="hljs-string"><span class="hljs-string"></span></span></a><span class="hljs-string"><span class="hljs-string"> .      Qt.    , ,          ,      .    ,   .       ,  </span></span><code><span class="hljs-string"><span class="hljs-string">setText()</span></span></code><span class="hljs-string"><span class="hljs-string"> ,        .    ,    ,      ,   . ,  ,  .          ( </span></span><code><span class="hljs-string"><span class="hljs-string">Oscillator</span></span></code><span class="hljs-string"><span class="hljs-string"> , </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> , </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string"> ).    </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> , . .   </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">       Qt    .     </span></span><a href="https://github.com/pbhogan/Signals"><span class="hljs-string"><span class="hljs-string">Signals</span></span></a><span class="hljs-string"><span class="hljs-string">  .   .  </span></span><i><span class="hljs-string"><span class="hljs-string">Signal.h</span></span></i><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">GallantSignal.h</span></span></i><span class="hljs-string"><span class="hljs-string"> ,    .  </span></span><i><span class="hljs-string"><span class="hljs-string">Delegate.h</span></span></i><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">GallantSignal.h</span></span></i><span class="hljs-string"><span class="hljs-string">   ( ,   ,  </span></span><i><span class="hljs-string"><span class="hljs-string">‚ÄúCopy items into destination group'</span></span>s folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "GallantSignal.h" <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code><span class="hljs-built_in"><span class="hljs-built_in">public</span></span></code> : <br> <br> <code class="cpp">Signal2&lt; <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> &gt; noteOn; Signal2&lt; <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> &gt; noteOff;</code> <br> <br>  ,        <code><span class="hljs-type"><span class="hljs-type">int</span></span></code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> previously pressed key: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the last note was released, <span class="hljs-keyword"><span class="hljs-keyword">nothing</span></span> should play: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noteNumber == mLastNoteNumber) { mLastNoteNumber = <span class="hljs-number"><span class="hljs-number">-1</span></span>; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code><span class="hljs-number"><span class="hljs-number">-1</span></span></code> ,   :      <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp"><span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onNoteOn(const <span class="hljs-type"><span class="hljs-type">int</span></span> noteNumber, const <span class="hljs-type"><span class="hljs-type">int</span></span> velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onNoteOff(const <span class="hljs-type"><span class="hljs-type">int</span></span> noteNumber, const <span class="hljs-type"><span class="hljs-type">int</span></span> velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code><span class="hljs-keyword"><span class="hljs-keyword">if</span></span></code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins<span class="hljs-number"><span class="hljs-number">-011</span></span>-envelopes</a></code> </pre> <code><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> void EnvelopeGenerator::calculateMultiplier(double startLevel, double endLevel, unsigned long long lengthInSamples) { multiplier = 1.0 + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp">void EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = 0; if (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = 0; } else { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { case ENVELOPE_STAGE_OFF: currentLevel = 0.0; multiplier = 1.0; break; case ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, 1.0, nextStageSampleIndex); break; case ENVELOPE_STAGE_DECAY: currentLevel = 1.0; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; case ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = 1.0; break; case ENVELOPE_STAGE_RELEASE: // We could go from ATTACK/DECAY to RELEASE, // so we're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</code> <br> <br>    <code>currentStage</code>     <code>currentSampleIndex</code> .       <i> </i> .   ,       ,   . <code>stageValue[currentStage]</code>   <code>double</code> (   ), ,       ,     . <code>Switch</code>     .  OFF         (  ,    ). ATTACK    <code>minimumLevel</code> ,  <code>multiplier</code>   <code>currentLevel</code>  <code>1.0</code> .   DECAY       <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code> ,  <code>fmax</code> ,      . RELEASE  <code>currentLevel</code> ,     ,  <code>minimumLevel</code> .    ,    RELEASE    <code>currentLevel</code> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code>    ,  <i> </i> .         <code>currentLevel</code> . <br> <br>   <br> <br>        : <br> <br> <code class="cpp">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</code> <br> <br>   <code>private</code>  <code>Synthesis</code> (  )   : <br> <br> <code class="cpp">EnvelopeGenerator mEnvelopeGenerator;</code> <br> <br>   <code>#include "EnvelopeGenerator.h"</code>   . <br> ,   <code>ProcessDoubleReplacing</code> <i>Synthesis.cpp</i>   <code>leftOutput[i]</code>  : <br> <br> <code class="cpp">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</code> <br> <br>    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . <br>     <code>mEnvelopeGenerator</code>     .   <code>Synthesis::Reset()</code> : <br> <br> <code class="cpp">mEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>       .     -    ‚Äî        ! . <br> <br>    Note On/Off <br> <br>    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. <code>mMIDIReceiver</code>     note on/off,  ,  -    . <br> <br>         <code>#include EnvelopeGenerator.h</code>  <i>MIDIReceiver.h</i> . ,  <i>Synthesis.h</i>          <code>mEnvelopeGenerator</code>  <code>mMIDIReceiver</code> ,      .  <code>MIDIReceiver</code>   <code>enterStage</code>   note on/off. <br>  , . . <code>MIDIReceiver</code>    <code>EnvelopeGenerator</code> .       ,      <code>MIDIReceiver</code>   ,    <code>EnvelopeGenerator</code> . <br> <br>   <a href="http://qt-project.org/doc/qt-5/signalsandslots.html"></a>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"></a> .      Qt.    , ,          ,      .    ,   .       ,  <code>setText()</code> ,        .    ,    ,      ,   . ,  ,  .          ( <code>Oscillator</code> , <code>EnvelopeGenerator</code> , <code>MIDIReceiver</code> ).    <i> </i> , . .   <code>Synthesis</code> . <br> <br>       Qt    .     <a href="https://github.com/pbhogan/Signals">Signals</a>  .   .  <i>Signal.h</i>  <i>GallantSignal.h</i> ,    .  <i>Delegate.h</i>  <i>GallantSignal.h</i>   ( ,   ,  <i>‚ÄúCopy items into destination group's folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#include "GallantSignal.h" using Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code>public</code> : <br> <br> <code class="cpp">Signal2&lt; int, int &gt; noteOn; Signal2&lt; int, int &gt; noteOff;</code> <br> <br>  ,        <code>int</code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides any previously pressed key: if (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// If the last note was released, nothing should play: if (noteNumber == mLastNoteNumber) { mLastNoteNumber = -1; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code>-1</code> ,   :      RELEASE.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.Connect(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.Connect(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code>if</code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       RELEASE,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins-011-envelopes</a></code> <pre> <code class="hljs pgsql"><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> <span class="hljs-type"><span class="hljs-type">void</span></span> EnvelopeGenerator::calculateMultiplier(<span class="hljs-type"><span class="hljs-type">double</span></span> startLevel, <span class="hljs-type"><span class="hljs-type">double</span></span> endLevel, unsigned long long lengthInSamples) { multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span> + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp"><span class="hljs-type"><span class="hljs-type">void</span></span> EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_OFF: currentLevel = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, nextStageSampleIndex); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_DECAY: currentLevel = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_RELEASE: // We could go <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ATTACK/DECAY <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>, // so w<span class="hljs-string"><span class="hljs-string">e're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    </span></span><code><span class="hljs-string"><span class="hljs-string">currentStage</span></span></code><span class="hljs-string"><span class="hljs-string">     </span></span><code><span class="hljs-string"><span class="hljs-string">currentSampleIndex</span></span></code><span class="hljs-string"><span class="hljs-string"> .       </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> .   ,       ,   . </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[currentStage]</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">double</span></span></code><span class="hljs-string"><span class="hljs-string"> (   ), ,       ,     . </span></span><code><span class="hljs-string"><span class="hljs-string">Switch</span></span></code><span class="hljs-string"><span class="hljs-string">     .  OFF         (  ,    ). ATTACK    </span></span><code><span class="hljs-string"><span class="hljs-string">minimumLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> ,  </span></span><code><span class="hljs-string"><span class="hljs-string">multiplier</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">1.0</span></span></code><span class="hljs-string"><span class="hljs-string"> .   DECAY       </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[ENVELOPE_STAGE_SUSTAIN]</span></span></code><span class="hljs-string"><span class="hljs-string"> ,  </span></span><code><span class="hljs-string"><span class="hljs-string">fmax</span></span></code><span class="hljs-string"><span class="hljs-string"> ,      . RELEASE  </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> ,     ,  </span></span><code><span class="hljs-string"><span class="hljs-string">minimumLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> .    ,    RELEASE    </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[ENVELOPE_STAGE_SUSTAIN]</span></span></code><span class="hljs-string"><span class="hljs-string">    ,  </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> .         </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">        : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">private</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis</span></span></code><span class="hljs-string"><span class="hljs-string"> (  )   : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator mEnvelopeGenerator;</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">#include "EnvelopeGenerator.h"</span></span></code><span class="hljs-string"><span class="hljs-string">   . </span></span><br><span class="hljs-string"><span class="hljs-string"> ,   </span></span><code><span class="hljs-string"><span class="hljs-string">ProcessDoubleReplacing</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><i><span class="hljs-string"><span class="hljs-string">Synthesis.cpp</span></span></i><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">leftOutput[i]</span></span></code><span class="hljs-string"><span class="hljs-string">  : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . </span></span><br><span class="hljs-string"><span class="hljs-string">     </span></span><code><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string">     .   </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis::Reset()</span></span></code><span class="hljs-string"><span class="hljs-string"> : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator.setSampleRate(GetSampleRate());</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">       .     -    ‚Äî        ! . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    Note On/Off </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. </span></span><code><span class="hljs-string"><span class="hljs-string">mMIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">     note on/off,  ,  -    . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">         </span></span><code><span class="hljs-string"><span class="hljs-string">#include EnvelopeGenerator.h</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">MIDIReceiver.h</span></span></i><span class="hljs-string"><span class="hljs-string"> . ,  </span></span><i><span class="hljs-string"><span class="hljs-string">Synthesis.h</span></span></i><span class="hljs-string"><span class="hljs-string">          </span></span><code><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">mMIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string"> ,      .  </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">enterStage</span></span></code><span class="hljs-string"><span class="hljs-string">   note on/off. </span></span><br><span class="hljs-string"><span class="hljs-string">  , . . </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">    </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> .       ,      </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">   ,    </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><a href="http://qt-project.org/doc/qt-5/signalsandslots.html"><span class="hljs-string"><span class="hljs-string"></span></span></a><span class="hljs-string"><span class="hljs-string">  </span></span><a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"><span class="hljs-string"><span class="hljs-string"></span></span></a><span class="hljs-string"><span class="hljs-string"> .      Qt.    , ,          ,      .    ,   .       ,  </span></span><code><span class="hljs-string"><span class="hljs-string">setText()</span></span></code><span class="hljs-string"><span class="hljs-string"> ,        .    ,    ,      ,   . ,  ,  .          ( </span></span><code><span class="hljs-string"><span class="hljs-string">Oscillator</span></span></code><span class="hljs-string"><span class="hljs-string"> , </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> , </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string"> ).    </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> , . .   </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">       Qt    .     </span></span><a href="https://github.com/pbhogan/Signals"><span class="hljs-string"><span class="hljs-string">Signals</span></span></a><span class="hljs-string"><span class="hljs-string">  .   .  </span></span><i><span class="hljs-string"><span class="hljs-string">Signal.h</span></span></i><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">GallantSignal.h</span></span></i><span class="hljs-string"><span class="hljs-string"> ,    .  </span></span><i><span class="hljs-string"><span class="hljs-string">Delegate.h</span></span></i><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">GallantSignal.h</span></span></i><span class="hljs-string"><span class="hljs-string">   ( ,   ,  </span></span><i><span class="hljs-string"><span class="hljs-string">‚ÄúCopy items into destination group'</span></span>s folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "GallantSignal.h" <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code><span class="hljs-built_in"><span class="hljs-built_in">public</span></span></code> : <br> <br> <code class="cpp">Signal2&lt; <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> &gt; noteOn; Signal2&lt; <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> &gt; noteOff;</code> <br> <br>  ,        <code><span class="hljs-type"><span class="hljs-type">int</span></span></code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> previously pressed key: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the last note was released, <span class="hljs-keyword"><span class="hljs-keyword">nothing</span></span> should play: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noteNumber == mLastNoteNumber) { mLastNoteNumber = <span class="hljs-number"><span class="hljs-number">-1</span></span>; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code><span class="hljs-number"><span class="hljs-number">-1</span></span></code> ,   :      <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp"><span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onNoteOn(const <span class="hljs-type"><span class="hljs-type">int</span></span> noteNumber, const <span class="hljs-type"><span class="hljs-type">int</span></span> velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onNoteOff(const <span class="hljs-type"><span class="hljs-type">int</span></span> noteNumber, const <span class="hljs-type"><span class="hljs-type">int</span></span> velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code><span class="hljs-keyword"><span class="hljs-keyword">if</span></span></code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins<span class="hljs-number"><span class="hljs-number">-011</span></span>-envelopes</a></code> </pre> <code><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> void EnvelopeGenerator::calculateMultiplier(double startLevel, double endLevel, unsigned long long lengthInSamples) { multiplier = 1.0 + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp">void EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = 0; if (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = 0; } else { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { case ENVELOPE_STAGE_OFF: currentLevel = 0.0; multiplier = 1.0; break; case ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, 1.0, nextStageSampleIndex); break; case ENVELOPE_STAGE_DECAY: currentLevel = 1.0; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; case ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = 1.0; break; case ENVELOPE_STAGE_RELEASE: // We could go from ATTACK/DECAY to RELEASE, // so we're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</code> <br> <br>    <code>currentStage</code>     <code>currentSampleIndex</code> .       <i> </i> .   ,       ,   . <code>stageValue[currentStage]</code>   <code>double</code> (   ), ,       ,     . <code>Switch</code>     .  OFF         (  ,    ). ATTACK    <code>minimumLevel</code> ,  <code>multiplier</code>   <code>currentLevel</code>  <code>1.0</code> .   DECAY       <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code> ,  <code>fmax</code> ,      . RELEASE  <code>currentLevel</code> ,     ,  <code>minimumLevel</code> .    ,    RELEASE    <code>currentLevel</code> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code>    ,  <i> </i> .         <code>currentLevel</code> . <br> <br>   <br> <br>        : <br> <br> <code class="cpp">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</code> <br> <br>   <code>private</code>  <code>Synthesis</code> (  )   : <br> <br> <code class="cpp">EnvelopeGenerator mEnvelopeGenerator;</code> <br> <br>   <code>#include "EnvelopeGenerator.h"</code>   . <br> ,   <code>ProcessDoubleReplacing</code> <i>Synthesis.cpp</i>   <code>leftOutput[i]</code>  : <br> <br> <code class="cpp">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</code> <br> <br>    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . <br>     <code>mEnvelopeGenerator</code>     .   <code>Synthesis::Reset()</code> : <br> <br> <code class="cpp">mEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>       .     -    ‚Äî        ! . <br> <br>    Note On/Off <br> <br>    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. <code>mMIDIReceiver</code>     note on/off,  ,  -    . <br> <br>         <code>#include EnvelopeGenerator.h</code>  <i>MIDIReceiver.h</i> . ,  <i>Synthesis.h</i>          <code>mEnvelopeGenerator</code>  <code>mMIDIReceiver</code> ,      .  <code>MIDIReceiver</code>   <code>enterStage</code>   note on/off. <br>  , . . <code>MIDIReceiver</code>    <code>EnvelopeGenerator</code> .       ,      <code>MIDIReceiver</code>   ,    <code>EnvelopeGenerator</code> . <br> <br>   <a href="http://qt-project.org/doc/qt-5/signalsandslots.html"></a>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"></a> .      Qt.    , ,          ,      .    ,   .       ,  <code>setText()</code> ,        .    ,    ,      ,   . ,  ,  .          ( <code>Oscillator</code> , <code>EnvelopeGenerator</code> , <code>MIDIReceiver</code> ).    <i> </i> , . .   <code>Synthesis</code> . <br> <br>       Qt    .     <a href="https://github.com/pbhogan/Signals">Signals</a>  .   .  <i>Signal.h</i>  <i>GallantSignal.h</i> ,    .  <i>Delegate.h</i>  <i>GallantSignal.h</i>   ( ,   ,  <i>‚ÄúCopy items into destination group's folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#include "GallantSignal.h" using Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code>public</code> : <br> <br> <code class="cpp">Signal2&lt; int, int &gt; noteOn; Signal2&lt; int, int &gt; noteOff;</code> <br> <br>  ,        <code>int</code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides any previously pressed key: if (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// If the last note was released, nothing should play: if (noteNumber == mLastNoteNumber) { mLastNoteNumber = -1; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code>-1</code> ,   :      RELEASE.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.Connect(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.Connect(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code>if</code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       RELEASE,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins-011-envelopes</a></code> <pre> <code class="hljs pgsql"><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> <span class="hljs-type"><span class="hljs-type">void</span></span> EnvelopeGenerator::calculateMultiplier(<span class="hljs-type"><span class="hljs-type">double</span></span> startLevel, <span class="hljs-type"><span class="hljs-type">double</span></span> endLevel, unsigned long long lengthInSamples) { multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span> + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp"><span class="hljs-type"><span class="hljs-type">void</span></span> EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_OFF: currentLevel = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, nextStageSampleIndex); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_DECAY: currentLevel = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ENVELOPE_STAGE_RELEASE: // We could go <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ATTACK/DECAY <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>, // so w<span class="hljs-string"><span class="hljs-string">e're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    </span></span><code><span class="hljs-string"><span class="hljs-string">currentStage</span></span></code><span class="hljs-string"><span class="hljs-string">     </span></span><code><span class="hljs-string"><span class="hljs-string">currentSampleIndex</span></span></code><span class="hljs-string"><span class="hljs-string"> .       </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> .   ,       ,   . </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[currentStage]</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">double</span></span></code><span class="hljs-string"><span class="hljs-string"> (   ), ,       ,     . </span></span><code><span class="hljs-string"><span class="hljs-string">Switch</span></span></code><span class="hljs-string"><span class="hljs-string">     .  OFF         (  ,    ). ATTACK    </span></span><code><span class="hljs-string"><span class="hljs-string">minimumLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> ,  </span></span><code><span class="hljs-string"><span class="hljs-string">multiplier</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">1.0</span></span></code><span class="hljs-string"><span class="hljs-string"> .   DECAY       </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[ENVELOPE_STAGE_SUSTAIN]</span></span></code><span class="hljs-string"><span class="hljs-string"> ,  </span></span><code><span class="hljs-string"><span class="hljs-string">fmax</span></span></code><span class="hljs-string"><span class="hljs-string"> ,      . RELEASE  </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> ,     ,  </span></span><code><span class="hljs-string"><span class="hljs-string">minimumLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> .    ,    RELEASE    </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  </span></span><code><span class="hljs-string"><span class="hljs-string">stageValue[ENVELOPE_STAGE_SUSTAIN]</span></span></code><span class="hljs-string"><span class="hljs-string">    ,  </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> .         </span></span><code><span class="hljs-string"><span class="hljs-string">currentLevel</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">        : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">private</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis</span></span></code><span class="hljs-string"><span class="hljs-string"> (  )   : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator mEnvelopeGenerator;</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">#include "EnvelopeGenerator.h"</span></span></code><span class="hljs-string"><span class="hljs-string">   . </span></span><br><span class="hljs-string"><span class="hljs-string"> ,   </span></span><code><span class="hljs-string"><span class="hljs-string">ProcessDoubleReplacing</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><i><span class="hljs-string"><span class="hljs-string">Synthesis.cpp</span></span></i><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">leftOutput[i]</span></span></code><span class="hljs-string"><span class="hljs-string">  : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . </span></span><br><span class="hljs-string"><span class="hljs-string">     </span></span><code><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string">     .   </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis::Reset()</span></span></code><span class="hljs-string"><span class="hljs-string"> : </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><code class="cpp"><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator.setSampleRate(GetSampleRate());</span></span></code><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">       .     -    ‚Äî        ! . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    Note On/Off </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. </span></span><code><span class="hljs-string"><span class="hljs-string">mMIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">     note on/off,  ,  -    . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">         </span></span><code><span class="hljs-string"><span class="hljs-string">#include EnvelopeGenerator.h</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">MIDIReceiver.h</span></span></i><span class="hljs-string"><span class="hljs-string"> . ,  </span></span><i><span class="hljs-string"><span class="hljs-string">Synthesis.h</span></span></i><span class="hljs-string"><span class="hljs-string">          </span></span><code><span class="hljs-string"><span class="hljs-string">mEnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string">  </span></span><code><span class="hljs-string"><span class="hljs-string">mMIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string"> ,      .  </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">   </span></span><code><span class="hljs-string"><span class="hljs-string">enterStage</span></span></code><span class="hljs-string"><span class="hljs-string">   note on/off. </span></span><br><span class="hljs-string"><span class="hljs-string">  , . . </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">    </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> .       ,      </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string">   ,    </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">   </span></span><a href="http://qt-project.org/doc/qt-5/signalsandslots.html"><span class="hljs-string"><span class="hljs-string"></span></span></a><span class="hljs-string"><span class="hljs-string">  </span></span><a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"><span class="hljs-string"><span class="hljs-string"></span></span></a><span class="hljs-string"><span class="hljs-string"> .      Qt.    , ,          ,      .    ,   .       ,  </span></span><code><span class="hljs-string"><span class="hljs-string">setText()</span></span></code><span class="hljs-string"><span class="hljs-string"> ,        .    ,    ,      ,   . ,  ,  .          ( </span></span><code><span class="hljs-string"><span class="hljs-string">Oscillator</span></span></code><span class="hljs-string"><span class="hljs-string"> , </span></span><code><span class="hljs-string"><span class="hljs-string">EnvelopeGenerator</span></span></code><span class="hljs-string"><span class="hljs-string"> , </span></span><code><span class="hljs-string"><span class="hljs-string">MIDIReceiver</span></span></code><span class="hljs-string"><span class="hljs-string"> ).    </span></span><i><span class="hljs-string"><span class="hljs-string"> </span></span></i><span class="hljs-string"><span class="hljs-string"> , . .   </span></span><code><span class="hljs-string"><span class="hljs-string">Synthesis</span></span></code><span class="hljs-string"><span class="hljs-string"> . </span></span><br><span class="hljs-string"><span class="hljs-string"> </span></span><br><span class="hljs-string"><span class="hljs-string">       Qt    .     </span></span><a href="https://github.com/pbhogan/Signals"><span class="hljs-string"><span class="hljs-string">Signals</span></span></a><span class="hljs-string"><span class="hljs-string">  .   .  </span></span><i><span class="hljs-string"><span class="hljs-string">Signal.h</span></span></i><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">GallantSignal.h</span></span></i><span class="hljs-string"><span class="hljs-string"> ,    .  </span></span><i><span class="hljs-string"><span class="hljs-string">Delegate.h</span></span></i><span class="hljs-string"><span class="hljs-string">  </span></span><i><span class="hljs-string"><span class="hljs-string">GallantSignal.h</span></span></i><span class="hljs-string"><span class="hljs-string">   ( ,   ,  </span></span><i><span class="hljs-string"><span class="hljs-string">‚ÄúCopy items into destination group'</span></span>s folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "GallantSignal.h" <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code><span class="hljs-built_in"><span class="hljs-built_in">public</span></span></code> : <br> <br> <code class="cpp">Signal2&lt; <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> &gt; noteOn; Signal2&lt; <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> &gt; noteOff;</code> <br> <br>  ,        <code><span class="hljs-type"><span class="hljs-type">int</span></span></code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> previously pressed key: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the last note was released, <span class="hljs-keyword"><span class="hljs-keyword">nothing</span></span> should play: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (noteNumber == mLastNoteNumber) { mLastNoteNumber = <span class="hljs-number"><span class="hljs-number">-1</span></span>; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code><span class="hljs-number"><span class="hljs-number">-1</span></span></code> ,   :      <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp"><span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onNoteOn(const <span class="hljs-type"><span class="hljs-type">int</span></span> noteNumber, const <span class="hljs-type"><span class="hljs-type">int</span></span> velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onNoteOff(const <span class="hljs-type"><span class="hljs-type">int</span></span> noteNumber, const <span class="hljs-type"><span class="hljs-type">int</span></span> velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.<span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span>(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code><span class="hljs-keyword"><span class="hljs-keyword">if</span></span></code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       <span class="hljs-keyword"><span class="hljs-keyword">RELEASE</span></span>,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins<span class="hljs-number"><span class="hljs-number">-011</span></span>-envelopes</a></code> </pre> <code><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> void EnvelopeGenerator::calculateMultiplier(double startLevel, double endLevel, unsigned long long lengthInSamples) { multiplier = 1.0 + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp">void EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = 0; if (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = 0; } else { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { case ENVELOPE_STAGE_OFF: currentLevel = 0.0; multiplier = 1.0; break; case ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, 1.0, nextStageSampleIndex); break; case ENVELOPE_STAGE_DECAY: currentLevel = 1.0; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; case ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = 1.0; break; case ENVELOPE_STAGE_RELEASE: // We could go from ATTACK/DECAY to RELEASE, // so we're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</code> <br> <br>    <code>currentStage</code>     <code>currentSampleIndex</code> .       <i> </i> .   ,       ,   . <code>stageValue[currentStage]</code>   <code>double</code> (   ), ,       ,     . <code>Switch</code>     .  OFF         (  ,    ). ATTACK    <code>minimumLevel</code> ,  <code>multiplier</code>   <code>currentLevel</code>  <code>1.0</code> .   DECAY       <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code> ,  <code>fmax</code> ,      . RELEASE  <code>currentLevel</code> ,     ,  <code>minimumLevel</code> .    ,    RELEASE    <code>currentLevel</code> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code>    ,  <i> </i> .         <code>currentLevel</code> . <br> <br>   <br> <br>        : <br> <br> <code class="cpp">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</code> <br> <br>   <code>private</code>  <code>Synthesis</code> (  )   : <br> <br> <code class="cpp">EnvelopeGenerator mEnvelopeGenerator;</code> <br> <br>   <code>#include "EnvelopeGenerator.h"</code>   . <br> ,   <code>ProcessDoubleReplacing</code> <i>Synthesis.cpp</i>   <code>leftOutput[i]</code>  : <br> <br> <code class="cpp">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</code> <br> <br>    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . <br>     <code>mEnvelopeGenerator</code>     .   <code>Synthesis::Reset()</code> : <br> <br> <code class="cpp">mEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>       .     -    ‚Äî        ! . <br> <br>    Note On/Off <br> <br>    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. <code>mMIDIReceiver</code>     note on/off,  ,  -    . <br> <br>         <code>#include EnvelopeGenerator.h</code>  <i>MIDIReceiver.h</i> . ,  <i>Synthesis.h</i>          <code>mEnvelopeGenerator</code>  <code>mMIDIReceiver</code> ,      .  <code>MIDIReceiver</code>   <code>enterStage</code>   note on/off. <br>  , . . <code>MIDIReceiver</code>    <code>EnvelopeGenerator</code> .       ,      <code>MIDIReceiver</code>   ,    <code>EnvelopeGenerator</code> . <br> <br>   <a href="http://qt-project.org/doc/qt-5/signalsandslots.html"></a>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"></a> .      Qt.    , ,          ,      .    ,   .       ,  <code>setText()</code> ,        .    ,    ,      ,   . ,  ,  .          ( <code>Oscillator</code> , <code>EnvelopeGenerator</code> , <code>MIDIReceiver</code> ).    <i> </i> , . .   <code>Synthesis</code> . <br> <br>       Qt    .     <a href="https://github.com/pbhogan/Signals">Signals</a>  .   .  <i>Signal.h</i>  <i>GallantSignal.h</i> ,    .  <i>Delegate.h</i>  <i>GallantSignal.h</i>   ( ,   ,  <i>‚ÄúCopy items into destination group's folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#include "GallantSignal.h" using Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code>public</code> : <br> <br> <code class="cpp">Signal2&lt; int, int &gt; noteOn; Signal2&lt; int, int &gt; noteOff;</code> <br> <br>  ,        <code>int</code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides any previously pressed key: if (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// If the last note was released, nothing should play: if (noteNumber == mLastNoteNumber) { mLastNoteNumber = -1; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code>-1</code> ,   :      RELEASE.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.Connect(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.Connect(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code>if</code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       RELEASE,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins-011-envelopes</a></code> <h3> <code><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> void EnvelopeGenerator::calculateMultiplier(double startLevel, double endLevel, unsigned long long lengthInSamples) { multiplier = 1.0 + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp">void EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = 0; if (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = 0; } else { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { case ENVELOPE_STAGE_OFF: currentLevel = 0.0; multiplier = 1.0; break; case ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, 1.0, nextStageSampleIndex); break; case ENVELOPE_STAGE_DECAY: currentLevel = 1.0; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; case ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = 1.0; break; case ENVELOPE_STAGE_RELEASE: // We could go from ATTACK/DECAY to RELEASE, // so we're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</code> <br> <br>    <code>currentStage</code>     <code>currentSampleIndex</code> .       <i> </i> .   ,       ,   . <code>stageValue[currentStage]</code>   <code>double</code> (   ), ,       ,     . <code>Switch</code>     .  OFF         (  ,    ). ATTACK    <code>minimumLevel</code> ,  <code>multiplier</code>   <code>currentLevel</code>  <code>1.0</code> .   DECAY       <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code> ,  <code>fmax</code> ,      . RELEASE  <code>currentLevel</code> ,     ,  <code>minimumLevel</code> .    ,    RELEASE    <code>currentLevel</code> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code>    ,  <i> </i> .         <code>currentLevel</code> . <br> <br>   <br> <br>        : <br> <br> <code class="cpp">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</code> <br> <br>   <code>private</code>  <code>Synthesis</code> (  )   : <br> <br> <code class="cpp">EnvelopeGenerator mEnvelopeGenerator;</code> <br> <br>   <code>#include "EnvelopeGenerator.h"</code>   . <br> ,   <code>ProcessDoubleReplacing</code> <i>Synthesis.cpp</i>   <code>leftOutput[i]</code>  : <br> <br> <code class="cpp">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</code> <br> <br>    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . <br>     <code>mEnvelopeGenerator</code>     .   <code>Synthesis::Reset()</code> : <br> <br> <code class="cpp">mEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>       .     -    ‚Äî        ! . <br> <br>    Note On/Off <br> <br>    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. <code>mMIDIReceiver</code>     note on/off,  ,  -    . <br> <br>         <code>#include EnvelopeGenerator.h</code>  <i>MIDIReceiver.h</i> . ,  <i>Synthesis.h</i>          <code>mEnvelopeGenerator</code>  <code>mMIDIReceiver</code> ,      .  <code>MIDIReceiver</code>   <code>enterStage</code>   note on/off. <br>  , . . <code>MIDIReceiver</code>    <code>EnvelopeGenerator</code> .       ,      <code>MIDIReceiver</code>   ,    <code>EnvelopeGenerator</code> . <br> <br>   <a href="http://qt-project.org/doc/qt-5/signalsandslots.html"></a>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"></a> .      Qt.    , ,          ,      .    ,   .       ,  <code>setText()</code> ,        .    ,    ,      ,   . ,  ,  .          ( <code>Oscillator</code> , <code>EnvelopeGenerator</code> , <code>MIDIReceiver</code> ).    <i> </i> , . .   <code>Synthesis</code> . <br> <br>       Qt    .     <a href="https://github.com/pbhogan/Signals">Signals</a>  .   .  <i>Signal.h</i>  <i>GallantSignal.h</i> ,    .  <i>Delegate.h</i>  <i>GallantSignal.h</i>   ( ,   ,  <i>‚ÄúCopy items into destination group's folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#include "GallantSignal.h" using Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code>public</code> : <br> <br> <code class="cpp">Signal2&lt; int, int &gt; noteOn; Signal2&lt; int, int &gt; noteOff;</code> <br> <br>  ,        <code>int</code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides any previously pressed key: if (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// If the last note was released, nothing should play: if (noteNumber == mLastNoteNumber) { mLastNoteNumber = -1; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code>-1</code> ,   :      RELEASE.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.Connect(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.Connect(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code>if</code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       RELEASE,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins-011-envelopes</a></code> </h3> <code><a href="http://www.musicdsp.org/showone.php%3Fid%3D189"></a> <code class="cpp">. ,   :       ,    ,        . <br>      (        ): <br> <br> void EnvelopeGenerator::calculateMultiplier(double startLevel, double endLevel, unsigned long long lengthInSamples) { multiplier = 1.0 + (log(endLevel) - log(startLevel)) / (lengthInSamples); }</code> <br> <br>        ,  .  ,      <code>startLevel</code>  <code>endLevel</code>    <code>lengthInSamples</code>    <code>multiplier</code> ,       .      <code>currentLevel</code> .  <code>log()</code>  <i></i> . <br> <br>    <br> <br>    <code>enterStage</code> : <br> <br> <code class="cpp">void EnvelopeGenerator::enterStage(EnvelopeStage newStage) { currentStage = newStage; currentSampleIndex = 0; if (currentStage == ENVELOPE_STAGE_OFF || currentStage == ENVELOPE_STAGE_SUSTAIN) { nextStageSampleIndex = 0; } else { nextStageSampleIndex = stageValue[currentStage] * sampleRate; } switch (newStage) { case ENVELOPE_STAGE_OFF: currentLevel = 0.0; multiplier = 1.0; break; case ENVELOPE_STAGE_ATTACK: currentLevel = minimumLevel; calculateMultiplier(currentLevel, 1.0, nextStageSampleIndex); break; case ENVELOPE_STAGE_DECAY: currentLevel = 1.0; calculateMultiplier(currentLevel, fmax(stageValue[ENVELOPE_STAGE_SUSTAIN], minimumLevel), nextStageSampleIndex); break; case ENVELOPE_STAGE_SUSTAIN: currentLevel = stageValue[ENVELOPE_STAGE_SUSTAIN]; multiplier = 1.0; break; case ENVELOPE_STAGE_RELEASE: // We could go from ATTACK/DECAY to RELEASE, // so we're not changing currentLevel here. calculateMultiplier(currentLevel, minimumLevel, nextStageSampleIndex); break; default: break; } }</code> <br> <br>    <code>currentStage</code>     <code>currentSampleIndex</code> .       <i> </i> .   ,       ,   . <code>stageValue[currentStage]</code>   <code>double</code> (   ), ,       ,     . <code>Switch</code>     .  OFF         (  ,    ). ATTACK    <code>minimumLevel</code> ,  <code>multiplier</code>   <code>currentLevel</code>  <code>1.0</code> .   DECAY       <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code> ,  <code>fmax</code> ,      . RELEASE  <code>currentLevel</code> ,     ,  <code>minimumLevel</code> .    ,    RELEASE    <code>currentLevel</code> , . .          SUSTAIN,    ATTACK  DECAY.    , SUSTAIN     ,  <code>stageValue[ENVELOPE_STAGE_SUSTAIN]</code>    ,  <i> </i> .         <code>currentLevel</code> . <br> <br>   <br> <br>        : <br> <br> <code class="cpp">void EnvelopeGenerator::setSampleRate(double newSampleRate) { sampleRate = newSampleRate; }</code> <br> <br>   <code>private</code>  <code>Synthesis</code> (  )   : <br> <br> <code class="cpp">EnvelopeGenerator mEnvelopeGenerator;</code> <br> <br>   <code>#include "EnvelopeGenerator.h"</code>   . <br> ,   <code>ProcessDoubleReplacing</code> <i>Synthesis.cpp</i>   <code>leftOutput[i]</code>  : <br> <br> <code class="cpp">// leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * velocity / 127.0; if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_OFF) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); } if (mEnvelopeGenerator.getCurrentStage() == EnvelopeGenerator::ENVELOPE_STAGE_SUSTAIN) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); } leftOutput[i] = rightOutput[i] = mOscillator.nextSample() * mEnvelopeGenerator.nextSample() * velocity / 127.0;</code> <br> <br>    .        :  OFF  ATTACK,  SUSTAIN  RELEASE.        . <br>     <code>mEnvelopeGenerator</code>     .   <code>Synthesis::Reset()</code> : <br> <br> <code class="cpp">mEnvelopeGenerator.setSampleRate(GetSampleRate());</code> <br> <br>       .     -    ‚Äî        ! . <br> <br>    Note On/Off <br> <br>    ,       (,    -   ,    ),        :   ‚Äî    ATTACK,  ‚Äî  RELEASE. <code>mMIDIReceiver</code>     note on/off,  ,  -    . <br> <br>         <code>#include EnvelopeGenerator.h</code>  <i>MIDIReceiver.h</i> . ,  <i>Synthesis.h</i>          <code>mEnvelopeGenerator</code>  <code>mMIDIReceiver</code> ,      .  <code>MIDIReceiver</code>   <code>enterStage</code>   note on/off. <br>  , . . <code>MIDIReceiver</code>    <code>EnvelopeGenerator</code> .       ,      <code>MIDIReceiver</code>   ,    <code>EnvelopeGenerator</code> . <br> <br>   <a href="http://qt-project.org/doc/qt-5/signalsandslots.html"></a>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258B_%25D0%25B8_%25D1%2581%25D0%25BB%25D0%25BE%25D1%2582%25D1%258B"></a> .      Qt.    , ,          ,      .    ,   .       ,  <code>setText()</code> ,        .    ,    ,      ,   . ,  ,  .          ( <code>Oscillator</code> , <code>EnvelopeGenerator</code> , <code>MIDIReceiver</code> ).    <i> </i> , . .   <code>Synthesis</code> . <br> <br>       Qt    .     <a href="https://github.com/pbhogan/Signals">Signals</a>  .   .  <i>Signal.h</i>  <i>GallantSignal.h</i> ,    .  <i>Delegate.h</i>  <i>GallantSignal.h</i>   ( ,   ,  <i>‚ÄúCopy items into destination group's folder‚Äù)</i>        Xcode.  VisualStudio        ,         Solution Explorer. <br> <br>  ,  <code>MIDIReceiver</code>  ,        .     <i>MIDIReceiver.h</i>  : <br> <br> <code class="cpp">#include "GallantSignal.h" using Gallant::Signal2;</code> <br> <br> <code>Signal2</code>  ,   .   ‚Äî  <code>Signal0</code>  <code>Signal8</code> ,         . <br>   <code>public</code> : <br> <br> <code class="cpp">Signal2&lt; int, int &gt; noteOn; Signal2&lt; int, int &gt; noteOff;</code> <br> <br>  ,        <code>int</code> .   <i>MIDIReceiver.cpp</i>    <code>advance</code> : <br> <br> <code class="cpp">// A key pressed later overrides any previously pressed key: if (noteNumber != mLastNoteNumber) { mLastNoteNumber = noteNumber; mLastFrequency = noteNumberToFrequency(mLastNoteNumber); mLastVelocity = velocity; // Emit a "note on" signal: noteOn(noteNumber, velocity); }</code> <br> <br> <code class="cpp">// If the last note was released, nothing should play: if (noteNumber == mLastNoteNumber) { mLastNoteNumber = -1; noteOff(noteNumber, mLastVelocity); }</code> <br> <br>   ‚Äî  ,  ‚Äî .     <code>mLastFrequency</code>  <code>-1</code> ,   :      RELEASE.    <code>mLastVelocity</code> :   ,   . <br>  ,    ,    ,        .        .     . <br> <br>    <code>mEnvelopeGenerator</code>   .     - <code>onNoteOn</code>  <code>onNoteOff</code>   <code>EnvelopeGenerator</code>    .  ,       <code>EnvelopeGenerator</code>   <i></i> .   , <i> </i>     <i></i> .        <code>enterStage</code> -   .    -  <code>private</code>   <code>Synthesis</code> : <br> <br> <code class="cpp">inline void onNoteOn(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_ATTACK); }; inline void onNoteOff(const int noteNumber, const int velocity) { mEnvelopeGenerator.enterStage(EnvelopeGenerator::ENVELOPE_STAGE_RELEASE); };</code> <br> <br>     . <br>   ,    <i>Synthesis.cpp</i>  : <br> <br> <code class="cpp">mMIDIReceiver.noteOn.Connect(this, &amp;Synthesis::onNoteOn); mMIDIReceiver.noteOff.Connect(this, &amp;Synthesis::onNoteOff);</code> <br> <br>   ‚Äî     ,  ‚Äî  -. <br>       <code>ProcessDoubleReplacing</code> .     <code>if</code> ,     ,      . <br> <br> ! <br> <br> .                 .      DECAY,       RELEASE,        .    <code>stageValues</code>   . <br>   ,        ,    .      GUI  - : <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/cd5/a48/f11/cd5a48f1183635530aabfa80820e1173.png"> <br> <br>      ! <br> <br>        <a href=""></a> . <br> <br>  : <br> <a href="http://martin-finke.de/blog/articles/audio-plugins-011-envelopes/">martin-finke.de/blog/articles/audio-plugins-011-envelopes</a></code> </div><p>Source: <a href="https://habr.com/ru/post/227475/">https://habr.com/ru/post/227475/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../227455/index.html">Useful code implementation</a></li>
<li><a href="../227459/index.html">Russian stage of the World Olympics Robots - we did it!</a></li>
<li><a href="../227467/index.html">Stories that have taught us a lot: the results of habrakrakursa</a></li>
<li><a href="../227471/index.html">Russian physicists have discovered two types of dust in the atmosphere of Mars.</a></li>
<li><a href="../227473/index.html">DIY Epilepsy Attack Detector</a></li>
<li><a href="../227477/index.html">Myo - official release in September</a></li>
<li><a href="../227479/index.html">Nokia X2 introduced: the next generation of the X line</a></li>
<li><a href="../227483/index.html">Why the growth of quality causes the growth of poor quality, or whether the main function</a></li>
<li><a href="../227485/index.html">Why do you still wear "silly" clothes?</a></li>
<li><a href="../227487/index.html">Anonymity in the era of social networks: what to do when your ‚Äúprivacy level‚Äù falls below zero</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>