<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unloading the conditions of public procurement contests with the EP. Zakupki.gov.ru</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Notes: 


- OOS - All-Russian official website ( Government procurement ). 
- Required knowledge to understand the article: VBA (MS Excel). 
 Introduc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unloading the conditions of public procurement contests with the EP. Zakupki.gov.ru</h1><div class="post__text post__text-html js-mediator-article">  Notes: <br><ul><li>  <b>OOS</b> - <i>All-Russian official website ( <a href="http://zakupki.gov.ru/">Government procurement</a> ).</i> </li><li>  Required knowledge to understand the article: <i>VBA (MS Excel).</i> </li></ul><br><h4>  <b>Introduction</b> </h4><br>  Quote: <blockquote>  ‚ÄúThe official website of the Russian Federation on the Internet for placing information about placing orders for goods, works and services ... is designed to provide free and free access to complete and reliable information about the contract system in the field of procurement and procurement of goods, works, services, certain types of legal entities, as well as for the formation, processing and storage of such information. ‚Äù </blockquote><br>  For many commercial and other companies, the system of "public procurement" is the main way of attracting state (budget) funds to economic activity.  Information on the procurement of goods, services, research carried out by companies with state participation (and other individual types of companies) is mandatory (according to federal laws No. 223, 94, 44) posted on the public procurement website.  Commercial companies also often publish their tenders on the official public procurement website. <br><br>  Links to the mentioned laws, information on the website "Consultant Plus": <br><ul><li>  <a href="http://base.consultant.ru/cons/cgi/online.cgi%3Freq%3Ddoc%3Bbase%3DLAW%3Bn%3D148890">Federal law of 21.07.2005 N 94-FZ (as amended on 02.07.2013) "On placing orders for the supply of goods, the performance of works, the provision of services for state and municipal needs"</a> </li><li>  <a href="http://base.consultant.ru/cons/cgi/online.cgi%3Freq%3Ddoc%3Bbase%3DLAW%3Bn%3D166488">Federal Law of July 18, 2011 No. 223-FZ (as amended on March 12, 2014, as amended of December 29, 2014) ‚ÄúOn the procurement of goods, works, services by certain types of legal entities‚Äù (as amended and added, force from 01/01/2015)</a> </li><li>  <a href="http://base.consultant.ru/cons/cgi/online.cgi%3Freq%3Ddoc%3Bbase%3DLAW%3Bn%3D176365">Federal law of 05/04/2013 N 44- (ed. 03/08/2015) "On the contract system in the procurement of goods, works, services for state and municipal needs"</a> </li></ul><br>  Thus, information on tenders, published on the website of public procurement, is the central source of current information on possible ‚Äústate‚Äù orders by profile for many companies from various fields of activity - from security services to geophysical surveys.  Therefore, the need to have regularly updated information about ongoing competitions that fall under certain criteria arises from each organization participating in public procurement.  In this article we will consider various methods and a practical example of the implementation of this need. <br><a name="habracut"></a><br><h4>  <b>Options for obtaining information on public procurement</b> </h4><br>  Most often, the task is put by management to the marketing or IT division of the company in the following wording: <i>‚Äúa daily summary of public procurement competitions that meets the following criteria is needed ...‚Äù</i> .  It is daily, because sometimes between the publication of the tender documentation and the end of the submission of applications for it is declared a period of less than 10 days, on average - about two weeks.  There is not much time to collect all the necessary documentation for participation in the contest, every day is ‚Äúon the bill‚Äù. <br><br>  We list the options for implementing the task. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  <b>1. The site of EP (state procurement)</b> </h5><br>  The site itself <a href="http://zakupki.gov.ru/">http://zakupki.gov.ru/</a> allows customizable search and selection of competitions by parameters. <br><br>  Disadvantages: <br><ul><li>  The search does not work correctly, sometimes there are no contests.  I am witness to a long slave through the official site, the statement I have verified; </li><li>  The site often does not work at night and on holidays; </li><li>  The limit on the number of results.  If the search returns more than 500 lines, it is impossible to download contest data (in the form of a .csv table of format) using the site. </li></ul><br>  To partially automate the process, I once wrote a plug-in for the FireFox browser, which was supposed to do a daily download of selected contests. <br><br>  In a nutshell, the plugin formed the address in the form of something like this: <br><br><pre><code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"http://zakupki.gov.ru/epz/order/extendedsearch/search.html?"</span></span> + <span class="hljs-string"><span class="hljs-string">"placeOfSearch=FZ_44"</span></span> + <span class="hljs-string"><span class="hljs-string">"&amp;orderPriceFrom="</span></span> + priceArray[i] + <span class="hljs-string"><span class="hljs-string">"&amp;orderPriceTo="</span></span> + (priceArray[i+<span class="hljs-number"><span class="hljs-number">1</span></span>]<span class="hljs-number"><span class="hljs-number">-1</span></span>) + <span class="hljs-string"><span class="hljs-string">"&amp;orderPriceCurrencyId=-1"</span></span> + <span class="hljs-string"><span class="hljs-string">"&amp;orderPublishDateFrom="</span></span> + OrderDate + <span class="hljs-string"><span class="hljs-string">"&amp;orderPublishDateTo="</span></span> + OrderDate + <span class="hljs-string"><span class="hljs-string">"&amp;headAgencyWithSubElements=true&amp;matchingWordPlace44=NOTIFICATIONS"</span></span> + <span class="hljs-string"><span class="hljs-string">"&amp;law44.okpd.withSubElements=true‚Äù + "</span></span>&amp;law44.okpd.ids=<span class="hljs-number"><span class="hljs-number">31301</span></span>%<span class="hljs-number"><span class="hljs-number">2</span></span>C37097%<span class="hljs-number"><span class="hljs-number">2</span></span>C50876%<span class="hljs-number"><span class="hljs-number">2</span></span>C51122<span class="hljs-string"><span class="hljs-string">" + "</span></span>&amp;law44.advantages[MP44]=I&amp;law44.advantages[UG44]=I<span class="hljs-string"><span class="hljs-string">" + "</span></span>&amp;law44.advantages[IN44]=I&amp;law44.advantages[MPSP44]=I<span class="hljs-string"><span class="hljs-string">" + "</span></span>&amp;morphology=<span class="hljs-literal"><span class="hljs-literal">false</span></span>&amp;strictEqual=<span class="hljs-literal"><span class="hljs-literal">false</span></span><span class="hljs-string"><span class="hljs-string">";</span></span></code> </pre> <br>  Naturally, for the 94 and 223 laws, the query parameters are different.  As you can see, OKPD, price range, etc.  it is necessary to ‚Äúsew‚Äù into the request, since otherwise the number of found contests will be too large and the search results can be downloaded only partially. <br><br><h5>  <b>2. Specialized web-based contest search services</b> </h5><br>  In response to a market request, several companies have organized information retrieval sites for ongoing competitions.  Often, these sites provide not only information on public procurement, but also on "private" tenders from electronic platforms. <br><br>  Several such systems: <br><ul><li>  <a href="http://multitender.ru/">Multitender.ru</a> : "free specialized search engine that allows you to track public procurement and commercial tenders" ¬©; </li><li>  <a href="http://tendercat.ru/">TenderCAT</a> : ‚ÄúThe TenderCAT catalog is intended to facilitate the search for government and commercial tenders and auctions in a huge mass of orders published in the government procurement portal (http://zakupki.gov.ru) daily in all regions and activities‚Äù ¬©; </li><li>  <a href="http://www.ist-budget.ru/">East Budget</a> : "The site of public procurement and tenders - the best search and analytics from the East Budget" ¬©; </li><li>  <a href="http://zakupki360.ru/">Procurement 360</a> </li></ul><br>  Other. <br>  Separately, I will mention the <a href="http://clearspending.ru/">government spending</a> , which was on the Habr√© <a href="http://habrahabr.ru/company/infoculture/blog/213303/">article</a> . <br><br>  The purpose of this article is not to compare or analyze the indicated resources, so neither their merits nor the disadvantages are given here. <br><br><h5>  <b>3. Independent development for downloading contests.</b> </h5><br>  In some (I know a few) cases, the management of a company participating in tenders sets very specific tasks concerning information selection parameters, regularity of search, or execution of a search result.  In such cases, turn to IT specialists, ‚Äúmanual work‚Äù on monitoring and selection of competitions becomes too time consuming. <br><br>  There are examples of the order of the described work with freelancers.  For example, on <a href="http://www.sql.ru/forum/1130011/specialist-po-rabote-s-zakupki-gov-ru-api-parsing-i-t-d">SQL.ru</a> , on <a href="http://www.weblancer.net/projects/598450.html">Weblancer</a> .  Finally, you can purchase a turnkey solution from time-honored <a href="">performers</a> .  However, the main part of this article describes the procedure for independent performance of the task. <br><br><h4>  <b>Downloading contest data from <a href="http://zakupki.gov.ru/">http://zakupki.gov.ru</a> using Excel VBA</b> </h4><br><h5>  <b>Initial data</b> </h5><br>  The basic necessary knowledge about the source of the data: The <i>EP (Russian official procurement website) has a public ftp-server</i> .  Moreover, if http regularly (usually at night and holidays) is not available due to ‚Äúmaintenance‚Äù, then ftp works (according to my practice) quite reliably. <br><br>  The addresses of ftp servers are divided according to federal laws, which are used for placing tenders: <br>   ‚Ññ223: <b><a href="">ftp://ftp.zakupki.gov.ru/out/</a></b> <br><br><div class="spoiler">  <b class="spoiler_title">Login and password:</b> <div class="spoiler_text">  fz223free <br></div></div><br>  Federal Law No. 94 and Federal Law No. 44: <b><a href="">ftp://zakupki.gov.ru</a></b> <br><div class="spoiler">  <b class="spoiler_title">Login and password:</b> <div class="spoiler_text">  free <br></div></div><br>  The directory structure for law 223 is completely transparent.  As for 94 and 44, the following subdirectories of interest are located here: <br><ol><li>  <b>94fz</b> directory containing data of public uploads in accordance with 94FZ (other directories - 44FZ), </li><li>  <b>fcs_regions</b> directory containing the data of the complete regional uploading of information published on DUS in accordance with 94FZ. </li></ol><br><br>  The remaining catalogs contain regulatory reference information, information on bank guarantees, unloading according to the rules and as part of the solution of the problem are not of interest. <br><br>  Further, the necessary extracts from the explanations on the procedure for uploading information about published documents in the region to the FTP server of the All-Russian official website, a set of quotes: <br><blockquote>  <em>Full regional landings include all documents of the following types published on DUS:</em> <br>  <em>‚Ä¢ published notices;</em> <br>  <em>‚Ä¢ published changes to notices;</em> <br>  <em>‚Ä¢ published protocols;</em> <br>  <em>‚Ä¢ published information about contracts;</em> <br>  <em>‚Ä¢ published contract changes;</em> <br>  <em>‚Ä¢ published information on the execution / termination of contracts.</em> <br></blockquote><br>  <i>Note that for our purposes, only notice is of interest.</i>  <i>All other types of documents within the task are not used!</i> <br><blockquote>  <em>Uploading is done in archived XML files.</em> <br>  <em>In one file there can be documents of only one type in an amount not exceeding 3000 records.</em>  <em>If the number of documents to be uploaded exceeds 3000 records, the system generates several files and each places in a separate archive.</em> <br>  <em>All generated and archived XML files are uploaded to an FTP server ... the files in the upload are divided into directories corresponding to the region.</em>  <em>In each catalog of the region there are 3 more catalogs: notifications, protocols and contracts.</em>  <em>In each of the notifications, protocols and contracts directories there is additionally a daily directory.</em> <br>  <em>Published documents are uploaded to an FTP server in the following order:</em> <br>  <em>¬∑</em> <em>Every calendar day (daily) a list of documents published on the previous calendar day is downloaded.</em>  <em>At the same time ... uploading notices by region is done in the &lt;Region name&gt; / notifications / daily directory;</em> <br>  <em>¬∑</em> <em>Each calendar month (monthly) unloads a list of documents published in the previous calendar month.</em>  <em>At the same time ... uploading notices by region is done in the &lt;Region name&gt; / notifications directory;</em> <br>  <em>In the daily and monthly uploads, all types of documents published for the last calendar day or calendar month are respectively unloaded.</em> <br>  <em>If at the time of the unloading for the elapsed period there was not a single published document of any type, then the XML file with this type of document is unloaded empty.</em> <br>  <em>After completing the monthly upload, the catalogs with daily uploads for the past month are cleared.</em> <br>  <em>The names of the regional upload files have the following structure:</em> <br>  <em>&lt;document_region_region_start-period_end-period_number.xml.zip&gt;,</em> <br>  <em>Where:</em> <br>  <em>‚Ä¢ document view ‚Äî takes the value notification, protocol or contract for notices, protocols and contract details, respectively;</em> <br>  <em>‚Ä¢ region - the name of the region of discharge;</em> <br>  <em>‚Ä¢ start-period ‚Äî the start date of the period for selecting documents by the date and time of publication of the documents being uploaded in the format yyyyddmm_hhmmss, where yyyy is the year, mm is the month (number), dd is the day, hh is the hour, mm is the minutes, ss is the second;</em> <br>  <em>‚Ä¢ end-period - the end date of the period for selecting documents by the date-time of publication of the documents being uploaded in the format yyyyddmm_hhmmss, where yyyy is the year, mm is the month (number), dd is the day, hh is the hour, mm is the minutes, ss is the second;</em> <br>  <em>‚Ä¢ number - the sequence number of the generated file;</em> <br></blockquote><br>  The current version of the above information can be downloaded from the EP in the form of documents "Information Exchange Schemes ...". <br><br><h5>  <b>Description of the program of automatic downloading of competitive information (VBA MS Excel, Windows).</b> </h5><br><h6>  <b>Training</b> </h6><br><ul><li>  We connect scripting Microsoft Scripting Runtime.  For FSO functionality ( <i>\ Windows \ System32 \ scrrun.dll</i> ) </li><li>  We connect scripting of Microsoft XML, v.6 </li></ul><br>  To query the date range in which to download contests, I made a userForm using the <b>MonthView</b> element.  Its settings allow you to expand two months side by side (suppose that the range is no longer than a month), show the current date (red frame), set the selected date range as default. <br><br><img src="https://habrastorage.org/files/ebf/a18/0f9/ebfa180f944645449392876e63b3a067.jpg" alt="Date range"><br><br>  The example selected range from February 26 to March 4.  Selected dates are read from Form properties: <br><br><pre> <code class="vbscript hljs">MonthView.SelStart  MonthView.SelEnd</code> </pre> <br>  This filter allows you to select files (the structure of whose names are known to us) in a given date range: <br><br><pre> <code class="vbscript hljs">fltr = <span class="hljs-string"><span class="hljs-string">"*_"</span></span> &amp; Format(targetDate, <span class="hljs-string"><span class="hljs-string">"yyyymmdd"</span></span>) &amp; <span class="hljs-string"><span class="hljs-string">"*"</span></span> &amp; Format(targetDate + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"yyyymmdd"</span></span>) &amp; <span class="hljs-string"><span class="hljs-string">"*.zip;"</span></span> &amp; <span class="hljs-string"><span class="hljs-string">"*_"</span></span> &amp; Format(targetDate, <span class="hljs-string"><span class="hljs-string">"yyyymmdd"</span></span>) &amp; <span class="hljs-string"><span class="hljs-string">"*"</span></span> &amp; Format(targetDate, <span class="hljs-string"><span class="hljs-string">"yyyymmdd"</span></span>) &amp; <span class="hljs-string"><span class="hljs-string">"*.zip"</span></span></code> </pre><br>  Note that here the semicolon separates the alternatives, so this filter is suitable for files generated according to all three laws. <br><br>  I download files to a specified directory, which I pre-clear of old downloads using FSO methods: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Dim</span></span> FSO As FileSystemObject <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> FSO = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span> FileSystemObject</code> </pre><br>  Next, select the target folder bFld = FSO.GetFolder (...) and destroy the subdirectories: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">For</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Each</span></span> SubFolder <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> bFld.SubFolders SubFolder.Delete <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span></code> </pre><br>  Not at all obligatory, but the use of <pre> <code class="vbscript hljs"> Application.Speech.Speak</code> </pre>  It is convenient not to monitor the progress of a long procedure, but to go about your business regularly to hear messages (in a pleasant female voice) like: <br><br><pre> <code class="vbscript hljs"> Application.Speech.Speak <span class="hljs-string"><span class="hljs-string">"Downloading purchase notices"</span></span>, <span class="hljs-literal"><span class="hljs-literal">True</span></span></code> </pre> <br>  The second parameter is asynchronous execution. <br><br><h6>  <b>File download</b> </h6><br>  Start downloading.  Make sure the target folder exists by <pre> <code class="vbscript hljs">FSO.FolderExists</code> </pre>  and, if necessary, create it with the <b>MkDir</b> function. <br>  Create a shell object <br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> myShell = <span class="hljs-built_in"><span class="hljs-built_in">CreateObject</span></span>(<span class="hljs-string"><span class="hljs-string">"Shell.Application"</span></span>)</code> </pre><br>  and apply the main feature of the described approach - the <a href="https://msdn.microsoft.com/ru-ru/library/windows/desktop/bb774085%2528v%3Dvs.85%2529.aspx%3Fcs-save-lang%3D1%26amp%3Bcs-lang%3Dvb"><b>namespace</b></a> method: <br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> ftpItems = myShell.Namespace(FTP).Items</code> </pre><br>  The specified line implements access to FTP, returning folders and files.  Please note that the passed parameter must be of type <i><b>Variant</b></i> , not <b><i>String</i></b> . <br><br>  You can select all directories as follows: <br><br><pre> <code class="vbscript hljs">ftpItems.<span class="hljs-built_in"><span class="hljs-built_in">Filter</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-string"><span class="hljs-string">"*"</span></span>.</code> </pre><br>  Select subdirectories and files ( <i>96 = 32 + 64</i> ) and apply a filter like the one that was built at the beginning of the paragraph to select files by date - like this: <br><br><pre> <code class="vbscript hljs">ftpItems.<span class="hljs-built_in"><span class="hljs-built_in">Filter</span></span> <span class="hljs-number"><span class="hljs-number">96</span></span>, fltr.</code> </pre><br>  It remains to specify the target (local) folder for downloading in a similar way: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> tFolder = myShell.Namespace(tgtFolder)</code> </pre><br>  And run the "copy" (it is also "download") as follows: <br><br><pre> <code class="vbscript hljs">tFolder.CopyHere ftpItems, <span class="hljs-number"><span class="hljs-number">20</span></span></code> </pre><br>  This command starts the external process (in Windows, the standard progress bar for copying files is displayed), its execution from vba is not controlled directly.  However, we need to wait until the end of its execution, for which we use the following method in the cycle to check for the presence of the last of the copied files: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">While</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Len</span></span>(Dir$(tgtFolder &amp; <span class="hljs-string"><span class="hljs-string">"\"</span></span> &amp; ftpItems.Item(ftpItems.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>).Name)) = <span class="hljs-number"><span class="hljs-number">0</span></span> Sleep <span class="hljs-number"><span class="hljs-number">1</span></span>: DoEvents <span class="hljs-keyword"><span class="hljs-keyword">Wend</span></span></code> </pre><br>  So arranged "waiting" lasts exactly as long as the files are copied. <br><br><h6>  <b>Unpacking (unzipping) downloaded files</b> </h6><br>  After scanning all the directories and subdirectories and downloading all the filtered files, we proceed to processing them on the local machine: <br><br><pre> <code class="vbscript hljs">Application.Speech.Speak <span class="hljs-string"><span class="hljs-string">"Unzipping archives"</span></span>, <span class="hljs-literal"><span class="hljs-literal">True</span></span>.</code> </pre><br>  To do this, use the <b><i>namespace</i></b> method again. <br>  We iterate through all the archives in the folder <pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">For</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Each</span></span> fl <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> tFolderItems</code> </pre><br>  and use the fact that these archives in Windows are visible as subdirectories!  Accordingly, the entire contents of the archive is available as follows: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> flItems = myShell.Namespace(CVar(tgtFolder &amp; <span class="hljs-string"><span class="hljs-string">"\"</span></span> &amp; fl.Name)).Items</code> </pre><br>  (Again, I draw your attention to the fact that the parameter must be a <i><b>Variant</b></i> , which is why a type conversion from the string is necessary). <br><br>  Again, the same <i><b>CopyHere</b></i> command allows <i><b>you</b></i> to ‚Äúcopy‚Äù (actually extract) all files from the archive into the target folder: <pre> <code class="vbscript hljs">myShell.Namespace(tgtFolder).CopyHere flItems, <span class="hljs-number"><span class="hljs-number">20</span></span></code> </pre><br>  and asynchronous execution causes us to wait in a loop to complete the execution of this command in the same way as described above. <br><br>  There are a lot of garbage among the unzipped files.  For example, for some region there were no purchases on a certain day, the CAB generates an empty file for that date.  Therefore, before parsing xml, I prefer to delete unnecessary.  Using FSO, iterate through files <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> fold = FSO.GetFolder(tgtFolder) <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Each</span></span> fl <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> fold.Files</code> </pre><br>  ‚ÄúScreening out‚Äù is easy to produce by file size <i><b>(fl.Size &lt;= 198)</b></i> and filtering its name <i><b>Not (LCase (fl.Name) Like "* noti *"))</b></i> . <br><br>  Deleting a file is extremely simple: <i><b>fl.Delete</b></i> <br><br><h6>  <b>XML decryption with contest data</b> </h6><br>  Deciphering xml depends on their scheme, which sometimes changes at the EP.  Therefore, the following are the basic techniques, without concentrating on individual fields and data.  We start, of course, with <br><br><pre> <code class="vbscript hljs">Application.Speech.Speak <span class="hljs-string"><span class="hljs-string">"Decoding files"</span></span>, <span class="hljs-literal"><span class="hljs-literal">True</span></span>.</code> </pre><br>  In this part, in addition to FSO, we need XML for working with files: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Dim</span></span> xml As MSXML2.DOMDocument60 <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> xml = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span> DOMDocument60: xml.async = <span class="hljs-literal"><span class="hljs-literal">False</span></span>: xml.validateOnParse = <span class="hljs-literal"><span class="hljs-literal">True</span></span></code> </pre><br>  And, of course, the target sheet ( <i>ActiveSheet</i> ) in the Excel book, where we will write information. <br>  Let's start by stopping rendering Excel for a while so that it doesn't ‚Äúflicker‚Äù: <br><br><pre> <code class="vbscript hljs">Application.ScreenUpdating = <span class="hljs-literal"><span class="hljs-literal">False</span></span></code> </pre><br>  The fundamental point is that <blockquote>  ‚ÄúXPath treats an empty prefix as a null namespace.  In other words, only prefixes associated with namespaces can be used in XPath queries.  This means that if you need to build a namespace query in an XML document, even if it is a default namespace, you need to define a prefix for it. ‚Äù </blockquote>  Therefore, to successfully parse the fields of downloaded documents for the default namespace, we add a certain prefix.  For example, "q": <br><br><pre> <code class="vbscript hljs">xml.setProperty <span class="hljs-string"><span class="hljs-string">"SelectionNamespaces"</span></span>, <span class="hljs-string"><span class="hljs-string">" xmlns:q= 'http://zakupki.gov.ru/oos/export/1' xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance' xmlns:oos='http://zakupki.gov.ru/oos/types/1'"</span></span></code> </pre><br>  This is how the namespace definitions look for parsing xml, formed by 94 FZ.  For 44, it will be slightly different: <br><br><pre> <code class="vbscript hljs">xml.setProperty <span class="hljs-string"><span class="hljs-string">"SelectionNamespaces"</span></span>, <span class="hljs-string"><span class="hljs-string">"xmlns:q='http://zakupki.gov.ru/oos/types/1' xmlns:ns2='http://zakupki.gov.ru/oos/export/1' xmlns:ns3='http://zakupki.gov.ru/oos/printform/1'"</span></span></code> </pre><br>  Actually, all the above data is taken from the header of any downloaded xml file, only for the namespace <i>q is</i> added by default. <br><br>  Next, determine the field (more precisely, <b><i>xpath</i></b> , pointing to them) that need to be downloaded.  Currently, for 94 FZ, they look like this: <i>".//oos:notificationNumber", ". //Oos:lot", ".//oos:orderName", ".//oos:maxPrice".</i>  <i>For 44 FZ - another structure (thanks to the programmers OOS): ".//q:purchaseNumber", ". //Q:lot", ".//q:purchaseObjectInfo", ".//q:maxPrice|.// q: price | .// q: totalSum "</i> . <br><br>  We see that there is no unambiguity, it is necessary to set up parsing not only based on published schemes, but also on our own practical experience in decoding data. <br><br>  Check whether the xml file is ‚Äúreadable‚Äù can be a double condition: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Not</span></span> xml.Load(tgtFolder &amp; <span class="hljs-string"><span class="hljs-string">"\"</span></span> &amp; fl.Name) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span>‚Ä¶<span class="hljs-keyword"><span class="hljs-keyword">If</span></span> (xml.parseError.ErrorCode &lt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span>‚Ä¶</code> </pre><br>  If the file is read (so far I have not had any problems with the files uploaded with OOS), you can actually parse its content.  First of all, I recommend reading the field describing the composition of the message ( <i>notice</i> ). <br><br><pre> <code class="vbscript hljs">purchaseType = <span class="hljs-built_in"><span class="hljs-built_in">LCase</span></span>(xml.DocumentElement.ChildNodes(<span class="hljs-number"><span class="hljs-number">0</span></span>).BaseName) documentType = <span class="hljs-built_in"><span class="hljs-built_in">LCase</span></span>(xml.DocumentElement.BaseName)</code> </pre><br>  And check that the content of the file is exactly the announcement of the competition, and not cancel it, notification of the publication of the protocol, etc.  like that: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Not</span></span> (purchaseType Like <span class="hljs-string"><span class="hljs-string">"*cancel*"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Or</span></span> purchaseType Like <span class="hljs-string"><span class="hljs-string">"*protocol*"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Or</span></span> documentType Like <span class="hljs-string"><span class="hljs-string">"*cancel*"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span></code> </pre><br>  Since in xml, formed by 223 FZ, the name of the document type is ‚Äúhidden‚Äù, you can add: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">If</span></span> (purchaseType Like <span class="hljs-string"><span class="hljs-string">"*notification*"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Or</span></span> documentType Like <span class="hljs-string"><span class="hljs-string">"*notice*"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span></code> </pre><br>  Next comes the actual writing of data from xml to the sheet cells: <br><br><pre> <code class="vbscript hljs">Range(<span class="hljs-string"><span class="hljs-string">"A"</span></span> &amp; i) = xml.DocumentElement.SelectSingleNode(XPath).Text</code> </pre><br>  Etc. <br>  If the XPath can give several options (an indication, for example, of the names of the lots) and we want to preserve all of them, this will help: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">For</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Each</span></span> it <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> lot.SelectNodes(XPath) Range(<span class="hljs-string"><span class="hljs-string">"E"</span></span> &amp; i) = Range(<span class="hljs-string"><span class="hljs-string">"E"</span></span> &amp; i) &amp; it.Text &amp; <span class="hljs-string"><span class="hljs-string">"; "</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span></code> </pre><br>  Some fields in the document may be missing, then we skip them by the condition: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Not</span></span> xml.DocumentElement.SelectSingleNode(XPath) <span class="hljs-keyword"><span class="hljs-keyword">Is</span></span> <span class="hljs-literal"><span class="hljs-literal">Nothing</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span></code> </pre><br><br><h6>  <b>Conclusion</b> </h6><br>  Downloading files from ftp can be implemented in different ways.  I described one, using <i><b>shell.namespace</b></i> , working and VERY simply implementable. <br><br>  After downloading, automatic ranking (selection) and formatting the list of contests, my daily selection of contests (for all Federal Laws) looks like this: <br><br><img src="https://habrastorage.org/files/b74/726/6eb/b747266eb9d4443eb4ecc45730ff1ee1.jpg" alt="Result"><br><br>  The approach described above allows you to download data about tenders, contracts, procurement plans, etc.  with OOS, because all this information is published on <u>an open ftp</u> .  I don‚Äôt cite the entire program code and cannot, because it is ‚Äúintellectual property‚Äù.  However, anyone who owns the basics of <b>vba</b> and, more importantly, patience, can restore the program using the given key code <b>points</b> . <br><br>  Patience will be needed, firstly, when parsing files and subdirectories on ftp: you should not download too much and not miss the right one.  And secondly, when parsing xml.  However, here is the question of the task: exactly which fields, in what sequence, how the customer wants to be formatted. <br><br>  <i>Good luck and victories to everyone: - in contests - and personal!</i> </div><p>Source: <a href="https://habr.com/ru/post/253201/">https://habr.com/ru/post/253201/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253183/index.html">Rex Black at SQA Days-17: ‚ÄúDo not chase after empty fantasies, but focus on gaining experience‚Äù</a></li>
<li><a href="../253189/index.html">MIDI player on eight floppy. Or how the electronics engineer went crazy</a></li>
<li><a href="../253191/index.html">How to facilitate hosting clients to create private networks and virtual servers: 1cloud project experience</a></li>
<li><a href="../253193/index.html">Expand linux working image with minimal interactivity</a></li>
<li><a href="../253199/index.html">QIWI terminals. Alternative way</a></li>
<li><a href="../253207/index.html">Simple PHP complex HTML table generator</a></li>
<li><a href="../253209/index.html">Bash Booster - SCM tool on a clean bash</a></li>
<li><a href="../253211/index.html">Why I don‚Äôt dislike Git: hidden integrity</a></li>
<li><a href="../253213/index.html">Device and operation of input / output ports of AVR microcontrollers. Part 1</a></li>
<li><a href="../253217/index.html">Meet Envoyer.io (Part 1)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>