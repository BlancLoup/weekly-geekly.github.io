<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Celery in busy projects: some practice</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On the eve of our Moscow Python Conf ++, we briefly talked with Oleg Churkin, a technical Fintech-start-up engineer, about his extensive work experien...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Celery in busy projects: some practice</h1><div class="post__text post__text-html js-mediator-article">  On the eve of our Moscow Python Conf ++, we briefly talked with Oleg Churkin, a technical Fintech-start-up engineer, about his extensive work experience with Celery: half a million background tasks, bugs and testing. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9e7/04b/f65/9e704bf65f55a3ee6007034fc9a38540.jpg"><br><a name="habracut"></a><br>  <b>- Tell us some details about the project you are working on now?</b> <br><br>  At the moment, I am <a href="https://statusmoney.com/">running</a> Fintech-start-up <a href="https://statusmoney.com/">Statusmoney</a> , which analyzes user financial data and allows customers to compare their income and expenses with other groups of people, set spending limits, watch how wealth grows or falls on charts.  While the project is focused only on the North American market. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To analyze financial information, we download and store all user transactions and integrate with credit bureaus to obtain additional data on credit history. <br><br>  Now we have about 200 thousand users and 1.5 terabytes of various financial data from our suppliers.  Some transactions about 100 million <br><br>  <b>- What is the technological stack?</b> <br><br>  The current project stack is Python 3.6, Django / Celery, and Amazon Web Services.  We actively use RDS and Aurora for storing relational data, ElasticCache for cache and for message queues, CloudWatch, Prometheus and Grafana for alerting and monitoring.  And, of course, S3 file storage. <br><br>  We are also very actively using Celery for various business tasks: sending notifications and sending mass emails, mass updating various data from external services, asynchronous API and the like. <br><br>  At the front end we have React, Redux and TypeScript. <br><br>  <b>- What is the main nature of the loads in your project and how are you with them?</b> <b><br></b>  <b>do you manage?</b> <br><br>  The main load in the project falls on the background tasks that Celery performs.  Every day we run about half a million different tasks, for example, updating and processing (ETL) of financial data of users from various banks, credit bureaus and investment institutions.  In addition, we send a lot of notifications and count a lot of parameters for each user. <br><br>  We also have an asynchronous API implemented that ‚Äúpulls‚Äù the results from external sources and also generates many tasks. <br><br>  At the moment, after tuning the infrastructure and Celery, we cope without problems, but earlier everything happened, I will definitely tell about it in my report. <br><br>  <b>- How do you scale this all and provide fault tolerance?</b> <br><br>  For scaling, we use Auto Scaling Groups, a toolkit provided by our AWS cloud platform.  Django and Celery scale well horizontally, we just adjusted the limits a bit to the maximum amount of memory used by uWSGI / Celery workers. <br><br>  <b>- And monitor what?</b> <br><br>  To monitor cpu / memory usage and the availability of the systems themselves, we use Cloud Watch in AWS, aggregate various metrics from the application and from Celery workers using Prometheus, and build graphs and send alerts to Grafana.  For some data in Grafana, we use ELK as the source. <br><br>  <b>- You mentioned asynchronous API.</b>  <b>Tell a little more about how you have it.</b> <b><br></b>  <b>is arranged.</b> <br><br>  Our users have the opportunity to link their bank (or any other financial) account and give us access to all their transactions.  We display the linking and transaction processing process dynamically on the site, using the usual pooling of current results from the backend for this, and the backend retrieves data by running the ETL pipeline from several repetitive tasks. <br><br>  <b>- Celery - a product with a controversial reputation.</b>  <b>How do you live with him?</b> <br><br>  According to my feelings, our relations with Celery are now at the ‚ÄúAcceptance‚Äù stage - we figured out how the framework works inside, selected settings for ourselves, figured out the deployment, monitored and wrote several libraries to automate routine tasks.  Some functionality was not enough for us ‚Äúout of the box‚Äù, and we added it ourselves.  Unfortunately, at the time of choosing the stack of technologies for the project, Celery had not so many competitors, and if we used simpler solutions, we would have to add much more. <br><br>  With bugs in the fourth version of Celery, we have never encountered.  Most of the problems were related either to our lack of understanding of how this all works, or to third-party factors. <br><br>  I will tell you about some of the libraries written in our project in my speech. <br><br>  <b>- My favorite question.</b>  <b>How do you test all this music?</b> <br><br>  Celery tasks are well tested with functional tests.  Integration is tested using autotests and manual testing on QA stands and staging.  At the moment, we have not yet solved a couple of questions with testing periodic tasks: how to let testers run them and how to check that the schedule of these tasks is correct (meets the requirements)? <br><br>  <b>- And tests for frontend and layout?</b>  <b>What is the general ratio of manual and</b> <b><br></b>  <b>automated testing?</b> <br><br>  At the front, we use Jest and write only unit tests for business logic.  55% of business criticisms of cases are now covered by auto tests on Selenium, at the moment we have about 600 tests in TestRail and 3000 tests on backend. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/59f/40f/ad7/59f40fad7b54ad4abeb212461b6653a7.jpg"><br><br>  <b>- What will be your talk at Moscow Python Conf ++?</b> <br><br>  In the <a href="https://conf.python.ru/2018/abstracts/4055">report,</a> I will tell you in detail for what tasks and how Celery can be used, and compare it with existing competitors.  I will describe how to avoid various rakes when designing a complex system with a large number of tasks: which settings should be specified immediately, and which ones can be left for later, how to fix the new version of the code so as not to lose tasks when switching traffic, I will share the written libraries for monitoring tasks and queues. <br><br>  I will also touch on the topic of implementation of the ETL pipelines on Celery and answer how to describe them nicely, what to use retry policy, how to limit the number of tasks performed in limited resource conditions.  Plus I will describe what tools we use to implement batch processing of tasks, which economically consumes the available memory. <br><br>  In general, if you crave the details on all the above points, come.  I hope my report will seem useful and interesting to you. </div><p>Source: <a href="https://habr.com/ru/post/425719/">https://habr.com/ru/post/425719/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../425709/index.html">We made a memo for the Chinese who came to you</a></li>
<li><a href="../425711/index.html">Losses in mismatched line</a></li>
<li><a href="../425713/index.html">Integration of HTML engine in native Windows application - choice and architecture</a></li>
<li><a href="../425715/index.html">Educational program in chemistry: acid reversing of microcircuits (how to expose a crystal of a microcircuit for its subsequent photographing)</a></li>
<li><a href="../425717/index.html">Neural Network for C ++ Developers</a></li>
<li><a href="../425723/index.html">Facebook is actively developing a service for finding work and hiring employees in a social network.</a></li>
<li><a href="../425725/index.html">Nintendo patents case - Game Boy</a></li>
<li><a href="../425727/index.html">To new meetings</a></li>
<li><a href="../425729/index.html">Hackathon Pro Welcome: how was the first charity SmartMail Hack</a></li>
<li><a href="../425731/index.html">The secrets of impossible computing on the GPU</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>