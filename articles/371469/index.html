<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to connect a bunch of old RS232 equipment via USB without registration and sms (STM32 + USB-HID)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Instead of intro 
 As usual, I propose to do strange - try to connect several old RS232 devices through a single USB port using blue electrical tape a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to connect a bunch of old RS232 equipment via USB without registration and sms (STM32 + USB-HID)</h1><div class="post__text post__text-html js-mediator-article"><h2>  <b>Instead of intro</b> </h2><br>  As usual, I propose to do strange - try to connect several old RS232 devices through a single USB port using blue electrical tape and ingenuity.  The article will not be big, rather, it‚Äôs a description of what is where to get it and why to do it all. <br><br><img src="https://habrastorage.org/webt/us/jj/6x/usjj6xsryxpeec2yni3gjs3vg2a.jpeg"><br><a name="habracut"></a><br><h2>  <b>What for?</b> </h2><br>  It is necessary that this happens when a certain special hardware complex consisting of separate devices and which performs some kind of uniform functionality, suddenly begins to be modified.  Of course, you can try to find a set of equipment for newer, but in real life it is very rarely used.  Begin to modify what is.  Sometimes thoughtfully, but more often how it goes. <br><br>  As a rule, the "brains" of such a complex is a computer with 100500 RS232 outputs.  From examples I can give the place of the cashier in a supermarket, ATMs and the like.  I faced the first case. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/9h/gp/f_/9hgpf_axyrh3m-o3neoewoj5jqs.jpeg"><br><br>  These computers do not shine with power, but differ in space cost.  Naturally, it ceases to meet the requirements of modern technologies and many have the idea to replace them with a regular PC and get decent power at an adequate price, but it quickly turns out that RS232 on new PCs has become extinct as a class.  Now this interface has become highly specialized.  Accordingly, it is necessary either to independently screw a bunch of RS232 or to search for a ready-made special solution. <br><br>  Of course, you can replace the equipment itself, but if you look at how much a stationary laser scanner of a decent company costs and multiply this price by the number of them, you will change your mind. <br><br>  People are not dedicated to the topic immediately happily buying a bundle of Chinese USBtoRS232 adapters, and then everything goes very sadly.  Better not to do this.  The second option is to buy a specialized expansion card with a bunch of RS232.  This option is better and has the right to life, but also has its drawbacks.  For example, the cost and problems with firewood if not used by Windows or the wrong version.  Also not unimportant factor is the availability in the future, as something fails and the park may expand in the future.  Then it turns out that a particular model is no longer being produced or is not being decided in a specific locality, etc.  In general, tying yourself to a particular device is always dangerous, especially if you can not do this. <br><br><img src="https://habrastorage.org/webt/nl/rr/m5/nlrrm5diykrowzick4uvobym8og.jpeg"><br><br><h2>  <b>We try to do something</b> </h2><br>  It may seem strange that primitive RS232 devices are so difficult and expensive to connect in a normal way if in fact there are usually simple protocols and a primitive physical layer.  And all because usually such hardware systems are used in commercial income areas and the purchase of equipment at such prices is justified, and the equipment itself has already passed into the category of special.  Special equipment = special issue price. <br><br>  However, all this does not interfere with trying to collect your budget bike.  Bonus we get the opportunity to change the behavior of such a kind of RS232 multiplexer and completely circumvent the problem of writing USB drivers.  HID profile is supported almost everywhere. <br><br>  Once I read an excellent <a href="https://habr.com/post/208026/"><b><u>article by the</u></b></a> author <a href="https://geektimes.com/users/raja/" class="user_link">RaJa</a> Before that, I was interested in USB, but I didn‚Äôt get to practice.  I had several cheap debugging boards, Chinese <a href="http://wiki.stm32duino.com/index.php%3Ftitle%3DBlue_Pill">Blue Pill</a> clones on the Stm32f103c8t6 microcontroller.  The story itself and the idea of ‚Äã‚Äãcreating this board is very interesting, it is worth asking. <br><br><img src="https://habrastorage.org/webt/bs/th/fa/bsthfatvgzt7jjyonb2pelc2sqm.jpeg"><br><br>  This microcontroller is different in that it has three UART and USB hardware support.  This is something that may be of interest to us in the context of our idea, but in general the microcontroller on this board runs at 72Mhz and, according to its characteristics, any Arduino of a similar form factor will break.  But the most important advantage is the widespread prevalence of this board.  I do not know of simpler and cheaper ways to touch the ‚Äúiron‚Äù USB. <br><br>  By adding three cheap RS232toUART MAX2323 converters and a little ‚Äúcrumbling‚Äù you can put together a kind of 3xRS232 &lt;=&gt; USB interface converter. <br><img src="https://habrastorage.org/webt/ui/zm/p-/uizmp-zyqmyubwfwgyuipvsvm2g.jpeg"><br>  In my case, it was necessary to connect three RS232 devices to the Raspberry Pi 3. If you use regular RS232 &lt;=&gt; USB adapters, you end up with a lot of identical devices in the system that don‚Äôt understand what‚Äôs connected and it‚Äôs all pretty buggy, but it looks more sad. <br><br>  If you drop a bit in the direction of which USB to UART chips are available everywhere, then you will find out that there are a lot of fakes.  I think it is not necessary to explain how it all then behaves with the original drivers.  And no one can guarantee you that even branded adapters will not suddenly buy the left batch of microcircuits.  Cheaper production, it happens everywhere. <br><br>  As a result, I came up with something like this simple switching scheme that can even be portrayed in the Arduino style: <br><br><img src="https://habrastorage.org/webt/0u/h4/yu/0uh4yuleiahsxz_acujovjukr1i.png"><br><br>  I broke off a resistor that pulls D + up to power and made this tightening controlled by a transistor.  She is responsible for identifying the device on the USB bus. <br><br>  Pinout RS232 connectors in the program ( <a href="http://fritzing.org/home/">Fritzing</a> ) where I threw a strange scheme, but I think it would be easy for anyone to find it on the Internet, contacts are involved as usual 2,3 and 5. And it will be even more convenient to use UART to RS232 converter boards which already have an RS232 connector . <br><br><img src="https://habrastorage.org/webt/yj/8j/cr/yj8jcrgmfb_zddls0ohf4f04amc.jpeg"><br><br><h3>  <b>Low level</b> </h3><br>  I wrote the code for the microcontroller and debugged it with the help of the <a href="https://www.embitz.org/">EmBitz IDE</a> (to be honest, I was surprised how easy it was to get this IDE, especially after dancing with a tambourine around CooCox.).  Based on the draft of the article above.  This is the first example that I have earned immediately after casting. <br><br>  I added work with three UARTs and changed the structure of HID reports so that the exchange with the PC was always 64 bytes with a checksum (crc8). <br><br>  I tried to auto-reconnect the device if the USB connection did not work correctly.  I do not pretend to a super algorithm, I must admit that I am not a USB specialist.  A separate transistor, shown in the diagram, controlled by a separate pin B5 pulls one of the USB signal lines to the power supply which simulates switching on the device and the host initializes the device.  If the attempt is not successful then a reconnection occurs. <br><br>  It was noted that in Linux (Raspbian) the percentage of unsuccessful connections is significantly less than in Win 10, perhaps this result was due to my local technical conditions. <br><br>  The general algorithm is similar to a primitive router, taking a packet via USB, we look at which UART it is designed for and send it in the opposite direction in the same way.  There is a bit of processing of the packets themselves, but this applies to the specific RS232 equipment that I connected.  These were: Datecs dpd-201 customer screen, Datalogic Magellan 8300 stationary laser barcode scanner and Digi DS890 scale. <br><br>  In the photo above, the test sample of the device contains another DC-DC power converter on the MP2307 chip. <br><img src="https://habrastorage.org/webt/dj/kl/co/djklcoyfzh0qmfomvt6it6ujixy.jpeg"><br>  This is necessary in order to power the device from a voltage of 10-24 V (input) and to be able to connect a customer display that is powered by the same voltage.  After DC-DC we convert the converter to 3.3V for all other modules.  For this display, the ‚Äútelephone‚Äù connector is also installed instead of the RS232, I did not want to re-solder the stock plug. <br><br>  The project is <a href="https://bitbucket.org/svavan/sv_hid_stm32f103"><b><u>here</u></b> .</a> <br><br><h3>  <b>High level</b> </h3><br>  The second part of the software is examples and tests compiled into a messy Java <a href="https://bitbucket.org/svavan/sv_hid_stm32f103_java_idea_test"><b><u>project</u></b></a> written by IDE IDEA.  It is assumed that the work with the device is integrated into the high-level software using various wrappers for working with the USB stack, depending on the language on the court, this software is written.  Now it is difficult to find such a PL so that such wrappers do not exist for it.  <s>Separately for the Old Believers, I note that java and usb are compatible if prepared correctly, this is proved by practice and is used in a commercial project.</s> <br><br>  In the process of testing, it turned out that work in Linux and Windows with USB HID is somewhat different, the work was debugged through two libraries usb4java and hid4java.  Work through the latter is used in Linux (Raspberry Pi 3). <br><br>  The difference is that in Windows, you can directly access the USB device even if it is registered as a HID and write / read its endpoints.  In Linux, you have to work with a hid device.  That is, the standard hid driver is installed and everything, work only with it please.  Work in this way is a little slower than directly, but it is also directly possible if you convince the system not to install drivers.  This is real. <br><br>  <i><i>As promised, I do not stretch the article and do not provide a detailed description of the code, those <s>few people</s> who are interested can see the projects and play live, and I think it would be more useful for the rest to take note that there is such a decision and resort to deeper study if necessary.</i></i> <br><br><h2>  <b>Conclusion</b> </h2><br>  The presented device is just one of the examples of how you can quite easily join the process of creating native USB devices and finally stop using adapters. <br><br>  Do not forget to add <a href="https://geektimes.com/users/raja/" class="user_link">RaJa to the</a> author's <a href="https://habr.com/post/208026/"><b><u>article</u></b></a> , which explains on the fingers how to touch the USB and keep the desire to understand further. </div><p>Source: <a href="https://habr.com/ru/post/371469/">https://habr.com/ru/post/371469/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../371455/index.html">SNR-S2985G-24T-UPS - doomsday switch</a></li>
<li><a href="../371457/index.html">Bad rate, or Spaceport "America" ‚Äã‚Äãas an attempt by New Mexico to invest in space exploration</a></li>
<li><a href="../371459/index.html">The release of "HD-plates": a new technology will be released next year</a></li>
<li><a href="../371461/index.html">Creating a WX-Mouse in razer Mamba TE</a></li>
<li><a href="../371465/index.html">Undoing Aging with Michael Greve</a></li>
<li><a href="../371471/index.html">New profession: "virtual dating assistant"</a></li>
<li><a href="../371473/index.html">Improving fiber lasers means that radiation weapons are about to appear</a></li>
<li><a href="../371475/index.html">Install OpenVPN in a few clicks</a></li>
<li><a href="../371479/index.html">Russification voice Xiaomi Robot Vacuum</a></li>
<li><a href="../371481/index.html">SpaceX and Boeing spacecraft will be ready later than planned.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>