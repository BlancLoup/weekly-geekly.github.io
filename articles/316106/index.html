<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A boring one-line calculator on sed</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Writing boring manuals, as I used to believe, has a negative impact on the nature of the character and therefore my body from time to time resists the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A boring one-line calculator on sed</h1><div class="post__text post__text-html js-mediator-article">  Writing boring manuals, as I used to believe, has a negative impact on the nature of the character and therefore my body from time to time resists the discipline as much as it can.  So recently I was under the impression of the listened stories of Zoshchenko, I decided to convey as much as possible on the pages of Habra a style, and most importantly a spirit that is very close to me and which I think does not diminish the value of the stated fact, but acts as a catalyst and guarantees the connoisseur the presence of intelligence.  I changed the subject accordingly, and that's what I got from this. <br><a name="habracut"></a><br>  Sed, according to some adepts, is an unpredictable language with a muddy, Old Testament syntax, with edits on the fields personally made by Cyril and Methodius.  I always respect the opinions of opponents, but I don‚Äôt have to divide them at all, so I decided for myself that sed is what you need to quickly get calluses and not be a black sheep in discussions when mysterious characters other than regular literals appear in the lines of the sed code expressions. <br><br>  What is the availability of tools?  The first is bash (version 4.3.42).  The second is sed (4.2.2).  Judging by the versions, if a little fantasy, then we can assume that our racers started at about the same era and go, though not nostrils, into the nostril, but with a difference of no more than half of the body.  All this stuff is located in fedora 24 on my computer. <br><br>  After refreshing and running the emulek tutorial in verses, I discovered that sed has a modifier that allows embedding shell commands and replacing the template with the value returned by this command.  My first line in this field looked quite encouraging. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="bash hljs">sed -r <span class="hljs-string"><span class="hljs-string">'s/([0-9]+)([-+])([0-9]+)/expr \1 \2 \3/e'</span></span> &lt;&lt;&lt;<span class="hljs-string"><span class="hljs-string">"2+2"</span></span></code> </pre> <br>  Everything turned out and at the exit a solid four was waiting for me!  The " <b>s</b> " (substitution) command looks for a match by the pattern <b>/ ([0-9] +) ([- +]) ([0-9] +) /</b> and replaces it with the output of the <b>/ expr ([0-9] +)</b> command <b>([- +]) ([0-9] +) / e</b> .  Parameters in this command are defined in a template.  The first block in parentheses corresponds to <b>\ 1</b> second <b>\ 2</b> and third <b>\ 3</b> .  Go ahead and expand the functionality by adding the arithmetic signs " <b>*% /</b> ". <br><br><pre> <code class="bash hljs">sed -r <span class="hljs-string"><span class="hljs-string">'s/([0-9]+)([-+*%/])([0-9]+)/expr \1 \2 \3/e'</span></span> &lt;&lt;&lt;<span class="hljs-string"><span class="hljs-string">"2*2"</span></span></code> </pre> <br>  And we immediately get a syntax error in the " <b>expr</b> " command.  We begin to analyze and understand that in the expression <b>\ 2</b> during the substitution, the asterisk has a special meaning and sed replaces its value with its own, that is, emptiness.  We'll have to escape this symbol before the Bashy team takes it into circulation.  We write another substitution command and modify the template somewhat. <br><br><pre> <code class="bash hljs">sed -r <span class="hljs-string"><span class="hljs-string">'s/\*/\\\*/; s/([0-9]+)([-+*%/\]+)([0-9]+)/expr \1 \2 \3/e'</span></span> &lt;&lt;&lt;<span class="hljs-string"><span class="hljs-string">"2*2"</span></span></code> </pre> <br>  Four again!  A masterpiece and asks for the painting "again, two"!  Here we have introduced another substitution command.  We precede the first template with an asterisk with a backslash icon in order to deprive the super villain of her abilities, and in the substitute line do not forget to screen the backslash icon itself.  As a result, this part grows to such a scary look <b>/ \\\ * /</b> . <br><br>  Also in the second pattern, namely, in the second round brackets, a backslash is added and in order not to make a fuss to the character class <b>[- + *% / \]</b> defined by square brackets, we substitute the quantifier " <b>+</b> ", which gives us a match on the pattern of two characters " <b>\ *</b> ".  It was certainly possible to more accurately determine the pattern, but in the context of this is quite enough. <br><br>  Bash is good because almost any thing available in it can be done in several different ways.  By the way, this is his apparent confusion.  To perform arithmetic operations with integers, a more modern form of writing is provided and I will, as a peer of the Pepsi generation, be offended with the alternative construction " <b>echo $ (())</b> ", and leave " <b>expr</b> " only in lines for example.  The new design allows us to get rid of part of the code and thoroughly simplify the program.  There is no need for shielding asterisks.  Since we will simplify the code, it is possible to introduce additional functionality, maintaining the level of complexity at a level acceptable for a beginner. <br><br>  I sent only one line to the editor and the program stopped working on it.  Conditional and unconditional jumps are available in sed.  Those who are familiar with the assembler, immediately find the perfect similarity of transitions or jumps on the labels.  The principle is the same.  And it already becomes interesting because the work in the editor begins to look like work <br>  with this program. <br><br>  There is an established opinion that html is a markup language, I agree with that.  So, I think, without transitions and some built-in functions, the language of the sed editor could also be brought under this definition.  But there are transitions and functions in the editor, which means we can fully engage in the programming of his work with the text. <br><br>  The next release of our program with the introduction into circulation of transitions, acquires the shape of the present code. <br><br><pre> <code class="bash hljs">sed -r <span class="hljs-string"><span class="hljs-string">':again s/([0-9]+)([-+%/*])([0-9]+)/echo $((\1 \2 \3))/e; t again'</span></span></code> </pre> <br>  Having run such a code in the terminal, we can only type arithmetic expressions with two numbers and press " <b>enter</b> ".  By the marks " <b>again</b> " immediately see the beginning and end of the cycle.  The conditional jump command " <b>t</b> " by the " <b>again</b> " label will return us to the beginning of the next loop defined by this mark after the colon and the editor will wait for the next line to be entered. <br><br>  Keep in mind, exit from the program is a well-known interrupt signal triggered by pressing the <b>Ctrl + C</b> key combination. <br><br>  But let's analyze the work of conditional transition.  The " <b>t</b> " command is used in conjunction with the " <b>s</b> " (substitution) command and, based on the result of the latter, a transition is made or not.  If the first (in the presence of several) command " <b>s</b> " makes a substitution in the buffer, then the conditional transition is performed. <br><br>  There is also a command " <b>T</b> " which is executed if the first (with several) command " <b>s</b> " failed. <br><br>  We analyzed the work program with the transition condition.  Stop you say.  And why do we need a transition by condition when an unconditional transition would be quite enough.  Let's replace the " <b>t</b> " command with the unconditional " <b>b</b> " command.  We are testing. <br><br><pre> <code class="bash hljs">sed -r <span class="hljs-string"><span class="hljs-string">':again s/([0-9]+)([-+%/*])([0-9]+)/echo $((\1 \2 \3))/e; b again'</span></span></code> </pre> <br>  We enter data as it should be, but there is not any result at the output!  Where are we wrong, because logically everything should work just as well?  Let us return and again analyze the work program.  As always, everything turned out to be elementary.  We did not take into account one moment, the conditional jump command " <b>t</b> " is triggered and translates the execution of the program to the label in the event that a change occurs in the command " <b>s</b> ". <br><br>  Apparently the construction with the extension " <b>e</b> " works a little differently.  As I dare to suggest in our case, there is not any substitution. Our line is fully consistent with the pattern and appears unchanged, in the form of bash utility parameters.  And here, apparently, the sacrament of substitution occurs, but alas, our editor believes that the " <b>s</b> " command has nothing to do with this, but the " <b>e</b> " extension team is involved.  And since we know that if the label is missing or the transition condition is not fulfilled, the program will go to the end of the command line, and not by the label to its beginning.  Repair the code. <br><br><pre> <code class="bash hljs">sed -rn <span class="hljs-string"><span class="hljs-string">':again s/([0-9]+)([-+%/*])([0-9]+)/echo $((\1 \2 \3))/e;p;d; b again'</span></span></code> </pre> <br>  The situation requires an explanation.  Enter an additional two commands and one option that correct the situation.  After recording the result of the calculation with the " <b>p</b> " command, we will print the buffer contents forcibly, and before returning to the beginning of the program, we will clear it with the " <b>d</b> " command.  The " <b>-n</b> " option usually works in conjunction with the " <b>p</b> " command and suppresses automatic print buffer output.  I feel that I have matured after such misadventures for several years, and if it goes on like this, I will quickly grow old and remain an old maid.  I could not even imagine what would be so boring! <br><br>  Our program works again, but it is still largely redundant.  For example, the labels that I introduced with a greater degree to demonstrate the capabilities of the sed language and which unexpectedly added detective pepper, are superfluous here.  They would make sense if in the line we had several commands separated by a semicolon and the label would allow to bypass one of the commands or blocks of commands.  We'll have to roll back so hard mastered the bells and whistles.  In fact, the editor is already waiting for the input of the next line and begins work on its input from the very beginning where we had the label.  Without any damage, I can rewrite the line like this: <br><br><pre> <code class="bash hljs">sed -r <span class="hljs-string"><span class="hljs-string">'s/([0-9]+)([-+%/*])([0-9]+)/echo $((\1 \2 \3))/e'</span></span> -</code> </pre> <br>  Or even like this: <br><br><pre> <code class="bash hljs">sed -r <span class="hljs-string"><span class="hljs-string">'s/([0-9]+)([-+%/*])([0-9]+)/echo $((\1 \2 \3))/e'</span></span></code> </pre> <br>  This main cycle that we modeled earlier in the manual mode is already built into the program of the editor and we will use it in the future.  Let's go back to the functional.  If we recall the work of this calculator, then we will find an additional buffer for storing intermediate results.  What about sed?  It turns out that there is also an additional buffer and several commands for working with it.  All that we did before this, it worked with the main buffer into which the string is loaded and actions are performed on it.  We will activate an additional buffer for storing the result of calculations, as well as add a functional, when subsequent operations with an intermediate result of the calculation could be performed simply by typing the sign of the arithmetic operation and the second operand in the line.  And we will also work with negative numbers.  Also, we will not cut the functionality of the bash itself and add a little entropy to the algorithm of the ‚ÄúNot boring‚Äù calculator, embed the construction of the number in the power.  Let me remind you that in the bash the exponentiation looks like NUMBER <b>**</b> DEGREE.  The sign is clear, a double asterisk is taken into account.  At the same time we will immediately carry out all the optimization available to my understanding. <br><br>  Although at first I poked my nose like a blind kitten looking for development for the code, in conclusion, he still acquired the following form. <br><br><pre> <code class="bash hljs">sed -r <span class="hljs-string"><span class="hljs-string">'/^[-+/%*]\*?-?[0-9]+$/{x;G;s/\n//}; s/.*/echo $((&amp;))/e;h'</span></span></code> </pre> <br>  I considered it unnecessary wastefulness to define a full-fledged template, which in fact does not do anything except as it provides with the help of such a design the ability to enter a shell command and reduced the template to a minimum of <b>/.*/</b> , which essentially coincides with any string.  I considered this to be acceptable and even imagined that I was insured for a million bucks from mistakes when entering.  If you are not so sure of yourself as I can insert such a pattern <b>s / ^ -? [0-9] + [- +% / *] \ *? -? [0-9] + $ /</b> .  I advise everyone else, blondes like me, not to bother, because even if there is an input error, the additional buffer is updated with the loss of intermediate results and this cycle is called very simply - ‚Äústart over‚Äù.  At the same time, restarting the program is completely unnecessary, just start entering the correct data. <br><br><img src="https://habrastorage.org/webt/a8/jm/hn/a8jmhnm32y5ntachabow7in3fhi.png"><br><br>  Well, let's look at what we wrote in the last line of the code and start with the algorithm of the program.  After launching the editor, it is in input standby mode.  The first line we enter consists of two operands and an arithmetic sign in the middle.  At the very beginning of the program code there is a template that ‚Äúdoes not notice‚Äù all operations consisting of two operands, which means that this filter will skip our first line and the action will immediately go to the already familiar command of the calling shell utility to get the final result. <br><br>  In this part of the program, I not only simplified the pattern, but also simplified the formula for recording operands.  Now we insert the operands not individually, but in a single line, one data block denoted as <b>&amp;</b> .  Ampersand, a synonym for this character denoting the entire string, is <b>\ 0</b> .  In this block of code ending with a semicolon, we change the values ‚Äã‚Äãof the main buffer to the calculated value by the shell command.  After the semicolon we have the command " <b>h</b> " which copies everything that is in the main buffer to the additional buffer.  After that, the program displays the contents of the main buffer and goes to the beginning of the loop, waiting for the new line to be entered. <br><br>  Now we know that we have the first operand in the buffer and enter only the sign of the arithmetic operation and the second operand.  The first " <b>s</b> " command finds that the main buffer contains a string matching the pattern <b>/ ^ [- + /% *] \ *? -? [0-9] + $ /</b> after which the action is passed to a block of commands enclosed in braces.  The second command in the block, the " <b>G</b> ", adds to the end of the main buffer the new line " <b>\ n</b> " and copies the line from the additional buffer after it.  As a result, we have two lines at once in the main buffer separated by a newline.  The first is only that the entered operation sign and the second operand. <br><br>  Immediately attracts attention is not the correct order of the operands.  To correct this slight misunderstanding before adding a line from the additional buffer to the main one, we will use the knee in the form of the " <b>x</b> " command, which swaps the main buffer with the additional one and then after executing the " <b>G</b> " command everything will be in the correct order.  As a result, after executing the two " <b>x; G</b> " commands <b>,</b> we will have a similar line <i>1 operand</i> <b>\ n</b> SIGN <i>2 operand</i> in the main buffer.  A line break in the middle of an expression is superfluous.  Remove it with the next substitution command <b>s / \ n //</b> .  Well, and then on written, control passes to the "counting machine." <br><br>  Those who previously were not familiar with the stream editor sed can independently look through the <a href="http://emulek.github.io/sed/">tutorial</a> from emulek and see how the buffers are in reality called sed, well, they can still find a bunch of goodies. <br><br>  For dessert, I will inform all DomSEDs that there still exists such a utility Super-sed in nature.  In the repository, debian-testing has the package name ssed.  This is a stream editor capable of understanding Perl regular expressions.  This utility is missing from fedora 24 in the rpmfusion repository.  But this is a completely different non-boring story. </div><p>Source: <a href="https://habr.com/ru/post/316106/">https://habr.com/ru/post/316106/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316094/index.html">What discounts are hosters on this Black Friday</a></li>
<li><a href="../316098/index.html">Inside NetBeans. Prologue</a></li>
<li><a href="../316100/index.html">Connecting the character LCD to the board from WD MyBook Live on AppliedMicro APM82181. Ending</a></li>
<li><a href="../316102/index.html">Banana Pi - backup server</a></li>
<li><a href="../316104/index.html">How IT professionals work. Anton Petrochenko, Panasonic Russia</a></li>
<li><a href="../316108/index.html">Trello Clone on Phoenix and React. Parts 10-12. Long Term Finish</a></li>
<li><a href="../316110/index.html">‚ÄúLead me better‚Äù: What will make the work of a novice programmer more effective</a></li>
<li><a href="../316112/index.html">Operating system from scratch (almost)</a></li>
<li><a href="../316116/index.html">Why does a good design start earlier than the first pictures?</a></li>
<li><a href="../316118/index.html">Publisher Peter. Black Friday 2016</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>