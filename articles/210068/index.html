<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MySQL engine in 5 minutes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Starting with version 5.1, MySQL supports dynamic plugin support. A distribution contains an approximate skeleton of the code called - example . It de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MySQL engine in 5 minutes</h1><div class="post__text post__text-html js-mediator-article">  Starting with version 5.1, MySQL supports dynamic plugin support.  A distribution contains an approximate skeleton of the code called - <b>example</b> .  It describes the interface and structure of the base handler - the <i>handler</i> , a copy of which is created separately for each connection to the database.  It also passes a pointer to the <i>TABLE * table table</i> descriptor and the <i>TABLE_SHARE * share</i> auxiliary vector used to synchronize with other handlers.  The development of a plug-in can be carried out according to a modular principle, realizing only the necessary functions in the first place and closing more complex operations with plugs. <br>  Since the <b>example</b> template describes only the interface and does not perform any operations, in this example we will add to it the implementation of CRUD operations based on a single-linked list. <a name="habracut"></a>  For this you need to write a total of 4 functions: <br><br><ul><li>  int rnd_init (bool scan); </li><li>  int rnd_next (uchar * buf); </li><li>  int write_row (uchar * buf); </li><li>  int delete_row (const uchar * buf); </li></ul><br><div class="spoiler">  <b class="spoiler_title">Environment preparation</b> <div class="spoiler_text">  The <b>example</b> template is located in two files <i>ha_example.h</i> and <i>ha_example.cc</i> in the <i>storage / example</i> directory from the MySQL source code.  In this example, <a href="">MySQL Community 5.5.35</a> will be used.  First, copy the <b>example</b> and rename it to <b>smalldb</b> . <br><br><pre><code class="bash hljs">wget http://downloads.mysql.com/archives/get/file/mysql-5.5.35.tar.gz tar -zxvf mysql-5.5.35.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> mysql-5.5.35 cp -rf storage/example storage/smalldb <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> storage/smalldb sed -e <span class="hljs-string"><span class="hljs-string">'s/EXAMPLE/SMALLDB/g'</span></span> -e <span class="hljs-string"><span class="hljs-string">'s/example/smalldb/g'</span></span> ha_example.h &gt; ha_smalldb.h sed -e <span class="hljs-string"><span class="hljs-string">'s/EXAMPLE/SMALLDB/g'</span></span> -e <span class="hljs-string"><span class="hljs-string">'s/example/smalldb/g'</span></span> ha_example.cc &gt; ha_smalldb.cc sed -i <span class="hljs-string"><span class="hljs-string">'s/EXAMPLE/SMALLDB/g;s/example/smalldb/g'</span></span> CMakeLists.txt</code> </pre> <br></div></div><br>  Let's start with the fact that we add a blank for a single-linked list and a few pointers to the head, the current, the previous and the next list item (in <i>ha_smalldb.h</i> ): <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">node</span></span></span><span class="hljs-class">{</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: uchar* data; <span class="hljs-comment"><span class="hljs-comment">//   node* next; //     node(){ data=NULL; next=NULL; } ~node(){ free(data); } }; node *first, *cur, *prev, *next; int row_count, cur_pos; void append_node(node* n){ if (first==NULL){ first=n; }else{ node* iter=first; while (iter-&gt;next!=NULL){iter=iter-&gt;next;} iter-&gt;next=n; } }</span></span></code> </pre><br>  We now turn to the write operation - <b>write_row (uchar * buf)</b> .  As an argument, it is passed <b>buf</b> , which contains the contents of the added string in the internal representation: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/ac2/711/a16/ac2711a16cbc2975b4f620f4621680bc.png" width="500"><br>  Since we will save the data to memory without preliminary processing, you can simply copy the contents of the entire line.  The length of the row with metadata can be obtained from the table descriptor <i>table-&gt; s-&gt; reclength</i> . <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ha_smalldb::write_row(uchar *buf) { DBUG_ENTER(<span class="hljs-string"><span class="hljs-string">"ha_smalldb::write_row"</span></span>); node* n=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> node(); n-&gt;data = (uchar*) <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(uchar)*table-&gt;s-&gt;reclength); <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(n-&gt;data,buf,table-&gt;s-&gt;reclength); append_node(n); row_count++; DBUG_RETURN(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> </pre><br>  When reading data from a table, sequential scanning with the help of a bundle - <b>rnd_init</b> and <b>rnd_next is used</b> .  It is used if the engine does not support indexes or primary keys.  First, in <b>rnd_init ()</b> you need to prepare pointers. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ha_smalldb::rnd_init(<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> scan) { DBUG_ENTER(<span class="hljs-string"><span class="hljs-string">"ha_smalldb::rnd_init"</span></span>); cur=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; prev=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; next=first; cur_pos=<span class="hljs-number"><span class="hljs-number">0</span></span>; DBUG_RETURN(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> </pre><br>  The boolean argument <b>scan</b> reports the intent of the database for an arbitrary (non-sequential) reading of the table.  We can safely ignore it, because  If you try to call the unimplemented <b>rnd_pos ()</b> command, the database will receive HA_ERR_WRONG_COMMAND in response and will guess that you will have to read it in a row. <br>  After a single <b>rnd_init (), the</b> database will consistently call <b>rnd_next ()</b> until it reaches the end of the table - HA_ERR_END_OF_FILE.  After each call, the memory at <b>buf</b> should be filled with the contents of the line in the internal representation. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ha_smalldb::rnd_next(uchar *buf) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rc; DBUG_ENTER(<span class="hljs-string"><span class="hljs-string">"ha_smalldb::rnd_next"</span></span>); MYSQL_READ_ROW_START(table_share-&gt;db.str, table_share-&gt;table_name.str, TRUE); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next!=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>){ prev=cur; cur=next; next=cur-&gt;next; <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(buf,cur-&gt;data,table-&gt;s-&gt;reclength); cur_pos++; rc=<span class="hljs-number"><span class="hljs-number">0</span></span>; }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ rc= HA_ERR_END_OF_FILE; } MYSQL_READ_ROW_DONE(rc); DBUG_RETURN(rc); }</code> </pre><br>  Finally, we finish writing <b>delete_row ()</b> by deleting the current item from the list: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ha_smalldb::delete_row(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> uchar *buf) { DBUG_ENTER(<span class="hljs-string"><span class="hljs-string">"ha_smalldb::delete_row"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cur!=first){ <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(cur); prev-&gt;next=next; }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(cur); cur=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; first=next; } row_count--; DBUG_RETURN(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> </pre><br>  That's all, now you can try the mini-engine in action. <br><div class="spoiler">  <b class="spoiler_title">Installation</b> <div class="spoiler_text">  MySQL 5.5 uses cmake to build code.  To install, just compile the .so file and copy it to the directory with the plugins of the installed version of MySQL.  You can find it out using the command - SHOW VARIABLES LIKE "% plugin_dir%"; <br>  If MySQL itself is not installed or <b>another version is installed</b> , then you must additionally install the database using make install. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   mysql-5.5.35: cmake . cd storage/smalldb make cp ha_smalldb.so /opt/mysql/server-5.5.35/lib/plugin/ #  MySQL: INSTALL PLUGIN smalldb SONAME "ha_smalldb.so"; CREATE DATABASE small; USE small; CREATE TABLE tbl (a VARCHAR(255), b VARCHAR(255)) ENGINE=smalldb; INSERT INTO tbl values ("Hello","Habr"); SELECT * FROM tbl;</span></span></code> </pre></div></div><br><img src="https://habrastorage.org/getpro/habr/post_images/a4d/2e3/dc7/a4d2e3dc7ed7be05dfddf857ee914f97.png"><br><br>  In addition to INSERT and SELECT, you can perform even more complex SQL queries using <i>LIKE</i> , <i>INNER JOIN</i> and other operators, because SQL query optimization is implemented at the database level before transferring control to the engine, but its efficiency will of course depend on the functionality supported by the engine. <br>  I hope this material will allow a little to get acquainted with the interface of MySQL plugins.  The complete project code can be downloaded on <a href="https://github.com/aboev/smalldb">github</a> . <br>  For those who want to more seriously study the insides of the MySQL engines, but do not risk getting closer to InnoDB, I advise you to pay attention to CSV or HEAP (New name - MEMORY).  CSV adds the ability to save data to disk in the same format.  And HEAP, as the name implies, organizes data into a heap and implements support for hash indexes.  In both cases, we have to solve the auxiliary problem of freeing up free memory areas after deleting rows, which we managed to avoid by using a single-linked list. <br>  More detailed guidance on writing your own engines can be found in chapter 22 of the official <a href="http://dev.mysql.com/doc/internals/en/custom-engine.html">MySQL Internals Manual</a> documentation <a href="http://dev.mysql.com/doc/internals/en/custom-engine.html">.</a>  <a href="http://dev.mysql.com/doc/internals/en/custom-engine.html">Chapter 22. Writing a Custom Storage Engine</a> . <br>  <b>PS</b> And finally, I would like to recommend the <a href="http://ctags.sourceforge.net/">ctags</a> utility for those who are not familiar with it.  Using it is quite convenient to study the code scattered across different files, for example, it allows you to jump to the definition of a function or variable by CTRL +].  There is support for vim, emacs and other popular editors.  Find a <a href="http://courses.cs.washington.edu/courses/cse451/10au/tutorials/tutorial_ctags.html">quick guide here</a> . </div><p>Source: <a href="https://habr.com/ru/post/210068/">https://habr.com/ru/post/210068/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../210050/index.html">Access iFrame content from another domain</a></li>
<li><a href="../210056/index.html">Once again about Intel contests. Memo to future participants</a></li>
<li><a href="../210058/index.html">Web Components - the future of the Web</a></li>
<li><a href="../210060/index.html">Treating tree structures and unified AST</a></li>
<li><a href="../210062/index.html">Smart cards for the smallest</a></li>
<li><a href="../210074/index.html">Three personalization strategies for an online store</a></li>
<li><a href="../210076/index.html">Sony creates a human genome research company</a></li>
<li><a href="../210078/index.html">Recognize it! Native Speech Competition 2014</a></li>
<li><a href="../210080/index.html">Table of Contents for Google Docs and Khabrhabra</a></li>
<li><a href="../210084/index.html">Measurement of the abstract</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>