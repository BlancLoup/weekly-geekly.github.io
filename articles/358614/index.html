<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Security or paranoia: temporary rights when running commands</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the last article, ‚Äú Less administrators to everyone, ‚Äù I talked about how to work without administrator rights ‚Äî in particular, about the Just Enou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Security or paranoia: temporary rights when running commands</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/no/zf/rk/nozfrkfmqe5mxgugkldwjyl-29o.jpeg"></p><br><p>  In the last article, ‚Äú <a href="https://habr.com/company/pc-administrator/blog/335568/">Less administrators to everyone,</a> ‚Äù I talked about how to work without administrator rights ‚Äî in particular, about the Just Enough Administration (JEA) technology.  This mechanism, though flexible, is difficult to configure, and in some situations you can do without it. </p><br><p>  For example, if regularly updated software is used in accounting, then it is not necessary to issue administrator rights, use third-party solutions such as AdminLink, and moreover, update them by hand.  There are other options. <a name="habracut"></a></p><br><h1 id="vremennoe-chlenstvo-v-gruppah">  Temporary group membership </h1><br><p>  In Windows 2016, a mechanism such as PAM - Privileged Access Management or Privileged Access Management System appeared.  You can read more about PAM in the Microsoft <a href="https://docs.microsoft.com/en-us/microsoft-identity-manager/pam/privileged-identity-management-for-active-directory-domain-services">Privileged Access Management for Active Directory Domain Services</a> documentation.  One of its tools is the ability to include a user in a group for a specific time. </p><br><p>  To enable PAM, run the following command: </p><br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Enable</span></span>-ADOptionalFeature "Privileged Access Management Feature" -Scope ForestOrConfigurationSet -Target corp.<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.com</code> </pre> <br><p>  And confirm the inclusion of the option in the domain. </p><br><p><img src="https://habrastorage.org/webt/jk/v3/zj/jkv3zjmpxcakzenb1oai1wuju0u.jpeg"><br>  <em>Turn on PAM.</em> </p><br><p>  Check that the option is enabled with the command: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-ADOptionalFeature -<span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> {<span class="hljs-type"><span class="hljs-type">name</span></span> -<span class="hljs-keyword"><span class="hljs-keyword">like</span></span> "Privileged*"}</code> </pre> <br><p><img src="https://habrastorage.org/webt/a3/ei/ug/a3eiuguypi9lbxfxasniis-_sy0.jpeg"><br>  <em>Check that PAM is enabled.</em> </p><br><p>  Now you can set the time of the user's membership in the group.  For example, let's give the user Vasya.Pupkin the right to manage accounts in the domain by including him in the Account Operators group: </p><br><pre> <code class="hljs vbscript">$<span class="hljs-built_in"><span class="hljs-built_in">Time</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-TimeSpan -Minutes <span class="hljs-number"><span class="hljs-number">15</span></span> Add-ADGroupMember -Identity <span class="hljs-string"><span class="hljs-string">" "</span></span> -Members Vasya.Pupkin -MemberTimeToLive $<span class="hljs-built_in"><span class="hljs-built_in">Time</span></span></code> </pre> <br><p>  You can check the remaining user lifetime in a group with the command: </p><br><pre> <code class="hljs vbscript"><span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-ADGroup <span class="hljs-string"><span class="hljs-string">" "</span></span> -<span class="hljs-keyword"><span class="hljs-keyword">Property</span></span> member ‚ÄìShowMemberTimeToLive</code> </pre> <br><p><img src="https://habrastorage.org/webt/2q/yf/nh/2qyfnhep0e30cloj-nwcownkcju.jpeg"><br>  <em>We check users in the group.</em> </p><br><p>  The lifetime in seconds is displayed in the TTL attribute.  In my case, the value <strong>&lt;TTL = 849&gt;</strong> means that the user Vasya.Pupkin has ‚Äúlive‚Äù in the group of 849 seconds. </p><br><p>  If necessary, the script to add a user to a group can be installed in the scheduler.  And then technical support staff will be able to create new users at a given time: for example, only in the morning.  Unless, of course, the creation of new users is not yet <a href="https://habr.com/company/pc-administrator/blog/354166/">automated</a> . </p><br><p>  Unfortunately, not everyone is still fully enjoying the new features of Windows 2016. But you can do without them. </p><br><h1 id="menya-zovut-georgiy-i-ya-paranoik">  My name is George and I'm paranoid </h1><br><p>  Indeed, why include some new features if you can add an account to the group, and then remove the account from the group.  This method is inconvenient for the temporary granting of authority to employees, but it is quite suitable for your own work if you, while observing all the IS precepts, do not work under a user with administrative rights. </p><br><p>  Suppose we need to restart the 1C: Enterprise server.  If you have rights, it is fairly easy to do with this command: </p><br><pre> <code class="hljs pgsql">Invoke-Command -ComputerName servername -ScriptBlock { <span class="hljs-keyword"><span class="hljs-keyword">Restart</span></span>-Service "1C:Enterprise 8.3 Server Agent" }</code> </pre> <br><p>  But I do not work with administrative rights, so I created a separate user <strong>admin-zhora</strong> , which is a member of the <strong>server-admins</strong> group.  In turn, this group has been added to local server administrators using the <a href="https://habr.com/company/pc-administrator/blog/335568/">Restricted Groups</a> mechanism.  Therefore, my script looks like this: </p><br><pre> <code class="hljs perl">$Credential = Get-Credential Invoke-Command-ComputerName servername -Credential $Credential -ScriptBlock { Restart-Service <span class="hljs-string"><span class="hljs-string">"1C:Enterprise 8.3 Server Agent"</span></span> }</code> </pre> <br><p><img src="https://habrastorage.org/webt/aq/0s/sm/aq0ssmhuab6ynorl57on8rs77zg.jpeg"><br>  <em>Requesting credentials when running a script.</em> </p><br><p>  And I take care of security - if someone steals a user's credentials.  Therefore, I modify the script: I add the inclusion of a user to a group and remove a user from a group: </p><br><pre> <code class="hljs vbscript">Add-ADGroupMember -Identity <span class="hljs-built_in"><span class="hljs-built_in">server</span></span>-admins -Members admin-zhora ... Remove-ADGroupMember -Identity <span class="hljs-built_in"><span class="hljs-built_in">server</span></span>-admins -Members admin-zhora ‚ÄìConfirm:$<span class="hljs-literal"><span class="hljs-literal">False</span></span></code> </pre> <br><p>  Now it is safer.  But it is not exactly. </p><br><p>  Add more security to my script: each time we will change the password of the <strong>admin-zhora user</strong> to random, so as not to worry about its compromise.  To do this, I will take the module New-SWRandomPassword.ps1, published on the <a href="https://gallery.technet.microsoft.com/scriptcenter/Generate-a-random-and-5c879ed5">Script Center</a> portal, and with its help I will write the following function: </p><br><pre> <code class="hljs mel">#<span class="hljs-keyword"><span class="hljs-keyword">requires</span></span> -Modules New-SWRandomPassword function Reset-InvokePassword { param ( [Parameter(Mandatory=$true)] [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]$UserName ) $NewSecurePassword = ConvertTo-SecureString -String (New-SWRandomPassword -MinPasswordLength <span class="hljs-number"><span class="hljs-number">14</span></span> -MaxPasswordLength <span class="hljs-number"><span class="hljs-number">14</span></span>) -AsPlainText -Force try { Set-ADAccountPassword -Identity $UserName -NewPassword $NewSecurePassword -Reset -Confirm:$False -ErrorAction Stop } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { Write-Output <span class="hljs-string"><span class="hljs-string">"Could not change password"</span></span> $ErrorMessage = $_.Exception.Message $ErrorMessage <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } New-Object System.Management.Automation.PsCredential($UserName,$NewSecurePassword) }</code> </pre> <br><p>  At the output of this function, I get new credential credentials that I can pass to other cmdlets.  Add to the original script password change before the execution of the main command and after it.  The final script will be: </p><br><pre> <code class="hljs vbscript">#requires -Modules Reset-InvokePassword Add-ADGroupMember -Identity <span class="hljs-built_in"><span class="hljs-built_in">server</span></span>-admins -Members admin-zhora -Verbose $Credential = Reset-InvokePassword -Username admin-zhora Invoke-Command -ComputerName servername -Credential $Credential -ScriptBlock { Restart-Service <span class="hljs-string"><span class="hljs-string">"1C:Enterprise 8.3 Server Agent"</span></span> -Verbose } Reset-InvokePassword -Username admin-zhora | Out-<span class="hljs-literal"><span class="hljs-literal">Null</span></span> Remove-ADGroupMember -Identity <span class="hljs-built_in"><span class="hljs-built_in">server</span></span>-admins -Members admin-zhora -Confirm:$<span class="hljs-literal"><span class="hljs-literal">False</span></span> -Verbose</code> </pre> <br><p><img src="https://habrastorage.org/webt/ju/oa/qo/juoaqoxtrh5gaqu1nsg2iaz4du4.jpeg"><br>  <em>Now it is safe enough, and also does not request a password.</em> </p><br><p>  The attentive reader will note that my account must be given the rights to manage the group and the user in order to change the password and group membership.  Well, in this example I‚Äôm ready to take risks, but in real practice I prefer JEA for such teams. </p><br><p>  If you compare JEA with <strong>sudo</strong> , which requires pre-configuration and issuance of rights, then the add-delete mechanism in groups looks more like <strong>su</strong> and is more suitable for one-time rather than regular tasks. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/358614/">https://habr.com/ru/post/358614/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358602/index.html">How to unleash the potential of a product manager? 30 typical PM interview questions</a></li>
<li><a href="../358604/index.html">PHP, GDB and arrays</a></li>
<li><a href="../358608/index.html">Each serverless platform has servers.</a></li>
<li><a href="../358610/index.html">The book "Theoretical minimum in Computer Science. All the programmer and developer need is "</a></li>
<li><a href="../358612/index.html">Building an extended anti-virus protection system for a small enterprise. Part 2. Antivirus Gateway USG40W by Zyxel</a></li>
<li><a href="../358616/index.html">The birth of a virtual mobile operator: the Bank Tinkoff project</a></li>
<li><a href="../358618/index.html">DevConf 2018 is already on Friday, May 18</a></li>
<li><a href="../358622/index.html">Web Authentication API standard: passwordless web authentication</a></li>
<li><a href="../358624/index.html">A story about how I, with the help of Google, found passwords on dozens of Trello public boards</a></li>
<li><a href="../358626/index.html">5 differences analyst work in projects and product development</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>