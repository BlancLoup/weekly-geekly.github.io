<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development Environment: Redmine + Git + ownCloud</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article appeared to summarize rather lengthy attempts to build a comfortable environment for working on projects. Undoubtedly, there are many ser...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development Environment: Redmine + Git + ownCloud</h1><div class="post__text post__text-html js-mediator-article">  This article appeared to summarize rather lengthy attempts to build a comfortable environment for working on projects.  Undoubtedly, there are many services ready to provide similar functionality, but their use is not always convenient and, for various reasons, may be unacceptable.  If such a situation arises, I hope the configuration presented in the article will be useful. <br><br><img src="https://habrastorage.org/files/396/e61/47b/396e6147bea949fb9299dc9b834a326a.png"><br><br>  The scenario of using this bundle can be briefly described as follows: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Project files are stored in the Git repository; </li><li>  The repository contains settings, source codes and other project files, the presence of which is convenient and permissible in the collective repository; </li><li>  At the root is the cloud directory, excluded in .gitignore, in which the ownCloud folder is mounted via WebDAV, for other files; </li><li>  The content of the Git repository is tracked in the Redmine project management system. </li></ul><br><br>  The system deployment plan includes the configuration of the following services: <br><br><ol><li>  <b>OpenLDAP</b> - single account for all services; </li><li>  <b>Redmine</b> - launch in Docker container, create and bind Git repository, LDAP authentication; </li><li>  <b>NGINX</b> - access to the Git repository via HTTPS and LDAP authentication; </li><li>  <b>ownCloud</b> - LDAP authentication and folder mounting via davfs2. </li></ol><br><a name="habracut"></a><br>  Hard binding to the distribution and operating system, there is not.  However, I have a Gentoo distribution on my Linux server, Kubuntu on my client, so some examples will have specific features. <br><br>  <i>For ease of reproduction, some of the examples contain predefined passwords.</i>  <i>Therefore, I strongly recommend that instead of the <nobr>[EXTERNAL_IP]</nobr> label, use a local IP that is not accessible from the outside, or immediately change passwords to strong ones.</i> <br><br><h2>  Openldap </h2><br><br>  LDAP is a data access protocol organized in the form of directories.  Its implementation will be discussed here - OpenLDAP.  This service is essentially an optimized database for storing tree structures such as directories.  In this case, it is important that LDAP is well suited for storing user data and is a standard that somehow supports most of the services that work with user accounts. <br><br>  Minimum required configuration: <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /etc/openldap/slapd.conf include /etc/openldap/schema/core.schema include /etc/openldap/schema/cosine.schema include /etc/openldap/schema/inetorgperson.schema include /etc/openldap/schema/nis.schema #     cn=Subschema  . access to dn.base="" by * read access to dn.base="cn=Subschema" by * read #     cn=manager,dc=example,dc=com. # ,    rootdn    . access to dn.regex=".+,dc=example,dc=com$" by self write by dn.exact="cn=manager,dc=example,dc=com" read by anonymous auth #         . access to * by self write by anonymous auth by * none pidfile /var/run/openldap/slapd.pid argsfile /var/run/openldap/slapd.args #        . #   1  2,    - 256 ( 2048). loglevel 0 modulepath /usr/lib64/openldap/openldap #    LDAPS. TLSCertificateFile /etc/ssl/openldap/server.pem TLSCertificateKeyFile /etc/ssl/openldap/server.key ###    database hdb #       700   ldap:ldap. directory /var/lib/openldap-data #  ,   . suffix "dc=example,dc=com" # DN (Distinguished Name)       . #        . rootdn "cn=admin,dc=example,dc=com" #   rootdn,    slappasswd -s [] #     : passwd rootpw {SSHA}70m8+2axDu++Adp6EOLPVpISPxbMVPFv #        memberOf  DN ,    . moduleload memberof.la overlay memberof memberof-group-oc groupOfUniqueNames memberof-member-ad uniqueMember memberof-refint true #     . #   ,     ,  . moduleload refint.la overlay refint refint_attributes uniqueMember #    .  ,  . refint_nothing "cn=admin,dc=example,dc=com" #    . index objectClass eq index uid,uidNumber,gidNumber,memberUid eq</span></span></code> </pre> <br><br>  For clarity, the configuration here is written in the slapd.conf file, but since OpenLDAP version 2.4, this file has been declared obsolete.  The new format is called OLC (on-line configuration) and is presented as a config database.  It is convenient because changing the settings no longer requires rebooting the service. <br><br>  To migrate to OLC, add at the end of the slapd.conf file: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">###     #      (root)  . # Ex: ldapadd/ldapmodify -Q -Y EXTERNAL -H ldapi:/// -f [config_update].ldif database config access to * by dn.exact="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" manage by * none</span></span></code> </pre><br><br>  And execute commands: <br><br><pre> <code class="bash hljs">mkdir -p /etc/openldap/slapd.d <span class="hljs-comment"><span class="hljs-comment">#  slapd   ,        . slaptest -f /etc/openldap/slapd.conf -F /etc/openldap/slapd.d chown ldap:ldap -R /etc/openldap/slapd.d /var/lib/openldap-data /etc/openldap/slapd.conf chmod 750 /etc/openldap/slapd.d &amp;&amp; chmod 640 /etc/openldap/slapd.conf</span></span></code> </pre><br><br>  Settings will be recorded in the specified folder, still in text form, but you should not edit them manually anymore. <br><br>  Next, you need to change the startup parameters of the daemon so that it reads the settings from the database instead of the file.  In Gentoo, for this, you need to change the /etc/conf.d/slapd file: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /etc/conf.d/slapd #    . #OPTS_CONF="-f /etc/openldap/slapd.conf" #     . OPTS_CONF="-F /etc/openldap/slapd.d" #      ldaps;  - ldap    (%2f -  ). OPTS="${OPTS_CONF} -h 'ldaps://[_IP]:636 ldap://127.0.0.1:389 ldapi://%2fvar%2frun%2fopenldap%2fslapd.sock'"</span></span></code> </pre><br><br>  Now you can start the service and add data: <br><br><div class="spoiler">  <b class="spoiler_title">Contents of the backup.ldif file</b> <div class="spoiler_text">  dn: dc = example, dc = com <br>  objectClass: top <br>  objectClass: dcObject <br>  objectClass: organization <br>  dc: example <br>  o: Example.com <br><br>  dn: ou = people, dc = example, dc = com <br>  objectClass: organizationalUnit <br>  ou: People <br><br>  dn: ou = groups, dc = example, dc = com <br>  objectClass: organizationalUnit <br>  ou: Groups <br><br>  dn: uid = example, ou = people, dc = example, dc = com <br>  cn: Example User <br>  givenName: User <br>  sn: Example <br>  uid: example <br>  uidNumber: 1001 <br>  gidNumber: 1000 <br>  homeDirectory: /var/www/example.com <br>  mail: example@example.com <br>  objectClass: top <br>  objectClass: posixAccount <br>  objectClass: shadowAccount <br>  objectClass: inetOrgPerson <br>  objectClass: organizationalPerson <br>  objectClass: person <br>  loginShell: / sbin / nologin <br>  userPassword: {SSHA} 1zGVasPHdQ7LXhBJxzAOseflZiqlecKT <br><br>  dn: cn = manager, dc = example, dc = com <br>  cn: Manager <br>  objectClass: top <br>  objectClass: simpleSecurityObject <br>  objectClass: organizationalRole <br>  userPassword: {SSHA} KihawPs8IchHTS / Lc7aqKGd1rfkpEKyi <br><br>  dn: cn = developers, ou = groups, dc = example, dc = com <br>  objectClass: groupOfUniqueNames <br>  cn: developers <br>  description: Developers <br>  uniqueMember: uid = example, ou = people, dc = example, dc = com <br></div></div><br><br><pre> <code class="bash hljs">ldapadd -x -D <span class="hljs-string"><span class="hljs-string">'cn=admin,dc=example,dc=com'</span></span> -w <span class="hljs-string"><span class="hljs-string">'passwd'</span></span> -f backup.ldif</code> </pre><br><br>  In order to use your passwords, you must replace the value of the userPassword fields.  New can be obtained with the command: <br><br><pre> <code class="bash hljs">slappasswd -s []</code> </pre><br><br>  When restoring from a backup, it is important to make sure that the records for adding <b>groups</b> are located <b>after the</b> records for adding <b>users</b> , and preferably at the very end of the script, otherwise the memberof overlay will not be able to correctly process them. <br><br>  Verify that OpenLDAP is correctly configured and works as intended, by typing: <br><br><pre> <code class="bash hljs">ldapsearch -D <span class="hljs-string"><span class="hljs-string">'cn=manager,dc=example,dc=com'</span></span> -w <span class="hljs-string"><span class="hljs-string">'passwd'</span></span> -b <span class="hljs-string"><span class="hljs-string">'ou=people,dc=example,dc=com'</span></span> <span class="hljs-string"><span class="hljs-string">'(uid=example)'</span></span> memberOf</code> </pre><br><br>  The answer should be as follows: <br><br><pre> <code class="bash hljs">‚Ä¶ dn: uid=example,ou=people,dc=example,dc=com memberOf: cn=developers,ou=groups,dc=example,dc=com <span class="hljs-comment"><span class="hljs-comment"># search result search: 2 result: 0 Success ‚Ä¶</span></span></code> </pre><br><br>  In addition to the test user, <b>cn = manager, dc = example, dc = com</b> was also added here, which will be used later to access the database.  Its rights must be the minimum necessary, and the password must be different from the password <b>cn = admin, dc = example, dc = com</b> , since you will have to specify it in plain text in the settings files.  The password passwd is used here, which is certainly a bad example. <br><br>  Working with entries in OpenLDAP is far from the most convenient and obvious, but <a href="https://directory.apache.org/studio/">Apache Directory Studio</a> can help with this. <br><br><h2>  Redmine </h2><br><br>  The Redmine web application is very well suited for project management.  However, installing it requires a large number of Ruby dependencies.  My activities are not related to Ruby or Rails, so installing the additional 76 packages that ebuild required on the server was not desirable.  An acceptable option was found very quickly - the <a href="https://www.docker.com/">Docker</a> container is the <a href="https://github.com/sameersbn/docker-redmine">sameersbn / docker-redmine</a> . <br><br>  Containers are easy to configure and run using <a href="https://docs.docker.com/compose/install/">docker-compose</a> .  This utility allows you to combine Docker command line parameters into a single configuration file and manage running containers. <br><br>  The options for setting up docker-redmine are very broad and it‚Äôs better to start working with it right away with official documentation.  The following example is only one of the options that turned out to be convenient in my case: <br><br><div class="spoiler">  <b class="spoiler_title">Redmine container settings</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /var/www/redmine.example.com/docker-compose.yml redmine: image: quay.io/sameersbn/redmine:3.2.0-2 #           restart: always environment: - TZ=Europe/Moscow #    uid:gid  ,  #  ,     ,  . - USERMAP_UID=[NGINX_UID] - USERMAP_GID=[NGINX_GID] - DB_TYPE=postgres # Docker-   ,   bridge IP (172.17.0.1),   #         .   , #   ,   .      IP, #          . - DB_HOST=10.0.10.10 - DB_USER=redmine - DB_PASS=[] - DB_NAME=redmine_production - REDMINE_HTTPS=true - REDMINE_PORT=10083 - SMTP_ENABLED=true - SMTP_OPENSSL_VERIFY_MODE=none #  MTA   Docker- 172.17.0.0/16,     . - SMTP_HOST=[_IP] - SMTP_PORT=25 - IMAP_ENABLED=false ports: - "127.0.0.1:10083:80" volumes: - /var/www/redmine.example.com/data:/home/redmine/data #      . - /var/www/redmine.example.com/logs:/var/log/redmine</span></span></code> </pre><br></div></div><br><br>  The container is started by the command: <br><br><pre> <code class="bash hljs">docker-compose -f /var/www/redmine.example.com/docker-compose.yml up -d</code> </pre><br><br>  In order for Redmine to automatically create accounts based on accounts from OpenLDAP and use its authentication mechanism, you must add the appropriate method to <b>Administration ‚Üí LDAP authentication ‚Üí New authentication mode</b> : <br><br><pre> <code class="html hljs xml">Name *: Example.com LDAP Host *: [_IP] Port *: 636; LDAPS: x Account: cn=manager,dc=example,dc=com Password: passwd Base DN *: ou=people,dc=example,dc=com LDAP filter: (&amp;(objectClass=person)(memberOf=cn=developers,ou=groups,dc=example,dc=com)) Timeout (in seconds): On-the-fly user creation: x Login attribute *: uid Firstname attribute: givenName Lastname attribute: sn Email attribute: mail</code> </pre><br><br>  Only existing Git repositories can be added to the Redmine project, so the repository folder should be accessible from the container.  Since in this case you only need to track locally located repositories, you can limit yourself to mounting repository folders in the container, but this is not convenient.  If you need to connect an external repository, then you will have to place its clone in a directory with your own repositories, besides mounting the system directory in a container is not beautiful. <br><br>  As a result, I got the following set of scripts for working with local repositories: <br><br><div class="spoiler">  <b class="spoiler_title">Script to create a new Git repository</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash set -e # /var/git/create_repo.sh LOCAL_GIT_DIR="/var/git" SCRIPT_NAME=`basename $0` E_OPTERROR=65 function usage() { echo "USAGE:" echo " $SCRIPT_NAME [repo_name]" echo "OPTIONS:" echo " repo_name - name of the new Git repository." exit $E_OPTERROR } function fatal_error() { echo "$1" &gt; /dev/stderr exit 1 } #   . if [ $# -ne 1 ]; then echo "Wrong number of arguments specified." usage fi REPO_NAME=$1 cd ${LOCAL_GIT_DIR} if [ -d "${REPO_NAME}" ]; then fatal_error "Error: the repository already exists!" fi #   . mkdir ${REPO_NAME} cd ${REPO_NAME} git --bare init git update-server-info -f #    Redmine    . cd .. cp ./post-update "${REPO_NAME}/hooks/" chmod 755 "${REPO_NAME}/hooks/post-update" chown -R nginx:nginx ${REPO_NAME} echo "Git repository successfully created." exit 0</span></span></code> </pre><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Script to migrate existing Git repository</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash set -e # /var/git/migrate_repo.sh LOCAL_GIT_DIR="/var/git" REDMINE_GIT_DIR="/var/www/redmine.example.com/data/git" SCRIPT_NAME=`basename $0` E_OPTERROR=65 function usage() { echo "USAGE:" echo " $SCRIPT_NAME [repo_name]" echo "OPTIONS:" echo " repo_name - name of the existing Git repository." exit $E_OPTERROR } function fatal_error() { echo "$1" &gt; /dev/stderr exit 1 } #   . if [ $# -ne 1 ]; then echo "Wrong number of arguments specified." usage fi REPO_NAME=$1 if [ ! -d "${LOCAL_GIT_DIR}/${REPO_NAME}" ]; then fatal_error "Error: the repository does not exists!" fi # ,     . if [ -f "${LOCAL_GIT_DIR}/${REPO_NAME}/hooks/post-update" ]; then fatal_error "Error: post-update hook already exists! The repository already migrated or should be migrated manually." fi if [ -d "${REDMINE_GIT_DIR}/${REPO_NAME}" ]; then fatal_error "Error: redmine already contains the repository with the same name!" fi #    Redmine    . cp "${LOCAL_GIT_DIR}/post-update" "${LOCAL_GIT_DIR}/${REPO_NAME}/hooks/" chown nginx:nginx "${LOCAL_GIT_DIR}/${REPO_NAME}/hooks/post-update" chmod 755 "${LOCAL_GIT_DIR}/${REPO_NAME}/hooks/post-update" #  Redmine  . cd "${REDMINE_GIT_DIR}" git clone --mirror "${LOCAL_GIT_DIR}/${REPO_NAME}" ${REPO_NAME} echo "Git repository successfully migrated." exit 0</span></span></code> </pre><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Hook to synchronize Redmine repository copies with local</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # /var/git/post-update #     ,  git push     . REDMINE_GIT_DIR="/var/www/redmine.example.com/data/git" REPO_PATH=${PWD} REPO_NAME=$(basename "${REPO_PATH}") LOG_FILE="/var/log/nginx/git_hooks_log" function log_message() { echo `date '+%d-%m-%y %H:%M:%S'` "$1" &gt;&gt;"${LOG_FILE}" } if [ -d "${REDMINE_GIT_DIR}" ]; then cd "${REDMINE_GIT_DIR}" if [ -d "${REPO_NAME}" ]; then #     ,  . cd "${REPO_NAME}" log_message "UPDATED: ${PWD}" exec git fetch -q --all -p &amp;&gt;&gt;"${LOG_FILE}" else #    . log_message "NEW: ${REPO_PATH} : ${REPO_NAME} : ${PWD}" exec git clone -q --mirror ${REPO_PATH} ${REPO_NAME} &amp;&gt;&gt;"${LOG_FILE}" fi fi</span></span></code> </pre><br></div></div><br><br>  If it is necessary to connect an external repository, for example GitHub, it will also need to be cloned into the <b>/var/www/redmine.example.com/data/git</b> folder, then install the task in cron to periodically synchronize Redmine copies with the remote repository. <br><br><h2>  Nginx </h2><br><br>  Next, you need to open access to the repositories via HTTPS.  Unfortunately, out of the box, NGINX does not support LDAP authorization, for this it needs to be built with a third-party <a href="https://github.com/kvspb/nginx-auth-ldap">kvspb / nginx-auth-ldap</a> module. <br><br>  In Gentoo, all you need to do is copy the ebuild to a local portage (PORTDIR_OVERLAY) and add this module to it.  The official ebuild connects a lot of modules, add another one is not difficult.  For the current version of NGINX, I got the following patch: <br><br><div class="spoiler">  <b class="spoiler_title">Patch adding module http_auth_ldap for nginx-1.8.0.ebuild</b> <div class="spoiler_text"><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- nginx-1.8.0.ebuild 2015-08-05 14:31:19.000000000 +0300 +++ nginx-1.8.0.ebuild.new 2015-08-07 08:19:35.899578187 +0300 @@ -126,6 +126,12 @@ HTTP_MOGILEFS_MODULE_URI="http://www.grid.net.ru/nginx/download/nginx_mogilefs_module-${HTTP_MOGILEFS_MODULE_PV}.tar.gz" HTTP_MOGILEFS_MODULE_WD="${WORKDIR}/nginx_mogilefs_module-${HTTP_MOGILEFS_MODULE_PV}" +# http_auth_ldap (https://github.com/kvspb/nginx-auth-ldap, ??? license) +HTTP_AUTH_LDAP_MODULE_PV="master" +HTTP_AUTH_LDAP_MODULE_P="ngx_http_auth_ldap-${HTTP_AUTH_LDAP_MODULE_PV}" +HTTP_AUTH_LDAP_MODULE_URI="https://github.com/kvspb/nginx-auth-ldap/archive/${HTTP_AUTH_LDAP_MODULE_PV}.tar.gz" +HTTP_AUTH_LDAP_MODULE_WD="${WORKDIR}/nginx-auth-ldap-${HTTP_AUTH_LDAP_MODULE_PV}" + inherit eutils ssl-cert toolchain-funcs perl-module flag-o-matic user systemd versionator multilib DESCRIPTION="Robust, small and high performance http and reverse proxy server" @@ -148,7 +154,8 @@ nginx_modules_http_security? ( ${HTTP_SECURITY_MODULE_URI} -&gt; ${HTTP_SECURITY_MODULE_P}.tar.gz ) nginx_modules_http_push_stream? ( ${HTTP_PUSH_STREAM_MODULE_URI} -&gt; ${HTTP_PUSH_STREAM_MODULE_P}.tar.gz ) nginx_modules_http_sticky? ( ${HTTP_STICKY_MODULE_URI} -&gt; ${HTTP_STICKY_MODULE_P}.tar.bz2 ) - nginx_modules_http_mogilefs? ( ${HTTP_MOGILEFS_MODULE_URI} -&gt; ${HTTP_MOGILEFS_MODULE_P}.tar.gz )" + nginx_modules_http_mogilefs? ( ${HTTP_MOGILEFS_MODULE_URI} -&gt; ${HTTP_MOGILEFS_MODULE_P}.tar.gz ) + nginx_modules_http_auth_ldap? ( ${HTTP_AUTH_LDAP_MODULE_URI} -&gt; ${HTTP_AUTH_LDAP_MODULE_P}.tar.gz )" LICENSE="BSD-2 BSD SSLeay MIT GPL-2 GPL-2+ nginx_modules_http_security? ( Apache-2.0 ) @@ -180,7 +187,8 @@ http_push_stream http_sticky http_ajp - http_mogilefs" + http_mogilefs + http_auth_ldap" IUSE="aio debug +http +http-cache ipv6 libatomic luajit +pcre pcre-jit rtmp selinux ssl userland_GNU vim-syntax" @@ -220,7 +228,8 @@ nginx_modules_http_auth_pam? ( virtual/pam ) nginx_modules_http_metrics? ( dev-libs/yajl ) nginx_modules_http_dav_ext? ( dev-libs/expat ) - nginx_modules_http_security? ( &gt;=dev-libs/libxml2-2.7.8 dev-libs/apr-util www-servers/apache )" + nginx_modules_http_security? ( &gt;=dev-libs/libxml2-2.7.8 dev-libs/apr-util www-servers/apache ) + nginx_modules_http_auth_ldap? ( net-nds/openldap )" RDEPEND="${CDEPEND} selinux? ( sec-policy/selinux-nginx ) " @@ -440,6 +449,11 @@ myconf+=" --add-module=${HTTP_MOGILEFS_MODULE_WD}" fi + if use nginx_modules_http_auth_ldap; then + http_enabled=1 + myconf+=" --add-module=${HTTP_AUTH_LDAP_MODULE_WD}" + fi + if use http || use http-cache; then http_enabled=1 fi</span></span></code> </pre><br></div></div><br><br>  NGINX configuration option for git.example.com host: <br><br><pre> <code class="nginx hljs"><span class="hljs-comment"><span class="hljs-comment"># /etc/nginx/conf.d/git.example.com.ssl.conf #   fcgiwrap,       nginx:nginx. upstream fastcgi-server { server unix:/run/fcgiwrap.sock-1; } ldap_server ldap_git_users { # ldap[s]://hostname:port/base_dn?attributes?scope?filter url "ldap://127.0.0.1:389/ou=people,dc=example,dc=com?uid?sub?(objectClass=person)"; # DN   . binddn "cn=manager,dc=example,dc=com"; binddn_passwd passwd; #        memberOf . group_attribute uniqueMember; #     DN  . group_attribute_is_dn on; # satisfy any; require group "cn=developers,ou=groups,dc=example,dc=com"; } #      LDAP. # $repo -    URL  location; $repo_login -  . map $repo $repo_login { default ""; #        . "example.com" "example"; } #   HTTPS server { listen [_IP]:80; server_name git.example.com; return 301 https://git.example.com$request_uri; } # HTTPS server { listen [_IP]:443 ssl; add_header Strict-Transport-Security max-age=2592000; server_name git.example.com; charset utf-8; ssl_certificate /etc/ssl/nginx/git.example.com.pem; ssl_certificate_key /etc/ssl/nginx/git.example.com.key; ssl_protocols TLSv1 TLSv1.1 TLSv1.2; access_log /var/log/nginx/nginx_git.example.com-ssl_access_log main; error_log /var/log/nginx/nginx_git.example.com-ssl_error_log info; #      . #        ,      . root /var/git/empty; #   Git . location ~ "^/(?&lt;repo&gt;[^/]+)/objects/([0-9a-f]{2}/[0-9a-f]{38}|pack/pack-[0-9a-f]{40}\.(pack|idx))$" { auth_ldap "git::repository"; auth_ldap_servers ldap_git_users; #   $repo_login    map  $repo if ($remote_user = $repo_login) { root /var/git; } } #   ,     git-http-backend. location ~ "^/(?&lt;repo&gt;[^/]+)/(HEAD|info/refs|objects/info/[^/]+|git-(upload|receive)-pack)$" { auth_ldap "git::repository"; auth_ldap_servers ldap_git_users; fastcgi_param SCRIPT_FILENAME /usr/libexec/git-core/git-http-backend; fastcgi_param PATH_INFO $uri; fastcgi_param GIT_HTTP_EXPORT_ALL ""; fastcgi_param GIT_PROJECT_ROOT /var/git; fastcgi_param REMOTE_USER $remote_user; include fastcgi_params; if ($remote_user = $repo_login) { fastcgi_pass fastcgi-server; } } #      404. location / { return 404; } }</span></span></code> </pre><br><br><h2>  ownCloud </h2><br><br>  Cloud storage ownCloud already contains everything you need to work with LDAP.  Simply go to <b>Apps ‚Üí Not enabled to</b> find the ‚ÄúLDAP user and group backend‚Äù and click Enable.  As a result, an <b>LDAP</b> item will appear in the settings.  You need to go to it and, in the Server tab, specify the already familiar settings: <br><br><pre> <code class="html hljs xml">SERVER: 127.0.0.1; Port: 389 DN: cn=manager,dc=example,dc=com PASS: passwd BASEDN: ou=ou=people,dc=example,dc=com</code> </pre><br><br>  To make the group selection on the next tab, you need to go to <b>Advanced ‚Üí Directory Settings</b> and change the following settings: <br><br><pre> <code class="html hljs xml">Group Display Name Field: cn Base Group Tree: ou=groups,dc=example,dc=com Group-Member association: uniqueMember</code> </pre><br><br>  However, even after that, I only had one posixGroup, which was clearly not enough.  Since the settings allow you to specify all the filters manually, it is easier and more reliable to use this feature.  To do this, it is desirable to enable the ‚ÄúManually enter LDAP filters‚Äù setting on the Server tab, then set all filters manually: <br><br><pre> <code class="html hljs xml">Users: (&amp;(objectClass=person)(memberOf=cn=developers,ou=groups,dc=example,dc=com)) Login Attributes: (&amp;(objectClass=person)(memberOf=cn=developers,ou=groups,dc=example,dc=com)(uid=%uid)) Groups:     ,     ownCloud   .</code> </pre><br><br>  Having finished with this, you can go to Users and make sure that all the necessary users are in the list. <br><br>  To mount your ownCloud folder using davfs2, you need to add the following lines to the files on the client side: <br><br>  /etc/davfs2/davfs2.conf <br><br><pre> <code class="html hljs xml">use_locks 0</code> </pre><br>  / etc / davfs2 / secrets <br><br><pre> <code class="html hljs xml">/home/<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span><span class="hljs-tag">&gt;</span></span>/workspace/example/cloud example "passwd"</code> </pre><br>  / etc / fstab <br><br><pre> <code class="html hljs xml">https://cloud.example.com/remote.php/webdav /home/<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span><span class="hljs-tag">&gt;</span></span>/workspace/example/cloud davfs user,noauto 0 0</code> </pre><br><br>  And finally, an example of the alias wo (work on) to activate the working environment using the example of the Django project: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ~/.bashrc alias wo=" \ mkdir -p ~/workspace/example/cloud &amp;&amp; \ (mountpoint -q ~/workspace/example/cloud || mount ~/workspace/example/cloud) &amp;&amp; \ cp -u ~/workspace/example/cloud/deploy/settings_local.py ~/workspace/example/src/project/settings_local.py &amp;&amp; \ source ~/VEnvs/example/bin/activate &amp;&amp; \ cd ~/workspace/example/src \ "</span></span></code> </pre><br><br>  All configuration files and scripts used in the article can be found on <a href="">GitHub</a> <br><br></div><p>Source: <a href="https://habr.com/ru/post/274187/">https://habr.com/ru/post/274187/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../274177/index.html">12 best overseas developer conferences in 2016</a></li>
<li><a href="../274179/index.html">OpenOCD, GDB and (strongly) remote debugging</a></li>
<li><a href="../274181/index.html">Unit Tests in ABAP. Part Three Every kind of fuss</a></li>
<li><a href="../274183/index.html">How I searched (and found) the difference in two byte-identical files.</a></li>
<li><a href="../274185/index.html">Diagnosing and fixing memory leaks in TypeScript applications</a></li>
<li><a href="../274189/index.html">Does your site have problems with Google?</a></li>
<li><a href="../274191/index.html">New Year's check .NET Core Libraries (CoreFX)</a></li>
<li><a href="../274193/index.html">Draw together. Portrait of user IE 8 full face</a></li>
<li><a href="../274195/index.html">Direct disk access from python</a></li>
<li><a href="../274197/index.html">Computational chemistry is a modern way to obtain the necessary chemical compounds from IBM</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>