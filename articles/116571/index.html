<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a Comet application using Ajax Push Engine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 In this article, I want to share the experience of building a real-time Web application. I will not delve into the theory, since the te...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a Comet application using Ajax Push Engine</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  In this article, I want to share the experience of building a real-time Web application.  I will not delve into the theory, since the technology reviews have already been on Habr√©, and there is no problem finding them on the network if you want to.  I propose to do directly practice. <br><br><h4>  Comet </h4><br>  The Comet model allows you to create asynchronous Web applications that respond to data that comes from the server in real time.  In this case, its implementation uses the Long-polling technology on the Ajax Push Engine (APE) framework.  The essence of the technology is that the browser connects to the server and waits until data appears.  As soon as they appear, the client accepts them and connects again.  If no data is received, the connection is broken after a timeout and re-established. <br><br><h4>  Ape </h4><img align="left" src="https://habrastorage.org/storage/habraeffect/d9/87/d987a05e8edd5b8ea24f0a48d0fa05c3.png"><br>  APE is an open source software package designed for Ajax Push.  The system includes a web server and Javascript Framework.  APE allows you to transfer to the browser any data in real time without any additional applications on the client side.  According to the creators of the free to withstand the load of 100,000 connections. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><h4>  Installation and Setup </h4><br>  Installing and configuring the server did not cause any problems.  At once I want to say that in this example installation on a working Web server with CentOS 5 on board is considered.  Depending on the goals and platform, the implementation, of course, will be different.  If the server is used for testing and working on localhost, an example of quick setup is given in the official documentation. <br><br><img src="https://habrastorage.org/storage/habraeffect/75/72/75724fc6a14f2c00f224eeaff3c5d8eb.png"><br><br>  It all starts, of course with the installation.  Here, too, no problems should arise.  On the official website published various types of packages, as well as the source.  We swing and set. <br>  Next, you need to prepare a configuration file and specify the APE server with which interface to work. <br>  In the Server section of the /etc/ape/ape.conf file, you must specify the port and interface to be listened to. <br><br> <code>port = 6969 <br> ip_listen = 69.65.59.1</code> <br> <br>  Do not forget to open the port to the outside world: <br><br> <code># iptables -I INPUT -p tcp --dport 9696 -j ACCEPT</code> <br> <br>  And run the Comet server: <br><br> <code># /usr/bin/aped --cfg /etc/ape/ape.conf</code> <br> <br>  The APE daemon is running, but it's too early to use for its intended purpose.  For the server to work correctly, you need to allocate your own subdomain and tweak the DNS settings a bit. <br>  If you use cPanel or another similar panel, this is also not difficult. <br>  In my case, a subdomain was created: <br><br> <code>ape.matvey.co</code> <br> <br>  Then a CNAME record for redirecting requests of the form * .ape.matvey.co to ape.matvey.co. <br><br> <code>*.ape.matvey.co IN CNAME ape.matvey.co</code> <br> <br>  Now the server is ready to communicate with clients. <br><br><h4>  First application </h4><br>  After that, you need to take from the official site JavaScript Framework and unpack it where you will be more convenient.  In the file apeClientJS.js, you must specify the parameters for connecting to the server.  In my case, it looked like this: <br><br> <code>APE.Config.baseUrl = 'http://matvey.co/apps/ape_test/jsf'; //    <br> APE.Config.domain = 'matvey.co'; //   <br> APE.Config.server = 'ape.matvey.co:6969'; // APE-</code> <br> <br>  As an illustration, I will provide a small application written in Python that will send simple text messages to clients using APE.  Communication between the Python script and the daemon is via the http protocol and Inlinepush.  More information about this is written in the official documentation. <br>  So, first put your password in the Inlinepush config.  You can also use the standard one, but for obvious reasons this is not recommended.  It is usually located in '/etc/ape/inlinepush.conf'. <br>  Then we write a small Python script (or whatever you prefer) that will transfer the necessary data to the ape server via port 6969.  Contact for this is necessary to the localhost. <br><br> <code>import urllib2 <br> import json <br> <br> server = 'http://127.0.0.1:6969/0/?' <br> <br> cmd = [{'cmd': 'inlinepush', <br> 'params': { <br> 'password': 'inlinepass5923', <br> 'raw': 'DATA', <br> 'channel': 'testchannel', <br> 'data': { <br> 'msg': 'Hey ya!' <br> } <br> } <br> }] <br> <br> url = server + urllib2.quote(json.dumps(cmd)) <br> response = urllib2.urlopen(url) <br> print response.read() <br></code> <br><br>  After the launch should get something like this answer: <br><br> <code># python test_ape.cgi <br> [{"time":"1301331051","raw":"ERR","data":{"code":"401","value":"UNKNOWN_CHANNEL"}}]</code> <br> <br>  The word ERR in this case means only that the channel is empty and is not used by anyone. <br>  Now let's try to do something really working. <br>  First, a simple page that will receive messages from the server. <br>  Source page client: <br><br> <code><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">&lt;!DOCTYPE html PUBLIC <font color="#A31515">"-//W3C//DTD XHTML 1.0 Transitional//EN"</font> <font color="#A31515">"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"</font> &gt; <br> &lt;html xmlns= <font color="#A31515">"http://www.w3.org/1999/xhtml"</font> xml:lang= <font color="#A31515">"en"</font> dir= <font color="#A31515">"ltr"</font> lang= <font color="#A31515">"en"</font> &gt; <br> &lt;head&gt; <br> &lt;!--   APE.     JSF. --&gt; <br> &lt;script type= <font color="#A31515">"text/javaScript"</font> src= <font color="#A31515">"/apps/ape_test/jsf/apeClientJS.js"</font> &gt;&lt;/script&gt; <br> &lt;/head&gt; <br> &lt;body&gt; <br> &lt;script type= <font color="#A31515">"text/javaScript"</font> &gt; <br> <font color="#0000ff">var</font> client = <font color="#0000ff">new</font> APE.Client(); <br> <font color="#008000">// --  ,       ,    </font> <br> <font color="#0000ff">function</font> randomString(length) { <br> <font color="#0000ff">var</font> chars = <font color="#A31515">'0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz'</font> .split( <font color="#A31515">''</font> ); <br> <font color="#0000ff">var</font> str = <font color="#A31515">''</font> ; <br> <font color="#0000ff">for</font> ( <font color="#0000ff">var</font> i = 0; i &lt; length; i++) {str += chars[Math.floor(Math.random() * chars.length)];} <br> <font color="#0000ff">return</font> str; <br> } <br> <font color="#008000">// --    </font> <br> <font color="#0000ff">function</font> createDiv(vartext) { <br> <font color="#0000ff">var</font> _body = <font color="#0000ff">document</font> .getElementsByTagName( <font color="#A31515">'body'</font> ) [0]; <br> <font color="#0000ff">var</font> _div = <font color="#0000ff">document</font> .createElement( <font color="#A31515">'div'</font> ); <br> <font color="#0000ff">var</font> _text = <font color="#0000ff">document</font> .createTextNode(vartext) <br> _div.appendChild(_text); <br> _body.appendChild(_div); <br> } <br> client.load(); <br> client.addEvent( <font color="#A31515">'load'</font> , <font color="#0000ff">function</font> () { <br> <font color="#008000">// --  ,   name  15 .   :)</font> <br> client.core.start({ <font color="#A31515">"name"</font> :randomString(15)}); <br> }); <br> client.addEvent( <font color="#A31515">'ready'</font> , <font color="#0000ff">function</font> () { <br> createDiv( <font color="#A31515">"Connected"</font> ); <br> client.core.join( <font color="#A31515">'testchannel'</font> ); <br> client.addEvent( <font color="#A31515">'multiPipeCreate'</font> , <font color="#0000ff">function</font> (pipe, options) { <br> }); <br> <font color="#008000">// --  .    .</font> <br> client.onRaw( <font color="#A31515">'data'</font> , <font color="#0000ff">function</font> (raw, pipe) { <br> createDiv( <font color="#A31515">'Receiving : '</font> + unescape(raw.data.msg)); <br> }); <br> }); <br> &lt;/script&gt; <br> &lt;/body&gt; <br> &lt;/html&gt;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code></code> <blockquote> <code><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">&lt;!DOCTYPE html PUBLIC <font color="#A31515">"-//W3C//DTD XHTML 1.0 Transitional//EN"</font> <font color="#A31515">"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"</font> &gt; <br> &lt;html xmlns= <font color="#A31515">"http://www.w3.org/1999/xhtml"</font> xml:lang= <font color="#A31515">"en"</font> dir= <font color="#A31515">"ltr"</font> lang= <font color="#A31515">"en"</font> &gt; <br> &lt;head&gt; <br> &lt;!--   APE.     JSF. --&gt; <br> &lt;script type= <font color="#A31515">"text/javaScript"</font> src= <font color="#A31515">"/apps/ape_test/jsf/apeClientJS.js"</font> &gt;&lt;/script&gt; <br> &lt;/head&gt; <br> &lt;body&gt; <br> &lt;script type= <font color="#A31515">"text/javaScript"</font> &gt; <br> <font color="#0000ff">var</font> client = <font color="#0000ff">new</font> APE.Client(); <br> <font color="#008000">// --  ,       ,    </font> <br> <font color="#0000ff">function</font> randomString(length) { <br> <font color="#0000ff">var</font> chars = <font color="#A31515">'0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz'</font> .split( <font color="#A31515">''</font> ); <br> <font color="#0000ff">var</font> str = <font color="#A31515">''</font> ; <br> <font color="#0000ff">for</font> ( <font color="#0000ff">var</font> i = 0; i &lt; length; i++) {str += chars[Math.floor(Math.random() * chars.length)];} <br> <font color="#0000ff">return</font> str; <br> } <br> <font color="#008000">// --    </font> <br> <font color="#0000ff">function</font> createDiv(vartext) { <br> <font color="#0000ff">var</font> _body = <font color="#0000ff">document</font> .getElementsByTagName( <font color="#A31515">'body'</font> ) [0]; <br> <font color="#0000ff">var</font> _div = <font color="#0000ff">document</font> .createElement( <font color="#A31515">'div'</font> ); <br> <font color="#0000ff">var</font> _text = <font color="#0000ff">document</font> .createTextNode(vartext) <br> _div.appendChild(_text); <br> _body.appendChild(_div); <br> } <br> client.load(); <br> client.addEvent( <font color="#A31515">'load'</font> , <font color="#0000ff">function</font> () { <br> <font color="#008000">// --  ,   name  15 .   :)</font> <br> client.core.start({ <font color="#A31515">"name"</font> :randomString(15)}); <br> }); <br> client.addEvent( <font color="#A31515">'ready'</font> , <font color="#0000ff">function</font> () { <br> createDiv( <font color="#A31515">"Connected"</font> ); <br> client.core.join( <font color="#A31515">'testchannel'</font> ); <br> client.addEvent( <font color="#A31515">'multiPipeCreate'</font> , <font color="#0000ff">function</font> (pipe, options) { <br> }); <br> <font color="#008000">// --  .    .</font> <br> client.onRaw( <font color="#A31515">'data'</font> , <font color="#0000ff">function</font> (raw, pipe) { <br> createDiv( <font color="#A31515">'Receiving : '</font> + unescape(raw.data.msg)); <br> }); <br> }); <br> &lt;/script&gt; <br> &lt;/body&gt; <br> &lt;/html&gt;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code></code> </blockquote> <br><br>  Now we have an APE server, an application that transmits data to it via inlinepush and a client that receives these messages. <br>  If you open the client page and run the script on the server, we get the following response: <br><br> <code>[{"time":"1301340083","raw":"pushed","data":{"value":"ok"}}]</code> <br> <br>  And the client will bring the cherished: <br><br> <code>Receiving : Hey ya!</code> <br> <br>  The result of running the script with different parameters is shown in the screenshot: <br><br><img src="https://habrastorage.org/storage/habraeffect/04/a5/04a507859808c2939be425e13b0c413c.png"><br><br>  Now add an infinite loop to the script, a timeout for 10 seconds and run it in the background: <br><br> <code># python test_ape.cgi &gt; /dev/null 2&gt;&amp; 1 &amp;</code> <br> <br><img src="https://habrastorage.org/storage/habraeffect/69/11/69110f95d26cde6d015075c98209560b.png"><br><br><h4>  Conclusion </h4><br>  The purpose of the article was to demonstrate to the reader on a living example that the Comet-model, being a fairly powerful tool, does not represent any difficulties in implementation. <br><br>  The result of the work can be found <a href="http://matvey.co/apps/ape_test/">here</a> . <br>  Every 10 seconds a message from the server should appear on the screen. <br><br>  On this, perhaps, for now.  In the next article, I think to write about a more serious and really working application. <br>  I would be glad if the material will be useful to someone. <br><br><h4>  useful links </h4><br>  <a href="http://habrahabr.ru/blogs/webdev/104945/">Comet - review article</a> <br>  <a href="http://www.ape-project.org/">APE official website</a> </div><p>Source: <a href="https://habr.com/ru/post/116571/">https://habr.com/ru/post/116571/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../116562/index.html">DreamSpark is open to teachers</a></li>
<li><a href="../116563/index.html">Mass SQL injection of LizaMoon script</a></li>
<li><a href="../116564/index.html">March 31, Caravan. UPD</a></li>
<li><a href="../116566/index.html">HTTP Archive: web development trends</a></li>
<li><a href="../116569/index.html">kedDroid - S02E08. Video review software for Android</a></li>
<li><a href="../116572/index.html">March 31 is the international day of backup!</a></li>
<li><a href="../116574/index.html">Intelligent Information Networks and the Semantic Web</a></li>
<li><a href="../116575/index.html">Determine your location via WiFi network</a></li>
<li><a href="../116576/index.html">April 1</a></li>
<li><a href="../116577/index.html">Using the singleton pattern</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>