<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Export to mail.app from Qt application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There was a need to export certain files to email (users are very asking). The problem is how to do it in Mac OS X. Well, suppose we do not assume any...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Export to mail.app from Qt application</h1><div class="post__text post__text-html js-mediator-article">  There was a need to export certain files to email (users are very asking).  The problem is how to do it in Mac OS X. Well, suppose we do not assume any other mailers other than Mail.app.  On developer.apple.com I found a description of how this is done without Qt.  The first attempt to realize this has generated a lot of questions, answers to which in developer.apple.com is not found.  In general, I suffered enough, and then I post the ready-made recipe for implementing this feature using AppleScript. <br><a name="habracut"></a><br>  <b>1.</b> Connect the carbon header file: <br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta"># </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Carbon/Carbon.h&gt;</span></span></span></span></code> </pre> <br><br>  <b>2. We</b> declare two static variables (constants) containing two full AppleScript text ‚Äî one to send one attachment and the other to send two attachments: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> sendMailScript_singAtt[] = <span class="hljs-string"><span class="hljs-string">"on send_email_message(subjectLine, messageText, fileAttachment)\n"</span></span> <span class="hljs-string"><span class="hljs-string">" tell application \"Mail\"\n"</span></span> <span class="hljs-string"><span class="hljs-string">" (* CREATE THE MESSAGE *)\n"</span></span> <span class="hljs-string"><span class="hljs-string">" activate\n"</span></span> <span class="hljs-string"><span class="hljs-string">" set newMessage to make new outgoing message at end of outgoing messages with properties {subject:subjectLine, content:messageText &amp; return, visible:true}\n"</span></span> <span class="hljs-string"><span class="hljs-string">" \n"</span></span> <span class="hljs-string"><span class="hljs-string">" (* SPECIFY THE ATTACHMENT *)\n"</span></span> <span class="hljs-string"><span class="hljs-string">" tell newMessage\n"</span></span> <span class="hljs-string"><span class="hljs-string">" make new attachment with properties {file name:fileAttachment} at after last paragraph\n"</span></span> <span class="hljs-string"><span class="hljs-string">" end tell\n"</span></span> <span class="hljs-string"><span class="hljs-string">" (*set frontmost to true*)\n"</span></span> <span class="hljs-string"><span class="hljs-string">" end tell\n"</span></span> <span class="hljs-string"><span class="hljs-string">"end send_email_message"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> sendMailScript_doubAtt[] = <span class="hljs-string"><span class="hljs-string">"on send_email_message(subjectLine, messageText, fileAttachmentA, fileAttachmentB)\n"</span></span> <span class="hljs-string"><span class="hljs-string">" tell application \"Mail\"\n"</span></span> <span class="hljs-string"><span class="hljs-string">" (* CREATE THE MESSAGE *)\n"</span></span> <span class="hljs-string"><span class="hljs-string">" activate\n"</span></span> <span class="hljs-string"><span class="hljs-string">" set newMessage to make new outgoing message at end of outgoing messages with properties {subject:subjectLine, content:messageText &amp; return, visible:true}\n"</span></span> <span class="hljs-string"><span class="hljs-string">" \n"</span></span> <span class="hljs-string"><span class="hljs-string">" (* SPECIFY THE ATTACHMENT *)\n"</span></span> <span class="hljs-string"><span class="hljs-string">" tell newMessage\n"</span></span> <span class="hljs-string"><span class="hljs-string">" make new attachment with properties {file name:fileAttachmentA} at after last paragraph\n"</span></span> <span class="hljs-string"><span class="hljs-string">" make new attachment with properties {file name:fileAttachmentB} at after last paragraph\n"</span></span> <span class="hljs-string"><span class="hljs-string">" end tell\n"</span></span> <span class="hljs-string"><span class="hljs-string">" (*set frontmost to true*)\n"</span></span> <span class="hljs-string"><span class="hljs-string">" end tell\n"</span></span> <span class="hljs-string"><span class="hljs-string">"end send_email_message"</span></span>;</code> </pre> <br><br>  As you can see, scripts are two functions that take as parameters the text for the subject, the text of the message body, and one or two attachments.  The method of sending is almost completely different from the method described in the above article, apparently the article is outdated, and apple did not bother to update the information.  Actually the script itself is quite trivial, the only thing I want to pay attention to is the activate call.  Without this, Mail.app windows open in the background. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>3.</b> Pay attention to the latest parameters of scripts - these are not just file paths, they are so-called aliases.  Therefore, the following function is designed to get these same aliases from the path: <br><pre> <code class="cpp hljs">GetAliasHandleForFile(QString fname, AliasHandle * ahandle) { FSRef fref; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(FSPathMakeRef((<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> UInt8 *)fname.toLocal8Bit().data(), &amp;fref, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) == noErr) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(FSNewAlias(<span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;fref, ahandle) == noErr &amp;&amp; (*ahandle)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre><br>  If the alias is successfully received from the file path passed in an argument of type QString, the function returns true, otherwise false <br><br>  <b>4.</b> To call AppleScript, we need to create an event object from the script text, which we will call by passing arguments to it to export the file to email.  Here are the functions for creating such events for both scripts: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">OSStatus </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateEmailMessageEvent1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AppleEvent *theEvent, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* subjectLine, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* messageText, AliasHandle fileAttachment)</span></span></span><span class="hljs-function"> </span></span>{ OSStatus err; ProcessSerialNumber PSN = {<span class="hljs-number"><span class="hljs-number">0</span></span>, kCurrentProcess}; <span class="hljs-comment"><span class="hljs-comment">/* create the container list */</span></span> err = AEBuildAppleEvent( <span class="hljs-string"><span class="hljs-string">'ascr'</span></span>, kASSubroutineEvent, typeProcessSerialNumber, (Ptr) &amp;PSN, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(PSN), kAutoGenerateReturnID, kAnyTransactionID, theEvent, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"'----':[TEXT(@),TEXT(@),alis(@@)],"</span></span> <span class="hljs-string"><span class="hljs-string">"'snam':TEXT(@)"</span></span>, subjectLine, messageText, fileAttachment, <span class="hljs-string"><span class="hljs-string">"send_email_message"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err; } <span class="hljs-function"><span class="hljs-function">OSStatus </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateEmailMessageEvent2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AppleEvent *theEvent, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* subjectLine, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* messageText, AliasHandle fileAttachmentA, AliasHandle fileAttachmentB)</span></span></span><span class="hljs-function"> </span></span>{ OSStatus err; ProcessSerialNumber PSN = {<span class="hljs-number"><span class="hljs-number">0</span></span>, kCurrentProcess}; <span class="hljs-comment"><span class="hljs-comment">/* create the container list */</span></span> err = AEBuildAppleEvent( <span class="hljs-string"><span class="hljs-string">'ascr'</span></span>, kASSubroutineEvent, typeProcessSerialNumber, (Ptr) &amp;PSN, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(PSN), kAutoGenerateReturnID, kAnyTransactionID, theEvent, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"'----':[TEXT(@),TEXT(@),alis(@@),alis(@@)],"</span></span> <span class="hljs-string"><span class="hljs-string">"'snam':TEXT(@)"</span></span>, subjectLine, messageText, fileAttachmentA, fileAttachmentB, <span class="hljs-string"><span class="hljs-string">"send_email_message"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err; }</code> </pre><br>  For details on the called functions, see the Apple documentation (I didn‚Äôt go into the details much, nadergal from various examples found on the Internet) <br><br>  <b>5.</b> Now the actual call of the event created using the above functions: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">OSStatus </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExecuteAppleScriptEvent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* text, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> textLength, AppleEvent *theEvent, AEDesc *resultData)</span></span></span><span class="hljs-function"> </span></span>{ ComponentInstance theComponent; AEDesc scriptTextDesc; OSStatus err; OSAID contextID, resultID; <span class="hljs-comment"><span class="hljs-comment">/* set up locals to a known state */</span></span> theComponent = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; AECreateDesc(typeNull, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;scriptTextDesc); contextID = kOSANullScript; resultID = kOSANullScript; <span class="hljs-comment"><span class="hljs-comment">/* open the scripting component */</span></span> theComponent = OpenDefaultComponent(kOSAComponentType, typeAppleScript); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(theComponent != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* put the script text into a Apple event descriptor record */</span></span> err = AECreateDesc(typeChar, text, textLength, &amp;scriptTextDesc); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(err == noErr) { <span class="hljs-comment"><span class="hljs-comment">/* compile the script into a new context. The flag 'kOSAModeCompileIntoContext' is used when compiling a script containing a handler into a context. */</span></span> err = OSACompile(theComponent, &amp;scriptTextDesc, kOSAModeCompileIntoContext, &amp;contextID); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(err == noErr) { <span class="hljs-comment"><span class="hljs-comment">/* run the script */</span></span> err = OSAExecuteEvent( theComponent, theEvent, contextID, kOSAModeNull, &amp;resultID); <span class="hljs-comment"><span class="hljs-comment">/* collect the results - if any */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(resultData != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { AECreateDesc(typeNull, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, resultData); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(err == errOSAScriptError) OSAScriptError(theComponent, kOSAErrorMessage, typeChar, resultData); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(err == noErr &amp;&amp; resultID != kOSANullScript) OSADisplay(theComponent, resultID, typeChar, kOSAModeDisplayForHumans, resultData); } } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> err = paramErr; AEDisposeDesc(&amp;scriptTextDesc); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(contextID != kOSANullScript) OSADispose(theComponent, contextID); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(resultID != kOSANullScript) OSADispose(theComponent, resultID); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(theComponent != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) CloseComponent(theComponent); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err; }</code> </pre><br><br>  As you can see, the function can return the results of a call through an object of type AEDesc.  The script text and its length are transferred to the function.  It is in this function that the compilation (OSACompile) and the launch (OSAExecuteEvent) of the script occur, and the previous event creation function only creates a call description and container for the parameters that are used when the script is executed. <br><br>  <b>6.</b> Well, now we collect everything together: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendSingleFileToEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(QString subj, QString body, QString attPath)</span></span></span><span class="hljs-function"> </span></span>{ AliasHandle ahandle; AppleEvent theEvent; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!GetAliasHandleForFile(attPath, &amp;ahandle)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(CreateEmailMessageEvent1(&amp;theEvent, subj.toLocal8Bit().data(), body.toLocal8Bit().data(), ahandle) == noErr) ExecuteAppleScriptEvent(sendMailScript_singAtt, <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(sendMailScript_singAtt), &amp;theEvent, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendDoubleFileToEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(QString subj, QString body, QString attPathA, QString attPathB)</span></span></span><span class="hljs-function"> </span></span>{ AliasHandle ahandleA, ahandleB; AppleEvent theEvent; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!GetAliasHandleForFile(attPathA, &amp;ahandleA) || !GetAliasHandleForFile(attPathB, &amp;ahandleB)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(CreateEmailMessageEvent2(&amp;theEvent, subj.toLocal8Bit().data(), body.toLocal8Bit().data(), ahandleA, ahandleB) == noErr) ExecuteAppleScriptEvent(sendMailScript_doubAtt, <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(sendMailScript_doubAtt), &amp;theEvent, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); }</code> </pre><br><br>  Here we have two functions respectively for sending one attachment and for sending two attachments.  Finally, I want to note that this code does not send files, but creates a new message and opens it for editing, entering the recipient's address or canceling it. <br>  Well, another important point.  You cannot use this code if you are working in privileged mode (ie, from root), as you cannot run any AppleScript itself. <br>  That's all for today. </div><p>Source: <a href="https://habr.com/ru/post/104633/">https://habr.com/ru/post/104633/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../104624/index.html">Windows Aero effect on pure HTML + CSS + JS</a></li>
<li><a href="../104627/index.html">We program LED on the phone</a></li>
<li><a href="../104628/index.html">Client-side templating is already a reality</a></li>
<li><a href="../104630/index.html">VLC player ported to iPad</a></li>
<li><a href="../104632/index.html">Hexlet.ru: "collective computer science student"</a></li>
<li><a href="../104634/index.html">Adobe Photoshop. Look back</a></li>
<li><a href="../104636/index.html">"Pirate Party" of Sweden failed miserably in parliamentary elections</a></li>
<li><a href="../104637/index.html">XenForo: public beta release date set and pricing announced</a></li>
<li><a href="../104638/index.html">So is it helpful or harmful to listen to music in the workplace?</a></li>
<li><a href="../104639/index.html">Announced by HP PhotoSmart eStation and HP Zeen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>