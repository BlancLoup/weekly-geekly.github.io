<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Installation and use of the virtual network lab EVE-NG with Ansible. First experience</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article describes the experience of a network engineer in deploying a virtual lab EVE-NG at home, for the purpose of preparing for Cisco expert e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Installation and use of the virtual network lab EVE-NG with Ansible. First experience</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/e2d/67c/51c/e2d67c51cca74b50b8ea5ca4dcc78ff0.png" alt="image"></p><br><p>  This article describes the experience of a network engineer in deploying a virtual lab <a href="http://www.unetlab.com/">EVE-NG</a> at home, for the purpose of preparing for Cisco expert examinations. </p><br><p>  I tried to collect all the major milestones of the settings scattered around the articles on the Internet and tried to add to the topology, while studying, in addition, the configuration management system.  The draft of the article appeared by chance, because I was sorry to lose my experience and decided to save it in a separate file.  Here I submit it to your judgment. </p><a name="habracut"></a><br><p>  All solutions given in the article do not claim to be optimal, but they definitely work. </p><br><h2 id="ustanovka-eve-ng">  EVE-NG installation </h2><br><h3 id="podgotovka-hosta">  Host preparation </h3><br><p>  As a host, I use the following system: Intel Xeon X3240, 32Gb RAM running Gentoo.  Setting up KVM on Gentoo is a rather trivial matter and, to tell the truth, I don‚Äôt remember which pitfalls I had to face when deploying it.  It was a long time. </p><br><p>  The main thing that catastrophically affects the performance of an EVE-NG laboratory bench is the kernel parameter, which triggers the ability to use <em>nested virtualization</em> (nested virtualization). </p><br><p>  For Intel processors: </p><br><pre><code class="bash hljs">kvm-intel.nested=1</code> </pre> <br><p>  More details can be read on the <a href="https://fedoraproject.org/wiki/How_to_enable_nested_virtualization_in_KVM">link</a> . </p><br><h3 id="podklyuchenie-obrazov-setevyh-ustroystv">  Connecting network device images </h3><br><p>  Images of network devices for connection are freely available on cisco.com itself, for downloading it is enough to have an entry level account.  We will need <a href="https://upload.cisco.com/cgi-bin/swc/fileexg/main.cgi%3FCONTYPES%3DCisco-IOS-XRv%26msg%3DDownload%2Bcomplete">XRv</a> and <a href="https://software.cisco.com/download/release.html%3Fmdfid%3D284364978%26softwareid%3D282046477%26release%3D3.16.5S%26relind%3DAVAILABLE%26rellifecycle%3DED%26reltype%3Dlatest">CSR</a> . <br>  We download on the specified links and follow the recommendations in <a href="http://www.unetlab.com/2014/11/adding-cisco-xrv-images/">how-to</a> . </p><br><p>  The problem I encountered when adding images is how to name the directories where you need to add the <em>hda.qcow2</em> files.  The solution, as always, is reverse engineering.  The list of headers processed by EVE-NG is sewn into the file: </p><br><pre> <code class="bash hljs">/opt/unetlab/html/includes/init.php</code> </pre> <br><p>  I will give it here: </p><br><pre> <code class="python hljs">$node_templates = Array( <span class="hljs-string"><span class="hljs-string">'a10'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'A10 vThunder'</span></span>, <span class="hljs-string"><span class="hljs-string">'clearpass'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Aruba ClearPass'</span></span>, <span class="hljs-string"><span class="hljs-string">'timos'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Alcatel 7750 SR'</span></span>, <span class="hljs-string"><span class="hljs-string">'veos'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Arista vEOS'</span></span>, <span class="hljs-string"><span class="hljs-string">'barracuda'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Barraccuda NGIPS'</span></span>, <span class="hljs-string"><span class="hljs-string">'brocadevadx'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Brocade vADX'</span></span>, <span class="hljs-string"><span class="hljs-string">'cpsg'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'CheckPoint Security Gateway VE'</span></span>, <span class="hljs-string"><span class="hljs-string">'docker'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Docker.io'</span></span>, <span class="hljs-string"><span class="hljs-string">'acs'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco ACS'</span></span>, <span class="hljs-string"><span class="hljs-string">'asa'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco ASA'</span></span>, <span class="hljs-string"><span class="hljs-string">'asav'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco ASAv'</span></span>, <span class="hljs-string"><span class="hljs-string">'cda'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco Context Directory Agent'</span></span>, <span class="hljs-string"><span class="hljs-string">'csr1000v'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco CSR 1000V'</span></span>, <span class="hljs-string"><span class="hljs-string">'csr1000vng'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco CSR 1000V (Denali and Everest)'</span></span>, <span class="hljs-string"><span class="hljs-string">'cips'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco IPS'</span></span>, <span class="hljs-string"><span class="hljs-string">'cucm'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco CUCM'</span></span>, <span class="hljs-string"><span class="hljs-string">'ise'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco ISE'</span></span>, <span class="hljs-string"><span class="hljs-string">'c1710'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco IOS 1710 (Dynamips)'</span></span>, <span class="hljs-string"><span class="hljs-string">'c3725'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco IOS 3725 (Dynamips)'</span></span>, <span class="hljs-string"><span class="hljs-string">'c7200'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco IOS 7206VXR (Dynamips)'</span></span>, <span class="hljs-string"><span class="hljs-string">'iol'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco IOL'</span></span>, <span class="hljs-string"><span class="hljs-string">'titanium'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco NX-OSv (Titanium)'</span></span>, <span class="hljs-string"><span class="hljs-string">'nxosv9k'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco NX-OSv 9K'</span></span>, <span class="hljs-string"><span class="hljs-string">'firepower'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco FirePower'</span></span>, <span class="hljs-string"><span class="hljs-string">'firepower6'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco FirePower 6'</span></span>, <span class="hljs-string"><span class="hljs-string">'ucspe'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco UCS-PE'</span></span>, <span class="hljs-string"><span class="hljs-string">'vios'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco vIOS'</span></span>, <span class="hljs-string"><span class="hljs-string">'viosl2'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco vIOS L2'</span></span>, <span class="hljs-string"><span class="hljs-string">'vnam'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco vNAM'</span></span>, <span class="hljs-string"><span class="hljs-string">'vwlc'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco vWLC'</span></span>, <span class="hljs-string"><span class="hljs-string">'vwaas'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco vWAAS'</span></span>, <span class="hljs-string"><span class="hljs-string">'phoebe'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco Email Security Appliance (ESA)'</span></span>, <span class="hljs-string"><span class="hljs-string">'coeus'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco Web Security Appliance (WSA)'</span></span>, <span class="hljs-string"><span class="hljs-string">'xrv'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco XRv'</span></span>, <span class="hljs-string"><span class="hljs-string">'xrv9k'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cisco XRv 9000'</span></span>, <span class="hljs-string"><span class="hljs-string">'nsvpx'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Citrix Netscaler'</span></span>, <span class="hljs-string"><span class="hljs-string">'sonicwall'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Dell SonicWall'</span></span>, <span class="hljs-string"><span class="hljs-string">'cumulus'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Cumulus VX'</span></span>, <span class="hljs-string"><span class="hljs-string">'extremexos'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'ExtremeXOS'</span></span>, <span class="hljs-string"><span class="hljs-string">'bigip'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'F5 BIG-IP LTM VE'</span></span>, <span class="hljs-string"><span class="hljs-string">'fortinet'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Fortinet FortiGate'</span></span>, //<span class="hljs-string"><span class="hljs-string">'radware'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Radware Alteon'</span></span>, <span class="hljs-string"><span class="hljs-string">'hpvsr'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'HP VSR1000'</span></span>, <span class="hljs-string"><span class="hljs-string">'olive'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Juniper Olive'</span></span>, <span class="hljs-string"><span class="hljs-string">'vmx'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Juniper vMX'</span></span>, <span class="hljs-string"><span class="hljs-string">'vmxvcp'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Juniper vMX VCP'</span></span>, <span class="hljs-string"><span class="hljs-string">'vmxvfp'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Juniper vMX VFP'</span></span>, <span class="hljs-string"><span class="hljs-string">'vsrx'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Juniper vSRX'</span></span>, <span class="hljs-string"><span class="hljs-string">'vsrxng'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Juniper vSRX NextGen'</span></span>, <span class="hljs-string"><span class="hljs-string">'vqfxre'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Juniper vQFX RE'</span></span>, <span class="hljs-string"><span class="hljs-string">'vqfxpfe'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Juniper vQFX PFE'</span></span>, <span class="hljs-string"><span class="hljs-string">'linux'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Linux'</span></span>, <span class="hljs-string"><span class="hljs-string">'mikrotik'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'MikroTik RouterOS'</span></span>, <span class="hljs-string"><span class="hljs-string">'ostinato'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Ostinato'</span></span>, <span class="hljs-string"><span class="hljs-string">'paloalto'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Palo Alto VM-100 Firewall'</span></span>, <span class="hljs-string"><span class="hljs-string">'pfsense'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'pfSense Firewall'</span></span>, <span class="hljs-string"><span class="hljs-string">'riverbed'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Riverbed'</span></span>, <span class="hljs-string"><span class="hljs-string">'sterra'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'S-Terra'</span></span>, <span class="hljs-string"><span class="hljs-string">'vyos'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'VyOS'</span></span>, <span class="hljs-string"><span class="hljs-string">'win'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Windows (Legacy template)'</span></span>, <span class="hljs-string"><span class="hljs-string">'winstation'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Windows Workstation'</span></span>, <span class="hljs-string"><span class="hljs-string">'winserver'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Windows Server'</span></span>, <span class="hljs-string"><span class="hljs-string">'vpcs'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Virtual PC (VPCS)'</span></span> );</code> </pre><br><p>  That is, if we need to add an image with any Linux, as we will do below, it is enough to create a directory <em>/ opt / unetlab / addons / qemu / linux-something-there /</em> and put the <em>hda.qcow2</em> image file into it. </p><br><h3 id="nastroyka-okruzheniya">  Setting up the environment </h3><br><p>  By environment we will understand everything that makes our life more convenient. </p><br><h4 id="dostup-k-konsoli-marshrutizatorov">  Access to the console of routers </h4><br><p>  Despite the fact that in EVE-NG, developers have introduced the ability to access network device consoles via web using HTML5, access from third-party clients is more convenient and familiar.  The main convenience provided by putty in my case is the ability to use the clipboard.  Copy / paste does not work in the web console. </p><br><p>  So, the process is as follows: </p><br><p>  Installing putty on the machine from where access will be made.  I work on a PC with ubuntu, therefore: </p><br><pre> <code class="bash hljs">sudo apt-get install putty</code> </pre> <br><p>  But this is not enough, you also need to tell the browser, in my case it is a chrome, how to respond to <em>telnet: //</em> links.  To do this, you need to create a file <em>~ / .local / share / applications / telnet.desktop with the</em> following content: </p><br><pre> <code class="bash hljs">[Desktop Entry] Version=1.0 Name=Telnet GenericName=Telnet Comment=Telnet Client Exec=/usr/bin/putty %U TryExec=/usr/bin/putty Terminal=<span class="hljs-literal"><span class="hljs-literal">false</span></span> Type=Application Categories=TerminalEmulator;Network;Telnet;Internet;BBS; MimeType=x-scheme/telnet X-KDE-Protocols=telnet Keywords=Terminal;Emulator;Network;Internet;BBS;Telnet;Client;</code> </pre> <br><p>  Register handler: </p><br><pre> <code class="hljs pgsql">xdg-mime <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> telnet.desktop x-scheme-<span class="hljs-keyword"><span class="hljs-keyword">handler</span></span>/telnet</code> </pre> <br><p>  After that, the console will be excellent in putty.  The task of switching to tabbed gnome-terminal or its analog will be left for later. </p><br><h4 id="zapusk-sniffera-trafika">  Starting a traffic sniffer </h4><br><p>  Wireshark - an urgent need when studying network technologies.  A lot has been written about its use.  I will not repeat.  I will describe the process of setting it up. </p><br><p>  Installation on the client: </p><br><pre> <code class="bash hljs">sudo apt-get install wireshark</code> </pre> <br><p>  But again, the browser does not understand how to handle the <em>capture: //</em> link </p><br><p>  He will have to explain it in three stages: </p><br><p>  Stage 1: <br>  As in the case of consoles, the file <em>~ / .local / share / applications / wireshark.desktop</em> : </p><br><pre> <code class="bash hljs">[Desktop Entry] Name=Wireshark Exec=capture_chrom.sh %u MimeType=x-scheme-handler/capture; Type=Application</code> </pre> <br><p>  Handler registration: </p><br><pre> <code class="hljs pgsql">xdg-mime <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> wireshark.desktop x-scheme-<span class="hljs-keyword"><span class="hljs-keyword">handler</span></span>/capture</code> </pre> <br><p>  Stage 2: <br>  Handler in the form of a script on bash on the client machine in any directory from the PATH list: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash ip=`echo $@ | sed 's/.*\/\/\(.*\)\/\(.*\)/\1/g'` interface=`echo $@ | sed 's/.*\/\/\(.*\)\/\(.*\)/\2/g'` ssh root@$ip tcpdump -i $interface -U -w - | wireshark -k -i -</span></span></code> </pre> <br><p>  Stage 3: <br>  Key ssh access between the client machine and EVE-NG. </p><br><p>  On the client machine (instead of ip_eve put the address EVE-NG): </p><br><pre> <code class="bash hljs">ssh-keygen -t rsa ssh root@_ip_eve_ mkdir -p .ssh cat ~/.ssh/id_eve_ng.pub | ssh root@ip_eve <span class="hljs-string"><span class="hljs-string">'cat &gt;&gt; .ssh/authorized_keys2'</span></span></code> </pre> <br><p>  After that, capturing traffic in the wireshark on the client side will work.  What we needed. </p><br><p>  At this unassuming user can stop, but there is no limit to perfection, and we continue ... </p><br><h3 id="nastroyka-instansa-servera-ansible">  Configure the ansible server instance </h3><br><p>  The need for ansible for virtual laboratory topologies at the beginning of the path was not obvious to me.  But over time, in the second ten of laboratory hours, the thought comes - but not whether to automate the loading of start-up topologies into devices without overloading them, thereby saving time? </p><br><p>  So where to start?  With restrictions ansible!  Yes, they really are.  For me, as far enough from programming, the sentence on one of the forums turned out to be too cruel - to add the telnet handler myself.  The telnet was needed for a head-on solution ‚Äî configure the ansible on the EVE-NG virtual machine and telnet to the console ports of the virtual routers.  But it was not there - only ssh works. </p><br><p>  But we are old engineers and not used to retreat!  If the mountain does not go to Mohammed, then we will move to it - we will set up a separate instance with ububtu in the topology itself, since there is a possibility for this. <br>  How to deploy in KVM image downloaded from ubuntu.com I will not bring.  I did it on a separate machine, set it up and poured it into EVE-NG.  After installation, we will need packages with a telnet server and a static IP address setting. </p><br><h4 id="nastroyka-telnet-servera">  Configure a telnet server </h4><br><p>  I didn‚Äôt manage to force EVE-NG to show me the server console in the standard way by clicking on the device.  In order not to dig deep, I went around - set up a telnet server.  SSH v2, of course, is also available and works with CSR, but very slowly for interactive work, and it is useless - we have a laboratory stand, and not production. </p><br><p>  Then the need for the server disappeared, but the record in the cheat sheet remained, so I will bring it. </p><br><p>  So let's get started: </p><br><pre> <code class="bash hljs"> sudo apt-get install xinetd telnetd</code> </pre> <br><p>  After the automatic launch of <em>xinetd</em> , of course, nothing happened, as we were promised on the Internet. </p><br><p>  The following <em>telnet</em> file should be added to <em>/etc/xinetd.d</em> : </p><br><pre> <code class="bash hljs">service telnet { <span class="hljs-built_in"><span class="hljs-built_in">disable</span></span> = no flags = REUSE socket_type = stream <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span> = no user = root server = /usr/sbin/in.telnetd }</code> </pre><br><p>  and restart <em>xinetd</em> server: </p><br><pre> <code class="bash hljs">sudo service xinetd restart</code> </pre> <br><p>  Check telnet locally: </p><br><pre> <code class="bash hljs">@ansible-server:~$ telnet 127.0.0.1 Trying 127.0.0.1... Connected to 127.0.0.1. Escape character is <span class="hljs-string"><span class="hljs-string">'^]'</span></span>. Ubuntu 16.04.2 LTS ansible-server login:</code> </pre> <br><p>  Works! </p><br><p>  We upload the resulting image to the EVE-NG virtual machine and try to compile the topology. </p><br><p>  Now we can, having set up the address from the server‚Äôs subnetwork on the neighboring cysk in the topology, can reach it via telnet.  Everything works fast, not like SSH. </p><br><h3 id="sbor-topologii">  Topology collection </h3><br><p>  Everything is extremely simple here.  My topology is as follows: </p><br><p><img src="https://habrastorage.org/files/700/0cb/daa/7000cbdaa7824329af27b51c60cd29bc.png" alt="image"></p><br><h3 id="razvyortyvanie-podsistemy-ansible">  Deploying the annsible subsystem </h3><br><h4 id="nastroyka-csr-dlya-raboty-s-ansible">  Setting up CSR to work with ansible </h4><br><p>  We select a separate port for control on each router and connect it to a common hub with the server ansible ports <em>Gi2</em> .  We choose a subnet for management, I have it 192.168.0.0/24.  And assign the IP addresses on the ports according to the router number. </p><br><p>  Add the same information to the <em>/ etc / hosts</em> server: </p><br><pre> <code class="bash hljs">192.168.0.1 R1 192.168.0.2 R2 192.168.0.3 R3 192.168.0.4 R4 192.168.0.5 R5 192.168.0.6 R6 192.168.0.7 R7 192.168.0.8 R8 192.168.0.9 R9 192.168.0.10 R10 192.168.0.11 XR1 192.168.0.12 XR2 192.168.0.20 SW1</code> </pre> <br><p>  On each router we configure SSH v2 according to the <a href="http://xgu.ru/wiki/Cisco_SSH">link</a> .  Everything is trivial, I will only say that in order to run the SSHv2 we need to generate a key of more than 768 bits, I chose the size of 2048. </p><br><p>  We check access from the server to routers via SSH, at the same time collecting keys in the storage. </p><br><p>  Save the configuration on the router: </p><br><pre> <code class="bash hljs">R1<span class="hljs-comment"><span class="hljs-comment">#wr Building configuration... [OK]</span></span></code> </pre> <br><p>  And we export the configuration to EVE-NG in order not to reconfigure the device when rebooting: </p><br><p><img src="https://habrastorage.org/files/fbb/6d5/59a/fbb6d559a241438097b8e8684199d74c.png" alt="image"></p><br><p>  This feature in EVE-NG, like Unetlab before it, works with varying success.  But let's hope. </p><br><h4 id="sozdanie-pervogo-vorkbuka">  Creating the first workbook </h4><br><p>  As we <a href="https://habrahabr.ru/post/195048/">remember</a> , the structure of ansible consists of two main parts - the description of devices (inventory), and the workbook, with the actual logic of the system. </p><br><p>  In our case, inventory is quite primitive and its containing file ( <em>/ etc / ansible / hosts</em> ) takes the form: </p><br><pre> <code class="bash hljs">[ios] R[1:10]</code> </pre> <br><p>  What is revealed in the list of hostnames from R1 to R10 (remember that we have already registered / etc / hosts for name resolution). </p><br><p>  But with the Vorbuk will have to tinker. </p><br><p>  The first step, in order to fill the configuration of laboratory interest for us, to the IOS virtual router, we need to roll back to the initial zero, which contains only IP management and VTY settings. </p><br><p>  For this, we will try to use the <a href="https://docs.ansible.com/ansible/ios_command_module.html">ios_command</a> module <a href="https://docs.ansible.com/ansible/ios_command_module.html">.</a> </p><br><p>  The basis of all the work on changing configurations in IOS devices for us will be the functionality of the privileged mode command of the router: </p><br><pre> <code class="bash hljs">configure replace scp://[PATH] force</code> </pre> <br><p>  Zero configurations will be stored on the server in the home directory of the new user under the name <em>router</em> in the <em>/ home / router / default_configs /</em> directory.  Looking ahead, I will say that the files will have the same names as in inventory, i.e.  in our case it is R1, R2, etc. </p><br><p>  Create in <em>/ opt / ansible</em> a <em>rollback.yml</em> file of the form: </p><br><pre> <code class="bash hljs">- name: rollback hosts: ios serial: 1 connection: <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> gather_facts: <span class="hljs-literal"><span class="hljs-literal">false</span></span> remote_user: cisco tasks: - name: Performing rollback to default configuration. ios_command: commands: configure replace scp://router:cisco@192.168.0.101:~/default_configs/{{ inventory_hostname }} force timeout: 30</code> </pre><br><p>  So, in order: </p><br><p>  Playbook name: </p><br><pre> <code class="bash hljs">- name: rollback</code> </pre> <br><p>  Name of inventory used: </p><br><pre> <code class="bash hljs">hosts: ios</code> </pre> <br><p>  Number of parallel configurable devices from inventory.  An important part of the subsequent performance optimization. </p><br><pre> <code class="bash hljs"> serial: 1</code> </pre> <br><p>  As I understand it, this indicates a connection with a local task processor.  I can be wrong. </p><br><pre> <code class="hljs pgsql"> <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span></code> </pre> <br><p>  Disabling host information collection: </p><br><pre> <code class="bash hljs">gather_facts: <span class="hljs-literal"><span class="hljs-literal">false</span></span></code> </pre> <br><p>  Username for connecting to devices: </p><br><pre> <code class="bash hljs">remote_user: cisco</code> </pre> <br><p>  Module call: </p><br><pre> <code class="bash hljs">ios_command:</code> </pre> <br><p>  Sending a command to the device from the inventory: </p><br><pre> <code class="bash hljs"> commands: configure replace scp://router:cisco@192.168.0.101:~/default_configs/{{ inventory_hostname }} force</code> </pre> <br><p>  Response time in seconds: </p><br><pre> <code class="bash hljs">timeout: 30</code> </pre> <br><p>  Nothing too complicated, as we see, but there is one thing but! </p><br><p>  Try to run ... </p><br><pre> <code class="bash hljs">ansible-playbook ./rollover.yml -k -vvvv</code> </pre> <br><p>  We get an error! </p><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"msg"</span></span>: <span class="hljs-string"><span class="hljs-string">"ios_command does not support running config mode commands. Please use ios_config instead"</span></span></code> </pre> <br><p>  Google will not tell us much about this, so we arm ourselves with savvy and try to find out who told us so.  And we find the file of the module we are using: <em>/usr/local/lib/python2.7/dist-packages/ansible-2.3.0-py2.7.egg/ansible/modules/network/ios/ios_command.py</em> , containing this code: </p><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> module.check_mode <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> item[<span class="hljs-string"><span class="hljs-string">'command'</span></span>].startswith(<span class="hljs-string"><span class="hljs-string">'show'</span></span>): warnings.append( <span class="hljs-string"><span class="hljs-string">'only show commands are supported when using check mode, not '</span></span> <span class="hljs-string"><span class="hljs-string">'executing `%s`'</span></span> % item[<span class="hljs-string"><span class="hljs-string">'command'</span></span>] ) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> item[<span class="hljs-string"><span class="hljs-string">'command'</span></span>].startswith(<span class="hljs-string"><span class="hljs-string">'conf'</span></span>): module.fail_json( msg=<span class="hljs-string"><span class="hljs-string">'ios_command does not support running config mode '</span></span> <span class="hljs-string"><span class="hljs-string">'commands. Please use ios_config instead'</span></span> )</code> </pre><br><p>  It is obvious that the developers have bent a little bit by putting all the configure parameters to the configuration mode, so we add to the appropriate line: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> item[<span class="hljs-string"><span class="hljs-string">'command'</span></span>].startswith(<span class="hljs-string"><span class="hljs-string">'configure terminal'</span></span>):</code> </pre> <br><p>  Earned! </p><br><pre> <code class="bash hljs">root@ansible-server:/opt/ansible<span class="hljs-comment"><span class="hljs-comment"># ansible-playbook ./rollback.yml -k SSH password: PLAY RECAP ****************************************************** R1 : ok=1 changed=0 unreachable=0 failed=0 R10 : ok=1 changed=0 unreachable=0 failed=0 R2 : ok=1 changed=0 unreachable=0 failed=0 R3 : ok=1 changed=0 unreachable=0 failed=0 R4 : ok=1 changed=0 unreachable=0 failed=0 R5 : ok=1 changed=0 unreachable=0 failed=0 R6 : ok=1 changed=0 unreachable=0 failed=0 R7 : ok=1 changed=0 unreachable=0 failed=0 R8 : ok=1 changed=0 unreachable=0 failed=0 R9 : ok=1 changed=0 unreachable=0 failed=</span></span></code> </pre> <br><h4 id="sozdanie-vtorogo-vorkbuka">  Creating a second workbook </h4><br><p>  I will not describe in the same way as in the previous stage, I‚Äôll just give an example of a workbook that fills the thematic initial configuration of laboratory works of one well-known brand with three letters in the title: </p><br><p>  <em>/ etc / ansible / hosts</em> </p><br><pre> <code class="bash hljs">[ios] R[1:10] [ios.base.ipv4] R[1:6]</code> </pre> <br><p>  <em>/opt/ansible/base.ipv4.yml</em> </p><br><pre> <code class="bash hljs">- name: base.ipv4 hosts: ios.base.ipv4 connection: <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> gather_facts: <span class="hljs-literal"><span class="hljs-literal">false</span></span> remote_user: cisco serial: 1 tasks: - name: base.ipv4 configuration load ios_config: src: ./IOS-XE-initials/base.ipv4/{{ inventory_hostname }}</code> </pre> <br><p>  The initial configuration files are in <em>/opt/ansible/IOS-XE-initials/base.ipv4</em> , respectively.  The main difference of this scenario is the use of the functional of the <a href="https://docs.ansible.com/ansible/ios_config_module.html">ios_config</a> module and the transfer of the right to it to interpret the commands that need to be executed on the devices. </p><br><p>  That's all, thank you for your attention.  If the article is worthy of continuation, the next topic will be setting up the interaction of IOS XR and ansible. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/323014/">https://habr.com/ru/post/323014/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../323004/index.html">Preview RamblerElixir # 2</a></li>
<li><a href="../323006/index.html">A simple way to create an IoT application for monitoring remote servers on the IBM Bluemix platform</a></li>
<li><a href="../323008/index.html">How to use maven to work with libraries that are not in maven</a></li>
<li><a href="../323010/index.html">REST API Design for High Performance Systems</a></li>
<li><a href="../323012/index.html">Meet Kotlin 1.1: javascript, cortina and more</a></li>
<li><a href="../323016/index.html">Multi-generation Intel processor performance comparison</a></li>
<li><a href="../323018/index.html">Objectives for sharing knowledge in an IT company</a></li>
<li><a href="../323020/index.html">Trends and prospects for the mobile application market: let's talk about money</a></li>
<li><a href="../323026/index.html">MTH: hurry to share our achievements</a></li>
<li><a href="../323030/index.html">Pattern Recognition and Scientific Knowledge</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>