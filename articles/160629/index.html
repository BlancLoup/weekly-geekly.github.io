<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Restore a broken Skype history (main.db)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Having once again bothered to restore the broken base, I decided to sketch a brief instruction on how I managed to get back almost the entire history ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Restore a broken Skype history (main.db)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/656/8af/5b0/6568af5b038a6e57d0decae229fe7262.jpeg" align="right" alt="Skype database crash">  Having once again bothered to restore the broken base, I decided to sketch a brief instruction on how I managed to get back almost the entire history of Skype messages.  Connoisseurs of sqlite3 are invited to write better ways than I felt at random. <br><br><h4>  Prehistory </h4><br>  Reinstalled Win7 OS, installed skype (6th), habitually copied the entire profile folder from the old one: <br>  % AppData% \ Roaming \ Skype \ my_profile \ <br>  to a new place. <br><br>  I launch Skype and suddenly it hangs on the auto-login.  After restarting, I see an invitation to enter.  I enter - all contacts are in place, and there are practically no messages anywhere.  Only in some group chats are preserved.  All personal correspondence, which has accumulated a lot - disappeared.  I made N (^ k) attempts to copy the database, deleting lock files, is-corrupt and others.  Skype swears that there is a problem with the base, then asks for a restart - after which there are no messages. <br>  Googling, found habra posts <a href="http://habrahabr.ru/post/160315/">about exporting messages</a> , <a href="http://habrahabr.ru/post/158545/">hijacking accounts</a> , etc.  Yeah, mean sqlite!  It is encouraging. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Tools and materials</b> <div class="spoiler_text">  You will need: <br><ul><li>  the surviving copy of the main.db database before it was ‚Äúopened‚Äù by new Skype, completely erasing the data (or take the main.corrupt file if there was no copy) </li><li>  <a href="https://addons.mozilla.org/ru/firefox/addon/sqlite-manager/">SQLite Manager</a> </li><li>  <a href="http://www.sqlite.org/download.html">sqlite3 command line</a> (optimally - work in it under * nix) </li><li>  <a href="http://notepad-plus-plus.org/">Notepad ++</a> or any other editor that does not crash UTF-8 files. </li><li>  * nix shell (some server with linux / ubuntu / ..., since the most important last step under Windows may not work) </li></ul></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Analyzing the base </h4><br><div class="spoiler">  <b class="spoiler_title">Information for admins, programmers and advanced users</b> <div class="spoiler_text">  1. Swing <a href="https://addons.mozilla.org/ru/firefox/addon/sqlite-manager/">SQLite Manager</a> (thanks for the link, <a href="https://habrahabr.ru/users/minamoto/" class="user_link">minamoto</a> ). <br><br>  2. Open the file main.db (about 150 megabytes for me). <br><br>  3. Database - Integrity check - Full check. <br><br><blockquote>  Check the integrity of the database using the "PRAGMA integrity_check". <br>  Result: NOT SUCCESSFUL.  To see errors, execute the PRAGMA integrity_check operator in the Run Request tab. </blockquote><br><br>  4. I execute the specified command, I get a lot of scary beeches: <br><br><blockquote>  "*** in database main *** <br>  On tree page 5482 cell 13: Rowid 262638 out of order (max larger than parent max of 255232) <br>  On tree page 22553 cell 8: Rowid 255233 out of order (min less than parent min of 262638) <br>  On tree page 5601 cell 10: Rowid 270500 out of order (max larger than parent max of 255358) <br>  On tree page 9610 cell 10: Rowid 255359 out of order (min less than parent min of 270500) <br>  On tree page 25320 cell 145: 2nd reference to page 5482 <br>  On tree page 25320 cell 145: Child page depth differs <br>  On tree page 25320 cell 146: Child page depth differs <br>  On tree page 25827 cell 290: 2nd reference to page 5601 <br>  On tree page 25827 cell 290: Child page depth differs <br>  On tree page 25827 cell 291: Child page depth differs <br>  On tree page 8955 cell 0: 2nd reference to page 28154 <br>  On tree page 27843 cell 0: 2nd reference to page 28136 <br>  Page 5335 is never used <br>  Page 5344 is never used <br>  Page 5369 is never used <br>  ... there are many such never used <br>  Page 28212 is never used " <br>  ‚ÄúWrong # of entries in index IX_Messages_remote_id‚Äù <br>  ‚ÄúWrong # of entries in index IX_Messages_timestamp_convo_id_type‚Äù <br>  ‚ÄúWrong # of entries in index IX_Messages_timestamp_chat‚Äù <br>  ‚ÄúWrong # of entries in index IX_Messages_call_guid‚Äù <br>  ‚ÄúWrong # of entries in index IX_Messages_convo_id_timestamp_consumption_status_sending_status‚Äù <br>  "Rowid 95101 missing from index IX_Contacts_buddystatus" <br>  "Rowid 103110 missing from index IX_Contacts_buddystatus" <br>  "Rowid 209626 missing from index IX_Contacts_buddystatus" <br></blockquote><br><br>  By the way, in other utilities, when trying to view message tables, I often received this: " <b>the database disk image is malformed</b> ". <br></div></div><br><br>  Since I am not an expert in sqlite and do not want to study every error, we proceed simply. <br><br><h4>  Treatment </h4><br>  Google how to dump the sqlite database, it turns out like this: <br><br>  1. Download <a href="http://www.sqlite.org/download.html">sqlite3 command line</a> for Windows or ‚Äúapt-get install sqlite3‚Äù for * nix.  I first experimented under Windows, but later I had to go to the Linux console, because  Windows sqlite3 not quite well proved. <br><br>  2. Under Windows, copy sqlite3.exe to a folder with a copy of the database (archived from the previous Windows, which Skype has not yet spoiled).  Then run cmd (Start&gt; Run). <br>  Under Linux, we simply execute: <br><br> <code>cd ------sqlite3.exe</code> <br> <code>sqlite3 main.db .dump&gt;&gt;myDumpSQLite.sql</code> <br> <br>  <i>(It is ‚Äúmain.db [space] .dump, do not mix it up)</i> <br><br>  3. Open the file myDumpSQLite.sql in a normal text editor, for example <a href="http://notepad-plus-plus.org/">Notepad ++</a> .  At the very end of the file I had a command: <br><br> <code>ROLLBACK;</code> <br> <br>  Who is familiar with SQL, knows why you need to delete this last line in the file and instead write it: <br> <code>COMMIT;</code> <br> <br>  <i>(You can completely abandon the transaction, but then there will be a very long import of data into the new database.)</i> <br><br>  4. Create a new, clean database from the file myDumpSQLite.sql (recommended for Linux). <br><br> <code>sqlite3 main-recovered.db &lt;myDumpSQLite.sql</code> <br> <div class="spoiler">  <b class="spoiler_title">Error messages may occur.</b> <div class="spoiler_text">  I had it like this: <br><br> <code>Error: near line 329619: PRIMARY KEY must be unique <br> Error: near line 329620: PRIMARY KEY must be unique <br> Error: near line 329621: PRIMARY KEY must be unique <br> Error: near line 329622: PRIMARY KEY must be unique <br> ...      <br></code> <br><br>  Due to the fact that we did COMMIT at the end of the file, errors will be ignored.  Theoretically, something will be lost (some single messages, maybe even some chat will disappear).  But this is nothing compared to the loss of the entire base that Microsoft offers. <br></div></div><br><br>  The resulting file main-recovered.db should weigh about the same as the sql file (I got 123MB).  If you skip step 3 or something goes wrong, you will get an empty useless file. <br><div class="spoiler">  <b class="spoiler_title">Windows like.</b>  <b class="spoiler_title">¬© CEP</b> <div class="spoiler_text">  I did it only under Linux, so if it doesn't work under Windows, and you don‚Äôt know linux, look for the right friends).  Windows sqlite3 issued: <br><blockquote>  Error: incomplete SQL: INSERT INTO "Contacts" VALUES (951 ....... </blockquote><br></div></div><br><br>  5. Copy the file to the folder% AppData% \ Roaming \ Skype \ my_profile \ under the name main.db, replacing the broken (Skype should be turned off). <br><br>  6. Run Skype.  Enter the username and password (I went to the machine). <br><br>  7. PROFIT !!!  All messages are back! <br><img src="http://habrastorage.org/storage2/71a/663/888/71a6638880379a97fd31ebc027f79584.png" alt="Skype history restored"><br><div class="spoiler">  <b class="spoiler_title">Know the best way?</b>  <b class="spoiler_title">- I invite in the comments.</b> <div class="spoiler_text">  Perhaps there is a more competent way to restore the database.  I even found <a href="http://www.sqliterecovery.com/how-it-works.html">Some greedy utility</a> , but it did not help me (maybe I had to give money?).  I also tried SkypeHistoryReader, Kudos Chat Search, sqlite maestro and all sorts of different things. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/160629/">https://habr.com/ru/post/160629/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../160611/index.html">UIDesign Group office</a></li>
<li><a href="../160613/index.html">HTC Windows Phone 8X - the ease of novelty</a></li>
<li><a href="../160621/index.html">What color is Mars?</a></li>
<li><a href="../160623/index.html">Presentation of the team "Astmedkom"</a></li>
<li><a href="../160625/index.html">DynAcSys team presentation</a></li>
<li><a href="../160631/index.html">Almost real transformer in scale 1:12</a></li>
<li><a href="../160633/index.html">Service of search for components for copters and not only</a></li>
<li><a href="../160635/index.html">State final certification in schools - not all like the exam</a></li>
<li><a href="../160637/index.html">Apple fired cardholder in iOS 6</a></li>
<li><a href="../160641/index.html">Microsoft says Gmail users are switching to Outlook.com, and launched an Android application</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>