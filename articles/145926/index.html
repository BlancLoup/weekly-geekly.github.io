<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The driver is just</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many people think that creating a driver for Windows itself is something on the verge of science fiction. But actually it is not. Of course, developin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The driver is just</h1><div class="post__text post__text-html js-mediator-article">  Many people think that creating a driver for Windows itself is something on the verge of science fiction.  But actually it is not.  Of course, developing a driver for some sophisticated device is not an easy task.  But the same can be said about the creation of complex programs or games.  There is nothing difficult in the development of a simple driver and I will try to show it with examples. <br><a name="habracut"></a><br>  First we need to decide what we are going to create our first driver for.  Since the material is focused on beginners, the programming language was chosen as one of the simplest, and this is not C or assembler, but BASIC.  We will use one of the BASIC dialects - PureBasic.  Out of the box, he is not trained to create drivers, but he has a good set of files used for compilation and a little shamanism allows you to add this feature.  The compilation process consists of several stages.  In short, it happens as follows: First, the translator ‚Äúovertakes‚Äù the basic code into an assembler, which is given to FASM (the assembler compiler), which creates an object file.  Next comes the polink linker, which creates the executable file.  Both the assembler compiler and the linker can create drivers, and if you slightly change the compilation options, you get not an executable file, such as an EXE or DLL, but a kernel-mode driver (SYS). <br><br>  You can download a slightly modified free demo version of PureBasic 4.61 x86 at the <a href="http://depositfiles.com/files/g0fv0zx1f">file sink</a> , <a href="http://ifolder.ru/31383732">mirror.</a> <br>  If you need to create a driver for the x64 system, download <a href="http://depositfiles.com/files/lwnwll6bz">this version</a> , <a href="http://ifolder.ru/31383802">mirror.</a> <br><br>  Distributions are small, about 3 MB each.  With this version you can only create drivers. <br>  Download, unpack and run by clicking on the file "PureBasic Portable".  This will launch the IDE and pop up a window with the message that this is a demo version and a list of restrictions.  Of these, the most significant is the limit of the number of lines of code equal to 800, and for creating simple drivers this may be enough.  The remaining restrictions in our case are not significant. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The IDE window with the loaded driver code is shown in the screenshot. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ff4/a58/cd1/ff4a58cd124ec74f341732490f994b15.png" alt="image"><br><br>  The driver is compiled through the ‚ÄúCompiler‚Äù menu (this is if someone did not understand). <br><img src="https://habrastorage.org/getpro/habr/post_images/d5b/eb4/f53/d5beb4f5352c4a534c605b021306de8f.png" alt="image"><br><br>  Now we decide what our first driver will do.  Usually, when learning programming, one starts with simple things, say, performing mathematical operations and displaying the result.  So let our driver do the same, because the banal math produced in kernel mode is very cool! <br><br>  Driver Code: <br><br><pre><code class="hljs tex">Declare DriverEntry(*DriverObject, *RegistryPath) !public PureBasicStart !section '.code' code readable executable align 8 !PureBasicStart: *A=@DriverEntry() !jmp [p_A] ;    DriverEntry(). #IOCTL_MyPlus = <span class="hljs-formula"><span class="hljs-formula">$200 !extrn PB_PokeL CompilerSelect #PB_Compiler_Processor CompilerCase #PB_Processor_x86 !extrn _IoCompleteRequest@8 ;    . !extrn _RtlInitUnicodeString@8 !extrn _IoCreateDevice@28 !extrn _IoDeleteDevice@4 !extrn _IoCreateSymbolicLink@8 !extrn _IoDeleteSymbolicLink@4 !extrn _PB_PeekI@4 Import "ntoskrnl.lib" CompilerCase #PB_Processor_x64 !extrn IoCompleteRequest;    . !extrn RtlInitUnicodeString !extrn IoCreateDevice !extrn IoDeleteDevice !extrn IoCreateSymbolicLink !extrn IoDeleteSymbolicLink !extrn PB_PeekI ImportC "ntoskrnl.lib" CompilerEndSelect ;    . IoCompleteRequest(*IRP, PriorityBoost) RtlInitUnicodeString(*UString, *String) IoCreateDevice(*DriverObject, DeviceExtensionSize, *UDeviceName, DeviceType, DeviceCharacteristics, Exclusive, *DeviceObject) IoDeleteDevice(*DeviceObject) IoCreateSymbolicLink(*SymbolicLinkName, *DeviceName) IoDeleteSymbolicLink(*SymbolicLinkName) EndImport Structure MyData ; ,   . Plus_1.l Plus_2.l EndStructure ;     . Procedure DeviceIoControl(*DeviceObject.DEVICE_OBJECT, *pIrp.IRP) Protected *Stack.IO_STACK_LOCATION Protected *InpBuff, *OutBuff Protected InBuffSize, OutBuffSize Protected ntStatus, *MyData.MyData ntStatus = #STATUS_SUCCESS ;  . *Stack = *pIrp</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Tail</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Overlay</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">CurrentStackLocation</span></span></span></span></span><span class="hljs-formula"> ;   (. WinAPI  DeviceIoControl()) InBuffSize = *Stack</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Parameters</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">DeviceIoControl</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">InputBufferLength</span></span></span></span></span><span class="hljs-formula"> OutBuffSize = *Stack</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Parameters</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">DeviceIoControl</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">OutputBufferLength</span></span></span></span></span><span class="hljs-formula"> If InBuffSize &gt;= SizeOf(Integer) And OutBuffSize &gt;= 4 Select *Stack</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Parameters</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">DeviceIoControl</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">IoControlCode</span></span></span></span></span><span class="hljs-formula"> Case #IOCTL_MyPlus *Point = *pIrp</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">SystemBuffer</span></span></span></span></span><span class="hljs-formula"> If *Point *MyData = PeekI(*Point) If *MyData Result.l = *MyData</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Plus</span></span></span></span></span><span class="hljs-formula">_1 + *MyData</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Plus</span></span></span></span></span><span class="hljs-formula">_2 PokeL(*pIrp</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">SystemBuffer</span></span></span></span></span><span class="hljs-formula">, Result) *pIrp</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">IoStatus</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Information</span></span></span></span><span class="hljs-formula"><span class="hljs-tag"> = </span></span><span class="hljs-number"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-number">4</span></span></span></span></span><span class="hljs-formula"> Else ntStatus = #STATUS_BUFFER_TOO_SMALL *pIrp</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">IoStatus</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Information</span></span></span></span><span class="hljs-formula"><span class="hljs-tag"> = </span></span><span class="hljs-number"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-number">0</span></span></span></span></span><span class="hljs-formula"> EndIf EndIf Default ntStatus = #STATUS_UNSUCCESSFUL *pIrp</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">IoStatus</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Information</span></span></span></span><span class="hljs-formula"><span class="hljs-tag"> = </span></span><span class="hljs-number"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-number">0</span></span></span></span></span><span class="hljs-formula"> EndSelect Else ntStatus = #STATUS_BUFFER_TOO_SMALL ;    . *pIrp</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">IoStatus</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Information</span></span></span></span><span class="hljs-formula"><span class="hljs-tag"> = </span></span><span class="hljs-number"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-number">0</span></span></span></span></span><span class="hljs-formula"> EndIf *pIrp</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">IoStatus</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Status</span></span></span></span><span class="hljs-formula"><span class="hljs-tag"> = </span></span></span><span class="hljs-formula">ntStatus IoCompleteRequest(*pIrp, #IO_NO_INCREMENT) ProcedureReturn ntStatus EndProcedure ;  .     . Procedure UnloadDriver(*DriverObject.DRIVER_OBJECT) Protected uniDOSString.UNICODE_STRING ;  -. RtlInitUnicodeString(@uniDOSString, ?DosDevices) ;   . IoDeleteSymbolicLink (@uniDOSString) ;  . IoDeleteDevice(*DriverObject</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">DeviceObject</span></span></span></span></span><span class="hljs-formula">) EndProcedure ;         CreateFile(). Procedure CreateDispatch(*DeviceObject.DEVICE_OBJECT, *pIrp.IRP) *pIrp</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">IoStatus</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Information</span></span></span></span><span class="hljs-formula"><span class="hljs-tag"> = </span></span><span class="hljs-number"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-number">0</span></span></span></span></span><span class="hljs-formula"> *pIrp</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">IoStatus</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Status</span></span></span></span><span class="hljs-formula"><span class="hljs-tag"> = </span></span></span><span class="hljs-formula">#STATUS_SUCCESS IoCompleteRequest(*pIrp, #IO_NO_INCREMENT) ProcedureReturn #STATUS_SUCCESS EndProcedure ;      CloseHandle(). Procedure CloseDispatch(*DeviceObject.DEVICE_OBJECT, *pIrp.IRP) *pIrp</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">IoStatus</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Information</span></span></span></span><span class="hljs-formula"><span class="hljs-tag"> = </span></span><span class="hljs-number"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-number">0</span></span></span></span></span><span class="hljs-formula"> *pIrp</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">IoStatus</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Status</span></span></span></span><span class="hljs-formula"><span class="hljs-tag"> = </span></span></span><span class="hljs-formula">#STATUS_SUCCESS IoCompleteRequest(*pIrp, #IO_NO_INCREMENT) ProcedureReturn #STATUS_SUCCESS EndProcedure ;   .     . Procedure DriverEntry(*DriverObject.DRIVER_OBJECT, *RegistryPath.UNICODE_STRING) Protected deviceObject.DEVICE_OBJECT Protected uniNameString.UNICODE_STRING Protected uniDOSString.UNICODE_STRING ;  -. RtlInitUnicodeString(@uniNameString, ?Device) RtlInitUnicodeString(@uniDOSString, ?DosDevices) ;  . status = IoCreateDevice(*DriverObject, 0, @uniNameString, #FILE_DEVICE_UNKNOWN, 0, #False, @deviceObject) If status &lt;&gt; #STATUS_SUCCESS ProcedureReturn status EndIf ;         , ;      user-mode,  ,  ;       . status = IoCreateSymbolicLink(@uniDOSString, @uniNameString) If status &lt;&gt; #STATUS_SUCCESS IoDeleteDevice(@deviceObject) ProcedureReturn status EndIf ;     . *DriverObject</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">DriverUnload</span></span></span></span><span class="hljs-formula"><span class="hljs-tag"> = </span></span></span><span class="hljs-formula">@UnloadDriver() *DriverObject</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">MajorFunction</span></span></span></span><span class="hljs-string"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-string">[#IRP_MJ_CREATE]</span></span></span></span><span class="hljs-formula"><span class="hljs-tag"> = </span></span></span><span class="hljs-formula">@CreateDispatch() *DriverObject</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">MajorFunction</span></span></span></span><span class="hljs-string"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-string">[#IRP_MJ_CLOSE]</span></span></span></span><span class="hljs-formula"><span class="hljs-tag"> = </span></span></span><span class="hljs-formula">@CloseDispatch() ;       WinAPI DeviceIoControl(). *DriverObject</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">MajorFunction</span></span></span></span><span class="hljs-string"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-string">[#IRP_MJ_DEVICE_CONTROL]</span></span></span></span><span class="hljs-formula"><span class="hljs-tag"> = </span></span></span><span class="hljs-formula">@DeviceIoControl() ProcedureReturn #STATUS_SUCCESS EndProcedure ;   (). DataSection Device: !du '</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">Device</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">pbDrPlus</span></span></span></span></span><span class="hljs-formula">', 0, 0 DosDevices: !du '</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">DosDevices</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">pbDrPlus</span></span></span></span></span><span class="hljs-formula">', 0, 0 EndDataSection</span></span></code> </pre> <br><br>  It may seem like a bunch of meaningless code, but it‚Äôs not. <br><br>  Each driver must have an entry point, usually it has the name DriverEntry () and it is executed as a procedure or function.  As you can see, there is such a procedure in this driver.  If you look at the beginning of the code, then in the first lines you will see how control is transferred to it.  In this procedure, the driver is initialized.  The procedure for terminating the driver is also assigned there, which in our case is named UnloadDriver ().  The procedures CreateDispatch () and CloseDispatch () are assigned as handlers for connecting and disconnecting the program from the user code. <br>  The DeviceIoControl () procedure will process the WinAPI requests of the DeviceIoControl () function, which in this driver is associated with the user interface.  At the end of the code is the so-called DataSection (DataSection), in which the driver names are saved in Unicode format (one of the assembler FASM chips was used for this). <br><br>  Now consider how the driver will interact with the outside world.  This happens in the DeviceIoControl () procedure.  It tracks one message, namely - #IOCTL_MyPlus, which the user mode program sends when it needs to add two numbers in kernel mode (sounds cool, right?).  When such a message is received, we read from the system buffer, the address of the pointer to the structure with the terms, we add and the result is placed in the system buffer.  Actually this is the main task of our first driver. <br><br>  See how much code was needed to perform the simplest mathematical operation - the addition of two numbers? <br><br>  And now we will consider the program working with this driver.  It is written on the same PureBasic. <br><br><pre> <code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#DriverName</span></span> = <span class="hljs-comment"><span class="hljs-comment">"pbDrPlus"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#IOCTL_MyPlus</span></span> = <span class="hljs-string"><span class="hljs-string">$2</span></span>00 <span class="hljs-type"><span class="hljs-type">XIncludeFile</span></span> <span class="hljs-comment"><span class="hljs-comment">"..\DrUserModeFramework.pbi"</span></span> <span class="hljs-type"><span class="hljs-type">Structure</span></span> <span class="hljs-type"><span class="hljs-type">MyData</span></span> ; ,   . <span class="hljs-type"><span class="hljs-type">Plus_1</span></span>.l <span class="hljs-type"><span class="hljs-type">Plus_2</span></span>.l <span class="hljs-type"><span class="hljs-type">EndStructure</span></span> ;    -. <span class="hljs-type"><span class="hljs-type">DrFile</span></span>.s = <span class="hljs-type"><span class="hljs-type">GetPathPart</span></span>(<span class="hljs-type"><span class="hljs-type">ProgramFilename</span></span>())+<span class="hljs-symbol"><span class="hljs-symbol">#DriverName</span></span>+<span class="hljs-comment"><span class="hljs-comment">".sys"</span></span> ;     ,    . hDrv=<span class="hljs-type"><span class="hljs-type">OpenDriver</span></span>(<span class="hljs-type"><span class="hljs-type">DrFile</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">#DriverName</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">#DriverName</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">#DriverName</span></span>) <span class="hljs-type"><span class="hljs-type">If</span></span> hDrv=<span class="hljs-number"><span class="hljs-number">0</span></span> ;    . <span class="hljs-type"><span class="hljs-type">Driver_UnInstall</span></span>(<span class="hljs-symbol"><span class="hljs-symbol">#DriverName</span></span>) <span class="hljs-type"><span class="hljs-type">MessageRequester</span></span>(<span class="hljs-comment"><span class="hljs-comment">""</span></span>, <span class="hljs-comment"><span class="hljs-comment">"  "</span></span>) <span class="hljs-type"><span class="hljs-type">End</span></span> <span class="hljs-type"><span class="hljs-type">EndIf</span></span> ;    . <span class="hljs-type"><span class="hljs-type">Procedure</span></span>.q <span class="hljs-type"><span class="hljs-type">Plus</span></span>(hDrv, x1, x2) <span class="hljs-type"><span class="hljs-type">Protected</span></span> <span class="hljs-type"><span class="hljs-type">MyData</span></span>.<span class="hljs-type"><span class="hljs-type">MyData</span></span>, <span class="hljs-type"><span class="hljs-type">Result</span></span>, *<span class="hljs-type"><span class="hljs-type">Point</span></span> <span class="hljs-type"><span class="hljs-type">MyData</span></span>\<span class="hljs-type"><span class="hljs-type">Plus_1</span></span>=x1 <span class="hljs-type"><span class="hljs-type">MyData</span></span>\<span class="hljs-type"><span class="hljs-type">Plus_2</span></span>=x2 *<span class="hljs-type"><span class="hljs-type">Point</span></span> = @<span class="hljs-type"><span class="hljs-type">MyData</span></span> <span class="hljs-type"><span class="hljs-type">DeviceIoControl_</span></span>(hDrv, <span class="hljs-symbol"><span class="hljs-symbol">#IOCTL_MyPlus</span></span>, @*<span class="hljs-type"><span class="hljs-type">Point</span></span>, <span class="hljs-type"><span class="hljs-type">SizeOf</span></span>(<span class="hljs-type"><span class="hljs-type">MyData</span></span>), @<span class="hljs-type"><span class="hljs-type">Result</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, @<span class="hljs-type"><span class="hljs-type">BytesReturned</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-type"><span class="hljs-type">ProcedureReturn</span></span> <span class="hljs-type"><span class="hljs-type">Result</span></span> <span class="hljs-type"><span class="hljs-type">EndProcedure</span></span> <span class="hljs-type"><span class="hljs-type">OpenWindow</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">300</span></span>,<span class="hljs-number"><span class="hljs-number">300</span></span>,<span class="hljs-number"><span class="hljs-number">140</span></span>,<span class="hljs-number"><span class="hljs-number">90</span></span>,<span class="hljs-comment"><span class="hljs-comment">"Title"</span></span>,<span class="hljs-symbol"><span class="hljs-symbol">#PB_Window_SystemMenu</span></span>|<span class="hljs-symbol"><span class="hljs-symbol">#PB_Window_ScreenCentered</span></span>) <span class="hljs-type"><span class="hljs-type">StringGadget</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">50</span></span>,<span class="hljs-number"><span class="hljs-number">20</span></span>,<span class="hljs-comment"><span class="hljs-comment">""</span></span>) <span class="hljs-type"><span class="hljs-type">StringGadget</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>,<span class="hljs-number"><span class="hljs-number">50</span></span>,<span class="hljs-number"><span class="hljs-number">20</span></span>,<span class="hljs-comment"><span class="hljs-comment">""</span></span>) <span class="hljs-type"><span class="hljs-type">TextGadget</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">70</span></span>,<span class="hljs-number"><span class="hljs-number">30</span></span>,<span class="hljs-number"><span class="hljs-number">70</span></span>,<span class="hljs-number"><span class="hljs-number">20</span></span>,<span class="hljs-comment"><span class="hljs-comment">""</span></span>) <span class="hljs-type"><span class="hljs-type">Repeat</span></span> ev=<span class="hljs-type"><span class="hljs-type">WaitWindowEvent</span></span>() <span class="hljs-type"><span class="hljs-type">If</span></span> ev=<span class="hljs-symbol"><span class="hljs-symbol">#PB_Event_Gadget</span></span> op1=<span class="hljs-type"><span class="hljs-type">Val</span></span>(<span class="hljs-type"><span class="hljs-type">GetGadgetText</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>)) op2=<span class="hljs-type"><span class="hljs-type">Val</span></span>(<span class="hljs-type"><span class="hljs-type">GetGadgetText</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)) <span class="hljs-type"><span class="hljs-type">Result</span></span> = <span class="hljs-type"><span class="hljs-type">Plus</span></span>(hDrv, op1, op2) <span class="hljs-type"><span class="hljs-type">SetGadgetText</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-type"><span class="hljs-type">Str</span></span>(<span class="hljs-type"><span class="hljs-type">Result</span></span>)) <span class="hljs-type"><span class="hljs-type">EndIf</span></span> <span class="hljs-type"><span class="hljs-type">Until</span></span> ev=<span class="hljs-symbol"><span class="hljs-symbol">#PB_Event_CloseWindow</span></span> ;   ,     . <span class="hljs-type"><span class="hljs-type">If</span></span> hDrv <span class="hljs-type"><span class="hljs-type">CloseHandle_</span></span>(hDrv) hDrv=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">EndIf</span></span> ;    . <span class="hljs-type"><span class="hljs-type">Driver_UnInstall</span></span>(<span class="hljs-symbol"><span class="hljs-symbol">#DriverName</span></span>)</code> </pre> <br><br>  When the program starts, the OpenDriver () function is called, which loads the driver.  For simplicity, the driver name, service name, and service description are the same ‚Äî pbDrPlus.  If the download is unsuccessful, the corresponding message is displayed and the program ends its work. <br><br>  The Plus () procedure communicates with the driver.  The handle is passed to it, the driver access and the addend numbers that are placed in the structure and the pointer to which pointer is passed to the driver.  The result of the addition of numbers will be in the variable "Result". <br><br>  The following is the code of the simplest GUI calculator, copied from <a href="http://ru.wikipedia.org/wiki/PureBasic">Wikipedia.</a> <br><br>  When the window is closed, before the program terminates, the connection with the driver is closed and it is uninstalled from the system. <br><br>  The result of the addition of the numbers 8 and 2 in the screenshot. <br><br><img src="http://i077.radikal.ru/1206/18/5ecac06c6138.png" alt="image"><br><br>  Source codes of the driver and the program can be found in the folder ‚ÄúExamples‚Äù, PureBasic on the file sink, the link to which was given at the beginning of the article.  There you will also find examples of direct access to the pores of the computer and an example of working with kernel memory. <br><br>  Ps. <br>  Remember, work in the kernel is fraught with minor surprises ala, BSOD (blue screen of death), so experiment carefully and be sure to save everything before running the driver. <br><br>  <b>For the possible loss of data, I am not responsible!</b> </div><p>Source: <a href="https://habr.com/ru/post/145926/">https://habr.com/ru/post/145926/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../145920/index.html">Unusual Tablet PC by ASUS - Taichi</a></li>
<li><a href="../145921/index.html">Anatomy of a profitable freemium</a></li>
<li><a href="../145922/index.html">Installing OS Inferno New Edition (update)</a></li>
<li><a href="../145923/index.html">The Dude. Practical monitoring (Part 1)</a></li>
<li><a href="../145925/index.html">GT03B GPS - what's inside</a></li>
<li><a href="../145927/index.html">Listen to music from Vkontakte on HP TouchPad</a></li>
<li><a href="../145928/index.html">SPDY is not so fast on real sites</a></li>
<li><a href="../145929/index.html">Algorithmic undecidability is not an obstacle for algorithmic AI</a></li>
<li><a href="../145930/index.html">On the mini-computer MK802 checked the work of Ubuntu and Puppy Linux</a></li>
<li><a href="../145931/index.html">Google turns off Meebo Messenger</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>