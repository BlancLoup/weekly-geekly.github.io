<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Deep diving into Windows Server and Docker containers - Part 2 - Implementing Windows Server containers (translation)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! I present to your attention the translation of the article Deep dive into Windows Server Containers and Docker - Part 2 - Underlying impleme...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Deep diving into Windows Server and Docker containers - Part 2 - Implementing Windows Server containers (translation)</h1><div class="post__text post__text-html js-mediator-article"><p>  Hi, Habr!  I present to your attention the translation of the article <a href="http://blog.xebia.com/deep-dive-into-windows-server-containers-and-docker-part-2-underlying-implementation-of-windows-server-containers/">Deep dive into Windows Server Containers and Docker - Part 2 - Underlying implementation of Windows Server Containers</a> by Cornell Knulst. </p><br><p>  This article describes the features of the Docker implementation in Windows, as well as the differences in the implementation of containers between Windows and Linux. </p><br><p>  Before this, a general idea is given of what containers are, how they are similar and how they differ from virtual machines. </p><a name="habracut"></a><br><h1 id="vstuplenie">  Introduction </h1><br><p>  Introducing Windows Server 2016 Technical Preview 3 on August 3, 2015, Microsoft introduced container technology into the Windows platform.  While container technology appeared on Linux in August 2008, this functionality was not previously supported by Microsoft operating systems.  Due to the success of Docker on Linux, Microsoft decided almost 3 years ago (the original article was published on May 6, 2017 - <em>approx. Transl.</em> ) To begin work on the implementation of containers for Windows.  Since September 2016, we have been able to work with the publicly available version of this new container technology in Windows Server 2016 and Windows 10. But what is the difference between containers and virtual machines?  And how are Windows containers internally implemented?  In this article we will dive into the implementation of containers on Windows. </p><br><h1 id="konteynery-i-virtualnye-mashiny">  Containers and virtual machines </h1><br><p>  Often, containers are introduced to the phrase ‚ÄúContainers are lightweight virtual machines‚Äù.  While this may help people give a fundamental understanding of what containers are, it is important to note that this statement is 100% wrong and can be very confusing.  Containers are different from virtual machines, and therefore I always see containers as ‚Äúsomething different from virtual machines‚Äù or even say ‚Äúcontainers are NOT virtual machines‚Äù.  But what is the difference?  And why is she so important? </p><br><h2 id="chto-obschego-mezhdu-konteynerami-i-virtualnymi-mashinami">  What do containers and virtual machines have in common? </h2><br><p>  Although containers are NOT virtual machines, they both have three important characteristics: </p><br><p><img src="https://habrastorage.org/web/6ac/937/c75/6ac937c751e84690ab277d026da47801.png"></p><br><p>  ( <a href="https://www.dreamstime.com/albund_info">Albund</a> image | <a href="https://www.dreamstime.com/">Dreamstime.com</a> ) </p><br><p>  What do containers and virtual machines have in common: </p><br><ul><li>  <strong>Isolated Environment</strong> : Like virtual machines, containers guarantee isolation of the file system, environment variables, the registry, and processes between applications.  This means that, like a virtual machine, each container creates an isolated environment for all applications inside it.  During migration, both containers and virtual machines retain not only the applications inside, but also the context of these applications. </li><li>  <strong>Migration between hosts</strong> : The great advantage of working with virtual machines is that you can move virtual machine snapshots between hypervisors without having to change their contents.  This is true for containers.  Where virtual machines can be ‚Äúmoved‚Äù between different hypervisors, containers can be ‚Äúmoved‚Äù between different container hosts.  When ‚Äúmoving‚Äù both types of artifacts between different hosts, the contents of the virtual machine / container remain exactly the same as on previous hosts. </li><li>  <strong>Resource management</strong> : another common feature is that the available resources (CPU, RAM, network bandwidth) of both containers and virtual machines can be limited to given values.  In both cases, this resource management can be performed only on the host side of the container or hypervisor.  Resource management ensures that the container receives limited resources to minimize the risk that it will affect the performance of other containers running on the same host.  For example, a container can be given a restriction that it cannot use more than 10% of the CPU. </li></ul><br><h2 id="raznica-mezhdu-konteynerami-i-virtualnymi-mashinami">  The difference between containers and virtual machines </h2><br><p>  Although there are similarities between containers and virtual machines, there are also some important differences between them. </p><br><p><img src="https://habrastorage.org/web/f6a/c40/c7a/f6ac40c7af0f4c7e99a8cce1778bb787.png"></p><br><p>  The difference between containers and virtual machines: </p><br><ul><li>  <strong>Virtualization Level</strong> : Containers are a new level of virtualization.  If you look at the history of virtualization, it began with concepts such as virtual memory and virtual machines.  Containers are a new level of this virtualization trend.  Where virtual machines provide hardware virtualization, containers provide OS virtualization.  This means that if hardware virtualization allows a virtual machine to believe that its hardware resources belong only to it, OS virtualization allows the container to believe that the entire OS belongs only to it.  It is important to note this difference in virtualization.  Containers, for example, do not have their own kernel mode.  For this reason, containers are not visible as virtual machines, and they are also not recognized as virtual machines inside the operating system (you can try the PowerShell Get-VM command yourself).  A good analogy to explain this difference is at home (virtual machines) and apartments (containers).  Houses (virtual machines) are completely self-sufficient and provide protection against uninvited guests.  Each house also has its own infrastructure - plumbing, heating, electricity, etc. Apartments (containers) also provide protection from uninvited guests, but they are built on the basis of common infrastructure.  In an apartment house (Docker Host) plumbing, heating, electricity, etc. are common.  Although they both may have common characteristics, they are different entities. </li><li>  <strong>OS Interaction</strong> : Another important difference between containers and virtual machines is the way they interact with kernel mode.  While virtual machines have a full OS (and dedicated kernel mode), containers share ‚ÄúOS (more precisely, kernel mode)‚Äù with other containers and with a host of containers.  As a result, containers should be guided by the container host OS, while the virtual machine can choose any OS (version and type) that it wishes.  Where virtual machines can run Linux on the Windows hypervisor, with container technology it is not possible to start the Linux container on the Windows container host, and vice versa.  (In Windows 10, you can run Linux containers, but they run inside a Linux virtual machine - <em>approx. Transl.</em> ) </li><li>  <strong>Growth model</strong> : containers share container host resources, and are created based on an image that contains exactly what you need to run your application.  You start with the basics and add what is needed.  Virtual machines are created in the reverse order.  Most often we start with a full operating system and, depending on the application, we remove things that are not needed. </li></ul><br><h1 id="konteynery-windows-server">  Windows Server Containers </h1><br><p>  Now that we know the differences between virtual machines and containers, let's dive deeper into the Windows Server container architecture.  To explain how containers are internally implemented in the Windows operating system, you need to be aware of two important concepts: user mode and kernel mode.  These are two different modes between which the processor constantly switches, depending on the type of code that needs to be executed. </p><br><h2 id="rezhim-yadra">  Kernel mode </h2><br><p>  The kernel mode of the operating system was created for drivers who need unrestricted access to hardware.  Normal programs (user mode) have to call the operating system API to gain access to hardware or memory.  The code running in kernel mode has direct access to these resources, and it shares the same memory / virtual address space as the operating system and other drivers in the kernel.  Therefore, it is very risky to execute code in kernel mode, as data belonging to the operating system or another driver may be damaged if your kernel mode code accidentally writes data to the wrong virtual address.  If the kernel mode driver crashes, then the entire operating system crashes.  Therefore, in kernel mode, you need to execute as little code as possible.  For this very reason, user mode has been created. </p><br><h2 id="rezhim-polzovatelya">  User mode </h2><br><p>  In user mode, the code is always executed in a separate process (user space), which has its own set of memory areas (its own virtual address space).  Since each application‚Äôs virtual address space is own, one application cannot change data belonging to another application.  Each application is executed in isolation, and if the application crashes, then the crash is limited only to this application.  In addition to the fact that the virtual address space is private, in user mode it is limited.  A user mode processor cannot access virtual addresses reserved for the operating system.  Limiting the virtual address space of an application in user mode does not allow it to change, and possibly damage, the critical data of the operating system. </p><br><h2 id="tehnicheskaya-realizaciya-konteynerov-windows">  Technical implementation of Windows containers </h2><br><p>  But what do all these processor modes do with containers?  Each container is just a ‚Äúuser mode‚Äù of a processor with a couple of additional features, such as isolation of the namespace, resource management, and the concept of a cascade-integrated file system.  This means that Microsoft needed to adapt the Windows operating system to allow it to support multiple user modes.  Something that was very difficult to do, given the high level of integration between the two modes in previous versions of Windows. </p><br><p>  Before the release of Windows Server 2016, each Windows operating system we used consisted of a single ‚Äúuser mode‚Äù and a ‚Äúkernel mode‚Äù.  With the advent of Windows Server 2016, it has become possible to have several user modes running in the same operating system.  The following diagram gives an overview of this new multi-user architecture. </p><br><p><img src="https://habrastorage.org/web/e16/aa2/672/e16aa2672a604176a4e13f416831a094.png"></p><br><p>  Looking at the user modes in Windows Server 2016, you can identify two different types: host user mode and container user modes (green blocks in the diagram).  The host user mode is identical to the normal user mode, which we are familiar with from previous versions of Windows.  The purpose of this user mode is to host basic Windows services and processes, such as Session Manager, Event Manager, and the network.  Moreover, this user mode facilitates, in the case of the implementation of Windows Server Core, user interaction with Windows Server 2016 using the user interface. </p><br><p> A new feature of Windows Server 2016 is that once you have enabled the Containers component, this user mode of the host will contain some additional container management technologies that ensure that the containers work in Windows.  The basis of this container technology is the abstraction of Compute Services (orange block), which gives access via the public API to the low-level capabilities of the container provided by the kernel.  In fact, these services contain only the functionality to launch Windows containers, monitor their running, and manage the functionality necessary to restart them.  Other container management functions, such as tracking all containers, storing container images, volumes, etc., are implemented in the Docker Engine.  This engine communicates directly with Compute Services Container API and uses the ‚ÄúGo language‚Äù proposed by Microsoft for this. </p><br><h1 id="raznica-mezhdu-konteynerami-windows-i-linux">  The difference between Windows and Linux containers </h1><br><p><img src="https://habrastorage.org/web/d75/128/e98/d75128e983bd46479f062fb5cf633ae6.png"><br>  Same Docker Utilities and Commands in Windows and Linux Containers </p><br><p>  Although the same Docker client utilities (Docker Compose, Docker Swarm) can manage both Windows and Linux containers, there are some important differences between container implementations on Windows and on Linux. </p><br><h2 id="sistemnye-processy">  System processes </h2><br><p>  Where Linux provides its kernel-level functionality through system calls, Microsoft decided to control the available kernel functionality with a DLL (this is also the reason why Microsoft actually did not document its system calls).  Although this method of abstraction for system calls has its advantages, it has resulted in a highly integrated Windows operating system with many interdependencies between different Win32 DLLs and the expectation from many DLLs that will start some system services that they (non) explicitly refer to.  As a result, it is not very realistic to run only the application processes specified in the Dockerfile inside the Windows container.  Therefore, inside the Windows container, you will see a bunch of additional system processes running, while Linux containers need to run only the specified application processes.  To ensure that the necessary system processes and services are running inside the Windows container, the so-called smss process is started inside each container.  The purpose of the smss process is to start the necessary system processes and services. </p><br><p><img src="https://habrastorage.org/web/f0a/7d8/e50/f0a7d8e5042f42739b008dde8e574aa2.png"><br>  <em>SMSS process</em> </p><br><h2 id="arhitektura-os">  OS architecture </h2><br><p>  Not only in the way kernel functionality is provided, but also at the architecture level, there is an important difference in how both operating systems provide container functionality to Docker client utilities.  In the current container implementation in Windows Server 2016, there is an abstraction layer called Compute Services, which abstracts the low-level capabilities of the container from the outside.  The reason for this is that Microsoft can change the container's low-level API without having to change the public API called by Docker Engine and other container client utilities.  In addition to this Compute Services API, you can write your own container management toolkit using C # or Go binding, which is available at <a href="https://github.com/Microsoft/dotnet-computevirtualization">https://github.com/Microsoft/dotnet-computevirtualization</a> and <a href="https://github.com/Microsoft/hcsshim">https://github.com/Microsoft/ hcsshim</a> </p><br><p><img src="https://habrastorage.org/web/4c5/608/290/4c560829061c4adf81d8e62e73e01a6a.png"><br><img src="https://habrastorage.org/web/02f/08c/13a/02f08c13aa0e46cc86e8c63854478b5b.png"></p><br><h2 id="kaskadno-obedinyonnaya-faylovaya-sistema">  Cascade unified file system? </h2><br><p>  The third important difference between the Linux and Windows container implementations is the way that both operating systems use copy-on-write Docker technology.  Since many Windows applications rely on NTFS semantics, it was difficult for the Microsoft team to create a full-fledged implementation of a cascading and unified file system in Windows.  For features such as USN logs and transactions, this would, for example, require a completely new implementation.  Therefore, in the current version of containers in Windows Server 2016 there is no real cascade-integrated file system.  Instead, the current implementation creates a new NTFS virtual disk for each container.  To keep these virtual disks small, the various file system objects on this virtual NTFS disk are in fact symbolic links to the real files of the host file system.  As soon as you change the files inside the container, these files are saved to the virtual block device, and at the moment you want to fix this layer of changes, the changes are picked up from the virtual block device and saved in the container host's file system. </p><br><h2 id="konteynery-hyper-v">  Hyper-V Containers </h2><br><p>  The final difference in the Linux and Windows container implementation is in the concept of Hyper-V containers.  I will write about this interesting type of container in the next article in this series.  Stay with us‚Ä¶ </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/336642/">https://habr.com/ru/post/336642/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336632/index.html">Developing games for the console at the Arduino summer camp</a></li>
<li><a href="../336634/index.html">When is the inevitable serverless future?</a></li>
<li><a href="../336636/index.html">How to prepare for the ISTQB exam? Testers of the Krasnodar studio Plarium share their experience</a></li>
<li><a href="../336638/index.html">Links around the blocks</a></li>
<li><a href="../336640/index.html">UPS on lithium-ion batteries: understand the pros and cons of the example of Schneider Electric products</a></li>
<li><a href="../336644/index.html">5 interesting ICO in September 2017: lead generation, online payments and search for restaurants</a></li>
<li><a href="../336646/index.html">User support, or emergency computer help. How it is done and how much it costs</a></li>
<li><a href="../336648/index.html">Applications for Tarantool. Part 2. OAuth2 authentication</a></li>
<li><a href="../336650/index.html">In a section: the news aggregator on Android with backend. Monitoring and data visualization system (InfluxDB, Grafana)</a></li>
<li><a href="../336654/index.html">Cheat Sheet with Docker Teams</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>