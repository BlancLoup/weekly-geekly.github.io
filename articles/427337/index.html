<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Parsing Joker 2018</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Aloha! 

 That ended one of the most hardcore conferences in the world of Java - Joker 2018, which traditionally takes place in St. Petersburg at Expo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Parsing Joker 2018</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/5d/j3/so/5dj3so2fprwkdxxtxhq5zak-uhu.jpeg"><br><br>  Aloha! <br><br>  That ended one of the most hardcore conferences in the world of Java - Joker 2018, which traditionally takes place in St. Petersburg at Expoforum.  This year a record number of participants took part in the conference.  Odnoklassniki traditionally offered to help our developers solve non-trivial tasks that arise when creating one of the most heavily loaded Java projects. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Those who responded well to questions received prizes, and we offer you a brief analysis of our problems.  We hid the correct answers under the spoiler, mind you, to open only after they themselves thought of the solution ;-) <br><br>  Go! <br><a name="habracut"></a><br><h2>  Deduplicator </h2><br>  Cyril wants to save memory by deduplicating objects equal in <code>equals()</code> .  Help him implement the thread-safe dedup method by analogy with <code>String.intern</code> , but not only for strings. <br><br><pre> <code class="hljs vala"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span> dedup(<span class="hljs-built_in"><span class="hljs-built_in">Object</span></span> obj) { }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Decision</b> <div class="spoiler_text">  Scratching the back of his head first, Cyril was able to come up with several options for solving this problem, but they were all somehow wrong.  Then he scratched his nose and the dock about <code>java.util.concurrent</code> , recalled the wonderful method <code>computeIfAbsent</code> .  This method will perform the lambda passed to it in the parameter only if there is no key in the <code>Map</code> , write its result and return it.  If there is already such a key, the lambda will not be calculated, and the current value associated with the key will be returned.  In addition, Kirill recalled, for <code>ConcurrentHashMap</code> this method works atomically, which makes it very elegant to solve the problem.  Satisfied Cyril wrote this code: <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> final ConcurrentHashMap <span class="hljs-built_in"><span class="hljs-built_in">map</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentHashMap(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dedup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object obj)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.computeIfAbsent(obj, o -&gt; o); }</code> </pre> <br>  and gladly scratched my nose again. <br></div></div><br><h2>  IP address </h2><br>  Dima is developing a new network protocol.  Correct the error in his method to translate the IPv4 address represented as a byte array into the string. <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ipToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] ip</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ip[<span class="hljs-number"><span class="hljs-number">0</span></span>] + <span class="hljs-string"><span class="hljs-string">'.'</span></span> + ip[<span class="hljs-number"><span class="hljs-number">1</span></span>] + <span class="hljs-string"><span class="hljs-string">'.'</span></span> + ip[<span class="hljs-number"><span class="hljs-number">2</span></span>] + <span class="hljs-string"><span class="hljs-string">'.'</span></span> + ip[<span class="hljs-number"><span class="hljs-number">3</span></span>]; }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Decision</b> <div class="spoiler_text">  The first error was immediately shown by the IDE, without letting Dima even finish the method to the end.  The <code>'.'</code>  of type <code>char</code> , added to the byte as an integer type.  Replacing <code>'.'</code>  on <code>"."</code>  , Dima was so pleased with the successfully compiled code that he immediately launched it without testing.  ‚ÄúAhhhhhhh, Dima‚Äù, thought the JVM and gave out some nonsense instead of an IP address.  Unlike Dima, the JVM knew exactly that in Java, the type <code>byte</code> serves to store signed numbers, that is, all addresses that have octets greater than 127 will be represented in Java by negative numbers.  By the rules of casting these numbers to <code>int</code> , the negative sign of the number is the same as in the original byte.  Oh, Dmitry, it was necessary to take additional measures in order to drop the symbolic part, for example: <br><br><pre> <code class="hljs lisp">return (<span class="hljs-name"><span class="hljs-name">ip</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>] &amp; <span class="hljs-number"><span class="hljs-number">255</span></span>) + <span class="hljs-string"><span class="hljs-string">"."</span></span> + (<span class="hljs-name"><span class="hljs-name">ip</span></span>[<span class="hljs-number"><span class="hljs-number">1</span></span>] &amp; <span class="hljs-number"><span class="hljs-number">255</span></span>) + <span class="hljs-string"><span class="hljs-string">"."</span></span> + (<span class="hljs-name"><span class="hljs-name">ip</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>] &amp; <span class="hljs-number"><span class="hljs-number">255</span></span>) + <span class="hljs-string"><span class="hljs-string">"."</span></span> + (<span class="hljs-name"><span class="hljs-name">ip</span></span>[<span class="hljs-number"><span class="hljs-number">3</span></span>] &amp; <span class="hljs-number"><span class="hljs-number">255</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br></div></div><br><h2>  Agile mixer </h2><br>  Marina needs to mix the elements of the list in a random order.  Why is this option not suitable, and how would you fix it? <br><br><pre> <code class="hljs lua">Random <span class="hljs-built_in"><span class="hljs-built_in">random</span></span> = ThreadLocalRandom.current(); list.<span class="hljs-built_in"><span class="hljs-built_in">sort</span></span>((o1, o2) -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">random</span></span>.nextBoolean() ? +<span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">-1</span></span>; });</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Decision</b> <div class="spoiler_text">  Marina obviously forgot that the <code>Comparator</code> contract requires stability: when comparing two identical values, the comparison result should be the same.  And in Marina‚Äôs implementation, the result for each pair is strictly random, which could easily lead to the exception of <code>java.lang.IllegalArgumentException: Comparison method violates its general contract</code> !  If Marina read documentation in the evenings, she would know that in this case it is best to use the <code>Collections.shuffle()</code> method. <br><br>  Answer: Comparator contract violated.  Sorting can throw an exception.  It is better to use the <code>Collections.shuffle()</code> method. <br></div></div><br><h2>  Den of the Functionalist </h2><br>  Egor loves to write in a functional style, not worrying about the effectiveness of the code.  Estimate how many objects each call to this method creates, if an <code>ArrayList</code> of 10 lines is passed to it? <br><br><pre> <code class="hljs cmake">Predicate&lt;<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>&gt; equalsAny(<span class="hljs-keyword"><span class="hljs-keyword">List</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">list</span></span>) { Predicate&lt;<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>&gt; p = s -&gt; <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; for (<span class="hljs-keyword"><span class="hljs-keyword">String</span></span> s : <span class="hljs-keyword"><span class="hljs-keyword">list</span></span>) { p = p.<span class="hljs-keyword"><span class="hljs-keyword">or</span></span>(s::contains); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p; }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Decision</b> <div class="spoiler_text">  Unlike Egor, the pedantic Alina does not like to write everything in a functional style, because she knows how to count overhead.  Single line <br><br> <code>p = p.or(s::contains);</code> <br> <br>  will create two objects at once: one as the result of calling <code>p.or()</code> , and the second to create the predicate <code>s::contains</code> .  The latter cannot be cached, since it captures the variable <code>s</code> in the context.  Multiplying by the number of iterations, we get 20 objects.  But also a hidden <code>Iterator</code> can be created if the JIT does not optimize it.  ‚Äú20 or even 21 objects, if not lucky, are sinful,‚Äù Alina thought. <br><br>  Answer: 10 predicates <code>or</code> + 10 predicates <code>contains</code> + 1 <code>Iterator</code> depending on JIT optimizations. <br></div></div><br><h2>  Maxim turns on the maximum </h2><br>  Maxim calculates the maximum in a multi-threaded program, but wants to do without locks.  Help him fix the error. <br><br><pre> <code class="hljs cs">AtomicLong max = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AtomicLong(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v &gt; max.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()) { max.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(v); } }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Decision</b> <div class="spoiler_text">  Oh, Maxim!  The use of <code>AtomicLong</code> does not make the program thread-safe.  For this there is an atomic operation <code>AtomicLong.compareAndSwap</code> .  And starting with Java 8, it‚Äôs not at all necessary to write the CAS loop yourself, because the remarkable atomic method <code>accumulateAndGet</code> .  And here it is convenient to use just it: <br><br><pre> <code class="hljs java"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span><span class="hljs-function"> </span></span>{ max.accumulateAndGet(v, Math::max); }</code> </pre><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/427337/">https://habr.com/ru/post/427337/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../427327/index.html">MVVM architecture in mobile applications on Flutter</a></li>
<li><a href="../427329/index.html">IBM overcomes the 7 nm barrier using graphene to place nanomaterials on substrates</a></li>
<li><a href="../427331/index.html">Review of the international version of the smartphone Xiaomi Mi Max 3 - my razmerchik</a></li>
<li><a href="../427333/index.html">Color Temperature Conversion (K) to RGB: Algorithm and Sample Code</a></li>
<li><a href="../427335/index.html">Read data from an old MiniScribe hard drive.</a></li>
<li><a href="../427339/index.html">Why is Godel's incompleteness theorem difficult to prove: the point is in the formulations and not only in the essence</a></li>
<li><a href="../427341/index.html">Learn to give thanks: this is the best you can give to others and the best way to develop ‚Äúuseful social connections‚Äù</a></li>
<li><a href="../427343/index.html">VK Mobile Challenge 2018</a></li>
<li><a href="../427345/index.html">Problems of modern writing of mathematical texts</a></li>
<li><a href="../427347/index.html">Transition to Google Cloud Platform (Google Cloud Platform - GCP)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>