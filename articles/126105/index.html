<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Calling Lua scripts from java and vice versa</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I recently encountered such a problem and was extremely surprised that there are very few materials on the network, given the popularity of Lua. As it...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Calling Lua scripts from java and vice versa</h1><div class="post__text post__text-html js-mediator-article"><img src="http://www.keplerproject.org/luajava/luajava_128.png" alt="image"><br>  I recently encountered such a problem and was extremely surprised that there are very few materials on the network, given the popularity of Lua.  As it turned out, there are quite a lot of libraries for working with Lua scripts from java, but they all have their own nuances.  Best of all, as it turned out, use the <a href="http://www.keplerproject.org/luajava/index.html">LuaJava</a> library from the same developers that wrote Lua. <br><a name="habracut"></a><br><h5>  Build LuaJava Library </h5><br>  At once I will say that it is better to unpack the archive with the input files and perform the assembly in a special folder, from where you will connect the assembled jar-file to the project.  The path to this folder will also need to be registered in ClassPath.  If you compile the jar-archive, and then copy it into the folder with the java-project, the program will not start just like that.  But this will be lower. <br>  The manual‚Äôs page says that happy Linux and OSX users can build a library from source with a simple make command, making minor changes to the config file, config.  Initially this file looks like this. <br> <code>############################################################# <br> #Linux/BSD/Mac <br> LUA_DIR= /usr/local/share/lua/5.1.1 <br> LUA_LIBDIR= /usr/local/lib <br> LUA_INCLUDES= /usr/local/include <br> JDK= $(JAVA_HOME) <br> # For Mac OS, comment the above line and uncomment this one <br> #JDK=/Library/Java/Home <br> <br> # Full path to Lua static library <br> LIB_LUA=$(LUA_LIBDIR)/liblua.a <br> <br> #Linux/BSD <br> LIB_EXT= .so <br> #Mac OS <br> #LIB_EXT= .jnilib <br> <br> LIB_PREFIX= lib <br> <br> #Linux/BSD <br> LIB_OPTION= -shared <br> #Mac OS <br> #LIB_OPTION= -dynamiclib -all_load <br> <br> ## On FreeBSD and Mac OS systems, the following line should be commented <br> DLLIB= -ldl <br> <br> WARN= -O2 -Wall -fPIC -W -Waggregate-return -Wcast-align -Wmissing-prototypes -Wnested-externs -Wshadow -Wwrite-strings <br> INCS= -I$(JDK)/include -I$(JDK)/include/linux -I$(LUA_INCLUDES) <br> CFLAGS= $(WARN) $(INCS) <br> <br> CC= gcc <br> <br> ######################################################### <br> VERSION= 1.1 <br> PKG= luajava-$(VERSION) <br> TAR_FILE= $(PKG).tar.gz <br> ZIP_FILE= $(PKG).zip <br> JAR_FILE= $(PKG).jar <br> SO_FILE= $(LIB_PREFIX)$(PKG)$(LIB_EXT) <br> DIST_DIR= $(PKG) <br> <br> # $Id: config,v 1.12 2006/12/22 14:06:40 thiago Exp $</code> <br>  If you immediately try to do make, then nothing good will happen.  Here is what you need to do to successfully assemble the library: <br>  <b>1.</b> Either create the JAVA_HOME environment variable, or set it in the configuration file, specifying the path to the folder where java is installed.  I added this variable the first line in the configuration file: <br> <code>JAVA_HOME= /usr/lib/jvm/java-6-sun-1.6.0.26</code> <br> <br>  <b>2.</b> Download Lua binary files <a href="http://luabinaries.sourceforge.net/">from here</a> .  We need the Linux archive ### _ lib.tar.gz.  After unpacking the archive, the files liblua5.1a and liblua5.1.so need to be copied to the / usr / local / lib folder, and the files from the include folder to the / usr / local / include folder.  After that, in the configuration file, replace the line <br> <code>LIB_LUA=$(LUA_LIBDIR)/liblua.a</code> <br>  on <br> <code>LIB_LUA=$(LUA_LIBDIR)/liblua5.1.a</code> <br> <br>  <b>3.</b> Gcc must also be installed. <br><br>  Everything, now it is possible to collect library.  After the make command, 2 files appear: luajava-1.1.jar and libluajava-1.1.so.  The manual says that .jar needs to be placed in the lib / folder with your project, and the .so file is either in the JRE bin / folder or in the folder where the variable LD_LIBRARY_PATH points to.  I put this file in the bin / jre folder. <br><br><h5>  Java project configuration </h5><br>  In the java project, you need to connect the external library luajava-1.1.jar.  Also, running a little ahead, you need to add a string in the VM arguments <br> <code>-Djava.library.path=[  ,    LuaJava]</code> <br> <br>  Now you can safely write Lua-scripts and access them from the program.  This is done using the org.keplerproject.luajava.LuaState class.  I came across <a href="http://w3.impa.br/~rbs/pdf/GAMEON-NA07.pdf">an example</a> in which a special class was written to call the Lua functions.  Here is an example of a class that I use: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.keplerproject.luajava.LuaObject; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.keplerproject.luajava.LuaState; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.keplerproject.luajava.LuaStateFactory; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LuaScriptLoader</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> LuaState luaState; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LuaScriptLoader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String fileFullName)</span></span></span><span class="hljs-function"> </span></span>{ luaState = LuaStateFactory.newLuaState(); luaState.openLibs(); luaState.LdoFile(fileFullName); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">closeScript</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ luaState.close(); } <span class="hljs-comment"><span class="hljs-comment">/** * ,  Lua- getRoomDescription,     * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment">    */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRoomDescription</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ luaState.getGlobal(<span class="hljs-string"><span class="hljs-string">"getRoomDescription"</span></span>); luaState.call(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); LuaObject lo = luaState.getLuaObject(<span class="hljs-number"><span class="hljs-number">1</span></span>); luaState.pop(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lo.getString(); } <span class="hljs-comment"><span class="hljs-comment">/** * ,     Lua- * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> functionName -   * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> adapter -  LuaAdapter,     */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runScriptFunction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String functionName, LuaAdapter adapter)</span></span></span><span class="hljs-function"> </span></span>{ luaState.getGlobal(functionName); luaState.pushJavaObject(adapter); luaState.call(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); } }</code> </pre><br><br>  The program will run from the programming environment.  If you want to launch a .jar file with your program, you need to do 2 things: <br>  <b>1.</b> When exporting, use a manifest file in which the Class-Path attribute should be specified <br> <code>Class-Path: [  ,    LuaJava]/luajava-1.1.jar</code> <br> <br>  <b>2.</b> Run the .jar file with the same key that is specified in the VM arguments of the environment <br> <code>-Djava.library.path=[  ,    LuaJava]</code> <br> <br>  When the call method of class LuaState is accessed, 2 integer parameters are passed.  This is the number of arguments and the number of return values.  In the getRoomDescription () method you can see how to get the result from the Lua function (0 arguments, 1 return value), and in the runScriptFunction () method, how to pass java-objects to the script (1 argument, 0 return values).  The LuaAdapter class is my class that has several public methods.  These methods can be called from a script.  Here is an example of a file with a script: <br><br><pre> <code class="lua hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRoomDescription</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(adapter)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> message = adapter:getMessage() <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> user = adapter:getUser() <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> nick = user:getNick() adapter:sendMessageToRoomAndUser(user, nick..<span class="hljs-string"><span class="hljs-string">": "</span></span>..message, <span class="hljs-string"><span class="hljs-string">""</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userEnter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(adapter)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> user = adapter:getUser() <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> nick = user:getNick() adapter:sendMessageToRoomAndUser(user, <span class="hljs-string"><span class="hljs-string">"  "</span></span>..nick, <span class="hljs-string"><span class="hljs-string">"   "</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userLeft</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(adapter)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> nick = adapter:getUser():getNick() adapter:sendMessageToRoom(<span class="hljs-string"><span class="hljs-string">" "</span></span>..nick..<span class="hljs-string"><span class="hljs-string">"   "</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><br>  In this example, a conference room is scripted using Lua, where users can communicate.  All public methods that are in the LuaAdapter class are successfully called and executed. <br><br>  UPD: forgot one more thing.  You can work with java-classes and objects from Lua not only as I described above (passing the object as a parameter to the Lua-function).  In the <a href="http://www.keplerproject.org/luajava/manual.html">manual</a> LuaJava described several more ways.  I worked with the first two, they worked without any problems, I did not try the others as superfluous.  I will describe the first two ways: <br>  <b>1.</b> Call the newInstance (className, ...) function of the LuaJava library.  The first parameter of the function is the full name of the java-class, the rest are the parameters of the constructor.  The result of calling this function will be a new java-object with which you can work. <br>  Example: <br><br><pre> <code class="java hljs">obj = luajava.newInstance(<span class="hljs-string"><span class="hljs-string">"java.lang.Object"</span></span>)</code> </pre> <br><br>  You can also call your classes by passing their names as parameters (for example, ‚Äúmyproject.mypackage.MyClass‚Äù).  But here there are nuances that I have not met: <br><ul><li>  it is not clear to which project the Lua script has access.  I doubt that to all </li><li>  if you have access to many projects, or you can call Lua scripts from several projects, and in these projects there are classes with the same name, then it is not clear which class object will be created </li></ul><br><br>  <b>2.</b> Call the bindClass (className) function of the LuaJava library.  This function will return an object for which it will be possible to access the static fields and methods of the java-class whose name has been specified. <br>  Example: <br><br><pre> <code class="java hljs">sys = luajava.bindClass(<span class="hljs-string"><span class="hljs-string">"java.lang.System"</span></span>) print ( sys:currentTimeMillis() )</code> </pre><br><br>  You can also call your classes (with the same nuances). <br>  I called these Lua-functions only from one project, and in functions I addressed classes only of this project, therefore I did not encounter any problems <br><br>  <b>UPD</b> Found a nuance.  The call method does not know how to catch errors that may be present in the script.  If there is an error in the script, the whole program crashes.  Iksepshenov this method does not throw.  The only solution that nagulit - is to try to run a script call from another thread.  But it is very ugly.  But the LuaState class has a pcall method: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pcall</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nArgs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nResults, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> errFunc)</span></span></span></span></code> </pre><br><br>  which in the case of a successful call will return the value 0, and a non-zero value as a result of an unsuccessful call.  The first two arguments repeat the arguments of the call method, the last parameter apparently should point to the error handling function.  In this case, the error description will be saved in the LuaState object with which the script function was called.  Now the runScriptFunction method looks like this for me: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runScriptFunction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String functionName, LuaAdapter adapter)</span></span></span><span class="hljs-function"> </span></span>{ luaState.getGlobal(functionName); luaState.pushJavaObject(adapter); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> res = luaState.pcall(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(res != <span class="hljs-number"><span class="hljs-number">0</span></span>) { Main.log(Level.SEVERE, <span class="hljs-string"><span class="hljs-string">"LuaScriptLoader call error: "</span></span> + luaState.toString(-<span class="hljs-number"><span class="hljs-number">1</span></span>)); } } }</code> </pre></div><p>Source: <a href="https://habr.com/ru/post/126105/">https://habr.com/ru/post/126105/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../126096/index.html">At SIGGRAPH 2011, the HP Z800 Workstation simultaneously processed 12 Full HD video streams.</a></li>
<li><a href="../126097/index.html">Android application Sixaxis Controller allows you to play on your smartphone using Sixaxis or DualShock 3 controllers</a></li>
<li><a href="../126101/index.html">On the dangers of copyright and the benefits of licensed programs (the end)</a></li>
<li><a href="../126102/index.html">IPad Case from Madoff Pants</a></li>
<li><a href="../126104/index.html">About the daily use of a task management system: summaries</a></li>
<li><a href="../126112/index.html">Groupon: Robot Vacuum II - Attack of the Clones</a></li>
<li><a href="../126113/index.html">Poll: How much time do programmers waste?</a></li>
<li><a href="../126115/index.html">GTUG TLV. 08/15/2011</a></li>
<li><a href="../126116/index.html">inTaxi from VentureBrothers - order a taxi in the modern world</a></li>
<li><a href="../126117/index.html">yaTouchSlider - slider for touch devices</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>