<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Amazon Glacier: Perl client with multi-thread / multipart download</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Amazon glacier 
 In short, Amazon Glacier is a service with a very attractive price tag, created for storing archives / backups. But the process of re...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Amazon Glacier: Perl client with multi-thread / multipart download</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/e7f/73b/344/e7f73b344a7bc65628159eac61b3e947.jpg" alt="image"><br><br><h4>  Amazon glacier </h4><br>  In short, Amazon Glacier is a service with a very attractive price tag, created for storing archives / backups.  But the process of restoring archives is quite complicated and / or expensive.  However, the service is quite suitable for secondary backup. <br>  More about Glacier already <a href="http://habrahabr.ru/post/149942/">wrote</a> on Habr√©. <br><br><h4>  What's the post about </h4><br>  I want to share the Open Source client in Perl to synchronize the local directory with the Glacier service, also to tell about some of the nuances of working with glacier and describe the workflow of its work. <br><a name="habracut"></a><br><h4>  Functional </h4><br>  So, mtglacier.  GitHub <a href="https://github.com/vsespb/mt-aws-glacier">link</a> <br>  Features of the program: <br><ul><li>  The protocol for working with AWS is implemented independently; no third-party libraries are used.  Independent implementation of <a href="http://docs.amazonwebservices.com/general/latest/gr/signature-version-4.html">Amazon Signature Version 4 Signing Process</a> and <a href="http://docs.amazonwebservices.com/amazonglacier/latest/dev/checksum-calculations.html">Tree Hash</a> calculation </li><li>  Implemented <a href="http://docs.amazonwebservices.com/amazonglacier/latest/dev/multipart-archive-operations.html">Multipart Upload</a> </li><li>  Multi-threaded upload / download / delete archives </li><li>  Combining multi-threaded and multipart apload.  Those.  three streams can upload parts of file A, two more - parts of file B, another one to initiate the upload of file C, etc. </li><li>  Local log file (open for writing only in append mode).  After all, to get a listing of files with Glacier, you must wait 4 hours </li><li>  Ability to compare checksums of local files with the log </li><li>  When downloading archives, the ability to limit the number of files that will be downloaded at a time (necessary because of the peculiarity of the billing download archives) </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Objective of the project </h4><br><h6>  Implement four things in one program (all this is separately, but not together) </h6><br><ol><li>  Implementation on Perl - I believe that the language / technology in which the program is made is also important for the end user / administrator.  So it is better to have a choice of implementations in different languages. <br></li><li>  Amazon S3 support is definitely planned. </li><li>  Multipart operations + multithreaded operations - <br>  multipart will help to avoid a situation where you upload several gigabytes to a remote server and suddenly the connection breaks.  Multithreading speeds up downloads, and significantly speeds up the loading of a heap of small files or the removal of a large number of files. <br></li><li>  Own implementation of the protocol - it is planned to make the code reusable and publish as separate modules on the CPAN </li></ol><br><br><h4>  How it works </h4><br><br>  When synchronizing files to a service, <b>mtglacier</b> creates a log (text file) in which all file upload operations are recorded: for each operation, the local file name, upload time, Tree Hash file, received by the archive_id file. <br><br>  When restoring files from Glacier to a local disk, data for recovery is taken from this log (since you can only get a listing of files on the glacier with a delay of four hours or more). <br><br>  When deleting files from Glacier, deletion entries are added to the log.  When re-synchronization in Glacier, only those files that are not there are processed, according to the log. <br><br>  The two-pass file recovery procedure: <br><ol><li>  Creates a task to download files that are present in the log, but not on the local disk </li><li>  After waiting four hours, you can run a repeated command to download these files. </li></ol><br><br><h4>  Cautions </h4><br><ul><li>  Check Amazon Pricing before use. </li><li>  Learn the Amazon <a href="http://aws.amazon.com/glacier/faqs/">FAQ</a> </li><li>  No, really, be sure to check prices. </li><li>  Before you play with Glacier, make sure you can delete all the archives at the end.  The fact is that you cannot delete archives and a non-empty vault through the Amazon Console </li><li>  When multi-threading with glacier you need to select the optimal number of threads.  Amazon returns HTTP 408 Timeout if the download is too slow for each stream (after that, the mtglacier stream pauses for one second and retries, but no more than five times).  So multi-threaded download may be slower than single-threaded </li><li>  For now, this is the Beta version.  Not recommended for use in production </li></ul><br><br><h4>  How to use </h4><br><ol><li>  Create a Vault in Amazon Console </li><li>  Create <b>glacier.cfg</b> (specify the same region in which the vault was created) <br><pre> key = YOURKEY
 secret = YOURSECRET
 region = us-east-1
</pre><br></li><li> Sync local directory to Glacier.  Use the <i>concurrency</i> parameter to specify the number of threads. <br> <code>./mtglacier.pl sync --config=glacier.cfg --from-dir /data/backup --to-vault=myvault --journal=journal.log --concurrency=3 <br></code> <br></li><li>  You can add files and sync again </li><li>  Check the integrity of files (checked only with the log) <br> <code>./mtglacier.pl check-local-hash --config=glacier.cfg --from-dir /data/backup --to-vault=myvault --journal=journal.log <br></code> <br><br></li><li>  You can delete some files from / data / backup <br></li><li>  Create a data recovery task.  Use the <i>max-number-of-files</i> parameter to specify the number of archovs you want to restore.  Currently, it is not recommended to specify a value greater than a few dozen (it‚Äôs not yet implemented to load more than one page with a list of current Jobs) <br> <code>./mtglacier.pl restore --config=glacier.cfg --from-dir /data/backup --to-vault=myvault --journal=journal.log --max-number-of-files=10 <br></code> <br></li><li>  Wait 4 hours or more </li><li>  Recover deleted files <br> <code>./mtglacier.pl restore-completed --config=glacier.cfg --from-dir /data/backup --to-vault=myvault --journal=journal.log <br></code> <br></li><li>  If backup is no longer needed, delete all files from Glacier <br> <code>./mtglacier.pl purge-vault --config=glacier.cfg --from-dir /data/backup --to-vault=myvault --journal=journal.log <br></code> <br></li></ol><br><br><h4>  Implementation </h4><br><ul><li>  HTTP / HTTPS operations are implemented through <i>LWP :: UserAgent</i> </li><li>  Interaction with the Amazon API is written from scratch, the only used module <i>Digest :: SHA</i> (Core module) </li><li>  Independent implementation of Amazon Tree Hash (this is their own algorithm for calculating the checksum, did not find similar among the TTH-algorithms, correct, if not right) </li><li>  Multithreading is implemented using fork-processes </li><li>  Handling abnormal termination of processes using signals </li><li>  Interaction between processes - through unnamed pipes </li><li>  Queue of tasks - OOP objects, similar to FSM </li></ul><br><h4>  What is not enough </h4><br>  The main thing for the first beta was a stable (not alpha) version, ready by the end of the week, so a lot of things are still missing. <br>  Necessarily will: <br><ul><li>  Adjustable chunk size </li><li>  non-multipart upload </li><li>  topic for SNS notifications in config </li><li>  integration with the outside world to receive a signal through SNS notifications </li><li>  Internal refractoring </li><li>  Unit tests will be published when I put them in order. </li><li>  There will be another testsuite, perhaps a glacier server emulator </li><li>  Of course there will be a production-ready version (not Beta) </li></ul></div><p>Source: <a href="https://habr.com/ru/post/150324/">https://habr.com/ru/post/150324/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../150318/index.html">Samsung shares fell significantly after losing a trial with Apple</a></li>
<li><a href="../150320/index.html">You can agree on everything</a></li>
<li><a href="../150321/index.html">Practice AngularJS - development of the administrative panel (part 2)</a></li>
<li><a href="../150322/index.html">Free VPN from ThePirateBay</a></li>
<li><a href="../150323/index.html">Digital Era Declaration</a></li>
<li><a href="../150325/index.html">Chinese browser UCWeb goes to the West (in Asia already 200 million users)</a></li>
<li><a href="../150326/index.html">Firefox 15 release</a></li>
<li><a href="../150327/index.html">Newbie Compiler Manual</a></li>
<li><a href="../150328/index.html">Notification that the browser is outdated</a></li>
<li><a href="../150329/index.html">Qt Coding Style</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>