<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fight for resources, part 6: cpuset or Sharing is not always right</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When talking about cgroups, Red Hat users often ask the same question: ‚ÄúI have one application that is very sensitive in terms of delays. Is it possib...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fight for resources, part 6: cpuset or Sharing is not always right</h1><div class="post__text post__text-html js-mediator-article">  When talking about cgroups, Red Hat users often ask the same question: ‚ÄúI have one application that is very sensitive in terms of delays.  Is it possible with cgroups to isolate this application from the rest by linking it to certain processor cores? ‚Äù <br><br><img src="https://habrastorage.org/webt/hj/ig/zd/hjigzdvn7vwbunpdkqiqjcdmqde.png" width="100%"><br><br>  Of course, you can.  Otherwise, we would not choose this question as the topic of today's article. <br><a name="habracut"></a><br>  In childhood we were often told that sharing is good and right.  By and large, the way it is.  But there are exceptions. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As we wrote in the <a href="https://habr.com/company/redhatrussia/blog/423051/">first post of this series</a> , by default Red Hat Enterprise Linux 7 behaves like a spherical good grandmother.  In the sense that it tries to fairly distribute system resources among all who ask them.  However, in real life, grandmothers have pets who get more.  Translated into a sysadmin, this means that there are situations when some applications or services are more important than others, so they should be given all possible attention so that they are as responsive as possible. <br><br>  In Red Hat Enterprise Linux 7, this is done in two steps: <br><br><ol><li>  We isolate part of the processor cores in order to transfer them to the exclusive use of such an application. </li><li>  We create cgroups groups and unit files that bind this application to isolated cores. </li></ol><br><h3>  A small digression regarding examples from these posts. </h3><br>  In Hat Enterprise Linux 7.4, the mechanism for working with short-lived slices, such as user sessions, has changed.  As a result, they can no longer change cgroup settings on the fly, make permanent configuration changes, and create drop-in files using the systemctl set-property command.  Yes, it's a shame, but the Linux development community decided so.  The good news is that these changes have not affected the service.  That is, if applications are started and stopped through unit files (they work as daemons), then all our examples work.  In addition, it remains possible to create your own cgroups using such ancient tools as cgcreate and cgset, and then place user sessions and processes in these groups to enable CPU balls and other controls.  In life, everything changes, so we can only adapt and invent new technology.  Now turn to today's topic. <br><br><h3>  Set up separatism with isolcpus </h3><br>  One of the most important components in the Linux kernel is the process scheduler.  If a little deeper, the process is the executable code that is part of the application or service.  In fact, the process consists of a series of instructions that the computer performs when doing this or that work, whether watching cats or something more serious. <br><br>  These instructions are handled by the central processor, also known as the CPU.  On modern computers, CPUs, as a rule, consist of several processors, which are called cores. <br><br>  By default, the scheduler treats each processor core as one of the execution modules, to which it assigns new processes as they appear.  In this case, the scheduler tries to more or less evenly distribute the emerging processes between the cores, taking into account the load.  Unfortunately, the scheduler cannot say that this particular process will eventually generate a whole group of processes, and this group will have to be performed in isolation from other processes, in the sense that they should not have common processor cores. <br><br>  Therefore, we need to somehow tell the planner so that he does not touch a part of the processor cores, that is, do not give them any processes.  And then we ourselves (or with the help of some other process) will forcibly plant on these processes, which we consider necessary, isolated from the kernel scheduler.  This can be done using the isolcpus parameter in the kernel boot line in the grub configuration file.  In the example below, we have a machine with four cores, on which there are two grub files: one is in / etc / default and is called grub.noiso (this is a backup copy of the default configuration), and the second is in the same place and is called just grub, so that picked up grub2-mkconfig.  This second file is edited to isolate kernels 1-3 from the process scheduler. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lx/ch/jj/lxchjjgcltehlxpbltbyfr5xark.png"></div><br>  ATTENTION: in Red Hat Enterprise Linux 7, you never need to manually modify the grub.conf file in the / boot folder.  Instead, make the necessary changes to / etc / default / grub and then rebuild the grub.conf file using an appropriate utility, for example: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/w8/au/gp/w8augp_6vfuutouvjdv8imw5way.png"></div><br>  When using the isolcpus parameter, you need to list the released processor cores separated by commas, the numbering starts from 0. After the system is rebooted, the process scheduler will not use these cores for anything, except for certain system-level processes that MUST BE on each core.  To check if our method worked, let's run several load processes and then look at loading each kernel using the top command. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/y_/0u/qh/y_0uqhre8j6tbm4mvaef0tdctms.png"></div><br>  As you can see, all the load processes sat on CPU 0, instead of being evenly distributed across all four cores.  So, we have entered the boot parameter correctly. <br><br><h3>  Bind processes to kernels with cpuset </h3><br>  Now we turn to the things that <b>are better not to do, if you don‚Äôt understand why you are doing this, and also which are better to deploy in production only after thorough testing</b> . <br><br>  Why these warnings?  In addition, what we are going to do is, in general, simple things using the libcgroup toolkit, which we wrote about in the last post.  If you remember, this is just a set of commands for creating, modifying and destroying cgroups groups.  Generally, they are part of Red Hat Enterprise Linux 6, but they can be installed on Red Hat Enterprise Linux 7, although it is possible that this possibility will disappear in the future.  In brief, let us recall the main recommendations for using libcgroup: <br><br><ol><li>  Use systemd to control those cgroup controllers that are controlled by systemd itself (this is the CPU, memory, and block I / O). </li><li>  Use the libcgroup tools to manage all other cgroup controller controls. </li><li>  Be very careful about the unintended consequences of your actions. </li></ol><br>  With the concept of cpuset, everything is simple - this is a list of processor cores (numbering, we recall, starts from 0), accepting tasks that will be executed ONLY on these cores.  These are the most common processor cores, they can either be under the control of the process scheduler (this is how the system is configured by default), or, conversely, can be isolated from the scheduler (as we did in the example above). <br><br>  Let's check the / sys / fs / cgroup filesystem directory on the system from our example.  As you can see, the cpuset directory already exists, since this controller is part of the kernel (although it is not under systemd control).  However, there are no cgroups in it yet, so we see in this directory only the default settings. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yp/wy/md/ypwymdstnktxg_kjxosbhx1ilsa.png"></div><br>  Check that the libcgroup toolbox is installed on our machine: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/vn/rn/oh/vnrnoheqhc2xzziafvhnbfx1f2o.png"></div><br>  If not installed, it is easy to fix with the command yum install libcgroup, even a reboot is not needed. <br><br>  Now create cpuset.  To do this, we will use the following commands to create a new cgroup for cpuset and set its properties: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bx/mv/kn/bxmvknuvxcxadwvboxizn__0hcg.png"></div><br>  The Cgcreate command creates a cgroup named testset and places it inside the cpuset controller.  Then we assign the third core of our VM to this new cpuset and allocate NUMA zone 0 to it. Even if your system does not use NUMA (and ours just does not use), you still need to prescribe the zone, otherwise you will not be able to assign tasks to the cgroup group .  Now let's check that the testset directory has been created in the file system, and see what is inside it. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ts/uu/ow/tsuuowh_2c5fsqu3hulepjgwtb0.png"></div><br>  As you can see, our changes are in place, but no process is running on this cpuset yet.  How to put some process here? <br><br>  This can be done in several ways: <br><br><ul><li>  You can drive the PID of an existing process into the tasks file.  It works, but not very beautiful. </li><li>  You can use cgexec and specify a group when starting the process.  This works if the application is not a daemon;  In addition, all this can be beautifully prescribed in the application launch script. </li><li>  For an application that runs as a daemon running systemd, you can create a service file. </li></ul><br>  Let's see the cgexec version. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/-w/ha/1y/-wha1yvoitn2e7-r_mlaqlunr-a.png"></div><br>  We launched foo.exe, it in turn launched a child process, which only does what actively loads the processor.  The --sticky option in the cgexec command says that "any child process must remain in the same cgroup as the parent process."  So this is an important option, and it must be remembered.  Now we see that there are two processes in our cgroup, and we know their PIDs.  We look top: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tr/x5/83/trx583ix3zsq-c6gawy27bmxibq.png"></div><br>  As you can see, CPU 3 is now loaded to capacity, and the rest are cooled. <br><br>  And this is what a unit file looks like for running the same application as a systemd service: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kx/wn/hv/kxwnhvb_6gwemks5fsoeoi37zpy.png"></div><br>  In the unit file there are three ExecStartPre commands that perform the settings that we have already managed to do with our hands.  Then comes the ExecStart command, which launches the application.  And when the application is stopped, the ExecStopPost command cleans up after itself, removing the cgroup. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/p2/wy/iw/p2wyiwogovccla42as0jpvwdemk.png"></div><br>  As you can see, in the last example we created a new cgroup named set1.  We did this to show that you can have several active cgroups that share the same CPU.  To whom it may seem useful, but to confuse someone else. <br><br>  Well, does it work?  It looks like yes! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pu/8x/7j/pu8x7jr-xhhtk6vayzkfqr0gcou.png"></div><br>  And now we finish the work of our service and check that the cgroup has been destroyed: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cd/qm/et/cdqmetsjwaodwhutwl5okmwob08.png"></div><br>  ATTENTION: cgroup groups created with cgcreate are not saved after a reboot.  Therefore, the creation of such groups should be prescribed in startup scripts and unit files. <br><br>  So now in your arsenal there are a couple more tools for working with cgroups.  We hope they come in handy! <br><br>  Other posts on cgroups from our series ‚ÄúFight for resources‚Äù are available at the links: <br><br><ul><li>  <a href="https://habr.com/company/redhatrussia/blog/423051/">Part 1</a> </li><li>  <a href="https://habr.com/company/redhatrussia/blog/424367/">Part 2</a> </li><li>  <a href="https://habr.com/company/redhatrussia/blog/425803/">Part 3</a> </li><li>  <a href="https://habr.com/company/redhatrussia/blog/427413/">Part 4</a> </li><li>  <a href="https://habr.com/company/redhatrussia/blog/429064/">Part 5</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/430748/">https://habr.com/ru/post/430748/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../430734/index.html">Smart updates against smart contracts</a></li>
<li><a href="../430736/index.html">We develop your browser from scratch. Part One: HTML</a></li>
<li><a href="../430738/index.html">Be a security ninja: secret level</a></li>
<li><a href="../430740/index.html">How to milk cows with robots and make an industrial startup on this. R-sept history</a></li>
<li><a href="../430742/index.html">Student Olympiad "I am a professional": the direction of "Programming and Information Technology"</a></li>
<li><a href="../430750/index.html">Quantum Checkers - make checkers great again</a></li>
<li><a href="../430752/index.html">DEV Labs 2018. Online MAP for web developers. December 1st</a></li>
<li><a href="../430754/index.html">Add depth to 2D sprites using hand-drawn normal maps</a></li>
<li><a href="../430756/index.html">Making a WX-Mouse in the Nova Slider 600</a></li>
<li><a href="../430762/index.html">How to choose a UPS to optimize costs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>