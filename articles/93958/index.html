<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Data acquisition, part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the advantages of a general reduction in the cost of equipment and the Internet is that the collection of information from various sources on t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Data acquisition, part 1</h1><div class="post__text post__text-html js-mediator-article">  One of the advantages of a general reduction in the cost of equipment and the Internet is that the collection of information from various sources on the Internet costs almost nothing and can be done without any problems.  The task of obtaining and processing large amounts of data is commercially attractive due to the demand for reading (‚Äúscrapping‚Äù) of websites by customers (usually described by the term 'social media analysis', ie social media analysis).  Well, in principle, it is quite interesting - at least compared to the routine development of sites, reports, etc. <br><br>  In this article I will start a story about how you can implement data collection and processing using the .Net platform.  It would be interesting to hear about how to do the same thing in the Java stack, so if someone wants to join this article as a collaborator, you are welcome. <br><br><a name="habracut"></a><br>  All sources are here: <a href="http://bitbucket.org/nesteruk/datagatheringdemos">http://bitbucket.org/nesteruk/datagatheringdemos</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="http://nesteruk.org/pix/18/hd0.jpg" alt="Task Overview" width="110" height="19"><br>  So, we probably have the most "blurry" of the possible tasks - receiving, processing and storing data.  To get a working system, we need to know <br><br><ul><li>  Where are the data and how to properly access it </li><li>  How to process data to get only what you need </li><li>  Where and how to store data </li></ul><br><br><br><img src="http://nesteruk.org/pix/18/hd1.jpg" alt="Data sources" width="155" height="17"><br>  Let's look at the data sources from which you need to receive information: <br><br><ul><li>  Forums </li><li>  Twitter </li><li>  Blogs </li><li>  News sites </li><li>  Catalogs, Listings </li><li>  Public Web Services </li><li>  Application Software </li></ul><br>  Just want to emphasize that the web browser is not the only source of data.  However, if working with web services or, say, using the API of a social platform, is a fairly understandable task and does not require a lot of body movements, parsing HTML is much more difficult.  And HTML is not the limit - sometimes you have to parse JavaScript or even visual information from images (for example, to bypass the "captcha"). <br><br>  Another problem is that sometimes the content is loaded dynamically via AJAX, which makes it necessary for different kinds of state accounting to get the content exactly when it is available. <br><br><img src="http://nesteruk.org/pix/18/hd2.jpg" alt="Data processing" width="155" height="19"><br>  Data processing is the most time-consuming and expensive (from the point of view of a potential customer) operation.  On the one hand, it may seem that the same HTML should be very easy to understand by existing means, but in fact it is not.  Firstly, HTML in most cases is not XHTML, in other words, by making <code>XElement.Parse()</code> you simply get an exception.  Therefore, you must at least be able to "correct" poorly written HTML. <br><br>  Even with well-formed data, you will still have a lot of problems - after all, any more or less complex web page is a projection of the multidimensional structure of the database owner on a one-dimensional space.  The restoration of relationships and dependencies is thus a necessary task for storing the obtained information in relational databases. <br><br>  We should not forget about more "down to earth" data processing, that is, some transformations or arbitrary actions on the data obtained.  For example, if you receive an IP address, you will want to know the location or availability of a web server at this address, which will require additional requests.  Or, say, when you receive new data, you need to constantly recalculate the moving average (streaming OLAP). <br><br><img src="http://nesteruk.org/pix/18/hd3.jpg" alt="Data storage" width="147" height="18"><br>  After receiving the data, they need to be stored somewhere.  There are a lot of storage options - using serialization, text files, as well as object-oriented and document-oriented as well as of course relational databases.  The choice of storage in a commercial order most likely depends on either the customer (‚Äúwe want MySQL‚Äù) or the financial preferences of the customer.  In .Net development, the default database is SQL Server Express.  If you are making a repository for yourself, you can use anything you want - be it MongoDB, db4o or, for example, SQL Server 2008R2 Datacenter Edition. <br><br>  In most cases, data warehouses do not require special complexity, since  users simply project the database into Excel (or <a href="http://en.wikipedia.org/wiki/SPSS">SPSS</a> , SAS, etc.) and then use familiar methods for analysis.  Options like SSAS (SQL Server Analysis Services) are used much less often (due to the minimum price tag of $ 7,500 - see <a href="http://www.microsoft.com/sqlserver/2008/en/us/R2-editions.aspx">here</a> ), but it‚Äôs also worth knowing about them. <br><br><img src="http://nesteruk.org/pix/18/hd4.jpg" alt="Small example" width="161" height="19"><br>  Let's look at the minimum piece of code that will help us download and ‚Äúparse‚Äù the page.  For these tasks, we will use two packages: <br><br><ul><li>  <a href="http://watin.sourceforge.net/">WatiN</a> is a library for testing web interfaces.  Its good to use for automated pressing buttons, select items from the list, and similar things.  WatiN also provides the object model of the captured page, but I would not use it.  The reason is generally the same - WatiN is an unstable and quite capricious library, which should be used with caution (only in 32-bit mode!) To control the browser. </li><li>  <a href="http://htmlagilitypack.codeplex.com/">HTML Agility Pack</a> - a library for parsing HTML.  HTML itself can be taken from WatiN, downloaded, and even if it is poorly formed, the Agility Pack will allow you to search and select it using XPath. </li></ul><br>  Here is a minimal example of how you can use these two frameworks together to get a page from the site: <br><br><blockquote> <code><img src="http://nesteruk.org/pix/18/ff101.jpg" align="right"> <font color="black">[STAThread]&lt;br/&gt; <br> <font color="#00008B">static</font> <font color="#00008B">void</font> Main()&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#00008B">using</font> ( <font color="#00008B">var</font> browser = <font color="#00008B">new</font> IE( <font color="#A52A2A">"http://www.pokemon.com"</font> ))&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#00008B">var</font> doc = <font color="#00008B">new</font> HtmlDocument();&lt;br/&gt; <br> doc.LoadHtml(browser.Body.OuterHtml);&lt;br/&gt; <br> <font color="#00008B">var</font> h1 = doc.DocumentNode.SelectNodes( <font color="#A52A2A">"//h3"</font> ).First();&lt;br/&gt; <br> Console.WriteLine(h1.InnerText);&lt;br/&gt; <br> }&lt;br/&gt; <br> Console.ReadKey();&lt;br/&gt; <br> }&lt;br/&gt; <br></font></code> </blockquote><br>  In the example above, we got the page through WatiN, loaded the body of the page into the HTML Agility Pack, found the first element of the <code>H3</code> type and wrote out its contents to the console. <br><br><img src="http://nesteruk.org/pix/18/hd5.jpg" alt="Polling" width="70" height="14"><br>  Probably it is obvious to you that writing data to some storage is not done from a console application.  In most cases, the service (windows service) is used for this.  And what the service does is in most cases polling, that is, the regular download of the resource and the update of our understanding of it.  Downloading usually occurs at intervals of N minutes / hours / days. <br><br><blockquote> <code><img src="http://nesteruk.org/pix/18/ff102.jpg" align="right"> <font color="black"><font color="#00008B">public</font> <font color="#00008B">partial</font> <font color="#00008B">class</font> PollingService : ServiceBase&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#00008B">private</font> <font color="#00008B">readonly</font> Thread workerThread;&lt;br/&gt; <br> <font color="#00008B">public</font> PollingService()&lt;br/&gt; <br> {&lt;br/&gt; <br> InitializeComponent();&lt;br/&gt; <br> workerThread = <font color="#00008B">new</font> Thread(DoWork);&lt;br/&gt; <br> workerThread.SetApartmentState(ApartmentState.STA);&lt;br/&gt; <br> }&lt;br/&gt; <br> <font color="#00008B">protected</font> <font color="#00008B">override</font> <font color="#00008B">void</font> OnStart( <font color="#00008B">string</font> [] args)&lt;br/&gt; <br> {&lt;br/&gt; <br> workerThread.Start();&lt;br/&gt; <br> }&lt;br/&gt; <br> <font color="#00008B">protected</font> <font color="#00008B">override</font> <font color="#00008B">void</font> OnStop()&lt;br/&gt; <br> {&lt;br/&gt; <br> workerThread.Abort();&lt;br/&gt; <br> }&lt;br/&gt; <br> <font color="#00008B">private</font> <font color="#00008B">static</font> <font color="#00008B">void</font> DoWork()&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#00008B">while</font> ( <font color="#00008B">true</font> )&lt;br/&gt; <br> {&lt;br/&gt; <br> log.Info( <font color="#A52A2A">"Doing work‚ãÆ"</font> );&lt;br/&gt; <br> <font color="#006400">// do some work, then</font> <br> Thread.Sleep(1000);&lt;br/&gt; <br> }&lt;br/&gt; <br> }&lt;br/&gt; <br> }&lt;br/&gt; <br></font></code> </blockquote><br>  For the good behavior of the service you need a few more useful chips.  First, it is useful to add the ability to start from the console to the services.  This helps with debugging. <br><br><blockquote> <code><img src="http://nesteruk.org/pix/18/ff103.jpg" align="right"> <font color="black"><font color="#00008B">var</font> service = <font color="#00008B">new</font> PollingService();&lt;br/&gt; <br> ServiceBase[] servicesToRun = <font color="#00008B">new</font> ServiceBase[] { service };&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#00008B">if</font> (Environment.UserInteractive)&lt;br/&gt; <br> {&lt;br/&gt; <br> Console.CancelKeyPress += (x, y) =&gt; service.Stop();&lt;br/&gt; <br> service.Start();&lt;br/&gt; <br> Console.WriteLine( <font color="#A52A2A">"Running service, press a key to stop"</font> );&lt;br/&gt; <br> Console.ReadKey();&lt;br/&gt; <br> service.Stop();&lt;br/&gt; <br> Console.WriteLine( <font color="#A52A2A">"Service stopped. Goodbye."</font> );&lt;br/&gt; <br> }&lt;br/&gt; <br> <font color="#00008B">else</font> &lt;br/&gt; <br> {&lt;br/&gt; <br> ServiceBase.Run(servicesToRun);&lt;br/&gt; <br> }&lt;br/&gt; <br></font></code> </blockquote><br>  Another useful feature is self-registration, so that instead of using <code>installutil</code> you can install the service through <code>myservice /i</code> .  For this there is a separate class ... <br><br><blockquote> <code><img src="http://nesteruk.org/pix/18/ff104.jpg" align="right"> <font color="black"><font color="#00008B">class</font> ServiceInstallerUtility&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#00008B">private</font> <font color="#00008B">static</font> <font color="#00008B">readonly</font> ILog log = &lt;br/&gt; <br> LogManager.GetLogger( <font color="#00008B">typeof</font> (Program));&lt;br/&gt; <br> <font color="#00008B">private</font> <font color="#00008B">static</font> <font color="#00008B">readonly</font> <font color="#00008B">string</font> exePath = &lt;br/&gt; <br> Assembly.GetExecutingAssembly().Location;&lt;br/&gt; <br> <font color="#00008B">public</font> <font color="#00008B">static</font> <font color="#00008B">bool</font> Install()&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#00008B">try</font> { ManagedInstallerClass.InstallHelper( <font color="#00008B">new</font> [] { exePath }); }&lt;br/&gt; <br> <font color="#00008B">catch</font> { <font color="#00008B">return</font> <font color="#00008B">false</font> ; }&lt;br/&gt; <br> <font color="#00008B">return</font> <font color="#00008B">true</font> ;&lt;br/&gt; <br> }&lt;br/&gt; <br> <font color="#00008B">public</font> <font color="#00008B">static</font> <font color="#00008B">bool</font> Uninstall()&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#00008B">try</font> { ManagedInstallerClass.InstallHelper( <font color="#00008B">new</font> [] { <font color="#A52A2A">"/u"</font> , exePath }); }&lt;br/&gt; <br> <font color="#00008B">catch</font> { <font color="#00008B">return</font> <font color="#00008B">false</font> ; }&lt;br/&gt; <br> <font color="#00008B">return</font> <font color="#00008B">true</font> ;&lt;br/&gt; <br> }&lt;br/&gt; <br> }&lt;br/&gt; <br></font></code> </blockquote><br>  The installation class uses the little-known <code>System.Configuration.Install</code> assembly.  It is used directly from <code>Main()</code> : <br><br><blockquote> <code><img src="http://nesteruk.org/pix/18/ff105.jpg" align="right"> <font color="black"><font color="#00008B">if</font> (args != <font color="#00008B">null</font> &amp;&amp; args.Length == 1 &amp;&amp; args[0].Length &gt; 1&lt;br/&gt; <br> &amp;&amp; (args[0][0] == <font color="#A52A2A">'-'</font> || args[0][0] == <font color="#A52A2A">'/'</font> ))&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#00008B">switch</font> (args[0].Substring(1).ToLower())&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#00008B">case</font> <font color="#A52A2A">"install"</font> :&lt;br/&gt; <br> <font color="#00008B">case</font> <font color="#A52A2A">"i"</font> :&lt;br/&gt; <br> <font color="#00008B">if</font> (!ServiceInstallerUtility.Install())&lt;br/&gt; <br> Console.WriteLine( <font color="#A52A2A">"Failed to install service"</font> );&lt;br/&gt; <br> <font color="#00008B">break</font> ;&lt;br/&gt; <br> <font color="#00008B">case</font> <font color="#A52A2A">"uninstall"</font> :&lt;br/&gt; <br> <font color="#00008B">case</font> <font color="#A52A2A">"u"</font> :&lt;br/&gt; <br> <font color="#00008B">if</font> (!ServiceInstallerUtility.Uninstall())&lt;br/&gt; <br> Console.WriteLine( <font color="#A52A2A">"Failed to uninstall service"</font> );&lt;br/&gt; <br> <font color="#00008B">break</font> ;&lt;br/&gt; <br> <font color="#00008B">default</font> :&lt;br/&gt; <br> Console.WriteLine( <font color="#A52A2A">"Unrecognized parameters."</font> );&lt;br/&gt; <br> <font color="#00008B">break</font> ;&lt;br/&gt; <br> }&lt;br/&gt; <br> }&lt;br/&gt; <br></font></code> </blockquote><br>  Well, the last feature is of course the use of logging.  I use the <a href="http://logging.apache.org/log4net/download.html">log4net</a> library, and to write logs to the console you can use a very tasty feature called <code>ColoredConsoleAppender</code> .  The logging process itself is primitive. <br><br><img src="http://nesteruk.org/pix/18/hd6.jpg" alt="Some important rules" width="220" height="18"><br>  For the first time enough information.  By the end I want to remind a few simple rules: <br><br><ul><li>  Running IE requires a single-thread apartment;  I really use FireFox.  i like <a href="http://getfirebug.com/">firebug</a> </li><li>  WatiN should be executed in a 32-bit program (x86) </li><li>  Polling, given above, is not ideal, because  does not take into account the fact that in itself WatiN protrusive and HTML parsing is also a slow operation </li></ul><br>  Speaking of birds ... instead of a service, you can basically make an EXE and run it through a sheduler.  But it is somehow untidy. <br><br>  Thanks for attention.  To be continued :) </div><p>Source: <a href="https://habr.com/ru/post/93958/">https://habr.com/ru/post/93958/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../93950/index.html">The App Store has fully earned the gift giving functionality.</a></li>
<li><a href="../93951/index.html">Facebook launches free mobile site</a></li>
<li><a href="../93954/index.html">Spring update</a></li>
<li><a href="../93956/index.html">Microsoft legalizes beta testing of patches</a></li>
<li><a href="../93957/index.html">Results of a meeting with the technical director of the SharePoint Development Group (Arpan Shah, Microsoft)</a></li>
<li><a href="../93959/index.html">Palm Pre - use experience</a></li>
<li><a href="../93960/index.html">Microsoft Sharepoint Conference 2010 Attendance Report</a></li>
<li><a href="../93962/index.html">nic.ru + spb.ru, reverse</a></li>
<li><a href="../93963/index.html">Choice of colocation in Novosibirsk</a></li>
<li><a href="../93969/index.html">New Google Keyboard: epic fail or joke?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>