<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Structure attachments to list items in Sharepoint 2010</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day to all! 

 In Sharepoint 2010 there are many standard types of site columns, but at least two important ones, in my opinion, are missing. Per...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Structure attachments to list items in Sharepoint 2010</h1><div class="post__text post__text-html js-mediator-article">  Good day to all! <br><br>  In Sharepoint 2010 there are many standard types of site columns, but at least two important ones, in my opinion, are missing.  Perhaps the developers have left the "field" for extensions from third-party companies.  But we "ourselves with a mustache" =) <br><br>  Missing out of the box columns are of the type time and file type.  For a date type column, you can select either a date with time, or a single date.  But only the time in the column can not be stored.  Implementing a control to edit two drop-down lists with possible values ‚Äã‚Äãfor hours and minutes does not seem to be a very interesting task.  Therefore, under the cat, the implementation of the file type field is <b>SPFileField</b> , which can also be used as a brief instruction on creating your own column types for Sharepoint 2010. The solution allows you to add new type columns to the Sharepoint lists and load files into them via automatically generated forms.  At the same time, the files and information about them are ‚Äúlaid out‚Äù in different fields: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/5f0/f9b/0b8/5f0f9b0b8e4f49afbe7e1139547e91bd.png"></div><br><a name="habracut"></a><br>  In general, the task looks like this: the user wants to create list items and attach files to them, and the attached files need to be expanded into different columns depending on their purpose (for example, technical task, payment contract, details, etc.) and display links to download them to other users.  The idea of ‚Äã‚Äãimplementation is as follows: store all files in the document library, and in the list there is only a link to the desired file from the library.  The user should show the link for downloading / deleting / replacing the file (if any) and the form for adding a new file to the document library.  When saving, process changes made on the client and, if necessary, update the document library. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Having looked now at the set of languages ‚Äã‚Äãand technologies involved in this implementation, it can not but rejoice that they are all represented in Visual Studio.  Creating a fully working version required a description of the column type in XML, encoding of field logic and related controls in C #, client logic in JavaScript, description of the appearance of controls in ASCX and its style in CSS, as well as a pair of triggers, again in C #.  Now about everything in order ... <br><br><h4>  XML column type description </h4><br>  To describe your own type of column, the first thing you need to do (after creating a project, of course) is to add a Sharepoint Mapped Folder to your project called XML.  This can be done from the context menu of the project (the XML folder is located in the Template folder): <br><div style="text-align:center;"><img src="https://habrastorage.org/files/f8d/e24/361/f8de24361f5446fc9ae6bcabfac3d998.png"></div><br>  You can immediately add the following directories: Template / CONTROLTEMPLATES, Template / LAYOUTS / STYLES, Template / LAYOUTS / XSL.  Here's what I got: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/319/ccd/63d/319ccd63d2654ae7b79bd27b775dfc70.png"></div><br>  In order to define a new type of Sharepoint column, you need to add a new file of the appropriate extension to the XML folder.  This file defines the properties of a new type, such as the name of the column type, the path to the class that describes the behavior, a list of additional properties that the user can set when creating the column, etc. <br><div class="spoiler">  <b class="spoiler_title">fldtypes_SPFileField.xml</b> <div class="spoiler_text"><pre><code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--     ,      --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FieldTypes</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--   --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FieldType</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--       CAML--&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TypeName"</span></span></span><span class="hljs-tag">&gt;</span></span>SPFileField<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--    ( /custom-) --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ParentType"</span></span></span><span class="hljs-tag">&gt;</span></span>Text<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--      SharePoint --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TypeDisplayName"</span></span></span><span class="hljs-tag">&gt;</span></span>SPFileField<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--       --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TypeShortDescription"</span></span></span><span class="hljs-tag">&gt;</span></span>SPFileField<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--     --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UserCreatable"</span></span></span><span class="hljs-tag">&gt;</span></span>TRUE<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- ,      --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ShowOnListCreate"</span></span></span><span class="hljs-tag">&gt;</span></span>TRUE<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ShowOnSurveyCreate"</span></span></span><span class="hljs-tag">&gt;</span></span>TRUE<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ShowOnDocumentLibraryCreate"</span></span></span><span class="hljs-tag">&gt;</span></span>TRUE<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ShowOnColumnTemplateCreate"</span></span></span><span class="hljs-tag">&gt;</span></span>TRUE<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--,            --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Sortable"</span></span></span><span class="hljs-tag">&gt;</span></span>FALSE<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Filterable"</span></span></span><span class="hljs-tag">&gt;</span></span>FALSE<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--         ,        (Text) --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"AllowBaseTypeRendering"</span></span></span><span class="hljs-tag">&gt;</span></span>TRUE<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--   ( )   --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"FieldTypeClass"</span></span></span><span class="hljs-tag">&gt;</span></span>SPFileFieldControl.SPFileField, $SharePoint.Project.AssemblyFullName$<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- ,       . --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertySchema</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Fields</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--      ,      ,   ,       --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"LibraryName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">DisplayName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" "</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Required</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TRUE"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Fields</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertySchema</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FieldType</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FieldTypes</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br>  More details can be found <a href="http://msdn.microsoft.com/en-us/library/office/ff407271%2528v%3Doffice.15%2529.aspx">here</a> and further on the links.  For testing, we will create a list ( <b>TestList</b> ) and a document library ( <b>TestLibrary</b> ).  After the solution is deployed in its current form, the SPFileField column can be added to the TestList list (as well as to any other): <br><div style="text-align:center;"><img src="https://habrastorage.org/files/ec1/c26/d8b/ec1c26d8b6d14bbcb30269b0ec32fc25.png"></div><br>  It is not necessary to activate anything, since the custom type does not count as a feature.  If suddenly a new column type does not appear, restart IIS.  After adding the SPFileField column, an error will pop up, since the specified type SPFileFieldControl.SPFileField was not found in the assembly.  We will correct this by adding the file SPFileField.cs to the project, which will contain the description of the class of the new column (SPFileField), value class (FileValue) and control (SPFileFieldControl) responsible for displaying and editing. <br><br><h4>  C # Server Logic </h4><br>  <b>FileValue is</b> inherited from SPFieldMultiColumnValue and is programmed to store 3 properties: a file name, a file path and a unique file ID.  SPFieldMultiColumnValue allows you to store these values ‚Äã‚Äãin a single line through the separator ' <b>; #</b> ' and provides access to them through an indexer.  The code is hidden under the spoiler, but <s>here</s> and further commented quite well. <br><div class="spoiler">  <b class="spoiler_title">Filevalue</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">FileValue</span></span> : <span class="hljs-title"><span class="hljs-title">SPFieldMultiColumnValue</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c_PropNumber = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FileValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">c_PropNumber</span></span></span><span class="hljs-function">)</span></span> {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FileValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> {} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Url { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>[<span class="hljs-number"><span class="hljs-number">1</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Guid _UniqueID = Guid.Empty; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Guid UniqueID { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_UniqueID == Guid.Empty) _UniqueID = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Guid(<span class="hljs-keyword"><span class="hljs-keyword">base</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _UniqueID; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { _UniqueID = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.ToString(); } } }</code> </pre></div></div><br>  <b>SPFileField is</b> inherited from SPField, which is the base for Sharepoint list columns.  In the SPFileField class, we will implement the necessary constructors for the parent class, we obtain the LibraryName property described above, and use it when creating the SPFileFieldControl, which will be responsible for displaying controls on the viewing and editing forms. <br><div class="spoiler">  <b class="spoiler_title">SPFileField</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SPFileField</span></span> : <span class="hljs-title"><span class="hljs-title">SPField</span></span> { <span class="hljs-comment"><span class="hljs-comment">//    SPField  public SPFileField(SPFieldCollection fields, string fieldName) : base(fields, fieldName) { } public SPFileField(SPFieldCollection fields, string typeName, string displayName) : base(fields, typeName, displayName) { } public override BaseFieldControl FieldRenderingControl { get { //     string libraryName = Convert.ToString(this.GetCustomProperty("LibraryName")); //         BaseFieldControl ctrl = new SPFileFieldControl(libraryName); ctrl.FieldName = this.InternalName; return ctrl; } } //     FileValue public override object GetFieldValue(string value) { if (String.IsNullOrEmpty(value)) return null; return new FileValue(value); } }</span></span></code> </pre></div></div><br>  And finally, the third class in the SPFileField.cs file is <b>SPFileFieldControl</b> , which describes the logic of the file loading operation.  This class is inherited from BaseFieldControl.  SPFileFieldControl contains a description of the template names that must be used to draw the field on the display and editing forms.  The <b>SetupEditTemplateControls</b> and <b>SetupDisplayTemplateControls functions</b> describe setting up templates depending on whether a file has already been downloaded.  In order not to be limited to one column of the new type SPFileField, the list in the SetupEditTemplateControls function dynamically hooks JavaScript to delete and add files, which use control IDs that go to the client machine. <br><br>  Here is the logic for handling custom changes.  It is described in the overloaded <b>UpdateFieldValueInItem</b> method and consists in the following: if the file was loaded (the ItemFieldValue field is specified), but the hidden field containing its UniqueID is empty, then the linked item from the document library will be deleted.  Also, the linked item is deleted when a new file is loaded.  Initially, there were attempts to replace the file without deleting the library item, but this did not lead to success, since the file type field (File_x0020_Type) for the document library is not updated when overwriting files using the Add method with the parameter overwrite = true. <br><br>  Since there are no two documents with the same name in the same Sharepoint document library (and it does not make sense to require unique names from our users;)), Guid is generated as the name of the new document.  After adding the name is replaced (‚Äúfor beauty‚Äù) by ‚Äúissued‚Äù when creating the element identifier (ID) plus the file name received from the client.  The result is approximately the following: "3-Filename.docx".  When a file is added, information about it is stored in our field (it is in the original TestList list, to which we added an SPFileField column). <br><div class="spoiler">  <b class="spoiler_title">SPFileFieldControl</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SPFileFieldControl</span></span> : <span class="hljs-title"><span class="hljs-title">BaseFieldControl</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ,       private const string fileNotExist = "  "; //      private const string editTemplateName = "SPFileFieldControlEdit"; //      private const string displayTemplateName = "SPFileFieldControlDisplay"; //  ,    public string libraryName; //   Value,     FileValue private FileValue currentFile = null; public override object Value { get { return currentFile; } set { currentFile = (FileValue)value; } } public SPFileFieldControl(string aLibraryName) { libraryName = aLibraryName; } //     protected override void OnInit(EventArgs e) { currentFile = (FileValue)this.ItemFieldValue; base.OnInit(e); } //  ,      protected override string DefaultTemplateName { get { return base.ControlMode == SPControlMode.Display ? displayTemplateName : editTemplateName; } } public override string DisplayTemplateName { get { return displayTemplateName; } } //           protected override void CreateChildControls() { base.CreateChildControls(); if (base.ControlMode == SPControlMode.Display) { SetupDisplayTemplateControls(); } else { SetupEditTemplateControls(); } } //         private void SetupEditTemplateControls() { FileUpload fuDocument = (FileUpload)TemplateContainer.FindControl("fuDocument"); HyperLink aFile = (HyperLink)TemplateContainer.FindControl("aFile"); HiddenField hdFileName = (HiddenField)TemplateContainer.FindControl("hdFileName"); HtmlInputImage btnDelete = (HtmlInputImage)TemplateContainer.FindControl("btnDelete"); HtmlInputImage btnAdd = (HtmlInputImage)TemplateContainer.FindControl("btnAdd"); //          if (currentFile != null) { //      SPWeb web = SPContext.Current.Site.RootWeb; SPList list = web.GetList(SPUrlUtility.CombineUrl(web.ServerRelativeUrl, libraryName)); SPListItem spFileItem = list.GetItemByUniqueId(currentFile.UniqueID); //     aFile.NavigateUrl = SPUrlUtility.CombineUrl(web.ServerRelativeUrl, spFileItem.Url); aFile.Text = currentFile.Name; //      UniqueId  hdFileName.Value = spFileItem.UniqueId.ToString(); } else { //    ,     aFile.Text = fileNotExist; hdFileName.Value = String.Empty; } btnDelete.Attributes.Add("onclick", String.Format(@"clearFileValue('{0}','{1}','{2}','{3}');return false;", aFile.ClientID, fuDocument.ClientID, hdFileName.ClientID, fileNotExist)); btnAdd.Attributes.Add("onclick", String.Format(@"changeDisplay('{0}');return false;", fuDocument.ClientID)); fuDocument.Attributes.Add("onchange",String.Format(@"changeFileName(this,'{0}');return false;", aFile.ClientID)); } //         private void SetupDisplayTemplateControls() { if (currentFile != null) { //      SPWeb web = SPContext.Current.Site.RootWeb; SPList list = web.GetList(SPUrlUtility.CombineUrl(web.ServerRelativeUrl, libraryName)); SPListItem spFileItem = list.GetItemByUniqueId(currentFile.UniqueID); //     HyperLink aFile = (HyperLink)TemplateContainer.FindControl("aFile"); aFile.NavigateUrl = SPUrlUtility.CombineUrl(web.ServerRelativeUrl, spFileItem.Url); aFile.Text = currentFile.Name; } } //      public override void UpdateFieldValueInItem() { //    Page.Validate(); if (Page.IsValid) { // ,     FileUpload fuDocument = (FileUpload)TemplateContainer.FindControl("fuDocument"); HiddenField hdFileName = (HiddenField)TemplateContainer.FindControl("hdFileName"); //       , ,    if (hdFileName.Value == String.Empty &amp;&amp; currentFile != null) { //   deleteFile(); //    currentFile = null; } //        if (fuDocument.HasFile) { SPWeb web = SPContext.Current.Site.RootWeb; SPFolder folder = web.GetFolder(SPUrlUtility.CombineUrl(web.ServerRelativeUrl, libraryName)); //   ,   if (currentFile != null) { deleteFile(); } //        currentFile = addFile(folder, fuDocument); } base.UpdateFieldValueInItem(); } } //   private void deleteFile() { //       UniqueID    SPWeb web = SPContext.Current.Site.RootWeb; SPList list = web.GetList(SPUrlUtility.CombineUrl(web.ServerRelativeUrl, libraryName)); SPListItem spFileItem = list.GetItemByUniqueId(currentFile.UniqueID); spFileItem.Delete(); } //   private FileValue addFile(SPFolder folder, FileUpload fuDocument) { string uniqueName = Guid.NewGuid().ToString(); //     uniqueName SPFile spfile = folder.Files.Add(uniqueName, fuDocument.FileContent,true); //       spfile.Item["BaseName"] = String.Format("{1}-{0}", fuDocument.FileName, spfile.Item.ID); spfile.Item.Update(); return new FileValue() { Url = spfile.Item.Url, UniqueID = spfile.Item.UniqueId, Name = fuDocument.FileName }; } }</span></span></code> </pre></div></div><br><h4>  ASCX Template Description </h4><br>  The resulting solution allows you to successfully create new type of site columns.  However, forms are not shown yet, as Sharepoint cannot detect the rendering templates specified in the SPFileFieldControl class (RenderingTemplate).  They are described in the ascx file in the CONTROLTEMPLATES folder.  To create the corresponding file, add the User Control to the project and delete the automatically generated files with the ascx.cs and ascx.designer.cs extensions.  The file describes two templates: a template for the <b>SPFileFieldControlEdit</b> editing <b>form</b> , consisting of a hyperlink to a file, fields for downloading a new file and add / delete buttons, and a template for the display form <b>SPFileFieldControlDisplay</b> , which contains one hyperlink to a file. <br><div class="spoiler">  <b class="spoiler_title">SPFileFieldControl.ascx</b> <div class="spoiler_text"><pre> <code class="cs hljs"> &lt;%--     --%&gt; &lt;SharePoint:RenderingTemplate ID=<span class="hljs-string"><span class="hljs-string">"SPFileFieldControlEdit"</span></span> runat=<span class="hljs-string"><span class="hljs-string">"server"</span></span>&gt; &lt;Template&gt; &lt;%--  CSS  JS --%&gt; &lt;SharePoint:CssRegistration ID=<span class="hljs-string"><span class="hljs-string">"CssRegistration1"</span></span> name=<span class="hljs-string"><span class="hljs-string">"/_layouts/styles/FileFieldControl.css"</span></span> after=<span class="hljs-string"><span class="hljs-string">"corev4.css"</span></span> runat=<span class="hljs-string"><span class="hljs-string">"server"</span></span>/&gt; &lt;SharePoint:ScriptLink ID=<span class="hljs-string"><span class="hljs-string">"ScriptLink1"</span></span> runat=<span class="hljs-string"><span class="hljs-string">"server"</span></span> Name=<span class="hljs-string"><span class="hljs-string">"FileFieldControl.js"</span></span> Localizable=<span class="hljs-string"><span class="hljs-string">"false"</span></span>/&gt; &lt;%--    --%&gt; &lt;asp:HyperLink ID=<span class="hljs-string"><span class="hljs-string">"aFile"</span></span> runat=<span class="hljs-string"><span class="hljs-string">"server"</span></span> CssClass=<span class="hljs-string"><span class="hljs-string">"ffc-hl"</span></span> EnableViewState=<span class="hljs-string"><span class="hljs-string">"False"</span></span>/&gt; &lt;%--   -     ) --%&gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"image"</span></span> ID=<span class="hljs-string"><span class="hljs-string">"btnDelete"</span></span> runat=<span class="hljs-string"><span class="hljs-string">"server"</span></span> src=<span class="hljs-string"><span class="hljs-string">"/_layouts/images/DELETE.gif"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"delete"</span></span>/&gt; &lt;%--   -  FileUpload --%&gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"image"</span></span> ID=<span class="hljs-string"><span class="hljs-string">"btnAdd"</span></span> runat=<span class="hljs-string"><span class="hljs-string">"server"</span></span> src=<span class="hljs-string"><span class="hljs-string">"/_layouts/images/newrowheader.png"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"add"</span></span>/&gt; &lt;br/&gt; &lt;asp:FileUpload ID=<span class="hljs-string"><span class="hljs-string">"fuDocument"</span></span> runat=<span class="hljs-string"><span class="hljs-string">"server"</span></span> CssClass=<span class="hljs-string"><span class="hljs-string">"ffc-fu"</span></span> /&gt; &lt;%--     UniqueId       --%&gt; &lt;asp:HiddenField runat=<span class="hljs-string"><span class="hljs-string">"server"</span></span> ID=<span class="hljs-string"><span class="hljs-string">"hdFileName"</span></span>/&gt; &lt;/Template&gt; &lt;/SharePoint:RenderingTemplate&gt; &lt;%--     --%&gt; &lt;SharePoint:RenderingTemplate ID=<span class="hljs-string"><span class="hljs-string">"SPFileFieldControlDisplay"</span></span> runat=<span class="hljs-string"><span class="hljs-string">"server"</span></span>&gt; &lt;Template&gt; &lt;%--  CSS --%&gt; &lt;SharePoint:CssRegistration ID=<span class="hljs-string"><span class="hljs-string">"CssRegistration1"</span></span> name=<span class="hljs-string"><span class="hljs-string">"/_layouts/styles/FileFieldControl.css"</span></span> after=<span class="hljs-string"><span class="hljs-string">"corev4.css"</span></span> runat=<span class="hljs-string"><span class="hljs-string">"server"</span></span>/&gt; &lt;%--    --%&gt; &lt;asp:HyperLink ID=<span class="hljs-string"><span class="hljs-string">"aFile"</span></span> runat=<span class="hljs-string"><span class="hljs-string">"server"</span></span> CssClass=<span class="hljs-string"><span class="hljs-string">"ffc-hl"</span></span> EnableViewState=<span class="hljs-string"><span class="hljs-string">"False"</span></span>/&gt; &lt;/Template&gt; &lt;/SharePoint:RenderingTemplate&gt;</code> </pre></div></div><br><h4>  Some JavaScript and CSS </h4><br>  In order for the solution to start working, you need to add a JavaScript file to the project (I added it to the LAYOUTS folder) and describe three functions in it: <b>changeDisplay</b> - show / hide an item by ID, <b>clearFileValue</b> - clear the link to the file, the hidden field and the file upload field, and <b>changeFileName</b> to display the name of the file being uploaded. <br><div class="spoiler">  <b class="spoiler_title">FileFieldControl.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// /    function changeDisplay(id) { var v = document.getElementById(id); if (v.style.display == 'block') //|| v.style.display == '') { v.style.display = 'none'; } else { v.style.display = 'block'; } } //    ,       function clearFileValue(aID, fID, hfId, defText) { var a = document.getElementById(aID); a.innerText = defText; a.removeAttribute("href"); var hf = document.getElementById(hfId); hf.value = ''; var f = document.getElementById(fID); f.outerHTML = f.outerHTML; } //    function changeFileName(oFile, aID) { var a = document.getElementById(aID); var fullPath = oFile.value; if (fullPath) { //           var startIndex = (fullPath.indexOf('\\') &gt;= 0 ? fullPath.lastIndexOf('\\') : fullPath.lastIndexOf('/')); var filename = fullPath.substring(startIndex); if (filename.indexOf('\\') === 0 || filename.indexOf('/') === 0) { filename = filename.substring(1); } a.innerText = filename; } }</span></span></code> </pre></div></div><br>  Well, where without CSS!  Add the FileFieldControl.css file to the STYLES folder, in which we specify the alignment for the hyperlink and that the FileUploader will be <b>hidden</b> by default. <br><div class="spoiler">  <b class="spoiler_title">FileFieldControl.css</b> <div class="spoiler_text"><pre> <code class="css hljs"><span class="hljs-selector-class"><span class="hljs-selector-class">.ffc-hl</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">text-align</span></span>:center; <span class="hljs-attribute"><span class="hljs-attribute">vertical-align</span></span>:top; } <span class="hljs-selector-class"><span class="hljs-selector-class">.ffc-fu</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">margin-top</span></span>: <span class="hljs-number"><span class="hljs-number">3px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">display</span></span>: none; }</code> </pre></div></div><br><h4>  Check! </h4><br>  Stop.  First, it is worth mentioning the features).  I found only one - for the list in which the columns of the new type are added, <b>attachments should be prohibited</b> .  Otherwise, the standard forms generated by Sharepoint try to process the FileUpload control and the error "The list item was saved, but one or more attachments could not be saved." <br><br>  Now check!  Let me remind you that we created the <b>TestList</b> list, added a new type column named <b>TestFile to it</b> , and also added the <b>TestLibrary</b> document <b>library</b> , into which the files should ultimately fall.  After all the work done, the form for creating the elements TestList looks like this: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/d1b/8f4/3f3/d1b8f43f326b432dbc12db61e04091c3.png"></div><br>  When adding a file, our control takes the form: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/4e3/e64/418/4e3e644180d04676bc573b4fa8f58187.png"></div><br>  And this is what the newly created elements look like in the TestList list: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/9ac/6e1/682/9ac6e16826fe49d2aee8db57d20bd806.png"></div><br>  And in the TestLibrary library: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/9b2/e84/c0f/9b2e84c0fee44115809bc284be8a7696.png"></div><br>  SPFileField field on the view form: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/388/db0/fe4/388db0fe4e524bfbada86aa95d8f5165.png"></div><br>  On the edit form: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/d50/39b/b29/d5039bb29b4e4cbd88a93a467f966be4.png"></div><br>  Notice the little cracks in the list item view?  Correctly, by default, the value of FileValue described by us is displayed (file name, path to it, and UniqueID through the separator).  To fix this, you need to turn to XSL. <br><br><h4>  Xsl </h4><br>  As you may have guessed, the XSL file must be added to the folder with the corresponding name.  Be careful - Visual Studio suggests adding an XSLT file after searching for the 'XSL' template.  It is necessary to replace the file extension with the one we need.  It is also worth noting that the file name must begin with <b>'fldtypes_'</b> .  Read more about it <a href="http://msdn.microsoft.com/en-us/library/office/ff606773%2528v%3Doffice.14%2529.aspx">here</a> .  You can also find the standard headers that have been omitted below.  The XSL file itself describes the parsing of the string that contains the name and path to the file, and the output of the resulting hyperlink. <br><div class="spoiler">  <b class="spoiler_title">fldtypes_SPFileField.xsl</b> <div class="spoiler_text"><pre> <code class="xml hljs"> <span class="hljs-comment"><span class="hljs-comment">&lt;!--        SPFileField--&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:template</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">match</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"FieldRef[@FieldType='SPFileField']"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Text_body"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--    --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:param</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"thisNode"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"."</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:variable</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"full"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$thisNode/@*[name()=current()/@Name]"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--    ,      (  UniqueID,    ) --&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- ""      --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:variable</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"substring-before(substring-after($full,';#'),';#')"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:variable</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"url"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"substring-before(substring-after(substring-after($full,';#'),';#'),';#')"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--      --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:element</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"a"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:attribute</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"href"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:value-of</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"concat($RootSiteUrl,'/',$url)"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:attribute</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:value-of</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$name"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:element</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:template</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre></div></div><br>  After deploying a solution with a new XSL file, the TestList list view will look more decent: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/f52/2ed/9c5/f522ed9c5ae9490eb6d9c6adf7bafe75.png"></div><br><br><h4>  EventRecievers </h4><br>  The resulting solution does not provide for deleting files from TestLibrary when deleting elements of the TestList list.  That is, if you delete the newly created elements ('untitled'), then the file 'Microsoft Word.docx document' will remain in the TestLibrary library.  This behavior can be corrected with the help of EventReceivers (the code triggered upon the occurrence of a specific event).  To do this, add an <b>EventReceiver</b> to the project.  I called it ER_OnItemDeleting.  We are interested in events for the elements of the list, namely the moment of deletion of the element (An item is being deleted), since after deletion we will lose the values ‚Äã‚Äãof all the fields, and therefore the file ID. <br><br>  I did not have the necessary list for which it is necessary to handle events, so I chose any and then made corrections manually.  To do this, in the Elements.xml file (inside ER_OnItemDeleting) for the Receivers tag, you must replace the ListTemplateId attribute with a ListUrl with the value Lists / TestList.  You can bind an EventReceiver to a specific list using both ListTemplateId and ListUrl.  The second is easier to learn, so I used it.  The following EventReciever description appeared: <br><div class="spoiler">  <b class="spoiler_title">Elements.xml</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Elements</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/sharepoint/"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Receivers</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ListUrl</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Lists/TestList"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Receiver</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Name</span></span></span><span class="hljs-tag">&gt;</span></span>ER_OnItemDeletingItemDeleting<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Type</span></span></span><span class="hljs-tag">&gt;</span></span>ItemDeleting<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Type</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Assembly</span></span></span><span class="hljs-tag">&gt;</span></span>$SharePoint.Project.AssemblyFullName$<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Assembly</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Class</span></span></span><span class="hljs-tag">&gt;</span></span>SPFileFieldControl.ER_OnItemDeleting.ER_OnItemDeleting<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Class</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SequenceNumber</span></span></span><span class="hljs-tag">&gt;</span></span>10000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SequenceNumber</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Receiver</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Receivers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Elements</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre></div></div><br>  Custom triggers are considered Sharepoint for individual features.  Therefore, after adding an EventReceiver, Feature1 will also be in the project.  To make it easier to navigate later, I re-named the 'Triggers' feature, and in the Title field I added 'SPFileFieldControl Triggers'.  The EventReceiver code itself is not complicated and lies in the fact that we iterate over the fields of the element being deleted in an attempt to find a column of type SPFileField.  If the field is found and the file has been loaded, it is deleted. <br><div class="spoiler">  <b class="spoiler_title">ER_OnItemDeleting.cs</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ER_OnItemDeleting</span></span> : <span class="hljs-title"><span class="hljs-title">SPItemEventReceiver</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ER_OnItemDeletingName = <span class="hljs-string"><span class="hljs-string">"SPFileFieldControl.ER_OnItemDeleting.ER_OnItemDeleting"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> SPFileFieldName = <span class="hljs-string"><span class="hljs-string">"SPFileField"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ItemDeleting</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SPItemEventProperties properties</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//        for (int i = 0; i &lt; properties.ListItem.Fields.Count; i++) { //    SPFileField if (properties.ListItem.Fields[i].TypeAsString == ER_OnItemDeleting.SPFileFieldName) { //     FileValue fileValue = properties.ListItem[properties.ListItem.Fields[i].StaticName] as FileValue; if (fileValue == null) continue; //   SPFile spFile = properties.Web.GetFile(fileValue.UniqueID); spFile.Delete(); } } base.ItemDeleting(properties); } }</span></span></code> </pre></div></div><br>  By publishing a solution, you can make sure that the file from the TestLibrary library is really deleted when necessary (the feature should be <b>activated</b> automatically when the solution is deployed).  But do not manually connect EventReceivers when adding an SPFileField type column to the list!  It turns out that the event of creating a new column can also be traced and processed using EventReceiver.  By analogy with the previous one, we will create a new EventReceiver that keeps track of List Events, such as adding and removing columns (a field was added / a field is being removed).  Here is the <b>final hierarchy of files</b> in a project: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/f19/831/dd7/f19831dd7c454c39953af465f461fed5.png"></div><br>  When developing EventReceivers, it is useful to <a href="http://techtrainingnotes.blogspot.ru/2011/06/sharepoint-which-lists-have-event.html">look at the list of all available ones</a> and <a href="http://blogs.solidq.com/sharepoint/Post.aspx%3FID%3D80">correct them with pens if something is wrong</a> .  Below is the code that executes when adding and deleting columns of type SPFileField.  When adding a column, we connect the above-described EventReceiver to the target list, which deletes the associated files when deleting the list items.  And when deleting, we delete the associated files and, if there are no more SPFileField columns in the list, cancel processing of the OnItemDeleting event. <br><div class="spoiler">  <b class="spoiler_title">ER_OnFileFieldCRUD.cs</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ER_OnFileFieldCRUD</span></span> : <span class="hljs-title"><span class="hljs-title">SPListEventReceiver</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> SPFileFieldName = <span class="hljs-string"><span class="hljs-string">"SPFileField"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FieldAdded</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SPListEventProperties properties</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//    SPFileField,     ,     if (properties.Field.TypeDisplayName == SPFileFieldName) { //   EventReceiver,    bool eventReceiverExists = false; for (int i = 0; i &lt; properties.List.EventReceivers.Count;i++) { if (properties.List.EventReceivers[i].Class == ER_OnItemDeleting.ER_OnItemDeleting.ER_OnItemDeletingName) { eventReceiverExists = true; break; } } if (!eventReceiverExists) { properties.List.EventReceivers.Add(SPEventReceiverType.ItemDeleting, Assembly.GetExecutingAssembly().FullName, ER_OnItemDeleting.ER_OnItemDeleting.ER_OnItemDeletingName); } } base.FieldAdded(properties); } public override void FieldDeleting(SPListEventProperties properties) { if (properties.Field.TypeDisplayName == SPFileFieldName) { //    SPFileField,  // 1)    ,    for (int i = 0; i &lt; properties.List.Items.Count; i++) { SPListItem splistItem = properties.List.Items[i]; FileValue fileValue = splistItem[properties.Field.StaticName] as FileValue; if (fileValue == null) continue; SPFile spFile = properties.Web.GetFile(fileValue.UniqueID); spFile.Delete(); } // ,       SPFileField bool anyFileFieldExist = false; for (int i = 0; i &lt; properties.List.Fields.Count; i++) { if (properties.List.Fields[i].TypeAsString == SPFileFieldName &amp;&amp; properties.List.Fields[i].StaticName != properties.Field.StaticName) { anyFileFieldExist = true; break; } } // 2)   ,      SPFileField if (!anyFileFieldExist) { for (int i = 0; i &lt; properties.List.EventReceivers.Count; ) { if (properties.List.EventReceivers[i].Class == ER_OnItemDeleting.ER_OnItemDeleting.ER_OnItemDeletingName) { properties.List.EventReceivers[i].Delete(); } else { i++; } } } } base.FieldDeleting(properties); } }</span></span></code> </pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At this point, I completed the development of the SPFileField column, although, as they say, ‚Äúthere is no limit to perfection‚Äù. For example, you can handle deleting a file from the document library directly (I don‚Äôt show this library to users) and clear the link to it (FileValue value). Or add a check for the existence of a document library when creating SPFileField columns, etc. In order not to limit you in your desires, I post the </font></font><a href="https://github.com/PetrovSerega/SPFileFieldControl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">source code, as well as a ready-made solution</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h4>  Conclusion </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The resulting solution allows you to create Sharepoint 2010 columns and ‚Äúupload‚Äù files into them. In this case, the downloaded files are not standard attachments, which, after downloading, differ only in name. Files entered into the system through the SPFileField column have a link to a specific column that can be used to create your own View. Thus, the presented approach allows sharing file downloads and displaying information about them at the column level. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An additional advantage is that we are not limited to one SPFileField type column per list, and the SPFileField columns can be configured to upload files to different document libraries (it may be interesting to show the user and the associated document library). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At this I have everything, thank you for your attention!</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I would like to say a special thank you to this </font></font><a href="http://www.ittilan.ru/publications/sharepoint/custom_field_types.php"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">resource</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which describes in some detail the creation of Custom Field Types for Sharepoint 2007. As my experience shows, most of the writing is valid for Sharepoint 2010 as well.</font></font></div><p>Source: <a href="https://habr.com/ru/post/235493/">https://habr.com/ru/post/235493/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../235483/index.html">On the verge of madness</a></li>
<li><a href="../235485/index.html">Yii2 RBAC setup</a></li>
<li><a href="../235487/index.html">How we (almost) defeated DirCrypt</a></li>
<li><a href="../235489/index.html">Apple Update Review Guideline, Redget Statistics and All Reports from the Unity Event - Main Mobile News for the Week</a></li>
<li><a href="../235491/index.html">Do you really need the source code?</a></li>
<li><a href="../235495/index.html">How to buy shares of IT companies before, during and after the IPO</a></li>
<li><a href="../235501/index.html">Asus smart watches at IFA 2014</a></li>
<li><a href="../235503/index.html">HeadHunter 2014 programmers start recruiting</a></li>
<li><a href="../235505/index.html">RabbitMQ - delayed messages</a></li>
<li><a href="../235507/index.html">Hardly ever a telescope will be built</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>