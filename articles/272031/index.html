<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>AllcountJS: Making a system for point of sale (POS)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue our acquaintance with AllcountJS - a framework for rapid application development on the NodeJS platform. In this article, we will look at ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>AllcountJS: Making a system for point of sale (POS)</h1><div class="post__text post__text-html js-mediator-article">  We continue our acquaintance with <a href="https://allcountjs.com/">AllcountJS</a> - a framework for rapid application development on the NodeJS platform.  In this article, we will look at an example of implementing a custom interface using AngualrJS and jade, as well as some configuration options that we have not mentioned yet. <br><br>  POS (Point Of Sale) - in the literal sense of the point (place) of sale, but usually this term refers to the workplace of the cashier, along with commercial equipment.  Such terminals are located in almost every place where we sell something.  And now we will create a simple application that will allow you to maintain a list of products with balances and create sales records. <br><br><img src="https://habrastorage.org/files/323/7be/a9a/3237bea9ace842da947ff037fa7af49f.png" alt="POS main UI">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As usual, the result can be viewed in the <a href="https://allcountjs.com/entity/DemoGallery/5608faa748c663113053d164">demo gallery</a> . <br><a name="habracut"></a><br><h1>  Model and business logic </h1><br>  Let's start with a description of the most important - the positions (goods) that we will sell. <br><pre><code class="javascript hljs">Item: { <span class="hljs-attr"><span class="hljs-attr">fields</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: Fields.text(<span class="hljs-string"><span class="hljs-string">"Name"</span></span>), <span class="hljs-attr"><span class="hljs-attr">stock</span></span>: Fields.integer(<span class="hljs-string"><span class="hljs-string">"Stock"</span></span>).computed(<span class="hljs-string"><span class="hljs-string">'sum(transactions.quantity)'</span></span>), <span class="hljs-attr"><span class="hljs-attr">price</span></span>: Fields.money(<span class="hljs-string"><span class="hljs-string">"Price"</span></span>), <span class="hljs-attr"><span class="hljs-attr">transactions</span></span>: Fields.relation(<span class="hljs-string"><span class="hljs-string">"Transactions"</span></span>, <span class="hljs-string"><span class="hljs-string">"Transaction"</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span>) }, <span class="hljs-attr"><span class="hljs-attr">referenceName</span></span>: <span class="hljs-string"><span class="hljs-string">"name"</span></span> }</code> </pre> <br>  The most interesting thing here is a field with the remnants of stock.  It should <a href="https://allcountjs.com/docs/apps">be calculated</a> automatically by quantity (quantity) from transactions (transactions).  This is exactly what is written in our configuration: the integer stock field is calculated as the sum of transactions for the quantity field.  Only with brackets, dots and quotes.  And the ‚Äútransactions‚Äù field is a list of all transactions in which this position participates. <br><br>  If you read the configuration: ‚Äútransactions‚Äù is a field of ‚Äú <a href="https://allcountjs.com/docs/apps">relation</a> ‚Äù type associated with the currently missing entity ‚ÄúTransaction‚Äù in the field ‚Äúitem‚Äù.  The ‚ÄúreferenceName‚Äù property determines which of the entity fields to display in the names of links leading to this entity. <br><br>  Now we add the Transaction type - transactions describing the arrival and departure of goods. <br><pre> <code class="javascript hljs">Transaction: { <span class="hljs-attr"><span class="hljs-attr">fields</span></span>: { <span class="hljs-attr"><span class="hljs-attr">item</span></span>: Fields.reference(<span class="hljs-string"><span class="hljs-string">"Item"</span></span>, <span class="hljs-string"><span class="hljs-string">"Item"</span></span>), <span class="hljs-attr"><span class="hljs-attr">order</span></span>: Fields.reference(<span class="hljs-string"><span class="hljs-string">"Order"</span></span>, <span class="hljs-string"><span class="hljs-string">"Order"</span></span>), <span class="hljs-attr"><span class="hljs-attr">orderItem</span></span>: Fields.reference(<span class="hljs-string"><span class="hljs-string">"Order item"</span></span>, <span class="hljs-string"><span class="hljs-string">"OrderItem"</span></span>), <span class="hljs-attr"><span class="hljs-attr">quantity</span></span>: Fields.integer(<span class="hljs-string"><span class="hljs-string">"Quantity"</span></span>) }, <span class="hljs-attr"><span class="hljs-attr">showInGrid</span></span>: [<span class="hljs-string"><span class="hljs-string">'item'</span></span>, <span class="hljs-string"><span class="hljs-string">'order'</span></span>, <span class="hljs-string"><span class="hljs-string">'quantity'</span></span>] }</code> </pre><br>  As you can see, the ‚Äúitem‚Äù field refers to the ‚ÄúItem‚Äù entity and supports the connection described above.  Otherwise nothing special except the ‚ÄúshowInGrid‚Äù property - it sets the list of fields that will be displayed in the grid. <br><br>  Next, we describe the central part of our POS: <br><pre> <code class="javascript hljs">Order: { <span class="hljs-attr"><span class="hljs-attr">fields</span></span>: { <span class="hljs-attr"><span class="hljs-attr">number</span></span>: Fields.integer(<span class="hljs-string"><span class="hljs-string">"Order #"</span></span>), <span class="hljs-attr"><span class="hljs-attr">date</span></span>: Fields.date(<span class="hljs-string"><span class="hljs-string">"Date"</span></span>), <span class="hljs-attr"><span class="hljs-attr">total</span></span>: Fields.money(<span class="hljs-string"><span class="hljs-string">"Total"</span></span>).computed(<span class="hljs-string"><span class="hljs-string">'sum(orderItems.finalPrice)'</span></span>), <span class="hljs-attr"><span class="hljs-attr">orderItems</span></span>: Fields.relation(<span class="hljs-string"><span class="hljs-string">"Items"</span></span>, <span class="hljs-string"><span class="hljs-string">"OrderItem"</span></span>, <span class="hljs-string"><span class="hljs-string">"order"</span></span>) }, <span class="hljs-attr"><span class="hljs-attr">beforeSave</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Entity, Dates, Crud</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Entity.date) { Entity.date = Dates.nowDate(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Crud.crudFor(<span class="hljs-string"><span class="hljs-string">'OrderCounter'</span></span>).find({}).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">last</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Entity.number) { Entity.number = last[<span class="hljs-number"><span class="hljs-number">0</span></span>].number; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Crud.crudFor(<span class="hljs-string"><span class="hljs-string">'OrderCounter'</span></span>).updateEntity({<span class="hljs-attr"><span class="hljs-attr">id</span></span>: last[<span class="hljs-number"><span class="hljs-number">0</span></span>].id, <span class="hljs-attr"><span class="hljs-attr">number</span></span>: last[<span class="hljs-number"><span class="hljs-number">0</span></span>].number + <span class="hljs-number"><span class="hljs-number">1</span></span>}); } }) }, <span class="hljs-attr"><span class="hljs-attr">beforeDelete</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Entity, Crud, Q</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> crud = Crud.crudFor(<span class="hljs-string"><span class="hljs-string">'OrderItem'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crud.find({<span class="hljs-attr"><span class="hljs-attr">filtering</span></span>: {<span class="hljs-attr"><span class="hljs-attr">order</span></span>: Entity.id}}).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">items</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Q.all(items.map(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crud.deleteEntity(i.id) })); }); }, <span class="hljs-attr"><span class="hljs-attr">referenceName</span></span>: <span class="hljs-string"><span class="hljs-string">"number"</span></span>, <span class="hljs-attr"><span class="hljs-attr">views</span></span>: { <span class="hljs-attr"><span class="hljs-attr">PointOfSale</span></span>: { <span class="hljs-attr"><span class="hljs-attr">customView</span></span>: <span class="hljs-string"><span class="hljs-string">'pos'</span></span> } } }</code> </pre><br>  I call it central because in it we defined our main view ‚ÄúPointOfSale‚Äù, described in the file ‚Äúpos.jade‚Äù, but we'll touch on it later.  Also, you probably noticed the ‚ÄúbeforeSave‚Äù and ‚ÄúbeforeDelete‚Äù functions.  These are handlers that are triggered when the corresponding events occur: before saving and before deleting.  You can read more about them in our <a href="https://allcountjs.com/docs/apps">documentation</a> in the CRUD hooks section.  Here these functions are needed to update the order counter (order) when the order is completed and to delete order items along with the order itself. <br><br>  Computed and relation fields are also found in this piece of code.  The calculated field is used to calculate the total cost of the order, and the relation field ‚ÄúorderItems‚Äù can be taken as a list of the positions contained in this order.  It is associated with the OrderItem entity: <br><pre> <code class="javascript hljs">OrderItem: { <span class="hljs-attr"><span class="hljs-attr">fields</span></span>: { <span class="hljs-attr"><span class="hljs-attr">order</span></span>: Fields.reference(<span class="hljs-string"><span class="hljs-string">"Order"</span></span>, <span class="hljs-string"><span class="hljs-string">"Order"</span></span>), <span class="hljs-attr"><span class="hljs-attr">item</span></span>: Fields.fixedReference(<span class="hljs-string"><span class="hljs-string">"Item"</span></span>, <span class="hljs-string"><span class="hljs-string">"Item"</span></span>).required(), <span class="hljs-attr"><span class="hljs-attr">quantity</span></span>: Fields.integer(<span class="hljs-string"><span class="hljs-string">"Quantity"</span></span>).required(), <span class="hljs-attr"><span class="hljs-attr">finalPrice</span></span>: Fields.money(<span class="hljs-string"><span class="hljs-string">"Final price"</span></span>).readOnly().addToTotalRow() }, <span class="hljs-attr"><span class="hljs-attr">showInGrid</span></span>: [<span class="hljs-string"><span class="hljs-string">'item'</span></span>, <span class="hljs-string"><span class="hljs-string">'quantity'</span></span>, <span class="hljs-string"><span class="hljs-string">'finalPrice'</span></span>], <span class="hljs-attr"><span class="hljs-attr">beforeSave</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Crud, Entity</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Crud.crudFor(<span class="hljs-string"><span class="hljs-string">'Item'</span></span>).readEntity(Entity.item.id).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">item</span></span></span><span class="hljs-function">) </span></span>{ Entity.finalPrice = Entity.quantity * item.price; }) }, <span class="hljs-attr"><span class="hljs-attr">afterSave</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Crud, Entity</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> crud = Crud.crudForEntityType(<span class="hljs-string"><span class="hljs-string">'Transaction'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> removeTransaction(Crud, Entity).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crud.createEntity({ <span class="hljs-attr"><span class="hljs-attr">order</span></span>: Entity.order, <span class="hljs-attr"><span class="hljs-attr">orderItem</span></span>: {<span class="hljs-attr"><span class="hljs-attr">id</span></span>: Entity.id}, <span class="hljs-attr"><span class="hljs-attr">item</span></span>: Entity.item, <span class="hljs-attr"><span class="hljs-attr">quantity</span></span>: Entity.quantity * <span class="hljs-number"><span class="hljs-number">-1</span></span> }) }) }, <span class="hljs-attr"><span class="hljs-attr">beforeDelete</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Crud, Entity</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> removeTransaction(Crud, Entity); } }</code> </pre><br>  As you may have noticed, every type of entity that participates in fields with links has a ‚ÄúshowInGrid‚Äù property.  It is necessary to show only certain fields of the entity in the grid.  Usually, we don‚Äôt want to show the user a higher entity in relation to it, because it is through her that he came to this view.  But, of course, this can be changed. <br><br>  Pay attention to the final price field - using the .addToTotalRow () call, we marked it for summarizing in the summary line. <br><br>  There are also several CRUD hooks: before saving, we update the total amount of the order item depending on the quantity, after saving, we delete, and re-create a new transaction, and also delete transactions when the order item is deleted.  Following the principle of <a href="https://ru.wikipedia.org/wiki/Don%25E2%2580%2599t_repeat_yourself">DRY</a> , we reuse the function to delete transactions: <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removeTransaction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Crud, Entity</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> crud = Crud.crudForEntityType(<span class="hljs-string"><span class="hljs-string">'Transaction'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crud.find({<span class="hljs-attr"><span class="hljs-attr">filtering</span></span>: {<span class="hljs-attr"><span class="hljs-attr">orderItem</span></span>: Entity.id}}).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">transactions</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (transactions.length) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crud.deleteEntity(transactions[<span class="hljs-number"><span class="hljs-number">0</span></span>].id); } }); }</code> </pre><br>  And for the sequential numbering of orders, we will have an order counter: <br><pre> <code class="javascript hljs">OrderCounter: { <span class="hljs-attr"><span class="hljs-attr">fields</span></span>: { <span class="hljs-attr"><span class="hljs-attr">number</span></span>: Fields.integer(<span class="hljs-string"><span class="hljs-string">"Counter"</span></span>) } }</code> </pre><br><h1>  Main POS Interface </h1><br>  Remember how you struggled with overloaded interfaces.  And as you were probably happy to press just a couple of large color buttons that do all the work.  Our customization capabilities make the interface for work simple and straightforward. <br>  Above, we mentioned that the ‚ÄúPointOfSale‚Äù view is central to the application.  It is the main user experience with the application - the creation of orders.  It is set in the pos.jade file: <br><div class="spoiler">  <b class="spoiler_title">pos.jade</b> <div class="spoiler_text"><pre> <code class="javascript hljs">extends main include mixins block vars - <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hasToolbar = <span class="hljs-literal"><span class="hljs-literal">false</span></span> block content div(ng-app=<span class="hljs-string"><span class="hljs-string">'allcount'</span></span>, ng-controller=<span class="hljs-string"><span class="hljs-string">'EntityViewController'</span></span>) +defaultList() .container.screen-container(ng-cloak) .row(ng-controller=<span class="hljs-string"><span class="hljs-string">"PosController"</span></span>) .col-md<span class="hljs-number"><span class="hljs-number">-8</span></span> .items-bar.row.btn-toolbar(lc-list=<span class="hljs-string"><span class="hljs-string">"'Item'"</span></span>, paging=<span class="hljs-string"><span class="hljs-string">"{}"</span></span>) .col-lg<span class="hljs-number"><span class="hljs-number">-4.</span></span>col-md<span class="hljs-number"><span class="hljs-number">-6.</span></span>col-xs<span class="hljs-number"><span class="hljs-number">-12</span></span>(ng-repeat=<span class="hljs-string"><span class="hljs-string">"item in items"</span></span>) button.btn.btn-lg.btn-block.btn-<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>(ng-click=<span class="hljs-string"><span class="hljs-string">"addItem(item)"</span></span>) p {{item.name}} p {{(item.price / <span class="hljs-number"><span class="hljs-number">100</span></span>) | currency}} .container-fluid h1 Total: {{viewState.editForm.entity().total/<span class="hljs-number"><span class="hljs-number">100</span></span> | currency}} .row.btn-toolbar .col-md<span class="hljs-number"><span class="hljs-number">-4</span></span> button.btn.btn-lg.btn-danger.btn-block(ng-click=<span class="hljs-string"><span class="hljs-string">"deleteEntity()"</span></span>, ng-disabled=<span class="hljs-string"><span class="hljs-string">"!viewState.formEntityId"</span></span>) Cancel .col-md<span class="hljs-number"><span class="hljs-number">-4</span></span>(ng-hide=<span class="hljs-string"><span class="hljs-string">'viewState.isFormEditing'</span></span>) +startFormEditingButton()(ng-disabled=<span class="hljs-string"><span class="hljs-string">"!viewState.formEntityId"</span></span>).btn-block.btn-lg .col-md<span class="hljs-number"><span class="hljs-number">-4</span></span>(ng-show=<span class="hljs-string"><span class="hljs-string">'viewState.isFormEditing'</span></span>) +doneFormEditingButton()(ng-disabled=<span class="hljs-string"><span class="hljs-string">"!viewState.formEntityId"</span></span>).btn-block.btn-lg .col-md<span class="hljs-number"><span class="hljs-number">-4</span></span> button.btn.btn-lg.btn-success.btn-block(ng-click=<span class="hljs-string"><span class="hljs-string">"viewState.mode = 'list'; viewState.formEntityId = undefined"</span></span>, ng-disabled=<span class="hljs-string"><span class="hljs-string">"!viewState.formEntityId"</span></span>) Finish .col-md<span class="hljs-number"><span class="hljs-number">-4</span></span> +defaultEditForm()(ng-show=<span class="hljs-string"><span class="hljs-string">"true"</span></span>) +defaultFormTemplate() block js +entityJs() script. angular.module(<span class="hljs-string"><span class="hljs-string">'allcount'</span></span>).controller(<span class="hljs-string"><span class="hljs-string">'PosController'</span></span>, [<span class="hljs-string"><span class="hljs-string">'$scope'</span></span>, <span class="hljs-string"><span class="hljs-string">'lcApi'</span></span>, <span class="hljs-string"><span class="hljs-string">'$q'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$scope, lcApi, $q</span></span></span><span class="hljs-function">) </span></span>{ $scope.addItem = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">item</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> promise; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$scope.viewState.formEntityId) { promise = lcApi.createEntity({<span class="hljs-attr"><span class="hljs-attr">entityTypeId</span></span>: <span class="hljs-string"><span class="hljs-string">'Order'</span></span>}, {}).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">orderId</span></span></span><span class="hljs-function">) </span></span>{ $scope.navigateTo(orderId) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> orderId; }) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { promise = $q.when($scope.viewState.formEntityId); } promise.then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">orderId</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lcApi.findRange({<span class="hljs-attr"><span class="hljs-attr">entityTypeId</span></span>: <span class="hljs-string"><span class="hljs-string">'OrderItem'</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">filtering</span></span>: {<span class="hljs-attr"><span class="hljs-attr">order</span></span>: orderId}}).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">items</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> existingOrderItem = _.find(items, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> i.item.id === item.id; }) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (existingOrderItem ? lcApi.updateEntity({<span class="hljs-attr"><span class="hljs-attr">entityTypeId</span></span>: <span class="hljs-string"><span class="hljs-string">'OrderItem'</span></span>}, { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: existingOrderItem.id, <span class="hljs-attr"><span class="hljs-attr">quantity</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> + existingOrderItem.quantity }) : lcApi.createEntity({<span class="hljs-attr"><span class="hljs-attr">entityTypeId</span></span>: <span class="hljs-string"><span class="hljs-string">'OrderItem'</span></span>}, { <span class="hljs-attr"><span class="hljs-attr">order</span></span>: {<span class="hljs-attr"><span class="hljs-attr">id</span></span>: orderId}, <span class="hljs-attr"><span class="hljs-attr">item</span></span>: item, <span class="hljs-attr"><span class="hljs-attr">quantity</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> }) ).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $scope.editForm.reloadEntity(); }) }) }) } }]) style. .items-bar .btn-block { margin-bottom: <span class="hljs-number"><span class="hljs-number">10</span></span>px; }</code> </pre><br></div></div><br>  Let's deal with what's going on inside there. <br><br>  At the beginning we see these two lines: <br><pre> <code class="javascript hljs"> extends main include mixins</code> </pre><br>  ‚ÄúMain‚Äù and ‚Äúmixins‚Äù are built-in templates.  The first is the foundation of markup, which is simply indispensable as long as you do not want to do something completely unusual.  The second provides you with separate jade snippets for interface elements, such as: tables, table rows, fields, basements, labels, etc. <br><br>  A couple of words about the blocks inside the ‚Äúmain‚Äù: there are blocks ‚Äúvars‚Äù, ‚Äúcontent‚Äù and ‚Äújs‚Äù, the names of which, in fact, speak for themselves: <br>  ‚ÄúVars‚Äù is located at the top <br>  ‚ÄúHead‚Äù - inside the title <br>  ‚ÄúContent‚Äù is part of the main area of ‚Äã‚Äãthe page. <br>  ‚ÄúJs‚Äù is the last one inside the body of the page. <br><br>  The ‚ÄúhasToolbar‚Äù flag is a variable that determines whether to add a double indent under the navigation bar. <br>  Next we describe our main UI application: <br><pre> <code class="javascript hljs"> div(ng-app=<span class="hljs-string"><span class="hljs-string">'allcount'</span></span>, ng-controller=<span class="hljs-string"><span class="hljs-string">'EntityViewController'</span></span>)</code> </pre> <br>  Note that we must use ‚Äúallcount‚Äù as the name for the application.  This is necessary in order to gain access to the various possibilities of AllacountJS Angular type controllers and directives. <br><br>  ‚Äú+ DefaultList ()‚Äù adds an ‚Äúlc-list‚Äù component that we can use to display list-type interface elements.  But specifically, this ‚Äúlist‚Äù is in the form state and is not displayed as a list, but it gives us the ‚Äúedit‚Äù button, which is needed to edit the current order. <br><pre> <code class="javascript hljs"> .container.screen-container(ng-cloak) .row(ng-controller=<span class="hljs-string"><span class="hljs-string">"PosController"</span></span>)</code> </pre><br>  Here we have a container with a POS controller, which we describe later.  And then we have two columns: <br><pre> <code class="javascript hljs"> .col-md<span class="hljs-number"><span class="hljs-number">-8</span></span> ... .col-md<span class="hljs-number"><span class="hljs-number">-4</span></span> ‚Ä¶</code> </pre><br>  The first (large) column displays a list of available positions: <br><pre> <code class="javascript hljs"> .items-bar.row.btn-toolbar(lc-list=<span class="hljs-string"><span class="hljs-string">"'Item'"</span></span>, paging=<span class="hljs-string"><span class="hljs-string">"{}"</span></span>) .col-lg<span class="hljs-number"><span class="hljs-number">-4.</span></span>col-md<span class="hljs-number"><span class="hljs-number">-6.</span></span>col-xs<span class="hljs-number"><span class="hljs-number">-12</span></span>(ng-repeat=<span class="hljs-string"><span class="hljs-string">"item in items"</span></span>) button.btn.btn-lg.btn-block.btn-<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>(ng-click=<span class="hljs-string"><span class="hljs-string">"addItem(item)"</span></span>) p {{item.name}} p {{(item.price / <span class="hljs-number"><span class="hljs-number">100</span></span>) | currency}}</code> </pre><br>  The attribute lc-list = "'Item'" is a directive and is required to get a list of positions, and the attribute paging = {} says that we do not need paging here. <br><br>  Internal div: <br><pre> <code class="javascript hljs"> .col-lg<span class="hljs-number"><span class="hljs-number">-4.</span></span>col-md<span class="hljs-number"><span class="hljs-number">-6.</span></span>col-xs<span class="hljs-number"><span class="hljs-number">-12</span></span>(ng-repeat=<span class="hljs-string"><span class="hljs-string">"item in items"</span></span>)</code> </pre> <br>  traverses positions using the ‚Äúng-repeat‚Äù directive and displays large buttons for a specific position. <br><img src="https://habrastorage.org/files/4da/cc5/442/4dacc5442de54607853de5e093abaacf.png" alt="item in items"><br>  Under the list of positions - the total amount in the user currency: <br><pre> <code class="javascript hljs"> .container-fluid h1 Total: {{viewState.editForm.entity().total/<span class="hljs-number"><span class="hljs-number">100</span></span> | currency}}</code> </pre><br>  And a line with buttons: <br><pre> <code class="javascript hljs"> .row.btn-toolbar .col-md<span class="hljs-number"><span class="hljs-number">-4</span></span> button.btn.btn-lg.btn-danger.btn-block(ng-click=<span class="hljs-string"><span class="hljs-string">"deleteEntity()"</span></span>, ng-disabled=<span class="hljs-string"><span class="hljs-string">"!viewState.formEntityId"</span></span>) Cancel .col-md<span class="hljs-number"><span class="hljs-number">-4</span></span>(ng-hide=<span class="hljs-string"><span class="hljs-string">'viewState.isFormEditing'</span></span>) +startFormEditingButton()(ng-disabled=<span class="hljs-string"><span class="hljs-string">"!viewState.formEntityId"</span></span>).btn-block.btn-lg .col-md<span class="hljs-number"><span class="hljs-number">-4</span></span>(ng-show=<span class="hljs-string"><span class="hljs-string">'viewState.isFormEditing'</span></span>) +doneFormEditingButton()(ng-disabled=<span class="hljs-string"><span class="hljs-string">"!viewState.formEntityId"</span></span>).btn-block.btn-lg .col-md<span class="hljs-number"><span class="hljs-number">-4</span></span> button.btn.btn-lg.btn-success.btn-block(ng-click=<span class="hljs-string"><span class="hljs-string">"viewState.mode = 'list'; viewState.formEntityId = undefined"</span></span>, ng-disabled=<span class="hljs-string"><span class="hljs-string">"!viewState.formEntityId"</span></span>) Finish</code> </pre><br><img src="https://habrastorage.org/files/fc8/15a/90a/fc815a90a31543bc81db4290d7f74853.png" alt="Total and buttons toolbar"><br>  We also have a snippet from the template on the form for the current order in the right column: <br><pre> <code class="javascript hljs"> +defaultEditForm()(ng-show=<span class="hljs-string"><span class="hljs-string">"true"</span></span>) +defaultFormTemplate()</code> </pre><br><img src="https://habrastorage.org/files/72c/9c2/3d9/72c9c23d9e264c2fa9a1c5bd5b940c3e.png" alt="Edit and form template"><br>  At the end we have such a block with the code: <br><pre> <code class="javascript hljs"> block js +entityJs() script. angular.module(<span class="hljs-string"><span class="hljs-string">'allcount'</span></span>).controller(<span class="hljs-string"><span class="hljs-string">'PosController'</span></span>, [<span class="hljs-string"><span class="hljs-string">'$scope'</span></span>, <span class="hljs-string"><span class="hljs-string">'lcApi'</span></span>, <span class="hljs-string"><span class="hljs-string">'$q'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$scope, lcApi, $q</span></span></span><span class="hljs-function">) </span></span>{ $scope.addItem = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">item</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> promise; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$scope.viewState.formEntityId) { promise = lcApi.createEntity({<span class="hljs-attr"><span class="hljs-attr">entityTypeId</span></span>: <span class="hljs-string"><span class="hljs-string">'Order'</span></span>}, {}).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">orderId</span></span></span><span class="hljs-function">) </span></span>{ $scope.navigateTo(orderId) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> orderId; }) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { promise = $q.when($scope.viewState.formEntityId); } promise.then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">orderId</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lcApi.findRange({<span class="hljs-attr"><span class="hljs-attr">entityTypeId</span></span>: <span class="hljs-string"><span class="hljs-string">'OrderItem'</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">filtering</span></span>: {<span class="hljs-attr"><span class="hljs-attr">order</span></span>: orderId}}).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">items</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> existingOrderItem = _.find(items, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> i.item.id === item.id; }) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (existingOrderItem ? lcApi.updateEntity({<span class="hljs-attr"><span class="hljs-attr">entityTypeId</span></span>: <span class="hljs-string"><span class="hljs-string">'OrderItem'</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">id</span></span>: existingOrderItem.id, <span class="hljs-attr"><span class="hljs-attr">quantity</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> + existingOrderItem.quantity}) : lcApi.createEntity({<span class="hljs-attr"><span class="hljs-attr">entityTypeId</span></span>: <span class="hljs-string"><span class="hljs-string">'OrderItem'</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">order</span></span>: {<span class="hljs-attr"><span class="hljs-attr">id</span></span>: orderId}, <span class="hljs-attr"><span class="hljs-attr">item</span></span>: item, <span class="hljs-attr"><span class="hljs-attr">quantity</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}) ).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $scope.editForm.reloadEntity(); }) }) }) } }]) style. .items-bar .btn-block { margin-bottom: <span class="hljs-number"><span class="hljs-number">10</span></span>px; }</code> </pre><br>  In it, we set our main controller, which will breathe life into the POS.  For the most part, he tells our submission how to add new items to an order.  Basically, the key mechanism used here is AllcountJS for AngularJS - provider ‚ÄúlcApi‚Äù.  With the help of it there is a search, create and change the order and order items. <br><br><h1>  Total </h1><br>  What we have done: described the model, business logic and user-friendly interface. <br>  Now let's put it all together.  The final configuration file will look like this (from the menu and examples of data not mentioned in it only): <br><div class="spoiler">  <b class="spoiler_title">app.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs">A.app({ <span class="hljs-attr"><span class="hljs-attr">appName</span></span>: <span class="hljs-string"><span class="hljs-string">"POS and inventory"</span></span>, <span class="hljs-attr"><span class="hljs-attr">appIcon</span></span>: <span class="hljs-string"><span class="hljs-string">"calculator"</span></span>, <span class="hljs-attr"><span class="hljs-attr">onlyAuthenticated</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">menuItems</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Transactions"</span></span>, <span class="hljs-attr"><span class="hljs-attr">entityTypeId</span></span>: <span class="hljs-string"><span class="hljs-string">"Transaction"</span></span>, <span class="hljs-attr"><span class="hljs-attr">icon</span></span>: <span class="hljs-string"><span class="hljs-string">"send-o"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Items"</span></span>, <span class="hljs-attr"><span class="hljs-attr">entityTypeId</span></span>: <span class="hljs-string"><span class="hljs-string">"Item"</span></span>, <span class="hljs-attr"><span class="hljs-attr">icon</span></span>: <span class="hljs-string"><span class="hljs-string">"cubes"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Orders"</span></span>, <span class="hljs-attr"><span class="hljs-attr">entityTypeId</span></span>: <span class="hljs-string"><span class="hljs-string">"Order"</span></span>, <span class="hljs-attr"><span class="hljs-attr">icon</span></span>: <span class="hljs-string"><span class="hljs-string">"shopping-cart"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"POS"</span></span>, <span class="hljs-attr"><span class="hljs-attr">entityTypeId</span></span>: <span class="hljs-string"><span class="hljs-string">"PointOfSale"</span></span>, <span class="hljs-attr"><span class="hljs-attr">icon</span></span>: <span class="hljs-string"><span class="hljs-string">"calculator"</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">entities</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Fields</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">Transaction</span></span>: { <span class="hljs-attr"><span class="hljs-attr">fields</span></span>: { <span class="hljs-attr"><span class="hljs-attr">item</span></span>: Fields.reference(<span class="hljs-string"><span class="hljs-string">"Item"</span></span>, <span class="hljs-string"><span class="hljs-string">"Item"</span></span>), <span class="hljs-attr"><span class="hljs-attr">order</span></span>: Fields.reference(<span class="hljs-string"><span class="hljs-string">"Order"</span></span>, <span class="hljs-string"><span class="hljs-string">"Order"</span></span>), <span class="hljs-attr"><span class="hljs-attr">orderItem</span></span>: Fields.reference(<span class="hljs-string"><span class="hljs-string">"Order item"</span></span>, <span class="hljs-string"><span class="hljs-string">"OrderItem"</span></span>), <span class="hljs-attr"><span class="hljs-attr">quantity</span></span>: Fields.integer(<span class="hljs-string"><span class="hljs-string">"Quantity"</span></span>) }, <span class="hljs-attr"><span class="hljs-attr">showInGrid</span></span>: [<span class="hljs-string"><span class="hljs-string">'item'</span></span>, <span class="hljs-string"><span class="hljs-string">'order'</span></span>, <span class="hljs-string"><span class="hljs-string">'quantity'</span></span>] }, <span class="hljs-attr"><span class="hljs-attr">Item</span></span>: { <span class="hljs-attr"><span class="hljs-attr">fields</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: Fields.text(<span class="hljs-string"><span class="hljs-string">"Name"</span></span>), <span class="hljs-attr"><span class="hljs-attr">stock</span></span>: Fields.integer(<span class="hljs-string"><span class="hljs-string">"Stock"</span></span>).computed(<span class="hljs-string"><span class="hljs-string">'sum(transactions.quantity)'</span></span>), <span class="hljs-attr"><span class="hljs-attr">price</span></span>: Fields.money(<span class="hljs-string"><span class="hljs-string">"Price"</span></span>), <span class="hljs-attr"><span class="hljs-attr">transactions</span></span>: Fields.relation(<span class="hljs-string"><span class="hljs-string">"Transactions"</span></span>, <span class="hljs-string"><span class="hljs-string">"Transaction"</span></span>, <span class="hljs-string"><span class="hljs-string">"item"</span></span>) }, <span class="hljs-attr"><span class="hljs-attr">referenceName</span></span>: <span class="hljs-string"><span class="hljs-string">"name"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">Order</span></span>: { <span class="hljs-attr"><span class="hljs-attr">fields</span></span>: { <span class="hljs-attr"><span class="hljs-attr">number</span></span>: Fields.integer(<span class="hljs-string"><span class="hljs-string">"Order #"</span></span>), <span class="hljs-attr"><span class="hljs-attr">date</span></span>: Fields.date(<span class="hljs-string"><span class="hljs-string">"Date"</span></span>), <span class="hljs-attr"><span class="hljs-attr">total</span></span>: Fields.money(<span class="hljs-string"><span class="hljs-string">"Total"</span></span>).computed(<span class="hljs-string"><span class="hljs-string">'sum(orderItems.finalPrice)'</span></span>), <span class="hljs-attr"><span class="hljs-attr">orderItems</span></span>: Fields.relation(<span class="hljs-string"><span class="hljs-string">"Items"</span></span>, <span class="hljs-string"><span class="hljs-string">"OrderItem"</span></span>, <span class="hljs-string"><span class="hljs-string">"order"</span></span>) }, <span class="hljs-attr"><span class="hljs-attr">beforeSave</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Entity, Dates, Crud</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Entity.date) { Entity.date = Dates.nowDate(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Crud.crudFor(<span class="hljs-string"><span class="hljs-string">'OrderCounter'</span></span>).find({}).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">last</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Entity.number) { Entity.number = last[<span class="hljs-number"><span class="hljs-number">0</span></span>].number; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Crud.crudFor(<span class="hljs-string"><span class="hljs-string">'OrderCounter'</span></span>).updateEntity({ <span class="hljs-attr"><span class="hljs-attr">id</span></span>: last[<span class="hljs-number"><span class="hljs-number">0</span></span>].id, <span class="hljs-attr"><span class="hljs-attr">number</span></span>: last[<span class="hljs-number"><span class="hljs-number">0</span></span>].number + <span class="hljs-number"><span class="hljs-number">1</span></span> }); } }) }, <span class="hljs-attr"><span class="hljs-attr">beforeDelete</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Entity, Crud, Q</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> crud = Crud.crudFor(<span class="hljs-string"><span class="hljs-string">'OrderItem'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crud.find({<span class="hljs-attr"><span class="hljs-attr">filtering</span></span>: {<span class="hljs-attr"><span class="hljs-attr">order</span></span>: Entity.id}}).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">items</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Q.all(items.map(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crud.deleteEntity(i.id) })); }); }, <span class="hljs-attr"><span class="hljs-attr">referenceName</span></span>: <span class="hljs-string"><span class="hljs-string">"number"</span></span>, <span class="hljs-attr"><span class="hljs-attr">views</span></span>: { <span class="hljs-attr"><span class="hljs-attr">PointOfSale</span></span>: { <span class="hljs-attr"><span class="hljs-attr">customView</span></span>: <span class="hljs-string"><span class="hljs-string">'pos'</span></span> } } }, <span class="hljs-attr"><span class="hljs-attr">OrderItem</span></span>: { <span class="hljs-attr"><span class="hljs-attr">fields</span></span>: { <span class="hljs-attr"><span class="hljs-attr">order</span></span>: Fields.reference(<span class="hljs-string"><span class="hljs-string">"Order"</span></span>, <span class="hljs-string"><span class="hljs-string">"Order"</span></span>), <span class="hljs-attr"><span class="hljs-attr">item</span></span>: Fields.fixedReference(<span class="hljs-string"><span class="hljs-string">"Item"</span></span>, <span class="hljs-string"><span class="hljs-string">"Item"</span></span>).required(), <span class="hljs-attr"><span class="hljs-attr">quantity</span></span>: Fields.integer(<span class="hljs-string"><span class="hljs-string">"Quantity"</span></span>).required(), <span class="hljs-attr"><span class="hljs-attr">finalPrice</span></span>: Fields.money(<span class="hljs-string"><span class="hljs-string">"Final price"</span></span>).readOnly().addToTotalRow() }, <span class="hljs-attr"><span class="hljs-attr">showInGrid</span></span>: [<span class="hljs-string"><span class="hljs-string">'item'</span></span>, <span class="hljs-string"><span class="hljs-string">'quantity'</span></span>, <span class="hljs-string"><span class="hljs-string">'finalPrice'</span></span>], <span class="hljs-attr"><span class="hljs-attr">beforeSave</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Crud, Entity</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Crud.crudFor(<span class="hljs-string"><span class="hljs-string">'Item'</span></span>).readEntity(Entity.item.id).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">item</span></span></span><span class="hljs-function">) </span></span>{ Entity.finalPrice = Entity.quantity * item.price; }) }, <span class="hljs-attr"><span class="hljs-attr">afterSave</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Crud, Entity</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> crud = Crud.crudForEntityType(<span class="hljs-string"><span class="hljs-string">'Transaction'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> removeTransaction(Crud, Entity).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crud.createEntity({ <span class="hljs-attr"><span class="hljs-attr">order</span></span>: Entity.order, <span class="hljs-attr"><span class="hljs-attr">orderItem</span></span>: {<span class="hljs-attr"><span class="hljs-attr">id</span></span>: Entity.id}, <span class="hljs-attr"><span class="hljs-attr">item</span></span>: Entity.item, <span class="hljs-attr"><span class="hljs-attr">quantity</span></span>: Entity.quantity * <span class="hljs-number"><span class="hljs-number">-1</span></span> }) }) }, <span class="hljs-attr"><span class="hljs-attr">beforeDelete</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Crud, Entity</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> removeTransaction(Crud, Entity); } }, <span class="hljs-attr"><span class="hljs-attr">OrderCounter</span></span>: { <span class="hljs-attr"><span class="hljs-attr">fields</span></span>: { <span class="hljs-attr"><span class="hljs-attr">number</span></span>: Fields.integer(<span class="hljs-string"><span class="hljs-string">"Counter"</span></span>) } }, } }, <span class="hljs-attr"><span class="hljs-attr">migrations</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Migrations</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"demo-records-1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">operation</span></span>: Migrations.insert(<span class="hljs-string"><span class="hljs-string">"Item"</span></span>, [ {<span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Snickers"</span></span>, <span class="hljs-attr"><span class="hljs-attr">price</span></span>: <span class="hljs-number"><span class="hljs-number">299</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Coffee"</span></span>, <span class="hljs-attr"><span class="hljs-attr">price</span></span>: <span class="hljs-number"><span class="hljs-number">199</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">"3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Tea"</span></span>, <span class="hljs-attr"><span class="hljs-attr">price</span></span>: <span class="hljs-number"><span class="hljs-number">99</span></span>} ]) }, { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"demo-records-2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">operation</span></span>: Migrations.insert(<span class="hljs-string"><span class="hljs-string">"Transaction"</span></span>, [ {<span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">item</span></span>: {<span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>}, <span class="hljs-attr"><span class="hljs-attr">quantity</span></span>: <span class="hljs-string"><span class="hljs-string">"50"</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">item</span></span>: {<span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">"2"</span></span>}, <span class="hljs-attr"><span class="hljs-attr">quantity</span></span>: <span class="hljs-string"><span class="hljs-string">"100"</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">"3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">item</span></span>: {<span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">"3"</span></span>}, <span class="hljs-attr"><span class="hljs-attr">quantity</span></span>: <span class="hljs-string"><span class="hljs-string">"200"</span></span>} ]) }, { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"order-counter"</span></span>, <span class="hljs-attr"><span class="hljs-attr">operation</span></span>: Migrations.insert(<span class="hljs-string"><span class="hljs-string">"OrderCounter"</span></span>, [ {<span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">number</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>} ]) } ] } }); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removeTransaction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Crud, Entity</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> crud = Crud.crudForEntityType(<span class="hljs-string"><span class="hljs-string">'Transaction'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crud.find({<span class="hljs-attr"><span class="hljs-attr">filtering</span></span>: {<span class="hljs-attr"><span class="hljs-attr">orderItem</span></span>: Entity.id}}).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">transactions</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (transactions.length) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crud.deleteEntity(transactions[<span class="hljs-number"><span class="hljs-number">0</span></span>].id); } }); }</code> </pre><br></div></div><br>  I note that if your browser language is English, then prices will be displayed in dollars, and if Russian, then in rubles. <br><h1>  Launch </h1><br>  If you are already familiar with AllcountJS, then you will not be difficult to run this code.  For the rest, briefly tell you how to do it: <br><ul><li>  Create a new directory </li><li>  Create the app.js file inside it and the code above it </li><li>  Put the pos.jade file next </li><li>  Set up allcountjs-cli (as described in the previous article or on the official website) </li><li>  Start the allcountjs -c app.js server (the MongoDB service should already be running) </li><li>  The application will be available at <a href="http://localhost:9080/">http: // localhost: 9080</a> </li></ul><br><br><h1>  What about real POS? </h1><br>  So, we have created a simple application for the POS-terminal.  How can it be made working?  You need to write an analogue of the PointOfSale representation for a mobile device and package the web application in a mobile with ionic, and then do the integration with one of the mobile acquiring services (for example, 2can or iBox), and you already have a real working POS terminal. <br><br>  I hope you were interested.  We will be grateful for any feedback.  Here or in <a href="https://gitter.im/allcount/allcountjs">gitter</a> and <a href="https://gitter.im/allcount/allcountjs-ru">gitter ru</a> . </div><p>Source: <a href="https://habr.com/ru/post/272031/">https://habr.com/ru/post/272031/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272013/index.html">How many times have I not abandoned the development of my second game</a></li>
<li><a href="../272015/index.html">Paranoid job: disaster recovery / continuity plans, meteorite, zombie apocalypse, 1000 cleaners, portal to hell</a></li>
<li><a href="../272017/index.html">SmartTV * - how to create an unsafe device in the modern world</a></li>
<li><a href="../272023/index.html">IBM launched cloud authentication service Identity Mixer</a></li>
<li><a href="../272025/index.html">Java Programmer Cheat Sheet 5. Two hundred and fifty Russian-language training video presentations and lectures on Java</a></li>
<li><a href="../272033/index.html">Welcome to Web Standards Day in Moscow, December 13</a></li>
<li><a href="../272035/index.html">Did you receive a-mail? .. Accounting mail</a></li>
<li><a href="../272037/index.html">Release typescript 1.7</a></li>
<li><a href="../272039/index.html">Setting up public Internet access in five minutes</a></li>
<li><a href="../272041/index.html">Architecture and technological approaches to processing BigData on the example of "1C-Bitrix BigData: Personalization"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>