<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Setting up automatic restart of Windows services in Nagios XI</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I think that it is not necessary to talk a lot about such a famous product as Nagios , many people use it. For those who have not heard, I inform: thi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Setting up automatic restart of Windows services in Nagios XI</h1><div class="post__text post__text-html js-mediator-article">  I think that it is not necessary to talk a lot about such a famous product as <b>Nagios</b> , many people use it.  For those who have not heard, I inform: this is a monitoring system that can do many useful things besides this.  Now I am actively studying this system and in this publication I will tell you how to simplify the work of the system administrator a little. <br><a name="habracut"></a><br>  First I want to clarify: I mean that the organization already has a server with <b>Nagios</b> and is configured to monitor any sites and / or services.  So, let's say there is a server named <b>PrintServer</b> , which often stops the <b>spooler</b> service.  It is quite banal, but this is just an example, on the basis of which you can come up with a lot of useful.  The first thing to do is set up monitoring of this service. <br><br>  Go to the <b>Nagios</b> web interface under the administrator and select <b>Configure</b> at the top of the page.  Next to add a new monitoring you need to run the <b>Monitoring Wizard</b> .  Afterwards, I recommend that you start <b>Core Config Manager</b> (column on the left) for editing and adding new hosts, and for the first acquaintance it is better to use a wizard. <br><br><img src="https://habrastorage.org/files/d3d/ad9/90a/d3dad990a40845379e68f9c5214b0a01.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A wizard consists of a few simple steps that specify the necessary parameters. <br><br>  1. Once this is a Windows service, you need to select <b>Windows Server</b> . <br>  2. Enter the ip address. <br>  3. Here is more interesting.  In the <b>Windows Agent</b> section <b>,</b> you can download (via a link from Nagios.com) the latest version of the Agent for Windows (it is installed on the client side) and enter the Agent's password.  The password is set on the server side, and is configured on the client for the client-server interaction.  Next section <b>Server Metrics</b> .  Here you can configure various metrics for verification.  I think everything is clear here, and, because  You need to configure the service, in this section you need to remove all the daws.  Next section <b>Services</b> .  Here you need to register the necessary service for monitoring and put a check.  In the <b>Windows Service</b> column <b>,</b> you need to specify the <b>Service Name</b> , this is important. <br><br><img src="https://habrastorage.org/files/5b5/20a/e91/5b520ae916814a73a01fa4a464e7c6b3.png"><br><br>  Next come the <b>Processes</b> and <b>Performance Counters</b> sections.  In the future, they will most likely come in handy, but now you need to skip them and go to step 4. <br>  4. Here you can set the frequency of checks in minutes and the time interval and the number of checks before Nagios generates an alert.  These settings depend only on a specific task, therefore I will skip this section.  Now you can click <b>Finish</b> and see the wizard report.  If all three stages are successful, then this means that the service is created. <br><br><img src="https://habrastorage.org/files/0f9/e23/3c2/0f9e233c2b2e41f9a49f642c75ee0a88.png"><br><br>  Next you need to select <b>Core Config Manager</b> in the left menu and below in the <b>Monitoring</b> section select <b>Services</b> .  In this section, in the search we drive in <b>Print Spooler</b> and find the created config.  Now Nagios monitors the status of the service.  Then you can proceed to setting up the restart of the service on an event.  To do this, you must first configure the client side.  Go to the server and install the agent Nagios.  After installation, go to the folder C: \ Program Files \ NSClient ++.  Perhaps the path will be different, the main thing is to get into the program installation folder.  We are looking for <b>NSC.ini</b> or <b>nsclient.ini</b> and open it for editing.  Here you need to change a few parameters: <br><br>  1. Uncomment the CheckExternalScripts.dll entry at the beginning of the file, removing the ";"; <br>  2. Uncomment <b>allow_arguments</b> and set parameter 1 instead of 0; <br>  3. In the <b>[External Scripts]</b> section add the entry <b>restart_svc = scripts \ restart_svc.bat ‚Äú$ ARG1 $‚Äù</b> . <br><br>  Save the changes and bury the file.  Further in this folder we find the <b>Scripts</b> folder and in it we create a bvnik <b>svc_restart.bat with the</b> following content: <br><br>  <a href="http://habrahabr.ru/users/echo/" class="user_link">echo</a> off <br>  Net stop% 1 <br>  Net start% 1 <br>  Exit 0 <br><br>  After this, you need to restart the NSClient ++ service so that it loads the changes in the .ini file.  At this, the client setup is ready, it remains to configure the server. <br><br>  The restart process looks like this: <br><br>  1. The service stops and an event is generated in Nagios that the state of the Critical service; <br>  2. The event handler runs the command configured for it; <br>  3. The command runs a script located on the Nagios server; <br>  4. The script transmits a command with arguments to NSClient ++; <br>  5. NSClient ++ runs a script on the .bat client that <s>destroys the earth and</s> restarts the service. <br><br>  In principle, everything is simple.  Now let's go in order.  Service monitoring is configured, so an event will be created when the service is stopped.  Before we go further, create a command for the event handler.  Go to <b>Configure</b> =&gt; <b>Core Config Manager</b> =&gt; <b>Commands</b> .  Create a new command using <b>Add New</b> and drive in the necessary parameters. <br><br>  Command Name = svc_restart <br>  Command Line = $ USER1 $ / svc_restart.sh $ SERVICESTATE $ $ HOSTADDRESS $ $ _SERVICESERVICE $ <br>  Command Type = misc command <br>  And put the daw ACTIVE. <br><br><img src="https://habrastorage.org/files/8cc/800/316/8cc8003168d346aab194b05589141637.png"><br><br>  Team created, click <b>Apply Configuration</b> .  Next, go to the <b>Services</b> section and open the created <b>Print Spooler</b> service.  Here, in the <b>Check Settings</b> tab in the event handler (Event Handler), select the command (svc_restart), which starts when the event occurs and enable the handler itself. <br><br><img src="https://habrastorage.org/files/4a9/0b8/2e8/4a90b82e80be4bb884beb7c1cd47227d.png"><br><br>  Next, go to the tab <b>Misc Settings</b> and then <b>Manage Variable Definitions</b> .  Here we fill: <br>  Variable name = _SERVICE <br>  Variable value = spooler <br>  And click <b>Insert</b> and <b>Close</b> . <br>  This completes the service setting, you can save and apply changes (Save &amp; Apply Configuration).  Now Nagios when stopping the service will run the <b>svc_restart</b> command, which in turn will launch <b>svc_restart.sh</b> with the required parameters.  The problem is that there is no such script, and it needs to be created.  The command will look for the script in a local folder with scripts and binaries on the server, so the next step is to log into the server on the console and go to the <b>/ usr / local / Nagios / libexec folder</b> and use any convenient text editor (I used nano) to create a file <b>svc_restart.sh</b> with the following content: <br><br>  1. #! / Bin / sh <br>  2. # Event Handler for Restarting Windows Services <br>  3. case "$ 1" in <br>  4. OK) <br>  five. ;; <br>  6. WARNING) <br>  7. ;; <br>  8. UNKNOWN) <br>  9. ;; <br>  10. CRITICAL) <br>  eleven. <br>  12. / usr / local / nagios / libexec / check_nrpe -H "$ 2" -p 5666 ‚Äìc svc_restart -a "$ 3" <br>  13. ;; <br>  14. esac <br>  15. <br>  16. exit 0 <br><br>  Now you need to change the permissions on this file with the following console commands: <br><br>  chown nagios: nagios /usr/local/nagios/libexec/servicerestart.sh <br>  chmod 775 /usr/local/nagios/libexec/servicerestart.sh <br><br>  This completes the setup.  If you do everything according to the instructions, there should be no problems.  Finally, I will once again describe the mechanism of work and a bit of troubleshooting: <br><br>  1. The service stops, the client sends to the server that it has the status of the Critical service; <br>  2. The server creates an event with arguments hostname, servicename, servicestate; <br>  3. The event handler executes the svc_restart command with the specified parameters; <br>  4. The command starts svc_restart.sh with the necessary parameters; <br>  5. Svc_restart.sh runs check_nrpe with the necessary parameters; <br>  6. Check_nrpe sends to the client that it is necessary to execute svc_restart with the specified parameters; <br>  7. The client in the ini file finds that the svc_restart is a bat file lying in the scripts; <br>  8. Run the bat file with the specified parameters; <br>  9. Bat file restarts the service. <br><br>  If something does not work: <br><br>  1. Try the bat file itself, if it works, then; <br>  2. On the server, go to the console and try the following: <br>  cd / usr / local / nagios / libexec <br>  ./check_nrpe -H -p 5666 -c svc_restart -a spooler <br>  This command will check if the client command works on the client, if it works, then; <br>  3. In the console, try <br>  cd / usr / local / nagios / libexec <br>  ./svc_restart.sh CRITICAL spooler <br>  This command will check the spelling of the svc_restart.sh script. <br><br>  When writing was used manual Nagios from the official site.  Unfortunately there are no links left, but I think they are easy to google on your own. </div><p>Source: <a href="https://habr.com/ru/post/243227/">https://habr.com/ru/post/243227/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../243215/index.html">Internet Explorer: Moving to live Edge mode - the next step for the web to just work</a></li>
<li><a href="../243217/index.html">InterSystems iKnow. Part one. iKnow and beach holidays</a></li>
<li><a href="../243219/index.html">RFM analysis on the knee (Excel)</a></li>
<li><a href="../243221/index.html">Meeting of mobile game developers, November 27, Moscow</a></li>
<li><a href="../243225/index.html">What is silent technical task?</a></li>
<li><a href="../243229/index.html">Analyze friendships VK using Python. Continuation</a></li>
<li><a href="../243231/index.html">VexorCI under the hood</a></li>
<li><a href="../243233/index.html">Calling a non-predefined method in a category after overriding it</a></li>
<li><a href="../243235/index.html">Fight for the buyer or how to buy loyalty?</a></li>
<li><a href="../243237/index.html">Localization of the button "Build"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>