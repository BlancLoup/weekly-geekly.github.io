<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Breaking the iOS application! Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first part, we examined some of the issues of data storage and transmission security . Now go to the protection of executable code . We will mo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Breaking the iOS application! Part 2</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="http://habrahabr.ru/post/199128/">first part,</a> we examined some of the issues of data storage and transmission <i>security</i> .  Now go to the protection of <i>executable code</i> .  We will modify the functionality of the iOS application at runtime and do reverse-engineering.  And again, remember!  Our goal is not to become an ugly hacker, but to protect your application and users from malicious actions.  To do this, you need to understand what a hacker can do. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/412/621/944/4126219446922efb37f654de16208801.png"><a name="habracut"></a><br><br>  To successfully complete this lesson, you must understand what an assembler is.  The author advises to go through the <a href="http://www.raywenderlich.com/37181/ios-assembly-tutorial">tutorial on ARM</a> (in English). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In fact, in order to understand the meaning of the lesson, the level of necessary knowledge is a few minutes to google along the way.  Well, you are closer to the end of the article, decide whether you need to learn assembler or not.  :) <i>- Approx.</i>  <i>per.</i> <br><br><h2>  Let's start </h2><br>  We will need: <br><br><ul><li>  Test project <a href="https://github.com/x128/MemeCollector">Meme Collector</a> from the previous part. <br></li><li>  Utility <a href="https://code.google.com/p/networkpx/wiki/class_dump_z">class-dump-z</a> . <br></li><li>  Open source HEX editor for OS X: <a href="http://ridiculousfish.com/hexfiend/">Hex Fiend</a> . <br></li><li>  The demo version of <a href="https://www.hex-rays.com/products/ida/support/download_demo.shtml">IDA</a> is a well-known multiprocessor disassembler and debugger.  The demo version has limitations that are not essential for this lesson. <br></li></ul><br>  I hope you learn a lot about these tools! <br><br><h2>  Manipulation of the runtime environment (runtime) </h2><br>  In the previous series, we modified the .plist files to change the balance in your account.  Now let's see how to manipulate variables and methods right during the execution of the application (what is called runtime).  For this we use the debagger LLDB. <br><div class="spoiler">  <b class="spoiler_title">In the original article, all examples are with GDB, but</b> <div class="spoiler_text">  after upgrading Xcode to 5.0.1 (the current version at the time of translation), GDB requires dancing with a tambourine.  Therefore, in order not to burden the tutorial, I remade it according to the <a href="http://lldb.llvm.org/lldb-gdb.html">table of the command correspondence between LLDB and GDB</a> .  <i>- Approx.</i>  <i>per.</i> </div></div><br>  Open the folder of the main bundle ( <code>Meme Collector.app</code> ) installed on the iOS simulator in the terminal.  If you are at a loss to make it, glance in the <a href="http://habrahabr.ru/post/199128/">first part</a> . <br><br>  We take the original position: the simulator is running, the application is installed, but not running. <br><br>  In the terminal type: <br><br><pre> <code class="bash hljs">lldb</code> </pre><br>  Debagger launched, great.  On the next line we see an invitation from him: <code>(lldb)</code> <br><br>  Recruit team for debugger: <br>  <i>I will not write characters <code>(lldb)</code> at the beginning of the line so that you do not confuse when copying</i> <br><br><pre> <code class="bash hljs">attach --name <span class="hljs-string"><span class="hljs-string">"Meme Collector"</span></span> --waitfor</code> </pre><br>  The <code>attach</code> command is used to connect to a specific process.  Here we ask LLDB to wait for the launch of the new process called " <code>Meme Collector</code> " and connect to it. <br><br>  So, the debugger is waiting.  Let us go to the iOS Simulator and perform the traditional (according to the last part of the lesson) deleting the application from multitasking, and then restarting (run it from the simulator, not from the IDE) - we will call it ‚Äúrestart‚Äù. <br><br>  If everything is done correctly, LLDB will begin <s>to walk along merrily</s> with the process in the simulator.  The debugger will connect to the process, suspend its execution and say: <br><br><pre> <code class="bash hljs">Process 1427 stopped Executable module <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to <span class="hljs-string"><span class="hljs-string">"/Users/dmitriy/Library/Application Support/iPhone Simulator/7.0.3/Applications/9A72F266-8851-4A25-84E4-9CF8EFF95CD4/Meme Collector.app/Meme Collector"</span></span>. Architecture <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to: i486-apple-macosx.</code> </pre><br>  And an invitation to enter a new command: <code>(lldb)</code> <br><br>  Let's add a breakpoint before displaying each ViewController.  This is the place where a lot of interesting things usually happen.  Often, a significant part of the application logic is defined there.  For example, let's add a breakpoint on every call to the <code>viewDidLoad</code> method, since in iOS, the <code>UIViewController</code> subclasses of iOS almost always override <code>viewDidLoad</code> . <br><br>  Run in terminal: <br><br><pre> <code class="bash hljs">b viewDidLoad</code> </pre><br>  Method names are case-sensitive, so the <code>viewdidload</code> option <code>viewdidload</code> not work. <br><br>  By this we set breakpoints on all methods called <code>viewDidLoad</code> (including C ++ and Objective C methods).  If desired, for specific ObjC selectors you can enter their names, for example, <code>-[UIViewController viewDidLoad]</code> , but note that this option will not work for the heirs of the <code>UIViewController</code> class. <br><br>  So LLDB informs us that it has found 15 suitable places for breakpoints: <br><br><pre> <code class="bash hljs">Breakpoint 1: 15 locations.</code> </pre><br>  Fine.  Let's see where he put them.  Enter the command: <br><br><pre> <code class="bash hljs">br l</code> </pre><br>  (This is short for <code>breakpoint list</code> - if you want, you can write the full version of the command.) <br><br>  Well, here they are: <br><br><pre> <code class="bash hljs">Current breakpoints: 1: name = <span class="hljs-string"><span class="hljs-string">'viewDidLoad'</span></span>, locations = 15, resolved = 15 1.1: <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> = Meme Collector`-[ViewController viewDidLoad] + 18 at ViewController.m:27, address = 0x0001f482, resolved, hit count = 0 1.2: <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> = UIKit`-[UIViewController viewDidLoad], address = 0x005d3db5, resolved, hit count = 0 1.3: <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> = UIKit`-[_UIModalItemsPresentingViewController viewDidLoad], address = 0x0065ab4b, resolved, hit count = 0 1.4: <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> = UIKit`-[UIKeyboardCandidateGridCollectionViewController viewDidLoad], address = 0x00680729, resolved, hit count = 0 1.5: <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> = UIKit`-[UIActivityGroupViewController viewDidLoad], address = 0x008d2b6b, resolved, hit count = 0 1.6: <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> = UIKit`-[UIPrintPanelTableViewController viewDidLoad], address = 0x009be80f, resolved, hit count = 0 1.7: <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> = UIKit`-[UIPrintStatusViewController viewDidLoad], address = 0x009c8828, resolved, hit count = 0 1.8: <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> = UIKit`-[UIPrintRangeViewController viewDidLoad], address = 0x009d29ae, resolved, hit count = 0 1.9: <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> = UIKit`-[_UILongDefinitionViewController viewDidLoad], address = 0x00a10cf4, resolved, hit count = 0 1.10: <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> = UIKit`-[_UINoDefinitionViewController viewDidLoad], address = 0x00a1249d, resolved, hit count = 0 1.11: <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> = UIKit`-[UIReferenceLibraryViewController viewDidLoad], address = 0x00a13bd4, resolved, hit count = 0 1.12: <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> = UIKit`-[_UIFallbackPresentationViewController viewDidLoad], address = 0x00a77877, resolved, hit count = 0 1.13: <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> = UIKit`-[_UIViewServiceViewControllerOperator viewDidLoad], address = 0x00aba23b, resolved, hit count = 0 1.14: <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> = UIKit`-[UIActivityViewController viewDidLoad], address = 0x00b4f296, resolved, hit count = 0 1.15: <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> = UIKit`-[_UITextEditingController viewDidLoad], address = 0x00b9a6ec, resolved, hit count = 0</code> </pre><br>  In fact, it is clear that we need to leave only one breakpoint: <code>-[ViewController viewDidLoad]</code> , since the rest belong to the Apple Private API.  But we are interested, so leave them on. <br><br>  Let's return to the launch of our application!  Enter the command: <br><br><pre> <code class="bash hljs">c</code> </pre><br>  which in the full version looks like <code>continue</code> .  The application will continue to execute code until the first call to <code>viewDidLoad</code> : <br><br><pre> <code class="bash hljs">Process 1427 resuming Process 1427 stopped * thread <span class="hljs-comment"><span class="hljs-comment">#1: tid = 0x83c4, 0x0001f482 Meme Collector`-[ViewController viewDidLoad](self=0x08f7c620, _cmd=0x00c50587) + 18 at ViewController.m:27, queue = 'com.apple.main-thread, stop reason = breakpoint 1.1 frame #0: 0x0001f482 Meme Collector`-[ViewController viewDidLoad](self=0x08f7c620, _cmd=0x00c50587) + 18 at ViewController.m:27 24 25 - (void)viewDidLoad 26 { -&gt; 27 [super viewDidLoad]; 28 self.memeDescriptionTextView.clipsToBounds = YES; 29 self.memeDescriptionTextView.layer.cornerRadius = 20.0f; 30 [self.moneyLabel sizeToFit];</span></span></code> </pre><br>  ‚ÄúAnd now tep-e-er ... it's time for us to have some fun: otherwise I do not play!‚Äù <br><br><img src="https://habrastorage.org/getpro/habr/post_images/42b/523/71c/42b52371c0261dd6a69dc5ce0a24e434.jpg" title="Tired of memes?  Here you have carlson"><br><br>  We stopped the process on the frame of the <code>ViewController</code> class (ViewController.m file).  This means that we have access to its instance variables and methods.  Cool?  And further!  The code section is already loaded into memory.  Consequently, we have access to all other classes, including - attention!  - singltony. <br><br>  Yes, singletons.  If you carefully studied this point in the <a href="http://habrahabr.ru/post/199128/">first part</a> , you might have noticed an ‚Äúinteresting‚Äù class called <code>MoneyManager</code> .  He has a method of <code>purchaseCurrency</code> , which one wants to test, eh?  :) <br><br>  Type in our <code>(lldb)</code> terminal: <br><br><pre> <code class="bash hljs">call [[MoneyManager sharedManager] purchaseCurrency]</code> </pre><br>  We called the method!  The debugger will display the result of the execution: <br><br><pre> <code class="bash hljs">(BOOL) <span class="hljs-variable"><span class="hljs-variable">$0</span></span> = YES</code> </pre><br>  If we saw the answer <code>YES</code> , it means that we have successfully ‚Äúacquired‚Äù virtual currency.  (The author blurted out here, this is insider information. We, hackers, should not know it. - <i>Appro. Trans.</i> ) <br><br>  And LLDB repeats the previous command by pressing Enter.  Therefore, press Enter several times to rob <s>Mikhalkov a</s> little more: <br><br><pre> <code class="bash hljs">(lldb) call [[MoneyManager sharedManager] purchaseCurrency] (BOOL) <span class="hljs-variable"><span class="hljs-variable">$0</span></span> = YES (lldb) (BOOL) <span class="hljs-variable"><span class="hljs-variable">$1</span></span> = YES (lldb) (BOOL) <span class="hljs-variable"><span class="hljs-variable">$2</span></span> = YES (lldb) (BOOL) <span class="hljs-variable"><span class="hljs-variable">$3</span></span> = YES (lldb) (BOOL) <span class="hljs-variable"><span class="hljs-variable">$4</span></span> = YES (lldb) (BOOL) <span class="hljs-variable"><span class="hljs-variable">$5</span></span> = YES (lldb) (BOOL) <span class="hljs-variable"><span class="hljs-variable">$6</span></span> = YES (lldb) (BOOL) <span class="hljs-variable"><span class="hljs-variable">$7</span></span> = YES (lldb)</code> </pre><br>  Buying <s>free</s> content has never been easier!  Now enter the command a couple of times. <br><br><pre> <code class="bash hljs">c</code> </pre><br>  ... so that all the breakpoints we‚Äôve completed are over and evaluate the result in the simulator: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f98/3da/20f/f983da20f7f0b0bd9b63a576966e5662.png"><br><br>  Not bad, huh?  Well, let's see what we can do about it. <br><br>  To pause the execution of the application and return to the command line again, switch to the terminal and press Ctrl + C there.  The LLDB debugger is again ready to execute our commands. <br><br>  Let's finish the debug session for now: enter the <b><code>q</code></b> command and then confirm <b><code>y</code></b> : <br><br><pre> <code class="bash hljs">(lldb) q Quitting LLDB will detach from one or more processes. Do you really want to proceed: [Y/n] y</code> </pre><br>  We return to the side of the developer.  Is it possible to outsmart those who want to manipulate your application through a debugger? <br><br><h2>  Protection against runtime manipulations </h2><br>  Fortunately, there is a way to find out if the debugger is connected to our code!  But there is one problem.  This check determines whether the debugger is connected at a particular time.  A hacker (cracker, cheater, ...) can connect to the application after this check, when the application is no longer aware of the danger.  This problem can be solved in at least two ways: <br><br><ol><li>  Include a check in the run loop, so the check will be performed continuously. <br></li><li>  Put the check in the most critical parts of the code where we are most concerned about security. <br></li></ol><br>  The first option is usually undesirable.  Its price is a waste of precious processor time <s>to heat the device</s> .  Let's go the second way. <br><br>  One elegant solution is to test for debugger activity in <code>MoneyManager</code> Singleton.  For example: if we determine that debugging is in progress, then return <code>nil</code> instead of a static instance of the class. <br><br><div class="spoiler">  <b class="spoiler_title">Advanced mode</b> <div class="spoiler_text">  In Objective C, you can do it easily, because  methods in Objective C are essentially not methods, but <a href="http://ru.wikipedia.org/wiki/Objective-C">messages</a> .  This means that sending a message to an empty object is absolutely safe - it does nothing, i.e.  the code does not fall. <br></div></div><br>  Well, finally, let's work with the code!  Open our project (in your favorite IDE or in Xcode) and go to the MoneyManager.m file.  This is what we will do: we will add a preprocessor macro that will check in which configuration our application is assembled, and if it is Release, then it will check if the debugger is running.  If running, returns <code>nil</code> .  Otherwise, everything is done as usual. <br><br>  Add 3 lines to the top of the <code>sharedManager</code> class's <code>MoneyManager</code> : <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> DEBUG SEC_IS_BEING_DEBUGGED_RETURN_NIL(); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre><br>  Now the method should look like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/474/420/b86/474420b860a06d62fb5286c189e38634.png"><br><br>  <code>SEC_IS_BEING_DEBUGGED_RETURN_NIL()</code> is a call to the standard preprocessor macro, which returns <code>nil</code> if a debugger is connected to the application. <br><br>  Note: this macro is available only in the Release configuration.  If you followed us in part one, you should have already switched to release. <br><div class="spoiler">  <b class="spoiler_title">(just to remind you)</b> <div class="spoiler_text">  Xcode: <b>Product&gt; Scheme&gt; Edit scheme ...</b> ( <b>‚åò &lt;</b> ) - select Run ... on the left, Info&gt; Build Configuration: Release tab on the right. <br><br>  AppCode: <b>Run&gt; Edit configurations ...</b> &gt; Configuration: Release. </div></div><br><br><div class="spoiler">  <b class="spoiler_title">Advanced mode</b> <div class="spoiler_text">  Someone might say that it is better to write an ObjC method or a C function instead of a preprocessor macro.  But!  There is a very specific reason for using a macro.  Since we have already learned that anyone can spy on the names of all the methods, and also change their behavior (looking ahead: this is what we will do next) - knowing this, we want to hide our test (for example, here, inside the singleton method).  In general, it will be much more difficult for hackers to find and patch the security check, in the case of a macro, you have to tinker with an assembler. </div></div><br>  Now start our application from the IDE (remember to choose the Release configuration?) <br><br>  Xcode: <b>Run</b> (‚åòR) <br>  AppCode: <b>Debug</b> (Ctrl + D) <br><br>  Xcode automatically turns on the LLDB debugger when you select the Run command.  Result: the balance on the account is not displayed!  Indeed, somewhere <code>nil</code> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d41/1d4/ec5/d411d4ec556e084f209c51cb32546313.png"><br><br>  And in AppCode, there are two different commands: the <b>Run</b> command does not enable the debugger, and the <b>Debug</b> command connects.  Conveniently. <br><br>  To finally make sure that our protection works, check: can you buy something now?  <code>MoneyManager</code> not available - so you can not. <br><br>  Stop the application by clicking the <b>Stop</b> button (with a square) in IDE.  Also stop debugger LLDB.  Switch to the simulator and start the application from there.  The application displays the currency, because  The debugger is not connected. <br><br>  As we have said, you can connect the debugger to the process not only at startup, but generally at an arbitrary point in time.  Run in terminal: <br><br><pre> <code class="bash hljs">ps aux | grep <span class="hljs-string"><span class="hljs-string">"Meme Collector"</span></span></code> </pre><br>  The output of this command will contain a list of all processes whose name contains the phrase ‚ÄúMeme Collector‚Äù: <br><br><pre> <code class="bash hljs">dmitriy 2008 0,0 0,0 2432784 636 s001 S+ 1:05 0:00.00 grep Meme Collector dmitriy 2001 0,0 0,4 857416 32240 ?? S 1:04 0:00.65 /Users/dmitriy/Library/Application Support/iPhone Simulator/7.0.3/Applications/9A72F266-8851-4A25-84E4-9CF8EFF95CD4/Meme Collector.app/Meme Collector</code> </pre><br>  You can see that the second line corresponds to the application folder in the simulator.  Note the number of this process (second column).  In my case, this number is 2001. <br><br>  From the terminal, run LLDB with the <code>-p</code> key to connect to the process by the number: <br><br><pre> <code class="bash hljs">lldb -p {  }</code> </pre><br>  For example, I need to type "lldb -p 2001". <br><br>  LLDB will start and report a successful connection to the process: <br><br><pre> <code class="bash hljs">Attaching to process with: process attach -p 2001 Process 2001 stopped Executable module <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to <span class="hljs-string"><span class="hljs-string">"/Users/dmitriy/Library/Application Support/iPhone Simulator/7.0.3/Applications/9A72F266-8851-4A25-84E4-9CF8EFF95CD4/Meme Collector.app/Meme Collector"</span></span>. Architecture <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to: i486-apple-macosx.</code> </pre><br>  When LLDB is running, try <code>MoneyManager</code> singleton: <br><br><pre> <code class="bash hljs">call [[MoneyManager sharedManager] purchaseCurrency]</code> </pre><br>  An attempt to ‚Äúbuy‚Äù a currency now returns <code>NO</code> , that is, does not work. <br><br>  And we will try to print the description of the <code>sharedManager</code> object.  Type the command: <br><br><pre> <code class="bash hljs">po [MoneyManager sharedManager]</code> </pre><br>  And what about this description? <br><br><pre> <code class="bash hljs"> nil</code> </pre><br>  What was required to achieve!  Our singleton does not return at least some intelligible result, and also does not show an error message during the purchase process.  Simple and incomprehensible hacker <code>nil</code> . <br><br>  We continue the application with the command: <br><br><pre> <code class="bash hljs">c</code> </pre><br>  Try to legally replenish your account by clicking on the ‚ÄúPurchase Currency‚Äù button.  Nothing will come out!  After all, LLDB is still connected to the process. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ab3/f18/22a/ab3f1822a6c2e58e9e215839f5597f7a.png"><br><br>  Disable the debugger from the process: press <b>Ctrl + C</b> and then enter the command <b>q</b> .  The ‚ÄúPurchase Currency‚Äù button is working again. <br><br>  In addition to checking for the presence of a debugger, a tougher approach can be applied.  The <code>ptrace</code> function helps <s>to</s> resist connecting GDB / LLDB to your application <code>ptrace</code> <s>possible</s> . <br><br>  To do this, go back to the IDE and open <b>main.m.</b>  Add one header file: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;sys/ptrace.h&gt;</span></span></span></span></code> </pre><br>  And three lines at the beginning of the <code>main</code> function: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> DEBUG ptrace(PT_DENY_ATTACH, 0, 0, 0); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre><br>  The <code>ptrace</code> function is commonly used in debuggers to connect to a process, as they do ‚Äî as we have seen ‚Äî GDB and LLDB.  We added a call to <code>ptrace</code> , which with the special parameter <code>PT_DENY_ATTACH</code> asks the operating system to prevent other processes (that is, debuggers) from connecting to our application. <br><br>  Now we will start application from IDE. <br><br>  <b>Xcode</b> : the application does not seem to start.  What's happening?  We see for a moment a black screen, which immediately disappears - this application is loaded into memory and begins to run.  At the same time, Xcode wants to connect LLDB to it, but iOS does not allow and terminate the debugger process.  ‚ÄúOnce the debugger is complete,‚Äù Xcode thinks, ‚Äúthe application has ended, so I‚Äôll stop its execution.‚Äù  The last phrase sounds crazy, but it works that way.  <i>- Approx.</i>  <i>per.</i> <br><br>  <b>AppCode</b> : after the <b>Run</b> (‚åòR) command, the application starts normally, and when the <b>Debug</b> command (Ctrl + D) ‚Äúdrops‚Äù like Xcode. <br><br>  And from the simulator runs correctly.  Try connecting the debugger to it now, as discussed above: <br><br><pre> <code class="bash hljs">lldb -p {  Meme Collector}</code> </pre><br>  The result is predictable: <br><br><pre> <code class="bash hljs">Attaching to process with: process attach -p 3435 error: attach failed: process did not stop (no such process or permission problem?)</code> </pre><br>  This is a good tool to stop young children who have been reading Habra from playing with your application.  But this will not stop the bearded hackers.  They will stop your process when you call the <code>ptrace</code> function and modify it before continuing. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/84b/18a/343/84b18a34389f79ff1bf3e3b1edec04e9.png"><br><br>  In general, do not feel too comfortable.  Hackers like to use <a href="http://www.cycript.org/">Cycript</a> - a scripting language (reminiscent of JavaScript) - precisely for manipulating ObjC applications at runtime.  The debugger protection we did will not protect you from Cycript.  Remember where we started the conversation in the previous article: <br><blockquote>  <b>No application is safe!</b> <br></blockquote><br><h2>  We prepare the binary </h2><br>  Before proceeding with the modification of binary files, let's find out how to disassemble it into pieces, and what's what. <br><br>  I will periodically refer to specific addresses in a binary to illustrate certain concepts.  If you do not have a version of the compiler like mine (for example, that comes with a newer Xcode), or you compile the Debug configuration instead of Release, or you made changes to the project yourself - the addresses may be different.  Don't let that bother you - just watch the presentation to get an idea. <br><br>  The format of executable files in OS X and iOS is called <b>Mach-O</b> .  As a rule, a binary begins with a <b>header</b> (header) containing all the information about where and what data is in the binary.  This information is followed by load commands that will tell you about marking a file by segment.  In addition, these commands define special flags: for example, whether binary data is encrypted in the file. <br><br>  In each <b>segment</b> (segment) there is one or more <b>sections</b> (sections).  Two types of sections worth noting: <br><br><ul><li>  <b>Text section</b> .  Mostly for read-only data.  For example, source code, C strings, constants, etc.  The peculiarity of read-only data is that if the system runs out of RAM, it can easily free the data from these partitions and then (if necessary) download it from the file again. <br></li><li>  <b>Data section</b>  Basically for the data that can be modified from the code.  They include BSS sections for static variables, common sections for global variables <a href="http://en.wikipedia.org/wiki/Data_segment">, etc.</a> <br></li></ul><br>  And Apple has an <a href="https://developer.apple.com/library/mac/documentation/DeveloperTools/Conceptual/MachORuntime/Reference/reference.html">excellent reference for the Mach-O format</a> in English.  <i>- Approx.</i>  <i>per.</i> <br><br>  Now we will explore the <code>Meme Collector</code> binary file to see all this in action.  Let's start with the title.  In the terminal, while still in the folder of the main bundle "Meme Collector.app", enter: <br><br><pre> <code class="bash hljs">otool -h <span class="hljs-string"><span class="hljs-string">"Meme Collector"</span></span></code> </pre><br>  This command will print the header of the executable binary file ‚ÄúMeme Collector‚Äù.  Something like this: <br><br><pre> <code class="bash hljs">Meme Collector: Mach header magic cputype cpusubtype caps filetype ncmds sizeofcmds flags 0xfeedface 7 3 0x00 2 25 3372 0x01000085</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Advanced mode</b> <div class="spoiler_text">  0xfeedface (0xFEEDFACE) is a hexadecimal address or ... some phrase in English, don't you think?  <a href="http://ru.wikipedia.org/wiki/Hexspeak">Wikipedia</a> responds.  <i>- Approx.</i>  <i>per.</i> <br></div></div><br>  Note: the file has 25 download commands ( <code>cmds</code> ), and they occupy 3372 bytes ( <code>sizeofcmds</code> ).  Let's look at these commands: <br><br><pre> <code class="bash hljs">otool -l <span class="hljs-string"><span class="hljs-string">"Meme Collector"</span></span></code> </pre><br>  (Before this, you can clear the terminal window by pressing ‚åòK. It will be more convenient to scroll through. - <i>Note. Trans.</i> ) <br><br>  You will get many, many lines.  From these lines (even without preliminary preparation) you can see a lot of interesting things about the order of loading segments and sections into memory.  But this study is beyond the scope of this tutorial, let us leave it to the most curious readers for <a href="http://lists.apple.com/archives/xcode-users/2008/Aug/msg00503.html">independent</a> study. <br><br>  And we continue our lesson.  Find ( <b>‚åòF</b> ) a section called <code>__objc_classname</code> , note the <code>offset</code> is the ‚Äúposition‚Äù or ‚Äúshift‚Äù of this section relative to the beginning of the virtual memory occupied by the application. <br><br><div class="spoiler">  <b class="spoiler_title">Advanced mode</b> <div class="spoiler_text">  About <code>offset</code> .  The most curious, perhaps, have already understood the difference between <code>addr</code> and <code>offset</code> , why is this difference everywhere equal to 0x1000 = 4096 bytes?  If not, then read <a href="https://developer.apple.com/library/mac/documentation/DeveloperTools/Conceptual/MachORuntime/Reference/reference.html">more</a> about <code>__PAGEZERO</code> , a very interesting page. </div></div><br>  Here the section shift <code>__objc_classname</code> is equal to 159942 bytes (in decimal representation).  In the image below, on the left side - underlined red. <br><br>  Go to the terminal.  Open a new terminal window ( <b>‚åòN</b> ) and from the same folder ‚ÄúMeme Collector.app‚Äù execute: <br><br><pre> <code class="bash hljs">strings -o <span class="hljs-string"><span class="hljs-string">"Meme Collector"</span></span></code> </pre><br>  The <code>strings</code> command searches for strings in a binary file, and the <code>-o</code> flag writes each line its position relative to the beginning of the file. <br><br>  Well, what is our address 159942?  Class names!  (Highlighted in red.) Logically, we searched for the <code>__objc_classname</code> section: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/672/a12/884/672a128844df847cb1d4242bf3bf3602.png"><br><br>  Directly above this section we see the <code>__objc_methname</code> section, it starts from 140887 - here we have method names (highlighted in blue), starting from the <code>init</code> method. <br><br><div class="spoiler">  <b class="spoiler_title">Advanced mode</b> <div class="spoiler_text">  I wonder why the <code>init</code> method comes first? <br></div></div><br>  Where method names end, class names immediately begin.  The <code>__objc_classname</code> section comes right after the <code>__objc_methname</code> section.  In the boot commands, they followed one after another - and loaded into memory sequentially. <br><br>  So, we see how load commands allow us to arrange the chaos that is represented by the Mach-O binary file.  With this knowledge, we proceed ... tadaaam!  to modify the code section. <br><br><h2>  Heavy artillery: disassembler and reverse engineering </h2><br>  Are you ready to use serious guns?  Finally, we will learn how to modify the application binary file! <br><br>  Probably, you often hear in your life the phrase: the application is ‚Äúhacked‚Äù.  This means that someone modified the application so that it works ... mmm ... otherwise than the developer intended.  For example, do not ask to register.  Therefore, we (the author and translator) sincerely hope that our work will serve you for good.  <b>Only</b> to protect your applications. <br><br>  Download <a href="https://www.hex-rays.com/products/ida/support/download_demo.shtml">IDA Demo</a> and some HEX editor, for example, <a href="http://ridiculousfish.com/hexfiend/">Hex Fiend</a> .  IDA is a tool that hackers turn to most often when they study binaries.  This is an incredibly powerful disassembler, debugger and decompiler.  And the full version is not that expensive. <br><br>  But if you are not ready to buy the program, which you heard about 15 seconds ago, IDA offers a demo version with limited functionality.  The demo version has limited types of assembler files that can be studied in it.  And also the ability to modify the code is disabled. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But it has our x86 assembly type. </font><font style="vertical-align: inherit;">And all the modifications we will do manually in another program - Hex Fiend.</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Advanced mode</font></font></b> <div class="spoiler_text"> ¬´ ‚Ä¶   x86?   ARM?¬ª ‚Äî  . , iOS-  ARM-.         x86. ,    ,      . </div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Install and run IDA. </font><font style="vertical-align: inherit;">We are greeted by Ada Lovelace - the world's first programmer: </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/4ea/ecb/0a5/4eaecb0a5374593a830dfae10f215520.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Click the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> button </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In the terminal, we (yes-yes) are still in the bundle folder ( </font></font><code>Meme Collector.app</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Enter the following command to display this folder in the Finder:</font></font><br><br><pre> <code class="bash hljs">open -R .</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do not forget the point at the end. The dot symbol here means "current folder". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then in the Finder window that opens, right-click&gt; </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Show package contents</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/f6e/396/ee5/f6e396ee537645e59580e64c4affca6b.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(OS Mavericks calls bundle a ‚Äúpackage‚Äù in Russian translation, but this name seems to me uninformative. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Note lane</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inside the bundle you will find the executable file </font></font><code>Meme Collector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, drag it into the IDA window and get the dialog box: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/5b5/09f/172/5b509f172790d9e67ca66e636594ca3a.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Indeed, IDA determined that this binary file is an executable file of the i386 architecture. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Your settings should correspond to those shown above (I think you don‚Äôt have to change anything) - and click </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Go!"</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OK The disassembler will parse the file into small pieces and make its mapping - what we did above, but ... how to say ... more professionally.</font></font> :) <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If asked ‚ÄúObjective-C 2.0 structures detected. Do you want to parse them and rename methods? ‚Äù- answer Yes. If you ask for something about proximity view, answer No. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When IDA finishes processing a binary file, you will of </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">course be shocked to</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> see the main screen. If the IDA window is not very similar to the one below, then in the left pane find the name of the function </font></font><code>start</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, click on it and then press the space bar until you see such a beautiful block diagram: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e07/e4d/ed9/e07e4ded9902675bd32745ec1bc6c948.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(In my case, it was not enough one space, I had to press Enter once or twice. Well, you quickly figure out what's what. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Note lane.</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And open the project in Xcode or AppCode. In order to shorten the presentation, we‚Äôll look at the code a little bit. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Open up</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MoneyManager.m</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and take a look at the method</font></font><code>buyObject:</code> <br><br><pre> <code class="cpp hljs">- (BOOL)buyObject:(id&lt;PurchasableItemProtocol&gt;)object { NSUInteger totalMoney = self.money.unsignedIntegerValue; NSUInteger cost = [object cost].unsignedIntegerValue; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (totalMoney &lt; cost) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NO; } _money = @(totalMoney - cost); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [self saveState]; }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Learn the algorithm, it's pretty simple. If the variable of the eclamption </font></font><code>_money</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">does not have enough sum to pay, the function will return </font></font><code>NO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and the transaction will not be executed. This conditional operator, allowing / prohibiting the purchase, relies on one boolean value: does the user have enough money? (Recalls the behavior of some people in the store? - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Approx. Lane.</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If this test was bypassed (‚Äújump over‚Äù, in terms of assembler), one could buy anything, then the value </font></font><code>_money</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">would </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no longer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> be considered a factor in the purchase. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we will find the same code in the disassembler. Go back to IDA, click on any function in the Functions panel (just to activate this panel) and then press </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ctrl + F</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(or from the menu: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Edit&gt; Quick Filter</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). An input field will appear to search for our function. We need to find </font></font><code>buyObject:</code> <br><br><img src="http://habrastorage.org/getpro/habr/post_images/a70/2b9/238/a702b92386d98fcb483a3db89db4b1f8.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aha, found, double click on the name of the method. IDA will show the disassembler window, which perfectly demonstrates the conditional operator and code branching: </font></font><br><br><img src="http://habrastorage.org/getpro/habr/post_images/6f7/538/26c/6f753826c05b354ac587d71014ea07bb.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Even if you do not know anything from </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> assembler </font><s><font style="vertical-align: inherit;">school course</font></s><font style="vertical-align: inherit;"> , from the comparison with the source code </font></font><code>buyObject:</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">you can assume that the green arrow to the right is exactly the place where we want to go hacking, there is a lot of action. A short code under the red arrow "to the left" looks more like a concise " </font></font><code>return nil</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I will load you a little with the assembler. Let's look at the conditional operator (‚Äújump‚Äù), the lowest one in the upper block, from which there are two arrows - red and green. it</font></font><b><code>jnb</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">which means "jump if not below" (to go if "not less"). Apparently, we should replace this instruction with ‚Äújump always‚Äù - instruction </font></font><b><code>jmp</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To replace the instruction, you need to find it. Double click the operand </font></font><code>jnb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. It will be highlighted in yellow. Now press the spacebar to go to text mode. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here is the same information, but in a linear form. Find the line number with the command </font></font><code>jnb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(this line is highlighted): </font></font><br><br><img src="http://habrastorage.org/getpro/habr/post_images/993/335/174/993335174a754e1330858719bc3a99a5.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In my case the address was 0x00018D88. Let me remind you that you can have any other address. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The operand code " </font></font><code>jnb short</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" is </font></font><code>0x73??</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">where question marks indicate the relative offset in bytes where we want to go. We need to change the operand code to </font></font><code>0xEB??</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- unconditional jump code "</font></font><code>jmp short</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"(for the same number of bytes). Where did I get the operand codes? For example, from the </font></font><a href="http://download.intel.com/products/processor/manual/325462.pdf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intel Software Developer's Manual</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (by the way, exciting reading!) </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Download (if you have not downloaded yet) </font></font><a href="http://ridiculousfish.com/hexfiend/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hex Fiend</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Install it, for example, by copying to a folder </font></font><code>/Applications</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. From the terminal (assuming that we are still in the ‚ÄúMeme Collector.app‚Äù bundle folder) type the command:</font></font><br><br><pre> <code class="bash hljs">open -a <span class="hljs-string"><span class="hljs-string">"/Applications/Hex Fiend.app/"</span></span> <span class="hljs-string"><span class="hljs-string">"Meme Collector"</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A window will open with our binary. </font><font style="vertical-align: inherit;">Beautiful, is not it? </font><font style="vertical-align: inherit;">Here they are - our friends: </font></font><code>__objc_classname</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and other sections. </font><font style="vertical-align: inherit;">Before us is clearly the header of the executable file. </font></font><br><br><img src="http://habrastorage.org/getpro/habr/post_images/1af/46d/0f5/1af46d0f57c8064e56fa5c6437cd1675.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now type in the terminal:</font></font><br><br><pre> <code class="bash hljs">otool -l <span class="hljs-string"><span class="hljs-string">"Meme Collector"</span></span> | grep -a10 <span class="hljs-string"><span class="hljs-string">"sectname __text"</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As we saw earlier, it </font></font><code>otool -l</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">displays the commands to load a binary file into memory. </font><font style="vertical-align: inherit;">We are interested in the code section (‚Äútext‚Äù section), so we narrow the search area with the command </font></font><code>grep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">We got something like this:</font></font><br><br><pre> <code class="bash hljs"> segname __TEXT vmaddr 0x00001000 vmsize 0x0002e000 fileoff 0 filesize 188416 maxprot 0x00000007 initprot 0x00000005 nsects 11 flags 0x0 Section sectname __text segname __TEXT addr 0x00002970 size 0x0001dec3 offset 6512 align 2^4 (16) reloff 0 nreloc 0 flags 0x80000400 reserved1 0 reserved2 0</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here we see the starting address of the section ( </font></font><code>addr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) 0x00002970, and the shift ( </font></font><code>offset</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) - 6512 (decimal). </font><font style="vertical-align: inherit;">You can take IDA and visually make sure that the starting address from which the code starts is exactly 0x2970, for this you need to scroll (in the "linear" form) to the very top. </font><font style="vertical-align: inherit;">(Remember, your specific values ‚Äã‚Äãmay differ, but the meaning is the same).</font></font><br><br>  Fine!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Time to do arithmetic: you need to recalculate the instruction offset </font></font><code>jnb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(found for the "text" section) to the absolute value inside the binary file. If you try to change the bytes at the address found in the IDA, you will probably have a crash somewhere, since they do not match. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In order not to distract us too much, I prepared for you a formula: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{absolute position of a command in a binary file} = </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{command address} - {starting address of the text section} + {shift of the text section} </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In my case: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Team address </font></font><code>jnb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= 0x18D88 (from IDA) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Text section start address = 0x2970 (from </font></font><code>otool</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Text section shift = decimal 6512 (from </font></font><code>otool</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Take the calculator, switch from the menu: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">View&gt; For programmer ...</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(do not forget to switch to the desired number system when entering decimal and hexadecimal numbers). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I got: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x18D88 - 0x2970 + 6512 = 0x17D88</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Advanced mode</font></font></b> <div class="spoiler_text">    ¬´Advanced Mode¬ª  ,              0x1000 (0x18D88 ‚Äì 0x17D88). </div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If your calculations were correct, this will be the address of the instruction </font></font><code>jnb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that we saw in the IDA. Now in Hex Fiend, click </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚åòL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (or from the menu </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Edit&gt; Jump To Offset</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) to open the address entry field. Enter your address value (if you enter in hexadecimal format, do not forget </font></font><code>0x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">at the beginning). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hmm, line numbers for some reason in decimal form. Well, let's recalculate: 0x17D88 = 97672, i.e. from position 97664 you need to count another 8 bytes to the right. 8 bytes = 16 hexadecimal digits = two 4-byte words. You see, Hex Fiend groups a binary "text" by the words: We </font></font><br><img src="http://habrastorage.org/getpro/habr/post_images/a1e/46a/c66/a1e46ac6604beb27b767e877ac6dc548.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">skip the first two words, and at the beginning of the third word - here it is - our opcode </font></font><code>0x7304</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><code>0x73</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- instruction code, and</font></font><code>0x04</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- offset by how many bytes the processor must "jump" forward. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Correct </font></font><code>0x73</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on </font></font><code>0xEB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(neatly: one click of Backspace deletes 1 byte = two hexadecimal characters at once). Save ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚åòS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) and close the file. Open the simulator, delete the application from the memory and run it again (from the simulator, not from the IDE, so that it does not compile again). ‚ÄúBuy‚Äù memes until you run out of money. What happened when you tried to buy a product that costs more than you have "money" left? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yes, we really threw out the check of the condition "does the user have money?" And a small bonus: unsigned value</font></font><code>_money</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Loops", due to the peculiarities of the representation of numbers in memory, instead of negative it becomes a little less than 10 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">32</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (about 4 billion).</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Reverse Engineering Protection </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How do we protect ourselves? </font><font style="vertical-align: inherit;">Remember, I said: "Nothing is safe." </font><font style="vertical-align: inherit;">This statement works here. </font><font style="vertical-align: inherit;">Reverse engineering can be very difficult, but you can't </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stop a</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> burglar if he is serious. </font><font style="vertical-align: inherit;">Your only hope is to confuse the intruders so much that they will give up and start breaking other applications. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One way is to change the names of important classes and methods through the preprocessor. </font><font style="vertical-align: inherit;">Open the project in the IDE and find the file ‚ÄúMeme Collector-Prefix.pch‚Äù in it. </font><font style="vertical-align: inherit;">Add a line to it:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MoneyManager DS_UIColor_Theme</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This code will replace all occurrences of " </font></font><code>MoneyManager</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" in a name that seems less interesting to hackers: " </font></font><code>DS_UIColor_Theme</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This approach should be applied with great care so as not to break anything. You need to make sure 100% that the selected new name is not found anywhere else in your application. Otherwise, you will confuse yourself; unexplainable things will start happening with the application. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Typically, an executable file has a symbol table that stores the mapping of addresses to the readable names of functions and methods. And now, another way to confuse the code is to delete the symbol table after building the project. This is more suitable for hiding C and C ++ functions, because Objective C messages are processed by a single function </font></font><code>objc_msgSend()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Open </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MoneyManager.m again</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and add the following C function to the beginning: </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">BOOL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">aSecretFunction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> YES; }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then compile the application again. </font><font style="vertical-align: inherit;">Check the existence of this function in the symbol table. </font><font style="vertical-align: inherit;">From the terminal:</font></font><br><br><pre> <code class="bash hljs">nm <span class="hljs-string"><span class="hljs-string">"Meme Collector"</span></span> | grep aSecretFunction</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The command </font></font><code>nm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">displays a table of characters, and </font></font><code>grep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">filters by function name. </font><font style="vertical-align: inherit;">Here, she is here:</font></font><br><br><pre> <code class="bash hljs">00018b8f t _aSecretFunction</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An easy way to remove a symbol table from an iOS application is to find two options in the project settings: Deployment Postprocessing and Strip Linked Product, and set them to Yes: </font></font><br><br><img src="http://habrastorage.org/getpro/habr/post_images/77a/06c/4aa/77a06c4aae3983741311d0025d84e361.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then you need to ‚Äúclean‚Äù the project (Xcode: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Product&gt; Clean</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or in AppCode: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Run&gt; Clean</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) and re-compile. </font><font style="vertical-align: inherit;">Then go to the terminal and run the same command:</font></font><br><br><pre> <code class="bash hljs">nm <span class="hljs-string"><span class="hljs-string">"Meme Collector"</span></span> | grep aSecretFunction</code> </pre><br>  Excellent!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We have successfully deleted the character that referred to </font></font><code>aSecretFunction()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Now the hacker will have to spend more time to find critical moments in the code.</font></font><br><br><h2>  What's next? </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We made sure that the attacker can: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> easy to see Objective C selector names; </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> manipulate the files accessed by your application; </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> intercept and modify network interaction; </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> manage the runtime environment; </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> change the executable file of your application. </font></font><br></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When creating an application, it is important to remember these things. Think about how much effort you are willing to make to make the application more secure. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is safety?</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It is always a balance between your resources (time), the level of problems for your users, and the likelihood of hacking. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The security of an iOS application is a serious topic. You can still learn a lot. So far we have barely scratched the surface. The whole range of features of the debugger and other analysis tools is much deeper. If you are interested in this topic, I advise you to think about jailbreaking the test device. The file system will provide rich research food. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you have no problems with English, be sure to check out the book </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hacking and Securing iOS Applications</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(author Jonathan Zdziarski). </font><font style="vertical-align: inherit;">Although it is slightly outdated (you‚Äôll have to google it for changes in the encryption mechanism of Apple applications), but the author of the article is one of the favorite books on iOS and security. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A couple of books: </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hacking: of The Art of Exploitation, 2nd Edition</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by of Jon Erickson </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the Mac OS the X and iOS Internals: the To the Core Apple's's</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by of Jonathan Levin</font></font><br>  Forums: <br> <a href="http://www.woodmann.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://www.woodmann.com </font></font></a> <br> <a href="http://www.reddit.com/r/ReverseEngineering"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://www.reddit.com/r/ReverseEngineering</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Article on code injection: </font></font><br> <a href="http://blog.timac.org/%3Fp%3D761"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://blog.timac.org/?p=761 The</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> author can be written </font></font><a href="http://www.raywenderlich.com/46223/ios-app-security-analysis-part-2"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the comments</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and on the translation write on mail </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev </font></font><code>@</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x128.ru</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div><p>Source: <a href="https://habr.com/ru/post/199130/">https://habr.com/ru/post/199130/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../199112/index.html">Interprocedural analysis and optimization (I)</a></li>
<li><a href="../199114/index.html">Remote work is not "freelancing"</a></li>
<li><a href="../199116/index.html">We create the first application on NancyFX. Part Three Nancy modules</a></li>
<li><a href="../199124/index.html">iversity - online courses from the European platform MOOC</a></li>
<li><a href="../199128/index.html">We break iOS-application. Part 1</a></li>
<li><a href="../199132/index.html">In Kenya, Wikipedia articles are now available via SMS.</a></li>
<li><a href="../199134/index.html">Firefox 25 release</a></li>
<li><a href="../199136/index.html">Developer Interview</a></li>
<li><a href="../199138/index.html">Network for the smallest. Micro issue ‚Ññ4. Immersion in IOU</a></li>
<li><a href="../199142/index.html">How we used matlab. Story of a single file</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>