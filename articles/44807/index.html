<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MySQL and JOINs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The reason for writing this article was some debates in one of the groups of linkedin related to MySQL, as well as communication with colleagues and h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MySQL and JOINs</h1><div class="post__text post__text-html js-mediator-article">  The reason for writing this article was some debates in one of the groups of linkedin related to MySQL, as well as communication with colleagues and habroles :-) <br><br>  In this article I wanted to write what JOINs are in general in MySQL and how you can optimize queries with them. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  What are JOINs in MySQL? </h4><br><br>  In MySQL, the term JOIN is used much more broadly than might be supposed.  Here JOIN can be called not only a query that combines the results from several tables, but also a query to one table, for example, SELECT on one table - this is also a join. <br><br>  That's because the algorithm for executing joins in MySQL is implemented using nested loops.  Those.  each subsequent JOIN is an additional nested loop.  To execute the query and return all the records that satisfy the condition MySQL performs a cycle and runs through the records of the first table in parallel, checking the conditions described in the request body when there are records that meet the conditions ‚Äî in the nested loop, the second table looks for records that match the first and satisfy the verification conditions and m .d <br><br>  Standard query with INNER JOIN <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">SELECT</font> <br> * <br> <font color="#0000ff">FROM</font> <br> Table1 <br> <font color="#0000ff">INNER</font> <font color="#0000ff">JOIN</font> <br> Table2 <font color="#0000ff">ON</font> P1(Table1,Table2) <br> <font color="#0000ff">INNER</font> <font color="#0000ff">JOIN</font> <br> Table3 <font color="#0000ff">ON</font> P2(Table2,Table3) <br> <font color="#0000ff">WHERE</font> <br> P(Table1,Table2,Table3). <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  where P is the table splicing conditions and filters in the WHERE condition. <br><br>  You can imagine such a pseudo code for such a query. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">FOR each row t1 <font color="#0000ff">in</font> Table1 { <br> IF(P(t1)) { <br> FOR each row t2 <font color="#0000ff">in</font> Table2 { <br> IF(P(t2)) { <br> FOR each row t3 <font color="#0000ff">in</font> Table3 { <br> IF P(t3) { <br> t:=t1||t2||t3; OUTPUT t; <br> } <br> } <br> } <br> } <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  where the construction t1 || t2 || t3 means the concatenation of columns from different tables. <br><br>  If the query contains OUTER JOINs, for example, LEFT OUTER JOIN <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">SELECT</font> <br> * <br> <font color="#0000ff">FROM</font> <br> Table1 <br> <font color="#0000ff">LEFT</font> <font color="#0000ff">JOIN</font> <br> ( <br> Table2 <font color="#0000ff">LEFT</font> <font color="#0000ff">JOIN</font> Table3 <font color="#0000ff">ON</font> P2(Table2,Table3) <br> ) <br> <font color="#0000ff">ON</font> P1(Table1,Table2) <br> <font color="#0000ff">WHERE</font> <br> P(Table1,Table2,Tabke3) <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  then the algorithm for executing this query MySQL will look something like this <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">FOR each row t1 <font color="#0000ff">in</font> T1 { <br> BOOL f1:=FALSE; <br> FOR each row t2 <font color="#0000ff">in</font> T2 such that P1(t1,t2) { <br> BOOL f2:=FALSE; <br> FOR each row t3 <font color="#0000ff">in</font> T3 such that P2(t2,t3) { <br> IF P(t1,t2,t3) { <br> t:=t1||t2||t3; OUTPUT t; <br> } <br> f2=TRUE; <br> f1=TRUE; <br> } <br> IF (!f2) { <br> IF P(t1,t2,NULL) { <br> t:=t1||t2||NULL; OUTPUT t; <br> } <br> f1=TRUE; <br> } <br> } <br> IF (!f1) { <br> IF P(t1,NULL,NULL) { <br> t:=t1||NULL||NULL; OUTPUT t; <br> } <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  You can read more about it here - <a href="http://dev.mysql.com/doc/refman/5.1/en/nested-joins.html">dev.mysql.com/doc/refman/5.1/en/nested-joins.html</a> <br><br>  So, as we can see, JOINs are just a group of nested loops.  So why in MySQL and UNION and SELECT and queries with SUBQUERY are also joins? <br><br>  MySQL optimizer tries to lead queries to the form to which it is more convenient for it to process and execute queries according to the standard scheme. <br><br>  With SELECT, everything is clear - just a loop without nested loops.  All UNIONs are executed as separate queries and the results are added to a temporary table, and then MySQL is already working with this table, i.e.  looping through the entries in it.  Subquery is the same story. <br><br>  Leading everything to one pattern, for example, MySQL rewrites all RIGHT JOIN requests for LEFT JOIN equivalents. <br><br>  But the strategy of executing queries through nested loops imposes some limitations, for example, in connection with such a scheme, MySQL does not support the execution of <a href="http://en.wikipedia.org/wiki/Join_(SQL)">FULL OUTER JOIN</a> queries. <br><br>  But the result of such a query can be obtained using the UNION of two queries on LEFT JOIN and on RIGHT JOIN. <br>  An example of the request itself can be viewed on the wiki link. <br><br><h4>  JOIN query execution plan </h4><br><br>  Unlike other RDBMSs, MySQL does not generate bytecodes to execute the query, instead MySQL generates a list of instructions in a tree form that the query execution engine follows when executing the query. <br>  This tree has the following form and has the name "left-deep tree" <br><img src="https://habrastorage.org/getpro/habr/post_images/279/9c2/e38/2799c2e387dc87a15462aa2ffd2936a2.jpg" alt="image"><br><br>  Unlike balanced trees (Bushy plan), which are used in other DBMS (for example Oracle) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/847/d8e/5dc/847d8e5dcbbbbfa4cf581ba817397f70.jpg" alt="image"><br><br><h4>  JOIN optimization </h4><br><br>  We now turn to the most interesting - to optimize joins. <br>  MySQL optimizer, namely the part that is responsible for optimizing JOINs, selects the order in which the existing tables will be glued together, because  You can get the same result (dataset) with a different order of tables in the gluing.  MySQL optimizer estimates the cost of various plans and selects with the lowest cost.  The unit of evaluation is a single-read operation of a 4-kilobyte data page from arbitrary disk space. <br><br>  For the selected plan, you can find out the cost by executing the command <br><br>  SHOW SESSION STATUS LIKE 'Last_query_cost'; <br><br>  after completing the query that interests us.  The variable Last_query_cost is a session variable.  The description of the <a href="http://dev.mysql.com/doc/refman/5.1/en/server-status-variables.html">Last_query_cost</a> variable in the MySQL documentation can be found here - <a href="http://dev.mysql.com/doc/refman/5.1/en/server-status-variables.html">dev.mysql.com/doc/refman/5.1/en/server-status-variables.html#option_mysqld_Last_query_cost</a> <br><br>  Estimation is based on statistics: the number of memory pages occupied by the table and / or indexes for this table, cardinality (number of unique values) of indexes, the length of records and indexes, their distribution, etc.  During its evaluation, the optimizer does not expect any parts to fall into the cache, the optimizer assumes that each read operation is a disk access. <br><br>  Sometimes the analyzer-optimizer cannot analyze all possible execution plans and chooses the wrong one.  For example, if we have an INNER JOIN in 3 tables, then the analyzer has 3 possible options!  = 6, and if we have gluing together on 10 tables, then there are already 10 possible options!  = 3628800 ... MySQL cannot analyze so many variants, therefore in this case it uses the " <a href="http://ru.wikipedia.org/wiki/%25D0%2596%25D0%25B0%25D0%25B4%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25B0%25D0%25BB%25D0%25B3%25D0%25BE%25D1%2580%25D0%25B8%25D1%2582%25D0%25BC">greedy</a> " search algorithm. <br><br>  And just to solve this problem, we can use the STRAIGHT_JOIN construction.  In fact, I am opposed to similar hacks like FORCE INDEX and STRAIGH_JOIN, more precisely, against their mindless use wherever possible and impossible.  In this case, you can :-) Having clarified (either experimentally making queries with STRAIGH_JOIN and evaluating Last_query_cost, or empirically) the necessary order of joins, you can rewrite the query with the tables in the appropriate order and add STRAIGH_JOIN to this query, so we immediately kill two hares - we define the correct execution plan for the request (this is the main hare) and save time at the ‚ÄúStatistic‚Äù stage (All stages of the request can be viewed by setting the profiling of requests with the SET PROFILING = 1 command, I described this in my previous article on  <a href="http://habrahabr.ru/blogs/mysql/39818/">profiling of queries</a> in MySQL) <br><br>  <b>But you should not apply this hack to all queries, expecting to optimize on matches and save time on drawing up a plan for query execution by the optimizer and add STRAIGH_JOIN to all queries with joins</b> , since  the data is changing and the gluing, which is optimal now, may cease to be optimal with time, and then the requests to start very much lag. <br><br>  Also, as mentioned above, the joins are placed in temporary tables, so it is often appropriate to use the ‚Äúderived table‚Äù in which we impose all the necessary conditions on the sample, and also indicate the LIMIT and the sort order.  In this case, we will get rid of data redundancy in the temporary table, as well as perform the sorting at an early stage (according to the result of one sample, and not the final splicing, which will reduce the size of the records that will be sorted). <br><br>  The standard example of the approach described above.  A simple sample for a lot of things to many: news and tags to them. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">SELECT</font> <br> t.tid, t.description, n.nid, n.title, n. <font color="#0000ff">extract</font> , n.modtime <br> <font color="#0000ff">FROM</font> <br> ( <br> <font color="#0000ff">SELECT</font> <br> n.nid <br> <font color="#0000ff">FROM</font> <br> news n <br> <font color="#0000ff">WHERE</font> <br> n.type = 1321 <br> <font color="#0000ff">AND</font> n.published = 1 <br> <font color="#0000ff">AND</font> status = 1 <br> <font color="#0000ff">ORDER</font> <font color="#0000ff">BY</font> <br> n.modtime <font color="#0000ff">DESC</font> <br> <font color="#0000ff">LIMIT</font> <br> 200 <br> ) <font color="#0000ff">as</font> news <br> <font color="#0000ff">INNER</font> <font color="#0000ff">JOIN</font> <br> news n <font color="#0000ff">ON</font> n.nid = news.nid <br> <font color="#0000ff">INNER</font> <font color="#0000ff">JOIN</font> <br> news_tag nt <font color="#0000ff">ON</font> n.nid = nt.nid <br> <font color="#0000ff">INNER</font> <font color="#0000ff">JOIN</font> <br> tags t <font color="#0000ff">ON</font> nt.tid = t.tid <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  And lastly there is a small problem, which I sometimes ask during interviews :-) <br><br>  There is a news blogger site.  There are such entities as news and comments to them. <br><br>  The task - you need to write a request that displays a list of 10 news of a certain type (set by the user) sorted by publication time in chronological order, as well as for each of these news to show no more than 10 recent comments, i.e.  if there are more comments, we show only the last 10. <br><br>  Everything needs to be done in one request.  Yes, this may not be the best way, and you are free to propose another solution :-) <br><br></div><p>Source: <a href="https://habr.com/ru/post/44807/">https://habr.com/ru/post/44807/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../448052/index.html">Mikrotik. IPSEC vpn over NAT as client</a></li>
<li><a href="../448054/index.html">SciPy, conditions optimization</a></li>
<li><a href="../448058/index.html">Developing a hexapod from scratch (part 5) - electronics</a></li>
<li><a href="../448060/index.html">We write a simple NTP client</a></li>
<li><a href="../448068/index.html">American scientists have taught robots to use auxiliary tools</a></li>
<li><a href="../448072/index.html">Joins understanding is broken. This is definitely not a lap crossing, honestly</a></li>
<li><a href="../448074/index.html">ALU on 12 transistors (actually not)</a></li>
<li><a href="../448076/index.html">Simple simulation system on Go</a></li>
<li><a href="../448078/index.html">On autoregressive estimation of the spectral density of a stationary signal</a></li>
<li><a href="../44808/index.html">Sun Mi—Årosystems released StarOffice 9</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>