<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementing domain-specific design in PHP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello again! 

 Well, the next ‚Äúnew‚Äù course, which started at the end of December, is coming to an end - ‚ÄúBackend developer in PHP‚Äù . Took into accoun...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementing domain-specific design in PHP</h1><div class="post__text post__text-html js-mediator-article">  Hello again! <br><br>  Well, the next ‚Äúnew‚Äù course, which started at the end of December, is coming to an end - <a href="https://otus.pw/EAx8/">‚ÄúBackend developer in PHP‚Äù</a> .  Took into account various small roughness and launch a new one.  It remains only to look at the issue and everything, put another tick. <br><br>  But wait a minute, let's look at one interesting article. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Go. <br><br>  In this article, you will learn how to use PHP to manage the next DDD project of your company and effectively model real-world situations to help define your business logic. <br><br>  Domain-driven design (Domain-Driven Design, hereinafter - DDD) is a software development methodology for designing complex software projects with the aim of delivering the final product that meets the objectives of the organization.  In fact, DDD helps to focus the project on the evolving base model. <br>  DDD will teach you how to effectively model the real world in your application and use OOP to encapsulate the organization's business logic. <br><br><img src="https://habrastorage.org/webt/c9/kl/bd/c9klbde9pex9uzqnz3kclbzwyzu.jpeg"><a name="habracut"></a><br><br><h4>  What is a domain model? </h4><br>  In my opinion, the Domain Model is your perception of the context to which it relates.  I will try to explain in more detail.  "Area" in itself means the world of business with which you work, and the tasks that it is intended to solve.  For example, if you want to develop an application for online food delivery, everything in your subject area (tasks, business rules, etc.) will be about online food delivery that needs to be implemented in your project. <br><br>  The domain model is your structured problem solution.  It should be a dictionary and key concepts of tasks from the subject area. <br><br><h4>  Common language </h4><br>  ‚ÄúUnified Language‚Äù (‚ÄúUbiquitous Language‚Äù) is the language used by business professionals to describe a domain model.  This means that the development team consistently uses this language in all interactions and in the code.  The language should be based on a region model.  Let me give an example: <br><br><pre><code class="php hljs">$product = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Entity\Product(); $product-&gt;setTitle(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Title(<span class="hljs-string"><span class="hljs-string">'Mobile Phone'</span></span>)); $product-&gt;setPrice(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Price(<span class="hljs-string"><span class="hljs-string">'1000'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;em-&gt;persist($product); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;em-&gt;flush();</code> </pre> <br>  In the code above, I create a new product, but in the application the product must be added, not created: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//add is a static method in product class $product = Product::add( new Title('Mobile Phone'), new Price('1000') );</span></span></code> </pre><br>  If in the development team, someone creates a product, and someone adds, it violates a single language.  In this case, if we have additional actions in the method of adding a product, such as sending emails, they will all be skipped and the definition of adding a product to the team will be changed.  We would have two different definitions for the same term. <br><br><h4>  Layered architecture </h4><br>  In this article, I'm not going to talk about object-oriented design.  But DDD involves the basics of good design.  Eric Evans (Eric Evans - author of the book ‚ÄúDomain-Oriented Design (DDD). Structuring Complex Software Systems‚Äù) believes that the development of a good domain model is an art. <br><br>  To develop a good domain model, you need to know about Model-Driven Design.  Model-Driven Design - combining model and implementation.  Layered architecture is one of its blocks. <br><br>  Layered Architecture is the idea of ‚Äã‚Äãisolating each part based on many years of experience and collaboration from developers.  Layers are listed below: <br><br><ul><li>  User interface </li><li>  Application level </li><li>  Domain Level </li><li>  Infrastructure level </li></ul><br>  The user interface is responsible for displaying information to the user and interpreting his commands.  In Laravel, a mapping is a user interface layer (presentation).  The application level is a way to communicate with the outside world (outside the domain).  This layer behaves like an open API for our application.  It does not contain business rules or knowledge.  In Laravel controllers are located right here. <br><br>  Domain level is the heart of business software.  This level is responsible for presenting business concepts, information about the business situation and business rules.  The infrastructure layer provides general technical capabilities that support higher layers and also supports the structure of the interactions between the four layers (which is why the repositories are in this layer). <br><br>  The connection between the layers is mandatory, but without losing the benefits of separation.  Communication takes place in one direction.  As can be seen from the diagram above, the upper layers can interact with lower levels.  If the bottom layers are to be connected to the top layer, they should use patterns such as Callback or Observer. <br><br><h4>  Value Objects and Entities </h4><br>  I'm a big fan of Value Objects.  I think they are the essence of OOP.  Although DDD value objects seem simple, they are a serious source of confusion for many, including me.  I read and heard many different ways of describing value objects from different points of view.  Fortunately, each of the different explanations rather helped me to deepen the understanding of object values, rather than contradict each other. <br><br>  Value objects are accessible by their value, not by their identifier.  These are immutable objects.  Their values ‚Äã‚Äãdo not change (or change, but rarely) and do not have a life cycle (this means that they are not as rows of database tables that can be deleted), for example, currencies, dates, countries, etc. <br><br>  You can create value objects that you do not recognize as value objects.  For example, an email address can be a string, or it can be a value object with its own set of behaviors. <br><br>  The code below shows an example of a value object class: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImagesTypeValueObject</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $imageType; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $validImageType = [<span class="hljs-string"><span class="hljs-string">'JPEG'</span></span>, <span class="hljs-string"><span class="hljs-string">'GIF'</span></span>, <span class="hljs-string"><span class="hljs-string">'BMP'</span></span>, <span class="hljs-string"><span class="hljs-string">'TIFF'</span></span>, <span class="hljs-string"><span class="hljs-string">'PNG'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($imageType)</span></span></span><span class="hljs-function"> </span></span>{ Assertion::inArray(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;validImageType, $imageType, <span class="hljs-string"><span class="hljs-string">'Sorry The entry is wrong please enter valid image type'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;imageType = $imageType; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;imageType; } }</code> </pre><br>  Entities are objects accessible by identifiers in our application.  In fact, an entity is a set of properties that have a unique identifier.  A good example is the number of database tables.  An entity is changeable, because it can change its attributes (usually with the help of setters and getters), and also has a life cycle, that is, it can be deleted. <br><br>  The object is something with continuity and identity - something that is tracked in different states or even in different implementations?  Or is it an attribute that describes the state of something else?  This is the main difference between an entity and a value object. <br><br><h4>  Aggregates </h4><br>  A model may contain a large number of domain objects.  Regardless of how much we foresee when modeling a region, it often happens that many objects are dependent on each other, creating a set of relationships, and you cannot be 100% sure of the result.  In other words, you should be aware of the business rule that must always be followed in your domain model;  Only with this knowledge can you talk about your code with confidence. <br><br>  Aggregates help reduce the number of bidirectional associations between objects in the system, because you are allowed to store references only to the root.  This greatly simplifies the design and reduces the number of blind changes in the object graph.  On the other hand, aggregates help with the decoupling of large structures by establishing the rules of relations between entities.  (Note: aggregates can also have properties, methods and invariants that do not fit into one class) <br><br>  Eric Evans, in his book, set some rules for implementing aggregates, and I list them below: <br><br><ul><li>  The root object has a global identity and is ultimately responsible for checking invariants. </li><li>  Root objects have a global identity.  Internal entities have a local identity, unique only within the aggregate. </li><li>  Nothing outside the boundaries of an aggregate can contain a link to anything inside but the root object.  The root object can associate links with internal objects to other objects, but these objects can only use them temporarily and cannot be attached to the link. </li><li>  As a consequence of the above rule, only basic roots can be obtained directly with database queries.  All other objects must be found by traversing associations. </li><li>  Objects within an aggregate may contain references to other aggregate roots. </li><li>  The delete operation should immediately delete everything within the common boundary (with garbage collection it is easy. Since there are no external links to anything other than the root, delete the root and everything else will be collected). </li><li>  When a change is made on an object at the boundary of the aggregate, all invariants of the aggregate must be satisfied. </li></ul><br><h4>  Factories </h4><br>  In the OOP world, a Factory is an object that is only responsible for creating other objects.  In DDD, factories are used to encapsulate the knowledge needed to create objects, and they are especially useful for creating aggregates. <br><br>  The root of an aggregate that provides a factory method for creating instances of an aggregate of a different type (or internal parts) will have primary responsibility for ensuring its basic aggregating behavior, and the factory method is just one of them.  Factories can also provide an important level of abstraction that protects the client from dependence on a particular class. <br><br>  There are cases when the factory is not needed, and a simple constructor is enough.  Use the constructor when: <br><br><ul><li>  The design is not complicated. </li><li>  Creating an object is not related to creating others, and all the necessary attributes are passed through the constructor. </li><li>  The developer is interested in implementation and may want to choose a strategy to use. </li><li>  Class - type.  There is no hierarchy, so there is no need to choose between a list of specific implementations. </li></ul><br><h4>  Storage </h4><br>  Storage is the layer that lies between the domain of your project and the database.  Martin Fowler, in his book Corporate Application Templates, writes that storage is an intermediate interaction between a domain and a data mapping layer using an interface like a collection for accessing domain objects. <br>  This means that you should think about accessing the data in your database as well as the standard collection objects. <br><br>  Let me explain in a bit more detail.  Imagine that in DDD you may need to create an object either with a constructor or with a factory;  you must request it from the root of the unit.  The problem is that the developer must have a link to the root.  For large applications, this becomes a problem, because you need to make sure that developers always have a link to the required object.  This will lead to the creation by the developers of a number of associations that are not really needed. <br><br>  Another reason why storage is important is access to the database.  The programmer does not need to know the details needed to access it.  Because the database is at the infrastructure level, it has to deal with a lot of the details of the infrastructure, and not with the concepts of the domain.  In addition, if the developer requests the launch of the request, it will lead to the disclosure of even more internal parts required by the request. <br><br>  If we do not have storage, the focus of the domain will be lost, and the design will be compromised.  Therefore, if developers use queries to access data from the database or pull out several specific objects, the domain logic moves into queries and developer code, so the aggregates will be useless. <br><br>  Finally, the repository acts as a storage place for objects available worldwide.  Storage may also include a strategy.  It can access one persistent storage or another based on a specified strategy. <br><br><h4>  Implementation in Laravel </h4><br>  As you might know, the best choice for implementing DDD in PHP is Doctrine ORM.  To implement aggregates and storage, we need to make some changes to our entities and create some files at our domain level. <br><br>  I decided to implement a small part of the application in which the user can create a page or edit it.  Each page may contain many comments, and each comment may contain some sub-comments.  Administrators can approve / reject comments after adding them. <br><br>  In the above scenario, the first step is to create the base storage in the domain level, the base storage obtained from the Doctrine EntityRepository, which will allow us to have all the built-in functions of the Doctrine storage.  Here we can also use our shared functionality, and all our repositories should inherit from it.  The implementation looks like this: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Repositories</span></span>\<span class="hljs-title"><span class="hljs-title">Database</span></span>\<span class="hljs-title"><span class="hljs-title">DoctrineORM</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Events</span></span>\<span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">DoctrineEventSubscriber</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">Common</span></span>\<span class="hljs-title"><span class="hljs-title">Persistence</span></span>\<span class="hljs-title"><span class="hljs-title">Event</span></span>\<span class="hljs-title"><span class="hljs-title">LifecycleEventArgs</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">ORM</span></span>\<span class="hljs-title"><span class="hljs-title">EntityRepository</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">ORM</span></span>\<span class="hljs-title"><span class="hljs-title">Mapping</span></span>\<span class="hljs-title"><span class="hljs-title">ClassMetadata</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">ORM</span></span>\<span class="hljs-title"><span class="hljs-title">EntityManager</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">GeneratedHydrator</span></span>\<span class="hljs-title"><span class="hljs-title">Configuration</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">Common</span></span>\<span class="hljs-title"><span class="hljs-title">Collections</span></span>\<span class="hljs-title"><span class="hljs-title">ArrayCollection</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DoctrineBaseRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EntityRepository</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $primaryKeyName; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $entityName = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(EntityManager $em)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::__construct($em, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClassMetadata(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;entityClass)); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;primaryKeyName = $em-&gt;getClassMetadata(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;entityClass)-&gt;getSingleIdentifierFieldName(); } }</code> </pre><br>  We have two repositories.  The first is the repository of pages, and the second is the repository of comments.  All stores must have an entityClass property to define an entity class.  In this case, we can encapsulate (the private property) object in our storage: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Repositories</span></span>\<span class="hljs-title"><span class="hljs-title">Database</span></span>\<span class="hljs-title"><span class="hljs-title">DoctrineORM</span></span>\<span class="hljs-title"><span class="hljs-title">Page</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Model</span></span>\<span class="hljs-title"><span class="hljs-title">Entities</span></span>\<span class="hljs-title"><span class="hljs-title">Pages</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Repositories</span></span>\<span class="hljs-title"><span class="hljs-title">Database</span></span>\<span class="hljs-title"><span class="hljs-title">DoctrineORM</span></span>\<span class="hljs-title"><span class="hljs-title">DoctrineBaseRepository</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DoctrinePageRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DoctrineBaseRepository</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $entityClass = Pages::class; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddComments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($pages)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_em-&gt;merge($pages); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_em-&gt;flush(); } }</code> </pre><br>  I use the Doctrine command line to generate entities: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Interactions</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Model</span></span>\<span class="hljs-title"><span class="hljs-title">Entities</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>\<span class="hljs-title"><span class="hljs-title">Comments</span></span>\<span class="hljs-title"><span class="hljs-title">Model</span></span>\<span class="hljs-title"><span class="hljs-title">Entities</span></span>\<span class="hljs-title"><span class="hljs-title">Comments</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">Common</span></span>\<span class="hljs-title"><span class="hljs-title">Collections</span></span>\<span class="hljs-title"><span class="hljs-title">ArrayCollection</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">ORM</span></span>\<span class="hljs-title"><span class="hljs-title">Mapping</span></span> <span class="hljs-title"><span class="hljs-title">as</span></span> <span class="hljs-title"><span class="hljs-title">ORM</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Pages * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Table(name="pages") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Entity */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Pages</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(name="page_title", type="string", length=150, nullable=false) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $pageTitle; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\OneToMany(targetEntity="App\Domain\User\Comments\Model\Entities\Comments", mappedBy="pageId", indexBy="pageId", cascade={"persist", "remove"}) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $pageComment; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> integer * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(name="page_id", type="integer") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Id * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\GeneratedValue(strategy="IDENTITY") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $pageId; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;pageComment = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayCollection(); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> Comment * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addComments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Comments $comment)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;pageComment[] = $comment; } <span class="hljs-comment"><span class="hljs-comment">//... other setters and getters. } namespace App\Domain\User\Comments\Model\Entities; use Doctrine\ORM\Mapping as ORM; /** * Comments * * @ORM\Table(name="comments") * @ORM\Entity */ class Comments { /** * @ORM\ManyToOne(targetEntity="App\Domain\User\Core\Model\Entities\Users") * @ORM\JoinColumn(name="users_user_id", referencedColumnName="id") */ private $usersUserId; /** * @ORM\ManyToOne(targetEntity="comments", inversedBy="children") * @ORM\JoinColumn(name="parent_id", referencedColumnName="comment_id") */ private $parentId; /** * @ORM\ManyToOne(targetEntity="App\Domain\Interactions\Core\Model\Entities\pages", inversedBy="pageComment" ) * @ORM\JoinColumn(name="page_id", referencedColumnName="page_id") */ private $pageId; /** * @ORM\OneToMany(targetEntity="comments", mappedBy="parent") */ private $children; /** * @param Page * @return void */ public function __construct() { $this-&gt;children = new\Doctrine\Common\Collections\ArrayCollection(); } }</span></span></code> </pre><br>  As you can see, in the above code, I define relationships in the annotations of objects.  Implementing relationships in Doctrine ORM may seem very difficult, but in fact it is not so difficult when you get to know how everything works.  The only way to add comments is to call the addComments of the page object, and this method only accepts the comment entity object as input.  This will make us confident in the functionality of our code. <br><br>  My unit looks like this: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Comment</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>\<span class="hljs-title"><span class="hljs-title">Comments</span></span>\<span class="hljs-title"><span class="hljs-title">Model</span></span>\<span class="hljs-title"><span class="hljs-title">Entities</span></span>\<span class="hljs-title"><span class="hljs-title">Comments</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Repositories</span></span>\<span class="hljs-title"><span class="hljs-title">Database</span></span>\<span class="hljs-title"><span class="hljs-title">DoctrineORM</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>\<span class="hljs-title"><span class="hljs-title">DoctrineCommentRepository</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Repositories</span></span>\<span class="hljs-title"><span class="hljs-title">Database</span></span>\<span class="hljs-title"><span class="hljs-title">DoctrineORM</span></span>\<span class="hljs-title"><span class="hljs-title">Interactions</span></span>\<span class="hljs-title"><span class="hljs-title">DoctrinePagesRepository</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Assert</span></span>\<span class="hljs-title"><span class="hljs-title">Assertion</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PageAggregate</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $Pages; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $pageResult; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $parentId = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $comments; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $DoctrineRepository = DoctrinePagesRepository::class; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id, $comments = null, $administrative = null)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;DoctrineRepository = \App::make(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;DoctrineRepository); Assertion::notNull(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;pageResult = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;DoctrineRepository-&gt;findOneBy([<span class="hljs-string"><span class="hljs-string">'pageId'</span></span> =&gt; $id]), <span class="hljs-string"><span class="hljs-string">'sorry the valid page id is required here'</span></span>); $commentFacory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Commentfactory(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;pageResult, $comments); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $commentFacory-&gt;choisir($administrative); } }</code> </pre><br>  We need an aggregate that is responsible for restricting access to comments if the PageId is valid;  I mean that without PageId access to comments is impossible.  Say, comments without a valid page id are meaningless and inaccessible.  In addition, there is a factory comment method that helps us encapsulate business rules. <br><br>  Factory Method: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Comment</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommentTypeFactoryInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">confectionner</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Comment</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommentFactoryInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">choisir</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre><br>  I identified two factories.  The first is the type of comments, and the second is the comment interfaces, which make it mandatory for each comment when implementing the choisir method. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Comment</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Application</span></span>\<span class="hljs-title"><span class="hljs-title">Factory</span></span>\<span class="hljs-title"><span class="hljs-title">Request</span></span>\<span class="hljs-title"><span class="hljs-title">RequestFactory</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Commentfactory</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommentFactoryInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $page; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $comment; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $parentId; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($page, $comment = null)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;page = $page; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;comment = $comment; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">choisir</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($administrative = null)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> Implement choisir() method. if (is_null($administrative)) { $comment = new Comment($this-&gt;page, $this-&gt;comment); return $comment-&gt;confectionner(); } $comment = new AdministrativeComments($this-&gt;page, $this-&gt;comment, $this-&gt;parentId); return $comment-&gt;confectionner(); } }</span></span></code> </pre><br>  The Factory method Comment provides internal parts of the unit. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Comment</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>\<span class="hljs-title"><span class="hljs-title">Comments</span></span>\<span class="hljs-title"><span class="hljs-title">Model</span></span>\<span class="hljs-title"><span class="hljs-title">Entities</span></span>\<span class="hljs-title"><span class="hljs-title">Comments</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Repositories</span></span>\<span class="hljs-title"><span class="hljs-title">Database</span></span>\<span class="hljs-title"><span class="hljs-title">DoctrineORM</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>\<span class="hljs-title"><span class="hljs-title">DoctrineCommentRepository</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Repositories</span></span>\<span class="hljs-title"><span class="hljs-title">Database</span></span>\<span class="hljs-title"><span class="hljs-title">DoctrineORM</span></span>\<span class="hljs-title"><span class="hljs-title">Interactions</span></span>\<span class="hljs-title"><span class="hljs-title">DoctrinePagesRepository</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Interactions</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Model</span></span>\<span class="hljs-title"><span class="hljs-title">Entities</span></span>\<span class="hljs-title"><span class="hljs-title">Pages</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Application</span></span>\<span class="hljs-title"><span class="hljs-title">Factory</span></span>\<span class="hljs-title"><span class="hljs-title">Request</span></span>\<span class="hljs-title"><span class="hljs-title">RequestFactory</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Assert</span></span>\<span class="hljs-title"><span class="hljs-title">Assertion</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Comment</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommentTypeFactoryInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $page; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $comments; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $DoctrineCommentRepository = DoctrineCommentRepository::class; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $DoctrineRepository = DoctrinePagesRepository::class; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Pages $page, $comment)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;page = $page; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;comments = $comment; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;DoctrineCommentRepository = \App::make(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;DoctrineCommentRepository); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;DoctrineRepository = \App::make(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;DoctrineRepository); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">confectionner</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_array(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;comments)) { \Request::replace(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;comments[<span class="hljs-string"><span class="hljs-string">'data'</span></span>]); \App::make(RequestFactory::class); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;addComments(); } <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> (is_null(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;comments)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;retrieveComments(); } <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> (is_int(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;comments)) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;deleteComment(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addComments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;comments[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]) &amp;&amp; !is_null(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;comments[<span class="hljs-string"><span class="hljs-string">'object'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;DoctrineCommentRepository-&gt;findOneBy([<span class="hljs-string"><span class="hljs-string">'commentId'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;comments[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]]))) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;editComment(); } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;comments = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;CommentObjectMapper(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Comments(), <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;comments[<span class="hljs-string"><span class="hljs-string">'data'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;page-&gt;addComments(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;comments); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;DoctrineRepository-&gt;AddComments(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;page); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">editComment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $comment = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;CommentObjectMapper(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;comments[<span class="hljs-string"><span class="hljs-string">'object'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;comments[<span class="hljs-string"><span class="hljs-string">'data'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;page-&gt;addComments($comment); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;DoctrineRepository-&gt;AddComments(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;page); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteComment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;DoctrineCommentRepository-&gt;delComments(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;comments); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">retrieveComments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;page-&gt;getPageComment(); } <span class="hljs-comment"><span class="hljs-comment">//... }</span></span></code> </pre><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Comment</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Interactions</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Model</span></span>\<span class="hljs-title"><span class="hljs-title">Entities</span></span>\<span class="hljs-title"><span class="hljs-title">Pages</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Repositories</span></span>\<span class="hljs-title"><span class="hljs-title">Database</span></span>\<span class="hljs-title"><span class="hljs-title">DoctrineORM</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>\<span class="hljs-title"><span class="hljs-title">DoctrineCommentRepository</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Repositories</span></span>\<span class="hljs-title"><span class="hljs-title">Database</span></span>\<span class="hljs-title"><span class="hljs-title">DoctrineORM</span></span>\<span class="hljs-title"><span class="hljs-title">Interactions</span></span>\<span class="hljs-title"><span class="hljs-title">DoctrinePagesRepository</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>\<span class="hljs-title"><span class="hljs-title">Comments</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Assert</span></span>\<span class="hljs-title"><span class="hljs-title">Assertion</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AdministrativeComments</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommentTypeFactoryInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $page; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $comments; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $parentId; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $privilege; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $DoctrineCommentRepository = DoctrineCommentRepository::class; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $DoctrineRepository = DoctrinePagesRepository::class; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Pages $page, $comment, $parentId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;page = $page; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;comments = $comment; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;parentId = $parentId; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;privilege = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Athurization(\Auth::gaurd(<span class="hljs-string"><span class="hljs-string">'admin'</span></span>)-&gt;user()); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">confectionner</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $action = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;comments[<span class="hljs-string"><span class="hljs-string">'action'</span></span>]; Assertion::notNull(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;comments = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;DoctrineCommentRepository-&gt;findOneBy([<span class="hljs-string"><span class="hljs-string">'commentId'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;comments[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]]), <span class="hljs-string"><span class="hljs-string">'no Valid comment Id'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;$action; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">approve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;privilege-&gt;isAuthorize(<span class="hljs-keyword"><span class="hljs-keyword">__METHOD__</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;DoctrineCommentRepository-&gt;approve(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;comments, \Auth::gaurd(<span class="hljs-string"><span class="hljs-string">'admin'</span></span>)-&gt;user()); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;privilege-&gt;isAuthorize(<span class="hljs-keyword"><span class="hljs-keyword">__METHOD__</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;DoctrineCommentRepository-&gt;reject(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;comments, \Auth::gaurd(<span class="hljs-string"><span class="hljs-string">'admin'</span></span>)-&gt;user()); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;privilege-&gt;isAuthorize(<span class="hljs-keyword"><span class="hljs-keyword">__METHOD__</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;DoctrineCommentRepository-&gt;delete(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;comments, \Auth::gaurd(<span class="hljs-string"><span class="hljs-string">'admin'</span></span>)-&gt;user()); } }</code> </pre><br>       ,     : Comment  AdministrativeComments. Commentfactory  ,    .     ,    Authorization   reject,  .        ,   RequestFactory  .       ,      .       DDD,     laravel 5+. <br><br><h4>  Conclusion </h4><br>        ,     ,   .        ,        ,   ,     . <br><br> THE END <br><br>    ,       <a href="https://otus.pw/fsUT/">  .</a> </div><p>Source: <a href="https://habr.com/ru/post/353500/">https://habr.com/ru/post/353500/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../353490/index.html">And again about translating PHP documentation</a></li>
<li><a href="../353492/index.html">GeekBrains starts training performance marketing specialists</a></li>
<li><a href="../353494/index.html">IntelliJ IDEA 2018.1 - Improved code analysis, support for Git partial commits, Android Studio 3.0, and more.</a></li>
<li><a href="../353496/index.html">Introducing reactive threads - for Java developers</a></li>
<li><a href="../353498/index.html">How many mathematics do you need to sign a polygon in the Yandex.Maps JS API</a></li>
<li><a href="../353502/index.html">Associative rules, or beer with diapers</a></li>
<li><a href="../353504/index.html">Root access through TeamCity</a></li>
<li><a href="../353506/index.html">Drupalgeddon2: SA-CORE-2018-002 operation began</a></li>
<li><a href="../353508/index.html">Imagine Cup 2018: live broadcast</a></li>
<li><a href="../353510/index.html">How can you develop two parts of the game for six months and not go crazy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>