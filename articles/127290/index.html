<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Let's work with MongoDb</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Currently, more and more high-load projects are operating with a huge amount of data. And it is no longer possible to get by with the classical relati...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Let's work with MongoDb</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/2f1/b08/0e9/2f1b080e98b529456e31b0e80139c4f1.jpg" align="left"><br><br>  Currently, more and more high-load projects are operating with a huge amount of data.  And it is no longer possible to get by with the classical relational storage model for this information.  NoSQL databases are becoming increasingly popular (NoSQL stands for Not only SQL).  One such database is MongoDB, which has already earned the attention of companies such as <a href="http://www.mongodb.org/display/DOCS/Production%2BDeployments">Disney, craiglist, four square</a> .  In addition, there have repeatedly written about her: <br>  <a href="http://habrahabr.ru/blogs/aspnet_mvc/93598/">NoSQL using MongoDB, NoRM and ASP.NET MVC</a> <br>  <a href="http://habrahabr.ru/blogs/nosql/108144/">MongoDB Sharding on the fingers</a> <br>  <a href="http://habrahabr.ru/blogs/nosql/108225/">MongoDB replication on fingers</a> <br><br>  This is another article about working with MongoDb in a .net environment. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What is required: <br>  1. Download ( <a href="http://www.mongodb.org/downloads">http://www.mongodb.org/downloads</a> ), unpack and run mongod (this is the server) <br>  2. Driver ( <a href="https://github.com/mongodb/mongo-csharp-driver/downloads">https://github.com/mongodb/mongo-csharp-driver/downloads</a> ) <br>  3. Let's go <br><br><a name="habracut"></a><br><h2>  Database creation. </h2><br>  By default, the database is located in the folder c: / data / db <br><br>  Run mongo.exe and create a new database: <br><pre><code class="bash hljs">use mongoblog</code> </pre> <br><br>  Immediately set the access parameters (username and password): <br><pre> <code class="bash hljs">db.addUser(<span class="hljs-string"><span class="hljs-string">"admin"</span></span>, <span class="hljs-string"><span class="hljs-string">"masterkey"</span></span>)</code> </pre><br><br>  A feature of MongoDb is that it is a document-oriented database, and does not contain information about the structure, so here we are done.  Immediately proceed to the description of the data models. <br><br>  We will have two entities, Article (Article) and Comment (Comment), and the Article will contain many Comments: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Article</span></span> { [BsonId] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ObjectId Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//    - id   public string Url { get; set; } public string Title { get; set; } public string Teaser { get; set; } public string Content { get; set; } public DateTime AddedDate { get; set; } public List&lt;string&gt; Tags { get; set; } public bool IsPublished { get; set; } public string Bulk { get; set; } public List Comments { get; set; } public Article() { Id = ObjectId.GenerateNewId(); Tags = new List&lt;string&gt;(); Comments = new List(); } } public partial class Comment { [BsonId] public ObjectId Id { get; set; } //    - id   public DateTime AddedDate { get; set; } public string Content { get; set; } public Comment() { Id = ObjectId.GenerateNewId(); } }</span></span></code> </pre><br><br>  Next, consider working with MongoDB: <br><ul><li>  connect to mongo </li><li>  adding an article </li><li>  article change </li><li>  indexing </li><li>  delete article </li><li>  output articles (filtering / paging / sorting) </li><li>  adding comments </li><li>  post removal </li><li>  Search </li><li>  backup base </li></ul><br><br><h3>  # 1 Connection to the database. </h3><br>  By default, the database occupies port 27017 on the server (we usually have localhost).  Connect to the database: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MongoDBContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ConnectionString, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> User, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Password, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Database</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mongoUrlBuilder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MongoUrlBuilder(ConnectionString); server = MongoServer.Create(mongoUrlBuilder.ToMongoUrl()); MongoCredentials credentials = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MongoCredentials(User, Password); database = server.GetDatabase(Database, credentials); }</code> </pre><br><br><h3>  # 2 / # 3 Adding / editing an entry </h3><br>  To add an object to the collection, you must obtain a collection by name. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> collection = database.GetCollection&lt;T&gt;(table);</code> </pre><br>  To add, you can run the command: <br><pre> <code class="cs hljs">collection.Insert&lt;T&gt;(obj);</code> </pre><br>  or (as for change) <br><pre> <code class="cs hljs">collection.Save&lt;T&gt;(obj);</code> </pre><br><br>  MongoDb independently adds the _id field - a unique parameter.  If, when the Save command is executed, the object has an Id that already exists in the collection, then an update of this object will be executed. <br><br><br><h3>  # 4 Indexing </h3><br>  For a quick search, we can add an index for any field.  For indexing, use the command <br><pre> <code class="cs hljs">collection.EnsureIndex(IndexKeys.Descending(<span class="hljs-string"><span class="hljs-string">"AddedDate"</span></span>));</code> </pre><br><br>  This will speed up sorting by this field. <br><br><h3>  # 5 Removal </h3><br>  To delete by id a query is created (Query).  In this case it is <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query = Query.EQ(<span class="hljs-string"><span class="hljs-string">"_id"</span></span>, id)</code> </pre><br>  and the command is executed: <br><pre> <code class="cs hljs">collection.Remove(query);</code> </pre><br><br><h3>  # 6 Conclusion of articles </h3><br>  To display the values ‚Äã‚Äãby applying the filter and sorted, and even with a paging cursor is used. <br>  For example, to select from the collection the unreleased (IsDeleted = false) sorted by descending date (AddedDate desc) 10th page (skip 90 elements and display the following 10) a cursor is composed: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cursor = collection.Find(Query.EQ(<span class="hljs-string"><span class="hljs-string">"IsDeleted"</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>)); cursor.SetSortOrder(SortBy.Descending(<span class="hljs-string"><span class="hljs-string">"AddedDate"</span></span>)); cursor.Skip = <span class="hljs-number"><span class="hljs-number">90</span></span>; cursor.Limit = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> obj <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cursor) { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj; }</code> </pre><br><br><h3>  # 7 Add comments. </h3><br>  Since MongoDb is a document-oriented database, there is no separate table with comments, and the comment is added to the comments array in the article, after which the article is saved: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> article = db.GetByID&lt;Article&gt;(<span class="hljs-string"><span class="hljs-string">"Articles"</span></span>, articleId); comment.AddedDate = DateTime.Now; article.Comments.Add(comment); db.Save&lt;Article&gt;(<span class="hljs-string"><span class="hljs-string">"Articles"</span></span>, article);</code> </pre><br><br><h3>  # 8 Delete a comment. </h3><br>  The comment is deleted in the same way.  We get the article object, delete the current comment from the list of comments and save the object. <br><br><h3>  # 9 Search. </h3><br>  To find an element containing a given substring, you must specify the following query: <br><pre> <code class="cs hljs">Query.Matches(<span class="hljs-string"><span class="hljs-string">"Text"</span></span>, <span class="hljs-string"><span class="hljs-string">@".* .*"</span></span>).</code> </pre><br>  There are 2 problems as the search is case sensitive, i.e.  Peter! = Peter, and besides, we have many fields. <br>  The first problem can be solved <a href="http://stackoverflow.com/questions/1863399/mongodb-is-it-possible-to-make-a-case-insensitive-query">using regular expressions.</a> <br><br>  But in order to get rid of both problems at once, I created a Bulk field where all the fields + comments are written in lower case and I search for this field. <br><br><h3>  # 10 Backup Base. </h3><br>  It is backup and not replication.  In order to have access to the database file, you need to execute lock (the database will continue to work, only at this moment all write commands will be cached so that it will be executed later).  Then the database can be copied, archived and put on ftp.  After this procedure, the base must be unlocked (Unlock). <br>  Commands: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lock</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> command = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CommandDocument(); command.Add(<span class="hljs-string"><span class="hljs-string">"fsync"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); command.Add(<span class="hljs-string"><span class="hljs-string">"lock"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> collection = server.AdminDatabase.RunCommand(command); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Unlock</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> collection = server.AdminDatabase.GetCollection(<span class="hljs-string"><span class="hljs-string">"$cmd.sys.unlock"</span></span>); collection.FindOne(); }</code> </pre><br>  If something goes wrong, then the database server will need to be restarted with the command: <br><pre> <code class="bash hljs">mongod --repair</code> </pre><br><br><h2>  Sources </h2><br><br>  A trial application (on asp.net mvc) can be found at: <br>  <a href="https://bitbucket.org/chernikov/mongodbblog">https://bitbucket.org/chernikov/mongodbblog</a> <br><br>  Yes, and about the performance in relation to the rest of the <a href="http://www.michaelckennedy.net/blog/2010/04/29/MongoDBVsSQLServer2008PerformanceShowdown.aspx">link</a> . </div><p>Source: <a href="https://habr.com/ru/post/127290/">https://habr.com/ru/post/127290/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../127282/index.html">SymmetricDS based PostgreSQL database replication</a></li>
<li><a href="../127285/index.html">Keymaster.js: a simple micro-library for hot keys</a></li>
<li><a href="../127286/index.html">Analyzing system performance</a></li>
<li><a href="../127287/index.html">"Cloud" as an alternative to traditional hosting</a></li>
<li><a href="../127288/index.html">Visualization of intra-class relationships using GraphViz</a></li>
<li><a href="../127291/index.html">Virtual RBK Money MasterCard Virtual</a></li>
<li><a href="../127293/index.html">Google promotes HTML5 as a gaming platform.</a></li>
<li><a href="../127295/index.html">How to make your own HTML5 Video player</a></li>
<li><a href="../127297/index.html">Mail.Ru Mail and Web Of Trust: Making Runet Safer</a></li>
<li><a href="../127298/index.html">When simply filtering request parameters is not enough or about the dangers of universality</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>