<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simplest HTTP server on Golang and Elixir. Performance comparison</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A couple of weeks ago, I decided to take the simplest example of an HTTP server on Go and measure its performance. Then I bravely took Phoenix , drove...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simplest HTTP server on Golang and Elixir. Performance comparison</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/822/a78/2ca/822a782ca92649978447b6d17e1eec3c.jpg" alt="image"><br>  A couple of weeks ago, I decided to take the simplest <a href="https://golang.org/doc/articles/wiki/">example of an HTTP server on Go</a> and measure its performance.  Then I bravely took <a href="http://www.phoenixframework.org/">Phoenix</a> , drove on the same tests, and was upset.  The results were not in favor of Elixir / Erlang (45133 RPS for Go and just 3065 RPS for Phoenix).  But Phoenix is ‚Äã‚Äãhard.  Something must be at least approximately equal in simplicity and development logic to what is on Go: when there is a path - "/" and a handler for it.  The logical analogy seemed to me to be the <a href="https://github.com/ninenines/cowboy">cowboy</a> + <a href="https://github.com/elixir-lang/plug">plug</a> solution, where we have a <a href="https://hexdocs.pm/plug/Plug.Router.html">Router</a> that also catches "/" and responds to it.  The results killed - Elixir / Erlang was again slower: </p><br><pre><code class="hljs ruby">Golang sea@sea<span class="hljs-symbol"><span class="hljs-symbol">:~/go</span></span>$ wrk -t1<span class="hljs-number"><span class="hljs-number">0</span></span> -c10<span class="hljs-number"><span class="hljs-number">0</span></span> -d10s <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/127.0.0.1:4000/</span></span> ... <span class="hljs-number"><span class="hljs-number">452793</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">10.03</span></span>s, <span class="hljs-number"><span class="hljs-number">58.30</span></span>MB read Requests/<span class="hljs-symbol"><span class="hljs-symbol">sec:</span></span> <span class="hljs-number"><span class="hljs-number">45133.28</span></span> Transfer/<span class="hljs-symbol"><span class="hljs-symbol">sec:</span></span> <span class="hljs-number"><span class="hljs-number">5.81</span></span>MB</code> </pre> <br><pre> <code class="hljs ruby">elixir cowboy plug sea@sea<span class="hljs-symbol"><span class="hljs-symbol">:~/http_test</span></span>$ wrk -t1<span class="hljs-number"><span class="hljs-number">0</span></span> -c10<span class="hljs-number"><span class="hljs-number">0</span></span> -d10s <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/127.0.0.1:4000/</span></span> ... <span class="hljs-number"><span class="hljs-number">184703</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">10.02</span></span>s, <span class="hljs-number"><span class="hljs-number">28.57</span></span>MB read Requests/<span class="hljs-symbol"><span class="hljs-symbol">sec:</span></span> <span class="hljs-number"><span class="hljs-number">18441.79</span></span> Transfer/<span class="hljs-symbol"><span class="hljs-symbol">sec:</span></span> <span class="hljs-number"><span class="hljs-number">2.85</span></span>MB</code> </pre> <br><p>  How to live on?  For two weeks I did not sleep and did not eat (almost).  Everything that I believed in all these years: perfection vm erlang, OP, green processes, was crushed torn, burned and launched into the wind.  A little away from the shock, calm down, and rubbing snot, I decided to break up, what's the matter. <a name="habracut"></a></p><br><div class="spoiler">  <b class="spoiler_title">For those who are in a hurry, I will answer immediately.</b> <div class="spoiler_text"><div class="spoiler">  <b class="spoiler_title">The reason was not entirely correct conditions in which I conducted testing</b> <div class="spoiler_text"><p>  Both the server and the test program were launched on the same virtual machine, inside VirtualBOX, with two dedicated cores. </p><br><div class="spoiler">  <b class="spoiler_title">But,</b> <div class="spoiler_text"><p>  if it turns out that you will have to work in such or similar conditions, then Go will really show better results </p><div class="spoiler">  <b class="spoiler_title">Moreover,</b> <div class="spoiler_text">  statically compiled program simply must be faster than a virtual machine with an interpreter </div></div><p></p></div></div></div></div></div></div><br><h4>  Test computer </h4><br><p>  As I tested.  I work on a laptop with Windows 7 x64, i7 processor, 8 Gb RAM, and Linux - in my case Ubuntu 16, I run inside VirtualBOX.  For her, I allocated 1 Gb of RAM and 2 cores.  Inside this virtual machine, I started an HTTP server, and on the same machine I started testing <a href="httpd.apache.org/docs/2.4/programs/ab.html">ab</a> and <a href="https://github.com/wg/wrk">wrk</a> .  In this situation, the same machine turns out to be loaded with both a server and a test;  data transmission over the network does not impose restrictions, because there is no transmission over the network. </p><br><p>  As a result, we got a complete rout: </p><br><div class="spoiler">  <b class="spoiler_title">go vs cowboy wrk -t10 -c100 -d10s http://127.0.0.1:4000/</b> <div class="spoiler_text"><pre> <code class="bash hljs">Go: sea@sea:~/go$ wrk -t10 -c100 -d10s http://127.0.0.1:4000/ Running 10s <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> @ http://127.0.0.1:4000/ 10 threads and 100 connections Thread Stats Avg Stdev Max +/- Stdev Latency 65.18ms 109.44ms 1.05s 86.48% Req/Sec 4.60k 5.87k 25.40k 86.85% 452793 requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 10.03s, 58.30MB <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> Requests/sec: 45133.28 Transfer/sec: 5.81MB Elixir cowboy: sea@sea:~/http_test$ wrk -t10 -c100 -d10s http://127.0.0.1:4000/ Running 10s <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> @ http://127.0.0.1:4000/ 10 threads and 100 connections Thread Stats Avg Stdev Max +/- Stdev Latency 8.94ms 11.38ms 123.57ms 86.53% Req/Sec 1.85k 669.61 4.99k 71.70% 184703 requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 10.02s, 28.57MB <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> Requests/sec: 18441.79 Transfer/sec: 2.85MB</code> </pre> </div></div><div class="spoiler">  <b class="spoiler_title">go vs cowboy wrk -t10 -c1000 -d10s http://127.0.0.1:4000/</b> <div class="spoiler_text"><pre> <code class="bash hljs">Go: sea@sea:~/go$ wrk -t10 -c1000 -d10s http://127.0.0.1:4000/ Running 10s <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> @ http://127.0.0.1:4000/ 10 threads and 1000 connections Thread Stats Avg Stdev Max +/- Stdev Latency 61.16ms 231.88ms 2.00s 92.97% Req/Sec 7.85k 8.65k 26.13k 79.49% 474853 requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 10.09s, 61.14MB <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> Socket errors: connect 0, <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> 0, write 0, timeout 1329 Requests/sec: 47079.39 Transfer/sec: 6.06MB Elixir cowboy: sea@sea:~/http_test$ wrk -t10 -c1000 -d10s http://127.0.0.1:4000/ Running 10s <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> @ http://127.0.0.1:4000/ 10 threads and 1000 connections Thread Stats Avg Stdev Max +/- Stdev Latency 123.00ms 303.25ms 1.94s 88.91% Req/Sec 2.06k 1.85k 11.26k 71.80% 173220 requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 10.09s, 26.79MB <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> Socket errors: connect 0, <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> 0, write 0, timeout 43 Requests/sec: 17166.03 Transfer/sec: 2.65MB</code> </pre> </div></div><br><p>  The only thing that could be said in defense of Erlang / Elixir is a smaller number of timeouts.  Build application in HiPE did not improve performance.  But first things first </p><br><h4>  Test environment v.2 </h4><br><p>  It became clear that testing is better on a stand-alone system, and not in a virtual machine.  A test http server would be better placed on a weaker machine, and the testing machine should be more powerful so that it can completely overwhelm the server, bringing it to the limit of its technical capabilities.  It is desirable to have a fast network, so as not to rest on its limitations. </p><br><p>  Therefore, as a testing machine, I decided to leave my laptop on i7.  And as the server decided to torment the Orange PI One.  I assumed that I would rather "put on" its performance than on the rate of exchange over the network.  Orange PI One is connected to the router via UTP at a speed of 100 Mbps. </p><br><p><img src="https://habrastorage.org/files/398/5b3/c81/3985b3c8153b4eebaf573409e5f4f237.jpg" alt="image"></p><br><p>  The manufacturer‚Äôs website states that the Orange PI One is equipped with an A7 Quad Core processor with a frequency of 1200 MHz.  But due to the mistakes of the developers, the entire system suffers from overheating of the kernel alerts, so I clamped down the processor speed to 600 MHz.  So it will be even more interesting.  The system works stably, but even with nothing doing, its load average: 2.00, 2.01, 2.05 (which is strange).  Ubuntu 14 is installed. 512MB of memory, so, just in case, I connected the swap partition to a file on a flash drive. </p><br><p><img src="https://habrastorage.org/files/186/479/5e1/1864795e11c44244957dbb5b5747f8b0.jpg" alt="image <h4> Round 2 </ h4>"></p><br><p>  In order to transfer the project to Go and to Elixir on Orange PI, I immediately created two projects on Github: </p><br><p>  <a href="http">https://github.com/UA3MQJ/go-small-http</a> <br>  <a href="http-cowboy">https://github.com/UA3MQJ/elx-small-http-cowboy</a> </p><br><p>  Golang on Orange PI was delivered without problems.  But with Erlang / Elixir had a little work.  But this work was carried out long ago.  Build projects and launch passed without problems.  As tests, I took a tool that will work under Windows - this is <a href="http://jmeter.apache.org/">Jmeter</a> . </p><br><p>  The first tests with the following parameters: </p><br><p><img src="https://habrastorage.org/files/450/287/ca4/450287ca46344bacaa87ede74cccb95f.png" alt="image"></p><br><p>  Showed that the forces ... are equal! </p><br><p>  RPS - Go: </p><br><p><img src="https://habrastorage.org/files/df8/626/d64/df8626d6479f4e19820d3d1204952206.png" alt="image"></p><br><p>  RPS - Elixir: </p><br><p><img src="https://habrastorage.org/files/25e/8d1/2b7/25e8d12b7b0c4cbf9b6d295192673a82.png" alt="image"></p><br><p>  Resp Time - Go: </p><br><p><img src="https://habrastorage.org/files/72b/656/18b/72b65618b2d6428aa828aee195600b7c.png" alt="image"></p><br><p>  Resp Time - Elixir: </p><br><p><img src="https://habrastorage.org/files/c65/3a1/a6f/c653a1a6f3fe4a44b6a2b75a059c4a2a.png" alt="image"></p><br><h4>  Interesting observations </h4><br><p>  Go has always worked with one core: </p><br><p><img src="https://habrastorage.org/files/b71/71f/3ff/b7171f3ff6cf40c1a67baa68b2bcc379.png" alt="image"></p><br><p>  While Elixir with all at once: </p><br><p><img src="https://habrastorage.org/files/e4e/ed7/bdb/e4eed7bdbc0e4c2da77f6ca4babfc346.png" alt="image"></p><br><p>  In this spherical test, it turned out that Elixir won. </p><br><div class="spoiler">  <b class="spoiler_title">go vs cowboy wrk -t10 -c100 -d10s http://192.168.1.16:4000/</b> <div class="spoiler_text"><pre> <code class="bash hljs">Go: sea@sea:~$ wrk -t10 -c100 -d10s http://192.168.1.16:4000/ Running 10s <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> @ http://192.168.1.16:4000/ 10 threads and 100 connections Thread Stats Avg Stdev Max +/- Stdev Latency 19.04ms 7.70ms 81.05ms 70.53% Req/Sec 531.09 78.11 828.00 77.10% 52940 requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 10.02s, 6.82MB <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> Requests/sec: 5282.81 Transfer/sec: 696.46KB Elixir cowboy: sea@sea:~$ wrk -t10 -c100 -d10s http://192.168.1.16:4000/ Running 10s <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> @ http://192.168.1.16:4000/ 10 threads and 100 connections Thread Stats Avg Stdev Max +/- Stdev Latency 14.27ms 10.54ms 153.60ms 95.81% Req/Sec 753.20 103.47 1.09k 80.40% 74574 requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 10.04s, 11.53MB <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> Requests/sec: 7429.95 Transfer/sec: 1.15MB</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">go vs cowboy wrk -t100 -c100 -d10s http://192.168.1.16:4000/</b> <div class="spoiler_text"><pre> <code class="bash hljs">Go: sea@sea:~$ wrk -t100 -c100 -d10s http://192.168.1.16:4000/ Running 10s <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> @ http://192.168.1.16:4000/ 100 threads and 100 connections Thread Stats Avg Stdev Max +/- Stdev Latency 60.14ms 137.57ms 1.52s 94.28% Req/Sec 38.45 20.62 130.00 60.30% 34384 requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 10.10s, 4.43MB <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> Requests/sec: 3404.19 Transfer/sec: 448.79KB Elixir cowboy: sea@sea:~$ wrk -t100 -c100 -d10s http://192.168.1.16:4000/ Running 10s <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> @ http://192.168.1.16:4000/ 100 threads and 100 connections Thread Stats Avg Stdev Max +/- Stdev Latency 13.32ms 5.25ms 90.37ms 73.31% Req/Sec 75.51 22.04 191.00 67.49% 75878 requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 10.10s, 11.74MB <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> Requests/sec: 7512.75 Transfer/sec: 1.16MB</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">go vs cowboy wrk -t100 -c500 -d10s http://192.168.1.16:4000/</b> <div class="spoiler_text"><pre> <code class="bash hljs">Go: sea@sea:~$ wrk -t100 -c500 -d10s http://192.168.1.16:4000/ Running 10s <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> @ http://192.168.1.16:4000/ 100 threads and 500 connections Thread Stats Avg Stdev Max +/- Stdev Latency 93.81ms 18.63ms 328.78ms 84.98% Req/Sec 53.13 11.12 101.00 77.60% 52819 requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 10.10s, 6.80MB <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> Requests/sec: 5232.01 Transfer/sec: 689.77KB Elixir cowboy: sea@sea:~$ wrk -t100 -c500 -d10s http://192.168.1.16:4000/ Running 10s <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> @ http://192.168.1.16:4000/ 100 threads and 500 connections Thread Stats Avg Stdev Max +/- Stdev Latency 93.24ms 96.80ms 1.26s 94.47% Req/Sec 62.95 23.33 292.00 79.87% 61646 requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 10.10s, 9.53MB <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> Requests/sec: 6106.38 Transfer/sec: 0.94MB</code> </pre></div></div><br><p>  But what if you start an erlang server using <a href="http://erlang.org/doc/man/HiPE_app.html">HiPE</a> ? </p><br><p>  To do this, you first need to google how to do it.  How to do this in Erlang - of course.  But about Elixir I had to google it.  In addition, those who tested HiPE write that often in HiPE it turns out even slower than in the standard one.  This is due to the fact that dependencies can be collected without HiPE (and it is necessary to assemble them in the same mode), plus you need to evaluate the system counter of context switches, and if there are many switches, this will adversely affect performance and show worse results. </p><br><p>  Compile project dependencies with HiPE compiler </p><br><pre> <code class="bash hljs">$ ERL_COMPILER_OPTIONS=<span class="hljs-string"><span class="hljs-string">"[native,{hipe, [verbose, o3]}]"</span></span> mix deps.compile --force</code> </pre> <br><p>  Let's collect the project </p><br><pre> <code class="bash hljs">$ ERL_COMPILER_OPTIONS=<span class="hljs-string"><span class="hljs-string">"[native,{hipe, [verbose, o3]}]"</span></span> mix compile</code> </pre> <br><p>  Tests have shown that HiPE does not increase, but on the contrary, shows the worst results. </p><br><div class="spoiler">  <b class="spoiler_title">cowboy vs cowboy (HiPE) wrk -t100 -c500 -d10s http://192.168.1.16:4000/</b> <div class="spoiler_text"><pre> <code class="bash hljs">Elixir cowboy: sea@sea:~$ wrk -t100 -c500 -d10s http://192.168.1.16:4000/ Running 10s <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> @ http://192.168.1.16:4000/ 100 threads and 500 connections Thread Stats Avg Stdev Max +/- Stdev Latency 93.24ms 96.80ms 1.26s 94.47% Req/Sec 62.95 23.33 292.00 79.87% 61646 requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 10.10s, 9.53MB <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> Requests/sec: 6106.38 Transfer/sec: 0.94MB Elixir cowboy (HiPE): sea@sea:~$ wrk -t100 -c500 -d10s http://192.168.1.16:4000/ Running 10s <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> @ http://192.168.1.16:4000/ 100 threads and 500 connections Thread Stats Avg Stdev Max +/- Stdev Latency 111.84ms 160.53ms 1.89s 95.42% Req/Sec 59.19 29.68 383.00 81.63% 56425 requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 10.10s, 8.72MB <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> Socket errors: connect 0, <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> 0, write 0, timeout 34 Requests/sec: 5587.39 Transfer/sec: 0.86MB</code> </pre> </div></div><br><h4>  Go Strikes Back </h4><br><p>  Why did Go work in a single processor?  Maybe a Go package, which goes by default with the old version, when Go was still running on a single processor?  And there is! </p><br><pre> <code class="bash hljs">sea@OrangePI:~$ go version go version go1.2.1 linux/arm</code> </pre> <br><p>  Have to update and repeat!  The collected Go version 1.7.3 for armv7 was found at <a href="https://github.com/hypriot/golang-armbuilds/releases">https://github.com/hypriot/golang-armbuilds/releases</a> </p><br><p>  The server on Golang compiled on this version loads all 4 cores already: </p><br><p><img src="https://habrastorage.org/files/f8b/eb1/cfb/f8beb1cfb9094945bccdff1cc4a13105.png" alt="image"></p><br><div class="spoiler">  <b class="spoiler_title">cowboy vs Go1.7.4 wrk -t100 -c500 -d10s http://192.168.1.16:4000/</b> <div class="spoiler_text"><pre> <code class="bash hljs">Elixir cowboy: sea@sea:~$ wrk -t100 -c500 -d10s http://192.168.1.16:4000/ Running 10s <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> @ http://192.168.1.16:4000/ 100 threads and 500 connections Thread Stats Avg Stdev Max +/- Stdev Latency 93.24ms 96.80ms 1.26s 94.47% Req/Sec 62.95 23.33 292.00 79.87% 61646 requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 10.10s, 9.53MB <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> Requests/sec: 6106.38 Transfer/sec: 0.94MB sea@sea:~/tender_pro_bots$ wrk -t100 -c500 -d10s http://192.168.1.16:4000/ Running 10s <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> @ http://192.168.1.16:4000/ 100 threads and 500 connections Thread Stats Avg Stdev Max +/- Stdev Latency 70.17ms 57.84ms 754.39ms 90.61% Req/Sec 84.09 31.01 151.00 73.20% 78787 requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 10.10s, 10.14MB <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> Requests/sec: 7800.43 Transfer/sec: 1.00MB</code> </pre></div></div><br><p>  Go breaks free! </p><br><h4>  Go and fasthttp </h4><br><p>  After the recommendation to change the version of Golang, I was advised to <a href="http">fasthttp</a> and gccgo.  Let's start with the first. </p><br><p>  <a href="http">https://github.com/UA3MQJ/go-small-fasthttp</a> </p><br><p>  Let's look at the download.  We see that all 4 cores are loaded, but not 100%. </p><br><p><img src="https://habrastorage.org/files/165/8cb/5f6/1658cb5f636642e8ba7be8b90b1165a0.png" alt="image"></p><br><p>  And now wrk </p><br><div class="spoiler">  <b class="spoiler_title">go vs cowboy wrk -t10 -c100 -d10s http://192.168.1.16:4000/</b> <div class="spoiler_text"><pre> <code class="bash hljs">Go fasthttp: sea@sea:~/tender_pro_bots$ wrk -t10 -c100 -d10s http://192.168.1.16:4000/ Running 10s <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> @ http://192.168.1.16:4000/ 10 threads and 100 connections Thread Stats Avg Stdev Max +/- Stdev Latency 43.56ms 85.95ms 738.51ms 89.71% Req/Sec 676.18 351.12 1.17k 70.80% 67045 requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 10.04s, 9.78MB <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> Requests/sec: 6678.71 Transfer/sec: 0.97MB Elixir cowboy: sea@sea:~$ wrk -t10 -c100 -d10s http://192.168.1.16:4000/ Running 10s <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> @ http://192.168.1.16:4000/ 10 threads and 100 connections Thread Stats Avg Stdev Max +/- Stdev Latency 14.27ms 10.54ms 153.60ms 95.81% Req/Sec 753.20 103.47 1.09k 80.40% 74574 requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 10.04s, 11.53MB <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> Requests/sec: 7429.95 Transfer/sec: 1.15MB</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">go vs cowboy wrk -t100 -c100 -d10s http://192.168.1.16:4000/</b> <div class="spoiler_text"><pre> <code class="bash hljs">Go fasthttp: sea@sea:~/tender_pro_bots$ wrk -t100 -c100 -d10s http://192.168.1.16:4000/ Running 10s <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> @ http://192.168.1.16:4000/ 100 threads and 100 connections Thread Stats Avg Stdev Max +/- Stdev Latency 8.95ms 3.08ms 42.23ms 75.69% Req/Sec 112.61 16.65 320.00 70.18% 112561 requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 10.10s, 16.42MB <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> Requests/sec: 11144.39 Transfer/sec: 1.63MB Elixir cowboy: sea@sea:~$ wrk -t100 -c100 -d10s http://192.168.1.16:4000/ Running 10s <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> @ http://192.168.1.16:4000/ 100 threads and 100 connections Thread Stats Avg Stdev Max +/- Stdev Latency 13.32ms 5.25ms 90.37ms 73.31% Req/Sec 75.51 22.04 191.00 67.49% 75878 requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 10.10s, 11.74MB <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> Requests/sec: 7512.75 Transfer/sec: 1.16MB</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">go vs cowboy wrk -t100 -c500 -d10s http://192.168.1.16:4000/</b> <div class="spoiler_text"><pre> <code class="bash hljs">Go fasthttp: sea@sea:~/tender_pro_bots$ wrk -t100 -c500 -d10s http://192.168.1.16:4000/ Running 10s <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> @ http://192.168.1.16:4000/ 100 threads and 500 connections Thread Stats Avg Stdev Max +/- Stdev Latency 46.44ms 10.69ms 327.50ms 93.21% Req/Sec 107.71 15.10 170.00 82.06% 107349 requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 10.10s, 15.66MB <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> Requests/sec: 10627.97 Transfer/sec: 1.55MB Elixir cowboy: sea@sea:~$ wrk -t100 -c500 -d10s http://192.168.1.16:4000/ Running 10s <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> @ http://192.168.1.16:4000/ 100 threads and 500 connections Thread Stats Avg Stdev Max +/- Stdev Latency 93.24ms 96.80ms 1.26s 94.47% Req/Sec 62.95 23.33 292.00 79.87% 61646 requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 10.10s, 9.53MB <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> Requests/sec: 6106.38 Transfer/sec: 0.94MB</code> </pre></div></div><br><p>  Golang, along with fasthttp, turned out to be faster than himself and faster than Elixir cowboy. </p><br><h4>  About the accuracy of measurements </h4><br><p>  To be more attentive, you can find out that cowboy and Go respond with different number of bytes.  This is due to the different HTTP Headers that they issue. </p><br><p>  Issuance go: </p><br><pre> <code class="hljs pgsql">HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK <span class="hljs-type"><span class="hljs-type">Date</span></span>: Thu, <span class="hljs-number"><span class="hljs-number">30</span></span> Mar <span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">37</span></span>:<span class="hljs-number"><span class="hljs-number">08</span></span> GMT Content-Length: <span class="hljs-number"><span class="hljs-number">18</span></span> Content-<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>: <span class="hljs-type"><span class="hljs-type">text</span></span>/plain; charset=utf<span class="hljs-number"><span class="hljs-number">-8</span></span></code> </pre> <br><p>  Cowboy issue: </p><br><pre> <code class="hljs pgsql">HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>: Cowboy <span class="hljs-type"><span class="hljs-type">date</span></span>: Thu, <span class="hljs-number"><span class="hljs-number">30</span></span> Mar <span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span> GMT content-length: <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span>-control: max-age=<span class="hljs-number"><span class="hljs-number">0</span></span>, private, must-revalidate</code> </pre> <br><p>  As you can see, cowboy also provides an additional line "server: Cowboy", which necessarily somehow affects the number of bytes transferred in the case of a cowboy.  The transferred data is received more. </p><br><h4>  UPDADE.  Forgot to include in the BEAM option to work with epoll </h4><br><p>  Thanks <a href="https://habrahabr.ru/users/nwalker/" class="user_link">nwalker</a> for <a href="https://habrahabr.ru/users/nwalker/" class="user_link">reminding me</a> about the + K key.  We specify it at startup: </p><br><pre> <code class="hljs ruby">sea@OrangePI<span class="hljs-symbol"><span class="hljs-symbol">:~/http_tests/elx-small-http-cowboy</span></span>$ iex --erl <span class="hljs-string"><span class="hljs-string">'+K true'</span></span> -S mix Erlang/OTP <span class="hljs-number"><span class="hljs-number">19</span></span> [erts-<span class="hljs-number"><span class="hljs-number">8.1</span></span>] [source] [<span class="hljs-symbol"><span class="hljs-symbol">smp:</span></span><span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">4</span></span>] [async-<span class="hljs-symbol"><span class="hljs-symbol">threads:</span></span><span class="hljs-number"><span class="hljs-number">10</span></span>] [hipe] [kernel-<span class="hljs-symbol"><span class="hljs-symbol">poll:</span></span><span class="hljs-literal"><span class="hljs-literal">true</span></span>]</code> </pre> <br><p>  This time I will not load 10 seconds, but a minute. </p><br><div class="spoiler">  <b class="spoiler_title">cowboy vs cowboy epoll wrk -t100 -c500 -d60s http://192.168.1.16:4000/</b> <div class="spoiler_text"><pre> <code class="bash hljs">Elixir cowboy: sea@sea:~/tender_pro_bots$ wrk -t100 -c500 -d60s http://192.168.1.16:4000/ Running 1m <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> @ http://192.168.1.16:4000/ 100 threads and 500 connections Thread Stats Avg Stdev Max +/- Stdev Latency 78.63ms 38.59ms 1.00s 90.17% Req/Sec 65.08 14.19 158.00 54.94% 389764 requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 1.00m, 60.28MB <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> Requests/sec: 6485.27 Transfer/sec: 1.00MB Elixir cowboy with epoll: sea@sea:~/tender_pro_bots$ wrk -t100 -c500 -d60s http://192.168.1.16:4000/ Running 1m <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> @ http://192.168.1.16:4000/ 100 threads and 500 connections Thread Stats Avg Stdev Max +/- Stdev Latency 90.25ms 78.45ms 1.96s 95.36% Req/Sec 59.91 19.71 370.00 64.78% 356572 requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 1.00m, 55.15MB <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> Socket errors: connect 0, <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> 0, write 0, timeout 21 Requests/sec: 5932.94 Transfer/sec: 0.92MB</code> </pre> </div></div><br><p>  But on OrangePI with epoll turned on, the result was worse. </p><br><h4>  findings </h4><br><p>  And everyone will make his own conclusions for himself.  Go'shniki will rejoice at Go, and Erlangists and Elixirschiki - for their product.  Each will remain with his.  An Erlang supporter saw the Go speed, which turned out to be not an order of magnitude higher, and not even 2 times (but slightly less), nor would he give up all the possibilities of Erlang even for the sake of a 10-fold increase.  At the same time, Go'shnik would hardly be interested in Erlang, seeing less speed and hearing about all the possible difficulties in studying functional programming. </p><br><p>  In the modern world, programmer time is expensive, sometimes even more than the cost of equipment.  It requires testing not only in the "spherical" RPS on the "spherical" task, but also the development time, the complexity of the refinement and maintenance.  Economic expediency.  But sometimes you want to bite it all. <del>  horsepower </del>  megahertz and arrange several races in a great company!  Great ride. </p><br><p><img src="https://habrastorage.org/files/17a/f1f/b57/17af1fb574a9446b9baf9eb693639f7a.gif" alt="image"></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/324818/">https://habr.com/ru/post/324818/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324808/index.html">Convenient C ++ enumerator</a></li>
<li><a href="../324810/index.html">Modular Java applications. How?</a></li>
<li><a href="../324812/index.html">Development for Sailfish OS: Features of working with dates and time zones</a></li>
<li><a href="../324814/index.html">Learn to think in REM. Talk about the obvious and about productivity in a small web studio</a></li>
<li><a href="../324816/index.html">Launch of the project Nerepetitor</a></li>
<li><a href="../324820/index.html">Security Week 12: dangerous feature in Windows, Chinese hackers broke everything around, HTTPS should be inspected wisely</a></li>
<li><a href="../324824/index.html">IT tablets</a></li>
<li><a href="../324826/index.html">Weekend project by IBM employee and his son: Havyn's cybersecurity virtual assistant</a></li>
<li><a href="../324830/index.html">What's wrong with Mass Effect: Andromeda animations?</a></li>
<li><a href="../324840/index.html">DIY Robot Vacuum Cleaner - Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>