<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Console in the robot on Arduin</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Send the robot on Arduin a few bytes via Wi-Fi, bluetooth, serial port or any other communication channel as a command, and then take a few bytes as a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Console in the robot on Arduin</h1><div class="post__text post__text-html js-mediator-article">  Send the robot on Arduin a few bytes via Wi-Fi, bluetooth, serial port or any other communication channel as a command, and then take a few bytes as an answer is not difficult: just download the sketch with the hello world data exchange example and insert several lines of your own code that will perform the desired actions. <br><br>  However, with the development of the project, the area of ‚Äã‚Äãthe auxiliary code, which is responsible for communication with the outside world, expands: there is a logic that separates one data packet from another, a forest of checks grows, what team has come, what parameters does it have, how to do it correctly, what to do, if the data packet is not correct, if the data did not arrive completely, if they do not fit in their allocated memory buffers, and so on.  The code serving the auxiliary logic is intertwined with the main code that performs interesting and useful work.  Replacing one communication channel with another (for example, adding a Wi-Fi connection to a serial port) without processing the accumulated code base becomes quite problematic. <br><br>  For a long time, I dragged such code from one project to another, new improvements and fixes had to be updated in all projects in parallel.  It is tiring, fraught with the emergence of new errors and not always possible.  Finally, it is time to bring all this logic into a separate library. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The initial task: to simplify the process of creating firmware for robots that will work in the "question-answer" mode.  The main sketch should contain a useful code (which, in fact, the robot should do) and a minimum number of auxiliary structures.  All auxiliary transport and protocol blocks should be puppeted into the library and moved beyond the engineer‚Äôs attention. <br><br>  As a side effect, we got a kind of command line working inside Arduina, if you connect to it via the serial port monitor and send commands manually: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/84a/90f/84a/84a90f84acbf502ae90091a1bb430256.gif" alt="image"><br><a name="habracut"></a><br><br><h3>  Library features </h3><br>  - Work in the question-answer mode <br>  - The maximum sizes of the incoming command and response are limited by the size of the buffers (set in the settings in the sketch) <br>  - Communication channels (serial port, Wi-Fi, bluetooth) are interchangeable, implemented as separate submodules <br>  - No strict requirements for protocol details (built on top of communication modules) <br>  - New commands are added as separate functions (subroutines) and are registered in the system by a unique name. <br>  - Mechanisms for the transfer of information about exceptional situations to the client <br><br>  <b>Architecturally, the library is divided into 3 levels:</b> <br><br>  - Modules of communication channels (implemented work through the serial port; wifi and bluetooth in the medium-term plans): set up and maintain the connection, isolate packets from the input data stream, send a response. <br>  - Module for registering and executing commands: registering a function (subroutine) as a command, searching a command by name, executing a command. <br>  - Auxiliary container protocols: formats for receiving commands and packaging responses (a simple command line ‚Äî the command name and parameters are separated by spaces; the command and answers are in JSON format). <br><br><blockquote>  Serial communication channel: <a href="https://github.com/1i7/babbler_h/tree/master/babbler_serial">babbler_serial</a> <br>  Command module (command registration and execution API): <a href="https://github.com/1i7/babbler_h/tree/master/babbler_h">babbler_h</a> <br>  Simple command line module (input format): <a href="">babbler_simple</a> <br>  JSON module (input and response format): <a href="https://github.com/1i7/babbler_h/tree/master/babbler_json">babbler_json</a> </blockquote><br>  The modules are relatively independent of each other: you can use only the communication channel module to exchange raw data and build your own protocol with it, you can connect other implementations of communication channels to the command module, you can not use the JSON module at all or put the module implementation in its place working with XML packages and so on. <br><br>  Further examples. <br><br><h3>  Library installation </h3><br>  Github Project: <a href="https://github.com/1i7/babbler_h">babbler_h</a> <br><br><pre><code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/1i7/babbler_h.git</code> </pre> <br>  Or download the next <a href="https://github.com/1i7/babbler_h/releases">release in the archive</a> <br><br>  then put the subdirectories <i>babbler_h</i> , <i>babbler_serial</i> , <i>babbler_json</i> in the directory to the libraries Arduino $ HOME / Arduino / libraries, should be: <br><br><pre> <code class="hljs perl">$HOME/Arduino/libraries/babbler_h $HOME/Arduino/libraries/babbler_serial $HOME/Arduino/libraries_babbler_json</code> </pre><br>  Everything. <br><br>  Launch the Arduino development environment, in the <i>File ‚Üí Examples ‚Üí babbler_h menu</i> , the <i>following</i> examples will appear: <br><br>  <a href="https://github.com/1i7/babbler_h/tree/master/babbler_h/examples/_1_babbler_hello">_1_babbler_hello</a> : simple firmware: setting up a communication channel, registering commands (built-in commands: ping and help) <br>  <a href="https://github.com/1i7/babbler_h/tree/master/babbler_h/examples/_2_babbler_custom_cmd">_2_babbler_custom_cmd</a> : add your own commands (turn on / off the light bulb) <br>  <a href="https://github.com/1i7/babbler_h/tree/master/babbler_h/examples/_3_babbler_cmd_params">_3_babbler_cmd_params</a> : commands with parameters (transport for pin_mode / digital_write) <br>  <a href="https://github.com/1i7/babbler_h/tree/master/babbler_h/examples/_4_babbler_cmd_devino">_4_babbler_cmd_devino</a> : a set of commands for getting information about the device <br>  <a href="https://github.com/1i7/babbler_h/tree/master/babbler_h/examples/_5_babbler_custom_handler">_5_babbler_custom_handler</a> : own input data handler (same as _1_babbler_hello, only the inside is outside) <br>  <a href="https://github.com/1i7/babbler_h/tree/master/babbler_h/examples/_6_babbler_reply_json">_6_babbler_reply_json</a> : I / O is packed with JSON <br>  <a href="https://github.com/1i7/babbler_h/tree/master/babbler_h/examples/_7_babbler_reply_xml">_7_babbler_reply_xml</a> : input by string, response in XML <br>  <a href="https://github.com/1i7/babbler_h/tree/master/babbler_h/examples/babbler_basic_io">babbler_basic_io</a> : raw <a href="https://github.com/1i7/babbler_h/tree/master/babbler_h/examples/babbler_basic_io">Q</a> &amp; A over serial port without command module infrastructure <br><br><h3>  Simple example: echo via serial port </h3><br>  Without using the infrastructure of working with teams. <br><br>  <i>File ‚Üí Examples ‚Üí babbler_h ‚Üí <a href="">babbler_basic_io.ino</a></i> <br><br>  We only need the babbler_serial module: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"babbler_serial.h"</span></span></span></span></code> </pre><br>  Buffers for receiving incoming data and sending a response.  An incoming packet (command and parameters) must fit completely into the <i>serial_read_buffer</i> buffer (plus one byte is reserved for one terminating zero).  The answer must fit completely into the <i>serial_write_buffer</i> buffer. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//         #define SERIAL_READ_BUFFER_SIZE 128 #define SERIAL_WRITE_BUFFER_SIZE 512 //         . // +1       char serial_read_buffer[SERIAL_READ_BUFFER_SIZE+1]; char serial_write_buffer[SERIAL_WRITE_BUFFER_SIZE];</span></span></code> </pre><br>  <i>Input</i> data handler function: accepts data in the <i>input_buffer</i> buffer, decides what to do with it, writes the response to the <i>reply_buffer</i> buffer, returns the number of bytes written to the response buffer.  Here is all user code. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle_input</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* input_buffer, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> input_len, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* reply_buffer, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> reply_buf_size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      , //       input_buffer[input_len] = 0; // -    -     if(reply_buf_size &gt; input_len + 10) sprintf(reply_buffer, "you say: %s\n", input_buffer); else sprintf(reply_buffer, "you are too verbose, dear\n"); return strlen(reply_buffer); }</span></span></code> </pre><br>  Serial Port Communication Module Presets: <br><br>  - <i>babbler_serial_setup</i> : passing buffers for incoming commands and outgoing responses, <br>  - <i>packet_filter_newline</i> : filter for new packets - packets are separated by a line <i>break</i> <br>  - <i>babbler_serial_set_input_handler</i> : pointer to the input data handler function in the user code (our <i>handle_input</i> ) <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Serial.begin(<span class="hljs-number"><span class="hljs-number">9600</span></span>); Serial.println(<span class="hljs-string"><span class="hljs-string">"Starting babbler-powered device, type something to have a talk"</span></span>); babbler_serial_set_packet_filter(packet_filter_newline); babbler_serial_set_input_handler(handle_input); <span class="hljs-comment"><span class="hljs-comment">//babbler_serial_setup( // serial_read_buffer, SERIAL_READ_BUFFER_SIZE, // serial_write_buffer, SERIAL_WRITE_BUFFER_SIZE, // 9600); babbler_serial_setup( serial_read_buffer, SERIAL_READ_BUFFER_SIZE, serial_write_buffer, SERIAL_WRITE_BUFFER_SIZE, BABBLER_SERIAL_SKIP_PORT_INIT); }</span></span></code> </pre><br>  We place the <i>babbler_serial_tasks</i> into the main loop: we constantly monitor the serial port and wait for the input data.  The <i>babbler_serial_tasks</i> call <i>is</i> not blocking, after which any other logic can be placed. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     ,    babbler_serial_tasks(); }</span></span></code> </pre> <br>  Flash, open <i>Tools ‚Üí Port Monitor</i> , enter messages, get the answers: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4a3/872/697/4a387269731e137b447685ed1a3ee0d5.gif" alt="image"><br><br><h3>  A simple example: working with teams </h3><br>  The next simple example is working with teams.  We register two embedded commands in the firmware (defined in the <a href="">babbler_cmd_core.h</a> module): <br><br>  - <i>help</i> (get a list of commands, see help on the selected command) and <br>  - <i>ping</i> (check if the device is alive). <br><br>  <b>Ping command:</b> <br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">ping</span></span></code> </pre> <br>  Returns "ok" <br><br>  <b>Help command:</b> <br>  Display a list of commands with a brief description. <br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">help</span></span></code> </pre> <br>  List the commands <br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">help</span></span> <span class="hljs-comment"><span class="hljs-comment">--list</span></span></code> </pre> <br>  Display detailed help on the team <br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">help</span></span> _</code> </pre> <br><br>  <i>File ‚Üí Examples ‚Üí babbler_h ‚Üí <a href="">_1_babbler_hello.ino</a></i> <br><br>  Here is the infrastructure for registering, searching and executing commands by name: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"babbler.h"</span></span></span></span></code> </pre><br>  Here, the analysis of the incoming command line: the line is divided into elements by spaces, the first element is the name of the command, all the rest are parameters. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"babbler_simple.h"</span></span></span></span></code> </pre><br>  Here are the command definitions: help and ping <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"babbler_cmd_core.h"</span></span></span></span></code> </pre><br>  Serial communication module: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"babbler_serial.h"</span></span></span></span></code> </pre><br>  Buffers for input and output, everything is unchanged. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//         #define SERIAL_READ_BUFFER_SIZE 128 #define SERIAL_WRITE_BUFFER_SIZE 512 //         . // +1       char serial_read_buffer[SERIAL_READ_BUFFER_SIZE+1]; char serial_write_buffer[SERIAL_WRITE_BUFFER_SIZE];</span></span></code> </pre><br>  Register commands - add the <i>CMD_HELP</i> and <i>CMD_PING structures</i> (they are defined in babbler_cmd_core.h) to the global <i>BABBLER_COMMANDS</i> array.  Along the way, we fix the number of registered commands <i>BABBLER_COMMANDS_COUNT</i> - the number of elements in the <i>BABBLER_COMMANDS</i> array (in C, it is impossible to know the size of the array, thus defined, dynamically in the place where we need it). <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/**   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">babbler_cmd_t</span></span> BABBLER_COMMANDS[] = { <span class="hljs-comment"><span class="hljs-comment">//   babbler_cmd_core.h CMD_HELP, CMD_PING }; /**    */ extern const int BABBLER_COMMANDS_COUNT = sizeof(BABBLER_COMMANDS)/sizeof(babbler_cmd_t);</span></span></code> </pre><br>  <i>Using the</i> same scheme, we register human-readable manuals for registered commands in the <i>BABBLER_MANUALS</i> array ‚Äî they are <i>displayed</i> by the <i>help</i> command (you can define an empty array with no elements if you want to save memory, but then the <i>help</i> command will not work). <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/**     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">babbler_man_t</span></span> BABBLER_MANUALS[] = { <span class="hljs-comment"><span class="hljs-comment">//   babbler_cmd_core.h MAN_HELP, MAN_PING }; /**      */ extern const int BABBLER_MANUALS_COUNT = sizeof(BABBLER_MANUALS)/sizeof(babbler_man_t);</span></span></code> </pre><br>  Configure the module: <br><br>  - <i>babbler_serial_set_packet_filter</i> and <i>babbler_serial_setup</i> - everything, as before <br>  - in <i>babbler_serial_set_input_handler we</i> send a pointer to the <i>handle_input_simple</i> function (from babbler_simple.h, instead of our own <i>handle_input</i> ) - it does all the necessary work: parses the input string by spaces, separates the command name from the parameters, executes the command, writes the answer. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Serial.begin(<span class="hljs-number"><span class="hljs-number">9600</span></span>); Serial.println(<span class="hljs-string"><span class="hljs-string">"Starting babbler-powered device, type help for list of commands"</span></span>); babbler_serial_set_packet_filter(packet_filter_newline); babbler_serial_set_input_handler(handle_input_simple); <span class="hljs-comment"><span class="hljs-comment">//babbler_serial_setup( // serial_read_buffer, SERIAL_READ_BUFFER_SIZE, // serial_write_buffer, SERIAL_WRITE_BUFFER_SIZE, // 9600); babbler_serial_setup( serial_read_buffer, SERIAL_READ_BUFFER_SIZE, serial_write_buffer, SERIAL_WRITE_BUFFER_SIZE, BABBLER_SERIAL_SKIP_PORT_INIT); }</span></span></code> </pre><br>  The main loop is unchanged: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     ,    babbler_serial_tasks(); }</span></span></code> </pre><br>  Flash, open <i>Tools ‚Üí Port Monitor</i> , enter commands, get the answers: <br><br> <code><b>]help --list</b></code> <br> <pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">help</span></span> <span class="hljs-built_in"><span class="hljs-built_in">ping</span></span></code> </pre><br> <code><b>]ping</b></code> <br> <pre> <code class="hljs erlang-repl">ok</code> </pre><br> <code><b>]help</b></code> <br> <pre> <code class="hljs sql">Commands: <span class="hljs-keyword"><span class="hljs-keyword">help</span></span> <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> available commands <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> detailed <span class="hljs-keyword"><span class="hljs-keyword">help</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> selected command ping <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> device <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> available</code> </pre><br> <code><b>]help ping</b></code> <br> <pre> <code class="hljs pgsql">ping - manual <span class="hljs-type"><span class="hljs-type">NAME</span></span> ping - <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> device <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> available SYNOPSIS ping DESCRIPTION <span class="hljs-keyword"><span class="hljs-keyword">Check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> device <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> available, <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> "ok" <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> device <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> ok</code> </pre><br> <code><b>]help help</b></code> <br> <pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">help</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">manual</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">help</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> available commands <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> detailed <span class="hljs-keyword"><span class="hljs-keyword">help</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> selected command SYNOPSIS <span class="hljs-keyword"><span class="hljs-keyword">help</span></span> <span class="hljs-keyword"><span class="hljs-keyword">help</span></span> [cmd_name] <span class="hljs-keyword"><span class="hljs-keyword">help</span></span> <span class="hljs-comment"><span class="hljs-comment">--list DESCRIPTION List available commands or show detailed help on selected command. Running help with no options would list commands with short description. OPTIONS cmd_name - command name to show detailed help for --list - list all available commands separated by space</span></span></code> </pre><br><h3>  Adding custom commands </h3><br>  And finally, adding your own team so that it can be easily called by name.  For example, add two commands: <br><br>  - <i>ledon</i> (turn on the bulb) and <br>  - <i>ledoff</i> (turn off the light bulb) <br><br>  to turn on and off the LED connected to the selected leg of the microcontroller. <br><br>  Here everything is unchanged: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"babbler.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"babbler_simple.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"babbler_cmd_core.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"babbler_serial.h"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//         #define SERIAL_READ_BUFFER_SIZE 128 #define SERIAL_WRITE_BUFFER_SIZE 512 //         . // +1       char serial_read_buffer[SERIAL_READ_BUFFER_SIZE+1]; char serial_write_buffer[SERIAL_WRITE_BUFFER_SIZE];</span></span></span></span></code> </pre> <br>  LED foot number: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LED_PIN 13</span></span></code> </pre> <br>  And here is a useful code right away - for each command, a function with parameters must be defined: <br><br>  - <i>reply_buffer</i> - buffer for recording the reply <br>  - <i>reply_buf_size</i> - <i>reply_buffer</i> buffer size (the answer should fit in it, otherwise report an error) <br>  - <i>argc</i> - the number of arguments (parameters) command <br>  - <i>argv</i> - the values ‚Äã‚Äãof the command arguments (the first argument is always the name of the command, all by analogy with the usual main) <br><br>  Option for <i>ledon</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/**   ledon ( ) */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cmd_ledon</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* reply_buffer, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> reply_buf_size, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *argv[]=</span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">NULL</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ digitalWrite(LED_PIN, HIGH); <span class="hljs-comment"><span class="hljs-comment">//   strcpy(reply_buffer, REPLY_OK); return strlen(reply_buffer); }</span></span></code> </pre> <br>  The <i>babbler_cmd_t</i> structure for registering a command: command name and pointer to its function: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">babbler_cmd_t</span></span> CMD_LEDON = { <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-string"><span class="hljs-string">"ledon"</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> &amp;cmd_ledon };</code> </pre> <br>  Team Guide - <i>babbler_man_t</i> structure: team name, short description, detailed description. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">babbler_man_t</span></span> MAN_LEDON = { <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-string"><span class="hljs-string">"ledon"</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-string"><span class="hljs-string">"turn led ON"</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-string"><span class="hljs-string">"SYNOPSIS\n"</span></span> <span class="hljs-string"><span class="hljs-string">" ledon\n"</span></span> <span class="hljs-string"><span class="hljs-string">"DESCRIPTION\n"</span></span> <span class="hljs-string"><span class="hljs-string">"Turn led ON."</span></span> };</code> </pre> <br>  All the same for <i>ledoff</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/**   ledoff ( ) */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cmd_ledoff</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* reply_buffer, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> reply_buf_size, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *argv[]=</span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">NULL</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ digitalWrite(LED_PIN, LOW); <span class="hljs-comment"><span class="hljs-comment">//   strcpy(reply_buffer, REPLY_OK); return strlen(reply_buffer); } babbler_cmd_t CMD_LEDOFF = { /*   */ "ledoff", /*       */ &amp;cmd_ledoff }; babbler_man_t MAN_LEDOFF = { /*   */ "ledoff", /*   */ "turn led OFF", /*  */ "SYNOPSIS\n" " ledoff\n" "DESCRIPTION\n" "Turn led OFF." };</span></span></code> </pre><br>  We register new <i>CMD_LEDON</i> and <i>CMD_LEDOFF</i> together with the familiar <i>CMD_HELP</i> and <i>CMD_PING</i> , similar to the manual. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/**   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">babbler_cmd_t</span></span> BABBLER_COMMANDS[] = { <span class="hljs-comment"><span class="hljs-comment">//   babbler_cmd_core.h CMD_HELP, CMD_PING, //   CMD_LEDON, CMD_LEDOFF }; /**    */ extern const int BABBLER_COMMANDS_COUNT = sizeof(BABBLER_COMMANDS)/sizeof(babbler_cmd_t); /**     */ extern const babbler_man_t BABBLER_MANUALS[] = { //   babbler_cmd_core.h MAN_HELP, MAN_PING, //   MAN_LEDON, MAN_LEDOFF }; /**      */ extern const int BABBLER_MANUALS_COUNT = sizeof(BABBLER_MANUALS)/sizeof(babbler_man_t);</span></span></code> </pre> <br>  The setup and main cycle unchanged. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Serial.begin(<span class="hljs-number"><span class="hljs-number">9600</span></span>); Serial.println(<span class="hljs-string"><span class="hljs-string">"Starting babbler-powered device, type help for list of commands"</span></span>); babbler_serial_set_packet_filter(packet_filter_newline); babbler_serial_set_input_handler(handle_input_simple); <span class="hljs-comment"><span class="hljs-comment">//babbler_serial_setup( // serial_read_buffer, SERIAL_READ_BUFFER_SIZE, // serial_write_buffer, SERIAL_WRITE_BUFFER_SIZE, // 9600); babbler_serial_setup( serial_read_buffer, SERIAL_READ_BUFFER_SIZE, serial_write_buffer, SERIAL_WRITE_BUFFER_SIZE, BABBLER_SERIAL_SKIP_PORT_INIT); pinMode(LED_PIN, OUTPUT); } void loop() { //     ,    babbler_serial_tasks(); }</span></span></code> </pre> <br>  Flash, open <i>Tools ‚Üí Port Monitor</i> , enter commands, watch the light bulb: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/84a/90f/84a/84a90f84acbf502ae90091a1bb430256.gif" alt="image"><br><br>  Live with a piece of iron: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/fD1UlC5zJDI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  ‚Üí <a href="">An example of a command with parameters</a> for independent work. </div><p>Source: <a href="https://habr.com/ru/post/315084/">https://habr.com/ru/post/315084/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../315070/index.html">Android developer cones and rakes for 2 years</a></li>
<li><a href="../315074/index.html">You are not superheroes: please stop setting yourself tasks that you are not yet able to cope with.</a></li>
<li><a href="../315076/index.html">We forward USB ‚Äì key to the cloud (Linux client - Linux server)</a></li>
<li><a href="../315078/index.html">"Browser War" Google Chrome continues - news from the fields</a></li>
<li><a href="../315080/index.html">Lectures Tehnotreka. Basics of web development (spring 2016)</a></li>
<li><a href="../315086/index.html">Installing PROXMOX 4.3 on Soft-RAID 10 GPT</a></li>
<li><a href="../315098/index.html">Nginx build: CentOS 6.8, documents and rake</a></li>
<li><a href="../315100/index.html">The malicious program Retefe is used to compromise online banking users.</a></li>
<li><a href="../315102/index.html">Setting up a FullMesh network on Mikrotik via EoIP tunnels</a></li>
<li><a href="../315106/index.html">From zero to one. How I went from freelance to chief designer for the year</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>