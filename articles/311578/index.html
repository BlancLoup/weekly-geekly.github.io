<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Processing voice requests in Telegram using Yandex SpeechKit Cloud</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How it all began 


 This summer, I participated in the development of the Datatron bot, which provides access with open financial data from the Russi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Processing voice requests in Telegram using Yandex SpeechKit Cloud</h1><div class="post__text post__text-html js-mediator-article"><h3>  How it all began </h3><br><p>  This summer, I participated in the development of the <a href="https://telegram.me/datatron_bot">Datatron</a> bot, which provides access with open financial data from the Russian Federation.  At some point, I wanted the bot to process voice requests, and decided to use Yandex for this task. <a name="habracut"></a></p><br><p>  After a long search for at least some useful information on this topic, I finally met a man who wrote <strong>voiceru_bot</strong> and helped me deal with this topic (sources refer to his repository).  Now I want to share this knowledge with you. </p><br><h3>  From words to practice </h3><br><p>  Below will be the fragments of the code is completely ready for use, which you can almost just copy and paste into your project. </p><br><h4>  Step 1. Where to start? </h4><br><p>  Get a Yandex account (if you don‚Äôt have one).  Then read the SpeechKit Cloud API <a href="https://yandex.ru/legal/speechkit_cloud/">terms of use</a> .  In short, for non-commercial projects with the number of requests no more than 1000 per day, use is free.  Then go to the <a href="https://developer.tech.yandex.ru/">Developer's Cabinet</a> and order the key to the desired service.  It is usually activated within 3 business days (although one of my keys was activated after a week).  Finally, review the <a href="https://tech.yandex.ru/speechkit/cloud/doc/intro/overview/concepts/about-docpage/">documentation</a> . </p><br><h4>  Step 2: Save the sent voice recording </h4><br><p>  Before you send a request to the API, you need to get the voice message itself.  In the code below, in a few lines, we get an object in which all data about the voice message is stored. </p><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests @bot.message_handler(content_types=[<span class="hljs-string"><span class="hljs-string">'voice'</span></span>]) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">voice_processing</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span><span class="hljs-function">:</span></span> file_info = bot.get_file(message.voice.file_id) file = requests.get(<span class="hljs-string"><span class="hljs-string">'https://api.telegram.org/file/bot{0}/{1}'</span></span>.format(TELEGRAM_API_TOKEN, file_info.file_path))</code> </pre> <br><p>  Saving an object to the file variable, we are primarily interested in the content field, which stores the byte recording of the sent voice message.  We need it for further work. </p><br><h4>  Step 3. Recoding </h4><br><p>  The voice message in Telegram is saved in OGG format with the Opus audio codec.  SpeechKit can handle audio data in the OGG format with the Speex audio codec.  Thus, it is necessary to convert the file, best of all to PCM 16000 Hz 16 bit, since according to the documentation this format provides the best quality of recognition.  <a href="https://www.ffmpeg.org/download.html">FFmpeg is</a> perfect for this.  Download it and save to the project directory, leaving only the bin folder and its contents.  Below, a function is implemented, which with the help of FFmpeg recodes a stream of bytes in the desired format. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> subprocess <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tempfile <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convert_to_pcm16b16000r</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(in_filename=None, in_bytes=None)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> tempfile.TemporaryFile() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> temp_out_file: temp_in_file = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> in_bytes: temp_in_file = tempfile.NamedTemporaryFile(delete=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>) temp_in_file.write(in_bytes) in_filename = temp_in_file.name temp_in_file.close() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> in_filename: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> Exception(<span class="hljs-string"><span class="hljs-string">'Neither input file name nor input bytes is specified.'</span></span>) <span class="hljs-comment"><span class="hljs-comment">#        FFmpeg command = [ r'Project\ffmpeg\bin\ffmpeg.exe', #   ffmpeg.exe '-i', in_filename, '-f', 's16le', '-acodec', 'pcm_s16le', '-ar', '16000', '-' ] proc = subprocess.Popen(command, stdout=temp_out_file, stderr=subprocess.DEVNULL) proc.wait() if temp_in_file: os.remove(in_filename) temp_out_file.seek(0) return temp_out_file.read()</span></span></code> </pre> <br><h4>  Step 4. Audio transmission in parts </h4><br><p>  SpeechKit Cloud API accepts a file up to 1 MB in size, while its size must be specified separately (in Content-Length).  But it is better to implement file transfer in parts (no larger than 1 MB in size using the Transfer-Encoding header: chunked).  It's safer, and text recognition will be faster. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_chunks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(chunk_size, bytes)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: chunk = bytes[:chunk_size] bytes = bytes[chunk_size:] <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> chunk <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> bytes: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span></code> </pre> <br><h4>  Step 5. Sending a request to the Yandex API and parsing the response </h4><br><p>  Finally, the last step is to write one single function that will serve as the "API" for this module.  That is, first it will call the methods responsible for converting and reading bytes by blocks, and then go to the SpeechKit Cloud request and read the response.  By default, for requests, the topic is set to notes, and the language is Russian. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> xml.etree.ElementTree <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> XmlElementTree <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> httplib2 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uuid <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> config <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> YANDEX_API_KEY YANDEX_ASR_HOST = <span class="hljs-string"><span class="hljs-string">'asr.yandex.net'</span></span> YANDEX_ASR_PATH = <span class="hljs-string"><span class="hljs-string">'/asr_xml'</span></span> CHUNK_SIZE = <span class="hljs-number"><span class="hljs-number">1024</span></span> ** <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">speech_to_text</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(filename=None, bytes=None, request_id=uuid.uuid4</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">.hex, topic=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'notes'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, lang=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'ru-RU'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, key=YANDEX_API_KEY)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#    if filename: with open(filename, 'br') as file: bytes = file.read() if not bytes: raise Exception('Neither file name nor bytes provided.') #     bytes = convert_to_pcm16b16000r(in_bytes=bytes) #     Yandex API url = YANDEX_ASR_PATH + '?uuid=%s&amp;key=%s&amp;topic=%s&amp;lang=%s' % ( request_id, key, topic, lang ) #    chunks = read_chunks(CHUNK_SIZE, bytes) #      connection = httplib2.HTTPConnectionWithTimeout(YANDEX_ASR_HOST) connection.connect() connection.putrequest('POST', url) connection.putheader('Transfer-Encoding', 'chunked') connection.putheader('Content-Type', 'audio/x-pcm;bit=16;rate=16000') connection.endheaders() #    for chunk in chunks: connection.send(('%s\r\n' % hex(len(chunk))[2:]).encode()) connection.send(chunk) connection.send('\r\n'.encode()) connection.send('0\r\n\r\n'.encode()) response = connection.getresponse() #    if response.code == 200: response_text = response.read() xml = XmlElementTree.fromstring(response_text) if int(xml.attrib['success']) == 1: max_confidence = - float("inf") text = '' for child in xml: if float(child.attrib['confidence']) &gt; max_confidence: text = child.text max_confidence = float(child.attrib['confidence']) if max_confidence != - float("inf"): return text else: #      - -    raise SpeechException('No text found.\n\nResponse:\n%s' % (response_text)) else: raise SpeechException('No text found.\n\nResponse:\n%s' % (response_text)) else: raise SpeechException('Unknown error.\nCode: %s\n\n%s' % (response.code, response.read())) #    lass SpeechException(Exception): pass</span></span></code> </pre> <br><h4>  Step 6. Using the written module </h4><br><p>  Now we add the main method, from which we will call the function speech_to_text.  It only needs to add processing of the case when the user sends a voice message in which there are no sounds or recognizable text.  Remember to import the speech_to_text function and the SpeechException class if necessary. </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@bot.message_handler(content_types=['voice']) def voice_processing(message): file_info = bot.get_file(message.voice.file_id) file = requests.get( 'https://api.telegram.org/file/bot{0}/{1}'.format(API_TOKEN, file_info.file_path)) try: #      text = speech_to_text(bytes=file.content) except SpeechException: #  ,     else: # -</span></span></code> </pre> <br><p>  That's all.  Now you can easily implement voice processing in your projects.  And not only in the Telegram, but also on other platforms, based on this article! </p><br><h4>  Sources: </h4><br><p>  ¬ª@Voiceru_bot: <a href="https://github.com/just806me/voiceru_bot">https://github.com/just806me/voiceru_bot</a> <br>  ¬ª <a href="https://github.com/eternnoir/pyTelegramBotAPI">Telebot</a> library was used to work with Telegram API on Python </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/311578/">https://habr.com/ru/post/311578/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../311566/index.html">Dot the ss</a></li>
<li><a href="../311568/index.html">Is your favorite C so fast or the native implementation of linear algebra on D</a></li>
<li><a href="../311572/index.html">"Write letters": Three techniques of layout of good emails</a></li>
<li><a href="../311574/index.html">Techleads Meetup in Badoo</a></li>
<li><a href="../311576/index.html">The history of creating an application for finding nannies in Ireland and an electronic waiter</a></li>
<li><a href="../311580/index.html">New management features: Intel RealSense and GestureWorks Fusion</a></li>
<li><a href="../311582/index.html">Twelve Useful Chrome DevTools Tips</a></li>
<li><a href="../311584/index.html">About hacking servers FirstVDS</a></li>
<li><a href="../311586/index.html">Restrictions (—Åonstraints) PostgreSQL: exclude, partial unique, pending restrictions, etc.</a></li>
<li><a href="../311588/index.html">What to do so that the organizer of the conference wants you</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>