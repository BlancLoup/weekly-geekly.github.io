<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configuring the VPN router TP-Link TL-ER6020 to work with 3CX Phone System</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TP-Link wireless routers have received deserved recognition, especially from home users and small companies. However, TP-Link also produces a line of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configuring the VPN router TP-Link TL-ER6020 to work with 3CX Phone System</h1><div class="post__text post__text-html js-mediator-article">  TP-Link wireless routers have received deserved recognition, especially from home users and small companies.  However, TP-Link also produces a line of powerful and fairly functional routers and enterprise-level access points.  In particular, the business class router TL-ER6020 at a very affordable price has a number of interesting features: <br><ul><li>  2 Gigabit WAN ports with backup switching capability, 2 Gigabit LAN ports, 1 Gigabit LAN / DMZ port and 1 console port </li><li>  Support for multiple VPN protocols, including IPsec / PPTP / L2TP servers </li><li>  Supports up to 50 IPsec VPN tunnels using a hardware VPN handler </li><li>  Advanced security features including ARP inspection, protection against DoS attacks, filtering by URL and domain name keyword, and access control </li></ul><br> <a href=""><img title="image" src="https://habrastorage.org/getpro/habr/post_images/de2/fa9/c22/de2fa9c2288cd3b94e50e2ae9fab427e.png" alt="image" width="819" height="254"></a> <br><br>  A detailed description of the features and settings of the TL-ER6020 is available <a href="http://www.tp-linkru.com/download/TL-ER6020.html">here</a> .  In this article, we will limit ourselves to the description of setting up the TP-Link TL-ER6020 router for working with 3CX Phone System. <br><br>  The network diagram provides for the location of the 3CX server on the NAT of the router in the network 192.168.0.0 / 24. The IP address of the router is 192.168.0.1, and the IP address of the server is 3CX 192.168.0.2 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <a href=""><img title="image" src="https://habrastorage.org/getpro/habr/post_images/5f2/ba6/ff5/5f2ba6ff57c6933941cb3047f1c16a87.png" alt="image" width="634" height="337"></a> <a name="habracut"></a><br><br><h2>  Router preparation </h2><br>  First of all, you need to update the firmware TL-ER6020, because, <a href="http://forum.tp-linkru.ru/viewtopic.php%3Ff%3D262%26amp%3Bt%3D8279">as it turned out</a> , even the latest firmware from the official TP-Link site has an error that does not allow disabling <a href="http://www.3cx.ru/voip-sip/alg/">SIP ALG</a> .  <a href="http://www.3cx.ru/docs/firewall-router-configuration-voip/">Disabling SIP ALG is</a> critical for the correct operation of various SIP operators with 3CX. <br><ol><li>  Log in to the router interface at 192.168.0.1 (default address) with username and password <strong>admin / admin</strong> </li><li>  <a href="">Download firmware</a> and upgrade router <a href=""><img title="image" src="https://habrastorage.org/getpro/habr/post_images/6d6/bec/35c/6d6bec35c0f3536fb7f0fb75af5bc4d9.png" alt="image" width="819" height="332"></a> </li><li>  After updating, it is recommended to reset the device to default settings. </li></ol><br><h2>  Router Setup </h2><br>  Configuring a router consists of three steps: <br><ol><li>  Connect at least one WAN port to the Internet </li><li>  Disable SIP ALG service </li><li>  Publication of services (port forwarding) through NAT, necessary for the full operation of 3CX Phone System </li><li>  Additional firewall settings for increased security </li><li>  Testing the correctness of the configuration of the TL-ER6020 inbound and outbound SIP call </li></ol><br><h3>  Connecting the router to the Internet </h3><br>  Connecting one (or both) WAN ports to the Internet is done in the <strong>Network - WAN</strong> section.  At the bottom of the interface, you can check the status of the connection.  This example uses a PPPoE connection. <br><br> <a href=""><img title="image" src="https://habrastorage.org/getpro/habr/post_images/4f4/26e/cd5/4f426ecd512412c4e8bf0c81c521730c.png" alt="image" width="860" height="688"></a> <br><br><h3>  Disable SIP ALG service </h3><br>  Disable SIP ALG in the <strong>Advanced - NAT - ALG</strong> section <strong>.</strong> <br><br> <a href=""><img title="image" src="https://habrastorage.org/getpro/habr/post_images/913/05c/8c7/91305c8c7a8fce64911caa639aa2eda3.png" alt="image" width="862" height="288"></a> <br><br><h3>  Publication of services (port forwarding) through NAT </h3><br>  For the correct operation of external SIP trunks, you must publish a number of <a href="http://www.3cx.ru/docs/firewall-router-configuration-voip/">ports of the</a> 3CX Phone System <a href="http://www.3cx.ru/docs/firewall-router-configuration-voip/">server</a> : <br><ul><li>  5060 TCP / UDP - SIP </li><li>  5090 TCP / UDP - <a href="http://www.3cx.ru/docs/3cx-tunnel-session-border-controller/">3CX Tunnel</a> </li><li>  5000, 5001 (for Abyss web server) or 80 and 443 (for IIS server) TCP ‚Äî 3CXPhone advanced management and auto configuration of IP phones </li><li>  9000-9500 UDP - RTP and WebRTC media stream </li></ul><br>  Publication of services is done in the section <strong>Advanced - NAT - Virtual Server</strong> .  Let's start with the SIP server. <br><br> <a href=""><img title="image" src="https://habrastorage.org/getpro/habr/post_images/cfd/00a/e3d/cfd00ae3dc1ab194529409eb66bee0c4.png" alt="image" width="952" height="451"></a> <br><br>  After publishing all the services, the interface should look something like this. <br><br> <a href=""><img title="image" src="https://habrastorage.org/getpro/habr/post_images/66b/7a8/95b/66b7a895b4f1738ad595e9ed0115ab40.png" alt="image" width="952" height="586"></a> <br><br><h3>  Configure a firewall for increased security </h3><br>  Publication of services as it is implemented in the TL-ER6020, causes fair concerns: we are opening the SIP port 5060, which hackers love so much, in fact, for the whole world.  In the publishing interface there is no possibility to specify for which IP addresses the 3CX server's SIP port should be opened. <br><br>  <strong>Our strong recommendation: open port 5060 only for the SIP addresses of telecom operators / SIP providers your system works with.</strong> <br><br>  In our example, the system works with the Russian operator Megafon (Multifon service) and the Ukrainian operator Kyivstar, while Megafon uses <a href="http://multifon.ru/help/">different IP addresses for the SIP server and SIP proxy</a> , and Kyivstar is the <a href="http://www.kyivstar.ua/f/1/business/fixed/archive/ip_telephony_arch/IP_rus.docx">only SIP server.</a> <br><br>  First, we define the services / port ranges to which access should be restricted in the <strong>Firewall - Access Control - Service</strong> section. <br><br> <a href=""><img title="image" src="https://habrastorage.org/getpro/habr/post_images/28f/b33/7c6/28fb337c6a33f4277cc5af2a52193e3e.png" alt="image" width="968" height="585"></a> <br><br>  Here we defined only SIP port 5060 and <a href="http://www.3cx.com/blog/docs/ports-used/">RTP ports 9000-9255</a> .  Since the remaining 3CX services must be accessible to any IP address on the Internet and there is no need to restrict access to them. <br><br>  In the <strong>Firewall - Access Control - Access Rules</strong> section, we add <strong>firewall</strong> rules that allow access to certain 3CX services only from certain SIP addresses. <br><br> <a href=""><img title="image" src="https://habrastorage.org/getpro/habr/post_images/3b1/9c8/cca/3b19c8cca237eb8c378d141d0c13bc30.png" alt="image" width="961" height="577"></a> <br><br>  You also need to add one general prohibition rule that restricts access to these ports to all Internet addresses.  Please note - <strong>this rule should be the last in the list.</strong>  The final list of rules should look like this. <br><br> <a href=""><img title="image" src="https://habrastorage.org/getpro/habr/post_images/b49/a1b/286/b49a1b28651a49cb2a0649d90c70da08.png" alt="image" width="764" height="272"></a> <br><br>  The second part of the list with the general prohibiting rule. <br><br> <a href=""><img title="image" src="https://habrastorage.org/getpro/habr/post_images/93d/481/bfc/93d481bfc7fb6cda85eb6ad3989f41ea.png" alt="image" width="762" height="270"></a> <br><h3>  Setup Testing </h3><br>  To verify that the firewall is working correctly, make outgoing and incoming calls.  The call should be successful, the audibility should be two-way and there should not be a connection break <a href="https://andrewjprokop.wordpress.com/2013/07/02/understanding-sip-timers-part-i/">after 32 seconds</a> . <br><br><h2>  Conclusion </h2><br>  Setting up the TP-Link TL-ER6020 VPN router to work with the 3CX Phone System is a fairly simple process, but requires consideration of some of the features that we had to face.  It is also desirable to have an understanding of the basic principles of the VoIP technology. <br><br>  In this guide, we did not consider such an interesting feature of the TL-ER6020 as the reservation of the WAN channel.  This feature allows you to provide uninterrupted VoIP connection even in the event of the ‚Äúfall‚Äù of the main Internet connection. <br><br> <a href=""><img title="image" src="https://habrastorage.org/getpro/habr/post_images/4c6/d6b/15f/4c6d6b15fe040ed64845b56691c96e82.png" alt="image" width="922" height="600"></a> <br><br>  However, keep in mind that such a reservation imposes certain requirements on the SIP connections used: <br><ul><li>  It is recommended to use SIP connections with authorization by username and password.  In this case, when the main Internet channel is disconnected, the SIP connection is automatically re-registered through the second operator. </li><li>  If you are using a SIP line with authorization by IP address (SIP trunk), ask the operator to authorize the IP address of the backup Internet connection.  After that, the operator will be able to receive and route calls through this connection. </li></ul><br><h2>  Additional Information </h2><br><ul><li>  <a href="http://www.3cx.com/blog/docs/ports-used/">Used ports in 3CX Phone System</a> </li><li>  <a href="http://blog.lithiumblue.com/2007/07/understanding-relationship-between-sip.html">Passing SIP and RTP traffic</a> </li><li>  <a href="http://www.3cx.com/support/firewall-configuration/">Recommendations for configuring</a> various firewalls for 3CX Phone System </li><li>  <a href="http://forum.tp-linkru.ru/index.php">TP-Link Technical Support Forum</a> </li><li>  <a href="http://www.3cx.com/blog/voip-howto/3cx-firewall-checker-client/">3CX Remote Firewall Checker utility</a> for detecting problems with <a href="http://www.3cx.com/blog/voip-howto/3cx-firewall-checker-client/">firewalls</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/281757/">https://habr.com/ru/post/281757/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../281745/index.html">Can all financial models be erroneous: 7 sources of risk of losses</a></li>
<li><a href="../281747/index.html">Aggregate functions in dplyr</a></li>
<li><a href="../281749/index.html">Test lab v.9 - countdown</a></li>
<li><a href="../281751/index.html">Is RemoteApp vulnerable?</a></li>
<li><a href="../281755/index.html">Unicode character properties in V8 regular expressions</a></li>
<li><a href="../281759/index.html">Kotlin overview and comparison with C #</a></li>
<li><a href="../281763/index.html">Underground carders market. Translation of the book "KingPIN". Chapter 27. "Web War One"</a></li>
<li><a href="../281765/index.html">Sphere: how to monitor billions of kilowatt-hours</a></li>
<li><a href="../281767/index.html">Generating shaders GLSL, HLSL, Metal</a></li>
<li><a href="../281769/index.html">Explanation of the branching experiment, or philosophical research on benchmarks in vacuum and in ... reality</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>