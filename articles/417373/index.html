<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ZFS Storage, standby and test environments</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="- Do we have any snapshot for January, closer to February? 
 - Now let's see ... Yes, there is! Now we open. 

 It happens that there is an average li...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ZFS Storage, standby and test environments</h1><div class="post__text post__text-html js-mediator-article">  <i>- Do we have any snapshot for January, closer to February?</i> <i><br></i>  <i>- Now let's see ... Yes, there is!</i>  <i>Now we open.</i> <br><br>  It happens that there is an average lifetime of the test base, there is a snapshot lifetime agreed upon by all concerned, but one of the environments ‚Äúlingers‚Äù for a long time in its picture, which cannot be deleted at all ... and then it turns out to be useful to colleagues.  And a minus on a minus gives plus. <br><br>  Usually for any systems in which something can happen, it is required to form backups.  And if it also develops and is being finalized, then somewhere else also develop development and testing environments.  And for backups and test environments that work, in fact, with the same data, you need a lot of space.  And yet these environments need to somehow lead to the current state.  And all this requires hardware and time resources. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In our case, these needs covered the Oracle ZFS Storage Appliance and the Oracle / Sun servers, which actually merged into one ecosystem with Exadata, which appeared shortly before them. <br><a name="habracut"></a><br>  Since there is an InfiniBand switch inside Exadata, through which its components communicate, and ZFS Storage is also a Oracle Appliance, then: <br><br><ul><li>  first, it was directly connected to this switch by part of its ports; </li><li>  secondly, it can store tablespace files with segments compressed in Exadata Hybrid Columnar Compression (EHCC), saving us a lot of space in the main system.  If you try to restore the database on a separate server, then after the recovery, referring to the compressed data, you will get the error: ‚Äúthe data files, compressed in the EHCC, must be stored on the Oracle Appliance; </li><li>  thirdly, it opens up the possibility of using ZFS facilities for storing test environment files. </li></ul><br>  Well, what about the place?  You need to avoid duplication. <br><br>  Test environments need the same data as they are in backups.  Can this data perform both functions?  Be a backup and foundation for any privileged test environment that needs a complete dataset?  They can! <br><br>  The Oracle ZFS Storage Appliance is an array that provides, among other things, the ability to form network shares running under the ZFS file system.  As part of the ZFS file system, you can create snapshots, based on which you can deploy clones, which are visible as new network shares.  We use this feature as follows: <br><br><ol><li>  On ZFS Storage (so we will call the array so as not to be confused with the file system) two shares are created - Archivelog is added into one, and the base files into the other; </li><li>  Share is mounted to the Oracle / Sun server (which is also an Appliance), and on the server itself, an instance of the Oracle Database works as cascaded physical standby - it receives logs from the conditionally reserve site and applies the changes to the files lying in share; </li><li>  The use of logs is organized according to the workunit principle (hello to all participants of distributed computing!).  At the level of the algorithm, the concept of workunit is introduced, which corresponds to a certain time interval.  After logging in for the required interval, the instance stops, and in share there are files that are in a consistent state relative to each other and the controlfile.  In fact, it is a cold backup, it is also an Image Copy, on top of which it is snapshot; </li><li>  When it comes time to re-create the test environment, a clone is created from the desired snapshot.  It is mounted to the server on which the environment is running, after which the files in it open as a base under a different name and in the Read / Write mode; </li><li>  In the process of working in the test database, changes are made that are deposited within the clone, and it is slowly growing.  By the end of the life cycle, the environment grows to its maximum. </li><li>  To reduce the consumption of disk space even less, we apply LZJB compression, which ZFS Storage performs on the fly. </li></ol><br>  Eventually: <br><br><ol><li>  In the current configuration, test environments can perform I / O up to the level of 3.75 Gb / s; <br>  The maximum for reading is still limited by the existing settings of the InfiniBand ports on the server, the maximum for writing is the CPU on the ZFS Storage controllers and reaches approximately 2 Gb / s.  (Yes, yes! Because 10 GbE was not enough, separate switches were purchased for test servers, including ZFS Storage and the servers themselves); </li><li>  Several snapshots are created per day, which are now stored, depending on the base, from 2 weeks to 2 months.  After that, they are all deleted, except for the snapshots created at 00:00, the 1st of each month - these are already stored for more than a quarter.  There were cases when the snapshots that were stored for about <i>six months</i> turned out to be useful; </li><li>  If necessary, the entire industrial database can be restored from the desired snapshot.  Also with a speed of about 1 ... 3 Gb / s., But the option of creating a clone from the desired snapshot, from which the data of the necessary tables is downloaded, is much more popular; </li><li>  The re-creation time of the test environment is about 1 hour (with transfer of a number of additional circuits there, etc.); </li><li>  The time to provide a clone to colleagues from which you can take data for recovery or just some kind of analysis - from 15 minutes (under ideal conditions) to 1-2 hours (with a large parallel load on ZFS Storage or us J); </li><li>  If necessary, you can recover from the snapshot and clone, and the entire database as a whole; </li><li>  The main performance limiter is the number of IOPS generated by test environments or cascaded standby instances.  And here the system behaves absolutely adequately and predictably - as soon as their number approaches 75 IOPS per HDD (it has 3.5 ‚Äùdisks at 7200 rpm) under prolonged load, the system gradually begins to sag.  And small in time - Write- and Read-Flash are facilitated noticeably; </li><li>  The number of IOPS, the total amount of incoming data, the load on the CPU, the number of reads from the caches in RAM and Flash, as well as a few dozen (if not hundreds) metrics - can be viewed in the web-based management interface; </li><li>  You can work with ZFS Storage objects using the REST requests described in the documentation.  With their help, we managed to automate the removal of outdated snapshots, and much more could be done! </li></ol></div><p>Source: <a href="https://habr.com/ru/post/417373/">https://habr.com/ru/post/417373/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../417355/index.html">Baldness: Theory and practice of treatment, part 2 "Even the prostate has tonsils, prostaglandins"</a></li>
<li><a href="../417357/index.html">"About IT" nastolki. The history of games with a computer setting</a></li>
<li><a href="../417359/index.html">Information Security? No have not heard</a></li>
<li><a href="../417367/index.html">How far away are dreams of the perfect ‚Äúfile search‚Äù</a></li>
<li><a href="../417369/index.html">15 tools for a working arsenal of a product manager</a></li>
<li><a href="../417375/index.html">15 HTML methods of elements that you have probably never heard of</a></li>
<li><a href="../417377/index.html">Why not use Google Cloud</a></li>
<li><a href="../417379/index.html">New RDTT for Vega-C and Ariane 6</a></li>
<li><a href="../417381/index.html">Skype 8.0 came out: call recording and secret chats</a></li>
<li><a href="../417383/index.html">JavaScript ES6: weaknesses</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>