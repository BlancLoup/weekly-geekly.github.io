<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Protecting a Phalcon + AngularJS web application against CSRF attacks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello to all! Not so long ago, I faced the problem of protecting a web application written in the Phalcon PHP Framework along with AngularJS. The prob...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Protecting a Phalcon + AngularJS web application against CSRF attacks</h1><div class="post__text post__text-html js-mediator-article">  Hello to all!  Not so long ago, I faced the problem of protecting a web application written in the Phalcon PHP Framework along with AngularJS.  The problem was that the page has several forms that send AJAX requests to the server.  How to make friends two security frameworks, I did not find a centralized solution, I had to assemble it piece by piece from various sources.  And in this article I would like to offer everyone who faced, or will face such a problem, a ready-made working solution. <br><br><h4>  We generate a token in the meta-tag </h4><br>  Unfortunately, I don‚Äôt remember the source right now, but more than once I noticed that between the tags, often in the meta, there were tokens on large sites.  If you look at the <a href="http://docs.phalconphp.com/ru/latest/reference/security.html">Phalcon documentation</a> , you will see that the token generation takes place in the form.  This is how the default token is generated in the form: <br><a name="habracut"></a><br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"&lt;?php echo $this-&gt;security-&gt;getTokenKey() ?&gt;"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"&lt;?php echo $this-&gt;security-&gt;getToken() ?&gt;"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre> <br>  What to do if there are two forms?  There was a solution on the forum, but it was using a third-party library, which in my case was not a good solution, so having a little more searching on the forum, I found a solution to generate a token in the meta-tag. <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"token"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"&lt;?= $this-&gt;security-&gt;getTokenKey() ?&gt;"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"&lt;?= $this-&gt;security-&gt;getToken() ?&gt;"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre><br><br><h4>  Fasten the token to all AJAX requests </h4><br>  After reading the documentation for working with <a href="http">AngularJS</a> with tokens, it is proposed to transfer a token in the header with the name X-XSRF-TOKEN, but alas, Phalcon needed to write a separate library for processing such tokens.  I do not have time for this, I am lazy, so I had to find another more simple solution. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> app = angular.module(<span class="hljs-string"><span class="hljs-string">'selfmd'</span></span>, [], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$httpProvider</span></span></span><span class="hljs-function">) </span></span>{ $httpProvider.defaults.headers.post[<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>] = <span class="hljs-string"><span class="hljs-string">'application/x-www-form-urlencoded;charset=utf-8'</span></span>; $httpProvider.defaults.transformRequest = [<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data === <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>) { data = {}; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> token = $(<span class="hljs-string"><span class="hljs-string">'meta[name=token]'</span></span>); data[token.attr(<span class="hljs-string"><span class="hljs-string">'title'</span></span>)] = token.attr(<span class="hljs-string"><span class="hljs-string">'content'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> angular.isObject(data) &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>(data) !== <span class="hljs-string"><span class="hljs-string">'[object File]'</span></span> ? param(data) : data; }]; }</code> </pre><br>  In addition to simplicity, it is also flexible, because absolutely all AJAX requests sent using the $ http function are protected by a token that Phalcon easily and conveniently accepts by standard means. <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;security-&gt;checkToken()) { <span class="hljs-comment"><span class="hljs-comment">//  }</span></span></code> </pre><br><br><h4>  Possible problems and solutions </h4><br>  1. If a person wants to view the source code of the page (not through firebug, but in a separate window), then when loading from, a new token is generated, and returning to the page, no request will be processed.  Perhaps this is good, there is nothing to climb into the source code. <br>  2. If suddenly there is no favicon on the page, or there is an empty background-image: url ("");  then the browser, requesting this data, generates a new token imperceptibly for us.  I spent two or three days trying to find the cause of the failure token, and the last thing I could suspect was a block with an empty background-image: url (""); <br>  3. How to protect forms without AJAX, and without $ http?  Very simple! <br>  In the controller, add new scopes: <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> token = $(<span class="hljs-string"><span class="hljs-string">'meta[name=token]'</span></span>); $scope.token_id = token.attr(<span class="hljs-string"><span class="hljs-string">'title'</span></span>); $scope.token_val = token.attr(<span class="hljs-string"><span class="hljs-string">'content'</span></span>);</code> </pre><br>  And in the view we display them in a hidden field: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{token_id}}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{token_val}}"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre><br>  Now all forms are protected, Phalcon is pleased with his usual data, and does not use extra libraries, and Angular without any problems we cling to all $ http token. <br><br><h4>  Afterword </h4><br>  I am far from being a security specialist, I am not a PHP guru, I just solve the problems that arise when I do what I like to do.  I did not find the same convenient and understandable solution, which is why I wanted to share it.  I use this solution in a real project until problems have been noticed.  Most likely you will indicate mistakes in the comments and I will be grateful to you.  I‚Äôve been working with Phalcon and AngularJS since August of this year, before that I‚Äôve worked with CodeIgniter and jQuery, so don‚Äôt judge much for such a solution if it turned out to be not as cool as it seemed to me. <br><br>  Thanks for attention.  If you are interested in reading about Phalcon, subscribe, I have a few more useful solutions to problems when working with him. </div><p>Source: <a href="https://habr.com/ru/post/245467/">https://habr.com/ru/post/245467/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../245453/index.html">Roslyn to automatically translate C # code into 1C code</a></li>
<li><a href="../245455/index.html">Problem, solution and stability check in statics</a></li>
<li><a href="../245459/index.html">Analog video input for Virturilki and its use in the national economy</a></li>
<li><a href="../245461/index.html">When running World of Tanks game replays, arbitrary code can be executed on your computer</a></li>
<li><a href="../245465/index.html">Why students need a CppCat code analyzer</a></li>
<li><a href="../245469/index.html">Rovio fires employees, tanks are out for Android, women with children shop more often - and other news of the week for a mobile developer</a></li>
<li><a href="../245471/index.html">How the Cowboy web server and the Kato messenger help each other: A little about Erlang and open source</a></li>
<li><a href="../245473/index.html">About creating platformer on Unity. Part 4.1, the villainous</a></li>
<li><a href="../245475/index.html">ASUS ESC4000 G2S - the most efficient supercomputer in the world</a></li>
<li><a href="../245477/index.html">Keeping independent time on android device</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>