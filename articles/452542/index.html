<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Adaptation programs for the ZX Spectrum to TR-DOS with modern tools. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first part of the article, we disassembled the original version downloader and found out where the game code is loaded and how it is launched. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Adaptation programs for the ZX Spectrum to TR-DOS with modern tools. Part 2</h1><div class="post__text post__text-html js-mediator-article"><p>  In the <a href="https://habr.com/ru/post/451174/">first part of the article,</a> we disassembled the original version downloader and found out where the game code is loaded and how it is launched.  Now you need to transfer files to disk. </p><br><p><img src="https://habrastorage.org/webt/jv/tm/ti/jvtmtiduxnsmps-skthb1oxwclq.jpeg" alt="Floppy 5.25 &quot;"></p><br><p>  This is usually done by simply copying files, but there is one problem.  The fact is that the original file contains a picture and a game code in a whole piece and, therefore, overwrites the area of ‚Äã‚Äãbasic and system variables that are immediately behind the screen area.  Such a file can be loaded from a tape, but cannot be loaded from a floppy.  TR-DOS reserves a certain memory area for your needs, and if you load data there, during the boot process everything will break. </p><a name="habracut"></a><br><p>  Fortunately, we have enough memory, not busy playing.  Therefore, the game can be downloaded to another place, and after the download is complete, move where you need to and start it.  In this case, I would like to show the picture before the end of the download - for that it is bootable.  To do this, we cut the monolithic file into two - the data of the screen area and the game data: </p><br><pre><code class="plaintext hljs">$ head -c 6912 headless.bin &gt; screen.bin $ tail -c +6913 headless.bin &gt; data.bin</code> </pre> <br><p>  The file with the game data immediately translate hobeta format.  Later we need it to write to the final image.  To convert formats, we will use <a href="https://sourceforge.net/projects/zxspectrumutils/">zxspectrum-utils</a> and <a href="http://xagon.webz.cz/convert.html"><code>trd2hob</code></a> : </p><br><pre> <code class="plaintext hljs">$ binto0 data.bin 3 $ 0tohob data.000 #   data.$C</code> </pre> <br><p><img src="https://habrastorage.org/webt/n1/s7/ui/n1s7uic_xqwh_4u1wsneecdqb28.png" alt="Loading screen"></p><br><p>  As for the boot screen, spend 6.75 kb on such a simple picture - waste.  It can be compressed with a screen compressor, for example, <a href="http://www.worldofspectrum.org/infoseekid.cgi%3Fid%3D0021446">Laser Compact 5.2</a> .  To do this, you first need to write the image file to a temporary floppy image: </p><br><pre> <code class="plaintext hljs">$ binto0 screen.bin 3 $ 0tohob screen.000 $ createtrd tmp.trd $ hobeta2trd screen.\$C tmp.trd</code> </pre> <br><p>  After that, run the Laser Compact in the emulator and save the compressed image to the same diskette (Pack screen ‚Üí Save with depacker).  When saving, specify the file name <code>screenz.C</code> .  Next, you need to copy the compressed image from the floppy image back to the disk.  Unfortunately, I could not find the <code>trd2hob</code> source code anywhere, so I have to run the DOS binary from under DosBox: </p><br><pre> <code class="plaintext hljs">$ dosbox -c "mount C $PWD" -c "C:" -c "trd2hob.exe screen.trd" -c exit</code> </pre> <br><p>  As a result, we obtain a hobeta file of the form <code>screenz.$</code> with a compressed picture. </p><br><p>  In addition to native Spectrum utilities for compressing screens, there are utilities for PCs, for example, <a href="https://github.com/antoniovillena/zx7b"><code>zx7b</code></a> and <code>zxsc</code> .  Although it is more convenient to automate work with them, both of them have laser drawbacks before the Laser Compact: </p><br><ol><li>  Both lose on the quality of compression. </li><li>  When unpacking a picture, certain artifacts are visible, while the Laser Compact fills the screen attribute area almost instantly. </li><li>  <code>zx7b</code> does not support the creation of self-extracting archives - you have to additionally compile the decompressor. </li></ol><br><p>  Finally, find out the size of the compressed file.  We will need it later to write the bootloader. </p><br><pre> <code class="plaintext hljs">$ lstrd tmp.trd 80 Tracks, Double Side, capacity 640kB Number of files/deleted: 2/0 Free sectors/bytes: 2509/642304 First free sector/track: 3/3 FILENAME TYPE SECTORS ADDRESS LENGTH TRACK SECTOR -------------------------------------------------------------- screen &lt;C&gt; CODE (BYTES) 27 16384 6912 1 0 screenz &lt;C&gt; CODE (BYTES) 8 40000 1812 2 11</code> </pre> <br><p>  As you can see, the file shrank more than three times and takes 8 sectors on the disk. </p><br><p>  In the next part, we proceed directly to the bootloader. </p><br><h3 id="ssylki-po-teme">  Related Links: </h3><br><ol><li>  <a href="https://zxpress.ru/book.php%3Fid%3D104">‚ÄúAdaptation of programs to the TR-DOS system‚Äù by</a> Nikolay Rodionov. </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/452542/">https://habr.com/ru/post/452542/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../452532/index.html">Arduino Thermometer & Hygrometer from E-PAPER to nRF52832 - or what manufacturers have forgotten to release</a></li>
<li><a href="../452534/index.html">New approach to multiplication suggests how to improve quantum computers</a></li>
<li><a href="../452536/index.html">A hacker who hacked into a GPS tracking application found that he could remotely stop them</a></li>
<li><a href="../452538/index.html">Atomexpo 2019, part 1: events and a sudden space engine</a></li>
<li><a href="../45254/index.html">Web Forms Design Patterns: Subscription Forms</a></li>
<li><a href="../452546/index.html">AirSelfie 2 Power Edition - Vyalik's camera. Or not?</a></li>
<li><a href="../452548/index.html">What are you ready for iPhone?</a></li>
<li><a href="../45255/index.html">Vision problems</a></li>
<li><a href="../452552/index.html">Cross-compiling Scala in the Gradle project</a></li>
<li><a href="../452556/index.html">The digest of fresh materials from the world of the frontend for the last week No. 365 (May 13 - 19, 2019)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>