<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>IIS Request filtering against ddos ‚Äã‚Äãattacks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Lie down 
 The customer, whose websites I supported earlier, turned to the fact that the site lies and gives 500 error. He has a standard site on ASP....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>IIS Request filtering against ddos ‚Äã‚Äãattacks</h1><div class="post__text post__text-html js-mediator-article"><h3>  Lie down </h3><br>  The customer, whose websites I supported earlier, turned to the fact that the site lies and gives 500 error.  He has a standard site on ASP.NET WebForms, I will not say that it is very loaded, but there were problems with database performance (MS SQL Server on a separate server).  Recently, the database server was changed and transferred data. <br><br>  This site is not the main business of the customer, so it is practically not maintained.  He does not have any monitoring and collection of metrics, and in general he is not particularly watched. <br><br><h3>  Telemetry data </h3><br>  What anomalies were evident: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  The w3wp process used more than 50% of the CPU (usually much less). </li><li>  The number of threads in this process has steadily increased (the site did not have time to serve customers). </li><li>  The disk on the database server was used 100% (Active Time). </li><li>  The queue length for disk calls with project databases was long (usually around zero-ones). </li><li>  RAM on the database server is fully used. </li><li>  The profiler showed that there is one hot method that goes to the database. </li></ol><a name="habracut"></a><h3>  Tuning DBMS </h3><br>  My first hypothesis was related to problems on the server side of the database due to its transfer: they forgot to configure something, it does not work out to collect statistics and rebuild the index, etc. <br><br>  Memory - it immediately became clear that when transferring the DBMS they forgot to limit the use of RAM on the new server - we limit it.  From past experience, this configuration was quite enough 24GB (of the total 32). <br><br>  Check Joba - all the rules.  We start Tuning Advisor and complete the missing indexes (among them was the index for the hot query from the profiler).  Exhaust close to zero: the site is. <br><br><h3>  IIS </h3><br>  I log in and immediately everything becomes clear - DDoS: <br><br><div style="text-align:center;"><img height="99" src="https://habrastorage.org/getpro/habr/post_images/9aa/de1/231/9aade12317cf44ace85d5a1ae7070add.png" width="400"></div><br>  The first time such a situation, it is not clear who needed.  Requests became 10 times more, what in logs? <br><br>  In the logs we see about 200 requests per second (regular users generate up to ten per minute by metrics).  All requests from different IP, they are united only by a similar user-agent: <br><table><tbody><tr><td width="30">  Get </td><td width="125">  101.200.177.82 </td><td>  WordPress / 4.2.2;  <a href="">www.renwenqifei.com; + verifying + pingback + from + 37.1.211.155</a> </td><td width="30">  503 <br></td></tr><tr><td>  Get </td><td>  54.69.1.242 </td><td>  WordPress / 4.2.10;  <a href="">54.69.1.242; + verifying + pingback + from + 37.1.211.155</a> </td><td>  503 <br></td></tr><tr><td>  Get </td><td>  123.57.33.117 </td><td>  WordPress / 4.0;  <a href="">www.phenomenon.net.cn; + verifying + pingback + from + 37.1.211.155</a> </td><td>  503 <br></td></tr><tr><td>  Get </td><td>  54.69.236.133 </td><td>  WordPress / 4.3.1; + http: //www.the-call-button.com; + verifying + pingback + from + 37.1.211.155 </td><td>  503 <br></td></tr><tr><td>  Get </td><td>  52.19.227.86 </td><td>  WordPress / 4.3.6;  <a href="">52.19.227.86; + verifying + pingback + from + 37.1.211.155</a> </td><td>  503 <br></td></tr><tr><td>  Get </td><td>  52.27.233.237 </td><td>  WordPress / 4.1.13;  <a href="">52.27.233.237;</a>  verifying + pingback + from + 37.1.211.155 </td><td>  503 <br></td></tr><tr><td>  Get </td><td>  202.244.241.54 </td><td>  WordPress / 3.5.1;  <a href="http://www.fm.geidai.ac.jp/">www.fm.geidai.ac.jp</a> </td><td>  503 <br></td></tr><tr><td>  Get </td><td>  52.34.12.105 </td><td>  WordPress / 4.3.6;  <a href="">52.34.12.105;</a>  verifying + pingback + from + 37.1.211.155 </td><td>  503 <br></td></tr><tr><td>  Get </td><td>  128.199.195.155 </td><td>  WordPress / 4.3.6;  <a href="">www.glamasia.com; + verifying + pingback + from + 37.1.211.155</a> </td><td>  503 <br></td></tr><tr><td>  Get </td><td>  61.194.65.94 </td><td>  WordPress / 4.2.10;  <a href="">wpwewill.help; + verifying + pingback + from + 37.1.211.155</a> </td><td>  503 <br></td></tr><tr><td>  Get </td><td>  23.226.237.2 </td><td>  WordPress / 4.3.1;  <a href="">hypergridder.com; + verifying + pingback + from + 37.1.211.155</a> </td><td>  503 <br></td></tr><tr><td>  Get </td><td>  104.239.228.203 </td><td>  WordPress / 4.2.5;  <a href="">pjtpartners.com; + verifying + pingback + from + 37.1.211.155</a> </td><td>  503 <br></td></tr><tr><td>  Get </td><td>  104.239.168.88 </td><td>  WordPress / 4.2.10;  <a href="">creatorinitiative.com; + verifying + pingback + from + 37.1.211.155</a> </td><td>  503 <br></td></tr><tr><td>  Get </td><td>  166.78.66.195 </td><td>  WordPress / 3.6;  <a href="http://remote.wisys.com/website">remote.wisys.com/website</a> </td><td>  503 <br></td></tr><tr><td>  Get </td><td>  212.34.236.214 </td><td>  WordPress / 3.5.1;  <a href="http://nuevavista.am/">nuevavista.am</a> </td><td>  503 <br></td></tr></tbody></table><br>  This is a known type of attack: a WordPress site with Pingback enabled (enabled by default), can be used in a DDOS attack on other sites.  More detailed <a href="https://habrahabr.ru/post/215543/">article</a> on Habr√©. <br><br><h1>  Configuring the query filter </h1><br>  There are several levels where you can filter requests.  The first is a firewall.  We get ip - we add them to the firewall, on schedule we collect newly appeared ones.  Pros - great speed, no garbage requests in the logs.  Cons - need to write scripts and follow. <br><br>  The second level is IIS itself (from obvious minuses, garbage requests get into the logs).  The third level is to write a module and use it.  This is the most flexible approach, but is laborious and has low productivity. <br><br>  I stopped at the second level from considerations to get a decision having made a minimum of actions. <br>  IIS has a lot of filtering capabilities.  In this case, is suitable <b>Request Filtering</b> .  <a href="https://www.iis.net/configreference/system.webserver/security/requestfiltering">More details about installation and configuration.</a> <br><br>  Choose site ‚Üí Request Filtering ‚Üí Rules ‚Üí Add filtering rules <br><div style="text-align:center;"><img height="161" src="https://habrastorage.org/getpro/habr/post_images/46c/4ed/9a1/46c4ed9a132fba90c1ffa5fce39a3063.png" width="640"></div><br>  And we indicate that we want to filter all requests where in Header: User-Agent is the word WordPress. <br><br><div style="text-align:center;"><img height="400" src="https://habrastorage.org/getpro/habr/post_images/448/8e7/09d/4488e709d4c3928af2e074de742592de.png" width="307"></div><br>  Or you can specify the appropriate settings in the web.config file: <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.webServer</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">security</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">requestFiltering</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filteringRules</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filteringRule</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ddos"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">scanUrl</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">scanQueryString</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scanHeaders</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">clear</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">requestHeader</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"User-Agent"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scanHeaders</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">denyStrings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">clear</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">string</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"WordPress"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">denyStrings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filteringRule</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filteringRules</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">requestFiltering</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">security</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.webServer</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Immediately after applying this filter, the site has earned.  All indicators are back to normal.  If I checked the logs right away, it would take less than half an hour. <br><br><h3>  What else can IIS do? </h3><br>  IIS is a very cool and productive web application server.  In addition to sending the request to the managed environment, it can do a lot and, in terms of performance, strongly beats managed solutions. <br><br>  In the <b>Request Filtering</b> section, you can configure many more different filters: by methods, URL segments, query parameters, extensions, etc.  You can disable PHP-specific query parameters in an asp.net project (an attempt to access htaccess or a password file).  You can prohibit malicious queries, for example, containing sql-injection.  This is done not as protection against these attacks, but in order to save server resources: IIS will automatically discard these requests and do it quickly with minimal memory and processor time. <br><br>  Another mechanism is called <b>IP Address and Domain Restrictions</b> .  This mechanism allows you to make white and black lists of IP addresses to restrict access to the site.  You can block the evil parser or vice versa to open access to the test site or admin panel only from certain IP.  Read more in the <a href="https://www.iis.net/configreference/system.webserver/security/ipsecurity">official documentation</a> . <br><br>  And the third mechanism that can help you counteract DDoS attacks and unwanted parsers is <b>Dynamic IP Address Restrictions.</b> <br><br>  Not always we can follow the constantly changing ip-addresses of the attacker.  But with this tool we can limit the frequency of requests.  Thus, IIS for an abnormally large number of requests from a single IP address will quickly give out 403 or 404. Be careful with search bots.  <a href="https://www.iis.net/downloads/microsoft/dynamic-ip-restrictions">Official documentation</a> . <br><br><h1>  findings </h1><br>  Do not disable logs, set up monitoring, which clearly warns you about anomalies in the indicators.  This can be done quickly and inexpensively, and will save you time when investigating incidents.  We shall leave the monitoring setting, as well as administrative and organizational countermeasures beyond the scope of this article. </div><p>Source: <a href="https://habr.com/ru/post/316550/">https://habr.com/ru/post/316550/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316538/index.html">Into the toolbox for prototyping: Make My App</a></li>
<li><a href="../316540/index.html">As I opened the Dota-league. Part 1</a></li>
<li><a href="../316542/index.html">Interview with Andrei Ivashentsev (Game Insight) about the future of VR and AR</a></li>
<li><a href="../316546/index.html">2.5F Authentication</a></li>
<li><a href="../316548/index.html">Vulnerability in the management software allows you to flash controllers Schneider Electric</a></li>
<li><a href="../316556/index.html">Two aspects of ‚Äúdecentralized‚Äù one-page applications</a></li>
<li><a href="../316558/index.html">An example of using the Product API from Fetchee for parsing products online store</a></li>
<li><a href="../316562/index.html">We look part of someone else's favorite VKontakte</a></li>
<li><a href="../316564/index.html">New generation of Cambium Networks products: ePMP Elevate</a></li>
<li><a href="../316566/index.html">A practical guide to VR design</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>