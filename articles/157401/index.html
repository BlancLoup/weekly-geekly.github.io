<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Combined load balancing online channels</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 

 Sooner or later, the system administrator is faced with the need to distribute traffic across multiple channels, while naturally the des...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Combined load balancing online channels</h1><div class="post__text post__text-html js-mediator-article"><h4>  Prehistory </h4><br><br>  Sooner or later, the system administrator is faced with the need to distribute traffic across multiple channels, while naturally the desire is that each channel be used to the maximum.  Faced with a similar need, and deciding not to reinvent the wheel, turned to the help of search engines.  Since I have a server on Ubuntu, I turned my attention to the article <a href="http://help.ubuntu.ru/wiki/ip_balancing">http://help.ubuntu.ru/wiki/ip_balancing</a> .  I implemented ‚ÄúMethod 1‚Äù, but during the test the following critical problems were noticed: when using links on some sites they did not open (for example, when trying to turn on music on the VKontakte resource).  The reason is obvious - the request went through another channel.  Having considered the situation, I decided to combine the approach to balancing.  The logic is simple - most torrents and similar programs eat up traffic, so we share traffic.  As a result, we distribute traffic with ports up to 11000 approximately evenly by the number of subscribers - subnets; with traffic with ports 11000-60000, we equalize the load on the channels. <br><a name="habracut"></a><br><h4>  Settings </h4><br><br>  It is assumed that the routing tables for each of the channels are created, let's call them <b>chan1</b> , <b>chan2</b> , <b>chan3</b> - three channels, respectively. <br>  Somewhere, for example, in /etc/rc.local we add something like: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="bash hljs">ip rule add prio 101 fwmark 1 table chan1 ip rule add prio 102 fwmark 2 table chan2 ip rule add prio 103 fwmark 4 table chan3</code> </pre> <br><br>  Create the /etc/rc.balance script: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash lst='/etc/rc.balance.lst' ########### Flushing ################## /sbin/iptables -t mangle -F PREROUTING /sbin/iptables -t mangle -F POSTROUTING /sbin/iptables -t mangle -F OUTPUT ####################################### /etc/rc.baltor /sbin/iptables -t mangle -A PREROUTING -d 172.16.0.0/16 -j RETURN /sbin/iptables -t mangle -A PREROUTING -s 172.16.0.0/16 -m state --state INVALID -j DROP while read net mark do /sbin/iptables -t mangle -A PREROUTING -s $net -m state --state new,related -j CONNMARK --set-mark $mark done&lt;$lst /sbin/iptables -t mangle -A PREROUTING -s 172.16.0.0/16 -p udp --sport 11000:60000 --dport 11000:60000 -m state --state new,related -j BALANCE /sbin/iptables -t mangle -A PREROUTING -s 172.16.0.0/16 -p tcp --sport 11000:60000 --dport 11000:60000 -m state --state new,related -j BALANCE /sbin/iptables -t mangle -A PREROUTING -s 172.16.0.0/16 -j CONNMARK --restore-mark exit 0</span></span></code> </pre><br><br>  Create a list of distribution of grids by channels (in the second column - the brand): <br><br><pre> <code class="bash hljs">172.16.0.0/22 1 172.16.4.0/22 2 172.16.8.0/22 4</code> </pre><br><br>  Script / etc / rc.baltor - balancing rules: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash /sbin/iptables -t mangle -F BALANCE lst='/etc/rc.cnload.lst' mrk=1 while read kld do /sbin/iptables -t mangle -A BALANCE -j CONNMARK --set-mark $mrk /sbin/iptables -t mangle -A BALANCE -m statistic --mode random --probability 0.$kld -j RETURN mrk=`expr $mrk \* 2` done &lt; $lst /sbin/iptables -t mangle -A BALANCE -j CONNMARK --set-mark $mrk exit 0</span></span></code> </pre><br><br>  The /etc/rc.cnload script is a calculation of the probability depending on the channel load: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash cn1=800000 #        cn2=600000 #  .. cn3=400000 #   if1='eth1' #    if2='eth2' #  if3='eth3' #  lst='/etc/rc.cnload.lst' a1=`ifconfig $if1 | grep "RX bytes" | awk '{print $2}' | awk -F: '{print $2}'` a2=`ifconfig $if2 | grep "RX bytes" | awk '{print $2}' | awk -F: '{print $2}'` a3=`ifconfig $if3 | grep "RX bytes" | awk '{print $2}' | awk -F: '{print $2}'` sleep 20 b1=`ifconfig $if1 | grep "RX bytes" | awk '{print $2}' | awk -F: '{print $2}'` b2=`ifconfig $if2 | grep "RX bytes" | awk '{print $2}' | awk -F: '{print $2}'` b3=`ifconfig $if3 | grep "RX bytes" | awk '{print $2}' | awk -F: '{print $2}'` c1=`expr \( $b1 - $a1 \) \* 8 / 20000` c2=`expr \( $b2 - $a2 \) \* 8 / 20000` c3=`expr \( $b3 - $a3 \) \* 8 / 20000` d1=`expr \( $cn1 - $c1 \) \* 100 / $cn1` d2=`expr \( $cn2 - $c2 \) \* 100 / $cn2` d3=`expr \( $cn3 - $c3 \) \* 100 / $cn3` #         60% if [ $d1 -lt "40" -o $d2 -lt "40" -o $d3 -lt "40" ] then e1=`expr 100 \* $d1 / \( $d1 + $d2 + $d3 \)` e2=`expr 100 \* $d2 / \( $d2 + $d3 \)` f1=`head -n 1 $lst | tail -n 1` f2=`head -n 2 $lst | tail -n 1` #     if [ $e1 -ne $f1 -a $e2 -ne $f2 ] then echo $e1 &gt; $lst echo $e2 &gt;&gt; $lst /etc/rc.baltor fi fi exit 0</span></span></code> </pre><br><br>  Add to /etc/rc.local <br><pre> <code class="bash hljs">/etc/rc.balance</code> </pre><br><br>  and in / etc / crontab <br><pre> <code class="bash hljs">*/1 * * * * root /etc/rc.cnload</code> </pre><br><br>  It is important that at the time of launch there already existed a file with coefficients /etc/rc.cnload.lst, it can be composed by running the script /etc/rc.cnload. <br><br><h4>  Conclusion </h4><br><br>  This method is successfully implemented in a network with 8000 subscribers.  In addition to balancing, dynamic shaping is used, but this is a topic for another article. <br><br>  All balance in everything. </div><p>Source: <a href="https://habr.com/ru/post/157401/">https://habr.com/ru/post/157401/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../157389/index.html">Context menus VS2010 / 2012 and keyboard</a></li>
<li><a href="../157391/index.html">Comparison of Microsoft Office under Windows and Mac from the perspective of office use: what to look for</a></li>
<li><a href="../157393/index.html">Custom Themes for Custom Widgets</a></li>
<li><a href="../157395/index.html">RIM's PlayBook 3G Now Available</a></li>
<li><a href="../157397/index.html">[LAVKA] Love shop at the Ostankino television tower</a></li>
<li><a href="../157405/index.html">Mysterious textures in the Takla Makan desert on Google Earth got an explanation</a></li>
<li><a href="../157407/index.html">Interpolation + (linear | logarithmic) scale + –° ++</a></li>
<li><a href="../157409/index.html">Productive use of PHPStorm</a></li>
<li><a href="../157411/index.html">Amazon and Google are undermining the prices of mobile devices and it can hit all</a></li>
<li><a href="../157413/index.html">NASA has announced a service to help monitor the position of the ISS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>