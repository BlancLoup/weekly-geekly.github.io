<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Rails 4 - Thread-Safety</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In Rails 4.0, the config.threadsafe option will be enabled by default! and in this lesson you will learn what it does after all, how it affects produc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Rails 4 - Thread-Safety</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/1e0/172/d93/1e0172d93256aefcc3d54544779e17d0.jpg"><br><br>  In Rails 4.0, the config.threadsafe option will be enabled by default!  and in this lesson you will learn what it does after all, how it affects production, and how you should behave with threads in general. <br><a name="habracut"></a><br><hr><br>  <b>The content of the cycle "The Subtleties of Rails 4"</b> <br><ul><li>  <a href="http://habrahabr.ru/post/165355/">Cache digests</a> </li><li>  <a href="http://habrahabr.ru/post/167161/">Turbolinks</a> </li><li>  Thread safety </li></ul><br><hr><br>  Some time ago, Aaron Patterson (Tenderlove) posted an <a href="http://tenderlovemaking.com/2012/06/18/removing-config-threadsafe.html">entry on his blog</a> .  In it, he talked about the <b>threadsafe</b> option in the rails and mentioned that it will most likely be included by default in the Rails 4 release. Therefore, in this episode I‚Äôll talk about it. <br><br>  First, create a simple Rails 3 application called thready: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      terminal <br><pre><code class="ruby hljs">$ rails new thready $ cd thready</code> </pre> <br>  Opening and looking at the configuration file of the application for production shows that the option is commented out: <br><br>  /config/environments/production.rb <br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># Enable threaded mode # config.threadsafe!</span></span></code> </pre><br>  It should be understood that its inclusion does not mean a magical transformation into a multi-threaded application.  What, then, does she do?  When viewing the source code of the <b>threadsafe</b> method <b>!</b>  You can see that the installation of the options set is happening: <br><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">threadsafe!</span></span></span><span class="hljs-function"> @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">preload_frameworks</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">true</span></span></span><span class="hljs-function"> @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cache_classes</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">true</span></span></span><span class="hljs-function"> @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dependency_loading</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">false</span></span></span><span class="hljs-function"> @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">allow_concurrency</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">true</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">self</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span></span></code> </pre><br><br>  The first 3 options are responsible for the so-called <i>impatient</i> loading of the application.  Thus, when the application is launched, it is loaded immediately, instead of downloading in parts, as it happens when <b>threadsafe is</b> disabled. <br><br>  The fourth option, <b>allow_concurrency,</b> cuts off the use of the intermediate layer <b>Rack :: Lock</b> .  When you run the rake middleware command in the developer mode in the terminal, you can see that Rack :: Lock is one of the first layers that registers activity: <br><br>  terminal <br><pre> <code class="ruby hljs">$ rake middleware use ActionDispatch::Static use Rack::Lock <span class="hljs-comment"><span class="hljs-comment">#    .</span></span></code> </pre><br>  Turning on the threadsafe option in production and running: <br><br><pre> <code class="ruby hljs">$ rake middleware RAILS_ENV=production</code> </pre><br>  This layer will no longer be visible.  To answer the question ‚ÄúAnd what does Rack :: Lock do?‚Äù You should look at the <a href="">source code</a> ( <i>attention, the file has undergone changes</i> ): <br><br>  /lib/rack/lock.rb <br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'thread'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'rack/body_proxy'</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Rack</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Lock</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FLAG</span></span></span><span class="hljs-class"> = '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rack</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">multithread</span></span></span><span class="hljs-class">'.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">freeze</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">app</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mutex</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mutex</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">app</span></span></span><span class="hljs-class">, @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mutex</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">app</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mutex</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">env</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">old</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">env</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FLAG</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">env</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FLAG</span></span></span><span class="hljs-class">], </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mutex</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lock</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class"> = @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">app</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">env</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class">[2] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BodyProxy</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class">[2]) { @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mutex</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unlock</span></span></span><span class="hljs-class"> } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rescue</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Exception</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mutex</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unlock</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">raise</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ensure</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">env</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FLAG</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">old</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  When the next request comes to the <b>call</b> method, then a lock is imposed on the mutex object and only after that the request is processed, after which the block is removed.  This approach ensures that only one request will be processed at a time.  For a better understanding of the process, I will show it clearly.  To do this, create a new controller with one method: <br><br>  terminal <br><pre> <code class="perl hljs">$ rails g controller foo bar</code> </pre><br>  In the created method, the current thread will fall asleep for a second, after which some mysterious text will be displayed: <br><br>  /app/controllers/foo_controller.rb <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FooController</span></span></span><span class="hljs-class"> &lt; ApplicationController </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bar</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sleep</span></span></span><span class="hljs-class"> 1 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">render</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">: "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foobar</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">n</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Now we will start the server in development mode.  Note that WEBrick is used (by default, this is what it is).  Now, in a separate tab of the console, we will make a request to the site using curl: <br><br>  terminal <br><pre> <code class="ruby hljs">$ curl <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/localhost:3000/foo</span></span><span class="hljs-regexp"><span class="hljs-regexp">/bar foobar</span></span></code> </pre><br>  There was a second delay before the message appeared, as expected.  Now we will make 5 parallel simultaneous requests.  To do this, use the &amp; symbol, which allows you to make asynchronous requests: <br><br><pre> <code class="ruby hljs">% repeat <span class="hljs-number"><span class="hljs-number">5</span></span> (curl <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/localhost:3000/foo</span></span><span class="hljs-regexp"><span class="hljs-regexp">/bar &amp;) % foobar foobar foobar foobar foobar</span></span></code> </pre><br>  Here, of course, this is not visible, but these 5 answers came in turn, one after another, taking a total of 5 seconds.  This is due to the above sequential request processing.  Now we will start the server in production mode and again make 5 parallel requests to it: <br><br>  terminal <br><pre> <code class="ruby hljs">% rails s -e production % repeat <span class="hljs-number"><span class="hljs-number">5</span></span> (curl <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/localhost:3000/foo</span></span><span class="hljs-regexp"><span class="hljs-regexp">/bar &amp;)</span></span></code> </pre><br>  All 5 responses from the server will come at the same time, thanks to the threadsafe! Option enabled, due to which the Rack :: Lock layer is no longer used.  So now requests are processed asynchronously, hooray! <br><br>  Does all this mean that with multithreading enabled, now you need to start writing stream-safe code?  In fact, it all depends on the settings of the production.  Most of the popular rails servers, such as Unicorn and Phusion Passenger, pass only one request at a time through one worker.  In other words, even with the option turned on, requests will be processed in turn. <br><br>  You can see how Unicorn will behave.  To do this, you need to uncomment the following line: <br><br>  / Gemfile <br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># Use unicorn as the app server gem 'unicorn'</span></span></code> </pre><br>  Then run bundle install.  Now, using the unicorn command, you can start the server for the Rails application in production mode: <br><br>  terminal <br><pre> <code class="ruby hljs">$ unicorn -E production -p <span class="hljs-number"><span class="hljs-number">3000</span></span></code> </pre><br>  Running curl again now will show that there is no multithreading.  This is how Unicorn works with one worker.  For Unicorn, no additional mutex and layer Rack :: Lock are required.  It is for this reason that the <b>threadsafe</b> option <b>is!</b>  will be enabled by default in production: the logic for processing requests and threads is left to the production environment.  But do not forget that the inclusion of this option also includes the impatient, forced download of the entire application, which can cause some side effects.  So do not forget to thoroughly test your application on a test server before moving it to production! <br><br>  Another small note: <b>threadsafe</b> option <b>!</b>  can change its name in release 4 rail in order to better show the logic of its work. <br><br>  So, we already know that Unicorn and Passenger do not support multi-threading, but what to do if you want a server with its support?  Puma comes to the rescue.  This server is based on Mongrel, so it can run any Rack application using multiple threads.  Puma supports JRuby, Rubinius and even MRI.  Let's try: <br><br>  / Gemfile <br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># Use unicorn as the app server # gem 'unicorn' gem 'puma'</span></span></code> </pre><br>  Now start the server in production mode: <br><br>  terminal <br><pre> <code class="ruby hljs">$ rails s puma -e production</code> </pre><br>  Running now curl will show that the responses from the server come almost instantly. <br><br>  Puma will not work very well in MRI, because of the mechanism that is built into this version of the mechanism called Global Interpreter Lock.  But JRuby and Rubinius have better quality thread support, so Puma will work better in them. <br><br>  Of course, when using multithreading, you need to carefully monitor the code in your application and its security.  Here is a small example of unsafe code: <br><br>  /app/controllers/foo_controller.rb <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FooController</span></span></span><span class="hljs-class"> &lt; ApplicationController @@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter</span></span></span><span class="hljs-class"> = 0 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bar</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter</span></span></span><span class="hljs-class"> = @@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sleep</span></span></span><span class="hljs-class"> 1 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter</span></span></span><span class="hljs-class"> += 1 @@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">render</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">: "</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#{@</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@counter</span></span></span></span><span class="hljs-class"><span class="hljs-comment">}\n" end end</span></span></span></span></code> </pre><br><br>  The controller has a class variable called @@ counter, which increases by 1 with each call to the bar method.  In the method itself, we save the value of the class variable, sleep a second, then return the value and display it on the screen.  Let's see how everything will work in a single-threaded environment: <br><br>  terminal <br><pre> <code class="ruby hljs">$ rails s</code> </pre><br>  Run curl 4 times, after which 4 digits will appear, each with a second delay: <br><br>  terminal <br><pre> <code class="ruby hljs">% repeat <span class="hljs-number"><span class="hljs-number">4</span></span> (curl <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/localhost:3000/foo</span></span><span class="hljs-regexp"><span class="hljs-regexp">/bar &amp;) % 1 2 3 4</span></span></code> </pre><br>  Now we stop the server, and start Puma in production mode: <br><br>  terminal <br><pre> <code class="ruby hljs">$ rails s puma -e production</code> </pre><br>  Her output will be different: <br><br>  terminal <br><pre> <code class="ruby hljs">% repeat <span class="hljs-number"><span class="hljs-number">4</span></span> (curl <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/localhost:3000/foo</span></span><span class="hljs-regexp"><span class="hljs-regexp">/bar &amp;) % 1 1 1 1</span></span></code> </pre><br>  Now requests are processed simultaneously in multiple threads.  Thus, the last request had time to complete even before the first one had managed to complete its work.  Therefore, you should be very careful in working with data (@@ counter, for example), to which several streams have access.  To resolve the problem you need to use an object of the mutex type: <br><br>  /app/controllers/foo_controller.rb <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FooController</span></span></span><span class="hljs-class"> &lt; ApplicationController @@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter</span></span></span><span class="hljs-class"> = 0 @@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mutex</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mutex</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bar</span></span></span><span class="hljs-class"> @@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mutex</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">synchronize</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter</span></span></span><span class="hljs-class"> = @@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sleep</span></span></span><span class="hljs-class"> 1 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter</span></span></span><span class="hljs-class"> += 1 @@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">render</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">: "</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#{@</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@counter</span></span></span></span><span class="hljs-class"><span class="hljs-comment">}" end end</span></span></span></span></code> </pre><br>  The framed mutex code becomes thread safe.  After that, you need to restart the application server and re-use curl.  The counter now works correctly, since the code processes the threads sequentially one after the other. <br><br>  Things like class and object variables, global variables and constants must be used inside a mutex.  Despite the warnings of the interpetator, constants in Ruby can be changed.  As the line, however.  In the case of strings, use the freeze method to prohibit changing them.  And please don't forget that the code inside the class is shared memory, so you don‚Äôt need to insert methods into the class itself dynamically after the application is loaded. <br><br>  Fortunately, transforming your application into a thread-safe is not as difficult as it may seem at first.  As a rule, you are unlikely to often share shared information.  And if it is necessary, it is better to look at the known ways to do it.  It is likely that there are more elegant methods. <br><br>  It may be a difficult task to make sure that all the gems used in your application are safe.  Read the README of the used libraries, if there is no necessary information there, then it is worth creating a ticket in the tracker. <br><br>  There is one more problem that can be encountered in a multithreaded application and it is connected with a pool of database connections.  This pool sets the number of simultaneous connections to the database and defaults to 5. I have commented mutex for the demonstration. <br><br>  /app/controllers/foo_controller.rb <br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bar</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">#@</span></span><span class="hljs-doctag"><span class="hljs-function"><span class="hljs-comment"><span class="hljs-doctag">@mutex</span></span></span></span><span class="hljs-function"><span class="hljs-comment">.synchronize do counter = @</span></span><span class="hljs-doctag"><span class="hljs-function"><span class="hljs-comment"><span class="hljs-doctag">@counter</span></span></span></span><span class="hljs-function"><span class="hljs-comment"> sleep 1 counter += 1 @</span></span><span class="hljs-doctag"><span class="hljs-function"><span class="hljs-comment"><span class="hljs-doctag">@counter</span></span></span></span><span class="hljs-function"><span class="hljs-comment"> = counter #end render text: "#{@</span></span><span class="hljs-doctag"><span class="hljs-function"><span class="hljs-comment"><span class="hljs-doctag">@counter</span></span></span></span><span class="hljs-function"><span class="hljs-comment">}\n" end</span></span></span></span></code> </pre><br><br>  Having tried to make 12 simultaneous requests to the application, it will be seen that only 4 of them have passed, due to the limited number of connections.  Despite the fact that in this method there is no query to the database, rails still reserves connections for the duration of each query.  And if during the request there will not be enough connections, the application will wait until it receives its own.  Thus, if the request is delayed in time, timeout errors will start to pour and other requests will also fall off due to the lack of available connections from the database pool. <br><br>  By increasing the value in the pool to 15, you can repeat the previous curl request and all requests will be successful. <br><br>  Thanks for attention! <br><br><h5>  <i>Permission was received for publication from the author (since this is a translation of a paid screencast).</i>  <i>All inaccuracies and errors, please report to the PM.</i> </h5><br><hr><br>  <b>application</b> <br><ul><li>  <a href="http://tenderlovemaking.com/2012/06/18/removing-config-threadsafe.html">Aaron's blog entry about the config.threadsafe option!</a> </li><li>  <a href="">Rack :: Lock module source code</a> </li><li>  <a href="http://puma.io/">Puma server</a> </li></ul><br><hr><br>  Subscribe <a href="http://bloginius.com/">to my blog</a> ! </div><p>Source: <a href="https://habr.com/ru/post/172109/">https://habr.com/ru/post/172109/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../172085/index.html">SQLite - database size after DELETE FROM</a></li>
<li><a href="../172093/index.html">Report on the maintenance of the base station standards GSM and UMTS</a></li>
<li><a href="../172101/index.html">Yet Another Rating System</a></li>
<li><a href="../172105/index.html">CryptoSMS - protect your SMS (Android only)</a></li>
<li><a href="../172107/index.html">Debugging Node.js in Visual Studio</a></li>
<li><a href="../172111/index.html">DIYROCKETS and Sunglass are taking a step towards the general availability of aerospace development using joint 3D modeling</a></li>
<li><a href="../172115/index.html">Controlling access to Samba file servers in an AD-based Windows domain</a></li>
<li><a href="../172119/index.html">SimplePHPEasyPlus: Adding Numbers to PHP</a></li>
<li><a href="../172121/index.html">Cross-platform development for mobile with Xamarin</a></li>
<li><a href="../172123/index.html">Oracle ADF (Application Development Framework)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>