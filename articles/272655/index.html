<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we taught 1C to generate an IVR menu for Asterisk</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In recent years, IP telephony has entered the business by leaps and bounds. Every day there are more and more opportunities. Employees can work not on...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we taught 1C to generate an IVR menu for Asterisk</h1><div class="post__text post__text-html js-mediator-article">  In recent years, IP telephony has entered the business by leaps and bounds.  Every day there are more and more opportunities.  Employees can work not only in the office, but in general, anywhere in the world.  In order to connect telephony to an employee, just a few clicks, no wires, and separate outlets.  Companies use call recording, telephony integration with CRM systems.  Every self-respecting company connects a multichannel number or even pays for every customer call using the number 8,800. <br><img src="https://habrastorage.org/files/d45/f50/0a9/d45f500a9cd04a6cb31da726748b8b89.png"><br>  Giving a client your cell phone becomes a bad tone, because the client's request must be registered with CRM and guaranteed to be processed.  Each employee is assigned an internal extension number, and most often, knowing the extension number, you can quickly contact the right person.  The PBX knows where the employee is now, and will be able to connect the client with the desired IP phone in the office or a mobile phone, or even a SIP softphone installed on a laptop or smartphone. <br><br>  But progress has another side.  Multichannel number becomes like a firewall.  It protects employees within the company from customer calls.  An IVR menu appears on the client‚Äôs path, or even a multi-level IVR menu, and just don‚Äôt say that my call is very important to you :) <br><a name="habracut"></a><br><h3>  Life story </h3><br>  An unpleasant story happened to me.  In one of the large banks, the issue of a single deal was resolved, and I had to go on foot to visit several branches in ascending order, until I found the right specialist.  My dear girl solved a lot of my questions, having spent 4 hours on it, during which we did some documents, scanned my contracts, signed some papers.  I thought that the issue was finally resolved, but the next day a call came to me, and the cute girl asked for some additional information.  And after 2 weeks of the deal came a refusal from the bank.  Oh, how I wanted to call back this girl and find out what exactly is the matter and how to proceed. <br><br>  First, I found a cell phone from which she called back, but the phone is not serviced.  Probably, it is only for outgoing.  Then I went to the site, but there was only one number 8800. One number for the whole of Russia !!!  Of course, I called and listened many times about new credit cards, about deposits, a bunch of some other advertising, but for 40 minutes I could not get on a living person.  Yes, and he doubted that they would be able to connect me with K. Ivanova (it was so written in the signature that the copy is correct for one of the documents) <br>  And I had to go to the other end of Moscow to find out the internal phone number of the girl who worked until 15.00 today. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And here in my head there were 2 ideas. <br><br><ul><li>  Do not apply to this bank again. </li><li>  Develop a new smart routing system for 1C and Asterisk </li></ul><br><br><img src="https://habrastorage.org/files/c83/d67/c59/c83d67c594ba452f9616b31c6b520f97.png"><br><br>  We have been engaged in the integration of 1C and telephony for many years, and we had a solution for routing the call to the responsible manager.  But it was awkward.  The manager was chosen in the client‚Äôs card, and in real life, different employees often worked with the client.  Responsible should be assigned automatically and change with the development of relations between the company and the client. <br><br><h3>  Figa main module on 1C </h3><br><br>  On the example of my communication with the bank, we began to develop the system from the event analysis module in 1C: CRM.  In 1C all contacts with the client are registered, bills and financial documents are written out, electronic correspondence and telephone conversations are stored.  Therefore, to begin with, we must select those events that matter to us. <br><br><img src="https://habrastorage.org/files/43d/1cc/771/43d1cc771c8e4de4b52f5cbe127ed770.png"><br><br>  It is clear that each event in CRM has its own weight and expiration date.  If I just billed you and sent it by e-mail, and after an hour you call back, then surely me.  And if I wrote you an invoice a month ago, and today you corresponded with the guys from support, and specialist Vanya called you several times, then your new call is definitely not for me, but for specialist Vanya. <br><br>  Each client has its own 1C, and it seems to me that it is the most difficult to configure the event types, weights and expiration correctly. <br><br><img src="https://habrastorage.org/files/2b9/63c/399/2b963c399bd24cd8861c8e36442d4b0d.png"><br><br>  After setting the list of recorded events, a continuous analysis of the base 1C of the scheduled task begins.  The 1C: Enterprise server copes well with this task. <br><img src="https://habrastorage.org/files/750/0e2/93a/7500e293ae48446ca7a4b3f7ebcf0a4f.png"><br><br>  In order for the 1C server not to do preliminary calculations at the time of the call, in the second table a rating is made up of the staff and phone numbers of our clients.  The rating is constantly recalculated after creating a new significant event. <br><br><img src="https://habrastorage.org/files/836/846/387/836846387ef54c0faac059f356c8e921.png"><br><br>  When an IPMATIKA customer calls from the number +7 (495) 926-26-44, then with great probability they will need <i>Yevgeny Chulkov</i> , well, if there is none, then <i>Maslennikov Dmitry</i> will be able to support the conversation. <br><br>  At this point, I realized that blind forwarding to a responsible person is not the best choice.  Why not suggest that the client specify the right employee for himself, and in terms of call routing, this is a simpler solution.  We do not touch the standard routing scenarios, but use prompts in the form of a <b>personal IVR menu</b> . <br><br>  We have to make a voice greeting from pre-prepared phrases, generate an audio file, play a new IVR menu for the client.  The algorithm of the solution should be approximately like this. <br><br><img src="https://habrastorage.org/files/7f0/a64/b8d/7f0a64b8d28341c4b5d6097fae018b30.png"><br><br>  We chose two TTS solutions as a speech synthesis service.  Conditionally free <br>  <a href="https://tech.yandex.ru/speechkit/cloud/">Speech Kit</a> from Yandex and <br>  <a href="https://voicefabric.ru/">VoiceFabric</a> from the Speech Technology Center. <br>  To get started, you need to get the API key from one of the services and enter it in the form of settings. <br><br><img src="https://habrastorage.org/files/4df/4b7/673/4df4b76736484aef8d921fae80fa48f8.png"><br><br>  I really liked the generation of speech from the company MDGs, but it is paid and is quite expensive for mass generation, so we came up with local cache technology.  When the maximum quality mode is set, the voice menu is generated from the full sentences, and when the maximum economy mode is enabled, we request the generation of individual words. <br><br>  You can set the fixed parts of the voice menu, for example, the beginning and the end of ours looks like this: <br><img src="https://habrastorage.org/files/a48/e4a/47c/a48e4a47c8bd456dab1141e13e309f88.png"><br><br>  When generating, a list of 2-3 suitable employees is inserted between them: <br><br><ul><li>  Chulkova Evgenia, additional 34 </li><li>  Dmitry Maslennikov, extension 02 </li></ul><br><br>  If in 1C there is no information about the relationship with the client, IVR is generated by default. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a9c/248/7a7/a9c2487a71e44022b0f7e28ac67b499d.png" alt="MIKO: Intelligent Call Routing - Default Hello" width="400"></div><br><br>  On the side of 1C, there is quite a bit left - to do filtering by dismissed employees, technical accounts (Robot, Administrator).  In an amicable way, you still need to clean up those who are on vacation, but we have not done it yet. <br><br><img src="https://habrastorage.org/files/7a5/85f/a84/7a585fa84788459087e4eb05a51516a7.png"><br><br>  It would also be good to advance in advance the full name, especially those that obey non-standard rules (White, Black, Twisted ...) <br><br><h3>  The second part we write on AGI in Asterisk </h3><br><br>  As an Asterisk server, we have been using a paid build for a long time. <br>  <a href="http://www.askozia.ru/">Askozia</a> , on the one hand, it is very easy to set up, on the other - according to the possibilities of customization, it is not inferior to many free solutions, and I like it, it is difficult to explain :) <br><br>  When developing the Asterisk module, there is an important condition: ‚ÄúNever <b>interrupt call processing</b> ‚Äù.  Even if 1C stops responding, calls should go.  We need a guaranteed backup route to the sales department. <br><br>  All the logic of work on the Asterisk side will be performed using AGI and AMI technologies.  How to create applications for the integration of 1C and AGI we wrote a few years ago in <a href="http://habrahabr.ru/post/166935/">this post</a> . <br>  The application on the Asterisk side performs the following tasks: <br><br><ul><li>  request from the web service 1C client name information to install CallerID on phones and in history; </li><li>  request from the web service 1C personal voice menu; </li><li>  request from the TTS server for synthesized phrases; </li><li>  gluing together the full voice menu for the client from new and previously cached phrases; </li><li>  playback of the IVR menu to the client and recognition of DTMF signals in response; </li><li>  connection of the client and the employee. </li></ul><br>  Add a PHP application directly in the Web interface and copy the ID of the new application. <br><br><img src="https://habrastorage.org/files/3b8/083/98e/3b808398eb524ea0b9b7f8c00117604f.png"><br><br>  We create the simplest IVR route to which we will direct all customer calls.  We define a backup route in case something breaks in the AGI script.  On our server, I simply indicated the phone number of our sales department (90) and the ID of the newly created AGI script. <br><br><img src="https://habrastorage.org/files/1a0/013/381/1a00133816114751ba026dcf4be7ea09.png"><br><br>  As a result, when you call our company, you will hear something like this: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/_4qptjyu3IE%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgw7e4LVrkQtBjcy5ietQolccqzNQ" frameborder="0" allowfullscreen=""></iframe><br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/Woo29awzFDY%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhixT3C1vBtsjEHQSkYn7-zUkm4vqA" frameborder="0" allowfullscreen=""></iframe><br>  Free Yandex, wave suitable for debugging.  The speech from the Speech Technology Center is much cooler, and we use it on the battle server. <br><br><h3>  Total </h3><br><br>  We implemented the IVR menu generation module 3 months ago.  During this time, the number of customer redirections between employees has sharply decreased. <br><br>  The new IVR menu has a multiple WOW effect.  We specifically added a phrase about CRM to the menu, many are interested in how it works =) <br><br>  The generation rate of a completely new IVR menu does not exceed 1-3 seconds, if the necessary phrases are not yet in the cache, and a fraction of seconds, if the necessary phrases have already been synthesized earlier.  In fact, now we receive new phrases only when a new employee appears in the company.  The rest of the time, the system works autonomously and independently of TTS servers. <br><br>  Thank you very much if you could finish reading to the end.  I am pleased to answer all questions. </div><p>Source: <a href="https://habr.com/ru/post/272655/">https://habr.com/ru/post/272655/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272645/index.html">How Cloud Foundry is Developed</a></li>
<li><a href="../272647/index.html">IBM cloud service translates applications into 9 languages</a></li>
<li><a href="../272649/index.html">Photoshop for coder (programmer)</a></li>
<li><a href="../272651/index.html">MongoDB as a monitoring tool for LOG files</a></li>
<li><a href="../272653/index.html">On the other side of the game: an open course on game design</a></li>
<li><a href="../272657/index.html">Architecture IoT-solutions on a real example</a></li>
<li><a href="../272659/index.html">Next, in search of palindromes 3</a></li>
<li><a href="../272661/index.html">NOT unlimited mailbox, or Tale about the secret limitation of Mail.ru</a></li>
<li><a href="../272667/index.html">Practice: How to set up an HP ProLiant ML10v2 server and prepare it for OS installation</a></li>
<li><a href="../272669/index.html">Tarantool as an application server</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>