<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we taught Mail.Ru how to glue letters into threads</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Threads, or chains of letters, have always been one of the most desirable features in Mail.Ru Mail, provided that the survey ‚ÄúWhat functionality are y...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we taught Mail.Ru how to glue letters into threads</h1><div class="post__text post__text-html js-mediator-article">  Threads, or chains of letters, have always been one of the most desirable features in Mail.Ru Mail, provided that the survey ‚ÄúWhat functionality are you missing?‚Äù Was conducted among an advanced audience (for example, among programmers or habrayusers).  The second most popular feature among geeks is, perhaps, two-factor authentication, but about it in a <a href="http://habrahabr.ru/company/mailru/blog/246607/">separate post</a> . <br><br>  However, all our usability testing showed that for a less advanced audience, threads are a fairly complex feature and not always convenient.  Many were horrified by ‚Äúlosing‚Äù their letters in the Inbox, they could not figure out how to respond to a specific message in the thread, and much more. <br><br>  Nevertheless, by ourselves (Mail.Ru team of the Mail), as people belonging to the first group (geeks, production lovers and programmers), the idea of ‚Äã‚Äãthreads was close and clear.  Therefore, we decided to meet the wishes of the advanced community and implement threads in an optional mode (you can turn them on in the ‚ÄúView‚Äù menu in the upper right corner above the list of letters). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/b88/40a/b38/b8840ab38482477c82e66386c535d514.png"><br><br>  However, it is easy to solve, but not so easy to do.  At the stage of thinking through logic, a lot of nuances were discovered.  Although the threads were already implemented in other postal services, we still had to develop our own algorithm.  Firstly, some other people's decisions seemed to be erroneous, and we decided to correct them, and secondly, the logic of some basic functionality of our mail is different from the work of similar functionality in others, so it‚Äôs impossible to ‚Äúlearn from experience‚Äù as is. <br><br>  In this post we want to talk about the difficulties that awaited us and how we managed to overcome them. <br><a name="habracut"></a><br><h1>  1. How to "glue" threads </h1><br>  <b>1.1 Understanding In-Reply-To</b> <br><br>  Each letter has meta-information (service headers).  The In-Reply-To header indicates the answer to which letter the message you opened (In-Reply-To) is answered, and the References contains, among other things, information about the letter that was the first to correspond.  It is logical that if there are such service headers, then it makes sense to group the letters by these headers.  However, there are two nuances that we had to take into account. <br><br>  First: how to deal with redirected letters?  In the case when the incoming letter is redirected, in fact there is another letter with the service header In-Reply-To.  This header indicates a redirected letter.  At the same time in the subject appears prefix FW or FWD.  That is, in fact, the forward is another answer.  Guided by this logic, Gmail, for example, ‚Äústicks‚Äù redirected letters to the same thread. <br><br>  We interviewed users inside Mail.Ru and outside and found out that, as a rule, they send a letter not in order to connect the person to the correspondence, but to discuss the topic of correspondence with him separately.  So - they want to start a new "conversation", and not stay in the old.  Therefore, we decided that in such cases we will start a new chain. <br><br><img src="https://habrastorage.org/files/d30/874/4f2/d308744f2a7540fea0f32ba40d2dd937.png"><br><br>  Second, sometimes people can reply to a letter by changing its subject manually.  Then the In-Reply-To tag will formally remain in the service header of the letter, but the subject of the letter will change.  Focusing on the results of our research, we realized that if people consciously change the subject of the letter, it means that this is a new chain for them, and decided that in such cases we will also create a separate thread, even though there is an In-Reply-To in the service header . <br><br>  Based on these two nuances, the grouping algorithm should be as follows: <br><ul><li>  we normalize the subject, for example, we throw out all the prefixes ‚ÄúRe‚Äù, but we leave ‚ÄúFWD‚Äù </li><li>  group letters associated with headers and with one normalized topic </li></ul><br>  <b>1.2 We consider grouping for automatic mailings.</b> <br><br>  If there are no headers, it does not mean that there is nothing to group.  There are many letters that are asked in one group: notifications from social networks, promotional letters from online stores, letters from task tracker, finally.  As a rule, in all these cases, the letters have one subject and one sender.  Therefore, we decided to group letters with no headers by the ‚Äúsubject + sender‚Äù criterion in order to cover automatic mailings. <br><br><img src="https://habrastorage.org/files/32e/c41/fd3/32ec41fd3c4c45089f60ae7b675eacc6.png"><br><br>  <b>1.3 Separate the "basket"</b> <br><br>  A separate problem in the implementation of threads creates the folder structure of the Post.  We decided that letters from different folders, including those from the ‚ÄúSent One,‚Äù could be put in the same thread, so that you could see the received letters and the answers to them in one place.  There, in theory, the letters from the ‚ÄúTrash‚Äù folder should have been included.  Initially, we were guided by this logic, but the first beta testers gave us feedback that it was inconvenient and that they did not want to see deleted letters, even if they could be grouped by headings with a letter in the Inbox. <br><br>  <b>1.4 Determine meter readings</b> <br><br>  As we have already said, when grouping letters from one chain, they can be scattered in different folders (the simplest case is Inbox and Sent Mail).  In this regard, a lot of questions arise, for example: <br><ul><li>  If the thread is not read, does it remain unread in all folders? </li><li>  If there are several unread letters in the chain, what should the counter show - the number of unread letters or one unread chain? </li></ul><br>  We have three options.  Let's consider them. <br><br>  The first: the counter works with chains, and the unread chain is marked in all the folders in which it is displayed.  For example, in two folders - "Inbox" and "Sent" - there is one unread letter that has just arrived in the box.  In the list of folders, we will see one in each of these two folders.  But what to show in the general counter at the box?  In theory, there it is necessary to display the amount for all folders, but in our case it is two.  But after all actually one unread chain is in the box! <br><br>  The second option: a thread in a folder is considered unread only if there are unread letters from this thread in the folder.  But suppose there are two unread letters in the thread.  Folder counter displays unit: one thread is not read.  The user opens a thread and reads the top letter, after which he returns to the list of letters.  One letter is read, but the counter still shows the unit: there is another unread letter in the thread, which means that the whole thread is not read.  It turns out that the user performed the action, and the meter readings have not changed. <br><br>  The third option, which we have chosen: in the meters we take into account letters, and not threads.  In this case, the counter of each folder displays the correct data, because the letter can not be in several folders.  The total counter also always displays the correct number.  The interface in this case reacts to the reading of any letter by changing the meter readings. <br><br><img src="https://habrastorage.org/files/699/0ce/ddb/6990ceddb7fd4408b50c32bbadfd04b0.png"><br><br>  We summarize: <br><ul><li>  we glue threads by headers and subject or by sender and subject. </li><li>  Forward letter starts a new thread </li><li>  the thread includes letters from all folders except the "Recycle Bin" </li><li>  in the folder counters we display the number of unread letters, but not threads </li></ul><br><h1>  2. Appearance of the thread and actions with it </h1><br>  <b>2.1 Three levels or two?</b> <br><br>  There are two basic types of display threads on the market: <br><br>  The first is when clicking on a thread in the list of threads, another list opens, this time already letters, where you have to click again to get to read a particular letter.  For convenience, we called it "three-level."  It is used, by the way, in many places - from some versions of Outlook to a large number of mobile email clients. <br><br>  The second one (it‚Äôs also ‚Äútwo-level‚Äù) ‚Äîwhen clicking from the list of threads, the user goes directly to the ‚Äúbodies‚Äù of the letters, i.e.  has the ability to quickly get to the actual content of the correspondence. <br><br>  We decided not to stand in the way of the user to his content and not to force him to make two clicks every time he wants to read the newly received letter.  As you already guessed, the ‚Äútwo-level‚Äù option was chosen.  Although he technically and ideologically foreshadowed many more problems, but about them a little further. <br><br>  <b>2.2 Read and unread letters inside the thread</b> <br><br>  Here we decided not to philosophize slyly - it is obvious that the user is interested first of all to get acquainted with the content of those letters that he has not yet seen.  And consequently, on them and need to focus his attention.  Therefore, inside the thread, we decided to deploy all the unread letters, and leave all the reads folded. <br><br>  If there are no unread letters in the thread, we leave the last one unrolled (why - more on that a little further). <br><br><img src="https://habrastorage.org/files/293/904/c06/293904c068d34a698feaaa45201c2491.png"><br><br>  <b>2.3 Read and unread threads in the thread list</b> <br><br>  The first question that had to be resolved was: should the thread be marked unread in the list of letters (now in the list of threads), if there is at least one unread letter?  Suppose we decide to mark the thread as unread.  But if the letters of the same thread are in different folders (for example, a part is in the Inbox and a part in the Important ones), we have two problems at once.  The first one - by marking the thread read in one folder, we change the count of unread letters in two folders at once.  The second is not clear what to do with the total counter unread letters.  After all, if the user enters the box, sees that there are unread letters in two folders at once, opens the thread in the first folder and reads it, and both counters are reset, he will think that the second unread letter is simply lost. <br><br>  We dismissed this option as unsuccessful and decided to try to do differently: mark the thread unread only in the folder where the user has unread letters.  For example, letters of a thread are dispersed between Inbox and Important, while the only unread letter lies in Important.  That is, if the user is in the "Inbox" (where there are no unread emails), all threads are marked as read. <br><br>  However, another small problem arose here - when a user opens a thread from the Inbox, already inside he sees that there is a unrolled unread letter in him (the same one that lies in the ‚ÄúImportant‚Äù).  It turns out a little illogical. <br><br>  We solved this problem in the following way: letters from other folders in the thread will also be minimized to the status of the header, even if they are not read.  So, getting to the thread, the user sees only the unread letters from this folder are expanded.  Thus, we have no unnecessary information and no ‚Äúrandom‚Äù readings of what should have been reminded of ourselves (it was not for nothing that the sorting into a separate folder was set up). <br><br>  However, in fairness, I must say that the situation when letters from one thread are in different folders (not counting the Sent, of course) is quite rare.  And this is good! <br><br>  <b>2.4 Removing threads</b> <br><br>  At the same time, we had to find an answer to one more question.  Imagine a situation: we are in the Inbox folder and open a thread in which one letter is from the Inbox folder, and the second is from the Sent folder.  If you click "Delete thread", what happens to the letter from the "Sent"?  Interviewing users, we found out: they expect the letter to remain in the Sent Items folder.  Therefore, we have all actions with a thread - removal, movement, etc.  - apply only to letters from the folder that the user has opened. <br><br>  <b>2.5 The position of the new letters in the thread</b> <br><br>  Another important question that needed to be solved: at the top or bottom of the chain to show the latest letters?  We decided to keep the principle on which classic e-mail works, that is, the most recent letters show on top of the thread (unlike, for example, Gmail, where new letters are displayed at the bottom of the thread). <br><br>  In addition, our research has shown that many users start reading threads from the last letter in order to understand whether it is worth reading the rest of the letters in the thread.  This was another argument in favor of displaying new letters from above. <br><br>  <b>2.6 Functionality of the toolbar</b> <br><br>  It was also necessary to decide how the toolbar with the "Answer" button relating to the whole thread would work.  We chose between two options: hang up on it the answer and forward it in relation to the last letter in the thread, or to the letter that the user currently has on the screen.  As a result, we stopped at the first option, because the option with the letter currently on the screen introduced too much uncertainty, for example, what to do if there are two or even three short letters on the screen at once?  Or how to intuitively prompt the user to which letter he is now responding? <br><br>  By the way, this is why the last letter in a thread is always expanded, regardless of whether it is read or not.  In case the user has a desire to respond to any other email, we have made a small additional toolbar inside the thread that allows it. <br><br><img src="https://habrastorage.org/files/851/612/6f4/8516126f41fa4c5f8287b201e631129b.png"><br><br>  We summarize: <br><ul><li>  the most current letter from the current folder is always expanded </li><li>  letters from other folders are minimized regardless of status </li><li>  Letters from the current folder are collapsed only if they are read. </li><li>  when deleting a thread, only letters from the current folder are deleted </li><li>  the most recent letters are displayed on top </li><li>  buttons on the top Tublar in the thread work with the top letter </li></ul><br>  *** <br><br>  Realization of threads in the mail is a rather difficult task, and we spent a lot of time and effort on solving it.  Now threads can be enabled in all Mail.Ru Mailboxes. <br><br>  I would be very grateful if you tell us in the comments how convenient it is for you to use the updated interface and whether the solutions that we have chosen seem logical to you. </div><p>Source: <a href="https://habr.com/ru/post/247861/">https://habr.com/ru/post/247861/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../247849/index.html">Meteor. How to sip this your iron: router for CRUD?</a></li>
<li><a href="../247853/index.html">Experience and practical tips to launch iOS applications</a></li>
<li><a href="../247855/index.html">Torment with LED cube 4x4x4 (Arduino + 74HC595)</a></li>
<li><a href="../247857/index.html">All ways to iterate an array in javascript</a></li>
<li><a href="../247859/index.html">We invite you to test the updated design of Alfa Mobile</a></li>
<li><a href="../247865/index.html">Work with a client or "why did you not do what we asked for?"</a></li>
<li><a href="../247867/index.html">35 new free courses virtual academy Microsoft Virtual Academy, January 2015</a></li>
<li><a href="../247871/index.html">Mobile interface for one hand</a></li>
<li><a href="../247873/index.html">Curve25519, EdDSA, and Poly1305: Three cryptoprimitives neglected</a></li>
<li><a href="../247877/index.html">How I got to the Top AppStore with a simple application of exchange rates</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>