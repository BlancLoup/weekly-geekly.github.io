<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Steroids for Munin</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Munin is a very good thing to monitor servers, especially one or two. However, if the number of servers grows, it works worse and worse. Under the cut...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Steroids for Munin</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://munin-monitoring.org/">Munin is a</a> very good thing to monitor servers, especially one or two.  However, if the number of servers grows, it works worse and worse.  Under the cut, the story of how I clocked it up to monitor more than 1000 virtual locks (275K rrd files in the system). <br><a name="habracut"></a><br><h5>  Why munin </h5><br>  Munin is beautiful: <br>  - not demanding on resources (while there are few servers); <br>  - easy setup (convenient defaults, simple text config); <br>  - just plugins are written (and there are a bunch of ready-made plugins). <br><br>  Munin is terrible: <br>  - convenient defaults are not changed; <br>  - integration with Nagios is useless; <br>  - inconvenient groupings of graphs; <br>  - "does not like" long-running plug-ins, you need to make crutches; <br>  - The code inside also does not shine with beauty. <br><br>  Based on rrd, it adds both pros and cons. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Munin's plug-in model turned out to be convenient, the developer can add graphics to the role without waiting for someone to start something in the central database.  It still will to us goes around the size of the config, but it‚Äôs convenient the same. <br>  The main thing, Munin was already.  Switching to another system means reworking existing software and retraining people. <br><br><h5>  Problems </h5><br>  - began to step on his tail (does not have time to complete in 5 minutes); <br>  - loads disk very hard; <br>  - inconvenient to edit configs (always forget to add a new server or remove the old one); <br>  - aggregated graphs are difficult to write; <br>  - there was no integration with Nagios. <br><br>  In addition, aggregated graphs are lying.  Because if you add up the number of requests from 10 servers, and then turn off 5, then the historical data will decrease by a factor of 2!  Naturally, since the total graph is calculated every time and is not saved, the formula has changed - the previous graph has changed. <br><br><h5>  And their decision </h5><br><h6>  Overclock </h6><br>  It is necessary to make the generation of graphs as CGI / FastCGI, it accelerates but not much. <br><br>  Radically overclock Munin can only be a costly way, put all the rrd in memory (tmpfs).  Nothing else, neither RAID nor SSD helps, alas.  275K rrd occupy 14GB, which is not so much, a server with 32GB RAM is not uncommon (a few more GB will consume the processes of Munin itself).  But the disk may be the most common. <br><br>  Naturally, every couple of hours you need to drop to disk and pack existing RRDs just in case.  Packed archive perfectly written to SATA disk. <br><br>  Munin himself does not clean rrd, so unused rrd must be cleaned. <br>  / usr / bin / find / mnt / ramdrive / -type f -mtime +5 -delete <br><br><div class="spoiler">  <b class="spoiler_title">A small digression about the inevitability of memory use.</b> <div class="spoiler_text">  The problem of all such systems is that the data comes "cross" (one measurement from each metric), and processed "longitudinally" (all measurements for one metric) and shuffling this stream is very difficult.  You can write as rrd immediately "longitudinally" and wait for the record, you can write to the database "transversely" (just add records one by one to a large table) and then slowly read them. <br>  In any case, without a large cache / index in memory can not do. <br></div></div><br><br>  Since we have a lot of memory, we run the update without limiting the processes, it helps with slow plugins.  Only I cocked the timer to kill munin-update, which work longer than 3 minutes. <br><br>  The next begins to blunt drawing graphics.  Profiling showed that the more servers there are, the bigger the config is and it is parsed each time munin-graph-cgi is started.  My config has grown to 64 megabytes and parsing it took up to 7 seconds (100% CPU load).  The solution is obvious, do not parse it again, but in order to substitute this crutch, you must edit the Munin code. <br><br>  munin-update will read and write the config as usual, plus save the config object using the Storable module.  munin-graph will read the storable file if it has one. <br>  This accelerates the drawing of graphs, but eats memory, 64 megabytes of the config are converted into 375MB of virtual memory per process. <br><br>  Oddly enough, this is not a big problem for munin-update, since it first expands the config in memory and then forks.  As a result, in the top 1000 processes with RSS in 250MB and only 21GB of RAM used (14 of them are rrd!) <br>  There is a big problem with munin-graph, since there each process honestly eats its 400MB of memory, but so far there is enough memory. <br><br>  The next problem was with the launch of munin-html, he did not have time to work out.  Cured by running asynchronously, and several forks in the code.  HTML is drawn every 10, not 5 minutes, but this is not necessary especially if you add a new server. <br><br><h6>  And make it more convenient </h6><br>  It is inconvenient to edit text configs with your hands, but it is very convenient to generate a script.  Fortunately, by that time we already had a server database with partitioning into systems (virtual machines) and data centers (physical hosts).  A simple script rewrites the Munin config based on this database and groups the servers by systems (Domain in Munin terms).  New servers appear automatically, old ones also disappear automatically.  Beauty! <br><br>  The next problem is drawing aggregated graphs. <br>  Plan such a script do a selection of the necessary rrd, take the last value of them and, for example, add. <br><br><div class="spoiler">  <b class="spoiler_title">It turns out this munin plugin for drawing the amount of requests for servers</b> <div class="spoiler_text"><pre><code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl -w use strict; use warnings; if($ARGV[0] &amp;&amp; $ARGV[0] eq 'config') { print &lt;&lt;&lt;'EOS'; host_name Aggregated graph_title Total requests graph_args --base 1000 -l 0 graph_vlabel requests graph_category Nginx graph_info Total count of requests total.label total requests total.info total requests EOS exit(0); } my @rrd_files = `/bin/ls /mnt/ramdrive/munin/oMobile/*-nginx_log_access-total-d.rrd`; my $sum = 0; foreach my $filename (@rrd_files) { next unless(-f $filename); my $lastline = `/usr/bin/rrdtool fetch $filename AVERAGE -s -15M -e now | fgrep -v 'nan' | tail -n 1`; if($lastline =~ m/^\d+: ([-+.0-9e]+)\s*$/) { $sum+=$1; } } print "total.value $sum\n"; exit(0);</span></span></code> </pre> <br><br>  Never do that!  This is just for demonstration, it makes a cloud of unnecessary exec, in production you must use RRD. <br></div></div><br><br>  Most often, either a sum is made, or a grouping of several lines on a single chart (it is very clearly seen whether someone is out of the crowd).  But you can also calculate something more complicated.  For example, given the average request processing time on each server and the number of requests to the server, then you can calculate the average request time for the entire system. <br><br>  Pay attention to host_name, so you can create virtual hosts and domains in Munin and group interesting graphics in them. <br><br>  If you read not only the last value from the RRD, then you can catch sharp ups and downs of graphs.  As a rule, sharp, percent by 20, change in the number of requests, response time, LA, etc.  not good and needs attention.  We take the data for the last hour, day, week and compare.  If the discrepancy is large, then you can send an alert (passive check in Nagios, for example). <br><br><h5>  Total </h5><br>  - Any system based on rrd can be overclocked by putting rrd files into memory (tmpfs); <br>  - Munin convenient for small projects can be stretched to a noticeable number of servers (I have&gt; 1500 munin-node); <br>  - A small script and you can draw quite complex graphics; <br>  - A small script and you can analyze trends and report alerts to them. </div><p>Source: <a href="https://habr.com/ru/post/146032/">https://habr.com/ru/post/146032/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../146026/index.html">Kenya abolishes software import tax in hopes of reducing piracy</a></li>
<li><a href="../146027/index.html">Sun boom in Japan and myths about alternative energy</a></li>
<li><a href="../146028/index.html">Droider Show # 45. Skype invasion!</a></li>
<li><a href="../146030/index.html">iOS6 SDK - UIKit changes</a></li>
<li><a href="../146031/index.html">Dell will sell Ubuntu computers in India</a></li>
<li><a href="../146033/index.html">Life with a programmer</a></li>
<li><a href="../146034/index.html">Automating work with Xcode projects using Ruby</a></li>
<li><a href="../146035/index.html">Tomorrow's computer of happiness</a></li>
<li><a href="../146037/index.html">Why I do not believe in 3D maps</a></li>
<li><a href="../146038/index.html">How I became an indie gamedev-developer or features of the national development on the knee</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>