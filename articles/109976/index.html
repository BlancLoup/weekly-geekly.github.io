<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OpenWRT + Asus WL 520GU + Iptables. We separate LAN, DMZ and Internet</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 
 Just now there was a need to hide some service in the DMZ. This service runs in W2K3, and I didn‚Äôt want the OS Windows machine to look into t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>OpenWRT + Asus WL 520GU + Iptables. We separate LAN, DMZ and Internet</h1><div class="post__text post__text-html js-mediator-article">  <b>Hello!</b> <br>  Just now there was a need to hide some service in the DMZ.  This service runs in W2K3, and I didn‚Äôt want the OS Windows machine to look into the Internet and the local network than anything unprotected (‚ÄúWindows‚Äù firewalls just go through the forest). <br>  Remembering the <a href="http://habrahabr.ru/blogs/sysadm/99925/">successful experience</a> with Asus WL 520GU and DD-WRT, I decided to take the beaten track, but chose OpenWRT as the firmware for the router. <br>  Scheme of the ligament can be seen in the figure. <br><img src="https://habrastorage.org/storage/6a7e3591/073e2274/8bde318e/6e156a3b.jpg"><br>  So, from the words get down to business. <br><a name="habracut"></a><br>  <i>Some misunderstanding of the term DMZ was noticed in the comments.</i> <i><br></i>  <i>In this connection, I will quote from <a href="http://ru.wikipedia.org/">Wikipedia</a> (for opponents of such quoting, I can see that this material is almost identical to what is written in the book <a href="http://www.williamspublishing.com/Books/978-5-8459-1309-8.html">Complete Reference Book on Cisco</a> )</i> <br><br>  <i><a href="http://ru.wikipedia.org/wiki/DMZ_(%25D0%25BA%25D0%25BE%25D0%25BC%25D0%25BF%25D1%258C%25D1%258E%25D1%2582%25D0%25B5%25D1%2580%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2581%25D0%25B5%25D1%2582%25D0%25B8)">DMZ (Demilitarized Zone, DMZ)</a> is an information perimeter protection technology in which servers responding to requests from an external network are located in a specific network segment (which is called a DMZ) and are restricted in accessing the main network segments using a firewall (firewall ), in order to minimize the damage, when hacking one of the publicly available services located in the DMZ.</i> <br><br><h4>  We are flashing the router. </h4><br>  For the model I have chosen, the <a href="">backfire.brcm47xx</a> firmware is <a href="">required.</a> <br>  <b>1. Perform a hardware reset, the so-called 30/30/30.</b> <br>  When the power of the router is on, press the reset button, hold for 30 seconds, without releasing the button, turn off the power and hold for another 30 seconds, without releasing the button, turn on the power and hold the reset button again for 30 seconds. <br>  Hint: the default ip of the router is 192.168.1.1.  If you ping it before a hardware reset of 30/30/30, then ttl will be equal to 64, after resetting ttl becomes equal to 100. <br>  Now send the firmware to the router using the following command <br> <code>atftp --trace --option "timeout 1" --option "mode octet" --put --local-file openwrt-brcm47xx-squashfs.trx 192.168.1.1</code> <br>  Upon completion of the message melting, wait for 5 minutes and turn off / turn on the power router. <br>  The next step is to set the root password and disable unnecessary services, for this we go to the web interface of the router <br>  <a href="http://192.168.1.1/">192.168.1.1</a> <br>  I disabled luci_dhcp_migrate and dnsmasq (I have DHCP and DNS on the network)) <br><img src="https://habrastorage.org/storage/07459aa7/470ed51b/b921f78b/ffee23e9.png"><br><img src="https://habrastorage.org/storage/cacc5852/55c2051d/031b4534/6c48be80.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  On this with the web interface we‚Äôll finish, further configuration will proceed from the console. </h4><br>  Asus WL 520GU has 5 ports, a WAN port and 4 LAN ports.  WAN will look at the provider, LAN1-3 to the local network, and LAN4 I will allocate to a separate VLAN and send it to the DMZ. <br><br><h5>  Connect to the router </h5><br> <code>#ssh root@192.168.0.30 <br> root@192.168.0.30's password: <br> <br> BusyBox v1.15.3 (2010-11-12 00:01:06 PST) built-in shell (ash) <br> Enter 'help' for a list of built-in commands. <br> <br> _______ ________ __ <br> | |.-----.-----.-----.| | | |.----.| |_ <br> | - || _ | -__| || | | || _|| _| <br> |_______|| __|_____|__|__||________||__| |____| <br> |__| WIRELESSFREEDOM <br> Backfire (10.03.1-rc4, r24045) -------------------- <br> * 1/3 shot Kahlua In a shot glass, layer Kahlua <br> * 1/3 shot Bailey's on the bottom, then Bailey's, <br> * 1/3 shot Vodka then Vodka. <br> --------------------------------------------------- <br> root@OpenWrt:~#</code> <br> <br><h5>  We need to change a few configuration files. </h5><br>  <b>1. / etc / config / network, in this file you can specify interface settings.</b> <br> <code>root@OpenWrt:~# cat /etc/config/network <br> #### VLAN configuration <br> config switch eth0 <br> option enable 1 <br> <br> config switch_vlan eth0_0 <br> option device "eth0" <br> option vlan 0 <br> option ports "1 2 3 5*" <i>#default vlan,   LAN1-3,    <br> # -    5*,     , <br> #       <br> #http://wiki.openwrt.org/doc/uci/network/switch</i> <br> <br> config switch_vlan eth0_1 <br> option device "eth0" <br> option vlan 1 <br> option ports "0 5" <i># WAN </i> <br> <br> config switch_vlan eth0_2 <br> option device "eth0" <br> option vlan 2 <br> option ports "4 5" <i>#  vlan2, DMZ</i> <br> <br> #### Loopback configuration <br> config interface loopback <br> option ifname "lo" <br> option proto static <br> option ipaddr 127.0.0.1 <br> option netmask 255.0.0.0 <br> <br> #### LAN configuration <br> config interface lan <br> option type bridge <br> option ifname "eth0.0" <br> option proto static <br> option ipaddr 192.168.0.30 <br> option netmask 255.255.255.0 <br> <br> #### DMZ configuration <br> config interface dmz <br> option ifname "eth0.2" <br> option proto static <br> option ipaddr 192.168.100.1 <br> option netmask 255.255.255.0 <br> <br> #### WAN configuration <br> config interface wan <br> option ifname "eth0.1" <br> option proto static <br> option ipaddr 1.2.3.4 <br> option netmask 255.255.255.0 <br> option gateway 1.2.3.1</code> <br> <br>  <b>2. Let's comment out all the lines in / etc / config / firewall except</b> <br> <code>config include <br> option path /etc/firewall.user</code> <br>  <b>3. Configuring Iptables, for this we will add to the /etc/firewall.user file</b> <br> <code>#!/bin/sh <br> <br> ext_if="eth0.1" <br> ext_ip="1.2.3.4" <br> <br> int_if="br-lan" <br> int_ip="192.168.0.30" <br> LAN="192.168.0.0/24" <br> <br> dmz_if="eth0.2" <br> dmz_ip="192.168.100.1" <br> dmz_server="192.168.100.2" <br> <br> lo_if="lo" <br> lo_ip="127.0.0.1" <br> <br> IPTABLES="/usr/sbin/iptables" <br> <br> $IPTABLES -P INPUT DROP <br> $IPTABLES -P OUTPUT DROP <br> $IPTABLES -P FORWARD DROP <br> <br> $IPTABLES -N bad_tcp_packets <br> $IPTABLES -N icmp_packets <br> <br> #chain icmp_packets (  echo reply[request) <br> $IPTABLES -A icmp_packets -p icmp -s 0/0 --icmp-type 8 -j ACCEPT <br> $IPTABLES -A icmp_packets -p icmp -s 0/0 --icmp-type 0 -j ACCEPT <br> <br> #chain bad_tcp_packets (     iptables      #) <br> $IPTABLES -A bad_tcp_packets -p tcp --tcp-flags SYN,ACK SYN,ACK -m state --state NEW -j REJECT --reject-with tcp-reset <br> $IPTABLES -A bad_tcp_packets -p tcp ! --syn -m state --state NEW -j DROP <br> <br> #chain PREROUTING ( destination address      IP) <br> $IPTABLES -t nat -A PREROUTING -p tcp -d $ext_ip -m multiport --dport 8001,31187,20113,20118 -j \ <br> DNAT --to-destination $dmz_server <br> $IPTABLES -t nat -A PREROUTING -p tcp -d $ext_ip -m multiport --dport 80 -j DNAT \ <br> --to-destination $dmz_server:8001 <br> $IPTABLES -t nat -A PREROUTING -p udp -d $ext_ip -m multiport --dport 20113,20118 -j \ <br> DNAT --to-destination $dmz_server <br> $IPTABLES -t nat -A PREROUTING -p icmp -d $ext_ip -j DNAT --to-destination $dmz_server <br> <br> #FORWARD <br> $IPTABLES -A FORWARD -p tcp -j bad_tcp_packets <br> $IPTABLES -A FORWARD -p tcp -i $ext_if -o $dmz_if -s 0/0 -d $dmz_server -m multiport --dport 80,8001,31187,20113,20118 -j \ ACCEPT <br> $IPTABLES -A FORWARD -p udp -i $ext_if -o $dmz_if -s 0/0 -d $dmz_server -m multiport --dport 20113,20118 -j ACCEPT <br> $IPTABLES -A FORWARD -p tcp -i $int_if -o $dmz_if -s $LAN -d $dmz_server -m multiport --dport 31187,3389 -j ACCEPT <br> $IPTABLES -A FORWARD -p icmp -i $int_if -o $dmz_if -s $LAN -d $dmz_server -j icmp_packets <br> $IPTABLES -A FORWARD -p icmp -i $ext_if -o $dmz_if -s 0/0 -d $dmz_server -j icmp_packets <br> $IPTABLES -A FORWARD -p ALL -i $dmz_if -o $int_if -m state --state ESTABLISHED,RELATED -j ACCEPT <br> $IPTABLES -A FORWARD -p ALL -i $dmz_if -o $ext_if -m state --state ESTABLISHED,RELATED -j ACCEPT <br> $IPTABLES -A FORWARD -p icmp -i $dmz_if -o $ext_if -j icmp_packets <br> <br> #INPUT <br> $IPTABLES -A INPUT -p tcp -j bad_tcp_packets <br> $IPTABLES -A INPUT -p icmp -j icmp_packets <br> $IPTABLES -A INPUT -p tcp -i $int_if -s $LAN -m multiport --dport 22,80 -j ACCEPT <br> $IPTABLES -A INPUT -p ALL -i $dmz_if -s $dmz_server -j ACCEPT <br> <br> #OUTPUT <br> $IPTABLES -A OUTPUT -p tcp -j bad_tcp_packets <br> $IPTABLES -A OUTPUT -p icmp -o $ext_if -d 0/0 -j icmp_packets <br> $IPTABLES -A OUTPUT -p ALL -s $lo_ip -j ACCEPT <br> $IPTABLES -A OUTPUT -p ALL -s $int_ip -d $LAN -j ACCEPT <br> $IPTABLES -A OUTPUT -p icmp -o $dmz_if -d $dmz_server -j icmp_packets <br> <br> #POSTROUTING <br> $IPTABLES -t nat -A POSTROUTING -o $ext_if -j SNAT --to-source $ext_ip <br></code> <br>  <b>Reboot the router and check the performance settings.</b> <br> <code>root@OpenWrt:~# reboot</code> <br> <br>  For this finish, the tasks are completed, the traffic runs as I need. <br>  In conclusion, it is worth noting that this solution is very budget and can hardly be considered with large volumes of traffic. <br>  When testing with iperf, the following results were obtained: <br>  iperf server is running in dmz, client in LAN = ~ 36Mb / s <br>  iperf server is running in dmz, client on the Internet = ~ 26Mb / s <br>  For me this is quite enough, the provider gives us 4Mb / s, and the traffic from the local network in the DMZ is not very large. <br><br>  Thank you for your attention =) </div><p>Source: <a href="https://habr.com/ru/post/109976/">https://habr.com/ru/post/109976/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../109970/index.html">The story of one repository</a></li>
<li><a href="../109971/index.html">Java 7 for Mac OS X: The Future Behind OpenJDK</a></li>
<li><a href="../109972/index.html">‚ÄúThe Internet is an effective and economical channel for attracting customers‚Äù - a blow to the very liver</a></li>
<li><a href="../109974/index.html">Analysis of bot penetration through an exploit in older versions of phpmyadmin and recommendations for php hosting security settings</a></li>
<li><a href="../109975/index.html">HTML paragraphs in the texts of topics on the desktop and in the editor</a></li>
<li><a href="../109978/index.html">Windows Phone 7 Rocks!</a></li>
<li><a href="../109979/index.html">Evernote update for Android - even more features.</a></li>
<li><a href="../109981/index.html">Facebook Friendship</a></li>
<li><a href="../109982/index.html">Statistics on your posts in social. Vkontakte network</a></li>
<li><a href="../109983/index.html">Do I need a rubric on Habr√© where I could write wishes for new articles?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>