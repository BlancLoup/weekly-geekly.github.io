<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We understand in MAVLink. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For the exchange of data, many modern drones, collected by enthusiasts, commercial or even industrial, use the MAVLink protocol. I would like to share...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We understand in MAVLink. Part 1</h1><div class="post__text post__text-html js-mediator-article">  For the exchange of data, many modern drones, collected by enthusiasts, commercial or even industrial, use the <a href="http://qgroundcontrol.org/mavlink/start">MAVLink</a> protocol.  I would like to share my experience with this protocol in this, and maybe in subsequent articles. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3a6/546/469/3a6546469555d30cfcdaf4c30929d146.png" alt="image"><br><a name="habracut"></a><br>  MAVLink or Micro Air Vehicle Link is a protocol for information interaction with drones or small unmanned vehicles (flying, floating, crawling, etc.), hereinafter referred to as MAV (Micro Air Vehicle).  MAVLink is distributed under the LGPL license as a module for python (there is a convenient wrapper for <a href="http://dronekit.io/">DroneKit</a> ) and a library generator for various languages, including the header-only C / C ++ library.  There are also repositories of already generated libraries for MAVLink <a href="https://github.com/mavlink/c_library_v1">version v1</a> (we will use this one) and <a href="https://github.com/mavlink/c_library_v2">version v2</a> . <br><br>  The protocol describes the information interaction between systems such as MAV and GCS (Ground control station) - a ground control station, as well as their constituent parts - components.  The basic essence of MAVLink is a package that has the following format: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/6e1/d14/19c/6e1d1419c9209e3ad47a4d5281eb5b4d.png" alt="image"><br><br>  The first byte of the packet ( <b>STX</b> ) is the character of the beginning of the message: 0xFD for version v2.0, 0xFE for version v1.0, 0x55 for version v0.9.  <b>LEN</b> - the length of the payload (message).  <b>SEQ</b> - contains a package counter (0-255), which will help us identify the loss of the message.  <b>SYS</b> (System ID) is the sending system identifier, and <b>COMP</b> (Component ID) is the sending component identifier.  <b>MSG</b> (Message ID) - type of message, it depends on what data will lie in the payload package.  <b>PAYLOAD</b> - packet payload, message size from 0 to 255 bytes.  The last two bytes of the packet - <b>CKA</b> and <b>CKB</b> , the lower and upper byte, respectively, contain the checksum of the packet. <br><br>  The MAVLink library allows you to encode and decode packets according to the protocol, but it does not regulate what hardware and software data will be sent - it can be TCP / UDP messages, exchange via a serial port, and anything that provides two-way exchange.  The library processes the input data byte-by-byte, adding it to the buffer and assembles the packet from it itself.  Each system or component can simultaneously exchange data from different sources, then a special identifier called a <i>channel</i> is assigned to each source.  MAVLink contains a buffer for each channel. <br><br><h2>  We get heartbeat from board </h2><br>  Let's move from theory to practice and try to write an OOP wrapper over MAVLink.  Below, I will provide code examples in C ++ using Qt.  I chose this tool, firstly, because in the future I plan to visualize some of the MAVLink parameters using Qt Quick and Qt Location, and secondly, I <a href="http://qgroundcontrol.com/">spotted</a> many solutions in the <a href="http://qgroundcontrol.com/">qgroundcontrol</a> project, also written in Qt. <br><br>  To begin with, we introduce an abstraction over the communication channel, let it be the AbstractLink class, in its interface we define the functionality that allows us to receive and send data in the form of QByteArray.  The heirs of this class, UdpLink and SerialLink, will provide us with data transmission over the network and via the serial port. <br><br><div class="spoiler">  <b class="spoiler_title">AbstractLink class interface</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractLink</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> QObject { Q_OBJECT <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">explicit</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AbstractLink</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(QObject* parent = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">nullptr</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> slots: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">up</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">down</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QByteArray&amp; data)</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; signals: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">upChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isUp)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dataReceived</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QByteArray&amp; data)</span></span></span></span>; };</code> </pre> <br></div></div><br>  We work directly with the MAVLink protocol in the MavLinkCommunicator class.  His responsibilities will include receiving data via communication channels and decoding them into mavlink_message_t packets, as well as sending messages via communication channels.  Since, for each communication channel, MAVLink contains its buffer, we will introduce a dictionary of the pointer to the communication channel to the channel identifier. <br><br><div class="spoiler">  <b class="spoiler_title">MavLinkCommunicator class interface</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MavLinkCommunicator</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> QObject { Q_OBJECT <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: MavLinkCommunicator(QObject* parent = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> slots: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addLink</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractLink* link, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> channel)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removeLink</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractLink* link)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">mavlink_message_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">&amp; message, AbstractLink* link)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendMessageOnLastReceivedLink</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">mavlink_message_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">&amp; message)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendMessageOnAllLinks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">mavlink_message_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">&amp; message)</span></span></span></span>; signals: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">messageReceived</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">mavlink_message_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">&amp; message)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> slots: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDataReceived</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QByteArray&amp; data)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: QMap&lt;AbstractLink*, <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>&gt; m_linkChannels; AbstractLink* m_lastReceivedLink; };</code> </pre><br></div></div><br>  Consider how to build the package from the data stream.  As mentioned above, MAVLink reads the incoming data stream byte-by-by; the mavlink_parse_char function is used for this, which returns the message data or NULL if the message cannot be received, storing the received character in the internal buffer.  MAVLink contains a buffer for each channel.  This approach allows transferring data from the serial port directly to the parsing function of the MAVLink package, depriving the user of the library of the pleasure of manually collecting messages from the stream. <br><br><div class="spoiler">  <b class="spoiler_title">Build method of the MavLinkCommunicator class package</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> MavLinkCommunicator::onDataReceived(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QByteArray&amp; data) { <span class="hljs-keyword"><span class="hljs-keyword">mavlink_message_t</span></span> message; <span class="hljs-keyword"><span class="hljs-keyword">mavlink_status_t</span></span> status; <span class="hljs-comment"><span class="hljs-comment">// onDataReceived  ,       AbstractLink m_lastReceivedLink = qobject_cast&lt;AbstractLink*&gt;(this-&gt;sender()); if (!m_lastReceivedLink) return; //      uint8_t channel = m_linkChannels.value(m_lastReceivedLink); for (int pos = 0; pos &lt; data.length(); ++pos) { if (!mavlink_parse_char(channel, (uint8_t)data[pos], &amp;message, &amp;status)) continue; emit messageReceived(message); //        } //     }</span></span></code> </pre><br></div></div><br>  For obtaining the useful data of one only assembly of a packet is not enough.  It is necessary to receive a <i>message</i> from the packet, extract the payload according to msgid.  MAVLink has a set of built-in types for each msgid (message type) and functions for receiving these messages from the package.  We introduce another abstract type - AbstractHandler; in the interface of this class, we define a purely virtual <i>processMessage</i> slot for processing the message received from MavLinkCommunicator.  The heirs of the AbstractHandler class will decide whether they can process a message and, if possible, process it.  For example, we want to process <a href="http://mavlink.org/messages/common">heartbeat</a> messages.  This is the most basic package in which the system says that it exists and what it is.  It is worth noting that heartbeat is the only type of package that MAVLink requires to use.  We introduce a message handler of this type - HeartbeatHandler. <br><br><div class="spoiler">  <b class="spoiler_title">Implementing the processMessage method of the HeartbeatHandler class</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> HeartbeatHandler::processMessage(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mavlink_message_t</span></span>&amp; message) { <span class="hljs-comment"><span class="hljs-comment">// ,     if (message.msgid != MAVLINK_MSG_ID_HEARTBEAT) return; mavlink_heartbeat_t heartbeat; //   heartbeat mavlink_msg_heartbeat_decode(&amp;message, &amp;heartbeat); //      //     ,        qDebug() &lt;&lt; "Heartbeat received, system type:" &lt;&lt; heartbeat.type; }</span></span></code> </pre><br></div></div><br>  Now, if we set up the classes and establish the correct connection, we can receive heartbeat messages from the flight controller.  I will use a pair of radio modems and a Raspberry Pi with the NAVIO2 shield on which the APM autopilot is running.  Theoretically, this should work with any autopilot that supports the current version of MAVLink, but if you have nothing at hand, there will be an example with the autopilot simulator a little further. <br><br><div class="spoiler">  <b class="spoiler_title">main function code</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* argv[])</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-function"><span class="hljs-function">QCoreApplication </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">app</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(argc, argv)</span></span></span></span>; domain::MavLinkCommunicator communicator; domain::HeartbeatHandler heartbeatHandler; <span class="hljs-comment"><span class="hljs-comment">//    heartbeat QObject::connect(&amp;communicator, &amp;domain::MavLinkCommunicator::messageReceived, &amp;heartbeatHandler, &amp;domain::HeartbeatHandler::processMessage); domain::SerialLink link("/dev/ttyUSB0", 57600); //       communicator.addLink(&amp;link, MAVLINK_COMM_0); link.up(); return app.exec(); }</span></span></code> </pre><br></div></div><br>  Run the program, turn on the autopilot and after a few seconds should run: <br><br><pre> <code class="bash hljs">Heartbeat received, system <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: 1 System status: 2 Heartbeat received, system <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: 1 System status: 2 Heartbeat received, system <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: 1 System status: 2 Heartbeat received, system <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: 1 System status: 5 Heartbeat received, system <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: 1 System status: 5</code> </pre> <br><h2>  Ship your heartbeat </h2><br>  As planned, each system must send a heartbeat, and therefore ours too.  Let's start with the implementation of the function of sending the package class MavLinkCommunicator.  The mavlink_msg_to_send_buffer function writes the message packet to the send buffer.  It is assumed that at this stage all the packet fields, including the length and the checksum, are filled in correctly. <br><br><div class="spoiler">  <b class="spoiler_title">MavLinkCommunicator class package sending method</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> MavLinkCommunicator::sendMessage(<span class="hljs-keyword"><span class="hljs-keyword">mavlink_message_t</span></span>&amp; message, AbstractLink* link) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!link || !link-&gt;isUp()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> buffer[MAVLINK_MAX_PACKET_LEN]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lenght = mavlink_msg_to_send_buffer(buffer, &amp;message); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!lenght) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; link-&gt;sendData(QByteArray((<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*)buffer, lenght)); }</code> </pre><br></div></div><br>  Now that we have the function to send a packet, we need to form a message and write it into the packet.  Let us assign this task to the already existing HeartbeatHandler class, and add the message sending signal to the AbstractHandler interface.  The mavlink_msg_heartbeat_encode function writes the heartbeat message to the package, there are similar functions for all embedded messages.  I‚Äôll draw the reader‚Äôs attention that additional functions are also provided in mavlink, for example, mavlink_msg_heartbeat_pack allows you to write a heartbeat message to mavlink_message_t without explicitly creating an object of type mavlink_heartbeat_t, and mavlink_msg_heartbeat_send immediately sends data if there is a certain sending function.  More information on how to work with these features can be found <a href="http://qgroundcontrol.org/dev/mavlink_onboard_integration_tutorial">here</a> .  The additional ending _chan (for example mavlink_msg_heartbeat_pack_chan) indicates which channel the message will be sent to. <br><br><div class="spoiler">  <b class="spoiler_title">The event code of the timerEvent class HeartbeatHandler</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> HeartbeatHandler::timerEvent(QTimerEvent* event) { Q_UNUSED(event) <span class="hljs-keyword"><span class="hljs-keyword">mavlink_message_t</span></span> message; <span class="hljs-keyword"><span class="hljs-keyword">mavlink_heartbeat_t</span></span> heartbeat; heartbeat.type = m_type; mavlink_msg_heartbeat_encode(m_systemId, m_componentId, &amp;message, &amp;heartbeat); <span class="hljs-function"><span class="hljs-function">emit </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span></span>; }</code> </pre><br></div></div><br>  We will send heartbeat on a timer with a frequency of 1 Hz.  If you put a debug output in the method of sending data to the communication channel data.toHex (), we will see our messages, according to the picture given at the beginning of the article.  Each clock count should increase, and the checksum will change accordingly. <br><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"fe09000100000821ee85017f0000023f08"</span></span> <span class="hljs-string"><span class="hljs-string">"fe09010100000821ee85017f000002d576"</span></span> <span class="hljs-string"><span class="hljs-string">"fe09020100000821ee85017f000002ebf5"</span></span></code> </pre> <br>  In order to check whether our heartbeat is working, we will create two assembly targets: gcs - ground control station simulator and uav - drone simulator. <br><br><div class="spoiler">  <b class="spoiler_title">function code main gcs</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* argv[])</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-function"><span class="hljs-function">QCoreApplication </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">app</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(argc, argv)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">//  GCS 255   sysid domain::MavLinkCommunicator communicator(255, 0); //   -    domain::HeartbeatHandler heartbeatHandler(MAV_TYPE_GCS); QObject::connect(&amp;communicator, &amp;domain::MavLinkCommunicator::messageReceived, &amp;heartbeatHandler, &amp;domain::HeartbeatHandler::processMessage); // heartbeat       QObject::connect(&amp;heartbeatHandler, &amp;domain::HeartbeatHandler::sendMessage, &amp;communicator, &amp;domain::MavLinkCommunicator::sendMessageOnAllLinks); //  UDP  localhost domain::UdpLink link(14550, QString("127.0.0.1"), 14551); communicator.addLink(&amp;link, MAVLINK_COMM_0); link.up(); return app.exec(); }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">function code main uav</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* argv[])</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-function"><span class="hljs-function">QCoreApplication </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">app</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(argc, argv)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">//   - sysid=1 domain::MavLinkCommunicator communicator(1, 0); //   -     domain::HeartbeatHandler heartbeatHandler(MAV_TYPE_FIXED_WING); QObject::connect(&amp;communicator, &amp;domain::MavLinkCommunicator::messageReceived, &amp;heartbeatHandler, &amp;domain::HeartbeatHandler::processMessage); // heartbeat       QObject::connect(&amp;heartbeatHandler, &amp;domain::HeartbeatHandler::sendMessage, &amp;communicator, &amp;domain::MavLinkCommunicator::sendMessageOnAllLinks); //  UDP  localhost domain::UdpLink link(14551, QString("127.0.0.1"), 14550); communicator.addLink(&amp;link, MAVLINK_COMM_0); link.up(); return app.exec(); }</span></span></code> </pre><br></div></div><br>  The result should be a two-way exchange of heartbeat packets.  If you wish, you can experiment further: add another system or communication channel.  The full source code of this example can be found on <a href="">github</a> .  I hope it was interesting, even though the first part came out pretty simple.  In the next article I will try to tell you about other types of messages and what interesting things you can do with them.  Thank you for attention! <br><br>  Interesting links: <br>  <a href="http://qgroundcontrol.org/mavlink/start">MAVLink official website</a> <br>  <a href="https://www.dronecode.org/">Dronecode project site</a> <br>  <a href="http://diydrones.com/group/arducopterusergroup/forum/topics/mavlink-tutorial-for-absolute-dummies-part-i">Tutorial in English from the site DIY Drones</a> </div><p>Source: <a href="https://habr.com/ru/post/312300/">https://habr.com/ru/post/312300/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../312288/index.html">Do not think about seconds down</a></li>
<li><a href="../312290/index.html">The concept of a sandbox when developing extensions for the browser Google Chrome</a></li>
<li><a href="../312292/index.html">Installing Mikrotik Cloud Hosted Router on VPS Hosting Digital Ocean</a></li>
<li><a href="../312294/index.html">What's wrong with the display of currency symbols in iOS</a></li>
<li><a href="../312296/index.html">The United States has transferred control of the domains to the world community: what does it mean</a></li>
<li><a href="../312302/index.html">We sit on a Java-hardcore: Free broadcast of the track Joker 2016 without cuts</a></li>
<li><a href="../312304/index.html">Sell ‚Äã‚Äãlike Amazon: 7 examples of automating personal trigger e-mails that you can run today</a></li>
<li><a href="../312306/index.html">10G Switching for SMB: Extreme Summit Switch X620 Series</a></li>
<li><a href="../312308/index.html">Dive into the blockchain technology: Fast and secure transactions</a></li>
<li><a href="../312310/index.html">How we built our mini data center. Part 1 - Colocation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>