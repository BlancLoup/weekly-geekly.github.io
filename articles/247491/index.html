<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We make shipped assemblies: we interact between domains without marshalling</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="To begin with, the full list of articles posted on this cycle in Habr√©   We make shipped assemblies: we interact between domains without marshalling 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We make shipped assemblies: we interact between domains without marshalling</h1><div class="post__text post__text-html js-mediator-article"><div class="spoiler">  <b class="spoiler_title">To begin with, the full list of articles posted on this cycle in Habr√©</b> <div class="spoiler_text"> <a href="http://habrahabr.ru/company/luxoft/blog/247491/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/247491/">We make shipped assemblies: we interact between domains without marshalling</a> <br> <a href="http://habrahabr.ru/company/luxoft/blog/219619/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/219619/">Getting a pointer to a .Net object</a> <br> <a href="http://habrahabr.ru/company/luxoft/blog/238947/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/238947/">Manual stream cloning.</a>  <a href="http://habrahabr.ru/company/luxoft/blog/238947/">When Assembler + C # or Java = Love</a> <br> <a href="http://habrahabr.ru/company/luxoft/blog/239005/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/239005/">Changing the code of system assemblies or "leak". Net Framework 5.0</a> <br> <a href="http://habrahabr.ru/company/luxoft/blog/244095/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/244095/">How does decompilation in .Net or Java using the example .Net</a> <br> <a href="http://habrahabr.ru/company/luxoft/blog/247433/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/247433/">Continuing to shred CLR: .Net object pool outside SOH / LOH heaps</a> <br> <a href="http://habrahabr.ru/company/luxoft/blog/247447/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/247447/">Remove objects dump from .Net application memory</a> <br></div></div><br><br>  Link to the project in GitHub: <a href="https://github.com/mumusan/dotnetex"><img src="https://habrastorage.org/files/979/38e/df1/97938edf1170406c842b0613d0c84ae9.png"></a>  <a href="https://github.com/mumusan/dotnetex">DotNetEx</a> <br><br>  On multiple resources, a question is asked from time to time.  Is it possible to make shipped assemblies from the current domain?  So, to use and "come on, bye!"?  Everywhere and always the answer that was given is ‚Äúno‚Äù.  After all, the only thing that can be unloaded is the domain.  Accordingly, if you want to organize the shipment, the assembly must be placed in the domain, and the interaction between the domains through serializable types should be established.  And this is a very slow interaction.  And we say so.  Can.  With nuances.  We will also upload to a separate domain.  <b>But we will cancel serialization when calling methods between domains</b> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Questions that we will solve: <br><ul><li>  Creating a domain with the ability to return the object from the domain to the parent </li><li>  Unloading assembly </li></ul><br><a name="habracut"></a><br><h4>  Solution to the problem </h4><br>  So, as always, we will solve problems as they appear: <br><ul><li>  As we have already found out in previous articles, memory is common and does not depend on domains.  And this means that if you find a way to transfer a pointer to an object, you can learn to transfer objects between domains without serialization. <br><br>  Take some general type.  For simplicity, let's take the type from mscorlib: IServiceProvider. <br>  Create an assembly that we are going to make friends with the possibility of shipment: <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Implementation</span></span> : <span class="hljs-title"><span class="hljs-title">IServiceProvider</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Awesome"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetService</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type serviceType</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); } }</code> </pre> <br></li><li>  Now we will write a class that will create a domain and be able to create instances of classes in this domain: <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AppDomainRunner</span></span> : <span class="hljs-title"><span class="hljs-title">MarshalByRefObject</span></span>, <span class="hljs-title"><span class="hljs-title">IDisposable</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AppDomain appDomain; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Assembly assembly; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AppDomainRunner remoteRunner; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadAssembly</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> assemblyPath</span></span></span><span class="hljs-function">)</span></span> { assembly = Assembly.LoadFile(assemblyPath); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AppDomainRunner</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> assemblyPath</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// make appdomain appDomain = AppDomain.CreateDomain("PseudoIsolated", null, new AppDomainSetup { ApplicationBase = AppDomain.CurrentDomain.BaseDirectory }); // create object instance remoteRunner = (AppDomainRunner)appDomain.CreateInstanceAndUnwrap(typeof(AppDomainRunner).Assembly.FullName, typeof(AppDomainRunner).FullName); remoteRunner.LoadAssembly(assemblyPath); } public IntPtr CreateInstance(string typename) { return remoteRunner.CreateInstanceImpl(typename); } private IntPtr CreateInstanceImpl(string typename) { return EntityPtr.ToPointer(assembly.CreateInstance(typename)); } public void Dispose() { assembly = null; remoteRunner = null; AppDomain.Unload(appDomain); }</span></span></code> </pre></li><li>  Now we will write the class for the IoC container: <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Container</span></span> : <span class="hljs-title"><span class="hljs-title">IDisposable</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AppDomainRunner appdomain; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Dictionary&lt;Type, Object&gt; instances = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;Type, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Container</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> assemblyName</span></span></span><span class="hljs-function">)</span></span> { appdomain = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AppDomainRunner(Path.Combine(System.Environment.CurrentDirectory, assemblyName)); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Register&lt;TInterface&gt;(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> fullTypeName) { instances.Add(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> (TInterface), EntityPtr.ToInstance&lt;Object&gt;(appdomain.CreateInstance(fullTypeName))); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TInterface Resolve&lt;TInterface&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (TInterface)(instances[<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> (TInterface)]); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Dispose</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { appdomain.Dispose(); } }</code> </pre><br>  And the last - using code: <br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> container = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Container(<span class="hljs-string"><span class="hljs-string">"library.dll"</span></span>)) { container.Register&lt;IServiceProvider&gt;(<span class="hljs-string"><span class="hljs-string">"IocLibrary.Implementation"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> serviceProvider = container.Resolve&lt;IServiceProvider&gt;(); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"calling method without proxy: {0}"</span></span>, serviceProvider); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Current domain assemblies: {0}"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Join(<span class="hljs-string"><span class="hljs-string">", "</span></span>, AppDomain.CurrentDomain.GetAssemblies().Select(asm =&gt; asm.GetName().Name).ToArray())); } }</code> </pre><br></li></ul><br><br><h4>  findings </h4><br>  As they say, you cannot make shipped types, but if you want, you can.  You just need to somehow pass between the domains a pointer to the object and they can be used on equal terms. <br>  There is only one minus of the method: we have no right to use objects after unloading the assembly.  This is a minus for one simple reason: it is necessary to additionally control the order of shipment and the loss of references to objects.  But, in general, this is not a problem =) <br> <a href="http://clrium.ru/%3Futm_source%3Dhistory%26utm_medium%3Ddirect%26utm_campaign%3Dhabr"><img src="https://habrastorage.org/getpro/habr/post_images/243/44e/207/24344e20757143d25661a8fbeaa706a3.png"></a> </div><p>Source: <a href="https://habr.com/ru/post/247491/">https://habr.com/ru/post/247491/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../247477/index.html">QQuickRenderControl, or how to make QML friends with someone else's OpenGL context. Part I</a></li>
<li><a href="../247481/index.html">Year npm in numbers: 2014</a></li>
<li><a href="../247483/index.html">Dnipropetrovsk Discussion Meetup: CQRS Problem / Solution</a></li>
<li><a href="../247487/index.html">Why vi-ax programmer 21st century</a></li>
<li><a href="../247489/index.html">The first experience of developing iOS applications and thinking about marketing and advertising</a></li>
<li><a href="../247493/index.html">01 Links for UX-specialists</a></li>
<li><a href="../247495/index.html">Step-by-step algorithm for creating a PHP site architecture</a></li>
<li><a href="../247501/index.html">The first screenshots of the new Spartan web browser from Microsoft</a></li>
<li><a href="../247505/index.html">Correct polyhedra. Part 2. Foursome</a></li>
<li><a href="../247507/index.html">Command line interpreter on the microcontroller with your own hands</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>