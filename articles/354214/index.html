<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Payment Management Privat24 from Google-tables</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Working with the Internet banking of a large number of enterprises can be quite a routine task. To create payments and control them, you need to switc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Payment Management Privat24 from Google-tables</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/oh/sj/ox/ohsjoxm6rqt6xguehwabx8e5g68.png"></div><br>  Working with the Internet banking of a large number of enterprises can be quite a routine task.  To create payments and control them, you need to switch between accounts each time.  And if there are more than 50 such organizations, you can easily get lost and make mistakes, not to mention porting time.  Let's see how to make the life of an accountant easier by the example of PrivatBank's API for business. <br><a name="habracut"></a><br>  To work with the account, you must create an AutoClient and <a href="https://docs.google.com/document/d/e/2PACX-1vTtKvGa3P4E-lDqLg3bHRF6Wi9S7GIjSMFEFxII5qQZBGxuTXs25hQNiUU1hMZQhOyx6BNvIZ1bVKSr/pub">get the data for authorization</a> .  This data, as well as billing information will be stored in the Google-table. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qh/bs/dm/qhbsdmjptxulgjisgqbiqfdhwku.png"></div><br><br><img src="https://habrastorage.org/webt/5k/ux/ip/5kuxipz4qldwpi-hyx7lnbldh-c.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Tools / Script Editor.  Here we will write the backend on <a href="https://developers.google.com/apps-script/reference/spreadsheet/">Google Apps Script</a> , which is based on Java Script.  Our task is to create an http request, specifying the necessary details. <br><br>  The script will respond to changes in the last column.  To do this, add a trigger when changing (onEdit) - perform the function onEditt ().  And the function itself: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ss = SpreadsheetApp.getActive(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sheet = ss.getActiveSheet(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lastRow = sheet.getLastRow(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lastCol = sheet.getLastColumn(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onEditt</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> range = e.range; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> col = range.getColumn(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> row = range.getRow(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (row &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (col == lastCol) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> value = range.getValue(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == <span class="hljs-string"><span class="hljs-string">''</span></span>) { createPayment(range.getRow()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == <span class="hljs-string"><span class="hljs-string">''</span></span>) { checkPayment(range.getRow(), sheet); } range.clearContent(); } }</code> </pre> <br><h3>  Making payments </h3><br>  To create payments, use a POST request.  The process generates a document number, which will come in handy later.  As a result, execution statuses for each request will be visible - either success or error. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url = <span class="hljs-string"><span class="hljs-string">"https://acp.privatbank.ua/api/proxy/payment/create_pred"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> day = getDay(); <span class="hljs-comment"><span class="hljs-comment">//     function createPayment(i) { var iRange = sheet.getRange(i, 1, 1, lastCol); var values = iRange.getDisplayValues(); var docNumRange = sheet.getRange(i, 3); var stateRange = sheet.getRange(i, 10); var state = stateRange.getValue(); if (state == '') { iRange.setBackground('#66ff66'); return; } else if (state == '') { iRange.setBackground('#ebebe0'); return; } docNumRange.clearContent(); var name = values[0][0]; var userData = getUserData(name); if (!userData) { iRange.setBackground('#ffff80'); stateRange.setValue('  '); return; } var inn = userData[1]; var id = userData[2]; var token = userData[3]; var payer_account = userData[4]; var doc_type = values[0][1]; var document_number = "" + day + (i + 10) + Math.floor(Math.random() * 90 + 10); var payment_amount = values[0][3]; var payment_naming = values[0][4]; var recipient_account = values[0][5]; var recipient_nceo = values[0][6]; var recipient_ifi = values[0][7]; var payment_destination = values[0][8]; if (!inn || !id || !token || !payer_account) { iRange.setBackground('#ffff80'); stateRange.setValue('  '); return; } if (!document_number || ! recipient_account || !recipient_nceo || !payment_naming || !recipient_ifi || !payment_amount || !payment_destination) { iRange.setBackground('#ffff80'); stateRange.setValue(' '); return; } var headers = { 'User-Agent' : 'GooApps', 'id' : id, 'token' : token, 'Connection' : 'close' } var payload = { 'document_number' : document_number, 'payer_account' : payer_account, 'recipient_account' : recipient_account, 'recipient_nceo' : recipient_nceo, 'payment_naming' : payment_naming, 'recipient_ifi' : recipient_ifi, 'payment_amount' : payment_amount, 'payment_destination' : payment_destination }; var options = { 'method' : 'post', 'contentType' : 'application/json;charset=utf8', 'headers' : headers, 'payload' : JSON.stringify(payload), 'muteHttpExceptions' : true }; var response = UrlFetchApp.fetch(url, options); var respCode = response.getResponseCode(); if (respCode == 201) { docNumRange.setValue(document_number); iRange.setBackground('#66ff66'); stateRange.setValue(''); } else { iRange.setBackground('#ff9980'); var resp = JSON.parse(response.getContentText()); var error = resp.code; if (!error) { error = resp.error_code; } stateRange.setValue(error); } } //   function createPayments() { var range = sheet.getRange(2, 1, lastRow, lastCol); range.clearFormat(); for (var i = 2; i &lt;= lastRow; i++) { createPayment(i); } } function getUserData(name) { var uSheet = ss.getSheetByName('Users'); var uRange = usersSheet.getRange(2, 1, uSheet.getLastRow(), uSheet.getLastColumn()); var values = uRange.getDisplayValues(); for (var i = 0; i &lt; values.length; i++) { if (name == values[i][0]) { return values[i]; } } } function getDay() { var now = new Date(); var start = new Date('January 1, 2018 00:00:00 +0200'); var number = Math.round((now.getTime() - start.getTime()) / (1000 * 3600 * 24)); return number; }</span></span></code> </pre><br><h3>  Payment control </h3><br>  To control payments, we will receive all statements for the last 30 days and look for the document number, status and payment amount in them.  If everything is the same, the payment is paid.  In this case, a GET request is used. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> urlGet = <span class="hljs-string"><span class="hljs-string">'https://acp.privatbank.ua/api/proxy/transactions'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stDate = Utilities.formatDate(substMonth() , <span class="hljs-string"><span class="hljs-string">'+0200'</span></span>, <span class="hljs-string"><span class="hljs-string">'dd-MM-yyyy'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> endDate = Utilities.formatDate(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>(), <span class="hljs-string"><span class="hljs-string">'+0200'</span></span>, <span class="hljs-string"><span class="hljs-string">'dd-MM-yyyy'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//     function checkPayment(i) { var iRange = sheet.getRange(i, 1, 1, lastCol); var values = iRange.getDisplayValues(); var stateRange = sheet.getRange(i, 10); var state = stateRange.getValue(); if (state != '') { return; } var name = values[0][0]; var userData = getUserData(name); if (!userData) { iRange.setBackground('#ffe066'); stateRange.setValue('  '); return; } var id = userData[2]; var token = userData[3]; var payer_account = userData[4]; var document_number = values[0][2]; var payment_amount = values[0][3]; if (!id || !token || !payer_account) { iRange.setBackground('#ffe066'); stateRange.setValue('  '); return; } if (!document_number || !payment_amount) { iRange.setBackground('#ffe066'); stateRange.setValue(' '); return; } var headers = { 'User-Agent' : 'GooApps', 'id' : id, 'token' : token, 'Connection' : 'close' } var options = { 'method' : 'get', 'contentType' : 'application/json;charset=utf8', 'headers' : headers, 'muteHttpExceptions' : true }; var url = Utilities.formatString('%s?acc=%s&amp;startDate=%s&amp;endDate=%s', urlGet, payer_account, stDate, endDate); var response = UrlFetchApp.fetch(url, options); var resp = JSON.parse(response); var statements = resp.StatementsResponse.statements; for (var j = 0; j &lt; statements.length; j++) { for (var name in statements[j]) { var bill = statements[j][name]; if (document_number == bill.BPL_NUM_DOC) { var pay = payment_amount.toString().replace(',','.'); if (pay == bill.BPL_SUM) { if ('r' == bill.BPL_PR_PR) { iRange.setBackground('#ebebe0'); stateRange.setValue(''); } else { iRange.setBackground('#df80ff'); stateRange.setValue(' '); } } else { Logger.log(pay + ' ' + bill.BPL_SUM) iRange.setBackground('#df80ff'); stateRange.setValue('  '); } } } } } function substMonth() { var now = new Date(); var start = new Date(now.getTime() - 30 * (1000 * 3600 * 24)); return start; }</span></span></code> </pre><br>  The check can be put on the trigger.  It remains only to observe how payments are made. <br><br> <a href=""><img src="https://habrastorage.org/webt/4a/ub/dj/4aubdjjy7rsetxp6myqp_b3stvm.png"></a> <br><br>  PS Try how it works on a <a href="https://docs.google.com/spreadsheets/d/1MA5jKVDWxJt2pvt6Xx7jAOJci-HyVTUXI0zMCeqGprA/edit%3Fusp%3Dsharing">test chart</a> .  Copy it to your disk and add an onEdit trigger to execute the onEditt () function. </div><p>Source: <a href="https://habr.com/ru/post/354214/">https://habr.com/ru/post/354214/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354200/index.html">Unified Scalable Remuneration System: Our Experience</a></li>
<li><a href="../354204/index.html">Morrowind speedran planning using simulated annealing</a></li>
<li><a href="../354206/index.html">Start with full stack and not regret: from senior developer to head of department for six years</a></li>
<li><a href="../354208/index.html">Learn OpenGL. Lesson 5.4 - Omnidirectional Shadow Maps</a></li>
<li><a href="../354210/index.html">The announcement of the mitap ThinkPHP # 16 in Kharkov</a></li>
<li><a href="../354216/index.html">Forbes: Alibaba and Uber have become the most profitable companies for investors</a></li>
<li><a href="../354220/index.html">Applying recurrent layers to solve multiple paths</a></li>
<li><a href="../354224/index.html">slowpoke is not the fastest database</a></li>
<li><a href="../354226/index.html">Another option for generating thumbnails for images using AWS Lambda & golang + nodejs + nginx</a></li>
<li><a href="../354228/index.html">Hyper-v cluster of two nodes, without external storage or hyperconvergence on the knee</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>