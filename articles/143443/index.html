<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>An evening with Sinatra to create a TwitterBar service</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In general, I would like to introduce and tell a little about my little child, so to speak about the code in the evening. I have always believed and I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>An evening with Sinatra to create a TwitterBar service</h1><div class="post__text post__text-html js-mediator-article">  In general, I would like to introduce and tell a little about my little child, so to speak about the code in the evening.  I have always believed and I think that if you want to learn something, and especially to understand technology, then of course you have to read a lot, and more importantly take, sit down and do this technology, even if just for fun.  All the same, because programming is a creative work, and each of us has some ideas of projects, services, startups in our head, and even if not, there are still needs, some small ones, but if we take them and solve them this evening - this is the pleasure of learning.  This is my course IMHO. <a name="habracut"></a><br><br>  But somehow I had one desire, more precisely the need for twitter on ‚Äúexhibitionism‚Äù in a broad sense.  I regularly conduct <a href="https://twitter.com/">my twitter</a> where I regularly share links about technology, programming, sometimes good music, sometimes I just talk about life in Asia or where we travel there.  So sometimes, I want these tweets to be visible to more people and by analogy with, for example, Last.fm which gives you the opportunity to show that you are listening to the current moment (by the way, I did the <a href="http://lastfm.rockufa.ru/">LastFM.bar</a> service for this) I decided that it was good so that, for example, visitors to the forum in which I write, see my last tweet in the signature.  The problem is that the forum is not mine, and you can only insert images into the signature, for example, no dynamics on JS and so on, only BBCode, only pictures. <br>  So I decided that it would be great to put together a very easy and simple service that would do 3 things in all: <br>  1. take the last user's tweet, for example in JSON format <br>  2. parse this JSON, take the thematic picture for the background, adjust the fonts, sizes, arrange hyphenation in the text and draw this very text on the picture <br>  3. give caching headers and give the picture itself <br>  Everything. <br><br>  Well, since lately I‚Äôve been trying to do more and more projects on Ruby, in particular Ruby on Rails, but in this case I think that for me this big framework would be redundant.  The good old Sinatra immediately came to mind.  He can be called the progenitor of web frameworks, he was able to give life to such PHP followers as Slim, Fat3, Perl has his youngest to take the Dancer, and even took Mojolicious :: Lite much into his piggy bank.  But all these frameworks are just a shadow, they have their own and slightly ugly DSL, there is no Ruby beauty, I‚Äôll try to show you this beauty a little. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's start with a demonstration, since the project does not use the Database and is not commercial, in such options there is an excellent hosting service Heroku.com I used it, especially since hosting it was not as simple as Heroku did.  And so, the demo is here: <a href="http://twitterbar.heroku.com/">twitterbar.heroku.com</a> <br>  And the source can be downloaded directly from here, they are very few and they are very simple <a href="https://github.com/mpakus/twitterbar">github.com/mpakus/twitterbar</a> <br><br>  Let's talk a little about Sinatra as a whole and go over the structure and source code of the application. <br><br>  What is Sinatra?  Actually, this is a regular gem (library) that can be put on one line. <br>  <em>&gt; gem install sinatra</em> <br><br>  create new file <br>  <em>&gt; mcedit first_app.rb</em> <br><br>  write in it <br><pre><code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'sinatra'</span></span> get <span class="hljs-string"><span class="hljs-string">'/'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-string"><span class="hljs-string">"Hello World"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><br>  and run this file in the console <br>  <em>&gt; ruby ‚Äã‚Äãfirst_app.rb</em> <br>  then a web server will be created on the local host on port 4567, now you can open your favorite browser and type localhost: 4567 in it and see the work of your first application on Sinatra. <br>  Voila, easy and convenient! <br><br>  What is the salt?  In simplicity, they hooked up one library through require, painted the necessary routes through convenient DSL, took our favorite templating engine, for example, built-in ERB or HAML, someone and Slim already fell in love, brought daddy to us, for example, views templates, connected them and showed static files from the public folder, and you can even store templates directly in the main file, even simpler and more compact.  All this is so flexible and customizable that you wonder how bright and understandable it is from the documentation <a href="http://www.sinatrarb.com/documentation">www.sinatrarb.com/documentation</a> <br><br>  Now about my simple application for the evening. <br><br>  At the root, there is the main application file index.rb and there are two helper classes whose methods I made singlet since I don't need objects, and even in Ruby, we have classes of objects :) it's hard to understand, but I thought something like that I saw in Basic language, execution right by code, line by line.  But I was distracted, and so, two classes that I wrote and brought classes to my daddy: twitter.rb - which simply takes the last tweet of the user in JSON format and turns it into a regular ruby ‚Äã‚Äãhash <br>  imagebar.rb - just a simple class for drawing on the picture of our text, uses the rmagick library, it is an adapter to the ImageMagick utility <br><br>  And now let's go through the application and I will try to paint each line with a comment, by the way, comments like Ruby start with # I, for example, after so many years Perl was generally pleasant and comfortable. <br><br>  And so index.rb in rows to understand what we use, for what and how. <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'rubygems'</span></span> <span class="hljs-comment"><span class="hljs-comment">#  1.9 Ruby   ,    require 'sinatra' #    require 'sinatra/reloader' #          require Dir.pwd + '/classes/twitter.rb' #        require Dir.pwd + '/classes/imagebar.rb' #        require 'ostruct' #    yaml    ruby require 'yaml' #   yaml  set :env, :production #    configure do #  ,     set :root, File.dirname(__FILE__) enable :static #        publc enable :logging #  enable :dump_errors #    disable :sessions #       end get '/' do #       response['Cache-Control'] = "public, max-age=#{5*60*10}" #     erb :index #      views/index.html.erb   layout end #        get '/twit/:theme/:user.gif' do #  ,     theme_dir = Dir.pwd + '/themes/' #      user_name = params[:user] #       theme = params[:theme] #         #    ,      -  halt [ 404, "Page not found" ] unless user_name halt [ 500, "Sorry wrong theme" ] unless theme halt [ 404, "Can't find themes file" ] unless FileTest.exists? theme_dir + theme + '.yml' halt [ 404, "Can not found background" ] unless FileTest.exists? theme_dir + theme + '.gif' #  yaml       ruby  conf = OpenStruct.new( YAML.load_file theme_dir + theme + '.yml' ) #      twit = Twitter.get_last_post user_name #     ,   2  response['Cache-Control'] = "public, max-age=#{60*2}" content_type 'image/gif' #  mime  ,    ImageBar.draw theme_dir, theme, twit, conf #         end</span></span></code> </pre> <br><br>  Just yes?  And note, it reads like ordinary English-language and almost instinctively code. <br><br>  Let's go further?  Our two classes, the first is Twitter: <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Twitter</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#    require 'open-uri' #     , - CURL  require 'json' #     JSON  class &lt;&lt; self #           last_post = nil #         def get_last_post user_name #      download user_name #     get_data user_name #        end protected #    ,    def download user_name #     json   </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@last</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_post = open("http://api.twitter.com/1/statuses/user_timeline/#{user_name}.json").read end def get_data user_name JSON.parse </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@last</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_post #   JSON     end end end</span></span></span></span></code> </pre> <br>  Just because you agree? <br><br>  Well, our second class is ImageBar for drawing a tweet in the picture: <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImageBar</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#    require 'RMagick' #       class &lt;&lt; self #     def draw theme_dir, theme, twit, conf #        #       img = Magick::ImageList.new theme_dir + theme + '.gif' text = Magick::Draw.new #      text.font = conf.font #     text.pointsize = conf.font_size.to_i #   text.gravity = Magick::NorthWestGravity #      text.fill = conf.color #   text.kerning = conf.kerning #   text.interline_spacing = conf.interline_spacing #   #   ,      wrap_text    text.annotate img, conf.width, conf.height, conf.left, conf.top, wrap_text( twit[0]['text'], conf.chars_in_row ) img.to_blob #      end def wrap_text(txt, col = 30) #       txt.gsub(/(.{1,#{col}})( +|$\n?)|(.{1,#{col}})/, "\\1\\3\n") end end end</span></span></span></span></code> </pre> <br>  That's all, no more magic, everything is simple, like a brick and works as reliably and simply. <br><br>  Taking into account the whole study of every mana of RMagick, for example, and Sinatra received a lot of pleasure and knowledge during the evening, and it is very important to keep our brains in good shape and not drown in this PHP monotony. <br><br>  Now I‚Äôm happy to read a Sinatra book called Sinatra Up and Running - an accessible and easy-to-learn literature, tells all the subtleties of this simple, but at the same time very powerful and concise Ruby framework, I recommend both the book and the framework, since the world of Ruby is alive not only the Ruby on Rails framework, but also such very convenient horses, which in some cases are even better to use on tasks when not needed in a large Rails infrastructure, like creating any API, quick statistics collection, drawing some kind of static ones kart  nok (counters, ratings, voting is), in general, all that requires simplicity, speed, and minimalism code loadable and overheads. <br><br>  That's all, thank you all.  If you have any questions, suggestions or comments, you are happy to read them and discuss them. </div><p>Source: <a href="https://habr.com/ru/post/143443/">https://habr.com/ru/post/143443/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../143437/index.html">Using GWT with Documentum & Webtop</a></li>
<li><a href="../143438/index.html">Ultramodem for ultrabook</a></li>
<li><a href="../143439/index.html">Simple, convenient - Mouse gestures</a></li>
<li><a href="../143440/index.html">Strange access bug to corporate google mail</a></li>
<li><a href="../143441/index.html">About code reuse</a></li>
<li><a href="../143444/index.html">The list of speakers at the MobileOptimized 2012 conference is defined</a></li>
<li><a href="../143446/index.html">Sharing is not always useful: we optimize work with cache memory.</a></li>
<li><a href="../143447/index.html">Oracle vs Google: Jury Delivers Verdict</a></li>
<li><a href="../143448/index.html">iOS 5.1.1 available for download</a></li>
<li><a href="../143450/index.html">garage48 for the first time in Kiev!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>