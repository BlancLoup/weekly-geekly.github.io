<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Long Polling for Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After reading the article , I began to introduce Long Polling into web projects. The server part is spinning on nginx, the clients listen to the chann...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Long Polling for Android</h1><div class="post__text post__text-html js-mediator-article">  After reading the <a href="http://habrahabr.ru/company/cackle/blog/167895/">article</a> , I began to introduce Long Polling into web projects.  The server part is spinning on nginx, the clients listen to the channels in javascript.  First of all, it was very useful for personal messages on the site. <br>  Then, in support of web projects, applications for Android began to be developed.  There was a question: how to implement a multi-user project, in which both browser clients and mobile applications would be equally involved.  Since Long Polling has already been implemented in browser versions, it was decided to write a java module for Android. <br><a name="habracut"></a><br>  There was no task to write a complete analog of the js library, so I started writing a module for a particular, but most popular, case. <br><br><h4>  Server part </h4><br>  So let's start with the server. <br><br><h5>  Nginx </h5><br>  <a href="https://github.com/wandenberg/nginx-push-stream-module">Nginx-push-stream-module is used</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the nginx settings: <br><br><pre><code class="nginx hljs"><span class="hljs-comment"><span class="hljs-comment">#     location /channels-stats { push_stream_channels_statistics; push_stream_channels_path $arg_id; } #     location /pub { push_stream_publisher admin; push_stream_channels_path $arg_id; push_stream_store_messages on; #   ,   ,      } #     location ~ ^/lp/(.*) { push_stream_subscriber long-polling; push_stream_channels_path $1; push_stream_message_template "{\"id\":~id~,\"channel\":\"~channel~\",\"tag\":\"~tag~\",\"time\":\"~time~\",\"text\":~text~}"; push_stream_longpolling_connection_ttl 30s; }</span></span></code> </pre> <br>  The config describes three directives: for sending, receiving messages, as well as for receiving statistics. <br><br><h5>  Php </h5><br>  Messages are published by the server.  Here is an example of the function in php: <br><br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">/* * $cids - ID ,  ,     - ID  * $text - ,    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($cids, $text)</span></span></span><span class="hljs-function"> </span></span>{ $text = json_encode($text); $c = curl_init(); $url = <span class="hljs-string"><span class="hljs-string">'http://example.com/pub?id='</span></span>; curl_setopt($c, CURLOPT_RETURNTRANSFER, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); curl_setopt($c, CURLOPT_POST, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $results = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_array($cids)) { $cids = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($cids); } $cids = array_unique($cids); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($cids <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $v) { curl_setopt($c, CURLOPT_URL, $url . $v); curl_setopt($c, CURLOPT_POSTFIELDS, $text); $results[] = curl_exec($c); } curl_close($c); }</code> </pre><br>  Here, too, everything is simple: we transmit the channel (s) and the message we want to send.  Due to the fact that plain plain text is not interesting to anyone, and there is a wonderful json format, you can send objects immediately. <br><br>  The concept of forming the name of the channels was long thought over.  It is necessary to provide the possibility of sending different types of messages to all clients, or only one or several, but filtered by some characteristic. <br><br>  As a result, the following format was developed, consisting of three parameters: <br><pre> <code class="hljs css"><span class="hljs-selector-attr"><span class="hljs-selector-attr">[id ]</span></span>_<span class="hljs-selector-attr"><span class="hljs-selector-attr">[ ]</span></span>_<span class="hljs-selector-attr"><span class="hljs-selector-attr">[id ]</span></span></code> </pre><br>  If we want to send a message to all users, we use the channel: <br><pre> <code class="hljs">0_main_0</code> </pre><br>  if the user with id = 777: <br><pre> <code class="hljs">777_main_0</code> </pre><br>  if the cost of the order has changed with id = 777 in general for all the list, then: <br><pre> <code class="hljs">0_orderPriceChanged_777</code> </pre><br>  It turned out very flexible. <br>  Although later, after a little reflection, I came to the conclusion that it is better not to load clients with wiretapping of all channels, but to transfer this load to the server, which will form and send a message to each user. <br>  And to separate message types, you can use a parameter, for example, act: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ACT_NEW_MESSAGE = <span class="hljs-number"><span class="hljs-number">1</span></span>; LongPolling::push($uid.<span class="hljs-string"><span class="hljs-string">"_main_0"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">"act"</span></span> =&gt; ACT_NEW_MESSAGE, <span class="hljs-string"><span class="hljs-string">"content"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"Hello, user "</span></span>.$uid.<span class="hljs-string"><span class="hljs-string">"!"</span></span>, ));</code> </pre><br><br><h4>  Client part </h4><br>  About the server part like everything.  Get down to java! <br>  I posted a class on <a href="https://github.com/jonasasx/LongPolling">gihub</a> . <br>  In my library, I used the <a href="http">android-async-http</a> library, which implements convenient asynchronous http requests.  In the example, I added a compiled jar file. <br><br>  The class interface is quite simple. <br>  First you need to create a callback object, whose methods will receive answers.  Since we mainly use objects in messages, JsonHttpResponseHandler was chosen as the callback class: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ACT_NEW_ORDER = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ACT_DEL_ORDER = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ACT_ATTRIBUTES_CHANGED = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ACT_MESSAGE = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> JsonHttpResponseHandler handler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonHttpResponseHandler() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSuccess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> statusCode, Header[] headers, JSONObject response)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { JSONObject json = response.getJSONObject(<span class="hljs-string"><span class="hljs-string">"text"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (json.getInt(<span class="hljs-string"><span class="hljs-string">"act"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ACT_NEW_ORDER: ... <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ACT_DEL_ORDER: ... <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ACT_ATTRIBUTES_CHANGED: ... <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ACT_MESSAGE: ... <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (JSONException e) { e.printStackTrace(); } } };</code> </pre><br>  In this example, you hear messages about the appearance of a new order, deleting an order, changing user attributes, and a new personal message. <br><br>  Next we initialize the LongPolling object (let's say we do it in the Activity): <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> LongPolling lp; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> uid = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setContentView(R.layout.activity_balance); lp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LongPolling(getApplicationContext(), <span class="hljs-string"><span class="hljs-string">"http://example.com/lp/"</span></span>, Integer.toString(uid) + <span class="hljs-string"><span class="hljs-string">"_main_0"</span></span>, handler); }</code> </pre><br>  If we need Long Polling only in Activity, then it is necessary to register: <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResume</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onResume(); lp.connect(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPause</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onPause(); lp.disconnect(); }</code> </pre><br>  If messages need to be received in the entire application (and this is usually), then the object can be initialized in the application class (Application) or in the service (Service). <br>  Then immediately after initialization, you need to start listening. <br><pre> <code class="java hljs">lp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LongPolling(getApplicationContext(), <span class="hljs-string"><span class="hljs-string">"http://example.com/lp/"</span></span>, Integer.toString(uid) + <span class="hljs-string"><span class="hljs-string">"_main_0"</span></span>, handler); lp.connect();</code> </pre><br>  And, in order not to depress the user's battery, it is necessary to register the BroadcastReceiver for the events of appearance / disappearance of connection to the Internet: <br>  AndroidManifest.xml <br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">manifest</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:android</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.ACCESS_NETWORK_STATE"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.ACCESS_WIFI_STATE"</span></span></span><span class="hljs-tag"> /&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">application</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">receiver</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.app.example.receivers.InternetStateReceiver"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.net.conn.CONNECTIVITY_CHANGE"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.net.wifi.supplicant.CONNECTION_CHANGE"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">receiver</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">application</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">manifest</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  and InternetStateReceiver <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InternetStateReceiver</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BroadcastReceiver</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onReceive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, Intent intent)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ConnectivityManager connMgr = (ConnectivityManager) context.getSystemService(Context.CONNECTIVITY_SERVICE); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> android.net.NetworkInfo wifi = connMgr.getNetworkInfo(ConnectivityManager.TYPE_WIFI); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> android.net.NetworkInfo mobile = connMgr.getNetworkInfo(ConnectivityManager.TYPE_MOBILE); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wifi != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; wifi.isAvailable() || mobile != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; mobile.isAvailable()) { application.getInstance().lp.connect(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { application.getInstance().lp.disconnect(); } } }</code> </pre><br><br><h4>  Statistics </h4><br>  Well, as a bun, it would be interesting to see real-time statistics, since we provided for it in time. <br>  Suppose we are interested in the number of users online. <br>  For this we get the XML / json information by url: <br><pre> <code class="nginx hljs">http://example.com/channels-stats?id=ALL</code> </pre> <br>  and see the following: <br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">root</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hostname</span></span></span><span class="hljs-tag">&gt;</span></span>example.com<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hostname</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">time</span></span></span><span class="hljs-tag">&gt;</span></span>2014-03-22T00:03:37<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">time</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">channels</span></span></span><span class="hljs-tag">&gt;</span></span>2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">channels</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wildcard_channels</span></span></span><span class="hljs-tag">&gt;</span></span>0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wildcard_channels</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uptime</span></span></span><span class="hljs-tag">&gt;</span></span>818530<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uptime</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">infos</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">channel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>4_main_0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">published_messages</span></span></span><span class="hljs-tag">&gt;</span></span>0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">published_messages</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">stored_messages</span></span></span><span class="hljs-tag">&gt;</span></span>0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">stored_messages</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">subscribers</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">subscribers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">channel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">channel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>23_main_0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">published_messages</span></span></span><span class="hljs-tag">&gt;</span></span>0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">published_messages</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">stored_messages</span></span></span><span class="hljs-tag">&gt;</span></span>0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">stored_messages</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">subscribers</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">subscribers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">channel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">infos</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">root</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  In the subscribers tag, we see the number of listeners for each channel.  But since in this case each user has his own channel, we‚Äôll compile a list of users online using PHP: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> STATISTICS_URL = <span class="hljs-string"><span class="hljs-string">'http://example.com/channels-stats?id=ALL'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getOnlineIds</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $str = file_get_contents(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::STATISTICS_URL); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$str) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; $json = json_decode($str); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($json -&gt; infos)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; $ids = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($json-&gt;infos <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $v) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($v -&gt; subscribers &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; substr_count($v -&gt; channel, <span class="hljs-string"><span class="hljs-string">'_main_0'</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { $ids[] = str_replace(<span class="hljs-string"><span class="hljs-string">'_main_0'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, $v -&gt; channel); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $ids; }</code> </pre><br>  So we got the id users in the network.  But there is one BUT.  At the moment when the client reconnects to the server, it will not be in the statistics, it must be taken into account. <br><br><h4>  Conclusion </h4><br>  Well, sort of told everything.  Now you can send messages to users in the browser, where they will receive JavaScript, and in the application on Android, using the same sender.  And in addition we can display, for example on the site, the exact number of users online. <br><br>  I will be glad to hear criticism and suggestions. <br><br><h5>  Links </h5><br><ol><li>  <a href="https://github.com/jonasasx/LongPolling">https://github.com/jonasasx/LongPolling</a> - the actual result of the work </li><li>  <a href="https://github.com/wandenberg/nginx-push-stream-module">https://github.com/wandenberg/nginx-push-stream-module</a> - nxing module </li><li>  <a href="http">https://github.com/loopj/android-async-http</a> - library of asynchronous http requests for Android </li></ol></div><p>Source: <a href="https://habr.com/ru/post/216713/">https://habr.com/ru/post/216713/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../216691/index.html">How to plant a neighbor on Linux, or a little bit about tangerines in the context of OS</a></li>
<li><a href="../216695/index.html">About patriotism and realism</a></li>
<li><a href="../216697/index.html">Easy way to write iOS apps on the web</a></li>
<li><a href="../216701/index.html">One! = The only one? Registry of banned sites</a></li>
<li><a href="../216711/index.html">Techniques for character development in games: Part 1 - Tarot</a></li>
<li><a href="../216715/index.html">Broccoli: first beta release</a></li>
<li><a href="../216719/index.html">As a single prosecution, Microsoft destroyed the trust of customers in the integrity of their data in the "cloud" services</a></li>
<li><a href="../216723/index.html">Mozilla changes the design of Firefox: try Firefox 29 beta</a></li>
<li><a href="../216725/index.html">Abstract Data Type Concept</a></li>
<li><a href="../216729/index.html">Machine learning in a simple project</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>