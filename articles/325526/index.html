<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Do we need neural networks?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Or the story of how I made image recognition using a convolutional neural network without a neural network. Interesting? Then I ask for cat. 

 Prehis...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Do we need neural networks?</h1><div class="post__text post__text-html js-mediator-article">  Or the story of how I made image recognition using a convolutional neural network without a neural network.  Interesting?  Then I ask for cat. <br><a name="habracut"></a><br><h2>  Prehistory </h2><br>  One summer evening playing Dota 2, I thought it would not be a bad thing to recognize the characters in the game, and to give out statistics on the most successful counter-character selection.  First thought, you need to somehow pull the data from the match and immediately process them.  But I rejected this idea, since I have no experience in hacking games.  Then I decided that it was possible to make screenshots during the game, process them quickly, and thus obtain data about the selected characters. <br><br><h2>  Training </h2><br>  And so we begin.  First we take a screenshot of the screen. <br><br><div class="spoiler">  <b class="spoiler_title">Screenshot</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/7b7/ff2/fc4/7b7ff2fc452145e89672c76047287675.png" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/c04/801/393/c048013931c046d7ab30e820780b476f.png" alt="image"><br><br></div></div><br>  Everything looks like the image; it may just be to take hash from the image and search for it. <br><br><div class="spoiler">  <b class="spoiler_title">Hm</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/2ec/ee2/bc9/2ecee2bc9a654ad19057c4ca1bc8c76c.gif" alt="image"><br><br><img src="https://habrastorage.org/files/b64/0af/11b/b640af11b7234b4183a81bf99898a7da.gif" alt="image"><br></div></div><br>  ‚ÄúOh Gabe!  Well, for that kind of torment me. "No, it will not work.  One Gabe knows why the characters' images are so wriggled (although not only to him, I have an assumption that the images go resize (tsya), and the dimensions are given by a fractional number).  So it is necessary to recognize the image in another way.  Now neural networks are in fashion.  So try to screw them.  We will use convolutional neural networks.  So we need: <br><br><ol><li>  Convolution core. </li><li>  Signs of haar. </li><li>  Test set of images.  1000 is another for one character ... </li><li>  ... </li></ol><br>  Wait, what about oh oh oh oh <br><br><img src="https://habrastorage.org/files/ebc/f1f/ff5/ebcf1fff52fd4bbbbe56d71312a170ea.png" alt="image"><br><br>  I don‚Äôt have enough life to accumulate such a base.  I thought we should somehow do without a huge training sample, while not at the expense of recognition speed.  There is an exhaustive article about the SNS (Convolutional Neural Network) on <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B2%25D1%2591%25D1%2580%25D1%2582%25D0%25BE%25D1%2587%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25BD%25D0%25B5%25D0%25B9%25D1%2580%25D0%25BE%25D0%25BD%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2581%25D0%25B5%25D1%2582%25D1%258C">Wikipedia</a> .  Briefly explain the principle of the SNA can be so.  The input matrix is ‚Äã‚Äãthe brightness of the pixels in grayscale.  And multiplied by the convolutional core, then the values ‚Äã‚Äãare added together and normalized.  A convolution core is usually -1 and 1, denoting black and white colors, respectively, or vice versa. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/0db/b10/097/0dbb100979204a1385d174aaf8eb6ff2.png" alt="image"></div><br>  There are popular kernel patterns, for example, Haar signs.  Further in the article we will use precisely some signs of Haar.  Then the convolution values ‚Äã‚Äãpass through the input connections of the neuron, are multiplied by the weights of the connections, summed, and ultimately the value obtained is fed to the neuron's activation function.  But this is pure comparison, or the difference of bundles, here it is.  We just need to take the difference of the original convolution with the convolutions of the characters, the smaller the difference, the more similar the images.  This is the simplest architecture.  There are no hidden layers in it, since we do not need any abstract parameters.  Let's try to do all of the above. <br><br><h2>  Write the code </h2><br>  The original character image will be 78x53 px.  In grayscale.  That is, a matrix of size 78x53 with values ‚Äã‚Äãof 0 ... 255. We will take the core of 10x10 in size.  The kernel pitch will be the size of the core - 10. Both in x and y.  (We don‚Äôt need a lot of parameters. After all, the images are not very different from each other).  Total 48 values ‚Äã‚Äãper character.  Now let's get down to the code.  We need to initialize the kernel with numbers according to the signs of Haar.  Take the following signs. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/2b1/a28/c24/2b1a28c24ec24ac1af1e9ce6cb2fd1ab.png" alt="image"></div><br>  Let's create the class ConvolutionCore where we will initialize the convolutional kernel. <br><br><div class="spoiler">  <b class="spoiler_title">ConvolutionCore class</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.kuldiegor.recognize; <span class="hljs-comment"><span class="hljs-comment">/** * Created by aeterneus on 17.03.2017. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConvolutionCore</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> unitMin; <span class="hljs-comment"><span class="hljs-comment">// -1 public int unitMax; // 1 public int matrix[][]; public ConvolutionCore(int width,int height,int haar){ matrix = new int[height][width]; unitMax=0; unitMin=0; switch (haar){ case 0:{ // -1 =   // 1 =   /* -1 -1 -1 1 1 1 -1 -1 -1 1 1 1 -1 -1 -1 1 1 1 */ for (int y=0;y&lt;height;y++){ for (int x=0;x&lt;(width/2);x++){ matrix[y][x]=-1; unitMin++; } for (int x=width/2;x&lt;width;x++){ matrix[y][x]=1; unitMax++; } } break; } case 1:{ // -1 =   // 1 =   /* 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 */ for (int y=0;y&lt;(height/2);y++){ for (int x=0;x&lt;width;x++){ matrix[y][x]=1; unitMax++; } } for (int y=(height/2);y&lt;height;y++){ for (int x=0;x&lt;width;x++){ matrix[y][x]=-1; unitMin++; } } break; } case 2:{ // -1 =   // 1 =   /* 1 1 -1 -1 -1 1 1 1 1 -1 -1 -1 1 1 1 1 -1 -1 -1 1 1 */ for (int y=0;y&lt;height;y++){ for (int x=0;x&lt;(width/3);x++){ matrix[y][x]=1; unitMax++; } for (int x=(width/3);x&lt;(width*2/3);x++){ matrix[y][x]=-1; unitMin++; } for (int x=(width*2/3);x&lt;width;x++){ matrix[y][x]=1; unitMax++; } } break; } case 3:{ // -1 =   // 1 =   /* 1 1 1 1 1 1 1 1 1 1 1 1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 1 1 1 1 1 1 1 1 1 1 1 1 */ for (int y=0;y&lt;(height/3);y++){ for (int x=0;x&lt;width;x++){ matrix[y][x]=1; unitMax++; } } for (int y=(height/3);y&lt;(height*2/3);y++){ for (int x=0;x&lt;width;x++){ matrix[y][x]=-1; unitMin++; } } for (int y=(height*2/3);y&lt;height;y++){ for (int x=0;x&lt;width;x++){ matrix[y][x]=1; unitMax++; } } break; } case 4:{ // -1 =   // 1 =   /* 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 -1 -1 -1 1 1 -1 -1 -1 1 1 -1 -1 -1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 */ for (int y=0;y&lt;(height/3);y++){ for (int x=0;x&lt;width;x++){ matrix[y][x]=1; unitMax++; } } for (int y=(height/3);y&lt;(height*2/3);y++){ for (int x=0;x&lt;(width/3);x++){ matrix[y][x]=1; unitMax++; } for (int x=(width/3);x&lt;(width*2/3);x++){ matrix[y][x]=-1; unitMin++; } for (int x=(width*2/3);x&lt;width;x++){ matrix[y][x]=1; unitMax++; } } for (int y=(height*2/3);y&lt;height;y++){ for (int x=0;x&lt;width;x++){ matrix[y][x]=1; unitMax++; } } break; } case 5:{ // -1 =   // 1 =   /* 1 1 1 -1 -1 -1 1 1 1 -1 -1 -1 -1 -1 -1 1 1 1 -1 -1 -1 1 1 1 */ for (int y=0;y&lt;(height/2);y++){ for (int x=0;x&lt;(width/2);x++){ matrix[y][x]=1; unitMax++; } for (int x=width/2;x&lt;width;x++){ matrix[y][x]=-1; unitMin++; } } for (int y=(height/2);y&lt;height;y++){ for (int x=0;x&lt;(width/2);x++){ matrix[y][x]=-1; unitMin++; } for (int x=width/2;x&lt;width;x++){ matrix[y][x]=1; unitMax++; } } break; } } } }</span></span></code> </pre> <br></div></div><br>  I did dynamic stuffing, and initialization, regardless of kernel size.  Now we will create a class of Convolution, in it we will do convolution <br><br><div class="spoiler">  <b class="spoiler_title">onvolution class</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.kuldiegor.recognize; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.awt.image.BufferedImage; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.ArrayList; <span class="hljs-comment"><span class="hljs-comment">/** * Created by aeterneus on 17.03.2017. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Convolution</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> ConvolutionCore convolutionCores[]; <span class="hljs-comment"><span class="hljs-comment">//  static { //    convolutionCores = new ConvolutionCore[6]; for (int i=0;i&lt;6;i++){ convolutionCores[i] = new ConvolutionCore(10,10,i); } } private int matrixx[][]; //   0 .. 255 public Convolution(BufferedImage image){ matrixx = getReadyMatrix(image); } private int[][] getReadyMatrix(BufferedImage bufferedImage){ //     int width = bufferedImage.getWidth(); int heigth = bufferedImage.getHeight(); int[] lineData = new int[width * heigth]; bufferedImage.getRaster().getPixels(0, 0, width, heigth, lineData); int[][] res = new int[heigth][width]; int shift = 0; for (int row = 0; row &lt; heigth; ++row) { System.arraycopy(lineData, shift, res[row], 0, width); shift += width; } return res; } private double[] ColapseMatrix(int[][] matrix,ConvolutionCore convolutionCore){ //     int cmh=convolutionCore.matrix.length; //   int cmw=convolutionCore.matrix[0].length; //   int mh=matrix.length; //   int mw=matrix[0].length; //   int addWidth = cmw - (mw%cmw); //      ,      int addHeight = cmh - (mh%cmh); int nmatrix[][]=new int[mh+addHeight][mw+addWidth]; for (int row = 0; row &lt; mh; row++) { System.arraycopy(matrix[row], 0, nmatrix[row], 0, mw); } int nw = nmatrix[0].length/cmw; int nh = nmatrix.length/cmh; double result[] = new double[nh*nw]; int dmin = -convolutionCore.unitMin*255; //   int dm = convolutionCore.unitMax*255-dmin; int q=0; for (int ny=0;ny&lt;nh;ny++){ for (int nx=0;nx&lt;nw;nx++){ int sum=0; for (int y=0;y&lt;cmh;y++){ for (int x=0;x&lt;cmw;x++){ sum += nmatrix[ny*cmh+y][nx*cmw+x]*convolutionCore.matrix[y][x]; } } result[q++]=((double)sum-dmin)/dm; } } return result; } public ArrayList&lt;double[]&gt; getConvolutionMatrix(){ //       ArrayList&lt;double[]&gt; result = new ArrayList&lt;&gt;(); for (int i=0;i&lt;convolutionCores.length;i++){ result.add(ColapseMatrix(matrixx,convolutionCores[i])); } return result; } }</span></span></code> </pre><br></div></div><br>  I will explain that in the class, in the static block, we load convolution kernels, since they are constant and do not change, and we will do a lot of bundles, initialize the kernels once and we will not do this anymore.  In the constructor we take a matrix of values ‚Äã‚Äãfrom the existing image, it is necessary to speed up the algorithm, so that we don‚Äôt take 1 pixel from the image each time, we will create a gray gradation matrix.  In the ColapseMatrix method at the entrance, we have an image matrix and a convolution kernel.  First, zeros are added to the end of the matrix in case the core does not align with the matrix.  Then we go through the kernel along the matrix and consider the convolution.  We save everything in an array.  We also need to store the convolutions of characters.  Therefore, we will create the hero class and add the following fields: <br><br><ol><li>  Array of convolutions; </li><li>  Character `s name; </li></ol><br><div class="spoiler">  <b class="spoiler_title">Hero class</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.kuldiegor.recognize; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.ArrayList; <span class="hljs-comment"><span class="hljs-comment">/** * Created by aeterneus on 17.03.2017. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Hero</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String name; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayList&lt;<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>[]&gt; convolutions; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Hero</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String Name)</span></span></span></span>{ name = Name; } }</code> </pre><br></div></div><br>  It is also necessary to load the convolutions samples, to compare the characters, create the class DefaultHero. <br><br><div class="spoiler">  <b class="spoiler_title">Class DefaultHero</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.kuldiegor.recognize; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.imageio.ImageIO; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.awt.image.BufferedImage; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.ArrayList; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Collections; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Comparator; <span class="hljs-comment"><span class="hljs-comment">/** * Created by aeterneus on 17.03.2017. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DefaultHero</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayList&lt;Hero&gt; heroes; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String path; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DefaultHero</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String path,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> tload)</span></span></span></span>{ heroes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.path = path; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (tload){ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:{ LoadFromFolder(path); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:{ LoadFromFile(path); } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadFromFolder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String path)</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">//        File folder = new File(path); File[] folderEntries = folder.listFiles(); for (File entry : folderEntries) { if (!entry.isDirectory()) { BufferedImage image = null; try { image = ImageIO.read(entry); } catch (IOException e) { e.printStackTrace(); } Hero hero = new Hero(StringTool.parse(entry.getName(),"",".png")); hero.convolutions = new Convolution(image).getConvolutionMatrix(); heroes.add(hero); } } } private void LoadFromFile(String name){ //     try { BufferedReader bufferedReader = new BufferedReader(new FileReader(name)); String str; while ((str = bufferedReader.readLine())!= null){ Hero hero =new Hero(StringTool.parse(str,"",":")); String s = StringTool.parse(str,":",""); String mas[] = s.split(";"); int n=mas.length/48; hero.convolutions = new ArrayList&lt;&gt;(n); for (int c=0;c&lt;n;c++) { double dmas[] = new double[48]; for (int i = 0; i &lt; 48; i++) { dmas[i] = Double.parseDouble(mas[i+c*48]); } hero.convolutions.add(dmas); } heroes.add(hero); } } catch (IOException e){ e.printStackTrace(); } } public void SaveToFile(String name){ //    Collections.sort(heroes, Comparator.comparing(o -&gt; o.name)); FileWriter fileWriter = null; try { fileWriter = new FileWriter(name); } catch (IOException e){ e.printStackTrace(); } for (int i=0;i&lt;heroes.size();i++){ Hero hero = heroes.get(i); StringBuilder stringBuilder = new StringBuilder(); stringBuilder.append(hero.name).append(":"); for (int i2=0;i2&lt;hero.convolutions.size();i2++){ double matrix[] = hero.convolutions.get(i2); for (int i3=0;i3&lt;matrix.length;i3++){ stringBuilder.append(matrix[i3]).append(";"); } } try { fileWriter.write(stringBuilder.append("\r\n").toString()); } catch (IOException e){ e.printStackTrace(); } } try { fileWriter.close(); } catch (IOException e){ e.printStackTrace(); } } public String getSearhHeroName(Hero hero){ //     for (int i=0;i&lt;heroes.size();i++){ if (equalsHero(hero,heroes.get(i))){ return heroes.get(i).name; } } return "0"; } public boolean equalsHero(Hero hero1,Hero hero2){ // 2  int min=0; int max=0; for (int i=0;i&lt;hero1.convolutions.size();i++){ double average=0; for (int i1=0;i1&lt;hero1.convolutions.get(i).length;i1++){ // 2    average += Math.abs(hero1.convolutions.get(i)[i1]-hero2.convolutions.get(i)[i1]); } average /=hero1.convolutions.get(0).length; if (average&lt;0.02){ //            min++; } else { max++; } } return (min&gt;=max); } }</span></span></code> </pre><br></div></div><br>  It's all very simple, run through all the convolutions and save them to a file.  Similarly, loading from a file.  Downloading from the catalog is different in that we consider the convolutions from the images that we will need when we accumulate a database of character images. <br><br>  Well, the comparison itself.  We consider the arithmetic mean of the difference between convolutions per core, if less than 0.02, then we assume that the images are similar, roughly speaking: ‚Äúif the images are similar to 98%, then we consider them the same‚Äù.  Then we assume that if at least half, or even more signs showed a positive result, then we indicate that the characters are equal. <br><br>  Now we will make a screenshot of the screen. <br><br><div class="spoiler">  <b class="spoiler_title">Screenshot code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  image = new Robot().createScreenCapture(new Rectangle(Toolkit.getDefaultToolkit().getScreenSize())); } catch (AWTException e) { e.printStackTrace(); }</span></span></code> </pre> <br></div></div><br>  In order not to look at the image of characters each time, we will immediately determine the boundaries of ten images.  Then copy ten images from the screenshot and convert them to grayscale.  In conclusion, we obtain a convolution of the image.  We do this with ten images.  And compare with the existing characters. <br><br><div class="spoiler">  <b class="spoiler_title">Class HRecognize</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.kuldiegor.recognize; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.awt.image.BufferedImage; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.ArrayList; <span class="hljs-comment"><span class="hljs-comment">/** * Created by aeterneus on 17.03.2017. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HRecognize</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DefaultHero defaultHero; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String heroes[]; <span class="hljs-comment"><span class="hljs-comment">//    public HRecognize(BufferedImage screen, DefaultHero defaultHero){ heroes = new String[10]; ArrayList&lt;Hero&gt; heroArrayList = new ArrayList&lt;&gt;(); this.defaultHero = defaultHero; for (int i=0;i&lt;5;i++){ //       BufferedImage bufferedImage = new BufferedImage(78,53,BufferedImage.TYPE_BYTE_GRAY); //    bufferedImage.getGraphics().drawImage(screen.getSubimage(43+i*96,6,78,53),0,0,null); Hero hero = new Hero(""); //  hero.convolutions = new Convolution(bufferedImage).getConvolutionMatrix(); heroArrayList.add(hero); } for (int i=0;i&lt;5;i++) { //       BufferedImage bufferedImage = new BufferedImage(78, 53, BufferedImage.TYPE_BYTE_GRAY); //    bufferedImage.getGraphics().drawImage(screen.getSubimage(777 + i * 96, 6, 78, 53), 0, 0, null); Hero hero = new Hero(""); //  hero.convolutions = new Convolution(bufferedImage).getConvolutionMatrix(); heroArrayList.add(hero); } for (int i=0;i&lt;10;i++){ //     heroes[i] = defaultHero.getSearhHeroName(heroArrayList.get(i)); } } }</span></span></code> </pre><br></div></div><br>  Now you need to accumulate a database of images.  I tried to take pictures with dotabuff, but there were images that were absolutely different from dota (vskih).  Therefore, it was decided to assemble them in semi-automatic mode.  Slightly rewriting the code for the convolution wizard, added the ‚ÄúMake Screenshot‚Äù button.  Comparison of convolutions occurs, each time, with loading of samples from the catalog, and if there are no samples, then save them to the catalog. <br><br>  <a href="https://github.com/aeterneus/Dota2HeroRecognizeMaster">Wizard convolutions on github</a> <br><br>  Go!  We start the pillbox in the lobby and in turn select all 113 characters. <br><br><div class="spoiler">  <b class="spoiler_title">Screenshot Lobby</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/361/d3f/e30/361d3fe300cd46d98c59caa28808fbbf.png" alt="image"><br></div></div><br>  Base accumulated.  Now you need to give a name to each character. <br><br><div class="spoiler">  <b class="spoiler_title">Screenshot of the directory with characters</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/e36/acb/73b/e36acb73b7fd422187919435f7967f4b.png" alt="image"><br></div></div><br>  And save all the convolutions to a file.  Now you can try to test the application. <br><br><div class="spoiler">  <b class="spoiler_title">Recognition Screenshot</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/f40/7e7/b41/f407e7b41e3847f4bb912c05bba959ef.png" alt="image"><br></div></div><br>  Recognition errors are not practical.  There is only one, when the game starts and around the black background the application reacts to this and gives out the character to Shadow Fiend, and when the choice of character comes, there are no errors.  It remains to send data about the recognized characters on the network to the Android application so as not to minimize the game every time. <br><br>  It's simple. <br><br><div class="spoiler">  <b class="spoiler_title">Broadcast Acceptance Code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { DatagramSocket socket = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DatagramSocket(<span class="hljs-number"><span class="hljs-number">6001</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> buffer[] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">1024</span></span>]; DatagramPacket packet = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DatagramPacket(buffer, <span class="hljs-number"><span class="hljs-number">1024</span></span>); InetAddress localIP= InetAddress.getLocalHost(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!Thread.currentThread().isInterrupted()) { <span class="hljs-comment"><span class="hljs-comment">//   socket.receive(packet); String s=new String(packet.getData(),0,packet.getLength()); if (StringTool.parse(s,"",":").equals("BroadCastFastDefinition")){ String str = "OK:"+localIP.getHostAddress(); byte buf[] = str.getBytes(); DatagramPacket p = new DatagramPacket(buf,buf.length,packet.getAddress(),6001); //     socket.send(p); } } }catch (Exception e) { e.printStackTrace(); }</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Code send data</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  Socket client = socket.accept(); final String ipclient = client.getInetAddress().getHostAddress(); Platform.runLater(new Runnable() { @Override public void run() { label1.setText(""); label1.setTextFill(Color.GREEN); textfield2.setText(ipclient); } }); DataOutputStream streamWriter = new DataOutputStream(client.getOutputStream()); BufferedImage image = null; while (client.isConnected()){ try { //  image = new Robot().createScreenCapture(new Rectangle(Toolkit.getDefaultToolkit().getScreenSize())); } catch (AWTException e) { e.printStackTrace(); } //  HRecognize hRecognize = new HRecognize(image,defaultHero); StringBuilder stringBuilder = new StringBuilder(); for (int i=0;i&lt;5;i++){ stringBuilder.append(hRecognize.heroes[i]).append(";"); } stringBuilder.append(":"); for (int i=5;i&lt;10;i++){ stringBuilder.append(hRecognize.heroes[i]).append(";"); } stringBuilder.append("\n"); String str = stringBuilder.toString(); //    streamWriter.writeUTF(str); try { Thread.sleep(300); } catch (InterruptedException e){ threadSocket.interrupt(); } } }catch (IOException e){ }</span></span></code> </pre> <br></div></div><br>  Accept the broadcast request.  We answer it, plus we additionally send your ip in the request, although it is not necessary, but let it be.  Then they open a tcp connection with us, and we start sending data every 300 milliseconds.  As soon as the connection fails, we stop recognizing characters.  I did this to reduce the CPU load.  When the game has already started, I just rip the connection on the client and the processor is no longer loaded. <br><br>  Android application.  I will not give the code here since this very simple application will tell you briefly how it works.  And I will give a link to GitHub. <br><br>  The application sends a broadcast request over the network (you can enter a specific ip address of the server) to determine the server part of the application.  As soon as a response comes from one of the servers, we connect to it and begin to receive data from it.  To define a counter-counterpart, I chose the site dotabuff.com.  I go through the list for each character and pull out the data "Strong against" and "Weak against" I am building a linked list.  Then I take the sent characters and display a list of all the characters who are weaker than the chosen five.  Along the way, checking that there were no characters in the list that ‚Äúcontrol‚Äù one of the five, that is, the characters in the list are absolutely weak against the five selected characters. <br><br><h2>  Unresolved Tasks </h2><br>  It works only at a resolution of 1280x1024, I have not tried it on other resolutions. <br><br><h2>  Conclusion </h2><br>  Recognition happens very quickly, the processor practically does not strain on my Lenovo B570e laptop with an Intel Celeron 1.5 GHz processor.  Load 6%, with the recognition cycle 3 times per second.  If the topic is interesting, I will tell you how I did the recognition of numbers on HealthBar (e), what difficulties I encountered, and how I solved them. <br><br>  Thank you all who read to the end. <br><br>  <b>PS</b> All references to the githab with the convolution wizard and the recognition program itself and the archive of images with convolution: <br><br>  ‚Üí <a href="https://github.com/aeterneus/Dota2HeroRecognizeMaster">GitHub link to wizard convolutions</a> <br>  ‚Üí <a href="https://github.com/aeterneus/Dota2HeroRecognize">GitHub link to the application itself</a> <br>  ‚Üí <a href="https://github.com/aeterneus/Dota2CounterPick">GitHub link for Android app</a> <br>  ‚Üí <a href="https://cloud.mail.ru/public/ANdj/CzJXiX8By">Link to archive with images</a> <br>  ‚Üí <a href="https://cloud.mail.ru/public/Hy1y/3dh2XgAy8">Link to convolution file</a> </div><p>Source: <a href="https://habr.com/ru/post/325526/">https://habr.com/ru/post/325526/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325514/index.html">Registration and authorization of the user on the site - one click - through the custom Facebook button. 2017</a></li>
<li><a href="../325516/index.html">Conference DUMP-2017: Section "Testing"</a></li>
<li><a href="../325518/index.html">Authenticating OAuth2 in-app using Google Sign-In. Continuous access to Google APIs</a></li>
<li><a href="../325522/index.html">Bash scripts: start</a></li>
<li><a href="../325524/index.html">Do new GitHub terms of use conflict with copyright?</a></li>
<li><a href="../325528/index.html">Kademlia (DHT) - A Practical Guide</a></li>
<li><a href="../325532/index.html">Top 8 new fintech applications of the beginning of 2017</a></li>
<li><a href="../325546/index.html">Setting up replication in FreeIPA 4.4 with domain level 1</a></li>
<li><a href="../325550/index.html">7 cases of using Big Data technologies in production</a></li>
<li><a href="../325552/index.html">How automatic testing is arranged in Mail.Ru Mail for iOS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>