<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Three interesting problems on SQL knowledge - Solutions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In my recent topic, I gave three interesting MySQL tasks in my opinion with a desire to look at possible solutions with habrami. As I promised, I give...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Three interesting problems on SQL knowledge - Solutions</h1><div class="post__text post__text-html js-mediator-article">  In my <a href="http://habrahabr.ru/blogs/mysql/70278/">recent topic,</a> I gave three interesting MySQL tasks in my opinion with a desire to look at possible solutions with habrami.  As I promised, I give my solutions to these problems.  In order for the text to be interesting and informative, I decided to thoroughly chew on what and why.  So‚Ä¶ <br><br><a name="habracut"></a><br><br>  First, go through the solutions that were proposed in the comments. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  1 task. </h5><br>  There was nothing complicated here, the moreover, there were few right decisions.  The most common mistake is that few people thought of considering the option when the category could not be published.  They came across with incorrect grouping or just gross syntax errors in the code.  There were solutions, after watching EXPLAIN which arose suicidal thoughts.  :-) <br><br>  But after correcting mistakes, many worked correctly, except for some "minor" sins. <br><br><h5>  2 task. </h5><br>  In fact, it turned out easier than I thought - but this is more my fault, because the condition was not sufficiently accurate, and no one could figure it out.  In the end, it turned into a trick to which no one paid attention.  The point is that the ordi field is responsible for sorting, but it was not clarified that it is unique (although there was no reverse either, and this is my fault, yes).  This field is indeed sorted, but for each affiliation there are different meanings, that is, if in one photo album there is 1,2,3, then in the other not 4,5,6 but also 1,2,3.  Because of this, half the decisions are both right and not at the same time. <br><br>  Of the errors, almost nowhere are there checks for the occurrence flags above.  Apart from this, almost everyone worked. <br><br>  If we take into account the conditions I have cited, then this task is quite complicated, namely, the request is very cumbersome.  Next stant is clear why. <br><br><h5>  3 task. </h5><br>  Solutions, as expected, were few.  Only <a href="http://habrahabr.ru/blogs/mysql/70278/">one thing</a> worked as it should - the proposed <a href="https://habrahabr.ru/users/pharod/" class="user_link">pharod</a> .  Because the task is really very difficult, and here it‚Äôs not the bulkiness of requests as in the second, but directly in the solution itself. <br><br><h4>  Now solutions. </h4><br>  To begin with, we will build a template query that will correctly take into account all the above conditions and select everything at all.  I always do this if the same data in the tables must be shown, but depending on certain external conditions.  Now it does not matter, I just want to clarify how I solve this step by step. <br><br>  We link all three tables in a single query by setting join conditions using JOIN ... ON (...).  It turns out about the following: <br><br><blockquote><code><font color="black"><font color="#0000ff">SELECT</font> <br> * <br> <font color="#0000ff">FROM</font> photo_category <font color="#0000ff">as</font> c <br> <font color="#0000ff">JOIN</font> photo_gallery <font color="#0000ff">as</font> g <font color="#0000ff">ON</font> (g.c_id=c.id <font color="#0000ff">AND</font> c.is_published <font color="#0000ff">AND</font> g.is_published) <br> <font color="#0000ff">JOIN</font> photo_image <font color="#0000ff">as</font> i <font color="#0000ff">ON</font> (i.g_id = g.id <font color="#0000ff">AND</font> i.is_published) <br> <font color="#0000ff">GROUP</font> <font color="#0000ff">BY</font> g.id <br> <font color="#0000ff">HAVING</font> <font color="#0000ff">COUNT</font> (i.id) &gt; 0 <br> <font color="#0000ff">ORDER</font> <font color="#0000ff">BY</font> c.ordi, g.ordi, i.ordi;</font> <br></code> </blockquote><br><br>  I am writing the conditions of joining in ON (...) so that it would be immediately clear what belongs to what and not to overload WHERE (in fact, one hell where they are written).  Grouping is needed to filter empty galleries and categories (for them the HAVING COUNT (i.id) condition will be NULL).  Sort by fields present. <br><br>  All initial conditions are fulfilled in this request, although this is not a solution at all.  We have made the preparation.  And now let's go. <br><br><h4>  Task one. </h4><br>  We take the original request, which already takes into account everything.  Add a condition of sampling by category ID and another JOIN table, taking into account the is_main_foto flag.  But since this may not be the case then we will make it LEFT JOIN: <br><br><blockquote> <code><font color="black"><font color="#0000ff">SELECT</font> <br> * <br> <font color="#0000ff">FROM</font> photo_category <font color="#0000ff">as</font> c <br> <font color="#0000ff">JOIN</font> photo_gallery <font color="#0000ff">as</font> g <font color="#0000ff">ON</font> (g.c_id=c.id <font color="#0000ff">AND</font> c.is_published <font color="#0000ff">AND</font> g.is_published) <br> <font color="#0000ff">JOIN</font> photo_image <font color="#0000ff">as</font> i <font color="#0000ff">ON</font> (i.g_id = g.id <font color="#0000ff">AND</font> i.is_published) <br> <font color="#0000ff">LEFT</font> <font color="#0000ff">JOIN</font> photo_image <font color="#0000ff">as</font> i2 <font color="#0000ff">ON</font> (i2.g_id = g.id <font color="#0000ff">AND</font> i2.is_main_foto) <br> <font color="#0000ff">WHERE</font> c.id = 1 <br> <font color="#0000ff">GROUP</font> <font color="#0000ff">BY</font> g.id <br> <font color="#0000ff">HAVING</font> <font color="#0000ff">COUNT</font> (i.id) &gt; 0 <br> <font color="#0000ff">ORDER</font> <font color="#0000ff">BY</font> c.ordi, g.ordi, i.ordi;</font> <br></code> </blockquote><br><br>  Now if the value of <i>im2.id IS NULL,</i> then in i.id absolutely any arbitrary photo will lie.  By the way, a normal DBMS in this case should swear because it will not be clear what value to take in <i>i</i> .  Now, for complete happiness, we write the answer using IF: <br><br><blockquote> <code><font color="black"><font color="#0000ff">SELECT</font> <br> c.id <font color="#0000ff">as</font> cid, <br> c.title <font color="#0000ff">as</font> ctitle, <br> g.id <font color="#0000ff">as</font> gid, <br> g.title <font color="#0000ff">as</font> gtitle, <br> <font color="#0000ff">IF</font> (i2.id <font color="#0000ff">IS</font> <font color="#0000ff">NULL</font> , i.id, i2.id) <font color="#0000ff">as</font> image_id <br> <font color="#0000ff">FROM</font> photo_category <font color="#0000ff">as</font> c <br> <font color="#0000ff">JOIN</font> photo_gallery <font color="#0000ff">as</font> g <font color="#0000ff">ON</font> (g.c_id=c.id <font color="#0000ff">AND</font> c.is_published <font color="#0000ff">AND</font> g.is_published) <br> <font color="#0000ff">JOIN</font> photo_image <font color="#0000ff">as</font> i <font color="#0000ff">ON</font> (i.g_id = g.id <font color="#0000ff">AND</font> i.is_published) <br> <font color="#0000ff">LEFT</font> <font color="#0000ff">JOIN</font> photo_image <font color="#0000ff">as</font> i2 <font color="#0000ff">ON</font> (i2.g_id = g.id <font color="#0000ff">AND</font> i2.is_main_foto) <br> <font color="#0000ff">WHERE</font> c.id = 1 <br> <font color="#0000ff">GROUP</font> <font color="#0000ff">BY</font> g.id <br> <font color="#0000ff">HAVING</font> <font color="#0000ff">COUNT</font> (i.id) &gt; 0 <br> <font color="#0000ff">ORDER</font> <font color="#0000ff">BY</font> c.ordi, g.ordi, i.ordi;</font> <br></code> </blockquote><br><br>  For those who do not know how IF works, I will explain - <i>IF (&lt;condition&gt;, &lt;expression value if true&gt;, &lt;expression value if false&gt;)</i> .  Trenarny operator practically. <br><br>  Everything, the problem is solved. <br><br><h5>  Task two. </h5><br>  The solution is not very difficult: you need to get the ORDI of the current element, then make MAX for satisfying the condition of the sample under the condition that the received ordi is less and thus get the previous one, then similarly - the next one.  If you do not go into details, then everything is quite simple, but if you go into it, you get quite complex queries. <br><br>  First we get the <i>ordi</i> (sort field) of the current element - it's very simple: <br><br><blockquote> <code><font color="black"><font color="#0000ff">SELECT</font> ordi <font color="#0000ff">FROM</font> photo_image <font color="#0000ff">WHERE</font> id = 1</font> <br></code> </blockquote><br><br>  Next, we will take into account what to look for if you enter only into the current gallery, that is, you must determine the id of the gallery (by condition it can be obtained from the outside, but for the sake of completeness, we calculate it ourselves): <br><br><blockquote> <code><font color="black"><font color="#0000ff">SELECT</font> g_id <font color="#0000ff">FROM</font> photo_image <font color="#0000ff">WHERE</font> id = 1</font> <br></code> </blockquote><br><br>  Now we will build a request for a previous ORDI (we are looking only for published ones): <br><br><blockquote> <code><font color="black"><font color="#0000ff">SELECT</font> <font color="#0000ff">MAX</font> (ordi) <font color="#0000ff">from</font> photo_image <br> <font color="#0000ff">WHERE</font> is_published <font color="#0000ff">AND</font> g_id = ( <font color="#0000ff">SELECT</font> g_id <font color="#0000ff">FROM</font> photo_image <font color="#0000ff">WHERE</font> id = 1) <br> <font color="#0000ff">AND</font> ordi &lt; ( <font color="#0000ff">SELECT</font> ordi <font color="#0000ff">FROM</font> photo_image <font color="#0000ff">WHERE</font> id = 1)</font> <br></code> </blockquote><br><br>  Similarly for the following: <br><br><blockquote> <code><font color="black"><font color="#0000ff">SELECT</font> <font color="#0000ff">MIN</font> (ordi) <font color="#0000ff">from</font> photo_image <br> <font color="#0000ff">WHERE</font> is_published <font color="#0000ff">AND</font> g_id = ( <font color="#0000ff">SELECT</font> g_id <font color="#0000ff">FROM</font> photo_image <font color="#0000ff">WHERE</font> id = 1) <br> <font color="#0000ff">AND</font> ordi &gt; ( <font color="#0000ff">SELECT</font> ordi <font color="#0000ff">FROM</font> photo_image <font color="#0000ff">WHERE</font> id = 1)</font> <br></code> </blockquote><br><br>  Now we know the ORDI of the following and previous ones, we need to get the ID of the corresponding elements, again, provided that we are only in the current gallery: <br><br><blockquote> <code><font color="black"><font color="#0000ff">SELECT</font> id, title <br> <font color="#0000ff">FROM</font> photo_image <br> <font color="#0000ff">WHERE</font> <br> g_id = ( <font color="#0000ff">SELECT</font> g_id <font color="#0000ff">FROM</font> photo_image <font color="#0000ff">WHERE</font> id = 1) <br> <br> <font color="#0000ff">AND</font> <br> ( <br> ordi = <br> ( <br> <font color="#0000ff">SELECT</font> <font color="#0000ff">MAX</font> (ordi) <font color="#0000ff">from</font> photo_image <br> <font color="#0000ff">WHERE</font> is_published <font color="#0000ff">AND</font> g_id = ( <font color="#0000ff">SELECT</font> g_id <font color="#0000ff">FROM</font> photo_image <font color="#0000ff">WHERE</font> id = 1) <br> <font color="#0000ff">AND</font> ordi &lt; ( <font color="#0000ff">SELECT</font> ordi <font color="#0000ff">FROM</font> photo_image <font color="#0000ff">WHERE</font> id = 1) <br> ) <br> <br> <font color="#0000ff">OR</font> <br> ordi = <br> <br> ( <br> <font color="#0000ff">SELECT</font> <font color="#0000ff">MIN</font> (ordi) <font color="#0000ff">from</font> photo_image <br> <font color="#0000ff">WHERE</font> is_published <font color="#0000ff">AND</font> g_id = ( <font color="#0000ff">SELECT</font> g_id <font color="#0000ff">FROM</font> photo_image <font color="#0000ff">WHERE</font> id = 1) <br> <font color="#0000ff">AND</font> ordi &gt; ( <font color="#0000ff">SELECT</font> ordi <font color="#0000ff">FROM</font> photo_image <font color="#0000ff">WHERE</font> id = 1) <br> ) <br> );</font> <br></code> </blockquote><br><br>  It seems to be everything, but we still have no condition checks.  And it is also not clear how to separate the following from the previous one if we have one result in the sample.  To solve this, we will add our photo to the sample (for which we calculate) and also use our ‚Äútemplate‚Äù query, and in the end we will get: <br><br><blockquote> <code><font color="black"><font color="#0000ff">SELECT</font> ordi, id, title <br> <font color="#0000ff">FROM</font> photo_image <br> <font color="#0000ff">WHERE</font> <br> <font color="#0000ff">EXISTS</font> <br> ( <br> <font color="#0000ff">SELECT</font> <br> i.id <br> <font color="#0000ff">FROM</font> photo_category <font color="#0000ff">as</font> c <br> <font color="#0000ff">JOIN</font> photo_gallery <font color="#0000ff">as</font> g <font color="#0000ff">ON</font> (g.c_id=c.id <font color="#0000ff">AND</font> c.is_published <font color="#0000ff">AND</font> g.is_published) <br> <font color="#0000ff">JOIN</font> photo_image <font color="#0000ff">as</font> i <font color="#0000ff">ON</font> (i.g_id = g.id <font color="#0000ff">AND</font> i.is_published) <br> <font color="#0000ff">WHERE</font> i.id = 1 <br> ) <br> <br> <font color="#0000ff">AND</font> <br> g_id = ( <font color="#0000ff">SELECT</font> g_id <font color="#0000ff">FROM</font> photo_image <font color="#0000ff">WHERE</font> id = 1) <br> <br> <font color="#0000ff">AND</font> <br> ( <br> ordi = <br> ( <br> <font color="#0000ff">SELECT</font> <font color="#0000ff">MAX</font> (ordi) <font color="#0000ff">from</font> photo_image <br> <font color="#0000ff">WHERE</font> is_published <font color="#0000ff">AND</font> g_id = ( <font color="#0000ff">SELECT</font> g_id <font color="#0000ff">FROM</font> photo_image <font color="#0000ff">WHERE</font> id = 1) <br> <font color="#0000ff">AND</font> ordi &lt; ( <font color="#0000ff">SELECT</font> ordi <font color="#0000ff">FROM</font> photo_image <font color="#0000ff">WHERE</font> id = 1) <br> ) <br> <br> <font color="#0000ff">OR</font> <br> ordi = <br> <br> ( <br> <font color="#0000ff">SELECT</font> <font color="#0000ff">MIN</font> (ordi) <font color="#0000ff">from</font> photo_image <br> <font color="#0000ff">WHERE</font> is_published <font color="#0000ff">AND</font> g_id = ( <font color="#0000ff">SELECT</font> g_id <font color="#0000ff">FROM</font> photo_image <font color="#0000ff">WHERE</font> id = 1) <br> <font color="#0000ff">AND</font> ordi &gt; ( <font color="#0000ff">SELECT</font> ordi <font color="#0000ff">FROM</font> photo_image <font color="#0000ff">WHERE</font> id = 1) <br> ) <br> <br> <font color="#0000ff">OR</font> <br> id = 1 <br> );</font> <br></code> </blockquote><br><br>  Condition <br><br><blockquote> <code><font color="black"><font color="#0000ff">EXISTS</font> <br> ( <br> <font color="#0000ff">SELECT</font> <br> i.id <br> <font color="#0000ff">FROM</font> photo_category <font color="#0000ff">as</font> c <br> <font color="#0000ff">JOIN</font> photo_gallery <font color="#0000ff">as</font> g <font color="#0000ff">ON</font> (g.c_id=c.id <font color="#0000ff">AND</font> c.is_published <font color="#0000ff">AND</font> g.is_published) <br> <font color="#0000ff">JOIN</font> photo_image <font color="#0000ff">as</font> i <font color="#0000ff">ON</font> (i.g_id = g.id <font color="#0000ff">AND</font> i.is_published) <br> <font color="#0000ff">WHERE</font> i.id = 1 <br> )</font> <br></code> </blockquote><br><br>  will remove everything from the selection if the current photo, gallery or category is not published.  There is no point in expressing HAVING and grouping here, since if there are no pictures in the gallery, then the selection will still be empty.  The result will be three, two or one row.  Accordingly, the desired photo will be the one that has the given ID and the previous one is determined based on the ordi - it is less or more than the one with the given ID. <br><br>  It seems that there are a lot of subqueries here and it will work slowly.  Actually, no - MySQL caches repeated zaryas (you can do SQL_CACHE for greater certainty), so each of the subqueries will be executed only 1 time.  Under the condition of the existence of indices (well, where without them) it will work quickly enough. <br><br>  Problem solved. <br><br>  Note: I said that I do not know how to solve this problem in one request.  This is so, because in reality I still needed to get a large pile of parameters for each photo, and if I did this by a request, it becomes just huge and really slows down.  Here is tezhe 2 requests (on the following and previous) truth with the general filter. <br><br><h5>  The third task. </h5><br>  The ambush is that you actually need to do LIMIT for a specific group.  You cannot do this as a normal limit, since it limits the result of the entire request and only that.  Combine UNION requests for each category using LIMIT ... - well, the solution is of course, but if there are a lot of categories?  Not okay.  The next thing that comes to mind is filtering with WHERE.  But then you need some kind of indication of what will be filtering, that is, you need to distinguish in the WHERE clause the rows that are more than our N.  Only by giving your serial number to a series of albums for each category.  How to make it?  Only with local variables.  I‚Äôm a little less than completely sure that this task and others like it are not solved in any other way. <br><br>  If we take the original query and modify it a bit, like this: <br><br><blockquote> <code><font color="black"><font color="#0000ff">SELECT</font> <br> @a:=@a+1, * <br> <font color="#0000ff">FROM</font> photo_category <font color="#0000ff">as</font> c <br> <font color="#0000ff">JOIN</font> photo_gallery <font color="#0000ff">as</font> g <font color="#0000ff">ON</font> (g.c_id=c.id <font color="#0000ff">AND</font> c.is_published <font color="#0000ff">AND</font> g.is_published) <br> <font color="#0000ff">JOIN</font> photo_image <font color="#0000ff">as</font> i <font color="#0000ff">ON</font> (i.g_id = g.id <font color="#0000ff">AND</font> i.is_published) <br> <font color="#0000ff">GROUP</font> <font color="#0000ff">BY</font> g.id <br> <font color="#0000ff">HAVING</font> <font color="#0000ff">COUNT</font> (i.id) &gt; 0 <br> <font color="#0000ff">ORDER</font> <font color="#0000ff">BY</font> c.ordi, g.ordi, i.ordi;</font> <br></code> </blockquote><br><br>  That will get the numbered rows.  For each row, the value of @a will increase by one.  Fine.  But we need to count all of a certain group, so, provided that c_id changes, you need to reset @a.  Let us introduce one more variable for this, and a reset condition (at the same time, instead of the asterisk, we add the fields we need): <br><br><blockquote> <code><font color="black"><font color="#0000ff">SELECT</font> <br> @a:=@a+1, <br> <font color="#0000ff">IF</font> (@cid=cid, @a:=@a+1, (@cid:=cid) <font color="#0000ff">AND</font> (@a:=1)), <br> c.id <font color="#0000ff">as</font> cid, c.title <font color="#0000ff">as</font> ctitle, <br> g.id <font color="#0000ff">as</font> gid, g.title <font color="#0000ff">as</font> gtitle, <br> <font color="#0000ff">FROM</font> photo_category <font color="#0000ff">as</font> c <br> <font color="#0000ff">JOIN</font> photo_gallery <font color="#0000ff">as</font> g <font color="#0000ff">ON</font> (g.c_id=c.id <font color="#0000ff">AND</font> c.is_published <font color="#0000ff">AND</font> g.is_published) <br> <font color="#0000ff">JOIN</font> photo_image <font color="#0000ff">as</font> i <font color="#0000ff">ON</font> (i.g_id = g.id <font color="#0000ff">AND</font> i.is_published) <br> <font color="#0000ff">GROUP</font> <font color="#0000ff">BY</font> g.id <br> <font color="#0000ff">HAVING</font> <font color="#0000ff">COUNT</font> (i.id) &gt; 0 <br> <font color="#0000ff">ORDER</font> <font color="#0000ff">BY</font> c.ordi, g.ordi, i.ordi;</font> <br></code> </blockquote><br><br>  What does it mean.  If the value of the variable <a href="https://habrahabr.ru/users/cid/" class="user_link">cid</a> is equal to the current id value of the category, then the variable @ a is incremented by 1, after which the result is equal to @a.  Otherwise, the value of <a href="https://habrahabr.ru/users/cid/" class="user_link">cid</a> becomes equal to the current id of the category, @a becomes equal to 1 and the result of the expression becomes = 1 (that is, the same @a, although in reality it is just a good match).  Now it would seem possible to just filter by the condition WHERE @a &lt;N but ... this will not work. <br><br>  And that's why.  This scheme will be executed correctly only if the rows are already sorted.  But sorting is done <b>after</b> the query has <b>been</b> processed, and not during.  It turns out that you need to first sort, and only then numbered. <br><br>  Now I also draw attention to the fact that, as I have already said, by a happy coincidence, the expression IF ( <a href="https://habrahabr.ru/users/cid/" class="user_link">cid</a> = cid, @a: = @ a + 1, ( <a href="https://habrahabr.ru/users/cid/" class="user_link">cid</a> : = cid) AND (@a: = 1)) will be equal @a in both cases.  Then it can be used by writing it directly in WHERE.  Let me remind you that by the condition it was necessary to show the picture, but this does not cause any problems, since we first execute the query and then we will only perform counting operations with filters.  Then this is what we get: <br><br><blockquote> <code><font color="black"><font color="#0000ff">SELECT</font> q.* <font color="#0000ff">FROM</font> <br> ( <br> <font color="#0000ff">SELECT</font> <font color="#008000">--    </font> <br> c.id <font color="#0000ff">as</font> cid, c.title <font color="#0000ff">as</font> ctitle, <br> g.id <font color="#0000ff">as</font> gid, g.title <font color="#0000ff">as</font> gtitle, <br> <font color="#0000ff">IF</font> (i2.title <font color="#0000ff">IS</font> <font color="#0000ff">NULL</font> , i.title, i2.title) <br> <font color="#0000ff">FROM</font> photo_category <font color="#0000ff">as</font> c <br> <font color="#0000ff">LEFT</font> <font color="#0000ff">JOIN</font> photo_gallery <font color="#0000ff">as</font> g <font color="#0000ff">ON</font> (g.c_id=c.id <font color="#0000ff">AND</font> c.is_published <font color="#0000ff">AND</font> g.is_published) <br> <font color="#0000ff">LEFT</font> <font color="#0000ff">JOIN</font> photo_image <font color="#0000ff">as</font> i <font color="#0000ff">ON</font> (i.g_id = g.id <font color="#0000ff">AND</font> i.is_published) <br> <font color="#0000ff">LEFT</font> <font color="#0000ff">JOIN</font> photo_image <font color="#0000ff">as</font> i2 <font color="#0000ff">ON</font> (i2.g_id = g.id <font color="#0000ff">AND</font> i2.is_main_foto) <br> <font color="#0000ff">GROUP</font> <font color="#0000ff">BY</font> g.id <br> <font color="#0000ff">HAVING</font> <font color="#0000ff">COUNT</font> (i.id) &gt; 0 <br> <font color="#0000ff">ORDER</font> <font color="#0000ff">BY</font> c.ordi, g.ordi <font color="#0000ff">DESC</font> <br> ) <font color="#0000ff">as</font> q <br> <font color="#0000ff">WHERE</font> <font color="#0000ff">IF</font> (@cid=q.cid, @a:=@a+1, (@cid:=q.cid) <font color="#0000ff">AND</font> (@a:=1)) &lt;= N;</font> <br></code> </blockquote><br><br>  This will already work properly.  Problem solved.  By the way, I'd note from myself - that local variables are a very strong thing with skillful use of them.  And yet - this request can be called a universal solution for many typical tasks of this kind: the last 5 added or best or purchased goods per category, 5 best articles for each user, 10 most bought books of each genre, and so on.  Because it doesn't matter what the subquery will be. <br><br>  Well, in general, that's all.  Thanks for attention.  I hope you were interested. <br><br>  PS: about the title of the gallery in the condition of the problem - well, of course it was a typo :-) Thanks to those who reported this, although I could not fix it on time. <br><br>  PS2: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> </div><p>Source: <a href="https://habr.com/ru/post/70479/">https://habr.com/ru/post/70479/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../70466/index.html">Registration of applications in the Palm App Catalog e-commerce beta</a></li>
<li><a href="../70467/index.html">Ways of student self-development - a look after graduation</a></li>
<li><a href="../70470/index.html">The difference between art and design</a></li>
<li><a href="../70474/index.html">Idea: ‚ÄúTag cloud‚Äù with an arbitrary choice (‚Äúcloud 2.0‚Äù :)</a></li>
<li><a href="../70475/index.html">Found use of three-symbol domain - short URL service</a></li>
<li><a href="../70481/index.html">MVC on iPhone: ‚ÄúThe Model‚Äù (Part 1)</a></li>
<li><a href="../70483/index.html">Habit, Habrahabr and Twitter</a></li>
<li><a href="../70484/index.html">Intel will support Silverlight on the Moblin platform</a></li>
<li><a href="../70485/index.html">VIP invitation to Google Developer Day 2009</a></li>
<li><a href="../70487/index.html">U3-X</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>