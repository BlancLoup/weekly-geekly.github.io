<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Our experience of participation in 10K Apart or how to shrink 40 KB of code in 10</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, Habr√© already wrote about the 10K Apart contest - competition for the best web application with a total volume of up to 10K, created ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Our experience of participation in 10K Apart or how to shrink 40 KB of code in 10</h1><div class="post__text post__text-html js-mediator-article">  Not so long ago, Habr√© already wrote about <a href="http://habrahabr.ru/blogs/webdev/100548/">the 10K Apart contest</a> - competition for the best web application with a total volume of up to 10K, created using only client technologies: (HTML, CSS, Javascript, SVG, etc.). <br><br><img src="http://10k.aneventapart.com/Uploads/177/Thumbnail2.png" alt="image"><br><br>  I want to introduce your attention to <a href="http://10k.aneventapart.com/entry/177">our work</a> for this contest, which we did in the evening with a <a href="https://habrahabr.ru/users/private_face/" class="user_link">private_face</a> in the evenings for two weeks: a <a href="http://ru.wikipedia.org/wiki/NetHack">dungeon-crawler</a> style adventure game called ‚ÄúFontanero‚Äù ( <i>Spanish</i> plumber). <br><a name="habracut"></a><br><ul><li>  Random connected generator. </li><li>  Disclosure of the map as it passes, the disclosure of rooms. </li><li>  13 monsters c primitive AI and the algorithm for finding the path. </li><li>  Food, drink, 4 different spellbooks: vision, heal, cure and genocide. </li><li>  The effects of poisoning and blinding. </li><li>  Mini-game with the rotation and repair of pipes </li><li>  And even a monstrous boss at the end. </li></ul><br>  All this variety in three files with a total weight of 10230 bytes.  If you ever find a 1.44MB diskette on the mezzanine, then you can write 144 such games to it. <br>  After we decided on the nature of the application (adventure), genre (dungeon crawler in the style of nethack) and the setting (the plumber goes down to the basement to fix the pipe and goes to hell), it‚Äôs time to figure out keep within 10K. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Zip </h4><br>  The first code sketches (card generator and playing field pattern) showed that 10K is not enough even for a third of the game.  It was necessary either to drop everything or to somehow increase the available space. <br><br>  As a low-level programmer, I was immediately very interested in the possibility of clamping js in a zip, in order to later unpack it at runtime.  My first thought was to write my own LZSS, but a little more simple idea was born a bit later: put js in PNG, because the data in it is compressed with the same zip.  (As it turned out later - we were <a href="http://blog.nihilogic.dk/2008/05/compression-using-canvas-and-png.html">not the first to whom this idea occurred</a> ). <br><br>  Having studied the technology, we checked the ability to load arbitrary code through the Canvas from the palette png, by encoding the symbols in one of the color components.  The test was successfully executed in all required browsers, including IE 9 preview (which now also supports Canvas).  It was a success.  The eight-bit palette can store 256 colors, but only characters with codes 32-94, and \ n (10) remained after the obfuscator.  Encoding them to 64 values, and not to 256, also gave significant savings (Strange, but png does not know how to compress the palette). <br><br>  Thus, the structure of our future application has become clear: an HTML uploader page with a script that restores javascript from PNG, which contains all the game logic, and also dynamically creates all the necessary HTML and CSS.  In the final version of the project, the loader occupied 850 bytes, including even alert (‚Äúno canvas‚Äù);  (You can not leave the users of old browsers in front of a white screen). <br><br><h4>  Obfuscation </h4><br>  Zip increased the actual amount of code we could afford, but this was still not enough.  Therefore, the next step in optimizing the size was the choice of obfuscator for JS. <br><br>  From the free solutions on the market, we chose between the yui compressor and the google closure compiler.  In the competition, of course, won the google closure compiler (hereinafter gcc), which, hand on heart, is by far the best in terms of compression, plus, it displays warnings, mostly useful. <br><br>  We used gcc in advanced mode, in which it throws out unused code, renames all identifiers to one-two-letter, rebuilds branching, inline functions, and in every possible way smokes code, in pursuit of saving bytes. <br><br>  However, even when using gcc in advanced mode, there is still room for optimization.  First, gcc is afraid of renaming fields with standard, in his opinion, names: <code>left, right, top, bottom, name, type, width, height</code> , etc. Therefore, we preprocess our code before running gcc by renaming such names ourselves.  Secondly, after obfuscation, a lot of frequently repeated words ‚Äúfunction‚Äù and ‚Äúthis‚Äù remain in the code.  To save money, we replaced their @ ‚Äã‚Äãand `characters.  At the same time, the loader grew a bit for reverse replacement: <code>replace(/@/g, 'function').replace(/\`/g. 'this')</code> and the code after such processing looked quite monstrous: <br> <code>;`.g=n;`.K=`.v=o;`.F=@(d){var c=`.e;</code>  , <br>  but it was worth it: in general, with each replacement it was a byte of 50. <br><br>  CSS compressed with the help of the yui compressor and enclosed the javascript directly at the end, after cutting the dots with commas before the closing brackets (60 bytes of savings!). <br><br>  When we were determined with the appearance of the game, our opinions diverged from <a href="https://habrahabr.ru/users/private_face/" class="user_link">private_face</a> .  I offered a classic 2D view: <br><img src="https://habrastorage.org/storage/habraeffect/95/51/9551fa564028cfa127b6e95825594963.png"><br><br>  Vova-2 insisted on an isometry of the following type: <br><img src="https://habrastorage.org/storage/habraeffect/a2/7e/a27e3b6f110fe419cdedeec4e84ea601.jpg"><br><br>  Therefore, then I, having scribbled a simple old-school render (everything was drawn with text inside the textarea tag), continued to write the game logic, and the map generator, and began to tinker with my isometry.  He did not yet know what surprise IE9 was preparing for him.  Ahahahahahahaha: (( <br><br><h4>  Isometric passion </h4><br>  <a href="https://habrahabr.ru/users/private_face/" class="user_link">private_face</a> : <blockquote>  The implementation of the isometry was assumed as follows: rectangular blocks with textures superimposed on them were translated into an isometric projection by the CSS transformations skew and scale, after which they were absolutely positioned at the right place. <br><img src="https://habrastorage.org/storage/habraeffect/62/0e/620e1cbb326a0cbab48b4f2d95d036e3.png"><br>  This solution required the creation of a separate DOM element for each tile, but it looked simpler and more compact (and, most importantly, more productive) than drawing on the canvas. <br>  In addition, the use of DOM elements made it possible not only to impose textures, but also to easily write <a href="">any text</a> on the walls, which could become a killer feature for our game. <br><br>  After some time, the prototype was ready.  Render turned out to be quite compact (all drawing was rendered in CSS, javascript only positioned blocks) <br>  and gave quite a good picture (although it significantly slowed down in Firefox 3.6): <br><img src="https://habrastorage.org/storage/habraeffect/82/05/8205bf450c367c7bc8e9f28863aba161.jpg"><br><br>  Life seemed beautiful and cloudless.  However, igniting the idea of ‚Äã‚Äãisometry, I forgot to do one important thing: to make sure that the CSS transformations are supported by the new Internet Explorer 9. This error cost me meaningless time spent and tons of innocently killed nerve cells in the final.  Because it turned out that the only option to implement the transformation in IE9 is the Matrix filter.  But the performance of such a decision was simply none. <br>  In general, the isometry had to be abandoned. <br></blockquote><br><h4>  Back to basics </h4><br>  After the failure of the 3D version, we decided to return to the simple tile version. <br><br>  All tiles were drawn in the usual GIMP and were combined into a PNG sprite with a 4-bit (16 colors) palette, after which the latter was clamped by the pngcrush utility with the -brute key. <br><br>  We managed to impart some volume to the picture by setting the box-shadow property of wall and floor tiles.  However, this unexpectedly negatively affected the performance of Internet Explorer 9, while other browsers worked at normal speed.  In order not to upset IE9 users with brakes, we had to add the option ‚ÄúEnable shadows‚Äù to the game interface, which is disabled by default in this browser.  Hopefully, the release of box-shadow performance in IE9 will be improved. <br><img src="https://habrastorage.org/storage/habraeffect/9a/a1/9aa102100139e36f48d4599b6be68d12.png"><br>  The transition to 2D had a good side: the total volume of the drawing code was significantly reduced compared to the isometric version, and we used the space we finally used to add a mini-game about repairing pipes to the gameplay. <br><br><h4>  Epilogue </h4><br>  This is a brief history of how we made this game.  Starting to work on this project, none of us had imagined that it would be so interesting - to work in strict constraints and saving precious bytes.  We got a huge amount of fun, and 10k did an excellent job with their task - reinspire the web. <br><br>  There are many other tasks left overboard of the narration that we had to solve during the work on this project.  Such, for example, as a compact level generation algorithm with connectivity testing, an ultracompact algorithm for moving monsters that could walk along the corridors and would not look too stupid. <br><br>  And at the end of this topic, I will cite once again a short list of optimizations that allowed us to cram almost 40K of code into 10K. <br>  CSS Optimization: <ol><li>  Wrapping CSS YUI Compressor into a string, adding the result to the original .js file. </li><li>  Remove optional semicolons at the end of each rule block. </li><li>  Inserting the resulting style line to JS (I mean, packing css + js in one archive block). </li></ol>  JS Optimization: <ol><li>  Before obfuscation: replacing fields with the names left, right, name, type, etc.  to others (since GCC does not rename them even in advanced mode). </li><li>  Obfuscating GCC code in advanced mode. </li><li>  After obfuscation: replacing the function and this keywords with single-letter abbreviations ('@' and '' '). </li><li>  <s>Encapsulation in a proton container.</s> Packaging in PNG. </li></ol>  Image optimization: <ol><li>  All images were stored in one sprite. </li><li>  The number of colors in the palette was limited to 16. </li><li>  After any change, the file was pinched by pngcrush with the -brute option to ensure the best compression. </li></ol><br>  <i>A small update:</i> Today, due to numerous requests, we fixed the display of the mini-game in the opera, although this is not in the requirements of the competition.  Patch on the way to 10K Apart. <br><br>  Thank you very much for your attention, we will be very happy if you rate <a href="http://10k.aneventapart.com/entry/177">our game on the contest page</a> . <br>  PS <a href="http://habrahabr.ru/blogs/crazydev/102534/">We press further, continued.</a> <br>  PPS Contest is over, thank you all! </div><p>Source: <a href="https://habr.com/ru/post/102153/">https://habr.com/ru/post/102153/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../102134/index.html">When is THEM cheaper?</a></li>
<li><a href="../102141/index.html">Re: Ways to evaluate employee performance</a></li>
<li><a href="../102142/index.html">Seven ways to increase your subscribers</a></li>
<li><a href="../102148/index.html">PS3 hacked and allows you to create / upload back-up games</a></li>
<li><a href="../102152/index.html">Created the first "probabilistic processor"</a></li>
<li><a href="../102156/index.html">Scientists have created an antenna implant</a></li>
<li><a href="../102157/index.html">Habrahabr vs Intel team: photo report</a></li>
<li><a href="../102159/index.html">35 lessons learned by age 35</a></li>
<li><a href="../102160/index.html">Eight most necessary features to be implemented in ¬µTorrent</a></li>
<li><a href="../102162/index.html">The next technological breakthrough is ‚ÄúVery Mass Medicine‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>