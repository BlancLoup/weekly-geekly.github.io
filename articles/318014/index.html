<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Huawei router + hypervisor in one package. Starting from scratch</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article will be useful to system administrators who plan to work with Huawei network equipment, as well as IT professionals who are faced with th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Huawei router + hypervisor in one package. Starting from scratch</h1><div class="post__text post__text-html js-mediator-article"><p>  This article will be useful to system administrators who plan to work with Huawei network equipment, as well as IT professionals who are faced with the task of developing their own solutions based on standard platforms.  It will provide a detailed description of device configuration via the command line (CLI). </p><br><p>  I received for testing and studying the product of Huawei Enterprise - Huawei AR169W-P-M9.  As follows from the description on the manufacturer‚Äôs website, this device combines a full range of services, including routing, switching, security, and wireless access, and also contains an open service platform (OSP, which is essentially an x86 computer) that can provide virtually any functionality available on the x86 platform. </p><a name="habracut"></a><br><p>  If you simplify everything, then this is a full-fledged enterprise-level router with an integrated hypervisor based on x86 architecture, and all this is the size of a thick book.  Consider the device closer.  The main characteristics of the manufacturer's website below. </p><br><img src="https://habrastorage.org/files/514/d64/322/514d64322c0043c79b4b363300fe0397.JPG"><br><p>  Pic1 </p><br><table cellpadding="2"><tbody><tr><td>  1 - USB port (host) </td><td>  2 - Bluetooth antenna </td></tr><tr><td>  3 - Two Wi-Fi antennas </td><td>  4 - Slot for additional.  Hard Drive (HDD 2.5 ‚Äù) </td></tr><tr><td>  5 - Console port </td><td>  6 - WAN 1GE Ethernet Port </td></tr><tr><td>  7 - WAN VDSL Port </td><td>  8 - LAN - 4-port switch GE thernet </td></tr><tr><td>  9 - Reset Reset Button </td><td>  10 - Connector for PoE power supply ports (100 W).  Not included. </td></tr><tr><td>  11 - Connector for a standard power supply (60 W) </td><td>  12 - Connector for fixing the power cable. </td></tr><tr><td>  13 - Three USB interfaces (host).  Output power of each 5 W. </td><td>  14 - VGA to connect the monitor. </td></tr><tr><td>  15 - HDMI video interface </td><td>  16 - Headphone Jack </td></tr><tr><td>  17 - microphone jack </td><td>  18 - RS485 / 232 interface </td></tr><tr><td>  19 - Interface for connecting a Bluetooth antenna </td><td>  20 - The name of the model. </td></tr><tr><td>  21 - Grounding Connector </td><td>  22 - Two Wi-Fi antennas </td></tr></tbody></table><br><p>  <strong>Data sheet</strong> </p><br><table cellpadding="2"><tbody><tr><td>  Core processor </td><td>  Dual-core, 1 GHz </td></tr><tr><td>  Main memory </td><td>  512 MB </td></tr><tr><td>  OSP system memory </td><td>  8 GB </td></tr><tr><td>  Flash main device </td><td>  512 MB </td></tr><tr><td>  Hard disk HDD OSP system (build in) </td><td>  64 GB </td></tr><tr><td>  OSP system processor </td><td>  Intel Atom 1.9 GHz 4 Core </td></tr><tr><td>  Dimensions (H x W x D) </td><td>  44.5 mm x 300 mm x 220 mm </td></tr><tr><td>  Wi-Fi </td><td>  802.11b / g / n + 802.11ac </td></tr><tr><td>  Service Forwarding Performance (IMIX) </td><td>  150 MB / s </td></tr><tr><td>  Weight </td><td>  2.8 kg. </td></tr><tr><td>  Nutrition </td><td>  100V - 240V </td></tr></tbody></table><br><p>  <strong>Router Features</strong> </p><br><table cellpadding="2"><tbody><tr><td>  Basic functionality </td><td>  ARP, DHCP, NAT, and Sub interface management </td></tr><tr><td>  WLAN (AP - FAT Access Point) </td><td>  AP management, WLAN QoS, WLAN security, WLAN radio management, and WLAN user management (WLAN models support WLAN AP features) </td></tr><tr><td>  WLAN (AC - Access Point Controller) </td><td>  AP management (AC discovery / AP access / AP management), CAPWAP, WLAN user management, WLAN radio management (802.11a / b / g / n), WLAN QoS (WMM), and WLAN security (WEP / WPA / WPA2 / Key management) </td></tr><tr><td>  LAN </td><td>  IEEE 802.1P, IEEE 802.1Q, IEEE 802.3, VLAN management, MAC address management, MSTP, etc. </td></tr><tr><td>  Ipv4 unicast routing </td><td>  Routing policy, static route, RIP, OSPF, IS-IS, and BGP </td></tr><tr><td>  Ipv6 unicast routing </td><td>  Routing policy, static route, RIPng, OSPFv3, IS-Isv6, and BGP4 + </td></tr><tr><td>  Multicast </td><td>  IGMP v1 / v2 / v3, PIM SM, PIM DM, and MSDP </td></tr><tr><td>  VPN </td><td>  IPSec VPN, GRE VPN, DSVPN, L2TP VPN, and Smart VPN </td></tr><tr><td>  QoS </td><td>  Diffserv mode, Priority mapping, traffic policing (CAR), traffic shaping, congestion avoidance (based on IP precedence / DSCP WRED), congestion management (LAN interface: SP / WRR / SP + WRR; WAN interface: PQ / CBWFQ), MQC (traffic classification, traffic behavior, and traffic policy), Hierarchical QoS, and Smart Application Control (SAC) </td></tr><tr><td>  Security </td><td>  ACL, firewall, 802.1x authentication, AAA authentication, RADIUS authentication, HWTACACS authentication, broadcast storm suppression, ARP security, ICMP attack defense, URPF, CPCAR, blacklist, IP source tracing, and PKI </td></tr><tr><td>  Management and Maintenance </td><td>  Upgrade management, device management, web-based GUI, GTL, SNMP v1 / v2c / v3, RMON, NTP, CWMP, Auto-Config, site deployment using USB disk, and CLI </td></tr></tbody></table><br><p>  The following operating systems can be installed on the OSP service module: </p><br><p>  ‚Ä¢ Windows Server 2003 32bit, <br>  ‚Ä¢ Windows Server 2008 R1 32bit, <br>  ‚Ä¢ Windows Server 2008 R2 64bit, <br>  ‚Ä¢ Windows 7 32bit sp1, <br>  ‚Ä¢ Windows 8.x <br>  ‚Ä¢ Red Hat Enterprise 6.5, <br>  ‚Ä¢ Red Hat Enterprise 7.0, <br>  ‚Ä¢ SUSE Enterprise 11 SP1, <br>  ‚Ä¢ Fedora Core 20, <br>  ‚Ä¢ Debian Wheezy. <br>  After a more detailed study of the device, I sketched the following block diagram of the device: </p><br><img src="https://habrastorage.org/files/5df/711/341/5df711341d4c42d48c9771b41acd3429.jpg"><br><p>  Pic2 </p><br><p>  As you can see, the device conventionally consists of two parts: </p><br><ul><li><p>  The MCU is the main device that is the Huawei AR Series router.  And as a matter of fact it is no different from it, all the functionality of routers of this series is available in this device. </p><br></li><li><p>  OSP - open system platform - is essentially an x86 computer on which the QEMU hypervisor is installed.  It communicates with the MCU through a virtual switch (vSwitch).  In the MCU command line, we will see the device as a separate interface (I tried to reflect this on the structural diagram as a separate link to the logical router).  Management of the hypervisor also comes from the command line of the router, which in my opinion is not very convenient, perhaps in the future this will change and it will be possible to configure OSP via the keyboard and monitor or via the WEB interface. </p><br></li><li><p>  Wi-Fi module (802.11b / g / n + 802.11ac) </p><br></li><li>  All possible ports for interacting with the outside world (described above). </li></ul><br><p>  In my practice, I often deal with Huawei network equipment, I think that I know its architecture, the VRP operating system and CLI quite well.  But when I found out about the existence of such a ‚Äúhybrid‚Äù, it became interesting to me - at what level does x86 and VRP integrate in it?  What will the hypervisor look like in terms of the router?  And what will the network resources of the router look like in terms of the x86 operating system installed on the service platform?  And interest, first of all, is connected with the opening options for solving various typical tasks - after all, in fact, almost everything is already in one box, for example, here are the use cases: </p><br><img src="https://habrastorage.org/files/fa2/ae7/e4f/fa2ae7e4f16b45f28a6df2e438174dc9.jpg"><br><p>  Fig.  3 </p><br><p>  Figure 3 shows the basic scheme for connecting an additional office to the main one.  A device in an additional office solves the problem of accessing the Internet, distributing Wi-Fi, providing IP telephony, switching four devices, and up to two servers for tasks that need to be solved locally. <br>  The second option: </p><br><img src="https://habrastorage.org/files/a8b/b11/880/a8bb1188005044a4afd22b7f36d4761a.jpg"><br><p>  Fig.  four </p><br><p> Solution for public transport.  The device will distribute the Internet to passengers, which it will receive via 3G / 4G, as well as broadcast advertising through the HDMI interface and the monitor and column connected to it.  Or, for example, determining the location by GPS, conduct a tour for passengers.  To do this, of course, the corresponding application must be running on the guest OS.  It is also worth noting that for this application it is more appropriate to use the industrial version of the AR 500 series, which is made in a special case that protects the device from shaking. </p><br><p>  I think that you can come up with many uses, these are the first options that came to my mind. </p><br><p>  <strong>Initial settings of the router.</strong> <br>  The default password for the console (console parameters are standard, as in Cisco: 9600baud, without parity): </p><br><p>  Username: admin <br>  Password: Admin @ huawei <br>  (In some early versions of VRP, the password may be Admin @ 123, but in newer versions, such as above). </p><br><p>  1) We set the IP address for VlanInterface1, in which by default are the ports of the LAN switch GE0-GE4, as well as the default route: </p><br><pre><code class="bash hljs">&lt;Huawei&gt;system-view Enter system view, <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> user view with Ctrl+Z. [Huawei]sysname AR169 [AR169]interface Vlanif1 [AR169-Vlanif1]ip address 172.31.31.77 255.255.255.0 [AR169-Vlanif1]quit [AR169]ip route-static 0.0.0.0 0.0.0.0 172.31.31.1</code> </pre> <br><p>  2) We configure SSH access to the device, having previously created the user and generated the rsa keys: </p><br><pre> <code class="bash hljs">[AR169]rsa <span class="hljs-built_in"><span class="hljs-built_in">local</span></span>-key-pair create The key name will be: Host RSA keys defined <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Host already exist. Confirm to replace them? (y/n):y The range of public key size is (512 ~ 2048). NOTES: If the key modulus is less than 2048, It will introduce potential security risks. Input the bits <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the modulus[default = 2048]: Generating keys... ...........................................................................................................................................+++ ....................+++ ..............................................++++++++ ................++++++++ [AR169]user-interface vty 0 4 [AR169-ui-vty0-4]authentication-mode aaa [AR169-ui-vty0-4]protocol inbound ssh [AR169-ui-vty0-4]quit [AR169]aaa [AR169-aaa]<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>-user user1 password irreversible-cipher Pa$<span class="hljs-variable"><span class="hljs-variable">$w0rd</span></span> [AR169-aaa]<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>-user user1 privilege level 15 [AR169-aaa]<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>-user user1 service-type ssh http terminal [AR169]ssh user user1 authentication-type password</code> </pre> <br><p>  3) Next, the optional item is the software update to the latest version.  Before you start working with any device, it is highly recommended that you upgrade to the latest software version. <br>  Check which version of the VRP software is currently on the router: </p><br><pre> <code class="bash hljs">[AR169]display version Huawei Versatile Routing Platform Software VRP (R) software, Version 5.160 (AR160 V200R007C00SPC600PWE) Copyright (C) 2011-2016 HUAWEI TECH CO., LTD Huawei AR169W-P-M9 Router uptime is 0 week, 0 day, 0 hour, 53 minutes MPU 0(Master) : uptime is 0 week, 0 day, 0 hour, 53 minutes SDRAM Memory Size : 512 M bytes Flash 0 Memory Size : 512 M bytes MPU version information : 1. PCB Version : ARSRU169AGW-L VER.D 2. MAB Version : 0 3. Board Type : AR169W-P-M9 4. CPLD0 Version : 0 5. BootROM Version : 1 SubBoard[1]: 1. PCB Version : AR-1OSPBT-D VER.B 2. Board Type : OSP-X86</code> </pre> <br><p>  As you can see, the VRP software version of this router is V200R007C00SPC600PWE.  You can conditionally decrypt as version 200, release 007, release number 00, service pack 600. The letters PWE mean Payload without encryption, which means that strong encryption with a long key above 56 bits is disabled in this software version.  If these letters are not in the software name, then the device will support strong encryption. </p><br><p>  At the time of this writing, the latest available version is V200R007C00SPC900, it can be found on <a href="http://e.huawei.com/en">the manufacturer‚Äôs website by</a> searching for the keywords ‚ÄúAR 169 OSP‚Äù: </p><br><img src="https://habrastorage.org/files/478/755/7a8/4787557a8e9a4d0d9abecb768379cf1f.JPG"><br><p><br>  If the file will not be available for download (icon in the form of a lock near the file name), then you should contact your partner through whom the equipment was purchased. <br>  Download the file with AR169-OSP-V200R007C00SPC900.cc and upload it to the TFTP server.  I use for this purpose free tftpd64 for Windows.  My tftp server is located on the same network as VLAN1 on the router.  The address of the tftp server is 172.31.31.250. </p><br><p>  Next, to download the file, you need to go into user mode (with triangular brackets) and give the command to download the file from the server tftp: <br><br></p><pre> <code class="bash hljs">&lt;AR169&gt;tftp 172.31.31.250 get AR169-OSP-V200R007C00SPC900.cc</code> </pre> <br><p>  The download of the file to the built-in flash-memory should begin.  After downloading, from the same mode, check the contents of the flash command dir and make sure that everything is downloaded. </p><br><p>  Further, so that the next time the device is rebooted, a new version of the software is loaded, in the same user mode you need to give a command with an explicit indication of this new file: </p><br><pre> <code class="bash hljs">&lt;AR169&gt;startup system-software flash:/AR169-OSP-V200R007C00SPC900.cc</code> </pre> <br><p>  Next, after rebooting, we‚Äôll make sure that the router has booted with the new V200R007C00SPC900 firmware version. </p><br><p>  4) We proceed to the creation of a virtual machine. </p><br><p>  A virtual machine is created in the CLI interface of the router in virtual-environment mode. <br>  First we will check if DHCP is enabled on the virtual interfaces GE0 / 0/5 and GE0 / 0/6 that connect the router and the OSP card. </p><br><p>  To do this, look at the configuration of the entire device: </p><br><pre> <code class="bash hljs">[AR169]display current-configuration ‚Ä¶ interface GigabitEthernet0/0/5 ip address 192.168.2.1 255.255.255.0 dhcp select interface <span class="hljs-comment"><span class="hljs-comment"># interface GigabitEthernet0/0/6 description VirtualPort ip address 192.168.3.1 255.255.255.0 dhcp select interface #</span></span></code> </pre> <br><p>  I cut the extra output, leaving only the output of the fifth and sixth interfaces.  As you can see, there is an enabled DHCP server here that will distribute IP addresses from the / 24 grids to these interfaces. </p><br><p>  In my case, this was configured by default, but if DHCP is not configured on these interfaces (at least it is written about this in the manual), you should enable it: </p><br><pre> <code class="bash hljs">[AR169]dhcp <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> [AR169]interface GigabitEthernet0/0/5 [AR169-GigabitEthernet0/0/5]dhcp select interface [AR169-GigabitEthernet0/0/5]quit [AR169]interface GigabitEthernet0/0/6 [AR169-GigabitEthernet0/0/6]dhcp select interface</code> </pre> <br><p>  Also at this stage, you can change the addresses of your virtual network, if these addresses do not suit you, in this case the network interface cards of virtual machines will be in the same address space GigabitEthernet0 / 0/5, i.e.  in this case, 192.168.2.0 / 24.  I will leave as is. </p><br><p>  Why do I need to distribute IP addresses to this interface? </p><br><p>  Below is a diagram of how the router (MCU) and x86 board (OSP) are interconnected: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/1af/0c7/68b/1af0c768bb7048338d9c90716ffad343.JPG"></div><br><p>  Fig.  five </p><br><p>  As can be seen in Figure 5, GE5 / 0/0/5 is the communication interface with the MCU and OSP, and the first DHCP-issued address will have to receive the br0 interface of the virtual switch.  Check what address you got from the Gi0 / 0/5 interface address pool: </p><br><pre> <code class="bash hljs">[AR169]display ip pool interface gigabitethernet0/0/5 used ----------------------------------------------------------------------------- Start End Total Used Idle(Expired) Conflict Disable ----------------------------------------------------------------------------- 192.168.2.1 192.168.2.254 253 1 252(0) 0 0 ----------------------------------------------------------------------------- Network section : ----------------------------------------------------------------------------- Index IP MAC Lease Status ----------------------------------------------------------------------------- 253 192.168.2.254 34a2-a2fc-edd8 36112 Used -----------------------------------------------------------------------------</code> </pre> <br><p>  Thus, the address 192.168.2.254 will be the main entry point into our virtual environment; it is this that needs to be addressed to switch to the virtual environment mode of the OSP card with the following command: </p><br><pre> <code class="bash hljs">[AR169]virtual-environment 192.168.2.254</code> </pre> <br><p>  In this mode, you will have to download the operating system image from a pre-raised ftp server, as well as create and launch a virtual machine. </p><br><p>  I picked up the FileZilla FTP server on the machine with the address 172.31.31.250 connected to the LAN switch of our device, i.e.  to VLAN1: </p><br><img src="https://habrastorage.org/files/99d/086/138/99d08613894943ee9c79daf7fd42e5f7.jpg"><br><p>  Pic.6 </p><br><p>  Important note.  In my case, the router is not the default gateway for the FTP server, so I manually registered a static route to the 192.168.2.0 / 24 network on the ftp server via 172.31.31.77. <br>  On the FTP server, user1 is connected to which a folder with a Windows 8.1 image is available - a file called win81.iso.  Download it to our virtual environment: </p><br><pre> <code class="bash hljs">[AR169]virtual-environment 192.168.2.254 [AR169-virtual-environment-192.168.2.254]download package win81.iso ftp ftp://172.31.31.250/win81.iso user user1 password cipher Enter Password(&lt;1-16&gt;): The download ratio is 100%. Info: Package downloading finished.</code> </pre> <br><p>  Next, create an empty 30GB virtual disk for a future operating system: </p><br><pre> <code class="bash hljs">[AR169-virtual-environment-192.168.2.254]blank-disk name disk1 size 30</code> </pre> <br><p>  We form an OVA-file from ISO with the parameters of our future virtual machine: </p><br><pre> <code class="bash hljs">[AR169-virtual-environment-192.168.2.254]ova file win81 iso win81.iso disk disk1 cpu 4 memory 2800 network-card 1 network-card-type virtio extend-description <span class="hljs-string"><span class="hljs-string">"-hdb /dev/external_disk"</span></span> Info: This operation will take several minutes, please <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span>....</code> </pre> <br><p>  Comments on the parameters of the ova file command: </p><br><p>  ‚Ä¢ The first parameter will be the name of the created ova-file without an extension, i.e.  win81; <br>  ‚Ä¢ Parameter iso - our win81.iso file that was downloaded earlier; <br>  ‚Ä¢ disk parameter - the name of the disk created by the blank-disk command, i.e.  disk1 <br>  ‚Ä¢ Cpu - specify the number of processors from 1 to 4. <br>  ‚Ä¢ Memory - the amount of RAM in gigabytes, in this case 2800 MB (if we use the extend-description in the previous command, then no more memory can be supplied). <br>  ‚Ä¢ Network-card - the number of network cards of the virtual machine, in this case 1. <br>  ‚Ä¢ Network-card-type - type of virtual card, three options are possible: e1000, rpl8139 and virtio.  The recommended type for Windows is e1000. <br>  ‚Ä¢ Extend-description - an important parameter that regulates the advanced settings of the virtual machine, such as an additional hard drive, serial interface, HDMI and Audio, as well as USB.  If you do not describe these parameters, the virtual machine "will not see" the additional hard disk, which can be installed in our device, etc. </p><br><p>  But there is an important limitation imposed by the device CLI - the entire command cannot be longer than 256 characters, and the USB or HDMI connection parameters exceed this limit. <br>  For this case, the manual describes how to create an OVA file off-line, that is, not on this device, but on your linux machine.  Here I will not give this description and I will use only one short parameter for connecting an external disk: "-hdb / dev / external_disk".  Also important note when </p><br><p>  And so, the ova-file is formed, you can proceed to the installation of a virtual machine from this assembly: </p><br><pre> <code class="bash hljs">[AR169-virtual-environment-192.168.2.254]install vm win81 package win81.ova Info: This operation will take several minutes, please <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span>..</code> </pre> <br><p>  The virtual machine is installed, then we go into the management mode of the virtual machine, we will write the port number (for example, 8) by which it will be available later in the VNC viewer: </p><br><pre> <code class="bash hljs">[AR169-virtual-environment-192.168.2.254]vm win81 [AR169-virtual-environment-vm-win81]vnc-server port 8 password cipher Enter Password(&lt;6-8&gt;): [AR169-virtual-environment-vm-win81]</code> </pre> <br><p>  Then you can activate and start the virtual machine: </p><br><pre> <code class="bash hljs">[AR169-virtual-environment-vm-win81]vm activate Info: VM activated successfully. [AR169-virtual-environment-vm-win81]vm start Info: VM started successfully.</code> </pre> <br><p>  Check the state of the virtual machine with the following command, and also remember the name of its virtual interface (veth), it will be useful to us in the next step: </p><br><pre> <code class="bash hljs">[AR169-virtual-environment-192.168.2.254]display vm win81 Name: win81 Status: running Package: win81.ova Auto-boot: <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> Exception-action: alarm Cpu-shared: Current: 0 1 2 3 Next: Cpu-mono: Current: Next: Storage-claimed: Current: Disk: disk1 Target: sda Size: 30720M Next: Memory: Current: 2800M Next: Cdrom: Current: Name: win81.iso Type: private Next: Veth: Current: Name: win81_eth1 Mac: 0a:0b:1b:ce:e9:17 Next:</code> </pre> <br><p>  From this output, you can see that the win81 virtual machine is in a neglected state, uses disk1 with a capacity of 30,720 MB as the main hard disk, 2800 MB of memory and its virtual network interface is called win81_eth.  The next step is to connect this interface with the routing system of the router itself: </p><br><p>  To do this, create a virtual interface veth2 for HostOS: </p><br><pre> <code class="bash hljs">[AR169-virtual-environment-192.168.2.254]veth veth2</code> </pre> <br><p>  ... and create a virtual link between HostOS and the Win81 virtual machine (see Figure 5): </p><br><pre> <code class="bash hljs">[AR169-virtual-environment-192.168.2.254]link veth veth2 to veth win81_eth1</code> </pre> <br><p>  Add the Host OS virtual interface to the vSwitch virtual switch: </p><br><pre> <code class="bash hljs">[AR169-virtual-environment-192.168.2.254]ovs bridge br0 [AR169-virtual-environment-ovs-br0]port veth2 link-type access [AR169-virtual-environment-ovs-br0]quit</code> </pre> <br><p>  All work on creating a virtual machine has been completed, you can proceed to its installation and work directly with it.  For this, we will use the free VNC Viewer, having previously downloaded it from the developer‚Äôs website (RealVNC). </p><br><p>  As the address, we specify our virtual interface 192.168.2.254:8 - and port 8, which we configured a little higher.  In the connection settings, in the Expert section you should make sure the parameter FullColor = true, otherwise nothing will not work: </p><br><img src="https://habrastorage.org/files/d1c/8f8/fb9/d1c8f8fb9697438f8793bc7ed1523867.JPG"><br><p>  Fig.  7 </p><br><p>  Enter the password that we set in the vnc-server command and we see the initial screen for installing our guest operating system, in this case Windows 8.1: </p><br><img src="https://habrastorage.org/files/a3a/f3c/edb/a3af3cedb6f742fea78905656639ffc8.JPG"><br><p>  Fig.  eight. </p><br><p>  The process of installing Windows is no different than usual, so I‚Äôll skip this point, we‚Äôll assume that Windows was successfully installed and running.  Immediately check that we have the network settings: </p><br><img src="https://habrastorage.org/files/1ed/574/275/1ed574275bfa40aeb96ddb0b94375049.JPG"><br><p>  Fig.  9 </p><br><p>  As you can see, DHCP has issued the address 192.168.2.253 and we can ping the gateway 192.168.2.1.  Thus, the network card was established normally and the virtual machine interacts with the router.  It remains to release the virtual machine to the Internet (configure NAT on the router) and, for example, ‚Äúpush‚Äù the port outside for RDP access to the virtual machine (in this case, it is highly desirable to configure a static address from the 192.168.2.0/24 network card of the virtual machine rather than leaving it dynamic): </p><br><p>  Create an Access-list to filter the hosts that need to provide Internet access, in this case the entire network 192.168.2.0 / 24: </p><br><pre> <code class="bash hljs">[AR169]acl number 2001 [AR169-acl-basic-2001] rule permit <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> 192.168.2.0 0.0.0.255 [AR169-acl-basic-2001]quit</code> </pre> <br><p>  We connect the cable from the provider to the GigabitEthernet0 / 0/4 (WAN) interface, let us be allocated the static address 195.19.XX.XX, the default gateway is 195.19.XX.1: </p><br><pre> <code class="bash hljs">[AR169]interface GigabitEthernet0/0/4 [AR169-GigabitEthernet0/0/4]ip address 195.19.XX.XX 255.255.255.224 [AR169-GigabitEthernet0/0/4] nat outbound 2001</code> </pre> <br><p>  Let's translate the port from the external 33389 to the internal 3389 host of our virtual machine 192.168.2.254 </p><br><pre> <code class="bash hljs">[AR169-GigabitEthernet0/0/4] nat server protocol tcp global current-interface 33389 inside 192.168.2.253 3389 [AR169-GigabitEthernet0/0/4]quit</code> </pre> <br><p>  Set the default route to the Internet: </p><br><pre> <code class="bash hljs">[AR169] ip route-static 0.0.0.0 0.0.0.0 195.19.XX.1</code> </pre> <br><p>  Be sure to save the configuration: </p><br><pre> <code class="bash hljs">[AR169]save Warning: The current configuration will be written to the device. Are you sure to <span class="hljs-built_in"><span class="hljs-built_in">continue</span></span>?[Y/N]:Y It will take several minutes to save configuration file, please <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span>........... Configuration file had been saved successfully Note: The configuration file will take effect after being activated</code> </pre> <br><p>  At this basic settings can be considered complete, one virtual machine was raised from the Windows 8.1 guest OS, the device software was updated, Internet access was made and the port was broadcast outside to access the OS using RDP. </p><p></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/318014/">https://habr.com/ru/post/318014/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318004/index.html">Balancing outgoing calls via GSM gateway</a></li>
<li><a href="../318006/index.html">Development and publication of the first game for Android on Unity3D</a></li>
<li><a href="../318008/index.html">PHP 7 performance improvement</a></li>
<li><a href="../318010/index.html">Hello dear Megaphone</a></li>
<li><a href="../318012/index.html">Intel Software Guard Extensions tutorial. Part 3, Design for Intel SGX</a></li>
<li><a href="../318016/index.html">Consumer psychology - free book and lecture with HSE</a></li>
<li><a href="../318018/index.html">Entertaining tasks and an excerpt from the book "Career Programmer"</a></li>
<li><a href="../318020/index.html">How not to write too much. No magic</a></li>
<li><a href="../318022/index.html">Calendar functions in MySQL and MariaDB</a></li>
<li><a href="../318024/index.html">Interface designer on Habr√© - the results of my first year</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>