<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple publication of geodata on your own map based on 2GIS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I faced an interesting task - to display a map on the site, with various objects, and these objects can be dozens and hundreds, and any belo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple publication of geodata on your own map based on 2GIS</h1><div class="post__text post__text-html js-mediator-article">  Recently, I faced an interesting task - to display a map on the site, with various objects, and these objects can be dozens and hundreds, and any below-middle manager should be able to manage them. <br><br>  More formally, the task was to enable users to set a certain list of geo-objects, give them the ability to easily and quickly manage these objects and automatically display these objects on a certain map. <br><br>  To implement the idea, a bunch of Google Docs and 2GIS map service API were chosen.  The solution turned out really simple, in the spirit of the famous "30 lines" :) <br><a name="habracut"></a><br><h5>  Step 1. Create a table for the data. </h5><br>  Open Google Docs and create a table.  In my table there were quite a few unnecessary fields for me, but very necessary for other services, so I‚Äôll go for a little trick and I‚Äôll have a separate one for testing. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Here is a link to it: <a href="https://docs.google.com/spreadsheet/ccc%3Fkey%3D0AvdXWIJtCGnndG0tODY5MzRsVFhnbkJseFk0aWJkaUE%26usp%3Dsharing">docs.google.com/spreadsheet/ccc?key=0AvdXWIJtCGnndG0tODY5MzRsVFhnbkJseFk0aWJkaUE&amp;usp=sharing</a> <br><br>  As test data, I took the addresses of houses belonging to two small polling stations in the city of Kostroma.  Site number, street, house number and number of apartments. <br><br>  Using Google Drive as a data source removes many problems with the collaboration of specialists of different degrees of training and with prompt data updates. <br><br>  Now the table needs to be published.  To do this, go to the menu "File - Publish on the Internet."  In the window that appears, select "Start publication", in the lower part - select "CSV (values ‚Äã‚Äãseparated by commas)" and get a link to our worksheet as a CSV. <br><br>  It turns out this link: <a href="https://docs.google.com/spreadsheet/pub%3Fkey%3D0AvdXWIJtCGnndG0tODY5MzRsVFhnbkJseFk0aWJkaUE%26single%3Dtrue%26gid%3D0%26output%3Dcsv">docs.google.com/spreadsheet/pub?key=0AvdXWIJtCGnndG0tODY5MzRsVFhnbkJseFk0aWJkaUE&amp;single=true&amp;gid=0&amp;output=csv</a> <br><br><h5>  Step 2. Prepare the data for the map. </h5><br>  Let's write a simple PHP script and call it getMapData.php: <br><pre><code class="php hljs">define(<span class="hljs-string"><span class="hljs-string">'CSV_DATA_URL'</span></span>, <span class="hljs-string"><span class="hljs-string">'https://docs.google.com/spreadsheet/pub?key=0AvdXWIJtCGnndG0tODY5MzRsVFhnbkJseFk0aWJkaUE&amp;single=true&amp;gid=0&amp;output=csv'</span></span>); define(<span class="hljs-string"><span class="hljs-string">'DEFAULT_CITY'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); $points = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); $csvDataHandle = fopen(CSV_DATA_URL, <span class="hljs-string"><span class="hljs-string">'r'</span></span>); $i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> !== ($line = fgetcsv($csvDataHandle, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-string"><span class="hljs-string">','</span></span>, <span class="hljs-string"><span class="hljs-string">'"'</span></span>)) ) { <span class="hljs-comment"><span class="hljs-comment">//      if ( !$i++ ) continue; //    if ( !empty($line[0]) ) $zone = $line[0]; $points[] = array( 'zone' =&gt; $zone, 'address' =&gt; DEFAULT_CITY . ', ' . $line[1] . ', ' . $line[2], 'data' =&gt; $line[3], ); }</span></span></code> </pre> <br>  Here it should be noted that most likely when you first start you will get the error "Warning: fopen (): Unable to find the wrapper" https ".  This is due to the fact that in the default PHP installation, the OpenSSL module is not included.  Find the line in the php.ini file <br>  <code>;extension=php_openssl.so</code> and uncomment it by removing the semicolon.  This is usually enough. <br><br>  Of course, the $ points array needs to be cached somewhere, so as not to ‚Äújerk‚Äù Google Docs every time a map is drawn. <br><br>  Now we have the next task.  It is necessary to translate the addresses of geo objects into coordinates on the map.  For this, 2GIS has a corresponding API: <a href="http://api.2gis.ru/doc/geo/search/">api.2gis.ru/doc/geo/search</a> <br><br>  Here is the simplest code for working with the geocoder API: <br><pre> <code class="php hljs">define(<span class="hljs-string"><span class="hljs-string">'DGIS_API_KEY'</span></span>, <span class="hljs-string"><span class="hljs-string">'XXXXXX'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   define('DGIS_API_URL', 'http://catalog.api.2gis.ru/geo/search?version=1.3&amp;key=' . DGIS_API_KEY . '&amp;q=%s'); function getGeoObjectInfo($address) { $url = sprintf(DGIS_API_URL, $address); $response = json_decode(file_get_contents($url)); if ( $response-&gt;response_code == 200 ) { //    $coords = $response-&gt;result[0]-&gt;centroid; //  ,       $coords = explode(',', preg_replace('/^POINT\(([\S]+)([\s]+)([\S]+)\)$/', '$1,$3', $coords)); } else $coords = array(); return $coords; }</span></span></code> </pre><br>  Finally, let's go over the $ points array by our ‚Äúgeocoder‚Äù and display the result in JSON format: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ( $points <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> &amp;$address ) { $address[<span class="hljs-string"><span class="hljs-string">'coords'</span></span>] = getGeoObjectInfo($address[<span class="hljs-string"><span class="hljs-string">'address'</span></span>]); sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> json_encode($points);</code> </pre><br>  Pay attention to the strange line sleep (1);  in the code.  The fact is that I use test access to the API 2GIS, and with it the frequency of requests is limited to one per second.  After gaining full access, this line must, of course, be removed. <br><br>  Well, do not forget again to cache the data, so as not to create an extra load for 2GIS, and for yourself - too much script time. <br><br><h5>  Step 3. Show the map. </h5><br>  Here I will give the full code page.  There is nothing complicated in it, especially since 2GIS has good documentation, you can read it at <a href="http://api.2gis.ru/doc/maps/info/">api.2gis.ru/doc/maps/info</a> <br><br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://maps.api.2gis.ru/1.0?loadByRequire=1"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DGMap"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"width:100%; height:600px"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> $(DG.load(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">//   var map = new DG.Map('DGMap'); map.setCenter(new DG.GeoPoint(40.95,57.76),12); map.controls.add(new DG.Controls.Zoom()); //   $.get('getMapData.php', function (data) { var objects = JSON.parse(data); for ( i in objects ) { var marker = new DG.Markers.MarkerWithBalloon({ geoPoint: new DG.GeoPoint(objects[i].coords[0], objects[i].coords[1]), balloonOptions: { headerContentHtml: '&lt;b&gt; ‚Ññ'+objects[i].zone+'&lt;/b&gt;', contentHtml: ':'+objects[i].address+'&lt;br /&gt; :'+objects[i].data } }); map.markers.add(marker); } //      : var markersBounds = map.markers.getBounds(); //      : map.setBounds(markersBounds); }); })); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  On this, in fact, everything.  We got a simple but functional system that displays objects on a map according to the list in Google Docs.  Here is a mash-up :) <br><br><h5>  PS </h5><br>  I do not give the link to the turned-out card because I am afraid for the server which can easily lie under a habraeffekt.  But I can not insert a picture: <br><img src="https://habrastorage.org/getpro/habr/post_images/472/7fa/336/4727fa3361919d4edffea736d295b0d4.png"><br><br><h5>  Pps </h5><br>  Actually, nothing prevents to do the same ‚Äútrick‚Äù with the cards, for example, from Yandex.  It will turn out even more beautiful, due to the set of built-in styles and clustering technology of markers on the map.  Initially, I went this way, but the tests showed that the 2GIS geocoder is still much more accurate.  Yandex copes with obtaining coordinates from about 95% of the addresses, provided that they are thoroughly prepared, 2GIS - almost all 100%. </div><p>Source: <a href="https://habr.com/ru/post/204228/">https://habr.com/ru/post/204228/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../204216/index.html">RAD Studio XE5 for effective programming training</a></li>
<li><a href="../204218/index.html">MNP - what do we have today?</a></li>
<li><a href="../204220/index.html">Computer design of new materials</a></li>
<li><a href="../204224/index.html">Yandex.Tank and load testing automation</a></li>
<li><a href="../204226/index.html">Nokia: Connecting Planets</a></li>
<li><a href="../204230/index.html">Winners of WEB READY 2013</a></li>
<li><a href="../204234/index.html">Is it worth optimizing image processing in C ++ using SIMD?</a></li>
<li><a href="../204236/index.html">OpenVX: computer vision standard</a></li>
<li><a href="../204238/index.html">60 FPS? Easy! pointer-events: none!</a></li>
<li><a href="../204240/index.html">Introduction to Veritas Volume Manager</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>