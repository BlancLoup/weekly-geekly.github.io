<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ASP.NET MVC Lesson A. Notification and Distribution</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The purpose of the lesson Understand the sending of letters and confirming SMS. MailNotify, use configuration file. Mailing through the creation of a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ASP.NET MVC Lesson A. Notification and Distribution</h1><div class="post__text post__text-html js-mediator-article">  <b>The purpose of the lesson</b> Understand the sending of letters and confirming SMS.  MailNotify, use configuration file.  Mailing through the creation of a separate stream. <br><br><h5>  SmtpClient and MailNotify </h5><br>  When developing a website, we sooner or later encounter interaction with e-mail, whether it is user activation, a reminder or resetting a password, or creating a newsletter. <br>  Let us define what we need for this: <br><ul><li>  The class that will send letters </li><li>  Smtp configuration is taken from iConfig </li><li>  Mail sending errors are logged. </li><li>  The presence of the parameter that turns off the work of the mail, so that when working with the combat base of customers, do not send out some trash. </li></ul><br><br><a name="habracut"></a><br>  Create a static class, let's call it MailSender (/Tools/Mail/MailSender.cs): <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MailSender</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IConfig _config; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IConfig Config { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_config == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { _config = (DependencyResolver.Current).GetService&lt;IConfig&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _config; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> NLog.Logger logger = NLog.LogManager.GetCurrentClassLogger(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendMail</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> email, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> subject, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> body, MailAddress mailAddress = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Config.EnableMail) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mailAddress == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { mailAddress = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MailAddress(Config.MailSetting.SmtpReply, Config.MailSetting.SmtpUser); } MailMessage message = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MailMessage( mailAddress, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MailAddress(email)) { Subject = subject, BodyEncoding = Encoding.UTF8, Body = body, IsBodyHtml = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, SubjectEncoding = Encoding.UTF8 }; SmtpClient client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SmtpClient { Host = Config.MailSetting.SmtpServer, Port = Config.MailSetting.SmtpPort, UseDefaultCredentials = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, EnableSsl = Config.MailSetting.EnableSsl, Credentials = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NetworkCredential(Config.MailSetting.SmtpUserName, Config.MailSetting.SmtpPassword), DeliveryMethod = SmtpDeliveryMethod.Network }; client.Send(message); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { logger.Debug(<span class="hljs-string"><span class="hljs-string">"Email : {0} {1} \t Subject: {2} {3} Body: {4}"</span></span>, email, Environment.NewLine, subject, Environment.NewLine, body); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { logger.Error(<span class="hljs-string"><span class="hljs-string">"Mail send exception"</span></span>, ex.Message); } } }</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Consider more: <br><ul><li>  By necessity, IConfig of DependencyResolver is statically initialized. </li><li>  If the EnableMain flag is set, then we start work with the mail, otherwise just write the letter to the log file </li><li>  If MailAddress is not specified, then it is initialized according to the data from the config </li><li>  SmtpClient is initialized according to the data from the config </li><li>  Letter body - html </li><li>  Encoding - UTF8 </li><li>  If an error occurred while sending, then we write Exception.Message to the log (here you can collect more information, but there is no need for now). </li></ul><br><br>  Consider the mailing list of letters on the template.  Create a class (also static) NotifyMail (/Tools/Mail/NotifyMail.cs): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">NotifyMail</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> NLog.Logger logger = NLog.LogManager.GetCurrentClassLogger(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IConfig _config; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IConfig Config { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_config == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { _config = (DependencyResolver.Current).GetService&lt;IConfig&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _config; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendNotify</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> templateName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> email, Func&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; subject, Func&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; body</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> template = Config.MailTemplates.FirstOrDefault(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Name, templateName, <span class="hljs-literal"><span class="hljs-literal">true</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (template == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { logger.Error(<span class="hljs-string"><span class="hljs-string">"Can't find template ("</span></span> + templateName + <span class="hljs-string"><span class="hljs-string">")"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { MailSender.SendMail(email, subject.Invoke(template.Subject), body.Invoke(template.Template)); } } }</code> </pre><br><br>  Similarly, we get the config.  When sending out, we specify for it, and then use Func &lt;string, string&gt; to form the subject and body of the letter. <br><br>  Notify the user about the registration using the Register template from Web.config: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Register"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">subject</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"  {0}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">template</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"! &lt;br/&gt;&lt;br/&gt;    &lt;a href='http://{1}/User/Activate/{0}'&gt;http://{1}/User/Activate/{0}&lt;/a&gt;,     .&lt;br/&gt;-----&lt;br/&gt; ,  &lt;a href='http://{1}'&gt;{1}&lt;/a&gt;"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br><br>  Note how it is necessary to screen html-tags to properly make a template.  It is necessary to take into account the relationship between the template for string.Format () and the number of parameters.  When registering in UserController.cs, add (/Areas/Default/Controllers/UserController.cs:Register): <br><pre> <code class="cs hljs">Repository.CreateUser(user); NotifyMail.SendNotify(<span class="hljs-string"><span class="hljs-string">"Register"</span></span>, user.Email, subject =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(subject, HostName), body =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(body, <span class="hljs-string"><span class="hljs-string">""</span></span>, HostName)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>);</code> </pre><br><br>  HostName we added in BaseController initialization (/Controllers/BaseController.cs): <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> HostName = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Initialize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">System.Web.Routing.RequestContext requestContext</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (requestContext.HttpContext.Request.Url != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { HostName = requestContext.HttpContext.Request.Url.Authority; } ‚Ä¶</code> </pre><br>  We register, and a letter arrives in our mail: <br><br><img src="https://habrastorage.org/storage2/61b/81c/de6/61b81cde66bd20b1bfc23cf560fcc1d4.jpg"><br><br><h5>  More difficult case </h5><br>  All this is good, but if we need a newsletter with a bunch of promotional offers, then this format does not suit us.  Firstly, it is difficult to set a similar template in Web.config, and secondly, the number of parameters is not known.  As well as usual html-templates, it would be wonderful to set a letter template in View.  Well, consider the ActionMailer library ( <a href="http://nuget.org/packages/ActionMailer">http://nuget.org/packages/ActionMailer</a> ): <br><br><pre> <code class="bash hljs">PM&gt; Install-Package ActionMailer Successfully installed <span class="hljs-string"><span class="hljs-string">'ActionMailer 0.7.4'</span></span>. Successfully added <span class="hljs-string"><span class="hljs-string">'ActionMailer 0.7.4'</span></span> to LessonProject.Model.</code> </pre><br><br>  We inherit MailController from MailerBase: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MailController</span></span> : <span class="hljs-title"><span class="hljs-title">MailerBase</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> EmailResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Subscription</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> message, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> email</span></span></span><span class="hljs-function">)</span></span> { To.Add(email); Subject = <span class="hljs-string"><span class="hljs-string">""</span></span>; MessageEncoding = Encoding.UTF8; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Email(<span class="hljs-string"><span class="hljs-string">"Subscription"</span></span>, message); } }</code> </pre><br><br>  Add the Subscription.html.cshtml View (/Areas/Default/Views/Mail/Subscription.html.cshtml): <br><pre> <code class="html hljs xml">@model string @{ Layout = null; } <span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">http-equiv</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Content-Type"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/html; charset=UTF-8"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>@Model<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Add to the Web.config configuration for working with mail (Web.config): <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.net</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mailSettings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">smtp</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">deliveryMethod</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Network"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">from</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"lxndrpetrov@gmail.com"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">network</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">host</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"smtp.gmail.com"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">port</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"587"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">userName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"lxndrpetrov"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">password</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"******"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">enableSsl</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">smtp</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mailSettings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.net</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  And we create a test method in UserController.cs (/Areas/Default/Controllers/UserController.cs): <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Authorize</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SubscriptionTest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mailController = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MailController(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> email = mailController.Subscription(<span class="hljs-string"><span class="hljs-string">", !"</span></span>, CurrentUser.Email); email.Deliver(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Content(<span class="hljs-string"><span class="hljs-string">"OK"</span></span>); }</code> </pre><br><br>  Run: <br><br>  <a href="http://localhost/User/SubscriptionTest">localhost / User / SubscriptionTest</a> - and get a letter in the mail. <br><br>  Consider an example of getting the text of a letter in a string  This will require a StreamReader (/Areas/Default/Controllers/UserController.cs): <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Authorize</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SubscriptionShow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mailController = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MailController(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> email = mailController.Subscription(<span class="hljs-string"><span class="hljs-string">", !"</span></span>, CurrentUser.Email); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StreamReader(email.Mail.AlternateViews[<span class="hljs-number"><span class="hljs-number">0</span></span>].ContentStream)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> content = reader.ReadToEnd(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Content(content); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre><br><br>  Content already has a generated page.  Run: <br>  <a href="http://localhost/User/SubscriptionShow">localhost / User / SubscriptionShow</a> <br><br><h5>  Smsnotify </h5><br><br>  In this chapter, we will discuss the interaction using SMS, and not just mail.  But there is a nuance - access to the mailing list is provided by individual services, and here we consider only the basic principles of the module writing for working with SMS providers using the example of working with unisender.ru. <br>  Create a class of settings like MailSetting (/Global/Config/SmsSetting.cs): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SmsSetting</span></span> : <span class="hljs-title"><span class="hljs-title">ConfigurationSection</span></span> { [ConfigurationProperty(<span class="hljs-string"><span class="hljs-string">"apiKey"</span></span>, IsRequired = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> APIKey { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[<span class="hljs-string"><span class="hljs-string">"apiKey"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[<span class="hljs-string"><span class="hljs-string">"apiKey"</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } [ConfigurationProperty(<span class="hljs-string"><span class="hljs-string">"sender"</span></span>, IsRequired = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Sender { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[<span class="hljs-string"><span class="hljs-string">"sender"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[<span class="hljs-string"><span class="hljs-string">"sender"</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } [ConfigurationProperty(<span class="hljs-string"><span class="hljs-string">"templateUri"</span></span>, IsRequired = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> TemplateUri { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[<span class="hljs-string"><span class="hljs-string">"templateUri"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[<span class="hljs-string"><span class="hljs-string">"templateUri"</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } }</code> </pre>  Set in Web.Config (Web.config): <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configSections</span></span></span><span class="hljs-tag">&gt;</span></span> ‚Ä¶ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">section</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"smsConfig"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"LessonProject.Global.Config.SmsSetting, LessonProject"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configSections</span></span></span><span class="hljs-tag">&gt;</span></span> ‚Ä¶ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">smsConfig</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">apiKey</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"*******"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">sender</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Daddy"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">templateUri</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://api.unisender.com/ru/api/sendSms"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Create the SmsSender class (/Tools/Sms/SmsSender.cs): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SmsSender</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IConfig _config; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IConfig Config { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_config == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { _config = (DependencyResolver.Current).GetService&lt;IConfig&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _config; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> NLog.Logger logger = NLog.LogManager.GetCurrentClassLogger(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendSms</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> phone, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> text</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Config.SmsSetting.APIKey)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetRequest(phone, Config.SmsSetting.Sender, text); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { logger.Debug(<span class="hljs-string"><span class="hljs-string">"Sms \t Phone: {0} Body: {1}"</span></span>, phone, text); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Success"</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRequest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> phone, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> text</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { HttpWebRequest webRequest = (HttpWebRequest)WebRequest.Create(Config.SmsSetting.TemplateUri); <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> important, otherwise the service can't desirialse your request properly webRequest.ContentType = "application/x-www-form-urlencoded"; webRequest.Method = "POST"; webRequest.KeepAlive = false; webRequest.PreAuthenticate = false; string postData = "format=json&amp;api_key=" + Config.SmsSetting.APIKey + "&amp;phone=" + phone + "&amp;sender=" + sender + "&amp;text=" + HttpUtility.UrlEncode(text); var ascii = new ASCIIEncoding(); byte[] byteArray = ascii.GetBytes(postData); webRequest.ContentLength = byteArray.Length; Stream dataStream = webRequest.GetRequestStream(); dataStream.Write(byteArray, 0, byteArray.Length); dataStream.Close(); WebResponse webResponse = webRequest.GetResponse(); Stream responceStream = webResponse.GetResponseStream(); Encoding enc = System.Text.Encoding.UTF8; StreamReader loResponseStream = new StreamReader(webResponse.GetResponseStream(), enc); string Response = loResponseStream.ReadToEnd(); return Response; } catch (Exception ex) { logger.ErrorException("   SMS", ex); return "   SMS"; } } }</span></span></code> </pre><br><br>  The result comes like: <br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"result"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"currency"</span></span>:<span class="hljs-string"><span class="hljs-string">"RUB"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"price"</span></span>:<span class="hljs-string"><span class="hljs-string">"0.49"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"sms_id"</span></span>:<span class="hljs-string"><span class="hljs-string">"1316886153.2_79859667475"</span></span>}}</code> </pre><br>  It can be disassembled and analyzed. <br>  In the next lesson we will look at how to work with json. <br><br><h5>  Separate stream </h5><br>  If we send email to a lot of people, the processing can take a lot of time.  For this, I use the following principle: <br><ul><li>  We create a separate thread that checks if outgoing emails are ready to be sent. </li><li>  When you create a mailing list are created and recorded in the database </li><li>  The thread checks the status of the database for the presence of letters. </li><li>  Letters are retrieved from the database sequentially (the letter can be deleted, can only nullify the contents of the letter (in order to save the size of the database). </li><li>  The letter is sent. </li><li>  Returns to check. </li></ul><br><br>  A separate thread is launched in Application_Start.  The timer is set to repeat after 1 minute: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MvcApplication</span></span> : <span class="hljs-title"><span class="hljs-title">System</span></span>.<span class="hljs-title"><span class="hljs-title">Web</span></span>.<span class="hljs-title"><span class="hljs-title">HttpApplication</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> NLog.Logger logger = NLog.LogManager.GetCurrentClassLogger(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Thread mailThread { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Application_Start</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> adminArea = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AdminAreaRegistration(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> adminAreaContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AreaRegistrationContext(adminArea.AreaName, RouteTable.Routes); adminArea.RegisterArea(adminAreaContext); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> defaultArea = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultAreaRegistration(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> defaultAreaContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AreaRegistrationContext(defaultArea.AreaName, RouteTable.Routes); defaultArea.RegisterArea(defaultAreaContext); FilterConfig.RegisterGlobalFilters(GlobalFilters.Filters); RouteConfig.RegisterRoutes(RouteTable.Routes); BundleConfig.RegisterBundles(BundleTable.Bundles); mailThread = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ThreadStart(ThreadFunc)); mailThread.Start(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ThreadFunc</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mailThread = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ThreadStart(MailThread)); mailThread.Start(); logger.Info(<span class="hljs-string"><span class="hljs-string">"Wait for end mail thread"</span></span>); mailThread.Join(); logger.Info(<span class="hljs-string"><span class="hljs-string">"Sleep 60 seconds"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { logger.ErrorException(<span class="hljs-string"><span class="hljs-string">"Thread period error"</span></span>, ex); } Thread.Sleep(<span class="hljs-number"><span class="hljs-number">60000</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MailThread</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> repository = DependencyResolver.Current.GetService&lt;IRepository&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (MailProcessor.SendNextMail(repository)) { } } }</code> </pre><br><br>  Consider the MailProcessor class (but we will not create it): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MailProcessor</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendNextMail</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IRepository repository</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mail = repository.PopMailQueue(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mail != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { MailSender.SendMail(mail.Email, mail.Subject, mail.Body); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }</code> </pre><br><br>  <code>MailProcessor.SendNextMail(repository)</code> - sends the next letter; if there are no letters, it returns false <br>  The MainThread thread waits for <code>MailThread</code> and takes a smoke break for one minute.  And further.  If there are no new letters in the database, then we smoke next minute. <br><br>  All sources are located at <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a> </div><p>Source: <a href="https://habr.com/ru/post/176075/">https://habr.com/ru/post/176075/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../176063/index.html">ASP.NET MVC Lesson 8. View, Razor, error page</a></li>
<li><a href="../176067/index.html">Easy customizable python daemon</a></li>
<li><a href="../176069/index.html">ASP.NET MVC Lesson 9. Configuration and File Upload</a></li>
<li><a href="../176071/index.html">How we searched for the first users and what Artemy Lebedev was wrong about</a></li>
<li><a href="../176073/index.html">Thoughts on the future of computer games</a></li>
<li><a href="../176077/index.html">Quite an interesting replacement for the standard terminal.</a></li>
<li><a href="../176079/index.html">Road to the clouds: SaaS vs desktop</a></li>
<li><a href="../176081/index.html">eBay plans to ‚Äúflood the planet‚Äù by 2015</a></li>
<li><a href="../176083/index.html">People began to move to Yukoz</a></li>
<li><a href="../176087/index.html">ASP.NET MVC Lesson B. Json</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>