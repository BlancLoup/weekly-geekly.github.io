<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Squid3 in SSLBump mode with dynamic certificate generation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings. 

 Encrypted web traffic is a good thing, but sometimes it‚Äôs not at all clear what the user does inside. When entering any https resource v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Squid3 in SSLBump mode with dynamic certificate generation</h1><div class="post__text post__text-html js-mediator-article">  Greetings. <br><br>  Encrypted web traffic is a good thing, but sometimes it‚Äôs not at all clear what the user does inside.  When entering any https resource via squid, enough lines of this type are written to the logs: <br><br>  <nobr>1330231066.104 10 172.26.27.8 TCP_MISS / 200 390 CONNECT mail.google.com:443 - HIER_DIRECT / 173.194.32.54 -</nobr> <br>  <nobr>1330241192.883 9 172.26.27.97 TCP_MISS / 200 390 CONNECT mc.yandex.ru:443 - HIER_DIRECT / 213.180.193.119 -</nobr> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It can be seen that at certain times, users went to gmail and Yandex.  In principle, that's all we see from the logs.  But it is not clear whether the GET or POST request was executed, the full URLs or file sizes are not visible.  It is also not possible to check ssl traffic with antivirus program or content inspection programs. <br><br>  In this article I want to describe the ability of squid to ‚Äúbreak down‚Äù an ssl connection and have at least some overview of what is happening in https traffic. <br><br><a name="habracut"></a><br><br>  Since CentOS has ‚Äúenhanced‚Äù openssl, the squid build with the keys we need does not work. <br>  There are two options for solving this problem. <br>  The first is to climb into the installed files of the installed openssl, then to the sources of the squid and change some lines.  And the second is to build a squid with custom openssl. <br><br>  The first option is too hardcore and leave it aside. <br><br><h5>  1. openssl </h5><br>  So first we need to build our openssl.  It's all pretty simple and no magic: <br><br> <code><a href=""></a> wget www.openssl.org/source/openssl-1.0.0k.tar.gz</code> <br> <code>tar -zxf openssl-1.0.0k.tar.gz</code> <br> <code>cd openssl-1.0.0k</code> <br> <br>  To avoid conflicts with the already installed version of openssl, specify the new path: <br><br> <code>./config shared --prefix=/opt/squid/openssl --openssldir=/opt/squid/openssl</code> <br> <code>make</code> <br> <code>make install</code> <br>  That's it, openssl is built and ready to use. <br><br><h5>  2. squid </h5><br>  The assembly of the proxy server is similar to the assembly of any program (configure &amp;&amp; make &amp;&amp; make install), the only thing is to specify certain keys when compiling: <br><br> <code><a href=""></a> wget www.squid-cache.org/Versions/v3/3.2/squid-3.2.7.tar.gz</code> <br> <code>tar -zxf squid-3.2.7.tar.gz</code> <br> <code>cd squid-3.2.7</code> <br> <code>./configure --prefix=/opt/squid --enable-ssl --enable-ssl-crtd --with-openssl=/opt/squid/openssl</code> <br> <br>  --enable-ssl - includes support for ssl mode <br>  --enable-ssl-crtd - a separate process deals with the generation of certificates, and not the proxy server itself. <br>  --with-openssl - the path where the custom openssl was installed <br><br> <code>make all</code> <br> <code>make install</code> <br>  So, the squid proxy server is compiled. <br><br><h5>  3. We generate self-signed certificate </h5><br>  The certificate will be used by the proxy server to create dynamic web site certificates. <br><br> <code>cd /opt/squid/etc/</code> <br> <code>openssl req -new -newkey rsa:1024 -days 365 -nodes -x509 -keyout squidCA.pem -out squidCA.pem</code> <br> <br>  Since the squidCA.pem file contains a private key, we make it readable only for the root user: <br> <code>chmod 400 squidCA.pem</code> <br> <br><h5>  4. Configure squid </h5><br>  Add the following lines to the squid.conf file <br><pre> <code class="bash hljs">http_port 3128 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/opt/squid/etc/squidCA.pem always_direct allow all ssl_bump allow all sslproxy_cert_error allow all sslproxy_flags DONT_VERIFY_PEER</code> </pre><br>  This setting is undesirable to use in the production system, since access is allowed to all https sites with any certificates. <br><br>  Prepare certificate caching: <br> <code>mkdir /opt/squid/var/lib</code> <br> <code>/opt/squid/libexec/ssl_crtd -c -s /opt/squid/var/lib/ssl_db</code> <br> <code>chown -R nobody /opt/squid/var/lib/ssl_db</code> <br>  If you have a different UID in the <b>cache_effective_user</b> setting, you should use it instead of nobody. <br><br>  <i>It is worth noting that if for some reason you have changed your certificate for squid, you must completely clear the / opt / squid / var / lib / ssl_db directory and reinitialize the certificate database.</i> <br><br>  Set the necessary rights, initialize and run the proxy server: <br> <code>chown -R nobody /opt/squid/var/logs</code> <br> <code>/opt/squid/sbin/squid -z</code> <br> <code>/opt/squid/sbin/squid</code> <br>  check the file /opt/squid/var/logs/cache.log for errors, if there are no errors and there is a string " <code>Accepting SSL bumped HTTP Socket connections at local=[::]:3128 remote=[::] FD 21 flags=9</code> ", then the proxy server in SSLBump mode is running. <br><br><h5>  5. user problems </h5><br>  Since in this case we use a self-signed certificate, any visits from https sites through a proxy will show users a certificate error.  The reason for the error is that the Issuer of our certificate is not in the Trusted CA list in the browser. <br>  Whatever the errors, we perform the following action. <br><br> <code>openssl x509 -in squidCA.pem -outform DER -out squid.der</code> <br> <br>  Now, the resulting squid.der file must be imported into the client browser. <br>  For Internet Explorer: <br>  Tools-&gt; Internet Options-&gt; Content-&gt; Certificates <br>  Select the tab "Trusted Root Certificate Authorities" <br>  Click Import, select the squid.der file and complete the import. <br><br>  For Firefox: <br>  Tools-&gt; Options-&gt; Advanced-&gt; Encryption-&gt; View Certificates <br>  Select the tab "Authorities" <br>  Click Import, select the squid.der file and complete the import. <br><br>  Well, in general, that's all.  Depending on your fantasies, you now have the opportunity in https traffic to prohibit POST requests, download large files, block access to certain files / folders.  You can also deny access to sites whose certificates are issued by non-trusted CAs.  Well, the ability to check for viruses. <br><br>  Thanks for attention, </div><p>Source: <a href="https://habr.com/ru/post/168515/">https://habr.com/ru/post/168515/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../168491/index.html">How to use the Instruments utility in Xcode</a></li>
<li><a href="../168493/index.html">7 steps to successfully migrate the SharePoint 2007 portal to SharePoint 2010</a></li>
<li><a href="../168497/index.html">Returning to the printed</a></li>
<li><a href="../168503/index.html">Kim Jong-un and the mysterious smartphone</a></li>
<li><a href="../168511/index.html">Runetology (184): Oleg Cheltsov, Fotolia project founder</a></li>
<li><a href="../168517/index.html">Wavelet compression on the fingers</a></li>
<li><a href="../168523/index.html">First impressions of Sony Xperia Z and ZL</a></li>
<li><a href="../168525/index.html">IT AS IS</a></li>
<li><a href="../168527/index.html">Open Days Ingria "How to start-up get into the TV"</a></li>
<li><a href="../168529/index.html">Instagram has launched a web version of the user's tape</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>