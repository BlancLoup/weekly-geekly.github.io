<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Vertex Wireless VW210: a rare router and its inner world</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Lyrical digression: everything described in this article was made solely for educational purposes, the goal of material gain was not pursued, not a si...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Vertex Wireless VW210: a rare router and its inner world</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  Lyrical digression: everything described in this article was made solely for educational purposes, the goal of material gain was not pursued, not a single cat in the process (hopefully) was damaged.  Everything that is described here you repeat at your own peril and risk. </blockquote><div style="text-align:center;"><img src="https://habrastorage.org/web/2d0/319/329/2d03193293b644c9b52f992a986b051d.png" alt="KDPV smoker (for those who have expensive traffic)"></div><br>  <i>KDPV smoker (for those who have expensive traffic)</i> <br><br>  For several years in a deaf village, this elusive Joe of the networking industry has been working tirelessly.  The choice fell on him, thanks to the support of the only working solution for the area, namely CDMA 450 from the local operator Sotel (ala SkyLink).  Unlike other routers / modems for this standard of the time, he was the only one who allowed to achieve a stable connection with the help of <s>some kind of mother and a</s> directional antenna.  But here's the problem: <a href="http://www.vwireless.co.kr/">the manufacturer's website</a> (and perhaps he himself) disappeared from the horizon of these of our Internet back in 2011.  All that remains is the <a href="https://www.youtube.com/watch%3Fv%3DQhP5NAed3M0">pretentious video</a> on YouTube and the mention of their products from various sellers and operators. <br><a name="habracut"></a><br><img src="https://habrastorage.org/web/486/ace/951/486ace95128144d1a98ac22706ae3296.png" alt="If you are already here."><br>  <i>KDPV for readers who do not limit themselves to anything, although there is so much attention here if you are already here.</i> <br><blockquote>  All subsequent images are clickable (except for the fairytale character) </blockquote><h4>  Motivation </h4><br>  Together with the site and the manufacturer, they left this mortal world and any hopes of receiving firmware files, let alone opening its source codes, despite the requirements of the GPL.  The idea to get a more complete access to the system than the web interface allows, appeared in my head for a long time and didn‚Äôt give rest to playful hands.  And, thanks to the <a href="https://toster.ru/q/45900">question on the toaster</a> from uv.  <a href="https://habrahabr.ru/users/nomad1/" class="user_link">Nomad1</a> and contrary to his advice to throw out this misunderstanding of the network industry, was immediately enforced.  In fact, thanks to this habraiser both for the first and for the second, because  it was a direct challenge, after which I shouted "Dementia and courage!" I went to an unequal battle with the Korean technological machine of the sample of 2009. <br><br><h4>  Soft </h4><br>  First of all, I began to study the web interface, or rather its inner world.  Thanks to a hole in the used version of the GoAhead embedded web server, it was possible to download the source code of the pages by adding the "/" link to the main link.  For example, the link <a href="http://192.168.200.1/html/log.asp">http://192.168.200.1/html/log.asp</a> opened the result of the script log.asp, and <a href="http://192.168.200.1/html/log.asp/">http://192.168.200.1/html/log.asp/</a> - the original file of the script log.asp.  With a small script on the bash, everything that was at least somehow mentioned in the scripts was pulled out, but after analyzing the mined, it became clear that this information was clearly not enough for hacking. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Due to another <a href="https://www.exploit-db.com/exploits/21707/">vulnerability</a> in the same GoAhead, it was possible to execute code when the buffer overflowed, but for this it was necessary to get information about the address, where to transfer control, and in the absence of access to the system, the call stack could not be received when it was dropped. <br><br>  In addition to the 2 vulnerabilities in the web server, vulnerabilities were found in the implementation of the uPnP server, which led to buffer overflow and code execution, but their operation also required access to the router system. <br><br><h4>  Iron </h4><br>  Saying goodbye to the hopes of a software hack, I turned to the study of the iron part. <br>  The iron part of the router is a sandwich of two boards: a modem and interfaces (on the top of the photo) and a processor unit (on the bottom of the photo): <br><br> <a href=""><img src="https://habrastorage.org/web/48e/b99/f19/48eb99f194b94da8be366cb6ffc18a8c.png" alt="image"></a> <br><br>  On the reverse side of the processor, there is a mini-PCI connector in which the Wi-Fi board is at peace: <br><br> <a href=""><img src="https://habrastorage.org/web/3af/c44/5f5/3afc445f57864488a909ecb44f6abea1.png" alt="image"></a> <br><br>  The initial examination of the patient showed that the main components of this device are: <br><br><ul><li>  Qualcomm MSM6801A - modem processor </li><li>  Micrel KSZ8692PB - system on a chip (SoC) with a network, PCI and other payload </li></ul><br> <a href=""><img src="https://habrastorage.org/web/480/520/94d/48052094ddf7480cbd3a9e185d8e3cec.png"></a> <br><br>  Since we have identified <s>the largest</s> SoC chip, we need to think from which side to get close to it.  Unfortunately, by some ridiculous coincidence, Micrel went into the sunset as well as Vertex Wireless.  Searches for at least some documentation on this chip were led to dead ends on forums, where the engineer was outraged by the secrecy of the specifications and the lack of open access documentation, to which the dear managers invited them to discuss this one-on-one.  But <a href="http://web.archive.org/">The Wayback Machine</a> came to the rescue, thanks to which it still managed to seize <a href="http://micrel.com/_PDF/Ethernet/sw_designkit/8692/">documentation and other goodies</a> for this chip. <br><br><h4>  UART </h4><br>  After studying the extracted documentation, it became clear that our new friend has UART-interfaces in the amount of 4 pieces, as well as JTAG.  One of the UARTs is most likely used as a debug console.  Having started the terminal, <br><br><pre><code class="bash hljs">$ minicom -D /dev/ttyUSB0 -b 115200</code> </pre> <br>  I started poking a needle connected to the TTL-USB converter at the debug points on the board, periodically sending a router to reload.  And at the next point, the cherished letters ran into the console ... and on the next letter of answers.  It turned out to be a UART for communicating SoC with a modem.  Theoretically, the exchange log with the modem is also of some interest, especially given the lack of intelligible documentation on the creation of Qualcomm in free access, but we still have a slightly different goal. <br><br>  The points of the UART of the debugging console turned out to be on the back of the board and closed with the second ‚Äúsandwich‚Äù board, so it took a little longer to detect them. <br><br> <a href=""><img src="https://habrastorage.org/web/aff/ef6/e15/affef6e1511c4a8c911044c305231141.png" alt="image"></a> <br><br>  Solder to the cherished contacts: <br><br> <a href=""><img src="https://habrastorage.org/web/f08/74a/019/f0874a019a2e4cc1b0c51d09a3ff0294.png" alt="image"></a> <br><br><div class="spoiler">  <b class="spoiler_title">Boot log</b> <div class="spoiler_text"><pre>  U-Boot 1.1.4 (November 6, 2008)<font></font>
<font></font>
 DRAM: 64 MB
 Flash: 4 MB
 In: serial
 Out: serial
 Err: serial<font></font>
<font></font>
 ## Booting image at 1c040000 ...
    Image Name: Kernel-Ramdisk-Image
    Image Type: ARM Linux Multi-File Image (uncompressed)
    Data Size: 3338960 Bytes = 3.2 MB
    Load Address: 00008000
    Entry Point: 00008000
    Contents:
    Image 0: 1609588 Bytes = 1.5 MB
    Image 1: 1729360 Bytes = 1.6 MB
    Verifying Checksum ... OK
 Ok
    Relocate RAMDISK from 0x1c1c8fc0 to 0xc00000 by 0x1a6350 bytes<font></font>
<font></font>
 Starting kernel ...<font></font>
<font></font>
 Uncompressing Linux ................................................ .................................................. ........ done, booting the kernel.
 Linux version 2.6.23.17-Pegasus (gcc version 4.2.1)
 CPU: ARM922T [41029220] revision 0 (ARMv4T), cr = c0007177
 Machine: Micrel Pegasus
 Memory policy: ECC disabled, Data cache writeback
 Pegasus ID = 8692 SubID = 00 Revision = 02
 Clocks: System 166 MHz, CPU 166 MHz, DDR 166 MHz, PCI 33 MHz, IPsec 50 MHz
 CPU0: D VIVT write-back cache
 CPU0: I cache: 8192 bytes, associativity 64, 32 byte lines, 4 sets
 CPU0: D cache: 8192 bytes, associativity 64, 32 byte lines, 4 sets
 Built 1 zonelists in Zone order.  Total pages: 16256
 Kernel command line: console = ttyAM0,115200
 PID hash table entries: 256 (order: 8, 1024 bytes)
 console [ttyAM0] enabled
 Dentry cache hash table entries: 8192 (order: 3, 32768 bytes)
 Inode-cache hash table entries: 4096 (order: 2, 16384 bytes)
 Memory: 64MB = 64MB total
 Memory: 59756KB available (3028K code, 259K data, 128K init)
 Mount-cache hash table entries: 512
 CPU: Testing write buffer coherency: ok
 NET: Registered protocol family 16
 PCI: bus0: Fast back to back transfers disabled
 usbcore: registered new interface driver usbfs
 usbcore: registered new interface driver hub
 usbcore: registered new device driver usb
 NET: Registered protocol family 2
 Time: pegasus clocksource has been installed.
 IP route cache hash table entries: 1024 (order: 0, 4096 bytes)
 TCP Established hash table entries: 2048 (order: 2, 16384 bytes)
 TCP bind hash table entries: 2048 (order: 1, 8192 bytes)
 TCP: Hash tables configured (established 2048 bind 2048)
 TCP reno registered
 Freeing initrd memory: 1688K
 reset button handler is loaded
 NetWinder Floating Point Emulator V0.97 (double precision)
 NTFS driver 2.1.28 [Flags: R / O].
 JFFS2 version 2.2.  (NAND)    2001-2006 Red Hat, Inc.
 io scheduler noop registered
 io scheduler deadline registered (default)
 LED device driver is installed
 Serial: Micrel Pegasus UART driver version: 2.6.1.0
 ttyAM0 at MMIO 0x1fffe000 (irq = 45) is a Pegasus
 ttyAM1 at MMIO 0x1fffe080 (irq = 49) is a Pegasus
 ttyAM2 at MMIO 0x1fffe100 (irq = 52) is a Pegasus
 ttyAM3 at MMIO 0x1fffe180 (irq = 55) is a Pegasus
 RAMDISK driver initialized: 16 RAM disks of 16384K size 1024 blocksize
 PPP generic driver version 2.4.2
 PPP Deflate Compression module registered
 PPP BSD Compression module registered
 IMQ starting with 2 devices ...
 IMQ driver loaded successfully.
         Hooking IMQ after NAT on PREROUTING.
         Hooking IMQ before NAT on POSTROUTING.
 30 = ffff ffff
 Micrel Pegasus 1.0.0 (Oct 7, 2008)
 physmap platform flash device: 00400000 at 1c000000
 physmap-flash.0: Found 1 x16 devices at 0x0 in 16-bit bank
  Amd / Fujitsu Extended Query Table at 0x0040
 physmap-flash.0: CFI does not contain boot bank location.  Assuming top.
 number of CFI chips: 1
 cfi_cmdset_0002: Disabling erase-suspend-program due to code brokenness.
 cmdlinepart partition parsing not available
 RedBoot partition parsing not available
 Using physmap partition information
 Creating 4 MTD partitions on "physmap-flash.0":
 0x00000000-0x00030000: "Boot Loader"
 0x00030000-0x00040000: "Loader Config"
 0x00040000-0x003e0000: "Linux RootFS"
 0x003e0000-0x00400000: "System Config"
 pegasus-ehci pegasus-ehci: Pegasus-EHCI
 pegasus-ehci pegasus-ehci: new USB bus registered, assigned bus number 1
 pegasus-ehci pegasus-ehci: irq 8, io mem 0x1fffc000
 pegasus-ehci pegasus-ehci: USB 0.0 started, EHCI 1.00, driver 10 Dec 2004
 usb usb1: Product: Pegasus-EHCI
 usb usb1: Manufacturer: Linux 2.6.23.17-Pegasus ehci_hcd
 usb usb1: SerialNumber: KS8692
 usb usb1: configuration # 1 chosen from 1 choice
 hub 1-0: 1.0: USB hub found
 hub 1-0: 1.0: 2 ports detected
 pegasus-ohci pegasus-ohci: new USB bus registered, assigned bus number 2
 pegasus-ohci pegasus-ohci: irq 9, io mem 0x1fffd000
 usb usb2: Product: Pegasus-OHCI
 usb usb2: Manufacturer: Linux 2.6.23.17-Pegasus ohci_hcd
 usb usb2: SerialNumber: ks8692
 usb usb2: configuration # 1 chosen from 1 choice
 hub 2-0: 1.0: USB hub found
 hub 2-0: 1.0: 2 ports detected
 usbcore: registered new interface driver cdc_acm
 cdc_acm: v0.26: usb adapters for usb modems and ISDN adapters
 usbcore: registered new interface driver usbserial
 drivers / usb / serial / usb-serial.c: USB Serial support registered for generic
 usbcore: registered new interface driver usbserial_generic
 drivers / usb / serial / usb-serial.c: USB Serial Driver core
 Using Pegasus for AES algorithm.
 Using Pegasus for DES algorithm.
 u32 classifier
     Performance counters on
 nf_conntrack version 0.5.0 (1024 buckets, 4096 max)
 IPv4 over IPv4 tunneling driver
 GRE over IPv4 tunneling driver
 ip_tables: (C) 2000-2006 Netfilter Core Team
 TCP cubic registered
 NET: Registered protocol family 1
 NET: Registered protocol family 17
 NET: Registered protocol family 15
 Bridge firewalling registered
 RAMDISK: Compressed image found at block 0
 VFS: Mounted root (ext2 filesystem).
 Freeing init memory: 128K
 Setting hostname ...
 Mounting root fs rw ...
 Mounting other filesystems ...
 checksum f0d68bc4, tmp_checksum f0d68bc4
 flash: Read from flash memory ...
 sysconf read 0x40070000
 Checksum is f0d68bc4
 flash: wrote to flash memory ...
 br0: Dropping NETIF_F_UFO since no NETIF_F_HW_CSUM feature.
 device eth1 entered promiscuous mode
 time: 9628 ms
 usb 2-1: new full speed usb device using pegasus-ohci and address 2
 usb 2-1: device descriptor read / 64, error -62
 usb 2-1: Product: Qualcomm CDMA Technologies MSM
 usb 2-1: Manufacturer: Qualcomm, Incorporated
 usb 2-1: configuration # 1 chosen from 1 choice
 cdc_acm 2-1: 1.0: ttyACM0: USB ACM device
 br0: port 1 (eth1) entering learning state
 udhcpd (v0.9.9) started
 Unable to open /etc/config/udhcpd.leases for reading
 Unable to open /etc/config/udhcpd.assigned for reading
 br0: topology change detected, propagating
 br0: port 1 (eth1) entering forwarding state
 =&gt; ATcommand Start 3<font></font>
<font></font>
 &gt;&gt;&gt; Send: AT $ ROUTERBOOTDONE
 &gt;&gt;&gt; Read: AT $ ROUTERBOOTDONE = OK
 command count 0<font></font>
<font></font>
 &gt;&gt;&gt; Send: AT $ TIME
 &gt;&gt;&gt; Read: AT $ TIME = 19800106000024<font></font>
<font></font>
 &gt;&gt;&gt; Send: AT $ PINSTAT<font></font>
<font></font>
 &gt;&gt;&gt; Send: AT $ TIME
 Sun Jan 6 00:00:24 UTC 1980
 command count 0
 &gt;&gt;&gt; Read: AT $ DRC = 0
 cdmainfo.r_drc Null Rate
 &gt;&gt;&gt; Read: AT $ RF = 007d, 007d
 cdmainfo.r_rf = Rx1 007d
 cdmainfo.r_rf = Rx2 007d
 &gt;&gt;&gt; Read: AT $ CALLSTAT = 0.0
 cdmainfo.r_callstat = 1x Offline
 cdmainfo.r_callstat = EVDO Inactive
 &gt;&gt;&gt; Read: AT $ PINSTAT = NOCARD
 pinstat 3
 command count 0
 &gt;&gt;&gt; Read: AT $ TIME = 19800106000024
 command count 0
 &gt;&gt;&gt; Read: AT $ EVDOINFO = 0,0,0,0,0, -31,0,0,0
 &gt;&gt;&gt; Read: AT $ CDMAINFO = 0,0,0,0,0,0,0,0, -31,0,0,9,9
 rmmod: nf_nat_dnsproxy: Unknown error -1074267480
 create_sysconf_linux_module <font></font>
<font></font>
 &gt;&gt;&gt; Send: AT $ DRC = OK<font></font>
<font></font>
 &gt;&gt;&gt; Send: AT $ RF = OK<font></font>
<font></font>
 &gt;&gt;&gt; Send: AT $ CALLSTAT = OK<font></font>
<font></font>
 &gt;&gt;&gt; Send: AT $ EVDOINFO = OK
 Sysinit done<font></font>
<font></font>
 &gt;&gt;&gt; Send: AT $ CDMAINFO = OK
 login: &gt;&gt;&gt; Read: AT $ BOOTDONE<font></font>
<font></font>
 &gt;&gt;&gt; Send: AT $ BOOTDONE = OK
 &gt;&gt;&gt; Read: AT $ RUIMREADDONE = NOCARD
 pinstat 3<font></font>
<font></font>
 &gt;&gt;&gt; Send: AT $ RUIMREADDONE = OK </pre></div></div><br>  And here we are in the console, but after the download the system asks for authorization and standard attendance passwords everyone there flatly refuses to accept, and the u-boot loader turned out to be assembled without being able to stop the download and manage it.  The path of the serial console was closed for me and I went further ... well, this is not counting foolish attempts to select a password as a script for minicom, which were doomed to receive the result a little later than that super computer says its "42". <br><br><h4>  JTAG </h4><br>  My happiness is that all the contacts of the JTAG-interface of the chip turned out to be extreme and were available for ‚Äúpinging‚Äù using a needle: <br><br> <a href=""><img src="https://habrastorage.org/web/6e1/90b/93b/6e190b93b5b64022908d1359ed84d524.png" alt="image"></a> <br><br>  JTAG contacts on the board: <br><br> <a href=""><img src="https://habrastorage.org/web/ab9/b45/457/ab9b4545793944c184eda131172e8734.png" alt="image"></a> <br><br>  However, the adapter assembled on the knee from the DB25-papa for LPT-port, resistances and snot showed that the JTAG is either disconnected or someone has curved arms.  For the second option, a factory-made JTAG adapter was ordered on the notorious trading platform of the Middle Kingdom, but this is a long time.  And in the first case, you should try to enter the SoC into some kind of test mode with the help of needles, wires and test points that go to the TESTEN and TESTEN1 legs. <br><br><h4>  Insight </h4><br>  But at that moment an old hack emerged in my memory, used to force every piece of hardware to be flushed: drive the piece of iron into the ‚Äúbroken firmware‚Äù mode, shorting the address legs on the flash drive with the firmware.  On our board, the firmware is in the microchip (Samsung K8P3215UQB <a href="http://www.bdtic.com/DataSheet/SAMSUNG/K8P3215UQB.pdf">www.bdtic.com/DataSheet/SAMSUNG/K8P3215UQB.pdf</a> ) under the screen next to the process. <br><br> <a href=""><img src="https://habrastorage.org/web/3c8/16a/0a4/3c816a0a4711474993d2b56cf377f3a9.png" alt="image"></a> <br><br>  The first legs of this microcircuit are the address lines and, by shorting them, we can break the firmware reading: <br><br> <a href=""><img src="https://habrastorage.org/web/667/e15/cba/667e15cba2a54b18b8224b9f495a2e7a.png" alt="image"></a> <br><br>  Since we would like to get into the menu of the u-boot, we will be naughty right after it is loaded at the moment of reading the rest of the firmware.  We turn on the router and after a significant blinking of the LEDs and the text output to the console: <br><br><pre>  U-Boot 1.1.4 (November 6, 2008)<font></font>
<font></font>
 DRAM: 64 MB
 Flash: 4 MB
 In: serial
 Out: serial
 Err: serial </pre>  Start gently short 1-2-3-4 feet with a screwdriver to achieve the coveted one: <br><pre>  Bad header checksum
 ks8692pb&gt; </pre><br>  Well, we have achieved the location of the intractable loader. <br><br><h4>  Loader </h4><br>  Let's see what this veteran can do: <br><br><div class="spoiler">  <b class="spoiler_title">ks8692pb&gt; help</b> <div class="spoiler_text">  ?  - alias for 'help' <br>  autoscr - run script from memory <br>  base - print or set address offset <br>  bdinfo - print Board Info structure <br>  boot - boot default, ie, run 'bootcmd' <br>  bootd - boot default, ie, run 'bootcmd' <br>  bootm - boot application image from memory <br>  bootp - boot image via network using BootP / TFTP protocol <br>  cmp - memory compare <br>  coninfo - print console devices and information <br>  cp - memory copy <br>  cp - memory copy <br>  crc32 - checksum calculation <br>  dhcp - invoke DHCP client IP / boot params <br>  echo - echo args to console <br>  erase - erase FLASH memory <br>  fatinfo - print information about filesystem <br>  fatload - load binary file from a dos filesystem <br>  fatls - list files in a directory (default /) <br>  flinfo - print FLASH memory information <br>  go - start application at address 'addr' <br>  help - print online help <br>  icrc32 - checksum calculation <br>  iloop - infinite loop on address range <br>  imd - i2c memory display <br>  iminfo - print header information for application image <br>  imls - list all images found in flash <br>  imm - i2c memory modify (auto-incrementing) <br>  imw - memory write (fill) <br>  inm - memory modify (constant address) <br>  iprobe - probe to discover valid I2C chip addresses <br>  isf - i2s transmit waveform data file from memory address <br>  isr - i2s receive waveform data to the memory address <br>  isw - i2s transmit waveform data from memory address <br>  itest - return true / false on integer compare <br>  loadb - load binary file over serial line (kermit mode) <br>  loads - load S-Record file over serial line <br>  loady - load binary file over serial line (ymodem mode) <br>  loop - infinite loop on address range <br>  md - memory display <br>  mdior register - read mdio register <br>  mdiow register data - write mdio register <br>  mii - MII utility commands <br>  mm - memory modify (auto-incrementing) <br>  mmcinit - init mmc card <br>  mnand - copy to nand boot <br>  mr - memory read and compare <br>  mtest - simple RAM test <br>  mw - memory write (fill) <br>  nettest - network port load test <br>  nfs - boot image via network using NFS protocol <br>  nm - memory modify (constant address) <br>  pci - list and access PCI Configuration Space <br>  ping - send ICMP ECHO_REQUEST to network host <br>  printenv- print environment variables <br>  protect - enable or disable FLASH write protection <br>  rarpboot- boot image via network using RARP / TFTP protocol <br>  reset - Perform RESET of the CPU <br>  run - run commands in an environment variable <br>  saveenv - save environment variables to persistent storage <br>  setenv - set environment variables <br>  sleep - delay execution for some time <br>  sspi - SPI utility commands <br>  tftpboot- boot image via network using TFTP protocol <br>  usb - USB sub-system <br>  usbboot - boot from USB device <br>  version - print monitor version <br>  wait - wait for memory <br></div></div><br>  It looks promising, but it turns out that some of the commands do not work, despite the mention in the help.  First of all I would like to know how the addressing of the flash drive works: <br><br><div class="spoiler">  <b class="spoiler_title">ks8692pb&gt; flinfo</b> <div class="spoiler_text"><pre>  Bank # 1: CFI conformant FLASH (16 x 16) Size: 4 MB in 78 Sectors
  Erase timeout 8192 ms, write timeout 1 ms, buffer write timeout 1 ms, buffer size 1
   Sector Start Addresses:
     1C000000 (RO) 1C002000 (RO) 1C004000 (RO) 1C006000 (RO) 1C008000 (RO)
     1C00A000 (RO) 1C00C000 (RO) 1C00E000 (RO) 1C010000 (RO) 1C020000 (RO)
     1C030000 (RO) 1C040000 1C050000 1C060000 1C070000     
     1C080000 1C090000 1C0A0000 1C0B0000 1C0C0000     
     1C0D0000 1C0E0000 1C0F0000 1C100000 1C110000     
     1C120000 1C130000 1C140000 1C150000 1C160000     
     1C170000 1C180000 1C190000 1C1A0000 1C1B0000     
     1C1C0000 1C1D0000 1C1E0000 1C1F0000 1C200000     
     1C210000 1C220000 1C230000 1C240000 1C250000     
     1C260000 1C270000 1C280000 1C290000 1C2A0000     
     1C2B0000 1C2C0000 1C2D0000 1C2E0000 1C2F0000     
     1C300000 1C310000 1C320000 1C330000 1C340000     
     1C350000 1C360000 1C370000 1C380000 1C390000     
     1C3A0000 1C3B0000 1C3C0000 1C3D0000 1C3E0000     
     1C3F0000 1C3F2000 1C3F4000 1C3F6000 1C3F8000     
     1C3FA000 1C3FC000 1C3FE000 </pre></div></div><br>  The areas marked "(RO)" are the bootloader itself.  Touching him is not pulling at all, so we run past him and stop his eyes on the other bands. <br><br>  Long and painful attempts to dump the contents of the flash drive in a normal form ended EXTREMELY with a flush overwritten after the restart.  It turned out that under some unknown conditions, after downloading the file via tftp, the loader sent the processor to a rezet, after which the flash drive automatically started erasing the range where the kernel image and ramdisk lie, and the loaded one begins to be written in their place.  In my case, it was a hastily assembled image of OpenWRT from Micrel for this platform, which has the same attitude to combat firmware as a plumber to a choreographer.  I tried to load it into memory, but the above feature of the bootloader led to the recording of this nonsense in the flash.  It was saved by the fact that in the first place the loader did not get stuck, and in the second I had the same combat piece of iron next to me.  Subsequently, the dump from the battle was set up on a padded test specimen, but then it was not at all ridiculous and the bricks fell to the floor in a continuous stream, while I tried to pull myself together. <br><br>  Since  the bootloader didn‚Äôt go anywhere, and at the firmware site didn‚Äôt understand what, interrupted halfway through the recording, the procedure was a bit easier ‚Äô: now you didn‚Äôt have to caress the stick of the flash drive with a screwdriver to go to the‚Äú Bad Header Checksum ‚Äù. <br>  On the barely breathing semi-corpus, the only way to dump the flash drive was found - this is the command md (memory display), which displays the specified section of memory directly to the console in the form of hexadecimal text: <br><br><div class="spoiler">  <b class="spoiler_title">ks8692pb&gt; md 0x1c040000</b> <div class="spoiler_text"><pre>  1c040000: 56190527 8e2b9359 cd32444b d0f23200 '..VY. +. KD2..2 ..
 1c040010: 00800000 00800000 6a1878c2 00040205 ......... xj ...
 1c040020: 6e72654b 522d6c65 69646d61 492d6b73 Kernel-Ramdisk-I
 1c040030: 6567616d 00000000 00000000 00000000 mage ............
 1c040040: 748f1800 50631a00 00000000 e1a00000 ... t..cP ........
 1c040050: e1a00000 e1a00000 e1a00000 e1a00000 ................
 1c040060: e1a00000 e1a00000 e1a00000 ea000002 ................
 1c040070: 016f2818 00000000 00188f74 e1a07001. (O ..... t .... p ..
 1c040080: e1a08002 e10f2000 e3120003 1a000001 ..... ..........
 1c040090: e3a00017 ef123456 e10f2000 e38220c0 .... V4 ... ... ..
 1c0400a0: e121f002 00000000 00000000 e28f00d0 ..! .............
 1c0400b0: e890307e e0500001 0a00000a e0855000 ~ 0 .... P ...... P ..
 1c0400c0: e0866000 e08cc000 e0822000 e0833000 .` ....... ... 0 ..
 1c0400d0: e08dd000 e5961000 e0811000 e4861004 ................
 1c0400e0: e156000c 3afffffa e3a00000 e4820004 ..V ....: ........
 1c0400f0: e4820004 e4820004 e4820004 e1520003 .............. R. </pre></div></div><br><img src="https://habrastorage.org/web/6be/2fc/e55/6be2fce55273480cbb53aa08ab825046.png" alt="image"><br>  <i>"It will be enough!"</i> <i><br></i>  <i>It turns out besides the starting address you need to specify the second parameter - the size.</i> <br><br><h4>  Dump </h4><br>  In order that everything acquired by overwork will not disappear together with the minicom console, we start recording the output to the file: press "Ctrl + al" and confirm the file name, for example, the standard "minicom.cap". <br><br>  We need a dump of the area from 0x1c040000 to 0x1c3fffff (see flinfo output).  A block of size 0x3c0000 is obtained, but the size of the md command (memory display) is not taken in bytes, but in 32-bit (4-byte) words, so the value we need is obtained by dividing 0x3c0000 by 4 and equal to 0xf0000.  Here is the result: <br><br><pre>  ks8692pb&gt; md 1c040000 f0000 </pre><br><br>  We are leaving to drink tea / coffee / boredom, since the procedure for outputting 3932160 bytes in a hexadecimal text form to a serial console is sadness.  After completion of the drainage procedure, close minicom (Ctrl + ax). <br><br>  Copy minidump exhaust to a file with a more meaningful name. <br><br><pre> <code class="bash hljs">$ cp ~/minicom.cap ./dump.hex</code> </pre> <br>  We'll have to look into it and remove the extra lines that were entered / displayed in the minicom.  In my case, this is one line at the beginning: <br><br><pre>  ks8692pb&gt; md 1c040000 f0000 </pre><br>  and one at the end of the file: <br><br><pre>  ks8692pb&gt; </pre><br>  Convert from text to binary data: <br><br><pre> <code class="bash hljs">$ xxd -r -s-0x1c040000 dump.hex &gt; dump.raw.bin</code> </pre> <br>  The offset to -0x1c040000 requires that data from the 0x00000000-0x1c03ffff range, which xxd would otherwise find missing, and politely write to the file, is not recorded in the final file. <br><br>  It turned out that the order of the bytes in the resulting binary is not the same, and I had to find a solution to deploy every four bytes (32-bit word).  On the Internet, a solution was found quickly: <br><br><pre> <code class="bash hljs">cat dump.raw.bin | perl -e <span class="hljs-string"><span class="hljs-string">'while (sysread(STDIN,$d,4)){print pack("N",unpack("V",$d));}'</span></span> &gt; dump.bin</code> </pre> <br><h4>  Autopsy </h4><br>  Let's see what we have inside the dump: <br><br><div class="spoiler">  <b class="spoiler_title">$ binwalk dump.bin</b> <div class="spoiler_text"><pre>  DECIMAL HEXADECIMAL DESCRIPTION
 -------------------------------------------------- ------------------------------
 0 0x0 uImage header, header size: 64 bytes, header CRC: 0x59932B8E, created: 2010-01-06 06:50:53, image size: 3338960 bytes, Data Address: 0x8000, Entry Point: 0x8000, data CRC: 0xC278186A, OS: Linux, CPU: ARM, image type: Multi-File Image, compression type: none, image name: "Kernel-Ramdisk-Image"
 14476 0x388C gzip compressed data, maximum compression, from Unix, last modified: 2010-01-05 04:49:24
 1609664 0x188FC0 gzip compressed data has original file name: "ramdisk.img", from Unix, last modified: 2010-01-06 06:50:44 </pre></div></div><br>  It is interesting that, in spite of the marking on the ‚Äú2009-10-15‚Äù board, the factory firmware is labeled January 2010.  Apparently something ‚Äúwent wrong‚Äù and finished the party finished on the move.  Well, that software, not iron ... mounted installation. <br><br>  Divide the acquired into separate parts: <br>  headline <br><br><pre> <code class="bash hljs">$ dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=dump.bin of=uImageHeader ibs=1 count=14476</code> </pre> <br>  core (size 1595188 = 1609664-14476) <br><br><pre> <code class="bash hljs">$ dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=dump.bin of=zImage ibs=1 skip=14476 count=1595188</code> </pre> <br>  ramdisk image: <br><br><pre> <code class="bash hljs">$ dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=dump.bin of=initrd.gz ibs=1 skip=1609664 &amp; gunzip initrd.gz</code> </pre> <br>  Subsequently, after editing a ramdisk, it will be possible to put everything back together into one command: <br><br><pre> <code class="bash hljs">$ cat uImageHeader &gt; out.bin $ cat zImage &gt;&gt; out.bin $ gzip initrd &amp; cat initrd.gz &gt;&gt; out.bin</code> </pre> <br>  Now you need to find out what file system is used: <br><br><pre> <code class="bash hljs">$ sudo blkid -o value -s TYPE ./initrd ext2</code> </pre> <br>  And mount it somewhere for cruel experiments: <br><br><pre> <code class="bash hljs">$ mkdir rootfs $ sudo mount -o loop -t ext2 ./initrd ./rootfs/</code> </pre> <br>  After a brief study of the FS, we find: <br><br><pre> <code class="bash hljs">$ sudo cat rootfs/etc/inittab ::sysinit:/etc/rc ::respawn:/bin/lgc_login</code> </pre> <br>  The first thing that comes to mind is ‚Äúwhat is it that has been done?‚Äù: <br><br><div class="spoiler">  <b class="spoiler_title">$ sudo strings rootfs / bin / lgc_login</b> <div class="spoiler_text"><pre>  /lib/ld-uClibc.so.0
 liblgc.so
 _DYNAMIC
 __dso_handle
 _init
 _fini
 _GLOBAL_OFFSET_TABLE_
 printf
 fgets
 strlen
 libc.so.0
 stdout
 getpass
 fflush
 abort
 stdin
 signal
 execlp
 __uClibc_main
 strcmp
 exit
 __data_start
 _edata
 __bss_start
 __bss_start__
 _end
 __bss_end__
 __end__
 login: 
 password: 
 admin
 .admin.
 GCC: (GNU) 3.3.2 20031005 (Debian prerelease)
 GCC: (GNU) 2.95.4 20010319 (prerelease)
 GCC: (GNU) 2.95.4 20010319 (prerelease)
 GCC: (GNU) 2.95.4 20010319 (prerelease)
 GCC: (GNU) 3.3.2 20031005 (Debian prerelease)
 .shstrtab
 .interp
 .note.ABI-tag
 .hash
 .dynsym
 .dynstr
 .rel.dyn
 .rel.plt
 .init
 .text
 .fini
 .rodata
 .data
 .dynamic
 .ctors
 .dtors
 .got
 .sbss
 .bss
 .comment </pre></div></div><br>  Well, here it‚Äôs enough to have eyes to see the login / password pair ‚Äúadmin / .admin.‚Äù Tightly wired in the code.  I will not torture - the authorization in the serial console with this data was successful. <br><br>  After a more detailed study of the file system, it turned out that it was possible to run the command without any authorization at all, for example telnetd: <br><br><pre> <code class="bash hljs">$ wget --post-data <span class="hljs-string"><span class="hljs-string">"cmd_key=%24telnetd%3b"</span></span> <span class="hljs-string"><span class="hljs-string">"http://192.168.200.1/goform/ping_showpopup"</span></span></code> </pre> <br>  It will start, start accepting connections ... but, unfortunately, will not be able to authorize us.  But that's another story. <br><br>  Thank uv.  <a href="https://habrahabr.ru/users/nomad1/" class="user_link">Nomad1</a> for <a href="https://habrahabr.ru/users/nomad1/" class="user_link">kicking</a> under my lazy ass, kind people who provided a half-dead sample for inhuman experiments, my wife and daughters for patience, and my five-year-old son for helping to reboot the router and run commands on the computer when my dad ran out of limbs. </div><p>Source: <a href="https://habr.com/ru/post/336942/">https://habr.com/ru/post/336942/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336932/index.html">Spectroscope-kaleidoscope</a></li>
<li><a href="../336934/index.html">Immersion in pricing Magento 2, we remove pennies after discounts</a></li>
<li><a href="../336936/index.html">IoT and 5G</a></li>
<li><a href="../336938/index.html">As a star of Brazilian TV shows, she accidentally helped open an IT company in Russia</a></li>
<li><a href="../336940/index.html">Transition to date-oriented design</a></li>
<li><a href="../336944/index.html">Overview of one Russian RTOS, part 3. Structure of the simplest program</a></li>
<li><a href="../336946/index.html">Simple models of economic dynamics in Python</a></li>
<li><a href="../336948/index.html">Deploy a .NET Core project to the Azure Web App for Linux</a></li>
<li><a href="../336950/index.html">The practice of forming requirements in IT projects from A to Z. Part 3. System Functions and Project Boundaries</a></li>
<li><a href="../336952/index.html">Lecture of Vitaly Kharisov "10k"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>