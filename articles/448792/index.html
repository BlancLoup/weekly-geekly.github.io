<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Python Testing with pytest. Builtin Fixtures, Chapter 4</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Back Next 


 The built-in fixtures that come with pytest can help you do pretty useful things in your tests with ease and ease. For example, in addit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Python Testing with pytest. Builtin Fixtures, Chapter 4</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://habr.com/ru/post/448786/">Back</a> <a href="https://habr.com/ru/post/448794/">Next</a> <img src="https://habrastorage.org/webt/rw/dy/-g/rwdy-grsvbpcetjttrmecdkxtlk.png"></p><br><p>  <em>The built-in fixtures that come with pytest can help you do pretty useful things in your tests with ease and ease.</em>  <em>For example, in addition to processing temporary files, pytest includes built-in fixtures for accessing command line parameters, communication between test sessions, checking output streams, changing environment variables, and polling warnings.</em> </p><br><p><img src="https://habrastorage.org/webt/hd/--/9w/hd--9w134j0rxhmxftrflbbdopy.png"></p><a name="habracut"></a><br><blockquote>  The source code for the Tasks project, as well as for all the tests shown in this book, is available via the <a href="https://pragprog.com/titles/bopytest/source_code" title="https://pragprog.com/titles/bopytest/source_code">link</a> on the book's web page at <a href="https://pragprog.com/titles/bopytest" title="https://pragprog.com/titles/bopytest">pragprog.com</a> .  You do not need to download the source code to understand the test code;  The test code is presented in a convenient form in the examples.  But to follow along with the project objectives, or to adapt test examples to test your own project (your hands are untied!), You must go to the book‚Äôs web page to download the work.  In the same place, on the web page of the book there is a link to the <a href="https://pragprog.com/titles/bopytest/errata" title="https://pragprog.com/titles/bopytest/errata">errata</a> message and a <a href="https://forums.pragprog.com/forums/438" title="https://forums.pragprog.com/forums/438">discussion forum</a> . </blockquote><p>  Under the spoiler is a list of articles in this series. </p><br><div class="spoiler">  <b class="spoiler_title">Table of contents</b> <div class="spoiler_text"><ul><li>  <a href="https://habr.com/ru/post/426699/"><strong>Introduction</strong></a> </li><li>  <a href="https://habr.com/ru/post/448782/"><strong>Chapter 1: Getting Started with pytest</strong></a> </li><li>  <a href="https://habr.com/ru/post/448788/"><strong>Chapter 2: Writing Test Functions</strong></a> </li><li>  <a href="https://habr.com/ru/post/448786/"><strong>Chapter 3: Pytest Fixtures</strong></a> </li><li>  <a href="https://habr.com/ru/post/448792/"><strong>Chapter 4: Builtin Fixtures</strong></a> (This article) </li><li>  <a href="https://habr.com/ru/post/448794/"><strong>Chapter 5: Plugins</strong></a> </li><li>  <a href="https://habr.com/ru/post/448796/"><strong>Chapter 6: Configuration</strong></a> </li><li>  <a href="https://habr.com/ru/post/448798/"><strong>Chapter 7: Using pytest with other tools</strong></a> </li></ul></div></div><br><p>  In the previous chapter, you looked at what fixtures are, how to write them, and how to use them for test data, as well as for setup and teardown code. </p><br><p> You also used conftest.py to share fixtures between tests in several test files.  At the end of Chapter 3, in pytest Fixtures, the following fixtures were installed on page 49 of the ‚ÄúTasks‚Äù project: <code>tasks_db_session</code> , <code>tasks_just_a_few</code> , <code>tasks_mult_per_owner</code> , <code>tasks_db</code> , <code>db_with_3_tasks</code> and db_with_multi_per_owner, which can be used by any test programmers who can use any test programs. needs them. </p><br><p>  Reusing ordinary fixtures is such a good idea that the pytest developers included some of the frequently required fixtures in pytest.  You have already seen how tmpdir and tmpdir_factory are used by the Tasks project in the area change area for Tasks project fixtures on page 59. You will understand them in more detail in this chapter. </p><br><p>  The built-in fixtures that come with pytest can help you do pretty useful things in your tests with ease and ease.  For example, in addition to processing temporary files, pytest includes built-in fixtures for accessing command line parameters, communication between test sessions, checking output streams, changing environment variables, and polling warnings.  Built-in fixtures are extensions to the pytest core functionality.  Let's now look at a few of the most commonly used embedded fixtures in order. </p><br><h2 id="ispolzovanie-tmpdir-i-tmpdir_factory">  Using tmpdir and tmpdir_factory </h2><br><p>  If you are testing something that reads, writes, or modifies files, you can use tmpdir to create files or directories used by one test, and you can use <code>tmpdir_factory</code> when you want to set up a directory for several tests. </p><br><p>  The tmpdir <code>tmpdir</code> has a function scope, and the <code>tmpdir_factory</code> fixture has a session scope.  Any single test that requires a temporary directory or file for only one test can use <code>tmpdir</code> .  This is also true for fixtures, which customizes a directory or file that must be recreated for each test function. </p><br><p>  Here is a simple example of using <code>tmpdir</code> : </p><br><blockquote> <a href="https://media.pragprog.com/titles/bopytest/code/ch4/test_tmpdir.py"><code>ch4/test_tmpdir.py</code></a> </blockquote> <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_tmpdir</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tmpdir)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># tmpdir    ,    # join()  ,    , #     a_file = tmpdir.join('something.txt') #    a_sub_dir = tmpdir.mkdir('anything') #      (  ) another_file = a_sub_dir.join('something_else.txt') #    'something.txt' a_file.write('contents may settle during shipping') #    'anything/something_else.txt' another_file.write('something different') #      assert a_file.read() == 'contents may settle during shipping' assert another_file.read() == 'something different'</span></span></code> </pre> <br><p>  The value returned from <code>tmpdir</code> is an object of type <a href="https://py.readthedocs.io/en/latest/path.html"><code>py.path.local.1</code></a> that seems like all we need for temporary directories and files.  However, there is one trick.  Because the <code>tmpdir</code> fixture <code>tmpdir</code> defined as a <em>function scope</em> , <code>tmpdir</code> cannot be used to create folders or files that should be available longer than a single test function.  For fixtures with a scope other than a function (class, module, session), <code>tmpdir_factory</code> is available. </p><br><p>  The tmpdir_factory <code>tmpdir_factory</code> very similar to <code>tmpdir</code> , but has a different interface.  As described in the ‚ÄúSpecification of Scope (Fixed Scope)‚Äù section, on page 56, functional area fixtures are run once for each test function, modular area fixtures are run once per module, class fixtures once for each class, and area check tests work once per session.  Thus, resources created in session area records have a lifetime of the entire session.  To show how similar <code>tmpdir</code> and <code>tmpdir_factory</code> , I‚Äôll <code>tmpdir</code> example, where <code>tmpdir_factory</code> : </p><br><blockquote>  <a href="https://media.pragprog.com/titles/bopytest/code/ch4/test_tmpdir.py">ch4 / test_tmpdir.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_tmpdir_factory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tmpdir_factory)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#      . a_dir   # ,    tmpdir a_dir = tmpdir_factory.mktemp('mydir') # base_temp    'mydir'    #  getbasetemp(),  # ,    base_temp = tmpdir_factory.getbasetemp() print('base:', base_temp) #       , #    ' test_tmpdir ()',   , #    a_dir  tmpdir a_file = a_dir.join('something.txt') a_sub_dir = a_dir.mkdir('anything') another_file = a_sub_dir.join('something_else.txt') a_file.write('contents may settle during shipping') another_file.write('something different') assert a_file.read() == 'contents may settle during shipping' assert another_file.read() == 'something different'</span></span></code> </pre> <br><p>  The first line uses <code>mktemp('mydir')</code> to create a directory and saves it to <code>a_dir</code> .  For the rest of the function, you can use <code>a_dir</code> in the same way as <code>tmpdir</code> returned from the <code>tmpdir</code> . </p><br><p>  In the second line of the <code>tmpdir_factory</code> example, the <code>getbasetemp()</code> function returns the base directory used for this session.  The <em>print</em> statement in the example is needed so that you can view the directory on your system.  Let's see where it is: </p><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /path/to/code/ch4 $ pytest -q -s test_tmpdir.py::test_tmpdir_factory base: /private/var/folders/53/zv4j_zc506x2xq25l31qxvxm0000gn/T/pytest-of-okken/pytest-732 . 1 passed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.04 seconds</code> </pre> <br><p>  This base directory is system and user dependent, and <code>pytest - NUM</code> changes for each session with increasing <code>NUM</code> .  The base directory is left alone after the session.  pytest clears it, and only the most recent few temporary base directories remain in the system, which is great if you want to check files after a test run. </p><br><p>  You can also specify your own base directory if you need to use <code>pytest --basetemp=mydir</code> . </p><br><h3 id="ispolzovanie-vremennyh-katalogov-dlya-drugih-oblastey">  Using temporary directories for other areas </h3><br><p>  We get the temporary directories and <strong>session</strong> area files from the <code>tmpdir_factory</code> , and the directories and <strong>function</strong> area files from the <code>tmpdir</code> .  But what about other areas?  What if we need a temporary directory for the scope of a module or class?  To do this, we create another fixture of the area of ‚Äã‚Äãthe desired size and for this you should use the <code>tmpdir_factory</code> . </p><br><p>  For example, suppose we have a module full of tests, and many of them should be able to read some data from the <em>json</em> file.  We were able to put the fixture volume of the module into the module itself, or into the <em>conftest.py</em> file, which configures the data file as follows: </p><br><blockquote>  <a href="https://media.pragprog.com/titles/bopytest/code/ch4/authors/conftest.py">ch4 / authors / conftest.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">"""Demonstrate tmpdir_factory."""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest @pytest.fixture(scope=<span class="hljs-string"><span class="hljs-string">'module'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">author_file_json</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tmpdir_factory)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""     ."""</span></span> python_author_data = { <span class="hljs-string"><span class="hljs-string">'Ned'</span></span>: {<span class="hljs-string"><span class="hljs-string">'City'</span></span>: <span class="hljs-string"><span class="hljs-string">'Boston'</span></span>}, <span class="hljs-string"><span class="hljs-string">'Brian'</span></span>: {<span class="hljs-string"><span class="hljs-string">'City'</span></span>: <span class="hljs-string"><span class="hljs-string">'Portland'</span></span>}, <span class="hljs-string"><span class="hljs-string">'Luciano'</span></span>: {<span class="hljs-string"><span class="hljs-string">'City'</span></span>: <span class="hljs-string"><span class="hljs-string">'Sau Paulo'</span></span>} } file = tmpdir_factory.mktemp(<span class="hljs-string"><span class="hljs-string">'data'</span></span>).join(<span class="hljs-string"><span class="hljs-string">'author_file.json'</span></span>) print(<span class="hljs-string"><span class="hljs-string">'file:{}'</span></span>.format(str(file))) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> file.open(<span class="hljs-string"><span class="hljs-string">'w'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: json.dump(python_author_data, f) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> file</code> </pre> <br><p>  The fixture <code>author_file_json()</code> creates a temporary directory named <em>data</em> and creates a file named <em>author_file.json</em> in the data directory.  It then writes the <code>python_author_data</code> dictionary as <em>json</em> .  Since this is the fixture of the module area, a json file will be created only once for each module using the test: </p><br><blockquote>  <strong>ch4 / authors / test_authors.py</strong> </blockquote><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">""" ,    ."""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_brian_in_portland</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(author_file_json)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""",   ."""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> author_file_json.open() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: authors = json.load(f) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> authors[<span class="hljs-string"><span class="hljs-string">'Brian'</span></span>][<span class="hljs-string"><span class="hljs-string">'City'</span></span>] == <span class="hljs-string"><span class="hljs-string">'Portland'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_all_have_cities</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(author_file_json)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""        ."""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> author_file_json.open() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: authors = json.load(f) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> authors: <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> len(authors[a][<span class="hljs-string"><span class="hljs-string">'City'</span></span>]) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  Both tests will use the same JSON file.  If one test data file works for several tests, it makes no sense to recreate it for both tests. </p><br><h2 id="ispolzovanie-pytestconfig">  Using pytestconfig </h2><br><p>  Using the built-in pytestconfig fixture, you can control how pytest works with command line arguments and parameters, configuration files, plugins, and the directory from which you started pytest.  The pytestconfig fix is ‚Äã‚Äãa shortcut to request.config, and is sometimes referred to in the pytest documentation as the " <em>pytest config object</em> " (pytest configuration object). </p><br><p>  To find out how <em>pytestconfig</em> works, you can see how to add a custom command line parameter and read the parameter value from the test.  You can read the command line parameters directly from pytestconfig, but to add a parameter and analyze it, you need to add a hook function.  The <em>hook</em> functions, which I describe in more detail in Chapter 5, ‚ÄúPlugins,‚Äù on page 95, are another way to control the behavior of pytest and are often used in plugins.  However, adding a custom command line option and reading it from <em>pytestconfig is</em> quite common, so I want to highlight it here. </p><br><p>  We will use the <em>pytest hook</em> <code>pytest_addoption</code> to add several parameters to the parameters already available on the pytest command line: </p><br><blockquote>  <a href="https://media.pragprog.com/titles/bopytest/code/ch4/pytestconfig/conftest.py">ch4 / pytestconfig / conftest.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pytest_addoption</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(parser)</span></span></span><span class="hljs-function">:</span></span> parser.addoption(<span class="hljs-string"><span class="hljs-string">"--myopt"</span></span>, action=<span class="hljs-string"><span class="hljs-string">"store_true"</span></span>, help=<span class="hljs-string"><span class="hljs-string">"some boolean option"</span></span>) parser.addoption(<span class="hljs-string"><span class="hljs-string">"--foo"</span></span>, action=<span class="hljs-string"><span class="hljs-string">"store"</span></span>, default=<span class="hljs-string"><span class="hljs-string">"bar"</span></span>, help=<span class="hljs-string"><span class="hljs-string">"foo: bar or baz"</span></span>)</code> </pre> <br><p>  Adding command line parameters via <code>pytest_addoption</code> should be done via plugins or in the <strong>conftest.py</strong> file located at the top of the project directory structure.  You should not do this in a test subdirectory. </p><br><p>  The parameters <code>--myopt</code> and <code>--foo &lt;value&gt;</code> were added to the previous code, and the help line was changed as shown below: </p><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /path/to/code/ch4/pytestconfig $ pytest --<span class="hljs-built_in"><span class="hljs-built_in">help</span></span> usage: pytest [options] [file_or_dir] [file_or_dir] [...] ... custom options: --myopt some boolean option --foo=FOO foo: bar or baz ...</code> </pre> <br><p>  Now we can access these options from the test: </p><br><blockquote>  <a href="https://media.pragprog.com/titles/bopytest/code/ch4/pytestconfig/test_config.py">ch4 / pytestconfig / test_config.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_option</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pytestconfig)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">'"foo" set to:'</span></span>, pytestconfig.getoption(<span class="hljs-string"><span class="hljs-string">'foo'</span></span>)) print(<span class="hljs-string"><span class="hljs-string">'"myopt" set to:'</span></span>, pytestconfig.getoption(<span class="hljs-string"><span class="hljs-string">'myopt'</span></span>))</code> </pre> <br><p>  Let's see how it works: </p><br><pre> <code class="bash hljs">$ pytest -s -q test_config.py::test_option <span class="hljs-string"><span class="hljs-string">"foo"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to: bar <span class="hljs-string"><span class="hljs-string">"myopt"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to: False .1 passed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.01 seconds $ pytest -s -q --myopt test_config.py::test_option <span class="hljs-string"><span class="hljs-string">"foo"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to: bar <span class="hljs-string"><span class="hljs-string">"myopt"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to: True .1 passed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.01 seconds $ pytest -s -q --myopt --foo baz test_config.py::test_option <span class="hljs-string"><span class="hljs-string">"foo"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to: baz <span class="hljs-string"><span class="hljs-string">"myopt"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to: True .1 passed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.01 seconds</code> </pre> <br><p>  Since pytestconfig is a fixture, it can also be obtained from other fixtures.  You can make fixtures for option names if you want, for example: </p><br><blockquote>  <a href="https://media.pragprog.com/titles/bopytest/code/ch4/pytestconfig/test_config.py">ch4 / pytestconfig / test_config.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@pytest.fixture() def foo(pytestconfig): return pytestconfig.option.foo @pytest.fixture() def myopt(pytestconfig): return pytestconfig.option.myopt def test_fixtures_for_options(foo, myopt): print('"foo" set to:', foo) print('"myopt" set to:', myopt)</span></span></code> </pre> <br><p>  You can also access the built-in parameters, not just the ones being added, as well as information about how pytest was run (directory, arguments, etc.). </p><br><p>  Here is an example of several values ‚Äã‚Äãand configuration parameters: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_pytestconfig</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pytestconfig)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">'args :'</span></span>, pytestconfig.args) print(<span class="hljs-string"><span class="hljs-string">'inifile :'</span></span>, pytestconfig.inifile) print(<span class="hljs-string"><span class="hljs-string">'invocation_dir :'</span></span>, pytestconfig.invocation_dir) print(<span class="hljs-string"><span class="hljs-string">'rootdir :'</span></span>, pytestconfig.rootdir) print(<span class="hljs-string"><span class="hljs-string">'-k EXPRESSION :'</span></span>, pytestconfig.getoption(<span class="hljs-string"><span class="hljs-string">'keyword'</span></span>)) print(<span class="hljs-string"><span class="hljs-string">'-v, --verbose :'</span></span>, pytestconfig.getoption(<span class="hljs-string"><span class="hljs-string">'verbose'</span></span>)) print(<span class="hljs-string"><span class="hljs-string">'-q, --quiet :'</span></span>, pytestconfig.getoption(<span class="hljs-string"><span class="hljs-string">'quiet'</span></span>)) print(<span class="hljs-string"><span class="hljs-string">'-l, --showlocals:'</span></span>, pytestconfig.getoption(<span class="hljs-string"><span class="hljs-string">'showlocals'</span></span>)) print(<span class="hljs-string"><span class="hljs-string">'--tb=style :'</span></span>, pytestconfig.getoption(<span class="hljs-string"><span class="hljs-string">'tbstyle'</span></span>))</code> </pre> <br><p>  We will return to pytestconfig when I demonstrate the ini-files in Chapter 6, ‚ÄúConfiguration,‚Äù on page 113. </p><br><h2 id="using-cache">  Using cache </h2><br><p>  Usually, we, testers, think that each test is as independent as possible from other tests.  You should make sure that the order accounting dependencies have not crept.  I would like to be able to run or restart any test in any order and get the same result.  In addition, it is necessary that test sessions be repeatable and do not change the behavior based on previous test sessions. </p><br><p>  However, sometimes transferring information from one test session to another can be very useful.  When we want to pass information to future test sessions, we can do this with the built-in <code>cache</code> fixture. </p><br><p>  The <code>cache</code> fix is ‚Äã‚Äãdesigned to store information about one test session and receive it in the next.  An excellent example of using <code>cache</code> privileges for business use is the built-in functionality <code>--last-failed</code> and <code>--failed-first</code> .  Let's see how the data for these flags is stored in the cache. </p><br><p>  Here is the help text for the options <code>--last-failed</code> and <code>--failed-first</code> , as well as several <code>cache</code> parameters: </p><br><pre> <code class="plaintext hljs">$ pytest --help ... --lf, --last-failed rerun only the tests that failed at the last run (or all if none failed) --ff, --failed-first run all tests but run the last failures first. This may re-order tests and thus lead to repeated fixture setup/teardown --cache-show show cache contents, don t perform collection or tests --cache-clear remove all cache contents at start of test run. ...</code> </pre> <br><p>  To see them in action, we will use these two tests: </p><br><p>  <a href="https//media.pragprog.com/titles/bopytest/code/ch4/cache/test_pass_fail.py">ch4 / cache / test_pass_fail.py</a> </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_this_passes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> == <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_this_fails</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> == <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br><p>  Let's run them using <code>--verbose</code> to see the function names, and <code>--tb=no</code> to hide the stack trace: </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch4/cache $ pytest --verbose --tb=no test_pass_fail.py ==================== test session starts ==================== collected 2 items test_pass_fail.py::test_this_passes PASSED test_pass_fail.py::test_this_fails FAILED ============ 1 failed, 1 passed in 0.05 seconds =============</code> </pre> <br><p>  If you run them again with the <code>--ff</code> or <code>--failed-first</code> flag, then the tests that failed earlier will be executed first, and then the entire session: </p><br><pre> <code class="plaintext hljs">$ pytest --verbose --tb=no --ff test_pass_fail.py ==================== test session starts ==================== run-last-failure: rerun last 1 failures first collected 2 items test_pass_fail.py::test_this_fails FAILED test_pass_fail.py::test_this_passes PASSED ============ 1 failed, 1 passed in 0.04 seconds =============</code> </pre> <br><p>  Or you can use <code>--lf</code> or <code>--last-failed</code> to simply run tests that failed last time: </p><br><pre> <code class="plaintext hljs">$ pytest --verbose --tb=no --lf test_pass_fail.py ==================== test session starts ==================== run-last-failure: rerun last 1 failures collected 2 items test_pass_fail.py::test_this_fails FAILED ==================== 1 tests deselected ===================== ========== 1 failed, 1 deselected in 0.05 seconds ===========</code> </pre> <br><p>  Before we look at how crash data is stored and how you can use the same mechanism, let's look at another example that makes the value <code>--lf</code> and <code>--ff</code> even more obvious. </p><br><p>  Here is a parameterized test with one failure: </p><br><blockquote>  <a href="https://media.pragprog.com/titles/bopytest/code/ch4/cache/test_few_failures.py">ch4 / cache / test_few_failures.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">"""Demonstrate -lf and -ff with failing tests."""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pytest <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> approx testdata = [ <span class="hljs-comment"><span class="hljs-comment"># x, y, expected (1.01, 2.01, 3.02), (1e25, 1e23, 1.1e25), (1.23, 3.21, 4.44), (0.1, 0.2, 0.3), (1e25, 1e24, 1.1e25) ] @pytest.mark.parametrize("x,y,expected", testdata) def test_a(x, y, expected): """Demo approx().""" sum_ = x + y assert sum_ == approx(expected)</span></span></code> </pre> <br><p>  And at the exit: </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch4/cache $ pytest -q test_few_failures.py .F... ====================== FAILURES ====================== _________________________ test_a[1e+25-1e+23-1.1e+25] _________________________ x = 1e+25, y = 1e+23, expected = 1.1e+25 @pytest.mark.parametrize("x,y,expected", testdata) def test_a(x, y, expected): """Demo approx().""" sum_ = x + y &gt; assert sum_ == approx(expected) E assert 1.01e+25 == 1.1e+25 ¬± 1.1e+19 E + where 1.1e+25 ¬± 1.1e+19 = approx(1.1e+25) test_few_failures.py:17: AssertionError 1 failed, 4 passed in 0.06 seconds</code> </pre> <br><p>  Maybe you can identify the problem right away.  But let's imagine that the test is longer and more difficult, and it is not so obvious that this is not the case.  Let's run the test again to see the error again.  The test case can be specified on the command line: </p><br><pre> <code class="plaintext hljs">$ pytest -q "test_few_failures.py::test_a[1e+25-1e+23-1.1e+25]"</code> </pre> <br><p>  If you do not want to copy-paste <em>(copy / paste</em> ) or if several unsuccessful cases happen that you would like to restart, then <code>--lf</code> much easier.  And if you are really debugging a test failure, another flag that can ease the situation, <code>--showlocals</code> , or <code>-l</code> for short: </p><br><pre> <code class="plaintext hljs">$ pytest -q --lf -l test_few_failures.py F ====================== FAILURES ====================== _________________________ test_a[1e+25-1e+23-1.1e+25] _________________________ x = 1e+25, y = 1e+23, expected = 1.1e+25 @pytest.mark.parametrize("x,y,expected", testdata) def test_a(x, y, expected): """Demo approx().""" sum_ = x + y &gt; assert sum_ == approx(expected) E assert 1.01e+25 == 1.1e+25 ¬± 1.1e+19 E + where 1.1e+25 ¬± 1.1e+19 = approx(1.1e+25) expected = 1.1e+25 sum_ = 1.01e+25 x = 1e+25 y = 1e+23 test_few_failures.py:17: AssertionError ================= 4 tests deselected ================= 1 failed, 4 deselected in 0.05 seconds</code> </pre><br><p>  The reason for the failure should be more obvious. </p><br><p>  In order to keep in mind that the test could not last time, there is a little trick.  pytest stores test error information from the last test session and you can view the saved information with <code>--cache-show</code> : </p><br><pre> <code class="plaintext hljs">$ pytest --cache-show ===================== test session starts ====================== ------------------------- cache values ------------------------- cache/lastfailed contains: {'test_few_failures.py::test_a[1e+25-1e+23-1.1e+25]': True} ================= no tests ran in 0.00 seconds =================</code> </pre> <br><p>  Or you can look in the cache directory: </p><br><pre> <code class="plaintext hljs">$ cat .cache/v/cache/lastfailed { "test_few_failures.py::test_a[1e+25-1e+23-1.1e+25]": true }</code> </pre> <br><p>  The <code>--clear-cache</code> option allows you to clear the cache before a session. </p><br><p>  The cache can be used not only for <code>--lf</code> and <code>--ff</code> .  Let's write a fixture that records how long tests take, saves time, and the next time it starts it reports an error in tests that take twice as long as more time than, say, last time. </p><br><p>  The interface for cash fixture is simple. </p><br><pre> <code class="plaintext hljs">cache.get(key, default) cache.set(key, value)</code> </pre> <br><p>  By convention, the key names begin with the name of your application or plugin, followed by <code>/</code> , and continue to separate the key name sections with <code>/</code> .  The value that you store can be anything that is converted to <em>json</em> , as represented in the <code>.cache directory</code> . </p><br><p>  Here is our fixture used to record test times: </p><br><p>  <a href="https://media.pragprog.com/titles/bopytest/code/ch4/cache/test_slower.py">ch4 / cache / test_slower.py</a> </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@pytest.fixture(autouse=True) def check_duration(request, cache): key = 'duration/' + request.node.nodeid.replace(':', '_') #   (nodeid)    #      .cache #    -     start_time = datetime.datetime.now() yield stop_time = datetime.datetime.now() this_duration = (stop_time - start_time).total_seconds() last_duration = cache.get(key, None) cache.set(key, this_duration) if last_duration is not None: errorstring = "       2-  " assert this_duration &lt;= last_duration * 2, errorstring</span></span></code> </pre> <br><p>  Since the fixture is <em>autouse</em> , it does not need to be referenced from the test.  The <em>request</em> object is used to get the <em>nodeid</em> to use in the key.  <em>nodeid</em> is a unique identifier that works even with parameterized tests.  We add a key with 'duration /' to be good cache dwellers.  The code above <em>yield</em> is executed before the test function;  code after <em>yield</em> is executed after the test function. </p><br><p>  Now we need some tests that take different time intervals: </p><br><p>  <a href="https://media.pragprog.com/titles/bopytest/code/ch4/cache/test_slower.py">ch4 / cache / test_slower.py</a> </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@pytest.mark.parametrize('i', range(5)) def test_slow_stuff(i): time.sleep(random.random())</span></span></code> </pre> <br><p>  Since you probably don‚Äôt want to write a bunch of tests for this, I used <code>random</code> and parameterization to easily generate some tests that sleep for a random amount of time, shorter than a second.  Let's see how it works a couple of times: </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch4/cache $ pytest -q --cache-clear test_slower.py ..... 5 passed in 2.10 seconds $ pytest -q --tb=line test_slower.py ...E..E =================================== ERRORS ==================================== ___________________ ERROR at teardown of test_slow_stuff[1] ___________________ E AssertionError: test duration over 2x last duration assert 0.35702 &lt;= (0.148009 * 2) ___________________ ERROR at teardown of test_slow_stuff[4] ___________________ E AssertionError: test duration over 2x last duration assert 0.888051 &lt;= (0.324019 * 2) 5 passed, 2 error in 3.17 seconds</code> </pre> <br><p>  Well, that was fun.  Let's see what's in the cache: </p><br><pre> <code class="plaintext hljs">$ pytest -q --cache-show -------------------------------- cache values --------------------------------- cache\lastfailed contains: {'test_slower.py::test_slow_stuff[2]': True, 'test_slower.py::test_slow_stuff[4]': True} cache\nodeids contains: ['test_slower.py::test_slow_stuff[0]', 'test_slower.py::test_slow_stuff[1]', 'test_slower.py::test_slow_stuff[2]', 'test_slower.py::test_slow_stuff[3]', 'test_slower.py::test_slow_stuff[4]'] cache\stepwise contains: [] duration\test_slower.py__test_slow_stuff[0] contains: 0.958055 duration\test_slower.py__test_slow_stuff[1] contains: 0.214012 duration\test_slower.py__test_slow_stuff[2] contains: 0.19001 duration\test_slower.py__test_slow_stuff[3] contains: 0.725041 duration\test_slower.py__test_slow_stuff[4] contains: 0.836048 no tests ran in 0.03 seconds</code> </pre> <br><p>  You can easily see the <code>duration</code> data separately from the cache data due to the prefix of the cache data names.  However, it is interesting that <code>lastfailed</code> functionality can work with a single cache entry.  Our duration data takes one cache entry for each test.  Let's follow the lastfailed example and put our data in one record. </p><br><p>  We read and write to the cache for each test.  We can divide the fixture into the fixture of the function scope for measuring the duration and the fixture of the session scope for reading and writing to the cache.  However, if we do this, we will not be able to use the cache fixture, because it has the scope of the function.  Fortunately, a quick glance at the implementation on <a href="https://github.com/pytest-dev/pytest/blob/master/src/_pytest/cacheprovider.py">GitHub</a> shows that the cache fixture simply returns <code>request.config.cache</code> .  It is available in any area. </p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Here is one of the possible reorganizations of the same functionality: </font></font></p><br><p> <a href="https://media.pragprog.com/titles/bopytest/code/ch4/cache/test_slower_2.py"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ch4 / cache / test_slower_2.py</font></font></a> </p><br><pre> <code class="python hljs">Duration = namedtuple(<span class="hljs-string"><span class="hljs-string">'Duration'</span></span>, [<span class="hljs-string"><span class="hljs-string">'current'</span></span>, <span class="hljs-string"><span class="hljs-string">'last'</span></span>]) @pytest.fixture(scope=<span class="hljs-string"><span class="hljs-string">'session'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">duration_cache</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request)</span></span></span><span class="hljs-function">:</span></span> key = <span class="hljs-string"><span class="hljs-string">'duration/testdurations'</span></span> d = Duration({}, request.config.cache.get(key, {})) <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> d request.config.cache.set(key, d.current) @pytest.fixture(autouse=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check_duration</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request, duration_cache)</span></span></span><span class="hljs-function">:</span></span> d = duration_cache nodeid = request.node.nodeid start_time = datetime.datetime.now() <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> duration = (datetime.datetime.now() - start_time).total_seconds() d.current[nodeid] = duration <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> d.last.get(nodeid, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: errorstring = <span class="hljs-string"><span class="hljs-string">"test duration over 2x last duration"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> duration &lt;= (d.last[nodeid] * <span class="hljs-number"><span class="hljs-number">2</span></span>), errorstring</code> </pre> <br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fixture </font></font><code>duration_cache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">belongs to the session area. </font><font style="vertical-align: inherit;">It reads the previous entry or empty dictionary if there are no previous cached data before running any tests. </font><font style="vertical-align: inherit;">In the previous code, we saved both the extracted dictionary and the empty one in the </font></font><code>namedtuple</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">named </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Duration</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with access methods </font></font><code>current</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>last</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Then we passed this </font></font><code>namedtuple</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to </font></font><code>test_duration</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which is a function and runs for each test function. </font><font style="vertical-align: inherit;">As the test runs, the same </font></font><code>namedtuple</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is passed to each test, and the time for the current test is stored in the dictionary </font></font><code>d.current</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">At the end of the test session, the collected current dictionary is saved in the cache.</font></font></p><br><p>     ,     : </p><br><pre> <code class="plaintext hljs">$ pytest -q --cache-clear test_slower_2.py ..... 5 passed in 2.80 seconds $ pytest -q --tb=no test_slower_2.py ...EE.. 7 passed, 2 error in 3.21 seconds $ pytest -q --cache-show -------------------------------- cache values --------------------------------- cache\lastfailed contains: {'test_slower_2.py::test_slow_stuff[2]': True, 'test_slower_2.py::test_slow_stuff[3]': True} duration\testdurations contains: {'test_slower_2.py::test_slow_stuff[0]': 0.483028, 'test_slower_2.py::test_slow_stuff[1]': 0.198011, 'test_slower_2.py::test_slow_stuff[2]': 0.426024, 'test_slower_2.py::test_slow_stuff[3]': 0.762044, 'test_slower_2.py::test_slow_stuff[4]': 0.056003, 'test_slower_2.py::test_slow_stuff[5]': 0.18401, 'test_slower_2.py::test_slow_stuff[6]': 0.943054} no tests ran in 0.02 seconds</code> </pre> <br><p>  . </p><br><h2 id="ispolzovanie-capsys">  capsys </h2><br><p>  <code>capsys builtin</code>    :   stdout  stderr   ,     .     stdout  stderr. </p><br><p> ,         stdout: </p><br><blockquote> <a href="https://media.pragprog.com/titles/bopytest/code/ch4/cap/test_capsys.py">ch4/cap/test_capsys.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">greeting</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">'Hi, {}'</span></span>.format(name))</code> </pre> <br><p>     ,   .   -  stdout.       capsys: </p><br><blockquote> <a href="https://media.pragprog.com/titles/bopytest/code/ch4/cap/test_capsys.py">ch4/cap/test_capsys.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_greeting</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(capsys)</span></span></span><span class="hljs-function">:</span></span> greeting(<span class="hljs-string"><span class="hljs-string">'Earthling'</span></span>) out, err = capsys.readouterr() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> out == <span class="hljs-string"><span class="hljs-string">'Hi, Earthling\n'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> err == <span class="hljs-string"><span class="hljs-string">''</span></span> greeting(<span class="hljs-string"><span class="hljs-string">'Brian'</span></span>) greeting(<span class="hljs-string"><span class="hljs-string">'Nerd'</span></span>) out, err = capsys.readouterr() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> out == <span class="hljs-string"><span class="hljs-string">'Hi, Brian\nHi, Nerd\n'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> err == <span class="hljs-string"><span class="hljs-string">''</span></span></code> </pre> <br><p>  <code>stdout</code>  <code>stderr</code>   <code>capsys.redouterr()</code> .   ‚Äî  ,      ,     . </p><br><p>      <code>stdout</code> .    ,   <code>stderr</code> : </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">yikes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(problem)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">'YIKES! {}'</span></span>.format(problem), file=sys.stderr) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_yikes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(capsys)</span></span></span><span class="hljs-function">:</span></span> yikes(<span class="hljs-string"><span class="hljs-string">'Out of coffee!'</span></span>) out, err = capsys.readouterr() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> out == <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> <span class="hljs-string"><span class="hljs-string">'Out of coffee!'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> err</code> </pre> <br><p> <em>pytest</em>        .     <em>print</em> .            .  <code>-s</code>   ,      stdout    .    ,        ,      .   ,             pytest  ,    ,   .      <em>capsys</em> .    <code>capsys.disabled()</code> ,       . </p><br><p>  Here is an example: </p><br><blockquote> <a href="https://media.pragprog.com/titles/bopytest/code/ch4/cap/test_capsys.py">ch4/cap/test_capsys.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_capsys_disabled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(capsys)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> capsys.disabled(): print(<span class="hljs-string"><span class="hljs-string">'\nalways print this'</span></span>) <span class="hljs-comment"><span class="hljs-comment">#    print('normal print, usually captured') #  ,  </span></span></code> </pre> <br><p> , <em>'always print this'</em>   : </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch4/cap $ pytest -q test_capsys.py::test_capsys_disabled</code> </pre> <br><p>    ,  <code>always print this</code>        ,        <code>capys.disabled()</code> .   print ‚Äî     print,  <code>normal print, usually captured</code> ( ,  ),    ,     <code>-s</code> ,     <code>--capture=no</code> ,   . </p><br><h2 id="ispolzovanie-monkeypatch">  monkeypatch </h2><br><p> "monkey patch" ‚Äî         .    "monkey patching" ‚Äî                ,      ,     .   <code>monkeypatch</code>       .    ,   ,    ,  ,    .    ,       .   API  ,  monkeypatch    . </p><br><p>  <code>monkeypatch</code>   : </p><br><ul><li> <code>setattr(target, name, value=&lt;notset&gt;, raising=True)</code> :  . </li><li> <code>delattr(target, name=&lt;notset&gt;, raising=True)</code> :  . </li><li> <code>setitem(dic, name, value)</code> :    . </li><li> <code>delitem(dic, name, raising=True)</code> :    . </li><li> <code>setenv(name, value, prepend=None)</code> :    . </li><li> <code>delenv(name, raising=True)</code> :   . </li><li> <code>syspath_prepend(path)</code> :    sys.,       Python. </li><li> <code>chdir(path)</code> :    . </li></ul><br><p>  <code>raising</code>  pytest,    ,     .  <code>prepend</code>  <code>setenv()</code>   .   ,        <code>+ prepend + &lt;old value&gt;</code> . </p><br><p>   monkeypatch  ,    ,   dot- .           ,   dot-    .    ,     cheese-  : </p><br><blockquote> <a href="https://media.pragprog.com/titles/bopytest/code/ch4/monkey/cheese.py">ch4/monkey/cheese.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_cheese_preferences</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> full_path = os.path.expanduser(<span class="hljs-string"><span class="hljs-string">'~/.cheese.json'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(full_path, <span class="hljs-string"><span class="hljs-string">'r'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: prefs = json.load(f) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prefs <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write_cheese_preferences</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(prefs)</span></span></span><span class="hljs-function">:</span></span> full_path = os.path.expanduser(<span class="hljs-string"><span class="hljs-string">'~/.cheese.json'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(full_path, <span class="hljs-string"><span class="hljs-string">'w'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: json.dump(prefs, f, indent=<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write_default_cheese_preferences</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> write_cheese_preferences(_default_prefs) _default_prefs = { <span class="hljs-string"><span class="hljs-string">'slicing'</span></span>: [<span class="hljs-string"><span class="hljs-string">'manchego'</span></span>, <span class="hljs-string"><span class="hljs-string">'sharp cheddar'</span></span>], <span class="hljs-string"><span class="hljs-string">'spreadable'</span></span>: [<span class="hljs-string"><span class="hljs-string">'Saint Andre'</span></span>, <span class="hljs-string"><span class="hljs-string">'camembert'</span></span>, <span class="hljs-string"><span class="hljs-string">'bucheron'</span></span>, <span class="hljs-string"><span class="hljs-string">'goat'</span></span>, <span class="hljs-string"><span class="hljs-string">'humbolt fog'</span></span>, <span class="hljs-string"><span class="hljs-string">'cambozola'</span></span>], <span class="hljs-string"><span class="hljs-string">'salads'</span></span>: [<span class="hljs-string"><span class="hljs-string">'crumbled feta'</span></span>] }</code> </pre> <br><p>  ,      <code>write_default_cheese_preferences()</code> .  ,         .    ,    .        . </p><br><p>      ,          . ,       <code>read_cheese_preferences()</code> ,    ,        <code>write_default_cheese_preferences()</code> : </p><br><blockquote> <a href="https://media.pragprog.com/titles/bopytest/code/ch4/monkey/test_cheese.py">ch4/monkey/test_cheese.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_def_prefs_full</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> cheese.write_default_cheese_preferences() expected = cheese._default_prefs actual = cheese.read_cheese_preferences() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> expected == actual</code> </pre> <br><p>        ,  ,     ,    cheese- .     . </p><br><p>     <code>HOME set</code> , <code>os.path.expanduser()</code>  <code>~</code> ,       <code>HOME</code> .       <code>HOME</code> ,       : </p><br><blockquote> <a href="https://media.pragprog.com/titles/bopytest/code/ch4/monkey/test_cheese.py">ch4/monkey/test_cheese.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_def_prefs_change_home</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tmpdir, monkeypatch)</span></span></span><span class="hljs-function">:</span></span> monkeypatch.setenv(<span class="hljs-string"><span class="hljs-string">'HOME'</span></span>, tmpdir.mkdir(<span class="hljs-string"><span class="hljs-string">'home'</span></span>)) cheese.write_default_cheese_preferences() expected = cheese._default_prefs actual = cheese.read_cheese_preferences() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> expected == actual</code> </pre> <br><p>    ,  <code>HOME</code>      .     -  <code>expanduser()</code> ,     ,    <a href="https://docs.python.org/3.6/library/os.path.html">¬´On Windows, HOME and USERPROFILE will be used if set, otherwise a combination of‚Ä¶.¬ª</a> .  Wow!      ,    Windows.  ,     . </p><br><p>  ,     <code>HOME</code> ,   <code>expanduser</code> : </p><br><blockquote> <a href="https://media.pragprog.com/titles/bopytest/code/ch4/monkey/test_cheese.py">ch4/monkey/test_cheese.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_def_prefs_change_expanduser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tmpdir, monkeypatch)</span></span></span><span class="hljs-function">:</span></span> fake_home_dir = tmpdir.mkdir(<span class="hljs-string"><span class="hljs-string">'home'</span></span>) monkeypatch.setattr(cheese.os.path, <span class="hljs-string"><span class="hljs-string">'expanduser'</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x: x.replace(<span class="hljs-string"><span class="hljs-string">'~'</span></span>, str(fake_home_dir)))) cheese.write_default_cheese_preferences() expected = cheese._default_prefs actual = cheese.read_cheese_preferences() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> expected == actual</code> </pre> <br><p>    ,    <em>cheese</em>  <code>os.path.expanduser()</code>     -.         <code>re.sub</code>   <code>~</code>    .    <code>setenv()</code>  <code>setattr()</code>      . , <code>setitem()</code> . </p><br><p> ,   ,  ,    .    ,      ,   <code>write_default_cheese_preferences()</code> : </p><br><blockquote> <a href="https://media.pragprog.com/titles/bopytest/code/ch4/monkey/test_cheese.py">ch4/monkey/test_cheese.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_def_prefs_change_defaults</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tmpdir, monkeypatch)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#      fake_home_dir = tmpdir.mkdir('home') monkeypatch.setattr(cheese.os.path, 'expanduser', (lambda x: x.replace('~', str(fake_home_dir)))) cheese.write_default_cheese_preferences() defaults_before = copy.deepcopy(cheese._default_prefs) #     monkeypatch.setitem(cheese._default_prefs, 'slicing', ['provolone']) monkeypatch.setitem(cheese._default_prefs, 'spreadable', ['brie']) monkeypatch.setitem(cheese._default_prefs, 'salads', ['pepper jack']) defaults_modified = cheese._default_prefs #       cheese.write_default_cheese_preferences() #    actual = cheese.read_cheese_preferences() assert defaults_modified == actual assert defaults_modified != defaults_before</span></span></code> </pre> <br><p>  <code>_default_prefs</code> - ,    <code>monkeypatch.setitem()</code> ,        . </p><br><p>   <code>setenv()</code> , <code>setattr()</code>  <code>setitem()</code> .  <code>del</code>  .     ,      ,  - .    <code>monkeypatch</code>   . </p><br><p> <code>syspath_prepend(path)</code>    <code>sys.path</code> ,    ,            .          stub-.      <code>monkeypatch.syspath_prepend()</code> ,     ,      stub-. </p><br><p> <code>chdir(path)</code>       .            ,      .        ,      ,    <code>monkeypatch.chdir(the_tmpdir)</code> . </p><br><p>       monkeypatch    <code>unittest.mock</code> ,      .      7 " pytest   "  . 125. </p><br><h2 id="ispolzovanie-doctest_namespace">  doctest_namespace </h2><br><p>  <em>doctest</em>     Python         <em>docstrings</em>   ,  ,   .    pytest      <em>doctest</em>   Python    <code>--doctest-modules</code> .    <code>doctest_namespace</code> ,      <em>autouse</em> ,       <em>pytest</em>     doctest .   docstrings    . </p><br><p> <code>doctest_namespace</code>         ,    Python       . , <code>numpy</code>    <code>import numpy as np</code> . </p><br><p>    . ,       <code>unnecessary_math.py</code>   <code>multiply()</code>  <code>divide()</code> ,    .  ,        docstring ,    docstrings : </p><br><blockquote> <a href="https://media.pragprog.com/titles/bopytest/code/ch4/dt/1/unnecessary_math.py">ch4/dt/1/unnecessary_math.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">""" This module defines multiply(a, b) and divide(a, b). &gt;&gt;&gt; import unnecessary_math as um Here's how you use multiply: &gt;&gt;&gt; um.multiply(4, 3) 12 &gt;&gt;&gt; um.multiply('a', 3) 'aaa' Here's how you use divide: &gt;&gt;&gt; um.divide(10, 5) 2.0 """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">multiply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Returns a multiplied by b. &gt;&gt;&gt; um.multiply(4, 3) 12 &gt;&gt;&gt; um.multiply('a', 3) 'aaa' """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a * b <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">divide</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Returns a divided by b. &gt;&gt;&gt; um.divide(10, 5) 2.0 """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a / b</code> </pre><br><p>   <code>unnecessary_math</code> ,    <code>um</code>  ,  <code>import noecessary_math as um</code>   -.   docstrings     <code>import</code> ,     <code>um</code> .   ,  pytest   docstring    .    docstring    ,    docstrings    : </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch4/dt/1 $ pytest -v --doctest-modules --tb=short unnecessary_math.py ============================= test session starts ============================= collected 3 items unnecessary_math.py::unnecessary_math PASSED unnecessary_math.py::unnecessary_math.divide FAILED unnecessary_math.py::unnecessary_math.multiply FAILED ================================== FAILURES =================================== ______________________ [doctest] unnecessary_math.divide ______________________ 034 035 Returns a divided by b. 036 037 &gt;&gt;&gt; um.divide(10, 5) UNEXPECTED EXCEPTION: NameError("name 'um' is not defined",) Traceback (most recent call last): ... File "&lt;doctest unnecessary_math.divide[0]&gt;", line 1, in &lt;module&gt; NameError: name 'um' is not defined ... _____________________ [doctest] unnecessary_math.multiply _____________________ 022 023 Returns a multiplied by b. 024 025 &gt;&gt;&gt; um.multiply(4, 3) UNEXPECTED EXCEPTION: NameError("name 'um' is not defined",) Traceback (most recent call last): ... File "&lt;doctest unnecessary_math.multiply[0]&gt;", line 1, in &lt;module&gt; NameError: name 'um' is not defined /path/to/code/ch4/dt/1/unnecessary_math.py:23: UnexpectedException ================ 2 failed, 1 passed in 0.03 seconds =================</code> </pre><br><p>     -  <code>import</code>   docstring: </p><br><blockquote> <a href="https://media.pragprog.com/titles/bopytest/code/ch4/dt/2/unnecessary_math.py">ch4/dt/2/unnecessary_math.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">""" This module defines multiply(a, b) and divide(a, b). &gt;&gt;&gt; import unnecessary_math as um Here's how you use multiply: &gt;&gt;&gt; um.multiply(4, 3) 12 &gt;&gt;&gt; um.multiply('a', 3) 'aaa' Here's how you use divide: &gt;&gt;&gt; um.divide(10, 5) 2.0 """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">multiply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Returns a multiplied by b. &gt;&gt;&gt; import unnecessary_math as um &gt;&gt;&gt; um.multiply(4, 3) 12 &gt;&gt;&gt; um.multiply('a', 3) 'aaa' """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a * b <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">divide</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Returns a divided by b. &gt;&gt;&gt; import unnecessary_math as um &gt;&gt;&gt; um.divide(10, 5) 2.0 """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a / b</code> </pre> <br><p>    : </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch4/dt/2 $ pytest -v --doctest-modules --tb=short unnecessary_math.py ============================= test session starts ============================= collected 3 items unnecessary_math.py::unnecessary_math PASSED [ 33%] unnecessary_math.py::unnecessary_math.divide PASSED [ 66%] unnecessary_math.py::unnecessary_math.multiply PASSED [100%] ===================== 3 passed in 0.03 seconds ======================</code> </pre> <br><p>     docstrings        . </p><br><p>   <code>doctest_namespace</code> ,   <code>autouse</code>   <code>conftest.py</code>  ,      : </p><br><blockquote> <a href="https://media.pragprog.com/titles/bopytest/code/ch4/dt/3/conftest.py">ch4/dt/3/conftest.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> unnecessary_math @pytest.fixture(autouse=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_um</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(doctest_namespace)</span></span></span><span class="hljs-function">:</span></span> doctest_namespace[<span class="hljs-string"><span class="hljs-string">'um'</span></span>] = unnecessary_math</code> </pre> <br><p>   pytest   <code>um</code>  <code>doctest_namespace</code> ,     <code>unnecessary_math</code> .     conftest.py,  doctests,     conftest.py    <code>um</code> . </p><br><p>     doctest  pytest   7 " pytest   "  . 125. </p><br><h2 id="ispolzovanie-recwarn">  recwarn </h2><br><p>   <code>recwarn</code>    ,   .  Python    ,     ,    ,      . , ,      ,         ,      .             : </p><br><blockquote> <a href="https://media.pragprog.com/titles/bopytest/code/ch4/test_warnings.py">ch4/test_warnings.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> warnings <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lame_function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> warnings.warn(<span class="hljs-string"><span class="hljs-string">"Please stop using this"</span></span>, DeprecationWarning) <span class="hljs-comment"><span class="hljs-comment"># rest of function</span></span></code> </pre> <br><p>   ,      : </p><br><blockquote> <a href="https://media.pragprog.com/titles/bopytest/code/ch4/test_warnings.py">ch4/test_warnings.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_lame_function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(recwarn)</span></span></span><span class="hljs-function">:</span></span> lame_function() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> len(recwarn) == <span class="hljs-number"><span class="hljs-number">1</span></span> w = recwarn.pop() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> w.category == DeprecationWarning <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> str(w.message) == <span class="hljs-string"><span class="hljs-string">'Please stop using this'</span></span></code> </pre> <br><p>  recwarn    ,        <code>category</code> (), <code>message</code> (), <code>filename</code> ( )  <code>lineno</code> ( ),    . </p><br><p>      .   ,     ,      ,     .      <code>recwarn.clear()</code> ,     ,      . </p><br><p>    <code>recwarn</code> , pytest      <code>pytest.warns()</code> : </p><br><blockquote> <a href="https://media.pragprog.com/titles/bopytest/code/ch4/test_warnings.py">ch4/test_warnings.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_lame_function_2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> pytest.warns(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> warning_list: lame_function() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> len(warning_list) == <span class="hljs-number"><span class="hljs-number">1</span></span> w = warning_list.pop() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> w.category == DeprecationWarning <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> str(w.message) == <span class="hljs-string"><span class="hljs-string">'Please stop using this'</span></span></code> </pre> <br><p>   <code>pytest.warns()</code>         .  <code>recwarn</code>    <code>pytest.warns()</code>   ,    ,  ,    . </p><br><h2 id="uprazhneniya">  Exercises </h2><br><ol><li>  <code>ch4/cache/test_slower.py</code>   <code>autouse</code> ,  <code>check_duration()</code> .    <code>ch3/tasks_proj/tests/conftest.py</code> . </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Perform tests from Chapter 3. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For really very fast tests, 2x is really fast still very fast. </font><font style="vertical-align: inherit;">Instead of 2x, change the fixture to check for 0.1 seconds plus 2x for the last duration.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Run pytest with the modified fixture. </font><font style="vertical-align: inherit;">The results seem reasonable?</font></font></li></ol><br><h2 id="chto-dalshe">  What's next </h2><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this chapter, you covered several pytest built-in fixtures. </font><font style="vertical-align: inherit;">Next, you will look at Plugins in more detail. </font><font style="vertical-align: inherit;">The nuances of writing large plugins can become a book in and of themselves; </font><font style="vertical-align: inherit;">however, small custom plugins are a regular part of the pytest ecosystem.</font></font></p><br><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://habr.com/ru/post/448786/">Back</a> <a href="https://habr.com/ru/post/448794/">Next</a> <img src="https://habrastorage.org/webt/rw/dy/-g/rwdy-grsvbpcetjttrmecdkxtlk.png"></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/448792/">https://habr.com/ru/post/448792/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../448780/index.html">What gives software for recruiting money</a></li>
<li><a href="../448782/index.html">Python Testing with pytest. Getting started with pytest, Chapter 1</a></li>
<li><a href="../448786/index.html">Python Testing with pytest. CHAPTER 3 pytest Fixtures</a></li>
<li><a href="../448788/index.html">Python Testing with pytest. Chapter 2, Writing Test Functions</a></li>
<li><a href="../448790/index.html">SpaceVIL - cross-platform GUI framework for development on .Net Core, .Net Standard and JVM</a></li>
<li><a href="../448794/index.html">Python Testing with pytest. Plugins, CHAPTER 5</a></li>
<li><a href="../448796/index.html">Python Testing with pytest. Configuration, CHAPTER 6</a></li>
<li><a href="../448798/index.html">Python Testing with pytest. Using pytest with other tools, CHAPTER 7</a></li>
<li><a href="../448806/index.html">Creating an extension system on the Qt library</a></li>
<li><a href="../448810/index.html">How I caught a hacker</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>