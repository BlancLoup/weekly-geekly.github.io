<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The implementation of the block cipher "Grasshopper" with CFB mode in C ++</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today we will talk about the new Grasshopper block encryption algorithm from the GOST R 34.12 2015 standard. Recently there have been many publication...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The implementation of the block cipher "Grasshopper" with CFB mode in C ++</h1><div class="post__text post__text-html js-mediator-article">  Today we will talk about the new Grasshopper block encryption algorithm from the GOST R 34.12 2015 standard. Recently there have been many publications devoted to this standard.  From a theoretical point of view, the described algorithm is described in them, the features of hotel transformations are studied, and optimization methods are proposed by including insertions of the code in assembly language. <br><br>  In this article, I propose to the reader to become familiar with the implementation of this block cipher in C ++.  It should be noted that when writing this program, the goal was not to achieve the greatest efficiency, and the main task was to show how the algorithm works.  Read the description of the algorithm in the official <a href="https://tc26.ru/standard/gost/GOST_R_3412-2015.pdf">documentation</a> . <br><br><h4>  Program structure </h4><br>  The program consists of three parts. <br><ul><li>  a set of helper functions and classes - mycrypto.cpp mycrypto.hpp </li><li>  block cipher "Grasshopper" - Kuznyechik.cpp Kuznyechik.hpp </li><li>  encryption mode Cipher Feed Back - modes.hpp </li></ul><a name="habracut"></a><br><h5>  Used notation </h5><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BLOCK_LENGTH 16 typedef unsigned char BYTE; typedef unsigned short WORD;</span></span></code> </pre> <br><h4>  Auxiliary means </h4><br><h5>  Class byteblock </h5><br><div class="spoiler">  <b class="spoiler_title">Interface byteblock</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ByteBlock</span></span></span><span class="hljs-class"> {</span></span> BYTE * pBlocks; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> amount_of_bytes; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-comment"><span class="hljs-comment">// Construct block of bytes which contsists of // size_ blocks each of them with init_value in it ByteBlock(size_t size_ = 0, BYTE init_value = 0); // Construct block with size_ first bytes of pBlocks_ // The value will be copied, source stays untouchable ByteBlock(BYTE * pBlocks_, size_t size_); // Move constructor // Copy constructor thus implicitly deleted // Object to move turn to null ByteBlock(ByteBlock &amp;&amp; rhs); // Destructor, yeah ~ByteBlock(); // Move assigment operator // Object to move turn to null void operator = (ByteBlock &amp;&amp; rhs); // This cast may be convenient to use the ByteBlock // in functions which takes raw pointers as argument BYTE * byte_ptr(); const BYTE * byte_ptr() const; // Indexing operator with evident functionality BYTE &amp; operator [] (size_t index); BYTE operator [] (size_t index) const; bool operator == (const ByteBlock &amp; lhs) const; bool operator != (const ByteBlock &amp; lhs) const; // Replace body of the current block with pBlocks_ // Old value will be zerod, and then, deleted // New value copied into the block, // source stays untouchable void reset(const BYTE * pBlocks_, size_t size_); // Return amount of bytes in block size_t size() const; // It'll return deep copy of the block, which // points to different place in memory ByteBlock deep_copy() const; // It'll return slice of current ByteBlock ByteBlock operator () (size_t begin, size_t length) const; // Changes values between two ByteBlock-s friend void swap(ByteBlock &amp; lhs, ByteBlock &amp; rhs); };</span></span></code> </pre></div></div><br>  Objects of this class (hereinafter referred to as ‚Äúmessages‚Äù) are commonly used in the program for storing information in binary form.  The interface was designed in such a way that the following tasks were effectively solved: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Storing byte strings of arbitrary length </li><li>  Ensuring the "uniqueness" of messages in memory </li><li>  Reset memory before freeing memory </li><li>  Ensuring timely removal of messages </li><li>  Providing convenient access to hotel bytes, and sequences of bytes in the message </li></ul><br>  Uniqueness is ensured by the fact that the copy constructor and the copy assignment operator are prohibited (implicitly), since similar moving functions are described. <br><br>  Objects of the ByteBlock class always own the memory pointed to.  Even when an object is initialized with a certain section of memory, the designer copies it to a new location, and the object works with a copy of the original information.  In a sense, this class is similar to the smart pointer from STL - std :: unique_ptr. <br>  Memory reset is provided by the memset function.  It is worth noting that when building this program, it is not necessary to specify optimization options, since some compilers tend to ignore the memset function call, knowing that the memory will not be used later, and will soon be deleted. <br><br><h5>  Translation of hex strings to ByteBlock and back </h5><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hex_representation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ByteBlock &amp; bb)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">ByteBlock </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hex_to_bytes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; s)</span></span></span></span>;</code> </pre><br>  These functions convert the input data from hexadecimal to their byte representation, which is necessary for the further work of the program. <br><br><h4>  Algorithm "Grasshopper" </h4><br><div class="spoiler">  <b class="spoiler_title">Kuznyechik interface</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Kuznyechik</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;ByteBlock&gt; keys; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> is_init; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> block_lenght { BLOCK_LENGTH }; Kuznyechik(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ByteBlock &amp; key); Kuznyechik(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Kuznyechik &amp; rhs); ~Kuznyechik(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encrypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ByteBlock &amp; src, ByteBlock &amp; dst)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decrypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ByteBlock &amp; src, ByteBlock &amp; dst)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; };</code> </pre></div></div><br>  The keys field is an iterative key that is calculated once during the initialization of the object using the specified key.  The is_init field is a flag that indicates whether Kuznyechik type objects have ever been created.  This flag is necessary due to the fact that at the time of launch of the program many coefficients and parameters of the algorithm are missing.  At the first initialization, they are calculated and stored in memory until the program is completed. <br><br>  Taking into account the above, it is necessary to comment on the presence of the copy constructor, whereas inside the class there are ByteBlock objects that do not have this constructor.  The fact is that when copying, elementwise deep copying of iteration keys from the keys array takes place. <br><br><h5>  Global variables and their initialization </h5><br><div class="spoiler">  <b class="spoiler_title">Used global variables</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;BYTE&gt; nonlinear_transform_perm = { <span class="hljs-number"><span class="hljs-number">252</span></span>, <span class="hljs-number"><span class="hljs-number">238</span></span>, <span class="hljs-number"><span class="hljs-number">221</span></span>, <span class="hljs-number"><span class="hljs-number">17</span></span>, <span class="hljs-number"><span class="hljs-number">207</span></span>, <span class="hljs-number"><span class="hljs-number">110</span></span>, <span class="hljs-number"><span class="hljs-number">49</span></span>, <span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">196</span></span>, <span class="hljs-number"><span class="hljs-number">250</span></span>, <span class="hljs-number"><span class="hljs-number">218</span></span>, <span class="hljs-number"><span class="hljs-number">35</span></span>, <span class="hljs-number"><span class="hljs-number">197</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">77</span></span>, <span class="hljs-number"><span class="hljs-number">233</span></span>, <span class="hljs-number"><span class="hljs-number">119</span></span>, <span class="hljs-number"><span class="hljs-number">240</span></span>, <span class="hljs-number"><span class="hljs-number">219</span></span>, <span class="hljs-number"><span class="hljs-number">147</span></span>, <span class="hljs-number"><span class="hljs-number">46</span></span>, <span class="hljs-number"><span class="hljs-number">153</span></span>, <span class="hljs-number"><span class="hljs-number">186</span></span>, <span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-number"><span class="hljs-number">54</span></span>, <span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">187</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">205</span></span>, <span class="hljs-number"><span class="hljs-number">95</span></span>, <span class="hljs-number"><span class="hljs-number">193</span></span>, <span class="hljs-number"><span class="hljs-number">249</span></span>, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">101</span></span>, <span class="hljs-number"><span class="hljs-number">90</span></span>, <span class="hljs-number"><span class="hljs-number">226</span></span>, <span class="hljs-number"><span class="hljs-number">92</span></span>, <span class="hljs-number"><span class="hljs-number">239</span></span>, <span class="hljs-number"><span class="hljs-number">33</span></span>, <span class="hljs-number"><span class="hljs-number">129</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-number"><span class="hljs-number">66</span></span>, <span class="hljs-number"><span class="hljs-number">139</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">142</span></span>, <span class="hljs-number"><span class="hljs-number">79</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">132</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">174</span></span>, <span class="hljs-number"><span class="hljs-number">227</span></span>, <span class="hljs-number"><span class="hljs-number">106</span></span>, <span class="hljs-number"><span class="hljs-number">143</span></span>, <span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-number"><span class="hljs-number">237</span></span>, <span class="hljs-number"><span class="hljs-number">152</span></span>, <span class="hljs-number"><span class="hljs-number">127</span></span>, <span class="hljs-number"><span class="hljs-number">212</span></span>, <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">235</span></span>, <span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">44</span></span>, <span class="hljs-number"><span class="hljs-number">81</span></span>, <span class="hljs-number"><span class="hljs-number">234</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-number"><span class="hljs-number">72</span></span>, <span class="hljs-number"><span class="hljs-number">171</span></span>, <span class="hljs-number"><span class="hljs-number">242</span></span>, <span class="hljs-number"><span class="hljs-number">42</span></span>, <span class="hljs-number"><span class="hljs-number">104</span></span>, <span class="hljs-number"><span class="hljs-number">162</span></span>, <span class="hljs-number"><span class="hljs-number">253</span></span>, <span class="hljs-number"><span class="hljs-number">58</span></span>, <span class="hljs-number"><span class="hljs-number">206</span></span>, <span class="hljs-number"><span class="hljs-number">204</span></span>, <span class="hljs-number"><span class="hljs-number">181</span></span>, <span class="hljs-number"><span class="hljs-number">112</span></span>, <span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">86</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">118</span></span>, <span class="hljs-number"><span class="hljs-number">18</span></span>, <span class="hljs-number"><span class="hljs-number">191</span></span>, <span class="hljs-number"><span class="hljs-number">114</span></span>, <span class="hljs-number"><span class="hljs-number">19</span></span>, <span class="hljs-number"><span class="hljs-number">71</span></span>, <span class="hljs-number"><span class="hljs-number">156</span></span>, <span class="hljs-number"><span class="hljs-number">183</span></span>, <span class="hljs-number"><span class="hljs-number">93</span></span>, <span class="hljs-number"><span class="hljs-number">135</span></span>, <span class="hljs-number"><span class="hljs-number">21</span></span>, <span class="hljs-number"><span class="hljs-number">161</span></span>, <span class="hljs-number"><span class="hljs-number">150</span></span>, <span class="hljs-number"><span class="hljs-number">41</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">154</span></span>, <span class="hljs-number"><span class="hljs-number">199</span></span>, <span class="hljs-number"><span class="hljs-number">243</span></span>, <span class="hljs-number"><span class="hljs-number">145</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">111</span></span>, <span class="hljs-number"><span class="hljs-number">157</span></span>, <span class="hljs-number"><span class="hljs-number">158</span></span>, <span class="hljs-number"><span class="hljs-number">178</span></span>, <span class="hljs-number"><span class="hljs-number">177</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">117</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">61</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">53</span></span>, <span class="hljs-number"><span class="hljs-number">138</span></span>, <span class="hljs-number"><span class="hljs-number">126</span></span>, <span class="hljs-number"><span class="hljs-number">109</span></span>, <span class="hljs-number"><span class="hljs-number">84</span></span>, <span class="hljs-number"><span class="hljs-number">198</span></span>, <span class="hljs-number"><span class="hljs-number">128</span></span>, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">189</span></span>, <span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-number"><span class="hljs-number">87</span></span>, <span class="hljs-number"><span class="hljs-number">223</span></span>, <span class="hljs-number"><span class="hljs-number">245</span></span>, <span class="hljs-number"><span class="hljs-number">36</span></span>, <span class="hljs-number"><span class="hljs-number">169</span></span>, <span class="hljs-number"><span class="hljs-number">62</span></span>, <span class="hljs-number"><span class="hljs-number">168</span></span>, <span class="hljs-number"><span class="hljs-number">67</span></span>, <span class="hljs-number"><span class="hljs-number">201</span></span>, <span class="hljs-number"><span class="hljs-number">215</span></span>, <span class="hljs-number"><span class="hljs-number">121</span></span>, <span class="hljs-number"><span class="hljs-number">214</span></span>, <span class="hljs-number"><span class="hljs-number">246</span></span>, <span class="hljs-number"><span class="hljs-number">124</span></span>, <span class="hljs-number"><span class="hljs-number">34</span></span>, <span class="hljs-number"><span class="hljs-number">185</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">224</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">236</span></span>, <span class="hljs-number"><span class="hljs-number">222</span></span>, <span class="hljs-number"><span class="hljs-number">122</span></span>, <span class="hljs-number"><span class="hljs-number">148</span></span>, <span class="hljs-number"><span class="hljs-number">176</span></span>, <span class="hljs-number"><span class="hljs-number">188</span></span>, <span class="hljs-number"><span class="hljs-number">220</span></span>, <span class="hljs-number"><span class="hljs-number">232</span></span>, <span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-number"><span class="hljs-number">78</span></span>, <span class="hljs-number"><span class="hljs-number">51</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">74</span></span>, <span class="hljs-number"><span class="hljs-number">167</span></span>, <span class="hljs-number"><span class="hljs-number">151</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>, <span class="hljs-number"><span class="hljs-number">115</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">98</span></span>, <span class="hljs-number"><span class="hljs-number">68</span></span>, <span class="hljs-number"><span class="hljs-number">26</span></span>, <span class="hljs-number"><span class="hljs-number">184</span></span>, <span class="hljs-number"><span class="hljs-number">56</span></span>, <span class="hljs-number"><span class="hljs-number">130</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">159</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">65</span></span>, <span class="hljs-number"><span class="hljs-number">173</span></span>, <span class="hljs-number"><span class="hljs-number">69</span></span>, <span class="hljs-number"><span class="hljs-number">70</span></span>, <span class="hljs-number"><span class="hljs-number">146</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>, <span class="hljs-number"><span class="hljs-number">94</span></span>, <span class="hljs-number"><span class="hljs-number">85</span></span>, <span class="hljs-number"><span class="hljs-number">47</span></span>, <span class="hljs-number"><span class="hljs-number">140</span></span>, <span class="hljs-number"><span class="hljs-number">163</span></span>, <span class="hljs-number"><span class="hljs-number">165</span></span>, <span class="hljs-number"><span class="hljs-number">125</span></span>, <span class="hljs-number"><span class="hljs-number">105</span></span>, <span class="hljs-number"><span class="hljs-number">213</span></span>, <span class="hljs-number"><span class="hljs-number">149</span></span>, <span class="hljs-number"><span class="hljs-number">59</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">88</span></span>, <span class="hljs-number"><span class="hljs-number">179</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">134</span></span>, <span class="hljs-number"><span class="hljs-number">172</span></span>, <span class="hljs-number"><span class="hljs-number">29</span></span>, <span class="hljs-number"><span class="hljs-number">247</span></span>, <span class="hljs-number"><span class="hljs-number">48</span></span>, <span class="hljs-number"><span class="hljs-number">55</span></span>, <span class="hljs-number"><span class="hljs-number">107</span></span>, <span class="hljs-number"><span class="hljs-number">228</span></span>, <span class="hljs-number"><span class="hljs-number">136</span></span>, <span class="hljs-number"><span class="hljs-number">217</span></span>, <span class="hljs-number"><span class="hljs-number">231</span></span>, <span class="hljs-number"><span class="hljs-number">137</span></span>, <span class="hljs-number"><span class="hljs-number">225</span></span>, <span class="hljs-number"><span class="hljs-number">27</span></span>, <span class="hljs-number"><span class="hljs-number">131</span></span>, <span class="hljs-number"><span class="hljs-number">73</span></span>, <span class="hljs-number"><span class="hljs-number">76</span></span>, <span class="hljs-number"><span class="hljs-number">63</span></span>, <span class="hljs-number"><span class="hljs-number">248</span></span>, <span class="hljs-number"><span class="hljs-number">254</span></span>, <span class="hljs-number"><span class="hljs-number">141</span></span>, <span class="hljs-number"><span class="hljs-number">83</span></span>, <span class="hljs-number"><span class="hljs-number">170</span></span>, <span class="hljs-number"><span class="hljs-number">144</span></span>, <span class="hljs-number"><span class="hljs-number">202</span></span>, <span class="hljs-number"><span class="hljs-number">216</span></span>, <span class="hljs-number"><span class="hljs-number">133</span></span>, <span class="hljs-number"><span class="hljs-number">97</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">113</span></span>, <span class="hljs-number"><span class="hljs-number">103</span></span>, <span class="hljs-number"><span class="hljs-number">164</span></span>, <span class="hljs-number"><span class="hljs-number">45</span></span>, <span class="hljs-number"><span class="hljs-number">43</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">91</span></span>, <span class="hljs-number"><span class="hljs-number">203</span></span>, <span class="hljs-number"><span class="hljs-number">155</span></span>, <span class="hljs-number"><span class="hljs-number">37</span></span>, <span class="hljs-number"><span class="hljs-number">208</span></span>, <span class="hljs-number"><span class="hljs-number">190</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">108</span></span>, <span class="hljs-number"><span class="hljs-number">82</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">116</span></span>, <span class="hljs-number"><span class="hljs-number">210</span></span>, <span class="hljs-number"><span class="hljs-number">230</span></span>, <span class="hljs-number"><span class="hljs-number">244</span></span>, <span class="hljs-number"><span class="hljs-number">180</span></span>, <span class="hljs-number"><span class="hljs-number">192</span></span>, <span class="hljs-number"><span class="hljs-number">209</span></span>, <span class="hljs-number"><span class="hljs-number">102</span></span>, <span class="hljs-number"><span class="hljs-number">175</span></span>, <span class="hljs-number"><span class="hljs-number">194</span></span>, <span class="hljs-number"><span class="hljs-number">57</span></span>, <span class="hljs-number"><span class="hljs-number">75</span></span>, <span class="hljs-number"><span class="hljs-number">99</span></span>, <span class="hljs-number"><span class="hljs-number">182</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>&lt;BYTE, BYTE&gt; direct_permutation, inverse_permutation; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;WORD&gt; linear_transform_coeff = { <span class="hljs-number"><span class="hljs-number">148</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">133</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">194</span></span>, <span class="hljs-number"><span class="hljs-number">192</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">192</span></span>, <span class="hljs-number"><span class="hljs-number">194</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">133</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">148</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> WORD linear_transform_modulus = <span class="hljs-number"><span class="hljs-number">0x1C3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;ByteBlock&gt; iteration_constants;</code> </pre></div></div><br>  It is here that we see those variables that, when launched, do not store the values ‚Äã‚Äãnecessary for the operation of the algorithm.  These are direct_permutation, inverse_permutation, which are used for non-linear transformation, and iteration_constants, which are used to expand the key.  They are filled in as follows: <br><br><div class="spoiler">  <b class="spoiler_title">Global variable initialization</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init_perms</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>&lt;BYTE, BYTE&gt; *p_direct, *p_inverse; p_direct = <span class="hljs-keyword"><span class="hljs-keyword">const_cast</span></span>&lt; <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>&lt;BYTE, BYTE&gt; * &gt;(&amp;direct_permutation); p_inverse = <span class="hljs-keyword"><span class="hljs-keyword">const_cast</span></span>&lt; <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>&lt;BYTE, BYTE&gt; * &gt;(&amp;inverse_permutation); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nonlinear_transform_perm.size(); i++) { (*p_direct)[i] = nonlinear_transform_perm[i]; (*p_inverse)[nonlinear_transform_perm[i]] = i; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init_consts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;ByteBlock&gt; * p = <span class="hljs-keyword"><span class="hljs-keyword">const_cast</span></span>&lt; <span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;ByteBlock&gt; * &gt;(&amp;iteration_constants); ByteBlock v128; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(BYTE i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt;= <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { v128 = ByteBlock(BLOCK_LENGTH, <span class="hljs-number"><span class="hljs-number">0</span></span>); v128[BLOCK_LENGTH - <span class="hljs-number"><span class="hljs-number">1</span></span>] = i; iteration_linear_transform_direct128(v128.byte_ptr()); p-&gt;push_back(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(v128)); } }</code> </pre></div></div><br><h5>  Implementation of the transformations used in the algorithm </h5><br>  All conversions work with ordinary pointers: the conversion from ByteBlock to BYTE * does not require additional costs, and the check that the size of the allocated memory corresponds to the cipher parameters has been performed at a higher level. <br><br><div class="spoiler">  <b class="spoiler_title">Nonlinear direct conversion</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nonlinear_transform_direct128</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BYTE * target)</span></span></span><span class="hljs-function"> </span></span>{ BYTE * p_end = target + BLOCK_LENGTH; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(target != p_end) { *target = direct_permutation.at(*target); target++; } }</code> </pre></div></div><br>  A nonlinear transformation is nothing more than an ordinary permutation. <br><br><div class="spoiler">  <b class="spoiler_title">Linear direct transform</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">iteration_linear_transform_direct128</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BYTE * target)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">16</span></span>; i++) linear_transform_direct128(target); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">linear_transform_direct128</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BYTE * target)</span></span></span><span class="hljs-function"> </span></span>{ BYTE buffer = linear_transform_core128(target); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = BLOCK_LENGTH - <span class="hljs-number"><span class="hljs-number">1</span></span>; i &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; i--) target[i] = target[i<span class="hljs-number"><span class="hljs-number">-1</span></span>]; *target = buffer; } <span class="hljs-function"><span class="hljs-function">BYTE </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">linear_transform_core128</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> BYTE * target)</span></span></span><span class="hljs-function"> </span></span>{ WORD result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; BLOCK_LENGTH; i++) result ^= multiply(target[i], linear_transform_coeff[i]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-function">WORD </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">multiply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WORD lhs, WORD rhs)</span></span></span><span class="hljs-function"> </span></span>{ WORD result = <span class="hljs-number"><span class="hljs-number">0</span></span>, modulus = linear_transform_modulus &lt;&lt; <span class="hljs-number"><span class="hljs-number">7</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(WORD detecter = <span class="hljs-number"><span class="hljs-number">0x1</span></span>; detecter != <span class="hljs-number"><span class="hljs-number">0x100</span></span>; detecter &lt;&lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>, lhs &lt;&lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(rhs &amp; detecter) result ^= lhs; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(WORD detecter = <span class="hljs-number"><span class="hljs-number">0x8000</span></span>; detecter != <span class="hljs-number"><span class="hljs-number">0x80</span></span>; detecter &gt;&gt;= <span class="hljs-number"><span class="hljs-number">1</span></span>, modulus &gt;&gt;= <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(result &amp; detecter) result ^= modulus; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre></div></div><br>  It will be interesting to dwell on the function multiply.  Its peculiarity lies in the fact that when performing a linear transformation, all calculations are carried out in the factor ring GL (2) [x] / p (x), where p (x) = x ^ 8 + x ^ 7 + x ^ 6 + x + 1. In the first cycle, the polynomials multiplied by their coefficients from GL (2) are multiplied.  In the second cycle, the value modulo p (x) is calculated step by step. <br><br><h5>  Deploy iteration keys </h5><br><div class="spoiler">  <b class="spoiler_title">Functions for generating iterative keys</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">keys_transform128</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BYTE * k1, BYTE * k2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> iconst)</span></span></span><span class="hljs-function"> </span></span>{ BYTE buffer[BLOCK_LENGTH]; <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(buffer, k1, BLOCK_LENGTH); xor128(k1, k1, iteration_constants[iconst].byte_ptr()); nonlinear_transform_direct128(k1); iteration_linear_transform_direct128(k1); xor128(k1, k2, k1); <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(k2, buffer, BLOCK_LENGTH); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">key_derivation128</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BYTE * k1, BYTE * k2, BYTE * k3, BYTE * k4, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ipair)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(k1 != k3) <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(k3, k1, BLOCK_LENGTH); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(k2 != k4) <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(k4, k2, BLOCK_LENGTH); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>; i++) keys_transform128(k3, k4, ipair * <span class="hljs-number"><span class="hljs-number">8</span></span> + i); }</code> </pre></div></div><br>  And finally, the encryption algorithm in our notation will be as follows: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encrypt128</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BYTE * target, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">vector</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;ByteBlock&gt; &amp; keys)</span></span></span><span class="hljs-function"> </span></span>{ xor128(target, target, keys[<span class="hljs-number"><span class="hljs-number">0</span></span>].byte_ptr()); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { nonlinear_transform_direct128(target); iteration_linear_transform_direct128(target); xor128(target, target, keys[i].byte_ptr()); } }</code> </pre><br>  Here are only options for functions acting in the "direct" direction.  In other words, performing encryption.  Decryption functions are implemented in exactly the same way. <br><br><h4>  CFB Encryption Mode </h4><br><div class="spoiler">  <b class="spoiler_title">Interface CFB_Mode</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> CipherType&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CFB_Mode</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CipherType algorithm; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ByteBlock iv; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decrypt_with_iv</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ByteBlock &amp; src, ByteBlock &amp; dst, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ByteBlock &amp; iv_)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: CFB_Mode(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CipherType &amp; alg, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ByteBlock &amp; init_vec); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encrypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ByteBlock &amp; src, ByteBlock &amp; dst)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decrypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ByteBlock &amp; src, ByteBlock &amp; dst)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parallel_decrypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ByteBlock &amp; src, ByteBlock &amp; dst)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; };</code> </pre></div></div><br>  The choice of block encryption mode was random.  By analogy, other modes are easily written.  Those familiar with the CryptoPP library may have a sense of deja vu, and this will be justified.  After all, this approach to the implementation of the interaction of the block cipher and encryption mode used in this library. <br><br>  In order to be able to use the block cipher in tandem with this template class, the class that implements it must meet the following requirements: <br><br><ul><li>  Open encrypt and decrypt methods are described with the same prototype as in the CFB_Mode class. </li><li>  There is an open field block_length storing the number of bytes corresponding to the length of the cipher block </li></ul><br>  Obviously, our class Kuznyechik meets these requirements. <br><br><h5>  Encryption and decryption function </h5><br>  In these algorithms, auxiliary functions are used, which break all messages into blocks, multiples of the length at which a particular block cipher works, merge them back, as well as element-wise xor. <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;ByteBlock&gt; split_blocks(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ByteBlock &amp; src, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> length); <span class="hljs-function"><span class="hljs-function">ByteBlock </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">join_blocks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">vector</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;ByteBlock&gt; &amp; blocks)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xor_blocks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ByteBlock &amp; to_assign, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ByteBlock &amp; lhs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ByteBlock &amp; rhs)</span></span></span></span>;</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Encryption function</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> CipherType&gt; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CFB_Mode&lt;CipherType&gt;::encrypt(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ByteBlock &amp; src, ByteBlock &amp; dst) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> blocks = split_blocks(src, CipherType::block_lenght); ByteBlock tmp; algorithm.encrypt(iv, tmp); xor_blocks(tmp, tmp, blocks[<span class="hljs-number"><span class="hljs-number">0</span></span>]); blocks[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(tmp); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; blocks.size(); i++) { algorithm.encrypt(blocks[i<span class="hljs-number"><span class="hljs-number">-1</span></span>], tmp); xor_blocks(tmp, tmp, blocks[i]); blocks[i] = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(tmp); } dst = join_blocks(blocks); }</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Decryption function</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> CipherType&gt; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CFB_Mode&lt;CipherType&gt;::decrypt(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ByteBlock &amp; src, ByteBlock &amp; dst) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { decrypt_with_iv(src, dst, iv); } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> CipherType&gt; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CFB_Mode&lt;CipherType&gt;::decrypt_with_iv(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ByteBlock &amp; src, ByteBlock &amp; dst, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ByteBlock &amp; iv_) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> blocks = split_blocks(src, CipherType::block_lenght); ByteBlock tmp; algorithm.encrypt(iv_, tmp); xor_blocks(tmp, blocks[<span class="hljs-number"><span class="hljs-number">0</span></span>], tmp); swap(tmp, blocks[<span class="hljs-number"><span class="hljs-number">0</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; blocks.size(); i++) { algorithm.encrypt(tmp, tmp); xor_blocks(tmp, blocks[i], tmp); swap(tmp, blocks[i]); } dst = join_blocks(blocks); }</code> </pre></div></div><br>  The decision to split the decryption function into multiple components seems redundant.  This would be the case if the ciphertext feedback encryption mode did not support parallelism for this procedure.  Next will be considered a variant of the decryption algorithm using the std :: threads thread from the C ++ 11 standard. <br><br><div class="spoiler">  <b class="spoiler_title">Concurrency decryption function</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> CipherType&gt; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CFB_Mode&lt;CipherType&gt;::parallel_decrypt(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ByteBlock &amp; src, ByteBlock &amp; dst) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-comment"><span class="hljs-comment">// length in blocks of CipherType::block_lenght unsigned long const length = src.size() / CipherType::block_lenght + (src.size() % CipherType::block_lenght ? 1 : 0); // amount of threads which can perform really simultaniously unsigned long const hardware_threads = std::thread::hardware_concurrency(); // blocks of size CipherType::block_lenght to perform on by one thread unsigned long const min_per_thread = 1; // amount of threads to satisfy current condition unsigned long const max_threads = (length + min_per_thread - 1) / min_per_thread; // amount of threads to create unsigned long const num_threads = std::min( hardware_threads != 0 ? hardware_threads : 2, max_threads ); // if we aren't able to use multiple threads call common decryptor if(num_threads &lt;= 1) { decrypt(src, dst); return; } std::cerr &lt;&lt; "Running " &lt;&lt; num_threads &lt;&lt; " threads." &lt;&lt; endl; unsigned long const block_size = (length / num_threads) * CipherType::block_lenght; std::vector&lt;ByteBlock&gt; init_vectors(num_threads); std::vector&lt;ByteBlock&gt; results(num_threads); std::vector&lt;std::thread&gt; threads(num_threads - 1); init_vectors[0] = iv.deep_copy(); for(int i = 1; i &lt; num_threads; i++) init_vectors[i] = src(i * block_size - CipherType::block_lenght, CipherType::block_lenght); unsigned long start_pos = 0; for(unsigned long i = 0; i &lt; num_threads - 1; i++) { threads[i] = std::thread( &amp;CFB_Mode&lt;CipherType&gt;::decrypt_with_iv, this, src(start_pos, block_size), std::ref( results[i] ), std::ref( init_vectors[i] ) ); start_pos += block_size; } decrypt_with_iv( src(start_pos, src.size() - start_pos), results[num_threads - 1], init_vectors[num_threads - 1] ); for(auto &amp; t : threads) t.join(); dst = join_blocks(results); }</span></span></code> </pre><br></div></div><br><h4>  An example of a program that encrypts a message </h4><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"mycrypto.hpp"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Kuznyechik.hpp"</span></span></span><span class="hljs-meta"> int main() { ByteBlock key = hex_representation( </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"8899aabbccddeeff0011223344556677fedcba98765432100123456789abcdef"</span></span></span><span class="hljs-meta"> ); ByteBlock iv = hex_representation(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"abcdef12345600dacdef94756eeabefa"</span></span></span><span class="hljs-meta">); ByteBlock msg = hex_representation(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"1122334455667700ffeeddccbbaa9988"</span></span></span><span class="hljs-meta">); ByteBlock result; CFB_Mode</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Kuznyechik&gt; encryptor(Kuznyechik(key), iv); encryptor.encrypt(msg, result); return 0; }</span></span></span></span></code> </pre><br>  The repository of the project is located <a href="https://github.com/KoSeAn97/Encryptor-With-Kuznyechik">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/313932/">https://habr.com/ru/post/313932/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../313918/index.html">Impressive Ellipsis (The Mighty Ellipsis)</a></li>
<li><a href="../313922/index.html">Scrolling content by touching and dragging on jQuery</a></li>
<li><a href="../313924/index.html">The infrastructure of the communication center from the kettle, or the next construction of server - part 2</a></li>
<li><a href="../313926/index.html">Mass customer robbery Fix-Price</a></li>
<li><a href="../313930/index.html">Most players will not go through your game, and that's fine.</a></li>
<li><a href="../313934/index.html">Concept of life program</a></li>
<li><a href="../313936/index.html">Modeling of enterprise assets: modern standards and practice</a></li>
<li><a href="../313938/index.html">Flexbox Cheat Sheet (CSS3 Flexible Box)</a></li>
<li><a href="../313940/index.html">The digest of interesting materials for the mobile # 177 developer (October 24-30)</a></li>
<li><a href="../313942/index.html">LED Management Tutorial with the Robotics Development Kit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>