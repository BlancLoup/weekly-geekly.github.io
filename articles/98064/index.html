<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Organization of live broadcast from ip camera on site</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction  Task  Consider the task of organizing a live video broadcast from an ip camera on the site. Our stand consists of three components: 

- ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Organization of live broadcast from ip camera on site</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><h5>  Task </h5>  Consider the task of organizing a live video broadcast from an ip camera on the site.  Our stand consists of three components: <ul><li>  ip camera </li><li>  media server </li><li>  flash player in client side browser </li></ul><a name="habracut"></a><h5>  Select ip camera </h5>  In order to be comfortable to take stream from the camera, it must support live video transmission (usually via the <a href="http://ru.wikipedia.org/wiki/RTSP">RTSP</a> protocol).  There is another option when you can pick up a JPEG with the current frame via HTTP from the camera at any time, but this is not so convenient.  Therefore, the D'Link DCS-2121 camera with RTSP support was selected. <h5>  Media server </h5>  The most difficult part of the configuration.  The functions of getting video from the camera, converting it to the required format, caching and distribution to clients fall on it.  Looking ahead, I will say that it is expedient to distribute in this case either via the adobe RTMP protocol, which is natively supported by flash players, or via HTTP.  For RTMP there are paid solutions: <a href="http://www.adobe.com/products/flashmediaserver/">FMS</a> , <a href="http://www.wowzamedia.com/">Wowza</a> (the latter is free with the number of simultaneous connections less than ten) and free ( <a href="http://osflash.org/red5">red5</a> and <a href="http://www.rtmpd.com/">rtmpd</a> ).  If you distribute via HTTP, then there are even more options, since the task is divided into two subtasks: <ol><li>  video conversion </li><li>  video distribution </li></ol>  Naturally, the number of combinations grows.  For distribution, you can use, for example, apache or lighthttpd.  To convert - ffmpeg. In my case it was necessary to do everything <ol><li>  under linux </li><li>  is free </li><li>  simply </li></ol>  Therefore, I stopped at the simple, in my opinion, simple version, in which on the server we need only one program - the <a href="http://www.videolan.org/vlc/">VLC</a> video <a href="http://www.videolan.org/vlc/">player</a> , which, by the way, we will configure and compile for our needs.  This video player does not yet have normal support for RTMP, so we will give the flv file via HTTP. <h4>  flash player in client side browser </h4>  In principle, anyone should approach, but for some reason I didn‚Äôt manage to set up <a href="http://www.longtailvideo.com/">JW Player</a> .  The FLV file was infinitely downloaded to the client, and the buffering did not end.  The deadline was pressed and changed the player to the <a href="http://flowplayer.org/">Flow player</a> , as a result of which this problem disappeared. <h4>  Customization </h4><h5>  Agreements </h5>  In order not to make reservations further, we will assume that I have the server ip address - 10.0.0.2, cameras - 10.0.0.3, mask 255.0.0.0 and gateway 10.0.0.1, in Linux I work under user user, I run all the necessary commands via sudo . <h5>  Camera setup </h5>  We will configure the camera via the web interface, set the necessary network parameters: ip address, mask, gateway, set the time.  We also need to specify the port on which the camera will transmit the RTSP stream (the standard port 554 is used, and I left it).  In the section "Audio and Video" we will set the characteristics of the video that we need.  In any case, we can change the bitrate and size of the image later on the server when converting, but in order to keep everything neat, we‚Äôll point out here and now.  We will use MPEG4 640x480, 15 fps, 512kb bitrate.  Also here it is necessary to specify the RTSP URL. This address will be used when retrieving the stream from the camera, we are required to specify only the file name.  I entered camera1.sdp.  As a result, the stream will be available via the link rtsp: //10.0.0.3: 554 / camera1.sdp <h5>  Server Tuning </h5>  Any Linux will do, I used Debian Lenny.  Create a folder in the home in which we will work: <blockquote><ol><li>  <font color="#c20cb9">mkdir</font> ~ user <font color="#000000">/</font> <font color="#c20cb9">install</font> </li><li>  <font color="#7a0874">cd</font> ~ user <font color="#000000">/</font> <font color="#c20cb9">install</font> </li></ol></blockquote>  We will need to download codecs, so we connect the debian-multimedia repository: <blockquote><ol><li>  <font color="#c20cb9">wget</font> http: <font color="#000000">//</font> www.debian-multimedia.org <font color="#000000">/</font> pool <font color="#000000">/</font> main <font color="#000000">/</font> d <font color="#000000">/</font> debian-multimedia-keyring <font color="#000000">/</font> debian-multimedia-keyring_2008.10.16_all.deb </li><li>  <font color="#c20cb9">dpkg</font> <font color="#660033">-i</font> .  <font color="#000000">/</font> debian-multimedia-keyring_2008.10.16_all.deb </li></ol></blockquote>  Add a line to /etc/apt/sources.list <blockquote><ol><li>  deb http: <font color="#000000">//</font> www.debian-multimedia.org stable main non-freel.deb </li></ol></blockquote>  We will need to install a lot of packages before we go directly to VLC.  I tried to list everything here, but maybe something is not enough, in this case the missing ones will have to be delivered. <blockquote><ol><li>  <font color="#c20cb9">apt-get</font> update </li><li>  <font color="#c20cb9">apt-get</font> <font color="#c20cb9">install</font> yasm <font color="#c20cb9">make</font> subversion xcb libxcb1-dev libxcb-shm0-dev libxcb-keysyms0-dev \ </li><li>  libavformatcvs51 libavcodeccvs51 libavcodeccvs51-dev libavformatcvs51-dev libavutilcvs49-dev \ </li><li>  <font color="#c20cb9">autoconf</font> <font color="#c20cb9">g ++</font> <font color="#c20cb9">gcc</font> liba52-0.7.4-dev libdvbpsi3-dev libdvbpsi3 libfaad-dev libfaac-dev libfribidi-dev \ </li><li>  libavutilcvs49 libavahi-client3 libavahi-common-dev libpostproccvs51-dev libswscalecvs0-dev \ </li><li>  libswscalecvs0 libxvidcore4-dev libxvidcore4 libx264-dev libx264-54 automake1.9 libgcrypt11-dev \ </li><li>  liblame-dev liblua5.1- <font color="#000000">0</font> -dev libmad0-dev libmpeg2- <font color="#000000">4</font> -dev libogg-dev libvorbis-dev zlib1g-dev \ </li><li>  libvcdinfo-dev libiso9660-dev libcddb2-dev libflac-dev libx264-dev x264 </li></ol></blockquote>  All the rest will be set from source to be able to enable or disable certain options.  Let's start with the latest version of ffmpeg: <blockquote><ol><li>  <font color="#c20cb9">svn</font> checkout <font color="#c20cb9">svn</font> : <font color="#000000">//</font> svn.ffmpeg.org <font color="#000000">/</font> ffmpeg <font color="#000000">/</font> trunk <font color="#c20cb9">ffmpeg</font> </li><li>  <font color="#7a0874">cd</font> <font color="#c20cb9">ffmpeg</font> </li><li>  .  <font color="#000000">/</font> configure </li><li>  <font color="#c20cb9">make</font> </li><li>  <font color="#c20cb9">make</font> <font color="#c20cb9">install</font> </li><li>  <font color="#7a0874">cd</font> .. </li></ol></blockquote> If you plan to work with the h264 codec, then you can configure ffmpeg with the options <code>./configure --enable-libx264 --enable-gpl</code> Next, we need the very necessary live555 streaming media library, it is through it that our VLC player will work with RTSP. <blockquote><ol><li>  <font color="#c20cb9">wget</font> http: <font color="#000000">//</font> www.live555.com <font color="#000000">/</font> liveMedia <font color="#000000">/</font> public <font color="#000000">/</font> live555-latest.tar.gz </li><li>  <font color="#c20cb9">tar</font> zxvf.  <font color="#000000">/</font> live555-latest.tar.gz </li><li>  <font color="#7a0874">cd</font> live </li><li>  .  <font color="#000000">/</font> genMakefiles linux </li><li>  <font color="#c20cb9">make</font> </li><li>  <font color="#7a0874">cd</font> .. </li></ol></blockquote>  Now go to the VLC player itself.  Go to <a href="http://download.videolan.org/pub/videolan/vlc/latest/">http://download.videolan.org/pub/videolan/vlc/latest/</a> and see which is the latest version, then download and unpack the source.  In my case it looked like this: <blockquote><ol><li>  <font color="#c20cb9">wget</font> http: <font color="#000000">//</font> download.videolan.org <font color="#000000">/</font> pub <font color="#000000">/</font> videolan <font color="#000000">/</font> vlc <font color="#000000">/</font> latest <font color="#000000">/</font> vlc-1.1.0.tar.bz2 </li><li>  <font color="#c20cb9">bzip2</font> <font color="#660033">-d</font> vlc-1.1.0.tar.bz2 </li><li>  <font color="#c20cb9">tar</font> xvf.  <font color="#000000">/</font> vlc-1.1.0.tar </li><li>  <font color="#7a0874">cd</font> vlc-1.1.0 </li></ol></blockquote>  The VLC configuration is the most creative part, we will try to make it so that we have what we need and nothing extra. <blockquote><ol><li>  .  <font color="#000000">/</font> configure <font color="#660033">--enable-release</font> <font color="#660033">--enable-faad</font> <font color="#660033">--disable-dbus</font> <font color="#660033">--disable-hal</font> \ </li><li>  <font color="#660033">--disable-remoteosd</font> <font color="#660033">--disable-qt4</font> <font color="#660033">--disable-skins2</font> <font color="#660033">--disable-activex</font> \ </li><li>  <font color="#660033">--disable-v4l2</font> <font color="#660033">--disable-libv4l2</font> <font color="#660033">--disable-x11</font> <font color="#660033">--disable-xvideo</font> <font color="#660033">--disable-glx</font> \ </li><li>  <font color="#660033">--disable-opengl</font> <font color="#660033">--disable-visual</font> <font color="#660033">--disable-nls</font> <font color="#660033">--disable-mozilla</font> \ </li><li>  <font color="#660033">--enable-realrtsp</font> <font color="#660033">--enable-flac</font> <font color="#660033">--disable-lua</font> <font color="#660033">--prefix</font> = <font color="#000000">/</font> usr \ </li><li>  <font color="#660033">--with-live555-tree</font> = <font color="#000000">/</font> home <font color="#000000">/</font> user <font color="#000000">/</font> install <font color="#000000">/</font> live <font color="#660033">--with-ffmpeg-tree</font> = <font color="#000000">/</font> home <font color="#000000">/</font> user <font color="#000000">/</font> install <font color="#000000">/</font> <font color="#c20cb9">ffmpeg</font> </li></ol></blockquote>  In the last line, we indicate the paths to the ffmpeg and live555 sources, with which we worked in the previous steps.  If you plan to use the player as root, you need to add the <code>--enable-run-as-root</code> key if the h264 codec is <code>--enable-x264</code> .  Next, compile and install the player.  This procedure takes a long time.  In my case there was always something missing to compile, I tried to enumerate all the necessary libraries, but in any case, everything can change from version to version, so watch for errors and deliver what it asks. <blockquote><ol><li>  <font color="#c20cb9">make</font> </li><li>  <font color="#c20cb9">make</font> <font color="#c20cb9">install</font> </li></ol></blockquote>  Software installation is complete, all we have to do is launch the player with the necessary parameters.  In general, the VLC player is unique in its flexibility.  The player will work for us in two simultaneous streams: the first will receive video from the camera via RTSP multiplex it in MPEG TS and send it to localhost: 8001, the second will take the result from localhost: 8001, compress, encode, package into an FLV container and give it to HTTP on port 8080. We make 2 files to run these streams, respectively: <blockquote><ol><li>  <font color="#c20cb9">mkdir</font> ~ user <font color="#000000">/</font> scripts </li><li>  <font color="#c20cb9">touch</font> ~ user <font color="#000000">/</font> scripts <font color="#000000">/</font> stream1.sh </li><li>  <font color="#c20cb9">touch</font> ~ user <font color="#000000">/</font> scripts <font color="#000000">/</font> stream2.sh </li></ol></blockquote>  Paste the lines in stream1.sh: <blockquote><ol><li>  <font color="#666666">#! / bin / sh</font> </li><li>  vlc <font color="#660033">-vv</font> rtsp: <font color="#000000">//</font> 10.0.0.3: <font color="#000000">554</font> <font color="#000000">/</font> camera1.sdp - <font color="#660033">rtsp-caching</font> = <font color="#000000">100000</font> <font color="#660033">--no-sout-audio -</font> <font color="#660033">sout</font> \ </li><li>  <font color="#ff0000">'#std {access = http, dst = 127.0.0.1: 8001, mux = ts}'</font> </li></ol></blockquote>  Here we have indicated to the player what to lose.  The stream from the rtsp: //10.0.03: 554 / camera1.sdp camera was selected as the source, indicated the size of the buffer and immediately made the first stage our movie silent ( <code>--no-sout-audio</code> ).  The result will be given to this stream at http://127.0.0.1:8001V stream2.sh insert the lines: <blockquote><ol><li>  <font color="#666666">#! / bin / sh</font> </li><li>  vlc <font color="#660033">-vv</font> http: <font color="#000000">//</font> 127.0.0.1: <font color="#000000">8001</font> <font color="#660033">--loop</font> <font color="#660033">--http-caching</font> = <font color="#000000">10,000</font> <font color="#660033">--sout</font> \ </li><li>  <font color="#ff0000">'#transcode {vcodec = FLV1, vb = 512, fps = 15}: std {access = http {mime = video / x-flv}, dst =: 8080 / view01.flv, mux = ffmpeg {mux = flv}} '</font> </li></ol></blockquote>  The second stream takes http://127.0.0.1:8001, has its own cache, overwrites it (vb - bitrate, fps - FPS) and distributes it via HTTP on port 8080 as view01.flv file.  If there are several interfaces on the server, then you can also specify in dst the specific ip address of the interface on which you need to distribute. In commercial operation, the streams must be run as a background and not tied to the console, in our example, we will launch them simply in two consoles.  vlc should fill the buffer some time, and then pass in the regular mode.  The duration of the filling depends on the size of the cache ( <code>--rtsp-caching</code> and <code>--http-caching</code> respectively). We will need to create a page with the player.  For simplicity, we will do it on the same server. <blockquote><ol><li>  <font color="#c20cb9">apt-get</font> <font color="#c20cb9">install</font> apache2 </li></ol></blockquote><h5>  Player settings </h5><blockquote><ol><li>  <font color="#7a0874">cd</font> <font color="#000000">/</font> var <font color="#000000">/</font> www <font color="#000000">/</font> </li></ol></blockquote>  Next, download Flow Player.  The developer‚Äôs site has a settings wizard. To use it, you need to register.  The wizard is available at <a href="http://flowplayer.org/setup/index.html">http://flowplayer.org/setup/index.html</a> .  Since we have a live stream and the camera displays the current time directly into the picture, the player should be minimalistic.  Turning off everything except the ‚ÄúFullscreen‚Äù button, downloading the player and unpacking the contents of the archive into the / var / www folder on our server. So that everything was perfect, I also renamed the swf and js files to player.swf and player.js, respectively.  I would not write about this fact if I had not forgotten how they were called before.  Therefore, in the text I will also use my new names. So, create an html page <blockquote><ol><li>  <font color="#c20cb9">touch</font> <font color="#000000">/</font> var <font color="#000000">/</font> www <font color="#000000">/</font> index.html </li></ol></blockquote>  We save in it the following text: <blockquote><ol><li>  <font color="#009900">&lt; <font color="#000000">html</font> &gt; &lt; <font color="#000000">head</font> &gt;</font> </li><li>  <font color="#009900">&lt; <font color="#000000">meta</font> <font color="#000066">http-equiv</font> <font color="#66cc66">=</font> <font color="#ff0000">"content-type"</font> <font color="#000066">content</font> <font color="#66cc66">=</font> <font color="#ff0000">"text / html; charset = UTF-8"</font> &gt; &lt; <font color="#000000">script</font> <font color="#000066">type</font> <font color="#66cc66">=</font> <font color="#ff0000">"text / javascript"</font> <font color="#000066">src</font> <font color="#66cc66">=</font> <font color="#ff0000">"/player.js"</font> &gt; &lt; <font color="#66cc66">/</font> <font color="#000000">script</font> &gt;</font> </li><li>  <font color="#009900">&lt; <font color="#000000">title</font> &gt;</font> Camera View 1 <font color="#009900">&lt; <font color="#66cc66">/</font> <font color="#000000">title</font> &gt;</font> </li><li>  <font color="#009900">&lt; <font color="#66cc66">/</font> <font color="#000000">head</font> &gt;</font> </li><li>  <font color="#009900">&lt; <font color="#000000">body</font> &gt;</font> </li><li>  <font color="#009900">&lt; <font color="#000000">h1</font> &gt;</font> Camera number 1 <font color="#009900">&lt; <font color="#66cc66">/</font> <font color="#000000">h1</font> &gt;</font> </li><li>  <font color="#009900">&lt; <font color="#000000">a</font></font> </li><li>  <font color="#009900"><font color="#000066">href</font> <font color="#66cc66">=</font> <font color="#ff0000">"http://stream.kubsu.ru:8080/view01.flv"</font></font> </li><li>  <font color="#009900"><font color="#000066">style</font> <font color="#66cc66">=</font> <font color="#ff0000">"display: block; width: 520px; height: 330px; margin: 10px auto;"</font></font> </li><li>  <font color="#009900"><font color="#000066">id</font> <font color="#66cc66">=</font> <font color="#ff0000">"player"</font> &gt;</font> </li><li>  <font color="#009900">&lt; <font color="#66cc66">/</font> <font color="#000000">a</font> &gt;</font> </li><li>  <font color="#009900">&lt; <font color="#000000">script</font> &gt;</font> </li><li>  flowplayer ("player", "/player.swf"); </li><li>  <font color="#009900">&lt; <font color="#66cc66">/</font> <font color="#000000">script</font> &gt;</font> </li><li>  <font color="#009900">&lt; <font color="#66cc66">/</font> <font color="#000000">body</font> &gt; &lt; <font color="#66cc66">/</font> <font color="#000000">html</font> &gt;</font> </li></ol></blockquote>  Everything is ready, go to the browser on http://10.0.0.2/ and watch the broadcast. <hr>  <b>PS</b> Post from the sandbox.  Thanks for the invite to habr. </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/98064/">https://habr.com/ru/post/98064/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../98056/index.html">Notebook</a></li>
<li><a href="../98058/index.html">New firmware version for Google Nexus One - FRF91</a></li>
<li><a href="../98059/index.html">MTS opens file sharing</a></li>
<li><a href="../98060/index.html">A prospective startup gets a $ 20 million investment</a></li>
<li><a href="../98062/index.html">Unit testing using .NET tools</a></li>
<li><a href="../98065/index.html">Google will increase the salary of employees with a non-traditional sexual orientation</a></li>
<li><a href="../98068/index.html">Sex.com - bankrupt</a></li>
<li><a href="../98070/index.html">Firefox Mobile (Fennec) 1.1 release for Maemo platform</a></li>
<li><a href="../98073/index.html">How to write official documents</a></li>
<li><a href="../98074/index.html">The Japanese invented the all-seeing eye</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>