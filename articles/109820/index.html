<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We generate OfficeOpenXML documents in 5 minutes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Often it is necessary to generate a report on a server in an OpenXML format from an application on ASP.NET. 

 There are several familiar ways to do t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We generate OfficeOpenXML documents in 5 minutes</h1><div class="post__text post__text-html js-mediator-article">  Often it is necessary to generate a report on a server in an OpenXML format from an application on ASP.NET. <br><br>  There are several familiar ways to do this: <ol><li>  ‚ÄúFound, linked, zayuzal‚Äù - go to Google, looking for a library to generate docx or xlsx, connect, understand, generate.  This is customary, but long. </li><li>  "Fu" - use COM.  This is not recommended, it requires Microsoft Office installed on the server, not very thread-safe, not friendly with x64 and generally old-fashioned. </li><li>  ‚ÄúB‚Äù - to deal with the format, to collect from XML and zazipat.  Brutal. </li><li>  "Microsoft way" - this method is described under the cut. </li></ol><br><a name="habracut"></a><br><h4>  Small introduction </h4><br>  OfficeOpenXML is what you save documents by default in Word and Excel: docx and xlsx.  The file is a zip archive.  You can rename it to zip, open it with the archiver and see what's inside: <br><img src="https://habrastorage.org/storage/4e9e1adf/468c3656/d547af43/61612b3b.png" alt="OfficeOpenXML Folder View"><br>  Reports in OOXML are well perceived and edited by conventional means.  I would not recommend in serious applications to be limited to this format, but I advise you to support it. <br><br><h4>  Training </h4><br>  We will need: <br><ul><li>  Microsoft OpenXML SDK: <a href="http://www.microsoft.com/downloads/en/details.aspx%3FFamilyId%3DC6E744E5-36E9-45F5-8D8C-331DF206E0D0%26displaylang%3Den">www.microsoft.com/downloads/en/details.aspx?FamilyId=C6E744E5-36E9-45F5-8D8C-331DF206E0D0&amp;displaylang=en</a> (download what's bigger) </li><li>  Microsoft Word </li><li>  The simplest C # application in Visual Studio </li></ul>  Download OpenXMLSDKTool from the Microsoft website and install it: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage/5849344c/6a1a4c50/28a75182/7f876dcb.png" alt="Setup"><br><br><h4>  Go </h4><br>  Launch the Open XML SDK 2.0 Productivity Tool: <br><img src="https://habrastorage.org/storage/ef8d10fa/f80ab165/b4fea994/335383dd.png" alt="Productivity tool"><br>  This tool is very simple and can do two small but important operations: <br><ul><li>  Generate the code for the document </li><li>  Compare XML-level documents </li></ul>  But first things first. <br><br><h4>  Code generation </h4><br>  We load our document into the program and click on the ‚ÄúReflect Code‚Äù: <br><img src="https://habrastorage.org/storage/62af9fce/bc7b9df0/5cf7c105/b60b5195.png" alt="Reflect code"><br><br>  On the left we see the structure of the document - the same files that are present in the archive, and the presentation of their contents. <br>  The nodes in the tree can be selected: on the right you can see the contents of the node in the form of XML and the code that can generate this particular piece.  In my example, one paragraph is visible from the body of the document.  It just lives in word / document.xml. <br>  If we select the root of the tree (the document itself), we obtain the code for the entire document. <br><br><h5>  Now let's search for this code. </h5><ol><li>  We do the project in the Visual Studio.  Let it be a simple console C # application </li><li>  Add a reference to the assembly of DocumentFormat.OpenXml: <br><img src="https://habrastorage.org/storage/dc205f66/8d2424f5/9b38dc39/1007ae89.png" alt="Add Reference"><br>  I have it in the GAC.  If you do not want to put it there, you can add a link to the file itself.  Separately, you can download it <a href="http://www.microsoft.com/downloads/en/details.aspx%3FFamilyId%3DC6E744E5-36E9-45F5-8D8C-331DF206E0D0%26displaylang%3Den">in the same place</a> where OpenXMLSDKTool was, but by reference OpenXMLSDKv2.msi </li><li>  We add reference on WindowsBase </li><li>  Add the file "GeneratedClass.cs" </li><li>  We copy there the code from the window, from the ReflectedCode window </li><li>  Close the file, save it, go to Program.cs </li><li>  We write the Main method: <br><blockquote><code><font color="black"><font color="#0000ff">new</font> GeneratedCode.GeneratedClass().CreatePackage( <font color="#A31515">@"D:\Temp\Output.docx"</font> );</font></code> </blockquote> </li><li>  Run </li></ol>  Everything.  The code for generating the document is ready.  The document will look exactly the same as it looked before you saved it in Word.  Quick, isn't it? <br><br><h5>  What's inside? </h5><br>  What is inside the generated class? <br>  First, there is only one open method: <br><blockquote> <code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">void</font> CreatePackage( <font color="#0000ff">string</font> filePath) { <br> <font color="#0000ff">using</font> (WordprocessingDocument package = WordprocessingDocument.Create(filePath, WordprocessingDocumentType.Document)) { <br> CreateParts(package); <br> } <br> } <br></font></code> </blockquote><br>  Here the text is inserted, which will be in the document: <br><blockquote> <code><font color="black"><font color="#0000ff">private</font> <font color="#0000ff">void</font> GenerateMainDocumentPart1Content(MainDocumentPart mainDocumentPart1) { <br> Run run2 = <font color="#0000ff">new</font> Run() { RsidRunProperties = <font color="#A31515">"00184031"</font> }; <br> Text text2 = <font color="#0000ff">new</font> Text(); <br> text2.Text = <font color="#A31515">" ,  ,   ,   ."</font> ; <font color="#008000">// .    ?</font> <br> } <br></font></code> </blockquote><br>  As can be seen from the names of private methods in the code, the OpenXml document consists of parts.  For the generation of each part made a separate method. <br>  The most inquisitive, of course, smiling wickedly, inserted a picture into the document. <br>  Pictures are stored directly in this file, in the form of base64, here: <br><blockquote> <code><font color="black"><font color="#0000ff">#region</font> Binary Data <br> <font color="#008000">//...</font> <br> <font color="#0000ff">#endregion</font> <br></font></code> </blockquote><br><h5>  Tying bows </h5><br>  Refactoring images and replacing static content with dynamic content will be left to the reader as an exercise. <br>  But the method that generates not a file, but an array of bytes - to return to the client from asp.net without temporary files: <br><blockquote> <code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">byte</font> [] CreatePackageAsBytes() { <br> <font color="#0000ff">using</font> ( <font color="#0000ff">var</font> mstm = <font color="#0000ff">new</font> MemoryStream()) { <br> <font color="#0000ff">using</font> (WordprocessingDocument package = WordprocessingDocument.Create(mstm, WordprocessingDocumentType.Document)) { <br> CreateParts(package); <br> } <br> mstm.Flush(); <br> mstm.Close(); <br> <font color="#0000ff">return</font> mstm.ToArray(); <br> } <br> }</font></code> </blockquote> <br>  Everything, the code for generation of the report in the docx format is ready. <br>  It remains to replace the content on the dynamic.  We did not do all this for the sake of giving the same thing all the time, right?  And add the link ‚ÄúDownload in Word format‚Äù to the page. <br><br><h4>  Document comparison </h4><br>  So, we have generated the code for the document.  They added a lot of data there, corrected it, implemented it in production.  And here we need to change the font and text in the report.  How to do it?  It is a lot of code to search in it for a long time. <br>  It turns out that everything is very simple; the feature of comparing documents will help us: <br><ol><li>  Put next to the old and new documents </li><li>  Open the Open XML Productivity Tool, select "Compare files ...": <br><img src="https://habrastorage.org/storage/fd8dd789/2b858779/697f155b/f1277b4f.png" alt="Compare Dialog"></li><li>  Open the files and click OK.  Before us is the result of the comparison: <br><img src="https://habrastorage.org/storage/f87dc2dc/3bacadde/e3e5983c/644edd61.png" alt="Result"><br><br>  On the lines with the names of the files, you can poke and see what the differences are: <br><img src="https://habrastorage.org/storage/259eb412/1286c09d/976f532d/1931b3a9.png" alt="Comparison Details"><br><br>  In MoreOprions, it is chosen what to ignore when comparing. <br>  View Part Code shows the code of the part whose XML you see. <br>  Already to compare XML and the code of work will not make. </li></ol><br>  By the way, this feature is still very convenient to use if you are just familiar with the format of OpenXML: add something to the document and see what has changed.  It will help those who chose the way "b", which was mentioned at the beginning of the article. <br><br><h4>  Data </h4><ul><li>  With xlsx rolls.  In the same way as with docx </li><li>  If inside a docx graph or chart, everything will be fine </li><li>  This is just a strongly-typed wrapper over the System.IO.Packaging library. </li><li>  On the server, nothing is needed except this library. </li><li>  No problem with x64 </li><li>  Performance at height </li></ul><br><h4>  findings </h4><br>  I believe that using DocumentFormat.OpenXml for generating reports in web applications is the right choice.  Useful tools from the SDK will allow you to not waste time in vain. <br><br><h4>  What to read </h4><br>  About OpenXML SDK: <a href="http://msdn.microsoft.com/en-us/library/bb448854(office.14).aspx">msdn.microsoft.com/en-us/library/bb448854</a> ( <a href="http://msdn.microsoft.com/en-us/library/bb448854(office.14).aspx">office 14).aspx</a> <br>  About OpenXML (if anyone is not familiar with it): <a href="http://en.wikipedia.org/wiki/Office_Open_XML">en.wikipedia.org/wiki/Office_Open_XML</a> <br><br>  Good luck!  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/109820/">https://habr.com/ru/post/109820/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../109809/index.html">Make Me Passport - the story of one idea</a></li>
<li><a href="../109811/index.html">And what would you suggest in the bill on the national payment system?</a></li>
<li><a href="../109816/index.html">FiiO E3 Portable Headphone Amplifier</a></li>
<li><a href="../109817/index.html">Rock music inside</a></li>
<li><a href="../109819/index.html">DDoS.megafon?</a></li>
<li><a href="../109823/index.html">Grid Mousepad</a></li>
<li><a href="../109825/index.html">And I love tenders!</a></li>
<li><a href="../109827/index.html">Stellarium 0.10.6: Short Guide</a></li>
<li><a href="../109831/index.html">Kharkov office</a></li>
<li><a href="../109832/index.html">Seize the moment</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>