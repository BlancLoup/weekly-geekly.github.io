<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>RxSwift: working with GUI</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="My first article on RxSwift covered almost all the basic operators, without whose knowledge it wasn‚Äôt much sense to go into development. But this is j...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>RxSwift: working with GUI</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/49a/a66/dfc/49aa66dfc7e34d5ca6292d7dc9c5e387.png"><br><br>  My <a href="https://habrahabr.ru/post/281292/">first article on RxSwift</a> covered almost all the basic operators, without whose knowledge it wasn‚Äôt much sense to go into development.  But this is just the functional programming alphabet.  In order to write full-fledged programs, it is necessary to understand the basic principles when working with GUI. <br><br>  Basically, standard materials from RxExample are used to work through the material, but UIExplanation sandbox and an additional example in RxExample were created to clarify certain points. <br>  All code can be found here <a href="https://github.com/sparklone/RxSwift/">github.com/sparklone/RxSwift</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When working with UI elements in Rx there are basic needs: <br>  1) <a href="https://habr.com/ru/post/283128/">understand what pitfalls await us in principle and why you need a driver</a> <br>  2) <a href="https://habr.com/ru/post/283128/">learn how to bind UI to Observable so that Observable elements change the state of the UI property / properties of the element.</a>  <a href="https://habr.com/ru/post/283128/">This is solved using UIBindingObserver</a> <br>  3) <a href="https://habr.com/ru/post/283128/">learn how to translate the target-action pattern on the Rx rails.</a>  <a href="https://habr.com/ru/post/283128/">This is done using ControlEvent.</a> <br>  4) <a href="https://habr.com/ru/post/283128/">make a two-way binding to the properties of the UI element.</a>  <a href="https://habr.com/ru/post/283128/">This is done using the ControlProperty.</a> <br>  5) <a href="https://habr.com/ru/post/283128/">because</a>  <a href="https://habr.com/ru/post/283128/">Often, the UI elements of delegate / dataSource are assumed to be singular, they introduced the class DelegateProxy, which allows you to use both a normal delegate and Rx sequences at the same time.</a> <br><br>  Consider each need separately <br><a name="habracut"></a><br><br><a name="Driver"></a><br><h2>  Driver </h2><br><br>  1) There are several problems with Observable.  To understand them, consider a small <a href="https://github.com/sparklone/RxSwift/blob/master/UIExplanation.playground/Pages/Without%2520ShareRelay.xcplaygroundpage/Contents.swift">example</a> in the sandbox. <br><br><pre><code class="hljs vbscript">import Cocoa import RxSwift import RxCocoa import XCPlayground XCPlaygroundPage.currentPage.needsIndefiniteExecution = <span class="hljs-literal"><span class="hljs-literal">true</span></span> example(<span class="hljs-string"><span class="hljs-string">"without shareReplay duplicate call problem"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> source = NSTextField() <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> status = NSTextField() <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> URL = NSURL(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>: <span class="hljs-string"><span class="hljs-string">"https://github.com/"</span></span>)! <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-built_in"><span class="hljs-built_in">request</span></span> = NSURLRequest(URL: URL) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> observable = NSURLSession.sharedSession().rx_response(<span class="hljs-built_in"><span class="hljs-built_in">request</span></span>).debug(<span class="hljs-string"><span class="hljs-string">"http"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> sourceObservable = observable.map { (maybeData, <span class="hljs-built_in"><span class="hljs-built_in">response</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> return <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>(data: maybeData, encoding: NSUTF8StringEncoding)! }.observeOn(MainScheduler.instance) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> statusObservable = observable.map { (maybeData, <span class="hljs-built_in"><span class="hljs-built_in">response</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> return <span class="hljs-built_in"><span class="hljs-built_in">response</span></span>.statusCode.description }.observeOn(MainScheduler.instance) sourceObservable.subscribe(source.rx_text) statusObservable.subscribe(status.rx_text) }</code> </pre> <br><br>  a) If there is an Observable and to sign several Observers for it, a separate Observable will be created for each Observer.  In our case, Observable addresses the network and downloads the page, the page code and the status of the server response are placed in a different textView. <br><br>  If we look at the console, we will see 2 subscribed, 2 disposed: <br><pre> <code class="hljs erlang-repl">--- without shareReplay duplicate call problem example --- <span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">05</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">17.225</span></span>: http -&gt; subscribed <span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">05</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">17.229</span></span>: http -&gt; subscribed curl -X GET <span class="hljs-string"><span class="hljs-string">"https://github.com/"</span></span> -i -v Success (<span class="hljs-number"><span class="hljs-number">1098</span></span>ms): Status <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">05</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">18.326</span></span>: http -&gt; Event Next((&lt;OS_dispatch_d...; mode=block<span class="hljs-string"><span class="hljs-string">"; } })) 2016-05-01 04:17:18.339: http -&gt; Event Completed 2016-05-01 04:17:18.339: http -&gt; disposed curl -X GET "</span></span>https://github.com/<span class="hljs-string"><span class="hljs-string">" -i -v Success (1326ms): Status 200 2016-05-01 04:17:18.556: http -&gt; Event Next((&lt;OS_dispatch_d...; mode=block"</span></span>; } })) <span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">05</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">18.557</span></span>: http -&gt; Event Completed <span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">05</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">18.557</span></span>: http -&gt; disposed</code> </pre> <br><br>  To avoid this, you need to add shareReplayLatestWhileConnected to the initial observable <br><pre> <code class="hljs vbscript"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> observable = NSURLSession.sharedSession().rx_response(<span class="hljs-built_in"><span class="hljs-built_in">request</span></span>).debug(<span class="hljs-string"><span class="hljs-string">"http"</span></span>).shareReplayLatestWhileConnected()</code> </pre> <br><br>  As a result, the console shows that now there is only one call to the server. <br><pre> <code class="hljs vbscript">--- <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> shareReplay no duplicate <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> problem example --- <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">27.845</span></span>: http -&gt; subscribed curl -X <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> <span class="hljs-string"><span class="hljs-string">"https://github.com/"</span></span> -i -v Success (<span class="hljs-number"><span class="hljs-number">960</span></span>ms): Status <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">28.807</span></span>: http -&gt; Event <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span>((&lt;OS_dispatch_d...; mode=block<span class="hljs-string"><span class="hljs-string">"; } })) 2016-05-01 04:18:28.820: http -&gt; Event Completed 2016-05-01 04:18:28.821: http -&gt; disposed</span></span></code> </pre> <br><br>  I also note that shareReplayLatestWhileConnected is used, not shareReplay (1), because  it clears the buffer when unsubscribing all Observers and completing the sequence correctly or with an error.  When I wrote the first article on RxSwift operators, I discovered this strange behavior of shareReplay (lack of cleaning even after the sequence was completed) on my own in the sandbox and first decided that I was doing something wrong, it turned out - by design. <br><br>  b) we are obliged to process everything related to the GUI on MainScheduler.  If you need to refresh your memory about different Schedulers.  You can refer to the official <a href="">documentation</a> and follow the links where I described <a href="https://habrahabr.ru/post/281292/">subscribeOn</a> and <a href="https://habrahabr.ru/post/281292/">observeOn</a> in the previous article. <br>  If we remove .observeOn (MainScheduler.instance) from the code, we get <br><pre> <code class="hljs sql">fatalError "fatal error: Executing on backgound thread. Please <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-string"><span class="hljs-string">`MainScheduler.instance.schedule`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> schedule <span class="hljs-keyword"><span class="hljs-keyword">work</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">main</span></span> thread.<span class="hljs-string"><span class="hljs-string">"</span></span></code> </pre> <br>  By the way, I was somewhat puzzled by this error, because I knew that in what stream you create the Observable, the code inside it will be executed in this one.  But I mistakenly thought that in what stream the call to subscribe goes, in such a way the execution of the observer code will occur. <br><br>  At the first moment, the Observable code is actually executed in the same thread where it was created.  But, in the case of rx_response, an Observable is created inside, inside of which there is a call to the NSURLSession dataTaskWithRequest method, and the return of values ‚Äã‚Äãcomes from the closure of this method, and this closure is already running in a completely different stream.  Therefore, at the output of NSURLSession.sharedSession (). Rx_response (request) another thread is waiting for us. <br><br>  And on the second point - after reading the official documentation, I mistakenly thought that from which thread you were calling subscribe - the Observer body would be executed in this thread, it turned out that it wasn‚Äôt. The stream is saved in which the executable Observable code is located. <br>  To check this, I wrote two more examples. <br><br><pre> <code class="hljs vbscript">example(<span class="hljs-string"><span class="hljs-string">"from main thread"</span></span>) { print(<span class="hljs-string"><span class="hljs-string">"init thread: \(NSThread.currentThread())"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> source = NSTextField() <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> status = NSTextField() <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> URL = NSURL(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>: <span class="hljs-string"><span class="hljs-string">"https://github.com/"</span></span>)! <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-built_in"><span class="hljs-built_in">request</span></span> = NSURLRequest(URL: URL) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> observable = NSURLSession.sharedSession().rx_response(<span class="hljs-built_in"><span class="hljs-built_in">request</span></span>).shareReplayLatestWhileConnected() <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> sourceObservable = observable.map { (maybeData, <span class="hljs-built_in"><span class="hljs-built_in">response</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> return <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>(data: maybeData, encoding: NSUTF8StringEncoding)! } sourceObservable.subscribe() { e <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> print(<span class="hljs-string"><span class="hljs-string">"observer thread: \(NSThread.currentThread())"</span></span>) } } example(<span class="hljs-string"><span class="hljs-string">"from another queue"</span></span>) { print(<span class="hljs-string"><span class="hljs-string">"init thread: \(NSThread.currentThread())"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> source = NSTextField() <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> status = NSTextField() <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> URL = NSURL(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>: <span class="hljs-string"><span class="hljs-string">"https://github.com/"</span></span>)! <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-built_in"><span class="hljs-built_in">request</span></span> = NSURLRequest(URL: URL) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> observable = NSURLSession.sharedSession().rx_response(<span class="hljs-built_in"><span class="hljs-built_in">request</span></span>).shareReplayLatestWhileConnected() <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> sourceObservable = observable.map { (maybeData, <span class="hljs-built_in"><span class="hljs-built_in">response</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> return <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>(data: maybeData, encoding: NSUTF8StringEncoding)! } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> queue1 = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number"><span class="hljs-number">0</span></span>) dispatch_async(queue1,{ print(<span class="hljs-string"><span class="hljs-string">"queue1 thread: \(NSThread.currentThread())"</span></span>) sourceObservable.subscribe() { e <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> print(<span class="hljs-string"><span class="hljs-string">"observer thread: \(NSThread.currentThread())"</span></span>) } }) }</code> </pre> <br><br>  Output to console: <br><br><pre> <code class="hljs cs">--- <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> main thread example --- init thread: &lt;NSThread: <span class="hljs-number"><span class="hljs-number">0x7fc298d12ec0</span></span>&gt;{number = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = main} curl -X GET <span class="hljs-string"><span class="hljs-string">"https://github.com/"</span></span> -i -<span class="hljs-function"><span class="hljs-function">v </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Success</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">944</span></span></span></span><span class="hljs-function"><span class="hljs-params">ms</span></span></span><span class="hljs-function">): Status 200 observer thread: &lt;NSThread: 0x7fc298fbf1a0&gt;</span></span>{number = <span class="hljs-number"><span class="hljs-number">3</span></span>, name = (<span class="hljs-literal"><span class="hljs-literal">null</span></span>)} observer thread: &lt;NSThread: <span class="hljs-number"><span class="hljs-number">0x7fc298fbf1a0</span></span>&gt;{number = <span class="hljs-number"><span class="hljs-number">3</span></span>, name = (<span class="hljs-literal"><span class="hljs-literal">null</span></span>)} --- <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> another queue example --- init thread: &lt;NSThread: <span class="hljs-number"><span class="hljs-number">0x7ff182d12ef0</span></span>&gt;{number = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = main} queue1 thread: &lt;NSThread: <span class="hljs-number"><span class="hljs-number">0x7ff182d5c3e0</span></span>&gt;{number = <span class="hljs-number"><span class="hljs-number">3</span></span>, name = (<span class="hljs-literal"><span class="hljs-literal">null</span></span>)} curl -X GET <span class="hljs-string"><span class="hljs-string">"https://github.com/"</span></span> -i -<span class="hljs-function"><span class="hljs-function">v </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Success</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">956</span></span></span></span><span class="hljs-function"><span class="hljs-params">ms</span></span></span><span class="hljs-function">): Status 200 observer thread: &lt;NSThread: 0x7ff185025950&gt;</span></span>{number = <span class="hljs-number"><span class="hljs-number">4</span></span>, name = (<span class="hljs-literal"><span class="hljs-literal">null</span></span>)} observer thread: &lt;NSThread: <span class="hljs-number"><span class="hljs-number">0x7ff185025950</span></span>&gt;{number = <span class="hljs-number"><span class="hljs-number">4</span></span>, name = (<span class="hljs-literal"><span class="hljs-literal">null</span></span>)}</code> </pre> <br><br>  In both examples, I do not use observeOn.  As you can see in both cases, the code inside the observer is executed not in the flow of the code that made subscribe, but in that it returned from rx_response (you can make sure of this by logging the flows within the NSURLSession + Rx file from the Rx project) <br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rx_response</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request: NSURLRequest)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Observable</span></span>&lt;(<span class="hljs-type"><span class="hljs-type">NSData</span></span>, <span class="hljs-type"><span class="hljs-type">NSHTTPURLResponse</span></span>)&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">Observable</span></span>.create { observer <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"RXRESPONSE thread: \(NSThread.currentThread())"</span></span>) ...... <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> task = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.dataTaskWithRequest(request) { (data, response, error) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"TASK thread: \(NSThread.currentThread())"</span></span>)</code> </pre> <br><br>  c) if an error occurs while processing the Observable code, then in the Debug mode we catch fatalError, and in Release, the error ‚ÄúBinding error to UI: Argument out of range.‚Äù goes to the console and the entire UChief involved in the UI goes to the Observable. <br><br>  To check how this happens - I modified the original IntroductionExampleViewController a bit.  I commented out the binding to disposeButton.rx_tap, instead I made my own (I commented out my version on the githaba so that you can change the implementation on the fly) <br><br><pre> <code class="hljs pgsql">disposeButton.rx_tap.<span class="hljs-keyword"><span class="hljs-keyword">debug</span></span>("rx_tap") .flatMap{ <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Observable&lt;String&gt;.<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>{ observer <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> observer.<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>(.Next("1")) observer.onError(RxError.ArgumentOutOfRange) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NopDisposable.instance } } .bindTo(a.rx_text) .addDisposableTo(disposeBag)</code> </pre> <br><br>  In Release mode in the console at startup appears <br><pre> <code class="hljs css">2016<span class="hljs-selector-tag"><span class="hljs-selector-tag">-04-30</span></span> 02<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:02</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:41.486</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">rx_tap</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">subscribed</span></span></code> </pre> <br><br>  And when you first press the button <br><br><pre> <code class="hljs vhdl"><span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">48.248</span></span>: rx_tap -&gt; Event <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span>(()) Binding <span class="hljs-literal"><span class="hljs-literal">error</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> UI: Argument <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">range</span></span>. <span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">48.248</span></span>: rx_tap -&gt; disposed</code> </pre> <br><br>  Further button presses do not lead to anything, since  rx_tap has become disposed <br><br>  As a result, in order not to follow these moments, Driver was created, it guarantees just three things. <br>  a) data will be scrambled using shareReplayLatestWhileConnected <br>  b) the stream is executed on MainScheduler (roughly speaking the UI stream) <br>  c) no errors will be generated (we ourselves decide what value to return instead of an error) <br><br>  Thus, the creation of the driver can be represented as it is done in the official documentation. <br><br><pre> <code class="hljs vhdl">let safeSequence = xs .observeOn(MainScheduler.instance) // observe events <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> main scheduler .catchErrorJustReturn(onErrorJustReturn) // can<span class="hljs-symbol"><span class="hljs-symbol">'t</span></span> <span class="hljs-literal"><span class="hljs-literal">error</span></span> <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> .shareReplayLatestWhileConnected // <span class="hljs-literal"><span class="hljs-literal">side</span></span> effects sharing <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Driver(raw: safeSequence) // wrap it up</code> </pre> <br><br>  If we see somewhere drive () instead of subscribe () we understand that we can safely work with ui. <br><br>  Consider now an example of GitHubSignup, there just compare the head-on code with the use of Driver and without it. <br>  Without using the Driver, the creation code of the viewModel is as follows: <br><br><pre> <code class="hljs lisp">let viewModel = GithubSignupViewModel1( <span class="hljs-name"><span class="hljs-name">input</span></span>: ( <span class="hljs-name"><span class="hljs-name">username</span></span>: usernameOutlet.rx_text.asObservable(), password: passwordOutlet.rx_text.asObservable(), repeatedPassword: repeatedPasswordOutlet.rx_text.asObservable(), loginTaps: signupOutlet.rx_tap.asObservable() ) ...</code> </pre> <br>  because  rx_text is ControlProperty, then asObservable returns an internal Observable without any conversions. <br><br>  Now as will be with the use of the driver'a <br><br><pre> <code class="hljs lisp">let viewModel = GithubSignupViewModel2( <span class="hljs-name"><span class="hljs-name">input</span></span>: ( <span class="hljs-name"><span class="hljs-name">username</span></span>: usernameOutlet.rx_text.asDriver(), password: passwordOutlet.rx_text.asDriver(), repeatedPassword: repeatedPasswordOutlet.rx_text.asDriver(), loginTaps: signupOutlet.rx_tap.asDriver() ), ...</code> </pre> <br>  The difference is small, instead of asObservable - asDriver, which leads to the fulfillment of the above 3 conditions. <br><br>  If you take the application, the difference is also minimal; without Driver, subscribe / bind and their modifications are used. <br><br><pre> <code class="hljs objectivec">viewModel.signupEnabled .subscribeNext { [<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>] valid <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>?.signupOutlet.enabled = valid <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>?.signupOutlet.alpha = valid ? <span class="hljs-number"><span class="hljs-number">1.0</span></span> : <span class="hljs-number"><span class="hljs-number">0.5</span></span> } .addDisposableTo(disposeBag) viewModel.validatedUsername .bindTo(usernameValidationOutlet.ex_validationResult) .addDisposableTo(disposeBag)</code> </pre> <br><br>  With driver we use drive and its modifications <br><br><pre> <code class="hljs objectivec">viewModel.signupEnabled .driveNext { [<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>] valid <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>?.signupOutlet.enabled = valid <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>?.signupOutlet.alpha = valid ? <span class="hljs-number"><span class="hljs-number">1.0</span></span> : <span class="hljs-number"><span class="hljs-number">0.5</span></span> } .addDisposableTo(disposeBag) viewModel.validatedUsername .drive(usernameValidationOutlet.ex_validationResult) .addDisposableTo(disposeBag)</code> </pre><br>  A little more interesting will be to look at GithubSignupViewModel1 / GithubSignupViewModel2 where the drivers are created <br><br>  Verbose code in GithubSignupViewModel1 <br><br><pre> <code class="hljs pgsql">validatedUsername = <span class="hljs-keyword"><span class="hljs-keyword">input</span></span>.username .flatMapLatest { username <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> validationService.validateUsername(username) .observeOn(MainScheduler.instance) .catchErrorJustReturn(.Failed(message: "Error contacting server")) } .shareReplay(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre><br><br>  simplified to <br><br><pre> <code class="hljs pgsql">validatedUsername = <span class="hljs-keyword"><span class="hljs-keyword">input</span></span>.username .flatMapLatest { username <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> validationService.validateUsername(username) .asDriver(onErrorJustReturn: .Failed(message: "Error contacting server")) }</code> </pre> <br><br>  The sensible use of this knowledge should already protect against major errors when working with UI.  But still this is not enough, you need to understand how the standard UI elements for working with Rx are expanded, in order to write your own extensions if necessary. <br><br><a name="UIBindingObserver"></a><br><br><h2>  UIBindingObserver </h2><br>  2) using the example of GeolocationViewController.swift, you can see how to hang your own Observers on the UI elements <br><br><pre> <code class="hljs objectivec">private extension <span class="hljs-built_in"><span class="hljs-built_in">UILabel</span></span> { var rx_driveCoordinates: AnyObserver&lt;<span class="hljs-built_in"><span class="hljs-built_in">CLLocationCoordinate2D</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">UIBindingObserver</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">UIElement</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) { label, location <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> label.text = <span class="hljs-string"><span class="hljs-string">"Lat: \(location.latitude)\nLon: \(location.longitude)"</span></span> }.asObserver() } }</code> </pre> <br><br>  So, UIBindingObserver is a generic helper class that allows you to bind a parameter passed to the closure (in our case, location) to changes in the property / properties of the passed object (in our case, the text property).  UIBindingObserver is parameterized by the object class (in our case, UILabel, because extension UILabel), the parameters will be passed to the closure as the object itself (label) and the value with which we will change the state of the object (location) <br>  The type for the location parameter in this example is determined by the automaton, due to the parameterization of the return value AnyObserver &lt;CLLocationCoordinate2D&gt; <br>  This code for example will not work. <br><br><pre> <code class="hljs objectivec">var rx_driveCoordinates: AnyObserver&lt;<span class="hljs-built_in"><span class="hljs-built_in">CLLocationCoordinate2D</span></span>&gt; { let observer = <span class="hljs-built_in"><span class="hljs-built_in">UIBindingObserver</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">UIElement</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) { label, location <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> label.text = <span class="hljs-string"><span class="hljs-string">"Lat: \(location.latitude)\nLon: \(location.longitude)"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> observer.asObserver() }</code> </pre> <br>  After all, at the time of the creation of observer, - UIBindingObserver has no idea what type the location will have, because unlike the original, it does not immediately return from the closure.  The "magic" of autodetection types will not work. <br>  But this will go, because  we explicitly specified the type of all parameters when creating the UIBindingObserver <br><br><pre> <code class="hljs objectivec">var rx_driveCoordinates: AnyObserver&lt;<span class="hljs-built_in"><span class="hljs-built_in">CLLocationCoordinate2D</span></span>&gt; { let uiBindingObserver: <span class="hljs-built_in"><span class="hljs-built_in">UIBindingObserver</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">UILabel</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">CLLocationCoordinate2D</span></span>&gt; = <span class="hljs-built_in"><span class="hljs-built_in">UIBindingObserver</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">UIElement</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) { label, location <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> label.text = <span class="hljs-string"><span class="hljs-string">"Lat: \(location.latitude)\nLon: \(location.longitude)"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> uiBindingObserver.asObserver() }</code> </pre> <br><br>  To summarize  On the one hand, this remark is not directly related to RxSwift, it is rather a reference to how Swift works with the types of transferred values ‚Äã‚Äãand their automatic recognition, which saves us from the routine explicit indication of types.  On the other hand, it is important to understand that there is no magic in the RXSwift binders.  With the knowledge that where it comes from and transmitted from, it is possible to come up with a puzzle to fix, for example, we want the text color of UILabel to change color depending on the value of the Bool type parameter transmitted to the closure.  If it is true, let the text color turn red, and black if false <br>  All that is needed is to parameterize the type returned by the definition of Observer by the Bool type, and it is correct to use this knowledge inside the closure <br><br><pre> <code class="hljs objectivec">var rx_wasError: AnyObserver&lt;Bool&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">UIBindingObserver</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">UIElement</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) { label, error <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> label.textColor = error ? <span class="hljs-built_in"><span class="hljs-built_in">UIColor</span></span>.redColor() : <span class="hljs-built_in"><span class="hljs-built_in">UIColor</span></span>.blackColor() }.asObserver() }</code> </pre> <br><br>  Well, last thing, why don't we return the UIBindingObserver, why bring to AnyObserver?  Because otherwise we would have to parameterize the type of the return value by the type of the object (UILabel), which is absolutely not important in the context of the task. <br><br><pre> <code class="hljs objectivec">var rx_driveCoordinatesUIB: <span class="hljs-built_in"><span class="hljs-built_in">UIBindingObserver</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">UILabel</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">CLLocationCoordinate2D</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">UIBindingObserver</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">UIElement</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) { label, location <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> label.text = <span class="hljs-string"><span class="hljs-string">"Lat: \(location.latitude)\nLon: \(location.longitude)"</span></span> } }</code> </pre> <br><br>  Are we right?  We look into the definition of AnyObserver <br><br>  / ** <br>  A type-erased ObserverType. <br><br>  Forwarding operations of an observer type. <br>  * / <br>  So it is, AnyObserver is a wrapper that hides the type of the transferred object, leaving only the type of the parameter passed to the closure. <br><br>  The following extension, thanks to the knowledge gained, is easy to read.  Depending on the Bool type parameter passed to the closure, we hide the UIView, or vice versa, make it visible. <br><br><pre> <code class="hljs pgsql">private <span class="hljs-keyword"><span class="hljs-keyword">extension</span></span> UIView { var rx_driveAuthorization: AnyObserver&lt;<span class="hljs-type"><span class="hljs-type">Bool</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UIBindingObserver(UIElement: self) { <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>, authorized <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> authorized { <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>.hidden = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>.superview?.sendSubviewToBack(<span class="hljs-keyword"><span class="hljs-keyword">view</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>.hidden = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>.superview?.bringSubviewToFront(<span class="hljs-keyword"><span class="hljs-keyword">view</span></span>) } }.asObserver() } }</code> </pre> <br><br><a name="ControlEvent"></a><br><h2>  ControlEvent </h2><br><br>  3) To process the target-event pattern in the Rx environment, enter the ControlEvent &lt;&gt; structure <br>  It has the following properties: <br>  - its code will never fall <br>  - no initial value will be sent when subscribing <br>  - when memory is released, the control will generate .Completed <br>  - no errors will ever come out <br>  - all events will be executed on MainScheduler <br><br>  Consider the example of clicking on a simple button.  For UIButton, an extension is created where the rx_tap property is defined. <br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIButton</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** Reactive wrapper for `TouchUpInside` control event. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rx_tap: <span class="hljs-type"><span class="hljs-type">ControlEvent</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Void</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rx_controlEvent(.<span class="hljs-type"><span class="hljs-type">TouchUpInside</span></span>) } }</code> </pre> <br><br>  For UIControl, the method is defined in the extension <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> func rx_controlEvent(controlEvents: UIControlEvents) -&gt; ControlEvent&lt;<span class="hljs-type"><span class="hljs-type">Void</span></span>&gt; { let source: Observable&lt;<span class="hljs-type"><span class="hljs-type">Void</span></span>&gt; = Observable.<span class="hljs-keyword"><span class="hljs-keyword">create</span></span> { [weak self] observer <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> MainScheduler.ensureExecutingOnScheduler() //     Main  guard let control = self <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { //      -  .Competed observer.<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>(.Completed) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NopDisposable.instance } //  ,  ControlTarget    ,            callback       let controlTarget = ControlTarget(control: control, controlEvents: controlEvents) { control <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> observer.<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>(.Next()) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> AnonymousDisposable { controlTarget.dispose() } }.takeUntil(rx_deallocated) //       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ControlEvent(events: source) }</code> </pre> <br><br>  Inside the ControlTarget class, the event is already subscribed <br>  control.addTarget (self, action: selector, forControlEvents: controlEvents) <br><br>  Using the same extensions is as easy as regular Observable. <br>  Consider the example of GeolocationExample, or rather the class GeolocationViewController <br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GeolocationViewController</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@IBOutlet</span></span> <span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> button: <span class="hljs-type"><span class="hljs-type">UIButton!</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">viewDidLoad</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { ... button.rx_tap .bindNext { [<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>?.openAppPreferences() } .addDisposableTo(disposeBag) ... } ... }</code> </pre> <br><br>  Here we simply do bindNext for each click on the button, and in the circuit code, open the settings panel. <br>  bindNext by the way is just a wrapper over the subscribe with a check that we are in the main thread <br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bindNext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(onNext: E -&gt; Void)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Disposable</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> subscribe(onNext: onNext, onError: { error <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> error = <span class="hljs-string"><span class="hljs-string">"Binding error: \(error)"</span></span> #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-type"><span class="hljs-type">DEBUG</span></span> rxFatalError(error) #<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(error) #endif }) }</code> </pre> <br><br>  We can also, at any time, if necessary, obtain from ControlEvent - Observable using .asObservable () or Driver using .asDriver () <br><br><a name="ControlProperty"></a><br><h2>  Controlproperty </h2><br><br>  4) To make a two-way binding to the UI properties of the element, the ControlProperty &lt;&gt; structure with the following properties comes to the rescue <br><br>  - its code will never fall <br>  - on the sequence of elements applied shareReplay (1) <br>  - when freeing by memory control will be generated .Completed <br>  - no errors will ever come out <br>  - all events will be executed on MainScheduler <br><br>  For example, of course, let's take the text property from UITextField <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">extension</span></span> UITextField { <span class="hljs-comment"><span class="hljs-comment">/** Reactive wrapper for `text` property. */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> var rx_text: ControlProperty&lt;String&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UIControl.rx_value( self, getter: { textField <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> textField.text ?? "" }, setter: { textField, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> textField.text = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> } ) } }</code> </pre> <br><br>  Let's see what the rx_value method is. <br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rx_value</span></span></span><span class="hljs-function">&lt;C: AnyObject, T: Equatable&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(control: C, getter: </span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(C)</span></span></span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">T</span></span>, setter: (<span class="hljs-type"><span class="hljs-type">C</span></span>, <span class="hljs-type"><span class="hljs-type">T</span></span>) -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span>) -&gt; <span class="hljs-type"><span class="hljs-type">ControlProperty</span></span>&lt;<span class="hljs-type"><span class="hljs-type">T</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> source: <span class="hljs-type"><span class="hljs-type">Observable</span></span>&lt;<span class="hljs-type"><span class="hljs-type">T</span></span>&gt; = <span class="hljs-type"><span class="hljs-type">Observable</span></span>.create { [<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> weakControl = control] observer <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> control = weakControl <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">//      -  .Competed observer.on(.Completed) return NopDisposable.instance } observer.on(.Next(getter(control))) //              getter' // ,     ControlTarget let controlTarget = ControlTarget(control: control as! UIControl, controlEvents: [.AllEditingEvents, .ValueChanged]) { _ in if let control = weakControl { observer.on(.Next(getter(control))) } } return AnonymousDisposable { controlTarget.dispose() } } .distinctUntilChanged() //       .takeUntil((control as! NSObject).rx_deallocated) //       //   ,   UIBindingObserver     Observable     setter let bindingObserver = UIBindingObserver(UIElement: control, binding: setter) return ControlProperty&lt;T&gt;(values: source, valueSink: bindingObserver) } }</span></span></code> </pre> <br><br>  As we can see, two-way binding is a combination of the ControlTarget and UIBindingObserver already discussed. <br>  If you look at the definition of ControlProperty, you can see that it implements the ControlPropertyType protocol, which in turn inherits from both ObservableType and ObserverType. <br>  Take another look at the code IntroductionExampleViewController <br><br><pre> <code class="hljs swift"><span class="hljs-meta"><span class="hljs-meta">@IBOutlet</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a: <span class="hljs-type"><span class="hljs-type">NSTextField!</span></span> <span class="hljs-meta"><span class="hljs-meta">@IBOutlet</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b: <span class="hljs-type"><span class="hljs-type">NSTextField!</span></span> <span class="hljs-meta"><span class="hljs-meta">@IBOutlet</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>: <span class="hljs-type"><span class="hljs-type">NSTextField!</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">viewDidLoad</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { ... <span class="hljs-comment"><span class="hljs-comment">//  ControlProperty      Observable let sum = Observable.combineLatest(a.rx_text, b.rx_text) { (a: String, b: String) -&gt; (Int, Int) in return (Int(a) ?? 0, Int(b) ?? 0) } ... sum .map { (a, b) in return "\(a + b)" } .bindTo(c.rx_text) //    Observer' .addDisposableTo(disposeBag) }</span></span></code> </pre> <br><br>  If we need both behaviors at the same time, i.e.  do two-way binding - you can see how to create your own operator in Rx code <br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">infix</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> &lt;-&gt; { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> &lt;-&gt; &lt;T&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(property: ControlProperty&lt;T&gt;, variable: Variable&lt;T&gt;)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Disposable</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> bindToUIDisposable = variable.asObservable() .bindTo(property) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> bindToVariable = property .subscribe(onNext: { n <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> variable.value = n }, onCompleted: { bindToUIDisposable.dispose() }) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">StableCompositeDisposable</span></span>.create(bindToUIDisposable, bindToVariable) }</code> </pre> <br><br>  The operator allows you to create a binding simply and clearly <br><br><pre> <code class="hljs rust"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> textViewValue = Variable(<span class="hljs-string"><span class="hljs-string">""</span></span>) textView.rx_text &lt;-&gt; textViewValue</code> </pre> <br><br><a name="DelegateProxy"></a><br><h2>  DelegateProxy </h2><br><br>  5) The cornerstone of Cocoa architecture is delegates.  But it is usually assumed - one delegate for one object, so the DelegateProxy class was added to Rx, which allows you to use both a regular delegate and Rx sequences at the same time. <br><br>  From the point of view of the user of the existing API, there is nothing particularly complicated and nothing. <br>  Take for example the UISearchBar, we want to somehow react to pressing the Cancel button.  A variable has been created for us in the extension for the UISearchBar class. <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rx_cancelButtonClicked: ControlEvent&lt;<span class="hljs-built_in"><span class="hljs-built_in">Void</span></span>&gt; { let source: Observable&lt;<span class="hljs-built_in"><span class="hljs-built_in">Void</span></span>&gt; = rx_delegate.observe(#selector(UISearchBarDelegate.searchBarCancelButtonClicked(_:))) .map { _ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> () } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ControlEvent(events: source) }</code> </pre> <br><br>  Working with her is easy and simple: <br><pre> <code class="hljs objectivec">searchBar.rx_cancelButtonClicked.subscribeNext { _ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-comment"><span class="hljs-comment">//    }</span></span></code> </pre> <br><br>  But working with tableView somewhat upset me. <br>  If you take an example (SimpleTableViewExample), then everything is simple <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> SimpleTableViewExampleViewController : ViewController { @IBOutlet weak var tableView: UITableView! override func viewDidLoad() { super.viewDidLoad() //  Observable   let items = Observable.just([ "First Item", "Second Item", "Third Item" ]) //     tableView (    dataSource),        items .bindTo(tableView.rx_itemsWithCellIdentifier("Cell", cellType: UITableViewCell.self)) { (<span class="hljs-keyword"><span class="hljs-keyword">row</span></span>, element, cell) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cell.textLabel?.text = "\(element) @ row \(row)" } .addDisposableTo(disposeBag) //      , rx_modelSelected -   tableView:didSelectRowAtIndexPath: tableView .rx_modelSelected(String) .subscribeNext { <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> DefaultWireframe.presentAlert("Tapped `\(value)`") } .addDisposableTo(disposeBag) //        -   tableView(_:accessoryButtonTappedForRowWithIndexPath:) tableView .rx_itemAccessoryButtonTapped .subscribeNext { indexPath <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> DefaultWireframe.presentAlert("Tapped Detail @ \(indexPath.section),\(indexPath.row)") } .addDisposableTo(disposeBag) } }</code> </pre> <br><br>  Cool, rx_itemsWithCellIdentifier is defined in Rx itself, so it is accessible to all.  OK.  And how are things with the table with sections?  Let's see an example of SimpleTableViewExampleSectioned <br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleTableViewExampleSectionedViewController</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewController</span></span></span><span class="hljs-class"> , </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UITableViewDelegate</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@IBOutlet</span></span> <span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tableView: <span class="hljs-type"><span class="hljs-type">UITableView!</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> dataSource = <span class="hljs-type"><span class="hljs-type">RxTableViewSectionedReloadDataSource</span></span>&lt;<span class="hljs-type"><span class="hljs-type">SectionModel</span></span>&lt;<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">Double</span></span>&gt;&gt;() <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">viewDidLoad</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.viewDidLoad() <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> dataSource = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.dataSource <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> items = <span class="hljs-type"><span class="hljs-type">Observable</span></span>.just([ <span class="hljs-type"><span class="hljs-type">SectionModel</span></span>(model: <span class="hljs-string"><span class="hljs-string">"First section"</span></span>, items: [ <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span> ]), <span class="hljs-type"><span class="hljs-type">SectionModel</span></span>(model: <span class="hljs-string"><span class="hljs-string">"Second section"</span></span>, items: [ <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span> ]), <span class="hljs-type"><span class="hljs-type">SectionModel</span></span>(model: <span class="hljs-string"><span class="hljs-string">"Second section"</span></span>, items: [ <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span> ]) ]) dataSource.configureCell = { (<span class="hljs-number"><span class="hljs-number">_</span></span>, tv, indexPath, element) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> cell = tv.dequeueReusableCellWithIdentifier(<span class="hljs-string"><span class="hljs-string">"Cell"</span></span>)! cell.textLabel?.text = <span class="hljs-string"><span class="hljs-string">"\(element) @ row \(indexPath.row)"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cell } items .bindTo(tableView.rx_itemsWithDataSource(dataSource)) .addDisposableTo(disposeBag) tableView .rx_itemSelected .<span class="hljs-built_in"><span class="hljs-built_in">map</span></span> { indexPath <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (indexPath, dataSource.itemAtIndexPath(indexPath)) } .subscribeNext { indexPath, model <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-type"><span class="hljs-type">DefaultWireframe</span></span>.presentAlert(<span class="hljs-string"><span class="hljs-string">"Tapped `\(model)` @ \(indexPath)"</span></span>) } .addDisposableTo(disposeBag) tableView .rx_setDelegate(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) .addDisposableTo(disposeBag) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tableView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tableView: UITableView, viewForHeaderInSection section: Int)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">UIView?</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> label = <span class="hljs-type"><span class="hljs-type">UILabel</span></span>(frame: <span class="hljs-type"><span class="hljs-type">CGRect</span></span>.zero) label.text = dataSource.sectionAtIndex(section).model ?? <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> label } }</code> </pre> <br><br>  Pay attention to the RxTableViewSectionedReloadDataSource, and where is it defined?  In the RxExample project, i.e.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as I understand it is not a run-in solution that is recommended to everyone, but for example. If you look inside, you understand why, they propose to reload data for the entire table for every sneeze.</font></font><br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tableView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tableView: UITableView, observedEvent: Event&lt;Element&gt;)</span></span></span></span> { <span class="hljs-type"><span class="hljs-type">UIBindingObserver</span></span>(<span class="hljs-type"><span class="hljs-type">UIElement</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) { dataSource, element <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dataSource.setSections(element) tableView.reloadData() }.on(observedEvent) }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To put it mildly, not the best solution. </font><font style="vertical-align: inherit;">What are the alternatives? </font><font style="vertical-align: inherit;">Again, RxTableViewSectionedAnimatedDataSource is defined in RxExample. </font><font style="vertical-align: inherit;">For an example of working with this dataSource, an example of TableViewPartialUpdates is provided. </font><font style="vertical-align: inherit;">It demonstrates in comparison how to update data in tables with sections with both a full data reload (RxTableViewSectionedReloadDataSource) and a partial data reload (RxTableViewSectionedAnimatedDataSource). </font><font style="vertical-align: inherit;">Here is also an example of working with CollectionView. </font><font style="vertical-align: inherit;">But all this without regard to the possibility of editing. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, me and the cards in hand, I will create a simple example of working with a table with sections and the possibility of editing. </font><font style="vertical-align: inherit;">The example TableViewEditPartialUpdate I put to the rest of the examples in RxExample.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Considering that this was my first experience of the ‚Äúcombat‚Äù code for working with GUI in RxSwift, I immediately received my portion of the rake. </font></font><br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> TablViewControllerEditPartialUpdate : ViewController { @IBOutlet weak var tableView: UITableView! var sections = Variable([NumberSection]()) override func viewDidLoad() { super.viewDidLoad() // NumberSection -    typealias AnimatableSectionModel&lt;String, <span class="hljs-type"><span class="hljs-type">Int</span></span>&gt; let items = [ NumberSection(model: "Section 1", items: [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>]), NumberSection(model: "Section 2", items: [<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>]), NumberSection(model: "Section 3", items: [<span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>]) ] self.sections.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = items let editableDataSource = RxTableViewSectionedAnimatedDataSource&lt;NumberSection&gt;() configDataSource(editableDataSource) //    rx_itemsAnimatedWithDataSource,   rx_itemsWithDataSource self.sections.asObservable() .bindTo(tableView.rx_itemsAnimatedWithDataSource(editableDataSource)) .addDisposableTo(disposeBag) //     tableView.rx_itemDeleted.subscribeNext{[weak self] item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> let controller = self { controller.sections.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>[item.section].items.removeAtIndex(item.<span class="hljs-keyword"><span class="hljs-keyword">row</span></span>) } }.addDisposableTo(disposeBag) //        tableView .rx_modelSelected(IdentifiableValue&lt;<span class="hljs-type"><span class="hljs-type">Int</span></span>&gt;) .subscribeNext { i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> DefaultWireframe.presentAlert("Tapped `\(i)`") } .addDisposableTo(disposeBag) //  NSIndexPath     ,        tableView .rx_itemSelected .subscribeNext { [weak self] i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> let controller = self { print("Tapped `\(i)` - \(controller.sections.value[i.section].items[i.row].dynamicType)") } } .addDisposableTo(disposeBag) } func configDataSource(dataSource: RxTableViewSectionedDataSource&lt;NumberSection&gt;) { dataSource.configureCell = { (_, tv, ip, i) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> let cell = tv.dequeueReusableCellWithIdentifier("Cell") ?? UITableViewCell(style:.<span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>, reuseIdentifier: "Cell") cell.textLabel!.text = "\(i)" <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cell } dataSource.titleForHeaderInSection = { (ds, section: <span class="hljs-type"><span class="hljs-type">Int</span></span>) -&gt; String <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dataSource.sectionAtIndex(section).model } dataSource.canEditRowAtIndexPath = { (ds, ip) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> } } }</code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1) I wrote this code, I registered my class for the TableViewController created in the storyboard and tried to run it. </font></font> Mistake. <br><pre> <code class="hljs vhdl">fatal <span class="hljs-literal"><span class="hljs-literal">error</span></span>: <span class="hljs-literal"><span class="hljs-literal">Failure</span></span> converting from &lt;RxExample_iOS.TableViewControllerEditPartialUpdate: <span class="hljs-number"><span class="hljs-number">0</span></span>x7f895a643dd0&gt; <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> UITableViewDataSource: <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> /Users/SparkLone/projects/repos/RxSwift/RxCocoa/Common/RxCocoa.swift, <span class="hljs-literal"><span class="hljs-literal">line</span></span> <span class="hljs-number"><span class="hljs-number">340</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wow. </font><font style="vertical-align: inherit;">Not immediately, I realized what was happening. </font><font style="vertical-align: inherit;">I picked up a lot of Rx code in a vain attempt to get through the wilds. </font><font style="vertical-align: inherit;">And the point was that by default, when creating a ViewTableController in the designer, it specifies our controller as a dataSource. </font><font style="vertical-align: inherit;">And when Rx creates a proxy, it tries to specify the current dataSource as forwardToDelegate. </font><font style="vertical-align: inherit;">And my controller does not implement the DataSource in the canonical form. </font><font style="vertical-align: inherit;">Of course, there is no one to blame, but apparently starting to work with a library of this kind, subconsciously expecting some tricky bugs. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2) Okay, they wanted tricky bugs - please. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Initially instead of string</font></font><br><br><pre> <code class="hljs lisp">rx_modelSelected(<span class="hljs-name"><span class="hljs-name">IdentifiableValue&lt;Int&gt;</span></span>)</code> </pre> <br><br>  was <br><br><pre> <code class="hljs lisp">rx_modelSelected(<span class="hljs-name"><span class="hljs-name">Int</span></span>)</code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and when I clicked on a table row, I caught another great mistake. </font></font><br><br><pre> <code class="hljs vhdl">fatal <span class="hljs-literal"><span class="hljs-literal">error</span></span>: <span class="hljs-literal"><span class="hljs-literal">Failure</span></span> converting from <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Int: <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> /Users/SparkLone/projects/repos/RxSwift/RxCocoa/Common/RxCocoa.swift, <span class="hljs-literal"><span class="hljs-literal">line</span></span> <span class="hljs-number"><span class="hljs-number">340</span></span></code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well yes, how does 4 lead to int then. </font><font style="vertical-align: inherit;">After another unsuccessful study of the library's entrails, to figure out which type should be instead of Int, I guessed to derive it in this way.</font></font><br><br><pre> <code class="hljs swift">tableView .rx_itemSelected .subscribeNext { [<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>] i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> controller = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Tapped `\(i)` - \(controller.sections.value[i.section].items[i.row].dynamicType)"</span></span>) } } .addDisposableTo(disposeBag)</code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I can take this error into my account with a stretch, nowhere was there any mention of any IdentifiableValue in the examples. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3) I initially indicated that the data for the first section was not [1, 3, 5] but [1, 3, 3]. The </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">application started normally, but when I tried to delete a line in a completely different section, I received this error</font></font><br><br><pre> <code class="hljs vhdl">precondition failed: Item <span class="hljs-number"><span class="hljs-number">3</span></span> has already been indexed at (<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> /Users/SparkLone/projects/repos/RxSwift/RxExample/RxDataSources/DataSources/Differentiator.swift, <span class="hljs-literal"><span class="hljs-literal">line</span></span> <span class="hljs-number"><span class="hljs-number">130</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As it turned out, protection against duplicates in the rows of the table is built in, the values ‚Äã‚Äãfor the rows must be unique. As you might guess, I did not find out immediately either. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is clear that all the errors seem to be some kind of frivolous, and the second time you will not step on the same rake. But hoping to spend half an hour to sketch a simple example of working with a table, it is extremely unpleasant to dive into the inside of the library in order to understand why everything does not work once again. And taking into account the non-linearity of execution, even with the help of debugging, it is not so easy (quickly) to understand what's the matter. I really hope that over time, the standardization of all extensions will be carried out, more detailed and intelligible documentation will be written. For me, the first pancake was lumpy. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, let's look at how it all works.</font></font><br><br><img src="https://habrastorage.org/files/90e/52a/15c/90e52a15cf29484b82bb3d0ad502ea06.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We create an extension above the UIView subclass, inside it we define the variable rx_delegate, which in turn creates a proxy for the delegate. Further, in the extension we write the wrappers over the events that we plan to process. The client subscribes to these wrappers over the events, and when such an event occurs, the proxy first generates an Observable element that arrives to the client, then if there is, sends (makes forward to understand the protocol API) to its normal delegate if it was assigned before creating the Rx delegate . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The basis is the protocol</font></font><br><br><pre> <code class="hljs pgsql">protocol DelegateProxyType { //      static func createProxyForObject(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>: AnyObject) -&gt; AnyObject //      objc_setAssociatedObject static func assignProxy(proxy: AnyObject, toObject <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>: AnyObject) //       objc_getAssociatedObject static func assignedProxyFor(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>: AnyObject) -&gt; AnyObject? //     /    ( Rx)  func setForwardToDelegate(forwardToDelegate: AnyObject?, retainDelegate: <span class="hljs-type"><span class="hljs-type">Bool</span></span>) func forwardToDelegate() -&gt; AnyObject? //     /  -,    static func currentDelegateFor(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>: AnyObject) -&gt; AnyObject? static func setCurrentDelegate(delegate: AnyObject?, toObject <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>: AnyObject) }</code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is also a base class DelegateProxy which implements the first 5 methods of this protocol. </font><font style="vertical-align: inherit;">The remaining two usually override specific extensions, since </font><font style="vertical-align: inherit;">they know what type the UI object should be and what name has the property containing the delegate in the particular UIControl</font></font><br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DelegateProxy</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">func</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">createProxyForObject</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnyObject</span></span></span><span class="hljs-class">) -&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnyObject</span></span></span><span class="hljs-class"> </span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">func</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assignedProxyFor</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnyObject</span></span></span><span class="hljs-class">) -&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnyObject</span></span></span><span class="hljs-class">? </span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">func</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assignProxy</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">proxy</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnyObject</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">toObject</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnyObject</span></span></span><span class="hljs-class">) </span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setForwardToDelegate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(delegate: AnyObject?, retainDelegate: Bool)</span></span></span></span> {} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">forwardToDelegate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">AnyObject?</span></span> {} }</code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To make it a little clearer, consider the example of the UISearchController class. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An extension has been created for it.</font></font><br><br><pre> <code class="hljs ruby">extension UISearchController { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    ,    RxSearchControllerDelegateProxy public var <span class="hljs-symbol"><span class="hljs-symbol">rx_delegate:</span></span> DelegateProxy { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> proxyForObject(RxSearchControllerDelegateProxy.<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) } /<span class="hljs-regexp"><span class="hljs-regexp">/ Rx     UISearchControllerDelegate.didDismissSearchController(_:) public var rx_didDismiss: Observable&lt;Void&gt; { return rx_delegate .observe(#selector(UISearchControllerDelegate.didDismissSearchController(_:))) .map {_ in} } ... }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Proxy for UISearchController is RxSearchControllerDelegateProxy </font></font><br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RxSearchControllerDelegateProxy</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DelegateProxy </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DelegateProxyType </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UISearchControllerDelegate { //    </span></span></span></span>( )      (UISearchController)      (delegate) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">func</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">setCurrentDelegate</span></span></span></span>(delegate: AnyObject?, toObject <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>: AnyObject) { let searchController: UISearchController = castOrFatalError(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>) searchController.delegate = castOptionalOrFatalError(delegate) } <span class="hljs-comment"><span class="hljs-comment">//       ,      public class func currentDelegateFor(object: AnyObject) -&gt; AnyObject? { let searchController: UISearchController = castOrFatalError(object) return searchController.delegate } }</span></span></code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dig a little deeper. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The proxy in the example is created using</font></font><br><pre> <code class="hljs swift">proxyForObject(<span class="hljs-type"><span class="hljs-type">RxSearchControllerDelegateProxy</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>)</code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">proxyForObject is a global function, the core of proxies for delegates. As parameters, the proxy type (RxSearchControllerDelegateProxy.self) and the object to which we will attach the proxy are passed to it. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In our case, the type will be RxSearchControllerDelegateProxy, object - the current object of type UISearchController</font></font><br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">public</span></span> func proxyForObject&lt;<span class="hljs-type"><span class="hljs-type">P</span></span>: <span class="hljs-type"><span class="hljs-type">DelegateProxyType</span></span>&gt;(<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">P</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Type</span></span></span><span class="hljs-class">, _ object: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AnyObject</span></span></span><span class="hljs-class">) -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">P</span></span></span><span class="hljs-class"> { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MainScheduler</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ensureExecutingOnScheduler</span></span></span><span class="hljs-class">() //        </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">let</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">maybeProxy</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">P</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assignedProxyFor</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">as</span></span></span><span class="hljs-class">? </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">P</span></span></span><span class="hljs-class"> // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assignedProxyFor</span></span></span><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DelegateProxy</span></span></span><span class="hljs-class">      </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">let</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">proxy</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">P</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">maybeProxy</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">proxy</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">P</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">createProxyForObject</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">as</span></span></span><span class="hljs-class">! </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">P</span></span></span><span class="hljs-class"> //   (    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RxSearchControllerDelegateProxy</span></span></span><span class="hljs-class">).  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">createProxyForObject</span></span></span><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DelegateProxy</span></span></span><span class="hljs-class">          ,       ,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">P</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assignProxy</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">proxy</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">toObject</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class">) //     . </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assignProxy</span></span></span><span class="hljs-class">     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DelegateProxy</span></span></span><span class="hljs-class">,    ,   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assignedProxyFor</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assert</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">P</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assignedProxyFor</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class">) === </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">proxy</span></span></span><span class="hljs-class">) } else { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">proxy</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">maybeProxy</span></span></span><span class="hljs-class">! //       -   } let currentDelegate: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AnyObject</span></span></span><span class="hljs-class">? = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">P</span></span></span><span class="hljs-class">.currentDelegateFor(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class">) //       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UI</span></span></span><span class="hljs-class">  ( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">delegate</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataSource</span></span></span><span class="hljs-class">).     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DelegateProxy</span></span></span><span class="hljs-class">   , ..    as!         if currentDelegate !== proxy { //        </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">proxy</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">setForwardToDelegate</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentDelegate</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">retainDelegate</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">) //           .    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UI</span></span></span><span class="hljs-class">        .     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Objective</span></span></span><span class="hljs-class">-</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Rx</span></span></span><span class="hljs-class">,    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_RXDelegateProxy</span></span></span><span class="hljs-class">. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">P</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">setCurrentDelegate</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">proxy</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">toObject</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class">) //     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DelegateProxy</span></span></span><span class="hljs-class">   , ..    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">as</span></span></span><span class="hljs-class">!         </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assert</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">P</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentDelegateFor</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class">) === </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">proxy</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assert</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">proxy</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">forwardToDelegate</span></span></span><span class="hljs-class">() === </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentDelegate</span></span></span><span class="hljs-class">) } return proxy }</span></span></code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thus, this function creates a proxy if it was not created earlier, puts it in as the current delegate, and if it was, it retains the normal delegate. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I don‚Äôt really want to go very deep into the implementation, I‚Äôll just say that the method substitution when calling delegate methods is done with a standard swizzling from Objective-C code. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I created a UML sequence diagram, I hope it will become a little clearer with it how the proxy is created (the image is clickable). </font><font style="vertical-align: inherit;">And now we dive a little deeper, for the last time, I promise. </font><font style="vertical-align: inherit;">What to do if our UI class has a delegate, but it is a successor from another UI class that also has a delegate? The factory method will help us.</font></font><br><br> <a href=""><img src="https://habrastorage.org/files/2f1/7ba/309/2f17ba30992448a7be33a9ef268e0d11.png"></a> <br><br><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consider the example of UITableView. </font><font style="vertical-align: inherit;">He is the heir of UIScrollView, and of which there is also a delegate. </font><font style="vertical-align: inherit;">Therefore, rx_delegate is defined in the parent class (UIScrollView), not in the UITableView. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The proxy for RxTableViewDelegateProxy is derived from RxScrollViewDelegateProxy</font></font><br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIScrollView</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** Factory method that enables subclasses to implement their own `rx_delegate`. - returns: Instance of delegate proxy that wraps `delegate`. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rx_createDelegateProxy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">RxScrollViewDelegateProxy</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">RxScrollViewDelegateProxy</span></span>(parentObject: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) } <span class="hljs-comment"><span class="hljs-comment">/** Reactive wrapper for `delegate`. For more information take a look at `DelegateProxyType` protocol documentation. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rx_delegate: <span class="hljs-type"><span class="hljs-type">DelegateProxy</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> proxyForObject(<span class="hljs-type"><span class="hljs-type">RxScrollViewDelegateProxy</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) } ... }</code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In his proxy, the method of the class createProxyForObject is redefined, which delegates the creation of the proxy to the method rx_createDelegateProxy </font></font><br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RxScrollViewDelegateProxy</span></span> : <span class="hljs-title"><span class="hljs-title">DelegateProxy</span></span> , <span class="hljs-title"><span class="hljs-title">UIScrollViewDelegate</span></span> , <span class="hljs-title"><span class="hljs-title">DelegateProxyType</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> class func </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createProxyForObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">: AnyObject</span></span></span><span class="hljs-function">) -&gt; AnyObject</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> scrollView = (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>! UIScrollView) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> castOrFatalError(scrollView.rx_createDelegateProxy()) } ... }</code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In the UItableView, the rx_createDelegateProxy method is overridden </font></font><br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UITableView</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** Factory method that enables subclasses to implement their own `rx_delegate`. - returns: Instance of delegate proxy that wraps `delegate`. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rx_createDelegateProxy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">RxScrollViewDelegateProxy</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">RxTableViewDelegateProxy</span></span>(parentObject: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) } ... }</code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The RxTableViewDelegateProxy constructor calls the parent constructor when it is created (in our case, RxScrollViewDelegateProxy) </font></font><br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RxTableViewDelegateProxy</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RxScrollViewDelegateProxy</span></span></span><span class="hljs-class"> , </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UITableViewDelegate</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tableView: <span class="hljs-type"><span class="hljs-type">UITableView?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">required</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(parentObject: <span class="hljs-type"><span class="hljs-type">AnyObject</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.tableView = (parentObject <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>! <span class="hljs-type"><span class="hljs-type">UITableView</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(parentObject: parentObject) } }</code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thus, the entire proxy chain is initialized. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The next UML scheme, as far as possible, can be seen on it as the creation and assignment of a proxy takes place, taking into account inheritance (the image is clickable).</font></font><br><br> <a href=""><img src="https://habrastorage.org/files/44d/0e4/992/44d0e4992fd5462c80cc01d1ce48decb.png"></a> <br><br>  Summarize.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RxSwift theme is very interesting, although the current state of the project and not without rough edges. </font><font style="vertical-align: inherit;">Having understood how it works, you need to think about how to correctly apply it within the framework of the architecture.</font></font><br><br>  Well.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Writing such articles, on the one hand, makes you understand the material more deeply; on the other hand, it takes a considerable amount of time. </font><font style="vertical-align: inherit;">Does it make sense to continue writing on this topic? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unfortunately, I cannot position myself as a cool architect, rather as a person in search of a ‚Äúsilver bullet‚Äù, so my conclusions can be both obvious and incorrect, but the road can be reached by walking. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">About all errors as always - in PM.</font></font></div><p>Source: <a href="https://habr.com/ru/post/283128/">https://habr.com/ru/post/283128/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../283108/index.html">Playing with keywords in javascript</a></li>
<li><a href="../283112/index.html">We use undocumented site API captionbot.ai</a></li>
<li><a href="../283116/index.html">DNS disorder Vkontakte and other companies</a></li>
<li><a href="../283118/index.html">Victor Gamov on In-Memory Data Grids and Hazelcast on jug.msk.ru</a></li>
<li><a href="../283122/index.html">Slit survey: implementation on bash (ffmpeg + imagemagick)</a></li>
<li><a href="../283130/index.html">Goals against restrictions</a></li>
<li><a href="../283132/index.html">Qook: Port an old toy to Android and share it with the world.</a></li>
<li><a href="../283136/index.html">Geography package or library that knows geography well and speaks different languages</a></li>
<li><a href="../283138/index.html">The digest of interesting events from the world of Java, and around it # 1 (05/02/2016 - 05/05/2016)</a></li>
<li><a href="../283146/index.html">How to enable Intel AMT, if the manufacturer forgot it</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>