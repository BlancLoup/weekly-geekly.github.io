<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Android security. Lecture in Yandex</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Developer Dmitry Lukyanenko, whose lecture we are publishing today, is not only a Yandex specialist, but also knows how to test the strength of the de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Android security. Lecture in Yandex</h1><div class="post__text post__text-html js-mediator-article">  Developer Dmitry Lukyanenko, whose lecture we are publishing today, is not only a Yandex specialist, but also knows how to test the strength of the decisions of developers of other companies.  This allows you to learn from the mistakes of others - sometimes including their own, of course.  In the report, Dmitry will share examples of Android vulnerabilities, including those he himself found.  Each example is accompanied by recommendations - how to and how not to write applications for Android. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/6Xj54AdvSls" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  My name is Dmitry, I work at Yandex in the Minsk office, I am developing an account manager.  This is the library that is responsible for authorizing users.  Therefore, we will talk about the security of Android applications. <br><a name="habracut"></a><br>  I would highlight the following sources of problems.  The first - network related to communication with the server.  This is when your data is not transmitted in a completely secure way.  The latter are related to the problem of data storage: this is when your data is stored somewhere in the open form, it can even be stored somewhere on the SD card, or it is not encrypted, in general, when it is accessed from the outside. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The third kind of problem is the impact of third-party applications on yours.  This is when a third-party application can get unauthorized access to yours, perform some actions on behalf of the user, or even steal something, etc. <br><br>  In this report, we will focus on the third type of problems associated with the impact of third-party applications.  We will consider not only the theory, but also specific examples from real-life applications.  And some of these examples are still relevant, apparently, they were simply scored, but they seem to me quite interesting. <br><img src="https://habrastorage.org/files/5a2/06d/673/5a206d673cff47e3a2df4eb82172f7b0.jpg"><br>  This report will be useful to those who are engaged in Android development.  I would advise to pay attention to these aspects to all who make applications.  For example, testers.  Testers, it seems to me, if they look at these nuances, will be able to knock out some bonuses, they will begin to delve more deeply into the development, and you can even not learn much of programming.  Manifest file will simply be able to analyze and identify potentially dangerous places.  And everyone else who is interested in such security issues. <br><img src="https://habrastorage.org/files/47a/590/09f/47a59009feae44cb87e5c52a55b36293.jpg"><br>  Before we begin, it is worth mentioning the software, which can be useful.  First of all, BytecodeViewer, a very useful program, allows you to get from the apk-file all the sources, all the resources, including the manifest-file, from the apk-file. <br><img src="https://habrastorage.org/files/ed2/20e/171/ed220e1715ac4e969e08f47f2e9e56b4.jpg"><br>  It is worth noting a handy utility for Android - ManifestViewer.  It allows you to quickly view the manifest files of all installed applications.  I use it for work, for example, when people come to me and say: the account manager does not work, what is it?  First of all, I always look at the manifest file to make sure that the account manager has been properly integrated, that is, that all its components are declared as it should. <br>  This program is useful for you to quickly open and look at the entry points, the vector of attacks from the manifest file. <br><br>  If you like to do everything from the console, here are all these programs separately.  apktool allows you to pull out all the resources and the manifest file.  Dex2jar and enjarify allow you to convert apk-file to jar.  Dex2jar may not convert some apk, issue it with some kind of exception.  Do not despair: often these files are consumed by enjarify, and you get a jar.  These are two good utilities. <br><br>  Once you have jar-files, you can take a Java Decompiler and convert them to a more convenient form - in the form of classes.  It is clear that they can not be run, but it is much easier to analyze them than the code that turns out there, etc. <br><img src="https://habrastorage.org/files/8ee/b42/df4/8eeb42df478e42d3b427afdf933afbcf.jpg"><br>  Let's look at the most basic problems.  First, we first need to analyze the manifest file, because all the components of the Android application must be described in it.  This is Activity, Service, Broadcast Receiver, ContentProvider.  All of them, with the exception of Broadcast Reciever, must be there. <br><br>  So when we start looking for some problems, we look at these components.  Here is a specific example.  This is a service that was declared in the manifest file of a single application, it is explicitly exported.  It even explicitly states that it is exported.  This means that it is available to any other third-party application.  Any other application, in turn, can send an intent to this service, and the service can perform some actions, if they are provided there. <br><br>  In this case, we see a potential attack vector.  If we dig deeper and look at the sources, it will become clear from them that this service allows, say, to delete an authorized user in this program.  I doubt that the developers provided such a feature for some third-party applications.  This is a concrete example that should be addressed. <br><br>  One more thing: when we have some component that uses intent filters, by default it also becomes exportable.  Here, perhaps, novice developers may stumble.  If the intent filter is there, then everything, this component is already public.  Here it is worth being attentive. <br><br>  I encountered these kinds of problems, when a number of actions can be taken on a notification that is displayed in the corresponding panel.  For example, this happened in Yandex.Mail and other applications. <br><img src="https://habrastorage.org/files/01c/feb/d30/01cfebd30d8d4e76b9df54d4ab9ece61.jpg"><br>  What did this event do?  It was processed using a public BroadcastReciever.  That is, the attacker could also send any Broadcast - pick up the ID of the letter and, say, delete it.  And it is not necessary that this was a message in the panel. <br><br>  Once upon a time in Yandex. Mail was such a vulnerability.  Already all corrected, so that you can use, everything is fine.  Thanks Ildar, they quickly do it all. <br><img src="https://habrastorage.org/files/20e/b3b/351/20eb3b3513f4470383245c6fc5a0c15a.jpg"><br>  How was this decided?  The component was simply made inaccessible from the outside, another permission was added.  It could not have been installed, the main thing is if it is not exported, it means that no one can connect to it and do something. <br><img src="https://habrastorage.org/files/e46/c1b/4c9/e46c1b4c9c254c5988de2fb77880ef57.jpg"><br>  The next type of problem is the use of implicit intents, when the intent is not to specify the specific place to which it should come.  This means that you have no guarantee that this intent will go where you want.  He may come somewhere else.  Therefore, here we must be careful. <br><br>  Another nuance that I would attribute to implicit intents is Browsable Activity, when we can open a third-party Application from our browser.  This happens when some kind of scheme is set, the host is clicked there and a window opens.  Well, when the window just opened and for example, passed the position on the map.  It's not scary.  But scary - the following.  Let's say we have some guys offer to use Slack in the company.  Slack has a very interesting authorization.  If you are logged in to the browser on Android, then you can log in to the installed Slack application.  It works according to this scheme, when there is a URL in the browser, you click on it and the Slack application intercepts it. <br><img src="https://habrastorage.org/files/abf/d16/49f/abfd1649fe2d458796988043dddbdec1.jpg"><br>  But there is no guarantee that the URL is not intercepted by someone else, and the token is transmitted through it.  The scheme is quite simple: when you click in the browser, you are immediately authorized in the Slack application.  This means that this URL is sufficient for authorization. <br><img src="https://habrastorage.org/files/6ff/ca5/cc6/6ffca5cc6e504ee1aa6618cfd9a2a16a.jpg"><br>  There are buttons that can be clicked in the browser and which initiate this discovery.  This is not only ‚ÄúOpen Slack‚Äù, but also the logo - it is always on top, on any screen. <br><br>  Let's watch a video that demonstrates how to use this problem.  We logged in, logged into our directory, clicked on the Slack logo - but we don‚Äôt have the Slack application, the attacker substituted an intent filter.  Returned, clicked ... You can do phishing - exactly the same in appearance as Slack.  Write that the authorization did not work and all that.  The user does not understand, and the token will be with you.  Therefore, if you use Slack, then be careful with this browser authorization. <br><img src="https://habrastorage.org/files/156/65f/946/15665f946d2847c4adfc6175fe910408.jpg"><br>  The solution is very simple.  As my colleague said, you can use explicit intents that open from the browser.  But when I signed up with Slack and my ticket received the number 80000 with something, they said it was a duplicate and that there was already a 5000-some sort of ticket.  If you estimate, it turns out that they were told more than six months ago.  It seems to be fixed rather simply, but - they did not fix it.  It means that this is not a critical problem and then you can talk about it. <br><br>  There is a recommendation that it is always better to use explicit intent.  If you read and understand more deeply, you will find out that Android had a funny typo.  They used the implicit pending intent in one place.  Because of this, it was possible to access the user with system privileges.  They fixed these errors in Android 5. Everyone has such errors, even Google. <br><br>  It is always better to use explicit intent or, if this is not possible, always ask for some kind of permission.  It allows you to restrict access. <br><br>  Consider another type of vulnerability - based on user data. <br><br><img src="https://habrastorage.org/files/20b/e61/24e/20be6124eb1347738bdf8294a0ecf019.jpg"><br><br>  We have applications that can get some data from users, for example, send a file, open it, view it.  This is usually done using intents like view and send. <br><br>  This malicious application can tell you: send me the file that you have in the private directory, in your sandbox.  Suppose this file can be your database containing all the correspondence, or preferences, if any tokens are stored.  Some applications can perform some actions with these files.  For example, they can cache the file on an SD card or send it somewhere.  In particular, you can perform such an action that this file will be available to the attacker, although initially they assumed that this would be their internal file. <br><br>  You can take getAbsolutePath () and check if the directory matches your private one.  But it's not right. <br><img src="https://habrastorage.org/files/ebf/d73/d27/ebfd73d2725e4e81b93bc87780ab42f3.jpg"><br>  An attacker may not send you the file itself, but a link to it. <br><br>  How can this link be created?  The attacker creates a readme.txt - he made a link to a private file of your application.  Then he pushed this link to you, and if you use getAbsolutePath (), then the link path is returned to you - the path to the readme.txt file.  And you think that everything is fine. <br><br>  To fix this, it is better to use the getCanonicalPath () method.  It returns the full path, the real one.  In this case, the system will not return a readme.txt, but some mailbox.  Consider these issues. <br><br>  I came across a situation where a single application with more than 50 million users had a similar problem.  You say: show me this file.  They cache it on the SD card and then try to open it.  So it was possible to steal all tokens.  They have already fixed everything, but have asked not to disclose yet.  However, this occurs. <br><br>  The next interesting point: you can send a link to the content provider, and it can also be transferred.  Even if it is protected by permission, even if it is not exported, it‚Äôs all the same - when your application tries to open it, the query method that is in the content provider will be executed. <br><br>  You have to be careful here.  Here is another real example, already from another application.  They made a backup of the database from the query method.  There it was possible to transfer an action of type backup and the program immediately duplicated the entire database to the SD card.  It turns out that the provider is protected, but you can slip it in such a way as to end up with the entire database. <br><img src="https://habrastorage.org/files/616/740/b13/616740b1367049578f066c9956e64b62.jpg"><br><img src="https://habrastorage.org/files/4c7/d06/5e5/4c7d065e58ae4d8bb56f92f53610bd1c.jpg"><br>  I have never met anyone else to write in the query method, but there it is always better to open something for reading.  And also consider that there may be a SQL injection.  Now there are a number of applications in which I discovered the possibility of SQL injection.  However, they have read-only access, and I have not yet understood whether something can be done further there.  But suddenly there is a vulnerability in the SQLite database itself, which will allow to perform an injection that is not so harmless?  Still, it is better not to allow them, even if if you open only read access. <br><br><img src="https://habrastorage.org/files/1e0/528/6c5/1e05286c50364bffbaed925f45027574.jpg"><br><br>  Now let's consider one problem with WebView, and it works in all Android up to version 5.0 and allows you to bypass the SOP.  From this we conclude that in WebView it is better not to let anyone open their files. <br><img src="https://habrastorage.org/files/27b/cbb/115/27bcbb115dae486dba40c580550bf25f.jpg"><br>  Consider this type of attack.  A malicious application can ask your application if it has access to WebView: show me the index.html file.  Suppose your application has opened index.html.  The content of the file is very simple - JavaScript, which after 5 seconds the file itself, itself, loads into the iframe, reloads, as it were. <br><img src="https://habrastorage.org/files/4bb/0e8/d40/4bb0e8d409d24b68ab87dcb04ed0d537.jpg"><br>  During this time period, the malicious application deletes the specified file and replaces it with a symbolic link to a private file from your application.  It takes 5 seconds, it reboots, but the content in it already becomes the content of the same private file.  On Android before 5.0, even before WebView, apparently, there is an incorrect check that this is a symbolic link.  This way you can read the content.  It looks - the file names match, which means the SOP is not broken, the content can be given away and it means that JavaScript can take the content and send it to the server. <br><img src="https://habrastorage.org/files/02e/43f/51e/02e43f51e78f4e8fa2b3950b46570f63.jpg"><br>  This type of attack is not only found in WebView.  He still works at UCBrowser, which has more than 100 million installations.  I have seen this on some versions of the Android browser, up to Android 5.0.  Probably, it is also built on WebView.  For example, on Samsung phones I couldn‚Äôt play this, but on my Acer phone it works. <br><img src="https://habrastorage.org/files/2be/ba6/62a/2beba662a0134feebdc694eb5b4ce380.jpg"><br>  Watch a short video on how this works in UCBrowser.  It's about a small malicious application, but it may work.  You went to bed, the phone, too, an activity, a page, suddenly starts.  You are asleep, and there it started - some iframe, confirmation, alert.  If the alert read the content, it means that we could also send this content anywhere.  This is bookmark.db, bookmarks are stored here.  I think anyone interested - can search.  It may be possible to find more private user data there.  You can steal cookies too.  But their cookies are named for the site, so you need to sort out.  VKontakte can be taken.  Vulnerability is still there, it seems like they have not yet been fixed and are in no hurry to fix it. <br><img src="https://habrastorage.org/files/4cf/32b/664/4cf32b664dec4c03a72c3cca3e670898.jpg"><br><img src="https://habrastorage.org/files/ff2/1c4/166/ff21c416621d434695763de41a2aba26.jpg"><br>  <strong>Conclusion:</strong> if you have a WebView, do not let anyone open your links in it.  And if you still give, then at least prohibit the opening of local files.  In this regard, Qiwi‚Äôs great fellows, I tried their application, was delighted that now I‚Äôll open the file - but no, they have forbidden to open local files and can‚Äôt do anything. <br><br>  Consider the following kind of nontrivial problem.  It is based on the features of deserialization in Android.  Perhaps Java developers themselves might be useful. <br><br>  Imagine that we have an intent that contains some data that is transmitted to our application ‚Äî it takes one field and reads it from the intent.  And if the application counted at least one field, then all the data in the intent will be automatically deserialized.  Even if they are not used, they are still deserialized.  Now you will understand what is dangerous here. <br><br>  There is such a bonus in Android up to 5.0: on some versions, during deserialization, it is not checked that the class actually implements the serialization interface. <br><br>  This means that all classes that are in your application may be vulnerable.  Yes, they may not be serializable, but if they fit the criteria that will be described later ... <br><img src="https://habrastorage.org/files/233/09e/792/23309e792d5a4188870f00eda28b5a73.jpg"><br>  So, what is dangerous here?  If an object has been created, it will someday be deleted.  Usually, the finalize method will be called, there is nothing dangerous, nothing is implemented.  However, when there is native development, usually in the finalize method, a destructor is called from the native area and the pointer is passed there.  I didn‚Äôt do any native development, but I learned how to get pointers there.  If this pointer is serialized, then the attacker can substitute his own, and he, in turn, can either cause an error exceeding the memory boundaries, and point to another memory, which then takes and executes some code. <br><img src="https://habrastorage.org/files/739/84a/358/73984a3588e64ce3b4235993be81d6dc.jpg"><br>  This was used by the guys from IBM.  They analyzed the entire list of classes on the Android platform - checked out more than a thousand or how many are there.  And they found only one that met the criteria: it was serializable, and it serialized the native pointer.  They took this class, set up their pointer, it was serialized and deserialized.  He was not new every time.  We made a proof of concept, a demonstration, there is a video.  This vulnerability allowed them using this class to send an intent to a system application.  It allowed them, for example, to remove the original Facebook application and replace it with a fake one.  The video lasts about 7 minutes. There you have to turn it around - until the finalize is called, until the memory is cleared.  But the conclusion is that you never need to deserialize the native pointer. <br><br><img src="https://habrastorage.org/files/e30/14f/386/e3014f38685248c48e82835eca2ea14d.jpg"><br><br>  To summarize  It is better to never export the components that are in your application.  Or - to restrict access by permission.  Intents are always better to use explicit or permission to set.  Never trust the data that comes from the user - it can be data for anything, even to your private areas.  You can then damage them.  Carefully consider ContentProvider, including SQL injection, etc. <br><br>  Such a thing as WebView is not a toy at all.  If it is in your application, close it and do not let anyone play with it. <br><br>  Serialization, or rather, native development, is also like a match, be careful with it.  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/310926/">https://habr.com/ru/post/310926/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../310872/index.html">ROAD audio codec analysis</a></li>
<li><a href="../310886/index.html">Replacing the boot-animation of an Android device with flickering Linux kernel logs</a></li>
<li><a href="../310892/index.html">Configuring D-link DSR routers to work with 3CX</a></li>
<li><a href="../310922/index.html">40% of organizations store admin passwords in spreadsheets and text files</a></li>
<li><a href="../310924/index.html">Forcing Asynchrony in Java Services for Baratine</a></li>
<li><a href="../310928/index.html">Monitor client PCs in Microsoft AD with Zabbix. Part 1 - Auto Install</a></li>
<li><a href="../310930/index.html">Placement of the table of values ‚Äã‚Äãwith the help of additional requisite and expansion of the 1C configuration</a></li>
<li><a href="../310938/index.html">Laziness, impatience and self-conceit are the three main virtues of a programmer. Happy birthday, Larry Wall</a></li>
<li><a href="../310942/index.html">Ultralight BDD: Little Mechanization of Stand-Alone Tests</a></li>
<li><a href="../310944/index.html">After the biggest data theft in history on Yahoo! still ‚Äú33 misfortunes‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>