<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to manipulate SIP messages on AudioCodes hardware</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the SIP protocol, it is often necessary to change the fields for compatibility and solving some particular problems at the junction between telepho...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to manipulate SIP messages on AudioCodes hardware</h1><div class="post__text post__text-html js-mediator-article">  In the SIP protocol, it is often necessary to change the fields for compatibility and solving some particular problems at the junction between telephone exchanges.  This can be either the removal of a simple SIP field, or the transfer of a value from one SIP field to another, or some more complicated manipulation. <br><a name="habracut"></a><br>  How this can be done on the equipment AudioCodes SBC (And absolutely on any SBC, even the youngest model).  Before you begin to describe how the transformation is done, we first deal with the terminology. <br>  As an example, take the INVITE message: <br><br>  INVITE sip: 84951234567@10.11.12.13: 5060; transport = udp SIP / 2.0 <br>  Via: SIP / 2.0 / UDP 10.11.12.13:5060;branch=z9hG4bK-2342-1C21439 <br>  To: &lt;sip: 84951234567@sip.sp.com; user = phone&gt; <br>  From: "Ivanov" &lt;sip: 4957654321@sip.sp.com; user = phone&gt;; tag = 26814-XM-09a664f9-77e583465 <br>  Allow: UPDATE, REFER, INFO <br>  Call ID: 26814-TO-09a664f8-0a52daf11@sip.sp.com <br>  Contact: &lt;sip: 12/13/11/10: 5060&gt; <br>  Content-Type: application / sdp <br>  CSeq: 157771616 INVITE <br>  History-Info: &lt;sip: 4952345678@20.21.22.23? Reason = Forward&gt; <br>  Max-Forwards: 29 <br>  User-Agent: GW_SIP <br>  Content-Length: 258 <br><br>  v = 0 <br>  o = cp10 139660536057 139660536057 IN IP4 12/13/11/10 <br>  s = sip call <br>  c = IN IP4 12/13/11/10 <br>  t = 0 0 <br>  m = audio 31854 RTP / AVP 8 0 18 <br>  b = AS: 80 <br>  a = rtpmap: 8 PCMA / 8000/1 <br>  a = rtpmap: 0 PCMU / 8000/1 <br>  a = rtpmap: 18 G729 / 8000/1 <br>  a = fmtp: 18 <br>  annexb = no <br>  a = ptime: 20 <br>  a = sendrecv 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For example, take the From field: <br>  From: "Ivanov" &lt;sip: 4957654321@sip.sp.com; user = phone&gt;; tag = 26814-XM-09a664f9-77e583465 <br>  Here: <br>  From - Title <br>  ‚ÄúIvanov‚Äù - display name header parameter <br>  sip: 4957654321@sip.sp.com - SIP URL, where <br>  4957654321 - user part of the SIP URL <br>  Sip.sp.com - url part of the SIP URL <br>  Tag: title parameter <br>  AudioCodes knows quite a lot of fields and can parse them into parameters and SIP URLs.  But, of course, not everything, because according to the SIP standard, it is possible to add any title that is not described anywhere and in any way.  In this case, only regular expressions can help to parse this header.  A more detailed description of what headers AudioCodes equipment knows and which ones does not know is described in the documentation: "SIP Message Manipulations Quick Reference Guide".  I do not publish the link here, because the link to our site requires a certain level of access, but I will not post it in public access, because at any moment in time this link may stop living.  If suddenly someone needs this documentation, then write, be sure to share. <br><br>  When creating a manipulation rule, there are the following rule parameters: <br>  Manipulation index - rule number.  Rules are processed sequentially. <br>  Manipulation Set ID - a set of rules that you apply for a particular direction. <br>  Message Type - the type of message you are trying to manipulate.  It can be simply invite, or the answer to invite - invite.response.200, or the answer 2xx to register = register.response.2xx.  And so on by analogy.  Separately, you can select the message reINVIE - reinvite.request <br>  Condition - under what condition this rule is executed, and under what condition it is not.  Here you can give a simple example header.from.url.user == '4957654321'.  This means that the User part of the SIP URL of the From field is 4957654321. You can also use the ==,! =,&gt; =, &lt;=,&gt;, &lt;, Contains,! Contains, exists,! Exists, suffix, prefix, len&gt; signs , len &lt;, len ==, regex.  All characters can be listed with or or and except Regex. <br>  Action Subject - the title that you plan to change (Either the header parameter).  For example: header.history-info <br>  Action value is what you are doing to Add / Remove / Modify / Add Prefix / Add Sufix / Remove Suffix / Remove Prefix. <br>  Action Subject is what you plan to insert if Remove is not specified in Action Subject.  The syntax is very important here. <br>  a.  If you plan to insert a value from another header, then you just need to specify the title.  For example: header.from.url.user <br>  b.  If you plan to use an internal variable, then only the internal variable is specified.  For example: param.message.address.dst.address (IP address where the message is sent) <br>  c.  If you plan to use the part selected using a regular expression, then the sign of the $ indicates the part number of the regular expression.  For example: $ 2 <br>  d.  If you plan to just insert a specific value, then it is indicated in single quotes.  For example 'Vsem Privet!' <br>  e.  If you plan to combine these values, this is done through the + sign.  For example: header.from.url.user + $ 2 + 'vsem Privet!'. <br><br>  Let's give an example of a regular expression.  A rather common task that confronts me is that in the case of a redirected number (as in the example above), it is necessary to transfer the number from the history-info field to the From field.  That is, the task is as follows: <br>  1. Move to the From field <br>  2. Delete the History-info field. <br>  How it's done <br>  Since AudioCodes does not parse the History-info field, the number can only be selected using a regular expression.  We build a regular expression in order to select a number from the header: <br>  <b>History-Info: &lt;sip: 4952345678@20.21.22.23? Reason = Forward&gt;</b> <br><br>  Highlight is required without regard to the title name.  An example of such a regular expression would be <br>  ^ (&lt;sip:) (. *) (@) (. *) <br>  The required number will be the second parameter in this regular expression.  That is, we need to insert the value of $ 2. <br><br>  An example of such an expression: <br>  Manipulation Set ID: 1 <br>  Message Type: invite <br>  Condition: header.history-info regex ^ (&lt;sip:) (. *) (@) (. *) <br>  Action Subject: header.from.url.user <br>  Action Type: Modify <br>  Action Value: $ 2 <br><br>  Since then we need to remove the field Histroty-info, we need to create another rule within the framework of the same Manipulation Set ID <br>  Manipulation Set ID: 1 <br>  Message Type: invite <br>  Condition: header.history-info exists <br>  Action Subject: header.history-info <br>  Action Type: Remove <br><br>  Then you just need to apply this Set ID as an outgoing rule for the corresponding IP Group.  Then at the output we will receive a message of the following form: <br>  INVITE sip: 84951234567@10.11.12.13: 5060; transport = udp SIP / 2.0 <br>  Via: SIP / 2.0 / UDP 10.11.12.13:5060;branch=z9hG4bK-2342-1C21439 <br>  To: &lt;sip: 84951234567@sip.sp.com; user = phone&gt; <br>  From: "Ivanov" &lt;sip: 4952345678@sip.sp.com; user = phone&gt;; tag = 26814-XM-09a664f9-77e583465 <br>  Allow: UPDATE, REFER, INFO <br>  Call ID: 26814-TO-09a664f8-0a52daf11@sip.sp.com <br>  Contact: &lt;sip: 12/13/11/10: 5060&gt; <br>  Content-Type: application / sdp <br>  CSeq: 157771616 INVITE <br>  Max-Forwards: 29 <br>  User-Agent: GW_SIP <br>  Content-Length: 258 <br><br>  v = 0 <br>  o = cp10 139660536057 139660536057 IN IP4 12/13/11/10 <br>  s = sip call <br>  c = IN IP4 12/13/11/10 <br>  t = 0 0 <br>  m = audio 31854 RTP / AVP 8 0 18 <br>  b = AS: 80 <br>  a = rtpmap: 8 PCMA / 8000/1 <br>  a = rtpmap: 0 PCMU / 8000/1 <br>  a = rtpmap: 18 G729 / 8000/1 <br>  a = fmtp: 18 <br>  annexb = no <br>  a = ptime: 20 <br>  a = sendrecv <br><br>  Often there is a question in the manipulation to use some variables that are not in the SIP message, for example, the remote IP address.  In this case, it is required to use internal variables, such as <br>  Param.message.address.dst.address - Remote IP address to which the SIP message is sent. <br><br>  All internal variables are described in the documentation I referred to before. <br><br>  It is also possible to transfer parameters from one SIP message to another, after saving them in variables.  These examples in this article will not be considered. <br><br>  We should also note that this rule can be applied not only to the SBC variant, but also to the AudioCodes voice gateway, but with the restriction that the rule will only work for messages to invite.  To do this, you also need to create the necessary Manipulation SetID and apply it as an inbound or outbound rule using the GWOutboundManipulationSet parameter and GWInboundManipulationSet, respectively. </div><p>Source: <a href="https://habr.com/ru/post/253015/">https://habr.com/ru/post/253015/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253003/index.html">ZeptoLab Code Rush 2015 is near</a></li>
<li><a href="../253005/index.html">Safety rules for online store users</a></li>
<li><a href="../253009/index.html">Open database of defects in closed software</a></li>
<li><a href="../253011/index.html">Tweaking Spark IM Client</a></li>
<li><a href="../253013/index.html">We exploit root-vulnerability in Asus routers</a></li>
<li><a href="../253017/index.html">Very large postgres</a></li>
<li><a href="../253025/index.html">Magnetic tape - the old horse does not spoil the furrow</a></li>
<li><a href="../253027/index.html">7th IT Jam Meet & Mix News 2015</a></li>
<li><a href="../253029/index.html">About Git Beginners and Git Starter Articles</a></li>
<li><a href="../253031/index.html">Hybrid implementation of the MST algorithm using CPU and GPU</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>