<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we learned to draw texts on Canvas</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We are developing a platform for visual collaboration . To display the content, we use the Canvas: everything is drawn on it, including texts. There i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we learned to draw texts on Canvas</h1><div class="post__text post__text-html js-mediator-article">  We are developing a <a href="http://miro.com/">platform for visual collaboration</a> .  To display the content, we use the Canvas: everything is drawn on it, including texts.  There is no ready-made solution for displaying texts on Canvas one-to-one as in html.  Over several years of working with text rendering, we studied various options for implementation, stuffed a lot of bumps, and seem to have found a good solution.  I'll tell you in the article how we moved from Flash to Canvas and why we refused SVG foreignObject. <br><br><img src="https://habrastorage.org/webt/jf/x3/vm/jfx3vm1-ffhat8wfv1jwvc5vf6i.gif"><br><br><h2>  Moving from Flash </h2><br>  We created the product in 2015 in Flash.  Inside Flash, there is a text editor that can work well with texts, so we didn‚Äôt have to do anything extra to work with texts.  But at that time, Flash was already dying, so we moved from it to HTML / Canvas.  And we faced the task - to display the text on the Canvas as in the html-editor, without breaking the texts created in the Flash version when moving. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We wanted to make it so that the user could edit the text directly in our product, without noticing the transition between editing and drawing modes.  We saw this solution: when you click on a text area, a text editor opens in which you can change the text;  the editor can be closed by removing the cursor from the text area.  In this case, the display of text on the Canvas should 1 in 1 correspond to the display of text in the editor. <br><br>  As an editor, we used an open library, but the ready-made libraries for rendering from html to Canvas did not suit us with the speed of work and insufficient functionality. <br><br>  We considered several solutions: <br><br><ul><li>  <b>Standard Canvas.fillText.</b>  Able to draw text as in html, can be styled, works in all browsers.  But he does not know how to draw links as in a html-editor multiline texts with different formatting.  These difficulties are solvable, but require a large amount of time; </li><li>  <b>Draw DOM over Canvas.</b>  The option did not suit us, because  we have in the product each created object has its own z-index on canvas.  And mixing it with the DOM z-index will not work. </li><li>  <b>Convert html to svg.</b>  He can turn html into an image thanks to the foreignObject element.  This allows you to bake html inside svg and work with it as with an image.  We chose this option. </li></ul><br><h2>  Features of SVG foreignObject </h2><br>  <b>How does SVG foreignObject work:</b> we have HTML from the editor ‚Üí put HTML into foreignObject ‚Üí some magic ‚Üí we get an image ‚Üí we add an image to the canvas <br><br><img src="https://habrastorage.org/webt/hj/ht/gp/hjhtgpn56gwrvg1vuoeqqxpbssi.png"><br><br>  <b>About magic.</b>  Despite the fact that most browsers support the foreignObject tag, each has its own peculiarities for using the result with canvas.  FireFox works with a Blob object, in Edge you need to make Base64 for an image and return a data-url, and in IE11 the tag does not work at all. <br><br><pre><code class="javascript hljs">getImageUrl(svg: string, <span class="hljs-attr"><span class="hljs-attr">browser</span></span>: string): string { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> dataUrl = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (browser) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> browsers.FIREFOX: <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> domUrl = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.URL || <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.webkitURL || <span class="hljs-built_in"><span class="hljs-built_in">window</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> blob = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Blob([svg], {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'image/svg+xml;charset=utf-8'</span></span>}) dataUrl = domUrl.createObjectURL(blob) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> browsers.EDGE: <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> encodedSvg = <span class="hljs-built_in"><span class="hljs-built_in">encodeURIComponent</span></span>(svg) dataUrl = <span class="hljs-string"><span class="hljs-string">'data:image/svg+xml;base64,'</span></span> + btoa(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.unescape(encodedSvg)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: dataUrl = <span class="hljs-string"><span class="hljs-string">'data:image/svg+xml,'</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">encodeURIComponent</span></span>(svg) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dataUrl }</code> </pre> <br>  After working with SVG, we had some interesting bugs that we didn‚Äôt notice in Flash.  Text with the same size and font was displayed differently in different browsers.  For example, the last word in a line could be transferred and run into the text below.  It was important for us that users get the same type of widgets, regardless of the browsers in which they work.  On Flash, this was not a problem, because  he is the same everywhere. <br><br><img src="https://habrastorage.org/webt/mb/63/fv/mb63fvrwyib4m-tnl_1xre8j55w.png"><br><br>  We solved this problem.  Firstly, for all single-line texts, the width was always assumed, regardless of the browser and data from the server.  For height, the difference remains, but in our case it does not interfere with users. <br><br>  Secondly, experimentally, we came to the conclusion that it is necessary to add several unusual css-styles for the editor and svg in order to reduce the display difference between browsers: <br><br><ul><li>  font-kerning: auto;  manages font kerning.  <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/font-kerning">Read more</a> </li><li>  webkit-font-smoothing: antialiased;  responsible for anti-aliasing.  <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/font-smooth">More details</a> . </li></ul><br>  What we ended up with thanks to the SVG &lt;foreignObject&gt;: <br><br><ul><li>  We can draw any html: text, tables, graphics </li><li>  The tag returns a vector image </li><li>  The tag works in all modern browsers except IE11 </li></ul><br><h2>  Why we abandoned foreignObject </h2><br>  Everything worked well, but once designers came to us and asked to add font support to create mockups. <br><br><img src="https://habrastorage.org/webt/ud/90/ha/ud90haadatev9z1dvo2qjnu5tle.png"><br><br>  We wondered if we could do this with foreignObject.  It turned out that he had a peculiarity, which, when solving this problem, becomes a fatal flaw.  It can display HTML within itself, but cannot access external resources, so all the resources it works with must be converted to base64 and added inside svg. <br><br><img src="https://habrastorage.org/webt/bj/eb/-g/bjeb-gztne3x_o8tefz7701bgs0.png"><br><br>  This means that if you have four texts that are written by OpenSans, you need to download this font to the user four times.  This option did not suit us. <br><br>  We decided that we would write our Canvas Text with ... good performance, support for the vector image, let's not forget about IE 11 <br><br>  Why is vector image important to us?  In our product, any object on the board can be zoomed in, and with a vector image we can create it only once and reuse it, regardless of the zoom.  Canvas.fillText draws a bitmap image: in this case, we need to redraw the image at each zoom, which we thought would have a significant effect on performance. <br><br><h2>  We create a prototype </h2><br>  First we created a simple prototype to test its performance. <br><br><img src="https://habrastorage.org/webt/dc/kt/wh/dcktwh05pk52qdr6jiipfyna-lo.png"><br><br>  The principle of operation of the prototype: <br><br><ul><li>  Give the function "text"; </li><li>  From it we get an object in which there is every word from the text, with coordinates and styles for drawing; </li><li>  Give the object to the Canvas; </li><li>  Canvas draws text. </li></ul><br>  The prototype had several tasks: check that the redrawing of the Canvas at the scale will take place without delay and that the time for turning the html into an object will be no more than creating an svg image. <br><br>  The prototype coped with the first task, the scale almost did not affect the performance when drawing texts.  With the second task, problems arose: processing large volumes of text takes enough time and the first performance measurements showed poor results.  To draw text from 1K characters, the new approach required almost 2 times more time than svg. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zi/xt/cv/zixtcvj3c0sn-pcbfq77glwuhhe.png"></div><br>  We decided to use the most reliable way to optimize the code - ‚Äúreplace the test with the one we need‚Äù ;-).  But seriously, we went to the analysts and asked how long the texts are most often created by our users.  It turned out that the average text size is 14 characters.  For such short texts, our prototype showed significantly better performance results, since  the dependence of speed on the volume of the text is linear, and the wrapper in svg is almost always executed at the same time, regardless of the length of the text.  It suited us: we can lose in performance on long texts, but for most cases our speed will be better than svg. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/0o/kx/4s/0okx4sbw1txhov2dipas8dpysji.png"></div><br>  After several iterations of the work on updating Canvas Text, we had the following algorithm: <br><br>  <b>Stage 1. We break into logical blocks</b> <br><br><ol><li>  We break the text into blocks: paragraphs, lists; </li><li>  We break blocks into smaller blocks by styles; </li><li>  We break blocks into words. </li></ol><br>  <b>Stage 2. We collect in one object with coordinates and styles</b> <br><br><ol><li>  We count the width and height of each word in px; </li><li>  We connect the separated words, since paragraph 2 some words were divided into several; </li><li>  From the words we collect strings, if the word does not fit into the string, we trim it until it fits; </li><li>  We collect paragraphs and lists; </li><li>  Calculate x, y for each word; </li><li>  We get the finished object to draw. </li></ol><br>  The advantage of this approach is that we can cover all the code from HTML to a text object with unit tests.  Thanks to this, we can separately check the rendering and the parsing itself, which helped us to significantly speed up the development. <br><br>  As a result, we made support for fonts and IE 11, covered everything with unit tests, and the rendering speed in most cases was higher than that of foreignObject.  Checked on beta users and released.  It seems a success! <br><br><h2>  Success lasted 30 minutes </h2><br>  So far, the guys with the right-hand letter system have not written to tech support.  It turned out that we forgot about the existence of such languages: <br><br><img src="https://habrastorage.org/webt/av/gq/ik/avgqikn29xgk7fx5xajj171rh5g.gif"><br><br>  Fortunately, it was easy to add support for the right-hand letter system, since the standard Canvas.fillText already supports it. <br><br>  But while we were dealing with this, we met even more interesting cases that fillText could not support.  We are faced with bidirectional texts in which part of the text is written from right to left, then from left to right and again from right to left. <br><br><img src="https://habrastorage.org/webt/ix/ob/gr/ixobgrf-sffclz5p2rbsikodizo.gif"><br><br>  The only solution we knew was to go to the W3C browser specification and try to repeat it inside Canvas Text.  It was difficult and painful, but we were able to add basic support.  More about bidirectional: <a href="http://w3.org/International/articles/inline-bidi-markup/uba-basics">one</a> and <a href="http://www.unicode.org/reports/tr9/">two</a> . <br><br><h2>  Brief conclusions we made for ourselves </h2><br><ol><li>  To display HTML in picture use SVG foreignObject; </li><li>  Always analyze your product for decision making; </li><li>  Make prototypes  They can show that complex solutions can only seem so at first glance; </li><li>  Write the code immediately so that it can be covered with tests; </li><li>  In international product it is important not to forget that there are many different languages, including biderectional. </li></ol><br>  If you have experience in solving such problems - share them in the comments. </div><p>Source: <a href="https://habr.com/ru/post/458624/">https://habr.com/ru/post/458624/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../45860/index.html">Website creation in Veliky Novgorod and other provincial cities</a></li>
<li><a href="../458604/index.html">Why the two largest electronics manufacturers joined forces in a new GPU project</a></li>
<li><a href="../458606/index.html">Run OpenVPN in Docker in 2 seconds</a></li>
<li><a href="../458614/index.html">Creating a React-Hook usePosition () to get and track browser coordinates</a></li>
<li><a href="../458622/index.html">Automation for the smallest. Part One (which is after zero). Network virtualization</a></li>
<li><a href="../458626/index.html">StealthWatch: basic concepts and minimum requirements. Part 1</a></li>
<li><a href="../45863/index.html">Mini photo studio at home</a></li>
<li><a href="../458630/index.html">A small history of developing your game on pure Windows Forms + –° # in my 16 years</a></li>
<li><a href="../458634/index.html">‚ÄúDÃ∂oÃ∂nÃ∂'Ã∂t be evil‚Äù or what Facebook is hiding from us</a></li>
<li><a href="../458636/index.html">Video recordings from the DevLeads mitap from Tutu.ru office</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>