<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Working with Yandex.Webmaster API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Anyone who tracks changes in the attitude of Yandex to his site knows about such a useful Yandex service as Yandex.Webmaster , but not many people kno...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Working with Yandex.Webmaster API</h1><div class="post__text post__text-html js-mediator-article">  Anyone who tracks changes in the attitude of Yandex to his site knows about such a useful Yandex service as <a href="http://webmaster.yandex.ru/">Yandex.Webmaster</a> , but not many people know that now it is possible to automate this process through interaction with the API. <br><br>  Since  I am engaged in the development and subsequent promotion of sites, and there are quite a lot of promoted sites, I immediately seized the opportunity to automate the process of obtaining statistics from Yandex.Webmaster. <br>  First, we get all the data, even if we forgot to do it or there was no time for it, daily, hourly or even more often. <br>  Secondly, working through the API, we can create our own data viewing interface, making it more convenient for us. <br><br>  Although there is <a href="">documentation</a> on this API on Yandex, and it is even provided with examples, I personally could not figure out what to do with the run-up.  Therefore, if you are also interested in this topic, please under the cat. <br><a name="habracut"></a><br>  You need to begin your acquaintance with the Yandex.Webmaster API by <a href="http://passport.yandex.ru/">registering</a> with Yandex.  When we are already logged in, we can register our ‚ÄúApplication‚Äù.  In the future, we will need it to receive tokens of users whose sites we want to monitor.  You can register a new application <a href="http://oauth.yandex.ru/client/new">here</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A little about registration. <br><br><ul><li>  The name of the application - write what you want, but it is better that the user, if you redirect him for authorization, understood that this application is really yours, because  logging in through it, he gives access to some Yandex services. </li><li>  Description.  For the most part, it seems to me, this is a point for moderators of Yandex.  I wrote that I will use this application for my own needs in back office of various sites. </li><li>  The rights.  Since  authorization for all Yandex API services can be single, they are all listed.  For our needs for working with the Webmasters API, we need the following: ‚ÄúAdd sites to the Yandex.Webmaster service and receive information about the indexing status‚Äù and ‚ÄúObtain information about external links to the site (identification is required)‚Äù.  As it is written, identification is required for the second item.  About what it is, a little later.  If you just want to test the service, you may not yet enable this feature. </li><li>  You can skip the link to the icon and the link to the applications. </li><li>  Callback URI.  Here you need to enter the address to which Yandex will transfer the user after authorization.  It is at this address that we will receive the token.  The token, by the way, is issued for 180 days.  So often it is not necessary to receive it. <br>  Suppose that the URL from which we send the user for authorization is <a href="http://domen.ru/token/">domen.ru/token</a> , then we enter this link in this field in order to receive the token in the same place where we sent the user. </li></ul><br><br>  If you did not check the second paragraph, then your application is registered and ready to use. <br>  A list of your applications is available <a href="http://oauth.yandex.ru/client/my">here</a> . <br>  Going into the newly created, we get the "application id" and "application password" that we need. <br><br>  If you decide to immediately access the links, i.e.  noted and the second paragraph, you will need to do the following: <br>  Download <a href="http://webmaster.yandex.ru/docs/uvedomlenie.pdf">this document</a> , print it, fill it out, scan it and send it to webmaster-api@yandex-team.ru.  My application passed moderation in 4-5 days. <br><br>  Getting Started. <br><br>  I will give an example in PHP, because  everything works for me on it. <br><br><pre><code class="php hljs">$client_id = <span class="hljs-string"><span class="hljs-string">"  Id "</span></span>; $client_secret = <span class="hljs-string"><span class="hljs-string">"  "</span></span>; <span class="hljs-comment"><span class="hljs-comment">//        ,        //        state,      ,    if (!isset($_GET["code"])) { Header("Location: https://oauth.yandex.ru/authorize?response_type=code&amp;client_id=".$client_id); die(); } //    ""   ,      // $_Get["code"]      .     . //        ,     . $result=postKeys("https://oauth.yandex.ru/token", array( 'grant_type'=&gt; 'authorization_code', //   'code'=&gt; $_GET["code"], //    'client_id'=&gt;$client_id, 'client_secret'=&gt;$client_secret ), array('Content-type: application/x-www-form-urlencoded') ); //    function postKeys($url,$peremen,$headers) { $post_arr=array(); foreach ($peremen as $key=&gt;$value) { $post_arr[]=$key."=".$value; } $data=implode('&amp;',$post_arr); $handle=curl_init(); curl_setopt($handle, CURLOPT_URL, $url); curl_setopt($handle, CURLOPT_HTTPHEADER, $headers); curl_setopt($handle, CURLOPT_SSL_VERIFYPEER, false); curl_setopt($handle, CURLOPT_SSL_VERIFYHOST, false); curl_setopt($handle, CURLOPT_POST, true); curl_setopt($handle, CURLOPT_RETURNTRANSFER, true); curl_setopt($handle, CURLOPT_POSTFIELDS, $data); $response=curl_exec($handle); $code=curl_getinfo($handle, CURLINFO_HTTP_CODE); return array("code"=&gt;$code,"response"=&gt;$response); } //   ,    200,    ,      if ($result["code"]==200) { $result["response"]=json_decode($result["response"],true); $token=$result["response"]["access_token"]; echo $token; }else{ echo "- ! : ".$result["code"]; } //     ,   , ,        ,  </span></span></code> </pre> <br><br>  So, we have a token.  Now we can deal with getting information about the status of sites. <br>  I will show this in several stages, as if we did not have access to any information previously. <br><br><pre> <code class="php hljs">$token=<span class="hljs-string"><span class="hljs-string">"  "</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ,   function get_stat($url,$headers) { $handle=curl_init(); curl_setopt($handle, CURLOPT_URL, $url); curl_setopt($handle, CURLOPT_HTTPHEADER, $headers); curl_setopt($handle, CURLOPT_SSL_VERIFYPEER, false); curl_setopt($handle, CURLOPT_SSL_VERIFYHOST, false); curl_setopt($handle, CURLOPT_RETURNTRANSFER, true); $response=curl_exec($handle); $code=curl_getinfo($handle, CURLINFO_HTTP_CODE); return array("code"=&gt;$code,"response"=&gt;$response); } //   ,       $result["code"] //   -  id   . //       https://webmaster.yandex.ru/api/123456789, 123456789 - id  //      ,   id   $result=get_stat('https://webmaster.yandex.ru/api/me',array('Authorization: OAuth '.$token)); $user_id=str_replace('https://webmaster.yandex.ru/api/','',$result["response"]); //      ,          . //   : href="https://webmaster.yandex.ru/api/123456789/hosts, 123456789 - id  //     ,     $result=get_stat('https://webmaster.yandex.ru/api/'.$user_id.'/hosts',array('Authorization: OAuth '.$token)); $xml=new SimpleXMLElement($result["response"]); $hosts_xml=$xml-&gt;xpath("host"); $hosts=array(); foreach($hosts_xml as $host) { $hosts[(string)$host-&gt;name]= array( "name"=&gt;(string)$host-&gt;name, "verification_state"=&gt;(string)$host-&gt;verification-&gt;attributes()-&gt;state, "crawling_state"=&gt;(string)$host-&gt;crawling-&gt;attributes()-&gt;state, "virused"=&gt;(string)$host-&gt;virused, "last-access"=&gt;(string)$host-&gt;{'last-access'}, "tcy"=&gt;(string)$host-&gt;tcy, "url-count"=&gt;(string)$host-&gt;{'url-count'}, "index-count"=&gt;(string)$host-&gt;{'index-count'}, "href"=&gt;(string)$host-&gt;attributes()-&gt;href ); } unset($hosts_xml); unset($xml); /*                       ,     Array ( [domen] =&gt; Array ( [name] =&gt; domen -   [verification_state] =&gt; VERIFIED -       [crawling_state] =&gt; INDEXED -   [virused] =&gt; false -      [last-access] =&gt; 2012-11-06T22:54:10 -      [tcy] =&gt; 150 -  [url-count] =&gt; 7458 -    [index-count] =&gt; 6131 -     [href] =&gt; https://webmaster.yandex.ru/api/id /hosts/id  -       ) ) */ //       //    xml,    ,   ,     ,     $site_href="https://webmaster.yandex.ru/api/654321/hosts/123456"; // 654321 - user_id, 123456 - site_id $result=get_stat($site_href."/stats",array('Authorization: OAuth '.$token)); $xml=new SimpleXMLElement($result["response"]); $errors=(string)$xml-&gt;{'url-errors'}; //     $internal-links=(string)$xml-&gt;{'internal-links-count'}; //    $links=(string)$xml-&gt;{'links-count'}; //     unset($xml);</span></span></code> </pre><br><br>  Also, we can get information on indexed and excluded pages, having received URLs, but, unfortunately, the data is given only ‚Äúfor the past week‚Äù, and this can be said, lack of data. <br>  You can get this data by requests: <br><br><pre> <code class="php hljs">$result=curlGet($site_href.<span class="hljs-string"><span class="hljs-string">"/indexed"</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'Authorization: OAuth '</span></span>.$token)); <span class="hljs-comment"><span class="hljs-comment">/*  : &lt;host&gt; &lt;index-count&gt;238&lt;/index-count&gt; &lt;last-week-index-urls&gt; &lt;url&gt;http://example.com/page1.html&lt;/url&gt; &lt;url&gt;http://example.com/page2.html&lt;/url&gt; &lt;/last-week-index-urls&gt; &lt;/host&gt; */</span></span> $result=curlGet($site_href.<span class="hljs-string"><span class="hljs-string">"/excluded"</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'Authorization: OAuth '</span></span>.$token)); <span class="hljs-comment"><span class="hljs-comment">/*  : &lt;host&gt; &lt;url-errors count="12"&gt; &lt;url-errors-with-code code=‚Äù404‚Äù&gt; &lt;count&gt;12&lt;/count&gt; &lt;severity&gt;ERROR&lt;/severity&gt; &lt;/url-errors-with-code&gt; &lt;/url-errors&gt; &lt;/host&gt;*/</span></span></code> </pre><br>  Status and decoding errors <a href="">look here</a> . <br><br>  You can also receive data on external links to the site, but they are also available as much as possible during the ‚Äúone week‚Äù period. <br><br><pre> <code class="php hljs">$result=curlGet($site_href.<span class="hljs-string"><span class="hljs-string">"/links"</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'Authorization: OAuth '</span></span>.$token)); <span class="hljs-comment"><span class="hljs-comment">/*  : &lt;host&gt; &lt;links-count&gt;1436&lt;/links-count&gt; &lt;last-week-links&gt; &lt;url&gt;http://example1.com/page1.html&lt;/url&gt; &lt;url&gt;http://example2.com/page2.html&lt;/url&gt; &lt;/last-week-links&gt; &lt;/host&gt;*/</span></span></code> </pre><br><br>  Another Yandex gives data "about popular requests", but practice shows that there is a divergence of positions very often with the actual position, and the data is outdated.  So I did not even bother about this. <br><br>  The most important thing I do is collect once every 12 hours statistics on all my sites.  All data is stored in the database, and therefore I have the opportunity not only to see the current state of affairs, but also to analyze the changes. <br><br>  And yet, in order not to receive all the data on the site every time, it is better to keep references to them in the database.  I mean $ site_url.  If suddenly something changes in the API, you can always update these links. <br><br>  I hope that this information was interesting and useful for you! <br>  Automate your work.  The less we are busy with red tape, the more time we have to work.  And our loved ones! </div><p>Source: <a href="https://habr.com/ru/post/157753/">https://habr.com/ru/post/157753/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../157739/index.html">"Poster": The History of the Russian Internet</a></li>
<li><a href="../157743/index.html">Prefix to the router (USB HUB + USB HDD + UPS)</a></li>
<li><a href="../157745/index.html">Updated Maps of Mars by Google</a></li>
<li><a href="../157747/index.html">Friday post good or how Samsung builds an online school of solar energy</a></li>
<li><a href="../157749/index.html">Competition Ivideon. Continuation</a></li>
<li><a href="../157755/index.html">All videos and presentations from the Autumn Forum Technologies Mail.Ru Group 2012</a></li>
<li><a href="../157757/index.html">Xyologic: Google in the world of mobile applications</a></li>
<li><a href="../157759/index.html">World Windows 8 Hackathon - WOWZAPP - walks around the country!</a></li>
<li><a href="../157761/index.html">My TOP-10 features in SSIS 2012</a></li>
<li><a href="../157763/index.html">IEC60027-2: Let's use standards, or 1024 B == 1 KiB && 1024 B! = 1 KB && 1000 B == 1 kB</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>