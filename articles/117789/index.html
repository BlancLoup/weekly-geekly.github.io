<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Comparing images and generating picture differences in ruby</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Surely you've seen the new image viewing modes that Github rolled out last month. This is a really neat way to show the difference between two version...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Comparing images and generating picture differences in ruby</h1><div class="post__text post__text-html js-mediator-article">  Surely you've seen the new <a href="https://github.com/blog/817-behold-image-view-modes">image viewing modes</a> that Github rolled out last month.  This is a really neat way to show the difference between two versions of a picture.  In this article I will try to explain how you can easily compare images using only Ruby and <a href="https://github.com/wvanbergen/chunky_png">ChunkyPNG</a> . <br><a name="habracut"></a><br>  In the simplest version, the search for differences comes down to traversing each pixel in the first picture and checking if this pixel is in the second one.  The implementation might look something like this: <br><br><pre><code class="hljs ruby"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'chunky_png'</span></span> images = [ ChunkyPNG::Image.from_file(<span class="hljs-string"><span class="hljs-string">'1.png'</span></span>), ChunkyPNG::Image.from_file(<span class="hljs-string"><span class="hljs-string">'2.png'</span></span>) ] diff = [] images.first.height.times <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|y|</span></span> images.first.row(y).each_with_index <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|pixel, x|</span></span> diff &lt;&lt; [x,y] <span class="hljs-keyword"><span class="hljs-keyword">unless</span></span> pixel == images.last[x,y] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> puts <span class="hljs-string"><span class="hljs-string">"pixels (total): </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{images.first.pixels.length}</span></span></span><span class="hljs-string">"</span></span> puts <span class="hljs-string"><span class="hljs-string">"pixels changed: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{diff.length}</span></span></span><span class="hljs-string">"</span></span> puts <span class="hljs-string"><span class="hljs-string">"pixels changed (%): </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{(diff.length.to_f / images.first.pixels.length) * </span></span><span class="hljs-number"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-number">100</span></span></span></span><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="hljs-string">%"</span></span> x, y = diff.map{ <span class="hljs-params"><span class="hljs-params">|xy|</span></span> xy[<span class="hljs-number"><span class="hljs-number">0</span></span>] }, diff.map{ <span class="hljs-params"><span class="hljs-params">|xy|</span></span> xy[<span class="hljs-number"><span class="hljs-number">1</span></span>] } images.last.rect(x.min, y.min, x.max, y.max, ChunkyPNG::Color.rgb(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>)) images.last.save(<span class="hljs-string"><span class="hljs-string">'diff.png'</span></span>)</code> </pre>  <font color="gray">Code: <a href="https://gist.github.com/923894">Gist</a> .</font> <br><br>  After loading two images, we go around each pixel in the first one, and if it is present in the second, we add it to the <code>diff</code> array.  After that, draw a frame around the area in which there are differences: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="http://1450821577221135859437"><img src="http://1450821577919080491641"><img src="http://habrastorage.org/storage/d1000f22/73a8ffe1/23d86570/2dc919c0.png"><br><br>  Works!  In the final image there is a frame around the hat, which we added to the photo and as a result we see that almost 9% of the pixels in the photo have changed their meaning. <br><br> <code>pixels (total): 16900 <br> pixels changed: 1502 <br> pixels changed (%): 8.887573964497042%</code> <br> <br>  The problem with this approach is that it only <i>identifies</i> changes without <i>measuring</i> them.  There is no difference, the pixel has become only a bit darker, or it has a completely different color.  If we apply this code to a slightly darkened version of the photo, the result will look like this: <br><br><img src="http://1450821577919080491641"><img src="http://1450821577617166488471"><img src="http://habrastorage.org/storage/2ed8c226/7b9d51bf/ffb131a0/00cf9397.png"><br><br> <code>pixels (total): 16900 <br> pixels changed: 16900 <br> pixels changed (%): 100.0%</code> <br> <br>  It turns out that the two photos are completely different, although by eye they are almost the same.  To get a more accurate result, we need to measure the difference between the pixel values. <br><br><h1>  <font color="black">Calculating color difference</font> </h1>  To calculate the differences in color, we will use the <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25BE%25D1%2580%25D0%25BC%25D1%2583%25D0%25BB%25D0%25B0_%25D1%2586%25D0%25B2%25D0%25B5%25D1%2582%25D0%25BE%25D0%25B2%25D0%25BE%25D0%25B3%25D0%25BE_%25D0%25BE%25D1%2582%25D0%25BB%25D0%25B8%25D1%2587%25D0%25B8%25D1%258F">ŒîE *</a> (‚ÄúDelta E‚Äù) metric.  There are three different formulas for this metric, but we will take the first one ( <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25BE%25D1%2580%25D0%25BC%25D1%2583%25D0%25BB%25D0%25B0_%25D1%2586%25D0%25B2%25D0%25B5%25D1%2582%25D0%25BE%25D0%25B2%25D0%25BE%25D0%25B3%25D0%25BE_%25D0%25BE%25D1%2582%25D0%25BB%25D0%25B8%25D1%2587%25D0%25B8%25D1%258F">CIE76</a> ), because it is the simplest, and we don‚Äôt need something abstruse.  The metric ŒîE * was created for the <a href="http://ru.wikipedia.org/wiki/LAB">color space LAB</a> , which corresponds most closely to human vision.  In this example, we will not convert colors to LAB, but simply work in the RGB color space (note that this means that our results will not be as accurate).  If you are interested in how different color spaces differ, see <a href="http://stevehanov.ca/blog/index.php%3Fid%3D116">this demo</a> . <br><br>  As before, we go through all the pixels in the images.  If they are different, then we apply the ŒîE * metric and store the result in the <code>diff</code> array.  We also apply this result to calculate the gray value that will be used in the final comparative image. <br><br><pre> <code class="hljs ruby"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'chunky_png'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> ChunkyPNG::Color images = [ ChunkyPNG::Image.from_file(<span class="hljs-string"><span class="hljs-string">'1.png'</span></span>), ChunkyPNG::Image.from_file(<span class="hljs-string"><span class="hljs-string">'2.png'</span></span>) ] output = ChunkyPNG::Image.new(images.first.width, images.last.width, WHITE) diff = [] images.first.height.times <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|y|</span></span> images.first.row(y).each_with_index <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|pixel, x|</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unless</span></span> pixel == images.last[x,y] score = Math.sqrt( (r(images.last[x,y]) - r(pixel)) ** <span class="hljs-number"><span class="hljs-number">2</span></span> + (g(images.last[x,y]) - g(pixel)) ** <span class="hljs-number"><span class="hljs-number">2</span></span> + (b(images.last[x,y]) - b(pixel)) ** <span class="hljs-number"><span class="hljs-number">2</span></span> ) / Math.sqrt(MAX ** <span class="hljs-number"><span class="hljs-number">2</span></span> * <span class="hljs-number"><span class="hljs-number">3</span></span>) output[x,y] = grayscale(MAX - (score * MAX).round) diff &lt;&lt; score <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> puts <span class="hljs-string"><span class="hljs-string">"pixels (total): </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{images.first.pixels.length}</span></span></span><span class="hljs-string">"</span></span> puts <span class="hljs-string"><span class="hljs-string">"pixels changed: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{diff.length}</span></span></span><span class="hljs-string">"</span></span> puts <span class="hljs-string"><span class="hljs-string">"image changed (%): </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{(diff.inject {</span></span><span class="hljs-params"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-params">|sum, value|</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> sum + value}</span></span></span><span class="hljs-string"> / images.first.pixels.length) * 100}%"</span></span> output.save(<span class="hljs-string"><span class="hljs-string">'diff.png'</span></span>)</code> </pre>  <font color="gray">Code: <a href="https://gist.github.com/925244">Gist</a> .</font> <br><br>  Now we have a more accurate picture of the differences.  If you look at the result, you will see that less than 3% of the photo has changed. <br><br> <code>pixels (total): 16900 <br> pixels changed: 1502 <br> image changed (%): 2.882157784948056%</code> <br> <br>  Again, we save the result - and this time it already shows differences in shades of gray.  Stronger changes are darker in color. <br><br><img src="http://1450821577221135859437"><img src="http://1450821577919080491641"><img src="http://habrastorage.org/storage/383f3b1a/2bf8f100/b0fb9ff3/96bb2acf.png"><br><br>  And now let's try those two images in which the second was slightly darker. <br><br> <code>pixels (total): 16900 <br> pixels changed: 16900 <br> image changed (%): 5.4418255392228945%</code> <br> <br><img src="http://1450821577919080491641"><img src="http://1450821577617166488471"><img src="http://habrastorage.org/storage/8944cc3c/ec38c119/46e5179e/1d477f67.png"><br><br>  Fine.  Now our program knows that the photos are only slightly different, and not completely different.  If you look closely, you can even see the specific areas where the image is different. <br><br><h1>  <font color="black">What does Github do?</font> </h1>  Github uses <a href="http://en.wikipedia.org/wiki/Blend_modes">the tone difference mode</a> , which is familiar from photo editors such as Photoshop.  This is a fairly simple method.  We go around each pixel in two images and calculate their difference over the RGB channels: <br><br><pre> <code class="hljs ruby"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'chunky_png'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> ChunkyPNG::Color images = [ ChunkyPNG::Image.from_file(<span class="hljs-string"><span class="hljs-string">'1.png'</span></span>), ChunkyPNG::Image.from_file(<span class="hljs-string"><span class="hljs-string">'2.png'</span></span>) ] images.first.height.times <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|y|</span></span> images.first.row(y).each_with_index <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|pixel, x|</span></span> images.last[x,y] = rgb( r(pixel) + r(images.last[x,y]) - <span class="hljs-number"><span class="hljs-number">2</span></span> * [r(pixel), r(images.last[x,y])].min, g(pixel) + g(images.last[x,y]) - <span class="hljs-number"><span class="hljs-number">2</span></span> * [g(pixel), g(images.last[x,y])].min, b(pixel) + b(images.last[x,y]) - <span class="hljs-number"><span class="hljs-number">2</span></span> * [b(pixel), b(images.last[x,y])].min ) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> images.last.save(<span class="hljs-string"><span class="hljs-string">'diff.png'</span></span>)</code> </pre>  <font color="gray">Code: <a href="https://gist.github.com/924996">Gist</a> .</font> <br><br>  Using this method, the comparison of two photos on the left gives a picture of the differences in the image on the right, clearly showing the changes: <br><br><img src="http://1450821577221135859437"><img src="http://1450821577919080491641"><img src="http://habrastorage.org/storage/3594c873/8480adad/66420074/3d6d7d71.png"><br><br>  Since colors are compared by channels (R, G, and B) instead of one color, three values ‚Äã‚Äãare returned.  This means that the resulting picture is color, but such a comparison for each channel separately may adversely affect the accuracy of the result. </div><p>Source: <a href="https://habr.com/ru/post/117789/">https://habr.com/ru/post/117789/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../117781/index.html">Kebrum VPN client ported to Nokia N900</a></li>
<li><a href="../117784/index.html">OpenStreetMap News ‚Ññ4</a></li>
<li><a href="../117785/index.html">The end of the work - left Portal 2</a></li>
<li><a href="../117786/index.html">Gmail will tell the recipient of the letter</a></li>
<li><a href="../117788/index.html">Mail game for office workers</a></li>
<li><a href="../117790/index.html">Seagate buys Samsung hard drive division</a></li>
<li><a href="../117791/index.html">Is it MVC?</a></li>
<li><a href="../117792/index.html">New YouTube videos are now saved in WebM format.</a></li>
<li><a href="../117794/index.html">Freelance VS Office - duel! (Video report)</a></li>
<li><a href="../117797/index.html">Transfer data from one database to any other</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>