<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automatic generation of Dial Patterns for Asterisk from DEF codes of cellular operators</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the office we use GSM gateways for outgoing calls to cellular. But there was a task to limit the range of numbers in outboud routes asterisk, so th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automatic generation of Dial Patterns for Asterisk from DEF codes of cellular operators</h1><div class="post__text post__text-html js-mediator-article">  In the office we use GSM gateways for outgoing calls to cellular.  But there was a task to limit the range of numbers in outboud routes asterisk, so that users do not call anywhere.  Namely, to allow outgoing communication only to the cellular of their region. <br><br>  Then you can read how to automate the Dial Up update of outgoing calls to Asterisk using a publicly available list of DEF codes of cellular operators. <br><a name="habracut"></a><br>  Automation has been the <i>Asterisk</i> server <i>1.8.6.0</i> , running on the distribution <i>FreePBX 2.10.1.1</i> . <br><br>  So, for starters, we needed to get somewhere a list of DEF codes of cellular operators that could be analyzed. <br>  It turned out that the Rossvyaz website possesses such information, and periodically updates it. <br>  Thus, using <a href="http://www.rossvyaz.ru/docs/num/DEF-9x.html">this link</a> you can get the latest updated list of DEF codes of cellular operators in html format. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since I would like to push the Dial Patterns update into the crontab, it was decided to parse this html file on bash. <br>  Well, since bash does not say that it is convenient for word processing, the main translation function in Dial Patterns is written in awk. <br><br>  So, after loading the processing of html with all sorts of grep and sed commands, we got a csv file, with a separator;, like: <br><pre><code class="hljs">913;0000000;0199999;200000; ;  913;0600000;0699999;100000; ;  913;2000000;2099999;100000; ;  913;3700000;3999999;300000; ; </code> </pre> <br>  <i>First column:</i> DEF code <br>  <i>The second and third columns: the</i> range of numbers allocated (from and to) <br>  <i>Fourth column:</i> total number of allocated numbers <br>  <i>Fifth column:</i> Operator <br>  <i>Sixth column:</i> Region <br><br>  This kind of view after that was required to be converted into <a href="http://www.voip-info.org/wiki/view/Asterisk%2BDialplan%2BPatterns">Dial Patterns format</a> , which in general was the main task, which was done using the awk language.  At the exit of the script was a list: <br><pre> <code class="hljs css">901458<span class="hljs-selector-tag"><span class="hljs-selector-tag">XXXX</span></span> 901459<span class="hljs-selector-tag"><span class="hljs-selector-tag">XXXX</span></span> 903049<span class="hljs-selector-tag"><span class="hljs-selector-tag">XXXX</span></span> 903076<span class="hljs-selector-tag"><span class="hljs-selector-tag">XXXX</span></span> 90390<span class="hljs-selector-attr"><span class="hljs-selector-attr">[0-6]</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">XXXX</span></span> 90393<span class="hljs-selector-tag"><span class="hljs-selector-tag">XXXXX</span></span> 90399<span class="hljs-selector-attr"><span class="hljs-selector-attr">[7-9]</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">XXXX</span></span> 90509<span class="hljs-selector-attr"><span class="hljs-selector-attr">[4-5]</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">XXXX</span></span></code> </pre> <br>  Well, in order not to press anything at all, after the formation of Dial Patterns, they are loaded into the FreePBX database, and the application of the configuration in FreePBX is initiated through curl.  ( <i>!!! Warning !!</i> you need to know the id of the route to which the templates will be applied, well, the data itself is written to the database tables individually. Therefore, pay attention to what exactly you need) <br><br>  This is actually the script itself, which performs all the data manipulations, which can then be written to the scheduler on the server: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # DEF- DOWNFILE='http://www.rossvyaz.ru/docs/num/DEF-9x.html'; #  TMPDIR='./'; #,   csv   FILENAME='codes'; #    REGION=' '; #id outbound route  FreePBX mysql  ROUTE_ID=4 FREEPBX_LOGIN='admin' FREEPBX_PASS='pass' FREEPBX_ADRESS='192.168.1.15' #     csv wget -c -q -O - $DOWNFILE | grep "^&lt;tr&gt;" | sed -e 's/&lt;\/td&gt;//g' -e 's/&lt;tr&gt;//g' -e 's/&lt;\/tr&gt;//g' -e 's/[\t]//g' -e 's/^&lt;td&gt;//g' -e 's/&lt;td&gt;/;/g' | iconv -c -f WINDOWS-1251 -t UTF8 | grep "$REGION" &gt; $TMPDIR/$FILENAME #     check=`cat $TMPDIR/$FILENAME` if [ "$check" == "" ]; then exit 0 fi #  awk  Dial Patterns awk_code=' #   function ret_diap(from,to) { if ((to-from)==0) return from; else if ((to-from)==9) return "X"; else return "["from"-"to"]"; } #  { DEF=$1; razm=1; delete out_str; for (i=1; i &lt;= length($3);i++) { if ((substr($3,i,1)-substr($2,i,1))==0) { for (r=1; r &lt;= razm;r++) { out_str[r]=out_str[r] substr($3,i,1); } } else { if ((substr($3,i,1)-substr($2,i,1))==9) { for (r=1; r &lt;= razm;r++) { out_str[r]=out_str[r]"X"; } } else { if (substr($3,i,1)-substr($2,i,1)&gt;=1 &amp;&amp; substr($3,(i+1),1)-substr($2,(i+1),1)!=9) { count=1; init_str=out_str[1]; for (j=substr($2,(i),1); j &lt; substr($3,(i),1);j++) { if (count==1) { out_str[count]=init_str j ret_diap(substr($2,(i+1),1),9); } else { out_str[count]=init_str ret_diap(j,(substr($3,(i),1)-1)) "X"; j=(substr($3,(i),1)-1); } count++; if (razm&lt;count) razm=count; } out_str[count]=init_str j ret_diap(0,substr($3,(i+1),1)); i++; } else { for (r=1; r &lt;= razm;r++) { out_str[r]=out_str[r]"["substr($2,i,1)"-"substr($3,i,1)"]"; } } } } } for (r in out_str) { print 8DEF out_str[r]; } }' #  awk,   - Dial Patterns cat codes | awk -F ';' "$awk_code" &gt; patterns #   sql="DELETE FROM outbound_route_patterns WHERE route_id=$ROUTE_ID" echo $sql mysql -Dasterisk -e "$sql" #   sql="INSERT INTO outbound_route_patterns (route_id,match_pattern_pass,match_pattern_prefix) VALUES " n=1 for i in `cat patterns_mts` do if [ $n -eq 1 ]; then sql="$sql ($ROUTE_ID,'$i','')" else sql="$sql, ($ROUTE_ID,'$i','')" fi let n=n+1 done echo $sql mysql -Dasterisk -e "$sql" #  freepbx curl -c cookies -d 'username=$FREEPBX_LOGIN&amp;password=$FREEPBX_PASS&amp;submit=Login' http://$FREEPBX_ADRESS/admin/config.php &gt; /dev/null #  curl -b cookies http://FREEPBX_ADRESS/admin/config.php?handler=reload &gt; /dev/null</span></span></code> </pre><br>  <i>PS: script and function does not claim to be ideal and universal.</i>  <i>But if you wish, you can remake to fit your needs very easily.</i> </div><p>Source: <a href="https://habr.com/ru/post/151401/">https://habr.com/ru/post/151401/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../151392/index.html">Ninja IDE - an open development environment for Python</a></li>
<li><a href="../151394/index.html">Comparing and contrasting Windows Azure Table Storage and Windows Azure SQL Database</a></li>
<li><a href="../151395/index.html">Robotic tentacle with multiple degrees of freedom</a></li>
<li><a href="../151397/index.html">VKontakte revealed its statistics</a></li>
<li><a href="../151398/index.html">Intel Parallel Studio XE 2013: optimizing performance in new ways</a></li>
<li><a href="../151402/index.html">How to be a programmer in this cruel world</a></li>
<li><a href="../151403/index.html">Using XML to generate a menu bar in Swing</a></li>
<li><a href="../151405/index.html">Web-based repository</a></li>
<li><a href="../151406/index.html">Decorate the mysql-client output in the console</a></li>
<li><a href="../151407/index.html">Batch processing and downloading images of goods in the online store</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>