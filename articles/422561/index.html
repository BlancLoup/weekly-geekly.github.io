<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How Yandex used computer vision to improve the quality of video broadcasts. DeepHD technology</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When people search a picture or video on the Internet, they often add the phrase ‚Äúin good quality‚Äù to a request. Quality usually refers to resolution ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How Yandex used computer vision to improve the quality of video broadcasts. DeepHD technology</h1><div class="post__text post__text-html js-mediator-article">  When people search a picture or video on the Internet, they often add the phrase ‚Äúin good quality‚Äù to a request.  Quality usually refers to resolution ‚Äî users want the image to be large and look good on a modern computer, smartphone, or TV screen.  But what if the source in good quality simply does not exist? <br><br>  Today we will tell Habr readers how we can improve video resolution in real time using neural networks.  You will also learn how the theoretical approach to solving this problem differs from the practical one.  If you are not interested in technical details, then you can safely browse the post - in the end you are waiting for examples of our work. <br><br><img width="800" src="https://habrastorage.org/webt/hx/lu/ak/hxluakxdy2mxmmskebqieei5zq4.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      On the Internet a lot of video content in low quality and resolution.  These may be films made decades ago, or broadcast TV channels, which for various reasons are not conducted in the best quality.  When users stretch the video to full screen, the image becomes muddy and fuzzy.  The ideal solution for old films would be to find the original film, scan it on modern equipment and restore it manually, but this is not always possible.  With broadcasts it is still more difficult - they need to be processed live.  In this regard, the most acceptable way for us to work is to increase the resolution and clean up artifacts using computer vision technologies. <br><br><a name="habracut"></a>  In the industry, the task of increasing pictures and videos without losing quality is called the term super-resolution.  Many articles have already been written on this topic, but the realities of ‚Äúcombat‚Äù use have proved much more complicated and interesting.  Briefly about the main problems that we had to solve in our own DeepHD technology: <br><br><ul><li>  You need to be able to restore parts that were not on the original video due to its low resolution and quality, to ‚Äúfinish‚Äù them. </li><li>  Solutions from the field of super-resolution restore the details, but they make clear and detailed not only the objects in the video, but also compression artifacts, which cause the hostility of the audience. </li><li>  There is a problem with the collection of the training sample - a large number of pairs are required, in which the same video is present in both low resolution and quality and high.  In reality, there is usually no quality pair for bad content. </li><li>  The solution should work in real time. </li></ul><br><h3>  Technology selection </h3><br>  In recent years, the use of neural networks has led to significant success in solving virtually all computer vision tasks, and the task of super-resolution is no exception.  The most promising solutions seemed to us based on GAN (Generative Adversarial Networks, generative rival networks).  They allow you to get photorealistic images of high definition, complementing them with missing details, such as drawing hair and eyelashes on images of people. <br><br><img src="https://habrastorage.org/webt/gq/hl/kz/gqhlkzdwwmq3ad9p78j7wapfhzs.png"><br><br>  In the simplest case, the neural network consists of two parts.  The first part - the generator - takes the image as input and returns it enlarged twice.  The second part - the discriminator - receives the image generated and ‚Äúreal‚Äù as input, and tries to distinguish it from each other. <br><br><img width="700" src="https://habrastorage.org/webt/kn/3s/sc/kn3sscgtqtwqzcnga59cwaor-8y.png"><br><br><h3>  Training set training </h3><br>  For training, we collected a few dozen videos in UltraHD-quality.  First, we reduced them to 1080p resolution, thereby obtaining reference examples.  Then we reduced these videos by another half, squeezing in parallel with a different bit rate to get something like a real video in low quality.  We split the resulting rollers into frames and in this form used for training the neural network. <br><br><h3>  Deblocking </h3><br>  Of course, we wanted to get an end-to-end solution: to train the neural network to generate high-resolution and high-quality video from the original at once.  However, the GANs turned out to be very capricious and constantly tried to refine compression artifacts, rather than eliminate them.  Therefore it was necessary to break the process into several stages.  The first is the suppression of video compression artifacts, also known as deblocking. <br><br>  An example of how one of the deblocking methods works: <br><br><img src="https://habrastorage.org/webt/0c/sg/zx/0csgzx4zwbtceyujcgcay4mclac.jpeg"><br><br>  At this stage, we minimized the standard deviation between the generated frame and the source frame.  Thus, although we increased the image resolution, we did not receive a real increase in resolution due to regression to the average: the neural network, not knowing in which particular pixels this or that border in the image passes, was forced to average several options, getting a blurred result.  The main thing that we have achieved at this stage is the elimination of video compression artifacts, so the next stage of the generative network only needed to increase clarity and add the missing small details and textures.  After hundreds of experiments, we selected an optimal architecture for performance and quality, vaguely reminiscent of the <a href="https://arxiv.org/abs/1511.04491">DRCN</a> architecture: <br><br><img width="800" src="https://habrastorage.org/webt/oq/au/pc/oqaupcp8k9m4rdspvx8rrrbhpy0.png"><br><br>  The basic idea of ‚Äã‚Äãsuch an architecture is the desire to obtain the deepest possible architecture, while not having problems with convergence during its training.  On the one hand, each next convolutional layer extracts more and more complex features of the input image, which allows determining that the object is at a given point of the image and reconstructing complex and badly damaged parts.  On the other hand, the distance in the graph of the neural network from any of its layers to the output remains small, thereby improving the convergence of the neural network and making it possible to use a large number of layers. <br><br><h3>  Generative network training </h3><br>  We took the <a href="https://arxiv.org/abs/1609.04802">SRGAN</a> architecture <a href="https://arxiv.org/abs/1609.04802">as the</a> basis for a neural network to increase resolution.  Before you train a competitive network, you need to train a generator ‚Äî train it in the same way as during the deblocking stage.  Otherwise, at the beginning of training, the generator will return only noise, the discriminator will immediately begin to ‚Äúwin‚Äù - it will be easy to learn to distinguish noise from real personnel, and no training will succeed. <br><br><img width="800" src="https://habrastorage.org/webt/tx/pb/r-/txpbr-pwdisdcwj62mrd6h4wuxm.png"><br><br>  Next, we teach GAN, but there are some nuances here too.  It is important for us that the generator created not only photo-realistic frames, but also kept the information available on them.  To do this, we add the content loss function (content loss) to the classic GAN architecture.  It consists of several layers of a VGG19 neural network trained in standard ImageNet dataset.  These layers convert an image into a feature map, which contains information about the content of the image.  The loss function minimizes the distance between such maps obtained from the generated and source frames.  Also, the presence of such a loss function makes it possible not to spoil the generator in the first steps of training, when the discriminator is not yet trained and provides useless information. <br><br><img width="800" src="https://habrastorage.org/webt/d7/5p/uu/d75puuaa6jqsy6wmvknjqo-hh84.png"><br><br><h3>  Acceleration of the neural network </h3><br>  Everything went well, and after a chain of experiments, we got a good model that could already be applied to old films.  However, it was still too slow to handle streaming video.  It turned out that simply reducing the generator without a significant loss of quality of the final model is impossible.  Then the knowledge distillation approach came to the rescue.  This method provides for the training of a lighter model so that it repeats the results of a heavier one.  We took a lot of real videos in low quality, processed them with the generative neural network obtained in the previous step and trained an easier network to get the same result from the same frames.  Due to this reception, we received a network that is not very much inferior in quality to the original one, but faster than it by a dozen times: one NVIDIA Tesla V100 card is required to process one TV channel at 576p resolution. <br><br><img width="800" src="https://habrastorage.org/webt/15/b3/eg/15b3eguc_ikkl-fdaclwdsga2ka.png"><br><br><h3>  Evaluation of the quality of decisions </h3><br>  Perhaps the most difficult moment when working with generative networks is an assessment of the quality of the models obtained.  There is no clear function of the error, as, for example, in solving the problem of classification.  Instead, we know only the accuracy of the discriminator, which does not reflect the quality of the generator we are interested in (a reader well familiar with this sphere could suggest using <a href="https://arxiv.org/pdf/1701.07875.pdf">the Wasserstein metric</a> , but, unfortunately, it gave us a noticeably worse result). <br><br>  People helped us solve this problem.  We showed the users of the <a href="https://habr.com/company/yandex/blog/305956/">Yandex.Toloka</a> service a pair of images, one of which was the original, and the other - the processed neural network, or both were processed by different versions of our solutions.  For a fee, users chose a better video from a pair, so we obtained a statistically significant version comparison, even with changes that were difficult for the eye to see.  Our final models triumph in more than 70% of cases, which is quite a lot, considering that users spend only a few seconds on assessing a couple of videos. <br><br>  An interesting result was also the fact that the video resolution of 576p, enhanced by DeepHD technology to 720p, wins the same original video with a resolution of 720p in 60% of cases - i.e.  Processing not only increases the resolution of the video, but also improves its visual perception. <br><br><h3>  Examples </h3><br>  In the spring, we tested DeepHD technology on several old films that can be viewed at Kinopoisk: ‚Äú <a href="https://www.kinopoisk.ru/film/42037/">Rainbow</a> ‚Äù by Mark Donskoy (1943), ‚Äú <a href="https://www.kinopoisk.ru/film/letyat-zhuravli-1957-7724/">The Cranes Are Flying</a> ‚Äù by Mikhail Kalatozov (1957), ‚Äú <a href="https://www.kinopoisk.ru/film/44291/">My Dear Man</a> ‚Äù by Joseph Kheyfits (1958), ‚Äú <a href="https://www.kinopoisk.ru/film/44027/">Man</a> 's <a href="https://www.kinopoisk.ru/film/44027/">Fate</a> ‚Äù Sergey Bondarchuk (1959), ‚Äú <a href="https://www.kinopoisk.ru/film/42667/">Ivanovo Childhood</a> ‚Äù by Andrei Tarkovsky (1962), ‚Äú <a href="https://www.kinopoisk.ru/film/otets-soldata-1964-44218/">Father of a Soldier</a> ‚Äù Rezo Chkheidze (1964) and ‚Äú <a href="https://www.kinopoisk.ru/film/46609/">Tango of Our Childhood</a> ‚Äù by Albert Mkrtchyan (1985). <br><br><img width="800" src="https://habrastorage.org/webt/zh/un/-d/zhun-dugkeykn9bmodmrgrjfxma.png"><br><br>  The difference between the versions before and after the treatment is especially noticeable if one looks at the details: study the mimicry of the heroes on close-ups, consider the texture of clothes or fabric design.  It was possible to compensate for some of the disadvantages of digitization: for example, remove overexposure on faces or make more visible objects placed in the shade. <br><br>  Later, the DeepHD technology was used to improve the quality of broadcasts of <a href="https://yandex.ru/oceantv">some</a> channels in the Yandex.Efir service.  Recognizing such content is easy by the <b>dHD</b> tag. <br><br>  Now <a href="https://yandex.ru/search/%3Ftext%3D%25D0%25BC%25D1%2583%25D0%25BB%25D1%258C%25D1%2582%25D1%2584%25D0%25B8%25D0%25BB%25D1%258C%25D0%25BC%25D1%258B%2520%25D0%25B2%2520deep%2520hd%26lr%3D125920">on Yandex,</a> in improved quality, you can watch ‚ÄúThe Snow Queen‚Äù, ‚ÄúThe Bremen Musicians‚Äù, ‚ÄúGolden Antelope‚Äù and other popular cartoons of the Soyuzmultfilm studio.  Several examples in dynamics can be seen in the video: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/ainlhiNn0Yk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  For viewers demanding image quality, the difference will be especially noticeable: the image has become sharper, tree leaves, snowflakes, stars in the night sky above the jungle and other small details are better seen. <br><br>  Further more. <br><br><h3>  useful links </h3><br>  Jiwon Kim, Jung Kwon Lee, Kyoung Mu Lee Deeply-Recursive Convolutional Network for Image Super-Resolution [ <a href="https://arxiv.org/abs/1511.04491">arXiv: 1511.04491</a> ]. <br><br>  Christian Ledig et al.  Photo-Realistic Super Image Resolution Using A Generative Adversarial Network [ <a href="https://arxiv.org/abs/1609.04802">arXiv: 1609.04802</a> ]. <br><br>  Mehdi SM Sajjadi, Bernhard Sch√∂lkopf, Michael Hirsch EnhanceNet: Single Image Super-Resolution Through Automated Texture Synthesis [ <a href="https://arxiv.org/abs/1612.07919">arXiv: 1612.07919</a> ]. </div><p>Source: <a href="https://habr.com/ru/post/422561/">https://habr.com/ru/post/422561/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../422547/index.html">To eliminate Specter and Meltdown, you may have to create a completely new type of processor.</a></li>
<li><a href="../422549/index.html">Corda: Kotlin</a></li>
<li><a href="../422551/index.html">How to steal money from a contactless card and Apple Pay</a></li>
<li><a href="../422553/index.html">Official browser extension Mega stole data and cryptocurrency of file sharing users</a></li>
<li><a href="../422555/index.html">Multi-modality in Android in terms of architecture. From A to Z</a></li>
<li><a href="../422565/index.html">Friday's Skillbox webinars: everything for programmers and designers</a></li>
<li><a href="../422569/index.html">Hourly, time tracking app</a></li>
<li><a href="../422571/index.html">Parallelization of tasks with dependencies - example on .NET</a></li>
<li><a href="../422573/index.html">Reverse engineering rendering "The Witcher 3"</a></li>
<li><a href="../422575/index.html">Rare intercom</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>