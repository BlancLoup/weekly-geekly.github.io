<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We create our own framework based on symfony2. (Part 5)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the fifth part of the series we will talk about controllers. 


- Part 1 
- Part 2 
- Part 3 
- Part 4 
- Part 5 
- Part 6 


 The attentive reader...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We create our own framework based on symfony2. (Part 5)</h1><div class="post__text post__text-html js-mediator-article">  In the fifth part of the series we will talk about controllers. <br><ul><li>  <a href="http://habrahabr.ru/blogs/symfony/136110/">Part 1</a> </li><li>  <a href="http://habrahabr.ru/blogs/symfony/136430/">Part 2</a> </li><li>  <a href="http://habrahabr.ru/blogs/symfony/136471/">Part 3</a> </li><li>  <a href="http://habrahabr.ru/blogs/symfony/136656/">Part 4</a> </li><li>  <b>Part 5</b> </li><li>  <a href="http://habrahabr.ru/blogs/symfony/138893/">Part 6</a> </li></ul><br><a name="habracut"></a><br><br>  The attentive reader noticed that in our framework the way that the code of templates is executed is rigidly registered.  For simple pages, like the ones we created earlier, this is not a problem.  But if you plan to add more logic, you will have to embed it in the template itself. <br><br>  Which, naturally, is not a good idea, especially if you wanted to divide the system into separate functional structures. <br>  Let's separate the template code from the logic by adding a new layer - the controller: ‚ÄúThe task of the controller is to create a Response based on the information sent by the Client Request.‚Äù <br>  Modify the rendering part of the template as follows: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// example.com/web/front.php // ... try { $request-&gt;attributes-&gt;add($matcher-&gt;match($request-&gt;getPathInfo())); $response = call_user_func('render_template', $request); } catch (Routing\Exception\ResourceNotFoundException $e) { $response = new Response('Not Found', 404); } catch (Exception $e) { $response = new Response('An error occurred', 500); }</span></span></code> </pre> <br><br>  Since the rendering is now done by the external function <b>render_template ()</b> , we must pass to it the attributes retrieved from the URL.  We could pass them as an additional argument to the <b>render_template ()</b> , but instead we use another feature of the Request class (attributes class).  Request Attributes allow you to include additional information about the Request, which is not directly related to the HTTP request data. <br>  Now we <b>‚Äôll</b> write the <b>render_template ()</b> function, a common controller that renders the template, without much logic.  To preserve the previous structure of the template, the attributes of the query are retrieved prior to rendering the template: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render_template</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($request)</span></span></span><span class="hljs-function"> </span></span>{ extract($request-&gt;attributes-&gt;all(), EXTR_SKIP); ob_start(); <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> sprintf(<span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span>.<span class="hljs-string"><span class="hljs-string">'/../src/pages/%s.php'</span></span>, $_route); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Response(ob_get_clean()); }</code> </pre><br><br>  Since the render_template is used as an argument to PHP <b>call_user_func ()</b> , we can replace it with any valid PHP callback function.  This will allow you to use a function, an anonymous function, or a controller class method ... of your choice. <br>  To standardize the definition of any path, the associated controller is configured via the <i>_controller</i> route attribute: <br><br><pre> <code class="php hljs">$routes-&gt;add(<span class="hljs-string"><span class="hljs-string">'hello'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Routing\Route(<span class="hljs-string"><span class="hljs-string">'/hello/{name}'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'World'</span></span>, <span class="hljs-string"><span class="hljs-string">'_controller'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'render_template'</span></span>, ))); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $request-&gt;attributes-&gt;add($matcher-&gt;match($request-&gt;getPathInfo())); $response = call_user_func($request-&gt;attributes-&gt;get(<span class="hljs-string"><span class="hljs-string">'_controller'</span></span>), $request); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Routing\<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>\ResourceNotFoundException $e) { $response = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Response(<span class="hljs-string"><span class="hljs-string">'Not Found'</span></span>, <span class="hljs-number"><span class="hljs-number">404</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> $e) { $response = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Response(<span class="hljs-string"><span class="hljs-string">'An error occurred'</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span>); }</code> </pre><br><br>  The route can now be connected to any controller and, of course, in the controller, you can use the <b>render_template ()</b> to render the template: <br><br><pre> <code class="php hljs">$routes-&gt;add(<span class="hljs-string"><span class="hljs-string">'hello'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Routing\Route(<span class="hljs-string"><span class="hljs-string">'/hello/{name}'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'World'</span></span>, <span class="hljs-string"><span class="hljs-string">'_controller'</span></span> =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($request)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> render_template($request); } )));</code> </pre><br><br>  This is more flexible since you can change the <i>Response object</i> , and you can even pass additional arguments to the template: <br><br><pre> <code class="php hljs">$routes-&gt;add(<span class="hljs-string"><span class="hljs-string">'hello'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Routing\Route(<span class="hljs-string"><span class="hljs-string">'/hello/{name}'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'World'</span></span>, <span class="hljs-string"><span class="hljs-string">'_controller'</span></span> =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($request)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// $foo will be available in the template $request-&gt;attributes-&gt;set('foo', 'bar'); $response = render_template($request); // change some header $response-&gt;headers-&gt;set('Content-Type', 'text/plain'); return $response; } )));</span></span></code> </pre><br><br>  Here is the updated and improved version of our system: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// example.com/web/front.php require_once __DIR__.'/../vendor/.composer/autoload.php'; use Symfony\Component\HttpFoundation\Request; use Symfony\Component\HttpFoundation\Response; use Symfony\Component\Routing; function render_template($request) { extract($request-&gt;attributes-&gt;all(), EXTR_SKIP); ob_start(); include sprintf(__DIR__.'/../src/pages/%s.php', $_route); return new Response(ob_get_clean()); } $request = Request::createFromGlobals(); $routes = include __DIR__.'/../src/app.php'; $context = new Routing\RequestContext(); $context-&gt;fromRequest($request); $matcher = new Routing\Matcher\UrlMatcher($routes, $context); try { $request-&gt;attributes-&gt;add($matcher-&gt;match($request-&gt;getPathInfo())); $response = call_user_func($request-&gt;attributes-&gt;get('_controller'), $request); } catch (Routing\Exception\ResourceNotFoundException $e) { $response = new Response('Not Found', 404); } catch (Exception $e) { $response = new Response('An error occurred', 500); } $response-&gt;send();</span></span></code> </pre><br><br>  In honor of the birthday of our framework, let's create a new application with the simplest logic.  Our application consists of one page that says: is this a leap year or not.  When you call <i>/ is_leap_year</i> , you will get the answer for the current year, but you can also specify the year, in the form <i>/ is_leap_year / 2009</i> .  Being universal, the framework does not need changes, just create a new app.php file: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// example.com/src/app.php use Symfony\Component\Routing; use Symfony\Component\HttpFoundation\Response; function is_leap_year($year = null) { if (null === $year) { $year = date('Y'); } return 0 == $year % 400 || (0 == $year % 4 &amp;&amp; 0 != $year % 100); } $routes = new Routing\RouteCollection(); $routes-&gt;add('leap_year', new Routing\Route('/is_leap_year/{year}', array( 'year' =&gt; null, '_controller' =&gt; function ($request) { if (is_leap_year($request-&gt;attributes-&gt;get('year'))) { return new Response('Yep, this is a leap year!'); } return new Response('Nope, this is not a leap year.'); } ))); return $routes;</span></span></code> </pre><br><br>  <b>Is_leap_year ()</b> returns true if the given year is a leap year, false otherwise.  If the year is null, then the current year is checked.  The controller is simple: it gets the year from the attributes of the query, passes it to <b>is_leap_year ()</b> , and according to the return value, it creates a new Response object. <br>  As always, you can decide to stop there and use the framework as it is.  This is probably enough to create simple one-page sites, and even perhaps with two pages or more. </div><p>Source: <a href="https://habr.com/ru/post/138010/">https://habr.com/ru/post/138010/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../138003/index.html">25 services for productive work with Gmail</a></li>
<li><a href="../138004/index.html">WebKit and web standards</a></li>
<li><a href="../138005/index.html">VMware vSphere: Convert Virtual IDE Disk to SCSI</a></li>
<li><a href="../138006/index.html">Learn jQuery for 30 days</a></li>
<li><a href="../138008/index.html">PowerShell and GUI. It is not difficult</a></li>
<li><a href="../138011/index.html">+ 2GB for your DropBox account. Samsung Brazil Promotion</a></li>
<li><a href="../138012/index.html">Debug methods in Documentum Process Builder</a></li>
<li><a href="../138013/index.html">Arduino LCD Informer</a></li>
<li><a href="../138014/index.html">How people make connections. Community or social network 2</a></li>
<li><a href="../138015/index.html">Opera 12 (Wahoo), update kernel with Do Not Track, mail and themeization fixes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>