<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Acquaintance with the robotic constructor TRIK: reverse pendulum</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction and formulation of the problem 


 What do female breasts and toy railroad have in common? That's right, and that, and that is intended f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Acquaintance with the robotic constructor TRIK: reverse pendulum</h1><div class="post__text post__text-html js-mediator-article"><h1>  Introduction and formulation of the problem </h1><br><img src="https://habrastorage.org/getpro/geektimes/post_images/094/7c5/cb4/0947c5cb40f94cdd0fc48bd286631581.jpg"><br><br>  What do female breasts and toy railroad have in common?  That's right, and that, and that is intended for children, and dads play with them.  A few days ago I got a <a href="http://trikset.com/">TRIK</a> robotics designer.  The kit is quite harsh, the developers claim that it is good for rapid prototyping and for training, namely (self-) learning I am currently interested in. <br><br>  What is now widely available on the market for robotic games?  Self-made production of boards for each project is not considered.  Lego, crucify, arduino.  Lego is beautiful, but unfortunately very, very limited.  Crucify and Arduins are expanding quite well, but they are rather inconvenient and quickly turn into scattering of different nameplates.  This is where St. Petersburg guys go to the market with their designer TRIK. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, my task is to understand how it is available to the general public (me).  I have never attended lectures on theoretical cybernetics or control theory.  Ohm's law, I learned just enough to understand that the socket is not worth licking, and the soldering iron is not my friend.  But like any normal (overgrown) child, I love to play, and therefore I became interested in this topic. <br><br><a name="habracut"></a><br><br>  I got this set: <br><img src="https://habrastorage.org/getpro/habr/post_images/30d/04a/5c0/30d04a5c0d2c65261ccf9279fbf6c900.jpg"><br><br>  In general, the price of their sets varies from about twenty to seventy thousand rubles.  Is it more expensive than Lego?  Not.  A month ago, I bought a Lego EV3.  The price of the issue is ‚Ç¨ 370 base set + ‚Ç¨ 100 battery (are they absolutely fucked up there ?!) And I didn‚Äôt even consider the charger for thirty euros.  Plus, neither the sonar (+ 35 ‚Ç¨) nor the gyroscope (+ 35 ‚Ç¨) are included in the basic set.  And we can forget about the camera with a microphone in general, without mentioning in general, in principle, the lack of access to the inside of Legovsky Linux. <br><br>  My set (it was laid out in the previous photo) includes <b>two controllers</b> , two cameras, two microphones, sonars, two types of infrared sensors, buttons, six electric motors with optoencoders, three servos, two mechanical captures, a bunch of wheels, including holonomic ones, charging-battery-laces, cog wheels, slats and a bunch of metal plates and corners (hello childhood!).  The constructor is purely for a start, in general, almost everything that is enough imagination can be connected to the controller.  ARM9 central processor, under the video a separate processor, so as not to load the central one.  You can program on anything from assembly to C #, you are given a root console, plus the entire firmware code is open source. <br><br>  This is what my wonder box looks like: <br><img src="https://habrastorage.org/getpro/geektimes/post_images/9aa/839/9bd/9aa8399bd8d2076931ee4a63fdd0552f.jpg"><br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/69d/cf7/6b1/69dcf76b137644154e267c21cc82ebde.jpg"><br><br>  As the very first project I decided to assemble a reverse pendulum, it is presented in the title picture.  This is how it looks from behind: <br><img src="https://habrastorage.org/getpro/geektimes/post_images/d96/9e5/131/d969e51318a63836a05fc9a2cea05dc5.jpg"><br>  From the kit I needed two engines, two wheels, a bit of fasteners and a controller with a battery directly.  My goal was not to copy the tutorial from the TRIK training course, I‚Äôm interested to break off teeth about all the problems on my own, so I‚Äôll reinvent the wheel. <br><br>  So, I have at my disposal one degree of freedom, an accelerometer and a gyroscope; I did not use encoders from engines.  I will write on Qt Script. <br><br><h1>  Reading sensors </h1><br>  Initially, I wanted to do with an accelerometer.  Like, I read the sign of the projection on the Z axis, if it is positive, then I twist the wheels in one direction, if negative, then in the other.  In theory, everything is fine, but having done this, I achieved only the wild jerking of my cart.  He sighed and sat down to study the literature, the good that it was not very long.  So, I am only interested in the angle of deviation of the trolley from the vertical. <br><br><h3>  Gyroscope </h3><br>  It is the angular velocity sensor, gives a good smooth signal, but in order to track the orientation in space with its help, the speed needs to be integrated.  Initially, the speeds are issued with an error, the integration introduces more errors, which ultimately will lead to the disappearance of the gyroscope readings.  Therefore, only a gyroscope is not enough for a pendulum for us, we need to combine it with an accelerometer. <br><br>  Here is my code for working with a gyroscope, here while (true) is the main program loop. <br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> gyr_x_angle = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lasttime = <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> G = brick.gyroscope().read(); G[<span class="hljs-number"><span class="hljs-number">0</span></span>] = G[<span class="hljs-number"><span class="hljs-number">0</span></span>] + <span class="hljs-number"><span class="hljs-number">69</span></span>; <span class="hljs-comment"><span class="hljs-comment">// drift correction var curtime = Date.now(); var dt = (curtime - lasttime)/1000.0; lasttime = curtime; gyr_x_rate = G[0] * 0.07; gyr_x_angle = gyr_x_angle + gyr_x_rate * dt; }</span></span></code> </pre> <br><br>  In the array G, I read the sensor values, in the next line I correct the axis of interest to me.  It turns out that my particular sensor at full speed shows an average speed of 69 units, so I subtract them to get the speed of interest to me. <br>  The sensor gives an integer that you want to translate into corners.  In normal mode, it works at 2000 degrees / sec (dps).  Datashit says this corresponds to a constant at 70mdps / digit.  Thus, G (digits) * 0.07 (dps / digit) gives us the angular velocity.  It remains to integrate it by multiplying by the measurement time dt. <br><br><h3>  Accelerometer </h3><br>  From the accelerometer, the angle is even simpler to obtain, but the problem is that it is painfully noisy, and when the cart starts to twitch back and forth, light out at all.  Here is the code: <br><pre> <code class="javascript hljs"> [...] <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { [...] <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> A = brick.accelerometer().read(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a_x_angle = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.atan(A[<span class="hljs-number"><span class="hljs-number">2</span></span>] / A[<span class="hljs-number"><span class="hljs-number">0</span></span>]) * <span class="hljs-number"><span class="hljs-number">180.0</span></span> / pi; }</code> </pre><br><br><h3>  Extinguish noise: the combination of accelerometer and gyroscope readings </h3><br><pre> <code class="javascript hljs"> [...] <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> CF_x_angle = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { [...] CF_x_angle = <span class="hljs-number"><span class="hljs-number">0.98</span></span>*(CF_x_angle+ gyr_x_rate*dt) + <span class="hljs-number"><span class="hljs-number">0.02</span></span>*a_x_angle; }</code> </pre><br>  It simply says that the value of the current angle is 98% the value of the previous angle corrected from the gyroscope, and 2% is the direct reading of the angle from the accelerometer.  This combination allows you to deal with floating gyro, note that we did not use the gyr_x_angle variable here. <br><br><h1>  PID controller </h1><br>  As I said, I did not attend smart lectures on control theory, so <a href="http://habrahabr.ru/post/220989/">LQR regulators</a> are too tough for a reasonable (couple of hours) time.  But the <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%2598%25D0%2594-%25D1%2580%25D0%25B5%25D0%25B3%25D1%2583%25D0%25BB%25D1%258F%25D1%2582%25D0%25BE%25D1%2580">PID</a> is fine. <br><br><h3>  Code </h3><br><br>  In the previous paragraph, we obtained a decent (I hope) estimate of the angle of deviation of the trolley from the vertical.  You can improve it using Kalman filtering, but this is shooting from a cannon at the sparrows.  Now it's time to turn the wheels - the greater the angle of deflection, the faster you need to turn the wheel. <br><br>  The speed of rotation of the wheel, which will give us the PID, consists of three (weighted) terms: proportional, integrating and differentiating.  Proportional is simply equal to the angle of deviation from the vertical, the integrating is the sum of all regulation errors, and the differentiator is proportional to the rate of change of the deviation from the vertical. <br><br>  It sounds scary, but in fact the code is extremely simple: <br><div class="spoiler">  <b class="spoiler_title">full program code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> gyr_x_angle = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lasttime = <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> CF_x_angle = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> iTerm = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> CF_x_angle_prev = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> KP = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> KI = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> KD = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> G = brick.gyroscope().read(); G[<span class="hljs-number"><span class="hljs-number">0</span></span>] = G[<span class="hljs-number"><span class="hljs-number">0</span></span>] + <span class="hljs-number"><span class="hljs-number">69</span></span>; <span class="hljs-comment"><span class="hljs-comment">// drift correction var curtime = Date.now(); var dt = (curtime - lasttime)/1000.0; lasttime = curtime; gyr_x_rate = G[0] * 0.07; var A = brick.accelerometer().read(); var a_x_angle = Math.atan(A[2] / A[0]) * 180.0 / pi; CF_x_angle = 0.98*(CF_x_angle+ gyr_x_rate*dt) + 0.02*a_x_angle; //  ! var pTerm = KP*CF_x_angle; //   iTerm = iTerm + KI*CF_x_angle; //   var dTerm = KD * (CF_x_angle - CF_x_angle_prev); //   CF_x_angle_prev = CF_x_angle; power = pTerm + iTerm + dTerm; brick.motor(M3).setPower(power); brick.motor(M4).setPower(power); }</span></span></code> </pre><br></div></div><br><br><h3>  Choice of constants KP, KI, KD </h3><br>  The most difficult part remains: to find the weights in total, unfortunately, this can only be done empirically. <br><br>  First we find the coefficient KP.  We set KI and KD equal to zero and increase KP starting from zero until the moment when our cart starts to make (approximately) constant oscillations, like this (KP = 8, KI = 0, KD = 0): <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/NNcBg7R8Aco%3Ffeature%3Doembed&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhiwidFtzwnJp_MXKozvZj8pAmBAqg" frameborder="0" allowfullscreen=""></iframe><br><br>  Obviously, this is a brute force, the trolley receives a too strong signal from the proportional component, so reduce it by about half, we get this (KP = 5, KI = 0, KD = 0): <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/TYpZG-jqAqw%3Ffeature%3Doembed&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhqE1xtgI77DpIQB4m7VbgqkuvGlA" frameborder="0" allowfullscreen=""></iframe><br><br>  Now the cart lacks a purely proportional signal, we increase its speed by adding an integrating component.  Smoothly increasing KI from scratch, trying to reach the moment when we again get the trolley oscillations around the desired position (KP = 5, KI = 0.5, KD = 0): <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/7TvDI9BihQc%3Ffeature%3Doembed&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhoW_WJLMuejrt0uaN6uawKxvKTzA" frameborder="0" allowfullscreen=""></iframe><br><br>  Now we add a differentiating component that will play the role of a damper, quenching the oscillations, this is what I get (KP = 5, KI = 0.5, KD = 5): <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/w-xed-n1gm4%3Ffeature%3Doembed&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhk2uFhEWvJ4RnhCPhtprrMg1Deow" frameborder="0" allowfullscreen=""></iframe><br><br><h1>  Conclusion </h1><br>  I pretty quickly (in one evening) turned out self-balancing trolley.  Considering that the program turned out to be as much as twenty-five lines, now, at leisure, it remains to add control of the cart, turns and passing of the obstacle course, this should not be a big deal. <br><br>  I have neither electrical, nor cybernetic background, that is, it is quite accessible to ordinary users, which, actually, is very interesting to me.  I will continue to study! <br><br>  Compared with the same Leg set, it all, of course, looks a bit more clumsy, the Chinese sensors (like the Lego), but not rolled up into thick high-quality Legovsky plastic.  Less licked software that is in active development.  The community of people programming on this controller is much smaller, but considering that a project without a year is a week, and even seeing the recent success of the Arduino, this frightens me a little.  But I admire the flexibility of the controller, which was obtained from the amazing enthusiasm with which in St. Petersburg they took up the development. <br><br><hr><br><br><h1>  Update: controller specifications </h1><br>  Many do not understand the difference between the Tricov controller and the Arduino or the Legovian boxes.  Therefore, here is a sign: <br><table><tbody><tr><td>  Central Processing Unit (CPU) </td><td>  OMAP-L138 C6-Integra ‚Ñ¢ DSP + ARM¬Æ SoC, Texas Instruments </td></tr><tr><td>  CPU clock speed </td><td>  375 MHz </td></tr><tr><td>  CPU core </td><td>  ARM926EJ-S ‚Ñ¢ RISC MPU </td></tr><tr><td>  DSP core CPU </td><td>  C674x Fixed / Floating-Point VLIW DSP </td></tr><tr><td>  RAM </td><td>  256 MB </td></tr><tr><td>  FLASH - memory </td><td>  16 MB </td></tr><tr><td>  Peripheral Processor (PP) </td><td>  MSP430F5510, Texas Instruments </td></tr><tr><td>  Clock frequency PP </td><td>  24 MHz </td></tr><tr><td>  User interfaces </td><td>  USB 2.0, WiFi b / g / n, BlueTooth, 2 * UART, 2 * I2C, Micro-SD, Mic in (stereo), Line out (mono) </td></tr><tr><td>  DC motor interfaces </td><td>  4 ports of 6-12V DC motors, with individual hardware overcurrent protection (up to 2A per motor) </td></tr><tr><td>  Peripheral Interfaces </td><td>  19 signal ports of general purpose (6 single-channel and 13 dual-channel) with 3.3-5V power supply, 6 of them can operate in the analog input mode </td></tr><tr><td>  Video Sensor Interfaces </td><td>  2 inputs BT.656 VGA 640 * 480, support stereo mode </td></tr><tr><td>  Built-in LCD monitor </td><td>  2.4 ‚ÄùTFT, color, touch, resolution 320 * 240 pixels </td></tr><tr><td>  Built-in speaker </td><td>  Rated power 1W, peak 3W </td></tr><tr><td>  Led indicator </td><td>  2-color, program-controlled </td></tr><tr><td>  Expansion slots </td><td>  2 * 26-pin slotted expansion module connectors </td></tr><tr><td>  Additional equipment (included in the controller) </td><td>  3-axis accelerometer, 3-axis gyroscope, audio codec, amplifier, converters and power control circuits, protection circuits for inputs against overload voltage and current </td></tr><tr><td>  Power supply </td><td>  6-12V DC, external power adapter or LiPo battery RC 3P (11,1V) / 2P (7,4V) </td></tr><tr><td>  Housing dimensions </td><td>  125 * 80 * 25 mm </td></tr></tbody></table></div><p>Source: <a href="https://habr.com/ru/post/260783/">https://habr.com/ru/post/260783/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../260773/index.html">Java string processing Part II: Pattern, Matcher</a></li>
<li><a href="../260775/index.html">How I Made and Sold the Axure 7 Course</a></li>
<li><a href="../260777/index.html">Favicons, Touch Icons, Tile Icons, etc. What to choose?</a></li>
<li><a href="../260779/index.html">Contracts in D</a></li>
<li><a href="../260781/index.html">Why I do not teach SOLID and the "principle of eliminating dependencies"</a></li>
<li><a href="../260787/index.html">The digest of interesting materials for the mobile developer # 108 (June 15-21)</a></li>
<li><a href="../260789/index.html">Node Webkit without webkit</a></li>
<li><a href="../260791/index.html">Howto Qemu-kvm Debian 8</a></li>
<li><a href="../260795/index.html">Hackathon in deep learning</a></li>
<li><a href="../260797/index.html">What is the best programming language to learn in 2015?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>