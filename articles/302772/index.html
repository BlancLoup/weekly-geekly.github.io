<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Front-door VRF. Another practical example</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi habr! There are many articles on the Internet about configuring VPN with VRF on Cisco equipment. There is a good cheat sheet for setting up IPsec V...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Front-door VRF. Another practical example</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/c9e/df5/993/c9edf59939334c2a9cf158ce4b2b7698.jpg"><br><br>  Hi habr!  There are many articles on the Internet about configuring VPN with VRF on Cisco equipment.  <a href="https://supportforums.cisco.com/document/51931/vrf-aware-ipsec-cheat-sheet">There</a> is a good cheat sheet for setting up IPsec VPN in the form of crypto maps and VTI tunnels in conjunction with the VRF.  In <a href="https://habrahabr.ru/post/270629/">this article,</a> an example of DMVPN with a VRF is given.  VRF gives a great deal of flexibility when setting up a large number of equipment and options for using it.  The main thing is not to forget that we have such a tool.  In my note, I decided to consider another interesting problem from our practice, which also came in handy with using Front-door VRF to build IPsec tunnels.  It will be about building parallel VPN tunnels through different Internet providers and distributing traffic across these tunnels. <a name="habracut"></a><br><br>  Virtual Routing and Forwarding (VRF) technology allows you to split one physical router into several logical (virtual) ones.  Thanks to this technology, it is possible to have several independent routing tables on one physical router.  VRF technology is widely used in MPLS networks.  However, VRF can be used without MPLS.  In this case, in Cisco terminology, the technology is called VRF lite.  To be more precise, VRF-lite is a technology that allows you to build two or more VPN tunnels on one VPN concentrator, in an environment that assumes intersecting address spaces.  In this note, the intersection of address spaces will not be affected. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Very briefly consider what gives us the use of VPN in conjunction with the VRF.  The protected network whose traffic is subject to encryption may not be located in the global VRF of the router.  The protected network VRF is called IVRF - Inside VRF.  However, by default, the router builds IPsec in the global VRF.  Internet service providers can be connected to the interfaces of the router, which are also not located in the global VRF of the router.  Such connection of Internet providers allows you to terminate and dispose of VPN tunnels from remote points simultaneously on all existing Internet connections of the router. <br><br><div class="spoiler">  <b class="spoiler_title">If internet providers are connected to one global VRF</b> <div class="spoiler_text">  In this case, there is a single default route on the router in the global VRF.  A remote office can build parallel VPN tunnels up to the router in question through all available Internet channels.  But the return traffic from the router in question will go in accordance with the default route through a single ISP.  Therefore, only the ISP that the default route points to will be recycled by return traffic.  Consider an example based on IPsec VTI tunnels: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/83c/4e0/eec/83c4e0eec2ef4ffd96f5241009a4f51b.png"></div><br>  R1 Tunnel Interface Settings: <br><br><pre><code class="python hljs">interface GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span> ip address <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> ! interface GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">1</span></span> ip address <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.252</span></span> ! interface GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">2</span></span> ip address <span class="hljs-number"><span class="hljs-number">2.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.252</span></span> ! interface Tunnel1 ip unnumbered GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span> tunnel source <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> tunnel mode ipsec ipv4 tunnel destination <span class="hljs-number"><span class="hljs-number">3.3</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> tunnel path-mtu-discovery tunnel protection ipsec profile ipsec-prof ! interface Tunnel2 ip unnumbered GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span> tunnel source <span class="hljs-number"><span class="hljs-number">2.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> tunnel mode ipsec ipv4 tunnel destination <span class="hljs-number"><span class="hljs-number">3.3</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> tunnel path-mtu-discovery tunnel protection ipsec profile ipsec-prof ! ip route <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> ip route <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">2.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre> <br>  R2 router tunnel interface settings: <br><pre> <code class="python hljs">interface GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span> ip address <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> ! interface GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">1</span></span> ip address <span class="hljs-number"><span class="hljs-number">3.3</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.252</span></span> ! interface Tunnel1 ip unnumbered GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span> tunnel source <span class="hljs-number"><span class="hljs-number">3.3</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> tunnel mode ipsec ipv4 tunnel destination <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> tunnel path-mtu-discovery tunnel protection ipsec profile ipsec-prof ! interface Tunnel2 ip unnumbered GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span> tunnel source <span class="hljs-number"><span class="hljs-number">3.3</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> tunnel mode ipsec ipv4 tunnel destination <span class="hljs-number"><span class="hljs-number">2.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> tunnel path-mtu-discovery tunnel protection ipsec profile ipsec-prof ! ip route <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">3.3</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span></code> </pre><br><br>  For the presented configuration, the tunneled traffic will be distributed across the R1 Internet service providers as follows: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/015/6d5/757/0156d57577a84327a692d4dade792e31.jpg"></div><br>  IPsec-packets Tunnel2 from R1 to R2 have the source IP address 2.2.2.1, but pass through the channel of the first ISP1 Internet service provider.  Some Internet providers block traffic with source IP addresses belonging to "foreign" Internet providers.  If the provider does this check, Tunnel2 will not install (therefore, part of the Tunnel2 line from R1 to R2 is shown in dotted lines). </div></div><br>  VRFs, to which Internet service providers connect channels and in which tunnelled (in particular, encrypted) traffic appears, are called FVRF - Front-door VRF.  If IPsec is correctly configured with VRF, we get a connection between IVRF and FVRF using IPsec.  In other words, the protected traffic enters the IVRF, and after encapsulation in the tunnel it automatically turns into FVRF, in which other routing rules are applied.  And it is very convenient. <br><br>  I turn to the description of my example.  There is a distributed network.  At the central office (hereinafter referred to as CO), there are two Internet providers, each of which is connected to its own Cisco router.  The first ISP1 ISP is used for VPN to remote offices, the second ISP2 ISP is used to access the Internet.  A redundancy protocol for the first HSRP transition is configured between the color routers.  In remote offices there are two options for boundary equipment: <br><br><ol><li>  Cisco router.  VTI-tunnels are built to such offices. </li><li>  Cisco NPE router paired with Cisco ASA.  GRE over IPsec tunnels are built up to such offices.  GREs are terminated on routers and encrypted in IPsec on the Cisco ASA. </li></ol><br>  Network layout: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/809/9f9/116/8099f91167474d449820f5f74df3aa64.jpg"></div><br>  Routes are routed via EIGRP between the central office and remote offices.  If ISP1 or R1 fails, all traffic goes to ISP2 and R2.  In the event of ISP2 or R2 failure, Internet access is provided via ISP1 and, accordingly, R1.  This scheme is implemented by EIGRP, HSRP and PBR.  PBR is used to redirect traffic to the Internet through ISP2.  PBR is configured using ISP2 health tracking (IP SLA PBR Object Tracking). <br><br>  <b>Task</b> <br><br>  In the CO, the third ISP3 ISP is connected to the router R1.  It is necessary to distribute traffic across the tunnels through ISP1 and ISP3 of router R1.  Also, it is necessary to comply with some of the requirements for fault tolerance by the Internet providers of the DH and the routers of the DH.  I will not describe all the failure options, I will mention only the most important requirement: ISP1 provider, which runs normal traffic to remote offices (green tunnels in the diagram), should remain as unloaded as possible.  That is, in case of ISP2 failure, Internet access should switch to ISP3, and in case of ISP3 failure, the traffic of the implemented service (red tunnels in the diagram) should switch to ISP2. <br><br>  Network layout with regard to the new channel (ISP3): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/58f/da9/c93/58fda9c9347c4ebdba776ddf80286cb2.jpg"></div><br>  <b>Decision</b> <br><br>  <u>Short description</u> <br>  Since R1 in normal network operation (when all Internet providers are working) must terminate VPN IPsec tunnels on both Internet providers simultaneously (ISP1 and ISP3), it was decided to make the connection to the new ISP3 Internet provider in a separate FVRF.  At the same time, it was decided to leave the protected (local) networks and the connection to the first Internet provider in the global VRF. <br><br>  After correct configuration of IPsec together with FVRF, we have parallel workable tunnels through IPS1 and IPS3.  An example IPSec configuration with FVRF will be discussed in the next section.  It now remains to distribute traffic flows through the existing tunnels.  To solve this problem, we can distinguish the following approaches: <br><br><ol><li>  Equal Cost Multi Path (ECMP).  Tunnel balancing using routes with the same metric; </li><li>  To route different IP subnetworks of the DH and / or remote offices through different tunnels; </li><li>  Performance Routing (PfR); </li><li>  Policy Based Routing (PBR); </li><li>  Use Network Address Translation (NAT) to allocate specific IP addresses and configure routing for these specific IP addresses. </li></ol><br>  For my task, the last option was the most preferable - an approach using NAT.  This option allows on the one hand to rigidly define the distribution of traffic across tunnels (as opposed to ECMP and PfR), on the other hand, to reduce the number of configuration lines (as opposed to PBR).  Consider it in more detail. <br><br>  On the Central Office Routers we configure the dynamic policy NAT network address translation rule.  We use this rule to change the IP addresses of the CO computers to some ‚Äúspecial‚Äù IP address when they access some previously known servers in remote offices.  We use <b>policy</b> NAT to change the IP addresses of clients only when referring to known IP addresses of servers.  Next, using the EIGRP setting, we distribute to the remote offices a ‚Äúspecial‚Äù IP address with the best metric via ISP3 tunnels, and for tunnels through ISP1, which must be unloaded, on the contrary, we overestimate the metric for the ‚Äúspecial‚Äù IP address. <br><br>  Thus, the request from the clients of the CO arrives at the server in the remote office with the changed source IP address.  In response, the server generates traffic to the changed IP address, and the router in the remote office routes this traffic flow to the required tunnel.  At the same time, routers in remote offices do not require additional routing configuration: route management is performed via EIGRP from the console of the DH routers.  Below is a request / response flow diagram.  The real IP address of the client: 192.168.1.100.  The ‚Äúspecial‚Äù IP address to which the IP address of the client is converted: 10.10.10.10.  Server IP address in remote office: 172.16.1.100. <br><br><img src="https://habrastorage.org/files/210/ead/051/210ead05167e4cac9fcaeb27498ad61d.jpg"><br><br><div class="spoiler">  <b class="spoiler_title">Asymmetric routing</b> <div class="spoiler_text">  The diagram shows that we allow asymmetric routing: requests go through ISP1 tunnels, responses are returned through ISP3 tunnels.  In normal operation, this scheme suits.  But asymmetric routing is almost always ready to bring problems.  Not without difficulties and with us. <br><br>  Imagine a scheme when ISP1 fails.  In this case, requests begin to go through router R2 and ISP2 tunnels, and the request / response flow diagram takes the following form: <br><br><img src="https://habrastorage.org/files/0a3/f5d/0c1/0a3f5d0c1873480290e23aa482417b23.jpg"><br>  The diagram shows that for request packets, the source IP address translation is performed on router R2.  Response packets come through the ISP3 tunnels on router R1.  However, in order to perform the UNNAT procedure and convert the recipient's IP address to the real client IP address, you have to send packets back to R2. <br><br>  In order for the UNNAT procedure on R2 to be successful, the response packets must first go to the router interface that has the ip nat outside directive, and then to the interface that has the ip nat inside directive.  The interface with the ip nat outside directive is the Loopback interface.  The interface with the ip nat inside directive is the internal interface of the router connected to the core network switches.  If you redirect traffic from router R1 to router R2 through the existing internal interfaces connected to the core network switches, the packets follow the following path: R2 internal interface with ip nat inside, R2 Loopback interface with ip nat outside and back to R2 internal interface c ip nat inside.  From the point of view of NAT, the trajectory looks like: ip nat inside -&gt; ip nat outside -&gt; ip nat inside.  UNNAT did not work.  It was necessary to exclude the first ip nat inside, that is, the entry of packets subject to UNNAT through the existing internal interface of router R2.  I had to configure an additional logical subinterface on R2 that does not have ip nat inside directives to receive traffic from R1 subject to UNNAT, and to configure the corresponding routing rules on R1. <br></div></div><br>  <u>Configuration description</u> <br><br>  DH IP Addressing: <br><table><tbody><tr><td>  Internal network: </td><td>  192.168.1.0/24 </td></tr><tr><td>  Connection to ISP1: </td><td>  1.1.1.1/30, Gateway 1.1.1.2 </td></tr><tr><td>  Connection to ISP2: </td><td>  2.2.2.1/30 gateway 2.2.2.2 </td></tr><tr><td>  Connection to ISP3: </td><td>  3.3.3.1/30 gateway 3.3.3.2 </td></tr><tr><td>  Client IP Address: </td><td>  192.168.1.100 </td></tr></tbody></table><br>  IP addressing of remote office type 1 (VTI-tunnels): <br><table><tbody><tr><td>  Internal network: </td><td>  172.16.1.0/24 </td></tr><tr><td>  Connection to ISP: </td><td>  4.4.4.1/30 gateway 4.4.4.2 </td></tr><tr><td>  Server IP Address: </td><td>  172.16.1.100 </td></tr></tbody></table><br>  IP addressing of a remote office type 2 (GRE over IPsec tunnels): <br><table><tbody><tr><td>  Internal network: </td><td>  172.16.2.0/24 </td></tr><tr><td>  Connection to ISP: </td><td>  5.5.5.1/30 Gateway 5.5.5.2 </td></tr><tr><td>  Subnet between the router and Cisco ASA: </td><td>  6.6.6.2 - router <br>  6.6.6.1 - Cisco ASA <br>  mask 255.255.255.252 </td></tr><tr><td>  Server IP Address: </td><td>  172.16.2.100 </td></tr></tbody></table><br>  Network layout: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/1fe/d0e/ff5/1fed0eff5c0c45e58bca56488185c0d5.jpg"></div><br>  Consider the configuration of router R1.  First, I will give an example of setting up VPN tunnels to remote offices of type 1 (VTI-tunnels) and type 2 (GRE over IPsec tunnels).  On the diagram and in the configuration I use the following notation of VPN tunnels: <br><br><ul><li>  Tunnel 10 - VTI-tunnel through ISP1; </li><li>  Tunnel 11 - VTI-tunnel through ISP3 configured using VRF; </li><li>  Tunnel 20 - GRE over IPsec tunnel through ISP1; </li><li>  Tunnel 21 - GRE over IPsec tunnel through ISP3 configured using VRF. </li></ul><br>  Configure VRF and interfaces: <br><br><pre> <code class="python hljs">!  VRF    - ISP3 ip vrf ISP3-vrf ! !      - ISP3 interface GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">2</span></span> description === ISP3 === ip address <span class="hljs-number"><span class="hljs-number">3.3</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.252</span></span> ip vrf forwarding ISP3-vrf ! !       - ISP3 ip route vrf ISP3-vrf <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">3.3</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> ! !     HSRP interface GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span> description === LAN === ip address <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> standby <span class="hljs-number"><span class="hljs-number">1</span></span> ip <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> standby <span class="hljs-number"><span class="hljs-number">1</span></span> priority <span class="hljs-number"><span class="hljs-number">105</span></span> standby <span class="hljs-number"><span class="hljs-number">1</span></span> preempt ! !     - ISP1 interface GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">1</span></span> description === ISP1 === ip address <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.252</span></span> ! !      - ISP1 ip route <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span></code> </pre> <br>  Setting up a VTI tunnel through an ISP1 provider to communicate with remote type 1 offices. <br><br><pre> <code class="python hljs">!  ISAKMP crypto isakmp policy <span class="hljs-number"><span class="hljs-number">10</span></span> encr aes hash sha authentication pre-share group <span class="hljs-number"><span class="hljs-number">2</span></span> ! ! Pre-shared key crypto isakmp key STRONGKEY address <span class="hljs-number"><span class="hljs-number">4.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> no-xauth ! !  IPsec crypto ipsec transform-set ESP-AES-SHA esp-aes <span class="hljs-number"><span class="hljs-number">256</span></span> esp-sha-hmac mode tunnel ! !  IPsec crypto ipsec profile VTI set transform-set ESP-AES-SHA ! !   VTI interface Tunnel10 description === To office Type <span class="hljs-number"><span class="hljs-number">1</span></span> over ISP1 === ip unnumbered GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span> tunnel source <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> tunnel mode ipsec ipv4 tunnel destination <span class="hljs-number"><span class="hljs-number">4.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> tunnel path-mtu-discovery tunnel protection ipsec profile VTI</code> </pre> <br>  Setting up a VTI tunnel through an ISP3 provider in the new VRF ‚ÄúISP3-vrf‚Äù for communication with remote offices of type 1. <br><br><pre> <code class="python hljs">! Keyring crypto keyring office1-keyring vrf ISP3-vrf pre-shared-key address <span class="hljs-number"><span class="hljs-number">4.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> key STRONGKEY ! !  ISAKMP crypto isakmp policy <span class="hljs-number"><span class="hljs-number">10</span></span> encr aes hash sha authentication pre-share group <span class="hljs-number"><span class="hljs-number">2</span></span> ! !  ISAKMP crypto isakmp profile office1-ike-prof keyring office1-keyring match identity address <span class="hljs-number"><span class="hljs-number">4.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span> ISP3-vrf isakmp authorization list default local-address GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">2</span></span> ! !  IPsec crypto ipsec transform-set ESP-AES-SHA esp-aes <span class="hljs-number"><span class="hljs-number">256</span></span> esp-sha-hmac mode tunnel ! !  IPsec crypto ipsec profile office1-ipsec-prof set transform-set ESP-AES-SHA set isakmp-profile office1-ike-prof ! !   VTI.     ISP3-vrf interface Tunnel11 description === To office Type <span class="hljs-number"><span class="hljs-number">1</span></span> over ISP3 === ip unnumbered GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span> tunnel source <span class="hljs-number"><span class="hljs-number">3.3</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> tunnel mode ipsec ipv4 tunnel destination <span class="hljs-number"><span class="hljs-number">4.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> tunnel path-mtu-discovery tunnel vrf ISP3-vrf tunnel protection ipsec profile office1-ipsec-prof</code> </pre><br>  Setting up a GRE over IPsec tunnel through an ISP1 provider to communicate with remote type 2 offices. <br><br><pre> <code class="python hljs">!  ISAKMP crypto isakmp policy <span class="hljs-number"><span class="hljs-number">10</span></span> encr aes hash sha authentication pre-share group <span class="hljs-number"><span class="hljs-number">2</span></span> ! ! Pre-shared key crypto isakmp key STRONGKEY address <span class="hljs-number"><span class="hljs-number">5.5</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> no-xauth ! !  IPsec crypto ipsec transform-set ESP-AES-SHA esp-aes <span class="hljs-number"><span class="hljs-number">256</span></span> esp-sha-hmac mode tunnel ! ! - crypto map CMAP <span class="hljs-number"><span class="hljs-number">10</span></span> ipsec-isakmp description === To office Type <span class="hljs-number"><span class="hljs-number">2</span></span> over ISP1 === set peer <span class="hljs-number"><span class="hljs-number">5.5</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> set transform-set ESP-AES-SHA match address cryptomap_10_acl ! !   GRE interface Tunnel520 description === To office Type <span class="hljs-number"><span class="hljs-number">2</span></span> over ISP1 === ip unnumbered GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span> keepalive <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> tunnel source <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> tunnel destination <span class="hljs-number"><span class="hljs-number">6.6</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> tunnel path-mtu-discovery ! ! -ACL ip access-list extended cryptomap_10_acl permit gre <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> host host <span class="hljs-number"><span class="hljs-number">6.6</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> ! !  -   ISP1 interface GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">1</span></span> crypto map CMAP</code> </pre><br>  Setting up a GRE over IPsec tunnel through an ISP3 provider in the new ‚ÄúISP3-vrf‚Äù VRF to communicate with remote type 2 offices. <br><br><pre> <code class="python hljs">crypto keyring office2-keyring vrf ISP3-vrf pre-shared-key address <span class="hljs-number"><span class="hljs-number">5.5</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> key STRONGKEY ! !  ISAKMP crypto isakmp policy <span class="hljs-number"><span class="hljs-number">10</span></span> encr aes hash sha authentication pre-share group <span class="hljs-number"><span class="hljs-number">2</span></span> ! !  ISAKMP crypto isakmp profile office2-ike-prof vrf ISP3-vrf keyring office2-keyring match identity address <span class="hljs-number"><span class="hljs-number">5.5</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span> ISP3-vrf isakmp authorization list default ! !  IPsec crypto ipsec transform-set ESP-AES-SHA esp-aes <span class="hljs-number"><span class="hljs-number">256</span></span> esp-sha-hmac mode tunnel ! ! - crypto map CMAP-vrf <span class="hljs-number"><span class="hljs-number">10</span></span> ipsec-isakmp description === To office Type <span class="hljs-number"><span class="hljs-number">2</span></span> over ISP3 === set peer <span class="hljs-number"><span class="hljs-number">5.5</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> set transform-set ESP-AES-SHA set isakmp-profile office2-ike-prof match address cryptomap-vrf_10_acl ! interface Tunnel21 description === To office Type <span class="hljs-number"><span class="hljs-number">2</span></span> over ISP3 === ip unnumbered GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span> keepalive <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> tunnel source <span class="hljs-number"><span class="hljs-number">3.3</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> tunnel destination <span class="hljs-number"><span class="hljs-number">6.6</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> tunnel path-mtu-discovery tunnel vrf ISP3-vrf ! ! -ACL ip access-list extended cryptomap-vrf_10_acl permit gre <span class="hljs-number"><span class="hljs-number">3.3</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> host host <span class="hljs-number"><span class="hljs-number">6.6</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> ! !  -   ISP3 interface GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">2</span></span> crypto map CMAP-vrf</code> </pre><br>  By the given examples, VPN-tunnels to all remote offices are configured.  The VPN tunnel settings on router R2 in the central location and on routers and Cisco ASA in remote offices will not be considered because they are trivial. <br><br>  Now that the VPN tunnels to all remote offices are ready, we can proceed to the consideration of routing settings.  The network uses EIGRP.  First, you need to configure the dynamic policy NAT rules to allocate clients for the system being implemented. <br><br><pre> <code class="python hljs">! Loopback      NAT !      interface Loopback1 description ===For System-Servers routing=== ip address <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span> ! !     IP-    object-group network System-Servers description === System-Servers === host <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span> host <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span> ! !     NAT ip access-list extended NAT-System-Servers permit ip any object-group System-Servers ! !     NAT route-map RM-NAT-System-Servers permit <span class="hljs-number"><span class="hljs-number">10</span></span> match ip address NAT-System-Servers ! !  dynamic policy NAT ip nat inside source route-map RM-NAT-System-Servers interface Loopback1 overload ! !  ip nat inside  ip nat outside   interface GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span> ip nat inside ! interface Tunnel10 ip nat outside ! interface Tunnel11 ip nat outside interface Tunnel20 ip nat outside interface Tunnel21 ip nat outside</code> </pre><br>  These NAT settings result in the conversion of client IP addresses to a ‚Äúspecial‚Äù IP address on 10.10.10.10 when accessing servers at remote offices. <br><br>  It remains to configure EIGRP on the router in the central office so that the network on 10.10.10.10/32 is announced to remote offices with the best metric through ISP3 provider tunnels.  In our example, this is Tunnel 11 and Tunnel 21. To control the EIGRP metric, I decided to use the offset-list construct.  Let me remind you that using the offset-list directive you can add the specified value to the advertised route metric.  EIGRP Settings: <br><br><pre> <code class="python hljs">access-list <span class="hljs-number"><span class="hljs-number">10</span></span> permit <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> ! router eigrp <span class="hljs-number"><span class="hljs-number">1</span></span> network <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span> offset-list <span class="hljs-number"><span class="hljs-number">10</span></span> out <span class="hljs-number"><span class="hljs-number">3000000</span></span> Tunnel10 offset-list <span class="hljs-number"><span class="hljs-number">10</span></span> out <span class="hljs-number"><span class="hljs-number">3000000</span></span> Tunnel20 passive-interface default no passive-interface Tunnel10 no passive-interface Tunnel11 no passive-interface Tunnel20 no passive-interface Tunnel21 no passive-interface GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  The described configuration makes the procedure for adding new servers in remote offices, the traffic from which should be routed through the tunnels of the new ISP3 DH provider, is as simple as possible.  When a new server appears, it is enough to add its IP address to the System-Servers object group: <br><br><pre> <code class="python hljs">!     IP-    object-group network System-Servers description === System-Servers === host <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span> host <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span></code> </pre><br>  This concludes my consideration of the configurations of the R1 DH router.  The configuration of R2 router in the central office and the configuration of network devices in remote offices are not of interest in this article. <br><br>  <b>Conclusion</b> <br><br>  Sometimes a simple and logical task is put before a network engineer, but solving a problem leads to the formation of relatively complex configurations.  In my example, an elementary task was considered: to connect a new Internet service provider to the existing router and start using it the traffic of some services from remote offices.  However, to solve this problem, it was necessary to split the router into a VRF, prescribe tricky rules for IP address translation, correct dynamic routing settings, correct the effects of asymmetric routing. <br><br>  Using this task as an example, I considered using Front-door VRF to build IPsec tunnels.  In addition, I showed the option of centralizing routing settings for the star topology using NAT rules.  Front-door VRF for building IPsec is a convenient tool that allows you to build a bridge for transferring traffic between the router's VRF: the protected traffic can be in IVRF or global VRF, and the encapsulated (encrypted) traffic is in FVRF.  FVRF has its own routing rules, which makes it possible to send FVRF traffic through additional communication channels, in particular, through an additional Internet service provider. </div><p>Source: <a href="https://habr.com/ru/post/302772/">https://habr.com/ru/post/302772/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302760/index.html">As we did the centralized data storage for the retail network and optimized it step by step.</a></li>
<li><a href="../302764/index.html">What is mobile-first for? Mobile leaders meet</a></li>
<li><a href="../302766/index.html">Web scraping on Node.js and problem sites</a></li>
<li><a href="../302768/index.html">Basic differences when working with MySQL and PostgreSQL databases Amateurish overview</a></li>
<li><a href="../302770/index.html">About the new features of SQL Server 2016</a></li>
<li><a href="../302774/index.html">Will OpenStack be a ‚Äúnew LAMP‚Äù?</a></li>
<li><a href="../302776/index.html">C / C ++ compiler based on LLVM for multicellular processors: to be or not to be?</a></li>
<li><a href="../302778/index.html">Simply the Best. Top Posts in Intel Blog History</a></li>
<li><a href="../302780/index.html">Installing, configuring, and running DevStack from 'A' to 'Z'</a></li>
<li><a href="../302782/index.html">The book "Career Programmer. 6th edition</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>