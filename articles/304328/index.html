<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Telegram bot and PostGIS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On the implementation of bots for the Telegram messenger on the site there were already quite a lot of posts. But there is one topic that, in my opini...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Telegram bot and PostGIS</h1><div class="post__text post__text-html js-mediator-article">  On the implementation of bots for the Telegram messenger on the site there were already quite a lot of posts.  But there is one topic that, in my opinion, has not yet been raised.  This is the implementation of work with geolocation inside the bot.  In this post I will give an example of how a bot can process geolocation information sent by users based on my own experience of implementing the bot <b>aroundus_bot</b> . <br><br><img src="https://habrastorage.org/files/6da/25b/96b/6da25b96b67049238eb3f5c3ea0e087d.jpg"><br><br><a name="habracut"></a>  The fact is that the Telegram messenger provides quite convenient opportunities for working with geolocation.  The user can send his current position, send any other point on the map (for mobile devices, attaching Location), or send the address and location of any place (restaurants, parks, squares ...) using a <b>foursquare</b> bot. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/382/47a/146/38247a1465ca4b518efb0ab629c12764.jpg"><br><br>  What can I do with this information next?  There are various options.  This can be either the implementation of quests (the bot will send the following points to follow the users, or give any information based on the location of the user), and search for something nearest (toilets, bars, restaurants).  For example, the bot implemented by me allows you to send a story that will be tied to a location specified by the user on the map, with the subsequent ability to read all the stories that users sent in a certain neighborhood from any specified point. <br><br><img src="https://habrastorage.org/files/b42/531/01a/b4253101abd7466898371284b6d9c1ae.jpg"><br><br>  Location comes in the form of a point on a map that has latitude and longitude.  Intuitively, it is clear what to do with this information - we simply save the coordinates in the database, and then, when the user requests stories from a given neighborhood, we simply find all the stories that fall in this neighborhood. <br><br><h4>  Problem </h4><br>  But latitude and longitude are the geographical coordinates of a point, which determine the location of an object on the earth's surface.  And as you know, the earth has the shape of an ellipsoid.  And there is no way to simply add to these coordinates, say, 100 meters, and say that this is the edge of the area in which to look for history.  It is necessary to calculate the neighborhood of the point in spherical coordinates. <br><br>  I thought for a long time what can be done with this, since I think it is wrong to reinvent the wheel and realize my calculation curves.  I wanted to use a ready-made tool that would allow at least to calculate the distance in meters between two geographic points. <br><br><h4>  Postgis </h4><br>  In my search I came across a <a href="https://habrahabr.ru/post/228023/">post</a> published on the current site.  And I realized that I made an absolutely correct choice of the DBMS that I use to store the information needed by the bot - PostgreSQL.  In short, the PostGIS extension, which can be supplied for this DBMS, allows you to work efficiently with geographic coordinates, using the call of special functions in a normal SQL query.  You can read more about PostGIS <a href="http://postgis.net/">here</a> . <br><br>  Thus, sampling all the stories from a neighborhood of a point (or finding the closest thing relative to a given point) is reduced to implementing an SQL query, which, using GiST indices to work with coordinates, will be performed very quickly.  But it should be noted that for the effective use of the extension, the location data must be stored in a column with a special type of geometry, on which then the index must be hung.  In my implementation, for ease of use, I store data both separately for latitude and longitude in double format, and column in geometry format. <br><br>  An example sql query to search for something in a given neighborhood (for example, within a radius of 100 meters), could be: <br><br><pre><code class="sql hljs">ST_Distance(ST_Transform(coordinates, 26986), ST_Transform(ST_SetSRID(ST_MakePoint(x, y), 4326), 26986)) &lt; 100</code> </pre> <br>  Where: <br><br>  <b>ST_Distance</b> , <b>ST_Transform</b> , <b>ST_SetSRID</b> , <b>ST_MakePoint</b> - special functions for working with geographic coordinates, <br>  <b>coordinates</b> - geometry type column <br>  <b>x</b> , <b>y</b> - the latitude and longitude of the point, the neighborhood of which we are interested. <br><br>  It should be said that I also know about the implementation of this extension for MySQL DBMS, but in the process of searching for information I had a strong opinion that the implementation of the extension for PostgreSQL works better and with fewer errors, although I could be mistaken. <br><br><h4>  Conclusion </h4><br>  If there is a need to implement a bot for Telegram, which should work with geographic coordinates, then a good solution would be to use PostgreSQL for storing information.  All that needs to be done is to save the latitude and longitude data received from the user in a geometry type column, and then you can efficiently work with this information using SQL queries. </div><p>Source: <a href="https://habr.com/ru/post/304328/">https://habr.com/ru/post/304328/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../304316/index.html">How to quickly create product descriptions for your store</a></li>
<li><a href="../304320/index.html">PostgreSQL based application performance: explicit and hidden latency</a></li>
<li><a href="../304322/index.html">How to make friends unit testing with a database</a></li>
<li><a href="../304324/index.html">Second rows of associations, or how to make the robot read "between the lines"</a></li>
<li><a href="../304326/index.html">Proportions in art. Is there anything better than the golden section? Research over 1,000,000 old and modern paintings</a></li>
<li><a href="../304332/index.html">How does Apple Pay affect the payment industry?</a></li>
<li><a href="../304340/index.html">Optimize React application to display a list of items</a></li>
<li><a href="../304342/index.html">How to rise after a catastrophic failure</a></li>
<li><a href="../304344/index.html">Never give up: how Netscape waged an unequal battle with Internet Explorer</a></li>
<li><a href="../304346/index.html">Why professional social networks should be handled with care</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>