<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Qt: working with Vkontakte API and Phonon</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article describes the interaction of Qt with software interfaces such as Vkontakte API and Phonon, in real-life examples and detailed descriptions...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Qt: working with Vkontakte API and Phonon</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/e16/778/e58/e16778e586071d722549d4b0c4f30c31.jpg" alt="Qt"><br>  The article describes the interaction of Qt with software interfaces such as Vkontakte API and Phonon, in real-life examples and detailed descriptions. <br>  At the end of the article there is a link to the repository with the source code which you can download and run for free. <br><a name="habracut"></a><br>  Immediately I would like to note that I am not a guru, but the program code can, it would be, better to implement.  I will gladly accept your amendments, comments and criticism. <br>  In order not to duplicate information - I will provide links to the Wiki. <br>  Also, probably, it should be noted that the program was tested and developed on the Gnu / Linux / Gentoo platform (KDE) and I did not check it under other platforms and distributions but it should work. <br><br><h5>  General algorithm: </h5><br>  1. Authorization in the social network through the Vkontakte API (hereinafter VC). <br>  2. Getting a list of your favorite audio recordings. <br>  3. Creating a list of tracks from the list for Phonon. <br>  4. Implementation of the ability to download the selected song. <br><br><h5>  Authorization </h5><br>  According to the <a href="http://vkontakte.ru/developers.php%3Fid%3D-1_21239305%26s%3D1">documentation</a> , for authorization you need to add a component that would allow us to view the web page.  Qt has a <a href="http://ru.wikipedia.org/wiki/WebKit">WebKit for this</a> .  In the component you need to load the page <a href="http://vkontakte.ru/login.php">vkontakte.ru/login.php</a> where the user can go through the authorization procedure.  Upon successful authorization, VC will redirect to the page /login_success.html and add the necessary data for us in the <a href="http://ru.wikipedia.org/wiki/URL">URL</a> , such as session ID, salt and user ID, which we will need to retrieve (parse) from the link. <br>  We connect the necessary modules to the project: <br> <code>QT += webkit \ <br> network \ <br> xml \ <br> phonon</code> <br>  Since VC returns data to XML (or JSON), we need to connect the XML module in order to simplify our life and not reinvent the wheel. <br>  The network module will allow you to download the desired song from the VC and generally work with the network. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <a href="http://ru.wikipedia.org/wiki/Phonon">Phonon</a> module will allow us to play our video locally or from the network.  It also supports playing video files.  It is a pleasure to work with this software interface, but about it later. <br>  To work with VK, I have a VKAuth class in whose constructor I pass my application identifier.  You can get it by <a href="http://vkontakte.ru/apps.php%3Fact%3Dadd">registering</a> your application in VK. <br><blockquote><ol><li>  <font color="#339900">#include &lt;QApplication&gt;</font> </li><li>  <font color="#339900">#include &lt;QObject&gt;</font> </li><li>  <font color="#339900">#include "mainwindow.h"</font> </li><li>  <font color="#339900">#include "VKAuth.h"</font> </li><li></li><li>  <font color="#0000ff">int</font> main <font color="#008000">(</font> <font color="#0000ff">int</font> argc, <font color="#0000ff">char</font> <font color="#000040">**</font> argv <font color="#008000">)</font> </li><li>  <font color="#008000">{</font> </li><li>  QApplication app <font color="#008000">(</font> argc, argv <font color="#008000">)</font> <font color="#008080">;</font> </li><li></li><li>  QApplication <font color="#008080">::</font> <font color="#007788">setApplicationName</font> <font color="#008000">(</font> <font color="#FF0000">"VKaudio"</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  QApplication <font color="#008080">::</font> <font color="#007788">setApplicationVersion</font> <font color="#008000">(</font> <font color="#FF0000">"0.01a"</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li></li><li>  MainWindow window <font color="#008080">;</font> </li><li>  VKAuth vkAuth <font color="#008000">(</font> <font color="#FF0000">"2169954"</font> <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#666666">// my application id</font> </li><li></li><li>  QObject <font color="#008080">::</font> <font color="#007788">connect</font> <font color="#008000">(</font> <font color="#000040">&amp;</font> vkAuth, SIGNAL <font color="#008000">(</font> unsuccess <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> , </li><li>  <font color="#000040">&amp;</font> app, SLOT <font color="#008000">(</font> quit <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> </li><li>  <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  QObject <font color="#008080">::</font> <font color="#007788">connect</font> <font color="#008000">(</font> <font color="#000040">&amp;</font> vkAuth, SIGNAL <font color="#008000">(</font> success <font color="#008000">(</font> QStringList <font color="#008000">)</font> <font color="#008000">)</font> , </li><li>  <font color="#000040">&amp;</font> window, SLOT <font color="#008000">(</font> slotSuccess <font color="#008000">(</font> QStringList <font color="#008000">)</font> <font color="#008000">)</font> </li><li>  <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  vkAuth.  <font color="#007788">show</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#0000ff">return</font> app.  <font color="#007788">exec</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> </li></ol></blockquote><br>  The VKAuth class sends a success signal upon successful authorization and, as an argument, sends a list of links to songs and an unsuccess signal if the user refuses authorization. <br>  Signal about successful authorization to connect to the slot of the main window of the application (the player itself) which adds the transferred list to the list of audio recordings, this process will be described in more detail later.  The user‚Äôs denial of authorization signal is connected to the program shutdown slot (output). <br><blockquote><ol><li>  VKAuth <font color="#008080">::</font> <font color="#007788">VKAuth</font> <font color="#008000">(</font> QString app, QWidget <font color="#000040">*</font> parent <font color="#008000">)</font> <font color="#008080">:</font> QWebView <font color="#008000">(</font> parent <font color="#008000">)</font> </li><li>  <font color="#008000">{</font> </li><li></li><li>  QObject <font color="#008080">::</font> <font color="#007788">connect</font> <font color="#008000">(</font> <font color="#0000dd">this</font> , SIGNAL <font color="#008000">(</font> urlChanged <font color="#008000">(</font> QUrl <font color="#008000">)</font> <font color="#008000">)</font> , </li><li>  SLOT <font color="#008000">(</font> slotLinkChanged <font color="#008000">(</font> QUrl <font color="#008000">)</font> <font color="#008000">)</font> </li><li>  <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  m_app <font color="#000080">=</font> app <font color="#008080">;</font> </li><li>  loadLoginPage <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> </li></ol></blockquote><br>  As I wrote above, the application identifier and a pointer to the ancestor object are passed to the constructor.  The class is inherited from QWebView which implements work with WebKit and allows us to display the required web page to the user.  QWebView has a signal that is sent each time the page is changed.  Since in the case of successful authorization, VC makes redirection (address change) exactly this signal suits us very well to catch this moment.  As an argument, it passes a new link, which we will <a href="http://wiki.searchengines.ru/index.php/%25D0%259F%25D0%25B0%25D1%2580%25D1%2581%25D0%25B8%25D1%2582%25D1%258C">parse</a> . <br>  The loadLoginPage () method implements loading the required page for authorization <br><blockquote><ol><li>  <font color="#0000ff">void</font> VKAuth <font color="#008080">::</font> <font color="#007788">loadLoginPage</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  QUrl url <font color="#008000">(</font> <font color="#FF0000">" <a href="http://vkontakte.ru/login.php%2522">vkontakte.ru/login.php"</a></font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li></li><li>  url.  <font color="#007788">addQueryItem</font> <font color="#008000">(</font> <font color="#FF0000">"app"</font> , m_app <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  url.  <font color="#007788">addQueryItem</font> <font color="#008000">(</font> <font color="#FF0000">"layout"</font> , <font color="#FF0000">"popup"</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  url.  <font color="#007788">addQueryItem</font> <font color="#008000">(</font> <font color="#FF0000">"type"</font> , <font color="#FF0000">"browser"</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  url.  <font color="#007788">addQueryItem</font> <font color="#008000">(</font> <font color="#FF0000">"settings"</font> , <font color="#FF0000">"8"</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li></li><li>  load <font color="#008000">(</font> url <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> </li></ol></blockquote><br>  The QUrl class makes working with links very, very convenient. <br>  QUrl breaks the link into parts. <br><img src="https://habrastorage.org/getpro/habr/post_images/c1e/521/cea/c1e521cea43a9ffe195910060fe4c3df.jpg" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/27e/94a/b34/27e94ab3479d368fc4cca3c6e34aa984.jpg" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/f12/929/967/f12929967152bf3090f8d0d4babe16e1.jpg" alt="image"><br>  The addQueryItem method adds GET parameters to the link, where the first argument is the name of the parameter and the second is its value. <br>  Table with parameter and possible values: <br><img src="https://habrastorage.org/getpro/habr/post_images/1b0/c0f/d1d/1b0c0fd1d22d1b574b45c8ac8634f8b0.jpg" alt="image"><br>  The settings value is necessary for us in order for the user to allow us access to his audio recordings. <br>  We pass the generated URL to the QwebView :: load () class method and it will load the page for authorization. <br><img src="https://habrastorage.org/getpro/habr/post_images/c02/f0a/fb3/c02f0afb353d63925480dc32cb596d50.jpg" alt="image"><br>  Suppose a user has passed authorization - VC redirects, a signal is sent with a new address, and control is given to the slotLinkChanged slot, which is responsible for processing the signal about changing the address. <blockquote><ol><li>  <font color="#0000ff">void</font> VKAuth <font color="#008080">::</font> <font color="#007788">slotLinkChanged</font> <font color="#008000">(</font> QUrl url <font color="#008000">)</font> </li><li>  <font color="#008000">{</font> </li><li>  <font color="#0000ff">if</font> <font color="#008000">(</font> <font color="#FF0000">"/api/login_success.html"</font> <font color="#000080">==</font> url. <font color="#007788">path</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  QRegExp regexp <font color="#008000">(</font> <font color="#FF0000">" <font color="#000099">\"</font> mid <font color="#000099">\ "</font> : ([^,] +), <font color="#000099">\"</font> secret <font color="#000099">\ "</font> : <font color="#000099">\"</font> ([^,] +) <font color="#000099">\ "</font> , <font color="#000099">\"</font> sid <font color="#000099">\ "</font> : <font color="#000099">\"</font> ([^,] + ) <font color="#000099">\ "</font> "</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  QString str <font color="#000080">=</font> url.  <font color="#007788">fragment</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li></li><li>  <font color="#0000ff">if</font> <font color="#008000">(</font> <font color="#000040">-</font> <font color="#0000dd">1</font> <font color="#000040">!</font> <font color="#000080">=</font> regexp. <font color="#007788">indexIn</font> <font color="#008000">(</font> str <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008000">{</font> </li><li></li><li>  m_mid <font color="#000080">=</font> regexp.  <font color="#007788">cap</font> <font color="#008000">(</font> <font color="#0000dd">1</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  m_secret <font color="#000080">=</font> regexp.  <font color="#007788">cap</font> <font color="#008000">(</font> <font color="#0000dd">2</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  m_sid <font color="#000080">=</font> regexp.  <font color="#007788">cap</font> <font color="#008000">(</font> <font color="#0000dd">3</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li></li><li>  QUrl request <font color="#008000">(</font> <font color="#FF0000">" <a href="http://api.vkontakte.ru/api.php%3F%2522">api.vkontakte.ru/api.php?"</a></font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  QString sig <font color="#008000">(</font> getSig <font color="#008000">(</font> m_mid, m_secret, <font color="#FF0000">"api_id ="</font> <font color="#000040">+</font> m_app <font color="#000040">+</font> <font color="#FF0000">"method = audio.get"</font> <font color="#000040">+</font> <font color="#FF0000">"uid ="</font> <font color="#000040">+</font> m_mid <font color="#000040">+</font> <font color="#FF0000">"v = 3.0"</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li></li><li>  request.  <font color="#007788">addQueryItem</font> <font color="#008000">(</font> <font color="#FF0000">"api_id"</font> , m_app <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  request.  <font color="#007788">addQueryItem</font> <font color="#008000">(</font> <font color="#FF0000">"method"</font> , <font color="#FF0000">"audio.get"</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  request.  <font color="#007788">addQueryItem</font> <font color="#008000">(</font> <font color="#FF0000">"uid"</font> , m_mid <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  request.  <font color="#007788">addQueryItem</font> <font color="#008000">(</font> <font color="#FF0000">"v"</font> , <font color="#FF0000">"3.0"</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  request.  <font color="#007788">addQueryItem</font> <font color="#008000">(</font> <font color="#FF0000">"sig"</font> , sig <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  request.  <font color="#007788">addQueryItem</font> <font color="#008000">(</font> <font color="#FF0000">"sid"</font> , m_sid <font color="#008000">)</font> <font color="#008080">;</font> </li><li></li><li></li><li>  QNetworkAccessManager <font color="#000040">*</font> manager <font color="#000080">=</font> <font color="#0000dd">new</font> QNetworkAccessManager <font color="#008000">(</font> <font color="#0000dd">this</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  m_http <font color="#000080">=</font> manager <font color="#000040">-</font> <font color="#000080">&gt;</font> get <font color="#008000">(</font> QNetworkRequest <font color="#008000">(</font> request <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  QObject <font color="#008080">::</font> <font color="#007788">connect</font> <font color="#008000">(</font> m_http, SIGNAL <font color="#008000">(</font> finished <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> , <font color="#0000dd">this</font> , SLOT <font color="#008000">(</font> slotDone <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li></li><li>  <font color="#008000">}</font> </li><li>  <font color="#008000">}</font> <font color="#0000ff">else</font> <font color="#0000ff">if</font> <font color="#008000">(</font> <font color="#FF0000">"/api/login_failure.html"</font> <font color="#000080">==</font> url. <font color="#007788">path</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  emit unsuccess <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> </li><li>  <font color="#008000">}</font> </li><li>  QByteArray VKAuth <font color="#008080">::</font> <font color="#007788">getSig</font> <font color="#008000">(</font> QString mid, QString secret, QString params <font color="#000080">=</font> <font color="#FF0000">""</font> <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  QString str <font color="#008080">;</font> </li><li></li><li>  str.  <font color="#007788">append</font> <font color="#008000">(</font> mid <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#0000ff">if</font> <font color="#008000">(</font> <font color="#000040">!</font> params. <font color="#007788">isEmpty</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> </li><li>  str.  <font color="#007788">append</font> <font color="#008000">(</font> params <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  str.  <font color="#007788">append</font> <font color="#008000">(</font> secret <font color="#008000">)</font> <font color="#008080">;</font> </li><li></li><li>  <font color="#0000ff">return</font> QCryptographicHash <font color="#008080">::</font> <font color="#007788">hash</font> <font color="#008000">(</font> str. <font color="#007788">toUtf8</font> <font color="#008000">(</font> <font color="#008000">)</font> , QCryptographicHash <font color="#008080">::</font> <font color="#007788">Md5</font> <font color="#008000">)</font> .  <font color="#007788">toHex</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> </li></ol></blockquote><br>  In the slot, we check where we were redirected if the redirection was on login_success.html then the authorization was successful (according to the <a href="http://vkontakte.ru/developers.php%3Fid%3D-1_21239305%26s%3D1">documentation</a> ). <br>  We create a <a href="http://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B5%25D0%25B3%25D1%2583%25D0%25BB%25D1%258F%25D1%2580%25D0%25BD%25D1%258B%25D0%25B5_%25D0%25B2%25D1%258B%25D1%2580%25D0%25B0%25D0%25B6%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F">regular expression</a> that will help us obtain the necessary data for further work with the VC, namely: <br>  mid, secret, sid. <br><img src="https://habrastorage.org/getpro/habr/post_images/ab1/c79/53d/ab1c7953d9145b8f02b1a26002389adc.jpg" alt="image"><br>  To get a list of audio recordings, we need to call the <a href="http://vkontakte.ru/developers.php%3Fo%3D-1%26p%3Daudio.get">audio.get</a> method. <br>  The Qhttp class simplifies working with the high-level <a href="http://ru.wikipedia.org/wiki/HTTP">HTTP protocol</a> . <br>  Pass the required parameters as GET parameters and create a hash (method - getSig). <br>  The Qhttp :: done signal that is sent when the request is completed (the response is received) is connected to the slotDone slot. <br><blockquote><ol><li>  <font color="#0000ff">void</font> VKAuth <font color="#008080">::</font> <font color="#007788">slotDone</font> <font color="#008000">(</font> <font color="#0000ff">bool</font> error <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  <font color="#0000ff">if</font> <font color="#008000">(</font> error <font color="#008000">)</font> </li><li>  emit unsuccess <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#0000ff">else</font> <font color="#008000">{</font> </li><li>  QStringList list <font color="#008080">;</font>  <font color="#666666">// list with mp3</font> </li><li></li><li>  QDomDocument dom <font color="#008080">;</font> </li><li>  dom.  <font color="#007788">setContent</font> <font color="#008000">(</font> m_http <font color="#000040">-</font> <font color="#000080">&gt;</font> readAll <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  QDomElement root <font color="#000080">=</font> dom.  <font color="#007788">firstChildElement</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#666666">// &lt;response&gt; root element</font> </li><li>  QDomNode audioElement <font color="#000080">=</font> root.  <font color="#007788">firstChildElement</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#666666">// &lt;audio&gt;</font> </li><li></li><li>  <font color="#0000ff">while</font> <font color="#008000">(</font> <font color="#000040">!</font> audioElement. <font color="#007788">isNull</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  QString url <font color="#000080">=</font> audioElement </li><li>  .  <font color="#007788">toElement</font> <font color="#008000">(</font> <font color="#008000">)</font> </li><li>  .  <font color="#007788">elementsByTagName</font> <font color="#008000">(</font> <font color="#FF0000">"url"</font> <font color="#008000">)</font> </li><li>  .  <font color="#007788">item</font> <font color="#008000">(</font> <font color="#0000dd">0</font> <font color="#008000">)</font> </li><li>  .  <font color="#007788">toElement</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#666666">// &lt;url&gt;</font> </li><li>  .  <font color="#007788">text</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  list.  <font color="#007788">append</font> <font color="#008000">(</font> url <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  audioElement <font color="#000080">=</font> audioElement.  <font color="#007788">nextSibling</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#666666">// next element</font> </li><li>  <font color="#008000">}</font> </li><li>  emit success <font color="#008000">(</font> list <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#666666">// load player window with playlist</font> </li><li>  hide <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#666666">// hide this window</font> </li><li>  <font color="#008000">}</font> </li><li></li><li>  m_http <font color="#000040">-</font> <font color="#000080">&gt;</font> close <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> </li></ol></blockquote><br>  The VKAuth :: slotDone slot reads the received XML and creates a list of links to mp3 songs and then sends a success signal with the same list, closes the join and hides the window.  Authorization completed list of songs received. <br><br><h5>  Phonon </h5><br>  It's very easy to work with Phonon, you need to create a meta object (MediaObject class), create audio (and / or video) output and combine them through Phonon :: createPath. <br>  In the method MainWindow :: appendToList () - we add the list to mp3 files to the list. <br><blockquote><ol><li>  <font color="#0000ff">void</font> MainWindow <font color="#008080">::</font> <font color="#007788">appendToList</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  <font color="#0000ff">if</font> <font color="#008000">(</font> VKAudioList. <font color="#007788">isEmpty</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> </li><li>  <font color="#0000ff">return</font> <font color="#008080">;</font> </li><li></li><li>  <font color="#0000ff">int</font> index <font color="#000080">=</font> sources.  <font color="#007788">size</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  foreach <font color="#008000">(</font> QString string, VKAudioList <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  Phonon <font color="#008080">::</font> <font color="#007788">MediaSource</font> source <font color="#008000">(</font> string <font color="#008000">)</font> <font color="#008080">;</font> </li><li></li><li>  sources.  <font color="#007788">append</font> <font color="#008000">(</font> source <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> </li><li>  <font color="#0000ff">if</font> <font color="#008000">(</font> <font color="#000040">!</font> sources. <font color="#007788">isEmpty</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> </li><li>  metaInformationResolver <font color="#000040">-</font> <font color="#000080">&gt;</font> setCurrentSource <font color="#008000">(</font> sources. <font color="#007788">at</font> <font color="#008000">(</font> index <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> </li></ol></blockquote><br><br><h5>  Download selected song </h5><br>  To download a song, you need to select it and click Download at the top of the program window, a dialog will appear in which you need to choose a place to download the file, naturally you should have rights to create (write) a file. <br>  The button click signal is connected to the MainWindow :: slotDownload () slot. <br><img src="https://habrastorage.org/getpro/habr/post_images/fd1/28a/057/fd128a0573555bb0fb3a813fd8a336ed.jpg" alt="image"><br><blockquote><ol><li>  <font color="#0000ff">void</font> MainWindow <font color="#008080">::</font> <font color="#007788">slotDownload</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  QString path <font color="#000080">=</font> QFileDialog <font color="#008080">::</font> <font color="#007788">getExistingDirectory</font> <font color="#008000">(</font> <font color="#0000dd">this</font> , <font color="#FF0000">"Save to ..."</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li></li><li>  <font color="#0000ff">if</font> <font color="#008000">(</font> <font color="#000040">!</font> path. <font color="#007788">isEmpty</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  m_file <font color="#000080">=</font> <font color="#0000dd">new</font> QFile <font color="#008080">;</font> </li><li>  <font color="#0000ff">int</font> item <font color="#000080">=</font> musicTable <font color="#000040">-</font> <font color="#000080">&gt;</font> currentRow <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  Phonon <font color="#008080">::</font> <font color="#007788">MediaSource</font> src <font color="#000080">=</font> sources.  <font color="#007788">at</font> <font color="#008000">(</font> item <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  m_pSrcUrl <font color="#000080">=</font> <font color="#0000dd">new</font> QUrl <font color="#008000">(</font> src. <font color="#007788">url</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  m_file <font color="#000040">-</font> <font color="#000080">&gt;</font> setFileName <font color="#008000">(</font> path <font color="#000040">+</font> <font color="#FF0000">"/"</font> <font color="#000040">+</font> musicTable <font color="#000040">-</font> <font color="#000080">&gt;</font> item <font color="#008000">(</font> item, musicTable <font color="#000040">-</font> <font color="#000080">&gt;</font> currentColumn <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#000040">-</font> <font color="#000080">&gt;</font> text <font color="#008000">(</font> <font color="#008000">)</font> <font color="#000040">+</font> <font color="#FF0000">".mp3"</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li></li><li>  <font color="#0000ff">if</font> <font color="#008000">(</font> m_file <font color="#000040">-</font> <font color="#000080">&gt;</font> open <font color="#008000">(</font> QIODevice <font color="#008080">::</font> <font color="#007788">ReadWrite</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  m_pTcpSocket <font color="#000080">=</font> <font color="#0000dd">new</font> QTcpSocket <font color="#008000">(</font> <font color="#0000dd">this</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li></li><li>  m_pTcpSocket <font color="#000040">-</font> <font color="#000080">&gt;</font> connectToHost <font color="#008000">(</font> m_pSrcUrl <font color="#000040">-</font> <font color="#000080">&gt;</font> host <font color="#008000">(</font> <font color="#008000">)</font> , <font color="#0000dd">80</font> , QIODevice <font color="#008080">::</font> <font color="#007788">ReadWrite</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  connect <font color="#008000">(</font> m_pTcpSocket, SIGNAL <font color="#008000">(</font> connected <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> , <font color="#0000dd">this</font> , SLOT <font color="#008000">(</font> slotConnected <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  connect <font color="#008000">(</font> m_pTcpSocket, SIGNAL <font color="#008000">(</font> readyRead <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> , <font color="#0000dd">this</font> , SLOT <font color="#008000">(</font> slotReadyRead <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  connect <font color="#008000">(</font> m_pTcpSocket, SIGNAL <font color="#008000">(</font> error <font color="#008000">(</font> QAbstractSocket <font color="#008080">::</font> <font color="#007788">SocketError</font> <font color="#008000">)</font> <font color="#008000">)</font> , </li><li>  <font color="#0000dd">this</font> , SLOT <font color="#008000">(</font> slotDownloadError <font color="#008000">(</font> QAbstractSocket <font color="#008080">::</font> <font color="#007788">SocketError</font> <font color="#008000">)</font> <font color="#008000">)</font> </li><li>  <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  connect <font color="#008000">(</font> m_pTcpSocket, SIGNAL <font color="#008000">(</font> disconnected <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> , <font color="#0000dd">this</font> , SLOT <font color="#008000">(</font> slotDisconnected <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> <font color="#0000ff">else</font> </li><li>  QMessageBox <font color="#008080">::</font> <font color="#007788">warning</font> <font color="#008000">(</font> <font color="#0000dd">this</font> , <font color="#FF0000">"Warning"</font> , <font color="#FF0000">"File open Err!"</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> </li><li></li><li>  <font color="#008000">}</font> </li></ol></blockquote><br>  After choosing a directory and successfully opening (creating) a file of a song that has not yet been downloaded, you need to send a request to the VC server to ‚Äúgive‚Äù the song to us.  This will help us QtcpSocket which implements and greatly simplifies working with TCP / IP.  After successfully connecting to the VC server, send an HTTP request to it: <br><blockquote><ol><li>  <font color="#0000ff">void</font> MainWindow <font color="#008080">::</font> <font color="#007788">slotConnected</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  m_pTcpSocket <font color="#000040">-</font> <font color="#000080">&gt;</font> write <font color="#008000">(</font> QString <font color="#008000">(</font> <font color="#FF0000">"GET"</font> <font color="#000040">+</font> m_pSrcUrl <font color="#000040">-</font> <font color="#000080">&gt;</font> path <font color="#008000">(</font> <font color="#008000">)</font> <font color="#000040">+</font> <font color="#FF0000">" <font color="#000099">\ r</font> <font color="#000099">\ n</font> "</font> <font color="#008000">)</font> . <font color="#007788">toAscii</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> </li></ol></blockquote><br>  To which he gives us the contents of the song that we need to write to the file: <br><blockquote><ol><li>  <font color="#0000ff">void</font> MainWindow <font color="#008080">::</font> <font color="#007788">slotReadyRead</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  m_file <font color="#000040">-</font> <font color="#000080">&gt;</font> write <font color="#008000">(</font> m_pTcpSocket <font color="#000040">-</font> <font color="#000080">&gt;</font> read <font color="#008000">(</font> m_pTcpSocket <font color="#000040">-</font> <font color="#000080">&gt;</font> bytesAvailable <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> </li></ol></blockquote><br>  After the VC returns the entire contents of the song, it closes the connection, and it remains for us to close the file. <br><blockquote><ol><li>  <font color="#0000ff">void</font> MainWindow <font color="#008080">::</font> <font color="#007788">slotDisconnected</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">{</font> </li><li>  m_file <font color="#000040">-</font> <font color="#000080">&gt;</font> close <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  m_pTcpSocket <font color="#000040">-</font> <font color="#000080">&gt;</font> close <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> </li><li>  <font color="#008000">}</font> </li></ol></blockquote><br><br>  As promised, at the beginning of the article, the link to the repository ( <a href="http://ru.wikipedia.org/wiki/Mercurial">Mercurial</a> ): <a href="https://bitbucket.org/denis_medved/vkaudio">https://bitbucket.org/denis_medved/vkaudio</a> <br>  Many thanks to Max Schlee and bhv for the wonderful book ‚ÄúQt 4.5: Professional C ++ programming‚Äù and of course to the entire open community. <br><br>  <b>upd</b> : <br>  Instead of outdated QHttp and QTcpSocket, QNetworkAccessManager is used. </div><p>Source: <a href="https://habr.com/ru/post/115397/">https://habr.com/ru/post/115397/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../115392/index.html">Attention, designers! Evernote starts a 100,000 T-shirt contest. The main prize is 100,000 rubles.</a></li>
<li><a href="../115393/index.html">Beyond HTML5: Database API and IndexedDB Path</a></li>
<li><a href="../115394/index.html">Application of fuzzy search algorithms in PHP</a></li>
<li><a href="../115395/index.html">Perl :: Critic + Subversion = implementation of common coding practices in the team</a></li>
<li><a href="../115396/index.html">Facebook Stock Exchange</a></li>
<li><a href="../115398/index.html">Do it yourself: register Ltd.</a></li>
<li><a href="../115399/index.html">The craftsman created a working laser gun</a></li>
<li><a href="../115400/index.html">The latest news from the World is Me network.</a></li>
<li><a href="../115401/index.html">Pi in programming languages</a></li>
<li><a href="../115403/index.html">Seven aspects of how Github changed the world of open source</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>