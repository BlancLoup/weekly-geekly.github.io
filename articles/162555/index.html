<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Testing the nodejs application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Last time I wrote about creating a nodejs application using expressjs as a framework and jade as a template engine. This time I want to dwell on testi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Testing the nodejs application</h1><div class="post__text post__text-html js-mediator-article">  Last <a href="http://habrahabr.ru/post/161943/">time</a> I wrote about creating a nodejs application using expressjs as a framework and jade as a template engine.  This time I want to dwell on testing the server side. <br><br>  For tests we will use: <br>  - <a href="http://visionmedia.github.com/mocha/">Mocha</a> - a framework that allows you to write tests and run easily.  Generates reports in various ways, as well as being able to create documentation from tests. <br>  - <a href="https://github.com/visionmedia/should.js/">Should</a> - library for tests in the style of "approval" <sub>(I did not find the correct name)</sub> <br>  - <a href="https://github.com/visionmedia/supertest">SuperTest</a> - library for testing HTTP servers on nodejs <br>  - <a href="http://siliconforks.com/jscoverage/">jscoverage</a> - to assess code coverage tests <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I did not write everything from scratch, but decided to wrap the <a href="https://github.com/zxcabs/4fun/tree/master/express/app1">application</a> from the previous article in the tests, completely copying it into the app2 folder. <br><br>  First of all, add the modules we need to the package.json file.  We will need: mocha, should, supertest. <br><div class="spoiler">  <b class="spoiler_title">package.json</b> <div class="spoiler_text"><pre><code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"app2"</span></span>, <span class="hljs-string"><span class="hljs-string">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.0.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"author"</span></span>: <span class="hljs-string"><span class="hljs-string">"Evgeny Reznichenko &lt;kusakyky@gmaill.com&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"dependencies"</span></span>: { <span class="hljs-string"><span class="hljs-string">"express"</span></span>: <span class="hljs-string"><span class="hljs-string">"3"</span></span>, <span class="hljs-string"><span class="hljs-string">"jade"</span></span>: <span class="hljs-string"><span class="hljs-string">"*"</span></span>, <span class="hljs-string"><span class="hljs-string">"should"</span></span>: <span class="hljs-string"><span class="hljs-string">"*"</span></span>, <span class="hljs-string"><span class="hljs-string">"mocha"</span></span>: <span class="hljs-string"><span class="hljs-string">"*"</span></span>, <span class="hljs-string"><span class="hljs-string">"supertest"</span></span>: <span class="hljs-string"><span class="hljs-string">"*"</span></span> } }</code> </pre> </div></div><br>  Run the <b>npm i</b> command to install all required modules. <br>  And install jscoverage (under Ubuntu <b>sudo apt-get install jscoverage</b> ). <br><br>  Next, create a lib directory in the root of the project and copy our app.js there, it is necessary to cover all the scripts with tests for coverage. <br>  Let's edit the app.js file so that it exports our server to the outside, and in the root of the project we will create an index.js file that will connect the server and hang it on the socket.  And do not forget to correct the path to the views and public directories. <br>  It should turn out like this: <br><div class="spoiler">  <b class="spoiler_title">index.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> app = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./lib/app.js'</span></span>); app.listen(<span class="hljs-number"><span class="hljs-number">3000</span></span>);</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">lib / app.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> express = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'express'</span></span>), jade = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'jade'</span></span>), fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>), app = express(), viewOptions = { <span class="hljs-attr"><span class="hljs-attr">compileDebug</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">self</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }; <span class="hljs-comment"><span class="hljs-comment">//data var db = { users: [ { id: 0, name: 'Jo', age: 20, sex: 'm' }, { id: 1, name: 'Bo', age: 19, sex: 'm' }, { id: 2, name: 'Le', age: 18, sex: 'w' }, { id: 10, name: 'NotFound', age: 18, sex: 'w' } ], titles: { '/users': ' ', '/users/profile': ' ' } }; //utils function merge(a, b) { var key; if (a &amp;&amp; b) { for (key in b) { a[key] = b[key]; } } return a; } //App settings app.set('views', __dirname + '/../views'); app.set('view engine', 'jade'); app.set('title', ' '); app.locals.compileDebug = viewOptions.compileDebug; app.locals.self = viewOptions.self; app.use(express.static(__dirname + '/../public')); app.use(app.router); app.use(function (req, res, next) { next('not found'); }); //error app.use(function (err, req, res, next) { if (/not found/i.test(err)) { res.locals.title = '  :('; res.render('/errors/notfound'); } else { res.locals.title = ''; res.render('/errors/error'); } }); app.use(express.errorHandler()); //routes //  app.all('*', function replaceRender(req, res, next) { var render = res.render, view = req.path.length &gt; 1 ? req.path.substr(1).split('/'): []; res.render = function(v, o) { var data, title = res.locals.title; res.render = render; res.locals.title = app.get('title') + (title ? ' - ' + title: ''); //         //  if ('string' === typeof v) { if (/^\/.+/.test(v)) { view = v.substr(1).split('/'); } else { view = view.concat(v.split('/')); } data = o; } else { data = v; } // res.locals      //     (res.locals.title) data = merge(data || {}, res.locals); if (req.xhr) { //     json res.json({ data: data, view: view.join('.') }); } else { //   ,    // (   history api) data.state = JSON.stringify({ data: data, view: view.join('.') }); //    .       . view[view.length - 1] = '_' + view[view.length - 1]; //   res.render(view.join('/'), data); } }; next(); }); //   app.all('*', function loadPageTitle(req, res, next) { res.locals.title = db.titles[req.path]; next(); }); app.get('/', function(req, res){ res.render('index'); }); app.get('/users', function(req, res){ var data = { users: db.users }; res.render('index', data); }); app.get('/users/profile', function(req, res, next){ var user = db.users[req.query.id], data = { user: user }; if (user) { res.render(data); } else { next('Not found'); } }); // function loadTemplate(viewpath) { var fpath = app.get('views') + viewpath, str = fs.readFileSync(fpath, 'utf8'); viewOptions.filename = fpath; viewOptions.client = true; return jade.compile(str, viewOptions).toString(); } app.get('/templates', function(req, res) { var str = 'var views = { ' + '"index": (function(){ return ' + loadTemplate('/index.jade') + ' }()),' + '"users.index": (function(){ return ' + loadTemplate('/users/index.jade') + ' }()),' + '"users.profile": (function(){ return ' + loadTemplate('/users/profile.jade') + ' }()),' + '"errors.error": (function(){ return ' + loadTemplate('/errors/error.jade') + ' }()),' + '"errors.notfound": (function(){ return ' + loadTemplate('/errors/notfound.jade') + ' }())' + '};' res.set({ 'Content-type': 'text/javascript' }).send(str); }); module.exports = app;</span></span></code> </pre><br></div></div><br><br>  Let's take a look at the app.js file, the division into three logical parts clearly suggests itself: <br>  - In the first part we take out all the logic of working with data models <br>  - In the second part, all the auxiliary utilities, now we only have the function <b>merge</b> <br>  - The third will be the server itself <br><br>  We have decided on our desires, we will start writing tests, but first we will write a Makefile for the convenience of running the tests and place it in the project root. <br><div class="spoiler">  <b class="spoiler_title">Makefile</b> <div class="spoiler_text"><pre> <code class="bash hljs">MOCHA = ./node_modules/.bin/mocha <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>: @NODE_ENV=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span> $(MOCHA) \ -r should \ -R spec .PHONY: <span class="hljs-built_in"><span class="hljs-built_in">test</span></span></code> </pre><br></div></div><br>  - -r - indicates that Mocha should include the library should <br>  - -R - indicates in what form we want to see test reports.  There are several types of reports, this will look something like this: <br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/storage2/30d/353/641/30d35364193c74fb5d0e2587d26676e5.jpg"><br></div></div><br><br><h5>  Testing Tulses </h5><br>  By default, Mocha runs tests from the test directory, so we will create such a directory and write our first test. <br>  And we will start testing with our "tools", we will make a small plan. <br>  - In the "tools" should be a function merge <br>  - The merge function should merge two objects into one <br>  - And the object that is transmitted first must be expanded, the second object <br>  - The function should not change the second object. <br><br>  BDD tests in Mocha begin with the <b>describe ()</b> block <b>;</b>  , the tests themselves are written in <b>it ()</b> blocks <b>;</b>  they must be located inside the describe () block.  Any nesting of describe () blocks in each other is allowed.  Hooks are also available: before (), after (), beforeEach (), and afterEach ().  Hooks must also be described inside the describe () block.  I will tell you more about hooks when we test our models for working with fake databases. <br><br>  In the test directory, create a file tools.js and write a test for tools.merge. <br><div class="spoiler">  <b class="spoiler_title">test / tools.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tools = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../lib/tools/index.js'</span></span>); describe(<span class="hljs-string"><span class="hljs-string">'tools'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ""    merge it('should be have #merge', function () { tools.should.be.have.property('merge'); tools.merge.should.be.a('function'); }); describe('#merge', function () { // merge       it('should merged', function () { var a = { foo: '1' }, b = { bar: '2' }; tools.merge(a, b).should.eql({ foo: '1', bar: '2' }); }); //      ,   it('should be extend', function () { var a = { foo: '1' }, b = { bar: '2' }; tools.merge(a, b); //   ,    //     a.should.not.equal({ foo: '1', bar: '2' }); a.should.equal(a); }); //      it('should not be extended', function () { var a = { foo: '1' }, b = { bar: '2' }; tools.merge(a, b); b.should.not.eql({ foo: '1', bar: '2' }); }); }); });</span></span></code> </pre><br></div></div><br>  If we start the test now, we will fall with an error even at the stage of connecting the tools module, which is normal, we don‚Äôt have this module yet.  Create a file lib / tools / index.js and transfer the code of the function <b>merge</b> from lib / app.js there. <br>  Run the <b>make test</b> and see that all four tests are inundated, <br><div class="spoiler">  <b class="spoiler_title">picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/storage2/ff9/54d/3f5/ff954d3f5abe0cbf5bcd0fadcf7f5e37.jpg"><br></div></div><br>  because  the very first test is filled up; it becomes clear that the function merge is not exported from the tools module.  Add export and run the tests again, now everything should be fine. <br><br>  Before proceeding with further testing of the rest of the application, add tests for coverage. <br>  Let's add jscoverage launch with parameters <b>--encoding = utf8</b> and <b>--no-highlight</b> specify <b>lib</b> as the incoming directory, and specify <b>lib-cov</b> as the outgoing directory.  Now we <b>‚Äôll</b> add Mocha launch for coverage tests, set the <b>COVERAGE = 1</b> environment variable as the reporter and specify <b>html-cov</b> to get a nice html page with the results of the coverage tests. <br><div class="spoiler">  <b class="spoiler_title">Makefile</b> <div class="spoiler_text"><pre> <code class="bash hljs">MOCHA = ./node_modules/.bin/mocha <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>: @NODE_ENV=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span> $(MOCHA) \ -r should \ -R spec <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-cov: lib-cov @COVERAGE=1 $(MOCHA) \ -r should \ -R html-cov &gt; coverage.html lib-cov: clear @jscoverage --encoding=utf8 --no-highlight lib lib-cov clear: @rm -rf lib-cov coverage.html .PHONY: <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-cov clear</code> </pre><br></div></div><br>  Let's return to our test and at the very top replace the line: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tools = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../lib/tools/index.js'</span></span>);</code> </pre><br>  on <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tools = process.env.COVERAGE ? <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../lib-cov/tools/index.js'</span></span>) : <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../lib/tools/index.js'</span></span>);</code> </pre><br>  Everything.  Now we can run <b>make test-cov</b> .  The coverage.html file will appear in the project root, with the results of the coverage test, the file is self-sufficient and can be immediately opened in the browser. <br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/storage2/763/3a7/345/7633a7345f6b1bd4f1a498044fc31d87.jpg"><br></div></div><br>  Red will be shown lines in which there was not a single approach, which means that this place is not covered by tests.  It also provides general statistics of test coverage in percent for each file. <br><br>  Great, the testing environment is set up, it remains to write tests for the database and the server. <br><br><h5>  We test work with base </h5><br>  We write the code to test our models.  First, we define the functionality. <br>  1) We should have two models User and UserList <br>  2) The User model must have methods: <br>  - find - the function returns a list of users with an object of type UserList, even if there is nothing <br>  - findById - the function should search for the user by ID and return the result as a User object, or nothing if there is no user with this ID <br>  - save - the function should save the user, returns err in case of an error <br>  - toJSON - the function returns causes an object of type User to json <br>  3) The UserList model should have only the toJSON method <br><div class="spoiler">  <b class="spoiler_title">Test code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> should = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'should'</span></span>), db = process.env.COVERAGE ? <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../lib-cov/models/db.js'</span></span>) : <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../lib/models/db.js'</span></span>), models = process.env.COVERAGE ? <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../lib-cov/models/index.js'</span></span>) : <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../lib/models/index.js'</span></span>), User = models.User, UserList = models.UserList; describe(<span class="hljs-string"><span class="hljs-string">'models'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      //   "describe('models')" before(function () { db.regen(); }); //    User it('should be have User', function () { models.should.be.have.property('User'); models.User.should.be.a('function'); }); //    UserList it('should be have UserList', function () { models.should.be.have.property('UserList'); models.UserList.should.be.a('function'); }); //  User describe('User', function () { // User    find it('should be have #find', function () { User.should.be.have.property('find'); User.find.should.be.a('function'); }); // User    findById it('should be have #findById', function () { User.should.be.have.property('findById'); User.findById.should.be.a('function'); }); // User    save it('should be have #save', function () { User.prototype.should.be.have.property('save'); User.prototype.save.should.be.a('function'); }); // User    toJSON it('should be have #toJSON', function () { User.prototype.should.be.have.property('toJSON'); User.prototype.toJSON.should.be.a('function'); }); describe('#find', function () { //find   UserList it('should be instanceof UserList', function (done) { User.find(function (err, list) { if (err) return done(err); list.should.be.an.instanceOf(UserList); done(); }); }); //find   UserList,     it('should not be exist', function (done) { //  db.drop(); User.find(function (err, list) { //  db.generate(); if (err) return done(err); list.should.be.an.instanceOf(UserList); done(); }); }); }); describe('#findById', function () { //findById     User it('should be instanceof User', function (done) { User.findById(0, function (err, user) { if (err) return done(err); user.should.be.an.instanceOf(User); done(); }); }); //findById   ,     it('should not be exists', function (done) { User.findById(100, function (err, user) { if (err) return done(err); should.not.exist(user); done(); }); }); }); describe('#save', function () { //save   ,     it('should not be saved', function (done) { var user = new User({ name: 'New user', age: 0, sex: 'w' }); user.save(function (err) { err.should.eql('Invalid age'); done(); }); }); //  ,       it('should be saved', function (done) { var newuser = new User({ name: 'New user', age: 2, sex: 'w' }); newuser.save(function (err) { if (err) return done(err); User.findById(newuser.id, function (err, user) { if (err) return done(err); user.should.eql(newuser); done(); }); }); }); }); describe('#toJSON', function () { //toJSON   json   it('should be return json', function (done) { User.findById(0, function (err, user) { if (err) return done(err); user.toJSON().should.be.eql({ id: 0, name: 'Jo', age: 20, sex: 'm' }); done(); }); }); }); }); describe('UserList', function () { //UserList    toJSON it('should be have #toJSON', function () { UserList.prototype.should.be.have.property('toJSON'); UserList.prototype.toJSON.should.be.a('function'); }); }); });</span></span></code> </pre><br></div></div><br>  The code is supplied with comments, therefore I will stop only on the separate moments. <br><pre> <code class="javascript hljs"> before(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ db.regen(); });</code> </pre><br>  This code will be called once at the start of testing.  Here you can connect to the database and fill in the test data, we do not have a real database, so we call only the regen method, which initializes our database with test data. <br>  It is worth paying attention to the fact that the work with the database is carried out in an asynchronous style; when testing asynchronous methods, we must call the <b>done ()</b> method after completing the testing of the block;  A piece of code for clarity: <br><pre> <code class="javascript hljs">... <span class="hljs-comment"><span class="hljs-comment">//find   UserList it('should be instanceof UserList', function (done) { User.find(function (err, list) { if (err) return done(err); list.should.be.an.instanceOf(UserList); done(); }); }); ...</span></span></code> </pre><br><br>  Now we will start implementation.  Let's create in the lib directory, the models directory, where our functionality for working with models will be implemented: <br><div class="spoiler">  <b class="spoiler_title">models / db.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* *    */</span></span> <span class="hljs-comment"><span class="hljs-comment">//  var users = []; exports.users = users; //     exports.regen = function () { exports.drop(); exports.generate(); }; exports.drop = function () { //    , //      users.splice(0, users.length); }; exports.generate = function () { //  users.push({ id: 0, name: 'Jo', age: 20, sex: 'm' }); users.push({ id: 1, name: 'Bo', age: 19, sex: 'm' }); users.push({ id: 2, name: 'Le', age: 18, sex: 'w' }); users.push({ id: 10, name: 'NotFound', age: 18, sex: 'w' }); }; //   exports.generate();</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">models / user.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> util = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'util'</span></span>), db = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./db.js'</span></span>), UserList = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./userlist.js'</span></span>), users = db.users; <span class="hljs-comment"><span class="hljs-comment">/* *   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> User = <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">User</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">opt</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.id = users.length; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.name = opt.name; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.age = opt.age; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sex = opt.sex; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.isNew = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* *        */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadFromObj</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(obj); user.id = obj.id; user.isNew = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> user; } <span class="hljs-comment"><span class="hljs-comment">/* *       */</span></span> User.find = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fn</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i, l = users.length, list; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (l) { list = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserList(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>, l; l &gt; i; i += <span class="hljs-number"><span class="hljs-number">1</span></span>) { list.push(loadFromObj(users[i])); } } fn(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, list); }; <span class="hljs-comment"><span class="hljs-comment">/* *    id */</span></span> User.findById = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id, fn</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> obj = users[id], user; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obj) { user = loadFromObj(obj); } fn(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, user); }; <span class="hljs-comment"><span class="hljs-comment">/* *  */</span></span> User.prototype.save = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fn</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> err; <span class="hljs-comment"><span class="hljs-comment">//    if (Number.isFinite(this.age) &amp;&amp; this.age &gt; 0 &amp;&amp; this.age &lt; 150) { if (this.isNew) { users.push(this.toJSON()); this.isNew = false; } else { users[this.id] = this.toJSON(); } } else { err = 'Invalid age'; } fn(err); }; User.prototype.toJSON = function () { var json = { id: this.id, name: this.name, age: this.age, sex: this.sex }; return json; };</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">models / userlist.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> util = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'util'</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* * UserList -  ,   Array */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> UserList = <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UserList</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>.apply(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) } util.inherits(UserList, <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>); UserList.prototype.toJSON = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i, l = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.length, arr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(l); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; l &gt; i; i += <span class="hljs-number"><span class="hljs-number">1</span></span>) { arr[i] = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[i].toJSON(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> arr; };</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">models / index.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs">exports.User = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./user.js'</span></span>); exports.UserList = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./userlist.js'</span></span>);</code> </pre><br></div></div><br><br>  We will tweak the lib / app.js code by adding the User model connection to it and will carry out all work with users through it. <br><div class="spoiler">  <b class="spoiler_title">lib / app.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ... User = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./models/index.js'</span></span>).User, ... ... app.get(<span class="hljs-string"><span class="hljs-string">'/users'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">)</span></span>{ User.find(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, users</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) { next(err); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { res.render(<span class="hljs-string"><span class="hljs-string">'index'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">users</span></span>: users.toJSON() }); } }); }); app.get(<span class="hljs-string"><span class="hljs-string">'/users/profile'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id = req.query.id; User.findById(id, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, user</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user) { res.render({ <span class="hljs-attr"><span class="hljs-attr">user</span></span>: user.toJSON() }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { next(<span class="hljs-string"><span class="hljs-string">'Not found'</span></span>); } }); }); ...</code> </pre><br></div></div><br><br><h5>  Testing the application </h5><br>  The last part not covered with tests remains.  This is directly http server.  Honestly, I decided to sham and test only four situations here: <br>  1) The answer should come in html if this is a normal request. <br>  2) The answer should come to json if it is an Ajax <br>  3) GET request to the site root should return the page / object, where the title contains the value 'My site' <br>  Thanks to the supertest library, writing such tests is easy and simple: <br><div class="spoiler">  <b class="spoiler_title">test / app.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'supertest'</span></span>), app = process.env.COVERAGE ? <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../lib-cov/app.js'</span></span>) : <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../lib/app.js'</span></span>); describe(<span class="hljs-string"><span class="hljs-string">'Response html or json'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   ,   //   html it('should be responded as html', function (done) { request(app) .get('/') .expect('Content-Type', /text\/html/) .expect(200, done); }); //  ,   json it('should be responded as json', function (done) { request(app) .get('/') .set('X-Requested-With', 'XMLHttpRequest') .expect('Content-Type', /application\/json/) .expect(200, done); }); }); describe('GET /', function () { //  title ===   it('should be included title', function (done) { request(app) .get('/') .end(function (err, res) { if (err) return done(err); res.text.should.include('&lt;title&gt; &lt;/title&gt;'); done(); }); }); //  title ===   it('should be included title', function (done) { request(app) .get('/') .set('X-Requested-With', 'XMLHttpRequest') .end(function (err, res) { if (err) return done(err); res.body.should.have.property('data'); res.body.data.should.have.property('title', ' '); done(); }); }); });</span></span></code> </pre><br></div></div><br>  In request (), we must pass an instance of http. Server or a function that executes the request.  SuperTest uses <a href="https://github.com/visionmedia/superagent">SuperAgent</a> to communicate with the server, so you can use all its capabilities to form requests to the server.  Responses can be <b>checked</b> in <b>expect ()</b> functions or directly as a result of a request by passing a handler function to <b>end ()</b> . <br><br><h5>  Conclusion </h5><br>  It‚Äôs just so easy (and even necessary) to write tests for our applications.  Even in my small sample code for tests, it turned out more than the code itself, but even these tests are not complete and, for example, the tests do not cover the error when we create two users at the same time and save them.  Although coverage tests show that the User model is covered with tests in the place where the new user is saved. <br>  Therefore, the tests themselves are not a panacea, the tests must be written correctly and you need to understand the little things, and test exactly the places that can cause problems. <br><br>  Code is available on <a href="https://github.com/zxcabs/4fun/tree/master/nodejs/express/app2">github'e</a> </div><p>Source: <a href="https://habr.com/ru/post/162555/">https://habr.com/ru/post/162555/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../162545/index.html">Official sales of iPad mini and iPhone 5 begin in Russia</a></li>
<li><a href="../162547/index.html">Ruby Science: thoughtbot's guide to creating quality applications in Ruby on Rails</a></li>
<li><a href="../162549/index.html">Born in the USSR</a></li>
<li><a href="../162551/index.html">Programming on OpenGl (freeglut), drawing primitives</a></li>
<li><a href="../162553/index.html">Support for Windows Phone 7.x will end in 2014</a></li>
<li><a href="../162561/index.html">Tale about how we tied subscribers to the ports</a></li>
<li><a href="../162563/index.html">Introvert, programmer, introvert programmer</a></li>
<li><a href="../162567/index.html">What is in my crater?</a></li>
<li><a href="../162569/index.html">Getting rid of the dampness of a startup (project) with the help of Persona, Concept Map and Customer Journey Map</a></li>
<li><a href="../162571/index.html">ETERNUS DX - disk arrays, what is inside. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>