<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unusual hard disk overflow or how to delete millions of files from one folder</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 Most likely, the article will not be very interesting for experienced system administrators. First of all, it focuses on newbies, as well a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unusual hard disk overflow or how to delete millions of files from one folder</h1><div class="post__text post__text-html js-mediator-article"><h4>  Foreword </h4><br>  Most likely, the article will not be very interesting for experienced system administrators.  First of all, it focuses on newbies, as well as on people who have encountered a similar problem - the need to delete a huge number of files from one folder on Linux (Debian in my case), as well as ended disk space when df -h issues which is almost 30% free. <br><a name="habracut"></a><br><h4>  Start </h4><br>  Nothing foreshadowed trouble. <br>  The server has been working without any problems for more than a year (uptime almost 500 days), there were no problems, and I calmly went on vacation with a pure soul. <br><br>  On the first day of vacation, they call me with a complaint - the site is unavailable.  MySQL crashes with Error 28 ‚ÄúNo space left on device‚Äù. <br><br>  It would seem that the problem is banal - the disk space is over.  True, df -h shows that the disk has a sufficient amount of free space, well, I'm on vacation, I‚Äôm too lazy to sort it out - I advised them to look for unnecessary files on the disk (old backups, etc.) and delete them.  Removed, it seems everything worked. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A couple of hours passed and the problem returned.  Strange - the free space on the hard disk during this time almost did not decrease.  After a quick googling, a <a href="http://serverfault.com/questions/399068/got-error-28-from-storage-engine-disk-full-but-my-disk-are-not-full">topic appeared on the serverfault</a> , which states that the problem may also arise due to the fact that it was not disk space, but <a href="http://ru.wikipedia.org/wiki/Inode">inodes</a> ! <br><br>  I enter <code>df -i</code> into the console - and it turns out really that I have ended my inodes. <br><br><h4>  Problem </h4><br>  I started looking for where I have so many files on my hard drive that they have devoured all the inodes (and I have over 30 million inins on a 500-gigabyte hard drive). <br><br>  And I found it - it turned out that the <b>problem was in the folder with the php sessions</b> . <br><br>  Apparently, for some reason, the auto-cleaning mechanism of this folder broke, which led to the accumulation of a huge number of files in it.  How huge is difficult to say, because no standard Linux commands, such as ls, find, rm, etc.  - do not work with this folder.  Just hang, at the same time hanging the entire server.  I can only say that the directory file itself weighs about a gigabyte, and also that there are exactly more than half a million files there, because I have already deleted so much from there. <br><br><h4>  Decision </h4><br>  The solution is obvious - you need to delete all these session files.  In this case, it is desirable that the server continued to work in normal mode.  For starters, I renamed the sessions folder, which contains a bunch of files, and instead I created an empty one - so that I can delete all files from the old (renamed) file and that would not prevent the creation of new session files. <br><br>  Also in CZK added automatic deletion of session files older than one hour, so that the problem does not recur. <br><br>  And went to the main problem - cleaning the hard disk. <br><br>  I tried the solution "in the forehead": <br><pre> <code class="bash hljs">rm -rf ./*</code> </pre> <br>  The server hung, nothing was removed. <br><br>  I tried a known method to delete a large number of files. <br><pre> <code class="bash hljs">find . -<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> f -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm -v {} \;</code> </pre> <br><br>  Nothing, the server hangs, the files are not deleted. <br><br>  And now that the most interesting thing is that the file manager <code>mc</code> has successfully coped with the task of deleting these files!  That is, when you start deleting a folder - the files are deleted, mc does not hang.  Deletion goes at a speed of about 5,000 files per minute, although it creates a huge load on the hard disk, which leads to server inoperability. <br><br>  And I would like these files to be gradually deleted in the background, and do not interfere with the normal operation of the site. <br><br>  Actually, the solution was again found in Google - Olark <a href="http://www.olark.com/spw/2011/08/you-can-list-a-directory-with-8-million-files-but-not-with-ls/">shares the way</a> it displayed a list of 8 million files in 1 folder, using the <code>getdents</code> system call <br><br>  <a href="http://www.kernel.org/doc/man-pages/online/pages/man2/getdents.2.html">Here</a> is the documentation for the getdents function, as well as sample code that uses it. <br><br>  However, this example did not quite fit me - even if I put a large buffer size, as Olark advises in my blog, the server still hangs when trying to read the entire folder at once. <br><br>  Experimentally, I selected a buffer size of 30 kilobytes, which allows you to read about 550 file names from a directory, while not suspending the server and not creating unnecessary load on the disk.  He also rewrote the sample code a bit so that instead of displaying the file name, he deleted it. <br><br>  As a result, I got this code: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;dirent.h&gt; /* Defines DT_* constants */ #include &lt;fcntl.h&gt; #include &lt;stdio.h&gt; #include &lt;unistd.h&gt; #include &lt;stdlib.h&gt; #include &lt;sys/stat.h&gt; #include &lt;sys/syscall.h&gt; #define handle_error(msg) \ do { perror(msg); exit(EXIT_FAILURE); } while (0) struct linux_dirent { long d_ino; off_t d_off; unsigned short d_reclen; char d_name[]; }; #define BUF_SIZE 1024*30 int main(int argc, char *argv[]) { int fd, nread; char buf[BUF_SIZE]; struct linux_dirent *d; int bpos; int deleted; char d_type; char temp[100]; fd = open(argc &gt; 1 ? argv[1] : ".", O_RDONLY | O_DIRECTORY); if (fd == -1) handle_error("open"); deleted = 0; nread = syscall(SYS_getdents, fd, buf, BUF_SIZE); if (nread == -1) handle_error("getdents"); if (nread != 0) { for (bpos = 0; bpos &lt; nread;) { d = (struct linux_dirent *) (buf + bpos); d_type = *(buf + bpos + d-&gt;d_reclen - 1); if(d-&gt;d_ino &amp;&amp; d-&gt;d_ino != 22332748 &amp;&amp; d-&gt;d_ino != 22332761) { //    inode      ,       "."  ".." -  ,     sprintf(temp,"%s/%s", argv[1], (char *) d-&gt;d_name); remove(temp); deleted += 1; } bpos += d-&gt;d_reclen; } } printf("deleted %d\n", deleted); exit(EXIT_SUCCESS); }</span></span></span></span></code> </pre><br><br>  The code is compiled by the usual gcc <br><pre> <code class="bash hljs">gcc listdir.c -o listdir</code> </pre> <br><br>  And just run from the command line: <br><pre> <code class="bash hljs">./listdir mod-tmp2</code> </pre> <br><br>  I put the resulting file in crowns and now I have 547 files per minute deleted, while the server load is within the normal range - and I hope that within a week or two all the files will be deleted. <br><br><h4>  findings </h4><br><ol><li>  If <code>df -h</code> indicates that there is still room on the hard disk - it may not be there.  We must also look <code>df -i</code> </li><li>  You shouldn‚Äôt hope for auto-cleaning mechanisms for such things as session files - at some point they may not work and you‚Äôll end up with a whole mountain of files that you‚Äôll remove is not a trivial task. </li><li>  Standard Linux commands such as <code>ls, rm, find</code> , etc.  can pass in front of non-standard situations like millions of files in one folder.  In this case, use low-level system calls. </li></ol></div><p>Source: <a href="https://habr.com/ru/post/152193/">https://habr.com/ru/post/152193/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../152183/index.html">cat, awk and sed</a></li>
<li><a href="../152185/index.html">Yandex presents a new service for choosing clothes</a></li>
<li><a href="../152187/index.html">Steve Jobs Candidate</a></li>
<li><a href="../152189/index.html">Problems of the updated App Store</a></li>
<li><a href="../152191/index.html">Ubooly: plush toy with iphone instead of brain</a></li>
<li><a href="../152197/index.html">From search to selection</a></li>
<li><a href="../152205/index.html">The history of handheld computers in faces. Part 1</a></li>
<li><a href="../152209/index.html">One line of HTML code can delete data or reload Samsung phones</a></li>
<li><a href="../152211/index.html">The first forum of data center operators? Yes, this fall in St. Petersburg!</a></li>
<li><a href="../152217/index.html">External batteries for mobile devices</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>