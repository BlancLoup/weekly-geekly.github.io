<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Angular: authorization, refresh token and HttpInterceptor</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. 

 I will describe the authorization process using some authorization server and the HttpInterceptor interface, which became available from ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Angular: authorization, refresh token and HttpInterceptor</h1><div class="post__text post__text-html js-mediator-article">  Good day. <br><br>  I will describe the authorization process using some authorization server and the <a href="http/HttpInterceptor">HttpInterceptor</a> interface, which became available from Angular 4.3+.  With the help of the HttpInterceptor`a we will add our token to the Header of the request before sending each request.  Also, after the expiration of the token, getting a 401 error, we will recover the token and repeat requests that did not pass authorization while waiting for a refresh. <br><br><h4>  Let's start with the Interceptor configuration: </h4><br>  Prefer configuration with the main application module.  Or if your application is already large enough, I advise you to make configurations in CoreModule. <br>  In the article I will use the CoreModule, but you can do this in the root (usually the AppModule) application module, the differences are minor. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">While writing an article on angular.io resource on CoreModule disappeared</b> <div class="spoiler_text">  In short, this is a module that should contain global services.  The advantage is that this module is imported in the application module (AppModule).  All services exported by the Core module are guaranteed to have only one instance per application, including lazy loaded modules. <br></div></div><a name="habracut"></a><br><pre><code class="hljs bash">//core.module.ts //imports.... @NgModule({ providers: [ AuthService, { provide: HTTP_INTERCEPTORS, //  interceptor`   auth header useClass: ApplyTokenInterceptor, multi: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, { provide: HTTP_INTERCEPTORS, //     useClass: RefreshTokenInterceptor, multi: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } ], exports: [HttpClientModule] }) <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> class CoreModule { //@Optional() @SkipSelf() -      CoreModule  AppModule   UserModule -   constructor(@Optional() @SkipSelf() parentModule: CoreModule, userService: UserService, inj: Injector, auth: AuthService, http: HttpClient) { //     AuthInterceptor <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> interceptors = inj.get&lt;AuthInterceptor[]&gt;(HTTP_INTERCEPTORS) .filter(i =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> i.init; }); // http    . interceptors.forEach(i =&gt; i.init(http, auth)); userService.init(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parentModule) { //  ,    CoreModule      throw new Error( <span class="hljs-string"><span class="hljs-string">'CoreModule is already loaded. Import it in the AppModule only'</span></span>); } } }</code> </pre> <br>  Of course, using the AuthInterceptor interface is not necessary, because only the init method is interesting for us.  Just with the interface, we see the method arguments in the IDE and so there are guarantees that we will not get other Intercoptors that may not implement the init method, or implement but have a different signature. <br><br><pre> <code class="hljs kotlin">export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthInterceptor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(http: HttpClient, auth: AuthRefreshProvider); }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">About InjectionToken and how inj.get works (HTTP_INTERCEPTORS)</b> <div class="spoiler_text">  <a href="https://v4.angular.io/api/core/InjectionToken">InjectionToken</a> , who do not know about this useful thing - we are studying. <br><br>  If you are familiar with the principle of DI operation in strongly typed languages, then briefly provide: HTTP_INTERCEPTORS in the module decorator connects the interface with the implementation (useClass: <b>ApplyTokenInterceptor</b> in our case) and then we can get the instances of our implementations by specifying the HTTP_INTERCEPTORS constant as a parameter, besides specify interface type as a generic parameter: inj.get &lt;AuthInterceptor []&gt; (HTTP_INTERCEPTORS) <br>  Here is what the <a href="https://github.com/angular/angular/blob/5.2.8/packages/common/">HTTP_INTERCEPTORS</a> constant in <a href="https://habr.com/users/angular/" class="user_link">angular</a> / common / http is (this is a string + type based on which DI can return us the necessary instances): <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> HTTP_INTERCEPTORS = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InjectionToken&lt;HttpInterceptor[]&gt;(<span class="hljs-string"><span class="hljs-string">'HTTP_INTERCEPTORS'</span></span>);</code> </pre><br></div></div><br>  Why transfer HttpClient to the Interceptor from the module constructor in general if you can simply describe it in the Interceptor `a constructor or get an instance via the Injector? <br><br>  Initialization of our Interceptor `s takes place in the module just because we cannot directly implement the http service into the Interceptor`a constructor, we just get a cyclic dependency: <br><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@Injectable()</span></span> export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplyTokenInterceptor</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HttpInterceptor</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AuthInterceptor { //circular dependency Error! public constructor</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">private</span></span> http: HttpClient) { <span class="hljs-comment"><span class="hljs-comment">//.... } //.... }</span></span></code> </pre><br>  You can also make an attempt to use Injector and get an instance of the HttpClient service through it, but it will also not work if you do this in the constructor: <br><br><pre> <code class="hljs java"><span class="hljs-meta"><span class="hljs-meta">@Injectable</span></span>() export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplyTokenInterceptor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HttpInterceptor</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthInterceptor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">constructor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">private</span></span></span></span><span class="hljs-function"><span class="hljs-params"> injector: Injector)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//circular dependency Error! injector.get(HttpClient); } //.... }</span></span></code> </pre><br>  In addition, you cannot get an instance of other services that de-inject yourself HttpClient - like AuthService for example. <br><br><pre> <code class="hljs haskell">//auth.service.ts <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-type"><span class="hljs-type">AuthService</span></span> implements <span class="hljs-type"><span class="hljs-type">AuthRefreshProvider</span></span> { constructor(client: <span class="hljs-type"><span class="hljs-type">HttpClient</span></span>) { } } //apply.interceptor.ts <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-type"><span class="hljs-type">ApplyTokenInterceptor</span></span> implements <span class="hljs-type"><span class="hljs-type">HttpInterceptor</span></span>, <span class="hljs-type"><span class="hljs-type">AuthInterceptor</span></span> { //circular dependency <span class="hljs-type"><span class="hljs-type">Error</span></span>! ,  <span class="hljs-type"><span class="hljs-type">AuthService</span></span>    <span class="hljs-type"><span class="hljs-type">HttpClient</span></span> public constructor(private auth: <span class="hljs-type"><span class="hljs-type">AuthService</span></span> ) { } }</code> </pre><br><cut></cut><br>  By the way, the release of the second version of Angular is not far off, and in this version we will finally be able to implement HttpClient in the Interceptor! <br><br><div class="spoiler">  <b class="spoiler_title">where did this circular dependency Error come from!</b> <div class="spoiler_text"><blockquote><ul><li>  Previously, an interceptor of the interceptor attempting to interceptor interceptor instances.  Users want to inject HttpClient into interceptors to make supporting; </li><li>  Either HttpClient or Dependency.  This change moves that responsibility into HttpClient itself.  By utilizing a new class HttpInterceptingHandler, it‚Äôs possible that you‚Äôve no longer need it. </li></ul><br></blockquote><br></div></div><br>  If the idea with initialization inside the module is not impressive, but the ‚Äúextra if‚Äù is impressive, you can do it directly in the intercept method and not use the AuthInterceptor and Injector interface in the constructor of the CoreModule module at all. <br><br><pre> <code class="hljs java"><span class="hljs-meta"><span class="hljs-meta">@Injectable</span></span>() export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplyTokenInterceptor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HttpInterceptor</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthInterceptor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> http: HttpClient; constructor(<span class="hljs-keyword"><span class="hljs-keyword">private</span></span> injector: Injector) { } intercept(req: HttpRequest&lt;any&gt;, next: HttpHandler): Observable&lt;HttpEvent&lt;any&gt;&gt; { <span class="hljs-comment"><span class="hljs-comment">// HttpClient      if (!http) { this.http = injector.get(HttpClient); } } }</span></span></code> </pre><br>  Initializing our ApplyTokenInterceptor and RefreshTokenInterceptor on almost everything! <br><br>  Add one more initialization in CoreModule, refresh the token when the application is initialized, if the token has almost expired (for example, 60 seconds left) or completely expired, then why not update it immediately: <br><br><pre> <code class="hljs pgsql">@NgModule({ providers: [ AuthService, UserService, export <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> CoreModule { { provide: APP_INITIALIZER, //    : (a) =&gt; a.renewAuth() // ! renewAuth   Promise,   Observable .   //    //       ,    AOT  useFactory: refreshToken, deps: [AuthService], multi: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }, { provide: HTTP_INTERCEPTORS, useClass: ApplyTokenInterceptor, multi: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }, { provide: HTTP_INTERCEPTORS, useClass: RefreshTokenInterceptor, multi: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> } ], exports: [HttpClientModule] }) export <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> CoreModule { // <span class="hljs-keyword"><span class="hljs-keyword">some</span></span> code }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">APP_INITIALIZER</b> <div class="spoiler_text">  APP_INITIALIZER is our InjectionToken, in the depths of <a href="">Angular</a> (if you don‚Äôt want to source, here‚Äôs <a href="https://hackernoon.com/hook-into-angular-initialization-process-add41a6b7e">an article</a> ) there is a code that pulls out all APP_INITIALIZERs from DI and executes them at the loading stage (while we see loading ... for example). <br></div></div><br><br>  We describe our refresh factory.  Ideally, renewAuth () should return Promise, not Observable.  It will also work with Observable (but not correctly, you can not even notice right away), but I did a test that used Observable, it resolved on a timer (10s) and as a result the module was initialized before 10 seconds expired (this means our refresh the token can come after the preloader disappears, which is not correct).  I prefer to bring Observable to Promise in the factory (`export function refreshToken () {... return o.toPromise ();}`), so the rest of my code will still work with Observable, which is clearly more convenient than Promise. <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">refreshToken</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">auth: AuthService</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">// return own subject to complete this initialization step in any case // otherwise app will stay on preloader if any error while token refreshing occurred const subj = new Subject(); auth.renewAuth() .finally(() =&gt; { subj.complete(); }) .catch((err, caught: Observable&lt;any&gt;) =&gt; { // do logout, redirect to login will occurs at UserService with onLoggedOut event auth.logout(); return ErrorObservable.create(err); }) .subscribe(); // need to return Promise!! return subj.toPromise(); }; }</span></span></code> </pre><br><br>  Another important point!  Of course there is a possibility that Refresh token may expire, or it may be revoked by the administrator.  In this case, the request will return an error, and the initialization process will be interrupted and the user will hang on the preloader.  Therefore, in addition to the need to return Promise, we will also return our own Subject that will be completed in any case, but if an error occurs we will make a logout and if you need a redirect to the login.  The approach with the complit can be useful in many other initialization processes. <br><br>  It is necessary to check the token for ‚Äúfreshness‚Äù in <b>renewAuth ()</b> , so as not to update it for each click on F5 in the browser and at the same time we have the opportunity to update it before the application starts to send requests to our API and collides with the expired token ( if he still expired of course). <br><br><pre> <code class="hljs pgsql">//auth.service.ts <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> renewAuth(): Observable &lt; string &gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!this.isNeedRefreshToken()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Observable.empty&lt;string&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this._http.post&lt;string&gt;(`https://${authConfig.<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>}/oauth/token`, { client_id: authConfig.clientID, grant_type: <span class="hljs-string"><span class="hljs-string">'refresh_token'</span></span>, refresh_token: localStorage.getItem(<span class="hljs-string"><span class="hljs-string">'refresh_token'</span></span>) }).<span class="hljs-keyword"><span class="hljs-keyword">do</span></span>(res =&gt; this.onAuthRenew(res)); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> isNeedRefreshToken(): <span class="hljs-type"><span class="hljs-type">boolean</span></span> { //expires_at -     ,        let expiresAtString = localStorage.getItem(<span class="hljs-string"><span class="hljs-string">'expires_at'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!expiresAtString) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } const expiresAt = <span class="hljs-type"><span class="hljs-type">JSON</span></span>.parse(expiresAtString); //,         ,       let isExpireInMinute = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">Date</span></span>().getTime() &gt; (expiresAt - <span class="hljs-number"><span class="hljs-number">60000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> isExpireInMinute; }</code> </pre><br><br>  <a href="http://www.redotheweb.com/2015/11/09/api-security.html">Why you should not store the token on the client, as I did.</a> <br>  Now add the Authorization header to the requests to our API. <br><br><pre> <code class="hljs pgsql">export <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ApplyTokenInterceptor implements HttpInterceptor, AuthInterceptor { intercept(req: HttpRequest&lt;<span class="hljs-keyword"><span class="hljs-keyword">any</span></span>&gt;, next: HttpHandler): Observable&lt;HttpEvent&lt;<span class="hljs-keyword"><span class="hljs-keyword">any</span></span>&gt;&gt; { //. HttpInterceptor       ,  <span class="hljs-keyword"><span class="hljs-keyword">Authorization</span></span>   //      API <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!req.url.includes(<span class="hljs-string"><span class="hljs-string">'api/'</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return next</span></span>.handle(req); } // ,      const authReq = req.clone({ headers: req.headers.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-string"><span class="hljs-string">'Authorization'</span></span>, this.auth.authHeader) }); //     <span class="hljs-keyword"><span class="hljs-keyword">return next</span></span>.handle(authReq); } }</code> </pre><br>  It is quite simple to add the Authorization heading (there are already articles in the open spaces).  The only thing I would like to clarify is, why is HttpRequest made immutable?  Most likely this is done so that it would be easier to test and, in principle, work with the Interceptor chain. <br><br>  But if you imagine the HttpRequest as a mutable object, what will get worse (who knows)? <br><br><div class="spoiler">  <b class="spoiler_title">Mutable \ Immutable</b> <div class="spoiler_text">  Who does not know but wants to know about mutable and immutable objects - google.  In short, we cannot change the immutable object after it has been created, but we can change the mutable. The call req.headers.set ('Authorization', this.auth.authHeader) - must first add to the header in the request, but since it is immutable, it will simply create a copy of the headers + add a new one that is not needed and return a new HttpHeader object with our new header.  In addition, based on the idempotency of the objects, you can improve the performance of the Angular application ( <a href="https://vsavkin.com/immutability-vs-encapsulation-90549ab74487">link</a> ) <br></div></div><br>  Finally, go directly to the token refresh. <br><br>  Our task is to write another Interceptor, which will intercept all requests to our API, and if there is a <a href="https://developer.mozilla.org/ru/docs/Web/HTTP/Status/401">401</a> error in the response to the request, we need to refresh the token (authService.renewAuth ()) and: <br><br><ul><li>  If renewAuth () for some reason could not update the token, for example, we can redirect the user to the login page; </li><li>  If everything is fine with the request for refresh, tobish while it is in process, we will remember all the requests that were returned to the 401th until the token was resolved, because the authorization server may be on another host and may delay the response for some reason, and our server will pour 401th.  In this case, the code initiating the request (component code for example) should not receive 401 errors, and the subscription of the code initiating the request should not fly off and we should not violate the standard behavior of RxJs, the request should be sent only after the calling component makes a subscription (subscribe ()). <br><br><pre> <code class="hljs erlang"> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> first = service.getData(); //             <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> second = service.getData(); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> concatenated = first.concat(second); concatenated.subscribe(); //    subscribe   .</code> </pre><br></li><li>  After the token was successfully resolved, we repeat the requests that were made while the refresh was in progress. </li></ul><br>  First, the interception process: <br><br><div class="spoiler">  <b class="spoiler_title">Subject and what it is eaten with</b> <div class="spoiler_text">  When I started working with rxjs, I actively used the Subject, at first glance it may seem that the Subject will help solve all the problems, but this is not so.  Who has not had time to get acquainted with the exact definition and behavior of this class, I advise the <a href="https://medium.com/%40benlesh/on-the-subject-of-subjects-in-rxjs-2b08b7198b93">article</a> to study. <br></div></div><br><pre> <code class="hljs haskell">//           <span class="hljs-number"><span class="hljs-number">401</span></span>   <span class="hljs-string"><span class="hljs-string">""</span></span>  //<span class="hljs-string"><span class="hljs-string">""</span></span> -      <span class="hljs-type"><span class="hljs-type">Observable</span></span>       <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CallerRequest</span></span></span><span class="hljs-class"> = { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscriber</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Subscriber</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">any</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">failedRequest</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpRequest</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">any</span></span></span><span class="hljs-class">&gt;; }; @</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Injectable</span></span></span><span class="hljs-class">() export class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RefreshTokenInterceptor</span></span></span><span class="hljs-class"> implements </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpInterceptor</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AuthInterceptor</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">auth</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AuthRefreshProvider</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">http</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpClient</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">refreshInProgress</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">boolean</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">requests</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CallerRequest</span></span></span><span class="hljs-class">[] = []; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">http</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpClient</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">auth</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AuthRefreshProvider</span></span></span><span class="hljs-class">) { /*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">some</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class">;*/ } intercept(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">req</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpRequest</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">any</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpHandler</span></span></span><span class="hljs-class">): </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Observable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpEvent</span></span></span><span class="hljs-class">&lt;any&gt;&gt; { //  ""  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class">(!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">req</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">url</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">includes</span></span></span><span class="hljs-class">('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">api</span></span></span><span class="hljs-class">/')) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">req</span></span></span><span class="hljs-class">); } // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Observable</span></span></span><span class="hljs-class">    ,  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Observable</span></span></span><span class="hljs-class"> //     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Observable</span></span></span><span class="hljs-class">,      let observable = new </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Observable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpEvent</span></span></span><span class="hljs-class">&lt;any&gt;&gt;((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscriber</span></span></span><span class="hljs-class">) =&gt; { //             </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HttpRequest</span></span></span><span class="hljs-class"> //    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">let</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">originalRequestSubscription</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">req</span></span></span><span class="hljs-class">) .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscribe</span></span></span><span class="hljs-class">((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class">) =&gt; { //   (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">success</span></span></span><span class="hljs-class">)    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscriber</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class">); }, (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">err</span></span></span><span class="hljs-class">) =&gt; { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">err</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">status</span></span></span><span class="hljs-class"> === 401) { //  401 -      </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handleUnauthorizedError</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscriber</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">req</span></span></span><span class="hljs-class">); } else { //   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscriber</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">err</span></span></span><span class="hljs-class">); } }, () =&gt; { // ,  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">finally</span></span></span><span class="hljs-class">()  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscriber</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">complete</span></span></span><span class="hljs-class">(); }); return () =&gt; { //            //      ,  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dev</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tools</span></span></span><span class="hljs-class">     , .  ( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Controller</span></span></span><span class="hljs-class">)     ,      </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">originalRequestSubscription</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unsubscribe</span></span></span><span class="hljs-class">(); }; }); //   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Observable</span></span></span><span class="hljs-class">,      . return observable; } //private handleUnauthorizedError //private repeatFailedRequests //private repeatRequest }</span></span></code> </pre><br>  Consider how we will memorize the ‚Äú401s‚Äù and repeat them: <br><br><pre> <code class="hljs coffeescript">private handleUnauthorizedError(subscriber: Subscriber &lt; any &gt;, request: HttpRequest&lt;any&gt;) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-string"><span class="hljs-string">"401"</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.requests.push({ subscriber, failedRequest: request }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.refreshInProgress) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    ,   ,   <span class="hljs-string"><span class="hljs-string">"401"</span></span> <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     refresh <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.refreshInProgress = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.auth.renewAuth() .<span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.refreshInProgress = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }) .subscribe(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(authHeader)</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   ,           <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repeatFailedRequests(authHeader), <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   -       ,    <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.auth.logout(); }); } } private repeatFailedRequests(authHeader) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.requests.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(c)</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  <span class="hljs-string"><span class="hljs-string">""</span></span> ,     const requestWithNewToken = c.failedRequest.clone({ headers: c.failedRequest.headers.set(<span class="hljs-string"><span class="hljs-string">'Authorization'</span></span>, authHeader) }); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  ( .subscriber - subscriber  ) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repeatRequest(requestWithNewToken, c.subscriber); }); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.requests = []; } private repeatRequest(requestWithNewToken: HttpRequest &lt; any &gt;, subscriber: Subscriber&lt;any&gt;) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.http.request(requestWithNewToken).subscribe(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(res)</span></span></span><span class="hljs-function"> =&gt;</span></span> { subscriber.next(res); }, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(err)</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err.status === <span class="hljs-number"><span class="hljs-number">401</span></span>) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> just refreshed, but <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> unknown reasons we got <span class="hljs-number"><span class="hljs-number">401</span></span> again - logout user <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.auth.logout(); } subscriber.error(err); }, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { subscriber.complete(); }); }</code> </pre><br>  That's all.  Research and improve! </div><p>Source: <a href="https://habr.com/ru/post/351036/">https://habr.com/ru/post/351036/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../351024/index.html">FastTrack Training. "Network Basics". "Equipment for data centers." Eddie Martin December 2012</a></li>
<li><a href="../351026/index.html">Design habits, UX trends and UX career. Brian Pagan Interview</a></li>
<li><a href="../351030/index.html">Thymeleaf Tutorial: Chapter 5 Setting Attribute Values</a></li>
<li><a href="../351032/index.html">Open lesson "Designing UX / UI: Design in the Modern World"</a></li>
<li><a href="../351034/index.html">Game development for NES in C. Chapters 22-23. Appendix 1 - mappers and digital sound</a></li>
<li><a href="../351038/index.html">Alert to mail in real time. Is it real? Or How to Make an Alert in Splunk - Part 1</a></li>
<li><a href="../351040/index.html">Pre-election race through the eyes of search robots</a></li>
<li><a href="../351042/index.html">Design at CodeFest: thinking, development and culture</a></li>
<li><a href="../351044/index.html">Overview of the new MikroTik hAP AC2</a></li>
<li><a href="../351046/index.html">My javascript consulting experience (React / Redux)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>