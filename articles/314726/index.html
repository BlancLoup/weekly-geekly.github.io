<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JRuby + Ratpack = ‚ù§Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many Ruby developers know how things are going with asynchronous code execution on existing servers. Either you use something on EventMachine, or conj...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JRuby + Ratpack = ‚ù§Ô∏è</h1><div class="post__text post__text-html js-mediator-article"><p>  Many Ruby developers know how things are going with asynchronous code execution on existing servers.  Either you use something on EventMachine, or conjure with Ruby :: Concurrent, Celluloid. </p><br><p>  In any case, this doesn't work very efficiently because of GIL (we wait, hope and believe in Ruby 3). <br>  But there are implementations free from this problem, one of them on top of the JVM is JRuby, where the same libraries will feel much more comfortable. </p><br><p>  Many will not paint, I think everyone at least heard about him.  The main feature of this implementation is easy integration with any library on the JVM.  This opens up a lot of room in choosing libraries and off-the-shelf tools. </p><a name="habracut"></a><br><p>  So in the Java world there is a library that saves us from using the standard competitive Java model on the Executor, implementing it on actors.  Call the library Netty.  Later on its basis were developed by others, for example Ratpack. </p><br><p>  Ratpack is an asynchronous web server, Netty is under the hood, therefore it works quite efficiently with connections and, in general, with IO, contains everything you need to build a productive server. </p><br><p>  Therefore, using the features of Ratpack, the flexibility and simplicity of Ruby (JRuby), we will create a simple service that will expand us to short links.  There are a number of examples on the Internet, but they end on how to run it all and get a simple answer. </p><br><p>  There is another example with the connection of metrics (link at the end), the method from the documentation is absolutely not suitable for JRuby, as it is given only for Groovy. </p><br><p>  In this example, consider: </p><br><ul><li>  connecting libraries </li><li>  server creation </li><li>  connection of metrics </li><li>  asynchronous execution of requests to external resources </li><li>  testing our service </li><li>  and fill it all on heroku </li></ul><br><p>  Connecting libraries </p><br><p>  Every Ruby programmer uses a bundler, life without him was sad and full of dancing, rakes and other adventures. </p><br><p>  In the Java world, there are various assemblers that pull these dependencies and build an application, but this is not a Ruby way. </p><br><p>  This is how jbundler appeared.  Performs the same function as the bundler, but for Java libraries, after which, when loaded, they are available from JRuby.  Beauty! </p><br><p>  And so, we need to connect Ratpack to our application.  It will be enough just core, the rest we do not use yet. </p><br><p>  <strong>Gemfile:</strong> </p><br><pre><code class="ruby hljs">source <span class="hljs-string"><span class="hljs-string">'https://rubygems.org'</span></span> ruby <span class="hljs-string"><span class="hljs-string">'2.3.0'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:engine</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'jruby'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:engine_version</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'9.1.2.0'</span></span> gem <span class="hljs-string"><span class="hljs-string">'rake'</span></span> gem <span class="hljs-string"><span class="hljs-string">'activesupport'</span></span>, <span class="hljs-string"><span class="hljs-string">'4.2.5'</span></span> gem <span class="hljs-string"><span class="hljs-string">'jruby-openssl'</span></span> gem <span class="hljs-string"><span class="hljs-string">'jbundler'</span></span>, <span class="hljs-string"><span class="hljs-string">'0.9.2'</span></span> gem <span class="hljs-string"><span class="hljs-string">'jrjackson'</span></span> group <span class="hljs-symbol"><span class="hljs-symbol">:test</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:development</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> gem <span class="hljs-string"><span class="hljs-string">'pry'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> group <span class="hljs-symbol"><span class="hljs-symbol">:test</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> gem <span class="hljs-string"><span class="hljs-string">'rspec'</span></span> gem <span class="hljs-string"><span class="hljs-string">'simplecov'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">require:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  <strong>Jarfile:</strong> </p><br><pre> <code class="ruby hljs">jar <span class="hljs-string"><span class="hljs-string">'io.ratpack:ratpack-core'</span></span>, <span class="hljs-string"><span class="hljs-string">'1.4.2'</span></span> jar <span class="hljs-string"><span class="hljs-string">'org.slf4j:slf4j-simple'</span></span>, <span class="hljs-string"><span class="hljs-string">'1.7.10'</span></span></code> </pre> <br><p>  In the console we execute </p><br><pre> <code class="bash hljs">bundle install bundle <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> jbundle install</code> </pre> <br><p>  In the future we will add a couple of libraries, but for now let's stop on this. </p><br><h1>  Server creation </h1><br><p>  Having downloaded all the dependencies, we create a basic server, check that everything works.  Since we do not have Rack, we will do the routing using standard tools. </p><br><p>  To get started, import the necessary Java classes. </p><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'java'</span></span> java_import <span class="hljs-string"><span class="hljs-string">'ratpack.server.RatpackServer'</span></span> java_import <span class="hljs-string"><span class="hljs-string">'ratpack.server.ServerConfig'</span></span> java_import <span class="hljs-string"><span class="hljs-string">'java.net.InetAddress'</span></span></code> </pre> <br><p>  And declare our server class: </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UrlExpander</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Server</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_reader</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">port</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">host</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">run</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">('0.0.0.0', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ENV</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PORT</span></span></span><span class="hljs-class">'] || 3000).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tap</span></span></span><span class="hljs-class">(&amp;:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">run</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initializer</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">host</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">port</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">host</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">host</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">port</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">port</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">run</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">server</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RatpackServer</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">serverConfig</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handlers</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">chain</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">chain</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">status</span></span></span><span class="hljs-class">', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Handler::Status</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">chain</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">all</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Handler::Default</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">server</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">start</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shutdown</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">server</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stop</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServerConfig</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">embedded</span></span></span><span class="hljs-class"> .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">port</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">port</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_i</span></span></span><span class="hljs-class">) .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">address</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InetAddress</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">getByName</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">host</span></span></span><span class="hljs-class">)) .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">development</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ENV</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RACK_ENV</span></span></span><span class="hljs-class">'] == '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">development</span></span></span><span class="hljs-class">') .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">base_dir</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseDir</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">find</span></span></span><span class="hljs-class">) .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">props</span></span></span><span class="hljs-class">("</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">application</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">properties</span></span></span><span class="hljs-class">") </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br><p>  Endpoint status was created for our service, it will allow to check if the server is alive in principle. <br>  The handlers method takes a block in which the <a href="https://ratpack.io/manual/current/api/ratpack/handling/Chain.html">Chain</a> interface is transmitted, which determines the routing.  To declare status, we use the get method, which is equivalent to the HTTP method. </p><br><p>  The second argument is the object that implements the <a href="https://ratpack.io/manual/current/api/ratpack/handling/Handler.html">Handler</a> interface.  In our case, this is the module in which the method is declared, which accepts the current context.  As you can see everything is quite simple and clear.  No three-story factories, or something like that. </p><br><p>  Actually the handler itself, just answer that everything is OK: </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UrlExpander</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Handler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Status</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">render</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OK</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br><p>  Ratpack also has its own health check implementation, but for our example it is redundant. </p><br><h1>  Connecting Metrics </h1><br><p>  We can now monitor the status of our service, but it would be good to know what is inside with it, response time, number of requests and other indicators. </p><br><p>  For this we need metrics.  Ratpack has integration with Dropwizard, for this you need to add a couple of packages to our Jarfile and install them </p><br><pre> <code class="ruby hljs">jar <span class="hljs-string"><span class="hljs-string">'io.ratpack:ratpack-guice'</span></span>, <span class="hljs-string"><span class="hljs-string">'1.4.2'</span></span> jar <span class="hljs-string"><span class="hljs-string">'io.ratpack:ratpack-dropwizard-metrics'</span></span>, <span class="hljs-string"><span class="hljs-string">'1.4.2'</span></span></code> </pre> <br><p>  Next, connect it to our server.  This is done quite simply, it is enough just to modify a few sections. </p><br><pre> <code class="ruby hljs">java_import <span class="hljs-string"><span class="hljs-string">'ratpack.guice.Guice'</span></span> java_import <span class="hljs-string"><span class="hljs-string">'ratpack.dropwizard.metrics.DropwizardMetricsConfig'</span></span> java_import <span class="hljs-string"><span class="hljs-string">'ratpack.dropwizard.metrics.DropwizardMetricsModule'</span></span> java_import <span class="hljs-string"><span class="hljs-string">'ratpack.dropwizard.metrics.MetricsWebsocketBroadcastHandler'</span></span></code> </pre> <br><p>  Register the module in our Registry: </p><br><pre> <code class="ruby hljs"> s.serverConfig(config) s.registry(Guice.registry { <span class="hljs-params"><span class="hljs-params">|g|</span></span> g.<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>(DropwizardMetricsModule.new) })</code> </pre> <br><p>  And load its configuration: </p><br><pre> <code class="ruby hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">config</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ServerConfig</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">embedded</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">port</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(port.to_i)</span></span></span></span> .address(InetAddress.getByName(host)) .development(ENV[<span class="hljs-string"><span class="hljs-string">'RACK_ENV'</span></span>] == <span class="hljs-string"><span class="hljs-string">'development'</span></span>) .base_dir(BaseDir.find) .props(<span class="hljs-string"><span class="hljs-string">"application.properties"</span></span>) .<span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">"/metrics"</span></span>, DropwizardMetricsConfig.java_class) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  And we want to receive our metrics via WebSocket, add a handler for this: </p><br><pre> <code class="ruby hljs"> s.handlers <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|chain|</span></span> chain.get <span class="hljs-string"><span class="hljs-string">'status'</span></span>, Handler::Status chain.get <span class="hljs-string"><span class="hljs-string">'metrics-report'</span></span>, MetricsWebsocketBroadcastHandler.new chain.all Handler::Default <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  Done, you can also connect the unloading of metrics in the console or in StatsD.  Since we now have a WebSocket for output, we will add a page for display. </p><br><p>  The scheme is standard, the public folder, containing all the statics.  To return it, we will prescribe an additional route, specifying the name of the folder and the index of the new file: </p><br><pre> <code class="ruby hljs"> s.handlers <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|chain|</span></span> chain.files <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|f|</span></span> f.dir(<span class="hljs-string"><span class="hljs-string">'public'</span></span>).indexFiles(<span class="hljs-string"><span class="hljs-string">'index.html'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> chain.get <span class="hljs-string"><span class="hljs-string">'status'</span></span>, Handler::Status chain.get <span class="hljs-string"><span class="hljs-string">'metrics-report'</span></span>, MetricsWebsocketBroadcastHandler.new chain.all Handler::Default <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><h1>  Asynchronous execution of requests to external resources </h1><br><p>  Our server starts, listens to the specified port and responds to requests.  Next, add an endpoint that will return us all the url through which our short link passes.  The algorithm is the simplest, at each redirect we save a new Location into an array, and then we return it. </p><br><pre> <code class="ruby hljs">s.handlers <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|chain|</span></span> chain.get <span class="hljs-string"><span class="hljs-string">'status'</span></span>, Handler::Status chain.path <span class="hljs-string"><span class="hljs-string">'expand'</span></span>, Handler::Expander chain.all Handler::Default <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  The added endpoint will accept both POST and GET requests. </p><br><p>  If we only had a blocking API, each request was processed in its own stream, how it was processed, 90% of the time it would wait for a response from the server, since  useful calculations we have a minimum.  But to our happiness, Ratpack is an asynchronous server and provides a complete set of components, including an asynchronous http client and Promise, which is asynchronous without them. <br>  And so, we create for each initial reference Promise, which, if successful, will return the Location array to us. </p><br><p>  Inside, run GET at our URL and hang up a callback to receive a new Location from the server. </p><br><p>  Thus, we place in our array the target URL and all intermediate ones. </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UrlExpander</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Handler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Expander</span></span></span><span class="hljs-class"> &lt; Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java_import</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ratpack</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">exec</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">util</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ParallelBatch</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java_import</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ratpack</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">http</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">client</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HttpClient</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">execute</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">present?</span></span></span><span class="hljs-class"> ? </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JrJackson::Json</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">load</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class">) : {}</span></span></code> </pre> <br><p>  We create HttpClient, which will collect our links </p><br><pre> <code class="ruby hljs"> httpClient = ctx.get HttpClient.java_class</code> </pre> <br><p>  We collect all the URLs transmitted to us and if there is nothing, then we immediately return Promise with an empty map. </p><br><pre> <code class="ruby hljs"> urls = [*data[<span class="hljs-string"><span class="hljs-string">'urls'</span></span>], *data[<span class="hljs-string"><span class="hljs-string">'url'</span></span>], *params[<span class="hljs-string"><span class="hljs-string">'url'</span></span>]].compact <span class="hljs-keyword"><span class="hljs-keyword">unless</span></span> urls.present? <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Promise.value({}) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  We create parallel requests for all links submitted: </p><br><pre> <code class="ruby hljs"> tasks = urls.map <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|url|</span></span> Promise.async <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|down|</span></span> uri = Java.java.net.URI.new(url) locations = [url] httpClient.get(uri) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|spec|</span></span> spec.onRedirect <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|resposne, action|</span></span> locations &lt;&lt; resposne.getHeaders.get(<span class="hljs-string"><span class="hljs-string">'Location'</span></span>) action <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|_resp|</span></span> down.success(locations); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  Waiting for them to complete, collect the result and return it: </p><br><pre> <code class="ruby hljs"> ParallelBatch.of(tasks).yieldAll.flatMap <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|results|</span></span> response = results.each_with_object({}) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|result, locations|</span></span> result.value.try <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|list|</span></span> locations[list.first] = list[<span class="hljs-number"><span class="hljs-number">1</span></span>..-<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> Promise.value response <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  As a result, we got a chain from Promise, which asynchronously executes our code. </p><br><h1>  Testing our service </h1><br><p>  It is time to test what you wrote.  We will test through the good old rspec, but with nuances.  Since  we use Ratpack + Promise, then testing in isolation from the library will not work, somehow these Promise should be performed, i.e.  need a working eventloop.  For this we will connect an additional JAR library from the bundle: </p><br><pre> <code class="ruby hljs">jar <span class="hljs-string"><span class="hljs-string">'io.ratpack:ratpack-test'</span></span>, <span class="hljs-string"><span class="hljs-string">'1.4.2'</span></span></code> </pre> <br><p>  This library allows you to organize how to test requests (creating a test server), and just perform the Promise.  For the latter, the <a href="https://ratpack.io/manual/current/api/ratpack/test/exec/ExecHarness.html">ExecHarness</a> class is <a href="https://ratpack.io/manual/current/api/ratpack/test/exec/ExecHarness.html">used</a> , it is described in detail in the documentation and the examples are easily transferred to JRuby. </p><br><p>  We will test how our GET request is executed and use <a href="https://ratpack.io/manual/current/api/ratpack/test/embed/EmbeddedApp.html">EmbeddedApp</a> , which allows you to run a test server.  There are various static methods to simplify the creation <br>  under certain cases.  We will only test our handler, regardless of the path, so we will create it as follows: </p><br><pre> <code class="ruby hljs">describe UrlExpander::Handler::Expander <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> let(<span class="hljs-symbol"><span class="hljs-symbol">:server</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> EmbeddedApp.fromHandlers <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|chain|</span></span> chain.all(described_class) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-comment"><span class="hljs-comment">#... end</span></span></code> </pre> <br><p>  And let's check that everything works as it should: </p><br><pre> <code class="ruby hljs"> let(<span class="hljs-symbol"><span class="hljs-symbol">:url</span></span>) { <span class="hljs-string"><span class="hljs-string">'http://bit.ly/1bh0k2I'</span></span> } context <span class="hljs-string"><span class="hljs-string">'get request'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> it <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> server.test <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|client|</span></span> response = client.params <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|builder|</span></span> builder.put(<span class="hljs-string"><span class="hljs-string">'url'</span></span>, url) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> .getText response = JrJackson::Json.load(response) expect(response).to be_present expect(response).to be_key url expect(response[url].last).to match /\/ya\.ru/ <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  The test method starts the execution and passes to the block an instance of TestHTTPClient, with which the request is executed.  Further we check the received answer.  As you can see everything is quite simple. <br>  Unlike ExecHarness, EmbeddedApp re-creates a server for every check, while ExecHarness only runs EventLoop once. </p><br><p>  Therefore, it is better to separate the code from working with the Ratpack Context as much as possible so that it can be independently tested. </p><br><h1>  Run on Heroku </h1><br><p>  After everything is ready, run our project on heroku.  This procedure is practically no different from running a normal ruby ‚Äã‚Äãservice. </p><br><p>  The only difference is that you need to install the JAR library, and heroku does not perform this operation automatically. </p><br><p>  For this, a small hack is made.  In principle, it is described everywhere, but for integrity, I will repeat it here.  During the build process, static builds are performed, so we will use this and add the following rake task: </p><br><pre> <code class="ruby hljs">task <span class="hljs-string"><span class="hljs-string">"assets:precompile"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'jbundler'</span></span> config = JBundler::Config.new JBundler::LockDown.new( config ).lock_down JBundler::LockDown.new( config ).lock_down(<span class="hljs-string"><span class="hljs-string">"--vendor"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  Everything, now at the assembly, also the libraries specified in Jarfile will be installed. </p><br><h1>  Conclusion </h1><br><p>  As you can see, using Ratpack in conjunction with JRuby is not so difficult, at the same time it gives you access to all the features of JVM and Netty in particular.  Based on it, you can build a high-performance asynchronous server.  All this is production ready, testing on Hello World shows up to 25k rps on EC2 c4.large in a docker container after warming up.  About 30K requests were executed for warming up, at the start time floats, but by the end it is stable.  At the same time, even with a fairly complex logic, the query execution time is a few milliseconds.  This of course depends on the tasks, but even just replacing Puma with Ratpack (tested for time evaluation) gave a significant increase.  After a complete refactoring and rethinking of the code and dense optimization on the JVM, the time was reduced by orders of magnitude.  So who is looking for Java performance and flexibility, Ruby development speed, while there is a lot of work, I recommend looking at this pair. </p><br><h1>  Links </h1><br><ul><li>  <a href="https://github.com/fuCtor/jruby_ratpack_example/">Github</a> </li><li>  <a href="https://jruby-ratpack-example.herokuapp.com/">Demo</a> </li><li>  <a href="http://bit.ly/1bh0k2I">Call example</a> </li><li>  <a href="https://github.com/jkutner/ratpack-jruby-example">Another example from which a page with metrics was taken and an example of how to connect these metrics in principle</a> </li><li>  <a href="https://ratpack.io/">Well, Ratpack itself</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/314726/">https://habr.com/ru/post/314726/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../314716/index.html">Now ONLYOFFICE can do everything: add plugins to document editors</a></li>
<li><a href="../314718/index.html">"Transparent" Squid with access control</a></li>
<li><a href="../314720/index.html">The release of mobile games in China is more complicated than ever.</a></li>
<li><a href="../314722/index.html">Google and Samsung fixed Dirty COW vulnerability in Android firmware</a></li>
<li><a href="../314724/index.html">One scientifically based way to rationally manage your busy and busy schedule</a></li>
<li><a href="../314730/index.html">How the cooling system of the NORD-4 data center was created</a></li>
<li><a href="../314732/index.html">Results Ruby Hero Russia Award 2016</a></li>
<li><a href="../314734/index.html">Vulnerability in payment service Platinum Bank (Ukraine)</a></li>
<li><a href="../314736/index.html">We build IPTV / OTT service: content protection</a></li>
<li><a href="../314738/index.html">Fake letters. How to defend</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>