<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PVS-Studio team is preparing a technical breakthrough, but for now we will double-check Blender</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Static analysis is most useful with regular checks. Especially for such actively developing projects as Blender. It's time to check it again, and find...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PVS-Studio team is preparing a technical breakthrough, but for now we will double-check Blender</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/b16/1e1/8b1/b161e18b12d6a3e1d781c044c5e4e543.png" alt="PVS-Studio, Blender, C / C ++" align="left">  Static analysis is most useful with regular checks.  Especially for such actively developing projects as Blender.  It's time to check it again, and find out what suspicious places you can find this time. <br><br><h2>  Introduction </h2><br>  Blender is a professional package for creating three-dimensional computer graphics, which includes tools for modeling, animation, rendering, post-processing and editing video with sound, also used to create interactive games. <br><br>  The project has already been tested previously.  The results of testing version 2.62 are presented in the article " <a href="http://www.viva64.com/ru/b/0145/">Checking a Blender Project with PVS-Studio</a> ". 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since the last inspection, the size of the source code, along with additional libraries, has increased to 77 megabytes.  And its volume increased to 2206 KLOC.  At the time of the previous calibration, the project size was 68 megabytes (2105 KLOC). <br><a name="habracut"></a><br>  The utility <a href="http://www.campwoodsw.com/sourcemonitor.html">SourceMonitor</a> helped me calculate the amount of code.  This utility can analyze code in C ++, C, C #, VB.NET, Java, Delphi languages ‚Äã‚Äãand calculates various metrics.  For example, it can determine the <a href="http://www.viva64.com/ru/t/0010/">cyclomatic complexity of</a> your projects, as well as generate detailed statistics for each of the project files.  And show the results in the form of a table or diagrams. <br><br>  So, this article will tell about the errors and suspicious places found in the Blender version 2.77a.  The PVS-Studio analyzer version 6.05 was used for verification. <br><br><h2>  Typos </h2><br>  With the active use of copying mechanisms and automatic code completion, very often errors can occur in the names of various variables and constants.  Such errors may lead to incorrect results of calculations or unexpected behavior of the program.  In the Blender project, the analyzer found several examples at once.  Consider them in detail. <br><br><h3>  A typo in the condition </h3><br><pre><code class="cpp hljs">CurvePoint::CurvePoint(CurvePoint *iA, CurvePoint *iB, <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> t3) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((iA-&gt;getPoint2D() - <span class="hljs-comment"><span class="hljs-comment">//&lt;= iA-&gt;getPoint2D()).norm() &lt; 1.0e-6) { //&lt;= .... } .... }</span></span></code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0090/">I‚Äôm the</a> operator: iA-&gt; getPoint2D () - iA-&gt; getPoint2D () curve.cpp 136 <br><br>  Inside the <i>CurvePoint</i> function, <i>you</i> work with two similar objects, <i>iA</i> and <i>iB</i> .  Different methods of these objects constantly intersect in various operations in a rather long tree of conditions.  In one of the conditional blocks, a typo was made.  The result is a subtraction operation between the property of the same object.  Without knowing the features of the code, it is impossible to say exactly which of the two operands is an error.  I suggest two possible options for its correction: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((iA-&gt;getPoint2D()-iB-&gt;getPoint2D()).norm()&lt;<span class="hljs-number"><span class="hljs-number">1.0e-6</span></span>)....</code> </pre> <br>  or <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((iB-&gt;getPoint2D()-iA-&gt;getPoint2D()).norm()&lt;<span class="hljs-number"><span class="hljs-number">1.0e-6</span></span>)....</code> </pre> <br>  The following error was also hidden inside the conditional operator. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> MatrixType, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> QRPreconditioner&gt; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> JacobiSVD&lt;MatrixType, QRPreconditioner&gt;::allocate(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(m_cols&gt;m_rows)m_qr_precond_morecols.allocate(*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(m_rows&gt;m_cols)m_qr_precond_morerows.allocate(*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(m_cols!=m_cols)m_scaledMatrix.resize(rows,cols); <span class="hljs-comment"><span class="hljs-comment">//&lt;= }</span></span></code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0090/">V501</a> There are identical sub-expressions to the left and the right! ‚Äù= 'Operator: m_cols! = M_cols jacobisvd.h 819 <br><br>  In the given code fragment, the equation for the number of rows and columns inside a certain matrix occurs.  If the number is not equal, respectively, memory is allocated for new items or they are created.  And after, if new cells were added, the matrix resizing operation takes place.  But as a result of an error in the expression of the conditional operator, the operation will never occur, since the condition <i>m_cols! = M_cols is</i> always false.  In this case, it does not matter which of the two parts of the expression needs to be changed, so I suggest this option: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(m_cols!=m_rows) m_scaledMatrix.resize(rows,cols)</code> </pre> <br>  A few more problem areas detected by the V501 diagnostic: <ul><li>  V501 There are identical to the left and the right of the operator: == 'operator: left.rows () == left.rows () numeric.cc 112 </li><li>  V501 operator: (from [0] [3])&gt; (from [0] [3]) stereoimbuf.c 120 </li><li>  V501 operator: (from [0] [3])&gt; (from [0] [3]) stereoimbuf.c 157 </li><li>  V501 There are identical to the left and the right of the operator: out-&gt; y == out-&gt; y filter.c 209 </li></ul><br><h3>  Work with a null pointer </h3><br>  Here a typo in the name led to a more serious error. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> QuantitativeInvisibilityF1D::<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>()(....) { ViewEdge *ve = <span class="hljs-keyword"><span class="hljs-keyword">dynamic_cast</span></span>&lt;ViewEdge*&gt;(&amp;inter); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ve) { result = ve-&gt;qi(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } FEdge *fe = <span class="hljs-keyword"><span class="hljs-keyword">dynamic_cast</span></span>&lt;FEdge*&gt;(&amp;inter); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fe) { result = ve-&gt;qi(); <span class="hljs-comment"><span class="hljs-comment">//&lt;= return 0; } .... }</span></span></code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0111/">V522</a> Dereferencing of the null pointer 'might take place.  functions1d.cpp 107 <br><br>  The above function is quite short, but typos can trap us even in simple functions.  From the code it is clear that two objects are created and checked sequentially.  But after checking the second object, an error occurred, and if <i>fe was</i> successfully created, instead of it, the result is recorded the result of the function from the first object, which was not created according to early conditions.  This will most likely lead to a program crash if the exception is not intercepted by a higher level handler. <br><br>  Apparently, the second code fragment was written using Copy-Paste.  And by chance in one place they forgot to change the variable name <i>ve</i> .  The correct code, most likely, should have been like this: <br><pre> <code class="cpp hljs">FEdge *fe = <span class="hljs-keyword"><span class="hljs-keyword">dynamic_cast</span></span>&lt;FEdge*&gt;(&amp;inter); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fe) { result = fe-&gt;qi(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <h3>  Using the <i>null</i> pointer </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ImBuf *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">accessor_get_ibuf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ ImBuf *ibuf, *orig_ibuf, *final_ibuf; .... <span class="hljs-comment"><span class="hljs-comment">/* First try to get fully processed image from the cache. */</span></span> ibuf = accesscache_get(accessor, clip_index, frame, input_mode, downscale, transform_key); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ibuf != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ibuf; } <span class="hljs-comment"><span class="hljs-comment">/* And now we do postprocessing of the original frame. */</span></span> orig_ibuf = accessor_get_preprocessed_ibuf(accessor, clip_index, frame); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (orig_ibuf == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; } .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (downscale &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (final_ibuf == orig_ibuf) { final_ibuf = IMB_dupImBuf(orig_ibuf); } IMB_scaleImBuf(final_ibuf, ibuf-&gt;x / (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; downscale), <span class="hljs-comment"><span class="hljs-comment">//&lt;= ibuf-&gt;y / (1 &lt;&lt; downscale)); //&lt;= } .... if (input_mode == LIBMV_IMAGE_MODE_RGBA) { BLI_assert(ibuf-&gt;channels == 3 || //&lt;= ibuf-&gt;channels == 4); //&lt;= } .... return final_ibuf; }</span></span></code> </pre> <br>  Warnings: <ul><li>  <a href="http://www.viva64.com/ru/d/0111/">V522</a> Dereferencing of the null pointer 'ibuf' might take place.  tracking_util.c 765 </li><li>  <a href="http://www.viva64.com/ru/d/0111/">V522</a> Dereferencing of the null pointer 'ibuf' might take place.  tracking_util.c 766 </li><li>  <a href="http://www.viva64.com/ru/d/0111/">V522</a> Dereferencing of the null pointer 'ibuf' might take place.  tracking_util.c 783 </li></ul><br>  In the above fragment, you can see that checking the <i>ibuf</i> variable in case the object is created interrupts the function much earlier than this variable is used.  Perhaps this could be stopped and confirm the fact of <i>pointer dereference.</i>  However, a closer examination of the code and comments to it, it turns out the true cause of the error.  And in fact, there is again a typo.  In the places specified by the analyzer, the variable <i>orig_ibuf</i> was actually to be used instead of <i>ibuf.</i> <br><br><h3>  Invalid variable type </h3><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> eOutlinerIdOpTypes { OUTLINER_IDOP_INVALID = <span class="hljs-number"><span class="hljs-number">0</span></span>, OUTLINER_IDOP_UNLINK, OUTLINER_IDOP_LOCAL, .... } eOutlinerIdOpTypes; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> eOutlinerLibOpTypes { OL_LIB_INVALID = <span class="hljs-number"><span class="hljs-number">0</span></span>, OL_LIB_RENAME, OL_LIB_DELETE, } eOutlinerLibOpTypes; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">outliner_lib_operation_exec</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... eOutlinerIdOpTypes event; <span class="hljs-comment"><span class="hljs-comment">//&lt;= .... event = RNA_enum_get(op-&gt;ptr, "type"); switch (event) { case OL_LIB_RENAME: //&lt;= { .... } case OL_LIB_DELETE: //&lt;= { .... } default: /* invalid - unhandled */ break; } .... }</span></span></code> </pre> <br>  Warnings: <ul><li>  <a href="http://www.viva64.com/ru/d/0147/">V556</a> The values ‚Äã‚Äãof different types are compared: switch (ENUM_TYPE_A) {case ENUM_TYPE_B: ...}.  outliner_tools.c 1286 </li><li>  <a href="http://www.viva64.com/ru/d/0147/">V556</a> The values ‚Äã‚Äãof different types are compared: switch (ENUM_TYPE_A) {case ENUM_TYPE_B: ...}.  outliner_tools.c 1295 </li></ul><br>  The example shows two types that are enumerations.  And the fact that there was a typo when writing code in the type is quite expected for such types that are almost indistinguishable by name. <br><br>  In fact, the code works correctly.  But at the same time, he is misleading by the type mismatch.  A variable gets the value of one enum and is compared with the constants of another.  To correct the error in this case, it is enough to change the type of the <i>event</i> <i>variable</i> to <i>eOutlinerLibOpTypes</i> . <br><br><h3>  Operation Priority Error </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">blf_font_draw_buffer_ex</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... cbuf[<span class="hljs-number"><span class="hljs-number">3</span></span>] = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>)((alphatest = ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)cbuf[<span class="hljs-number"><span class="hljs-number">3</span></span>] + (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(a * <span class="hljs-number"><span class="hljs-number">255</span></span>)) &lt; <span class="hljs-number"><span class="hljs-number">255</span></span>) ? alphatest : <span class="hljs-number"><span class="hljs-number">255</span></span>); .... }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0197/">V593</a> Consider reviewing the A = B &lt;C 'kind.  The expression is calculated as the following: 'A = (B &lt;C)'.  blf_font.c 414 <br><br>  Non-compliance with the priority of operations is one of the most common errors when working with complex expressions.  In this case, this is just a typo, but it has led to a violation of the logic of the ternary operator.  Due to an incorrectly set parenthesis, an error occurred with the priority of operations.  In addition, the value of the <i>alphatest</i> variable <i>deteriorates</i> .  Instead of the value that the ternary operator calculates, the <i>alphatest</i> variable <i>is</i> assigned the bool-type value obtained as a result of the comparison operation (&lt;).  And after that the ternary operator works with the value of the <i>alphatest variable</i> , and the result of its work is not saved.  To correct the error, you must change the expression as follows: <br><pre> <code class="cpp hljs">cbuf[<span class="hljs-number"><span class="hljs-number">3</span></span>] = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>)(alphatest = (((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)cbuf[<span class="hljs-number"><span class="hljs-number">3</span></span>] + (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(a * <span class="hljs-number"><span class="hljs-number">255</span></span>)) &lt; <span class="hljs-number"><span class="hljs-number">255</span></span>) ? alphatest : <span class="hljs-number"><span class="hljs-number">255</span></span>);</code> </pre> <h3>  Error in constant </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BKE_ffmpeg_alpha_channel_is_supported</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RenderData *rd)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> codec = rd-&gt;ffcodecdata.codec; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codec == AV_CODEC_ID_QTRLE) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codec == AV_CODEC_ID_PNG) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codec == AV_CODEC_ID_PNG) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; .... }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0268/">V649</a> There are two 'if' statements with identical conditional expressions.  The first 'if' statement contains function return.  This means that the statement is senseless.  Check lines: 1672, 1675. writeffmpeg.c 1675 <br><br>  The function performs a sequential check of the value of a variable against a flag using single-line conditions.  As a result of a typo, one of the flags is checked twice.  For certain, instead of repeated check another constant should be checked.  But there are a lot of variants of these constants, so I can‚Äôt guess exactly how to fix this code. <br><br><h2>  Using one variable in outer and nested loops </h2><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BM_face_exists_overlap_subset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...., </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i; .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i++) { BM_ITER_ELEM (f, &amp;viter, varr[i], BM_FACES_OF_VERT) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((f-&gt;len &lt;= len) &amp;&amp; (....)) { BMLoop *l_iter, *l_first; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_init == <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { is_init = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i++) { <span class="hljs-comment"><span class="hljs-comment">//&lt;= BM_ELEM_API_FLAG_ENABLE(varr[i], _FLAG_OVERLAP); } } .... } } } }</span></span></code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0124/">V535</a> The variable 'i' is being used for the loop.  Check lines: 2204, 2212. bmesh_queries.c 2212 <br><br>  Using the same variable in the outer and nested loop may lead to incorrect execution of the outer loop.  In this case, this is most likely not an error, since the cycle apparently searches for the necessary element and ends, and the second cycle only works in this case.  But still, the use of a single variable is a dangerous place, and can lead to real mistakes if you need to optimize this piece of code. <br><br><h2>  Redundant code </h2><br>  Extra code snippets can be found in any program.  Sometimes this is the old code left over after refactoring.  And it happens that the extra fragments serve to maintain the style of the project code.  Sometimes these pieces of code can be dangerous.  In other words, duplicate code often indicates logical errors. <br><br><h3>  Double check </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">knife_add_single_cut</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((lh1-&gt;v &amp;&amp; lh2-&gt;v) &amp;&amp; <span class="hljs-comment"><span class="hljs-comment">//&lt;= (lh1-&gt;v-&gt;v &amp;&amp; lh2-&gt;v &amp;&amp; lh2-&gt;v-&gt;v) &amp;&amp; //&lt;= (e_base = BM_edge_exists(lh1-&gt;v-&gt;v, lh2-&gt;v-&gt;v))) { .... return; } .... }</span></span></code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0090/">V501</a> There are identical sub-expressions of the operator.  editmesh_knife.c 781 <br><br>  This is one of the options for an ill-considered condition.  This, of course, is not an error, but an extra check, but this does not mean that the code does not need to be improved.  The condition consists of several expressions.  In this part of the second expression is fully consistent with the test of one of the variables in the first and is superfluous.  To fix it, remove the extra <i>lh2-&gt; v</i> check from the second expression.  After that, the code will be much clearer. <br><br>  Another example: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">edbm_rip_invoke__vert</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (do_fill) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (do_fill) { .... } } .... }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0169/">V571</a> Recurring check.  The 'if (do_fill)' condition was already verified in line 751. editmesh_rip.c 752 <br><br>  Another version of the logical error.  Here two absolutely identical expressions are checked inside an external and nested condition.  Re-checking will always produce the same result and does not make sense.  Of course, this code does not affect the operation of the program.  But it is not known how the code will change over time, and unnecessary checks can be confusing. <br><br>  Excessive checks are found not in the same place of the project.  Here are some more places found by the analyzer: <ul><li>  V571 Recurring check.  The 'but' condition was already verified in line 9587. interface_handlers.c 9590 </li><li>  V571 Recurring check.  The '! Me-&gt; mloopcol' condition was already verified in line 252. paint_vertex.c 253 </li><li>  V571 Recurring check.  The 'constinv == 0' condition was already verified in line 5256. transform_conversions.c 5257 </li><li>  V571 Recurring check.  The 'vlr-&gt; v4' condition was already verified in line 4174. convertblender.c 4176 </li><li>  V571 Recurring check.  The 'ibuf == ((void *) 0)' condition was already verified in line 3557. sequencer.c 3559 </li></ul><br>  And the third example is explicit redundancy code: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writedata_do_write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((wd == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) || wd-&gt;error || (mem == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) || memlen &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wd-&gt;error) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; .... }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0268/">V649</a> There are two 'if' statements with identical conditional expressions.  The first 'if' statement contains function return.  This means that the statement is senseless.  Check lines: 331, 332. writefile.c 332 <br><br>  Here is the string <i>if (wd-&gt; error) return;</i>  just superfluous, and the function will complete before this condition is processed.  Therefore, it is required to simply remove. <br><br><h3>  Opposite condition blocks </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">select_less_exec</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((lastsel==<span class="hljs-number"><span class="hljs-number">0</span></span>)&amp;&amp;(bp-&gt;hide==<span class="hljs-number"><span class="hljs-number">0</span></span>)&amp;&amp;(bp-&gt;f1 &amp; SELECT)){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastsel != <span class="hljs-number"><span class="hljs-number">0</span></span>) sel = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> sel = <span class="hljs-number"><span class="hljs-number">0</span></span>; .... } .... }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0255/">V637</a> Two opposite conditions were encountered.  The second condition is always false.  Check lines: 938, 939. editcurve_select.c 938 <br><br>  From the fragment it is true that an additional condition is located inside the external conditional block.  The nested condition is opposite to the main one and always gives the same result, and the variable <i>sel</i> will never get the value <i>1</i> .  Therefore, it is sufficient to simply write <i>sel = 0</i> without re-checking.  Although, perhaps the error should be corrected by changing one of the conditions.  I do not participate in the development of the project and it is difficult for me to judge what is what. <br><br><h3>  Overkill </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">DerivedMesh *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fluidsimModifier_do</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!fluidmd || (fluidmd &amp;&amp; !fluidmd-&gt;fss)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dm; .... }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0375/">V728 Anonymous</a> check can be simplified.  The '||'  operator fluidmd and fluidmd.  mod_fluidsim_util.c 528 <br><br>  Within one condition, the opposite values ‚Äã‚Äãof the same variable are checked.  Such conditions are often found in different types and variations.  They do not harm the work of the program, but in vain complicate the code.  This expression can be simplified and lead to the following form: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!fluidmd || !fluidmd-&gt;fss)) ....</code> </pre> <br>  Similar places: <ul><li>  V728 Anonymous check can be simplified.  The '||'  operator is surrounded by opposite expressions '! render_only' and 'render_only'.  drawobject.c 4663 </li><li>  V728 Anonymous check can be simplified.  The '||'  operator is surrounded by opposite expressions '! parent' and 'parent'.  kx_scene.cpp 1667 </li></ul><br>  Another variant of this condition: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ED_transverts_create_from_obedit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((tipsel &amp;&amp; rootsel) || (rootsel)) {....} .... }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0320/">V686</a> A pattern was detected: (rootsel) ||  ((rootsel) &amp;&amp; ...).  The expression is abundant or contains a logical error.  ed_transverts.c 325 <br><br>  As in the example above, the same variable is checked twice within the same expression.  Such an expression is not erroneous, but is clearly overloaded with an extra check.  To make the code more compact and clear it needs to be simplified. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((tipsel || rootsel) {....}</code> </pre> <br>  Similar errors were encountered in other places of the project. <ul><li>  V686 A pattern was detected: (! Py_b_len) ||  ((! py_b_len) &amp;&amp; ...).  The expression is abundant or contains a logical error.  aud_pyapi.cpp 864 </li><li>  V686 A pattern was detected: (xn == 0.0f) ||  ((xn == 0.0f) &amp;&amp; ...).  The expression is abundant or contains a logical error.  renderdatabase.c 993 </li><li>  V686 A pattern was detected: (xn == 0.0f) ||  ((xn == 0.0f) &amp;&amp; ...).  The expression is abundant or contains a logical error.  renderdatabase.c 1115 </li></ul><br><h3>  Reassignment </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find_prev_next_keyframes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { aknext = (ActKeyColumn *)BLI_dlrbTree_search_next( &amp;keys, compare_ak_cfraPtr, &amp;cfranext); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aknext) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (CFRA == (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)aknext-&gt;cfra) { cfranext = aknext-&gt;cfra; <span class="hljs-comment"><span class="hljs-comment">//&lt;- } else { if (++nextcount == U.view_frame_keyframes) donenext = true; } cfranext = aknext-&gt;cfra; //&lt;- } } while ((aknext != NULL) &amp;&amp; (donenext == false)); .... }</span></span></code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0108/">V519</a> The 'cfranext' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 447, 454. anim_draw.c 454 <br><br>  Assignment within conditional blocks does not make sense, since its value is still assigned anew at the end of the cycle without any condition.  The conclusion that the extra line is located just above helps the loop located in the code after the given fragment.  It differs only in <i>prev</i> variables and the absence of this line in the condition.  Moreover, if we assume that the extra line below and the condition <i>CFRA == (int) aknext-&gt; cfra</i> turns out to be false, then the cycle will turn into an infinite one.  This fragment obviously needs to be corrected, but how only the project developers know how to change it. <br><br><h3>  Unnecessary or unused variables </h3><br>  There are a lot of similar fragments with initialized, but not used as a result, variables.  Some of them relate to examples of logical errors and redundant rechecks; similar fragments have already been mentioned above many times.  There are also constants, which quite possibly should have changed inside functions.  But in the end they remained only in the form of a test, always returning the same result.  An example of such a fragment: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rule_avoid_collision</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n, neighbors = <span class="hljs-number"><span class="hljs-number">0</span></span>, nearest = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//&lt;= .... if (ptn &amp;&amp; nearest==0) //&lt;= MEM_freeN(ptn); return ret; }</span></span></code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0153/">V560</a> A part of the conditional expression is always true: nearest == 0. boids.c 361 <br><br>  The rest of the fragments, I will just list.  Perhaps many of them are controversial, but they are worth paying attention to. <ul><li>  V560 A part of the conditional expression is always true: edit == 0. particle.c 3781 </li><li>  V560 A part of the conditional expression is always true:! Error.  pointcache.c 154 </li><li>  V560 A part of the conditional expression is always true:! Error.  pointcache.c 2742 </li><li>  V560 A part of the conditional expression is always false: col.  drawobject.c 7803 </li><li>  V560 A part of the conditional expression is always false:! Canvas_verts.  dynamicpaint.c 4636 </li><li>  V560 A part of the conditional expression is always true: (! Leaf).  octree.cpp 2513 </li><li>  V560 A part of the conditional expression is always true: (! Leaf).  octree.cpp 2710 </li><li>  V560 A part of conditional expression is always false: (1 == i).  basicstrokeshaders.cpp 67 </li><li>  V560 A part of the conditional expression is always true: (0 == i).  basicstrokeshaders.cpp 69 </li><li>  V560 A part of conditional expression is always false: (1 == i).  basicstrokeshaders.cpp 84 </li><li>  V560 A part of the conditional expression is always true: (0 == i).  basicstrokeshaders.cpp 86 </li><li>  V560 A part of conditional expression is always false: (1 == i).  basicstrokeshaders.cpp 155 </li><li>  V560 A part of the conditional expression is always true: (0 == i).  basicstrokeshaders.cpp 157 </li><li>  V560 A part of the conditional expression is always true: (! Radmod).  solver_control.cpp 557 </li><li>  V560 A part of the conditional expression is always true: done! = 1. context.c 301 </li><li>  V560 A part of the conditional expression is always true: is_tablet == false.  ghost_systemwin32.cpp 665 </li><li>  V560 A part of the conditional expression is always true: mesh&gt; = 0. kx_gameobject.cpp 976 </li></ul><br><h3>  Extra cleaning list </h3><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TileManager::gen_tiles(<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> sliced) { .... state.tiles.clear(); <span class="hljs-comment"><span class="hljs-comment">//&lt;= .... int tile_index = 0; state.tiles.clear(); state.tiles.resize(num); .... }</span></span></code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0189/">V586</a> The 'clear' function of the same resource.  Check lines: 149, 156. tile.cpp 156 <br><br>  In this case, it may just be an extra line.  It is possible that some other code was located between the two cleanings of the list earlier, but in this case it is another extra piece that is not useful and should be deleted so as not to clutter up the code.  This line may also be due to the fact that it had to clear some other object that is not visible during a cursory inspection of the code.  In this case, the fragment will be an obvious mistake, which may lead to unknown consequences for the program. <br><br>  Very often, this seemingly redundant code can lead to really serious errors or help to avoid their appearance in the future when finalizing the code.  That is why you should pay attention to such messages of the analyzer, and not dismiss them as minor. <br><br><h2>  Intrigue </h2><br>  The PVS-Studio team is now actively working on a new direction.  And I cover the rear, filling the information field with articles about re-checking some open projects.  What is this direction?  I can not say.  I will only leave a picture that everyone is free to interpret in his own way. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6c4/d9d/519/6c4d9d519eb91b73daf8125733e75b45.png" alt="Picture 2"><br><br><h2>  Conclusion </h2><br>  The analyzer indicated a lot of problem areas in the project.  However, Blender sometimes uses a strange style of code, and it is impossible to accurately interpret such fragments as errors.  I find dangerous mistakes often due to typos.  The PVS-Studio analyzer copes with their finding well.  But the errors reflected in the article are solely the opinion of the author, which is quite subjective.  And for a full assessment of the capabilities of the analyzer it is worth downloading and trying it yourself. <br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0413/"><img src="https://habrastorage.org/getpro/habr/post_images/35e/064/ddf/35e064ddf91f5d99b620384893909ff7.png"></a> </div><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Alexander Chibisov.  <a href="http://www.viva64.com/en/b/0413/">Let us recheck Blender</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/306104/">https://habr.com/ru/post/306104/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../306088/index.html">Nine simple UX truths</a></li>
<li><a href="../306090/index.html">Features of promotion: how we built a partner channel. Errors and solutions</a></li>
<li><a href="../306092/index.html">Is the US market an attractive opportunity or a trap of opinions?</a></li>
<li><a href="../306096/index.html">Portals in React.js</a></li>
<li><a href="../306102/index.html">Bitrix24: an inconspicuous CRM that works for you</a></li>
<li><a href="../306106/index.html">Reducing delays, increasing trading volume and new platforms: major technological trends in the development of world exchanges</a></li>
<li><a href="../306108/index.html">RS-422 pairing adapters supporting speeds up to 1Mbaud for PCI system bus</a></li>
<li><a href="../306112/index.html">X2CRM - or in search of the perfect CRM for business</a></li>
<li><a href="../306116/index.html">How we updated and rewrote the Otkrytie Bank's iOS application: case</a></li>
<li><a href="../306118/index.html">Localization of personal data</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>