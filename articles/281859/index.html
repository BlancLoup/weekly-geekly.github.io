<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing a Lisp Interpreter in Java</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago I wanted to write my own small interpreted scripting language, just for fun, without setting myself any serious tasks. I was then active...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing a Lisp Interpreter in Java</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/862/3e9/9c3/8623e99c32d4479a8da974f0fbb928e0.png"><br><br>  Some time ago I wanted to write my own small interpreted scripting language, just for fun, without setting myself any serious tasks.  I was then actively reading the famous SICP magic book (Structure and Interpretation of Computer Programs), and I wanted to implement the abstractions described in it ‚Äî functions as first-class objects, closures, macros, and so on.  In parallel, I was interested in Haskell, and decided to combine the pleasant with the pleasant, and write an interpreter of the language on it.  In my language there should have been strict semantics with call by value and mutable variables.  I connected the resulting Lisp-family language in my local environment with the name Liscript, the full implementation of which fit in about 250 lines, including the parser, the kernel and console / file I / O.  This is more than enough for the sake of interest to solve any problems, which usually torment students who have managed to learn Lisp on the curriculum. <br><br>  Over time, I wanted to make a cross-platform GUI interface to the interpreter with the perspective of porting to Android, so I implemented the second version of the Java interpreter, the appearance of which you can see in the image above.  Yes, it supports graphical output and in general interoperability with Java, and this Tetris is written in Liscript, part of its code is visible.  Who are interested in the details - I ask under the cat. <br><a name="habracut"></a><br>  Within one article, it is difficult to fit all the features of the language and its implementation, and to write a series of many articles, starting with a lengthy description of the implementation of the parser using the standard library, my modesty will not allow.  (By the way, in both implementations ‚Äî I didn‚Äôt use any parsing libraries in Haskell and Java, but wrote everything manually ‚Äî it took Haskell as much as 10 lines of code).  Therefore, I will write some things in the style of ‚Äúcame, saw, won‚Äù.  In general, I wrote text parsers in AST types.  The only thing I want to mention is a couple of points - I am not a fan of parentheses, but the ease of parsing, the code homoiconnost (code as data) and the lack of infix binary operators with the need to take into account priority and associativity and parsing through Poland or sorting stations outweighs all the claims to this syntax.  As a result of the parsing, I get a list that is passed to the interpretation function.  In the Java implementation, I did not use library list types, but my override was simple, simply connected, not safe, and so on: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Spoiler header</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/**   Liscript -   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConsList</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/**  -     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object car; <span class="hljs-comment"><span class="hljs-comment">/**  -     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ConsList cdr; <span class="hljs-comment"><span class="hljs-comment">/**      . * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> h  -   * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> t  -   */</span></span> ConsList(Object h, ConsList t) { car = h; cdr = t; } <span class="hljs-comment"><span class="hljs-comment">/** ,     * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> / */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isEmpty</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.car == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.cdr == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/**    * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment">  */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">size</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> r = <span class="hljs-number"><span class="hljs-number">0</span></span>; ConsList p = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!p.isEmpty()) {r += <span class="hljs-number"><span class="hljs-number">1</span></span>; p = p.cdr;} <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> r; } <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment">     */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> showVal(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } }</code> </pre> <br></div></div><br>  In a similar way, class types for a function, a macro, are implemented.  Example code of a function type class: <br><br><div class="spoiler">  <b class="spoiler_title">Spoiler header</b> <div class="spoiler_text"><pre> <code class="java hljs"> <span class="hljs-comment"><span class="hljs-comment">/**   Liscript -  */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Func</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/**      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ConsList pars; <span class="hljs-comment"><span class="hljs-comment">/**   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object body; <span class="hljs-comment"><span class="hljs-comment">/** ,     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Env clojure; <span class="hljs-comment"><span class="hljs-comment">/**  * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> p      * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> b   * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> c ,     */</span></span> Func(ConsList p, Object b, Env c) { pars = p; body = b; clojure = c; } <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment">    */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> showVal(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } }</code> </pre> <br></div></div><br><h3>  Environment </h3><br>  Implemented in full compliance with SICP - hierarchical structure of dictionaries, where each dictionary is HashMap &lt;String, Object&gt;, the class contains methods for adding, receiving and changing values ‚Äã‚Äãby a string name.  And here you can already take a creative approach: for example, what to do if you try to get a value by the missing key (variable name)?  Interrupt execution with an error?  Or return a string representation of the key?  The same thing, if we try to add a variable whose name is already contained in the dictionary of the current frame of the environment - give an error or override the variable?  Such trifles as a result determine the peculiarities of the language, and for example, I like that I can define them myself.  We get auto-quote and deep binding, with all the pros and cons of this approach. <br><br>  I also wanted to implement the variable arity of special forms right in the core of the language, and not later in the standard library.  Many of them allow the transmission of a number of parameters and / or do not work quite exactly as their like-named counterparts in other Lisp dialects ‚Äî this does not complicate the implementation of the interpreter.  An example of working with the environment (after =&gt; there is an interpreter's answer): <br><br><pre> <code class="lisp hljs">++ <span class="hljs-string"><span class="hljs-string">"a1 = "</span></span> a1 <span class="hljs-string"><span class="hljs-string">", b1 = "</span></span> b1 <span class="hljs-string"><span class="hljs-string">", c1 = "</span></span> c1 =&gt; a1 = a1, b1 = b1, c1 = c1 def a1 <span class="hljs-number"><span class="hljs-number">1</span></span> b1 (<span class="hljs-name"><span class="hljs-name">+</span></span> a1 <span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">++</span></span> <span class="hljs-string"><span class="hljs-string">"c"</span></span> a1) (<span class="hljs-name"><span class="hljs-name">+</span></span> a1 b1) =&gt; OK ++ <span class="hljs-string"><span class="hljs-string">"a1 = "</span></span> a1 <span class="hljs-string"><span class="hljs-string">", b1 = "</span></span> b1 <span class="hljs-string"><span class="hljs-string">", c1 = "</span></span> c1 =&gt; a1 = <span class="hljs-number"><span class="hljs-number">1</span></span>, b1 = <span class="hljs-number"><span class="hljs-number">2</span></span>, c1 = <span class="hljs-number"><span class="hljs-number">3</span></span> set! (<span class="hljs-name"><span class="hljs-name">++</span></span> <span class="hljs-string"><span class="hljs-string">"a"</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">5</span></span> c1 <span class="hljs-number"><span class="hljs-number">10</span></span> =&gt; OK ++ <span class="hljs-string"><span class="hljs-string">"a1 = "</span></span> a1 <span class="hljs-string"><span class="hljs-string">", b1 = "</span></span> (<span class="hljs-name"><span class="hljs-name">get</span></span> (<span class="hljs-name"><span class="hljs-name">++</span></span> <span class="hljs-string"><span class="hljs-string">"b"</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-string"><span class="hljs-string">", c1 = "</span></span> c1 =&gt; a1 = <span class="hljs-number"><span class="hljs-number">5</span></span>, b1 = <span class="hljs-number"><span class="hljs-number">2</span></span>, c1 = <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre><br><h3>  Functions </h3><br>  They are first class objects.  When created, the function captures the current context.  When called, the arguments are calculated strictly sequentially.  Implemented automatic tail call optimization - TCO: <br><br><pre> <code class="lisp hljs">defn is-even (<span class="hljs-name"><span class="hljs-name">n</span></span>) (<span class="hljs-name"><span class="hljs-name">cond</span></span> (<span class="hljs-name"><span class="hljs-name">=</span></span> n <span class="hljs-number"><span class="hljs-number">0</span></span>) true (<span class="hljs-name"><span class="hljs-name">is-odd</span></span> (<span class="hljs-name"><span class="hljs-name">-</span></span> n <span class="hljs-number"><span class="hljs-number">1</span></span>)) ) =&gt; OK defn is-odd (<span class="hljs-name"><span class="hljs-name">n</span></span>) (<span class="hljs-name"><span class="hljs-name">cond</span></span> (<span class="hljs-name"><span class="hljs-name">=</span></span> n <span class="hljs-number"><span class="hljs-number">0</span></span>) false (<span class="hljs-name"><span class="hljs-name">is-even</span></span> (<span class="hljs-name"><span class="hljs-name">-</span></span> n <span class="hljs-number"><span class="hljs-number">1</span></span>)) ) =&gt; OK is-even <span class="hljs-number"><span class="hljs-number">10000</span></span> =&gt; true is-even <span class="hljs-number"><span class="hljs-number">10001</span></span> =&gt; false</code> </pre><br>  The special form of the tray allows you to print a call stack when applying a function.  So, for example, factorial calculation from 3 occurs: <br><br><div class="spoiler">  <b class="spoiler_title">Spoiler header</b> <div class="spoiler_text"><pre> <code class="lisp hljs">defn f (<span class="hljs-name"><span class="hljs-name">i</span></span>) (<span class="hljs-name"><span class="hljs-name">cond</span></span> (<span class="hljs-name"><span class="hljs-name">&lt;</span></span> i <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">*</span></span> i (<span class="hljs-name"><span class="hljs-name">f</span></span> (<span class="hljs-name"><span class="hljs-name">-</span></span> i <span class="hljs-number"><span class="hljs-number">1</span></span>)))) =&gt; OK tray f <span class="hljs-number"><span class="hljs-number">3</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> ‚Üê (<span class="hljs-name"><span class="hljs-name">f</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Üê f <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Üí (<span class="hljs-name"><span class="hljs-name">lambda</span></span> (<span class="hljs-name"><span class="hljs-name">i</span></span>) (<span class="hljs-name"><span class="hljs-name">cond</span></span> (<span class="hljs-name"><span class="hljs-name">&lt;</span></span> i <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">*</span></span> i (<span class="hljs-name"><span class="hljs-name">f</span></span> (<span class="hljs-name"><span class="hljs-name">-</span></span> i <span class="hljs-number"><span class="hljs-number">1</span></span>))))) <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Üê (<span class="hljs-name"><span class="hljs-name">cond</span></span> (<span class="hljs-name"><span class="hljs-name">&lt;</span></span> i <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">*</span></span> i (<span class="hljs-name"><span class="hljs-name">f</span></span> (<span class="hljs-name"><span class="hljs-name">-</span></span> i <span class="hljs-number"><span class="hljs-number">1</span></span>)))) <span class="hljs-number"><span class="hljs-number">3</span></span> ‚Üê (<span class="hljs-name"><span class="hljs-name">&lt;</span></span> i <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">4</span></span> ‚Üê i <span class="hljs-number"><span class="hljs-number">4</span></span> ‚Üí <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> ‚Üí false <span class="hljs-number"><span class="hljs-number">3</span></span> ‚Üê (<span class="hljs-name"><span class="hljs-name">*</span></span> i (<span class="hljs-name"><span class="hljs-name">f</span></span> (<span class="hljs-name"><span class="hljs-name">-</span></span> i <span class="hljs-number"><span class="hljs-number">1</span></span>))) <span class="hljs-number"><span class="hljs-number">4</span></span> ‚Üê i <span class="hljs-number"><span class="hljs-number">4</span></span> ‚Üí <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> ‚Üê (<span class="hljs-name"><span class="hljs-name">f</span></span> (<span class="hljs-name"><span class="hljs-name">-</span></span> i <span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-number"><span class="hljs-number">5</span></span> ‚Üê f <span class="hljs-number"><span class="hljs-number">5</span></span> ‚Üí (<span class="hljs-name"><span class="hljs-name">lambda</span></span> (<span class="hljs-name"><span class="hljs-name">i</span></span>) (<span class="hljs-name"><span class="hljs-name">cond</span></span> (<span class="hljs-name"><span class="hljs-name">&lt;</span></span> i <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">*</span></span> i (<span class="hljs-name"><span class="hljs-name">f</span></span> (<span class="hljs-name"><span class="hljs-name">-</span></span> i <span class="hljs-number"><span class="hljs-number">1</span></span>))))) <span class="hljs-number"><span class="hljs-number">5</span></span> ‚Üê (<span class="hljs-name"><span class="hljs-name">-</span></span> i <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">6</span></span> ‚Üê i <span class="hljs-number"><span class="hljs-number">6</span></span> ‚Üí <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> ‚Üí <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> ‚Üê (<span class="hljs-name"><span class="hljs-name">cond</span></span> (<span class="hljs-name"><span class="hljs-name">&lt;</span></span> i <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">*</span></span> i (<span class="hljs-name"><span class="hljs-name">f</span></span> (<span class="hljs-name"><span class="hljs-name">-</span></span> i <span class="hljs-number"><span class="hljs-number">1</span></span>)))) <span class="hljs-number"><span class="hljs-number">6</span></span> ‚Üê (<span class="hljs-name"><span class="hljs-name">&lt;</span></span> i <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">7</span></span> ‚Üê i <span class="hljs-number"><span class="hljs-number">7</span></span> ‚Üí <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> ‚Üí false <span class="hljs-number"><span class="hljs-number">6</span></span> ‚Üê (<span class="hljs-name"><span class="hljs-name">*</span></span> i (<span class="hljs-name"><span class="hljs-name">f</span></span> (<span class="hljs-name"><span class="hljs-name">-</span></span> i <span class="hljs-number"><span class="hljs-number">1</span></span>))) <span class="hljs-number"><span class="hljs-number">7</span></span> ‚Üê i <span class="hljs-number"><span class="hljs-number">7</span></span> ‚Üí <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> ‚Üê (<span class="hljs-name"><span class="hljs-name">f</span></span> (<span class="hljs-name"><span class="hljs-name">-</span></span> i <span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-number"><span class="hljs-number">8</span></span> ‚Üê f <span class="hljs-number"><span class="hljs-number">8</span></span> ‚Üí (<span class="hljs-name"><span class="hljs-name">lambda</span></span> (<span class="hljs-name"><span class="hljs-name">i</span></span>) (<span class="hljs-name"><span class="hljs-name">cond</span></span> (<span class="hljs-name"><span class="hljs-name">&lt;</span></span> i <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">*</span></span> i (<span class="hljs-name"><span class="hljs-name">f</span></span> (<span class="hljs-name"><span class="hljs-name">-</span></span> i <span class="hljs-number"><span class="hljs-number">1</span></span>))))) <span class="hljs-number"><span class="hljs-number">8</span></span> ‚Üê (<span class="hljs-name"><span class="hljs-name">-</span></span> i <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">9</span></span> ‚Üê i <span class="hljs-number"><span class="hljs-number">9</span></span> ‚Üí <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> ‚Üí <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> ‚Üê (<span class="hljs-name"><span class="hljs-name">cond</span></span> (<span class="hljs-name"><span class="hljs-name">&lt;</span></span> i <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">*</span></span> i (<span class="hljs-name"><span class="hljs-name">f</span></span> (<span class="hljs-name"><span class="hljs-name">-</span></span> i <span class="hljs-number"><span class="hljs-number">1</span></span>)))) <span class="hljs-number"><span class="hljs-number">9</span></span> ‚Üê (<span class="hljs-name"><span class="hljs-name">&lt;</span></span> i <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">10</span></span> ‚Üê i <span class="hljs-number"><span class="hljs-number">10</span></span> ‚Üí <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> ‚Üí true <span class="hljs-number"><span class="hljs-number">8</span></span> ‚Üí <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> ‚Üí <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> ‚Üí <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> ‚Üí <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> ‚Üí <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> ‚Üí <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Üí <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> ‚Üí <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre><br></div></div><br>  If, when calling the function of arguments, more than the number of formal parameters is passed, then the last formal parameter will be associated with the list of calculated remaining passed arguments.  If it is less, then these formal parameters will not be connected in the environment of the function calculation and in the calculation of its body they will be searched in the environments of the upper level of the hierarchy.  It would be possible to choose the currying option ‚Äî return a partially applied function, or give an error of inconsistency in the number of arguments. <br><br><h3>  Macros </h3><br>  Liscript supports so-called runtime macros, which are objects of the first class of the language.  They can be created, associated with names, returned as a result of functions, and executed during the work (interpretation of the code).  The expression obtained from the source code immediately begins to be interpreted, without the preliminary macros opening stage, so the macros remain full language types and are expanded and calculated during the interpretation according to all macro calculation rules ‚Äî first, the uncalculated passed arguments are substituted into the macro body and then this macro body is calculated in the current environment (as opposed to the function body, which is always calculated in a separate own environment, in which there are already  aritelno calculated values ‚Äã‚Äãof the actual parameters): <br><br><pre> <code class="lisp hljs"> def m (<span class="hljs-name"><span class="hljs-name">macro</span></span> (<span class="hljs-name"><span class="hljs-name">ir</span></span>) (<span class="hljs-name"><span class="hljs-name">cond</span></span> (<span class="hljs-name"><span class="hljs-name">&lt;=</span></span> i <span class="hljs-number"><span class="hljs-number">0</span></span>) 'r (<span class="hljs-name"><span class="hljs-name">m</span></span> (<span class="hljs-name"><span class="hljs-name">-</span></span> i <span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">cons</span></span> ir)))) =&gt; OK m <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span> =&gt; (<span class="hljs-name"><span class="hljs-name">cons</span></span> (<span class="hljs-name"><span class="hljs-name">-</span></span> (<span class="hljs-name"><span class="hljs-name">-</span></span> (<span class="hljs-name"><span class="hljs-name">-</span></span> (<span class="hljs-name"><span class="hljs-name">-</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">cons</span></span> (<span class="hljs-name"><span class="hljs-name">-</span></span> (<span class="hljs-name"><span class="hljs-name">-</span></span> (<span class="hljs-name"><span class="hljs-name">-</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">cons</span></span> (<span class="hljs-name"><span class="hljs-name">-</span></span> (<span class="hljs-name"><span class="hljs-name">-</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">cons</span></span> (<span class="hljs-name"><span class="hljs-name">-</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">cons</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>))))) eval (<span class="hljs-name"><span class="hljs-name">m</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) =&gt; (<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>)</code> </pre><br><h3>  Java Interoperability </h3><br>  Implemented through Java Reflection.  Only 2 special forms: class - defines the class by its full name and java - calls the class method with the passed parameters.  The search for the required method among the overloaded ones of the same name is carried out taking into account the number and types of the passed parameters.  To speed up the work, the class method once found and called in the current session of the interpreter is stored in a table of called methods, and when calling any method, a search is first performed in the table ‚Äî memoization. <br><br><pre> <code class="lisp hljs">def m (<span class="hljs-name"><span class="hljs-name">java</span></span> (<span class="hljs-name"><span class="hljs-name">class</span></span> <span class="hljs-string"><span class="hljs-string">"java.util.HashMap"</span></span>) <span class="hljs-string"><span class="hljs-string">"new"</span></span>) =&gt; OK java m <span class="hljs-string"><span class="hljs-string">"put"</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-string"><span class="hljs-string">"a"</span></span> =&gt; OK java m <span class="hljs-string"><span class="hljs-string">"put"</span></span> <span class="hljs-string"><span class="hljs-string">"b"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> =&gt; OK java m <span class="hljs-string"><span class="hljs-string">"get"</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> =&gt; a m =&gt; {<span class="hljs-number"><span class="hljs-number">1</span></span>=a, b=2}</code> </pre><br>  Thus, we can access many of the resources of the implementation language, including the graph.  This code opens a separate window with a red line drawn on a white background: <br><br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">def</span></span> image (<span class="hljs-name"><span class="hljs-name">java</span></span> (<span class="hljs-name"><span class="hljs-name">class</span></span> <span class="hljs-string"><span class="hljs-string">"java.awt.image.BufferedImage"</span></span>) <span class="hljs-string"><span class="hljs-string">"new"</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>)) (<span class="hljs-name"><span class="hljs-name">def</span></span> imageGraphics (<span class="hljs-name"><span class="hljs-name">java</span></span> image <span class="hljs-string"><span class="hljs-string">"createGraphics"</span></span>)) (<span class="hljs-name"><span class="hljs-name">java</span></span> imageGraphics <span class="hljs-string"><span class="hljs-string">"setBackground"</span></span> (<span class="hljs-name"><span class="hljs-name">java</span></span> (<span class="hljs-name"><span class="hljs-name">class</span></span> <span class="hljs-string"><span class="hljs-string">"java.awt.Color"</span></span>) <span class="hljs-string"><span class="hljs-string">"new"</span></span> <span class="hljs-number"><span class="hljs-number">255</span></span> <span class="hljs-number"><span class="hljs-number">255</span></span> <span class="hljs-number"><span class="hljs-number">255</span></span>)) (<span class="hljs-name"><span class="hljs-name">java</span></span> imageGraphics <span class="hljs-string"><span class="hljs-string">"clearRect"</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>) (<span class="hljs-name"><span class="hljs-name">java</span></span> imageGraphics <span class="hljs-string"><span class="hljs-string">"setColor"</span></span> (<span class="hljs-name"><span class="hljs-name">java</span></span> (<span class="hljs-name"><span class="hljs-name">class</span></span> <span class="hljs-string"><span class="hljs-string">"java.awt.Color"</span></span>) <span class="hljs-string"><span class="hljs-string">"new"</span></span> <span class="hljs-number"><span class="hljs-number">255</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>)) (<span class="hljs-name"><span class="hljs-name">java</span></span> imageGraphics <span class="hljs-string"><span class="hljs-string">"drawLine"</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span>) (<span class="hljs-name"><span class="hljs-name">def</span></span> icon (<span class="hljs-name"><span class="hljs-name">java</span></span> (<span class="hljs-name"><span class="hljs-name">class</span></span> <span class="hljs-string"><span class="hljs-string">"javax.swing.ImageIcon"</span></span>) <span class="hljs-string"><span class="hljs-string">"new"</span></span>)) (<span class="hljs-name"><span class="hljs-name">java</span></span> icon <span class="hljs-string"><span class="hljs-string">"setImage"</span></span> image) (<span class="hljs-name"><span class="hljs-name">def</span></span> label (<span class="hljs-name"><span class="hljs-name">java</span></span> (<span class="hljs-name"><span class="hljs-name">class</span></span> <span class="hljs-string"><span class="hljs-string">"javax.swing.JLabel"</span></span>) <span class="hljs-string"><span class="hljs-string">"new"</span></span>)) (<span class="hljs-name"><span class="hljs-name">java</span></span> label <span class="hljs-string"><span class="hljs-string">"setIcon"</span></span> icon) (<span class="hljs-name"><span class="hljs-name">def</span></span> window (<span class="hljs-name"><span class="hljs-name">java</span></span> (<span class="hljs-name"><span class="hljs-name">class</span></span> <span class="hljs-string"><span class="hljs-string">"javax.swing.JFrame"</span></span>) <span class="hljs-string"><span class="hljs-string">"new"</span></span>)) (<span class="hljs-name"><span class="hljs-name">java</span></span> window <span class="hljs-string"><span class="hljs-string">"setLayout"</span></span> (<span class="hljs-name"><span class="hljs-name">java</span></span> (<span class="hljs-name"><span class="hljs-name">class</span></span> <span class="hljs-string"><span class="hljs-string">"java.awt.FlowLayout"</span></span>) <span class="hljs-string"><span class="hljs-string">"new"</span></span>)) (<span class="hljs-name"><span class="hljs-name">java</span></span> window <span class="hljs-string"><span class="hljs-string">"add"</span></span> label) (<span class="hljs-name"><span class="hljs-name">java</span></span> window <span class="hljs-string"><span class="hljs-string">"setVisible"</span></span> true) (<span class="hljs-name"><span class="hljs-name">java</span></span> window <span class="hljs-string"><span class="hljs-string">"pack"</span></span>)</code> </pre><br>  Of course, you can select typical blocks into separate functions or macros and register them once in the standard library, which is loaded when the interpreter starts.  And since the interpreter implements multi-threaded execution of tasks in separate tabs with a common mutable environment (yes, I know that the HashMap selected as the dictionary repository is not thread-safe and this can create problems when changing the environment from parallel threads, and it was better to use HashTable), so, this allows in one tab to start a procedure that calls itself after a certain waiting time on a timer, and in another window (thread) - a procedure that requests user input and performs  certain actions.  This was how Tetris was implemented (with the feature of blocking user input - each command must be confirmed with Ctrl + Enter). <br><br>  This project is available on Github at <a href="https://github.com/Ivana-/Liscript-GUI-Java-Swing">github.com/Ivana-/Liscript-GUI-Java-Swing</a> .  It contains the source files of the interpreter and its GUI in Swing (I know that it is already 21st century in the yard, but I don‚Äôt rush to rewrite JavaFX), as well as script files of the standard library, language, interpreter descriptions and a sufficient number of demos.  If you wish to criticize, please note that this is my first project in Java and in OOP language in general, so much can be realized nonoptimally.  But I will be interested in opinions and feedback on this project. </div><p>Source: <a href="https://habr.com/ru/post/281859/">https://habr.com/ru/post/281859/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../281847/index.html">How I suffered, raising LTSP with a third-party TFTP server</a></li>
<li><a href="../281849/index.html">Open Server-status in the Electronic Government of Kazakhstan or how to get a database of citizens</a></li>
<li><a href="../281851/index.html">Make a UI plug-in in IntelliJ Idea "like a maven'a"</a></li>
<li><a href="../281855/index.html">Microsoft uncovered historical aspects of Windows development.</a></li>
<li><a href="../281857/index.html">From passport scanner to standalone discerner</a></li>
<li><a href="../281861/index.html">Kite: contextual clues and auto-completion when writing code</a></li>
<li><a href="../281863/index.html">Filtering data in symfony</a></li>
<li><a href="../281865/index.html">Firebird 3.0 released</a></li>
<li><a href="../281867/index.html">PyNSK # 7 - April meeting of the Novosibirsk Python community</a></li>
<li><a href="../281871/index.html">New conference for anyone interested in JavaScript</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>