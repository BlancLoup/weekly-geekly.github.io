<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Orchestration of the CockroachDB DBMS at Kubernetes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Preface of the translator : Literally a week after our publication of acquaintance with CockroachDB , the first final release of this distributed and ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Orchestration of the CockroachDB DBMS at Kubernetes</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  <b>Preface of the translator</b> : Literally a week after our publication of <a href="https://habrahabr.ru/company/flant/blog/327640/">acquaintance with CockroachDB</a> , the first <a href="https://www.nixp.ru/news/14024.html">final release of</a> this distributed and scalable open source DBMS took place, which marked its official readiness for use in production.  And that means it's time to learn how to ‚Äúprepare‚Äù it in the realities of microservices with Kubernetes. </blockquote><br>  This article shows you how to orchestrate deployments and manage an unsafe 3-node CockroachDB cluster using Kubernetes and its <a href="http://kubernetes.io/docs/concepts/abstractions/controllers/statefulsets/">StatefulSet</a> function, which is in beta. <br><img src="https://habrastorage.org/web/aec/838/987/aec83898765f4834ab084ca32e9460de.png"><br>  Yes, launching a stateful application like CockroachDB on Kubernetes requires the use of complex system capabilities that are currently supported at the beta level.  You can run CockroachDB on Kubernetes for testing and easier, however, the approach described here is intended for deploying the DBMS in production, when the necessary functions in Kubernetes are finally ready for this.  <i>(Approx. Translation: about the problem of stateful applications in Kubernetes and one of the approaches to its solution, we told in the <a href="https://habrahabr.ru/company/flant/blog/326414/">material about Kubernetes Operators</a> .)</i> <a name="habracut"></a><br><br>  Please note that an <b>unsecured</b> cluster <i>(i.e., with encryption disabled - approx. Transl.) Is</i> not recommended for production data.  The authors promise to update the manual after the deployment of secure clusters is improved. <br><br><h2>  Step 1. Choosing an environment for deployment </h2><br>  Select the environment in which you will run CockroachDB in Kubernetes: cloudy or local.  The instructions given in the article take into account both options, and each of them has its own nuances. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, for a start, it will be useful to familiarize yourself with the terminology associated with Kubernetes: <br><br><ul><li>  <b><a href="https://kubernetes.io/docs/getting-started-guides/minikube/">minikube</a></b> <i>[relevant only for local use]</i> - a utility that allows you to run a Kubernetes cluster from a single node inside a virtual machine of your computer; <br><br></li><li>  <b>An instance</b> <i>[relevant only for cloud applications]</i> is a physical or virtual machine.  In this guide, a script for Kubernetes will be launched from your local computer, which will remotely create four instances of GCE or AWS and join them to a single cluster Kubernetes; <br><br></li><li>  <b><a href="https://kubernetes.io/docs/concepts/workloads/pods/pod/">pod</a> (under)</b> - a group of one or more Docker containers.  In this tutorial, each of them will run on a separate instance and contain one Docker container, which runs a single CockroachDB node.  We will start with 3 sweeps and increase their number to 4; <br><br></li><li>  <b><a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/">StatefulSet</a></b> is a group of pods considered as stateful units.  Each sub has its own network address and always after restarting is tied back to the same permanent storage.  StatefulSets is a beta-based feature from Kubernetes 1.5; <br><br></li><li>  <b><a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">persistent volume</a> (constant volume)</b> - part of the network storage, i.e.  Persistent Disk for GCE and Elastic Block Store for AWS <i>[in the case of cloud application]</i> , or local storage <i>[in the local case]</i> , mounted in under.  The lifetime of a permanent volume does not depend on the lifetime of the hearth that uses it, and each CockroachDB node, when restarted, is tied back to its old repository. <br><br><ul><li>  Clarification for the cloud: the guide implies that dynamic provisioning is available for volumes.  Otherwise, you must manually create <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">persistent volume claims</a> .  See the steps necessary for this in <a href="">minikube.sh</a> . <br><br></li><li>  For local use: when using minikube, persistent volumes are temporary external directories that continue to exist until they are manually removed or the entire Kubernetes cluster is deleted. <br></li></ul></li><li>  <b><a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">persistent volume claim</a></b> <i>[pertinent to local use only]</i> - when pods are created (one for each CockroachDB node), each of them requests a persistent volume claim to determine the persistent storage for its node. </li></ul><br><h2>  Step 2. Installing and running Kubernetes </h2><br><h3>  In the cloud </h3><br>  Install and run the Kubernetes cluster from your computer according to the project documentation: <br><br><ul><li>  For GCE instructions, see <a href="https://kubernetes.io/docs/getting-started-guides/gce/">Running Kubernetes on Google Compute Engine</a> . </li><li>  For AWS instructions, see ‚Äú <a href="https://kubernetes.io/docs/getting-started-guides/aws/">Running Kubernetes on AWS EC2</a> ‚Äù. </li></ul><br>  The central part of this step will be the launch of the Kubernetes script, which will create four instances of GCE or AWS, combining them into a single cluster of Kubernetes - and all this remotely from your computer.  Subsequent steps will also be performed from your computer. <br><br><h3>  Locally </h3><br>  According to the <a href="https://kubernetes.io/docs/getting-started-guides/minikube/">Kubernetes documentation,</a> install minikube and kubectl for your operating system.  After that, start the local cluster Kubernetes: <br><br><pre><code class="bash hljs">$ minikube start Starting <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Kubernetes cluster... Kubectl is now configured to use the cluster.</code> </pre> <br><h2>  Step 3. Launch the CockroachDB Cluster </h2><br><h3>  In the cloud </h3><br>  Use the ready <a href="">-made cockroachdb-statefulset.yaml</a> file to create the StatefulSet from your computer: <br><br><pre> <code class="bash hljs">kubectl create -f https://raw.githubusercontent.com/cockroachdb/cockroach/master/cloud/kubernetes/cockroachdb-statefulset.yaml</code> </pre> <br><blockquote>  <b>Translator's note</b> : Before using ready-made <code>cockroachdb-statefulset.yaml</code> from the developers at Cockroach Labs, it is useful to examine its contents.  Fortunately, the authors took care of comments that help in understanding what and how unfolds in Kubernetes.  And, of course, you can modify it in accordance with your expectations from the experimental or combat operation of CockroachDB. </blockquote><br><h3>  Locally </h3><br>  Download the <a href="">minikube.sh</a> script and the <a href="">cockroachdb-statefulset.yaml</a> configuration file, run the script: <br><br><pre> <code class="bash hljs">$ wget https://raw.githubusercontent.com/cockroachdb/cockroach/master/cloud/kubernetes/minikube.sh $ wget https://raw.githubusercontent.com/cockroachdb/cockroach/master/cloud/kubernetes/cockroachdb-statefulset.yaml $ sh minikube.sh</code> </pre> <br>  This script automates the process of creating persistent volumes and persistent volume claims.  It also executes the <code>kubectl create</code> command with the <code>cockroachdb-statefulset.yaml</code> configuration to create a StatefulSet. <br><br><h3>  General </h3><br>  Further actions of this step are common for cloud and local applications. <br><br>  Use the <code>kubectl get</code> command to verify that persistent volumes and corresponding claims were created: <br><br><pre> <code class="bash hljs">$ kubectl get persistentvolumes NAME CAPACITY ACCESSMODES RECLAIMPOLICY STATUS CLAIM REASON AGE pvc-52f51ecf-8bd5-11e6-a4f4-42010a800002 1Gi RWO Delete Bound default/datadir-cockroachdb-0 26s pvc-52fd3a39-8bd5-11e6-a4f4-42010a800002 1Gi RWO Delete Bound default/datadir-cockroachdb-1 27s pvc-5315efda-8bd5-11e6-a4f4-42010a800002 1Gi RWO Delete Bound default/datadir-cockroachdb-2 27s</code> </pre> <br>  For local volumes, the output of the same command will look like this: <br><br><pre> <code class="bash hljs">NAME CAPACITY ACCESSMODES STATUS CLAIM REASON AGE pv0 1Gi RWO Bound default/datadir-cockroachdb-0 27s pv1 1Gi RWO Bound default/datadir-cockroachdb-1 26s pv2 1Gi RWO Bound default/datadir-cockroachdb-2 26s</code> </pre><br>  Wait a bit and make sure that the three hearths were also successfully created  If you still don‚Äôt see them, wait and check again: <br><br><pre> <code class="bash hljs">$ kubectl get pods NAME READY STATUS RESTARTS AGE cockroachdb-0 1/1 Running 0 2m cockroachdb-1 1/1 Running 0 2m cockroachdb-2 1/1 Running 0 2m</code> </pre> <br>  The StatefulSet configuration configures all the CockroachDB nodes to write to stderr, so if you need access to the subsea logs or nodes for analyzing problems, use the <code>kubectl logs &lt;podname&gt;</code> instead of the ‚Äúphysical‚Äù log check on the actual sub. <br><br><h2>  Step 4. Using the embedded SQL client </h2><br>  Run the embedded SQL client in an interactive temporary (created for one-time use) pod, substituting the host name <code>cockroachdb-public</code> to connect to the CockroachDB cluster: <br><br><pre> <code class="bash hljs">$ kubectl run cockroachdb -it --image=cockroachdb/cockroach --rm --restart=Never \ -- sql --insecure --host=cockroachdb-public</code> </pre> <br>  Run the CockroachDB SQL commands (for more information, see the <a href="https://www.cockroachlabs.com/docs/sql-statements.html">project documentation</a> ): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> bank; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> bank.accounts (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, balance <span class="hljs-built_in"><span class="hljs-built_in">DECIMAL</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> bank.accounts <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1234</span></span>, <span class="hljs-number"><span class="hljs-number">10000.50</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> bank.accounts; +<span class="hljs-comment"><span class="hljs-comment">------+----------+ | id | balance | +------+----------+ | 1234 | 10000.50 | +------+----------+ (1 row)</span></span></code> </pre> <br>  When the execution of commands in the SQL client is complete, press &lt;Ctrl&gt; + &lt;d&gt;, &lt;Ctrl&gt; + &lt;c&gt; or enter the <code>\q</code> command to exit and delete the temporary sub. <br><br><h2>  Step 5. Simulation of a node fall </h2><br>  According to <code>replicas: 3</code> in the StatefulSet configuration, Kubernetes checks that three sub-sites / nodes are constantly running.  If the / node falls, Kubernetes will automatically create a new one with the same network name and persistent storage. <br><br>  Let's look at it in action: <br><br><ol><li>  Kill one of the CockroachDB nodes: <br><br><pre> <code class="bash hljs">$ kubectl delete pod cockroachdb-2 pod <span class="hljs-string"><span class="hljs-string">"cockroachdb-2"</span></span> deleted</code> </pre> <br></li><li>  Check that under restarted: <br><br><pre> <code class="bash hljs">$ kubectl get pod cockroachdb-2 NAME READY STATUS RESTARTS AGE cockroachdb-2 0/1 ContainerCreating 0 3s</code> </pre> <br></li><li>  Wait a bit and check that it is ready to work: <br><br><pre> <code class="bash hljs">$ kubectl get pod cockroachdb-2 NAME READY STATUS RESTARTS AGE cockroachdb-2 1/1 Running 0 1m</code> </pre> </li></ol><br><h2>  Step 6. Cluster scaling </h2><br><h3>  In the cloud </h3><br>  The Kubernetes script created 4 nodes: 1 master and 3 workers (workers).  The pods are placed only on the working nodes, so to be sure that you will not have two pods on one node (see recommendations in <a href="https://www.cockroachlabs.com/docs/recommended-production-settings.html">best practices</a> for production), you need to add a new working node and edit the StatefulSet configuration, adding another one. <br><br><ol><li>  Add a working node.  To do this, resize the <a href="https://cloud.google.com/compute/docs/instance-groups/">Managed Instance Group</a> on the GCE and resize the <a href="https://docs.aws.amazon.com/autoscaling/latest/userguide/as-manual-scaling.html">Auto Scaling Group</a> on the AWS. </li><li>  Use the <code>kubectl scale</code> command to add a sub into the StatefulSet: <br><br><pre> <code class="bash hljs">$ kubectl scale statefulset cockroachdb --replicas=4 statefulset <span class="hljs-string"><span class="hljs-string">"cockroachdb"</span></span> scaled</code> </pre> <br></li><li>  Make sure the fourth sub has been added: <br><br><pre> <code class="bash hljs">$ kubectl get pods NAME READY STATUS RESTARTS AGE cockroachdb-0 1/1 Running 0 2h cockroachdb-1 1/1 Running 0 2h cockroachdb-2 1/1 Running 0 9m cockroachdb-3 1/1 Running 0 46s</code> </pre> </li></ol><br><h3>  Locally </h3><br>  To increase the number of pods, it is enough to run the same <code>kubectl scale</code> command, and then check the success of the operation performed ( <code>kubectl get pods</code> ). <br><br><h2>  Step 7. Stop the cluster </h2><br><h3>  In the cloud </h3><br>  To stop a CockroachDB cluster: <br><br><ol><li>  Use the <code>kubectl delete</code> command to clear all created resources (including logs and remote persistent volumes): <br><br><pre> <code class="bash hljs">$ kubectl delete pods,statefulsets,services,persistentvolumeclaims,persistentvolumes,poddisruptionbudget \ -l app=cockroachdb</code> </pre> <br></li><li>  Run the <code>cluster/kube-down.sh</code> from the <code>kubernetes</code> directory. </li></ol><br>  <i><b>Note</b> : if you stop Kubernetes without first deleting resources, the deleted persistent volumes will continue to exist in your cloud.</i> <br><br><h3>  Locally </h3><br><ul><li>  If you plan to start the cluster again, use the <code>minikube stop</code> command.  It will turn off the virtual machine with minikube, but will save all the resources created: <br><br><pre> <code class="bash hljs">$ minikube stop Stopping <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Kubernetes cluster... Machine stopped.</code> </pre> <br>  Recovery of the cluster in the last state is possible using the <code>minikube start</code> command. <br><br></li><li>  If you are not planning further cluster launches, use the <code>minikube delete</code> command.  It will turn off and delete the virtual machine with minikube and all created resources (including permanent volumes): <br><br><pre> <code class="bash hljs">$ minikube delete Deleting <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Kubernetes cluster... Machine deleted.</code> </pre> </li></ul><br>  <i><b>Note</b> : to save the logs, copy them from the stderr of each hearth before removing the cluster and all its resources.</i>  <i>To access the stderr stream, use the command <code>kubectl logs &lt;podname&gt;</code> .</i> <br><br><blockquote>  <b>Translator's afterword</b> : The material translated here from the Cockroach Labs website <i>(link is</i> provided <i>in the source)</i> corresponds to the <a href="">document in the markdown markup</a> , updated in the project's Git repository. <br><br>  We ourselves do not use CockroachDB in production yet, but we look closely at this interesting project and see in it real potential. </blockquote></div><p>Source: <a href="https://habr.com/ru/post/328756/">https://habr.com/ru/post/328756/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../328744/index.html">MyTaskHelper online database designer: create relational databases without programming knowledge</a></li>
<li><a href="../328746/index.html">We order translations and copywriting - the results of the project for 2 years</a></li>
<li><a href="../328748/index.html">Security threats in electronic postage stamp systems</a></li>
<li><a href="../328750/index.html">The reverse side of the ticket. How Tutu.ru helps to choose the best rate</a></li>
<li><a href="../328752/index.html">Guide React Native - create an application for iOS. Part 1.1</a></li>
<li><a href="../328760/index.html">Do cats know how to build regression?</a></li>
<li><a href="../328762/index.html">On fear of paranoids: where did the development of an analytics system lead us to fight industrial espionage?</a></li>
<li><a href="../328764/index.html">Multi-armed bandit in the task of finding objects in the video stream</a></li>
<li><a href="../328766/index.html">Applications for iOS, Android and Mac for developers</a></li>
<li><a href="../328768/index.html">Connecting to xxx.xxx.xx.xxx:443 ... failed: Unknown error or warned - so armed</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>