<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Text Template Transformation Toolkit (T4), Part 2: Template Generators</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings, Habr! 

 This article will continue the topic of automatic code generation in Visual Studio using the T4 - Text Template Transformation Too...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">🔎</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">📜</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">⬆️</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">⬇️</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Text Template Transformation Toolkit (T4), Part 2: Template Generators</h1><div class="post__text post__text-html js-mediator-article">  Greetings, Habr! <br><br>  This article will continue the topic of automatic code generation in Visual Studio using the T4 - Text Template Transformation Toolkit.  <a href="http://habrahabr.ru/blogs/net/64895/">Part number 1</a> , a little earlier published in this blog, described the syntax T4 and the basic principles of its use.  This time I decided to explore the blog of the respected <a href="http://www.olegsych.com/">Oleg Sych in</a> more detail and to adapt a few more of his ideas to the habrew Audience.  In particular, today we will discuss the following topics: <ul><li>  Creating reusable and parameterizable templates </li><li>  Creating Template Generators </li><li>  Debugging, testing and extending generators (links) </li></ul><br>  I did not invent any special examples.  The history of the development of a query with the creation of a stored procedure, described by Oleg, is ideal for illustrating a problem that may require generators.  And, characteristically, not a far-fetched problem.  The article also adheres to the principle “less words - more code”. <br>  Hereinafter, it is assumed that you have Visual Studio 2005/2008/2010 installed, as well as <a href="http://www.codeplex.com/t4toolbox">T4 Toolbox</a> . <br><br><a name="habracut"></a><br><h2>  Parameterizable templates </h2><br><h4>  initial stage </h4><br>  So, we have a database.  There is a table in this database.  And in the table, in the best traditions of Koshchey Immortal, there is a line that we wish to remove.  Moreover, it is not just a delete, but a newly created stored procedure.  Let, for simplicity, the parameters passed to the procedure — every single table field, by which the lines to be deleted are identified.  To fill the request to create such a procedure manually is a thankless job, so we use T4 and create code similar to the one below: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote><code>&lt;#@ <font color="brown">template</font> <font color="red">language=</font> “ <font color="blue">C#v3.5</font> ” #&gt; <br> &lt;#@ <font color="brown">output</font> <font color="red">extension=</font> “ <font color="blue">SQL</font> ” #&gt; <br> &lt;#@ <font color="brown">assembly</font> <font color="red">name=</font> “ <font color="blue">Microsoft.SqlServer.ConnectionInfo</font> ” #&gt; <br> &lt;#@ <font color="brown">assembly</font> <font color="red">name=</font> “ <font color="blue">Microsoft.SqlServer.Smo</font> ” #&gt; <br> &lt;#@ <font color="brown">import</font> <font color="red">namespace=</font> “ <font color="blue">Microsoft.SqlServer.Management.Smo</font> ” #&gt;&lt;# <br> <font color="#191970">Server server = new Server(); <br> Database database = new Database(server, “Northwind”); <br> Table table = new Table(database, “Products”); <br> table.Refresh(); <br></font> #&gt; <br> <font color="gray">create procedure</font> &lt;#= <font color="#191970">table.Name</font> #&gt; <font color="gray">_Delete <br></font> &lt;# <br> <font color="#191970">PushIndent(”\t”); <br> foreach (Column column in table.Columns) <br> if (column.InPrimaryKey) <br> WriteLine(”@” + column.Name + ” ” + column.DataType.Name); <br> PopIndent(); <br></font> #&gt; <br> <font color="gray">as <br> delete from</font> &lt;#= <font color="#191970">table.Name</font> #&gt; <br> <font color="red">&nbsp;&nbsp;&nbsp;&nbsp;</font> <font color="gray">where <br></font> &lt;# <br> <font color="#191970">PushIndent(”\t</font> \ <font color="#191970">t”); <br> foreach (Column column in table.Columns) <br> if (column.InPrimaryKey) <br> WriteLine(column.Name + ” = @” + column.Name); <br> PopIndent(); <br></font> #&gt; <font color="red">&nbsp;&nbsp;&nbsp;&nbsp;</font></code> </blockquote><br>  Here, <a href="http://msdn.microsoft.com/en-us/library/ms162169.aspx">SQL Server Management Objects</a> (SMO) is used to get information about table fields from a local SQL server <a href="http://msdn.microsoft.com/en-us/library/ms162169.aspx">database</a> .  After saving the file, we get the required query at the output.  For example, it might look like this: <br><br><blockquote> <code><font color="blue">create procedure</font> Products_Delete <br> @ProductID <font color="blue">int <br> as <br> delete from</font> Products <br> <font color="blue">where</font> ProductID = @ProductID</code> </blockquote> <br><h4>  Parameterization </h4><br>  The first question that should arise in the head of a person who has looked at this code: why are the database names and tables rigidly packed into the code?  So, to create each new request, the programmer will have to climb into the template and change it manually in several places? <br>  Actually not necessarily.  It is enough to use another method of generation.  Add a new file to the project, using the Template option instead of the File from the T4 Toolbox, let's call it, for example, DeleteProcedureTemplate.tt.  As you can see, the environment has automatically created a template parameterization, that is, a file, which we will later include in other templates in order to use it in a generalized form. <br><br><blockquote> <code><font color="black">&lt;#+ <br></font> <font color="green">// &lt;copyright file=”DeleteProcedureTemplate.tt” company=”Your Company”&gt; <br> //  Copyright © Your Company. All Rights Reserved. <br> // &lt;/copyright&gt; <br> <br></font> <font color="blue">public class</font> <font color="black">DeleteProcedureTemplate : Template <br> { <br></font> <font color="blue">protected override void</font> <font color="black">RenderCore() <br> { <br> <br> } <br> } <br> #&gt;</font></code> </blockquote> <br>  Do not try to find the Template class in the Microsoft.VisualStudio.TextTemplating namespace: it is not there.  This is an abstract class defined in T4Toolbox, and the T4Toolbox.tt file does not make sense to include directly in the parameterized templates themselves.  Therefore, each time DeleteProcedureTemplate.tt is saved, Studio will attempt to process it, generate an output file, crash and notify you with an error.  This unpleasant behavior can be easily removed by looking into the Properties window for our edited file and setting the Custom Tool property to an empty line.  Now attempts of implicit generation do not occur. <br>  The RenderCore () method of the Template class is the main point of operation of a parameterized template.  It is in it that the part of the text is generated, for which our pattern in the generator will ultimately be responsible.  Therefore, without further ado, we simply transfer the ready code into it. <br><br><blockquote> <code>&lt;#@ <font color="brown">assembly</font> <font color="red">name=</font> “ <font color="blue">Microsoft.SqlServer.ConnectionInfo</font> ” #&gt; <br> &lt;#@ <font color="brown">assembly</font> <font color="red">name=</font> “ <font color="blue">Microsoft.SqlServer.Smo</font> ” #&gt; <br> &lt;#@ <font color="brown">import</font> <font color="red">namespace=</font> “ <font color="blue">Microsoft.SqlServer.Management.Smo</font> ” #&gt; <br> &lt;#+ <br> <font color="#191970">public class DeleteProcedureTemplate : Template <br> { <br> public string DatabaseName; <br> public string TableName; <br> <br> protected override void RenderCore() <br> { <br> Server server = new Server(); <br> Database database = new Database(server, DatabaseName); <br> Table table = new Table(database, TableName); <br> table.Refresh(); <br></font> #&gt; <br> <font color="gray">create procedure</font> &lt;#= <font color="#191970">table.Name</font> #&gt; <font color="gray">_Delete <br></font> &lt;#+ <br> <font color="#191970">PushIndent(”\t”); <br> foreach (Column column in table.Columns) <br> { <br> if (column.InPrimaryKey) <br> WriteLine(”@” + column.Name + ” ” + column.DataType.Name); <br> } <br> PopIndent(); <br></font> #&gt; <br> <font color="gray">as <br> delete from</font> &lt;#= <font color="#191970">table.Name</font> #&gt; <br> <font color="red">&nbsp;&nbsp;&nbsp;&nbsp;</font> <font color="gray">where <br></font> &lt;#+ <br> <font color="#191970">PushIndent(”\t</font> \ <font color="#191970">t”); <br> foreach (Column column in table.Columns) <br> { <br> if (column.InPrimaryKey) <br> WriteLine(column.Name + ” = @” + column.Name); <br> } <br> PopIndent(); <br> } <br> } <br></font> #&gt;</code> </blockquote> <br>  The main change to which the template has been subjected is the addition of the open fields DatabaseName and TableName, which, in fact, perform the parameterization function.  Now the data and logic files are separated.  The only thing that remains is to use the include directive and run the same template alternately on different databases and tables, like this: <br><br><blockquote> <code><font color="black">&lt;#@</font> <font color="brown">template</font> <font color="red">language</font> <font color="black">=”</font> <font color="blue">C#v3.5</font> <font color="black">”</font> <font color="red">hostspecific</font> <font color="black">=”</font> <font color="blue">True</font> <font color="black">” #&gt; <br> &lt;#@</font> <font color="brown">output</font> <font color="red">extension</font> <font color="black">=”</font> <font color="blue">sql</font> <font color="black">” #&gt; <br> &lt;#@</font> <font color="brown">include</font> <font color="red">file</font> <font color="black">=”</font> <font color="blue">T4Toolbox.tt</font> <font color="black">” #&gt; <br> &lt;#@</font> <font color="brown">include</font> <font color="red">file</font> <font color="black">=”</font> <font color="blue">DeleteProcedureTemplate.tt</font> <font color="black">” #&gt; <br> &lt;# <br> DeleteProcedureTemplate template =</font> <font color="blue">new</font> <font color="black">DeleteProcedureTemplate(); <br> template.DatabaseName =</font> <font color="maroon">“Northwind”</font> <font color="black">; <br> template.TableName =</font> <font color="maroon">“Products”</font> <font color="black">; <br> template.Render(); <br> #&gt;</font></code> </blockquote> <br>  If desired, a similar method can be used to create a universal template that creates, depending on the parameters, a stored procedure based on SELECT, INSERT and UPDATE, and not just DELETE.  The code for the template, anyone can now make their own <br><br>  A small retreat to the side.  At first glance, all the material described seems elementary.  Yes, in fact, he is so, like the whole T4 in itself.  The question is different: these features are included in the standard delivery, and with such a simple compilation article I want to protect readers (and readers of Habr of different degrees of experience) from the danger of building their own bicycles.  The pattern generators described below are another one of these pitfalls. <br><br><h2>  Pattern Generators </h2><br>  There is still one unaccounted bug in the parameterized templates.  Yes, we have taken out the logic of launching a template with specific database names and tables into a separate file, but in the case of working with several possible databases and tables, such a solution is a replacement for soap.  The programmer is still forced to produce separate template files for each specific table.  Let these files now noticeably shrunk in size, but no one has canceled the copy-paste problem.  Ideally, I would like to create separate requests for each table of this particular database in one movement.  Is it possible  Yes. <br><br>  Add to the project a third useful template type, developed in the framework of the T4Toolbox - Generator.  The generator will use our parameterized template in order to substitute in it different values ​​of parameters (database names and tables) and send the result of processing to different files.  With the latter purpose, the Template class provides a great RenderToFile method. <br><br>  So, let the generator file is called CrudProcedureGenerator.tt and the default procurement for it, as you can see for yourself, is as follows: <br><br><blockquote> <code><font color="black">&lt;#+ <br></font> <font color="green">// &lt;copyright file=”CrudProcedureGenerator.tt” company=”Your Company”&gt; <br> //  Copyright © Your Company. All Rights Reserved. <br> // &lt;/copyright&gt; <br> <br></font> <font color="blue">public class</font> <font color="black">CrudProcedureGenerator : Generator <br> { <br></font> <font color="blue">protected override void</font> <font color="black">RunCore() <br> { <br> <br> } <br> } <br> #&gt;</font></code> </blockquote> <br>  The generator itself does not carry out any processing of the text T4, it only launches in turn other, already written basic templates.  Therefore, its corresponding basic methods instead of Render and RenderCore are called Run and RunCore, respectively.  We arrange them for ourselves: <br><br><blockquote> <code><font color="black">&lt;#@</font> <font color="brown">assembly</font> <font color="red">name</font> <font color="black">=”</font> <font color="blue">Microsoft.SqlServer.ConnectionInfo</font> <font color="black">” #&gt; <br> &lt;#@</font> <font color="brown">assembly</font> <font color="red">name</font> <font color="black">=”</font> <font color="blue">Microsoft.SqlServer.Smo</font> <font color="black">” #&gt; <br> &lt;#@</font> <font color="brown">import</font> <font color="red">namespace</font> <font color="black">=”</font> <font color="blue">Microsoft.SqlServer.Management.Smo</font> <font color="black">” #&gt; <br> &lt;#@</font> <font color="brown">include</font> <font color="red">file</font> <font color="black">=”</font> <font color="blue">DeleteProcedureTemplate.tt</font> <font color="black">” #&gt; <br> &lt;#+ <br></font> <font color="blue">public class</font> <font color="black">CrudProcedureGenerator : Generator <br> { <br></font> <font color="blue">public string</font> <font color="black">DatabaseName; <br></font> <font color="blue">public</font> <font color="black">DeleteProcedureTemplate DeleteTemplate =</font> <font color="blue">new</font> <font color="black">DeleteProcedureTemplate(); <br> <br></font> <font color="blue">protected override void</font> <font color="black">RunCore() <br> { <br> Server server =</font> <font color="blue">new</font> <font color="black">Server(); <br> Database database =</font> <font color="blue">new</font> <font color="black">Database(server,</font> <font color="blue">this</font> <font color="black">.DatabaseName); <br> database.Refresh(); <br></font> <font color="blue">foreach</font> <font color="black">(Table table</font> <font color="blue">in</font> <font color="black">database.Tables) <br> { <br></font> <font color="blue">this</font> <font color="black">.DeleteTemplate.DatabaseName =</font> <font color="blue">this</font> <font color="black">.DatabaseName; <br></font> <font color="blue">this</font> <font color="black">.DeleteTemplate.TableName = table.Name; <br></font> <font color="blue">this</font> <font color="black">.DeleteTemplate.RenderToFile(table.Name +</font> <font color="maroon">“_Delete.sql”</font> <font color="black">); <br> } <br> } <br> } <br> #&gt;</font></code> </blockquote> <br>  All tables in one given database are searched here and for each instance of the DeleteProcedureTemplate class creates a separate unique output file with a query.  For complete happiness, all you need is to set a database and run a full processing cycle: <br><br><blockquote> <code><font color="black">&lt;#@</font> <font color="brown">template</font> <font color="red">language</font> <font color="black">=”</font> <font color="blue">C#v3.5</font> <font color="black">”</font> <font color="red">hostspecific</font> <font color="black">=”</font> <font color="blue">True</font> <font color="black">”</font> <font color="red">debug</font> <font color="black">=”</font> <font color="blue">True</font> <font color="black">” #&gt; <br> &lt;#@</font> <font color="brown">output</font> <font color="red">extension</font> <font color="black">=”</font> <font color="blue">txt</font> <font color="black">” #&gt; <br> &lt;#@</font> <font color="brown">include</font> <font color="red">file</font> <font color="black">=”</font> <font color="blue">T4Toolbox.tt</font> <font color="black">” #&gt; <br> &lt;#@</font> <font color="brown">include</font> <font color="red">file</font> <font color="black">=”</font> <font color="blue">CrudProcedureGenerator.tt</font> <font color="black">” #&gt; <br> &lt;# <br> CrudProcedureGenerator generator =</font> <font color="blue">new</font> <font color="black">CrudProcedureGenerator(); <br> generator.DatabaseName =</font> <font color="maroon">“Northwind”</font> <font color="black">; <br> generator.Run(); <br> #&gt;</font></code> </blockquote> <br>  Result on your screens: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5ff/fcf/cf2/5fffcfcf2d7a19a7ea913af4e34266e8.png"><br><h2>  P.S.  Features of the use of generators </h2><br>  Following the usual logic, the article about the generators would be necessary to complete the notes on how to debug them, test and modify them painlessly for advanced needs.  Unfortunately, this one habrastatya simply can not stand such an excess of program code, but I don’t want to take it to the third part either, the material will turn out to be poor and cut off from the team.  Therefore, I will confine myself to advice, on the basis of which, as well as the source code from Oleg Sych’s blog, the reader will be able to use generators in life without any problems. <ol><li>  To test the generators in the T4 Toolbox has its own excellent billet called "Unit Test". </li><li>  If it is necessary to modify the heart of generation — the code created by the template — there is no need to directly edit the file with its class (in this case, DeleteProcedureTemplate).  It is enough to import one more file into the generator in which to describe the successor of our template with the required corrections. </li><li>  The Generator class has a function called Validate, which is called first by the Run method, before you start directly generating code (RunCore).  It can be used to check the input parameters of the generator. </li><li>  For error reporting, you can use the Error and Warning methods, similar to those discussed in the TextTransformation class. </li></ol>  Related Links: <br>  <a href="http://www.olegsych.com/2008/11/t4-tutorial-handling-errors-in-code-generators/">Handling errors in code generators</a> <br>  <a href="http://www.olegsych.com/2008/11/t4-tutorial-unit-testing-code-generators/">Unit testing code generators</a> <br>  <a href="http://www.olegsych.com/2009/02/t4-tutorial-making-code-generators-extensible/">Making code generators extensible</a> <br></div><p>Source: <a href="https://habr.com/ru/post/65716/">https://habr.com/ru/post/65716/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../65709/index.html">Apple introduced the new iPhone, which only the most loyal customers can see</a></li>
<li><a href="../65711/index.html">Windows 7 Ultimate Hacked</a></li>
<li><a href="../65712/index.html">Sony Walkman X-series NWZ-X1060 / X1050</a></li>
<li><a href="../65714/index.html">Using XML-RPC in Drupal. Quickstart</a></li>
<li><a href="../65715/index.html">Interactive magazine cover. Almost reality</a></li>
<li><a href="../65721/index.html">Five elementary techniques from the arsenal of writers</a></li>
<li><a href="../65722/index.html">Misunderstanding of markup. XHTML 2 and HTML5 Comics</a></li>
<li><a href="../65723/index.html">GNOME Nautilus: setting up the main panel</a></li>
<li><a href="../65724/index.html">Firefox 3.6 Details for Developers</a></li>
<li><a href="../65732/index.html">Shared hosting on Windows Server 2008 platform (ISPserver)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>