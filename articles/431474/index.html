<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Microservice architecture on a modern stack of Java technologies</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We had JDK 11, Kotlin, Spring 5 and Spring Boot 2, Gradle 5 with production-ready Kotlin DSL, JUnit 5, and another half a dozen Spring Cloud stack lib...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Microservice architecture on a modern stack of Java technologies</h1><div class="post__text post__text-html js-mediator-article">  <i>We had JDK 11, Kotlin, Spring 5 and Spring Boot 2, Gradle 5 with production-ready Kotlin DSL, JUnit 5, and another half a dozen Spring Cloud stack libraries for Service discovery, creating API gateway, client balancing, implementing the Circuit breaker pattern , writing declarative HTTP clients, distributed tracing and all that.</i>  <i>Not that all this was needed to create a microservice architecture - only just for fun ...</i> <br><a name="habracut"></a><br><h1>  Introduction </h1><br>  In this article, you will see an example of a microservice architecture on technologies that are relevant in the Java world, the main of which are given below (these versions are used in the project at the time of publication): <br><table><tbody><tr><th>  Technology type </th><th>  Title </th><th>  Version </th></tr><tr><td>  Platform </td><td>  <a href="https://jdk.java.net/11/">JDK</a> </td><td>  11.0.1 </td></tr><tr><td>  Programming language </td><td>  <a href="https://kotlinlang.org/">Kotlin</a> </td><td>  1.3.10 </td></tr><tr><td rowspan="2">  Application framework </td><td>  <a href="https://spring.io/projects/spring-framework">Spring framework</a> </td><td>  5.0.9 </td></tr><tr><td>  <a href="https://spring.io/projects/spring-boot">Spring boot</a> </td><td>  2.0.5 </td></tr><tr><td rowspan="2">  Assembly system </td><td>  <a href="https://gradle.org/">Gradle</a> </td><td>  5.0 </td></tr><tr><td>  <a href="https://docs.gradle.org/current/userguide/kotlin_dsl.html">Gradle kotlin dsl</a> </td><td>  1.0.4 </td></tr><tr><td>  Unit testing framework </td><td>  <a href="https://junit.org/junit5/">Junit</a> </td><td>  5.1.1 </td></tr><tr><td colspan="3" align="center">  <a href="https://spring.io/projects/spring-cloud">Spring cloud</a> </td></tr><tr><td>  Single access point (API gateway) </td><td>  <a href="https://spring.io/projects/spring-cloud-gateway">Spring cloud gateway</a> </td><td rowspan="7">  Included in the Spring Cloud Release train Finchley SR2 </td></tr><tr><td>  Centralized configuration </td><td>  <a href="https://spring.io/projects/spring-cloud-config">Spring cloud config</a> </td></tr><tr><td>  Request Tracing (Distributed tracing) </td><td>  <a href="https://spring.io/projects/spring-cloud-sleuth">Spring cloud sleuth</a> </td></tr><tr><td>  Declarative HTTP client </td><td>  <a href="https://spring.io/projects/spring-cloud-openfeign">Spring cloud openfeign</a> </td></tr><tr><td>  Service discovery </td><td>  <a href="https://spring.io/projects/spring-cloud-netflix">Spring cloud netflix eureka</a> </td></tr><tr><td>  Circuit breaker </td><td>  <a href="https://spring.io/projects/spring-cloud-netflix">Spring cloud netflix hystrix</a> </td></tr><tr><td>  Client load balancing </td><td>  <a href="https://spring.io/projects/spring-cloud-netflix">Spring Cloud Netflix Ribbon</a> </td></tr></tbody></table><br>  The project consists of 5 microservices: 3 infrastructure (Config server, Service discovery server, UI gateway) and examples of the front-end (Items UI) and back-end (Services service): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/jz/rw/ia/jzrwiaehuhksnkj2dzmjea-43fy.png"></div><br>  All of them will be discussed below.  In the ‚Äúcombat‚Äù project, obviously, there will be much more microservices implementing any business functionality.  Their addition to a similar architecture is technically similar to the Items UI and Items service. <br><br><h3>  Disclaimer </h3><br>  The article does not consider the tools for containerization and orchestration, since at present they are not used in the project. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  Config server </h1><br>  Spring Cloud Config was used to create a centralized repository for application configurations.  Configs can be read from various sources, for example, a separate git repository;  In this project, for simplicity and clarity, they are in the application resources: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sm/35/af/sm35aft9609348sicenfjgosw1k.png"></div><br>  The configuration of the Config server itself ( <code>application.yml</code> ) looks like this: <br><br><pre> <code class="plaintext hljs">spring: profiles: active: native cloud: config: server: native: search-locations: classpath:/config server: port: 8888</code> </pre> <br>  Using port 8888 allows Config server clients not to explicitly specify its port in their <code>bootstrap.yml</code> .  At startup, they load their config by executing a GET request to the HTTP API Config server. <br><br>  The program code of this microservice consists of just one file, which contains the declaration of the application class and the main method, which, unlike the equivalent Java code, is a top-level function: <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringBootApplication</span></span> <span class="hljs-meta"><span class="hljs-meta">@EnableConfigServer</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigServerApplication</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fun</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">main</span></span></span></span>(args: Array&lt;String&gt;) { runApplication&lt;ConfigServerApplication&gt;(*args) }</code> </pre> <br>  Application classes and main methods in other microservices have a similar appearance. <br><br><h1>  Service discovery server </h1><br>  Service discovery is a microservice architecture pattern that allows you to simplify the interaction between applications in terms of a possible change in the number of their instances and network location.  The key component in this approach is the Service registry - a database of microservices, their instances and network locations (more <a href="https://microservices.io/patterns/service-registry.html">here</a> ). <br><br>  In this project, Service discovery is implemented on the basis of Netflix Eureka, which is a <a href="https://microservices.io/patterns/client-side-discovery.html">Client-side service discovery</a> : Eureka server performs the function of the Service registry, and Eureka client calls the Eureka server for the list of instances of the called application and independently balances before performing a request to any microservice. load (using Netflix Ribbon).  Netflix Eureka, like some other components of the Netflix OSS stack (for example, Hystrix and Ribbon), integrates with Spring Boot applications using <a href="https://spring.io/projects/spring-cloud-netflix">Spring Cloud Netflix</a> . <br><br>  In the Service discovery server configuration, located in its resources ( <code>bootstrap.yml</code> ), only the application name and the parameter determining that the microservice launch will be interrupted is indicated if it is impossible to connect to the Config server: <br><br><pre> <code class="plaintext hljs">spring: application: name: eureka-server cloud: config: fail-fast: true</code> </pre> <br>  The rest of the application config is located in the <code>eureka-server.yml</code> in the Config server resources: <br><br><pre> <code class="plaintext hljs">server: port: 8761 eureka: client: register-with-eureka: true fetch-registry: false</code> </pre> <br>  Eureka server uses port 8761, which allows all Eureka clients not to specify it using the default value.  The value of the <code>register-with-eureka</code> (indicated for clarity, <code>register-with-eureka</code> it is also used by default) indicates that the application itself, like other microservices, will be registered with the Eureka server.  The <code>fetch-registry</code> parameter determines whether the Eureka client will receive data from the Service registry. <br><br>  The list of registered applications and other information is available at <code>http://localhost:8761/</code> : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sh/co/lz/shcolza08r8j3qkdmgb42exawqs.png"></div><br>  Alternative options for implementing Service discovery are Consul, Zookeeper, and others. <br><br><h1>  Items service </h1><br>  This application is an example of a back-end with the REST API implemented using the WebFlux framework that appeared in Spring 5 (the documentation is <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html">here</a> ), or rather the Kotlin DSL for it: <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">itemsRouter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ItemHandler</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> = router { path(<span class="hljs-string"><span class="hljs-string">"/items"</span></span>).nest { GET(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, handler::getAll) POST(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, handler::add) GET(<span class="hljs-string"><span class="hljs-string">"/{id}"</span></span>, handler::getOne) PUT(<span class="hljs-string"><span class="hljs-string">"/{id}"</span></span>, handler::update) } }</code> </pre> <br>  Processing received HTTP requests is delegated to the <code>ItemHandler</code> class <code>ItemHandler</code> .  For example, the method for getting a list of objects of some entity looks like this: <br><br><pre> <code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ServerRequest</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> = ServerResponse.ok() .contentType(APPLICATION_JSON_UTF8) .body(fromObject(itemRepository.findAll()))</code> </pre> <br>  The application becomes a client of the Eureka server, i.e., it registers and receives data from the Service registry, due to the <code>spring-cloud-starter-netflix-eureka-client</code> .  After registration, the application with a certain periodicity sends hartbits to the Eureka server, and if, for a certain period of time, the percentage of the Hearbits received by the Eureka server relative to the maximum possible value is below a certain threshold, the application will be deleted from the Service registry. <br><br>  Consider one of the ways to send additional metadata to the Eureka server: <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@PostConstruct</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addMetadata</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> = aim.registerAppMetadata(mapOf(<span class="hljs-string"><span class="hljs-string">"description"</span></span> to <span class="hljs-string"><span class="hljs-string">"Some description"</span></span>))</code> </pre> <br>  Make sure that the Eureka server receives this data by going to <code>http://localhost:8761/eureka/apps/items-service</code> via Postman: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/5l/0v/xg/5l0vxgolfgjzyuceskxhmdv-0kc.png"></div><br><br><h1>  Items UI </h1><br>  This microservice, besides showing interaction with the UI gateway (will be shown in the next section), performs the function of the front-end for the Items service, with which REST API can interact in several ways: <br><br><ol><li>  Client to REST API, written using OpenFeign: <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@FeignClient(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"items-service"</span></span></span><span class="hljs-meta">, fallbackFactory = ItemsServiceFeignClient.ItemsServiceFeignClientFallbackFactory::class)</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ItemsServiceFeignClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@GetMapping(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/items/{id}"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getItem</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@PathVariable(</span></span></span><span class="hljs-meta-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta"><span class="hljs-meta-string">"id"</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: String <span class="hljs-meta"><span class="hljs-meta">@GetMapping(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/not-existing-path"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testHystrixFallback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: String <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ItemsServiceFeignClientFallbackFactory</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FallbackFactory</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ItemsServiceFeignClient</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> log = LoggerFactory.getLogger(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">override</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fun</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span></span>(cause: Throwable) = <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> : ItemsServiceFeignClient { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getItem</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: String { log.error(<span class="hljs-string"><span class="hljs-string">"Cannot get item with id=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$id</span></span></span><span class="hljs-string">"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> ItemsUiException(cause) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testHystrixFallback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: String { log.error(<span class="hljs-string"><span class="hljs-string">"This is expected error"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"{\"error\" : \"Some error\"}"</span></span> } } } }</code> </pre> </li><li>  <code>RestTemplate</code> class <code>RestTemplate</code> <br>  In the java-config, a bin is created: <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-meta"><span class="hljs-meta">@LoadBalanced</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">restTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> = RestTemplate()</code> </pre> <br>  And is used in this way: <br><br><pre> <code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requestWithRestTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: String = restTemplate.getForEntity(<span class="hljs-string"><span class="hljs-string">"http://items-service/items/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$id</span></span></span><span class="hljs-string">"</span></span>, String::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">body</span></span></span><span class="hljs-class"> ?: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">"No result"</span></span></span></span></code> </pre> </li><li>  Bean of the <code>WebClient</code> class (the method is specific for the WebFlux framework) <br>  In the java-config, a bin is created: <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">webClient</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loadBalancerClient: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">LoadBalancerClient</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> = WebClient.builder() .filter(LoadBalancerExchangeFilterFunction(loadBalancerClient)) .build()</code> </pre> <br>  And is used in this way: <br><br><pre> <code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requestWithWebClient</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Mono&lt;String&gt; = webClient.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>().uri(<span class="hljs-string"><span class="hljs-string">"http://items-service/items/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$id</span></span></span><span class="hljs-string">"</span></span>).retrieve().bodyToMono(String::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">)</span></span></code> </pre> </li></ol><br>  The fact that all three methods return the same result can be seen by going to <code>http://localhost:8081/example</code> : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ma/c8/oz/mac8ozz07cju5mitffz_qiew9mc.png"></div><br>  I prefer the option using OpenFeign, because it gives the opportunity to develop a contract for interaction with the called microservice, the implementation of which Spring assumes.  The object implementing this contract is injected and used as an ordinary bin: <br><br><pre> <code class="kotlin hljs">itemsServiceFeignClient.getItem(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br>  If the request for any reason fails, the corresponding class method that implements the <code>FallbackFactory</code> interface will be called, in which you need to handle the error and return the default response (or forward an exception further).  In the event that some number of consecutive calls fail, the Fuse will open the circuit (for more on Circuit breaker <a href="https://martinfowler.com/bliki/CircuitBreaker.html">here</a> and <a href="https://microservices.io/patterns/reliability/circuit-breaker.html">here</a> ), giving time to restore the fallen microservice. <br><br>  For the Feign client to work, you need to annotate the application class <code>@EnableFeignClients</code> : <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringBootApplication</span></span> <span class="hljs-meta"><span class="hljs-meta">@EnableFeignClients(clients = [ItemsServiceFeignClient::class])</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ItemsUiApplication</span></span></span></span></code> </pre> <br>  To use Hystrix fallback in the Feign client, you need to enter the configuration file: <br><br><pre> <code class="plaintext hljs">feign: hystrix: enabled: true</code> </pre> <br>  To test the work of Hystrix fallback in the Feign client, just go to <code>http://localhost:8081/hystrix-fallback</code> .  The feign client will attempt to execute the query on the path that does not exist in the Items service, which will lead to the return of respons: <br><br><pre> <code class="json hljs">{<span class="hljs-attr"><span class="hljs-attr">"error"</span></span> : <span class="hljs-string"><span class="hljs-string">"Some error"</span></span>}</code> </pre> <br><h1>  Ui gateway </h1><br>  The API gateway pattern allows you to create a single entry point for API provided by other microservices (more <a href="http://microservices.io/patterns/apigateway.html">here</a> ).  The application implementing this pattern performs routing (routing) of requests to microservices, and also can perform additional functions, for example, authentication. <br><br>  In this project, for greater clarity, a UI gateway is implemented, that is, a single entry point for different UIs;  obviously, the API gateway is implemented in a similar way.  Microservice is implemented on the basis of the Spring Cloud Gateway framework.  An alternative option is Netflix Zuul, which is part of Netflix OSS and integrated with Spring Boot using Spring Cloud Netflix. <br>  The UI gateway works on port 443 using the generated SSL certificate (located in the project).  SSL and HTTPS are configured as follows: <br><br><pre> <code class="plaintext hljs">server: port: 443 ssl: key-store: classpath:keystore.p12 key-store-password: qwerty key-alias: test_key key-store-type: PKCS12</code> </pre> <br>  User logins and passwords are stored in the Map-based implementation of the WebFlux-specific <code>ReactiveUserDetailsService</code> interface: <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reactiveUserDetailsService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: ReactiveUserDetailsService { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> user = User.withDefaultPasswordEncoder() .username(<span class="hljs-string"><span class="hljs-string">"john_doe"</span></span>).password(<span class="hljs-string"><span class="hljs-string">"qwerty"</span></span>).roles(<span class="hljs-string"><span class="hljs-string">"USER"</span></span>) .build() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> admin = User.withDefaultPasswordEncoder() .username(<span class="hljs-string"><span class="hljs-string">"admin"</span></span>).password(<span class="hljs-string"><span class="hljs-string">"admin"</span></span>).roles(<span class="hljs-string"><span class="hljs-string">"ADMIN"</span></span>) .build() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MapReactiveUserDetailsService(user, admin) }</code> </pre> <br>  Security settings are configured as follows: <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">springWebFilterChain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(http: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ServerHttpSecurity</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: SecurityWebFilterChain = http .formLogin().loginPage(<span class="hljs-string"><span class="hljs-string">"/login"</span></span>) .and() .authorizeExchange() .pathMatchers(<span class="hljs-string"><span class="hljs-string">"/login"</span></span>).permitAll() .pathMatchers(<span class="hljs-string"><span class="hljs-string">"/static/**"</span></span>).permitAll() .pathMatchers(<span class="hljs-string"><span class="hljs-string">"/favicon.ico"</span></span>).permitAll() .pathMatchers(<span class="hljs-string"><span class="hljs-string">"/webjars/**"</span></span>).permitAll() .pathMatchers(<span class="hljs-string"><span class="hljs-string">"/actuator/**"</span></span>).permitAll() .anyExchange().authenticated() .and() .csrf().disable() .build()</code> </pre> <br>  The given config determines that a part of web resources (for example, static) is available to all users, including those who are not authenticated, and everything else ( <code>.anyExchange()</code> ) is available only to authenticated users.  When you try to login to a URL that requires authentication, you will be redirected to the login page ( <code>https://localhost/login</code> ): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/vz/eu/yx/vzeuyxohx_kfb17mrg4llnv4n8q.png"></div><br>  This page uses the tools of the Bootstrap framework connected to the project using Webjars, which allows you to manage client-side libraries as normal dependencies.  Thymeleaf is used to form HTML pages.  Access to the login page is configured using WebFlux: <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">routes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> = router { GET(<span class="hljs-string"><span class="hljs-string">"/login"</span></span>) { ServerResponse.ok().contentType(MediaType.TEXT_HTML).render(<span class="hljs-string"><span class="hljs-string">"login"</span></span>) } }</code> </pre> <br>  Spring Cloud Gateway routing can be configured in a YAML or java-config.  Routes to microservices are either set manually or created automatically based on data received from the Service registry.  With a sufficiently large number of UIs that require routing, it will be more convenient to use the integration with the Service registry: <br><br><pre> <code class="plaintext hljs">spring: cloud: gateway: discovery: locator: enabled: true lower-case-service-id: true include-expression: serviceId.endsWith('-UI') url-expression: "'lb:http://'+serviceId"</code> </pre> <br>  The value of the <code>include-expression</code> parameter indicates that the routes will be created only for microservices whose names end with <i>-UI</i> , and the value of the <code>url-expression</code> parameter means that they are accessible via the HTTP protocol, unlike the UI gateway working via HTTPS, and when accessing they will use client load balancing (implemented using the Netflix Ribbon). <br><br>  Consider the example of creating routes in the java-config manually (without integration with the Service registry): <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">routeLocator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(builder: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">RouteLocatorBuilder</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> = builder.routes { route(<span class="hljs-string"><span class="hljs-string">"eureka-gui"</span></span>) { path(<span class="hljs-string"><span class="hljs-string">"/eureka"</span></span>) filters { rewritePath(<span class="hljs-string"><span class="hljs-string">"/eureka"</span></span>, <span class="hljs-string"><span class="hljs-string">"/"</span></span>) } uri(<span class="hljs-string"><span class="hljs-string">"lb:http://eureka-server"</span></span>) } route(<span class="hljs-string"><span class="hljs-string">"eureka-internals"</span></span>) { path(<span class="hljs-string"><span class="hljs-string">"/eureka/**"</span></span>) uri(<span class="hljs-string"><span class="hljs-string">"lb:http://eureka-server"</span></span>) } }</code> </pre> <br>  The first route routes to the previously shown home page of the Eureka server ( <code>http://localhost:8761</code> ), the second is needed to load the resources of this page. <br><br>  All routes created by the application are accessible via <code>https://localhost/actuator/gateway/routes</code> . <br><br>  In the underlying microservices, it may be necessary to gain access to the login and / or user roles authenticated in the UI gateway.  To do this, I created a filter that adds the appropriate headers to the request: <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddCredentialsGlobalFilter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GlobalFilter { private val loggedInUserHeader = "logged-in-user" private val loggedInUserRolesHeader = "logged-in-user-roles" override fun filter</span></span></span></span>(exchange: ServerWebExchange, chain: GatewayFilterChain) = exchange.getPrincipal&lt;Principal&gt;() .flatMap { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> request = exchange.request.mutate() .header(loggedInUserHeader, it.name) .header(loggedInUserRolesHeader, (it <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Authentication).authorities?.joinToString(<span class="hljs-string"><span class="hljs-string">";"</span></span>) ?: <span class="hljs-string"><span class="hljs-string">""</span></span>) .build() chain.filter(exchange.mutate().request(request).build()) } }</code> </pre> <br>  Now let's turn to Items UI using the UI gateway - <code>https://localhost/items-ui/greeting</code> , rightly assuming that the Items UI has already implemented the processing of these headers: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rc/sl/_s/rcsl_sdjuf6vkxkite5h3rgzoui.png"></div><br>  Spring Cloud Sleuth is a solution for tracing requests in a distributed system.  Trace Id (pass-through identifier) ‚Äã‚Äãand Span Id (unit of work) identifier are added to the headers of the request passing through several microservices (for easier perception, I simplified the scheme; <a href="https://cloud.spring.io/spring-cloud-sleuth/single/spring-cloud-sleuth.html">here is a</a> more detailed explanation): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sp/1q/em/sp1qem4a6silx9bo3kh83enn_mu.png"></div><br>  This functionality is connected by simply adding the <code>spring-cloud-starter-sleuth</code> . <br><br>  Specifying the appropriate logging settings, you can see something like the following in the console of the corresponding microservices (after the name of the microservice, Trace Id and Span Id are displayed): <br><br><pre> <code class="plaintext hljs">DEBUG [ui-gateway,009b085bfab5d0f2,009b085bfab5d0f2,false] oscghRoutePredicateHandlerMapping : Route matched: CompositeDiscoveryClient_ITEMS-UI DEBUG [items-ui,009b085bfab5d0f2,947bff0ce8d184f4,false] oswrfunction.server.RouterFunctions : Predicate "(GET &amp;&amp; /example)" matches against "GET /example" DEBUG [items-service,009b085bfab5d0f2,dd3fa674cd994b01,false] oswrfunction.server.RouterFunctions : Predicate "(GET &amp;&amp; /{id})" matches against "GET /1"</code> </pre> <br>  For a graphical representation of distributed tracing, you can use, for example, Zipkin, which will act as a server that aggregates information about HTTP requests from other microservices (more <a href="https://spring.io/projects/spring-cloud-sleuth">here</a> ). <br><br><h1>  Assembly </h1><br>  Depending on the OS, <code>gradlew clean build</code> or <code>./gradlew clean build</code> is performed. <br><br>  Given the possibility of using the <a href="https://docs.gradle.org/current/userguide/gradle_wrapper.html">Gradle wrapper</a> , there is no need for a locally installed Gradle. <br><br>  Build and subsequent launch successfully pass on JDK 11.0.1.  Prior to that, the project worked on JDK 10, so I admit that there will be no problems with build and launch on this version.  I have no data for earlier versions of the JDK.  In addition, you need to take into account that the Gradle 5 used requires at least JDK 8. <br><br><h1>  Launch </h1><br>  I recommend starting the applications in the order of their description in this article.  If you use Intellij IDEA with Run Dashboard enabled, you should get something like the following: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/7h/yb/t0/7hybt0ljfcfnrkckajkikwctj-g.png"></div><br><h1>  Conclusion </h1><br>  The article reviewed an example of a microservice architecture on the current technology stack in the Java world, its main components and some features.  I hope for someone the material will be useful.  Thank you for attention! <br><br><h1>  Links </h1><br><ul><li>  Project source code on <a href="https://github.com/rkudryashov/microservices-example">github</a> </li><li>  <a href="https://microservices.io/">Articles about</a> Chris Richardson <a href="https://microservices.io/">microservices</a> </li><li>  <a href="https://martinfowler.com/articles/microservices.html">An article about</a> Martin Fowler <a href="https://martinfowler.com/articles/microservices.html">microservices</a> </li><li>  <a href="https://martinfowler.com/microservices/">Guide on materials about</a> Martin Fowler <a href="https://martinfowler.com/microservices/">microservices</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/431474/">https://habr.com/ru/post/431474/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../431456/index.html">50 documentation questions</a></li>
<li><a href="../431458/index.html">We become wizards in programming. Part 2</a></li>
<li><a href="../431460/index.html">"Calendar tester" for November. Reasonable pair testing</a></li>
<li><a href="../431462/index.html">How we did a book scanner for ships</a></li>
<li><a href="../431464/index.html">Double Bottom: a post about a modern ecosystem, in which we pay data for everything, and also about fast Blockchain Protocols</a></li>
<li><a href="../431478/index.html">Conference of Roskomnadzor "Protection of personal data"</a></li>
<li><a href="../431482/index.html">And you, Yota ...</a></li>
<li><a href="../431486/index.html">"Invisible" flies: a new method of studying the nervous system through tissue depigmentation</a></li>
<li><a href="../431488/index.html">Sound modulation</a></li>
<li><a href="../431490/index.html">External - GUI for Golang</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>