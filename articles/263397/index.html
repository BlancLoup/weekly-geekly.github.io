<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bit Kung Fu, or How to optimize traffic between a mobile application and a server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Old as the world ... 
 People always strive to keep abreast of the latest developments. Thanks to this aspiration, many media have emerged that need t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bit Kung Fu, or How to optimize traffic between a mobile application and a server</h1><div class="post__text post__text-html js-mediator-article"><h4>  Old as the world ... </h4><br>  People always strive to keep abreast of the latest developments.  Thanks to this aspiration, many media have emerged that need their own mobile application for delivering content to their readers.  So in the shops appeared a great many news applications.  Hundreds of applications for reading news, newspapers and magazines. <br><br><img src="https://habrastorage.org/files/edc/5ce/69d/edc5ce69de9144348f532cd6709e66e4.jpg"><br><a name="habracut"></a><br>  Almost all news applications have a similar hierarchical type of storing and displaying articles: headings or sections, news lists, and the article itself with the pictures contained in it, videos, and so on.  Usually in a mobile application, the user has to download these items sequentially while navigating through the application. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/da3/422/b67/da3422b67061d38940d66c8ae3f09b0e.png" alt="image" align="right">  The most boring moment for the user in the navigation phase begins when the download is slow for some reason.  Then, quite often, when navigating to an article in the list or when downloading pictures, it can only watch the progress bar.  Perhaps that is why the varieties of these elements are also so many? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the article, we will discuss the new method for loading data for media applications, which we proposed and successfully implemented with one of our customers. <br><br><h4>  Salt of life in search of new.  (with) </h4><br>  Standard loading, for example, of the list of articles in the section occurs as follows: the application requests the latest N news, reduces this list to what has been downloaded and stored locally, forms a new list and shows it to the user.  Next, the user enters the article, downloads content and so on.  When downloading a list of articles, the application and the server can interact in two ways: <br>  ‚Ä¢ The application asks to download the list, starting with the last download.  But then the server starts an operation to search for the necessary data in the database, which loads the server. <br>  ‚Ä¢ The application always loads the last N articles and keeps the list on its side, but then it will be a losing option for traffic with frequent downloads. <br><br>  It would seem that there can be changed?  And it turned out that you can!  But it is necessary to apply a creative approach and a little hard work. <br><br>  We decided to offer one of our customers an original approach to the data loading method, in which the user will have a quick download of news content and traffic savings with frequent periodic use of the application. <br><br>  Our idea was as follows: on the application side, you must always keep a fresh archive of news.  And periodically in the background we will update it to the current state. <br><br><img src="https://habrastorage.org/files/ef9/1c6/a38/ef91c6a3853349dba3cf77cd476837eb.jpg"><br><br>  Easy to say, but harder to implement.  It's great that news will always be up to date without (sometimes lengthy) data loading. <br>  But how to synchronize the archive that is in the application, and prepared an updated archive, located on the server.  Do you just need to download and replace the file?  It is not effective ... <br><br><h4>  Solution scheme </h4><br>  So, we have two files - on the server and on the client (the initial situation, when there is no file in the application, we will consider later).  And we do not want to load the entire server file with every update.  Surely, many have already thought that you can compare 2 versions of a file and download only different parts.  We thought the same and looked for ready-made solutions.  As a result, came to the two most popular: bsdiff / bspatch and rsync. <br><br>  We noticed <a href="http://www.daemonology.net/papers/bsdiff.pdf">bsdiff</a> because of its ability to find the same sequence of bytes in two versions of files, but located in different places.  Look at the two bit sequences ‚Äú0 1 0 1 0 1 0 1‚Äù and ‚Äú0 0 1 0 1 0 1 0‚Äù.  They only share the first bit, but they can find a common sequence. <br><br><img src="https://habrastorage.org/files/0d0/414/16e/0d041416e1854aa5b17c809d3ede3dd9.png"><br><br>  Thus, the second sequence from the first one can be obtained by shifting the first 7 bits to the right by a bit, add 0 to the free space and delete the last bit.  This sequence of operations, recorded in a specific format and saved to a file, is the result of the bsdiff utility.  Later this file, called a patch, and the source file can be processed by the bspatch utility to get a new file. <br><br>  It sounded promising, but only versions of the file are needed to calculate the patch.  As a result, the concept looked like this: on the server we store N named release versions for the last few days and another N-1 pre-calculated patches from each of them to the last.  The client also has some version of the release and its id, according to which he will receive the necessary patch from the server and update it. <br><br>  I wanted a more universal solution so that it was possible to upgrade from any version and not depend on N, but we were most worried about the fact that bspatch uses a memory-hungry algorithm.  To patch a 1MB file with a 0.1MB patch, you need to spend 1MB + 0.1MB of RAM. <br><br>  With such thoughts, we left bsdiff, intending never to return to it, and began to explore <a href="https://rsync.samba.org/documentation.html">rsync</a> .  This client-server utility running at the TCP level <br>  widely known among users of unix-like systems.  In general terms, the algorithm of its work is reduced to the following steps: <br>  1. The client splits his file into sequences of size K; <br>  2. For each sequence, the client counts two checksums: MD4 and a ring hash and sends all the amounts to the server; <br>  3. The server tries to find in its version of the file a sequence of size K, both sums of which coincide with one of those sent by the client; <br>  4. The server generates a set of instructions for the client, which he needs to execute in order to turn his version of the file into the necessary one. <br><br><img src="https://habrastorage.org/files/a9c/54b/1bf/a9c54b1bfc494f3e8bc8b2e1fb5a51c3.png"><br><br>  It is noteworthy that the server counts the amounts from intersecting sequences.  This allows you to find the same data block, even if it is located at a different place, when compared with the old version of the file. <br>  It looks archiccusto: synchronization of any version of the file (including no), smart search for common parts of the file - what you need.  We conducted several proof-of-concept tests of the rsync utility from the Ubuntu repository, measuring the amount of data to be collected between the supposedly ‚Äúyesterday‚Äù and ‚Äútoday's‚Äù releases, and obtained very encouraging results.  That's just rsync is not designed for a large number of clients.  Each file synchronization is the load on the server processor by checksum calculations.  If we had offered such a concept, multiplied by our 200k daily users, the guys from the back-end would simply have twisted their fingers at their heads.  Therefore, we did not offer this. <br><br>  But, fortunately, after experimenting with rsync, we found a solution that finally came to us - <a href="http://zsync.moria.org.uk/paper/paper.html">zsync</a> . <br><br><h4>  ZSYNC </h4><br>  In fact, zsync is an open source http wrapper over rsync.  It uses the same algorithms for finding common parts / file differences as rsync, but the data transfer mechanism between the client and the server is completely different. <br>  The first step on the server side of the target file is processed by the zsyncmake utility, which will generate the same file with the * .zsync extension with all calculated non-overlapping checksums, block size, reference to the main file and other useful information for the client.  HTTP files are opened to both target files and * .zsync.  The client first downloads the * .zsync file, then tries to find in his version of the file blocks with checksums identical to any amount from the metafile.  Now the client knows what data blocks he lacks and makes the HTTP Range request the target file, receiving only the missing part of it. <br><br><img src="https://habrastorage.org/files/f2e/c0a/819/f2ec0a81934d4272ac1815cb4afb3b72.png"><br><br>  Have you noticed how cleverly on one of the steps did the client and server switch between zrsync and rsync?  :) Now the HTTP server as the rsync client counts the amounts for non-overlapping blocks, and the HTTP client as the rsync server finds these blocks in its file. <br><br>  To get zsync to work for us, we first had to port it slightly to Android.  And to integrate zsync into our project, we wrote a java-wrapper that worked with zsync via JNI so that only algorithmic tasks remained on the C-code side, and downloading, deleting metafiles and range requests fell on the Android API. <br><br>  There is another very important difference between rsync and zsync, which we haven‚Äôt mentioned before.  The fact is that changing even one byte of the source file can lead to changes in the entire file of its archive, so the compression algorithms work.  For this reason, rsync is not very efficient in synchronizing archives.  You can try to increase efficiency by reducing the size of the blocks into which the file is divided.  But this is a double-edged sword, because it will increase the volume of operations to find the same blocks on the server.  The balance between the minimum block size and maximum efficiency depends on specific archives, compression algorithms and the content itself.  Fortunately, zsync can, if necessary, divide into blocks and count the amounts not the archive itself, but its unpacked contents, but at the same time determine the missing blocks not from the unpacked content, but from the archive.  Here is a trick, read more <a href="http://zsync.moria.org.uk/paper/index.html">here</a> in the Compressed Content section. <br><br><h4>  ‚ÄúWhat is your evidence?‚Äù (C) </h4><br>  Nothing is better than experimenting with real data.  We collected 2 issues: Saturday and Sunday, with sizes of 7.8MB and 8.5MB, respectively.  In the Sunday release, 2 articles disappeared and 3 new ones appeared, which brought about 2.9 MB of new pictures and about 100KB of new text and auxiliary files to the archive. <br><br>  Let's see how zsync does the task: <br><br>  Read topstories.zip.  Target 61.8% complete. <br>  downloading from http: // [...] /topstoriesweb.zip: <br>  #################### 100.0% 0.0 kBps DONE <br><br>  verifying download ... checksum matches OK <br>  used 5234688 local fetched 3242306 <br><br>  The traffic was 3242306 bytes.  Slightly more than the actual size of the new data, but this is only ~ 7% of redundancy.  Good job, zsync. <br><br><h4>  One more thing ... </h4><br>  We have already done a good job to surprise the user of our application with solutions that he will never know about, but you can always do something a little better.  And we did.  We have prepared a special issue on the server from several of the hottest articles that only downloads when the application is launched for the first time so that the user will be up to date in a few seconds.  In the meantime, he is busy, zsync will make sure that this small release becomes a real one. <br><br>  For more than a year, we have been using the bundle downloading scheme in conjunction with zsync instead of the usual ‚Äúrequest-per-item‚Äù for content delivery to users and are not going to refuse, because it seems more convenient to us: <br>  ‚Ä¢ 1 request for release or 1 request for section is implemented easier than a chain: download list of articles -&gt; download content of each article -&gt; download media files of each article -&gt; etc; <br>  ‚Ä¢ out of the box offline mode, subject to successful synchronization, of course; <br>  ‚Ä¢ Fits perfectly into the <a href="https://developer.android.com/training/efficient-downloads/index.html">scheme of effective, in Google's opinion, synchronization</a> : synchronization will occur at a time favorable for the device, with normal battery power and a good Internet connection. <br><br>  But the whole Internet will not be able to download.  This approach obviously requires much more local storage and you need to carefully approach the question of what we preload, and what is not.  For example, to save space on old devices, we decided to teach our server to prepare special issues with pictures of lower resolution, and for devices with a slow Internet connection, this is altogether without illustrations.  This does not mean that the user will not see the photos at all, they simply will not fall into preloading. <br><br><h4>  That's all </h4><br>  This method does not solve all the problems of transferring news content from the server to the numerous devices of our users.  But he helped us in the application to speed up the loading of content, reducing the waiting for users, and also significantly reduce the load on the server.  We managed to apply a creative approach and make a fast-running, cost-effective software solution, while not increasing the capacity of server hardware. <br><br>  Have a great day everyone! </div><p>Source: <a href="https://habr.com/ru/post/263397/">https://habr.com/ru/post/263397/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../263379/index.html">Snipper - a little programmer assistant</a></li>
<li><a href="../263381/index.html">Registration for MBLTdev 15 - international conference of mobile developers has begun</a></li>
<li><a href="../263387/index.html">Research interstitial ads on Google+ with advertisements</a></li>
<li><a href="../263391/index.html">Automate it</a></li>
<li><a href="../263393/index.html">Organizing collaborative web development environment</a></li>
<li><a href="../263399/index.html">The first experience of participation in the kaggle-competition and work on the bugs</a></li>
<li><a href="../263403/index.html">My code does not work :-(</a></li>
<li><a href="../263405/index.html">Video of reports from Zabbix Moscow Meetup</a></li>
<li><a href="../263407/index.html">Dirty secrets of express programming courses</a></li>
<li><a href="../263409/index.html">The end of the IT era</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>