<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>"Bicycle" version checking site</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day everyone. 

 In connection with the growing load on one of the company's website, in which I am listed as a system administrator, it was deci...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>"Bicycle" version checking site</h1><div class="post__text post__text-html js-mediator-article">  Good day everyone. <br><br>  In connection with the growing load on one of the company's website, in which I am listed as a system administrator, it was decided to use the Keepalived balancer.  I will not dwell on this product, I will describe the problem that has arisen. <br><br>  The layout comes from gitlaba.  In order for the testing department to be aware of what it is testing at all, a file was added to each individual site a long time ago.  Normal txt file that was generated during layout.  In itself, this file contained information about the current version (brunch, revision, hash of the last commit and a list of the last 300 commits.) That is, thanks to this file, the tester knows what he is testing.  It looks like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/61a/a3d/a41/61aa3da4163c437a87bdb72f084adf8e.png"><br><a name="habracut"></a><br>  Since this file is on all nodes, it was decided to compare the versions on it. <br>  Took 2 nodes with ubuntu.  On each keepalived, nginx, php5-fpm.  Virtual ip jumps between nodes. <br>  Since I had a blank check for a decision, I chose what the soul is for. <br>  I will not give a lot of code, since I am not a programmer and writing it is not my responsibility. <br><br>  The solution is as follows: <br>  - bash script to generate the file in the screenshot above; <br>  - go to build web snails and check; <br>  - python for nagios. <br><br>  The first step was to write a function to get the hash. <br><br><pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_release</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(revall </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>{ i := strings.Index(revall, <span class="hljs-string"><span class="hljs-string">"commit "</span></span>) chars := revall[i:] i = strings.Index(chars, <span class="hljs-string"><span class="hljs-string">"\n"</span></span>) returned := chars[:i] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> returned }</code> </pre> <br>  In this block, I, apparently, receive a line of the form ‚Äúcommit 65f58976c71651c91ba641d43930f07a3d55c244‚Äù from a text file. <br>  The config and the function of its reading were also added.  For dynamism, there may be several configs, reading is a folder in the style of conf.d.  Config consisted of the following: <br><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"HeaderHost"</span></span>: <span class="hljs-string"><span class="hljs-string">"somehost.org"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ips"</span></span>: [<span class="hljs-string"><span class="hljs-string">"192.168.1.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"192.168.1.2"</span></span>], <span class="hljs-attr"><span class="hljs-attr">"Hostname"</span></span>: [<span class="hljs-string"><span class="hljs-string">"somehost.org-1"</span></span>, <span class="hljs-string"><span class="hljs-string">"somehost.org-2"</span></span>] }</code> </pre><br>  Here, too, everything is clear, since nginx is configured to *: 80, then you can safely fight in the address specified in interfaces with the desired name.  Actually, this is also the address in the config and the hostname just for output to the form. <br>  Request function. <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reqrev</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(urlic </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, host </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span> { tr := &amp;http.Transport{ TLSClientConfig: &amp;tls.Config{InsecureSkipVerify: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, } client := &amp;http.Client{Transport: tr} req, _ := http.NewRequest(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>, urlic, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) req.Host = host resp, _ := client.Do(req) body, _ := ioutil.ReadAll(resp.Body) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(body) }</code> </pre><br><br>  The site is a revrayt from http to https.  So a piece about ignoring the certificate was added to the function and the connection goes immediately to https.  The piece is higher rather than test than combat, so error handling is not taken into account. <br><br>  In fact, I enforce that this was the first thing done.  First of all, the bootstrap template was found and converted to a specific need. <br><br>  Then there was a set of various functions, structures and templates of html (with which go works, in my opinion, very simple and convenient), to obtain the desired result.  In the end, I got something like the following. <br><br><img src="https://habrastorage.org/files/a5e/579/778/a5e579778d764637a8e2cd4962eed6f3.png"><br><br>  Here we see the difference, if there is one.  If the last commit is the same - everything is green calm, if not - the colors turn red and at the top of the page it will be written what and where it diverges. <br>  This page has been added to aggregate information. <br><br><img src="https://habrastorage.org/files/6b9/ac3/539/6b9ac35399a4452ebc90c0177bf8ed73.png"><br><br>  By clicking on the REV button we get the same text file. <br><br><img src="https://habrastorage.org/files/d42/501/240/d42501240e1e41cbac1a403222cb621e.png"><br><br>  Further, using all the same functions and adding one new one, we hang it on the go-web server via uri / nagios, for example, json. <br><br><img src="https://habrastorage.org/files/aa7/c12/ea5/aa7c12ea55984045a5a825a201f288e1.png"><br><br>  In this case, our python-script comes at all ready.  Here you are in the array we display the checkable sites (the configs of which are in the conf.d folder), the status for nagios (0-OK), and a description.  If there are discrepancies in the description, there will be an array of commits and the status will change. <br><br>  Obviously, it was possible to find a simpler solution and implement, for example, in one python-script, but it was more fun and interesting to do that.  If you are interested, I can comb the code and lay out.  I beg your pardon for skewing smeared screenshots. </div><p>Source: <a href="https://habr.com/ru/post/248671/">https://habr.com/ru/post/248671/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../248659/index.html">Introduction to topological spaces. Java finite topology programming</a></li>
<li><a href="../248661/index.html">Interesting solutions for mobile ecommerce applications</a></li>
<li><a href="../248663/index.html">GNU Emacs. An article that I never found ...</a></li>
<li><a href="../248667/index.html">An example of using Fabric (Twitter Kit) in Android Studio</a></li>
<li><a href="../248669/index.html">Almost correct development on 1C, without revolutions</a></li>
<li><a href="../248675/index.html">NSA Curious Look: What is the War of Internet Security (Part 2)?</a></li>
<li><a href="../248677/index.html">Evaluation of labor costs for the project and the preparation of commercial proposals</a></li>
<li><a href="../248679/index.html">Unusual CM.com Domain History</a></li>
<li><a href="../248685/index.html">About Haskell Names</a></li>
<li><a href="../248689/index.html">Postgres straightens shoulders</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>