<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Encodings</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Everyone sooner or later has to work with different encodings. Having noticed various, sometimes strange approaches to solving these problems in the c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Encodings</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/74cb95e0/88acd566/80504558/fce4ae22.jpg" align="left" height="252"><br>  Everyone sooner or later has to work with different encodings.  Having noticed various, sometimes strange approaches to solving these problems in the code of my team, I had to conduct an explanatory conversation.  Below I will share my vision of correct work with non-ASCII characters in the code.  I will be glad to constructive criticism. <br><br><a name="habracut"></a><br><br><h3>  Principle of operation </h3><br>  The logic of working with different encodings in C ++ is simple and transparent.  In general, it is reflected in the scheme.  The program works in one - its internal encoding, and correctly localized streams are responsible for converting the encoding of data from external code to internal code and vice versa.  The internal coding of the program is best fixed once and for all.  If the program works with non-ASCII characters, the most logical choice for internal encoding is Unicode, and using UTF-8 and char to parameterize STL is usually unjustified (although there are situations in which this is necessary);  it is more logical to switch to wchar_t extended characters and use UCS-2.  The codecvt cell is responsible for converting data from external encoding to internal encoding.  Localized streams themselves will call the corresponding facet functions when retrieving data (who I wrote about such facets <a href="http://habrahabr.ru/blogs/cpp/104417/" title="My article about facets">earlier</a> ). <br>  I will explain the above with a commented example in which we will read data from the cp1251 file, we will show how boost :: xpressive works with Unicode and we will derive the Cyrillic cout in cp866 (windows console by default). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/storage/2c71ed73/4639b184/84048b71/8da51ebb.png"></div><br><br><h3>  Source encoding </h3><br>  Before proceeding with the consideration of the example, it is necessary (just in case) to say a few words about the encoding of the source code of the program.  I keep all my sources in UTF-8 (if they contain wide string constants with non-ASCII characters, then I add a <a href="http://en.wikipedia.org/wiki/Byte_order_mark" title="Wikipedia article on Byte order mark">BOM</a> to the files), which I advise everyone.  Modern compilers themselves convert "wide" characters, marked in the source as L "" in UCS-2 (or UCS-4).  It is clear that the correct conversion depends on the source encoding.  gcc by default assumes that it works with UTF-8 text, in order to convince it you will have to specifically specify the value of the -finput-charset parameter.  The compiler from MS needs a little help - add the BOM file ( <a href="http://en.wikipedia.org/wiki/Byte_order_mark" title="Wikipedia article on Byte order mark">Byte Order Mark</a> ) to the UTF-8.  Unfortunately, Borland C ++ Compiler version 5.5 has problems with UTF-8. <br>  For those who are going to throw a stone at me, I will explain two points: the first is that it is not convenient for me to read the code from the ‚Äúunicode escape‚Äù type: <br> <code>std::wstring wstr(L"\u0410\u0411\u0412\u0413\u0413"); <br></code>  the second is not only about the user interface, so putting all the wide string constants in a separate module and somehow working with them (like gettext) is not an option. <br>  So it's decided - the sources in UTF-8 with BOM.  If anyone does not know, in vim BOM can be added to the file using the command ‚Äúset bomb‚Äù.  If the BOM in the file already has vim, it is not going anywhere. <br><br><h3>  An example of working with different encodings </h3><br>  Well, that's got to the most interesting.  As I said, the code is simple and straightforward.  A small note on standard streams - by default, the facets for them are not used as they are synchronized with stdio for performance.  You must specify sync_with_stdio (false). <br><br><pre> <code class="hljs lua">#include &lt;boost/xpressive/xpressive.hpp&gt; #include &lt;locale&gt; #include &lt;fstream&gt; #include &lt;iostream&gt; #include &lt;iterator&gt; #include <span class="hljs-string"><span class="hljs-string">"codecvt_cp866.hpp"</span></span> #include <span class="hljs-string"><span class="hljs-string">"codecvt_cp1251.hpp"</span></span> #include <span class="hljs-string"><span class="hljs-string">"unicyr_ctype.hpp"</span></span> using namespace std; using namespace boost::xpressive; int main() { //    <span class="hljs-built_in"><span class="hljs-built_in">input</span></span>.txt   cp1251,   // <span class="hljs-string"><span class="hljs-string">", !"</span></span> ofstream ofile(<span class="hljs-string"><span class="hljs-string">"input.txt"</span></span>, std::ios::binary); ostreambuf_iterator&lt;<span class="hljs-built_in"><span class="hljs-built_in">char</span></span>&gt; writer(ofile); writer = <span class="hljs-number"><span class="hljs-number">0xCF</span></span>; //  ++writer = <span class="hljs-number"><span class="hljs-number">0xF0</span></span>; //  ++writer = <span class="hljs-number"><span class="hljs-number">0xE8</span></span>; //  ++writer = <span class="hljs-number"><span class="hljs-number">0xE2</span></span>; //  ++writer = <span class="hljs-number"><span class="hljs-number">0xE5</span></span>; //  ++writer = <span class="hljs-number"><span class="hljs-number">0xF2</span></span>; //  ++writer = <span class="hljs-number"><span class="hljs-number">0x2C</span></span>; // , ++writer = <span class="hljs-number"><span class="hljs-number">0x20</span></span>; // ++writer = <span class="hljs-number"><span class="hljs-number">0xEC</span></span>; //  ++writer = <span class="hljs-number"><span class="hljs-number">0xE8</span></span>; //  ++writer = <span class="hljs-number"><span class="hljs-number">0xF0</span></span>; //  ++writer = <span class="hljs-number"><span class="hljs-number">0x21</span></span>; // ! ofile.<span class="hljs-built_in"><span class="hljs-built_in">close</span></span>(); //   wifstream ifile(<span class="hljs-string"><span class="hljs-string">"input.txt"</span></span>); //    locale cp1251(locale(<span class="hljs-string"><span class="hljs-string">""</span></span>), new codecvt_cp1251&lt;wchar_t, <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>, mbstate_t&gt;); ifile.imbue(cp1251); wchar_t wstr[<span class="hljs-number"><span class="hljs-number">14</span></span>]; ifile.getline(wstr, <span class="hljs-number"><span class="hljs-number">13</span></span>); //  C++   cout, cin, cerr  // clog,       stdio,   //        (    //  gcc, msvc <span class="hljs-number"><span class="hljs-number">7</span></span>    ).  //  ios,       stdio. ios_base::sync_with_stdio(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); //    locale cp866(locale(<span class="hljs-string"><span class="hljs-string">""</span></span>), new codecvt_cp866&lt;wchar_t, <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>, mbstate_t&gt;); //  ,      //  wcout.imbue(cp866); //    ctype locale cyrr(locale(<span class="hljs-string"><span class="hljs-string">""</span></span>), new unicyr_ctype); wsregex_compiler xpr_compiler; xpr_compiler.imbue(cyrr); wsregex xpr = xpr_compiler.compile(L<span class="hljs-string"><span class="hljs-string">""</span></span>, regex_constants::icase); wsmatch <span class="hljs-built_in"><span class="hljs-built_in">match</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(regex_search(wstring(wstr), <span class="hljs-built_in"><span class="hljs-built_in">match</span></span>, xpr)) wcout &lt;&lt; L<span class="hljs-string"><span class="hljs-string">"icase "</span></span> &lt;&lt; endl; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> wcout &lt;&lt; L<span class="hljs-string"><span class="hljs-string">"icase  "</span></span> &lt;&lt; endl; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br><br>  Codecvt facet to convert Cyrillic from cp1251 to ucs-2 and back <br><br><pre> <code class="hljs lua">#include &lt;locale&gt; #include &lt;map&gt; /**@brief  codecvt      cp1251 *  UCS<span class="hljs-number"><span class="hljs-number">-2</span></span>   * *       (<span class="hljs-number"><span class="hljs-number">3</span></span>-   - * ).        - * .   ,   codecvt     *  .       *  .  ,      , *  ,     .   *        . State *      ,     *       ,    *       . */ template&lt;class I, class E, class State&gt; class codecvt_cp1251 : public std::codecvt&lt;I, E, State&gt; { public: //     typedef typename std::codecvt_base::result result; const result ok, //  partial, //   (  State) <span class="hljs-built_in"><span class="hljs-built_in">error</span></span>, //   noconv; //   explicit codecvt_cp1251(size_t r=<span class="hljs-number"><span class="hljs-number">0</span></span>) : std::codecvt&lt;I, E, State&gt;(r), ok(std::codecvt_base::ok), partial(std::codecvt_base::partial), <span class="hljs-built_in"><span class="hljs-built_in">error</span></span>(std::codecvt_base::<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>), noconv(std::codecvt_base::noconv) { //    -   in_tab[<span class="hljs-number"><span class="hljs-number">0xA8</span></span>] = <span class="hljs-number"><span class="hljs-number">0x401</span></span>; out_tab[<span class="hljs-number"><span class="hljs-number">0x401</span></span>] = <span class="hljs-number"><span class="hljs-number">0xA8</span></span>; in_tab[<span class="hljs-number"><span class="hljs-number">0xB8</span></span>] = <span class="hljs-number"><span class="hljs-number">0x451</span></span>; out_tab[<span class="hljs-number"><span class="hljs-number">0x451</span></span>] = <span class="hljs-number"><span class="hljs-number">0xB8</span></span>; // ...   } ~codecvt_cp1251() { } protected: /**@brief        *  from-from_end,     <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-in_end.*/ virtual result do_in(State&amp;, const E* from, const E* from_end, const E* &amp;from_next, I* to, I* to_end, I* &amp;to_next) const { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(from != from_end) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(to == to_end) { from_next = ++from; to_next = to; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> partial; } // ASCII <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span> &lt;= *from &amp;&amp; *from &lt;= <span class="hljs-number"><span class="hljs-number">0x7F</span></span>) { *to = static_cast&lt;I&gt;(*from); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-number"><span class="hljs-number">0xC0</span></span> &lt;= static_cast&lt;unsigned <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>&gt;(*from) &amp;&amp; static_cast&lt;unsigned <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>&gt;(*from) &lt;=<span class="hljs-number"><span class="hljs-number">0xFF</span></span>) { *to = static_cast&lt;I&gt;(static_cast&lt;unsigned <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>&gt;(*from) + <span class="hljs-number"><span class="hljs-number">0x350</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { typename std::map&lt;E, I&gt;::const_iterator s; s = in_tab.lower_bound(*from); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(s == in_tab.<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>()) { //   ,  from  <span class="hljs-built_in"><span class="hljs-built_in">next</span></span>   from_next = ++from; to_next = ++to; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">error</span></span>; } *to = s-&gt;second; } ++to; ++from; } from_next = from_end; to_next = to; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ok; } /**@brief    ,  <span class="hljs-literal"><span class="hljs-literal">true</span></span>*/ virtual int do_encoding() const throw() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } /**@brief    ,  <span class="hljs-literal"><span class="hljs-literal">true</span></span>*/ virtual bool do_always_noconv() const throw() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } /*     virtual result do_out(State&amp;, const I* from, const I* from_end, const I* &amp;from_next, E* to, E* to_end, E* &amp;to_next); virtual int do_length(State&amp; s, const E* from, const E* from_end, size_t <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>) const; virtual int do_max_length() const throw(); */ private: //       std::map&lt;E, I&gt; in_tab; std::map&lt;I, E&gt; out_tab; };</code> </pre><br><br><h3>  Notes </h3><br>  I did not litter the article with an extra code - the codecvt facet for cp866 is implemented in a similar way, but I mentioned ctype earlier, but if someone needs a working example, these facets can be taken on github - git: //github.com/hoxnox/cyrillic- facets.git. <br>  And I apologize for the lack of line numbers - so that the UFO "swallowed" the topic had to be reduced highight code. <br><br>  Read more about UNICODE <a href="http://ru.wikipedia.org/wiki/%25D0%25AE%25D0%25BD%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25B4" title="Unicode article on wikipedia">here.</a> <br>  More about facets in the Straustrup C ++ Programming Language, third special edition, appendix <br>  More about boost :: xpressive <a href="http://boost-sandbox.sourceforge.net/libs/xpressive/doc/html/index.html" title="boost :: xpressive manual">here</a> <br><br>  <b>UPD 20150813:</b> <br>  Habrapapolzovatel <a href="https://habrahabr.ru/users/cyapa/" class="user_link">Cyapa</a> conducted an investigation and found out that the codecvt facet only works with threads that work with bisic_filebuf.  According to the standard (clause 27.9.1.1, besides this is noted by Straustrup) implementations are not required to call the codecvt facet methods for other buffers ‚Äî in particular, basic_stringbuf.  Thus, if you create a locale with your codecvt facet and hope that the std :: stringstream to which this locale is assigned (using imbue) will pull this facet, you are mistaken. </div><p>Source: <a href="https://habr.com/ru/post/107679/">https://habr.com/ru/post/107679/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../107673/index.html">Hack Kinect, serve Open Source and get $ 2000. The winner is already there</a></li>
<li><a href="../107674/index.html">Easy installation and configuration of BURG</a></li>
<li><a href="../107675/index.html">My experience of opening a free hosting</a></li>
<li><a href="../107677/index.html">First look at Activiti</a></li>
<li><a href="../107678/index.html">Book The Art of Unit Testing with Examples in .NET</a></li>
<li><a href="../107680/index.html">Gimpbox - Single Window Gimp</a></li>
<li><a href="../107682/index.html">OOP Practice PHP5: emulation of impurities (mixin) in the language</a></li>
<li><a href="../107683/index.html">Forwarding block devices to a XenServer virtual machine</a></li>
<li><a href="../107684/index.html">.Net connector for elFinder file manager</a></li>
<li><a href="../107685/index.html">The algorithm of the user's popularity on the site - ‚ÄúNon-standard approach to standard things‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>