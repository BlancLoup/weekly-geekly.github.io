<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automate the publication of an application on Google Play</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you have an android application that you are going to publish on Google Play or it has already been published, as well as if you are only developin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automate the publication of an application on Google Play</h1><div class="post__text post__text-html js-mediator-article">  If you have an android application that you are going to publish on Google Play or it has already been published, as well as if you are only developing it, and it is in closed beta testing, and the customer / tester periodically needs to collect and transfer the assembly by hand, it is perhaps better automate this process <br><a name="habracut"></a><br>  You can independently understand the <a href="https://developers.google.com/android-publisher">documentation</a> in English, but if the process is difficult or something does not work, I hope the publication will be useful <br><br>  Before you begin, you must manually publish the first version of the application. <br><br><h4>  Access setting </h4><br>  Open the <a href="https://play.google.com/apps/publish">Google Play Developer Console</a> and go to <i>Settings</i> ‚Üí <i>API access</i> <br>  The console must be linked to the Google API project.  If you do not have a project, then at the moment only the button Create new project will be available from the interface. <br><img src="https://habrastorage.org/files/333/fbc/395/333fbc3959d449a3afba1170b0c1e47e.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If there is, then a list of these projects will be available.  The link button, of course, binds them <br><img src="https://habrastorage.org/files/e14/cbf/2fd/e14cbf2fd25b4a058094d2d8c4094a01.jpg"><br><br>  But let's consider an example with the creation of a new project.  You can create it from the <a href="https://console.developers.google.com/">Google API Console</a> or directly from the Google Play Developer Console, which you already have, click the <i>Create new project</i> button <br><br>  If this is your first time creating a Google API project, a popup window will appear, here <i>Accept All</i> <br><img src="https://habrastorage.org/files/927/38f/304/92738f30489a44ea8e82d26b270a7153.jpg"><br><br>  Great, now you have a project and a service account, which in this case is created automatically <br><img src="https://habrastorage.org/files/345/8ce/e80/3458cee80bcd47bbb022c836737b120f.jpg"><br><br>  Now you need to allow this account to work with Google Play and give it a role.  This can also be done right from here, click <i>Grant access</i> .  You will be transferred to the User accounts &amp; right menu (seen in the background) and a popup window will open, where the email and other required fields will already be filled out.  Click <i>Add user</i> <br><img src="https://habrastorage.org/files/66b/895/ec8/66b895ec8af34c9d88c6f23d71be69bf.jpg"><br><br>  Now you see that your user has been successfully added. <br><img src="https://habrastorage.org/files/640/575/5ff/6405755ffa084992a196719efe2645a7.jpg"><br><br>  Now you need to generate a pair of public and private keys so that you can work with libraries and publish new versions of the application.  To do this, open the <a href="https://console.developers.google.com/project">list of projects</a> in the Google API Console and click on the one you need, by default it is called <i>Google Play Android Developer</i> <br><img src="https://habrastorage.org/files/c72/a34/cf3/c72a34cf3f8f42259dd0ebb869852b72.jpg"><br><br>  Then click the menu item <i>Credentials</i> ‚Üí <i>Create credentials</i> , select <i>Service account key</i> <br><img src="https://habrastorage.org/files/c89/977/5c9/c899775c945e4f2ea37fa924c35315d0.jpg"><br><br>  Select the <i>default service account</i> from the <i>Compute Engine</i> list and transfer the radio button to <i>P12</i> .  Click <i>Create</i> <br><img src="https://habrastorage.org/files/443/904/821/44390482187443429b3dbc4722eeb770.jpg"><br><br>  With all settings, a pair of public and private keys with the name <i>Google Play Android Developer-% id% .p12 slice</i> was saved on the computer <br><img src="https://habrastorage.org/files/166/b54/0dc/166b540dc6864115b47660aeff46887e.jpg"><br><img src="https://habrastorage.org/files/996/f28/da7/996f28da7dd940cfa78e20d823abb049.jpg"><br><br><h4>  Let's start programming </h4><br>  Now Google provides libraries in java and python to work with the Google Play Developer API.  We will consider an option on java, for this <a href="">download the zip-archive</a> with libraries and examples <br>  Open your IDE and create a project, I called mine ProductionManager, connect the following libraries: <br><ul><li>  google-api-client-1.19.0.jar </li><li>  google-api-services-androidpublisher-v2-rev20141111-1.19.0.jar </li><li>  google-http-client-1.19.0.jar </li><li>  google-http-client-jackson2-1.19.0.jar </li><li>  google-oauth-client-1.19.0.jar </li><li>  jackson-core-2.1.3.jar </li></ul><br>  Copy the <i>Google Play Android Developer</i> file - <i>% id% .p12 piece</i> into the resource folder of your project, I renamed it so that there were no spaces, it seems I had an exception when I tried to read it.  If you keep the source code of this project in VCS where many people have access, it is probably better to store the file on a continuous integration server, here is at your discretion. <br><br>  Before building and publishing the application, I make a request to find out the latest version of the code (versionCode) and update it, because I like them to go in an arithmetic progression with step 1 (those are just 1, 2, 3 ...), you can just substitute the buildNumber from the CI server or revesionNumber from your VCS, also at your discretion <br><br><div class="spoiler">  <b class="spoiler_title">Version update</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Edits </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getApplicationEdits</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ String applicationName = <span class="hljs-string"><span class="hljs-string">"ApplicationName"</span></span>; String serviceAccountId = <span class="hljs-string"><span class="hljs-string">"--@developer.gserviceaccount.com"</span></span> HttpTransport httpTransport = GoogleNetHttpTransport.newTrustedTransport(); JsonFactory jsonFactory = JacksonFactory.getDefaultInstance(); KeyStore keyStore = SecurityUtils.getPkcs12KeyStore(); InputStream inputStream = ProductionManager.class.getResourceAsStream(<span class="hljs-string"><span class="hljs-string">"/resources/key.p12"</span></span>); PrivateKey privateKey = SecurityUtils.loadPrivateKeyFromKeyStore(keyStore, inputStream, <span class="hljs-string"><span class="hljs-string">"notasecret"</span></span>, <span class="hljs-string"><span class="hljs-string">"privatekey"</span></span>, <span class="hljs-string"><span class="hljs-string">"notasecret"</span></span>); inputStream.close(); GoogleCredential credential = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GoogleCredential .Builder() .setTransport(httpTransport) .setJsonFactory(jsonFactory) .setServiceAccountId(serviceAccountId) .setServiceAccountScopes(Collections.singleton(AndroidPublisherScopes.ANDROIDPUBLISHER)) .setServiceAccountPrivateKey(privateKey) .build(); AndroidPublisher androidPublisher = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AndroidPublisher .Builder(httpTransport, jsonFactory, credential) .setApplicationName(applicationName) .build(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> androidPublisher.edits(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateVersionCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ String packageName = <span class="hljs-string"><span class="hljs-string">"com.package.name"</span></span>; Edits edits = getApplicationEdits(); String editId = edits .insert(packageName, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) .execute() .getId(); ApksListResponse apksResponse = edits .apks() .list(packageName, editId) .execute(); List&lt;Integer&gt; versions = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;Integer&gt;(); List&lt;Apk&gt; apks = apksResponse.getApks(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (apks == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"responsed list of apks is null"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Apk apk : apks) { versions.add(apk.getVersionCode()); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (versions.isEmpty()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"previous versions are not detected"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lastVersionCode = Collections.max(versions); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastVersionCode == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"version is 0"</span></span>); } <span class="hljs-comment"><span class="hljs-comment">//TODO update version code //++lastVersionCode }</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Application publications</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publishApplication</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ String packageName = <span class="hljs-string"><span class="hljs-string">"com.package.name"</span></span>; String track = <span class="hljs-string"><span class="hljs-string">"beta"</span></span>;<span class="hljs-comment"><span class="hljs-comment">//release String setupFilePath = "/path/to/setup/file/app.apk"; Edits edits = getApplicationEdits(); String editId = edits .insert(packageName, null) .execute() .getId(); FileContent mediaContent = new FileContent("application/vnd.android.package-archive", new File(setupFilePath)); Upload uploadRequest = edits .apks() .upload(packageName, editId, mediaContent); Apk apk = uploadRequest.execute(); List&lt;Integer&gt; versions = new ArrayList&lt;&gt;(); versions.add(apk.getVersionCode()); edits .tracks() .update(packageName, editId, track, new Track().setVersionCodes(versions)) .execute(); edits .commit(packageName, editId) .execute(); }</span></span></code> </pre><br></div></div><br>  Compile the executable jar.  Now you need to configure the creation of the installation file and its publication on your CI server, I use TeamCity.  So, we will have 4 build steps: <br><ol><li>  Update versioncode.  Run the jar file with the parameter that you will process and call the updateVersionCode () method.  This is how it looks on TeamCity <br><img src="https://habrastorage.org/files/0b5/c5f/085/0b5c5f0855874724a2ca1a024323c6dd.jpg"><br></li><li>  Update versionName </li><li>  Generation apk.  You can use the command line, you can select the special step, there is a gradle and IntelliJ IDEA, in the second case you need to specify the name artifact </li><li>  The publication of the application.  Just run the jar file with a different parameter and call the publishApplication () method </li></ol><br><br>  Thanks for attention </div><p>Source: <a href="https://habr.com/ru/post/281557/">https://habr.com/ru/post/281557/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../281547/index.html">Regular expressions search with regular expressions</a></li>
<li><a href="../281549/index.html">Creating a simple game based on FPGA</a></li>
<li><a href="../281551/index.html">Top 5 reports from the Mobius 2015 Mobile Development Conference</a></li>
<li><a href="../281553/index.html">Fragility of data warehousing architecture</a></li>
<li><a href="../281555/index.html">How we did the Winter Internship on iOS- and Android-development in Redmadrobot</a></li>
<li><a href="../281559/index.html">Chat bot development for Facebook Messenger</a></li>
<li><a href="../281561/index.html">Paul Graham, ‚ÄúHackers and Artists‚Äù, chapter 10: ‚ÄúProgramming Languages ‚Äã‚ÄãExplained‚Äù</a></li>
<li><a href="../281563/index.html">Data Storage: What is the future?</a></li>
<li><a href="../281565/index.html">IBM / Lenovo Servers and Watchdog Timer: Episode II</a></li>
<li><a href="../281569/index.html">Winner of Password Hashing Competition Argon2 or again on slow hashing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>