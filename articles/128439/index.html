<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We get lists of mac-addresses on ports of managed switches in Zabbix</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the organization where I work, quite a large number of managed switches are used, spread over several buildings. I wanted to see the MAC addresses ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We get lists of mac-addresses on ports of managed switches in Zabbix</h1><div class="post__text post__text-html js-mediator-article">  In the organization where I work, quite a large number of managed switches are used, spread over several buildings.  I wanted to see the MAC addresses on their ports not only using telnet or ssh, but directly in the web interface of the Zabbix monitoring system. <br><a name="habracut"></a><br><h5>  <b>Information gathering and theory</b> </h5><br>  In search of information on how to do this, Google was asked, and after a brief search, a wonderful Cisco authorship <a href="http://www.cisco.com/en/US/tech/tk648/tk362/technologies_tech_note09186a00801c9199.shtml">document</a> was found, describing the algorithm for obtaining the required addresses and identifying the ports on which they appear. <br>  A cursory study of the findings of snmpwalk from the 3Com 4200G switch showed that in my case it is not even necessary to determine the vlan, and only three steps are sufficient to determine the MAC addresses by ports. <br><br>  As you can see from the documentation, we just need to: <br>  1) get the address list with the command <br> <code>$snmpwalk -c public -v 2c hostname .1.3.6.1.2.1.17.4.3.1.1 <br> <br> 17.4.3.1.1.0.0.12.7.172.8 = Hex: 00 00 0C 07 AC 08 <br> 17.4.3.1.1.0.1.2.27.80.145 = Hex: 00 01 02 1B 50 91 <br> 17.4.3.1.1.0.1.3.72.77.90 = Hex: 00 01 03 48 4D 5A <br> 17.4.3.1.1.0.1.3.72.221.191 = Hex: 00 01 03 48 DD BF <br> ... <br></code> <br>  2) get a list of ports with the command <br> <code>$snmpwalk -c public -v 2c hostname .1.3.6.1.2.1.17.4.3.1.2 <br> 17.4.3.1.2.0.0.12.7.172.8 = 13 <br> 17.4.3.1.2.0.1.2.27.80.128 = 13 <br> 17.4.3.1.2.0.1.2.27.80.145 = 13 <br> 17.4.3.1.2.0.1.2.163.145.225 = 13 <br> ... <br></code> <br>  If we interview a simple switch, then this wonderful number (13 in the example) is our switch port. <br><br>  3) It remains only to find a match between the OID numbers, and we will see that OIDs ending in <u>12.7.172.8</u> will give us the mac and the port number on which this mac hangs. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  <b>Moving from theory to practice</b> </h5><br>  To automate this whole thing, I sketched a simple pearl script ( <b>UPDATE0: the</b> code was updated according to the advice of <a href="https://habrahabr.ru/users/gescheit/" class="user_link">gescheit</a> ; <b>UPDATE1: the</b> code was updated again according to the advice of <a href="https://habrahabr.ru/users/freelsd/" class="user_link">FreeLSD</a> ) <br><br><blockquote>  <font color="#666666">#!</font>  <font color="#666666">/ usr / bin / perl</font> <br>  <font color="#666666"># ================================================= ===================</font> <br>  <font color="#666666">#</font> <br>  <font color="#666666"># QUERY MAC ADDRESSES FROM 3COM SWITCH FROM SELECTED PORT</font> <br>  <font color="#666666"># ================================================= ===================</font> <br><br><br>  use strict; <br>  use Net :: SNMP qw <font color="#7a0874">(</font> snmp_dispatcher oid_lex_sort <font color="#7a0874">)</font> ; <br><br>  my <font color="#007800">$ show_vendor</font> = <font color="#000000">1</font> ; <br>  my <font color="#007800">$ script</font> = <font color="#ff0000">"/usr/share/zabbix/scripts/mac.sh -s"</font> ; <br>  my <font color="#007800">$ debug</font> = <font color="#000000">0</font> ; <br>  my <font color="#007800">$ file_name</font> = <font color="#ff0000">"/ tmp / <font color="#007800">$ ARGV</font> [0] -getmac.tmp"</font> ; <br>  my <font color="#007800">$ interval</font> = <font color="#000000">90</font> ;  <font color="#666666">#refresh rate</font> <br>  my <font color="#007800">$ new</font> = <font color="#000000">0</font> ; <br>  my <font color="#000000">@</font> list; <br>  my <font color="#007800">$ write_secs</font> = <font color="#7a0874">(</font> <font color="#c20cb9">stat</font> <font color="#7a0874">(</font> <font color="#007800">$ file_name</font> <font color="#7a0874">)</font> <font color="#7a0874">)</font> <font color="#7a0874">[</font> <font color="#000000">9</font> <font color="#7a0874">]</font> ; <br>  <font color="#000000">if</font> <font color="#7a0874">(</font> <font color="#007800">$ debug</font> == <font color="#000000">1</font> <font color="#7a0874">)</font> <font color="#7a0874">{</font> <br>  print <font color="#ff0000">"file <font color="#007800">$ file_name</font> updated at"</font> , scalar <font color="#7a0874">(</font> localtime <font color="#7a0874">(</font> <font color="#007800">$ write_secs</font> <font color="#7a0874">)</font> <font color="#7a0874">)</font> , <font color="#ff0000">" <font color="#000099">\ n</font> "</font> ; <br>  <font color="#7a0874">}</font> ; <br>  <font color="#000000">if</font> <font color="#7a0874">(</font> <font color="#007800">$ write_secs</font> + <font color="#007800">$ interval</font> <font color="#000000">&lt;</font> <font color="#000000">time</font> <font color="#7a0874">)</font> <font color="#7a0874">{</font> <font color="#666666">#file updated less then $ interval seconds ago</font> <br>  <font color="#000000">if</font> <font color="#7a0874">(</font> <font color="#007800">$ debug</font> == <font color="#000000">1</font> <font color="#7a0874">)</font> <font color="#7a0874">{</font> print <font color="#ff0000">"generating new mac table <font color="#000099">\ n</font> "</font> ;  <font color="#7a0874">}</font> <br>  <font color="#007800">$ new</font> = <font color="#000000">1</font> ; <br>  open FH, <font color="#ff0000">"&gt; <font color="#007800">$ file_name</font> "</font> or die <font color="#ff0000">"can't open ' <font color="#007800">$ file_name</font> ': $!"</font>  ; <br>  <font color="#7a0874">}</font> <font color="#000000">else</font> <font color="#7a0874">{</font> <br>  <font color="#000000">if</font> <font color="#7a0874">(</font> <font color="#007800">$ debug</font> == <font color="#000000">1</font> <font color="#7a0874">)</font> <font color="#7a0874">{</font> print <font color="#ff0000">"using old mac table <font color="#000099">\ n</font> "</font> ;  <font color="#7a0874">}</font> <br>  open FR, <font color="#ff0000">"&lt; <font color="#007800">$ file_name</font> "</font> or die <font color="#ff0000">"can't open ' <font color="#007800">$ file_name</font> ': $!"</font>  ; <br>  <font color="#000000">while</font> <font color="#7a0874">(</font> my <font color="#007800">$ line</font> = <font color="#000000">&lt;</font> FR <font color="#000000">&gt;</font> <font color="#7a0874">)</font> <font color="#7a0874">{</font> <br>  chomp <font color="#7a0874">(</font> <font color="#007800">$ line</font> <font color="#7a0874">)</font> ; <br>  my <font color="#7a0874">(</font> <font color="#007800">$ p</font> , <font color="#007800">$ m</font> <font color="#7a0874">)</font> = split <font color="#000000">/</font> ;  <font color="#000000">/</font> , <font color="#007800">$ line</font> ; <br>  <font color="#000000">@</font> list <font color="#7a0874">[</font> <font color="#007800">$ p</font> <font color="#7a0874">]</font> = <font color="#ff0000">"@list [ <font color="#007800">$ p</font> ] <font color="#007800">$ m</font> ,"</font> ; <br>  <font color="#7a0874">}</font> <br>  <font color="#7a0874">}</font> <br>  <font color="#666666"># =====================================</font> <br>  my <font color="#007800">$ session</font> ; <br>  my <font color="#007800">$ error</font> ; <br>  my <font color="#007800">$ port</font> = <font color="#007800">$ ARGV</font> <font color="#7a0874">[</font> <font color="#000000">1</font> <font color="#7a0874">]</font> ; <br>  <font color="#000000">if</font> <font color="#7a0874">(</font> <font color="#007800">$ new</font> == <font color="#000000">1</font> <font color="#7a0874">)</font> <font color="#7a0874">{</font> <br>  <font color="#666666"># === Setup session to remote host ===</font> <br>  <font color="#7a0874">(</font> <font color="#007800">$ session</font> , <font color="#007800">$ error</font> <font color="#7a0874">)</font> = Net :: SNMP- <font color="#000000">&gt;</font> session <font color="#7a0874">(</font> <br>  <font color="#660033">-hostname</font> = <font color="#000000">&gt;</font> <font color="#007800">$ ARGV</font> <font color="#7a0874">[</font> <font color="#000000">0</font> <font color="#7a0874">]</font> <font color="#000000">||</font>  <font color="#ff0000">'localhost'</font> , <br>  <font color="#660033">-community</font> = <font color="#000000">&gt;</font> <font color="#ff0000">'public'</font> , <br>  <font color="#660033">-version</font> = <font color="#000000">&gt;</font> <font color="#ff0000">'2c'</font> , <br>  <font color="#660033">-translate</font> = <font color="#000000">&gt;</font> <font color="#7a0874">[</font> -octetstring = <font color="#000000">&gt;</font> <font color="#000000">0</font> <font color="#7a0874">]</font> , <br>  <font color="#660033">-port</font> = <font color="#000000">&gt;</font> <font color="#000000">161</font> <br>  <font color="#7a0874">)</font> ; <br>  <font color="#666666"># === Was the session created?</font>  <font color="#666666">===</font> <br>  <font color="#000000">if</font> <font color="#7a0874">(</font> <font color="#000000">!</font> defined <font color="#7a0874">(</font> <font color="#007800">$ session</font> <font color="#7a0874">)</font> <font color="#7a0874">)</font> <font color="#7a0874">{</font> <br>  <font color="#7a0874">printf</font> <font color="#7a0874">(</font> <font color="#ff0000">"ERROR:% s <font color="#000099">\ n</font> "</font> , <font color="#007800">$ error</font> <font color="#7a0874">)</font> ; <br>  <font color="#7a0874">exit</font> <font color="#000000">1</font> ; <br>  <font color="#7a0874">}</font> <br>  <font color="#7a0874">}</font> ; <br>  <font color="#666666"># ==================================</font> <br><br>  <font color="#666666"># === OIDs queried to retrieve information ====</font> <br>  my <font color="#007800">$ TpFdbAddress</font> = <font color="#ff0000">'1.3.6.1.2.1.17.4.3.1.1'</font> ; <br>  my <font color="#007800">$ TpFdbPort</font> = <font color="#ff0000">'1.3.6.1.2.1.17.4.3.1.2'</font> ; <br>  <font color="#666666"># =============================================</font> <br>  my <font color="#007800">$ result</font> ; <br>  my <font color="#000000">@</font> tmp; <br>  my <font color="#007800">$ x</font> ; <br>  <font color="#000000">if</font> <font color="#7a0874">(</font> <font color="#007800">$ new</font> == <font color="#000000">1</font> <font color="#7a0874">)</font> <font color="#7a0874">{</font> <br>  <font color="#000000">if</font> <font color="#7a0874">(</font> defined <font color="#7a0874">(</font> <font color="#007800">$ result</font> = <font color="#007800">$ session</font> - <font color="#000000">&gt;</font> get_table <font color="#7a0874">(</font> <font color="#007800">$ TpFdbAddress</font> <font color="#7a0874">)</font> <font color="#7a0874">)</font> <font color="#7a0874">)</font> <font color="#7a0874">{</font> <br>  foreach <font color="#7a0874">(</font> oid_lex_sort <font color="#7a0874">(</font> keys <font color="#7a0874">(</font> <font color="#000000">%</font> <font color="#7a0874">{</font> <font color="#007800">$ result</font> <font color="#7a0874">}</font> <font color="#7a0874">)</font> <font color="#7a0874">)</font> <font color="#7a0874">)</font> <font color="#7a0874">{</font> <br>  <font color="#007800">$ x</font> = unpack <font color="#7a0874">(</font> <font color="#ff0000">'H *'</font> , <font color="#007800">$ result</font> - <font color="#000000">&gt;</font> <font color="#7a0874">{</font> <font color="#007800">$ _</font> <font color="#7a0874">}</font> <font color="#7a0874">)</font> ; <br>  <font color="#007800">$ x</font> = ~ s <font color="#000000">/</font> <font color="#7a0874">(</font> .. <font color="#7a0874">(</font> ? <font color="#000000">!</font> \ Z <font color="#7a0874">)</font> <font color="#7a0874">)</font> <font color="#000000">/</font> \ <font color="#000000">1</font> : <font color="#000000">/</font> g; <br>  push <font color="#7a0874">(</font> <font color="#000000">@</font> tmp, <font color="#007800">$ x</font> <font color="#7a0874">)</font> ; <br>  <font color="#7a0874">}</font> <br>  <font color="#7a0874">}</font> <font color="#000000">else</font> <font color="#7a0874">{</font> <br>  <font color="#000000">if</font> <font color="#7a0874">(</font> <font color="#007800">$ debug</font> == <font color="#000000">1</font> <font color="#7a0874">)</font> <font color="#7a0874">{</font> <br>  <font color="#7a0874">printf</font> <font color="#7a0874">(</font> <font color="#ff0000">"ERROR:% s <font color="#000099">\ n</font> <font color="#000099">\ n</font> "</font> , <font color="#007800">$ session</font> - <font color="#000000">&gt;</font> error <font color="#7a0874">(</font> <font color="#7a0874">)</font> <font color="#7a0874">)</font> ; <br>  <font color="#7a0874">}</font> <br>  <font color="#7a0874">}</font> <br>  <font color="#666666"># ==========================================</font> <br>  <font color="#666666"># === Print the returned MAC ports ===</font> <br>  <font color="#007800">$ result</font> ; <br>  <font color="#000000">if</font> <font color="#7a0874">(</font> defined <font color="#7a0874">(</font> <font color="#007800">$ result</font> = <font color="#007800">$ session</font> - <font color="#000000">&gt;</font> get_table <font color="#7a0874">(</font> -baseoid = <font color="#000000">&gt;</font> <font color="#007800">$ TpFdbPort</font> <font color="#7a0874">)</font> <font color="#7a0874">)</font> <font color="#7a0874">)</font> <font color="#7a0874">{</font> <br>  my <font color="#007800">$ i</font> = <font color="#000000">0</font> ; <br>  my <font color="#007800">$ out</font> = <font color="#ff0000">""</font> ; <br>  my <font color="#007800">$ res</font> = <font color="#000000">0</font> ; <br>  my <font color="#007800">$ tmp_port</font> ; <br>  my <font color="#007800">$ tmp_mac_list</font> = <font color="#ff0000">""</font> ; <br>  foreach <font color="#7a0874">(</font> oid_lex_sort <font color="#7a0874">(</font> keys <font color="#7a0874">(</font> <font color="#000000">%</font> <font color="#7a0874">{</font> <font color="#007800">$ result</font> <font color="#7a0874">}</font> <font color="#7a0874">)</font> <font color="#7a0874">)</font> <font color="#7a0874">)</font> <font color="#7a0874">{</font> <br>  <font color="#000000">if</font> <font color="#7a0874">(</font> <font color="#007800">$ result</font> - <font color="#000000">&gt;</font> <font color="#7a0874">{</font> <font color="#007800">$ _</font> <font color="#7a0874">}</font> == <font color="#007800">$ port</font> <font color="#7a0874">)</font> <font color="#7a0874">{</font> <br>  <font color="#007800">$ res</font> = <font color="#000000">1</font> ; <br>  <font color="#000000">if</font> <font color="#7a0874">(</font> <font color="#007800">$ show_vendor</font> == <font color="#000000">1</font> <font color="#7a0874">)</font> <font color="#7a0874">{</font> <br>  <font color="#007800">$ out</font> = <font color="#000000">`</font> <font color="#007800">$ script</font> <font color="#007800">$ tmp</font> <font color="#7a0874">[</font> <font color="#007800">$ i</font> <font color="#7a0874">]</font> <font color="#000000">`</font> ; <br>  <font color="#7a0874">printf</font> <font color="#7a0874">(</font> <font color="#ff0000">"% s (% s)"</font> , <font color="#007800">$ tmp</font> <font color="#7a0874">[</font> <font color="#007800">$ i</font> <font color="#7a0874">]</font> , <font color="#007800">$ out</font> <font color="#7a0874">)</font> ; <br>  <font color="#7a0874">}</font> <font color="#000000">else</font> <font color="#7a0874">{</font> <br>  <font color="#7a0874">printf</font> <font color="#7a0874">(</font> <font color="#ff0000">"% s"</font> , <font color="#007800">$ tmp</font> <font color="#7a0874">[</font> <font color="#007800">$ i</font> <font color="#7a0874">]</font> <font color="#7a0874">)</font> ; <br>  <font color="#7a0874">}</font> ; <br>  print <font color="#ff0000">","</font> ; <br>  <font color="#7a0874">}</font> ; <br>  <font color="#000000">if</font> <font color="#7a0874">(</font> <font color="#007800">$ show_vendor</font> == <font color="#000000">1</font> <font color="#7a0874">)</font> <font color="#7a0874">{</font> <br>  <font color="#007800">$ out</font> = <font color="#000000">`</font> <font color="#007800">$ script</font> <font color="#007800">$ tmp</font> <font color="#7a0874">[</font> <font color="#007800">$ i</font> <font color="#7a0874">]</font> <font color="#000000">`</font> ; <br>  <font color="#7a0874">printf</font> FH <font color="#7a0874">(</font> <font color="#ff0000">"% s;% s (% s) <font color="#000099">\ n</font> "</font> , <font color="#007800">$ result</font> - <font color="#000000">&gt;</font> <font color="#7a0874">{</font> <font color="#007800">$ _</font> <font color="#7a0874">}</font> , <font color="#007800">$ tmp</font> <font color="#7a0874">[</font> <font color="#007800">$ i</font> <font color="#7a0874">]</font> , <font color="#007800">$ out</font> <font color="#7a0874">)</font> ; <br>  <font color="#7a0874">}</font> <font color="#000000">else</font> <font color="#7a0874">{</font> <br>  <font color="#7a0874">printf</font> FH <font color="#7a0874">(</font> <font color="#ff0000">"% s;% s <font color="#000099">\ n</font> "</font> , <font color="#007800">$ result</font> - <font color="#000000">&gt;</font> <font color="#7a0874">{</font> <font color="#007800">$ _</font> <font color="#7a0874">}</font> , <font color="#007800">$ tmp</font> <font color="#7a0874">[</font> <font color="#007800">$ i</font> <font color="#7a0874">]</font> <font color="#7a0874">)</font> ; <br>  <font color="#7a0874">}</font> ; <br>  <font color="#007800">$ i</font> ++; <br>  <font color="#7a0874">}</font> <br>  <font color="#000000">if</font> <font color="#7a0874">(</font> <font color="#007800">$ res</font> == <font color="#000000">0</font> <font color="#7a0874">)</font> <font color="#7a0874">{</font> <br>  print <font color="#ff0000">"null"</font> ; <br>  <font color="#7a0874">}</font> ; <br>  <font color="#7a0874">}</font> <font color="#000000">else</font> <font color="#7a0874">{</font> <br>  <font color="#000000">if</font> <font color="#7a0874">(</font> <font color="#007800">$ debug</font> == <font color="#000000">1</font> <font color="#7a0874">)</font> <font color="#7a0874">{</font> <br>  <font color="#7a0874">printf</font> <font color="#7a0874">(</font> <font color="#ff0000">"ERROR:% s <font color="#000099">\ n</font> <font color="#000099">\ n</font> "</font> , <font color="#007800">$ session</font> - <font color="#000000">&gt;</font> error <font color="#7a0874">(</font> <font color="#7a0874">)</font> <font color="#7a0874">)</font> ; <br>  <font color="#7a0874">}</font> <font color="#000000">else</font> <font color="#7a0874">{</font> <br>  print <font color="#ff0000">"null"</font> ; <br>  <font color="#7a0874">}</font> ; <br>  <font color="#7a0874">}</font> <br>  <font color="#7a0874">}</font> <font color="#000000">else</font> <font color="#7a0874">{</font> <br>  <font color="#000000">if</font> <font color="#7a0874">(</font> <font color="#000000">@</font> list <font color="#7a0874">[</font> <font color="#007800">$ port</font> <font color="#7a0874">]</font> <font color="#7a0874">)</font> <font color="#7a0874">{</font> <br>  print <font color="#ff0000">"@list [ <font color="#007800">$ port</font> ]"</font> ; <br>  <font color="#7a0874">}</font> <font color="#000000">else</font> <font color="#7a0874">{</font> <br>  print <font color="#ff0000">"null"</font> ; <br>  <font color="#7a0874">}</font> ; <br>  <font color="#7a0874">}</font> <br>  print <font color="#ff0000">" <font color="#000099">\ n</font> "</font> ; <br>  <font color="#666666"># =============================================</font> <br>  <font color="#666666"># === Close the session and exit the program ===</font> <br>  <font color="#000000">if</font> <font color="#7a0874">(</font> <font color="#007800">$ new</font> == <font color="#000000">1</font> <font color="#7a0874">)</font> <font color="#7a0874">{</font> <br>  <font color="#007800">$ session</font> - <font color="#000000">&gt;</font> close; <br>  close FH; <br>  <font color="#7a0874">}</font> <font color="#000000">else</font> <font color="#7a0874">{</font> <br>  close FR; <br>  <font color="#7a0874">}</font> <br>  <font color="#7a0874">exit</font> <font color="#000000">0</font> ; <br><br></blockquote><br><br>  The code is very unsophisticated, if there is no file with already received OIDs, then we get OIDs with mac-addresses, and write to the array.  And then in the same sequence we obtain OIDs with ports, which gives us the correspondence of the nth value in the array to the nth value of the received OID with the port number.  Then we dump the data in the file. <br>  If there is already a file at the start of the script, and it is not older than $ interval, which in my case is 90 seconds, then we take data from it.  This allowed the use of only 2 snmp switch requests. <br>  The script accepts two parameters as input, the first of which is the device address (this is the specificity of zabbix, for external scripts the first parameter is always the node's address), and the second parameter is the port number of interest to us.  If there are no addresses on this port, the script will return a string with the text ‚Äúnull‚Äù.  In the new version, we can still find out the device manufacturer by the mac-address.  To enable this feature, there is a $ show_vendor variable, at the value of which is equal to one, the script tries to get data about the manufacturer from another script specified in the script variable.  The mac-address of the device is transferred to this script.  For myself, I implemented a fairly simple sh script, the whole essence of which comes down to running a single line: <br><br><blockquote>  <font color="#c20cb9">awk</font> <font color="#660033">--assign</font> <font color="#007800">IGNORECASE</font> = <font color="#000000">1</font> <font color="#ff0000">'/ hex / &amp;&amp; /'</font> <font color="#007800">$ mac</font> <font color="#ff0000">'/ {for (x = 3; x &lt;= NF; x ++) {printf ("% s", $ x)}}'</font> <font color="#007800">$ filename</font> </blockquote><br><br>  The mysterious file hiding under the $ filename variable is obtained by <a href="http://standards.ieee.org/develop/regauth/oui/oui.txt">reference</a> , and contains all the data we need, carefully chosen ieee. <br><br>  I slightly improved this one line, adding even the ‚Äúupdate‚Äù mode, which extorts the most recent version of the list of manufacturers.  Here's what happened in the end: <br><br><blockquote>  <font color="#666666">#! / bin / sh</font> <br>  <font color="#666666">#get vendor from mac-address</font> <br>  <font color="#000000">if</font> <font color="#7a0874">[</font> <font color="#660033">-z</font> <font color="#ff0000">"$ 1"</font> <font color="#7a0874">]</font> ;  <font color="#000000">then</font> <br>  <font color="#7a0874">echo</font> <font color="#ff0000">"no args specified, exiting! Use $ 0 [-option] mac"</font> <br>  <font color="#7a0874">echo</font> <font color="#ff0000">"where [-option] can be -u (update databse and exit) or -s (silent mode, just show vendor)"</font> <br>  <font color="#7a0874">exit</font> <font color="#000000">1</font> <br>  <font color="#000000">fi</font> <br>  <font color="#666666"># don't forget that Zabbix set $ PATH when running scripts</font> <br>  <font color="#007800">filename</font> = <font color="#000000">/</font> usr <font color="#000000">/</font> share <font color="#000000">/</font> zabbix <font color="#000000">/</font> scripts <font color="#000000">/</font> oui.txt <br>  <font color="#007800">tmpfile</font> = <font color="#000000">/</font> tmp <font color="#000000">/</font> oui.txt <br>  <font color="#007800"><font color="#c20cb9">link</font></font> = http: <font color="#000000">//</font> standards.ieee.org <font color="#000000">/</font> develop <font color="#000000">/</font> regauth <font color="#000000">/</font> oui <font color="#000000">/</font> oui.txt <br>  <font color="#007800"><font color="#c20cb9">sed</font></font> = <font color="#000000">/</font> bin <font color="#000000">/</font> <font color="#c20cb9">sed</font> <br>  <font color="#007800"><font color="#c20cb9">awk</font></font> = <font color="#000000">/</font> bin <font color="#000000">/</font> <font color="#c20cb9">awk</font> <br><br>  <font color="#000000">case</font> $ <font color="#000000">1</font> <font color="#000000">in</font> <br>  -s <font color="#7a0874">)</font> <br>  <font color="#007800">silent</font> = <font color="#000000">1</font> <br>  <font color="#007800">mac</font> = $ <font color="#000000">2</font> <br>  <font color="#000000">if</font> <font color="#7a0874">[</font> <font color="#660033">-z</font> <font color="#ff0000">"$ 2"</font> <font color="#7a0874">]</font> ;  <font color="#000000">then</font> <br>  <font color="#7a0874">echo</font> <font color="#ff0000">"no mac specified, exiting!"</font> <br>  <font color="#7a0874">exit</font> <font color="#000000">1</font> <br>  <font color="#000000">fi</font> <br>  <font color="#000000">;;</font> <br>  -u <font color="#7a0874">)</font> <br>  <font color="#c20cb9">wget</font> <font color="#007800">$ link</font> <font color="#660033">-O</font> <font color="#007800">$ tmpfile</font> <br>  <font color="#000000">if</font> <font color="#7a0874">[</font> <font color="#007800">$?</font>  <font color="#660033">-gt</font> <font color="#000000">0</font> <font color="#7a0874">]</font> ;  <font color="#000000">then</font> <br>  <font color="#7a0874">echo</font> <font color="#ff0000">"download error, exiting"</font> <br>  <font color="#7a0874">exit</font> <font color="#000000">1</font> <br>  <font color="#000000">else</font> <br>  <font color="#7a0874">echo</font> <font color="#ff0000">"Download ok!"</font> <br>  <font color="#7a0874">echo</font> <font color="#ff0000">"Moving <font color="#007800">$ tmpfile</font> to <font color="#007800">$ filename</font> ..."</font> <br>  <font color="#c20cb9">mv</font> <font color="#660033">-f</font> <font color="#007800">$ tmpfile</font> <font color="#007800">$ filename</font> <br>  <font color="#000000">if</font> <font color="#7a0874">[</font> <font color="#007800">$?</font>  <font color="#660033">-gt</font> <font color="#000000">0</font> <font color="#7a0874">]</font> ;  <font color="#000000">then</font> <br>  <font color="#7a0874">echo</font> <font color="#ff0000">"Error!"</font> <br>  <font color="#000000">else</font> <br>  <font color="#7a0874">echo</font> <font color="#ff0000">"Success!"</font> <br>  <font color="#000000">fi</font> <br>  <font color="#7a0874">exit</font> <font color="#000000">0</font> <br>  <font color="#000000">fi</font> <br>  <font color="#000000">;;</font> <br>  <font color="#000000">*</font> <font color="#7a0874">)</font> <br>  <font color="#007800">mac</font> = $ <font color="#000000">1</font> <br>  <font color="#000000">;;</font> <br>  <font color="#000000">esac</font> <br>  <font color="#000000">if</font> <font color="#7a0874">[</font> <font color="#000000">!</font>  <font color="#660033">-f</font> <font color="#007800">$ filename</font> <font color="#7a0874">]</font> ;  <font color="#000000">then</font> <br>  <font color="#000000">if</font> <font color="#7a0874">[</font> <font color="#660033">-z</font> <font color="#007800">$ silent</font> <font color="#7a0874">]</font> ;  <font color="#000000">then</font> <br>  <font color="#7a0874">echo</font> <font color="#ff0000">"no mac list file, dowload it? [y / n]"</font> <br>  <font color="#000000">else</font> <br>  <font color="#7a0874">exit</font> <font color="#000000">1</font> <br>  <font color="#000000">fi</font> <br>  <font color="#000000">while</font> : <br>  <font color="#000000">do</font> <br>  <font color="#c20cb9">read</font> INPUT_STRING <br>  <font color="#000000">case</font> <font color="#007800">$ INPUT_STRING</font> <font color="#000000">in</font> <br>  y <font color="#7a0874">)</font> <br>  <font color="#7a0874">echo</font> <font color="#ff0000">"Trying to download from <font color="#007800">$ link</font> "</font> <br>  <font color="#c20cb9">wget</font> <font color="#007800">$ link</font> -O <font color="#007800">$ filename</font> <br>  <font color="#000000">if</font> <font color="#7a0874">[</font> <font color="#007800">$?</font>  <font color="#660033">-gt</font> <font color="#000000">0</font> <font color="#7a0874">]</font> ;  <font color="#000000">then</font> <br>  <font color="#7a0874">echo</font> <font color="#ff0000">"download error, exiting"</font> <br>  <font color="#7a0874">exit</font> <font color="#000000">1</font> <br>  <font color="#000000">else</font> <br>  <font color="#7a0874">echo</font> <font color="#ff0000">"Download ok!"</font> <br>  <font color="#000000">fi</font> <br>  <font color="#7a0874">break</font> <br>  <font color="#000000">;;</font> <br>  n <font color="#7a0874">)</font> <br>  <font color="#7a0874">echo</font> <font color="#ff0000">"exiting!"</font> <br>  <font color="#7a0874">exit</font> <font color="#000000">0</font> <br>  <font color="#000000">;;</font> <br>  <font color="#000000">*</font> <font color="#7a0874">)</font> <br>  <font color="#7a0874">echo</font> <font color="#ff0000">"wrong input, use [y / n]"</font> <br>  <font color="#000000">;;</font> <br>  <font color="#000000">esac</font> <br>  <font color="#000000">done</font> <br>  <font color="#000000">fi</font> <br>  <font color="#000000">if</font> <font color="#7a0874">[</font> <font color="#800000">$ {# mac}</font> <font color="#660033">-lt</font> <font color="#000000">8</font> <font color="#7a0874">]</font> ;  <font color="#000000">then</font> <br>  <font color="#007800">mac</font> = <font color="#000000">`</font> <font color="#7a0874">echo</font> <font color="#ff0000">" <font color="#007800">$ mac</font> "</font> <font color="#000000">|</font>  <font color="#007800">$ sed</font> <font color="#ff0000">'s / ^ \ (.. \) \ (.. \) \ (.. \) / \ 1- \ 2- \ 3 /'</font> <font color="#000000">`</font> <br>  <font color="#000000">else</font> <br>  <font color="#007800">mac</font> = <font color="#000000">`</font> <font color="#7a0874">echo</font> <font color="#ff0000">" <font color="#007800">$ mac</font> "</font> <font color="#000000">|</font>  <font color="#007800">$ sed</font> <font color="#660033">-e</font> <font color="#ff0000">'s /: / - / g'</font> <font color="#000000">`</font> <br>  <font color="#000000">fi</font> <br>  <font color="#007800">mac</font> = <font color="#800000">$ {mac: 0: 8}</font> <br>  <font color="#000000">if</font> <font color="#7a0874">[</font> <font color="#660033">-z</font> <font color="#007800">$ silent</font> <font color="#7a0874">]</font> ;  <font color="#000000">then</font> <br>  <font color="#7a0874">echo</font> <font color="#ff0000">"Searching for <font color="#007800">$ mac</font> ..."</font> <br>  <font color="#000000">fi</font> <br>  <font color="#007800">result</font> = <font color="#000000">`</font> <font color="#007800">$ awk</font> <font color="#660033">--assign</font> <font color="#007800">IGNORECASE</font> = <font color="#000000">1</font> <font color="#ff0000">'/ hex / &amp;&amp; /'</font> <font color="#007800">$ mac</font> <font color="#ff0000">'/ {for (x = 3; x &lt;= NF; x ++) {printf ("% s ", $ x)}}'</font> <font color="#007800">$ filename</font> <font color="#000000">`</font> <br>  <font color="#000000">if</font> <font color="#7a0874">[</font> <font color="#660033">-z</font> <font color="#ff0000">" <font color="#007800">$ result</font> "</font> <font color="#7a0874">]</font> ;  <font color="#000000">then</font> <br>  <font color="#007800">result</font> = <font color="#ff0000">"no info"</font> <br>  <font color="#000000">fi</font> <br>  <font color="#7a0874">echo</font> <font color="#660033">-n</font> <font color="#007800">$ result</font> <br></blockquote><br><br>  Run the script that gives us the manufacturer to check for performance: <br><br> <code><a href="http://standards.ieee.org/develop/regauth/oui/oui.txt"></a> <a href="http://standards.ieee.org/develop/regauth/oui/oui.txt"></a> $./mac.sh "000000" <br> no mac list file, dowload it? [y/n] <br> y <br> Trying to download from standards.ieee.org/develop/regauth/oui/oui.txt <br> --2011-10-06 14:20:16-- standards.ieee.org/develop/regauth/oui/oui.txt <br>  proxy.organization.ltd... 192.168.0.1 <br>    proxy.organization.ltd|192.168.0.1|:3128...  . <br>  Proxy ,  ... 200 OK <br> : 2493060 (2,4M) [text/plain] <br> Saving to: ¬´oui.txt¬ª <br> <br> 100%[==========================================================================================================================================================================&gt;] 2 493 060 784K/s  3,1s <br> <br> 2011-10-06 14:20:26 (784 KB/s) - ¬´oui.txt¬ª saved [2493060/2493060] <br> <br> Download ok! <br> Searching for 00-00-00... <br> XEROX CORPORATION <br></code> <br>  If everything works, move on. <br><br>  Now you need to configure the script execution time in the zabbixa config, increasing it to the desired values.  If the timeout value you select is not enough, you will immediately understand it, because the data elements reflecting mac-addresses will go one by one into the category of ‚Äúunsupported‚Äù with a description of an error like ‚Äúscript execution timeout‚Äù. <br>  Rule the config: <br>  #vim /etc/zabbix/zabbix-server.conf <br><br>  We are looking for such lines there <br> <code>### Option: Timeout <br> # Specifies how long we wait for agent, SNMP device or external check (in seconds). <br> # Range: 1-30</code> <br> <br>  and uncomment and change to the desired value <br> <code>Timeout=5</code> <br> <br>  We are also looking for <br> <code>### Option: ExternalScripts <br> # Location of external scripts <br> ExternalScripts=/usr/share/zabbix/scripts/</code> <br> <br>  and if necessary, change to the correct path to the scripts. <br>  Here is the way we have our script on the pearl and place.  I called it ingenuously - get_mac.pl <br><br>  Now in Zabbix we will configure the necessary data type in the template for the switch: <br><br><img src="https://habrastorage.org/storage1/13cee633/3773fa61/a1f0ac61/ee718467.png"><br><br>  And so for all ports. <br><br>  After that, you can get the data on the addresses on the ports of the switch directly in zabbix. <br>  It looks like this to me (I cannot post the updated screenshot with the names of the manufacturers, since habrastoradj does not work without a flash, but it doesn‚Äôt work with a Google flash drive either): <br><img src="https://habrastorage.org/storage1/d6a9833a/d5b31ad4/53e08fcb/2d5258a0.png"><br><br>  Do not worry, looking at port 16 - it is uplink. <br><br>  This technique has been tested and has been successfully working for a month on nine 3Com brand switches: 4200G, 4210, 2916, 2924. Zabbix version 1.8.5, recently updated to 1.8.7.  Considering that I wrote all this on the Cisco documentation, there should be no problems for Cisco switches. <br><br>  PS I believe that the script can (and should) be refined and reworked, but I am not strong in perl, and therefore I ask the habrasoobshchestvo help in this noble cause to post on such a wonderful project like Zabbix in the wiki.  I also plan, together with the improved script, to lay out my 3Com 4200G, 4210, 2924 switch templates. <br>  <b>UPD0 Script</b> code updated by <a href="https://habrahabr.ru/users/gescheit/" class="user_link">gescheit</a> advice <br>  <b>UPD1</b> Article and code updated on the advice of <a href="https://habrahabr.ru/users/freelsd/" class="user_link">FreeLSD</a> </div><p>Source: <a href="https://habr.com/ru/post/128439/">https://habr.com/ru/post/128439/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../128432/index.html">The dark side of programming for beginners, including php</a></li>
<li><a href="../128433/index.html">Hidden in the foliage</a></li>
<li><a href="../128434/index.html">The government loved Wi-Fi. Gorky Park, metro, universities. Calculating the cost of the network at the university</a></li>
<li><a href="../128437/index.html">How to add a new diagnostic rule in PVS-Studio? Everyday developers ...</a></li>
<li><a href="../128438/index.html">The basic theory of collision objects, sprites on Javascript</a></li>
<li><a href="../128440/index.html">Where's the lawyer: reload legal services</a></li>
<li><a href="../128441/index.html">Non-WYSIWYG diagrams on the wiki</a></li>
<li><a href="../128445/index.html">Mail.Ru Mail Support: Past, Present, Future</a></li>
<li><a href="../128446/index.html">The court forbade Anonymous to go online under the real name</a></li>
<li><a href="../128448/index.html">Kevin Turner, Microsoft COO, will speak at Tech ‚àô Ed Russia 2011</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>