<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a cross-browser shell for custom scripts</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, dear habrazhiteli. There were quite a few posts about user scripts (userscripts), however, they only showed how to use them. And in the work of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a cross-browser shell for custom scripts</h1><div class="post__text post__text-html js-mediator-article">  Hello, dear habrazhiteli.  There were quite a few posts about user scripts (userscripts), however, they only showed how to use them.  And in the work of userscripts there are a lot of cross-browser incompatibilities (as in any area of ‚Äã‚Äãbrowser js).  Naturally, you can install various add-ons for different browsers, however, in the case of writing a script for the end user, you will have to accompany him with a huge readme for installing components to ensure its normal operation.  What I personally, and you, too, I suppose, is not very happy with. <br><br>  This article will cover three browsers: Mozilla Firefox (with installed GreaseMonkey), Google Chrome, Opera.  The goal of the article is ‚Äúprocurement‚Äù, which will allow the user script to work in the same way in all the browsers listed.  The GM API implementation will not be considered, since  such already hundreds.  It is assumed that the reader is already familiar with the general rules of writing userscripts (if not, I recommend you first read another <a href="http://habrahabr.ru/post/129343/">article</a> ). <br><a name="habracut"></a><br><br>  And directly to the topic.  Let's start with the directives.  There are several incompatibilities here: first, only <a href="http://habrahabr.ru/users/include/" class="user_link">include is</a> supported in opera, only <a href="http://habrahabr.ru/users/match/" class="user_link">match is</a> supported in chrome.  Firefox supports both.  Accordingly, you need to specify both directives (suddenly).  Secondly, to support unsafeWindow in firefox, you need the @unwrap directive.  I will not specify that before using unsafeWindow you need to think hard about whether it is really so necessary.  So, the initial part of our workpiece looks like this: <br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// ==UserScript== // @name script_name // @author author's name // @version 1.0 // @description example // @unwrap // @run-at document-end // @include http://example.com/* // @match http://example.com/* // ==/UserScript==</span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Plus, in Chrome, the <a href="http://habrahabr.ru/users/match/" class="user_link">match</a> directive has a blessing in it, so it‚Äôs useful to add a line like this to the beginning: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (location.hostname !== <span class="hljs-string"><span class="hljs-string">"example.com"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;</code> </pre><br><br>  Now let's talk about the scope.  In Google Chrome, user scripts are always executed in a separate area of ‚Äã‚Äãview - while in opera, on the contrary, they are executed in the middle of the page, threatening to destroy all global variables.  Therefore, for security, it would be nice to add an additional closure: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// ==UserScript== // @name script_name // @author author's name // @version 1.0 // @description example // @unwrap // @run-at document-end // @include http://example.com/* // @match http://example.com/* // ==/UserScript== (function(){ if (location.hostname !== "example.com") return; })();</span></span></code> </pre><br><br>  And, finally, such an important thing as access to global objects.  In Mozilla Firefox, they are accessed through the unsafeWindow variable, in Opera the script is executed directly in the page's scope, therefore, global variables are accessible through the window, in Google Chrome there is no access to global objects at all (sadness).  However, unsafeWindow there can be emulated by adding an object to the page, onclick of which the window returns to us.  Actually, the code with comments: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   unsafeWindow    -   ,    , //      window var unsafeWindow= this.unsafeWindow; //  ,    unsafeWindow,     , //    (function(){ // ..,   ,      , //  unsafeWindow  chrome,   , ,   . var test_scr= document.createElement("script"); //       var tid= ("t" + Math.random() + +(new Date())).replace(/\./g, ""); //       . test_scr.text= "window."+tid+"=true"; document.querySelector("body").appendChild(test_scr); //      unsafeWindow, //         if (typeof(unsafeWindow) == "undefined" || !unsafeWindow[tid]) { if (window[tid]) { // ..   window -    window, //    unsafeWindow= window; } else { //   -    var scr= document.createElement("script"); scr.text= "(" + (function() { var el= document.createElement('unsafeWindow'); el.style.display= 'none'; el.onclick=function(){return window}; document.body.appendChild(el); }).toString() + ")()"; //   -   script      document.querySelector("body").appendChild(scr); this.unsafeWindow= document.querySelector("unsafeWindow").onclick(); //   ,     // onclick  unsafeWindow ,      unsafeWindow= this.unsafeWindow; }; } })(); // </span></span></code> </pre><br><br>  So, in the end, our stocking will look like this: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// ==UserScript== // @name script_name // @author author's name // @version 1.0 // @description example // @unwrap // @run-at document-end // @include http://example.com/* // @match http://example.com/* // ==/UserScript== (function(){ if (location.hostname !== "example.com") return; var unsafeWindow= this.unsafeWindow; (function(){ var test_scr= document.createElement("script"); var tid= ("t" + Math.random() + +(new Date())).replace(/\./g, ""); test_scr.text= "window."+tid+"=true"; document.querySelector("body").appendChild(test_scr); if (typeof(unsafeWindow) == "undefined" || !unsafeWindow[tid]) { if (window[tid]) { unsafeWindow= window; } else { var scr= document.createElement("script"); scr.text= "(" + (function() { var el= document.createElement('unsafeWindow'); el.style.display= 'none'; el.onclick=function(){return window}; document.body.appendChild(el); }).toString() + ")()"; document.querySelector("body").appendChild(scr); this.unsafeWindow= document.querySelector("unsafeWindow").onclick(); unsafeWindow= window.unsafeWindow; }; } })(); //  ,    })();</span></span></code> </pre><br><br>  Actually, that's all.  I hope this article will help someone. <br><br>  PS Oh yes.  To debug userscripts in Firefox, you can wrap your script code in a try ... catch structure like this: <br>  try { <br>  // script code <br>  } catch (e) {console.error (e)} <br>  Facilitates life very much. <br><br>  <b>UPD:</b> Thank you so much <a href="http://habrahabr.ru/users/spmbt/" class="user_link">spmbt</a> for such a nice addition to the article.  Rather, the article is an addition to what he wrote ... <br><br>  <b>UPD2:</b> The include directive will not allow the script to work in chrome on unnecessary sites, however, when installing the script, if you do not specify the <a href="http://habrahabr.ru/users/match/" class="user_link">match</a> directive, it will be said that the script works on all pages.  Therefore, it is better to specify the match directive. </div><p>Source: <a href="https://habr.com/ru/post/140825/">https://habr.com/ru/post/140825/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../140818/index.html">Jquery slideshow do it yourself</a></li>
<li><a href="../140820/index.html">Vizhenera cipher. Python parsing algorithm</a></li>
<li><a href="../140821/index.html">Home agent</a></li>
<li><a href="../140822/index.html">Psychology and digital reality</a></li>
<li><a href="../140824/index.html">Pirate party passed to the parliament of another German land</a></li>
<li><a href="../140826/index.html">Ajax site indexed by all search engines</a></li>
<li><a href="../140827/index.html">Eight principles of programming that can make your life easier</a></li>
<li><a href="../140828/index.html">Chalk-cepstral coefficients (MFCC) and speech recognition</a></li>
<li><a href="../140829/index.html">Web archive for Evernote</a></li>
<li><a href="../140830/index.html">And which exchange do you use?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>