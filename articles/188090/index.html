<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating TMG Internet traffic reports based on MS Reporting Services</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Part 1: clean table 
 At some point in time, I needed to create a flexible end-user traffic reporting system. This system had to solve two tasks: redu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating TMG Internet traffic reports based on MS Reporting Services</h1><div class="post__text post__text-html js-mediator-article"><h4>  Part 1: clean table </h4><br>  At some point in time, I needed to create a flexible end-user traffic reporting system.  This system had to solve two tasks: reduce the burden on system administrators, provide end users with a convenient system of reports in real time. <br><a name="habracut"></a><br>  Initial conditions of the problem: there is a TMG server that writes logs to a remote MS SQL server. <br><br>  So, if you open the database in which the TMG logs are written, we will see two tables - Firewalllog and Webproxylog.  To create reports and optimize the amount of stored data, I created a third, ‚Äúclean‚Äù table: report: <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [dbo].[report]( [<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">IDENTITY</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ClientUserName] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">514</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [DestinationHost] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">514</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [bytesrecvd] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [bytessent] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [logTime] [<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ClientAgent] [<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>](<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ClientIP] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">514</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [PK_report] PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED</code> </pre> <br>  Data from the Firewalllog and Webproxylog tables will be transferred to this table.  To transfer data, I used a SQL job, which runs once an hour and, summing up the data, inserts it into a clean table, then this data is deleted from the default tables, and the data from the ‚Äúclean‚Äù table older than 180 days is also deleted: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> dbo.REPORT (ClientUserName, ClientAgent, clientip, logtime, destinationhost, bytesrecvd, bytessent) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dbo.GetUserName (ClientUserName, SourceIP) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ClientUserName, ClientAgent, dbo.parseip (sourceip) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> clientip, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (logtime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> logtime, dbo.parseip (destinationip) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> destinationhost, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(bytessent) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> bytessent, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(bytesrecvd) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> bytesrecvd <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dbo.FirewallLog <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> (DestinationIP <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> DestinationIP <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'  TMG'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> SourceIP <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'  TMG'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> bytessent + bytesrecvd &lt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (logtime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>) &gt;= <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">day</span></span>, <span class="hljs-number"><span class="hljs-number">-5</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (logtime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>) &lt;= <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Action</span></span> &lt;&gt; <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> ClientUserName, SourceIP, DestinationIP, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (logtime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>), ClientAgent <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dbo.GetUserName (ClientUserName, ClientIP) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ClientUserName, ClientAgent, dbo.parseip (clientip) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> clientip, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (logtime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> logtime, urldesthost <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> destinationhost, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(bytesrecvd) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> bytessent, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(bytessent) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> bytesrecvd <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dbo.WebProxyLog <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> (DestHostIP <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> DestHostIP <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'  TMG'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ClientIP <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'  TMG'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> bytessent + bytesrecvd &lt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (logtime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>) &gt;= <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">day</span></span>, <span class="hljs-number"><span class="hljs-number">-5</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (logtime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>) &lt;= <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Action</span></span> &lt;&gt; <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> ClientUserName, ClientIP, UrlDestHost, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (logtime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>), ClientAgent <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dbo.FirewallLog <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (logtime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>) &gt;= <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">day</span></span>, <span class="hljs-number"><span class="hljs-number">-5</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (logtime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>) &lt;= <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dbo.WebProxyLog <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (logtime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>) &gt;= <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">day</span></span>, <span class="hljs-number"><span class="hljs-number">-5</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (logtime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>) &lt;= <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dbo.REPORT <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> logtime &lt;= <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">day</span></span>, <span class="hljs-number"><span class="hljs-number">-180</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>)</code> </pre><br><br>  Let us analyze the request in more detail, the first thing we had to deal with was the data format containing the IP address, namely the sourceip and destinationip fields.  In these fields, the data type is uniqueidentifier, and the IPv4 address is C0A89E4B-FFFF-0000-0000-000000000000.  In order to convert this string to the IPv4 address we are used to, you need to take the left side of this string to FFFF, divide it into 4 blocks of two digits each and convert from hexadecimal to decimal - C0.A8.9E.4B = 192.168.158.75.  For this purpose, the query uses the dbo.parseip function: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [TMG] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> [dbo].[parseIP] ( @ui uniqueidentifier ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">hex</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>), @t <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span> (<span class="hljs-number"><span class="hljs-number">8</span></span>), @<span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>, @n <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>, @IP <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) = <span class="hljs-string"><span class="hljs-string">''</span></span>, @i <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">hex</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">SUBSTRING</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>), @ui), <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @i &lt;<span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @t = <span class="hljs-keyword"><span class="hljs-keyword">REVERSE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUBSTRING</span></span>(@<span class="hljs-keyword"><span class="hljs-keyword">hex</span></span>, @i, <span class="hljs-number"><span class="hljs-number">2</span></span>)) <span class="hljs-comment"><span class="hljs-comment">--SELECT @t WHILE @number &lt; = LEN(@t) BEGIN SET @n = @n + case lower(SUBSTRING(@t, @number, 1)) when '0' then 0 when '1' then 1 when '2' then 2 when '3' then 3 when '4' then 4 when '5' then 5 when '6' then 6 when '7' then 7 when '8' then 8 when '9' then 9 when 'a' then 10 when 'b' then 11 when 'c' then 12 when 'd' then 13 when 'e' then 14 when 'f' then 15 end * convert( decimal( 28 , 0 ) , power( 16 , @number - 1 ) ) SET @number = @number + 1 END -- SELECT @n SET @IP = @IP + CASE WHEN LEN(@IP) &gt;0 THEN '.' ELSE '' END + CONVERT(VARCHAR(3), @n) SELECT @n = 0, @number = 1 SET @i = @i +2 END --SELECT @IP -- Return the result of the function RETURN @IP END</span></span></code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Next, the dbo.GetUserName function: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [TMG] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> [dbo].[GetUserName] (@Username <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>), @IpAddress uniqueidentifier) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> (@Username = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> @Username = <span class="hljs-string"><span class="hljs-string">'-'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> @Username = <span class="hljs-string"><span class="hljs-string">'anonymous'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> dbo.parseip (@IpAddress); RETURN @Username; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br>  There is nothing particularly interesting here, the function was used in ISA 2006, the only thing that had to be changed was the data type for @IpAddress. <br><br>  By functions in this query all, now let's look at some of the nuances of data recording. <br><br>  In the Webproxylog table, the columns bytessent and bytesrecvd mean exactly the opposite of their names, so they are inverted in the query - SUM (bytesrecvd) as bytessent, sum (bytessent) as bytesrecvd. <br>  The last thing I would like to note is the filtering of the intermediate state of the connection and zero records.  The fact is that with ‚Äúlong-lasting‚Äù connections, TMG records the intermediate amount of traffic that the connection received / transmitted, such intermediate data and are filtered using Action &lt;&gt; 11. As far as zero records are concerned, everything is quite obvious, they do not represent values ‚Äã‚Äãfor past traffic. <br>  After the execution of this request, data appears in the ‚Äúclean‚Äù table, on the basis of which reports are built in the reporting services, but about this in the second part. <br><br>  PS: Thanks to my colleagues for answering questions about SQL, and for writing the parseip procedure. </div><p>Source: <a href="https://habr.com/ru/post/188090/">https://habr.com/ru/post/188090/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../188076/index.html">Simple-Science - Simple Experiments (Digest # 26)</a></li>
<li><a href="../188080/index.html">Overview of Embedded USB Hub with ST-Lab E-110 Card Reader</a></li>
<li><a href="../188082/index.html">We study STM32 in practice. Part 1. Screen connection from Siemens C55</a></li>
<li><a href="../188086/index.html">HackPoint. The experience of self-organization of the provincial hackathon from scratch</a></li>
<li><a href="../188088/index.html">Container java-server code with the support of a permanent connection</a></li>
<li><a href="../188092/index.html">Android component from scratch</a></li>
<li><a href="../188094/index.html">Order in the photo and video archives using the technique and a pair of scripts</a></li>
<li><a href="../188096/index.html">Failover Master-Slave Cluster on PostgreSQL</a></li>
<li><a href="../188098/index.html">Relations enikeyschika and people in work</a></li>
<li><a href="../188102/index.html">Simple client and server authorization of an Ajax site user using the VKontakte API</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>