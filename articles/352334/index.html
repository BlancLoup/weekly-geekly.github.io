<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Testing Android Applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Testing is one of the most important parts of developing high-quality software products. Today we will talk about some methodologies and libraries dev...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Testing Android Applications</h1><div class="post__text post__text-html js-mediator-article"><p>  Testing is one of the most important parts of developing high-quality software products.  Today we will talk about some methodologies and libraries developed and used by our team to write tests for Android applications. </p><br><p><img src="https://habrastorage.org/webt/xb/ro/uj/xbroujtyyutzjr-8oah2cnzwbx8.png"></p><br><p>  Let's start with the most basic things, because more experienced developers can go directly to the section on tools for UI testing.  For those who want to learn or refresh basic things - enjoy reading. </p><a name="habracut"></a><br><h2 id="sozdanie-pervogo-testa">  Creation of the first test </h2><br><p>  Let's create a small component, which we will test.  It parses the file with a JSON object containing the name and returns the resulting string: </p><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NameRepository</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> File file; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NameRepository</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(File file)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.file = file; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ Gson gson = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Gson(); User user = gson.fromJson(readFile(), User.class); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> user.name; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) file.length()]; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (FileInputStream in = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInputStream(file)) { in.read(bytes); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String(bytes, Charset.defaultCharset()); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span></span>{ String name; } }</code> </pre> <br><p>  Here and in the future I will give an abbreviated version of the code.  The full version can be viewed in the <a href="https://github.com/Monnoroch/android-testing">repository</a> .  Each snippet will be accompanied by a link to the <a href="">full code</a> . </p><br><p>  Now we will write the first <a href="http://junit.org/junit4/javadoc/4.12/overview-summary.html">JUnit</a> test.  JUnit is a Java library for writing tests.  In order for JUnit to know that a method is a test, you need to add the <code>@Test</code> annotation to it.  JUnit contains the <code>Assert</code> class, which allows you to compare actual values ‚Äã‚Äãwith expected values ‚Äã‚Äãand displays an error if the values ‚Äã‚Äãdo not match.  This test will test the correctness of our component, namely, reading the file, parsing the JSON and getting the correct field: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NameRepositoryTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> File FILE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(<span class="hljs-string"><span class="hljs-string">"test_file"</span></span>); NameRepository nameRepository = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NameRepository(FILE); <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName_isSasha</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ PrintWriter writer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PrintWriter( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BufferedWriter( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OutputStreamWriter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileOutputStream(FILE), UTF_8)), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); writer.println(<span class="hljs-string"><span class="hljs-string">"{name : Sasha}"</span></span>); writer.close(); String name = nameRepository.getName(); Assert.assertEquals(name, <span class="hljs-string"><span class="hljs-string">"Sasha"</span></span>); FILE.delete(); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName_notMia</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ PrintWriter writer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PrintWriter( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BufferedWriter( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OutputStreamWriter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileOutputStream(FILE), UTF_8)), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); writer.println(<span class="hljs-string"><span class="hljs-string">"{name : Sasha}"</span></span>); writer.close(); String name = nameRepository.getName(); Assert.assertNotEquals(name, <span class="hljs-string"><span class="hljs-string">"Mia"</span></span>); FILE.delete(); } }</code> </pre><br><p>  <a href="">Full code</a> </p><br><h2 id="biblioteki-dlya-napisaniya-testov">  Test Writing Libraries </h2><br><p>  Tests are also code that must be supported.  Moreover, the test code should be easy to understand so that it can be verified in the mind.  Therefore, it makes sense to invest in simplifying the test code, getting rid of duplication and improving readability.  Let's look at the widely used libraries that will help us in this matter. </p><br><p>  In order not to duplicate the preparation code in each test, there are annotations <code>@Before</code> and <code>@After</code> .  Methods marked with <code>@Before</code> annotation will be executed before each test, and marked with <code>@After</code> annotation after each test.  There are also annotations <code>@BeforeClass</code> and <code>@AfterClass</code> , which are executed respectively before and after all the tests in the class.  Let's redo our test using these methods: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NameRepositoryTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> File FILE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(<span class="hljs-string"><span class="hljs-string">"test_file"</span></span>); NameRepository nameRepository = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NameRepository(FILE); <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ PrintWriter writer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PrintWriter( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BufferedWriter( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OutputStreamWriter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileOutputStream(FILE), UTF_8)), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); writer.println(<span class="hljs-string"><span class="hljs-string">"{name : Sasha}"</span></span>); writer.close(); } <span class="hljs-meta"><span class="hljs-meta">@After</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tearDown</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ FILE.delete(); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName_isSasha</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ String name = nameRepository.getName(); Assert.assertEquals(name, <span class="hljs-string"><span class="hljs-string">"Sasha"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName_notMia</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ String name = nameRepository.getName(); Assert.assertNotEquals(name, <span class="hljs-string"><span class="hljs-string">"Mia"</span></span>); } }</code> </pre> <br><p>  <a href="">Full code</a> </p><br><p>  We were able to remove duplication of the setup code for each test.  However, many different classes with tests may require creating a file, and I would also like to remove this duplication.  For this there is a library of test rules ( <a href="https://developer.android.com/reference/android/support/test/rule/package-summary.html">TestRule</a> ).  The test rule performs a function similar to <code>@Before</code> and <code>@After</code> .  In the apply () method of this class, we can perform the actions we need before and after the execution of each or all tests.  In addition to reducing code duplication, the advantage of such a method is that the code is removed from the class of tests, which reduces the amount of code in the test and makes it easier to read.  Let's write a rule to create a file: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreateFileRule</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestRule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> File file; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String text; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateFileRule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(File file, String text)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.file = file; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.text = text; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Statement </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Statement s, Description d)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Statement() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">evaluate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Throwable </span></span>{ PrintWriter writer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PrintWriter( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BufferedWriter( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OutputStreamWriter( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileOutputStream(FILE), UTF_8)), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); writer.println(text); writer.close(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { s.evaluate(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { file.delete(); } } }; } }</code> </pre> <br><p>  <a href="">Full code</a> </p><br><p>  We use this rule in our test.  In order for the <code>TestRule</code> actions to <code>TestRule</code> performed for each test, you must mark the <code>TestRule</code> annotation. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NameRepositoryTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> File FILE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(<span class="hljs-string"><span class="hljs-string">"test_file"</span></span>); <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> CreateFileRule fileRule = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreateFileRule(FILE, <span class="hljs-string"><span class="hljs-string">"{name : Sasha}"</span></span>); NameRepository nameRepository = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NameRepository(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileReader(FILE)); <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName_isSasha</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ String name = nameRepository.getName(); Assert.assertEquals(name, <span class="hljs-string"><span class="hljs-string">"Sasha"</span></span>); } ... }</code> </pre><br><p>  <a href="">Full code</a> </p><br><p>  If the rule is marked with the <code>@ClassRule</code> annotation, then the actions will not be invoked before each test, but once before all the tests in the class, similar to the annotations <code>@BeforeClass</code> and <code>@AfterClass</code> . </p><br><p>  When several <code>TestRule</code> are used in tests, it may be necessary to start them in a specific order, for this there is a <a href="http://junit.org/junit4/javadoc/4.12/org/junit/rules/RuleChain.html">RuleChain</a> with which you can determine the order in which our <code>TestRule</code> .  Create a rule that should create a folder before the file is created: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreateDirRule</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestRule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> File dir; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateDirRule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(File dir)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dir = dir; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Statement </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Statement s, Description d)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Statement() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">evaluate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Throwable </span></span>{ dir.mkdir(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { s.evaluate(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { dir.delete(); } } }; } }</code> </pre> <br><p>  <a href="">Full code</a> </p><br><p>  With this rule, the class with the dough will look like this: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NameRepositoryTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> File DIR = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(<span class="hljs-string"><span class="hljs-string">"test_dir"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> File FILE = Paths.get(DIR.toString(), <span class="hljs-string"><span class="hljs-string">"test_file"</span></span>).toFile(); <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> RuleChain chain = RuleChain .outerRule(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreateDirRule(DIR)) .around(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreateFileRule(FILE, <span class="hljs-string"><span class="hljs-string">"{name : Sasha}"</span></span>)); <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName_isSasha</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ String name = nameRepository.getName(); Assert.assertEquals(name, <span class="hljs-string"><span class="hljs-string">"Sasha"</span></span>); } ... }</code> </pre> <br><p>  <a href="">Full code</a> </p><br><p>  Now in each test the directory will be created before creating the file and deleted after deleting the file. </p><br><p>  <a href="https://github.com/google/truth">Google Truth</a> is a library for improving the readability of test code.  Contains assert methods (similar to <a href="http://junit.sourceforge.net/javadoc/org/junit/Assert.html">JUnit Assert</a> ), but more readable for humans, and also includes many more options for checking parameters.  This is the previous test using Truth: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName_isSasha</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ String name = nameRepository.getName(); assertThat(name).isEqualTo(<span class="hljs-string"><span class="hljs-string">"Sasha"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName_notMia</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ String name = nameRepository.getName(); assertThat(name).isNotEqualTo(<span class="hljs-string"><span class="hljs-string">"Mia"</span></span>); }</code> </pre> <br><p>  <a href="">Full code</a> </p><br><p>  It can be seen that the code reads almost like text in spoken English. </p><br><p>  Our component does two different jobs: it reads a file and parses it.  To adhere to the principle of sole responsibility, let's separate the logic of reading a file into a separate component: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FileReader</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> File file; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FileReader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(File file)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.file = file; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) file.length()]; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (FileInputStream in = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInputStream(file)) { in.read(bytes); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String(bytes, Charset.defaultCharset()); } }</code> </pre> <br><p>  <a href="">Full code</a> </p><br><p>  Now we want to test <code>NameRepository</code> , and in fact we are testing and reading the file in <code>FileReader</code> .  To avoid this and thereby increase the isolation, reliability and speed of the test, we can replace the real <code>FileReader</code> with his MoK. </p><br><p>  <a href="http://site.mockito.org/">Mockito</a> is a library for creating stubs (mocks) instead of real objects for use in tests.  Some actions that can be performed using the Mockito: <br>  create stubs for classes and interfaces; <br>  check method calls and values ‚Äã‚Äãpassed to this method; <br>  connecting to a real spy object ‚Äúspy‚Äù to control call methods. </p><br><p>  Create a <code>FileReader</code> mock and configure it so that the <code>readFile()</code> method returns the string we need: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NameRepositoryTest</span></span></span><span class="hljs-class"> </span></span>{ FileReader fileReader = mock(FileReader.class); NameRepository nameRepository = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NameRepository(fileReader); <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ when(fileReader.readFile()).thenReturn(<span class="hljs-string"><span class="hljs-string">"{name : Sasha}"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName_isSasha</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ String name = nameRepository.getName(); assertThat(name).isEqualTo(<span class="hljs-string"><span class="hljs-string">"Sasha"</span></span>); } }</code> </pre> <br><p>  <a href="">Full code</a> </p><br><p>  Now there is no file reading.  Instead, the mock returns the value set in the test. </p><br><p>  The use of mocks has its advantages: </p><br><ul><li>  tests only check the class under test for errors, errors of other classes do not affect the test of the class under test </li><li>  sometimes shorter and more readable code </li><li>  it is possible to check method calls and values ‚Äã‚Äãpassed to the mocked object methods </li></ul><br><p>  and disadvantages: </p><br><ul><li>  By default, unconfigured methods return null, because all methods used must be configured explicitly. </li><li>  if a real object has a state, then at each of its intended changes it is necessary to reconfigure its moke, which is why the test code sometimes swells. </li></ul><br><p>  There is an easier and more convenient way to create mocks - use the <code>@Mock</code> special annotation: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Mock</span></span> File file;</code> </pre> <br><p>  There are three ways to initialize such mocks: </p><br><ul><li>  Call <a href="https://static.javadoc.io/org.mockito/mockito-core/2.2.28/org/mockito/MockitoAnnotations.html">MockitoAnnotations.initMocks ()</a> : </li></ul><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ MockitoAnnotations.initMocks(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); }</code> </pre> <br><ul><li>  Use <a href="https://static.javadoc.io/org.mockito/mockito-core/2.2.28/org/mockito/junit/MockitoJUnitRunner.html">MockitoJUnitRunner</a> to run tests: </li></ul><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(MockitoJUnitRunner.class)</code> </pre> <br><ul><li>  Add a <a href="https://static.javadoc.io/org.mockito/mockito-core/2.6.5/org/mockito/junit/MockitoRule.html">MockitoRule</a> rule to the test: </li></ul><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MockitoRule rule = MockitoJUnit.rule();</code> </pre> <br><p>  The second option is maximally declarative and compact, but requires the use of a special test runner, which is not always convenient.  The latter option lacks this drawback and is more declarative than using the <code>initMocks()</code> method. </p><br><div class="spoiler">  <b class="spoiler_title">MockitoJUnitRunner usage example</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(MockitoJUnitRunner.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NameRepositoryTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Mock</span></span> FileReader fileReader; NameRepository nameRepository; <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ when(fileReader.readFile()).thenReturn(<span class="hljs-string"><span class="hljs-string">"{name : Sasha}"</span></span>); nameRepository = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NameRepository(fileReader); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName_isSasha</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ String name = nameRepository.getName(); assertThat(name).isEqualTo(<span class="hljs-string"><span class="hljs-string">"Sasha"</span></span>); } }</code> </pre> <br><p>  <a href="">Full code</a> </p></div></div><br><h2 id="host-java-vm-vs-android-java-vm">  Host Java VM vs Android Java VM </h2><br><p>  Android tests can be divided into two types: those that can be run on a regular Java VM, and those that need to be run on an Android Java VM.  Let's look at both types of tests. </p><br><h3 id="testy-zapuskaemye-na-obychnoy-java-vm">  Tests run on a regular Java VM </h3><br><p>  Tests for code that does not require the operation of Android API components, for which you need an Android emulator or a real device, can be run directly on your computer and on any Java machine.  These are mostly business logic unit tests that test a single class in isolation.  The integration tests are much less often written, since it is not always possible to create real class objects with which the tested class interacts. </p><br><p>  To write a class with Host Java tests, you need the java file to have the path <code>${moduleName}/src/test/java/...</code>  Also using <code>@RunWith</code> annotations to specify <code>Runner</code> , which is responsible for running the tests, the correct call and handling of all methods: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(MockitoJUnitRunner.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestClass</span></span></span><span class="hljs-class"> </span></span>{...}</code> </pre> <br><p>  Using these tests has many advantages: </p><br><ul><li>  do not require the launch of an emulator or a real device, this is especially important when passing tests in <a href="https://en.wikipedia.org/wiki/Continuous_integration">Continuous integration</a> , where the emulator can work very slowly and there is no real device </li><li>  they pass very quickly, because you do not need to start the application, display the UI, etc. </li><li>  are stable, since there are no problems connected with the fact that the emulator may hang, etc. </li></ul><br><p>  on the other hand, these tests: </p><br><ul><li>  cannot fully test the interaction of classes with the operating system </li><li>  in particular, you cannot test pressing UI elements and gestures </li></ul><br><p>  In order to be able to use the Android API classes in the Host Java tests, there is a <a href="http://robolectric.org/getting-started/">Robolectric</a> library that emulates the Android environment and gives access to its main functions.  However, testing Android classes with Roboelectric is often unstable: it takes time while Robolectric supports the latest Android API, there are problems with getting resources, etc.  Therefore, real classes are almost not used, and their mocks are used for unit testing. </p><br><p>  To run tests using Roboelectric, you need to install a custom <a href="http://junit.sourceforge.net/junit3.8.1/javadoc/junit/textui/TestRunner.html">TestRunner</a> .  In it, you can configure the SDK version (the most recent stable version is 23), designate the main class <code>Application</code> and other parameters for the emulated Android environment. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainApplication</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application</span></span></span><span class="hljs-class"> </span></span>{}</code> </pre> <br><p>  <a href="">Full code</a> </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(RobolectricTestRunner.class) <span class="hljs-meta"><span class="hljs-meta">@Config</span></span>(sdk = <span class="hljs-number"><span class="hljs-number">21</span></span>, application = MainApplication.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainApplicationTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">packageName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ assertThat(RuntimeEnvironment.application) .isInstanceOf(MainApplication.class); } }</code> </pre><br><p>  <a href="">Full code</a> </p><br><h3 id="testy-zapuskaemye-na-android-java-vm">  Tests run on Android Java VM </h3><br><p>  For instrumental tests, the presence of a device or emulator is mandatory, since we will test button presses, text input, and other actions. </p><br><p>  To write a test for an Android Java VM, you need to put a java file along the path <code>${moduleName}/src/androidTest/java/...</code> , as well as using <code>@RunWith</code> annotations to specify <code>AndroidJUnit4</code> , which will allow you to run tests on an Android device. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(AndroidJUnit4.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestClass</span></span></span><span class="hljs-class"> </span></span>{...}</code> </pre> <br><h2 id="ui-testy">  UI tests </h2><br><p>  For testing the UI, the <a href="https://developer.android.com/training/testing/ui-testing/espresso-testing.html">Espresso</a> framework is used, which provides an API for testing the user interface of the program.  In Espresso, tests run in the background thread and interact with UI elements in the UI thread.  Espresso has several basic classes for testing: </p><br><ul><li>  Espresso - the main class.  It contains static methods, such as pressing the system buttons (Back, Home), call / hide the keyboard, open the menu, turn to the component. </li><li>  ViewMatchers - allows you to find a component on the screen in the current hierarchy. </li><li>  ViewActions - allows you to interact with the component (click, longClick, doubleClick, swipe, scroll, etc.). </li><li>  ViewAssertions - allows you to check the status of the component. </li></ul><br><h3 id="pervyy-ui-test">  First ui test </h3><br><p>  Let's write the simplest Android application, which we will test: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppCompatActivity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setContentView(R.layout.main_activity); } }</code> </pre> <br><p>  <a href="">Full code</a> </p><br><p>  We are testing our application.  When testing the UI, you first need to start the Activity.  For this, there is an <a href="https://developer.android.com/reference/android/support/test/rule/ActivityTestRule.html">ActivityTestRule</a> that launches an Activity before each test and closes after: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ActivityTestRule&lt;MainActivity&gt; activityTestRule = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActivityTestRule&lt;&gt;(MainActivity.class);</code> </pre> <br><p>  Let's write a simple test that checks that the element with id <code>R.id.container</code> shown on the screen: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(AndroidJUnit4.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivityTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ActivityTestRule&lt;MainActivity&gt; activityTestRule = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActivityTestRule&lt;&gt;(MainActivity.class); <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkContainerIsDisplayed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ onView(ViewMatchers.withId(R.id.container)) .check(matches(isDisplayed())); } }</code> </pre> <br><p>  <a href="">Full code</a> </p><br><h2 id="razblokirovka-i-vklyuchenie-ekrana">  Unlocking and turning on the screen </h2><br><p>  Emulator on weak or loaded machines may be slow.  Therefore, between the launch of the emulator and the end of the build with the installation of the application on the emulator, it may take enough time for the screen to be blocked from inactivity.  Thus, the test can be run when the screen is locked, causing a <code>java.lang.RuntimeException: Could not launch activity within 45 seconds</code> error <code>java.lang.RuntimeException: Could not launch activity within 45 seconds</code> .  Therefore, before launching the Activity, you need to unlock and turn on the screen.  Once this needs to be done in each UI test, to avoid duplication of the code, we will create a rule that will unlock and turn on the screen before the test: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UnlockScreenRule</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppCompatActivity</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestRule</span></span></span><span class="hljs-class"> </span></span>{ ActivityTestRule&lt;A&gt; activityRule; UnlockScreenRule(ActivityTestRule&lt;A&gt; activityRule) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.activityRule = activityRule; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Statement </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Statement statement, Description description)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Statement() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">evaluate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Throwable </span></span>{ activityRule.runOnUiThread(() -&gt; activityRule .getActivity() .getWindow() .addFlags( WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED | WindowManager.LayoutParams.FLAG_DISMISS_KEYGUARD | WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON | WindowManager.LayoutParams.FLAG_TURN_SCREEN_ON | WindowManager.LayoutParams.FLAG_ALLOW_LOCK_WHILE_SCREEN_ON)); statement.evaluate(); } }; } }</code> </pre> <br><p>  <a href="">Full code</a> </p><br><p>  Let's write a custom <code>ActivityTestRule</code> that unlocks the emulator screen and starts activating before running the tests: </p><br><div class="spoiler">  <b class="spoiler_title">ActivityTestRule</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ActivityTestRule</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppCompatActivity</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestRule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> android.support.test.rule.ActivityTestRule&lt;A&gt; activityRule; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> RuleChain ruleChain; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ActivityTestRule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Class&lt;A&gt; activityClass)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.activityRule = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActivityTestRule&lt;&gt;(activityClass, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); ruleChain = RuleChain .outerRule(activityRule) .around(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UnlockScreenRule(activityRule)); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> android.support.test.rule.<span class="hljs-function"><span class="hljs-function">ActivityTestRule&lt;A&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getActivityRule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> activityRule; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runOnUiThread</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Runnable runnable)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Throwable </span></span>{ activityRule.runOnUiThread(runnable); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> A </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getActivity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> activityRule.getActivity(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Statement </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Statement statement, Description description)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ruleChain.apply(statement, description); } }</code> </pre> <br><p>  <a href="">Full code</a> </p></div></div><br><p>  Using this rule instead of the standard one can greatly reduce the number of random drops in UI tests in CI. </p><br><h2 id="testirovanie-fragmentov">  Fragment Testing </h2><br><p>  Typically, the layout and logic of the UI application is not put all in the activit, but is divided into windows, for each of which a fragment is created.  Let's create a simple snippet to display the name using the <code>NameRepository</code> : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserFragment</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Fragment</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TextView textView; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> View </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreateView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ textView = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TextView(getActivity()); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { textView.setText(createNameRepository().getName()); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException exception) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(exception); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> textView; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> NameRepository </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createNameRepository</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NameRepository( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileReader( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File( getContext().getFilesDir().getAbsoluteFile() + File.separator + <span class="hljs-string"><span class="hljs-string">"test_file"</span></span>))); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDestroyView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onDestroyView(); textView = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }</code> </pre> <br><p>  <a href="">Full code</a> </p><br><p>  When opening a fragment, the UI may freeze for a while, and if animations of transitions between fragments are used, the test may begin before the fragment appears.  Therefore, you need not just to open the fragment, but to wait until it is launched.  The <a href="https://github.com/awaitility/awaitility">Awaitility</a> library, which has a very simple and clear syntax, is excellent for waiting for the result of actions.  Let us write a rule that starts a fragment and waits to start it using this library: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OpenFragmentRule</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppCompatActivity</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestRule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ActivityTestRule&lt;A&gt; activityRule; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Fragment fragment; OpenFragmentRule(ActivityTestRule&lt;A&gt; activityRule, Fragment fragment) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.activityRule = activityRule; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fragment = fragment; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Statement </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Statement statement, Description description)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Statement() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">evaluate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Throwable </span></span>{ openFragment(fragment); await().atMost(<span class="hljs-number"><span class="hljs-number">5</span></span>, SECONDS).until(fragment::isResumed); statement.evaluate(); } }; } }</code> </pre> <br><p>  <a href="">Full code</a> </p><br><p>  In this case, the expression means that if the fragment does not start within five seconds, the test will not be passed.  It should be noted that as soon as the fragment starts, the test will immediately continue execution and will not wait all five seconds. </p><br><p>  Similar to the rule that triggers activations, it is logical to create a rule that triggers a fragment: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FragmentTestRule</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppCompatActivity</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">F</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Fragment</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestRule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ActivityTestRule&lt;A&gt; activityRule; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> F fragment; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> RuleChain ruleChain; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FragmentTestRule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Class&lt;A&gt; activityClass, F fragment)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fragment = fragment; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.activityRule = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActivityTestRule&lt;&gt;(activityClass); ruleChain = RuleChain .outerRule(activityRule) .around(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OpenFragmentRule&lt;&gt;(activityRule, fragment)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActivityTestRule&lt;A&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getActivityRule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> activityRule; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> F </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFragment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fragment; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runOnUiThread</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Runnable runnable)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Throwable </span></span>{ activityRule.runOnUiThread(runnable); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> A </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getActivity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> activityRule.getActivity(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Statement </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Statement statement, Description description)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ruleChain.apply(statement, description); } }</code> </pre> <br><p>  <a href="">Full code</a> </p><br><p>  A fragment test using this rule will look like this: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(AndroidJUnit4.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserFragmentTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> RuleChain rules = RuleChain .outerRule(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreateFileRule(getTestFile(), <span class="hljs-string"><span class="hljs-string">"{name : Sasha}"</span></span>)) .around(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FragmentTestRule&lt;&gt;(MainActivity.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserFragment())); <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nameDisplayed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ onView(withText(<span class="hljs-string"><span class="hljs-string">"Sasha"</span></span>)).check(matches(isDisplayed())); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> File </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTestFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File( InstrumentationRegistry.getTargetContext() .getFilesDir() .getAbsoluteFile() + File.separator + <span class="hljs-string"><span class="hljs-string">"test_file"</span></span>); } }</code> </pre> <br><p>  <a href="">Full code</a> </p><br><h2 id="asinhronnaya-zagruzka-dannyh-vo-fragmentah">  Asynchronous data loading in fragments </h2><br><p>  Since disk operations, namely, retrieving a name from a file, can take a relatively long time, this operation should be performed asynchronously.  For asynchronous retrieval of the name from the file, use the <a href="https://github.com/ReactiveX/RxJava">RxJava</a> library.  You can confidently say that RxJava is now used in most Android applications.  Virtually every task that needs to be performed asynchronously is performed using RxJava, because this is probably one of the most convenient and understandable libraries for asynchronous code execution. </p><br><p>  Let's change our repository so that it works asynchronously: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NameRepository</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Single&lt;String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Single.create( emitter -&gt; { Gson gson = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Gson(); emitter.onSuccess( gson.fromJson(fileReader.readFile(), User.class).getName()); }); } }</code> </pre> <br><p>  <a href="">Full code</a> </p><br><p>  To test the RX code, there is a special class <code>TestObserver</code> , which automatically subscribes to <code>Observable</code> and instantly gets the result.  The test repository will look like this: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(MockitoJUnitRunner.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NameRepositoryTest</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ TestObserver&lt;String&gt; observer = nameRepository.getName().test(); observer.assertValue(<span class="hljs-string"><span class="hljs-string">"Sasha"</span></span>); } }</code> </pre> <br><p>  <a href="">Full code</a> </p><br><p>  Update our snippet using the new reactive repository: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserFragment</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Fragment</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> View </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreateView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ textView = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TextView(getActivity()); createNameRepository() .getName() .subscribeOn(Schedulers.io()) .observeOn(AndroidSchedulers.mainThread()) .subscribe(name -&gt; textView.setText(name)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> textView; } }</code> </pre> <br><p> <a href=""> </a> </p><br><p>      ,             Awaitility: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(AndroidJUnit4.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserFragmentTest</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nameDisplayed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ await() .atMost(<span class="hljs-number"><span class="hljs-number">5</span></span>, SECONDS) .ignoreExceptions() .untilAsserted( () -&gt; onView(ViewMatchers.withText(<span class="hljs-string"><span class="hljs-string">"Sasha"</span></span>)) .check(matches(isDisplayed()))); } }</code> </pre><br><p> <a href=""> </a> </p><br><p>        ,    ‚Äî    ,   ,        ,    .      ,           ,  <code>textView</code>      <code>null</code> .       <code>NullPointerException</code>    <code>textView</code>  <code>subscribe()</code> ,      : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserFragment</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Fragment</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TextView textView; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Disposable disposable; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> View </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreateView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ textView = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TextView(getActivity()); disposable = createNameRepository() .getName() .subscribeOn(Schedulers.io()) .observeOn(AndroidSchedulers.mainThread()) .subscribe(name -&gt; textView.setText(name)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> textView; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDestroyView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onDestroyView(); disposable.dispose(); textView = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }</code> </pre> <br><p> <a href=""> </a> </p><br><p>    ,      ,        .         .      <code>onCreateView</code>    <code>textView</code>  <code>null</code>        ,  .       : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FragmentAsyncTestRule</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppCompatActivity</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestRule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ActivityTestRule&lt;A&gt; activityRule; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Fragment fragment; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FragmentAsyncTestRule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Class&lt;A&gt; activityClass, Fragment fragment)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.activityRule = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActivityTestRule&lt;&gt;(activityClass); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fragment = fragment; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Statement </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Statement base, Description description)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Statement() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">evaluate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Throwable </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { base.evaluate(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { activityRule.launchActivity(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent()); openFragment(fragment); openFragment(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Fragment()); } } }; } }</code> </pre> <br><p> <a href=""> </a> </p><br><p>       : </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(AndroidJUnit4.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserFragmentTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@ClassRule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> TestRule asyncRule = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FragmentAsyncTestRule&lt;&gt;(MainActivity.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserFragment()); ... }</code> </pre> <br><p> <a href=""> </a> </p><br><p>   ,           . </p><br><h2 id="yunit-testirovanie-rx-koda"> - Rx  </h2><br><p>  ,         <code>Observable</code>  ,    <code>timeout</code>     : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserPresenter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Listener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUserNameLoaded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onGettingUserNameError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String message)</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Listener listener; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> NameRepository nameRepository; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UserPresenter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Listener listener, NameRepository nameRepository)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listener = listener; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.nameRepository = nameRepository; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ nameRepository .getName() .timeout(<span class="hljs-number"><span class="hljs-number">2</span></span>, SECONDS) .subscribeOn(Schedulers.io()) .observeOn(AndroidSchedulers.mainThread()) .subscribe( listener::onUserNameLoaded, error -&gt; listener.onGettingUserNameError(error.getMessage())); } }</code> </pre> <br><p> <a href=""> </a> </p><br><p>            ,    .     : </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(RobolectricTestRunner.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserPresenterTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MockitoRule rule = MockitoJUnit.rule(); <span class="hljs-meta"><span class="hljs-meta">@Mock</span></span> UserPresenter.Listener listener; <span class="hljs-meta"><span class="hljs-meta">@Mock</span></span> NameRepository nameRepository; UserPresenter presenter; <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ when(nameRepository.getName()).thenReturn(Observable.just(<span class="hljs-string"><span class="hljs-string">"Sasha"</span></span>)); presenter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserPresenter(listener, nameRepository); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ presenter.getUserName(); verifyNoMoreInteractions(listener); } }</code> </pre> <br><p> <a href=""> </a> </p><br><p>          <code>listener</code> ,     ,    .     Awaitility   .  -        ,        RxJava <code>Schedulers</code>  .    <a href="http://reactivex.io/RxJava/javadoc/io/reactivex/schedulers/TestScheduler.html">TestScheduler</a> ,     ,        <code>Observable</code> ,     .  ,    : </p><br><div class="spoiler"> <b class="spoiler_title">RxImmediateSchedulerRule</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RxImmediateSchedulerRule</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestRule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> TestScheduler TEST_SCHEDULER = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestScheduler(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Scheduler IMMEDIATE_SCHEDULER = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scheduler() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Disposable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scheduleDirect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Runnable run, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> delay, TimeUnit unit)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.scheduleDirect(run, <span class="hljs-number"><span class="hljs-number">0</span></span>, unit); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Worker </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createWorker</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExecutorScheduler.ExecutorWorker(Runnable::run); } }; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Statement </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Statement base, Description description)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Statement() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">evaluate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Throwable </span></span>{ RxJavaPlugins.setIoSchedulerHandler(scheduler -&gt; TEST_SCHEDULER); RxJavaPlugins.setComputationSchedulerHandler( scheduler -&gt; TEST_SCHEDULER); RxJavaPlugins.setNewThreadSchedulerHandler( scheduler -&gt; TEST_SCHEDULER); RxAndroidPlugins.setMainThreadSchedulerHandler( scheduler -&gt; IMMEDIATE_SCHEDULER); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { base.evaluate(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { RxJavaPlugins.reset(); RxAndroidPlugins.reset(); } } }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> TestScheduler </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTestScheduler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> TEST_SCHEDULER; } }</code> </pre> <br><p> <a href=""> </a> </p></div></div><br><p>         : </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(RobolectricTestRunner.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserPresenterTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TIMEOUT_SEC = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String NAME = <span class="hljs-string"><span class="hljs-string">"Sasha"</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MockitoRule rule = MockitoJUnit.rule(); <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> RxImmediateSchedulerRule timeoutRule = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RxImmediateSchedulerRule(); <span class="hljs-meta"><span class="hljs-meta">@Mock</span></span> UserPresenter.Listener listener; <span class="hljs-meta"><span class="hljs-meta">@Mock</span></span> NameRepository nameRepository; PublishSubject&lt;String&gt; nameObservable = PublishSubject.create(); UserPresenter presenter; <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ when(nameRepository.getName()).thenReturn(nameObservable.firstOrError()); presenter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserPresenter(listener, nameRepository); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ presenter.getUserName(); timeoutRule.getTestScheduler().advanceTimeBy(TIMEOUT_SEC - <span class="hljs-number"><span class="hljs-number">1</span></span>, SECONDS); nameObservable.onNext(NAME); verify(listener).onUserNameLoaded(NAME); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserName_timeout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ presenter.getUserName(); timeoutRule.getTestScheduler().advanceTimeBy(TIMEOUT_SEC + <span class="hljs-number"><span class="hljs-number">1</span></span>, SECONDS); nameObservable.onNext(NAME); verify(listener).onGettingUserNameError(any()); } }</code> </pre> <br><p> <a href=""> </a> </p><br><h2 id="testirovanie-koda-ispolzuyuschego-dagger-2">  ,  Dagger 2 </h2><br><p>           <strong>Dependency Injection</strong> . <a href="https://google.github.io/dagger/">Dagger 2</a> ‚Äî  ,      .     Android       Dagger.          ,    ,   ,  . </p><br><p>   ,      Dagger  <code>ApplicationComponent</code> ,      ,      <code>Application</code> , ,   ,      . </p><br><div class="spoiler"> <b class="spoiler_title">ApplicationComponent</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-meta"><span class="hljs-meta">@Component</span></span>(modules = {ContextModule.class}) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">UserComponent </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createUserComponent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br><p> <a href=""> </a> </p></div></div><br><div class="spoiler"> <b class="spoiler_title">MainApplication</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainApplication</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ApplicationComponent component; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(); component = DaggerApplicationComponent.builder() .contextModule(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ContextModule(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)) .build(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ApplicationComponent </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getComponent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> component; } }</code> </pre> <br><p> <a href=""> </a> </p></div></div><br><p>   Dagger ,    : </p><br><div class="spoiler"> <b class="spoiler_title">UserModule</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Module</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserModule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-function"><span class="hljs-function">NameRepository </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideNameRepository</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Private FileReader fileReader)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NameRepository(fileReader); } <span class="hljs-meta"><span class="hljs-meta">@Private</span></span> <span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-function"><span class="hljs-function">FileReader </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideFileReader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Private File file)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileReader(file); } <span class="hljs-meta"><span class="hljs-meta">@Private</span></span> <span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-function"><span class="hljs-function">File </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(context.getFilesDir().getAbsoluteFile() + File.separator + <span class="hljs-string"><span class="hljs-string">"test_file"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Qualifier</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention</span></span>(RetentionPolicy.RUNTIME) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> Private {} }</code> </pre> <br><p> <a href=""> </a> </p></div></div><br><p>    ,      Dagger: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserFragment</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Fragment</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> NameRepository nameRepository; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> View </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreateView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ ((MainApplication) getActivity().getApplication()) .getComponent() .createUserComponent() .injectsUserFragment(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); textView = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TextView(getActivity()); disposable = nameRepository .getName() .subscribeOn(Schedulers.io()) .observeOn(AndroidSchedulers.mainThread()) .subscribe(name -&gt; textView.setText(name)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> textView; } }</code> </pre> <br><p> <a href=""> </a> </p><br><p>    UI    unit-   .       Dagger,   <code>ApplicationComponent</code>      .           <code>Application</code> : </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setComponentForTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ApplicationComponent component)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.component = component; }</code> </pre> <br><p> <a href=""> </a> </p><br><p>          ,    : </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestDaggerComponentRule</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppCompatActivity</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestRule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ActivityTestRule&lt;A&gt; activityRule; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ApplicationComponent component; TestDaggerComponentRule( ActivityTestRule&lt;A&gt; activityRule, ApplicationComponent component) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.activityRule = activityRule; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.component = component; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Statement </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Statement statement, Description description)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Statement() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">evaluate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Throwable </span></span>{ MainApplication application = ((MainApplication) activityRule.getActivity().getApplication()); ApplicationComponent originalComponent = application.getComponent(); application.setComponentForTest(component); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { statement.evaluate(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { application.setComponentForTest(originalComponent); } } }; } }</code> </pre> <br><p> <a href=""> </a> </p><br><p> ,       ,   Application              .   ,          .      ,  ,        Dagger ,   . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FragmentTestRule</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppCompatActivity</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">F</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Fragment</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestRule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ActivityTestRule&lt;A&gt; activityRule; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> F fragment; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> RuleChain ruleChain; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FragmentTestRule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( Class&lt;A&gt; activityClass, F fragment, ApplicationComponent component)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fragment = fragment; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.activityRule = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActivityTestRule&lt;&gt;(activityClass); ruleChain = RuleChain .outerRule(activityRule) .around(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestDaggerComponentRule&lt;&gt;(activityRule, component)) .around(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OpenFragmentRule&lt;&gt;(activityRule, fragment)); } ... }</code> </pre> <br><p> <a href=""> </a> </p><br><p>       : </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(AndroidJUnit4.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserFragmentTest</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> FragmentTestRule&lt;MainActivity, UserFragment&gt; fragmentRule = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FragmentTestRule&lt;&gt;( MainActivity.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserFragment(), createTestApplicationComponent()); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> ApplicationComponent </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createTestApplicationComponent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ApplicationComponent component = mock(ApplicationComponent.class); when(component.createUserComponent()) .thenReturn(DaggerUserFragmentTest_TestUserComponent.create()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> component; } <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-meta"><span class="hljs-meta">@Component</span></span>(modules = {TestUserModule.class}) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestUserComponent</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserComponent</span></span></span><span class="hljs-class"> </span></span>{} <span class="hljs-meta"><span class="hljs-meta">@Module</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestUserModule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> NameRepository </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideNameRepository</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ NameRepository nameRepository = mock(NameRepository.class); when(nameRepository.getName()).thenReturn( Single.fromCallable(() -&gt; <span class="hljs-string"><span class="hljs-string">"Sasha"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> nameRepository; } } }</code> </pre> <br><p> <a href=""> </a> </p><br><h2 id="testy-zapuskaemye-tolko-dlya-debug-prilozheniya">     Debug  </h2><br><p> ,       UI,                 debug.    ,   debug       ,      : </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserPresenter</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ nameRepository .getName() .timeout(TIMEOUT_SEC, SECONDS) .subscribeOn(Schedulers.io()) .observeOn(AndroidSchedulers.mainThread()) .subscribe( name -&gt; { listener.onUserNameLoaded(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (BuildConfig.DEBUG) { logger.info(String.format(<span class="hljs-string"><span class="hljs-string">"Name loaded: %s"</span></span>, name)); } }, error -&gt; listener.onGettingUserNameError(error.getMessage())); } }</code> </pre> <br><p> <a href=""> </a> </p><br><p>     ,          .   <code>DebugTestRule</code> ,             : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DebugRule</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestRule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Statement </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Statement base, Description description)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Statement() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">evaluate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Throwable </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (BuildConfig.DEBUG) { base.evaluate(); } } }; } }</code> </pre> <br><p> <a href=""> </a> </p><br><p>        : </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserPresenterDebugTest</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DebugTestsRule debugRule = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DebugTestsRule(); <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userNameLogged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ presenter.getUserName(); timeoutRule.getTestScheduler().triggerActions(); nameObservable.onNext(NAME); verify(logger).info(contains(NAME)); } }</code> </pre> <br><p> <a href=""> </a> </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>               ,   <a href="https://developer.android.com/reference/android/support/test/rule/package-summary.html">TestRule</a>         ,    , ,     .       ,         . </p><br><div class="spoiler"> <b class="spoiler_title">    </b> <div class="spoiler_text"><p>     ,      . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NameRepository</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> FileReader fileReader; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NameRepository</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FileReader fileReader)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fileReader = fileReader; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Single&lt;String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Single.create( emitter -&gt; { Gson gson = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Gson(); emitter.onSuccess( gson.fromJson(fileReader.readFile(), User.class).name); }); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span></span>{ String name; } }</code> </pre> <br><p> <a href=""> </a> </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(MockitoJUnitRunner.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NameRepositoryTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Mock</span></span> FileReader fileReader; NameRepository nameRepository; <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ when(fileReader.readFile()).thenReturn(<span class="hljs-string"><span class="hljs-string">"{name : Sasha}"</span></span>); nameRepository = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NameRepository(fileReader); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ TestObserver&lt;String&gt; observer = nameRepository.getName().test(); observer.assertValue(<span class="hljs-string"><span class="hljs-string">"Sasha"</span></span>); } }</code> </pre> <br><p> <a href=""> </a> </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserPresenter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Listener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUserNameLoaded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onGettingUserNameError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String message)</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Listener listener; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> NameRepository nameRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger logger; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Disposable disposable; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UserPresenter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( Listener listener, NameRepository nameRepository, Logger logger)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listener = listener; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.nameRepository = nameRepository; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger = logger; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ disposable = nameRepository .getName() .timeout(<span class="hljs-number"><span class="hljs-number">2</span></span>, SECONDS) .subscribeOn(Schedulers.io()) .observeOn(AndroidSchedulers.mainThread()) .subscribe( name -&gt; { listener.onUserNameLoaded(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (BuildConfig.DEBUG) { logger.info(String.format(<span class="hljs-string"><span class="hljs-string">"Name loaded: %s"</span></span>, name)); } }, error -&gt; listener.onGettingUserNameError(error.getMessage())); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stopLoading</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ disposable.dispose(); } }</code> </pre> <br><p> <a href=""> </a> </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(RobolectricTestRunner.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserPresenterTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TIMEOUT_SEC = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String NAME = <span class="hljs-string"><span class="hljs-string">"Sasha"</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MockitoRule rule = MockitoJUnit.rule(); <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> RxImmediateSchedulerRule timeoutRule = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RxImmediateSchedulerRule(); <span class="hljs-meta"><span class="hljs-meta">@Mock</span></span> UserPresenter.Listener listener; <span class="hljs-meta"><span class="hljs-meta">@Mock</span></span> NameRepository nameRepository; <span class="hljs-meta"><span class="hljs-meta">@Mock</span></span> Logger logger; PublishSubject&lt;String&gt; nameObservable = PublishSubject.create(); UserPresenter presenter; <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ when(nameRepository.getName()).thenReturn(nameObservable.firstOrError()); presenter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserPresenter(listener, nameRepository, logger); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ presenter.getUserName(); timeoutRule.getTestScheduler().advanceTimeBy(TIMEOUT_SEC - <span class="hljs-number"><span class="hljs-number">1</span></span>, SECONDS); nameObservable.onNext(NAME); verify(listener).onUserNameLoaded(NAME); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserName_timeout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ presenter.getUserName(); timeoutRule.getTestScheduler().advanceTimeBy(TIMEOUT_SEC + <span class="hljs-number"><span class="hljs-number">1</span></span>, SECONDS); nameObservable.onNext(NAME); verify(listener).onGettingUserNameError(any()); } }</code> </pre> <br><p> <a href=""> </a> </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(RobolectricTestRunner.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserPresenterDebugTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String NAME = <span class="hljs-string"><span class="hljs-string">"Sasha"</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DebugRule debugRule = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DebugRule(); <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MockitoRule mockitoRule = MockitoJUnit.rule(); <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> RxImmediateSchedulerRule timeoutRule = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RxImmediateSchedulerRule(); <span class="hljs-meta"><span class="hljs-meta">@Mock</span></span> UserPresenter.Listener listener; <span class="hljs-meta"><span class="hljs-meta">@Mock</span></span> NameRepository nameRepository; <span class="hljs-meta"><span class="hljs-meta">@Mock</span></span> Logger logger; PublishSubject&lt;String&gt; nameObservable = PublishSubject.create(); UserPresenter presenter; <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ when(nameRepository.getName()).thenReturn(nameObservable.firstOrError()); presenter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserPresenter(listener, nameRepository, logger); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userNameLogged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ presenter.getUserName(); timeoutRule.getTestScheduler().triggerActions(); nameObservable.onNext(NAME); verify(logger).info(contains(NAME)); } }</code> </pre> <br><p> <a href=""> </a> </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserFragment</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Fragment</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserPresenter</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Listener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TextView textView; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> UserPresenter userPresenter; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> View </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreateView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ ((MainApplication) getActivity().getApplication()) .getComponent() .createUserComponent(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserModule(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)) .injectsUserFragment(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); textView = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TextView(getActivity()); userPresenter.getUserName(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> textView; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUserNameLoaded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ textView.setText(name); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onGettingUserNameError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String message)</span></span></span><span class="hljs-function"> </span></span>{ textView.setText(message); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDestroyView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onDestroyView(); userPresenter.stopLoading(); textView = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }</code> </pre> <br><p> <a href=""> </a> </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(AndroidJUnit4.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserFragmentIntegrationTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@ClassRule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> TestRule asyncRule = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FragmentAsyncTestRule&lt;&gt;(MainActivity.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserFragment()); <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> RuleChain rules = RuleChain .outerRule(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreateFileRule(getTestFile(), <span class="hljs-string"><span class="hljs-string">"{name : Sasha}"</span></span>)) .around(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FragmentTestRule&lt;&gt;(MainActivity.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserFragment())); <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nameDisplayed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ await() .atMost(<span class="hljs-number"><span class="hljs-number">5</span></span>, SECONDS) .ignoreExceptions() .untilAsserted( () -&gt; onView(ViewMatchers.withText(<span class="hljs-string"><span class="hljs-string">"Sasha"</span></span>)) .check(matches(isDisplayed()))); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> File </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTestFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File( InstrumentationRegistry.getTargetContext() .getFilesDir() .getAbsoluteFile() + File.separator + <span class="hljs-string"><span class="hljs-string">"test_file"</span></span>); } }</code> </pre> <br><p> <a href=""> </a> </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(AndroidJUnit4.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserFragmentTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@ClassRule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> TestRule asyncRule = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FragmentAsyncTestRule&lt;&gt;(MainActivity.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserFragment()); <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> FragmentTestRule&lt;MainActivity, UserFragment&gt; fragmentRule = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FragmentTestRule&lt;&gt;( MainActivity.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserFragment(), createTestApplicationComponent()); <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNameMethodCalledOnCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ verify(fragmentRule.getFragment().userPresenter).getUserName(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> ApplicationComponent </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createTestApplicationComponent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ApplicationComponent component = mock(ApplicationComponent.class); when(component.createUserComponent(any(UserModule.class))) .thenReturn(DaggerUserFragmentTest_TestUserComponent.create()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> component; } <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-meta"><span class="hljs-meta">@Component</span></span>(modules = {TestUserModule.class}) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestUserComponent</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserComponent</span></span></span><span class="hljs-class"> </span></span>{} <span class="hljs-meta"><span class="hljs-meta">@Module</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestUserModule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> UserPresenter </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideUserPresenter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mock(UserPresenter.class); } } }</code> </pre> <br><p> <a href=""> </a> </p></div></div><br><h2 id="blagodarnosti">  Thanks </h2><br><p>      <a href="https://github.com/AseevEIDev">Evgeny Aseev</a> .        .        ‚Äî <a href="https://github.com/andrewtar">Andrei Tarashkevich</a> , <a href="https://www.linkedin.com/in/ruslan-login-68bb2676/">Ruslan Login</a> .   ,  AURA Devices. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/352334/">https://habr.com/ru/post/352334/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352324/index.html">The Internet of Things as a catalyst for digital transformation</a></li>
<li><a href="../352326/index.html">JPoint 2018 plans</a></li>
<li><a href="../352328/index.html">The main criteria for SEO and AEO in the future - understanding and credibility</a></li>
<li><a href="../352330/index.html">Effective way to load a large number of points (geometries) on the map</a></li>
<li><a href="../352332/index.html">ThinLinc Remote Desktop Server Overview for Linux</a></li>
<li><a href="../352336/index.html">Control of the hardware product: the path of heavy compromise</a></li>
<li><a href="../352338/index.html">Miners succeeded cryptographers</a></li>
<li><a href="../352340/index.html">"Mamkin architect." Part 1: Ups and downs of software engineering</a></li>
<li><a href="../352342/index.html">Welcome to Security Meetup Mail.Ru Group</a></li>
<li><a href="../352344/index.html">Scales in action. How trade scales turn into a marketing tool</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>