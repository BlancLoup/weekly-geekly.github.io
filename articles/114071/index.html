<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We create the structure of personal documents of users in the enterprise in Samba</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Small foreplay 
 Greetings to the habrasoobshchestvo. 

 In the life of any medium and large company, sooner or later there comes a time when it is si...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We create the structure of personal documents of users in the enterprise in Samba</h1><div class="post__text post__text-html js-mediator-article"><h3>  Small foreplay </h3><br>  Greetings to the habrasoobshchestvo. <br><br>  In the life of any medium and large company, sooner or later there comes a time when it is simply not decent to live without a network data storage.  It is necessary to create a certain folder structure for intra-individual, inter-unit and other interactions, but more on that next time.  And now I would like to show you a quick way to create ‚Äúpersonal folders‚Äù for users of a company / company / institution / etc (underline the appropriate). <br><br><h3>  Introduction </h3><br>  So to the point of what is happening.  We assume that we have a domain with authorization in any LDAP-compatible directory service (hereinafter referred to as IC).  And the desire to create a file server based on Linux + Samba (can be on the same machine as the IC).  Why should everyone allocate a personal folder?  Mainly for storing data on the server so that no one has access to it.  Why does everyone have their own folder, and not 1 directory with the differentiation of rights?  Yes, there really is such a way, for me as an administrator, they are approximately equal in <s>hemorrhoid</s> complexity of implementation, but for users the uniquely chosen approach is more convenient. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I will not talk about configuring samba directly with authorization in <s>AD</s> SC, here and so a lot of articles in runet and not only, we‚Äôll dwell only on a couple of relevant parameters for us.  Basically it will be about the shell script, which will simplify all our tasks to impossibility. <br><a name="habracut"></a><br><h3>  Let's hit the road </h3><br>  First you need to create the folders themselves.  No, we will not do it manually ... All we need is to create text files with the following logic: call the otdelK.txt file and put several lines into it, IvanovI PetrovV.  How will the script parse this case?  Very simple - the file name will be taken as the name of the department / division, and the strings as the names of employees from the UK.  Compiling .txt files manually or automatically will be left at your discretion. <br>  The very logic of creating folders: <br><br><pre>  CreateFolders () {
		 mkdir "$ PP"
		 for filename in `ls -l $ catname / *. txt |  awk '{print $ NF}' `;  do
			 group = `basename" $ ‚Äã‚Äãfilename ".txt`
			 mkdir "$ PP / $ group"
			 for user in `cat" $ filename "`;  do
				 mkdir "$ PP / $ group / $ user"
				 CreateShare "$ group" "$ user"
				 PermissionsAssignment "$ group" "$ user"
			 done
		 done
	 } </pre><br><br>  That's actually not a tricky way to create a directory structure (of course in the full version there are a lot of all sorts of checks).  The $ catname directory is viewed for the presence of txt files in it and then they are sorted.  The $ PP variable contains the path to the folder where everything will be created. <br>  After creating each personal folder, you may notice a call for 2 more functions with ‚Äútalking names‚Äù.  Consider their content: <br><br><pre>  CreateShare () {
		 username = "$ 2"
		 ou = "$ 1"

		 grep -wi '\ [' $ username '\]' "$ SC"&gt; / dev / null
		 if ["$?"  -ne 0];  then
			 echo -e "[$ username]
			 path = \ "$ PP / $ ou / $ username \"

			 valid users = \ "@ $ DN \\ $ AG \", \ "$ DN \\ $ username \"
			 admin users = \ "@ $ DN \\ $ AG \"

			 browseable = No
			 comment = \ "Private Documents% U \"
			 public = No
			 writeable = Yes
			 read only = No

			 create mask = 0700
			 directory mask = 0700

			 inherit permissions = Yes
			 inherit acls = Yes
			 inherit owner = Yes

			 vfs objects = recycle

			 recycle: repository = .Trash
			 recycle: versions = Yes
			 recycle: keeptree = Yes
			 recycle: exclude = * .TMP * .tmp ~ *
			 "&gt;&gt;" $ SC "
			 echo "Folder for user $ username is shared" |  tee -a "$ log"
		 else
			 echo "INFO: Sharing for user $ username already exist" |  tee -a "$ log"
			 warn = true
		 fi
	 } </pre><br><br>  This function calls with two arguments: department and user name.  Checks if a ball already exists for it and if not, then creates it.  The values ‚Äã‚Äãof each parameter can be viewed both in the official man pages and <a href="http://smb-conf.ru/">in Russian</a> .  Let me just say that all the rules are aimed at the fact that the user has full access to the folder, but he could not change any permissions in it.  You can also notice that the user is allocated a basket, i.e.  all that he removes from his network folder will be placed in his network cart (I only have access to the baskets on my network).  All these folders are connected to users through my vbs script when I log into the system. <br>  Here you should remember a couple of lines from smb.conf <br><br><pre>  store dos attributes = Yes
	  map acl inherit = Yes
	  acl group control = No
	  dos filemode = No

	  # POSIX 'rwx' is displayed in rwx, but not full control
	  acl map full control = No &lt;--- here is a very important parameter that helped us. </pre><br><br>  Next, you need to assign rights in the system for the created directory. <br><br><pre>  PermissionsAssignment () {
	    path = "$ PP / $ 1 / $ 2 /"
	    chown "$ AU": "$ AG" -R "$ path"
	    chmod 0770 -R "$ path"
	    chmod g + s -R "$ path"
	    setfacl -bR "$ path"
	    setfacl -R -mm :: rwx "$ path"
	    setfacl -nR -mu: "$ 2": rwx "$ path"
	 } </pre><br><br>  It immediately becomes clear that the xfsprogs package is required, which includes the setfacl and getfacl utilities for managing extended attributes in Linux.  All this <s>gimp</s> utility is created for all the same purpose - to keep the user from the possibility of changing rights.  Although, indeed, in the case of ‚Äúpersonal documents‚Äù this is not critical and even an extra MB, but when organizing shared network resources, it is impossible without it. <br><br><h3>  Conclusion </h3><br>  This article is designed for an average level of knowledge and is not intended to make a newbie guru. <br>  The script does not provide for a multi-level hierarchy of departments (to be added upon individual requests).  I tried to stuff the script with ‚Äúprotection from a fool‚Äù as much as possible, and did it even at the time of writing this article, but I cannot foresee everything.  The script inside contains several parameters that should be corrected for themselves, they are not difficult to find ;-).  You can also pass them as arguments to the script, with one small restriction - I don‚Äôt know how <s>to make</s> <i>getopts</i> take arguments with spaces, so if your paths or group names contain spaces, please specify them inside the script. <br>  The full text of the script and smb.conf is attached: <a href="http://rghost.ru/4425870">script</a> , <a href="http://rghost.ru/4425863">smb.conf</a> . <br><br>  PS smb.conf is well-developed.  The script itself turned out to be quite cumbersome because of all sorts of checks and ‚Äúand if‚Äù.  He also does not claim a complete universal solution because he was written under a narrow task and then was a bit unified. </div><p>Source: <a href="https://habr.com/ru/post/114071/">https://habr.com/ru/post/114071/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../114061/index.html">Effective meetings</a></li>
<li><a href="../114062/index.html">What's next?</a></li>
<li><a href="../114063/index.html">Love and sex in search queries or "I do not want to learn, I want to marry!"</a></li>
<li><a href="../114064/index.html">Would you buy a nokia smartphone with windows phone 7?</a></li>
<li><a href="../114067/index.html">Tip: Using ReSharper with Microsoft CodeContracts</a></li>
<li><a href="../114073/index.html">Clodo Downtime and Strange Support</a></li>
<li><a href="../114075/index.html">New types of files in Google Docs</a></li>
<li><a href="../114078/index.html">Collect data or teach Doctrine to do multiple insert</a></li>
<li><a href="../114079/index.html">How I implemented Zimbra</a></li>
<li><a href="../114080/index.html">Canvas Indicator - Alternative for AjaxLoad.gif</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>