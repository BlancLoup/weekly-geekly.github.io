<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Gcc vs Intel C ++ Compiler: build FineReader Engine for Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The prerequisite for writing this article was a completely natural desire to improve the performance of the FineReader Engine. 

 It is believed that ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Gcc vs Intel C ++ Compiler: build FineReader Engine for Linux</h1><div class="post__text post__text-html js-mediator-article">  The prerequisite for writing this article was a completely natural desire to improve the performance of the FineReader Engine. <br><br>  It is believed that the compiler from Intel produces a much faster code than gcc.  And it would be nice to increase the recognition speed <s>without doing anything</s> just by assembling the FR Engine with another compiler. <a name="habracut"></a><br><br>  At the moment, the FineReader Engine is not built by the most recent compiler - gcc 4.2.4.  It's time to move on to something more modern.  We considered two alternatives - this is the new version of gcc - 4.4.4, and the compiler from Intel is the Intel C ++ Compiler (icc). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Porting a large project to a new compiler may not be the easiest thing to do, so for a start we decided to test the compilers on the <a href="http://www.povray.org/download/benchmark.php">benchmark</a> . <br><br>  Here are the brief results on the Intel Core2 Duo processor: <br><img src="https://habrastorage.org/getpro/habr/post_images/e8c/a7d/bf9/e8ca7dbf96f5d7a20e555e4aa88feba0.jpg" alt="image"><br>  <sub>Time of povray test on an Intel processor (sec)</sub> <br><br>  AMD was also interesting to see: <br><img src="https://habrastorage.org/getpro/habr/post_images/e39/b4b/0c1/e39b4b0c19248b02d62358d41845e44f.jpg" alt="image"><br>  <sub>Time povray- test on AMD processor (sec)</sub> <br><br>  Briefly about the flags: <br>  -O1, -O2 and -O3 - various levels of optimization. <br>  For gcc, the best option is ‚ÄìO3, and it is used almost everywhere when building the FineReader Engine. <br>  For icc, the optimal option is -O2, and -O3 includes some additional optimization of the cycles, which, however, may not work. <br>  -mtune = core2 -march = core2 -msse3 - optimization for a specific processor, in this case for Core2 Duo. <br>  -xT is a similar flag for the compiler from Intel. <br>  -fprofile-use - <a href="http://en.wikipedia.org/wiki/Profile-guided_optimization">PGO</a> <br><br>  Tests with optimizations for a specific processor are given just for fun.  A binary compiled with one processor optimized may not run on another.  FineReader Engine should not be tied to a specific processor, therefore, such optimizations cannot be used. <br><br>  So, apparently, a performance boost is possible: icc speeds up on an Intel processor very significantly.  On AMD, it behaves <a href="http://habrahabr.ru/blogs/hardware/80050/">more modestly</a> , but it still gives a good gain compared to gcc. <br>  It's time to move on to what we all have started, the assembly of the FineReader Engine.  We compiled FineReader Engine with different compilers, started recognition on a package of images.  Here are the results: <br><img src="https://habrastorage.org/getpro/habr/post_images/c84/7fd/2ac/c847fd2ac5b0f87ac0471d9d51e533d0.jpg" alt="image"><br>  <sub>Hours of FREngine compiled by various compilers (seconds per page)</sub> <br><br>  Unexpected result.  The ratio of gcc-4.4.4 / gcc-4.2.4 is quite consistent with the measurements on the benchmark, and even slightly exceeds expectations.  But what about icc?  He loses not only the new gcc, but gcc two years ago! <br><br>  We went to oprofile for the truth, and this is what we found out: in some (quite rare) cases, icc has problems with loop optimization.  Here is the code that I managed to write based on the results of the profiling: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">static</font> <font color="#0000ff">const</font> <font color="#0000ff">int</font> aim = ..; <br> <font color="#0000ff">static</font> <font color="#0000ff">const</font> <font color="#0000ff">int</font> range = ..; <br> <br> <font color="#0000ff">int</font> process( <font color="#0000ff">int</font> * line, <font color="#0000ff">int</font> size ) <br> { <br> <font color="#0000ff">int</font> result = 0; <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; size; i++ ) { <br> <font color="#0000ff">if</font> ( line[i] == aim ) { <br> result += 2; <br> } <font color="#0000ff">else</font> { <br> <font color="#0000ff">if</font> ( line[i] &lt; aim - range || line[i] &gt; aim + range ) { <br> result--; <br> } <font color="#0000ff">else</font> { <br> result++; <br> } <br> } <br> } <br> <font color="#0000ff">return</font> result; <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  By running the function on different input data, we got something like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/6ae/b18/fef/6aeb18fefbfb5ebddcd068e2b71a6363.jpg" alt="image"><br>  <sub>Cycle time (ms)</sub> <br><br>  Adding other optimization flags didn‚Äôt give tangible results, so I‚Äôve just listed the main ones. <br>  Unfortunately, Intel does not explicitly indicate what -O1, -O2, and -O3 include, so it was not possible to figure out exactly which optimization caused the code to slow down.  In fact, in most cases, icc optimizes cycles better, but in some special cases (like the one above) there are difficulties. <br><br>  With the help of profiling, we managed to find another, more serious problem.  In the profiler report for the version of FineReader Engine, compiled by icc, at a fairly high position was a similar line: <br><br> <code>Namespace::A::GetValue() const (         )</code> <br> <br>  while in the gcc version there was no such function at all. <br>  A :: GetValue () returns a simple structure containing several fields.  Most often, this method is called for a global constant object in the construction of the form <br><br> <code>GlobalConstObject.GetValue().GetField()</code> <br> <br>  which is of type int.  All the above Get .. () methods are trivial - they simply return some field of the object (by value or by reference).  Thus, GetValue () returns an object with several fields, after which GetField () pulls out one of these fields.  In this case, instead of permanently copying the entire structure in order to pull out just one field, it is quite possible to turn the chain into one call that returns the desired number.  In addition, all the fields of the GlobalConstObject object are known (can be calculated) at the compilation stage, so the chain of these methods can be replaced with a constant. <br><br>  gcc does just that (at least it avoids unnecessary construction), however icc with the included -O2 or -O3 optimizations leaves everything as it is.  And given the number of such calls, this place becomes critical, although no useful work is being done here. <br><br>  Now about the methods of treatment: <br><br>  1) Automatic.  Icc has a wonderful -ipo flag that asks the compiler to perform <a href="http://en.wikipedia.org/wiki/Interprocedural_optimization">interprocedural optimization</a> , besides between files.  Here is what is written about this in Intel's optimization manuals: <br><br><blockquote>  The IPO allows you to make a list of optimizations: <br>  ‚Ä¢ Inline function expansion of calls, jumps, branches and loops. <br>  ‚Ä¢ Interprocedural constant propagation for global variables and return values. <br>  ‚Ä¢ Monitoring module-level invariant code. <br>  ‚Ä¢ Dead code elimination to reduce code size. <br>  ‚Ä¢ Propagation of function characteristics <br>  ‚Ä¢ Identification of loop-invariant code for invariant code. <br></blockquote><br>  It seems that this is what you need.  Everything would be fine, but FineReader Engine contains a huge amount of code.  Attempting to launch it with the -ipo flag meant that the linker (namely, it performs ipo) took up all the memory, the entire swap, and only the page recognition module (the largest one, however) collected for several hours.  Hopelessly. <br><br>  2) Manual.  If you manually replace the call chain with a constant everywhere in the code, the Intel compiler produces a good performance increase with respect to the old results. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/210/59a/999/21059a9997b05981bc1f0700a0be7960.jpg" alt="image"><br><br>  The last line is the version compiled by icc, where in the most critical places the call chain has been replaced with a constant.  As you can see, this allowed icc to run faster than gcc-4.2.4, but still slower than gcc-4.4.4. <br>  You can try to catch all such critical places and manually correct the code.  The drawback is obvious - it will take a huge amount of time and effort. <br><br>  3) Combined.  You can build with the -ipo flag not the whole module, but only some of its parts.  This will give an acceptable compile time.  However, which files should be compiled with this flag will have to be determined manually, which again potentially leads to high labor costs. <br><br>  So, we summarize.  Intel C ++ Compiler is potentially good.  But due to the features described above and a large amount of code, we decided that it does not give a significant gain in speed - significant enough to justify the labor costs of porting and ‚Äúsharpening‚Äù the code for this compiler. </div><p>Source: <a href="https://habr.com/ru/post/103447/">https://habr.com/ru/post/103447/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../103439/index.html">DevPoint 2</a></li>
<li><a href="../103440/index.html">CMS Plone 4 - Better, Faster</a></li>
<li><a href="../103441/index.html">Rad Studio 2011 XE: New in Delphi, C ++ Builder, RadPHP and Delphi Prism</a></li>
<li><a href="../103444/index.html">Benchmarking with Basho Bench</a></li>
<li><a href="../103446/index.html">We identify Skype users by intercepted HTTP traffic</a></li>
<li><a href="../103448/index.html">How Eychary of the largest IT-companies in Russia recruit staff</a></li>
<li><a href="../103449/index.html">An overview of the functionality of web-based e-mail</a></li>
<li><a href="../103450/index.html">Overview of several new jQuery plugins</a></li>
<li><a href="../103451/index.html">PocketBook Education- Read, learn and read again</a></li>
<li><a href="../103452/index.html">India wants to control RIM, Google and Skype</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>