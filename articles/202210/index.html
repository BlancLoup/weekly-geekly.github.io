<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Never repeat this house: modification of the HC-128 encryption algorithm</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="HC-128 (pdf) - finalist of the European project eSTREAM , stream cipher with a rather large internal state 
 (2 independent arrays of 512 32bit words)...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Never repeat this house: modification of the HC-128 encryption algorithm</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/66e/14a/cc7/66e14acc7acd02c6ff5b32de98efa873.png" align="right"><br>  <a href="http://www.ecrypt.eu.org/stream/p3ciphers/hc/hc128_p3.pdf">HC-128</a> (pdf) - <a href="http://www.ecrypt.eu.org/stream/hcp3.html">finalist of the</a> European project <a href="http://ru.wikipedia.org/wiki/ESTREAM">eSTREAM</a> , stream cipher with a rather large internal state <br>  (2 independent arrays of 512 32bit words).  It is very smart if you encrypt large streams, but since the initialization of these arrays takes a decent amount of time, it is not very efficient in batch mode.  On the right are 6 main functions that are used in it.  It is not overloaded with scary long arrays of constants, its implementation (under the cut) compared to others looks simple and more or less understandable.  It all started with the fact that I hooked two functions <b>f1</b> and <b>f2</b> <br><a name="habracut"></a><br><br>  Here is the standard implementation, taken from the BouncyCastle library <br><br><div class="spoiler">  <b class="spoiler_title">HC-128</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> org.bouncycastle.crypto.engines; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.bouncycastle.crypto.CipherParameters; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.bouncycastle.crypto.DataLengthException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.bouncycastle.crypto.StreamCipher; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.bouncycastle.crypto.params.KeyParameter; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.bouncycastle.crypto.params.ParametersWithIV; <span class="hljs-comment"><span class="hljs-comment">/** * HC-128 is a software-efficient stream cipher created by Hongjun Wu. It * generates keystream from a 128-bit secret key and a 128-bit initialization * vector. * &lt;p&gt; * http://www.ecrypt.eu.org/stream/p3ciphers/hc/hc128_p3.pdf * &lt;/p&gt;&lt;p&gt; * It is a third phase candidate in the eStream contest, and is patent-free. * No attacks are known as of today (April 2007). See * * http://www.ecrypt.eu.org/stream/hcp3.html * &lt;/p&gt; */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HC128Engine</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StreamCipher</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] p = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[<span class="hljs-number"><span class="hljs-number">512</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] q = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[<span class="hljs-number"><span class="hljs-number">512</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cnt = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rotateRight(x, <span class="hljs-number"><span class="hljs-number">7</span></span>) ^ rotateRight(x, <span class="hljs-number"><span class="hljs-number">18</span></span>) ^ (x &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">3</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rotateRight(x, <span class="hljs-number"><span class="hljs-number">17</span></span>) ^ rotateRight(x, <span class="hljs-number"><span class="hljs-number">19</span></span>) ^ (x &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">10</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">g1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> z)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (rotateRight(x, <span class="hljs-number"><span class="hljs-number">10</span></span>) ^ rotateRight(z, <span class="hljs-number"><span class="hljs-number">23</span></span>)) + rotateRight(y, <span class="hljs-number"><span class="hljs-number">8</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">g2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> z)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (rotateLeft(x, <span class="hljs-number"><span class="hljs-number">10</span></span>) ^ rotateLeft(z, <span class="hljs-number"><span class="hljs-number">23</span></span>)) + rotateLeft(y, <span class="hljs-number"><span class="hljs-number">8</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rotateLeft</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bits)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (x &lt;&lt; bits) | (x &gt;&gt;&gt; -bits); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rotateRight</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bits)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (x &gt;&gt;&gt; bits) | (x &lt;&lt; -bits); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">h1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> q[x &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>] + q[((x &gt;&gt; <span class="hljs-number"><span class="hljs-number">16</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>) + <span class="hljs-number"><span class="hljs-number">256</span></span>]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">h2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p[x &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>] + p[((x &gt;&gt; <span class="hljs-number"><span class="hljs-number">16</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>) + <span class="hljs-number"><span class="hljs-number">256</span></span>]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mod1024</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x &amp; <span class="hljs-number"><span class="hljs-number">0x3FF</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mod512</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x &amp; <span class="hljs-number"><span class="hljs-number">0x1FF</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dim</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mod512(x - y); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">step</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = mod512(cnt); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ret; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cnt &lt; <span class="hljs-number"><span class="hljs-number">512</span></span>) { p[j] += g1(p[dim(j, <span class="hljs-number"><span class="hljs-number">3</span></span>)], p[dim(j, <span class="hljs-number"><span class="hljs-number">10</span></span>)], p[dim(j, <span class="hljs-number"><span class="hljs-number">511</span></span>)]); ret = h1(p[dim(j, <span class="hljs-number"><span class="hljs-number">12</span></span>)]) ^ p[j]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { q[j] += g2(q[dim(j, <span class="hljs-number"><span class="hljs-number">3</span></span>)], q[dim(j, <span class="hljs-number"><span class="hljs-number">10</span></span>)], q[dim(j, <span class="hljs-number"><span class="hljs-number">511</span></span>)]); ret = h2(q[dim(j, <span class="hljs-number"><span class="hljs-number">12</span></span>)]) ^ q[j]; } cnt = mod1024(cnt + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] key, iv; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> initialised; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (key.length != <span class="hljs-number"><span class="hljs-number">16</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> java.lang.IllegalArgumentException( <span class="hljs-string"><span class="hljs-string">"The key must be 128 bits long"</span></span>); } cnt = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] w = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[<span class="hljs-number"><span class="hljs-number">1280</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">16</span></span>; i++) { w[i &gt;&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>] |= (key[i] &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>) &lt;&lt; (<span class="hljs-number"><span class="hljs-number">8</span></span> * (i &amp; <span class="hljs-number"><span class="hljs-number">0x3</span></span>)); } System.arraycopy(w, <span class="hljs-number"><span class="hljs-number">0</span></span>, w, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; iv.length &amp;&amp; i &lt; <span class="hljs-number"><span class="hljs-number">16</span></span>; i++) { w[(i &gt;&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>) + <span class="hljs-number"><span class="hljs-number">8</span></span>] |= (iv[i] &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>) &lt;&lt; (<span class="hljs-number"><span class="hljs-number">8</span></span> * (i &amp; <span class="hljs-number"><span class="hljs-number">0x3</span></span>)); } System.arraycopy(w, <span class="hljs-number"><span class="hljs-number">8</span></span>, w, <span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">16</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">1280</span></span>; i++) { w[i] = f2(w[i - <span class="hljs-number"><span class="hljs-number">2</span></span>]) + w[i - <span class="hljs-number"><span class="hljs-number">7</span></span>] + f1(w[i - <span class="hljs-number"><span class="hljs-number">15</span></span>]) + w[i - <span class="hljs-number"><span class="hljs-number">16</span></span>] + i; } System.arraycopy(w, <span class="hljs-number"><span class="hljs-number">256</span></span>, p, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">512</span></span>); System.arraycopy(w, <span class="hljs-number"><span class="hljs-number">768</span></span>, q, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">512</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">512</span></span>; i++) { p[i] = step(); } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">512</span></span>; i++) { q[i] = step(); } cnt = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAlgorithmName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"HC-128"</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * Initialise a HC-128 cipher. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> forEncryption whether or not we are for encryption. Irrelevant, as * encryption and decryption are the same. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> params the parameters required to set up the cipher. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> IllegalArgumentException if the params argument is * inappropriate (ie. the key is not 128 bit long). */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> forEncryption, CipherParameters params)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IllegalArgumentException </span></span>{ CipherParameters keyParam = params; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (params <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> ParametersWithIV) { iv = ((ParametersWithIV)params).getIV(); keyParam = ((ParametersWithIV)params).getParameters(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { iv = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keyParam <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> KeyParameter) { key = ((KeyParameter)keyParam).getKey(); init(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException( <span class="hljs-string"><span class="hljs-string">"Invalid parameter passed to HC128 init - "</span></span> + params.getClass().getName()); } initialised = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] buf = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">4</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> idx = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">byte</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getByte</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (idx == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> step = step(); buf[<span class="hljs-number"><span class="hljs-number">0</span></span>] = (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)(step &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>); step &gt;&gt;= <span class="hljs-number"><span class="hljs-number">8</span></span>; buf[<span class="hljs-number"><span class="hljs-number">1</span></span>] = (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)(step &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>); step &gt;&gt;= <span class="hljs-number"><span class="hljs-number">8</span></span>; buf[<span class="hljs-number"><span class="hljs-number">2</span></span>] = (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)(step &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>); step &gt;&gt;= <span class="hljs-number"><span class="hljs-number">8</span></span>; buf[<span class="hljs-number"><span class="hljs-number">3</span></span>] = (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)(step &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ret = buf[idx]; idx = idx + <span class="hljs-number"><span class="hljs-number">1</span></span> &amp; <span class="hljs-number"><span class="hljs-number">0x3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processBytes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] in, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> inOff, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] out, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> outOff)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> DataLengthException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!initialised) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(getAlgorithmName() + <span class="hljs-string"><span class="hljs-string">" not initialised"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((inOff + len) &gt; in.length) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataLengthException(<span class="hljs-string"><span class="hljs-string">"input buffer too short"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((outOff + len) &gt; out.length) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataLengthException(<span class="hljs-string"><span class="hljs-string">"output buffer too short"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i++) { out[outOff + i] = (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)(in[inOff + i] ^ getByte()); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ idx = <span class="hljs-number"><span class="hljs-number">0</span></span>; init(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">byte</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returnByte</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> in)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)(in ^ getByte()); } }</code> </pre> <br></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      About the functions <b>f1</b> and <b>f2</b> I <a href="http://habrahabr.ru/post/168707/">wrote</a> earlier.  In short, they are taken from SHA-2 (hello, NSA!) And represent a unique transformation of one 32-bit number to another. <br><br>  I was interested in constants in these functions, where they were taken from and how they were calculated.  It turned out that there is a little more than <b>0</b> information, all that is given in the link above.  I counted the period of these two functions, it was not the maximum of all, and I picked up constants that corresponded to the maximum period.  A simple cycle, searching through all three constants, searched for triples, which will have a maximum period.  Well, it looked that the values ‚Äã‚Äãof two different triples did not overlap during the calculation of the period.  Here, for example, such triples (there are many such pairs, I chose those that I liked). <br>  <b>{22, 13, 3} and {18, 4, 9}</b> instead of the original <b>{7, 18, 3} and {17, 19, 10}</b> <br><br>  I do not know what the NSA was guided by when developing these functions, maybe they have a bookmark, and maybe not.  But it is very similar to the fact that my constants are not worse than theirs.  They also provide a one-to-one correspondence (checked over all values ‚Äã‚Äãof 0 - (2 <sup>32</sup> -1)) and have a longer cycle than the standard ones.  So, feel free to replace them with my <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rotateRight(x, <span class="hljs-number"><span class="hljs-number">22</span></span>) ^ rotateRight(x, <span class="hljs-number"><span class="hljs-number">13</span></span>) ^ (x &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">3</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rotateRight(x, <span class="hljs-number"><span class="hljs-number">18</span></span>) ^ rotateRight(x, <span class="hljs-number"><span class="hljs-number">4</span></span>) ^ (x &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">9</span></span>); }</code> </pre><br><br>  C figured it out. <br><br>  Now one more thing.  I came across a <a href="http://eprint.iacr.org/2010/387.pdf">document</a> with combinatorial analysis of HC-128.  There is a billion matan, but what is more interesting - there are suggestions for improving the functions of <b>h1</b> , <b>h2</b> and <b>g1</b> , <b>g2</b> (section 4) <br><br>  The essence of the improvements is the following: The functions <b>h1 (x)</b> and <b>h2 (x)</b> use only 16 bits from the 32 provided by them. These 16 bits are used as 2 indices (2x8) in the <b>P</b> and <b>Q</b> state arrays.  But it is necessary to use all 32, otherwise it is possible under certain conditions to restore the internal state.  Therefore, what is considered initially in these functions (the sum of two elements modulo 2 <sup>32</sup> ) is xorim with <b>x</b> itself.  It will look like this (compare with the option above): <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">h1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (q[x &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>] + q[((x &gt;&gt; <span class="hljs-number"><span class="hljs-number">16</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>) + <span class="hljs-number"><span class="hljs-number">256</span></span>]) ^ x; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">h2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (p[x &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>] + p[((x &gt;&gt; <span class="hljs-number"><span class="hljs-number">16</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>) + <span class="hljs-number"><span class="hljs-number">256</span></span>]) ^ x; }</code> </pre><br><br>  Now about the functions <b>g1 (x)</b> and <b>g2 (x)</b> .  Arrays of states <b>P</b> and <b>Q</b> live independently of each other.  Therefore, under adverse conditions (recognition of one of these arrays and part of the stream of generated bytes), this can lead to bad consequences. <br><br>  Therefore, we modify the functions <b>g1</b> and <b>g2</b> so that each element of <b>P</b> depends on a random element of <b>Q</b> and vice versa.  And instead of cyclically shifting the element <b>y,</b> we take a few bits from it as an index for an element from the arrays <b>Q</b> and <b>P.</b> <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">g1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> z)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (rotateRight(x, <span class="hljs-number"><span class="hljs-number">10</span></span>) ^ rotateRight(z, <span class="hljs-number"><span class="hljs-number">23</span></span>)) + Q[(y &gt;&gt; <span class="hljs-number"><span class="hljs-number">7</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x1FF</span></span>]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">g2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> z)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (rotateLeft(x, <span class="hljs-number"><span class="hljs-number">10</span></span>) ^ rotateLeft(z, <span class="hljs-number"><span class="hljs-number">23</span></span>)) + P[(y &gt;&gt; <span class="hljs-number"><span class="hljs-number">7</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x1FF</span></span>]; }</code> </pre><br><br>  That's all, now we have a new algorithm, not inferior (and, in theory, superior) to the original in-line HC-128. <br><br><h4>  Comment </h4><br><br>  Of course, this is all by and large the game and <b>I just have to advise you not to use such things in real applications</b> .  But as a charge for the brain, for self-application and deliberately avoiding standards and patents (if HC-128 were patented), such studies and <b><i>careful</i></b> modifications may well have the right to life.  For example, I use this option in the procedure of slowing down a password hash (I form a hash (password) + hash (hash (password)) + (hash (password) + hash (hash (password)) from the password of a 15-kilobyte array) and so on ... ), I initialize the modified HC-128 hash from this array, and then in a cycle several million times I encrypt different small sections of this array with the modified HC-128 in order to finally calculate the hash from the array, which will be a slow hash from the password. <br><br>  By the way, something like <a href="http://habrahabr.ru/post/168707/">Sponge</a> function.  But this is me after doper. <br><br>  After this cycle, I once again consider the hash of the array, this will be a slow password hash.  An effective brutal-force to such horror will be simply impossible to write. <br><br>  Here is the class that does it.  ObfuscatorEngine is a modified HC-128.  <b>entropy</b> is an array that is collected from hashes and then encrypted in chunks in random places. <br>  The number of iterations is a prime number.  It is also interesting to look at the place where <b>offset is</b> calculated. <br><div class="spoiler">  <b class="spoiler_title">SlowHasher</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.paranoim.crypto.utils; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Arrays; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.bouncycastle.crypto.util.Pack; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.paranoim.crypto.Consts; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.paranoim.crypto.digest.SHA3_256; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.paranoim.crypto.digest.SHA3_512; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.paranoim.crypto.utils.obfuscator.ObfuscatorEngine; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> fr.cryptohash.DigestEngine; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> fr.cryptohash.Keccak256; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> fr.cryptohash.Keccak512; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@author</span></span></span><span class="hljs-comment"> scratch * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@description</span></span></span><span class="hljs-comment"> this class does calculation of hash of a password but with many iterations, * so that it would be difficult to find with brute force * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@created</span></span></span><span class="hljs-comment"> 06.08.2010 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SlowHasher</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ITERATIONS_COUNT = <span class="hljs-number"><span class="hljs-number">0x133ECD</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CHUNK_SIZE = <span class="hljs-number"><span class="hljs-number">71</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] calculateSlowHash(<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String password, <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] salt) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (salt.length != Consts.BIG_SALT_SIZE) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException(<span class="hljs-string"><span class="hljs-string">"Salt size must be "</span></span> + Consts.BIG_SALT_SIZE + <span class="hljs-string"><span class="hljs-string">" bytes!"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] saltedPassword = ByteUtils.concat(salt, password.getBytes()); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] hashOfSaltedPassword = SHA3_512.process(saltedPassword); <span class="hljs-comment"><span class="hljs-comment">// hash of (salt+password) final ObfuscatorEngine engine = new ObfuscatorEngine(); // used to mix bytes //compute initial entropy string final byte[] entropy = getInitialEntropy(engine, hashOfSaltedPassword, saltedPassword); final byte[] entropyHash = SHA3_512.process(entropy); engine.init(entropyHash); // 16 bytes used as key, 16 as iv final int maxOffset = entropy.length - CHUNK_SIZE + 1; int offset = (Pack.bigEndianToInt(entropyHash, 7) &amp; 0x7FFFFFFF) % maxOffset; // main loop for (int i = 0; i &lt; ITERATIONS_COUNT; i++) { engine.processBytes(entropy, offset = (Pack.bigEndianToInt(entropy, offset) &amp; 0x7FFFFFFF) % maxOffset, CHUNK_SIZE, entropy, offset); } //finalization process engine.init(SHA3_256.process(entropy)); engine.processBytes(entropy, 0, entropy.length, entropy, 0); engine.processBytes(entropyHash, 0, entropyHash.length, entropyHash, 0); return SHA3_256.process(ByteUtils.concat(entropyHash, entropy)); } private static byte[] getInitialEntropy(final ObfuscatorEngine engine, final byte[] hashOfSaltedPassword, final byte[] saltedPassword) { //final ExtendedDigest sha256 = new SHA3Digest(256); //final ExtendedDigest sha512 = new SHA3Digest(512); final DigestEngine sha256 = new Keccak256(); final DigestEngine sha512 = new Keccak512(); final byte[] hash32 = new byte[32]; final byte[] hash64 = new byte[64]; final byte[] sp = Arrays.copyOf(saltedPassword, saltedPassword.length); final byte[] h = Arrays.copyOf(hashOfSaltedPassword, hashOfSaltedPassword.length); byte[] entropy = ByteUtils.concat(h, sp); engine.init(hashOfSaltedPassword); engine.processBytes(entropy, 0, entropy.length, entropy, 0); for (int i = 0; i &lt; hashOfSaltedPassword.length &lt;&lt; 1; i++) // 128 iterations { final byte b = hashOfSaltedPassword[i &gt;&gt; 1]; // i/2 if (((b &gt;&gt; (i &amp; 1)) &amp; 1) == 1) // we check 1st bit of b on even i and 2nd on odd { engine.processBytes(sp, 0, sp.length, sp, 0); entropy = ByteUtils.concat(sp, entropy); hash(sha512, entropy, hash64); entropy = ByteUtils.concat(entropy, hash64); hash(sha256, entropy, hash32); engine.init(hash32); engine.processBytes(entropy, 0, entropy.length, entropy, 0); } else { engine.processBytes(h, 0, h.length, h, 0); entropy = ByteUtils.concat(entropy, h); hash(sha512, entropy, hash64); entropy = ByteUtils.concat(hash64, entropy); hash(sha256, entropy, hash32); engine.init(hash32); engine.processBytes(entropy, 0, entropy.length, entropy, 0); } } return entropy; } private static void hash(final DigestEngine digest, final byte[] data, final byte[] result) { digest.update(data, 0, data.length); digest.digest(result, 0, result.length); } }</span></span></code> </pre><br></div></div><br><br>  Here is such a Friday etude. </div><p>Source: <a href="https://habr.com/ru/post/202210/">https://habr.com/ru/post/202210/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../202194/index.html">Chinese Hackspace: Chaihuo Make Space</a></li>
<li><a href="../202196/index.html">Samsung MultiScreen SDK beta</a></li>
<li><a href="../202202/index.html">Overview of Drupal Learning Materials</a></li>
<li><a href="../202204/index.html">How I trusted my intuition and was very stubborn</a></li>
<li><a href="../202206/index.html">Uniregistry launched nic.sexy and nic.tattoo</a></li>
<li><a href="../202212/index.html">Python-digest # 2. News, interesting projects, articles and interviews [November 8, 2013 - November 15, 2013]</a></li>
<li><a href="../202214/index.html">Continuous Delivery hecho en Alawar</a></li>
<li><a href="../202216/index.html">Telephone radiations: myths and legends - and what determines the power of the telephone transmitter</a></li>
<li><a href="../202218/index.html">Meople.Net. How it works?</a></li>
<li><a href="../202220/index.html">Normal numbers. Episode II: De Bruin's Attack</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>