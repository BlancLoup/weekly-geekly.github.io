<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Investigation into one unknown archive</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Moving New town. Job seeking. Even for an IT specialist, this can take a long time. A series of interviews, which, in general, are very similar to eac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Investigation into one unknown archive</h1><div class="post__text post__text-html js-mediator-article">  Moving  New town.  Job seeking.  Even for an IT specialist, this can take a long time.  A series of interviews, which, in general, are very similar to each other.  And as it usually happens when you have already found a job, after a while, one interesting office is announced. <br><br>  It was difficult to understand what she was doing, however, her area of ‚Äã‚Äãinterest was the study of someone else's software.  It sounds intriguing, although when you realize that this is not a vendor who is releasing cybersecurity software, you stop for a second and start scratching your turnips. <br><br><img src="https://lh3.googleusercontent.com/Wm2cSc19nc9XsapzlEW-eGMZBZCEgSbZFCSj6hdNNlkqCa40ksCXrYv8ual-VfYF3rcn5OoM9X2OwIJY07u_dD5Lo_7mzZU4D7rQuu164GIDE2_IjBu_J1dIMsjD4uDgyep3yipN"><br><a name="habracut"></a><br>  Briefly: they threw me an archive and offered to test it as a test task and try to calculate a certain signature based on the input data presented.  It should be noted that I had very little experience in such activities and, probably, therefore, in the first iteration of the solution, I only had enough for a couple of hours - the further motivation to do this, went away.  And yes, I, of course, the first thing I tried to run it on the phone / emulator - this application is invalid. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>What we have: an</b> archive with the extension <b>".apk"</b> .  Under the spoiler I placed the task itself so that it would not be indexed by search engines: what if the guys did not like it that I placed the solution on Habr? <br><br><div class="spoiler">  <b class="spoiler_title">Task itself</b> <div class="spoiler_text">  In the APK is the functionality for generating signatures for an associative array. <br>  Try to get a signature for the following dataset: <br><br><pre><code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"user"</span></span> : <span class="hljs-string"><span class="hljs-string">"LeetD3vM4st3R"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"__s33cr$$tV4lu3__"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"hash"</span></span>: <span class="hljs-string"><span class="hljs-string">"34765983265937875692356935636464"</span></span> }</code> </pre> <br></div></div><br><h2>  Roll up the sleeves </h2><br>  It is said that the archive contains the functionality of signing an associative array.  By file extension, we immediately understand that we are dealing with an application written for Android.  First, unpack the archive.  In fact, this is a regular ZIP archive, and any archiver can handle it lightly.  I used the apktool utility, and, as it turned out, inadvertently, walked around a couple of rakes.  Yes, it happens (usually the opposite, yes?).  The spell is quite simple: <br><br><pre> <code class="bash hljs">apktool d task.zip</code> </pre> <br>  It turns out that the code and resources in the apk file are also stored in separate binaries, and they will need some other software to extract them.  apktool implicitly got classes bytecode, resources, and laid it all out in a natural file hierarchy.  You can proceed. <br><br><pre> <code class="bash hljs">‚îú‚îÄ‚îÄ AndroidManifest.xml ‚îú‚îÄ‚îÄ apktool.yml ‚îú‚îÄ‚îÄ lib ‚îÇ   ‚îî‚îÄ‚îÄ arm64-v8a ‚îú‚îÄ‚îÄ original ‚îÇ   ‚îú‚îÄ‚îÄ AndroidManifest.xml ‚îÇ   ‚îî‚îÄ‚îÄ META-INF ‚îú‚îÄ‚îÄ res ‚îÇ   ‚îú‚îÄ‚îÄ anim ‚îÇ   ‚îú‚îÄ‚îÄ color ‚îÇ   ‚îú‚îÄ‚îÄ drawable ‚îÇ   ‚îú‚îÄ‚îÄ layout ‚îÇ   ‚îú‚îÄ‚îÄ layout-watch-v20 ‚îÇ   ‚îú‚îÄ‚îÄ mipmap-anydpi-v26 ‚îÇ   ‚îú‚îÄ‚îÄ values ‚îÇ   ‚îî‚îÄ‚îÄ values-af ‚îú‚îÄ‚îÄ smali ‚îÇ   ‚îú‚îÄ‚îÄ android ‚îÇ   ‚îú‚îÄ‚îÄ butterknife ‚îÇ   ‚îú‚îÄ‚îÄ com ‚îÇ   ‚îú‚îÄ‚îÄ net ‚îÇ   ‚îî‚îÄ‚îÄ org ‚îî‚îÄ‚îÄ unknown   ‚îî‚îÄ‚îÄ org</code> </pre> <br>  We see a similar hierarchy (left its simplified version) and try to understand where to start.  It is worth noting that I once wrote a couple of small Android applications, so the essence of the part of the directories and, in general, the principles of the Android device, I understand something about. <br><br>  For a start, I decide to just walk through the files.  I open AndroidManifest.xml and start to read meaningfully.  My attention is attracted by a strange attribute. <br><br><pre> <code class="xml hljs">android:supportsRtl="true"</code> </pre> <br>  It turns out that he is responsible for the support of languages ‚Äã‚Äãwith the letter "from right to left" in the application.  Getting started, strain.  Not good. <br><br>  Then my eyes cling to the folder "unknown".  Under it is a hierarchy of the form: <b>org.apache.commons.codec.language.bm</b> and a huge number of text files with obscure content.  We google the full name of the package and find out what is stored here, something related to the search algorithm for words phonetically similar to the given one.  Frankly, here I began to strain more.  A little poking through the directories, I actually found the code itself, and then the most interesting began.  I was met not by the usual Java bytecode, with which I once had time to play, but something else.  Very similar, but different. <br><br>  As it turned out, Android has its own virtual machine - Dalvik.  And, like every respected virtual machine, it has its own bytecode.  It seems that on the first attempt to solve this problem, it was on that sad note that I announced an intermission, bowed, lowered the curtain and threw it all the same for 4 months until my curiosity finally finished. <br><br><h2>  Roll up sleeves [2] </h2><br>  ‚ÄúIsn't it possible to make everything easier?‚Äù - that is the question I asked myself when I started the task a second time.  I started searching the Internet for a decompiler from smali to Java.  I saw only that this process is unequivocally impossible to perform.  Frowning a little, I went to Github and drove a couple of key phrases into the search box.  The first caught <a href="https://github.com/AlexeySoshin/smali2java">smali2java</a> . <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> gradle build java -jar smali2java.jar ..</code> </pre> <br>  Errors.  I see a huge structure and errors on several pages of the terminal.  Having read a little into the essence of the content (and restraining emotions on the size of the frame), I find that this tool works on the basis of some described grammar and the byte code that she met clearly does not correspond to it.  I open smali bytecode and see annotations, synthetic methods and other strange constructions in it.  There was no such bytecode in java!  How long?  Delete! <br><br><div class="spoiler">  <b class="spoiler_title">Read more</b> <div class="spoiler_text">  The Dalvik virtual machine (as well as the JVM), as it turned out, is not aware of the existence of such concepts as the inner / outside classes (cheat nested classes), and the compiler generates so-called "synthetic" methods to provide access from the nested class to external fields, for example. <br><br><h4>  As an example: </h4><br>  If the outer class (OuterClass) has a field <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OuterClass</span></span></span><span class="hljs-class"> </span></span>{ List a; ... }</code> </pre> <br>  In order for a private class to access an external class field, the compiler will implicitly generate the following method: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> synthetic java.util.<span class="hljs-function"><span class="hljs-function">List </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OuterClass p1)</span></span></span><span class="hljs-function"> </span></span>{ p1 = p1.a; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p1; }</code> </pre> <br>  Also, due to this ‚Äúunder-the-hood‚Äù kitchen, the work of some other mechanisms provided by the language is achieved. <br><br>  You can start learning more about this question <a href="https://stackoverflow.com/questions/5223268/what-is-the-meaning-of-static-synthetic">from here</a> . </div></div><br>  Does not help.  Swears even, on, seemingly, not a suspicious byte code.  I open the source code of the decompiler, read and see something very strange: even Hindu programmers (with all due respect) would not have written this.  The thought creeps in: not that generated code.  I drop the idea for about 30 minutes, trying to understand what the error is.  COMPLEX.  I open again Github - and the truth, the parser generated on grammar.  And here is the generator itself.  I put it all away and try to come from the other side. <br><br>  <i>It is worth noting that a little later, I still tried to change the grammar and sometimes even the byte code itself, so that the decompiler still managed to digest it.</i>  <i>But even when the bytecode became valid in terms of the grammar of the decompiler, the program simply did not return anything to me.</i>  <i>Open Source ...</i> <br><br>  I leaf through the byte code and stumble upon unknown constants.  Googling, I meet the same in the book on the reverse of Android applications.  I remember that this is just the ID assigned by the compiler's preprocessor, which is assigned to Android application resources (the time constant of writing the code is R. *).  The next half hour is an hour, I briefly examine which registers are responsible for what, in what order the arguments are passed, and generally delve into the syntax. <br><br><h2>  What does this look like? </h2><br><img src="https://lh4.googleusercontent.com/6vy-LnmhLmjl2TnDiAoA632c026jlrPG7zFlclZNXJRdpethXv_iFjRtzwyvQWrqkd1LUKixzHfzXAyDj4c28JAzqVYTmP9uqJTmUYgjJd8Yx5pEDkd0cad34bNg9LYDf3r2jFVj" width="350" height="496" align="left">  I found the layout of the main application window, and already understood what is happening in the application: on the main screen (Activity) there is a RecyclerView (conditionally, a View that can reuse UI objects that are not currently displayed, for memory utilization) with input fields key / value pairs, a couple of buttons that are responsible for adding a new key / value pair to some abstract container, and a button that generates a signature (signature) for this container. <br><br>  Looking at the annotations and watching a certain amount of code suspiciously similar to the generated one, I start to google.  The project uses the ButterKnife library, which allows using annotations to produce <b>inflate () -&gt; bind ()</b> UI elements automatically.  If there are annotations in the class, the ButterKnife annotation processor implicitly creates another binder class like <b>&lt;original_class&gt; __ ViewBinding</b> , which does all the dirty work under the hood.  Actually, I received all this information from only one MainActivity file after manually recreating the similarity of the Java source from it.  Half an hour later, I realized that the annotations of this library can also set callback on actions with buttons and found those key functions that were actually responsible for adding a key / value pair to the container and generating the signature. <br><br>  <i>Of course, in the course of the study, I had to go into the ‚Äúguts‚Äù of various libraries and plug-ins, because even beautiful Lendosa with cook-books do not cover all use-cases and details, which I think is common practice for any ‚Äúreverser‚Äù.</i> <br><br><h2>  Laziness is a programmer's friend </h2><br>  Having spent some time on the second source, I finally got tired and realized that I could not cook porridge like that.  Climbing on Github again, and this time I‚Äôm looking closer.  I find the project <a href="https://github.com/gngsg/Smali2PsuedoJava">Smali2PsuedoJava</a> - the decompiler in "pseudo-Java code".  Even if this utility can at least bring something into a human form, then for me, the author will have a mug of his favorite beer (well, or at least put a star on Github, for starters). <br><br>  And it really works!  Effect on face: <br><br><img src="https://lh6.googleusercontent.com/4yxBPy1Wt7_J7uLey66rp_qHwomfvAW_B1C6g3CsrS0DR73J_U42t4JgobNaGIUXVstTEVIaHriawFfRVZL4IqUEObjCL8RdLUv5VCGKiv_jeAxBclaXZlsMvmFUzFuuuuxfshw7"><br><br><h2>  Meet Cipher.so </h2><br>  A little later, studying the Java pseudo-code of the project and mistrustfully comparing it with the smali bytecode, I find a strange library in the code - Cipher.so.  Googling, I find out that this is a lib for encrypting a set of compile-time values ‚Äã‚Äãinside the APK-archive.  This is usually necessary when the application uses constants of the form: IP addresses, credentials for an external database, tokens for authorization, etc.  - what you can get with the help of reverse-engineering application.  True, the author clearly writes that this project is abandoned, they say, go away.  This is getting interesting. <br><br>  This library provides access to values ‚Äã‚Äãthrough a Java library, where a specific method is the key of interest.  It only stirs my interest, and I begin to climb deeper. <br><br>  In short, what Cipher.so does and how it works: <br><br><ul><li>  The keys and the corresponding values ‚Äã‚Äãare written in the Gradle file of our project. <br></li><li>  all key values ‚Äã‚Äãwill be automatically packaged into a separate dynamic library (.so), which will be generated at compile time.  Yes - yes, it WILL be generated. <br></li><li>  then these keys can be obtained from the Java methods generated by Cipher.so <br></li><li>  After creating the APK, the key names are hashed MD5 (for more sesurnosti, of course) <br></li></ul><br>  Having found the dynamic library I need in the folder with the archive, I proceed to picking it.  To begin with, as an experienced reverser (no) I try to start with a simple one - I decide to look at the section with constants and for interesting lines in an ELF-like binary.  Unfortunately, Mac users have no readelf out of the box, and before the start we say the cherished: <br><br><pre> <code class="bash hljs">brew install binuitls</code> </pre> <br>  And don't forget to set the path to <b>/ usr / local</b> in PATH, because <i>brew</i> is gentlemanly protecting you from anything ... <br><br><pre> <code class="bash hljs">greadelf -p .rodata lib/arm64-v8a/libcipher-lib.so | head -n 15</code> </pre> <br>  We restrict the output to the first 15 lines, otherwise this can lead to a shock to an unprepared engineer. <br><br><img src="https://lh6.googleusercontent.com/-ka6awAjaQ6zTDJ4sogEHaqBEG2QL3il5HTS1M-HchKGBg4hK5qe__lAtEKtcL7CT0i_lhqtiEZYYRsnTpLmbc10hdpVTMcAeRP0bGJE87jUBvtkncNMJ3s5YtjgGXk0duZeHIrY"><br><br>  In lower addresses we notice suspicious lines.  As I found out, studying the sources of Cipher.so, the keys and values ‚Äã‚Äãare put into the usual <b>std :: map:,</b> this gives little information, but we know that in the binary itself, along with the encrypted passwords, there are also obfuscated keys. <br><br>  How are values ‚Äã‚Äãencrypted?  Studying the sources, I discovered that encryption occurs using AES, the standard symmetric encryption system.  So, if there are encrypted values ‚Äã‚Äãhere, then the key should be located nearby ... Without studying for a long time, I came across an issue in the same project with the provocative name <a href="https://github.com/MEiDIK/Cipher.so/issues/30">‚ÄúInsecure key storage: secrets‚Äù</a> .  In it, then, in fact, I learned that the key is stored in clear form in the binary, and found the decryption algorithm.  In the example, the key was at the zero address, and although I understood that the compiler could put it in another place in the binary file‚Äôs .rodata section, I decided that this suspicious unit at the zero address is the key. <br><br>  <b>Attempt # 1: I</b> start deciphering the values ‚Äã‚Äãand consider that the encryption key is the same one.  Mistake.  OpenSSL hints that something is wrong.  After reading a bit of the Cipher.so source code, I understand that if the user does not specify a key when building, then the default key is used - <i>Cipher.so@DEFAULT</i> . <br><br>  <b>Attempt # 2:</b> Error again.  Hmm ... Is it really redefined by this constant?  Making a mistake is quite simple: confusing code written in Gradle, with ‚Äúgone‚Äù formatting.  I check again.  Everything seems to be so. <br><br>  Instead of keys, their MD5 hashes lie, and then I try to try my luck and open a service with rainbow tables.  Voila - one of the keys is the word "password".  There is no second.  It gives us, of course, not much.  Both of these keys are at addresses 240 and 2a2, respectively.  In principle, it is easy to recognize them immediately - 32 characters (MD5). <br><br>  I checked everything again and tried to do the decryption with all the other lines (which are in the lower addresses) as a key for decryption - all in vain. <br>  So, there is some other secret key, the algorithm of actions seems to be correct.  I throw this task aside and try not to bury myself. <br><br>  Having a little rummaged in the container signature algorithm, I still see calls to the Cipher.so library and code that also uses the cryptographic functions of the Java library. <br><br><h2>  Riddle (which I never guessed) </h2><br>  In the function that is responsible for encryption, at the very beginning there is a check for the keys in the container. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] a(java/util/Map p1) { v0 = p1.size() v1 = <span class="hljs-number"><span class="hljs-number">0x0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v0 != <span class="hljs-number"><span class="hljs-number">0</span></span>) goto :cond_0 p1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[v1]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p1; :cond_0 v0 = <span class="hljs-string"><span class="hljs-string">"user"</span></span>; v0 = p1.containsKey(v0) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v0 == <span class="hljs-number"><span class="hljs-number">0</span></span>) goto :cond_1 p1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[v1]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p1; ...</code> </pre><br>  Literally: if there is a key ‚Äúuser‚Äù, then this container is not signed (a zero signature is returned).  A strange feeling: the problem seems to have been solved, but it seems suspiciously simple and somehow.  Then why invent everything else?  To knock off the easy way?  Then why haven't I learned fluently this code before?  Hmm ... <br><br>  No, not right.  I clarified the answer from a certain user in a blue messenger, whose contacts I provided when issuing a task.  We dig further.  Perhaps the key / value input set somehow changes as it is added to the container?  I read the code more carefully. <br><br>  I draw your attention that the decompiler removed the annotations from the smali code.  And what if he removed something important?  I check the main files - like, nothing substantial.  Everything is important in its place, and the meaning is not lost.  I check callback functions that are responsible for writing a key / value pair from conditional TextBox to internal containers.  I did not find anything criminal. <br><br>  I became skeptical about every line of code - I can no longer trust anyone. <br><br>  Simple solution # 2: I noticed that the signing procedure begins with checking for the presence of some value (substrings in a string) in the signature of the certificate with which the application was signed. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@OnClick</span></span> <span class="hljs-comment"><span class="hljs-comment">//   protected void huvot324yo873yvo837yvo() { String signature = "no data"; boolean result = some_packages.isKeyInSignature(this); if result { Map map = new HashMap(); ...</span></span></code> </pre> <br>  The value itself, of course, lies encrypted in that same ill-fated binar.  And actually, if this value is not in the signature, then the algorithm will not sign anything, but simply return the string ‚Äúno data‚Äù, as a signature ... Again, we‚Äôll take on Cipher ... <br><br><h2>  Final fight with key decryption </h2><br>  To understand the scale of the tragedy, I was so confused: <br><br>  I made a hex dump of this section and looked at the first two lines, suspicions from which did not fall from the very beginning. <br><br><img src="https://lh4.googleusercontent.com/J4lmChj6kk0lWWy23D8QngSgnJlNfd-xDP1XyBnw1wyQ_U1NBRLYyx2BFZ4y9D1HXEjcSeCKVvZC3xgVCpx-VSV0bIHD5dcmsfdaX4jrmH-uRFsRMc9VJrqpUEMDEEaijeSTPRbk"><br><br>  If you pay attention, the character that separates the lines here is '0x00'.  It is also usually used by the standard C library, in functions for working with strings.  From that no less interesting, what is the space character in the middle of the first line?  Further insane attempts begin, where the keys are: <br><br><ul><li>  whole first line <br></li><li>  first line before the space <br></li><li>  first line with a space to the end <br></li><li>  ... <br></li></ul><br>  The degree of paranoia can already be assessed.  When you do not understand how difficult and cunning the task should be, then you begin to be driven.  And yet, not that.  Then the thought comes to my mind: ‚ÄúDoes the algorithm correctly work out the issue on my machine?‚Äù.  In general, the sequence of actions there is logical and did not cause any questions, but the question is: do the commands on my machine do what is required of them?  So what do you think? <br><br>  Checking all the steps manually, it turned out that <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"some_base64_input"</span></span> | openssl base64 -d</code> </pre> <br>  on some input arguments it suddenly returns an empty string.  Hmm. <br><br>  Replacing it with the first base64 decoder on the machine, and sorting through the main candidates, a suitable key was immediately detected, and the keys were decoded accordingly. <br><br><h2>  Get signature from certificate </h2><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isKeyInSignature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(android.content.Context p1)</span></span></span><span class="hljs-function"> </span></span>{ v0 = <span class="hljs-number"><span class="hljs-number">0x0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> TRY_0{ v1 = p1.getPackageManager() p0 = p1.getPackageName() v2 = <span class="hljs-number"><span class="hljs-number">0x40</span></span>; <span class="hljs-comment"><span class="hljs-comment">// GET_SIGNATURES PackageInfo p0 = v1.getPackageInfo(p0, v2) android.content.pm.Signature[] p0 = p0.signatures; // Order are not guaranteed v1 = p0.length; v2 = 0x0; :goto_0 if (v2 &gt;= v1) goto :cond_1 v3 = p0[v2]; String v3 = v3.toCharsString() String v4 = net.idik.lib.cipher.so.CipherClient.a() v3 = v3.contains(v4) }TRY_0 catch TRY_0 (android/content/pm/PackageManager$NameNotFoundException) goto :catch_0; if (v3 == 0) goto :cond_0 p1 = 0x1; return p1; :cond_0 v2 = v2 + 0x1; goto :goto_0 :catch_0 p0 = Thrown Exception p1.printStackTrace() :cond_1 return v0; }</span></span></code> </pre> <br>  Here is what the generated pseudocode looks like, after my minor edits.  Confused a couple of things: <br><br><ul><li>  poor knowledge of cryptography and "kitchen" device certificates <br></li><li>  according to the documentation, this method does not guarantee the order of the certificates in the returned collection, and accordingly, they would not be able to go round in the same order in the same order ‚Äî what if the application was signed by more than one certificate? <br></li><li>  lack of knowledge how to extract the certificate from the APK, given that it is unclear what the Android Runtime does in this case <br></li></ul><br>  I had to delve into all these questions and the result was the following: <br><br><ul><li>  the certificate itself is in the <i>original / META-INF / CERT.RSA directory</i> <i><br></i> <br>  there is only one file in this directory with this extension - it means that the application is signed with just one certificate <br></li><li>  On the website about research engineering Android applications, a listing was found that can extract the signature we need in the way that Android itself does.  According to the author, at least. <br></li></ul><br>  By running this code, I can figure out the signature, and in fact, the key we need is a substring.  Go ahead.  Simple solution # 2 is swept away. <br><br>  And the truth is, the key is in the certificate, it remains only to understand what's next, because if we have the key ‚Äúuser‚Äù, we still get a zero signature, and as we learned above, this is the wrong answer. <br><br><h2>  Write the documentation carefully! </h2><br>  Further studies to ensure that data entered from text fields change, are discarded due to lack of evidence.  Paranoia rolls on with a new power: maybe the code that pulled the signature from the certificate is incorrect or is it the implementation of the code for old Android releases?  I open the documentation again and see the following: ( <a href="https://developer.android.com/reference/android/content/pm/Signature.html">https://developer.android.com/reference/android/content/pm/Signature.html#toChars ()</a> ): <br><br><img src="https://lh5.googleusercontent.com/1TZ3rj6hzTEWw5YHEl1EWnANjsiqpzGR-tTrXP_Nc6jt42ANPf1QW-fmP-mh7Y2MhgMcZF0Z8CpskzT_ge65C0YCcryiWjjpG0UuPeqkUCsde1qcQgm5NbeqFj4KO3QkdtvHM3v2"><br><br>  <b>Note: the</b> function encodes the signature as ASCII text.  In the output I was getting above, there was a hex representation of the data.  It seemed to me that the API was strange, but if you believe the documentation, it turns out that I was again driven into a dead end, and the encrypted key is not a substring of the signature.  After sitting thoughtfully over the code for some time, I could not stand it and opened the source code for this class.  <a href="">https://android.googlesource.com/platform/frameworks/base/+/e639da7/core/java/android/content/pm/Signature.java</a> <br><br>  The answer was not long in coming.  And actually, in the code itself - an oil painting: the output format is a regular hex string.  And think: either I don‚Äôt understand something, or the documentation is written ‚Äúslightly‚Äù incorrectly.  Having quarreled in nowhere, I again set to work. <br><br><h2>  Total </h2><br>  The following n hours have passed for: <br><br><ul><li>  checking the correctness of work in the code with RecyclerView and clarifying its behavior through the source code, since<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> again, not all moments are covered in detail in the dock and even on StackOverflow </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">manual decompiling of the code fragment responsible for signing the collection into compiled Java. </font><font style="vertical-align: inherit;">I took it for the assumption that I missed something after all and the first key in the container (‚Äúuser‚Äù) implicitly leaves the collection. </font><font style="vertical-align: inherit;">I decided to set the rest of the data on the code.</font></font><br></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In general, this code refused to sign even the remaining arguments (further in the code when working with cryptography, these arguments implicitly threw me out of the distance). </font></font><br><br>  Not.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It turned out that you cannot sign these inputs. Unfortunately, it‚Äôs impossible to pass this work and find out whether it really is so. It's a pity. For a while it took my mind, but I reassured myself that I did everything I could. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In fact, I spent a lot of time on this task, and at the same time on the restoration of gaps in knowledge. It was really helpful. One can trace the whole path and pay attention to how at first I clung to absolutely unrelated details. Perhaps, it will help someone to realize how newcomers solve problems of this kind, because we usually read ‚Äúsuccess stories‚Äù, where all steps are logical, consistent and lead to the correct result.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If someone wants to try to pick it up with this puzzle a little more or ask a question - write me in blue </font></font><a href="https://habr.com/ru/users/arturbrsg/" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arturbrsg</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> messenger </font><font style="vertical-align: inherit;">.</font></font><br><br>  Stay tuned. </div><p>Source: <a href="https://habr.com/ru/post/450394/">https://habr.com/ru/post/450394/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../450372/index.html">How Amazon's algorithms determine who should fire</a></li>
<li><a href="../450374/index.html">RAM Expansion Board for Apple IIgs</a></li>
<li><a href="../45038/index.html">Test regular expressions in OnLine</a></li>
<li><a href="../450384/index.html">History of a little study of legacy code</a></li>
<li><a href="../450386/index.html">Interfaces as abstract data types in Go</a></li>
<li><a href="../450398/index.html">The most fearless poisons</a></li>
<li><a href="../4504/index.html">Pensioners are being introduced into social networks</a></li>
<li><a href="../45040/index.html">Wonders of automation or how real geeks send SMS</a></li>
<li><a href="../45041/index.html">Work with ANSI console</a></li>
<li><a href="../450410/index.html">Terraformer - Infrastructure To Code</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>