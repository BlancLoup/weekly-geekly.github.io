<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We assemble your first WebAsse assembly component</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When I first heard about WebAssembly technology, it immediately seemed like a cool thing to me and I immediately wanted to try it out. From the first ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We assemble your first WebAsse assembly component</h1><div class="post__text post__text-html js-mediator-article">  When I first heard about <a href="https://webassembly.github.io/">WebAssembly</a> technology, it immediately seemed like a cool thing to me and I immediately wanted to try it out.  From the first desire, to something working, however, I had to spend a lot of time and sometimes experience some disappointments.  In order to save your time and your nerves, if you want to repeat the same way, this article is written. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d8a/461/a90/d8a461a9052739e0a937c6fe7cf19de8.jpg" alt="image"><br><h5>  Warning reader </h5><br>  This article was written on June 24th, 2016.  Since WebAssembly is a very young and dynamic technology, with time, many of the things described in this article will become obsolete or change completely - keep this in mind. <br><br>  And now let's go. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  What is WebAssembly? </h5><br>  Official documentation says the following: ‚ÄúWebAssembly or wasm is a new portable, efficient in size and download speed compilation format for the web.‚Äù  Ummmmmm ... What?  What format?  Text or binary?  Yes, this is frankly a bad description.  So remove your bazo-bingo cards and I, based on my experience, will give my definition: <br><br>  "WebAssembly or wasm is the bytecode specification for writing productive, browser-independent components for the web."  This definition, too, of course, is not the top of the epistolary genre, but I will try to complement it.  WebAssembly allows you to improve performance by using statically typed variables that cost significantly faster on runtime than dynamic ones.  WebAssembly is being developed by the <a href="https://www.w3.org/community/webassembly/">W3C Community Group</a> and is planned to be implemented in all major browsers.  And from this point on, the killer feature is laid out on the table: you can write the code of web components in any programming language. <br><br>  Now it sounds better, right? <br><a name="habracut"></a><br><h5>  Let's start </h5><br>  When I learn a new thing, I usually look for the smallest possible example, enough to see how everything works.  Unfortunately, this approach is not very possible with WebAssembly.  In its current state, the wasm specification is simply a bytecode format.  Imagine how in some 1996th year, Sun Microsystems engineers would have introduced the JVM ... but without Java.  The conversation would go something like this: <br><br>  "- Hey, you all, check out what a cool machine we have created for baytkod! <br>  - Cool!  And how to write code for it? <br>  - That's how: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/983/c8a/ab0/983c8aab0357bfec10559ac092d3fab1.png" alt="image"><br><br>  ‚ÄúUmmmmmh ... cool ... I'll try it sometime at leisure. <br>  ‚ÄúFine, let us know if there are any problems or ideas!‚Äù <br>  - Yes Yes.  But I'm a little busy here, you need to look at a few other things ... But as soon as - so immediately! " <br><br>  And even this is a bad example, since the JVM is at least based on the Java language, and with WebAssembly we don‚Äôt have that either.  I hope you get the idea.  If you represent bytecode without a tool that compiles the code of some programming language into this bytecode, it will be difficult for you to promote it.  So how do we still start working with WebAssembly? <br><br><h5>  What happened to WebAssembly? </h5><br>  Most technologies are the result of the development of some previous technologies, especially when the planned goal is to obtain some formal specification.  WebAssembly is not an exception, it is a continuation of the development of ideas embodied once in asm.js, a specification designed for writing javascript code in such a way that it can be compiled with static typing.  Wasm developed these ideas by creating a bytecode specification that can be created by the compiler of any programming language, then sent over the Internet as a binary file, suitable for execution by any modern browser. <br><br>  asm.js is just a specification for writing javascript code using a subset of Javascript features.  You can write the code in asm.js manually and if you can not wait to take and write something - it's time to start. <br><br><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyMathModule</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">global</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-string"><span class="hljs-string">"use asm"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> exp = global.Math.exp; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doubleExp</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value</span></span></span><span class="hljs-function">) </span></span>{ value = +value; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> +(+exp(+value) * <span class="hljs-number"><span class="hljs-number">2.0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">doubleExp</span></span>: doubleExp }; }</code> </pre> <br>  This is not a very useful feature, but it is written according to the asm.js specification.  If it looks a little silly for you - so know that you are not the only one who thinks so.  However, all these "strange" symbols (all these unary operators) are necessary.  They point the compiler to the data types in the operations.  The code is very simple, but if you make a mistake somewhere, the debug console will show a fairly readable error message. <br><br>  If you want to use this function, you can do it something like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> myMath = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyMathModule(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>; i++) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(myMath.doubleExp(i)); }</code> </pre><br>  And if you did everything right, then you should see something like this at the output: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1a0/60d/433/1a060d4330136354dacac2e79e27e04e.png" alt="image"><br><br><h5>  Finally, go to WebAssembly </h5><br>  At the moment we have a working piece of code on asm.js.  We can go to the <a href="https://github.com/WebAssembly/binaryen">official WebAssembly page</a> on GitHub and find there tools to compile this code into wasm.  The only trouble is that we will have to assemble these tools on our own.  This is, frankly, the worst part of the quest.  These tools are constantly changing and are in broken condition from time to time, especially in terms of using them under Windows. <br><br>  You need make and cmake to build.  If you are working under Windows, you will also need Visual Studio 2015. Here are <a href="https://github.com/WebAssembly/binaryen">instructions</a> for building on Mac, but on Windows. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d2d/04d/0b6/d2d04d0b6f40c44d625cfcc2c1354e57.png" alt="image"><br><br>  It should be noted that the distribution of the collected binaries of these utilities would be a huge step forward in promoting the WebAssembly technology. <br><br>  If you went through all of the above without any problems, you got the bin folder in the binaryen folder, where the tools for converting our asm.js code to wasm are located.  The first tool is called asm2wasm.exe.  It converts the code in asm.js to the .s code format, which is a textual representation of the abstract syntax tree (AST) of the wasm format.  By running asm2wasm on your asm.js code, you will get something like this: <br><br> <code>(module <br> (memory 256 256) <br> (export "memory" memory) <br> (type $FUNCSIG$dd (func (param f64) (result f64))) <br> (import $exp "global.Math" "exp" (param f64) (result f64)) <br> (export "doubleExp" $doubleExp) <br> (func $doubleExp (param $0 f64) (result f64) <br> (f64.mul <br> (call_import $exp <br> (get_local $0) <br> ) <br> (f64.const 2) <br> ) <br> ) <br> ) <br></code> <br>  You can parse this code line by line, but now I just want to emphasize that since wasm is a binary format, just clicking on the browser on something and seeing the code, as you used to do it with Javascript, will not work (at least for now). moment).  What you see will be very similar to the code above. <br><br>  The next step is to convert this .s format to a wasm binary, for this we will use the wasm-as.exe utility.  Applying it to your output .s-file, you will get a bytecode, for which we started this whole story. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/280/008/4ef/2800084ef9d7ede5e11c2829c30486ff.png" alt="image"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/45f/18b/589/45f18b589ba5e263f668c10faf547f2b.png" alt="image"><br><br>  Now grab the latest version of Firefox or Chrome Canary and enable WebAssembly. <br><br>  For Firefox, you need to open about: config and type "wasm" in the search bar.  After that, change the value of the javascript.options.wasm option to true and restart the browser.  For Chrome Canary, you need to open chrome: // flags, find and enable the Experimental WebAssembly option, and then restart the browser. <br><br>  Now we need to run our module in the browser.  For me, this at first turned out to be a problem, since it is not at all obvious how to do this.  I opened the console in Chrome Canary and tried to type "WebAsse" - and nothing, no tips.  Then I typed "Was" and got a hint!  This object in the inspector looked very poor in terms of documentation.  I will omit the whole story about how I rummaged in search of a working example, I will only say that in the end I found it in some <a href="">JS.md</a> file in the WebAssembly repository.  There was something like documentation and an example, here it is: <br><br><pre> <code class="javascript hljs">fetch(<span class="hljs-string"><span class="hljs-string">"my-math-module.wasm"</span></span>) .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response.arrayBuffer(); }) .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">buffer</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dependencies = { <span class="hljs-string"><span class="hljs-string">"global"</span></span>: {}, <span class="hljs-string"><span class="hljs-string">"env"</span></span>: {} }; dependencies[<span class="hljs-string"><span class="hljs-string">"global.Math"</span></span>] = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.Math; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> moduleBufferView = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>(buffer); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> myMathModule = Wasm.instantiateModule(moduleBufferView, dependencies); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(myMathModule.exports.doubleExp); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>; i++) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(myMathModule.exports.doubleExp(i)); } });</code> </pre><br>  Drop it into your html file, raise the local web server and open this file in the browser.  Here is what it will look like: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3c7/730/b40/3c7730b404c6c12e90a8a06a564751ac.png" alt="image"><br><br>  It's time to go send a bug report.  Remember that this is still a very raw and experimental technology, so do not be surprised at the bugs arising along the way. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/eb8/e10/e72/eb8e10e720b34ba2c55ca0cd1a6c9060.png" alt="image"><br><h5>  Congratulations! </h5><br>  You have created your first WebAsse installation component.  What's next?  Well, we have only slightly discarded the covers of mystery.  Writing asm.js code was the key to this example, and writing any non-trivial functionality will take time and patience.  Using emscripten, compiling non-trivial applications in asm.js becomes much easier.  I advise you to read the asm.js specification, especially the section on the memory model, since many concepts have been transferred to WebAssembly directly from asm.js.  One more important point: at the moment you cannot pass arrays as function arguments.  There is some agreement that this should change, but so far this is not reflected in the specification.  It's time to refresh the memory of working with pointers. <br><br>  Another caveat: when you start writing non-trivial things on wasm, you may notice that performance can sometimes be slower than good old Javascript.  Just keep in mind that modern Javascript engines in all browsers are very highly optimized and it will take some time for wasm to achieve their effectiveness.  The theoretical performance limit of WebAssembly is higher than that of Javascript code in text form, but WebAssembly is not yet ready for industrial use. </div><p>Source: <a href="https://habr.com/ru/post/304362/">https://habr.com/ru/post/304362/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../304352/index.html">5 rules for working with tickets</a></li>
<li><a href="../304354/index.html">Php tools for japanese</a></li>
<li><a href="../304356/index.html">51 tools for APM and server monitoring</a></li>
<li><a href="../304358/index.html">Lenovo server set six world records</a></li>
<li><a href="../304360/index.html">Gamified Generation</a></li>
<li><a href="../304366/index.html">Desktop CRM. We have to talk</a></li>
<li><a href="../304370/index.html">20,000 real leads by email. How to do it? Personal experience</a></li>
<li><a href="../304372/index.html">Secrets of good photos for the site: a mini-guide on the types of commercial shooting</a></li>
<li><a href="../304374/index.html">Creating an OSSIM plugin to collect logs from the database</a></li>
<li><a href="../304378/index.html">We work with a budget institution. Part 3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>