<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cross a hedgehog (Marathon) with a snake (Spring Cloud). Episode 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first episode , we managed to pull information from Mesos Marathon straight into the bins of Spring Cloud . However, we had the first problems,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cross a hedgehog (Marathon) with a snake (Spring Cloud). Episode 2</h1><div class="post__text post__text-html js-mediator-article"><p>  In the <a href="https://habrahabr.ru/post/325714/">first episode</a> , we managed to pull information from <strong>Mesos Marathon</strong> straight into the bins of <strong>Spring Cloud</strong> .  However, we had the first problems, one of which we will examine in the current part of the story.  Let's recall our connection configuration to <strong>Marathon</strong> : </p><br><pre><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">spring</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">cloud</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">marathon</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">scheme</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">http</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#url</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">scheme</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">host</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">marathon</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#marathon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">host</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">port</span></span>: 8080 <span class="hljs-selector-id"><span class="hljs-selector-id">#marathon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">port</span></span></code> </pre> <br><p>  What problems do we see here?  The first is that we have no authorization when connecting, which is strange for industrial use.  The second is that we can specify only one host and port.  In principle, it would be possible to try several masters for one balancer or DNS, but I would like to avoid this additional point of failure.  How to do this is written under the cut. </p><a name="habracut"></a><br><h2 id="parol-vsemu-golova">  Password all head </h2><br><p>  There are two authorization schemes available to us: <strong>Basic</strong> and <strong>Token</strong> .  Basic authorization is so trivial that almost every developer has met with it.  Its essence is painfully simple.  We take the login and password.  We glue them through <code>:</code>  We encode in Base64.  Add an <code>Authorization</code> header with the value <code>Basic &lt;Base64&gt;</code> .  Profit </p><br><p>  With a token is somewhat more complicated.  In the open-source implementation, it is not available, so this method is suitable for those who use <strong>DC / OS</strong> .  To do this, just add a slightly different authorization header: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Authorization</span></span>: token=&lt;auth_token&gt;</code> </pre> <br><p>  Thus, we can add several properties we need to our configuration: </p><br><pre> <code class="hljs mel"><span class="hljs-keyword"><span class="hljs-keyword">spring</span></span>: cloud: marathon: ... token: dcos_acs_token username: marathon password: mesos</code> </pre> <br><p>  And then we can be guided by simple priorities.  If a token is specified, then we take it.  Otherwise, we take the login and password and do the basic-authorization.  Well, in the absence of both, we create a ‚Äúnaked‚Äù client. </p><br><pre> <code class="java hljs">Feign.Builder builder = Feign.builder() .encoder(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GsonEncoder(ModelUtils.GSON)) .decoder(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GsonDecoder(ModelUtils.GSON)) .errorDecoder(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MarathonErrorDecoder()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!StringUtils.isEmpty(token)) { builder.requestInterceptor(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TokenAuthRequestInterceptor(token)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!StringUtils.isEmpty(username)) { builder.requestInterceptor(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicAuthRequestInterceptor(username,password)); } builder.requestInterceptor(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MarathonHeadersInterceptor()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> builder.target(Marathon.class, baseEndpoint);</code> </pre> <br><p>  The client for <strong>Marathon is</strong> implemented using the <a href="https://github.com/OpenFeign/feign"><strong>Feign</strong></a> http client, to which you can easily add any <strong>interceptors</strong> .  In our case, they add the necessary http headers to the request.  After this, the <strong>builder</strong> constructs an object for us on the interface, in which possible requests are declaratively declared: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Marathon</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Apps @RequestLine("GET /v2/apps") GetAppsResponse getApps() throws MarathonException; //Other methods }</span></span></code> </pre> <br><p>  So, the warm-up is over, now let's do a more difficult task. </p><br><h2 id="otkazoustoychivyy-klient">  Failover Client </h2><br><p>  If we have an industrial installation of <strong>Mesos-a</strong> and <strong>Marathon</strong> -a, then the number of masters from which we can read data will be more than one.  Moreover, one of the masters may accidentally be unavailable, slow down, or be able to upgrade.  Failure to obtain information will either lead to obsolescence of information on customers, and, therefore, at some point to shots into the milk.  Or, let's say when updating the application software, we will not get a list of instances at all and will refuse to service the client.  All this is not good.  We need client request balancing. </p><br><p>  It is logical that <a href="https://github.com/Netflix/ribbon"><strong>Ribbon</strong></a> should be selected as a candidate for this role, as it is used in client-side balancing of requests within <strong>Spring Cloud</strong> .  We will talk more about strategies for balancing requests in the following episodes, but for now we will limit ourselves to the most basic functionality that we need to solve a problem. </p><br><p>  The first thing we need to do is to implement the balancer in our <strong>feign</strong> client: </p><br><pre> <code class="java hljs">Feign.Builder builder = Feign.builder() .client(RibbonClient.builder().lbClientFactory(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MarathonLBClientFactory()).build()) ...;</code> </pre> <br><p>  Looking at the code begs a logical question.  What is <strong>lbClientFactory</strong> and why are we doing our own?  In short, this factory constructs a client request balancer.  By default, the created client is deprived of one feature we need: a repeated request in case of problems on the first request.  To be able to <strong>retry</strong> , we will add it when constructing an object: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MarathonLBClientFactory</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LBClientFactory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> LBClient </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String clientName)</span></span></span><span class="hljs-function"> </span></span>{ LBClient client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LBClientFactory.Default().create(clientName); IClientConfig config = ClientFactory.getNamedConfig(clientName); client.setRetryHandler(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultLoadBalancerRetryHandler(config)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client; } }</code> </pre> <br><p>  Do not be afraid that our <strong>retry</strong> handler has the <strong>Default</strong> prefix.  Inside it is everything that we need.  And here we come to the configuration of all this stuff. </p><br><p>  Since we can have several clients in the application, and the client for <strong>Marathon is</strong> only one of them, the settings have a specific template of the form: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">client_name</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ribbon</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.property_name</span></span></code> </pre> <br><p>  In our case: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">marathon</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ribbon</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.property_name</span></span></code> </pre> <br><p>  All properties for the client balancer are stored in the configuration manager - <a href="https://github.com/Netflix/archaius"><strong>Archarius</strong></a> .  In our case, these settings will be stored in memory, because we add them on the fly.  To do this, in our modified client, add a helper method <code>setMarathonRibbonProperty</code> , inside which we will set the value of the property: </p><br><pre> <code class="java hljs">ConfigurationManager.getConfigInstance().setProperty(MARATHON_SERVICE_ID_RIBBON_PREFIX + suffix, value);</code> </pre> <br><p>  Now, before creating the <strong>feign</strong> client, we need to initialize these settings: </p><br><pre> <code class="java hljs">setMarathonRibbonProperty(<span class="hljs-string"><span class="hljs-string">"listOfServers"</span></span>, listOfServers); setMarathonRibbonProperty(<span class="hljs-string"><span class="hljs-string">"OkToRetryOnAllOperations"</span></span>, Boolean.TRUE.toString()); setMarathonRibbonProperty(<span class="hljs-string"><span class="hljs-string">"MaxAutoRetriesNextServer"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); setMarathonRibbonProperty(<span class="hljs-string"><span class="hljs-string">"ConnectTimeout"</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); setMarathonRibbonProperty(<span class="hljs-string"><span class="hljs-string">"ReadTimeout"</span></span>, <span class="hljs-number"><span class="hljs-number">300</span></span>);</code> </pre> <br><p>  What is there interesting.  First is the <code>listOfServers</code> .  In fact, this is an enumeration of all possible <code>host:port</code> pairs on which the <strong>Marathon</strong> -a masters are located, separated by commas.  In our case, we simply add the ability to specify them in our configuration: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">spring</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">cloud</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">marathon</span></span>: ... <span class="hljs-selector-tag"><span class="hljs-selector-tag">listOfServers</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">m1</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:8080</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">m2</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:8080</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">m3</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:8080</span></span></code> </pre> <br><p>  Now each new request to the master will go to one of these three servers. </p><br><p>  In order for <strong>retry</strong> to work at all, we must set the value of <code>OkToRetryOnAllOperations</code> to <code>true</code> . </p><br><p>  We set the maximum number of repetitions using the <code>MaxAutoRetriesNextServer</code> option.  Why does it have an indication for <strong>NextServer</strong> ?  It's simple.  Because there is another option <code>MaxAutoRetries</code> , which indicates how many times you need to try to re-call the first server (the one that was selected for the very first request).  By default, this property is set to <code>0</code> .  That is, after the first failure, we will go to ask for the data from the next candidate.  It is also worth remembering that <code>MaxAutoRetriesNextServer</code> indicates the number of attempts minus attempts to request data from the first server. </p><br><p>  Well, in order not to hang on the line indefinitely, we set the <code>ConnectTimeout</code> and <code>ReadTimeout</code> properties within reasonable limits. </p><br><h2 id="itogo">  Total </h2><br><p>  In this part we have made our client to <strong>Marathon</strong> more customizable and fault tolerant.  And taking advantage of ready-made solutions, we did not have to make too many gardens.  But we are still far from the completion of the work, because we still do not have the most interesting part of the ballet - client balancing requests for application software. </p><br><h4 id="prodolzhenie-sleduet">  To be continued </h4></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/327937/">https://habr.com/ru/post/327937/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../327910/index.html">Functional security, part 7 of 7. Methods of ensuring information and functional security</a></li>
<li><a href="../327912/index.html">RMarkdown, R and ggplot</a></li>
<li><a href="../327913/index.html">Typing a technical interview</a></li>
<li><a href="../327931/index.html">The recipe for the perfect Habropost</a></li>
<li><a href="../327933/index.html">CocoaConf DC 2016: Swift server side</a></li>
<li><a href="../327939/index.html">Again on the use of photos from the Internet. Supreme Court allowed?</a></li>
<li><a href="../327943/index.html">Splunk Machine Learning Toolkit Overview</a></li>
<li><a href="../327947/index.html">Part 2. Where to store data for decentralized applications on the blockchain?</a></li>
<li><a href="../327951/index.html">Video for Google Play: interface, animation or video?</a></li>
<li><a href="../327953/index.html">10 mandatory features of the new generation firewall</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>