<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Launch fractal snowflakes on HTML5 Canvas</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pre-Christmas entertainment on HTML5 Canvas to decorate the site with snowflakes (well, just an interesting example to see how Canvas works). 

 In my...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Launch fractal snowflakes on HTML5 Canvas</h1><div class="post__text post__text-html js-mediator-article">  Pre-Christmas entertainment on HTML5 Canvas to decorate the site with snowflakes (well, just an interesting example to see how Canvas works). <br><br>  In my story, I will build on <a href="http://blogs.msdn.com/b/giorgio/archive/2010/12/13/html5-snow-falling-on-my-blog.aspx">the</a> <a href="http://blogs.msdn.com/members/gisardo/">Giorgio Sardo</a> <a href="http://blogs.msdn.com/b/giorgio/archive/2010/12/13/html5-snow-falling-on-my-blog.aspx">code</a> , which in turn is based on <a href="http://www.davidflanagan.com/2010/12/let-it-snow.html">the David Flanagan code</a> . <br><br><img src="https://habrastorage.org/storage/3aadad5f/f30d83b7/18c99985/0b7a224e.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Everything that is described below, you can try directly here, on Habr√© in any modern browser with development tools, simply by running the JavaScript console.  In IE9, just press F12 and, if you want to test directly on this page, do not forget to switch the browser to Internet Explorer 9 Standards (Alt + 9), since  by default, Habr requires IE8 mode. <a name="habracut"></a><br><br><h4>  Check Canvas Support </h4><br><br>  First of all, you need to start with the fact that you need to make sure that the browser supports Canvas, for this you need to create a Canvas element and try to get to the work context: <br><br><blockquote><code><font color="#000000"><font color="#0000ff">if</font> ( <font color="#0000ff">document</font> .createElement( <font color="#a31515">'canvas'</font> ).getContext) { <br> ... <br> } <br> <font color="#0000ff">else</font> { <br> ... <br> }</font></code> </blockquote> <br><br>  In the first case, you can move on and run the snowflakes. <br><br><h4>  Create canvas </h4><br><br>  To draw snowflakes, we will create a canvas (full canvas): <br><br><blockquote> <code><font color="#000000"><font color="#0000ff">var</font> canvas = <font color="#0000ff">document</font> .createElement( <font color="#a31515">'canvas'</font> ); <br> canvas.style.position = <font color="#a31515">'fixed'</font> ; <br> canvas.style.top = <font color="#a31515">'0px'</font> ; <br> canvas.style.left = <font color="#a31515">'0px'</font> ; <br> canvas.style.zIndex = <font color="#a31515">'-10'</font> ; <br> canvas.width = <font color="#0000ff">document</font> .body.offsetWidth; <br> canvas.height = window.innerHeight; <br> <br> <font color="#0000ff">document</font> .body.insertBefore(canvas, <font color="#0000ff">document</font> .body.firstChild);</font></code> </blockquote> <br><br>  In this case, we create a new Canvas element and assign it a fixed location, trying to place it in such a way that it does not fit the other elements. <br><br>  Next we get the context to draw: <br><br><blockquote> <code><font color="#000000"><font color="#0000ff">var</font> sky = canvas.getContext( <font color="#a31515">'2d'</font> );</font></code> </blockquote> <br><br><h4>  Koch's snowflake </h4><br><br>  I think habrauders should be well aware of what the <a href="http://mathworld.wolfram.com/KochSnowflake.html">Koch Snowflake is</a> , so I will limit myself to a picture: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5c4/20b/961/5c420b96143d7b7de10fa8ed5bbc1fac.gif"><br><br>  This fractal thing is conveniently drawn recursively.  To draw a triangle, you need to apply the same drawing pattern to each of its edges: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d46/276/c8b/d46276c8bb23b49a3f83bc4b8afa61bb.gif"><br><br>  Let's start by trying to draw one line.  When drawing, which is convenient, we can apply <a href="http://www.w3.org/TR/2010/WD-2dcontext-20101019/">transformations</a> (scaling and rotations), at which each local drawing will look like a drawing of a straight horizontal line.  That is, we scale and rotate the context (change the transformation matrix) instead of turning the line drawing. <br><br>  To save and restore the state of the transformation matrix, the save () and restore () functions are used, respectively. <br><br>  In the course of work, we will need to convert degrees to radians (although if you wish, you can write immediately in radians): <br><br><blockquote> <code><font color="#000000"><font color="#0000ff">var</font> deg = Math.PI / 180;</font></code> </blockquote> <br><br>  The recursive function for drawing one edge looks like this: <br><br><blockquote> <code><font color="#000000"><font color="#0000ff">function</font> leg(n, len) { <br> sky.save(); <font color="#008000">//   </font> <br> <font color="#0000ff">if</font> (n == 0) { <font color="#008000">//   -  </font> <br> sky.lineTo(len, 0);  } <br> <font color="#0000ff">else</font> { <br> sky.scale(1 / 3, 1 / 3); <font color="#008000">//    3 </font> <br> leg(n ‚Äì 1, len);           sky.rotate(60 * deg); <br> leg(n ‚Äì 1, len);            sky.rotate(-120 * deg); <br> leg(n ‚Äì 1, len);            sky.rotate(60 * deg);        leg(n ‚Äì 1, len);      } <br> sky.restore(); <font color="#008000">//  </font> <br> sky.translate(len, 0); <font color="#008000">//    </font> <br> }</font></code> </blockquote> <br><br>  To start drawing you can use this function: <br><br><blockquote> <code><font color="#000000"><font color="#0000ff">function</font> drawFlake(x, y, len, n, stroke, fill) { <br> sky.save();  sky.strokeStyle = stroke; <br> sky.fillStyle = fill; <br> sky.beginPath(); <br> sky.translate(x, y); <br> sky.moveTo(0, 0);  leg(n, len);       sky.closePath(); <br> sky.fill(); <br> sky.stroke(); <br> sky.restore(); <br> }</font></code> </blockquote> <br><br>  Please note that for drawing you need to start creating a path, if necessary, close it and only then say what needs to be done to fill the areas and draw the lines.  Result: <br><br><img src="https://habrastorage.org/storage/267a58b7/ef88f62b/5d0133e7/db84cb86.png"><br><br>  If we add a few more edges with the corresponding turns, we get a snowflake: <br><br><blockquote> <code><font color="#000000"><font color="#0000ff">function</font> drawFlake(x, y, len, n, stroke, fill) { <br> sky.save();      sky.strokeStyle = stroke; <br> sky.fillStyle = fill; <br> sky.beginPath(); <br> sky.translate(x, y); <br> sky.moveTo(0, 0);  leg(n, len); <font>sky.rotate(-120 * deg); <br> leg(n, len);       sky.rotate(-120 * deg); <br> leg(n, len);</font> sky.closePath(); <br> sky.fill(); <br> sky.stroke(); <br> sky.restore(); <br> }</font></code> </blockquote> <br><br>  Result: <br><br><img src="https://habrastorage.org/storage/e5bb8b52/df6262c8/12cccbba/3a09a047.png"><br><br><h4>  Creating and moving snowflakes </h4><br><br>  Then the idea is pretty transparent: 1) create a pool of snowflakes by hanging the addition of snowflakes on the timer, 2) change the position of the snowflakes by the timer and draw it. <br><br><h5>  <strong>Adding Snowflakes</strong> </h5><br><br>  Additional function for random values, an array of snowflakes and the maximum number.  Set the timer: <br><br><blockquote> <code><font color="#000000"><font color="#0000ff">var</font> rand = <font color="#0000ff">function</font> (n) { <font color="#0000ff">return</font> Math.floor(n * Math.random()); } <br> <font color="#0000ff">var</font> flakes = []; <font color="#0000ff">var</font> maxflakes = 20; <br> <font color="#0000ff">var</font> snowspeed = 500; <br> <font color="#0000ff">var</font> snowingTimer = setInterval(createSnowflake, snowspeed);</font></code> </blockquote> <br><br>  And the creation of snowflakes itself (at the right moment, the creation of new snowflakes stops cleaning the timer): <br><br><blockquote> <code><font color="#000000"><font color="#0000ff">function</font> createSnowflake() { <br> <font color="#0000ff">var</font> order = 3; <br> <font color="#0000ff">var</font> size = 10 + rand(50); <br> <font color="#0000ff">var</font> x = rand( <font color="#0000ff">document</font> .body.offsetWidth); <br> <font color="#0000ff">var</font> y = window.pageYOffset; <br> <br> flakes.push({ x: x, y: y, vx: 0, vy: 3 + rand(3), size: size, order: order, stroke: <font color="#a31515">"#99f"</font> , fill: <font color="#a31515">"transparent"</font> }); <br> <font color="#0000ff">if</font> (flakes.length &gt; maxflakes) clearInterval(snowingTimer); <br> }</font></code> </blockquote> <br><br><h5>  Moving snowflakes </h5><br><br>  Here an additional variable invalidateMeasure appears, which is set to true when the screen size is changed.  We set the timer to update the position and the actual movement function (clear the screen, update the position -&gt; draw snowflakes). <br><br><blockquote> <code><font color="#000000"><font color="#0000ff">var</font> scrollspeed = 64; <br> setInterval(moveSnowflakes, scrollspeed); <br> <br> <font color="#0000ff">function</font> moveSnowflakes() { <br> sky.clearRect(0, 0, canvas.width, canvas.height); <br> <br> <font color="#0000ff">var</font> maxy = canvas.height; <br> <br> <font color="#0000ff">for</font> ( <font color="#0000ff">var</font> i = 0; i &lt; flakes.length; i++) { <br> <font color="#0000ff">var</font> flake = flakes[i]; <br> flake.y += flake.vy; <br> flake.x += flake.vx; <br> <br> <font color="#0000ff">if</font> (flake.y &gt; maxy) flake.y = 0; <br> <font color="#0000ff">if</font> (invalidateMeasure) { <br> flake.x = rand(canvas.width); <br> } <br> <br> drawFlake(flake.x, flake.y, flake.size, flake.order, flake.stroke, flake.fill); <br> <br> <font color="#008000">//    </font> <br> <font color="#0000ff">if</font> (rand(4) == 1) flake.vx += (rand(11) - 5) / 10; <br> <font color="#0000ff">if</font> (flake.vx &gt; 2) flake.vx = 2; <br> <font color="#0000ff">if</font> (flake.vx &lt; -2) flake.vx = -2; <br> } <br> <font color="#0000ff">if</font> (invalidateMeasure) invalidateMeasure = <font color="#0000ff">false</font> ; <br> }</font></code> </blockquote> <br><br><h4>  Final code </h4><br><br>  Then you can add a few more details: a random turn of the snowflake and a random color of the snowflake + detailing depending on the size: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#000000">( <font color="#0000ff">function</font> () { <br> <font color="#0000ff">if</font> ( <font color="#0000ff">document</font> .createElement( <font color="#a31515">'canvas'</font> ).getContext) { <br> <font color="#0000ff">if</font> ( <font color="#0000ff">document</font> .readyState === <font color="#a31515">'complete'</font> ) <br> snow(); <br> <font color="#0000ff">else</font> <br> window.addEventListener( <font color="#a31515">'DOMContentLoaded'</font> , snow, <font color="#0000ff">false</font> ); <br> } <br> <font color="#0000ff">else</font> { <br> <font color="#0000ff">return</font> ; <br> } <br> <br> <font color="#0000ff">var</font> deg = Math.PI / 180; <br> <font color="#0000ff">var</font> maxflakes = 20; <font color="#0000ff">var</font> flakes = []; <font color="#0000ff">var</font> scrollspeed = 64; <font color="#0000ff">var</font> snowspeed = 500; <br> <font color="#0000ff">var</font> canvas, sky; <br> <font color="#0000ff">var</font> snowingTimer; <br> <font color="#0000ff">var</font> invalidateMeasure = <font color="#0000ff">false</font> ; <br> <br> <font color="#0000ff">var</font> strokes = [ <font color="#a31515">"#6cf"</font> , <font color="#a31515">"#9cf"</font> , <font color="#a31515">"#99f"</font> , <font color="#a31515">"#ccf"</font> , <font color="#a31515">"#66f"</font> , <font color="#a31515">"#3cf"</font> ]; <br> <br> <font color="#0000ff">function</font> rand (n) { <br> <font color="#0000ff">return</font> Math.floor(n * Math.random()); <br> } <br> <br> <font color="#008000">//  </font> <br> <font color="#0000ff">function</font> snow() { <br> canvas = <font color="#0000ff">document</font> .createElement( <font color="#a31515">'canvas'</font> ); <br> canvas.style.position = <font color="#a31515">'fixed'</font> ; <br> canvas.style.top = <font color="#a31515">'0px'</font> ; <br> canvas.style.left = <font color="#a31515">'0px'</font> ; <br> canvas.style.zIndex = <font color="#a31515">'-10'</font> ; <br> <br> <font color="#0000ff">document</font> .body.insertBefore(canvas, <font color="#0000ff">document</font> .body.firstChild); <br> sky = canvas.getContext( <font color="#a31515">'2d'</font> ); <br> <br> ResetCanvas(); <br> <br> snowingTimer = setInterval(createSnowflake, snowspeed); <br> setInterval(moveSnowflakes, scrollspeed); <br> window.addEventListener( <font color="#a31515">'resize'</font> , ResetCanvas, <font color="#0000ff">false</font> ); <br> } <br> <br> <font color="#008000">//   Canvas</font> <br> <font color="#0000ff">function</font> ResetCanvas() { <br> invalidateMeasure = <font color="#0000ff">true</font> ; <br> canvas.width = <font color="#0000ff">document</font> .body.offsetWidth; <br> canvas.height = window.innerHeight; <br> } <br> <br> <font color="#008000">//   </font> <br> <font color="#0000ff">function</font> leg(n, len) { <br> sky.save(); <font color="#008000">//   </font> <br> <font color="#0000ff">if</font> (n == 0) { <font color="#008000">//   -  </font> <br> sky.lineTo(len, 0);    } <br> <font color="#0000ff">else</font> { <br> sky.scale(1 / 3, 1 / 3); <font color="#008000">//    3 </font> <br> leg(n - 1, len);          sky.rotate(60 * deg); <br> leg(n - 1, len);            sky.rotate(-120 * deg); <br> leg(n - 1, len);            sky.rotate(60 * deg);        leg(n - 1, len);        } <br> sky.restore(); <font color="#008000">//  </font> <br> sky.translate(len, 0); <font color="#008000">//    </font> <br> } <br> <br> <font color="#008000">//   </font> <br> <font color="#0000ff">function</font> drawFlake(x, y, angle, len, n, stroke, fill) { <br> sky.save();    sky.strokeStyle = stroke; <br> sky.fillStyle = fill; <br> sky.beginPath(); <br> sky.translate(x, y); <br> sky.moveTo(0, 0);    sky.rotate(angle); <br> leg(n, len); <br> sky.rotate(-120 * deg); <br> leg(n, len);         sky.rotate(-120 * deg); <br> leg(n, len);         sky.closePath(); <br> sky.fill(); <br> sky.stroke(); <br> sky.restore(); <br> } <br> <br> <font color="#008000">//   </font> <br> <font color="#0000ff">function</font> createSnowflake() { <br> <font color="#0000ff">var</font> order = 2+rand(2); <br> <font color="#0000ff">var</font> size = 10*order+rand(10); <br> <font color="#0000ff">var</font> x = rand( <font color="#0000ff">document</font> .body.offsetWidth); <br> <font color="#0000ff">var</font> y = window.pageYOffset; <br> <font color="#0000ff">var</font> stroke = strokes[rand(strokes.length)]; <br> <br> flakes.push({ x: x, y: y, vx: 0, vy: 3 + rand(3), angle:0, size: size, order: order, stroke: stroke, fill: <font color="#a31515">'transparent'</font> }); <br> <br> <font color="#0000ff">if</font> (flakes.length &gt; maxflakes) clearInterval(snowingTimer); <br> } <br> <br> <font color="#008000">//  </font> <br> <font color="#0000ff">function</font> moveSnowflakes() { <br> sky.clearRect(0, 0, canvas.width, canvas.height); <br> <br> <font color="#0000ff">var</font> maxy = canvas.height; <br> <br> <font color="#0000ff">for</font> ( <font color="#0000ff">var</font> i = 0; i &lt; flakes.length; i++) { <br> <font color="#0000ff">var</font> flake = flakes[i]; <br> <br> flake.y += flake.vy; <br> flake.x += flake.vx; <br> <br> <font color="#0000ff">if</font> (flake.y &gt; maxy) flake.y = 0; <br> <font color="#0000ff">if</font> (invalidateMeasure) { <br> flake.x = rand(canvas.width); <br> } <br> <br> drawFlake(flake.x, flake.y, flake.angle, flake.size, flake.order, flake.stroke, flake.fill); <br> <br> <font color="#008000">//    </font> <br> <font color="#0000ff">if</font> (rand(4) == 1) flake.vx += (rand(11) - 5) / 10; <br> <font color="#0000ff">if</font> (flake.vx &gt; 2) flake.vx = 2; <br> <font color="#0000ff">if</font> (flake.vx &lt; -2) flake.vx = -2; <br> <font color="#0000ff">if</font> (rand(3) == 1) flake.angle = (rand(13) - 6) / 271; <br> } <br> <font color="#0000ff">if</font> (invalidateMeasure) invalidateMeasure = <font color="#0000ff">false</font> ; <br> } <br> } ()); <br></font> <br> <br> <font color="#808080">* This source code was highlighted with <font color="#808080">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Copy the code, run from the console and get snowfall on the site. </div><p>Source: <a href="https://habr.com/ru/post/110237/">https://habr.com/ru/post/110237/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../110230/index.html">Coffee shop available to all</a></li>
<li><a href="../110232/index.html">Review of free lancer fees</a></li>
<li><a href="../110234/index.html">From sand to processor</a></li>
<li><a href="../110235/index.html">Localized Wikileaks servers in Google Earth</a></li>
<li><a href="../110236/index.html">Help the robots</a></li>
<li><a href="../110238/index.html">Pirates Love Daisies</a></li>
<li><a href="../110239/index.html">Forced Update Outpost Security Suite Pro 7</a></li>
<li><a href="../110241/index.html">We bring down the ice from the Internet cable</a></li>
<li><a href="../110245/index.html">Exactly what is needed</a></li>
<li><a href="../110247/index.html">We write the first application for Android</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>