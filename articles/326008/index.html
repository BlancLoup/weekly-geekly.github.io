<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Integration of IS with ESIA via SAML</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When executing the next state order, our team was faced with the problem of integrating the site with ESIA. There are no instructions on how to solve ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Integration of IS with ESIA via SAML</h1><div class="post__text post__text-html js-mediator-article"><img src="https://denjoy.s3.amazonaws.com/044785af-ce52-498f-aa90-6cea5e6b138a_esia.jpg" alt="Integration with ESIA"><br><br><p>  When executing the next state order, our team was faced with the problem of integrating the site with ESIA.  There are no instructions on how to solve this problem, except for information in official documents of the Ministry of Communications and Communities (approximately 300 pages in three regulations).  There are also companies that provide paid services for the integration of ESIA.  We implemented, described the integration process and decided to share with the community habrahabr. </p><a name="habracut"></a><br><h2>  What is ESIA </h2><br><p>  EDITIONAL SYSTEM <b>AND</b> IDENTIFICATION <b>AND</b> AUTHENTICATION - Russian information system providing access (registration, authentication) to the websites of state structures and some commercial organizations.  Read more on <a href="https://ru.wikipedia.org/wiki/%25D0%2595%25D0%25B4%25D0%25B8%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2581%25D0%25B8%25D1%2581%25D1%2582%25D0%25B5%25D0%25BC%25D0%25B0_%25D0%25B8%25D0%25B4%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B8%25D1%2584%25D0%25B8%25D0%25BA%25D0%25B0%25D1%2586%25D0%25B8%25D0%25B8_%25D0%25B8_%25D0%25B0%25D1%2583%25D1%2582%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B8%25D1%2584%25D0%25B8%25D0%25BA%25D0%25B0%25D1%2586%25D0%25B8%25D0%25B8">wikipedia</a> </p><br><p>  During the integration of the ESIA, the system will be able to send a request to the ESIA and upon successful authorization receive user data as a response </p><br><p>  The authorization script looks like this: </p><br><ul><li>  The user on the site where ESIA is being introduced, in his account, clicks on the button ‚ÄúLogin through GosSlugi‚Äù </li><li>  The system redirects to the <a href="https://esia.gosuslugi.ru/">ESIA</a> website </li><li>  The user enters his username and password on the ESIA website </li><li>  If authorization is successful, ESIA returns the user back to the site and transfers his personal data via a secure protocol </li></ul><br><h2>  Content </h2><br><ol><li>  General information </li><li>  Install SimpleSAMLphp </li><li>  Configuring SimpleSAMLphp to connect to the ESIA test environment </li><li>  Metadata File Configuration </li><li>  Sending an application to the address of MinKomSvzyai for connection of IP to the ESIA test environment </li><li>  Functional integration with ESIA and obtaining data from authorized users via ESIA </li><li>  Sending an application for connecting the IP to the ESIA production environment </li></ol><br><h3>  General information </h3><br><p>  The MinKomSvyaz website contains a document called <i>‚ÄúGuidelines for the use of the Unified Identification and Authentication System‚Äù</i> , the latest current version can always be found on the <a href="http://minsvyaz.ru/ru/documents/4243/">MinKomSvyaz</a> website.  The document itself is rather big - almost 200 pages, and, of course, few people will want to study it in detail, and it will not be understandable to everyone, so I will describe here the process in the bottom line. </p><br><p>  It is possible to connect the IC to the ESIA in two ways: </p><br><ul><li>  By SAML 2.0 standard </li><li>  Based on the REST approach </li></ul><br><p>  If we compare the 2 approaches, then in fact there is no big difference between them, there are several advantages to the method based on the REST approach.  There are guys who, in my opinion, connect ESIA for a lot of money and they wrote about the advantages of REST <a href="https://identityblitz.ru/services/esia-integration/oauth-vs-saml-esia/">here</a> . </p><br><p>  But for the vast majority of cases, the first approach covers all the necessary functions.  Therefore, I will talk about the implementation of ESIA through SAML 2.0 </p><br><h3>  Install SimpleSAMLphp </h3><br><p>  For integration we will use SimpleSAMLphp.  If the system you are setting up is not written in PHP, then you can still use this module, just on your website there will be an authentication function implemented in php, you will receive data from ESIA in xml format. </p><br><p>  The latest official version of SimplSAMLphp is available on the official <a href="https://simplesamlphp.org/docs/stable/simplesamlphp-install">SimpleSamlPHP</a> website.  Download the archive, unpack the module in the /var folder. For security reasons, for the folder with the unzipped module, you need to set access rights only for root users.  In the server configuration, you must add an alias and the following rules: </p><br><pre><code class="apache hljs"><span class="hljs-section"><span class="hljs-section">&lt;VirtualHost *&gt;</span></span> <span class="hljs-attribute"><span class="hljs-nomarkup"><span class="hljs-attribute"><span class="hljs-nomarkup">ServerName</span></span></span></span> service.example.com DocumentRoot /var/www/service.example.com SetEnv SIMPLESAMLPHP_CONFIG_DIR /var/simplesamlphp/config Alias /simplesaml /var/simplesamlphp/www &lt;Directory /var/simplesamlphp/www&gt; &lt;IfModule !mod_authz_core.c&gt; # For Apache 2.2: Order allow,deny Allow from <span class="hljs-literal"><span class="hljs-literal">all</span></span> &lt;/IfModule&gt; &lt;IfModule mod_authz_core.c&gt; # For Apache 2.4: Require <span class="hljs-literal"><span class="hljs-literal">all</span></span> granted &lt;/IfModule&gt; &lt;/Directory&gt; &lt;/VirtualHost&gt;</code> </pre> <br><p>  The bottom line is that on request <code>ServerName/simplesaml</code> opened the welcome page simplesaml.  If you did everything correctly, then at the request of <code>ServerName/simplesaml</code> you will see such a page </p><br><br><div style="text-align:center;"><img src="https://denjoy.s3.eu-west-1.amazonaws.com/a5507327-3558-4e39-9bdf-2611ba7f2af4_simplesaml.jpg" title="SimpleSamlPHP" alt="SimpleSamlPHP"></div><br><h3>  Configuring SimpleSAMLphp to connect to the ESIA test environment </h3><br><p>  Integration requires a certificate ( <code>cert.crt</code> ) and a key ( <code>key.key</code> ).  It is important (!) With the Gostovskiy certificate nothing comes out, you can get a free certificate, google how it is done, or issue a certificate yourself.  <code>simplesamlphp/cert</code> key and certificate in the folder <code>simplesamlphp/cert</code> </p><br><p>  To configure SimpleSAMLphp, you need to edit the following files: </p><br><ul><li> <code>simplesamlphp/config/config.php</code> </li> <li> <code>simplesamlphp/config/authsources.php</code> </li> <li> <code>simplesamlphp/metadata/saml20-idp-remote.php</code> </li> </ul><br><p>  Important note - the time on the server should not differ from the ESIA time more than 1 minute. </p><br><p>  <code>simplesamlphp/config/config.php</code> : </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//         simplesamlphp 'certdir' =&gt; 'cert/' //  'secretsalt' =&gt; 'defaultsecretsalt', //  'technicalcontact_name' =&gt; 'Familiya Imya', 'technicalcontact_email' =&gt; 'po4ta@domen.zone',</span></span></code> </pre> <br><p>  It is important to know if the system has an entityID, if it does not, then in the <code>'entityID'</code> field you must specify the address of the system </p><br><p>  <code>simplesamlphp/config/authsources.php</code> : </p><br><pre> <code class="php hljs">esia<span class="hljs-string"><span class="hljs-string">' =&gt; array ( '</span></span>saml:SP<span class="hljs-string"><span class="hljs-string">', '</span></span>name<span class="hljs-string"><span class="hljs-string">' =&gt; '</span></span>Esia<span class="hljs-string"><span class="hljs-string">', //   '</span></span>privatekey<span class="hljs-string"><span class="hljs-string">' =&gt; '</span></span>key.key<span class="hljs-string"><span class="hljs-string">', //  '</span></span>privatekey_pass<span class="hljs-string"><span class="hljs-string">' =&gt; '</span></span><span class="hljs-number"><span class="hljs-number">12345678</span></span><span class="hljs-string"><span class="hljs-string">', //   '</span></span>certificate<span class="hljs-string"><span class="hljs-string">' =&gt; '</span></span>cert.crt<span class="hljs-string"><span class="hljs-string">', // , '</span></span>entityID<span class="hljs-string"><span class="hljs-string">' =&gt; '</span></span>ServerName<span class="hljs-string"><span class="hljs-string">', '</span></span>discoURL<span class="hljs-string"><span class="hljs-string">' =&gt; NULL, '</span></span>redirect.sign<span class="hljs-string"><span class="hljs-string">' =&gt; TRUE, '</span></span>redirect.validate<span class="hljs-string"><span class="hljs-string">' =&gt; TRUE, '</span></span>validate.logout<span class="hljs-string"><span class="hljs-string">' =&gt; FALSE, //idp      '</span></span>idp<span class="hljs-string"><span class="hljs-string">' =&gt; '</span></span>https:<span class="hljs-comment"><span class="hljs-comment">//esia-portal1.test.gosuslugi.ru/idp/shibboleth', //idp      // 'idp' =&gt; 'https://esia.gosuslugi.ru/idp/shibboleth', //  'OrganizationName' =&gt; 'Organization Name', //url  'OrganizationURL' =&gt; 'ServerName',</span></span></code> </pre> <br><p>  Now you need to get a signature for our certificate (fingerprint).  This can be done in the terminal of one of the commands. </p><br><ul><li> <code>openssl x509 -noout -fingerprint -in "cert.crt" SHA1</code> </li> <li> <code>sha1sum cert.crt</code> </li> </ul><br><p>  <code>simplesamlphp/metadata/saml20-idp-remote.php</code> : </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// idp      $metadata['https://esia-portal1.test.gosuslugi.ru/idp/shibboleth'] = array( 'name' =&gt; array( 'en' =&gt; 'Esia', 'no' =&gt; 'ESIA', ), //idp SignOn   'SingleSignOnService' =&gt; 'https://esia-portal1.test.gosuslugi.ru/idp/profile/SAML2/Redirect/SSO', //idp LogOut   'SingleLogoutService' =&gt; 'https://esia-portal1.test.gosuslugi.ru/idp/profile/SAML2/Redirect/SLO', //Fingerprint  'certFingerprint' =&gt; 'f17393ae5927293ae5927261b6515c44501e4450', );</span></span></code> </pre> <br><h3>  Metadata File Configuration </h3><br><p>  Now you need to configure the metadata file in order to send it along with the application to the ESIA </p><br><p>  The metadata file is available at the link: <code>ServerName/simplesaml/module.php/saml/sp/metadata.php/esia?output=xhtml</code> </p><br><p>  Sample metadata file: </p><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:EntityDescriptor</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:md</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:oasis:names:tc:SAML:2.0:metadata"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ds</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2000/09/xmldsig#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">entityID</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ServerName"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:SPSSODescriptor</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">protocolSupportEnumeration</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:oasis:names:tc:SAML:1.1:protocol urn:oasis:names:tc:SAML:2.0:protocol"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">AuthnRequestsSigned</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:KeyDescriptor</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">use</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"signing"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:KeyInfo</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ds</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2000/09/xmldsig#"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:X509Data</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:X509Certificate</span></span></span><span class="hljs-tag">&gt;</span></span> // <span class="hljs-tag"><span class="hljs-tag">&lt;/ </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ds:X509Certificate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:X509Data</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:KeyInfo</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:KeyDescriptor</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:KeyDescriptor</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">use</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"encryption"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:KeyInfo</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:ds</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2000/09/xmldsig#"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:X509Data</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:X509Certificate</span></span></span><span class="hljs-tag">&gt;</span></span> // <span class="hljs-tag"><span class="hljs-tag">&lt;/ </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ds:X509Certificate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:X509Data</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ds:KeyInfo</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:KeyDescriptor</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:SingleLogoutService</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Binding</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Location</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ServerName/simplesaml/module.php/saml/sp/saml2-logout.php/esia"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:AssertionConsumerService</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Binding</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Location</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ServerName/simplesaml/module.php/saml/sp/saml2-acs.php/esia"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">index</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:AssertionConsumerService</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Binding</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:oasis:names:tc:SAML:1.0:profiles:browser-post"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Location</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ServerName/simplesaml/module.php/saml/sp/saml1-acs.php/esia"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">index</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:AssertionConsumerService</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Binding</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Artifact"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Location</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ServerName/simplesaml/module.php/saml/sp/saml2-acs.php/esia"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">index</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:AssertionConsumerService</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Binding</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:oasis:names:tc:SAML:1.0:profiles:artifact-01"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Location</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ServerName/simplesaml/module.php/saml/sp/saml1-acs.php/esia/artifact"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">index</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"3"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:SPSSODescriptor</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:Organization</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:OrganizationName</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xml:lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"en"</span></span></span><span class="hljs-tag">&gt;</span></span>Organization Name<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:OrganizationName</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:OrganizationDisplayName</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xml:lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"en"</span></span></span><span class="hljs-tag">&gt;</span></span>Organization Name<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:OrganizationDisplayName</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:OrganizationURL</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xml:lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"en"</span></span></span><span class="hljs-tag">&gt;</span></span>ServerName<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:OrganizationURL</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:Organization</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:ContactPerson</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">contactType</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"technical"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:GivenName</span></span></span><span class="hljs-tag">&gt;</span></span>Imya<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:GivenName</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:SurName</span></span></span><span class="hljs-tag">&gt;</span></span>Familiya<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:SurName</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:EmailAddress</span></span></span><span class="hljs-tag">&gt;</span></span>po4ta@domen.zone<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:EmailAddress</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:ContactPerson</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:E</span></span></span><span class="hljs-tag">&lt;/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ntityDescriptor</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  But, unfortunately, SimpleSaml generates a metadata file, which is slightly different from the ESIA requirement, so you need to correct it in accordance with the recommendations of paragraph <i>A.6. Metadata file template</i> </p><br><p>  An example of a metadata file that meets the requirements of the ESIA can be downloaded at <code><a href="">example.xml</a></code> </p><br><h3>  Sending an application to the address of MinKomSvzyai for connection of IP to the ESIA test environment </h3><br><p>  Now we form an application in the form <a href="http://minsvyaz.ru/ru/documents/4244/" title="Rules of information interaction">‚ÄúE‚Äù of the Regulations for Informational Interaction between the Participants and the Operator of the ESIA</a> .  The application form in docx format can be downloaded from our website by the <a href="https://denjoy.s3.eu-west-1.amazonaws.com/92858999-065e-4b91-a833-9bf7d82545c2_e.docx" title="Form E Regulations">link</a> . </p><br><p>  Now you need to send a request for <code>esia@minsvyaz.ru</code> mail with the subject ‚ÄúIntegration of test ESIA‚Äù and you need to attach three files to the letter: </p><br><ul><li>  scan applications in pdf format, </li><li>  certificate in crt format </li><li>  xml metadata file </li></ul><br><p>  After receiving the answer from the service provider (ESIA) with the status ‚ÄúSolved‚Äù and the attached files for testing, proceed to the next step. </p><br><p>  Perhaps you will receive a reply with the subject ‚ÄúAdditional information is required by request #‚Äù, in this case the letter will contain information about what needs to be corrected. </p><br><h3>  Functional integration with ESIA and obtaining data from authorized users via ESIA </h3><br><p>  Check the connection of the IC to the test environment can be on the link <br>  <code>ServerName/simplesaml/module.php/core/authenticate.php?as=esia</code> . </p><br><p>  If all previous points are correctly executed, a page with the ESIA test environment will open.  For authentication in a test environment, data obtained from ESIA in a letter with the ‚ÄúResolved‚Äù status are used.  After authentication, you will be transferred to the SimpleSAML page with a table with the received data from ESIA. </p><br><img src="https://denjoy.s3.eu-west-1.amazonaws.com/10ef5295-7e70-49c3-97f7-0fa211a38e9c_answer.jpg" alt="xml answer ESIA" title="xml answer ESIA">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>  Now we will write a script that will process the data.  To begin, add a button for authorization on the site. </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//  action         &lt;form action="inc/esia.php" method="POST"&gt; &lt;input name="esia" type="submit" value="  "/&gt; &lt;/form&gt;</span></span></code> </pre> <br><p>  Handler <code>inc/esia.php</code> .  Here we get the data and we can write it to the database, add it to the session, etc.  In general, you need to properly parse xml.  Now just display the data on the screen. </p><br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_POST[<span class="hljs-string"><span class="hljs-string">'esia'</span></span>])){ <span class="hljs-comment"><span class="hljs-comment">//   simplesamlphp/lib/_autoload.php require_once('../../simplesamlphp/lib/_autoload.php'); $as = new SimpleSAML_Auth_Simple('esia'); $as-&gt;requireAuth(); $attributes = $as-&gt;getAttributes(); foreach($attributes as $key =&gt; $value) { echo ($key . ' ' . $value . '&lt;br/&gt;'); } }</span></span></code> </pre> <br><h3>  Sending an application for connecting the IP to the ESIA production environment </h3><br><p>  Now we form an application in the <a href="http://minsvyaz.ru/ru/documents/4244/" title="Regulation of information interaction">form ‚ÄúM‚Äù of the Regulations for information interaction of the Participants with the Operator ESIA</a> .  It is not much different from form E, but carefully study the form, it is necessary to add the requested data in the form and no longer need to attach the certificate file. </p><br><p>  In the files <code>simplesamlphp/config/authsources.php</code> , <code>simplesamlphp/metadata/saml20-idp-remote.php</code> you must replace the idp of the service provider from the Test environment with the productive one: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//idp      // 'idp' =&gt; 'https://esia-portal1.test.gosuslugi.ru/idp/shibboleth', //   idp      'idp' =&gt; 'https://esia.gosuslugi.ru/idp/shibboleth',</span></span></code> </pre> <br><p>  Now we create a new metadata file, in fact only the links in the Service fields change. </p><br><p>  We send an email to esia@minsvyaz.ru and attach 2 files: </p><br><ul><li>  New Metadata File </li><li>  Application form M </li></ul><br><p>  Now you should receive a response with the status ‚ÄúReshen‚Äù, after that you can enter the entry function through the ENIA into operation. </p><br><p>  At the time of writing, the current version of the Regulation is 2.7.  When updating the regulations, some changes in the interaction of the EC with the ESIA are possible. </p><br></div><p>Source: <a href="https://habr.com/ru/post/326008/">https://habr.com/ru/post/326008/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325996/index.html">e-Government of the future</a></li>
<li><a href="../325998/index.html">Parse the qualified X.509 certificates in the search for TIN, SNILS and OGRN</a></li>
<li><a href="../326002/index.html">We write our monads on Scala using the example of a CSV parser</a></li>
<li><a href="../326004/index.html">The digest of interesting materials for the mobile developer # 198 (April 2-9)</a></li>
<li><a href="../326006/index.html">An example of creating a web application on PureQML</a></li>
<li><a href="../326014/index.html">Looks like I'm not an entrepreneur</a></li>
<li><a href="../326016/index.html">Application evolution or where are we going</a></li>
<li><a href="../326018/index.html">The organization of components in the project</a></li>
<li><a href="../326020/index.html">Automation QA is a separate command?</a></li>
<li><a href="../326022/index.html">Inkscape in action: sunset with stars</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>