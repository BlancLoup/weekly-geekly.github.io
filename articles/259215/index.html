<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Application KolibriOS. Part 2: Core Exposure for Iron Developers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Summer has already arrived outside the window, but we present you a continuation of a series of articles on the practical use of ColibriOS. In the fir...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Application KolibriOS. Part 2: Core Exposure for Iron Developers</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/332/ac0/97c/332ac097cb7bfba245943a942c69f564.png" align="left">  Summer has already arrived outside the window, but we present you a continuation of a series of articles on the practical use of ColibriOS.  In the <a href="http://habrahabr.ru/company/kolibrios/blog/256799/">first part,</a> we conducted a theoretical review of possible applications, and now, as promised, we move on to a more practical part: the kernel kernel for developers. <br><a name="habracut"></a><br><br>  I would like to say thanks <b>art_zh</b> for <b>taking</b> the time to prepare the material for this article. <br><br>  Probably, few of our readers remember those old, old times, "when computers were big" and were practically not used for office work and entertainment.  The main areas of application of these expensive monsters were furious computing, automated systems for collecting data, designing and managing complex technological processes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Decades have passed, computers have become much cheaper and faster, but old tasks have not become easier.  Requirements to the efficiency of processing broadband data streams, to the speed and reliability of control schemes, to the simplicity and visibility of the user interface are constantly increasing. <br><br>  One of our developers, <b>art_zh</b> , an electronics engineer from England, came to the project after a long and unsuccessful search for the optimal OS for the "fast" technical vision on the x86 platform.  A specific task required the processing of a wideband video stream (500 SXGA frames, 660 million pixels per second). From this avalanche of data, it was necessary to select several characteristic zones, find the average brightness in each zone and monitor the change in this brightness for 10-12 hours.  Periodically displaying a full-format image on the screen. <br><br><img src="https://habrastorage.org/files/5d4/55b/1b1/5d455b1b1f93462f8ed9302c7c572f18.jpg"><br><br>  The task was complicated by the irregularity of the iron used.  The framegrabber and the DMA controller were implemented on an experimental PCI-express card with a Xilinx Virtex-5 engine.  Severe Verilog-code required careful debugging of all packet transactions to the TLP-PCIe protocol.  We will discuss this topic in more detail in one of the following publications of this cycle; here we confine ourselves to stating that the Windows environment seems to be completely unsuitable for such debugging, and in Linux the code modification cycle ‚Äî driver compilation ‚Äî restart ‚Äî analysis of printk messages took an unacceptable long time. <br><br>  So, we needed a fast, graphical, 32-bit operating system with an exo-card transparent for access from the application to the lowest level hardware resources ‚Äî PCI configuration space, PCIe Root Complex registers, MMIO addresses (mapped to I / O memory), etc. . <br><br>  KolibriOS attracted by its speed and minimal latency, simple and convenient graphical user interface, very compact and open source kernel code.  The problem was with a limited set of functions for working with the PC hardware. <br><br>  In the standard Hummingbird kernel, the application was only allowed access to a limited range of I / O ports, system messages about some hardware interrupts, and a very curved PCI service.  In order to maximally speed up the work of programs with computer hardware, it was necessary to cut through the exodus in the monolithic core. <br><br>  This is how Kolibri-A, the KolibriOS exo version for AMD Fusion based platforms, appeared.  Since any ekzoyadro carries the risk of fatal damage to data and PC equipment due to incorrect access to critical system resources, and also considering that the vast majority of users of our system are <s>kettles,</s> inexperienced users trying new operating systems out of pure curiosity, Kolibri-A was initially positioned as a completely detached KolibriOS branch, intended only for qualified users who have an idea how and with what devices you can (and how you can) handle and carry  they have full responsibility for the consequences of their actions. <br><br>  First of all, the application was directly open access to <br><ol><li>  I / O to all ports (in the main branch of the kernel, the application still has to ‚Äúorder‚Äù the required range of I / O ports through the ugly Menuetov heritage ‚Äî the so-called ‚Äúfortieth functions‚Äù). <br>  This was not enough.  Now it is difficult to find a device that communicates with the processor exclusively through the ports.  Convenient has been added </li><li>  Access to the <a href="http://en.wikipedia.org/wiki/Memory-mapped_I/O">MMIO</a> (memory mapped I / O space) using the 62:12 system.  The service works like the Linux function ioremap (), but is implemented easier and more flexible.  The application specifies the BAR register number in the configuration space of the selected device and selects the MMIO range to which it will apply, and the kernel maps the selected range to the linear space of the application. <br>  But that's not all.  The application must have full access to the configuration space of the selected device.  The KolibriOS core PCI service was implemented through slow and uncomfortable CF8 / CFC ports.  Quick access was added to A-version </li><li>  PCI configuration space (including extended PCI Express configuration) with mapping to the virtual address space of the application starting at address 0xF0000000.  Example of reading a PCI device header 1: 18: 2 <br><blockquote>  <font color="#00007f">mov</font> <font color="#46aa03">eax</font> <font color="#339933">,</font> <font color="#009900">(</font> <font color="#ff0000">1</font> <font color="#00007f">shl</font> <font color="#ff0000">20</font> <font color="#009900">)</font> <font color="#339933">+</font> <font color="#009900">(</font> <font color="#ff0000">18</font> <font color="#00007f">shl</font> <font color="#ff0000">15</font> <font color="#009900">)</font> <font color="#339933">+</font> <font color="#009900">(</font> <font color="#ff0000">2</font> <font color="#00007f">shl</font> <font color="#ff0000">12</font> <font color="#009900">)</font> <br>  <font color="#00007f">or</font> <font color="#46aa03">eax</font> <font color="#339933">,</font> <font color="#ff0000">0xF0000000</font> <br>  <font color="#00007f">mov</font> <font color="#009900">[</font> device_vendor <font color="#009900">]</font> <font color="#339933">,</font> <font color="#009900">[</font> <font color="#46aa03">eax</font> <font color="#009900">]</font> </blockquote><br>  It should be noted that the display of the configuration on memory is implemented only for platforms based on AMD-processors (by the way, this is what the name ‚ÄúKolibri-A‚Äù picks up).  For intel, exoservice has not yet been developed: art_zh works only with AMD hardware, and all other developers, unfortunately, do not show much interest in the exo-core. <br>  Okay, the configuration space is open.  Now we can identify devices, resolve interrupts, monitor the status of the PCI line and access any internal resources, controlling data flows and organizing direct memory access ... Although there is a problem here: the device knows only the physical addresses of the DMA region, and the application lives in its linear space.  For this </li><li>  Selected static area DMA.  Using the special system 62: 12-DA, the application can request its linear address and work with it directly: <br><blockquote>  mcall <font color="#ff0000">62</font> <font color="#339933">,</font> <font color="#ff0000">11</font> <font color="#339933">,</font> <font color="#ff0000">0x0500</font> <font color="#666666">;</font>  <font color="#666666">init MMIO / DMA: bus = 5, device = 0, fn = 0</font> <br>  <font color="#00007f">mov</font> <font color="#009900">[</font> dma <font color="#009900">]</font> <font color="#339933">,</font> <font color="#46aa03">eax</font> <font color="#666666">;</font>  <font color="#666666">store phys.addr of the DMA buffer:</font> <br>  mcall <font color="#ff0000">62</font> <font color="#339933">,</font> <font color="#ff0000">0</font> <font color="#339933">+</font> <font color="#ff0000">12</font> <font color="#339933">,</font> <font color="#ff0000">4096</font> <font color="#339933">,</font> <font color="#ff0000">0</font> <font color="#666666">;</font>  <font color="#666666">map MMIO access to BAR0-space</font> <br>  <font color="#00007f">mov</font> <font color="#009900">[</font> mio <font color="#009900">]</font> <font color="#339933">,</font> <font color="#46aa03">eax</font> <font color="#666666">;</font>  <font color="#666666">store MMIO linear address</font> <br>  mcall <font color="#ff0000">62</font> <font color="#339933">,</font> <font color="#ff0000">0xDA0C</font> <font color="#339933">,</font> <font color="#ff0000">4096</font> <font color="#339933">,</font> <font color="#ff0000">0</font> <font color="#666666">;</font>  <font color="#666666">0x0da0c = create user DMA channel</font> <br>  <font color="#00007f">mov</font> <font color="#009900">[</font> mem <font color="#009900">]</font> <font color="#339933">,</font> <font color="#46aa03">eax</font> <font color="#666666">;</font>  <font color="#666666">store DMA buffer: linear @</font> <br>  <font color="#00007f">mov</font> <font color="#46aa03">eax</font> <font color="#339933">,</font> <font color="#009900">[</font> dma <font color="#009900">]</font> <br>  <font color="#00007f">or</font> <font color="#46aa03">eax</font> <font color="#339933">,</font> DMA_FLAGS <br>  <font color="#00007f">mov</font> <font color="#0000ff">dword</font> <font color="#009900">[</font> mio <font color="#339933">+</font> <font color="#ff0000">4</font> <font color="#009900">]</font> <font color="#339933">,</font> <font color="#46aa03">eax</font> <font color="#666666">;</font>  <font color="#666666">program device-specific DMA-register</font> <br>  <font color="#666666">;</font>  <font color="#666666">....</font> <br>  <font color="#00007f">mov</font> <font color="#46aa03">ecx</font> <font color="#339933">,</font> <font color="#009900">[</font> mem <font color="#009900">]</font> <br>  <font color="#00007f">mov</font> <font color="#46aa03">eax</font> <font color="#339933">,</font> <font color="#009900">[</font> index <font color="#009900">]</font> <br>  <font color="#00007f">mov</font> <font color="#46aa03">edx</font> <font color="#339933">,</font> <font color="#0000ff">dword</font> <font color="#009900">[</font> <font color="#46aa03">ecx</font> <font color="#339933">+</font> <font color="#46aa03">eax</font> <font color="#339933">*</font> <font color="#ff0000">4</font> <font color="#009900">]</font> <font color="#666666">;</font>  <font color="#666666">load the fresh data from DMA-buffer</font> </blockquote><br>  Now you can fully work with the device directly from the user application.  It turned out a flexible and versatile tool that <b>art_zh</b> has been using in everyday work for 5 years to develop new hardware and debug low-level code of very different embedded x86 devices. <br>  Unfortunately, having developed such a tool, the author switched to other tasks and rarely publishes new versions of his code (remaining in the project as an ‚Äúadvanced user‚Äù and an eternal beep on the forum).  But despite long breaks, the work continues slowly.  In addition to the above, today in Kolibri-A there are other exofics: </li><li>  The organization of MSI interrupts can be organized through the LAPIC address space available to the user. </li><li>  Physical memory can also be read from the application.  This service is very useful when debugging a kernel. </li><li>  Diskless OS loading was tested through <a href="http://en.wikipedia.org/wiki/Coreboot">CoreBoot</a> (using <a href="http://habrahabr.ru/users/xvilka/" class="user_link">Xvilka</a> ) and via BIOS Extension ROM from onboard memory of PCIe devices. </li><li>  The GPU space is open - for now only for installing hardware cursors and reverse engineering of AMD / ATI graphics processor resources.  But who knows, maybe sometime in Kolibri there will be programs on a GPU-assembler ... </li></ol><br><br>  <b>(to be continued)</b> </div><p>Source: <a href="https://habr.com/ru/post/259215/">https://habr.com/ru/post/259215/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259205/index.html">Real-time debugging via JTAG / SWJ-DP for ARM Cortex-M microcontrollers</a></li>
<li><a href="../259207/index.html">The digest of interesting materials from the world of web development and IT for the last week? 162 (May 15 - 31, 2015)</a></li>
<li><a href="../259209/index.html">Comparison of PHP7 and Hack type systems</a></li>
<li><a href="../259211/index.html">Delays are a stumbling block to the Internet of Things</a></li>
<li><a href="../259213/index.html">We write a simple code analyzer on Roslyn</a></li>
<li><a href="../259217/index.html">Screen with an infinite number of pixels</a></li>
<li><a href="../259219/index.html">Cheat sheet on mongodb: e-commerce, migration, frequently used operations and a little about transactions</a></li>
<li><a href="../259223/index.html">jQuery is considered harmful</a></li>
<li><a href="../259225/index.html">Gulp.watch: catch errors correctly</a></li>
<li><a href="../259227/index.html">Network warrior. Demand study</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>