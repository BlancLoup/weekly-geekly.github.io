<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mongoose rake</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hacker - a man who steps on a rake, which are hidden in the barn and closed on the castle 
 Mongoose is the most popular javascript mongodb module. Ex...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mongoose rake</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  Hacker - a man who steps on a rake, which are hidden in the barn and closed on the castle </blockquote><br>  Mongoose is the most popular javascript mongodb module.  Examples on the site allow you to start using it fairly quickly and successfully, but mongoose has a number of unexpected features that can make the programmer start tearing out the hair on his head.  It is about these features that I am going to tell. <br><a name="habracut"></a><br><h4>  1. Naming collections </h4><br>  I will start with the most innocuous and easily detectable features.  You create a model: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mongoose = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'mongoose'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> User = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> mongoose.Schema({ <span class="hljs-attr"><span class="hljs-attr">email</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, <span class="hljs-attr"><span class="hljs-attr">password</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: { <span class="hljs-attr"><span class="hljs-attr">birthday</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>, <span class="hljs-attr"><span class="hljs-attr">default</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now }, <span class="hljs-attr"><span class="hljs-attr">status</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, <span class="hljs-attr"><span class="hljs-attr">default</span></span>: <span class="hljs-string"><span class="hljs-string">'active'</span></span>, <span class="hljs-attr"><span class="hljs-attr">enum</span></span>: [<span class="hljs-string"><span class="hljs-string">'active'</span></span>, <span class="hljs-string"><span class="hljs-string">'unactive'</span></span>] }, <span class="hljs-attr"><span class="hljs-attr">mix</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: mongoose.Schema.Types.Mixed, <span class="hljs-attr"><span class="hljs-attr">default</span></span>: {} } } }); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = mongoose.model(<span class="hljs-string"><span class="hljs-string">'User'</span></span>, User);</code> </pre> <br>  Create a user: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User({<span class="hljs-attr"><span class="hljs-attr">email</span></span>: <span class="hljs-string"><span class="hljs-string">'test@test.com'</span></span>, <span class="hljs-attr"><span class="hljs-attr">password</span></span>: <span class="hljs-string"><span class="hljs-string">'12345'</span></span>}); user.save(ok(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'ok'</span></span>); }));</code> </pre><br>  If we now execute the ‚Äúshow collections‚Äù command in the mongodb console, we will see that the users collection has been created.  Those.  mongoose when creating collections brings their names to lowercase and plural. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  2. Overriding the toJSON () Method </h4><br>  Let us need to modify our instance of the model by adding an attribute that is not described in the model: <br><br><pre> <code class="javascript hljs">User.findOne({<span class="hljs-attr"><span class="hljs-attr">email</span></span>: <span class="hljs-string"><span class="hljs-string">'test@test.com'</span></span>}, ok(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user</span></span></span><span class="hljs-function">) </span></span>{ user.someArea = <span class="hljs-string"><span class="hljs-string">'custom value'</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(user.someArea); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'===='</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(user); }));</code> </pre><br>  In the console we will see (instead of console.log, res.json may be used): <br><br><pre> <code class="javascript hljs">custom value ==== { <span class="hljs-attr"><span class="hljs-attr">__v</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">54</span></span>fc8c22c90fb7dd025eee7c, <span class="hljs-attr"><span class="hljs-attr">email</span></span>: <span class="hljs-string"><span class="hljs-string">'test@test.com'</span></span>, <span class="hljs-attr"><span class="hljs-attr">password</span></span>: <span class="hljs-string"><span class="hljs-string">'12345'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: { <span class="hljs-attr"><span class="hljs-attr">mix</span></span>: {}, <span class="hljs-attr"><span class="hljs-attr">status</span></span>: <span class="hljs-string"><span class="hljs-string">'active'</span></span>, <span class="hljs-attr"><span class="hljs-attr">birthday</span></span>: Thu Mar <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">46</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span> GMT+<span class="hljs-number"><span class="hljs-number">0300</span></span> (MSK) } }</code> </pre><br>  As you can see, the object has the attribute someArea, but when it dumped to the console, it disappeared somewhere.  The fact is that mongoose overrides the toJson method and all fields not described in the model schema are discarded.  A situation may arise when we add an attribute to an object and give it to the client, but the attribute does not reach the client.  In order for it to successfully hit the client, it is necessary to modify not a mongoose object.  For these purposes, model instances have a toObject method, which returns a native-Object, which can be modified as desired and nothing is lost from it. <br><br><h4>  3. Comparison _id </h4><br>  It may seem that _id is of type String, however, this is not at all the case.  _id is an object and it is necessary to compare the identifiers of instances of mongoose models as objects.  Example: <br><br><pre> <code class="javascript hljs">User.findOne({<span class="hljs-attr"><span class="hljs-attr">email</span></span>: <span class="hljs-string"><span class="hljs-string">'test@test.com'</span></span>}, ok(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user1</span></span></span><span class="hljs-function">) </span></span>{ User.findOne({<span class="hljs-attr"><span class="hljs-attr">email</span></span>: <span class="hljs-string"><span class="hljs-string">'test@test.com'</span></span>}, ok(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user2</span></span></span><span class="hljs-function">) </span></span>{ log(user1._id == user2._id); <span class="hljs-comment"><span class="hljs-comment">// false log(user1._id.equals(user2._id)); // true log(user1._id.toString() == user2._id.toString()); // true })); }));</span></span></code> </pre><br><br><h4>  4. Saving mixed fields </h4><br>  We have one field with the type mixed in the scheme, this is data.mix.  If we change it, for example: <br><br><pre> <code class="javascript hljs">User.findOne({<span class="hljs-attr"><span class="hljs-attr">email</span></span>: <span class="hljs-string"><span class="hljs-string">'test@test.com'</span></span>}, ok(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user</span></span></span><span class="hljs-function">) </span></span>{ user.data.mix = {<span class="hljs-attr"><span class="hljs-attr">msg</span></span>: <span class="hljs-string"><span class="hljs-string">'hello world'</span></span>}; user.save(ok(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'ok'</span></span>); })); }));</code> </pre><br>  , then the changes will successfully fall into the database. <br><br>  However, if now we make the change inside data.mix, then the changes in the database will not fall. <br><br><pre> <code class="javascript hljs">User.findOne({<span class="hljs-attr"><span class="hljs-attr">email</span></span>: <span class="hljs-string"><span class="hljs-string">'test@test.com'</span></span>}, ok(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user</span></span></span><span class="hljs-function">) </span></span>{ user.data.mix.msg = <span class="hljs-string"><span class="hljs-string">'Good bye'</span></span>; user.save(ok(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ log(user); })); }));</code> </pre><br>  The user object containing our modifications will be displayed in the console, and a query to the database will show that the user has not been changed.  In order for the changes to be in the database, you need to notify mongoose before the save method that we modified the mixed-field: <br><br><pre> <code class="javascript hljs">user.markModified(<span class="hljs-string"><span class="hljs-string">'data.mix'</span></span>);</code> </pre><br>  The same operation must be performed with objects of type Date when they are modified by the built-in methods (setMonth, setDate, ...), this is stated in the <a href="http://mongoosejs.com/docs/schematypes.html">documentation</a> <br><br><h4>  5. Defaults for arrays </h4><br>  Suppose, when describing the model scheme, we decided that we should have an array of objects in the field.  We need to register defaults for the array itself and for all objects embedded in it.  In mongoose, the special key type is used for this: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Lib = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> mongoose.Schema({ <span class="hljs-attr"><span class="hljs-attr">userId</span></span>: mongoose.Schema.ObjectId, <span class="hljs-attr"><span class="hljs-attr">images</span></span>: { <span class="hljs-comment"><span class="hljs-comment">//           images type: [{ uploaded: { type: Date, default: Date.now }, src: String }], //  -   images default: [{uploaded: new Date(2012, 11, 22), src: '/img/default.png'}] } }); module.exports = mongoose.model('Lib', Lib);</span></span></code> </pre><br>  Similarly, using the type keyword, we can create multi-level defaults for objects. <br><br><h4>  6. Streaming update </h4><br>  Sometimes it is necessary to update a very large collection from code.  Download the entire collection - not enough memory.  You can manually set limits, load documents in batches and update, but mongoose has very convenient interfaces for this operation - streaming. <br><br><pre> <code class="javascript hljs">emusers.find({}).stream() .on(<span class="hljs-string"><span class="hljs-string">'data'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> me = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; me.pause(); <span class="hljs-comment"><span class="hljs-comment">//        user.save(function(err) { me.resume(err); }); }) .on('error', function(err) { log(err); }) .on('close', function() { log('All done'); });</span></span></code> </pre><br>  (However, if we extract users in batches, edit and save via async.parallel, this will work a little faster, but less readable). <br><br><h4>  6. Disable automatic index building </h4><br>  To ensure the uniqueness of the fields in mongodb unique indexes are used.  Using mongoose is very easy to create.  Mongoose generally creates a high level of abstraction when working with data.  However, our shortcomings are extensions of our merits and many forget to disable the automatic creation of indexes in the production mode, although the official <a href="http://mongoosejs.com/docs/guide.html">documentation</a> clearly states this. <br>  For these purposes, mongoose even has a special flag {autoIndex: false}, which must be specified when describing the data scheme: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> User = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> mongoose.Schema({ <span class="hljs-attr"><span class="hljs-attr">email</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, <span class="hljs-attr"><span class="hljs-attr">unique</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">required</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, <span class="hljs-attr"><span class="hljs-attr">password</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">autoIndex</span></span>: process.env(<span class="hljs-string"><span class="hljs-string">'mode'</span></span>) == <span class="hljs-string"><span class="hljs-string">'development'</span></span> });</code> </pre><br>  Now automatic building of indexes will work only in development mode. <br><br><h4>  7. Do not forget about reserved keys. </h4><br>  Probably, not everyone is faced with a similar problem, but nevertheless I‚Äôll draw attention to the fact that in mongoose objects there is a set of reserved names for attributes, they are given in the <a href="http://mongoosejs.com/docs/api.html">documentation</a> .  We had to deal with the naming of attributes by keys from the list of reserved ones, after which it was necessary to scrub calls to these keys throughout the code.  Mongoose does not swear at all about using reserved keys.  The rake I stepped on this list of keys turned out to be the options key. </div><p>Source: <a href="https://habr.com/ru/post/253395/">https://habr.com/ru/post/253395/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253385/index.html">Modular data centers from the Middle Kingdom and Asia</a></li>
<li><a href="../253387/index.html">We write processing Asterisk AMI do it yourself. Part one: create a class in PHP to refer to an asterisk or how to make a php socket client yourself</a></li>
<li><a href="../253389/index.html">The hero of IT-stories: quest</a></li>
<li><a href="../253391/index.html">DUMP-2015 Conference: Serverside.Experience and Serverside.Knowledge section</a></li>
<li><a href="../253393/index.html">As we with third-graders programmed the address garland</a></li>
<li><a href="../253397/index.html">Dagaz: Kicks to common sense (part 4)</a></li>
<li><a href="../253401/index.html">Analysis of the tasks of the warm-up training round of the Russian Code Cup 2015</a></li>
<li><a href="../253403/index.html">Semaphore App. Ruby on Rails. Continuous integration / delivery</a></li>
<li><a href="../253405/index.html">The Golden App mobile application competition has started</a></li>
<li><a href="../253407/index.html">CNC machine with advanced functionality</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>