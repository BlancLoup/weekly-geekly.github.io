<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Chinese AIBUS protocol and laboratory chemical reactor</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings Habr! Once upon a time I wrote an article about reaction flavors. It took a long time, I returned to this issue. 

 In this article, I will ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Chinese AIBUS protocol and laboratory chemical reactor</h1><div class="post__text post__text-html js-mediator-article">  Greetings Habr!  Once upon a time I wrote <a href="https://habr.com/ru/post/382427/">an article</a> about reaction flavors.  It took a long time, I returned to this issue. <br><br>  In this article, I will not go into the details of the development technology of reaction flavors, but I will tell you about my experience in automating my working time and sharing code that can be useful to anyone.  I came across a Chinese-made laboratory chemical reactor and, unfortunately, it lacked tools for automating cooling, reading and writing data, programming modes, which was very important.  The reactor itself was a usual metal blank on a tripod, with heating elements up to 350 degrees.  For temperature control is responsible controller <a href="https://yadi.sk/i/mpCUowpbXw9Vug">Yudian AI518</a> . <br><br><img src="https://habrastorage.org/webt/ok/r4/as/okr4as_a8vaknn8sdmaaduth2e0.jpeg"><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The good news for me was the presence of an RS-485 port in it. <br><br>  Yes, in Yudian AI518 there are timers and some very simple programs, but first of all, it was very interesting to make your ‚Äúblackjack‚Äù with windows and buttons, and secondly it‚Äôs not very convenient to poke at a regular controller, I would like it all do on the computer. <br><br>  Since I had experience with Arduino controllers, I initially decided to make communication and control through it, then I had an idea to write a program on Qt which would be responsible for management and automation, and Arduino Mega for forming and decrypting packages with AI518. <br><br>  Since the cold water on valve can be located at a distance from the computer and the installation itself, it was decided to build an additional controller that will, on command, turn on / off the cold water valve and read-send the cooling temperature.  Yes, at the end of the project, I realized that a lot of construction was piled up, it would have been possible to use the RS485 whistle on a computer to get rid of one program, but my ambitions to make my own device fueled interest. <br><br>  Total in our bundle: <br><br><ol><li>  Regular controller Yudian AI518. </li><li>  Arduino Mega + 2 RS485 Converters (MAX485) </li><li>  Arduino nano + 1 RS485 converter (MAX485) + thermocouple + 12V transistor. </li><li>  12V cold water valve. </li></ol><cut></cut><br>  First of all, the structure of communication between mega and nano was written. <br><br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">packet_arduino_pomp</span></span></span><span class="hljs-class"> // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Arduino</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nano</span></span></span><span class="hljs-class"> {</span></span> byte start_byte_one;<span class="hljs-comment"><span class="hljs-comment">//    212 byte start_byte_two;//    211 byte temp_pomp;//  byte on_of_pomp;//on-off  (1  0) byte CRC8;//  /**/ void pask() { CRC8 = (start_byte_one + start_byte_two + temp_pomp + on_of_pomp + tmp) / 10; } /* */ bool test_pask() { if (CRC8 == (start_byte_one + start_byte_two + temp_pomp + on_of_pomp + tmp) / 10) return 0; // return 1; //  } };</span></span></code> </pre> <br>  When everything worked steadily, I began to read a lot about different data transfer protocols, but I could not find the one I needed.  The fact is that the regular controller Yudian AI518 communicates with the outside world via the AIBUS protocol, as I understand it is a Chinese analogue of MODBUS.  ( <a href="https://yadi.sk/i/MbHPRAvGupRDTw">documentation</a> ) I did it for the first time and focusing on the documentation and help of all possible forums. <br><br>  Outgoing packet structure for Yudian AI518: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tagREQ_FRM_T</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> u8DevAddr1; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> u8DevAddr2; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> u8ReqType; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> u8DevPara; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> u8LoParam; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> u8HiParam; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> u8LoSumCheck; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> u8HiSumCheck; } ;</code> </pre> <br>  The structure of the incoming package for Yudian AI518: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tagANS_FRM_T</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> u8LoPV; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> u8HiPV; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> u8LoSV; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> u8HiSV; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> u8MV; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> u8ALm; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> u8LoParam; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> u8HiParam; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> u8LoSumCheck; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> u8HiSumCheck; };</code> </pre> <br>  In fact, it turned out that packets from all devices come from Mega (from nano with cooling temperature values, from AI518 with updated reactor temperature and other values ‚Äã‚Äãand commands from the computer).  Then Mega combined everything into one package and sent it to the computer where the QT program read it. <br><br>  The structure of the package mega-computer: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">packet_big</span></span></span><span class="hljs-class"> // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PC</span></span></span><span class="hljs-class"> {</span></span> byte start_byte_one;<span class="hljs-comment"><span class="hljs-comment">//    254 byte start_byte_two;//    232 byte temp_pomp;//  byte on_of_pomp;//on-off  (1  0) byte ex_temp_reactor_one;//    1 byte ex_temp_reactor_two;//    2 byte current_temp_reactor;//    byte timer_ex;// byte tmp;//   byte CRC8;//   void pask() { CRC8 = (start_byte_one + start_byte_two + temp_pomp + on_of_pomp + ex_temp_reactor_one + ex_temp_reactor_two + current_temp_reactor + timer_ex + tmp) / 10; } /* */ bool test_pask() { if (CRC8 == ((start_byte_one + start_byte_two + temp_pomp + on_of_pomp + ex_temp_reactor_one + ex_temp_reactor_two + current_temp_reactor + timer_ex + tmp)) / 10) return 0; // return 1; //  } };</span></span></code> </pre> <br>  Since the Chinese protocol is silent, if the sent packet does not fit the description, selecting the structure, I generally started to think that it was broken, but in the end everything turned out.  When I saw the first correct numbers in the log, there was happiness ... <br><br>  In order to protect the controller on the Arduino nano from moisture, I decided to etch my own board and place it in the case.  The matter is not tricky, there are many descriptions of how to do it, but I chose LUT technology.  ( <a href="https://habr.com/ru/post/45322/">LUT</a> ).  The hardest part was finding the right glossy inkjet paper on which the laser printer normally prints.  But after all the trial and error, it turned out such a device. <br><br><img src="https://habrastorage.org/webt/wn/jh/nl/wnjhnloq4nhjbnsz9pasaehoh9y.jpeg"><br><br>  But what about the program on the computer, with buttons and windows.  The blessing on Qt is very easy to do such things.  We are able to form requests and read them from the ‚Äúbassurman‚Äù device, now it is necessary that we can set the modes, build a time-temperature graph, issue a report on the heating rate to the set temperature at the end of the reaction, the reaction time itself, the cooling rate to a certain temperature and etc.  By combining all this into a separate structure, via QSerialPort, through the COM port to which Arduinka itself is connected, we transmit and receive values. <br><br>  The most difficult thing was to compile the finished project under Windows XP.  Unfortunately, these systems are at work and I had to dance with a tambourine for a couple of days to make it work.  Since I did this for the second day, unconsciously and going through all the proposed options from the forums, I will not post exact instructions. <br><br>  The result was a program that works and helps me at my workplace and saves a lot of time (I will not post the QT project, as there is nothing interesting there. Data transfer through QSerialPort, and then what the soul desires). <br><br>  Links to firmware for Arduynok: <br><br>  ‚Üí <a href="https://yadi.sk/d/07PRVRtvsO0NCg">For Nano</a> <br>  ‚Üí <a href="https://yadi.sk/d/BvRShSy--TqU1w">For Mega</a> </div><p>Source: <a href="https://habr.com/ru/post/448212/">https://habr.com/ru/post/448212/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../448196/index.html">The future (or secret present) of plasma engines or how to achieve 27 max moves in the atmosphere</a></li>
<li><a href="../448202/index.html">Manage generator or fight against ADC in STM32F030</a></li>
<li><a href="../448206/index.html">Modular development or the way there, not back</a></li>
<li><a href="../448208/index.html">20, 100, 3, 19 - InoThings in numbers</a></li>
<li><a href="../448210/index.html">A satellite cannon, a blaster and a sun-walker: funny and paradoxical projects</a></li>
<li><a href="../448218/index.html">New MFP security level: imageRUNNER ADVANCE III</a></li>
<li><a href="../448220/index.html">GLTF and GLB format basics, part 1</a></li>
<li><a href="../448222/index.html">GPU, hexagonal accelerators and linear algebra</a></li>
<li><a href="../448228/index.html">Types of modeling. Basics of Sculpting, Retopology and Sweep</a></li>
<li><a href="../448230/index.html">Manage Business Continuity with ClearView</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>