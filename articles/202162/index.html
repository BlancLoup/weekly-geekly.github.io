<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implicit predicates</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Here we will talk about some aspects of computer security related to the entanglement of the program code. That was what I was interested in in connec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implicit predicates</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/a15/ac3/6bc/a15ac36bc9a171e26037b67a8aaceb65.png" align="left">  Here we will talk about some aspects of computer security related to the entanglement of the program code.  That was what I was interested in in connection with the development of the .NET application obfuscator - a program to protect the .NET code from hacking.  There is another - the dark side: the developers of viruses and other bad things are very interested in code obfuscation, but they are not interesting for us. <br><br><br clear="all"><h4>  Emulators </h4><br>  So, you have come up with a super algorithm for tangling the program code.  When decompiling, the code looks simply out of order and no one will analyze it exactly.  It seemed: victory!  But no.  Naturally, nobody will analyze the obfuscated code ... by hand.  The hacker will understand how you tangled the code and write "unraveling".  If your algorithm was strong enough, then the hacker will have to write his own emulator, but this is not such a problem as it may seem at first glance - there are available emulators on the network and even specially written for hacking purposes. <br><br>  From the theory of computer science it is known that there is no and there will never be an algorithm that determines whether a program will stop or work forever - the so-called ‚Äústop problem‚Äù.  This ensures that a hacker emulator, unraveling an obfuscated program, will do it as if ‚Äúlocally‚Äù: it will not be able to find out the state and value of all variables involved in each code segment and therefore at the points of conditional branching it will often be assumed that all possible variations programs.  It is here that a solution comes to mind: a tangled code will be filled with transitions to conditions that will always be true, but it will be difficult to emulate and understand.  Like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((x+x &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) good_code <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> </code> </pre> <br><br>  ‚ÄúBut this is just one of those tangles that a hacker is going to bypass with an emulator,‚Äù you will say, and you will be right.  And what if you come up with a thousand such tricks?  Oh, this is a solution if you have a legion of programmers, each of whom comes up with tricks not similar to the tricks of others.  In reality, this is not the case.  In reality, you think a week and come up with thirty tricks, and the hacker looks at the code one day and finds all thirty tricks, because thirty is not so much. <br><br><a name="habracut"></a><br>  In the domain associated with code obfuscation, identically true conditional expressions are called ‚Äúimplicit predicates‚Äù (the original term ‚Äúopaque predicates‚Äù).  Further I will use the words ‚Äúpredicate‚Äù and ‚Äúcondition‚Äù as synonyms.  This topic was invented a long time ago and I honestly do not know who the original author is, there must be folklore.  Several prominent predicate articles: <br><br><ul><li>  <a href="http://crypto.cs.mcgill.ca/~garboit/sp-paper.pdf">http://crypto.cs.mcgill.ca/~garboit/sp-paper.pdf</a> </li><li>  <a href="http://citeseerx.ist.psu.edu/viewdoc/summary%3Fdoi%3D10.1.1.302.2312">citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.302.2312</a> </li><li>  <a href="http://sandmark.cs.arizona.edu/ginger_pubs_talks/icecr7_paper.pdf">sandmark.cs.arizona.edu/ginger_pubs_talks/icecr7_paper.pdf</a> </li></ul><br><br><h4>  Ideal generator of implicit predicates </h4><br>  We formulate what a perfect super implicit predicate generator should look like.  It creates predicates P (x1, x2, ..., xn), depending on the variables x1, x2, ..., xn, and can create both identically true and not always true predicates depending on the desire of the user of the generator.  And the generator has the following fantastic characteristics: <br><br><ol><li>  the predicate is generated in linear time from length; </li><li>  the predicate is very similar to the usual condition from the usual program (secrecy); </li><li>  there is not and cannot exist (!) an algorithm that would determine that the predicate is generated by our generator; </li><li>  there is not and cannot exist (!) an algorithm that, according to the generated predicate, it can always determine whether it is true or there are input parameters on which it is false; </li><li>  there is no probabilistic algorithm that would correctly determine, on average, in at least 80% of cases (the figure is found using a scientific method) whether the predicate created by the generator is identically true. </li></ol><br>  Now it is necessary to understand whether such a thing is theoretically possible. <br><br>  <b>Point 4 seems to be possible</b> .  Let me remind you that the Diophantine equation is an equation of the form f (x1, x2, ..., xn) = 0, where f is a polynomial with integer coefficients, and X are non-negative integer numbers.  Turning again to the theory of computer science, we recall that there is not and cannot exist an algorithm that, according to any Diophantine equation, would determine whether it has a solution or not.  In particular, according to Fermat's great theorem, the Diophantine equation (x + 1) * (x + 1) * (x + 1) + (y + 1) * (y + 1) * (y + 1) - (z + 1 ) * (z + 1) * (z + 1) = 0 has no solutions.  It seemed: this is where to dig!  But do not hurry.  The Diophantine equation is not a set of sums and products of ints with values ‚Äã‚Äãfrom 0 to 4 billion, but a set of sums and products of integers with values ‚Äã‚Äãfrom 0 to infinity.  You will have to write them down with the help of the so-called ‚Äúlong arithmetic‚Äù and they will look very strange in the code. <br><br>  <b>Point 2 bothers everyone</b> .  Intuitively secretive, we call a predicate that does not stand out in a crowd of real, "non-tacit" predicates from real programs.  Smart people have already analyzed many typical applications and found that most of the predicates in them are completely uncomplicated: x == 0, x == y, x&gt; 0, etc., where x, y are int variables (in the second of these Above the articles, smart people just in between analyze the conditions of typical java programs).  No need to guess for a long time to understand that the condition of secrecy is very important for predicates.  Indeed, a hacker can simply find all the ‚Äústrange‚Äù predicates and somehow isolate them or even remove them altogether, which we do not need at all. <br><br>  <b>Point 4 is not possible due to point 2 ... though</b> .  So, if a predicate is arithmetic and it is ‚Äúhidden‚Äù, then it is likely that only arithmetic with integers is involved in it, which means there is an algorithm that will check whether the predicate is always true: just select all the values ‚Äã‚Äãof ints included in the predicate.  But this is not bad, because at best, for the analysis of the predicate, you will have to go over 4 billion values!  And if there are two variables in the predicate?  So we, with a clear conscience, assuming that P &lt;NP, weaken the fourth characteristic of the generator: the task of identifying the fact that the predicate created by the generator is always true should be NP-complete.  Of course, if it turns out that P = NP, then this is also hardly an option, but for now you can sleep well.  Here I recall the 3-SAT - the well-known NP-complete task that God himself commanded to recall at this moment.  But the predicates obtained along this path can hardly be called hidden. <br><br>  Paragraphs 1, 3 and 5 are left silent - too delicate question for a short article. <br><br><h4>  Program execution graph </h4><br>  Arithmetic predicates are called predicates of the form f (x1, ..., xn) &lt;g (x1, ... xn) or f (x1, ..., xn) == g (x1, ..., xn), where all X are of the int type, and f and g are ordinary arithmetic expressions.  Why should the predicate necessarily be arithmetic?  No, I should not and do not even say that in the text below I can convince you that I must.  Nevertheless, I will cite the considerations that led me to believe that arithmetic predicates are the most real. <br><br>  If you think about it, then it is clear that obfuscation with the help of implicit predicates has one main goal - to entangle the graph of program execution.  The execution graph is the only piece of information that we have at the obfuscation stage and which the hacker does not have at the hacking stage.  We have found above that it is indeed theoretically possible to permanently confuse this information. <br><br>  Is the arithmetic predicate implicit (that is, always true)?  This is an NP-complete task.  What does this pointer indicate in this place of the program?  This is an unsolvable problem, that is, there is no general algorithm for solving such an issue, as in the case of a stop problem.  That's fine: the unsolvable is better than the NP-complete.  The following idea of ‚Äã‚Äãthe method of constructing implicit predicates is drawn from the second article cited above (Collberg, Clark, Low). <br><br>  Let's, since we have the execution graph, we will scroll through the program invisible code that builds and modifies somewhere in memory some rather complex dynamic structure.  It really may not be noticeable: who knows what it took to write to memory? <br>  And we will know at each specific point of the program what the structure state is and what the pointers contained in it indicate. <br>  Based on this knowledge, we stick in implicit predicates and dead code under implicit predicates, which causes some parts of the program that modify our hidden structure. <br>  As a result, the hacker no longer possesses our knowledge of the structure, unless he solves the unsolvable problem of resolving pointers. <br>  Consider a toy example.  Let a part of the initial graph of the program execution look like: <br><img src="http://habrastorage.org/storage3/beb/5e8/f9b/beb5e8f9b26166cd3362cfc70bd3db4d.png"><br>  In the obfuscated program, we form in memory a wildly complex structure consisting of one four-byte number and a pointer to this number.  Let p be a pointer.  Let at the entrance to the left drawn piece of the graph (* p) is guaranteed to be 1. The graph is modified as follows: <br><img src="https://habrastorage.org/getpro/habr/post_images/dd2/d2b/589/dd2d2b589ba962b53a0469158b25848f.png"><br>  If it was previously possible to find out that * p == 1 could be difficult, then now you can additionally make an incorrect assumption on this piece, that sometimes * p == 7 and in the left part of the figure. <br><br>  This is a good method and is better than arithmetic predicates.  But there is one big BUT: in reality, we, like the hacker, do not know the execution graph.  All this mean reflex, callbacks / delegates and other unpredictable ways to execute code.  And if the code is generated in memory?  Yes, this also happens, and especially in .NET.  However, we know the execution graph locally.  In .NET, at a minimum, you can be confident in the graph of code execution within each specific method.  But if you insert the creation and construction of a certain structure in memory in each method, then it is unlikely to be secretive.  This is how stealth, or rather its absence, prevents us from using this method. <br><br>  There are other methods for constructing implicit predicates, but all of them (those I heard with the edge of my ear) are tied to the graph of the execution of the entire program and look cumbersome in the context of one method.  Another thing is arithmetic predicates. <br><br><h4>  Implementation </h4><br>  In an ideal implicit predicate generator there is another big plus: the algorithm of your generator should not be secret!  Our implementation of the generator, unfortunately, is not quite perfect, and we will not disclose all the details of the implementation of our algorithm.  However, I did not find someone even close to the ideal generator.  The topic is very interesting, and I would be happy to continue its discussion in the comments. <br><br>  Below are some of the results of our implicit predicate generator.  Excerpts from the beginning, middle, and end of the list of predicates (3000 pieces; priority of operations as in # ~; * /%; + -; ""; &amp;; ^; |; all int variables): <br><br><pre> <code class="hljs go"> ~x != x (x + x &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> (x + -x &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> ~x != x * <span class="hljs-number"><span class="hljs-number">4</span></span>u &gt;&gt; <span class="hljs-number"><span class="hljs-number">2</span></span> (-x &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>) == (x &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>) ((-x ^ x) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> (x * <span class="hljs-number"><span class="hljs-number">0x80</span></span> &amp; <span class="hljs-number"><span class="hljs-number">0x56</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span> ^ <span class="hljs-number"><span class="hljs-number">0x1765</span></span>) != <span class="hljs-number"><span class="hljs-number">0</span></span> ~(-x * <span class="hljs-number"><span class="hljs-number">0x40</span></span>) != x &lt;&lt; <span class="hljs-number"><span class="hljs-number">6</span></span> (~(x * <span class="hljs-number"><span class="hljs-number">0x80</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x3d</span></span>) == <span class="hljs-number"><span class="hljs-number">0x3d</span></span> x - <span class="hljs-number"><span class="hljs-number">0x9d227f</span></span>a9 != x - <span class="hljs-number"><span class="hljs-number">0x699c945e</span></span> (y ^ y - <span class="hljs-number"><span class="hljs-number">0x35f5f4d</span></span>2) != <span class="hljs-number"><span class="hljs-number">0x42a26409</span></span> (x * <span class="hljs-number"><span class="hljs-number">0x20000000</span></span> &amp; <span class="hljs-number"><span class="hljs-number">0x19a27923</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(y * <span class="hljs-number"><span class="hljs-number">9</span></span>u + y * <span class="hljs-number"><span class="hljs-number">0xf7</span></span>u &gt;&gt; <span class="hljs-number"><span class="hljs-number">3</span></span>) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> (x * <span class="hljs-number"><span class="hljs-number">4</span></span> &amp; <span class="hljs-number"><span class="hljs-number">8</span></span>) == (x + x * <span class="hljs-number"><span class="hljs-number">3</span></span> - <span class="hljs-number"><span class="hljs-number">0x1fef9d8f</span></span> &amp; <span class="hljs-number"><span class="hljs-number">8</span></span>) (x | <span class="hljs-number"><span class="hljs-number">0xffffd</span></span>be8) - <span class="hljs-number"><span class="hljs-number">0x1baa</span></span> != x || (x &amp; <span class="hljs-number"><span class="hljs-number">0x10</span></span>) == <span class="hljs-number"><span class="hljs-number">0x10</span></span> (x ^ <span class="hljs-number"><span class="hljs-number">0x1145f</span></span>) != <span class="hljs-number"><span class="hljs-number">0</span></span> || (x | <span class="hljs-number"><span class="hljs-number">0xfffeffff</span></span>) == <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>)x / <span class="hljs-number"><span class="hljs-number">0x59d</span></span>7e3 != <span class="hljs-number"><span class="hljs-number">0x90298cf</span></span>9 || (x * <span class="hljs-number"><span class="hljs-number">3</span></span> + x &amp; <span class="hljs-number"><span class="hljs-number">3</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>)x % <span class="hljs-number"><span class="hljs-number">0x38</span></span> + <span class="hljs-number"><span class="hljs-number">0xe4df</span></span>62c8 &amp; <span class="hljs-number"><span class="hljs-number">0x6d</span></span>755e00) == <span class="hljs-number"><span class="hljs-number">0x64554200</span></span> (x ^ <span class="hljs-number"><span class="hljs-number">0x770363c6</span></span>) != <span class="hljs-number"><span class="hljs-number">0</span></span> || ((<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>)x &gt;&gt; <span class="hljs-number"><span class="hljs-number">0x19</span></span> ^ <span class="hljs-number"><span class="hljs-number">0x926797eb</span></span>) != <span class="hljs-number"><span class="hljs-number">0</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>)y / <span class="hljs-number"><span class="hljs-number">0x2369af</span></span>8 - <span class="hljs-number"><span class="hljs-number">0x78400000</span></span> != (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>)x / <span class="hljs-number"><span class="hljs-number">0x1f</span></span>2ce * <span class="hljs-number"><span class="hljs-number">0x10</span></span> (x &amp; <span class="hljs-number"><span class="hljs-number">0x8e3ef</span></span>800) != <span class="hljs-number"><span class="hljs-number">0x70641d</span></span>eb &amp;&amp; (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>)x / <span class="hljs-number"><span class="hljs-number">0x9388ea</span></span> != <span class="hljs-number"><span class="hljs-number">0x3ab6921c</span></span></code> </pre><br><br>  <i>Publication author: Dmitry Kosolobov, <a href="http://appfuscator.com/">Appfuscator</a> developer.</i> </div><p>Source: <a href="https://habr.com/ru/post/202162/">https://habr.com/ru/post/202162/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../202146/index.html">It seems to me that the software hell is already close ...</a></li>
<li><a href="../202150/index.html">About cloud backups: use Rackspace CloudFiles</a></li>
<li><a href="../202152/index.html">Life hacking: in any incomprehensible situation, multiply by three</a></li>
<li><a href="../202154/index.html">Copy-Paste and muons</a></li>
<li><a href="../202158/index.html">Geant4 Continuation Check</a></li>
<li><a href="../202164/index.html">Well, Pebble, wait a minute</a></li>
<li><a href="../202166/index.html">Live broadcast launch Visual Studio 2013 in Russia!</a></li>
<li><a href="../202168/index.html">Added support for Yandex.Maps version 2.1 in angular.js module yaMap</a></li>
<li><a href="../202170/index.html">Video of October Python Meetup Reports</a></li>
<li><a href="../202172/index.html">Liberator recognized as a deadly weapon</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>