<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Accelerate OpenVPN for $ 9.99 * or embed Orange Pi One into a router</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some of us do not use the Internet without VPN for one reason or another: someone needs a dedicated IP, and it's easier and cheaper to buy VPS with tw...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Accelerate OpenVPN for $ 9.99 * or embed Orange Pi One into a router</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/geektimes/post_images/52f/00c/984/52f00c9842f76b1ecfe01843a90d3259.jpg" alt="image"><br><br>  Some of us do not use the Internet without VPN for one reason or another: someone needs a dedicated IP, and it's easier and cheaper to buy VPS with two IPs than to buy an address from an ISP, someone wants to get access to all websites, and not only allowed on the territory of the Russian Federation, third needs IPv6, but the provider does not provide it ... <br>  Most often, a VPN connection is established on the device itself, which is used at some point, which is justified if you have only one computer and one phone, and you rarely use them at the same time.  If there are many devices in your home network, or, for example, there are those on which you cannot configure VPN, it would be more convenient to raise the tunnel directly on the home router, so as not to think about setting up each device separately. <br><br>  If you ever installed OpenVPN on your router, you were probably unpleasantly surprised by the speed of its work.  <abbr title="System-on-chip">SoC</abbr> 'and even cheap routers pass around okigigabit traffic without any problems, due to the removal of the routing and NAT functions on a separate chip designed exclusively for this task, and the main processors of such routers are rather weak, since  There is practically no load on them.  Such a compromise allows you to achieve high speed of the router and significantly reduce the price of the finished device - routers with powerful processors are several times more expensive, and are positioned not only as a box for distributing the Internet, but also as a NAS, torrentokachalki and home multimedia system. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      My router, TP-Link TL-WDR4300, cannot be called new - the model appeared in the middle of 2012 and has a 560 MHz processor of the MIPS32 74Kc architecture, which has enough power for 20-23 Mb / s of encrypted traffic through OpenVPN, which is by the standards The speed of the modern home Internet is quite a bit. <br>  How can we increase the speed of an encrypted tunnel?  My router is quite functional, supports 3x3 MIMO, and indeed, it works well, I would not want to change it. <br>  Since it is now customary to do 10-megabyte Internet pages, write desktop applications on node.js and pack them into a 100-megabyte file, increase computing capacity instead of optimization, we will do something awful - we will transfer the VPN connection to the productive single-board Orange computer Pi One, which we install into the router case, without taking up the existing network and USB ports, for only $ 9.99 *! <br>  <sub>* + shipping, + taxes, + beer, + microSD.</sub> <a name="habracut"></a><br><br><h3>  Openvpn </h3>  You can‚Äôt call the router processor completely weak - it can encrypt and hash data with the AES-128-CBC-SHA1 algorithm with a speed of 50 Mb / s, which is much faster than OpenVPN, and the modern stream cipher CHACHA20 with the POLY1305 hash does 130 megabits per second!  Why is the speed of the VPN tunnel so low?  It‚Äôs all about context switching between user space and kernel space: OpenVPN encrypts traffic and communicates with the outside world in the context of the user, and in the context of the kernel, routing happens.  The operating system has to constantly switch back and forth, here, to each received or transmitted packet, but this operation is not fast.  This problem is inherent in all VPN applications running through the TUN / TAP driver, and it cannot be said that the problem of low speed is caused by poor OpenVPN optimization (although, of course, there are places that need to be redone).  Not a single userspace VPN client issues even a gigabit with encryption disabled on my laptop, let alone a system with a weak processor. <br><br><h3>  Orange pi one </h3>  Xunlong's Orange Pi One odnoplatnik is the best deal in terms of performance / price at the moment.  For $ 9.99 *, you get a good quad-core ARM Cortex-A7 processor (stably) operating at a frequency of 1008 MHz, and obviously more productive than the neighbors Raspberry Pi Zero and Next Thing CHIP by price category.  This pluses end.  The Xunlong company pays exactly zero attention to its motherboard software, and at the time One was launched, it didn‚Äôt even offer a board configuration file, let alone ready-made images.  Allwinner - the manufacturer of SoC - is also not particularly sensitive to the support of its product.  They are only interested in the minimum performance in the OS Android 4.4.4, which means that we are forced to use the kernel version 3.4 with Android patches.  Fortunately, there are enthusiasts who compile distributions, rule the kernel, write code to support boards in the mainline core, i.e.  actually do the work for the manufacturer, forcing this shit acceptable work.  For my purposes, I chose the Armbian distribution, it is often conveniently updated (new kernels are installed directly through the batch manager, not by copying files to a special partition, as is usually the case with Allwinner), and most peripherals are supported, unlike the others. <br><br><h3>  Router </h3>  In order not to load the weak processor of the router with encryption and speed up our VPN connection, we can shift this task onto the shoulders of a more productive Orange Pi processor by connecting it to the router in any way.  A connection comes to mind either via Ethernet or USB - both of these standards are supported by both devices, but I didn‚Äôt want to occupy already existing ports.  Fortunately, there is a way out. <br><br>  The GL850G USB hub chip used in the router supports 4 USB ports, two of which are not soldered.  It is unclear why the manufacturer did not unplug them, I suppose, to prevent users from connecting 4 devices with high current consumption (for example, hard drives), since  The standard power supply of the router is not designed for such a load.  In any case, it is in our favor. <br><img src="https://habrastorage.org/getpro/geektimes/post_images/fee/578/d8b/fee578d8b9d622074e4bc27d30aac87f.png" alt="image"><br>  In order to get another USB port, it is enough to solder two wires to 8 (D-) and 9 (D +) or 11 (D-) and 12 (D +) pins. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/9a7/695/d6b/9a7695d6b2efc2b4f375ed73682315e7.jpg" alt="image"><br><br>  However, it is not enough just to connect two USB devices and hope that everything will work by itself, as it would have happened with Ethernet.  First, we need to make one of them work in the USB Client mode, not the USB Host, and second, we need to decide how the devices will determine each other.  There are many drivers of so-called USB Gadgets (after the name of the Linux kernel subsystem), which allow you to emulate various types of USB devices: network adapter, audio card, keyboard and mouse, USB flash drive, camera, console through the serial port.  Since our device will work with the network, we are best suited to emulate an Ethernet adapter. <br><br>  There are three standards for Ethernet-over-USB: <br><ul><li>  <b>Remote NDIS (RNDIS)</b> .  Outdated standard from Microsoft, used primarily in the days of Windows XP. </li><li>  <b>Ethernet Control Model (ECM)</b> .  A simple standard that encapsulates Ethernet frames into USB packets.  Great for wired modems with USB-connection, where it is convenient to transfer frames without processing, but because of its simplicity and limitations of USB-bus does not work too fast. </li><li>  <b>Ethernet Emulation Model (EEM)</b> .  A smarter protocol that takes into account the limitations of USB and optimally aggregates several frames into one, thus increasing throughput. </li><li>  <b>Network Control Model (NCM)</b> .  The newest protocol.  It has the advantages of EEM and further optimizes work with the bus. </li></ul><br>  To make any of these protocols work on our board, as always, we will have to face some difficulties.  Due to the fact that Allwinner is only interested in the Android part of the kernel, only Android Gadget works fine - the code that implements communication with adb, exporting the device using the MTP protocol and emulating a flash drive on Android devices.  Android Gadget itself supports the RNDIS protocol, but it is broken in the Allwinner core.  If you try to compile the kernel with any other USB Gadget, the device simply does not appear in the system, no matter what you do. <br>  To solve the problem, in an amicable way, you need to find a place for initializing the USB controller in the Android-gadget-modified Android gadget code android.c, but there is also a workaround to make at least Ethernet emulation via USB: <br><pre><code class="hljs rust">--- sun8i/drivers/usb/sunxi_usb/udc/sunxi_udc.c <span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">40.427088792</span></span> +<span class="hljs-number"><span class="hljs-number">0300</span></span> +++ sun8i/drivers/usb/sunxi_usb/udc/sunxi_udc.c <span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">45.339088792</span></span> +<span class="hljs-number"><span class="hljs-number">0300</span></span> @@ -<span class="hljs-number"><span class="hljs-number">57</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> +<span class="hljs-number"><span class="hljs-number">57</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> @@ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> sunxi_udc_io_t g_sunxi_udc_io; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span> usb_connect = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span> is_controller_alive = <span class="hljs-number"><span class="hljs-number">0</span></span>; -<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span> is_udc_enable = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* is udc enable by gadget? */</span></span> +<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span> is_udc_enable = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* is udc enable by gadget? */</span></span> #ifdef CONFIG_USB_SUNXI_USB0_OTG <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">platform_device</span></span></span></span> *g_udc_pdev = NULL;</code> </pre>  This patch forcibly turns on the USB client mode, which allows you to use ordinary USB Gadgets from Linux. <br>  Now you should rebuild the kernel with this patch and the necessary gadget.  I chose EEM because  according to test results, it turned out to be more productive than NCM. <br>  The Armbian team provides a <a href="https://github.com/igorpecovnik/lib">very simple and convenient build system</a> for all supported boards in the distribution.  Just download it, put our patch in <code>userpatches/kernel/sun8i-default/otg.patch</code> , edit <code>compile.sh</code> and choose the gadget you need: <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/d55/7e5/842/d557e584204408fc98d4c444e30138ed.png" alt="image"><br><br>  The kernel will be assembled into a deb-package, which is not difficult to install on the board through <code>dpkg</code> . <br>  It remains only to connect the board via USB and configure our new network adapter to receive the address via DHCP.  To do this, add something like the following in <code>/etc/network/interfaces</code> : <br><pre> <code class="hljs pgsql">auto usb0 iface usb0 <span class="hljs-type"><span class="hljs-type">inet</span></span> dhcp hwaddress ether c2:<span class="hljs-number"><span class="hljs-number">46</span></span>:<span class="hljs-number"><span class="hljs-number">98</span></span>:<span class="hljs-number"><span class="hljs-number">49</span></span>:<span class="hljs-number"><span class="hljs-number">3</span></span>e:<span class="hljs-number"><span class="hljs-number">9</span></span>d pre-up /bin/sh -c <span class="hljs-string"><span class="hljs-string">'echo 2 &gt; /sys/bus/platform/devices/sunxi_usb_udc/otg_role'</span></span></code> </pre>  It is better to set the MAC address manually, since  it will be random with each reboot of the device, which is inconvenient and troublesome. <br>  We connect the microUSB cable to the OTG connector, connect the power from the router (it can be fed to 2 and 3 pins of the comb, and not just to the power connector). <br><br>  It remains to configure the router.  Just install the package with the EEM driver and add our new USB network device to the bridge of the local firewall zone: <br><pre> <code class="hljs sql">opkg <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> kmod-usb-net-cdc-eem</code> </pre> <img src="https://habrastorage.org/getpro/geektimes/post_images/ccc/3ce/49b/ccc3ce49bf30f23e200d9e7e27114c0d.png" alt="image"><br>  To route all traffic to the VPN tunnel, you must either add a SNAT rule to the board's IP address on the router side, or distribute the board address via dnsmasq as the gateway address.  The latter is done by adding the following line to <code>/etc/dnsmasq.conf</code> : <br><pre> <code class="hljs pgsql">dhcp-<span class="hljs-keyword"><span class="hljs-keyword">option</span></span> = tag:lan, <span class="hljs-keyword"><span class="hljs-keyword">option</span></span>:router, <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span></code> </pre>  where <code>192.168.1.100</code> is the IP address of your board.  Do not forget to register the router address in the network settings on the board itself! <br><br>  To isolate the contacts of the board from the contacts of the router, a melamine sponge was used.  It turned out something like this: <br><img src="https://habrastorage.org/getpro/geektimes/post_images/d2f/87a/a77/d2f87aa77a1681ecf2c8bb943107bed1.jpg" alt="image"><br><br><h3>  Conclusion </h3>  The network works via USB surprisingly fast: 100-120 Mb / s, I expected less.  OpenVPN passes about 70 Mb / s of encrypted traffic through itself, which is also not very much, but enough for my needs.  The cover of the router does not close tightly, leaving a small gap.  The aesthetes can drop out Ethernet and USB Host connectors at the board, which will allow the lid to close completely, and there is still room. <br>  And it is better not to engage in such pornography and buy a <a href="https://omnia.turris.cz/en/">Turris Omnia</a> . </div><p>Source: <a href="https://habr.com/ru/post/368735/">https://habr.com/ru/post/368735/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../368725/index.html">VRToday - what is virtual reality in Russia today?</a></li>
<li><a href="../368727/index.html">New military chips use approximate calculations.</a></li>
<li><a href="../368729/index.html">Scientists have created the world's smallest engine, the size of a little more than one atom</a></li>
<li><a href="../368731/index.html">Mobile applications of restaurants: What customers want</a></li>
<li><a href="../368733/index.html">Stephen Hawking about labor market robots</a></li>
<li><a href="../368737/index.html">Why I say goodbye to Apple, Google and Microsoft</a></li>
<li><a href="../368739/index.html">How Dell laptops improve the efficiency of training in the oil and gas industry</a></li>
<li><a href="../368743/index.html">Banks in Denmark began to pay interest to mortgage borrowers</a></li>
<li><a href="../368747/index.html">Smart float with a video camera and Wi-Fi will help you find a "fish" place</a></li>
<li><a href="../368749/index.html">Andy Grove and the turning points of Intel history</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>