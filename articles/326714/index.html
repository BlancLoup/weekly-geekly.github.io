<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Source Code Analysis and Prince of Persia Copy Protection</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Part 1: introduction 
 On April 17, 2012, Jordan Mekner published the source code of Prince of Persia. 

 Even despite the fact that this is the versi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Source Code Analysis and Prince of Persia Copy Protection</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b2c/5be/ef7/b2c5beef77f47661bee436d8371b1c8d.jpg" alt="image"></div><br><h1>  Part 1: introduction </h1><br>  On April 17, 2012, Jordan Mekner <a href="http://jordanmechner.com/blog/2012/04/source/">published the source code of</a> Prince of Persia. <br><br>  Even despite the fact that this is the version for Apple II, written in assembler processor 6502, it was very nice to dive into the code of this legendary game.  As usual, I was waiting for a lot of program interesting. <br><br>  The obviously weak Apple II programming environment was in fact the foundation of incomparable innovation and creativity: self-modifying code, internal loader, smart floppy disk format, and shifting lookup tables.  In each of its module Prince Of Persia stores the treasures of engineering. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Reading the source allowed me not only to learn more about the game development process in the 80s, but also again caused a sense of appreciation for those things that are considered natural today. <br><br>  As usual, I kept detailed notes and created this article based on them.  I hope it inspires others to read the source code and improve their development skills. <br><a name="habracut"></a><br>  <u>Acknowledgments:</u> I want to thank Miles.J for 6502.org and Roland Gustafsson (author RWTS18) for sharing their knowledge with me. <br><br><h2>  Where to begin? </h2><br>  <a href="https://github.com/jmechner/Prince-of-Persia-Apple-II">The source code</a> is available in the repository on GitHub and can be downloaded with one command: <br><br><pre><code class="hljs php">git <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span> git:<span class="hljs-comment"><span class="hljs-comment">//github.com/jmechner/Prince-of-Persia-Apple-II.git</span></span></code> </pre> <br>  The interesting part is in the <code>/Prince-of-Persia-Apple-II/01 POP Source/Source/</code> folder, which contains a game engine made up of many <code>.S</code> files. <br><br>  This is the first thing that programmers did not have at the time: high-level languages ‚Äã‚Äãwith high-quality compilers.  In order to achieve good speed, developers had to work directly with hardware in 6502 assembly language. It is from this that these <code>.S</code> files consist. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7d3/e41/baa/7d3e41baa69d3565037fd9e8303cd1d3.png"><br><br>  According to Jordan Mekner‚Äôs book <a href="http://www.amazon.com/The-Making-Prince-Persia-Journals/dp/1468093657/ref%3Dsr_1_1%3Fie%3DUTF8%26qid%3D1370971768%26sr%3D8-1%26keywords%3Dmaking%2Bof%2Bprince%2Bof%2Bpersia">Making of Prince of Persia</a> , Merlin assembler was used in PoP. <br><br>  One of the good features of Merlin is the <code>ORG</code> directive, which lets you tell the assembler where the instructions will be loaded into RAM: the PoP <code>ORG</code> is located at the beginning of each file. <br><br>  <u><b>Interesting fact:</b></u> <code>ORG</code> directives were really just directions.  In Apple II, there was no operating system, no linker or bootloader: the developer himself had to somehow manage to transfer instructions from the floppy disk to the right place. <br><br>  The second important point that needs to be understood for the perception of PoP as a whole is the way information is exchanged between modules.  Since at that time there was no cross-file linker (and the final executable file, only fragments), the modules must exchange data, making the transition to the void ... in which other modules should have been. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/227/c27/6f0/227c276f02cd6d292c0731cbab7d67b8.png"><br><br>  An example of this we can see in the bootloader <code>BOOT.S</code> in <a href="">line 138</a> : <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">jmp</span></span> <span class="hljs-variable"><span class="hljs-variable">$ee00</span></span></code> </pre> <br>  And it is quite mysterious. <br><br>  To follow the flow of instructions, we need to find out what is in <code>$ee00</code> .  With the help of a small grep command, you can see <code>org = $ee00</code> in <code>HIRES.S</code> and transfer. <br><br>  Since there were no linkers, the developers of the 80s needed to know the engine's memory scheme and understand the limitations of RAM.  This is now quite rare, because most professionals rely on garbage collectors or the use of vectors with automatic resizing. <br><br><h2>  6502 assembler </h2><br>  I will talk about it in order to present a general picture and explain how to perform the transition between subsystems.  To understand the contents of each module, you need to know a little about the central processor.  Fortunately, the 6502 is a simple 16-bit processor with only three registers capable of addressing 64 KB of RAM (bank switching has expanded this volume to 128 KB), with no floating point functions and no segmentation, having only 56 instructions. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/66d/a3e/310/66da3e3105c31acc226b723ef661ea8f.png"><br><br>  The figure shows how simple it all was: <br><br><ul><li>  Gray blocks: 64 KB of RAM, including 256 bytes allocated for the stack. </li><li>  Blue blocks: 3 registers - X, A, Y (8 bits). </li><li>  Green block: one 16-bit program counter. </li><li>  Red block: one 8-bit stack pointer. </li><li>  Yellow block: several STATUS flags. </li></ul><br>  Most of the operations are designed to load and store the register, the X and Y registers have simple instructions, and the drive (A) is a bit more complicated, but generally quite straightforward and well documented. <br><br>  Two excellent books that, unfortunately, have been removed from print today: <a href="http://fd.fabiensanglard.net/prince_of_persia/a2rm.pdf">Apple II Reference Manual</a> and <a href="http://fd.fabiensanglard.net/prince_of_persia/Inside%2520the%2520Apple%2520IIe.pdf">Inside the Apple IIe</a> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a76/047/334/a7604733431832e405c62e7be888778b.jpg"><br><br><h2>  starting point </h2><br>  In the 80s there was no IDE and C source files with the <code>main</code> method, so it‚Äôs impossible to tell where the program started.  To understand where to start reading, we need to know how the Apple II was loaded: <br><br><ol><li>  Reading the first byte of X sector 0 on track 0 from a floppy disk. </li><li>  Load X sectors from track 0 into RAM at <code>$800</code> . </li><li>  Begin code execution at <code>$800</code> . </li></ol><br>  To find the starting point, we need to determine which module is specified to run at <code>$800</code> by searching for the <code>ORG</code> directive: <br><br><pre> <code class="hljs pgsql"> fabiensanglard$ find . -<span class="hljs-type"><span class="hljs-type">name</span></span> "*.S" -exec grep -H "org = \$800" {} \; ./<span class="hljs-number"><span class="hljs-number">01</span></span> POP Source/Source/BOOT.S:org = <span class="hljs-meta"><span class="hljs-meta">$800</span></span> ./<span class="hljs-number"><span class="hljs-number">02</span></span> POP Disk <span class="hljs-keyword"><span class="hljs-keyword">Routines</span></span>/CP<span class="hljs-number"><span class="hljs-number">.525</span></span>/POPBOOT0.S:org = <span class="hljs-meta"><span class="hljs-meta">$800</span></span> ./<span class="hljs-number"><span class="hljs-number">03</span></span> Disk Protection/POPBOOT0.S:org = <span class="hljs-meta"><span class="hljs-meta">$800</span></span> ./<span class="hljs-number"><span class="hljs-number">04</span></span> Support/MakeDisk/DRAZ/DRAZ.S:org = <span class="hljs-meta"><span class="hljs-meta">$800</span></span> ./<span class="hljs-number"><span class="hljs-number">04</span></span> Support/MakeDisk/S/BOOT.S:org = <span class="hljs-meta"><span class="hljs-meta">$800</span></span></code> </pre> <br>  So, the starting point is in <code>BOOT.S</code> : this file, as we will see later, contains the PoP bootloader. <br><br><h2>  Recommended reading </h2><br>  Jordan Mekner published his magazines (they can be purchased as a book or pdf).  This is a very accurate description of what game developers must go through when creating a game: doubts, pressure, despair, hope and delight. <br><br> <a href="http://www.amazon.com/The-Making-Prince-Persia-Journals/dp/1468093657/ref%3Dsr_1_1%3Fie%3DUTF8%26qid%3D1370971768%26sr%3D8-1%26keywords%3Dmaking%2Bof%2Bprince%2Bof%2Bpersia"><img src="https://habrastorage.org/getpro/habr/post_images/8df/54a/67a/8df54a67ad691bcc080ead0574f45614.jpg"></a> <a href="http://www.amazon.com/The-Making-Karateka-Journals-1982-1985/dp/1480297232/ref%3Dsr_1_1%3Fie%3DUTF8%26qid%3D1370978099%26sr%3D8-1%26keywords%3Dmaking%2Bof%2Bkarateka"><img src="https://habrastorage.org/getpro/habr/post_images/116/4df/708/1164df708766885607d126fe95d7cde4.jpg"></a> <br><br>  To understand more about the technical part, study the developer‚Äôs notes intended for Atari / Amiga / PC developers (the work on these ports wasn‚Äôt very good, but I‚Äôll not detract from the significance of the magazine ‚ÄúMaking Of‚Äù). <br><br> <a href="http://fd.fabiensanglard.net/prince_of_persia/popsource009.pdf"><img src="https://habrastorage.org/getpro/habr/post_images/b5f/7c9/12d/b5f7c912d2d46b87202e50895c201b9f.png"></a> <br><br> <a href="http://fd.fabiensanglard.net/prince_of_persia/Beneath%2520Apple%2520DOS.pdf"><img src="https://habrastorage.org/getpro/habr/post_images/d19/0fe/831/d190fe8310ac9a4f484efe37902693e7.png"></a> <br><br> <a href="http://fd.fabiensanglard.net/prince_of_persia/Inside%2520the%2520Apple%2520IIe.pdf"><img src="https://habrastorage.org/getpro/habr/post_images/413/db0/061/413db00619c03fc38ba7ca99577f4793.png"></a> <br><br> <a href="http://fd.fabiensanglard.net/prince_of_persia/a2rm.pdf"><img src="https://habrastorage.org/getpro/habr/post_images/193/5c9/419/1935c9419410766b4f705dd059a8eb11.png"></a> <br><br>  Several videos of the legendary rotoscoping process and the introduction to Tina LaDeau (Princess) mentioned in Jordan's diary. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/gC3WEwSJoHs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/0vG403uFdYc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <u><b>Note:</b></u> Jordan Mekner participated in AMA on Reddit in January 2013, you can read it <a href="http://www.reddit.com/r/IAmA/comments/14e6p3/im_jordan_mechner_creator_of_prince_of_persia_and/">here</a> . <br><br><h1>  Part 2: bootloader </h1><br>  To save RAM and computing resources, Apple II game developers did not use the operating system that came with the computer.  Therefore, they had to write their own loader: a small program that loaded the game engine from a floppy disk into RAM. <br><br>  The procedures contained in the Apple II ROM: RWTS16 was a set of instructions that managed the floppy disk and allowed it to read / write 16 sectors of 256 bytes per a track of 35 tracks.  In total, it was 140 KB to disk. <br><br>  But in the games Br√∏derbund not used RWTS16.  They found a better format: RWTS18, which provided more data and proved to be a reliable copy protection mechanism. <br><br><h2>  Traditional loader </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/c76/92d/a75/c7692da75b9e6a88dcb625ad25282c6d.png"><br><br>  Before focusing on the differences, I will list what is usually done in the video game industry: <br><br>  When the computer starts, three components interact: <br><br><ul><li>  Floppy disk </li><li>  The procedure for downloading to the Apple ROM. </li><li>  Procedures for reading a floppy disk (RWTS16) in the ROM of Apple. </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/651/436/2dc/6514362dcb301e28a6e11033ad525396.png"><br><br>  When you start Apple II: <br><br><ol><li>  The computer has installed its instruction pointer on the Apple download instructions. </li><li>  Apple's boot procedures used RWTS16 to boot sectors from a floppy disk into RAM at <code>$800</code> . </li><li>  These sectors contained a game loader. </li><li>  Apple II download procedures then went over to <code>$800</code> . </li></ol><br><img src="https://habrastorage.org/getpro/habr/post_images/e0b/717/684/e0b717684e3dfa633774678b1e66ef53.png"><br><br>  From this point on, the game loader was responsible for loading the game engine from a floppy disk into RAM: <br><br><ol><li>  Using the RWTS16 Apple II procedures ... </li><li>  He transferred the game engine from the floppy disk to the RAM ... </li><li>  And then went to the engine. </li></ol><br><h2>  RWTS16 </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/892/03c/a7c/89203ca7cde98a1ee6d88dba8267e41c.png"><br><br>  The RWTS16 was a floppy disk format shipped with the Apple II.  It is described in detail in the brilliant book " <a href="http://fd.fabiensanglard.net/prince_of_persia/Beneath%2520Apple%2520DOS.pdf">Beneath Apple DOS</a> ".  In short, it consisted of a set of procedures in the ROM that controlled the disk drive for writing and reading 16 sectors per track. <br><br>  Sectors of 256 bytes were recorded on the track as follows: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/97d/3b8/938/97d3b8938df4d5d0ccd3f0b3d4339f4e.png"><br><br>  Because the drives lacked precision, huge gaps needed to be left between sectors in order to ensure wipe / restart without overlaps: <br><br>  As you can see in the figure below, the drive head could write a little before or after the ‚Äúperfect‚Äù position.  Clearances compensated for these inaccuracies: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/414/017/21e/41401721e82b91b402e694c00f599cf8.png"><br><br><h2>  RWTS18 </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/83b/e3f/81d/83be3f81d51fd83c27547774e36ea1a2.png"><br><br>  RWTS18 was a floppy disk format created by Roland Gustafsson for Br√∏derbund.  It was completely different from RWTS16 in that it not only provided more storage, but also made life much harder for hackers. <br><br>  The increased capacity of the RWTS18 was provided by an important observation: during the development of the games, the data <u>read was</u> used rather than the write.  RWTS18 almost completely abandoned the concept of sectors: it recorded the tracks entirely and read the much larger sectors. <br><br>  This scheme eliminated most of the gaps that RWTS16 had to have between sectors: between sectors there were only XXX bytes of self-synchronization. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/557/c0c/b67/557c0cb678d750cb1340668d419ec1ce.png"><br><br>  As a result, the RWTS18 provided storage of 768 bytes in each of the 6 sectors and 157 KB per disk instead of 140 KB available on the RWTS16. <br><br>  But the increased capacity was not the only advantage of the RWTS18.  He also created copy protection mechanisms: <br><br><ul><li>  All manufactured disks had physical differences: the data was encoded differently due to the nibble table loaded by RWTS18 during execution. </li><li>  The various Prolog and Epilog sectors were confusing disc copying programs. </li></ul><br>  <u><b>Note:</b></u> RWTS18 has not completely abandoned the sectors for two reasons: <br><br><ul><li>  The maximum latency of the track reading start was 1/6 of the disk rotation. </li><li>  Developers still needed a bit of fragmentation (the full track may contain too much data). </li></ul><br>  <u><b>Note:</b></u> Roland Gustafsson added his comment: <br><br><blockquote>  According to the specification, when reading a disk, 18 sectors could be transferred to 18 different pages of RAM, and not just be consecutive readings of 18 sectors ($ 1200 bytes) in any resulting order.  This method is now used for hard drives, it seems to be called ‚Äúscatter-read‚Äù (and then it just seemed like a great idea to me!). <br><br>  The self-modifying code I used made it possible to perform 4 cyclic reads instead of 6, saving 2 cycles on read / write.  In addition, he allowed to ‚Äúdiscard‚Äù read operations, when each sector / page was not necessarily needed.  There was an API that controlled all the necessary variations.  The cycles of reading and writing internal tracks were extremely dense.  In fact, the recording procedures had to pre-process the data a bit in advance in order to perform the recording in one turn.  If I'm not mistaken, the stock was only 20%. </blockquote><br>  <u><b>Interesting fact:</b></u> Roland Gustafsson was so in love with Apple II that he made the license plate number " <code>D5 AA 96</code> " for his car (this corresponds to the three byte mark of the prologue RWTS16. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/88f/024/73c/88f02473c260e74c522aa501298148ff.jpg"></a>  <a href="">.</a> <br><br>  <u><b>An interesting fact: the</b></u> RWTS18 source code was written using the LISA assembler, which had a marked-up file format, and not just text files.  Roland plans to publish the source code as soon as he can extract it.  If you know how to do this, help him. <br><br>  <u><b>An interesting fact:</b></u> RWTS18 was so difficult to decipher that strange legends arose: they used to think that <a href="http://compgroups.net/comp.sys.apple2/toy-shop-for-apple-ii-available-and-a-long-st/1133956">slow disk drives were</a> needed to create RWTS18 disks. <br><br>  <u><b>An interesting fact: the</b></u> hackers still managed to crack Prince Of Persia ... but for further distribution they had to reverse engineer the game and burn it to three disks formatted with RWTS16.  The original version of PoP was sold on two disks with RWTS18.  Even Apple II emulators can run only the hacked version of Prince Of Persia! <br><br><h2>  Prince Of Persia Loader </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/7e9/b0d/873/7e9b0d873f962366ce146c3f38cde62d.png"><br><br>  Now we have all the information to start with the PoP downloader: <br><br>  PoP started loading in the usual way: the first track was formatted with RWTS16, so the Apple II boot procedures loaded the PoP bootloader into RAM. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/077/77a/c23/07777ac2326319ddbe1d18119bef803d.png"><br><br>  Then the PoP loader using RWTS16 loaded the RWTS18 procedures from the rest of track 0. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a6a/db1/a4e/a6adb1a4e21ffaad76b7a98cfc3f9fa3.png"><br><br>  Then the loader used RWTS18 to download the game engine from other tracks formatted with RWTS18. <br><br>  The loader switched to the game engine, which also used the RWTS18 procedures for loading game resources. <br><br><h2>  Interview with Roland Gustafsson </h2><br>  Roland agreed to answer a few questions, here is our interview: <br><br>  <b>Fabien Sanglar:</b> Hello, Roland, can you tell us a little about yourself: when you were born, where you grew up, did you like school and how did you become a programmer? <br><br>  <b>Roland Gustafsson:</b> I was born in Sweden, but I lived all my life in California.  I didn‚Äôt really like it at school, but I graduated from high school and at that time I was already programming and lived well in my 17 years.  (That's why I didn't go to college: at the university, computer science teaching was in no way connected with new interesting machines, which were called ‚Äúpersonal computers.‚Äù It was in the late 70s.) <br><br>  <b>FS:</b> How did it happen that in the 80s you started working for Br√∏derbund?  How long have you worked there?  How did the idea of ‚Äã‚ÄãRWTS18 come to you, why did you write it?  What else have you worked for in Br√∏derbund besides RWTS18? <br><br>  <b>RG:</b> I was never an employee of Br√∏derbund, I didn‚Äôt have a real job, I was always a freelancer. <br><br>  The idea of ‚Äã‚ÄãRW18 was born out of necessity.  We had Bank Street products (after Bank Street Writer) that could not fit on a standard 16-sector disc.  I used to do tricks, so I was asked if I could think of something to store more data.  I have been working on copy protection for years, thinking outside the box and fully understanding the capabilities of Disk II.  A little thought, I came to the most effective way that came to mind.  It happened on the plane on the way to Japan, so I had a lot of time on paper and a pencil.  My friend Corey Kosak was confident that he had found a way to store 19 sectors (the theoretical limit), but it used such expensive mathematical calculations that a weak 6502 wouldn't cope with them.  I use base 64 to manage nibbles by using mathematics; moreover, it was possible to store more data if I could not work with base 78 or something like that, I don‚Äôt remember.  Math introduced a little into a stupor.  And working with base 64 was, of course, very easy for binary systems. <br><br>  <b>FS:</b> How did you work with Br√∏derbund (I'm interested in the schedule, salary, passionate people like you)?  Can you compare that experience with modern working conditions? <br><br>  <b>RG:</b> I didn‚Äôt have a real job, I didn‚Äôt want it, I don‚Äôt like offices. <br><br>  <b>FS:</b> Have you ever worked on Prince of Persia?  Did you help the developers of the game or did you finish the work by transferring the source code in assembler and manual? <br><br>  <b>RG:</b> I worked directly with Jordan Mekner on the implementation of RW18 and copy protection.  We often had interesting moments when we came up with devious ways to make copying more complex.  In some cases, the game seemed to work, but as a result it became impossible to play it.  In the case of most other games, I started working after their completion and added copy protection.  An exception was the program RW18, which had to be implemented during the development phase!  I wrote a simple manual so that it can be easily used. <br><br>  <b>FS:</b> In the book Hackers: Heroes of the Computer Revolution (Hackers: Heroes of the Computer Revolution) there is a chapter dedicated to the fight against Spiradisc and Sierra On-Line against piracy.  Looking back, can you call RWTS18 an effective way to protect the Br√∏derbund from piracy of games?  Have you studied the copy protection mechanisms of other publishers (Spiradisc)?  If so, what do you think of them? <br><br>  <b>RG:</b> The only copy protection that I have carefully studied is the cassette version of Microsoft Flight Simulator.  Then I realized that there is copy protection.  From that moment on, I developed my security system and rarely studied what others were doing.  I myself came to the concept of protection with a spiral disk and used it in many Br√∏derbund and Gebelli games.  I did not know if anyone else had thought of the technology with 18 sectors, but I heard many years later that someone had copied it or had come to this method.  But I'm still not sure.  I know for sure that RW18 was invented by me. <br><br>  <b>FS:</b> Let's continue the topic of fighting software piracy: have you followed the techniques of your opponents to improve RWTS18?  Opponents sometimes pay tribute to the skill of those who are struggling: have you ever been impressed by what the pirates were able to do (for example, a pirated copy of PoP on three RWTS16 disks)? <br><br>  <b>RG:</b> Yes, I at least studied Locksmith, Nibbles Away and other copying software, and also read topics about hardware.  I added a hardware copy protection code that was so well done that Apple couldn‚Äôt figure out how to protect against it even in the then not yet announced and secret Apple // e.  Therefore, they brought this computer to my home and I made the protection work.  I hid Apple // e for a long time, until it was announced and released. <br><br>  Honestly, I think that the idea of ‚Äã‚Äãcreating a three-disk version for a two-disk game with RW18 was stupid and not very impressive.  It was better for them to create a copy system that completely recreated this RW18 format and just make exact copies!  The game would be much better, faster, etc ... <br><br>  <b>FS:</b> What kind of hack do you consider the greatest in the entire history of software development? <br><br>  <b>RG:</b> Nothing comes to mind.  I can say that when someone finds a surprisingly clever solution to a complex problem that requires inventive thinking, it is always worth recognizing. <br><br>  <b>FS:</b> What game do you like the most? <br>  <b>RG:</b> Even though I have not played for a long time, I can name the original version of Tetris for the GameBoy "network" game, when players fight against each other.  I played it very hard at Br√∏derbund. <br><br>  <b>FS:</b> Do you have a role model, a personal hero in the computer industry? <br><br>  <b>RG:</b> The fact that Steve Wozniak insisted on publishing the source code for the original Apple II's ROM has become extremely important to my learning.  I once met him at an Apple user meeting in San Francisco, I managed to talk to him and get detailed information about the Disk II system, which allowed me to do copy protection. <br><br>  <b>FS:</b> What moment are you most proud of as a software engineer? <br><br>  <b>RG:</b> Always, when I manage to exceed expectations, ‚Äúget a rabbit out of a hat,‚Äù these are amazing moments.  I still think RW18 is one of my best tricks. <br><br>  <b>FS:</b> What are you working on now? <br><br>  <b>RG:</b> I am the Technical Director of Oceanhouse Media, we are developing mobile applications.  Apple has made a real breakthrough with iOS and app development!  We are developing for other mobile markets, and we still have a lot to do.  Yes, I'm still a big Apple fan. <br><br><h2>  Recommended reading </h2><br> <a href="http://fd.fabiensanglard.net/prince_of_persia/Beneath%2520Apple%2520DOS.pdf"><img src="https://habrastorage.org/getpro/habr/post_images/d19/0fe/831/d190fe8310ac9a4f484efe37902693e7.png"></a> <br><br>  " <a href="http://fd.fabiensanglard.net/prince_of_persia/Beneath%2520Apple%2520DOS.pdf">Beneath Apple DOS</a> " is a great book that describes the internal design of Apple II computers.  It is very useful for understanding RWTS16 and broadcasting 6 + 2. <br><br> <a href="http://www.amazon.ca/Hackers-Heroes-Computer-Revolution-Anniversary/dp/1449388396/ref%3Dsr_1_1%3Fie%3DUTF8%26qid%3D1371144548%26sr%3D8-1%26keywords%3Dhackers%2Bhero"><img src="https://habrastorage.org/getpro/habr/post_images/b54/eb4/6d2/b54eb46d28da049f5a52ac565cae12f1.jpg"></a> <br><br>  <a href="http://www.amazon.ca/Hackers-Heroes-Computer-Revolution-Anniversary/dp/1449388396/ref%3Dsr_1_1%3Fie%3DUTF8%26qid%3D1371144548%26sr%3D8-1%26keywords%3Dhackers%2Bhero">Hackers: Heroes of the Computer Revolution</a> has a chapter on Sierra On-Line and on the complex relationship with their anti-hacker prodigy who developed <a href="http://en.wikipedia.org/wiki/Spiradisc">Spiradisc</a> - Mark Duchaineau. <br><br>  Now that we have all the knowledge we need, we can actually dive into the code and figure out where each of the files is in incredible chaos, which is the structure of the Apple II RAM. <br><br><h1>  Part 3: more about the loader </h1><br>  A detailed commented version of the source code can be found <a href="">on GitHub</a> . <br><br>  Here is a diagram of this infamous RAM, which will be updated below: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0b2/6dd/ed1/0b26dded186014c35345a36316f14eae.png"><br><br><h2>  BOOT.S </h2><br>  <a href=""><code>BOOT.S</code></a> begins with the output of <code>$01</code> to the instruction stream ( <a href="">line: 21</a> ).<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This forces Apple's firmware to automatically load one sector from track 0 into RAM at </font></font><code>$800</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and go there: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/4ce/98b/ffa/4ce98bffa39a24267e72d8f9bc62e6ed.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After installing several software switches, it </font></font><code>BOOT.S</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uses RWTS16 to load a series of sectors into RAM using the offset table ( </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">line: 79</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">It </font></font><code>BOOT.S</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">turned </font><font style="vertical-align: inherit;">out that in these sectors contains the rest of the procedures </font><font style="vertical-align: inherit;">and RWTS18: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/aaf/272/2cf/aaf2722cfeb45dd0baf5e6021bfe7c36.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After moving the RWTS18 procedures to another bank at the address </font></font><code>$D000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(for ease of use), it uses RWTS18 to load the whole track 1 at the address </font></font><code>$E000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">line: 136</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) and goes to the mysterious one </font></font><code>$ee00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/101/5ab/1e0/1015ab1e0b47de2c62908c66d10b7da6.png"><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> HIRES.S </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We have no idea what was on track 1 and whether this data should be located at </font></font><code>$ee00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But you can use grep to find out:</font></font><br><br><pre> <code class="hljs perl"> fabiensanglard$ find . -name <span class="hljs-string"><span class="hljs-string">"*.S"</span></span> -<span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> <span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> -H <span class="hljs-string"><span class="hljs-string">"org = \$ee00"</span></span> {} \; ./<span class="hljs-number"><span class="hljs-number">01</span></span> POP Source/Source/HIRES.S:org = $ee00 ./<span class="hljs-number"><span class="hljs-number">01</span></span> POP Source/Source/MOVER.S:org = $ee00</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A little studying the code, we found that we are interested </font></font><code>HIRES.S</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/802/22b/e67/80222be67f0a51d21a23e60fce4faf91.png"><br><br> <a href=""><code>HIRES.S</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">at the beginning contains the transition table, which takes us to another mysterious address: </font></font><code>$f880</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">line: 13</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MASTER.S </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And again we do not know what should be the address </font></font><code>$f880</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But you can use grep again to find out:</font></font><br><br><pre> <code class="hljs perl"> fabiensanglard$ find . -name <span class="hljs-string"><span class="hljs-string">"*.S"</span></span> -<span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> <span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> -H <span class="hljs-string"><span class="hljs-string">"org = \$f880"</span></span> {} \; ./<span class="hljs-number"><span class="hljs-number">01</span></span> POP Source/Source/MASTER.S:org = $f880 ./<span class="hljs-number"><span class="hljs-number">04</span></span> Support/MakeDisk/S/MASTER.S:org = $f880 ./<span class="hljs-number"><span class="hljs-number">04</span></span> Support/MakeDisk/S/MASTER525.S:org = $f880</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, the address </font></font><code>$f880</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is the content </font></font><code>MASTER.S</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">We can edit the memory allocation table: it </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/d6c/4c5/5c9/d6c4c55c9e099d3c38aae76e099bafc1.png"><br><br> <a href=""><code>MASTER.S</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">has the following contents:</font></font><br><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">jmp</span></span> FIRSTBOOT jmp LOADLEVEL jmp RELOAD jmp LoadStage2 jmp RELOAD jmp ATTRACTMODE jmp CUTPRINCESS jmp SAVEGAME jmp LOADGAME jmp DOSTARTGAME jmp EPILOG jmp LOADALTSET</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> At this stage, the game engine is loaded into RAM and is ready to load the legendary DOUBLE-HIGH screen: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/4e0/6fc/a56/4e06fca56954e015ca1f679ab55be3d3.png"><br><br>  <i>[Approx.</i> <i>.:      .    ,     ,    ,  -   .]</i> </div><p>Source: <a href="https://habr.com/ru/post/326714/">https://habr.com/ru/post/326714/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326696/index.html">PHP version performance comparison</a></li>
<li><a href="../326700/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ258 (April 10 - 16, 2017)</a></li>
<li><a href="../326702/index.html">IT internships: waiting vs reality</a></li>
<li><a href="../326706/index.html">From Rails 4 to Rails 5: how it was</a></li>
<li><a href="../326712/index.html">The composition of protocols for injection dependencies</a></li>
<li><a href="../326716/index.html">Native ECMAScript Modules - First Review</a></li>
<li><a href="../326718/index.html">Go to your personal account on zakupki.gov.ru without Internet Explorer and other useful tips when working with CryptoPro</a></li>
<li><a href="../326720/index.html">Record a WebRTC video stream from a webcam browser towed to Amazon S3</a></li>
<li><a href="../326722/index.html">Methods for circumventing web application security tools when operating XSS vectors</a></li>
<li><a href="../326724/index.html">Corporate portal. What is it? What for? Who and when?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>