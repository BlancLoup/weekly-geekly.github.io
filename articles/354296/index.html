<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We charge super power Appium tests on Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 

 My name is Nikolai Abalov. I work at Badoo‚Äôs London office on the Mobile QA Automation team. My colleague Rajdip Varma talked about how t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We charge super power Appium tests on Android</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/17/am/k0/17amk0pw1pt5o4bhbo4uoql9pwq.png"><br><br>  Hi, Habr! <br><br>  My name is Nikolai Abalov.  I work at Badoo‚Äôs London office on the Mobile QA Automation team.  My colleague <a href="https://badootech.badoo.com/%40rajdeepvarma">Rajdip Varma</a> talked about how to make Appium tests faster and more reliable.  Below is a translation of his article. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In recent years, Appium has become one of the most popular automation tools in mobile development.  However, along with the advantages, it has some limitations, in particular due to the fact that the test code is completely separated from the application code.  In this article, Rajdip tells how you can give your code a super power and solve the most unpleasant automation problems of end-to-end tests for Android. <br><a name="habracut"></a><br><h2>  Problem number 1: capricious application </h2><br><img src="https://habrastorage.org/webt/vx/pp/5h/vxpp5hd8vfnq1lwmaiasjng0ods.png" align="left"><br>  Imagine that when you run a test in your application, a pop-up message appears (as in the picture on the left).  What if the logic that controls the display of the message is not testable to the tester?  How in this case to ensure the reliability of the tests?  Or, say, you want to click on the moving banner in your application, but the test fails, because the position of the banner has changed by the time Appium could click! <br><br>  There are many examples of the unpredictability of application behavior during testing, leading to test failures. <br><br>  Imagine that your tests can tell the application: ‚ÄúI'm testing you now, so turn off the pop-up message asking you to rate the application.‚Äù <br><br><h2>  Problem number 2: Appium does not support everything </h2><br>  In our application there is a feature that allows, by shaking the device, to cancel its refusal from the assessment. <br><br>  How to automate using Appium shaking on an Android device?  There is a Shake endpoint ((POST / session /: session_id / appium / device / shake), but it is not implemented for the UIAutomator2 driver. <br><br>  Imagine that your tests can tell the application: "Pretend that the device has been shaken." <br><br><h2>  Solution: let the application help your tests by implementing backdoors </h2><br>  Backdoors - a way to call the methods defined in the code of the Android application from the automation code base, that is, from your tests. <br><br>  Let's take a look at this with a simple example.  Let's say you have a <code>foo()</code> method <br>  in Activity, let's say, in the <code>LoginActivity</code> class: <br><br><img src="https://habrastorage.org/webt/cf/sc/ri/cfscriih3dcjc8-nu55gohrfyh4.png"><br><br>  In the <code>foo()</code> method, we can write code that turns off random pop-up messages, OR add fake shaking functionality OR something that sets the state of your application.  Imagine that we can call this method from the automation code base with something like this: <br><br><img src="https://habrastorage.org/webt/6g/uc/ml/6gucmlggsx9awfsjepzu6wcirxs.png"><br><br>  This will solve our problem ‚ÄúBut imagine that your tests can tell the application ...‚Äù <br><br>  <b>The bad news:</b> backdoors are not supported in Appium out of the box. <br>  <b>Good news:</b> backdoors can still be implemented in Appium! <br><br>  Before proceeding to the solution, I will give some real examples of the use of backdoors in automation: <br><br><ul><li>  change backend URL; <br></li><li>  changing the geographic region of the application; <br></li><li>  selection of specific variants of client A / B tests; <br></li><li>  Simulation of the presence of a SIM card for the application; <br></li><li>  getting the ID of the current session; <br></li><li>  receiving from the application data analytics. <br></li></ul><br>  <b>PS Doing it all yourself can be difficult.</b>  <b>If you are not interested in how I did it, then you can skip to the chapter ‚ÄúQuick start working with backdoors in your project‚Äù.</b> <br><br><h2>  Implementation backdoors in Appium </h2><br><img src="https://habrastorage.org/webt/zr/wi/h9/zrwih9vz1dcfubbyavmwkqgtfha.png"><br>  <i>Architecture out of the box server UIAutomator2</i> <br><br><ol><li>  APK-1 =&gt; appium-uiautomator2-server-debug-androidTest.apk </li><li>  APK-2 =&gt; appium-uiautomator2-server.apk </li></ol><br>  APK-1 is an instrumentation package for APK-2.  It has a test - instrumentation test.  It is started by the command for the adb shell am instrument ... driver. The only purpose of such a test is to start the HTTP server defined in APK-2. <br><br>  Both APK files are executed in the same process, highlighted in green in the illustration. <br><br>  When the server is up and running, the client can send JSON-HTTP-requests, and the server will execute them. <br><br>  But we can get the most out of the Android instrumentation if we change the architecture (as shown below). <br><br><h3>  Modified architecture of the UIAutomator2 server: </h3><br><img src="https://habrastorage.org/webt/7r/tv/fa/7rtvfabeyb0dis73w7bapj3m3ku.png"><br>  <i>Equipment test application APK Appium</i> <br><br>  We poured APK-2 code into APK-1.  Therefore, the instrumental test and the HTTP server are now in the same APK file.  Let's call it Merged Server APK. <br><br>  Now you can modify the Manifest.xml of our new APK file so that its target instrumented package becomes the package with the name of our application under test: <br><img src="https://habrastorage.org/webt/gl/sg/a_/glsga_rk1iomrlnf9swriwpfrzu.png"><br>  This is easy to implement with the help of a Ruby Gem called <a href="https://rubygems.org/gems/appium_instrumenter">appium_instrumenter</a> , which is based on the code from calabash-android gem. <br><br>  Then we sign the Merged Server APK using the same keystore (keystore) as the application under test.  Now we have a custom tool server running in the same process as the application under test (highlighted in green). <br><br>  We have instrumented our application using Merged Server APK, which means that the latter can access the application context.  This means that we can ask the Merged Server APK file to call the methods defined in our application. <br><br>  Create an endpoint in the Merged Server APK to specify which application method to call: <br><br> <code>/wd/hub/session/:sessionId/backdoor.</code> <br> <br>  We can send the name of the method we want to call to this endpoint.  Merged Server APK retrieves the application context and calls the method using the Java Reflection API. <br><br>  You can download all the code for this Appium UIAutomator2 Server backdoor endpoint from the <a href="https://github.com/rajdeepv/appium-uiautomator2-server/tree/single_apk">repository</a> from the 'single_apk' branch. <br><br>  Next, we replace the APK file that comes with the appium_uiautomator2_driver package with our custom APK file.  All the hardest thing behind, these manipulations need to be done only once. <br><br>  Now in our test automation code there is an auxiliary method for calling backdoor methods.  Here is an example in Ruby: <br><br><img src="https://habrastorage.org/webt/v8/4x/w-/v84xw-dgtrmxcxchd6ijemcb04q.png"><br><br>  Voila!  We got super power!  Now it is very easy to call any public method defined in the Application class or the current Activity class: <br><br><img src="https://habrastorage.org/webt/6g/uc/ml/6gucmlggsx9awfsjepzu6wcirxs.png"><br><br>  At the same time, it is supported that the test code returns return values! <br><br><h2>  Quick start with backdoors in your project </h2><br><h3>  1. Generate the Appium UIAutomator Server APK file for your <br>  applications: </h3><br><br>  install <code>appium_instrumenter gem</code> .  Even if your Appium tests are written in Java, you have to do it once, since I wrote the utility only in Ruby. <br><br><pre> <code class="ruby hljs">gem install appium_instrumenter appium_instrumenter instrument app-debug.apk</code> </pre> <br>  The folder <code>./test_servers</code> will be created in your current directory: <br><br><pre> <code class="ruby hljs">test_servers ‚îú‚îÄ‚îÄ appium-uiautomator2-server-debug-androidTest.apk ‚îî‚îÄ‚îÄ appium-uiautomator2-server-v<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">3.0</span></span>.apk</code> </pre> <br>  Install both of the above mentioned apk files on your device: <br><br><pre> <code class="ruby hljs">adb install test_servers/appium-uiautomator2-server-debug-androidTest.apk adb install test_servers/appium-uiautomator2-server-v<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">3.0</span></span>.apk</code> </pre> <br><h3>  2. Now install the NPM package <code>appium_uiautomator2_driver</code> from my fork: </h3><br><pre> <code class="ruby hljs">npm install ‚Äúrajdeepv/appium-uiautomator2-driver<span class="hljs-comment"><span class="hljs-comment">#adb_host‚Äù</span></span></code> </pre> <br><h3>  3. Define the <code>backdoor()</code> method: </h3><br>  define a method that sends data to the endpoint for the backdoor: <br><br><pre> <code class="ruby hljs"><span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/localhost:</span><span class="hljs-subst"><span class="hljs-regexp"><span class="hljs-subst">#{APPIUM_FORWARDED_PORT}</span></span></span><span class="hljs-regexp">/wd</span></span><span class="hljs-regexp"><span class="hljs-regexp">/hub/session</span></span><span class="hljs-regexp"><span class="hljs-regexp">/:sessionId/backdoor</span></span></code> </pre> <br>  <i>Consider the above example of implementing this method in Ruby.</i>  <i>You can implement the same method if you write in Java or any other language.</i> <br><br><h3>  4. May the superpower come with you! </h3><br><h2>  Stay away from problems </h2><br>  "With great strength comes great responsibility." <br><br>  Backdoor is a very powerful tool.  And if used improperly, it can lead to unpleasant consequences.  So, if we use the backdoor to completely change the application logic, the risks of testing will be higher than its value. <br><br>  Backdoors allow you to implement previously impossible scenarios, they expand the possibilities of testing.  And in some cases, simply can not do without them! <br><br>  Here is a story.  By the way, on April 1, Rajdip <a href="https://2018.codefest.ru/lecture/1276/">spoke at the CodeFest</a> in Novosibirsk.  A video of his report should appear in the summer on the CodeFest YouTube channel and on Badoo Tech. </div><p>Source: <a href="https://habr.com/ru/post/354296/">https://habr.com/ru/post/354296/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354284/index.html">Basics of programming on the SAS Base. Lesson 3. Reading text files</a></li>
<li><a href="../354286/index.html">ESET: Lazarus Cyber ‚Äã‚ÄãGroup Switches to Central America</a></li>
<li><a href="../354290/index.html">Summ3r 0f h4ck: Digital Security Internship 2018</a></li>
<li><a href="../354292/index.html">Developing a game server on Nadron</a></li>
<li><a href="../354294/index.html">PYCON RUSSIA 2018 will be held July 22-23. Save the date</a></li>
<li><a href="../354302/index.html">Veeam Backup & Replication: 10 Tips for Beginners</a></li>
<li><a href="../354304/index.html">Operation Orangeworm: hackers infect medical equipment around the world using the Kwampirs Trojan</a></li>
<li><a href="../354310/index.html">Forms on the site - a spammer reluctantly</a></li>
<li><a href="../354312/index.html">How to optimize power consumption in iOS</a></li>
<li><a href="../354314/index.html">Roskomnadzor‚Äôs locks in the Telegram case reached the mining pools</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>