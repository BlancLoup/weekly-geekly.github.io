<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Metaclasses in C ++</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article we will talk about the new proposed extension of the C ++ language - metaclasses. The coat of arms of Sutter and his colleagues worked...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Metaclasses in C ++</h1><div class="post__text post__text-html js-mediator-article">  In this article we will talk about the new proposed extension of the C ++ language - metaclasses.  The coat of arms of Sutter and his colleagues worked on this proposal for about 2 years and, finally, this summer <a href="https://herbsutter.files.wordpress.com/2017/07/p0707r1.pdf">presented</a> it to the public. <br><br>  So, what is the "metaclass" in terms of the Sutter's coat of arms?  Let us recall our C ++, the most beautiful programming language in the world, in which, however, <s>for</s> decades there have been approximately the same entities: variables, functions, classes.  Adding something fundamentally new (like enum classes) takes a very long time and you can‚Äôt expect to wait for the inclusion of something you need here and now in the standard.  But something really is not enough.  For example, we still have no (yes, probably will not) interfaces as such (we have to emulate them with abstract classes with purely virtual methods).  There are no properties in their full understanding, there are not even value-types (something that could be defined as a set of variables of simple types and immediately used in containers / sortings / dictionaries there without defining for them different operations of comparison, copying and hashing).  And in general, something is constantly missing.  Qt developers now lack metadata and code generation, which forces them to use moc.  C ++ / CLI and C ++ / CX developers lacked ways to interact with the garbage collector and their type systems.  Well, etc. <br><br>  And let's imagine for a moment that we ourselves can introduce new entities into the language.  Well, or if not directly "entities", but the rules for checking and modifying classes. <br><a name="habracut"></a><br>  How it all will work.  The emblem suggests introducing the concept of ‚Äúmetaclass‚Äù as a set of rules and code that will be executed at the compilation stage and on the basis of which the compiler will check the classes in the code and / or create new classes based on the above-mentioned rules. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For example, we want to have a classic interface in the language.  What is an "interface"?  For example, the C # language standard answers this question on 18 pages.  And with this there are a number of problems: <br><br><ol><li>  Nobody reads them. </li><li>  The compiler is absolutely not guaranteed to implement exactly what is written in those 18 pages of text. </li><li>  We are not able to verify the compliance of the compiler and the text in English </li><li>  For C ++, you would have to write the same specification and its implementation in compilers (and knowing C ++ is also much more complicated).  And then see paragraphs 1, 2 and 3. </li></ol><br>  But let's say in simple terms that an ‚Äúinterface‚Äù is a named set of public pure-virtual methods to which, at the same time, no private methods or data members are attached.  Everything!  Yes, maybe I have now missed some small detail from those 18 pages of specification, but for 99.99% practical code this definition is enough.  And so, metaclasses have been invented to describe such definitions in the code. <br><br>  The syntax is still at the discussion stage, but here‚Äôs how the interface metaclass can be implemented: <br><br><pre><code class="cpp hljs">$<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interface</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> { compiler.require($interface.variables().empty(), <span class="hljs-string"><span class="hljs-string">" -  !"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> f : $interface.functions()) { compiler.require(!f.is_copy() &amp;&amp; !f.is_move(), <span class="hljs-string"><span class="hljs-string">"    ; "</span></span> <span class="hljs-string"><span class="hljs-string">"virtual clone()  "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!f.has_access()) f.make_public(); <span class="hljs-comment"><span class="hljs-comment">//    ! compiler.require(f.is_public(), // ,   "interface functions must be public"); f.make_pure_virtual(); //     } } //     ++    , //       virtual ~interface() noexcept { } };</span></span></code> </pre> <br>  The code is intuitive - we declare an interface metaclass in which at the stage of compiling the code (the constexpr block) certain checks and modifications of the final class will be carried out, which will pretend to be considered an interface. <br><br>  This case can now be applied like this: <br><br><pre> <code class="cpp hljs">interface Shape { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">area</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scale_by</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> factor)</span></span></span></span>; };</code> </pre> <br>  True, very similar to C # or Java?  When compiling, the compiler will apply the metaclass interface to Shape, which will give us a class at the output: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Shape</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">area</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scale_by</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> factor)</span></span></span><span class="hljs-function"> </span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~Shape() <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> { }; };</code> </pre> <br>  Plus will generate a compilation error when attempting to add member data. <br>  At the same time pay attention, there is no longer any "meta-magic" in the Shape class thus obtained.  It's just a class, exactly the same as if it was written by hand - you can create copies of it, you can inherit from it, etc. <br><br>  This is how we were able to add a new entity to the language and use it without resorting to the need to edit the standard of the language or the compiler. <br>  Let's now define a class that could be used in ordered containers.  For example, in practice you have to write the classic storage point in an ordered-container like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Point</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: Point() = <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">friend</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>==(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Point&amp; a, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Point&amp; b) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ax == bx &amp;&amp; ay == by; } <span class="hljs-keyword"><span class="hljs-keyword">friend</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>&lt; (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Point&amp; a, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Point&amp; b) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ax &lt; bx || (ax == bx &amp;&amp; ay &lt; by); } <span class="hljs-keyword"><span class="hljs-keyword">friend</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>!=(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Point&amp; a, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Point&amp; b) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !(a == b); } <span class="hljs-keyword"><span class="hljs-keyword">friend</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>&gt; (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Point&amp; a, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Point&amp; b) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> b &lt; a; } <span class="hljs-keyword"><span class="hljs-keyword">friend</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>&gt;=(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Point&amp; a, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Point&amp; b) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !(a &lt; b); } <span class="hljs-keyword"><span class="hljs-keyword">friend</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>&lt;=(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Point&amp; a, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Point&amp; b) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !(b &lt; a); } };</code> </pre> <br>  But if at the compilation stage we have a reflection that allows us to enumerate the data members and add new methods to the class - we can put all these comparisons in the metaclass: <br><br><pre> <code class="cpp hljs">$<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ordered</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (! requires(ordered a) { a == a; }) -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">friend</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> == (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ordered&amp; a, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ordered&amp; b) { <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> o : ordered.variables()) <span class="hljs-comment"><span class="hljs-comment">// for each member -&gt; { if (!(aoname$ == b.(o.name)$)) return false; } } return true; } } if (! requires(ordered a) { a &lt; a; }) -&gt; { friend bool operator &lt; (const ordered&amp; a, const ordered&amp; b) { for (auto o : ordered.variables()) -&gt; { if (aoname$ &lt; b.(o.name)$) return true; if (b.(o.name$) &lt; aoname$) return false; ) } return false; } } if (! requires(ordered a) { a != a; }) -&gt; { friend bool operator != (const ordered&amp; a, const ordered&amp; b) { return !(a == b); } } if (! requires(ordered a) { a &gt; a; }) -&gt; { friend bool operator &gt; (const ordered&amp; a, const ordered&amp; b) { return b &lt; a ; } } if (! requires(ordered a) { a &lt;= a; }) -&gt; { friend bool operator &lt;= (const ordered&amp; a, const ordered&amp; b) { return !(b &lt; a); } } if (! requires(ordered a) { a &gt;= a; }) -&gt; { friend bool operator &gt;= (const ordered&amp; a, const ordered&amp; b) { return !(a &lt; b); } } } };</span></span></code> </pre> <br>  What?  Looks hard?  Yes, but you will not write such a metaclass - it will be in the standard library or in something like Boost.  In your code, you only define a point, like this: <br><br><pre> <code class="cpp hljs">ordered Point { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y; };</code> </pre> <br>  And it will work! <br><br>  In the same way, we can finally ensure that things like a pair or tuple are defined trivially: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T1</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T2</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">literal_value</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pair</span></span></span><span class="hljs-class"> {</span></span> T1 first; T2 second; };</code> </pre> <br>  Look, for the sake of interest, how a banal couple is <a href="https://gcc.gnu.org/onlinedocs/gcc-4.6.3/libstdc%2B%2B/api/a01060_source.html">defined now</a> . <br><br>  From the opening opportunities the eyes scatter: <br><br><ul><li>  We can explicitly define guides in the code like "the base class must always have a purely virtual destructor" or " <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25B0%25D0%25B2%25D0%25B8%25D0%25BB%25D0%25BE_%25D1%2582%25D1%2580%25D1%2591%25D1%2585_(C%252B%252B_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5)">rule of three</a> " </li><li>  We will be able to implement interfaces, value-types, properties </li><li>  We can abandon Moc in Qt and custom compilers for C ++ / CLI and C ++ / CX, since all these things can be described by metaclasses </li><li>  We will be able to generate code not with external code-generators and not stupid defines, but with the built-in powerful framework </li><li>  We will be able to implement at the compilation stage even such complex checks as ‚Äúdo we use the critical section controlling access to it in all class methods that access some variable?‚Äù </li></ul><br>  Meta-level is very cool!  True? <br><br>  Here's another video for you to eat, where the Coat of Arms tells more about this: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/6nsyX37nsRs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  And here is an online compiler in which you can even <a href="https://cppx.godbolt.org/">try it</a> . </div><p>Source: <a href="https://habr.com/ru/post/334284/">https://habr.com/ru/post/334284/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../334274/index.html">If there is no difference between the two code options, choose the one that is easier to debug.</a></li>
<li><a href="../334276/index.html">Zabbix + RocksDB - migration and first impressions</a></li>
<li><a href="../334278/index.html">A bit about SSL certificates: How to choose and how to get</a></li>
<li><a href="../334280/index.html">Cryptocurrency in terms of civil law</a></li>
<li><a href="../334282/index.html">What are chemists and biologists doing at EPAM?</a></li>
<li><a href="../334286/index.html">Internet travel. Analysis of foreign SIM-cards</a></li>
<li><a href="../334288/index.html">The ghost of a locomotive or the stock market through the prism of correlations</a></li>
<li><a href="../334290/index.html">SOAP and REST services using the Spyne Python library</a></li>
<li><a href="../334292/index.html">Anatomy of Google Analytics</a></li>
<li><a href="../334294/index.html">About Agile, Scrum and teamwork. How are the processes of product development in the Alpha Laboratory</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>