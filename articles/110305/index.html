<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Javascript: Sending images on the canvas to the server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello habrovchane. 

 I decided to send the image from the canvas to the server. 
 And what came out of this look under the cut. 

 So, we need a brow...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Javascript: Sending images on the canvas to the server</h1><div class="post__text post__text-html js-mediator-article">  Hello habrovchane. <br><br>  I decided to send the image from the canvas to the server. <br>  And what came out of this look under the cut. <br><a name="habracut"></a><br>  So, we need a browser that supports the canvas. <br><br>  I decided to make it possible with the mouse to draw something on the canvas and send this picture to the server. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Go </h5><br><br><h6>  Canvas </h6><br><br>  At once I will say that the javascript code will be written in <a href="http://ru.wikipedia.org/wiki/javascript">javascript</a> . <br>  I have nothing against libraries, I use them myself.  Simply, this is a more general case.  If you wish, you can be rewritten under the library. <br><br>  Create a canvas / canvas (underline the appropriate): <br> <code>&lt;canvas id="canvas" ...&gt;&lt;/canvas&gt; <br></code> <br><br>  Now we need to make it so that you can draw on canvas. <br>  For drawing, we need to get a 2D mapping context, create a path, move to the starting point, <br>  call the LineTo () method to draw the line to the end point, call the stroke () method to draw the outline, close the path. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> canvas = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'canvas'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ctx = canvas.getContext(<span class="hljs-string"><span class="hljs-string">"2d"</span></span>); ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke(); ctx.closePath();</code> </pre><br><br>  All this can be seen in my code, in the onmousedown, onmouseup and onmousemove handlers. <br><br><h6>  Send to server </h6><br>  But with the canvas, okay, there are a lot of libraries to work with it.  Now how to send pictures to the server. <br><br>  We need to make an ajax request using the POST method. <br>  Only the picture should be sent not like this: <br>  ‚ÄúImage =% 01% 02% 03 ...‚Äù, but as a file. <br><br>  We need to put the Content-type not ‚Äúapplication / x-www-form-urlencoded‚Äù, but ‚Äúmultipart / form-data‚Äù. <br>  This means that the request body will consist of other subqueries that will themselves have their own headers and bodies. <br>  How the body of such a request looks like can be viewed in LiveHttpHeaders in Firefox by creating an html page with a form <br>  with attribute enctype = "multipart / form-data": <br><br><img src="https://habrastorage.org/storage/7812f18b/707d9446/a35c74f4/2ac40c2d.png"><br><br>  Each such subquery corresponds to a specific form field. <br>  In the picture, I send a form with a text field with name = "id" and a field "file" to send the file. <br>  I am loading the loading.gif file <br><br>  We need to come up with a boundary separator (boundary) that will separate the request bodies. <br>  In the figure, this delimiter is the string "--------------------------- 12722593819037", this delimiter should separate these <br>  subqueries and should not occur in them. <br>  Before each such subquery there should be a line "-" + boundary, and after all - a line "-" + boundary + "-" <br><br>  You can read about it here: <a href="http://www.faqs.org/rfcs/rfc1521.html">rfc 1521</a> <br>  About form-data can be read in <a href="http://www.faqs.org/rfcs/rfc1867.html">rfc 1867</a> . <br><br>  I note that on 12/19/2010 in Chrome there is already a FormData object for creating form-data, and in Firefox it will only be in 4 versions. <br><br>  To send the contents of the canvas, we will use the dataURL method, which returns the image as a base64 string. <br><br>  Example: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> canvas = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'canvas'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> body = canvas.todataURL(); ... xmlhttprequest.open(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, url); ... xmlhttprequest.setRequestHeader(<span class="hljs-string"><span class="hljs-string">"Content-type"</span></span>, <span class="hljs-string"><span class="hljs-string">"multipart/form-data; boundary="</span></span> + boundary); ... var data =  <span class="hljs-comment"><span class="hljs-comment">/*--boundary*/</span></span>  <span class="hljs-string"><span class="hljs-string">"--"</span></span> + boundary + <span class="hljs-string"><span class="hljs-string">"\n"</span></span> +    <span class="hljs-comment"><span class="hljs-comment">/**/</span></span>  <span class="hljs-string"><span class="hljs-string">"Content-Disposition: form-data; name=\"file\"; filename=\"filename\"\n"</span></span> +  <span class="hljs-string"><span class="hljs-string">"Content-type: image/png\n\n"</span></span> +    <span class="hljs-comment"><span class="hljs-comment">/**/</span></span>  body +    <span class="hljs-comment"><span class="hljs-comment">/*--boundary--*/</span></span>  <span class="hljs-string"><span class="hljs-string">"\n--"</span></span> + boundary + <span class="hljs-string"><span class="hljs-string">"--\n"</span></span>; ... xmlhttprequest.send(data);</code> </pre><br><br><h6>  Server part </h6><br>  For emails, you can write a "Content-Transfer-Encoding" header with a value of "base64" to indicate that <br>  that the attached file is encrypted in base64.  Unfortunately, I didn‚Äôt add such a title to anything. <br>  I had to decode base64 on the server myself. <br><br>  Only one small ‚Äúbut‚Äù, I will say. <br>  When you read a file in slices and decode from base64, you need to read the number of bytes in one multiple of 4. <br>  This is due to base64 encoding.  It treats every 3 bytes as a set of 4 6-bit characters, and then each <br>  such a 6-bit character displays as some ordinary 8-bit text character. <br>  (if at the end there is not enough two or one byte, then zero bytes are taken, and in the resulting text you add "=" or "==") <br><br>  Accordingly, if at one time to read the number of characters not a multiple of 4, then we will not receive pictures (you can check by correcting my code). <br>  Actually, here is the decoding code for a picture in PHP: <br><br><pre> <code class="php hljs">$f = fopen ($filename, <span class="hljs-string"><span class="hljs-string">'r'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(<span class="hljs-string"><span class="hljs-string">'Cannot open file'</span></span>);<span class="hljs-comment"><span class="hljs-comment">#   $f2 = fopen ($path . '/' . $name, 'w') or die('Cannot open file');#   $length = 64;//   4! $error = FALSE; while ($content = fread($f, $length)) {  $content = base64_decode($content, TRUE);    if ($content === FALSE) {    $error = TRUE;    break;  }    fwrite($f2, $content); } fclose($f); fclose($f2);</span></span></code> </pre><br><br>  Actually all this can be viewed on <a href="http://xn--c1abmgrdmpk4e.xn--p1ai/canvas">truodkoding.rf / canvas /</a> <br>  On the left there will be a picture, draw something on it, press the ‚ÄúSend‚Äù button, the picture is sent to the server, <br>  and then displayed to the right. <br><br><img src="https://habrastorage.org/storage/d445aca8/c30dba36/734acdfb/a63b9667.png"><br><br>  Code here: <a href="">trukoding.rf / canvas / canvas.zip</a> , <br>  and here: <a href="http://www.rapidshare.ru/1709200">http://www.rapidshare.ru/1709200</a> , <br>  and here: <a href="http://narod.ru/disk/1762612001/canvas.zip.html">http://narod.ru/disk/1762612001/canvas.zip.html</a> <br><br>  On Yandex sometimes the message ‚ÄúFile not found‚Äù is skipped, try several times. <br><br>  Example here: <a href="http://xn--c1abmgrdmpk4e.xn--p1ai/canvas/">trukoding.rf / canvas /</a> <br><br>  References: <br>  <a href="http://www.faqs.org/rfcs/rfc1521.html">RFC MIME</a> <br>  <a href="http://www.faqs.org/rfcs/rfc1867.html">form-data</a> <br>  <a href="https://developer.mozilla.org/en/drawing_graphics_with_canvas">Canvas</a> <br><br>  Good luck! <br><br>  <b>upd:</b> Here are some cool images flooded by users: <a href="http://xn--c1abmgrdmpk4e.xn--p1ai/cpg/thumbnails.php%3Falbum%3D1">http: //trukoding.rf/cpg/thumbnails.php? album = 1</a> <br>  <b>upd:</b> Similar turns out to be implemented here: <a href="http://www.nihilogic.dk/labs/canvas2image/">http://www.nihilogic.dk/labs/canvas2image/</a> </div><p>Source: <a href="https://habr.com/ru/post/110305/">https://habr.com/ru/post/110305/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../110297/index.html">Cards Heaven - you postcard. Printed Is free</a></li>
<li><a href="../110298/index.html">Beltelecom again blocked opposition sites</a></li>
<li><a href="../110299/index.html">Determining the location of the mac address of the router</a></li>
<li><a href="../110300/index.html">Riding a ... network package</a></li>
<li><a href="../110302/index.html">In the Republic of Belarus, an information attack on opposition resources</a></li>
<li><a href="../110306/index.html">Microsoft will not allow the use of Kinect for adult games</a></li>
<li><a href="../110307/index.html">Key points of testing</a></li>
<li><a href="../110310/index.html">Configurability</a></li>
<li><a href="../110311/index.html">Internet in Belarus</a></li>
<li><a href="../110313/index.html">Teamviewer for Linux updated to version 6</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>