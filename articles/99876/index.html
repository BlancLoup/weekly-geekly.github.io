<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pseudo Random Number Generator Overview for CUDA</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="According to the specifics of work, one often has to do simulations on the GPU using pseudorandom number generators. As a result, I gained experience,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pseudo Random Number Generator Overview for CUDA</h1><div class="post__text post__text-html js-mediator-article"> According to the specifics of work, one often has to do simulations on the GPU using pseudorandom number generators.  As a result, I gained experience, which I decided to share with the community. <br><br><a name="habracut"></a>  So, the types of generators, their advantages and disadvantages. <br><br>  <b>1. Linear Congruential Generator</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The simplest and most inefficient generator with a period of only 2 ^ 32.  It is not suitable for serious simulations, such as Monte Carlo, but can be used for debugging, because it is extremely simple to implement. <br><br> <code>__device__ inline unsigned int lcg_rand(unsigned int&amp; seed) <br> { <br> seed = seed * 1664525 + 1013904223UL; <br> return seed; <br> } <br></code> <br><br>  The generator requires storing a state for each generator (stream).  To do this, you can use the unsigned int array and address it by threadId.  For example: <br><br> <code>__global__ void GenerateRandNums(unsigned int* out, unsigned int* states) <br> { <br> const int tid = blockDim.x * blockIdx.x + threadIdx.x; <br> unsigned int s = states[tid]; <br> out[tid] = lcg_rand(s) + lcg_rand(s); <br> states[tid] = s; <br> } <br></code> <br><br>  <b>2. Combined Tausworthe Generator</b> <br><br>  This generator has a longer period than LCG, but almost as simple.  It requires only 27 instructions to generate a stream with a period of 2 ^ 113.  This period is achieved by combining several generators with exclusive or.  Below is the code generating a single thread. <br><br> <code>//S1,S2,S3,M -  <br> __device__ inline unsigned int taus_rand_step(unsigned int&amp; state, int S1, int S2, int S3, int M) <br> { <br> unsigned int b = (((state &lt;&lt; S1) ^ state) &gt;&gt; S2); <br> state = (((state &amp; M) &lt;&lt; S3) ^ b); <br> return state; <br> } <br></code> <br><br>  Combined generator using 4 independent streams. <br><br> <code>__device__ unsigned int taus_rand(uint4&amp; state) <br> { <br> return <br> taus_rand_step(state.x, 6, 13, 18, 4294967294UL) ^ <br> taus_rand_step(state.y, 2, 27, 2, 4294967288UL) ^ <br> taus_rand_step(state.z, 13, 21, 7, 4294967280UL) ^ <br> taus_rand_step(state.w, 3, 12, 13, 4294967268UL); <br> <br> } <br> <br></code> <br><br>  This generator requires 4 unsigned int to store the state, but its use is not fundamentally different from LCG. <br><br>  <b>3. Hybrid Generator</b> <br><br>  This generator is obtained by combining the 2 previous generators.  If the periods of 2 generators are mutually simple, then the period of the resulting generator will be the product of their periods.  This generator is obtained by combining 3 Tausworthe generator streams and one LCG stream.  The resulting period will be 2 ^ 121. <br> <code>__device__ unsigned int hybrid_taus(uint4&amp; state) <br> { <br> return <br> taus_rand_step(state.x, 13, 19, 12, 4294967294UL) ^ <br> taus_rand_step(state.y, 2, 25, 4, 4294967288UL) ^ <br> taus_rand_step(state.z, 3, 11, 17, 4294967280UL) ^ <br> lcg_rand(state.w); <br> } <br></code> <br><br>  <b>4. XorShift</b> <br><br>  This generator has a period of 2 ^ 128-1 and requires 4 unsigned int to store the state.  Thanks to <a href="https://habrahabr.ru/users/maratyszcza/" class="user_link">maratyszcza</a> for advice. <br><br> <code>__device__ inline unsigned int rng_xor128(uint4&amp; s) <br> { <br> unsigned int t; <br> <br> t = sx^(sx&lt;&lt;11); <br> <br> sx = sy; <br> sy = sz; <br> sz = sw; <br> <br> sw = (sw^(sw&gt;&gt;19))^(t^(t&gt;&gt;8)); <br> <br> return sw; <br> } <br></code> <br><br>  <b>5. Mersenne Twister</b> <br><br>  This generator is considered to be one of the best at the present time and has a very long period - 2 ^ 19937; however, to generate one element from the stream requires the implementation of a complex sequential algorithm.  Also, the generator requires a lot of memory to store its state, which can greatly affect the performance of the GPU, because  state has to be stored in global memory.  However, in situations where accuracy is more important than speed, it is more preferable to use this generator.  As in the previous generators, each thread has its own generator and state.  Below is the code for this generator (a modified example from the NVIDIA SDK). <br><br> <code>#define SEED 999 <br> <br> #define DCMT_SEED 4172 <br> #define MT_RNG_PERIOD 607 <br> <br> typedef struct{ <br> unsigned int matrix_a; <br> unsigned int mask_b; <br> unsigned int mask_c; <br> unsigned int seed; <br> } mt_struct_stripped; <br> <br> #define MT_RNG_COUNT (4096*16) <br> #define MT_MM 9 <br> #define MT_NN 19 <br> #define MT_WMASK 0xFFFFFFFFU <br> #define MT_UMASK 0xFFFFFFFEU <br> #define MT_LMASK 0x1U <br> #define MT_SHIFT0 12 <br> #define MT_SHIFTB 7 <br> #define MT_SHIFTC 15 <br> #define MT_SHIFT1 18 <br> <br> __device__ struct mt_state <br> { <br> int iState; <br> unsigned int mti1; <br> unsigned int mt[MT_NN]; <br> }; <br> <br> __device__ mt_struct_stripped ds_MT[MT_RNG_COUNT]; <br> static mt_struct_stripped h_MT[MT_RNG_COUNT]; <br> __device__ mt_state ds_mtState[MT_RNG_COUNT]; <br> <br> void InitGPUTwisters(const char* fname, unsigned int seed) <br> { <br> FILE *fd = fopen(fname, "rb"); <br> if(!fd) <br> printf("initMTGPU(): failed to open %s\n", fname); <br> <br> if( !fread(h_MT, sizeof(h_MT), 1, fd) ) <br> printf("initMTGPU(): failed to load %s\n", fname); <br> <br> fclose(fd); <br> <br> mt_struct_stripped *MT = (mt_struct_stripped *)malloc(MT_RNG_COUNT * sizeof(mt_struct_stripped)); <br> <br> for(int i = 0; i &lt; MT_RNG_COUNT; i++) <br> { <br> MT[i] = h_MT[i]; <br> seed = lcg_rand(seed); <br> MT[i].seed = seed; <br> } <br> cudaMemcpyToSymbol(ds_MT, MT, sizeof(h_MT)); <br> <br> free(MT); <br> } <br> <br> __device__ unsigned int GetRandomIntegerFast(unsigned int tid, mt_state* mts, mt_struct_stripped* config) <br> { <br> int iState1, iStateM; <br> unsigned int mti, mtiM, x; <br> <br> iState1 = mts-&gt;iState + 1; <br> iStateM = mts-&gt;iState + MT_MM; <br> <br> if(iState1 &gt;= MT_NN) <br> iState1 -= MT_NN; <br> <br> if(iStateM &gt;= MT_NN) <br> iStateM -= MT_NN; <br> <br> mti = mts-&gt;mti1; <br> mts-&gt;mti1 = mts-&gt;mt[iState1]; <br> mtiM = mts-&gt;mt[iStateM]; <br> <br> x = (mti &amp; MT_UMASK) | (mts-&gt;mti1 &amp; MT_LMASK); <br> x = mtiM ^ (x &gt;&gt; 1) ^ ((x &amp; 1) ? config-&gt;matrix_a : 0); <br> mts-&gt;mt[mts-&gt;iState] = x; <br> mts-&gt;iState = iState1; <br> <br> x ^= (x &gt;&gt; MT_SHIFT0); <br> x ^= (x &lt;&lt; MT_SHIFTB) &amp; config-&gt;mask_b; <br> x ^= (x &lt;&lt; MT_SHIFTC) &amp; config-&gt;mask_c; <br> x ^= (x &gt;&gt; MT_SHIFT1); <br> <br> return x; <br> } <br> <br> __device__ float GetRandomFloatFast(unsigned int tid, mt_state* mts, mt_struct_stripped* config) <br> { <br> return ((float)GetRandomIntegerFast(tid,mts,config) + 1.0f) / 4294967296.0f; <br> } <br> <br> __device__ void InitTwisterFast(unsigned int tid, mt_state* mts, mt_struct_stripped* config) <br> { <br> mts-&gt;mt[0] = config-&gt;seed; <br> <br> for(int i = 1; i &lt; MT_NN; i++) <br> mts-&gt;mt[i] = (1812433253U * (mts-&gt;mt[i - 1] ^ (mts-&gt;mt[i - 1] &gt;&gt; 30)) + i) &amp; MT_WMASK; <br> <br> mts-&gt;iState = 0; <br> mts-&gt;mti1 = mts-&gt;mt[0]; <br> } <br> <br></code> <br><br>  An example of using this generator: <br><br> <code>__global__ void GenerateUniformNumbers(float* output) <br> { <br> const uint tid = gridDim.x*gridDim.y*threadIdx.x + blockIdx.y*gridDim.x + blockIdx.x; <br> <br> mt_state mts = ds_mtState[tid]; <br> mt_struct_stripped config = ds_MT[tid]; <br> <br> InitTwisterFast(tid, &amp;mts, &amp;config); <br> <br> output[tid] = GetRandomFloatFast(tid, &amp;mts, &amp;config) <br> <br> ds_mtState[tid] = mts; <br> } <br></code> <br><br>  <b>6. WarpStandard generator</b> <br><br>  This generator was designed specifically for the GPU and has a period of 2 ^ 1024.  The generator uses shared memory, so all threads in the block must be executed in concert, which is not always possible.  A very good description of this generator is presented by <a href="http://www.doc.ic.ac.uk/~dt10/research/rngs-gpu-uniform.html">reference.</a> <br><br>  <b>Conclusion</b> <br><br>  Each of the presented generators is suitable for different cases.  For debugging, you can use LCG, if you need more precision and randomness, I would use MersenneTwister.  If all the threads on the GPU are consistent, there are no dynamic transitions inside the blocks ‚Äî WarpStandard fits very well.  In all other cases, I use HybridGenerator. </div><p>Source: <a href="https://habr.com/ru/post/99876/">https://habr.com/ru/post/99876/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../99864/index.html">A hydrogen fuel charger is on sale</a></li>
<li><a href="../99867/index.html">Release of the new generation engine of forum Vanilla 2.0</a></li>
<li><a href="../99868/index.html">Microsoft Windows 0-day exploit vulnerability on July 19th turned out to be multi-vector: sites can automatically infect readers through Internet Explorer</a></li>
<li><a href="../99872/index.html">Odyssey Tester</a></li>
<li><a href="../99873/index.html">This is my way to China (part 1)</a></li>
<li><a href="../99878/index.html">PhpVirtualBox allows you to manage your virtual machines via the web interface</a></li>
<li><a href="../99883/index.html">Excel 2010 Games: Tower Defense and Missile Command</a></li>
<li><a href="../99884/index.html">Scalable relational db</a></li>
<li><a href="../99885/index.html">What is Vala</a></li>
<li><a href="../99889/index.html">Criminal Reengineering</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>