<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automatically export Google Forms to Notion using IFTTT and Django</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day to all! I think the article will be interesting to everyone who uses Notion, but for some reason could not move to it completely. 

 Prehisto...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automatically export Google Forms to Notion using IFTTT and Django</h1><div class="post__text post__text-html js-mediator-article">  Good day to all!  I think the article will be interesting to everyone who uses Notion, but for some reason could not move to it completely. <br><br><h3>  Prehistory </h3><br>  I am developing <a href="https://vc.ru/tribuna/66577-reface-upravlyay-mirom-dvizheniem-glaz">my project</a> .  On the landing page after entering the email, a link to a Google Forms based survey is issued.  Answers are recorded in a tablet on Google Drive. <br><br>  The problem is that I <s>carry everything</s> I <s>keep with myself</s> in Notion.  It is trite more convenient.  Managed by manual copy-paste, while there were few reviews.  Then there were more of them - and I had to think of something.  Who cares what happened - welcome under cat. <br><a name="habracut"></a><br><h3>  Problem </h3><br>  Google Forms records responses only in a tablet - that is, there is no other recipe.  Therefore, I had a plan: let's listen to the updates of the tablets through IFTTT, send new data to the webbook, somehow process them and upload them to Notion. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For those who are not familiar with IFTTT: this is a service that allows you to make chains of actions.  Say, ‚Äúthe post has come to telegrams‚Äù - ‚Äúwe export it to VKontakte‚Äù. <br><br>  The plan began to fail: Notion has no official API.  But someone reversed it and made <a href="https://pypi.org/project/notion/">an unofficial API</a> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f5a/db2/7d2/f5adb27d207515233f46367b0de66d6c.jpg" alt="image"><br><br>  <b>The final plan was:</b> <br><br><ul><li>  We make an applet in IFTTT: ‚ÄúA line has been added to the table - we send it to the server </li><li>  We make directly the server that receives the data and sends it to Notion </li></ul><br>  The second problem appeared when it turned out that IFTTT broke integration with Google Sheets, and therefore the applet does not work. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/26d/35b/87b/26d35b87bb2bba45dbc7ce71cef86d58.jpg" alt="image"><br><br>  Therefore, we had to change the plan: we extort csv'shka from Google Sheets, parse it on the server and throw everything new in Notion.  IFTTT is used as a trigger for the whole process. <br><br><h3>  Part 1. CSV with Google Sheets </h3><br>  This part is probably the easiest.  Open the table for viewing (so as not to have to mess with the cookies).  Next, take and copy the link to export CSV.  For this action, by lightly pressing the keyboard, type Ctrl + Shift + J (that is, open the developer console), go to the Network tab.  Then click on File - Download - CSV.  We see the request and copy the link. <br><br><h3>  Part 2. We write the server </h3><br>  Since we have Python library, we will write on Django. <br><br>  Now a little about the structure of my particular table.  A table in Notion, unlike a table in Google Sheets, has a column ‚ÄúReference‚Äù.  This is a link to another table (in my case, a description of the features that users liked).  The rest is generally clear: just columns with just data. <br><br>  Go to Notion, with the usual Ctrl + Shift + J, open the console, go to Application - Cookies, copy token_v2 and call it TOKEN.  Then we go to the necessary page with a tablet and copy the link to it.  Call NOTION.  If you also have a Relation, go to the page with Relation, copy the link and call, for example, NOTION_FUNCTION <br><br>  Next, we write the following code (we import notion beforehand): <br><br><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">index</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> request.method == <span class="hljs-string"><span class="hljs-string">"POST"</span></span>: client = NotionClient(token_v2=TOKEN) database = client.get_collection_view(NOTION) current_rows = database.default_query().execute() database_functions = client.get_collection_view(NOTION_FUNCTIONS) current_rows_functions = database_functions.default_query().execute()</code> </pre> <br>  In it we connect NotionClient, say ‚ÄúDatabases?  Give two! ‚ÄúAnd we receive directly the data from these two plates (by default request, but it is possible also with sorting, in more detail - in documentation to library). <br><br>  Then we have to do the following: request CSV from Google and parse it.  We will do it pandas'om. <br><br><pre> <code class="python hljs">result = requests.get(SHEET).content pandas_result = pd.read_csv(io.StringIO(result.decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>))) timestamps = pandas_result[[<span class="hljs-string"><span class="hljs-string">" "</span></span>]].values ages = pandas_result[[<span class="hljs-string"><span class="hljs-string">" "</span></span>]].values sexes = pandas_result[[<span class="hljs-string"><span class="hljs-string">" "</span></span>]].values cities = pandas_result[[<span class="hljs-string"><span class="hljs-string">" "</span></span>]].values socials = pandas_result[[<span class="hljs-string"><span class="hljs-string">"   (   )"</span></span>]].values agreements = pandas_result[[<span class="hljs-string"><span class="hljs-string">"   ,   - ."</span></span>]].values control_usages = pandas_result[[<span class="hljs-string"><span class="hljs-string">"      "</span></span>]].values health_usages = pandas_result[[<span class="hljs-string"><span class="hljs-string">"       "</span></span>]].values prices = pandas_result[[<span class="hljs-string"><span class="hljs-string">"        .    :)"</span></span>]].values mentions = pandas_result[[<span class="hljs-string"><span class="hljs-string">", ,       "</span></span>]].values</code> </pre><br>  Then we have to go through all the data from this tablet and check whether they are added to Notion or not yet.  For this we requested data from the plates. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkTimestamp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rows, timestamp)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0</span></span>, len(rows)): row = rows[i] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> row.name == timestamp: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre><br>  We should also say about row.name, because an attentive reader will surely ask: what is that all about? <br><br>  This is the name of the column in Notion (where the recording times are stored).  I somehow did not manage to add Russian names, so I changed all the names to English and add them. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1c4/3f7/692/1c43f76924fbdce97c109728120b2a0e.jpg" alt="image"><br><br>  And now the code to check the data and add a line to the Notion table: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0</span></span>, len(timestamps)): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> checkTimestamp(current_rows, timestamps[i]): row = database.collection.add_row() health_usage = health_usages[i][<span class="hljs-number"><span class="hljs-number">0</span></span>] control_usage = control_usages[i][<span class="hljs-number"><span class="hljs-number">0</span></span>] ticks = health_usage + <span class="hljs-string"><span class="hljs-string">","</span></span> + control_usage row.title = timestamps[i][<span class="hljs-number"><span class="hljs-number">0</span></span>] row.age = ages[i][<span class="hljs-number"><span class="hljs-number">0</span></span>] row.sex = sexes[i][<span class="hljs-number"><span class="hljs-number">0</span></span>] row.social_network = checkEmptiness(socials[i][<span class="hljs-number"><span class="hljs-number">0</span></span>]) row.can_we_write_you = checkEmptiness(agreements[i][<span class="hljs-number"><span class="hljs-number">0</span></span>]) row.city = checkEmptiness(cities[i][<span class="hljs-number"><span class="hljs-number">0</span></span>]) row.controlling_examples = checkEmptiness(control_usages[i][<span class="hljs-number"><span class="hljs-number">0</span></span>]) row.health_examples = checkEmptiness(health_usages[i][<span class="hljs-number"><span class="hljs-number">0</span></span>]) row.cost = checkEmptiness(prices[i][<span class="hljs-number"><span class="hljs-number">0</span></span>]) row.noticements = checkEmptiness(mentions[i][<span class="hljs-number"><span class="hljs-number">0</span></span>]) row.castdev_relation = findIds(current_rows_functions, ticks)</code> </pre><br>  checkEmptiness is a function that checks whether a null piece has been passed to it.  Notion somehow reluctantly worked when I fed him zero fields, so you should write. <br><br>  We now turn to the analysis of Relation, because I have not seen it in the official documentation.  To make a link to a line from another database, you need to take it (this line) and send it.  Accordingly, if an array of references to rows from another table is implied, it is necessary to take an array of their IDs.  I personally added Relation's by function name. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findIds</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(current_rows, titles)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">"titles"</span></span>, titles) print(<span class="hljs-string"><span class="hljs-string">"current rows"</span></span>, current_rows) array = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0</span></span>, len(current_rows)): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> current_rows[a].name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> titles: array.append(current_rows[a].id) print(<span class="hljs-string"><span class="hljs-string">"Ids"</span></span>, array) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> array</code> </pre><br>  At the end, after creating the lines, we add an answer so that we know at the end that the request has arrived. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HttpResponse(<span class="hljs-string"><span class="hljs-string">"Hello, habr."</span></span>)</code> </pre><br>  Tachemta with the most important server finished, go to IFTTT. <br><br><h3>  Part 3. IFTTT </h3><br>  Go to the <a href="https://ifttt.com/create">tab create applets</a> .  We select the trigger (in our case it is Date &amp; time), set ‚Äúevery hour‚Äù.  Select the triggered (that is, ‚Äúthat‚Äù) Webhook, specify our (for now) local address in order to test.  Well, that's it.  Test <br><br><h3>  Part 4. Heroku </h3><br>  You thought why we were busy with this trigger by the IFTTT - this is in order not to pay.  Heroku offers a free rate for hosting our stuff.  The main thing is that the service sleeps for at least 6 hours.  And he will definitely sleep, because we call him to work every hour, not every minute. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f42/1c4/624/f421c4624a25f5cf6c92b4f890abbfb9.jpg" alt="image"><br><br>  Next, do the following.  Go to heroku to <a href="https://dashboard.heroku.com/new-app">create a new project</a> .  Next, install <a href="https://devcenter.heroku.com/articles/heroku-cli">their client</a> on your operating system.  And then we do everything according to the instructions that appeared after creating the application. <br><br>  Downloading everything to heroku, go to our applet and edit the URL to a new one. <br><br>  Now every hour the list should be updated.  Hypothetically, the IFTTT may give an error message that you have a long request, but this is not so important. <br><br><h3>  Update </h3><br>  It turned out to be important.  When the IFTTT catches constant errors, it starts skipping applets. <br>  To solve this problem, simply launch a new thread for this whole thing, immediately giving an answer. <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> request.method == <span class="hljs-string"><span class="hljs-string">"POST"</span></span>: thread = Thread(target=run_notion_import) thread.start() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HttpResponse(<span class="hljs-string"><span class="hljs-string">"Hello, habr."</span></span>)</code> </pre><br><br>  Another idea that I forgot to voice in the article is to check for nullity using the standard pandas method. <br>  That is, your check will look something like this: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> pd.isna(health_usages[i][<span class="hljs-number"><span class="hljs-number">0</span></span>]): row.health_examples = health_usages[i][<span class="hljs-number"><span class="hljs-number">0</span></span>]</code> </pre></div><p>Source: <a href="https://habr.com/ru/post/455714/">https://habr.com/ru/post/455714/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../4557/index.html">IE 7: new version, new vulnerability</a></li>
<li><a href="../45570/index.html">All the same 100% height and margin</a></li>
<li><a href="../455702/index.html">Effective number generation in a given interval</a></li>
<li><a href="../45571/index.html">New LinkedIn Search Platform</a></li>
<li><a href="../455710/index.html">Why do we need our own development department for 200 people in Leroy Merlin?</a></li>
<li><a href="../455716/index.html">15 recommendations for deploying business intelligence software</a></li>
<li><a href="../45572/index.html">How not to get a job</a></li>
<li><a href="../455720/index.html">How we build a UI for advertising systems</a></li>
<li><a href="../455726/index.html">C ++ Enterprise Edition. Is it possible to?</a></li>
<li><a href="../455728/index.html">We make our almost Extended Floating Action Button</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>