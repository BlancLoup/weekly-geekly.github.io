<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Emulate and intercept SIM commands via the SIM Toolkit on Android 5.1 and below (CVE-2015-3843)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I discovered this vulnerability by exploring the possibility of intercepting one-time passwords that were sent by the bank to the telecommunications s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Emulate and intercept SIM commands via the SIM Toolkit on Android 5.1 and below (CVE-2015-3843)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/d23/059/429/d230594295bd46fdb722f53352aa3496.jpg"><br><br>  I discovered this vulnerability by exploring the possibility of intercepting one-time passwords that were sent by the bank to the telecommunications service provider, and then entered a special SIM card application and were output to the Android user interface. <a name="habracut"></a><br><br><h4>  Intercept </h4><br>  Imagine that there is a small application on the SIM card that receives a message from the service provider and displays it on the screen of your Android device.  If you delve into the source code of Android, you can stumble upon the <a href="">com.android.internal.telephony.cat.CatService</a> class, which is responsible for sending commands between the Radio Interface Layer (RIL) layer and the OS. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Message msg</span></span></span><span class="hljs-function">)</span></span> { CatLog.d(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"handleMessage["</span></span> + msg.what + <span class="hljs-string"><span class="hljs-string">"]"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (msg.what) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MSG_ID_SESSION_END: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MSG_ID_PROACTIVE_COMMAND: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MSG_ID_EVENT_NOTIFY: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MSG_ID_REFRESH: CatLog.d(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"ril message arrived,slotid:"</span></span> + mSlotId); String data = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (msg.obj != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { AsyncResult ar = (AsyncResult) msg.obj; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ar != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; ar.result != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { data = (String) ar.result; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ClassCastException e) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } mMsgDecoder.sendStartDecodingMessageParams(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RilMessage(msg.what, data)); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MSG_ID_CALL_SETUP: mMsgDecoder.sendStartDecodingMessageParams(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RilMessage(msg.what, <span class="hljs-literal"><span class="hljs-literal">null</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MSG_ID_ICC_RECORDS_LOADED: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MSG_ID_RIL_MSG_DECODED: handleRilMsg((RilMessage) msg.obj); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MSG_ID_RESPONSE: handleCmdResponse((CatResponseMessage) msg.obj); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;</code> </pre> <br>  Of all the message types, we are interested in <code>MSG_ID_RIL_MSG_DECODED</code> . <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleRilMsg</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RilMessage rilMsg</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rilMsg == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// dispatch messages CommandParams cmdParams = null; switch (rilMsg.mId) { case MSG_ID_EVENT_NOTIFY: if (rilMsg.mResCode == ResultCode.OK) { cmdParams = (CommandParams) rilMsg.mData; if (cmdParams != null) { handleCommand(cmdParams, false); } } break; case MSG_ID_PROACTIVE_COMMAND: try { cmdParams = (CommandParams) rilMsg.mData; } catch (ClassCastException e) { // for error handling : cast exception CatLog.d(this, "Fail to parse proactive command"); // Don't send Terminal Resp if command detail is not available if (mCurrntCmd != null) { sendTerminalResponse(mCurrntCmd.mCmdDet, ResultCode.CMD_DATA_NOT_UNDERSTOOD, false, 0x00, null); } break; } if (cmdParams != null) { if (rilMsg.mResCode == ResultCode.OK) { handleCommand(cmdParams, true); } else { // for proactive commands that couldn't be decoded // successfully respond with the code generated by the // message decoder. sendTerminalResponse(cmdParams.mCmdDet, rilMsg.mResCode, false, 0, null); } } break;</span></span></code> </pre><br>  Both switch statements call the <code>handleCommand()</code> method, but the second parameter is different in each case: <br><br><ul><li>  <code>MSG_ID_EVENT_NOTIFY</code> - a normal notification that does not require a response from the user; </li><li>  <code>MSG_ID_PROACTIVE_COMMAND</code> - and this, on the contrary, requires. </li></ul><br>  Go to <code>handleCommand</code> : <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Handles RIL_UNSOL_STK_EVENT_NOTIFY or RIL_UNSOL_STK_PROACTIVE_COMMAND command * from RIL. * Sends valid proactive command data to the application using intents. * RIL_REQUEST_STK_SEND_TERMINAL_RESPONSE will be send back if the command is * from RIL_UNSOL_STK_PROACTIVE_COMMAND. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleCommand</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CommandParams cmdParams, boolean isProactiveCmd</span></span></span><span class="hljs-function">)</span></span> { CatLog.d(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, cmdParams.getCommandType().name()); CharSequence message; CatCmdMessage cmdMsg = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CatCmdMessage(cmdParams); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (cmdParams.getCommandType()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> SET_UP_MENU: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (removeMenu(cmdMsg.getMenu())) { mMenuCmd = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { mMenuCmd = cmdMsg; } sendTerminalResponse(cmdParams.mCmdDet, ResultCode.OK, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DISPLAY_TEXT: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> REFRESH: <span class="hljs-comment"><span class="hljs-comment">// ME side only handles refresh commands which meant to remove IDLE // MODE TEXT. cmdParams.mCmdDet.typeOfCommand = CommandType.SET_UP_IDLE_MODE_TEXT.value(); break; case SET_UP_IDLE_MODE_TEXT: sendTerminalResponse(cmdParams.mCmdDet, ResultCode.OK, false, 0, null); break; case SET_UP_EVENT_LIST: if (isSupportedSetupEventCommand(cmdMsg)) { sendTerminalResponse(cmdParams.mCmdDet, ResultCode.OK, false, 0, null); } else { sendTerminalResponse(cmdParams.mCmdDet, ResultCode.BEYOND_TERMINAL_CAPABILITY, false, 0, null); } break; case PROVIDE_LOCAL_INFORMATION: ResponseData resp; switch (cmdParams.mCmdDet.commandQualifier) { case CommandParamsFactory.DTTZ_SETTING: resp = new DTTZResponseData(null); sendTerminalResponse(cmdParams.mCmdDet, ResultCode.OK, false, 0, resp); break; case CommandParamsFactory.LANGUAGE_SETTING: resp = new LanguageResponseData(Locale.getDefault().getLanguage()); sendTerminalResponse(cmdParams.mCmdDet, ResultCode.OK, false, 0, resp); break; default: sendTerminalResponse(cmdParams.mCmdDet, ResultCode.OK, false, 0, null); } // No need to start STK app here. return; case LAUNCH_BROWSER: if ((((LaunchBrowserParams) cmdParams).mConfirmMsg.text != null) &amp;&amp; (((LaunchBrowserParams) cmdParams).mConfirmMsg.text.equals(STK_DEFAULT))) { message = mContext.getText(com.android.internal.R.string.launchBrowserDefault); ((LaunchBrowserParams) cmdParams).mConfirmMsg.text = message.toString(); } break; case SELECT_ITEM: case GET_INPUT: case GET_INKEY: break; case SEND_DTMF: case SEND_SMS: case SEND_SS: case SEND_USSD: if ((((DisplayTextParams)cmdParams).mTextMsg.text != null) &amp;&amp; (((DisplayTextParams)cmdParams).mTextMsg.text.equals(STK_DEFAULT))) { message = mContext.getText(com.android.internal.R.string.sending); ((DisplayTextParams)cmdParams).mTextMsg.text = message.toString(); } break; case PLAY_TONE: break; case SET_UP_CALL: if ((((CallSetupParams) cmdParams).mConfirmMsg.text != null) &amp;&amp; (((CallSetupParams) cmdParams).mConfirmMsg.text.equals(STK_DEFAULT))) { message = mContext.getText(com.android.internal.R.string.SetupCallDefault); ((CallSetupParams) cmdParams).mConfirmMsg.text = message.toString(); } break; case OPEN_CHANNEL: case CLOSE_CHANNEL: case RECEIVE_DATA: case SEND_DATA: BIPClientParams cmd = (BIPClientParams) cmdParams; /* Per 3GPP specification 102.223, * if the alpha identifier is not provided by the UICC, * the terminal MAY give information to the user * noAlphaUsrCnf defines if you need to show user confirmation or not */ boolean noAlphaUsrCnf = false; try { noAlphaUsrCnf = mContext.getResources().getBoolean( com.android.internal.R.bool.config_stkNoAlphaUsrCnf); } catch (NotFoundException e) { noAlphaUsrCnf = false; } if ((cmd.mTextMsg.text == null) &amp;&amp; (cmd.mHasAlphaId || noAlphaUsrCnf)) { CatLog.d(this, "cmd " + cmdParams.getCommandType() + " with null alpha id"); // If alpha length is zero, we just respond with OK. if (isProactiveCmd) { sendTerminalResponse(cmdParams.mCmdDet, ResultCode.OK, false, 0, null); } else if (cmdParams.getCommandType() == CommandType.OPEN_CHANNEL) { mCmdIf.handleCallSetupRequestFromSim(true, null); } return; } // Respond with permanent failure to avoid retry if STK app is not present. if (!mStkAppInstalled) { CatLog.d(this, "No STK application found."); if (isProactiveCmd) { sendTerminalResponse(cmdParams.mCmdDet, ResultCode.BEYOND_TERMINAL_CAPABILITY, false, 0, null); return; } } /* * CLOSE_CHANNEL, RECEIVE_DATA and SEND_DATA can be delivered by * either PROACTIVE_COMMAND or EVENT_NOTIFY. * If PROACTIVE_COMMAND is used for those commands, send terminal * response here. */ if (isProactiveCmd &amp;&amp; ((cmdParams.getCommandType() == CommandType.CLOSE_CHANNEL) || (cmdParams.getCommandType() == CommandType.RECEIVE_DATA) || (cmdParams.getCommandType() == CommandType.SEND_DATA))) { sendTerminalResponse(cmdParams.mCmdDet, ResultCode.OK, false, 0, null); } break; default: CatLog.d(this, "Unsupported command"); return; } mCurrntCmd = cmdMsg; broadcastCatCmdIntent(cmdMsg); }</span></span></code> </pre> <br>  And finally, <code>broadcastCatCmdIntent()</code> : <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">broadcastCatCmdIntent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CatCmdMessage cmdMsg</span></span></span><span class="hljs-function">)</span></span> { Intent intent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(AppInterface.CAT_CMD_ACTION); intent.putExtra(<span class="hljs-string"><span class="hljs-string">"STK CMD"</span></span>, cmdMsg); intent.putExtra(<span class="hljs-string"><span class="hljs-string">"SLOT_ID"</span></span>, mSlotId); CatLog.d(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"Sending CmdMsg: "</span></span> + cmdMsg+ <span class="hljs-string"><span class="hljs-string">" on slotid:"</span></span> + mSlotId); mContext.sendBroadcast(intent); }</code> </pre><br>  But this part is quite entertaining: <br><br><ul><li>  <code>AppInterface.CAT_CMD_ACTION</code> equals <code>android.intent.action.stk.command</code> ; </li><li>  <code>SLOT_ID</code> used for devices with multiple SIM cards; </li><li>  <code>STK CMD</code> - command as a <code>Parcelable</code> object. </li></ul><br>  The problem is that to send a command to another application, the CatService uses an implicit intent without restriction of privileges. <br><br><h5>  How can an attacker take advantage of this? </h5><br>  For example, use a malicious application that does not require additional privileges to intercept commands sent by a SIM card to a phone.  To do this, you only need to register the receiver with the action android.intent.action.stk.command and get the STK CMD from the intent. <br><br>  An example of an intercepted command: <br><br><img src="https://habrastorage.org/files/720/fbf/916/720fbf91637a42df96df0923bb088084.png"><br><br>  This is a <code>Parcelable</code> object in bytes.  When converting Hex to ASCII, you will receive a SIM card message. <br><br><h4>  Emulation </h4><br>  However, this is only half the vulnerability.  Consider an application that receives a broadcast message like this: <br><br><img src="https://habrastorage.org/files/785/42d/023/78542d023e1c46069b0a38a90046e27b.jpg"><br><br>  <i>Type of message</i> <br><br>  This application is called SIM Toolkit (STK) and is part of the standard Android framework.  Sources can be found <a href="https://android.googlesource.com/platform/packages/apps/Stk/%2B/master">here</a> . <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">manifest</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:android</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:androidprv</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/apk/prv/res/android"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">package</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.android.stk"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:sharedUserId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.uid.phone"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">original-package</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.android.stk"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.RECEIVE_BOOT_COMPLETED"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.GET_TASKS"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">application</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:icon</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@drawable/ic_launcher_sim_toolkit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:label</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@string/app_name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:clearTaskOnLaunch</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:process</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.android.phone"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:taskAffinity</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.task.stk"</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">receiver</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.android.stk.StkCmdReceiver"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">= </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.intent.action.stk.command"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">= </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.intent.action.stk.session_end"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">= </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.intent.action.stk.icc_status_change"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">= </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.intent.action.stk.alpha_notify"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">= </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.intent.action.LOCALE_CHANGED"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">receiver</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  The above is a fragment of the <code>AndroidManifest.xml</code> file related to the <code>receiver</code> component.  As you can see, the component is fully exported.  This allows not only intercepting SIM-card commands, but also creating a <code>Parcelable</code> object with the help of malicious programs, and then sending it to <code>com.android.stk.StkCmdReceiver</code> .  <code>Receiver</code> does not check the sender, and the android.intent.action.stk.command action is not announced in the AndroidManifest.xml system file as a secure message, which allows fraudsters to emulate sending SIM commands. <br><br>  For example: <br><br>  1. The SIM card requests confirmation of a certain operation, say, a transaction in the Internet bank, displaying on the phone screen a message like ‚ÄúConfirm transaction No. 1234 worth 100,500 rubles‚Äù with two options - ‚ÄúOK‚Äù and ‚ÄúCancel‚Äù.  The code on <a href="">StkDialogActivity.java</a> : <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onClick</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">View v</span></span></span><span class="hljs-function">)</span></span> { String input = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (v.getId()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> OK_BUTTON: CatLog.d(LOG_TAG, <span class="hljs-string"><span class="hljs-string">"OK Clicked!, mSlotId: "</span></span> + mSlotId); cancelTimeOut(); sendResponse(StkAppService.RES_ID_CONFIRM, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CANCEL_BUTTON: CatLog.d(LOG_TAG, <span class="hljs-string"><span class="hljs-string">"Cancel Clicked!, mSlotId: "</span></span> + mSlotId); cancelTimeOut(); sendResponse(StkAppService.RES_ID_CONFIRM, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } finish(); }</code> </pre><br>  2. If the user clicks OK, the <code>sendResponse(StkAppService.RES_ID_CONFIRM, true)</code> command will be called <code>sendResponse(StkAppService.RES_ID_CONFIRM, true)</code> ;  otherwise, <code>sendResponse(StkAppService.RES_ID_CONFIRM, false)</code> <br><br>  3. What if using the <code>android.intent.action.stk.command</code> action create the same dialog box with other text (fake) and display it on the screen a few seconds before the SIM card generates the original message (‚ÄúConfirm transaction No. 1234 on the amount of 100 500 rubles ")?  In the text of the message we will write ‚ÄúClick OK to close‚Äù, and the buttons will remain the same - ‚ÄúOK‚Äù and ‚ÄúCancel‚Äù. <br><br>  4. The user will not see the original transaction confirmation dialog until he selects one of these options in the fake window, since all commands requiring user interaction are queued. <br><br>  5. So, we stopped at the following: <br><br><ul><li>  The SIM card is waiting for a response from the user; </li><li>  Android shows the user the first (fake) dialogue. </li></ul><br>  If you click "OK", the <code>sendResponse()</code> method will be called with the "true" flag and the SIM card will receive the "OK" command as if it were sent from the original dialog.  Even if the user selects the ‚ÄúCancel‚Äù option in the second window, this will not affect the previous command in any way.  The SIM card will take this as a new response, which it does not expect.  In the source I was able to find a description of a similar situation: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleCmdResponse</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CatResponseMessage resMsg</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Make sure the response details match the last valid command. An invalid // response is a one that doesn't have a corresponding proactive command // and sending it can "confuse" the baseband/ril. // One reason for out of order responses can be UI glitches. For example, // if the application launch an activity, and that activity is stored // by the framework inside the history stack. That activity will be // available for relaunch using the latest application dialog // (long press on the home button). Relaunching that activity can send // the same command's result again to the CatService and can cause it to // get out of sync with the SIM. This can happen in case of // non-interactive type Setup Event List and SETUP_MENU proactive commands. // Stk framework would have already sent Terminal Response to Setup Event // List and SETUP_MENU proactive commands. After sometime Stk app will send // Envelope Command/Event Download. In which case, the response details doesn't // match with last valid command (which are not related). // However, we should allow Stk framework to send the message to ICC.</span></span></code> </pre><br>  It says that "Invalid is a response that does not have an appropriate proactive command and sending which can‚Äú confuse ‚Äùbaseband / ril‚Äù.  In fact, if a RIL or SIM card gets unexpected feedback from you, the consequences can be unpredictable.  In the course of my research, several SIM cards failed, without loading the menu. <br><br><h4>  Conclusion </h4><br>  The AOSP team fixed this error in updating Android 5.1.1 for Nexus devices (build LMY48I). <br><br>  Here are some of my patches: <br><br><pre> <code class="cs hljs">For /platform/frameworks/opt/telephony/+/master/: --- a/src/java/com/android/<span class="hljs-keyword"><span class="hljs-keyword">internal</span></span>/telephony/cat/CatService.java +++ b/src/java/com/android/<span class="hljs-keyword"><span class="hljs-keyword">internal</span></span>/telephony/cat/CatService.java @@ <span class="hljs-number"><span class="hljs-number">-501</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> +<span class="hljs-number"><span class="hljs-number">501</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> @@ intent.putExtra(<span class="hljs-string"><span class="hljs-string">"STK CMD"</span></span>, cmdMsg); intent.putExtra(<span class="hljs-string"><span class="hljs-string">"SLOT_ID"</span></span>, mSlotId); CatLog.d(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"Sending CmdMsg: "</span></span> + cmdMsg+ <span class="hljs-string"><span class="hljs-string">" on slotid:"</span></span> + mSlotId); - mContext.sendBroadcast(intent); + mContext.sendBroadcast(intent,<span class="hljs-string"><span class="hljs-string">"android.permission.RECEIVE_STK_COMMANDS"</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/** @@ -514,7 +514,7 @@ mCurrntCmd = mMenuCmd; Intent intent = new Intent(AppInterface.CAT_SESSION_END_ACTION); intent.putExtra("SLOT_ID", mSlotId); - mContext.sendBroadcast(intent); + mContext.sendBroadcast(intent,"android.permission.RECEIVE_STK_COMMANDS"); } @@ -868,7 +868,7 @@ intent.putExtra(AppInterface.CARD_STATUS, cardPresent); CatLog.d(this, "Sending Card Status: " + cardState + " " + "cardPresent: " + cardPresent); - mContext.sendBroadcast(intent); + mContext.sendBroadcast(intent,"android.permission.RECEIVE_STK_COMMANDS"); } private void broadcastAlphaMessage(String alphaString) { @@ -877,7 +877,7 @@ intent.addFlags(Intent.FLAG_RECEIVER_FOREGROUND); intent.putExtra(AppInterface.ALPHA_STRING, alphaString); intent.putExtra("SLOT_ID", mSlotId); - mContext.sendBroadcast(intent); + mContext.sendBroadcast(intent,"android.permission.RECEIVE_STK_COMMANDS"); } @Override For /platform/frameworks/base/ : --- a/core/res/AndroidManifest.xml +++ b/core/res/AndroidManifest.xml @@ -303,6 +303,11 @@ &lt;protected-broadcast android:name="android.intent.action.ACTION_SET_RADIO_CAPABILITY_DONE" /&gt; &lt;protected-broadcast android:name="android.intent.action.ACTION_SET_RADIO_CAPABILITY_FAILED" /&gt; + &lt;protected-broadcast android:name="android.intent.action.stk.command" /&gt; + &lt;protected-broadcast android:name="android.intent.action.stk.session_end" /&gt; + &lt;protected-broadcast android:name="android.intent.action.stk.icc_status_change" /&gt; + &lt;protected-broadcast android:name="android.intent.action.stk.alpha_notify" /&gt; + &lt;!-- ====================================== --&gt; &lt;!-- Permissions for things that cost money --&gt; &lt;!-- ====================================== --&gt; @@ -2923,6 +2928,9 @@ android:description="@string/permdesc_bindCarrierMessagingService" android:protectionLevel="signature|system" /&gt; + &lt;permission android:name="android.permission.RECEIVE_STK_COMMANDS" + android:protectionLevel="signature|system" /&gt; + &lt;!-- The system process is explicitly the only one allowed to launch the confirmation UI for full backup/restore --&gt; &lt;uses-permission android:name="android.permission.CONFIRM_FULL_BACKUP"/&gt; For /platform/packages/apps/Stk/ : --- a/AndroidManifest.xml +++ b/AndroidManifest.xml @@ -24,6 +24,7 @@ &lt;uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" /&gt; &lt;uses-permission android:name="android.permission.GET_TASKS"/&gt; + &lt;uses-permission android:name="android.permission.RECEIVE_STK_COMMANDS"/&gt; &lt;application android:icon="@drawable/ic_launcher_sim_toolkit" android:label="@string/app_name"</span></span></code> </pre><br>  <b>Author</b> : Head of Mobile Applications Security, Positive Technologies ( <a href="http://blog.0xb.in/2015/08/spoofing-and-intercepting-sim-commands.html">English version of the material</a> ) </div><p>Source: <a href="https://habr.com/ru/post/280095/">https://habr.com/ru/post/280095/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280085/index.html">Windows Trojan specializes in stealing data from isolated air-gapped computers</a></li>
<li><a href="../280087/index.html">Superscalar stack processor: details</a></li>
<li><a href="../280089/index.html">Conference DUMP-2016: Review of the Web-design section</a></li>
<li><a href="../280091/index.html">Who are the most famous hackers in history?</a></li>
<li><a href="../280093/index.html">25 questions asked during an interview with Linux system administrators</a></li>
<li><a href="../280097/index.html">Underground carders market. Translation of the book "KingPIN". Chapter 32. The Mall</a></li>
<li><a href="../280099/index.html">NPM and left-pad: have we forgotten how to program?</a></li>
<li><a href="../280105/index.html">NetApp FlexClone: ‚Äã‚ÄãHow technology accelerates development</a></li>
<li><a href="../280107/index.html">Qt for mobile cross-platform development</a></li>
<li><a href="../280111/index.html">15 free online programming courses</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>