<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About antivirus bypass in practice</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The other day a link to the news about a universal antivirus workaround was published on this blog. However, the essence of the message is distorted b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About antivirus bypass in practice</h1><div class="post__text post__text-html js-mediator-article">  The other day a <a href="http://habrahabr.ru/blogs/infosecurity/93269/">link to the news about a universal antivirus workaround</a> was published <a href="http://habrahabr.ru/blogs/infosecurity/93269/">on</a> this blog.  However, the essence of the message is distorted by a chain of English and Russian copy-passer journalists into a heresy so incompatible with reason and reality that I, as an expert on (anti) viral technologies, had to re-read the text twice before I understood what it was about.  Therefore, it is recommended to get acquainted with the <a href="http://www.matousec.com/info/articles/khobe-8.0-earthquake-for-windows-desktop-security-software.php">source</a> . <br><br>  I will not comment on the proposed concept - <a href="http://www.sophos.com/blogs/duck/g/2010/05/11/khobe-vulnerability-earth-shaker/">antivirus vendors</a> will successfully cope with this task.  The essence is different: bypassing anti-virus protection is not the science of missiles, which requires a conceptual approach, but is quite commonplace.  To illustrate this fact, I will give a few technical examples from life. <br><br> <a href=""><img align="left" alt="Antivirus-losers" src="http://blog.alisa.sh/images/av_tdss_small.png"></a>  Examples will be extracted from our favorite little creature - the TDSS bot rootkit, which has been talked about a lot lately.  Which is not surprising: this is one of the most common, technically advanced and actively developing bots. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The diagram on the left shows statistics on anti-virus protection installed on users' computers <b>simultaneously with the infection with</b> TDSS. <br><a name="habracut"></a><br><br>  Notes to the chart: <br><ol><li>  Baseline data - statistics from users of the TDSS Remover utility for the first quarter of 2010. </li><li>  A total of about a thousand infected machines were processed. </li><li>  Of these, 12% were equipped with known antivirus </li><li>  The diagram <b>does not</b> display statistics on antivirus programs that failed treatment, but do not block or hide their files.  The fact of locking or hiding files falls into the statistics as an anomaly significant for the anti-rootkit. </li></ol><br><h4>  A few words about the little animals </h4><br>  Appearing about two years ago, a TDSS bot rootkit (also known as Alureon, Tidserv, TDL / TDL2 / TDL3 +) quietly and quietly multiplied to alarming numbers. <br><br>  Namely: <br><ul><li>  The TDSS family (here - Alureon) ranks <a href="http://blogs.technet.com/mmpc/archive/2010/04/30/msrt-april-threat-reports-alureon.aspx">third</a> in the number of infected machines in April 2010. </li><li>  TDSS botnet (here - Tidserv) <a href="http://blog.damballa.com/%3Fp%3D569">is among the TOP10</a> largest botnets in the world, representing a population of <a href="http://www.networkworld.com/news/2009/072209-botnets.html">1.5 million zombie machines</a> only in the US </li><li>  According to our own research, the figure of "1.5 million" infected machines greatly underestimated. </li></ul><br>  The fundamental factor in such a rapid and, at the same time, silent victory is a <b>bet on antivirus bypass and advanced technologies</b> .  The task is successfully solved from the first days of the bot's existence to this day: as the antiviruses are updated, the technologies of their crawling in the TDSS code are updated, invariably pleasing researchers and ‚Äúpleasing‚Äù developers of protection with originality of innovations. <br><br>  In fact, throughout the lifetime of TDSS, it was continuously unattainable for <b>all</b> existing remedies, including the most popular antiviruses and professional anti-rootkits.  Moreover, until recently, the bot has <i>quietly</i> developed under the cover of its own efficiency, since it was unprofitable for antivirus vendors to publicize a threat that they could not cope with. <br><br>  Over the past six months, the situation has improved slightly.  The confrontation continues, the ‚Äúbig‚Äù antiviruses still fail to cope, but they have begun to produce specialized utility tools (Norman TDSS Cleaner, Kaspersky TDSSKiller). <br><br><h4>  Antivirus bypass: technical information </h4><br>  From the point of view of survival, the malware has two major tasks: <br><ol><li>  At the stage of installation - bypassing behavioral protection (HIPS, proactive defense, sandbox). <br>  <b>Methods: the</b> use of legitimate system mechanisms that are not provided by the developers of protection, and "white lists" of protection;  less commonly, exploitation of vulnerabilities in the antivirus code or operating system. <br></li><li>  At the stage of active infection - protection of its own code from detection and deletion. <br>  <b>Methods:</b> from prohibiting anti-virus updates and blocking access to files, to hiding files (rootkit-technology) and their complete absence (more on that below). </li></ol><br><h4>  Examples of protection bypass techniques </h4><br>  The techniques are listed in the order in which we found them in the evolving TDSS.  All the described techniques are not as effective as they were at the time of their appearance. <br><br><h5>  Example number 1.  System Cache Dynamic Libraries </h5><br>  <b>The essence of the technique: the</b> malicious code is placed in the system cache of frequently used libraries <a href="http://blogs.msdn.com/larryosterman/archive/2004/07/19/187752.aspx">\ KnownDLLS</a> , from where it is called by a legitimate system application when it uses one of these libraries. <br><br>  <b>Profit:</b> one shot killed two hares: bypassing behavioral protection and bypassing a personal firewall.  The latter is possible due to the fact that the malicious code is executed in the context of the system process ‚Äútrusted‚Äù by default. <br><br>  <b>Pseudo-code:</b> <br><br> <code>// 1.         <br> NtCreateSection(‚Äù\knowndlls\dll.dll‚Äù) <br> // 2.        , <br> //   -      <br> CopyFile(‚Äùmsi.dll‚Äù, "patched_msi.dll") <br> WriteFile("patched_msi.dll", &lt;  dll.dll&gt;) <br> // 3.      <br> NtOpenSection(‚Äù\knowndlls\msi.dll‚Äù) <br> NtMakeTemporaryObject(...) //   ,    ... <br> CloseHandle(...) //  <br> NtCreateSection(‚Äùpatched_msi.dll‚Äù) <br> // 4.   ,    msi.dll =&gt; dll.dll <br> StartService (‚ÄùWindows Installer (msiexec.exe)‚Äù)</code> <br> <br><h5>  Example number 2.  Print manager </h5><br>  The essence of the technique is the same as in the previous example - a passive implementation in the system process.  The mechanism is somewhat different: the malicious code is pushed off to the print dispatcher service under the guise of its utility library. <br><br>  <b>Pseudo-code:</b> <br><br> <code>//1.         <br> GetPrintProcessorDirectory(...) <br> GetTempFileName(...) <br> CopyFile(&lt;self&gt;,&lt;tempname&gt;) <br> // 2.       <br> StartService("spooler") <br> // 3.     <br> AddPrintProcessor(&lt;tempname&gt;) <br></code> <br><br><h5>  Example number 3.  Infecting a legitimate driver </h5><br>  The previous examples illustrated the behavioral defense bypass.  Now consider how TDSS avoids detection and treatment. <br><br>  <b>The essence of the approach:</b> minimizing changes to the system, + powerful low-level masking of the remaining "tails". <br><br>  Since the end of last year, TDSS has virtually no own files or links to it in the startup lists.  The power of the ‚Äútails‚Äù masking is ensured by the fact that the rootkit filters are located below the level of all existing anti-rootkit technologies. <br><br> <a href=""><img src="http://www.esagelab.ru/images/disc_hooks_ru_small.jpg" align="left"></a> <ol><li>  The microdifferentiation of the miniport disk driver is being carried out (atapi.sys for IDE disks, iastor.sys for all others).  The size of the driver does not change, and the infection code is minimal and only provides loading of the main body of the rootkit. <br>  <b>Profit:</b> autoload with miniport driver. </li><li>  The code and configuration file of the rootkit is stored in the last sectors of the disk, in its own file system. <br>  <b>Profit:</b> rootkit files "do not exist" for the operating system, but remain available for applications that know the secret path to them. </li><li>  Masking infection of the system driver and the last sectors of the disk is done by filtering data at the miniport level. <br>  <b>Profit:</b> invisibility for all existing protection mechanisms (see the diagram). </li></ol><br><h5>  Example number 4.  "Odnoshagovka" </h5><br>  At the end of April, the bot was once again updated. <br><br> <code>version= <font color="red">3.273</font> <br> builddate= <font color="red">20.4.2010 16:17:53</font></code> <br> <br>  This time, the task of circumventing the defenses is solved by a minimal modification of the techniques from an already existing arsenal.  Namely: <br><ol><li>  Files atapi.sys / iastor.sys under the watchful eye of protection?  - The new version is infected with a random driver. </li><li>  Behavioral defenses learned to notice the call to the <a href="http://msdn.microsoft.com/en-us/library/dd183348(VS.85).aspx">AddPrintProcessor</a> function ‚Äî it was replaced with a call to the similar function <a href="http://msdn.microsoft.com/en-us/library/dd183349(VS.85).aspx">AddPrintProvidor</a> .  (!) </li><li>  Some healer tools reached the protected areas of the rootkit on the disk via the <a href="http://support.microsoft.com/kb/251369">SCSI Pass Through</a> interface - in the new version of the rootkit, the corresponding IRPs are filtered. </li></ol><br>  I note that it is exactly the same as in the last example that the primitive one-step protection bypass scheme is found at every step in the mass malware.  Such a solution requires neither a special genius from the developer, nor special vulnerabilities from protection, and is characterized by an extremely short lifespan. <br><br>  Techniques as complex (as in Example # 3) or cunning (Examples # 1 and 2) are more characteristic of well-funded targeted rootkits.  It remains an open question whether the TDSS team has lost its best developer, or is it still a fair amount of funding? .. </div><p>Source: <a href="https://habr.com/ru/post/93027/">https://habr.com/ru/post/93027/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../93019/index.html">Server2008, unknown device driver installed successfully</a></li>
<li><a href="../93020/index.html">About State. orders, State. sites and all that</a></li>
<li><a href="../93021/index.html">CEO disco</a></li>
<li><a href="../93024/index.html">Foxconn D51S - the right motherboard on the Intel Atom D510 for home NAS</a></li>
<li><a href="../93026/index.html">Steve Jobs about flash technology. Applied rhetoric</a></li>
<li><a href="../93028/index.html">Get the file version (exe, dll) using java</a></li>
<li><a href="../93031/index.html">Do not forget: the video of the war</a></li>
<li><a href="../93034/index.html">Online Library</a></li>
<li><a href="../93036/index.html">How we assembled a computer class for people with disabilities</a></li>
<li><a href="../93040/index.html">The first frame of the "Renaissance" Futurama</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>