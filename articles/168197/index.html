<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Learning robot control by IR remote</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I recently joined the project Robot-Mitya . Thanks a lot to Dmitry DmitryDzz for making such a cool project and helping with the initial launch of the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Learning robot control by IR remote</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/cea/2e2/fb9/cea2e2fb92fc4b96bd8d6433ae77e70a.jpg"><br>  I recently joined the <a href="http://habrahabr.ru/post/135043/">project Robot-Mitya</a> .  Thanks a lot to Dmitry <a href="https://geektimes.ru/users/dmitrydzz/" class="user_link">DmitryDzz</a> for making such a cool project and helping with the initial launch of the robot, especially with regard to launching an Android application. <br>  The robot could already be controlled via Bluetooth and Wi-Fi (via Android head).  And after a while I wanted to control the Mitya remote.  On board the staff robot, the Robot already had an IR receiver (after all, it was originally assembled for the IR warhead), so the matter remained with the code.  Pretty quickly, we managed to adjust the control using our TV remote control, reading and writing down the ‚Äúcodes‚Äù of the remote control keys provided by the IRremote.h library.  However, for this I had to prescribe these ‚Äúcodes‚Äù in the code, which was not universal: each participant would have to manually read and prescribe the codes separately, and I would have to re-write the data of these consoles in the sketch when changing the console or a small change of commands.  And how great it would be to take ANY remote and just start controlling Mitya with it! <br><br><a name="habracut"></a><br><h4>  Teaching robot remote control commands </h4><br>  And really, why and yes?  After all, on board the Arduino 512 bytes of EEPROM, which is enough to save 128 commands.  (One ‚Äúcode‚Äù takes 4 bytes).  I now got only 17 teams.  It remains to figure out how to implement learning the robot console.  I would like to do this so that it is as simple as possible and desirable even without the participation of the telephone part of the robot (all of a sudden someone will assemble the robot and it will not have an Android phone).  In this case, immediately after assembling the robot, it will be possible to fill it with a sketch, immediately control the robot without any changes.  This is one of the small victories that will greatly delight the new participant and he will have more motivation to move on (assembling Android and the robot's Windows parts.) - We decided that in the process of joining a new participant it is very important that at each stage a person sees a positive feedback connection from the development, and did not quit halfway, if something does not work.  Therefore, it was decided to train the commands from the console exclusively with the help of the console. <br>  In order for the robot to learn that it is time for him to learn, he will wait for pressing any key on the console in Morse code, for example, the letters K (I named my robot after my wife Katyusha), i.e.  Long press, then short, long and short again. <br>  After that, the robot enters an interactive learning mode.  This means that he starts to perform an action, and you just need to press the button for this action, then the next one and so on until the last action. <br>  In conclusion, after saving all the parameters, Katyusha begins to spin in the dance, inviting him to play. <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/YnhsniKRR40%3Ffeature%3Doembed&amp;xid=17259,15700002,15700023,15700186,15700191,15700253&amp;usg=ALkJrhiwgTqwu2YyR_vEDwk4wRcdepWFXg" frameborder="0" allowfullscreen=""></iframe>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Programming </h4><br>  Add this to our <code>robo_body.ino.</code> sketch <code>robo_body.ino.</code> <br>  All comments in English because  The project is planned to be international, but at the beginning of each block I added comments in Russian too :) <br>  All code consists of several blocks: <br><br><h5>  Loading old teams </h5><br>  When starting up, we load old commands from memory.  If they have not been recorded before this, nothing terrible will happen. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;EEPROM.h&gt; ... const int IR_TOTAL_COMMANDS = 17; // Total Number of commands, that can be send by IR control unsigned long IrCommands[IR_TOTAL_COMMANDS]; // All command from remote control // Read all IR commands from EEPROM for(int i=0; i&lt;sizeof(IrCommands); i++) { *((byte*)&amp;IrCommands + i) = EEPROM.read(i); }</span></span></span></span></code> </pre><br><br><h5>  Check keystrokes on the IR remote </h5><br>  We check if the buttons on the remote control were pressed and for how long, after that the command handler is launched. <br>  After pressing any button on the remote, the function <code>irrecv.decode(&amp;results);</code>  returns the button code in <code>results.value</code> if the button was just clicked.  If the button was pressed and held, the button code is sent, and then <code>IR_COMMAND_SEPARATOR = 0xFFFFFFFF</code> sent at a certain frequency until the button is released.  Thus, we define the duration of pressing - fast <code>IrRemoteButtonState = 1</code> , short <code>IrRemoteButtonState = 2</code> - one <code>IR_COMMAND_SEPARATOR</code> came after the command, and a long <code>IrRemoteButtonState = 3</code> - two or more <code>IR_COMMAND_SEPARATOR</code> . <br>  To determine the duration, we will consider fast and short equivalent. <br><br>  The <code>CheckIrCommands()</code> function is called from the main <code>loop()</code> . <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Check if any IR remote buttons pressed void CheckIrCommands() { // If we're in programm mode, just check if buttons vere pressed there if(IsInIrProgrammMode) { IrProgrammatorProcess(); return; } if (irrecv.decode(&amp;results)) { // Button was pressed for LONG or SHORT time, but not VERY SHORT ) if(results.value==IR_COMMAND_SEPARATOR) { if(IrRemoteButtonState&lt;3) { // Set the IR remote button state IrRemoteButtonState++; } // Update last pressed button state IrLastCommandsState[0] = IrRemoteButtonState; }else { IrRemoteLastCommand = results.value; IrRemoteButtonState = 1; // Saving last pressed buttons and their state - we will use it to determine when to start IR programmator. for(int i=IR_LAST_COMMANDS_BUFFER_SIZE-1; i&gt;0; i--) { IrLastCommandsState[i] = IrLastCommandsState[i-1]; IrLastCommandsValue[i] = IrLastCommandsValue[i-1]; } IrLastCommandsValue[0] = IrRemoteLastCommand; IrLastCommandsState[0] = 2; // For programmator mode short and very short press of the button is equal. checkIrHit(); // Check if robot was hit by another robot } ProcessIrCommands(); irrecv.resume(); } }</span></span></code> </pre><br><br><h5>  Command definition </h5><br>  The <code>ProcessIrCommands()</code> function determines which of the known keys has been pressed and executes the corresponding command. <br>  If the command is unknown, then we check for pressing the same button in Morse code (Long-Short-Long-Short) to start the learning mode. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessIrCommands</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(IrRemoteLastCommand==<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-comment"><span class="hljs-comment">// The signal was not good enough to get the signal data // Check for known commands and executing them for(int i=0; i&lt;IR_TOTAL_COMMANDS; i++) { if(IrCommands[i]==IrRemoteLastCommand) { executeIrCommand(i); return; } } // We recieved unknown command. Let's check if we need to enter in programmator mode. (Same button should be pressed in the following order: LONG-&gt;SHORT-&gt;LONG-&gt;SHORT if((IrLastCommandsValue[0]==IrLastCommandsValue[1])&amp;&amp;(IrLastCommandsValue[0]==IrLastCommandsValue[2])&amp;&amp;(IrLastCommandsValue[0]==IrLastCommandsValue[3]) &amp;&amp;(IrLastCommandsState[0]==2)&amp;&amp;(IrLastCommandsState[1]==3)&amp;&amp;(IrLastCommandsState[2]==2)&amp;&amp;(IrLastCommandsState[1]==3)) { // Starting Programmator mode. IrServoStep = IR_SERVO_STEP_PROGRAM_MODE; // Maximun step for Programm mode, so that user will notice servo movement IsInIrProgrammMode = true; IrProgrammatorStep = 0; executeIrCommand(0); // Executing command and waiting for user to press the button to save it. } }</span></span></code> </pre><br><br><h5>  Command execution </h5><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">executeIrCommand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cmd)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(cmd) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-comment"><span class="hljs-comment">// move forward moveMotor( "G", IR_MOVE_SPEED ); break; case 1: // move backwards moveMotor( "G", -IR_MOVE_SPEED ); break; case 2: // turn left moveMotor( "L", -IR_MOVE_SPEED ); moveMotor( "R", IR_MOVE_SPEED ); break; case 3: // turn right moveMotor( "L", IR_MOVE_SPEED ); moveMotor( "R", -IR_MOVE_SPEED ); break; case 4: //stop moveMotor( "G", 0 ); break; case 5: // Move Horizontal Head Left moveHead( "H", servoHeadHorizontal.read()-IrServoStep ); break; case 6: // Move Horizontal Head Right moveHead( "H", servoHeadHorizontal.read()+IrServoStep ); break; case 7: // Move Vertical Head Up moveHead( "V", servoHeadVertical.read()-IrServoStep ); break; case 8: // Move Vertical Head Down moveHead( "V", servoHeadVertical.read()+IrServoStep ); break; case 9: //no noSwinger.startSwing(90, 1, 400, 2.5, 60, 0.75, true); break; case 10: //yes yesSwinger.startSwing(60, 1, 400, 2.5, 30, 0.8, true); break; case 11: //tail tailSwinger.startSwing(90, 1, 250, 6, 70, 0.9, true); break; case 12: // Mood executeAction("M", 0x0102, true ); break; case 13: // Mood executeAction("M", 0x0103, true ); break; case 14: // Mood executeAction("M", 0x0104, true ); break; case 15: // Mood executeAction("M", 0x0105, true ); break; case 16: // Mood executeAction("M", 0x0106, true ); break; } }</span></span></code> </pre><br><br><h5>  Remembering commands </h5><br>  We start the action of the robot and wait until the user presses the button on the IR remote control.  After pressing the button, we launch the next action, etc. <br>  After receiving the final command, we save everything into the EEPROM's memory and start Katyusha's rotation in a circle, as an indication that she is ready to play with the console. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IrProgrammatorProcess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (irrecv.decode(&amp;results)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((results.value!=IR_COMMAND_SEPARATOR)&amp;&amp;(results.value!=<span class="hljs-number"><span class="hljs-number">0</span></span>)&amp;&amp;(results.value!=IrLastCommandsValue[<span class="hljs-number"><span class="hljs-number">0</span></span>])) { IrCommands[IrProgrammatorStep]=results.value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(IrProgrammatorStep==IR_TOTAL_COMMANDS<span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-comment"><span class="hljs-comment">// Was it the last command? { // Save all IR commands to EEPROM for(int i=0; i&lt;sizeof(IrCommands); i++) { EEPROM.write(i, *((byte*)&amp;IrCommands + i) ); } IsInIrProgrammMode = false; IrServoStep = IR_SERVO_STEP_DEFAULT; executeIrCommand(2); // Tell the user that we finished programm mode }else { executeIrCommand(++IrProgrammatorStep); } } irrecv.resume(); } }</span></span></code> </pre><br><br>  Full code in SVN: <a href="http://code.google.com/p/robot-mitya/source/checkout">http://code.google.com/p/robot-mitya/source/checkout</a> </div><p>Source: <a href="https://habr.com/ru/post/168197/">https://habr.com/ru/post/168197/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../168185/index.html">Deploy Zabbix agents to a large number of Windows-based servers using Powershell</a></li>
<li><a href="../168187/index.html">How to build Adobe Air app for Mac OS AppStore</a></li>
<li><a href="../168189/index.html">License Manager for 1C in a virtual environment + monitoring in Zabbix</a></li>
<li><a href="../168191/index.html">Analysis of the design methodology: errors, situations and useful conclusions from them</a></li>
<li><a href="../168195/index.html">Understanding hashCode () and equals ()</a></li>
<li><a href="../168201/index.html">Objective C. Practice. Events and "dead" objects</a></li>
<li><a href="../168205/index.html">5 components of an advanced online store</a></li>
<li><a href="../168207/index.html">Surveillance on the knee - the tricks of the camera selection</a></li>
<li><a href="../168217/index.html">"Debriefing" - Episode 33 - Special: Moscow voyage of the Amazon</a></li>
<li><a href="../168219/index.html">How to start flying on your own, without risking your life</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>