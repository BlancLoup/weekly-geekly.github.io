<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing an OTA-downloader for ATmega128RFA1 (as part of the Smart Response XE device)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It all started with the acquisition by the author in the secondary market of an interesting device - Smart Response XE ( short description ). It is in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing an OTA-downloader for ATmega128RFA1 (as part of the Smart Response XE device)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/ie/eb/sz/ieebszdo1m1pcoy6jx1gvxww3ao.jpeg"><br><br>  It all started with the acquisition by the author in the secondary market of an interesting device - Smart Response XE ( <a href="http://downloads.smarttech.com/media/sitecore/en/support/product/smartresponse/smartresponsexe/specsheets/specsresponsexev18mar13.pdf">short description</a> ).  It is intended for schools: each student in the class receives a device similar to an electronic notebook or translator of the nineties, the teacher asks a question, and students dial on the device keyboards answers received over the radio (802.15.4) into a receiver connected to the teacher‚Äôs PC. <br><br>  Support for these devices was discontinued several years ago, and the fact that schools purchased $ 100‚Äì200 apiece now pops up on eBay for 10 or less.  "Iron" there is very suitable for geeks experiences: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  60-key keyboard </li><li>  display with a resolution of 384x136, 2 bits per pixel - similar to BK, CGA, but 4 are not colors, but brightness gradations </li><li>  ATmega128RFA1 microcontroller (128 kB flash memory, 4 kB ROM, 16 kB RAM, 802.15.4 transceiver) </li><li>  external (with respect to the microcontroller, and not the entire device) flash memory of 1 megabyte (128 kilobytes) with SPI interface </li><li>  compartment for 4 AAA elements. </li></ul><br>  By the name of the microcontroller, it is clear that it belongs to the AVR family, which means that making an Arduino-compatible device is more than a trivial task ... <a name="habracut"></a><br><br>  From the news on <a href="https://hackaday.com/2018/07/22/classroom-gadget-turned-arduino-compatible/">Hackaday, the</a> author found out that they <a href="https://community.arduboy.com/t/smart-response-xe-re-purposed-into-arduboy/6094/">already did it</a> (using the same link, it tells you where to connect), having the opportunity to run games for Arduboy: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/6VqPGFtIT8Q" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  But the author is more interested in the opportunity not to play on the device, but to study: <br><br><ul><li>  flash memory with SPI serial interface </li><li>  AVR loaders </li><li>  802.15.4 standard </li></ul><br>  The author began by writing a <a href="https://github.com/bitbank2/SmartResponseXE">library</a> (GPL v3), which allows you to initialize the display, display text and rectangles, and gain access to flash memory with an SPI interface.  Then he began to invent ideas for the practical use of the device: a pocket-sized VT-100-compatible terminal, multiplayer games.  Redoing three devices, he decided to ‚Äúteach‚Äù them to get sketches ‚Äúthrough the air‚Äù.  That would be not only interesting, but also very convenient: it is difficult to open the device case every time, and under the battery compartment cover there are only openings that allow you to connect a JTAG programmer to the board. <br><br><img src="https://habrastorage.org/webt/ds/tb/zn/dstbzns76vsm4pfjogzjsyo9mla.jpeg"><br><br>  This is enough to fill the Arduino bootloader, but not the sketch - the serial port is not displayed there, you still can‚Äôt do without opening the case.  Also, the TX0 and RX0 lines of the first serial port are combined with the lines for polling the keyboard matrix, namely, those that poll the function keys on the sides of the display.  But what to do - the author built this: <br><br><img src="https://habrastorage.org/webt/8f/xa/-q/8fxa-qo6dgerkd3ghgh4g-tbjak.jpeg"><br><br>  There he brought the JTAG lines, and now the battery compartment is not necessary to open.  And so that it was possible to fill in and sketches, I brought out the same connector and both serial ports, adding also a switch, because it is impossible to physically turn off the device when the batteries are installed. <br><br>  It took quite a long time to work with a soldering iron, stationery knife and glue gun.  In general, it is much more convenient to fill in sketches ‚Äúthrough the air‚Äù, it is necessary to reinvent something urgently for this. <br><br>  Arduino IDE uses <a href="http://www.ladyada.net/learn/avr/avrdude.html">avrdude</a> to fill in sketches.  It communicates with the microcontroller using the <a href="http://www.tuxgraphics.org/common/src2/article05101/stk500_spec_AVR068.pdf">STK500</a> protocol, which allows you to transfer files in both directions.  It is poorly compatible with channels where variable delays, distortion and data loss are possible.  If something goes away or rustles in the serial channel, you can go crazy looking for a reason.  Once, the author suffered half a day until he realized that it was a bad cable, as well as a capricious converter of the CP2102 interface.  Even a microcontroller with a built-in interface converter, for example, ATmega32u4, can sometimes be naughty.  Each user of Arduino noticed that errors when filling sketches are not so rare.  Sometimes the recording proceeds normally, and an error is detected during the verification reading.  This does not mean that there was an error while writing - there was a failure while reading.  Now imagine that when working "through the air" the same thing will happen, but much more often. <br><br>  Having tried various ways to overcome this problem, the author came up with the following.  The device has 128-kilobyte flash memory with SPI interface - we receive data by wire (remember that the author already has one device with a connector on the side), use this memory as a buffer, and send data to another device via radio.  Such a greeting from Cybiko. <br><br>  After writing the code for working with the radio channel, as well as the font, the bootloader became longer than 4 kilobytes.  Therefore, the value of HFUSE had to be changed from 0xDA to 0xD8.  Now the bootloader can be up to 8 kilobytes in length, and the starting address is 0x1E000.  This is reflected in the Makefile, but must also be taken into account when uploading the <a href="https://www.arduino.cc/en/Hacking/Bootloader%3Ffrom%3DTutorial.Bootloader">bootloader</a> using avrdude. <br><br>  The 802.15.4 transceiver in the ATmega128RFA1 was originally designed to work using the <a href="https://www.zigbee.org/what-is-zigbee/">ZigBee</a> protocol, which is rather complicated, so the author decided instead to simply transfer packets.  This is implemented in hardware in ATmega128RFA1, so it will take a bit of code.  Also, for simplicity, the author decided to use a fixed channel, not allowing him to select it manually.  The 802.15.4 standard supports 16 channels with numbers from 11 to 26. They are quite clogged, some also overlap WiFi channels (ZigBee channels are red, WiFi is blue, green and yellow). <br><br><img src="https://habrastorage.org/webt/nn/vx/fn/nnvxfnxaptwvpgbllq60zkfh2bq.png"><br><br>  It turned out that channels 15 and 26 are the least susceptible to interference from WiFi. The second of them was chosen by the author.  Disclaimer: the translator does not know whether to simplify ZigBee so much.  Maybe it is worth a little more programming and implement it completely? <br><br>  On the first device, you need to implement a state machine that transmits data using the STK500 protocol.  Most of the transmitted and received messages are self-sufficient, but some are tied to those that have passed through the channel earlier.  A description of the dialogue is given <a href="http://baldwisdom.com/bootloading/">here</a> . <br><br>  An important component of this dialogue is the transfer of packets intended for writing to the flash memory of the destination device.  For simple AVR microcontrollers, the page size is 128 bytes, but for ATmega128RFA1 it is 256. And for the flash memory that is connected via SPI, it is the same.  The program in the first device when pouring a sketch does not transfer it immediately to the second, but writes it to this memory.  When the Arduino IDE verifies the correctness of the record, it sends what it has recorded there.  Now it is necessary to transmit the received data over the air to the second device.  In this case, switching from reception to transmission and back occurs quite often.  The STK500 protocol is indifferent to delays, but it does not suffer data loss (strangely, but the above said that data transfer delays also have an effect).  A loss in wireless transmission is inevitable.  ATmega128RFA1 has a built-in hardware implementation of repeated requests with doubts about the correctness of the transfer, but the author decided to implement the same software independently.  He developed a protocol in which much more data passes in one direction than the other. <br><br>  It is not perfect, but everything works.  256-byte page is divided into four segments, each of which is transmitted over the radio as a packet.  A packet holds up to 125 bytes of data plus one byte - length and two - CRC.  So fragments of 64 bytes in length together with the numbers of pages and segments (from 0 to 3) are placed there.  The receiving device has a variable that allows you to track how many segments are received, and when all four arrive, a confirmation is sent to the transmitting device that the entire page is received.  No confirmation (CRC did not match) - send the whole page again.  The speed at the same time turns out even more than when transmitting via cable.  See: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/d-ObUCnRmQU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  But in general, it would be necessary to provide a convenient way to connect to the cable devices for pouring sketches and on it.  For example, place an interface converter on the CP2102 inside, as in the photo, and glue it to the board so that it withstands the force when connecting and disconnecting the Micro USB cable. <br><br><img src="https://habrastorage.org/webt/vd/qj/e7/vdqje7zvkvnkzoggl7nvoezzzry.jpeg"><br><br>  It also has a 3.3-volt stabilizer (and how to use it in a device with 6-volt power - if only there is the same stabilizer, and you can add two diodes to automatically choose which one will power the device).  All three LEDs must be removed from the interface converter board, otherwise they will additionally load the batteries when working on them, and also interfere with the keyboard polling and working with flash memory with an SPI interface. <br><br>  The pursuit of the goal was even more interesting than its achievement (and do not need that joke about the bus).  The author has learned a lot about loaders for AVR, flash memory with SPI interface, STK500 protocol and 802.15.4 standard. <br><br>  The rest of the code in addition to the library described above is <a href="https://github.com/bitbank2/SMART_bootloader">here</a> , and it is also under GPL v3.  Author's twitter is <a href="https://twitter.com/fast_code_r_us">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/447026/">https://habr.com/ru/post/447026/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447016/index.html">25 years later: an interview with Linus Torvalds</a></li>
<li><a href="../447018/index.html">Quantum enrichment in a multi-world interpretation</a></li>
<li><a href="../447020/index.html">Productivity is not about time management, but about attention management.</a></li>
<li><a href="../447022/index.html">Do not make listeners to reflect</a></li>
<li><a href="../447024/index.html">How to combine the benefits of a laptop and a desktop computer? Analysis of problems and ideas solutions</a></li>
<li><a href="../447028/index.html">Steganography past files: hiding data right in the sectors</a></li>
<li><a href="../447034/index.html">New bug in Telegram Desktop allows you to read the latest message.</a></li>
<li><a href="../447036/index.html">Cocktail for healthy eating - it is made by a startup from the accelerator of ITMO University</a></li>
<li><a href="../447038/index.html">In the list of threats: "Game of Thrones" - one of the most popular covers for cybercriminals</a></li>
<li><a href="../447040/index.html">Study: the average cost of switches decreases - we understand why</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>