<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Backup in FreeNas</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, habrauzery! 

 I want to share with you the experience of organizing backup using standard FreeNas tools . 

 To begin with, I would like to in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Backup in FreeNas</h1><div class="post__text post__text-html js-mediator-article"> Hello, habrauzery! <br><br>  I want to share with you the experience of organizing backup using <b>standard FreeNas tools</b> . <br><br>  To begin with, I would like to introduce you to the course of the matter so that the reader can more easily navigate the circumstances of my case, so. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We have in our AD network, with all the associated services, many users and a file server running on FreeNas (aka freeBSD), which is friends with the domain. <br><br>  FreeNas itself has the option of moving deleted files to a hidden folder. <b>Recycle</b> There are deleted files that are grouped into folders, where the folder name is <b>% USERNAME% deleted</b> .  This solution is enough, but what if the user does not delete the information, but changes it? <br>  In this case, the rollback of the file itself is necessary, which our standard file server cannot do. <br><br>  Therefore, we write scripts that we run through cron. <br><a name="habracut"></a><br><br>  I decided to split the script for myself into 2 parts.  The first part makes a backup, the second deletes =) In the second I will explain a little lower. <br><br>  The pepper part of the script, the usual backup, nothing complicated. <br>  We backup, add to where we want and name the archive by creation date to avoid duplication <br><br> <code>pax -wvzf /mnt/data/backup/Hartmann_backup/Hartmann-`date "+%Y%m%d"`.tar.gz /mnt/data/Users_data</code> <br> <br>  Thus, you will have to create archives until the end of free space.  This is bad, you need to delete the oldest copies of the archives.  This is the second part of the script. <br><br>  But here begins a non-trivial solution. <br>  How do we figure out which archive is the last?  The first thing that comes to mind is to look at the archive property, take a date from there and delete the oldest ones.  But he will compare this date with the FreeNas system date.  Ie, if the time on the file server is suddenly lost, we can lose all the archives, so this option is not suitable. <br><br>  Another option is to take the name of the archive and compare the largest numbers from the names ... and keep, say, the 3 largest numbers, that is, leave the 3 most recent archives.  This option suits us.  I implemented this solution as follows. <br><br> <code>#search_to_bd <br> filename=/mnt/data/backup/Hartmann_backup/bd.txt <br> filename2=/mnt/data/backup/Hartmann_backup/sort.txt <br> echo "" &gt; $filename2 <br> ls /mnt/data/backup/Hartmann_backup/ | grep .gz &gt; $filename <br> declare -a array1 <br> array1=( `cat "$filename" | tr '\n' ' '`) <br> #search_to_bd/ <br> <br> kolel=${#array1[*]} <br> var0=1 <br> <br> #Cut_name_to_bd <br> while [ "$var0" -lt "$kolel" ] <br> do <br> eval var$var0= echo ${array1[$var0]:9:8} &gt;&gt; $filename2 <br> var=array1[$var0] <br> var0=`expr $var0 + 1` <br> done <br> #Cut_name_to_bd/ from_var0_to_kolel <br> <br> #Take_sort_from_bd <br> ARRAY=( `cat "$filename2" | tr '\n' ' '`) <br> #Take_sort_from_bd/ <br> <br> #Comperison <br> maxi=0 <br> for ((i=0; i &lt; "${#ARRAY[@]}"; i++));do [ "0${ARRAY[i]}" -gt "0${ARRAY[maxi]}" ] &amp;&amp; maxi=$i; done <br> maxi1=${ARRAY[maxi]} <br> <br> ARRAY[maxi]= <br> maxi=0 <br> for ((i=0; i &lt; "${#ARRAY[@]}"; i++));do [ "0${ARRAY[i]}" -gt "0${ARRAY[maxi]}" ] &amp;&amp; maxi=$i; done <br> maxi2=${ARRAY[maxi]} <br> <br> ARRAY[maxi]= <br> maxi=0 <br> for ((i=0; i &lt; "${#ARRAY[@]}"; i++));do [ "0${ARRAY[i]}" -gt "0${ARRAY[maxi]}" ] &amp;&amp; maxi=$i; done <br> maxi3=${ARRAY[maxi]} <br> #Comperison/ <br> #shopt -s extglob <br> #rm !(@("backup/Hartmann_backup/Hartmann-$maxi1.tar.gz"|"backup/Hartmann_backup/Hartmann-#$maxi2.tar.gz"|"backup/Hartmann_backup/Hartmann-$maxi3.tar.gz")) <br> cd /mnt/data/backup/Hartmann_backup <br> ls -1 | egrep -v "(Hartmann-$maxi1.tar.gz|Hartmann-$maxi2.tar.gz|Hartmann-$maxi3.tar.gz)" | xargs rm</code> <br> <br>  <b>In 2 words,</b> I create 2 files, something DB, where I bring the entire contents of the folder.  Further I throw everything in an array.  Further, in order to compare the numbers, I need to remove the letter from the name, well, and there I already sranivaet the numbers and delete the old ones.  Waiting for objective criticism! </div><p>Source: <a href="https://habr.com/ru/post/126496/">https://habr.com/ru/post/126496/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../126488/index.html">Script convenient work with WebDAV in Ubuntu</a></li>
<li><a href="../126489/index.html">Competition for children habravchan</a></li>
<li><a href="../126492/index.html">In Yandex.Money, new limits and special commission</a></li>
<li><a href="../126493/index.html">Personal computers: in the prime of life!</a></li>
<li><a href="../126495/index.html">Threads in C # .NET first steps</a></li>
<li><a href="../126497/index.html">Neural network data compression</a></li>
<li><a href="../126498/index.html">Another project that gave way to MSTU. Bauman</a></li>
<li><a href="../126499/index.html">User rights in information systems through the lens of CMS Bitrix</a></li>
<li><a href="../126500/index.html">A group of 27,612 South Koreans sued Apple</a></li>
<li><a href="../126501/index.html">C ++: Leash Pattern</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>