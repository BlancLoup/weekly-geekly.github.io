<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Puzzle "Test My Patience" by Check Point Security Academy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I mentioned the program ‚ÄúCheck Point Security Academy‚Äù several times on Habr√©: its essence is that the Check Point firm in the summer announced a cont...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Puzzle "Test My Patience" by Check Point Security Academy</h1><div class="post__text post__text-html js-mediator-article">  I mentioned the program <a href="https://csa.checkpoint.com/index.php%3Fpage%3Dchmain">‚ÄúCheck Point Security Academy‚Äù</a> several times on Habr√©: its essence is that the <a href="https://ru.wikipedia.org/wiki/Check_Point">Check Point</a> firm in the summer announced a contest in the Capture the Flag format, where the participant‚Äôs past experience is not important, but only his ability to disentangle cyber- puzzles.  According to the results of this competition, the company recruited twenty participants for a three-month professional course on cyber security, and all participants from the very beginning of the course receive a full salary of a specialist in KB, under the obligation to work in the company two years after the end of the course. <br><br><img src="https://habrastorage.org/webt/vf/kb/ix/vfkbixclsmvdnirjojnsjcc5q2k.png"><br>  <i>In a CTF competition, the flag may even be a picture, for example.</i> <br><br>  The selection of participants was completed in August, but the competition site will continue to operate until next summer, and I invite those who wish to register and try their hand for the sake of sports interest.  The competition consists of 12 puzzles of varying difficulty, rated from 10 to 150 points. <br>  Here I want to make out the ‚ÄúTest My Patience‚Äù puzzle from the ‚ÄúSurprise‚Äù category.  She is of medium difficulty (50 points), and here is her full text: <br><blockquote>  Hi there <br>  We found <a href="">this to be</a> executable on the local watchmaker's computer. <br>  It is a rumored person. <br>  What is your watchmaker? <br>  <b>This note is not malicious in any way.</b> </blockquote> The link is a 32-bit binary for Windows, which <a href="https://www.virustotal.com/">some antiviruses swear</a> , but if it is launched, it looks like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/iw/x_/_f/iwx__foij5pljrqee4346ldcgqy.png"><br><br>  Inside the binary is encrypted;  it refuses to run under the debugger;  if you try to connect a debugger to it that is running, it ends instantly.  Probably, experts from Check Point wrapped their puzzle in a crypto-packer, borrowed from some Malvari. <br><br>  How can we guess the number, thought of by a watchmaker? <br><a name="habracut"></a><br>  There are two ways.  The first one can conditionally be called ‚Äúthe power is, the mind is not necessary‚Äù: if the program cannot be debugged live, then we will debug the dead! <br><br>  Launch the 32-bit Task Manager (\ Windows \ SysWOW64 \ taskmgr.exe), right-click on the mysterious process, and select Create dump file.  (The 64-bit Task Manager for 32-bit processes creates a wow64cpu emulator dump, which is more difficult to work with.) <br><br>  We look at the dump and see that at least the lines in it are already decoded: <br><br><img src="https://habrastorage.org/webt/ug/fx/u-/ugfxu-y-1tgtxfjbhjb-zx7gmlg.png"><br><br>  But the lines with neither the number nor the flag is not visible yet. <br><br>  Go to the main caliber gun: WinDbg (X86) -&gt; Open Crash Dump ... <br><br><img src="https://habrastorage.org/webt/kz/em/by/kzemby77zuk_wllg194irxj864y.png"><br><br>  Where in memory is the line that we want to see printed - ‚ÄúGood job my friend!‚Äù? <br>  The <code>lm</code> command allows you to determine that the binary is loaded from <code>01140000</code> to <code>015b2000</code> ;  then <code>sa 01140000 015b2000 "Good job my friend!"</code>  finds the required string at <code>0115a0d0</code> : <br><br><img src="https://habrastorage.org/webt/3g/nu/ed/3gnuedahkhiapktjyob3fsxavto.png"><br><br>  Let's now find out where this line is printed: maybe some command contains bytes <code>d0 a0 15 01</code> , corresponding to the address of the desired line?  ( <code>sb 01140000 015b2000 d0 a0 15 01</code> ) <br><br>  Luck!  - such a command was found: <br><br><img src="https://habrastorage.org/webt/rm/5v/ah/rm5vah4nctvyf7bewf8uy-dkzbo.png"><br><br>  What is the code around this command?  ( <code>ub 011412f7; u 011412f7</code> ) <br><br><img src="https://habrastorage.org/webt/xx/oc/kx/xxockxynmnfarqsjejxdghowqk8.png"><br><br>  We see that, depending on the result of the function <code>01141180</code> either the message being <code>01141180</code> or ‚ÄúWrong one ...‚Äù is printed. <br><br>  Function code <code>01141180</code> takes up three screens;  it's pretty easy to understand that this is the implementation of <code>strcmp()</code> , inside of which the <code>Sleep(700)</code> call is added.  It is not yet clear why there is <code>Sleep()</code> ;  but it still does not affect the result of the function, so we better understand what the lines are compared: <br><br><img src="https://habrastorage.org/webt/kz/ie/l3/kziel3yw1_p5f74wyjngg-aam2k.png"><br><br>  Two pointers are <code>ebp-14h</code> , equal to <code>ebp-14h</code> and <code>ebp-24h</code> ;  The second of them was passed to the function <code>011410b0</code> . <br>  Is this the function that requests the hidden number?  Check by call stack ( <code>k</code> ): <br><br><img src="https://habrastorage.org/webt/8t/ov/tl/8tovtlh8uebmq10eb5hwfbaa_nq.png"><br><br>  Yes, it is she! <br><br>  The general scheme of the puzzle is now clear: the user's guess is saved at <code>ebp-24h</code> , the hidden number is at <code>ebp-14h</code> , then they are compared, and either "Good job my friend!" Or "Wrong one ..." is printed <br><br>  All that remains is to pull the hidden number out of the stack frame.  We already know his <code>ebp</code> from the call stack: <br><br><img src="https://habrastorage.org/webt/p1/eq/qo/p1eqqone8e7i_kszzwojdlq8goa.png"><br><br>  Well, well ... <br><br><img src="https://habrastorage.org/webt/zn/zo/yk/znzoyk99atyzq37hewnooffjvsu.png"><br><br>  Success!  You can uncork something tasty. <br><br>  But three mysterious things were left without explanation: <ol><li>  Why inside the local <code>strcmp()</code> call the <code>Sleep(700)</code> call? </li><li>  Why, when we entered the hidden number, did the program hang for a dozen seconds before typing ‚ÄúGood job my friend!‚Äù? </li><li>  What does the watchmaker have to do with this whole puzzle? </li></ol><br>  So, it turns out that there is a second - more intellectual - way of guessing the conceived number.  If you just try randomly the numbers 0-9, then it is easy to see that on the nine, the program slightly freezes.  If you try the numbers 90-99, then you will notice that at the number 98 the program ‚Äúfreezes‚Äù twice as long.  (By picking up her offal, we already understand what's the matter: a successful comparison of each pair of characters causes a delay of 0.7s.) To solve the puzzle, even without launching the debugger, it was enough to select each next digit so that the delay before the response increased - either manually with an accurate stopwatch or simple script.  Thus, the compilers hinted at the <a href="https://habr.com/post/338072/">old way of attacking cryptographic algorithms</a> when the time to an error message is measured and analyzed. <br><br>  But learning how to unzip programs wrapped in unknown crypto-packers is, in my opinion, both more interesting and more valuable :-) <br><br>  Notice that we didn‚Äôt have to figure out how the binary is encrypted, nor how a line appears with a hidden number in the stack (we saw in the dump that it‚Äôs not among the string constants) - we managed to get both About a dozen WinDbg commands were enough. </div><p>Source: <a href="https://habr.com/ru/post/430210/">https://habr.com/ru/post/430210/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../430200/index.html">Nvidia stock price fell amid a collapse of the cryptocurrency market and declining interest in mining</a></li>
<li><a href="../430202/index.html">Writing a system of pairwise interacting particles in C ++ using DirectX 11</a></li>
<li><a href="../430204/index.html">MIT course "Computer Systems Security". Lecture 18: "Private Internet Browsing", part 1</a></li>
<li><a href="../430206/index.html">MIT course "Computer Systems Security". Lecture 18: "Private Internet Browsing", part 2</a></li>
<li><a href="../430208/index.html">MIT course "Computer Systems Security". Lecture 18: "Private Internet Browsing", part 3</a></li>
<li><a href="../430212/index.html">OpenSceneGraph: Scene Geometry Basics</a></li>
<li><a href="../430216/index.html">As I understood that I eat a lot of sweets, or the classification of goods by checks in the application</a></li>
<li><a href="../430218/index.html">Energy Optimization STM32: A Practical Guide</a></li>
<li><a href="../430220/index.html">How to turn a "hundred" usb hub into a "smart" managed and save at the same time $ 300</a></li>
<li><a href="../430222/index.html">Senior Engineer in search of work. How I passed 20 interviews with HR and what I think about it</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>