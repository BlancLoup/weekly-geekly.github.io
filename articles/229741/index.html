<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Improving performance: boxing in .NET that can be avoided</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We are developing a C # server in our project. This server must withstand very high loads, for this reason we try to write the code as best as possibl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Improving performance: boxing in .NET that can be avoided</h1><div class="post__text post__text-html js-mediator-article">  We are developing a C # server in our project.  This server must withstand very high loads, for this reason we try to write the code as best as possible.  C # is rarely associated with high performance, but if you are wise to develop, you can achieve a very good level. <br><br>  One of the expensive processes in terms of performance is boxing and unboxing.  A reminder of what it is, can be found <a href="http://msdn.microsoft.com/en-us/library/yz2be5wk.aspx">here</a> .  Recently, I decided to look at the whole IL code of our projects and look for instructions for box and unbox.  There were many plots in which boxing can be avoided with a flick of the wrist.  All cases leading to unnecessary boxing are obvious, and are allowed by inattention at the moment of concentration on functionality, and not on optimization.  I decided to write out the most common cases, so as not to forget about them, and then to automate their correction.  This article lists these cases. <br><a name="habracut"></a><br>  Immediately I will make a remark: most often, the performance problems are at a higher level, and before you edit all the extra boxing, you need to bring the code to a state where it will make sense.  It makes sense to think seriously about things like boxing if you really want to get the most out of C #. <br><br>  May the Russian language forgive me, but later in the article I will use the word ‚Äúboxing‚Äù, unexpected for him, so that the eye does not cling once again in an attempt to find a line of code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's get started <br><br><h5>  1. Passing the value type variables to String.Format, String.Concat, etc. </h5><br>  The first place in the number of boxing hold string operations.  Fortunately, in our code, this was mainly in the formatting of the message for exceptions.  The main rule to avoid boxing is to call ToString () on the value type of a variable before using it in the String.Format methods or when adding strings. <br><br>  The same, but in the code.  Instead: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id = Guid.NewGuid(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> str1 = String.Format(<span class="hljs-string"><span class="hljs-string">"Id {0}"</span></span>, id); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> str2 = <span class="hljs-string"><span class="hljs-string">"Id "</span></span> + id;</code> </pre> <br><br><pre> <code class="cs hljs">IL_0000: call valuetype [mscorlib]System.Guid [mscorlib]System.Guid::NewGuid() IL_0005: stloc<span class="hljs-number"><span class="hljs-number">.0</span></span> IL_0006: ldstr <span class="hljs-string"><span class="hljs-string">"Id {0}"</span></span> IL_000b: ldloc<span class="hljs-number"><span class="hljs-number">.0</span></span> IL_000c: box [mscorlib]System.Guid IL_0011: call <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> [mscorlib]System.String::Format(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>) IL_0016: pop IL_0017: ldstr <span class="hljs-string"><span class="hljs-string">"Id "</span></span> IL_001c: ldloc<span class="hljs-number"><span class="hljs-number">.0</span></span> IL_001d: box [mscorlib]System.Guid IL_0022: call <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> [mscorlib]System.String::Concat(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>)</code> </pre><br><br>  Need to write: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id = Guid.NewGuid(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> str1 = String.Format(<span class="hljs-string"><span class="hljs-string">"Id {0}"</span></span>, id.ToString()); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> str2 = <span class="hljs-string"><span class="hljs-string">"Id "</span></span> + id.ToString();</code> </pre><br><br><pre> <code class="cs hljs">IL_0000: call valuetype [mscorlib]System.Guid [mscorlib]System.Guid::NewGuid() IL_0005: stloc<span class="hljs-number"><span class="hljs-number">.0</span></span> IL_0006: ldstr <span class="hljs-string"><span class="hljs-string">"Id {0}"</span></span> IL_000b: ldloca.s id IL_000d: constrained. [mscorlib]System.Guid IL_0013: callvirt instance <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> [mscorlib]System.Object::ToString() IL_0018: call <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> [mscorlib]System.String::Format(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>) IL_001d: pop IL_001e: ldstr <span class="hljs-string"><span class="hljs-string">"Id "</span></span> IL_0023: ldloca.s id IL_0025: constrained. [mscorlib]System.Guid IL_002b: callvirt instance <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> [mscorlib]System.Object::ToString() IL_0030: call <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> [mscorlib]System.String::Concat(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)</code> </pre><br><br>  As we can see, the statement constrained instead of box appears.  <a href="http://msdn.microsoft.com/en-us/library/system.reflection.emit.opcodes.constrained(v%3Dvs.110).aspx">It</a> says <a href="http://msdn.microsoft.com/en-us/library/system.reflection.emit.opcodes.constrained(v%3Dvs.110).aspx">here</a> that the next call to the callvirt will be directly on the variable, provided that <i>thisType</i> is the value type and is the implementation of the method.  If there is no method implementation, then boxing will still happen. <br><br>  The unpleasant point is that almost everyone has Resharper, which suggests that the call to ToString () is superfluous. <br><br>  And about the lines, or rather their addition.  Sometimes I met code like: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> str2 = str1 + <span class="hljs-string"><span class="hljs-string">'\t'</span></span>;</code> </pre> <br><br>  There is a false feeling that <code>char</code> will add up with a string without any problems, but <code>char</code> is a value type, so boxing will also be here.  In this case, it‚Äôs still better to write like this: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> str2 = str1 + <span class="hljs-string"><span class="hljs-string">"\t"</span></span>;</code> </pre> <br><br><h5>  2. Calling methods on generic variables </h5><br>  Second place in the number of boxing keep generic methods.  The fact is that any method call on a generic variable causes boxing, even if the constraint <code>class</code> . <br><br>  Example: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Boolean Equals&lt;T&gt;(T x, T y) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x == y; }</code> </pre><br><br>  Turns into: <br><br><pre> <code class="cs hljs">IL_0000: ldarg<span class="hljs-number"><span class="hljs-number">.0</span></span> IL_0001: box !!T IL_0006: ldarg<span class="hljs-number"><span class="hljs-number">.1</span></span> IL_0007: box !!T IL_000c: ceq</code> </pre><br><br>  In fact, not everything is so bad here, since this IL code will be optimized by JIT, but the case is interesting. <br><br>  A positive point is that the already constrained instruction is used to call methods on generic variables, and this allows calling methods on value types without boxing.  If the method works with both value types and reference types, for example, a comparison to null is better written as: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T).IsValueType &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-comment"><span class="hljs-comment">// Do something</span></span></code> </pre><br><br>  There is also a problem with the <code>as</code> operator.  It is a typical practice to immediately cast using the <code>as</code> operator instead of checking for the type and cast to it.  But if you can have a value type, then it is better to check for the type first and then to bring it, because the as operator works only with reference types, and boxing will occur first, and then the <code>isinst</code> call will <code>isinst</code> . <br><br><h5>  3. Calls to enumeration methods </h5><br>  Enumerations in C # are very sad.  The problem is that any method call to the enumeration causes boxing: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Flags</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> Flags { First = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">0</span></span>, Second = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>, Third = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">2</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Boolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Foo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Flags flags</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> flags.HasFlag(Flags.Second); }</code> </pre><br><br><pre> <code class="cs hljs">IL_0000: ldarg<span class="hljs-number"><span class="hljs-number">.1</span></span> IL_0001: box HabraTests.Flags IL_0006: ldc.i4<span class="hljs-number"><span class="hljs-number">.2</span></span> IL_0007: box HabraTests.Flags IL_000c: call instance <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> [mscorlib]System.Enum::HasFlag(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span> [<span class="hljs-title"><span class="hljs-title">mscorlib</span></span>]<span class="hljs-title"><span class="hljs-title">System</span></span>.<span class="hljs-title"><span class="hljs-title">Enum</span></span>)</code> </pre><br><br>  Moreover, even the GetHashCode () method causes boxing.  Therefore, if you suddenly need a hash code from the enumeration, first make a cast to its underlying type.  And also, if you suddenly use enumeration as a key in a Dictionary, then make your own IEqualityComparer, otherwise every time you call GetHashCode () you will have boxing. <br><br><h5>  4. Enumerations in generic methods </h5><br>  The logical continuation of points 2 and 3 is the desire to see, and how the listing in the generic method will behave.  On the one hand, if there is a method implementation for the value type, then generic methods are able to call interface methods on structures without boxing.  On the other hand, all implementations of methods exist in the base class <code>Enum</code> , and not in our created enums.  Let's write a small test to understand what is going on inside. <br><br><div class="spoiler">  <b class="spoiler_title">Test code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Double intAverageGrow, enumAverageGrow; Int64 intMinGrow, intMaxGrow, enumMinGrow, enumMaxGrow; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result1 = Test&lt;Int32&gt;(() =&gt; GetUlong(<span class="hljs-number"><span class="hljs-number">10</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> intAverageGrow, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> intMinGrow, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> intMaxGrow); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result2 = Test&lt;Flags&gt;(() =&gt; GetUlong(Flags.Second), <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> enumAverageGrow, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> enumMinGrow, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> enumMaxGrow); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Int32 memory change. Avg: {0}, Min: {1}, Max: {2}"</span></span>, intAverageGrow, intMinGrow, intMaxGrow); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Enum memory change. Avg: {0}, Min: {1}, Max: {2}"</span></span>, enumAverageGrow, enumMinGrow, enumMaxGrow); Console.WriteLine(result1 + result2); Console.ReadKey(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> UInt64 GetUlong&lt;T&gt;(T <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span>, IConvertible { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.ToUInt64(CultureInfo.InvariantCulture); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> UInt64 Test&lt;T&gt;(Func&lt;UInt64&gt; testedMethod, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> Double averageGrow, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> Int64 minGrow, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> Int64 maxGrow) { GCSettings.LatencyMode = GCLatencyMode.SustainedLowLatency; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> previousTotalMemory = GC.GetTotalMemory(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); Int64 growSum = <span class="hljs-number"><span class="hljs-number">0</span></span>; minGrow = <span class="hljs-number"><span class="hljs-number">0</span></span>; maxGrow = <span class="hljs-number"><span class="hljs-number">0</span></span>; UInt64 sum = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">100000</span></span>; i++) { sum += testedMethod(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currentTotalMemory = GC.GetTotalMemory(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> grow = currentTotalMemory - previousTotalMemory; growSum += grow; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (minGrow &gt; grow) minGrow = grow; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (maxGrow &lt; grow) maxGrow = grow; previousTotalMemory = currentTotalMemory; } averageGrow = growSum / <span class="hljs-number"><span class="hljs-number">100000.0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum; }</code> </pre><br></div></div><br><br>  Result: <br><br><pre> <code class="bash hljs">Int32 memory change. Avg: 0, Min: 0, Max: 0 Enum memory change. Avg: 3,16756, Min: -2079476, Max: 8192</code> </pre><br><br>  As we can see, with enumerations and everything is not thanks to God: boxing happens every time the ToUInt64 () method is called.  But on the other hand, it is clearly seen that calling Int32 in the interface method does not cause any boxing. <br><br>  And at the end, and partly as a conclusion, I would like to add that value types are great to help raise productivity, but you need to carefully monitor how they are used, otherwise as a result of boxing their main advantage will be leveled. <br>  In the next article I would like to talk about places where global synchronization points are not obvious, and how to get around them.  Stay tuned. </div><p>Source: <a href="https://habr.com/ru/post/229741/">https://habr.com/ru/post/229741/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../229727/index.html">New Windows Phone 8.1. What should an application developer do?</a></li>
<li><a href="../229729/index.html">Epson Print Factory - A4 and A3 + Photo Prints</a></li>
<li><a href="../229731/index.html">Using Percona XtraBackup in daily life</a></li>
<li><a href="../229733/index.html">14 mpps SYN floods or 14 V load fork</a></li>
<li><a href="../229735/index.html">Private space truck "Cygnus" successfully launched to the ISS</a></li>
<li><a href="../229743/index.html">Node.js + jQuery Ajax. Upload files to server</a></li>
<li><a href="../229747/index.html">A simple way to connect an arbitrary video source in Qml</a></li>
<li><a href="../229749/index.html">Raspberry Developers Release Raspberry Pi Model B +</a></li>
<li><a href="../229755/index.html">Meet Avaya ERS 4000</a></li>
<li><a href="../229757/index.html">Search and analysis of the optimal color space for the construction of eye-catching objects on a given class of images</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>