<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ELK + R as log repository</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the company of the customer there is a need for a certain log repository with the possibility of horizontal scaling. Starting from the beginning of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ELK + R as log repository</h1><div class="post__text post__text-html js-mediator-article">  In the company of the customer there is a need for a certain log repository with the possibility of horizontal scaling.  Starting from the beginning of the task, the first thought is Splunk.  Unfortunately, the cost of this decision went far beyond the budget of the customer. <br><br>  As a result, the choice fell on a bunch of Logstash + Elasticsearch + Kibana. <br><a name="habracut"></a><br>  Inspired by the article on Habr√© <a href="http://habrahabr.ru/company/maxifier/blog/216201/">‚ÄúCollect and analyze logs using Lumberjack + Logstash + Elasticsearch + RabbitMQ‚Äù</a> and having armed with a small ‚Äúcloud‚Äù on DevStack, the experiments began. <br><br>  The first thing you liked was RabbitMQ as an intermediate link, so as not to lose the logs.  But, unfortunately, logstash-forwarder was not very convenient in collecting logs from Windows, and since most of the clients will be on WinServer, this turned out to be critical.  Searches led to the nxlog community edition.  It was not difficult to find a bundle with logstash (tcp + json was used tritely). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And the tests began.  All experiments were conducted on the configuration: <br><br>  Name / Cores / RAM / HDD <br>  <i>HAProxy: 1Core / 512MB / 4Gb</i> <i><br></i>  <i>LIstener: 2Core / 512MB / 4G</i> <i><br></i>  <i>RABBIT: 2Core / 2Gb / 10G</i> <i><br></i>  <i>Filter: 2Core / 2G / 4G</i> <i><br></i>  <i>ES_MASTER: 2Core / 2G / 4G</i> <i><br></i>  <i>ES_DATA: 2Core / 2G / 40G</i> <i><br></i>  <i>ES_BALANSER: 2Core / 2G / 4G</i> <i><br></i>  <i>KIBANA: 2Core / 2G / 4G</i> <br><br>  System: <i>Ubuntu Server 14.04 LTS</i> (image <a href="https://cloud-images.ubuntu.com/trusty/current/">here</a> ). <br><br><h2>  First approach </h2><br>  <i>Bunch</i> : <i>nxlog =&gt; haproxy =&gt; logstash (listener) =&gt; rabbimq =&gt; logstash (filter) =&gt; elasticsearch</i> <br>  listeners and filters on 2 instances <br>  elasticsearch - a cluster of 2 "equal" instances <br><br>  Benefits: <br><ul><li>  Easy to install on the customer side. </li></ul><br>  Disadvantages: <br><ul><li>  The bottleneck is rabbitmq.  After the rabbitmq restart, I had to restart the listeners, because, for some unknown reason, they did not want to reconnect on their own.  And the fall of the "rabbit" has not been canceled; </li><li>  Elasticsearch with a very large attempt to digest queries, after filling the index&gt; 100mb; </li><li>  It is inconvenient to add new instances to the ES cluster: we had to manually add to the filter a list of available servers. </li></ul><br><br>  Errors were taken into account + there was a new requirement: the system should be on CentOS. <br><br><h2>  Second approach </h2><br>  Bundle: <i>nxlog =&gt; haproxy =&gt; logstash (listener) =&gt; haproxy (2) =&gt; rabbimq =&gt; haproxy (3) =&gt; logstash (filter) =&gt; elasticsearch-http =&gt; elasticsearch-data + master</i> <br>  haproxy (2) and haproxy (3) are the same machine. <br>  Under ES 5 machines - ES-http, 2xES-data and 2xES-master. <br><br>  Benefits: <br><ul><li>  Horizontal growth to infinity; </li><li>  Fault tolerance; </li><li>  You can implement the exchange between the listener and filter on rabbitmq ram nodes (+10 performance). </li></ul><br>  Disadvantages: <br><ul><li>  Massive decision; </li><li>  Difficulties in installation at the client; </li></ul><br><br>  As a result, we got something like this: <br><br><div class="spoiler">  <b class="spoiler_title">Scheme</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/408/5be/609/4085be6098f14bd1a0109939d3b62b8d.jpg"><br></div></div><br>  The system quietly "digests" 17,488,154 log messages per day.  Message size - up to 2kb. <br><br>  One of the advantages of ES is the fact that the size of the message base is greatly reduced when the fields are of the same type: with a stream of 17 million messages and an average message size of 1kb, the size of the database was slightly more than 2GB.  Almost 10 times less than it should be. <br><br>  With this configuration of the equipment, up to 800 messages / sec without delays are free.  With more messages, the queue grows, but for peak loads it is not so critical. <br><br>  TODO: <br><ul><li>  After restarting all RabbitMQ instances one by one, the logstash listener started hysterically and unsuccessfully trying to reconnect to the Rabbit.  Restarting listeners is required.  The search for causes continues; </li><li>  Squeeze Elasticsearch for more performance. </li></ul><br><br>  The problem with the installation is solved by means of Chef-server. <br>  Everything fit (and there is still room) on the i5-4570 4x3.2GHz + 24Gb RAM + 2x500Gb HDD test bench. <br><br>  If it is interesting and relevant, I can write a detailed manual, what and how to install. </div><p>Source: <a href="https://habr.com/ru/post/260869/">https://habr.com/ru/post/260869/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../260859/index.html">Hola prizes: consolatory and not only</a></li>
<li><a href="../260861/index.html">Dirty reverse engineering solutions</a></li>
<li><a href="../260863/index.html">SED: path from easy to hard</a></li>
<li><a href="../260865/index.html">Choosing a text editor or "I want everything in one"</a></li>
<li><a href="../260867/index.html">My acquaintance with ASP.NET MVC in Visual Studio 2015 on the example of building a prototype MIS</a></li>
<li><a href="../260873/index.html">How to learn on ABAPer?</a></li>
<li><a href="../260875/index.html">Exceptionally simple tasks using AppSec .NET</a></li>
<li><a href="../260877/index.html">Wirmaker Abbreviations: WIM, CSRSS, EMET, CCMP, EFS, SEHOP, ASLR, KPP, UAC, DEP and one more thing</a></li>
<li><a href="../260879/index.html">Malware for OS X: the complete chronicle. The most iconic apple pests of this decade</a></li>
<li><a href="../260881/index.html">First-aid kit sysadmin. Minimal set of utilities for the most effective problem solving</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>