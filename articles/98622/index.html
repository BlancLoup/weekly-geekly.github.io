<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Oh, these query plans</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The story is as old as the world. Two tables: 


- Cities - 100 unique cities. 
- People - 10 million people. For some people, the city may not be spe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Oh, these query plans</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/habraeffect/60/0a/600a6fd71dace410943f5772282eebef.png" align="left"><br><br>  The story is as old as the world.  Two tables: <br><ul><li>  Cities - 100 unique cities. </li><li>  People - 10 million people.  For some people, the city may not be specified. </li></ul><br>  The distribution of people in cities is even. <br>  Indices on the fields Cites.Id, Cites.Name, People .CityId - in stock. <br><br>  You need to select the first 100 People records sorted by Cites. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  Rolling up our sleeves, we cheerfully write: <br><br> <code>select top 100 p.Name, c.Name as City from People p <br> left join Cities c on c.Id=p.CityId <br> order by c.Name <br></code> <br><br>  In this case, we get something like: <br><br><img src="https://habrastorage.org/storage/habraeffect/ec/9f/ec9f3bb8a9d204471827ce6447230db9.png"><br><br>  For ... 6 seconds.  (MS SQL 2008 R2, i5 / 4Gb) <br><br>  But how so!  6 seconds from where ?!  We know that in the first 100 records there will be only Almaty!  After all, there are 10 million records, and this means that the city accounts for 100 thousand each. Even if this is not the case, we can select the first city in the list and check whether it has at least 100 inhabitants. <br><br>  Why the SQL server, having statistics, does not do so: <br><br> <code>select * from People p <br> left join Cities c on c.Id=p.CityId <br> where p.CityId <br> in (select top 1 id from Cities order by Name) <br> order by c.[Name] <br></code> <br>  This query returns approximately 100k records in less than a second!  We made sure that there are 100 required records and gave them very, very quickly. <br><br>  However, MSSQL does everything according to plan.  And he has a plan, "pure thermonuclear" (c). <br><img src="https://habrastorage.org/storage/habraeffect/c3/43/c343ef540eaa2b531280cc35a5119a62.png"><br><br>  <b>Question to experts:</b> <b><br></b>  <b>How do I need to correct the SQL query or do some actions on the server in order to get the result 10 times faster on the first query?</b> <br><br>  PS <br> <code>CREATE TABLE [dbo].[People] ( <br> [Id] uniqueidentifier NOT NULL, <br> [Name] nvarchar(50) NOT NULL, <br> [CityId] uniqueidentifier <br> ) <br> ON [PRIMARY] <br> GO <br> <br> CREATE TABLE [dbo].[Cities] ( <br> [Id] uniqueidentifier NOT NULL, <br> [Name] nvarchar(50) NOT NULL, <br> ) <br> ON [PRIMARY] <br> GO <br></code> <br><br>  Pps <br>  Where the legs grow from: <br>  The task is very real.  There is a table with the main entity, many dimensions depart from it according to the ‚Äústar‚Äù principle.  The user needs to display it in the grid, providing sorting by fields. <br>  Starting from a certain size of the main table, sorting boils down to the fact that a window is selected with the same (extreme) values ‚Äã‚Äã(like "Almaty") but at the same time, the system begins to slow down terribly. <br>  I would like to have ONE parameterized query that will work effectively with both the small size of the People table and the large one. <br><br>  PPPS <br>  Interestingly, if City would have been NotNull and used by InnerJoin, then the query is executed instantly. <br>  Interestingly, EVEN IF the City field would have been NotNull but LeftJoin was used - that query slows down. <br><br>  In the comments idea: First select all InnerJoin and then Union by Null values.  Tomorrow I will check this and other crazy ideas) <br><br>  PPPPS tried.  It worked! <br><br>  WITH Help AS <br>  ( <br>  select top 100 p.Name, c.Name as City from People p <br>  INNER join Cities c on c.Id = p.CityId <br>  order by c.Name ASC <br>  UNION <br>  select top 100 p.Name, NULL as City from People p <br>  WHERE p.CityId IS NULL <br>  ) <br>  SELECT TOP 100 * FROM help <br><br>  Gives 150 milliseconds under the same conditions!  Thank you <a href="http://holem.habrahabr.ru/">holem</a> . </div><p>Source: <a href="https://habr.com/ru/post/98622/">https://habr.com/ru/post/98622/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../98614/index.html">5 social media trends, where are we going right now?</a></li>
<li><a href="../98615/index.html">World Cup, porn and twitter</a></li>
<li><a href="../98616/index.html">We build Qt applications for Symbian from under linux</a></li>
<li><a href="../98619/index.html">Tim Bray, "Promising Your Android Application"</a></li>
<li><a href="../98620/index.html">Canonical will introduce a new font</a></li>
<li><a href="../98624/index.html">Free Plush Icons Set</a></li>
<li><a href="../98626/index.html">How important is a simple and fast return to the online store</a></li>
<li><a href="../98627/index.html">Brief instructions for setting up Vlans</a></li>
<li><a href="../98629/index.html">Robotic cosmonaut Robonaut 2 passed the final tests before being sent to space</a></li>
<li><a href="../98633/index.html">Testing a wifi link based on Ubiquiti NanoStation M2 equipment</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>