<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Nginx configuration</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The theme of the correct setup of nginx is very large, and, I am afraid, it doesn‚Äôt fit into the framework of a single article on the habr. In this te...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Nginx configuration</h1><div class="post__text post__text-html js-mediator-article"> The theme of the correct setup of nginx is very large, and, I am afraid, it doesn‚Äôt fit into the framework of a single article on the habr.  In this text I tried to tell about the general structure of the config, more interesting little things and particulars, maybe, will come later.  :) <br><br>  A good starting point for configuring nginx is the config that comes with the distribution, but many of the features of this server are not even mentioned in it.  A significantly more detailed example is on Igor Sysoev‚Äôs website: <a href="http://sysoev.ru/nginx/docs/example.html">sysoev.ru/nginx/docs/example.html</a> .  However, let's better try to build from scratch your config, with a bridge and poetess.  :) <br><a name="habracut"></a><br>  Let's start with the general settings.  First, we will indicate the user on whose behalf nginx will work (from the root it‚Äôs not working well, everyone knows :)) <br><br> <code>user nobody; <br></code> <br>  Now let's say nginx, how many workflows to spawn.  Usually, a good choice is the number of processes equal to the number of processor cores in your server, but it makes sense to experiment with this setting.  If a high load on a hard disk is expected, you can do it by a process on each physical hard disk, since all the work will be anyway limited by its performance. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code>worker_processes 2; <br></code> <br>  Specify where to write error logs.  Then, for individual virtual servers, this parameter can be redefined, so that only global errors, for example, related to server start, will be added to this log. <br><br> <code>error_log /spool/logs/nginx/nginx.error_log notice; #   "notice", ,   <br></code> <br>  Now comes a very interesting section "events".  In it, you can specify the maximum number of connections that will be simultaneously processed by a single worker process and the method that will be used to receive asynchronous notifications about events in the OS.  Of course, you can choose only those methods that are available on your OS and were included during compilation. <br><br>  These settings can have a significant impact on the performance of your server.  They must be selected individually, depending on the OS and iron.  I can give only a few general rules. <br><br>  Event Modules: <br>  - select and poll are usually slower and rather heavily load the processor, but are available almost everywhere, and work almost always; <br>  - kqueue and epoll are more efficient, but are only available on FreeBSD and Linux 2.6, respectively; <br>  - rtsig is a fairly efficient method, and is supported even by very old linux, but can cause problems with a large number of connections; <br>  - / dev / poll - as far as I know, it works in several more exotic systems, such as a Solaris, and is quite effective in it; <br><br>  Worker_connections parameter: <br>  - The total maximum number of clients served will be worker_processes * worker_connections; <br>  - Sometimes even the most extreme values, like 128 processes, 128 connections per process, or 1 process, can work in a positive direction, but with the parameter worker_connections = 16384.  In the latter case, however, most likely you will need to tune the OS. <br><br> <code>events { <br> worker_connections 2048; <br> use kqueue; #   BSD :) <br> } <br></code> <br>  The next section is the largest, and contains the most interesting.  This is a description of virtual servers, and some parameters common to them all.  I will omit the standard settings that are in each config, such as paths to logs. <br><br> <code>http { <br> #        %) <br> # ... <br> } <br></code> <br>  Inside this section there can be some pretty interesting parameters. <br><br>  The sendfile system call appeared in Linux relatively recently.  It allows you to send data to the network, bypassing the stage of copying them into the address space of the application.  In many cases, this significantly improves server performance, so the sendfile parameter is always better to include. <br><br> <code>sendfile on; <br></code> <br>  The keepalive_timeout parameter is responsible for the maximum time for keeping a keepalive connection, in case the user requests nothing from it.  Consider exactly how requests are sent to your site, and correct this parameter.  For sites that actively use AJAX, it is better to keep the connection longer, for static pages that users will read for a long time, it is better to break the connection early.  Note that by supporting an inactive keepalive connection, you are occupying a connection that might have been used differently.  :) <br><br> <code>keepalive_timeout 15; <br></code> <br>  Separately, it is worth highlighting the nginx proxy settings.  Most often, nginx is used exactly as a server-proxy, respectively, they are quite important.  In particular, it makes sense to set the buffer size for proxied requests to be no less than the expected response size from the backend server.  With slow (or, conversely, very fast) backends, it makes sense to change the timeouts for waiting for a response from the backend.  Remember, the longer these timeouts are, the longer your user will have to wait for the response when the backend brakes. <br><br> <code>proxy_buffers 8 64k; <br> proxy_intercept_errors on; <br> proxy_connect_timeout 1s; <br> proxy_read_timeout 3s; <br> proxy_send_timeout 3s; <br></code> <br>  A little trick.  In case nginx serves more than one virtual host, it makes sense to create a ‚Äúvirtual host by default‚Äù, which will process requests in cases where the server cannot find another alternative to the Host header in the client's request. <br><br> <code># default virtual host <br> server { <br> listen 80 default; <br> server_name localhost; <br> deny all; <br> } <br></code> <br>  Further one (or several) sections of "server" can follow.  Each of them describes a virtual host (most often, name-based).  For owners of multiple sites on the same hosting, or for hosts, there may be something like a directive <br><br> <code>include /spool/users/nginx/*.conf; <br></code> <br>  The rest are likely to describe their virtual host directly in the main config. <br><br> <code>server { <br> listen 80; <br> <br> #  ,   server_name     . <br> server_name myserver.ru myserver.com; <br> access_log /spool/logs/nginx/myserver.access_log timed; <br> error_log /spool/logs/nginx/myserver.error_log warn; <br> # ... <br></code> <br>  Set the encoding for the default return. <br><br> <code>charset utf-8; <br></code> <br>  And we say that we do not want to receive requests from clients with a length of more than 1 megabyte. <br><br> <code>client_max_body_size 1m; <br></code> <br>  Enable SSI for the server and ask for SSI variables to reserve no more than 1 kilobyte. <br><br> <code>ssi on; <br> ssi_value_length 1024; <br></code> <br>  And finally, we will describe two locations, one of which will lead to the backend, to an Apache running on port 9999, and the second to give static pictures from the local file system.  For two locales, this is not very meaningful, but for a larger number of them, it makes sense to also immediately determine the variable in which the server root directory will be stored, and then use it in location descriptions. <br><br> <code><a href="http://127.0.0.1/"></a> set $www_root "/data/myserver/root"; <br> <br> location / { <br> proxy_pass 127.0.0.1:9999; <br> proxy_set_header X-Real-IP $remote_addr; <br> proxy_intercept_errors off; <br> proxy_read_timeout 5s; #  ,     ,   <br> proxy_send_timeout 3s; <br> # ... <br></code> <br>  A separate block in the root location is dedicated to compressing the result in gzip.  This will allow you and your users to save on traffic.  Nginx can specify which types of files (or, in our case, responses from the backend) should be compressed, and what should be the minimum file size in order to use compression. <br><br> <code># ... <br> gzip on; <br> gzip_min_length 1024; <br> gzip_proxied expired no-cache no-store private auth; <br> gzip_types text/plain application/xml; <br> } <br> <br> location /i/ { <br> root $www_root/static/; <br> } <br> } <br></code> <br>  Thank you all for your attention.  And, sorry, that the post turned out quite long. </div><p>Source: <a href="https://habr.com/ru/post/66764/">https://habr.com/ru/post/66764/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../66751/index.html">Overview of the natural input mechanism in RAD Studio 2010</a></li>
<li><a href="../66753/index.html">Nikita Filippov - 100% agile</a></li>
<li><a href="../66758/index.html">VMware buys SpringSource</a></li>
<li><a href="../66762/index.html">ASP.NET MVC: unit testing routes</a></li>
<li><a href="../66763/index.html">Change the menu: wave client extensions</a></li>
<li><a href="../66766/index.html">Algorithms in Graphs - Part 2: Sorting Networks</a></li>
<li><a href="../66767/index.html">Cataclysm - addition to World of Warcraft</a></li>
<li><a href="../66771/index.html">MacBook Pro owners are haunted</a></li>
<li><a href="../66772/index.html">Retrieving a file from the server with possible error handling</a></li>
<li><a href="../66774/index.html">Web application architecture using XSLT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>