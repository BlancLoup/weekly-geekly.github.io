<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How the frame is rendered A Plague Tale: Innocence</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 As in my other studies, let's start with an introduction. Today we will review the latest game by the French developer Asobo Studio. I firs...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How the frame is rendered A Plague Tale: Innocence</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/qi/73/10/qi7310oonn7yulhrcsdmw_rzfsy.png"></div><br><h2>  Foreword </h2><br>  As in my other studies, let's start with an introduction.  Today we will review the latest game by the French developer Asobo Studio.  I first saw the video of this game last year, when a colleague shared a <a href="https://www.youtube.com/watch%3Fv%3DOfdC_IQjdQQ">16-minute gameplay trailer</a> with me.  My attention was attracted by the ‚Äúrat against the light‚Äù mechanic, but I didn‚Äôt really want to play this game.  However, after its release, many began to say that it looks like it was made on the Unreal engine, but it is not.  I was curious to see how rendering works and how much the developers were generally inspired by Unreal.  I was also interested in the process of rendering a flock of rats, because in the game she looked very convincing and also is one of the key elements of the gameplay. <br><br>  When I started trying to capture the game, I thought that I would have to give up because nothing worked.  Although the game uses DX11, which is now supported by almost all analysis tools, I could not get any of them to work.  When I tried to use RenderDoc, the game crashed on launch, and the same thing happened with the PIX.  I still don‚Äôt know why this is happening, but fortunately, I managed to execute several captures using NSight Graphics.  As usual, I raised all parameters to the maximum and began to look for suitable frames for analysis. <br><a name="habracut"></a><br><h2>  Frame breakdown </h2><br>  Having made a couple of grips, I decided to use one of the very beginning of the game for analyzing the frame.  There is not much difference between the grippers, and besides, I can avoid spoilers. <br><br>  As usual, let's start with the final frame: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e30/9bc/013/e309bc01336450e755af378e9e07ebf9.png"></div><br>  The first thing I noticed was a completely different balance in this game of rendering events compared to what I had seen in other games before.  There are many draw calls, which is normal, but surprisingly only a few of them are used for post-processing.  In other games, after rendering colors, the frame goes through many stages to get the final result, but in A Plague Tale: Innocence, the post-processing stack is very small and optimized to only a few draw / compute events. <br><br>  The game starts building a frame with a GBuffer rendering with six render targets.  Interestingly, these are all render targets have a 32-bit unsigned integer format (with the exception of one) instead of RGBA8 colors or other specific data formats.  This was difficult because I had to decode each channel manually using the NSight Custom Shader function.  I spent a lot of time figuring out which values ‚Äã‚Äãare encoded into 32-bit targets, but it‚Äôs possible that I missed something anyway. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/156/6ce/6fe/1566ce6fe3f539b267b0c3ddc777de78.png"></div><br>  <i>GBuffer 0</i> <br><br>  The first target contains some shading values ‚Äã‚Äãin 24 bits, and some other values ‚Äã‚Äãfor hair in 8 bits. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1b5/0a7/205/1b50a72056766e9cadd8b6a040bb98cd.png"></div><br>  <i>GBuffer 1</i> <br><br>  The second target looks like a traditional RGBA8-target with different material management values ‚Äã‚Äãin each channel.  As far as I understand, the red channel is metalness (it‚Äôs not quite clear why some leaves are marked with it), the green channel looks like the roughness value, and the blue channel is the mask of the main character.  No alpha channel was used in any of my captures. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2cf/a40/72a/2cfa4072a62ca02ef7de7f9e9b5ed259.png"></div><br>  <i>GBuffer 2</i> <br><br>  The third target also looks like RGBA8 with albedo in the RGB channels, and the alpha channel in each capture I made was completely white, so I don‚Äôt quite understand what this data should do. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5f7/c6d/9e2/5f7c6d9e2b37a7ff18ec87c8389ca0a7.png"></div><br>  <i>GBuffer3</i> <br><br>  The fourth target is curious, because on all my captures it is almost completely black.  Values ‚Äã‚Äãlook like a mask of a piece of vegetation and all hair / fur.  Perhaps this is somehow related to translucency. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/18d/91f/69f/18d91f69f594f6898c21805c9cd9164a.png"></div><br>  <i>GBuffer 4</i> <br><br>  The fifth target is probably some kind of normal encoding, because I haven't seen them anywhere else, and the shader seems to be sampling normal maps, and then doing output to this target.  With this in mind, I did not figure out how to properly visualize them. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/09e/8d2/8da/09e8d28dae99dc5af634a67eaa8e2214.png"></div><br>  <i>Depth of GBuffer 5</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cd1/c4b/76c/cd1c4b76c92413c4d6848e2e5ecdcdc8.png"></div><br>  <i>Mask from GBuffer 5</i> <br><br>  The last target is an exception because it uses a 32-bit floating point format.  The reason for this is that it contains the linear depth of the image, and the sign bit encodes some other mask that again masks the hair and part of the vegetation. <br><br>  After the creation of the GBuffer is completed, the resolution of the depth map is reduced in the computational shader, and then shadow maps are rendered (directed cascading shadow maps from the sun and cubic depth maps from point sources of lighting). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/94d/bbb/2dd/94dbbb2dd8220f2494ef81785910ea39.png"></div><br>  <i>Twilight rays</i> <br><br>  After completing the shadow maps, you can calculate the light, but first, the god rays are rendered in a separate target. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d58/f88/abf/d58f88abfc4aee82a95a9404ff5e4f09.png"></div><br>  <i>SSAO</i> <br><br>  At the stage of computing the lighting, a computational shader is performed to calculate the SSAO. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c37/717/66d/c3771766d0785d131f15633eb2c52010.png"></div><br>  <i>Illuminated opaque geometry</i> <br><br>  Lighting is added from cubic maps and local light sources.  All these different sources of illumination in combination with the above rendered targets as a result form an illuminated HDR image. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1ec/40b/716/1ec40b716cf2715f98d2c4f6a72bb83c.png"></div><br>  <i>Elements rendered proactively rendering</i> <br><br>  Elements that are rendered proactively are added on top of the lighted opaque geometry, but in this scene they are not very noticeable. <br><br>  After the accumulation of all color, we are almost finished, there are only a few post-processing operations and UI. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cdd/73c/ddb/cdd73cddb19f72c7f9e228ee3b65ceef.png"></div><br>  The color resolution decreases in the computational shader and then increases to create a very beautiful and soft bloom effect. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/98b/edb/ed2/98bedbed24528e052b396786b027369d.png"></div><br>  After compositing all previous results, adding camera dirt, color correction and finally tonal correction of the image, we get the colors of the scene.  Overlaying UI gives us an image from the beginning of the article. <br><br>  A couple of interesting things about rendering are worth mentioning: <br><br><ul><li>  Instancing (duplication of geometry) is used only for individual meshes (it seems that only for vegetation).  All other objects are rendered in separate draw calls. </li><li> Objects seem to be roughly sorted from front to back, with some exceptions. </li><li>  It seems that the developers did not make any effort to group the draw calls in terms of material parameters. </li></ul><br><h2>  Rats </h2><br>  As I said at the beginning of the article, one of the reasons why I wanted to explore this game was the way of rendering a pack of rats.  The decision somehow disappointed me: it seems that it was made by brute force.  Here I use screenshots from another game scene, but I hope there are no spoilers in it. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/865/875/0c7/8658750c7c37151679f4ca5c12f196e8.png"></div><br>  As in the case of other objects, there seems to be no duplication of geometry for rats, unless we reach the distance at which we switch to the last level of mesh detail (LOD).  Let's see how it works. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bf5/0bc/b33/bf50bcb334685d1b8e332ec5d386ecca.png"></div><br>  <i>LOD0</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fcf/f8e/9dd/fcff8e9dd94ec9a4537ea781991be2c2.png"></div><br>  <i>LOD1</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/35f/d4b/2f2/35fd4b2f2f4f1a29ea10502b002dc3ce.png"></div><br>  <i>LOD2</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d92/c13/e16/d92c13e16d465a0d900d8cd59d288578.png"></div><br>  <i>LOD3</i> <br><br>  Rats have 4 levels of LOD.  Interestingly, at the third level, the tail is bent to the body, while the fourth tail does not exist at all.  This probably means that the animations are active only for the first two levels.  Unfortunately, NSight Graphics does not seem to have enough tools to check it out. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f54/4d5/62f/f544d562f3b2434ffb6f47e665db27fc.png"></div><br>  <i>Without instancing rats.</i> <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/20c/89a/9c2/20c89a9c25d0c9039ee691b4e1f5500e.png"></div><br>  <i>With duplication.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zw/2f/t1/zw2ft16y68vu84ugwmiblagsfsa.gif"></div><br>  In the scene captured above, the following number of rats are rendered: <br><br><ul><li>  LOD0 - 200 </li><li>  LOD1 - 200 </li><li>  LOD2 - 1258 </li><li>  LOD3 - 3500 (with duplication of geometry) </li></ul><br>  This makes us understand that there is a hard limit on the number of rats that can be rendered on the first two LODs. <br><br>  In the capture I made, I couldn‚Äôt identify any logic that binds rats to individual LODs.  Sometimes rats located closer to the camera are not very detailed, and sometimes barely visible rats have high details. <br><br><h2>  Finally </h2><br>  Plague Tale: Innocence is very interesting in terms of rendering.  His results no doubt impressed me, they serve the gameplay very well.  As with any proprietary engine, it would be great to hear more detailed analysis from the mouths of the developers themselves, especially because I was not able to confirm some of my theories.  I hope my article will ever get to someone from Asobo Studio and they will see that people have an interest in this. </div><p>Source: <a href="https://habr.com/ru/post/456614/">https://habr.com/ru/post/456614/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../456604/index.html">As we automated a large online store and began to match products automatically</a></li>
<li><a href="../456606/index.html">News from the world of OpenStreetMap ‚Ññ 464 (04.06.2019-10.06.2019)</a></li>
<li><a href="../45661/index.html">New search engine Keyboardr does not like mice</a></li>
<li><a href="../456610/index.html">Do not press and do not approve</a></li>
<li><a href="../456612/index.html">One of the hundreds of ways to publish multiple production projects on one server</a></li>
<li><a href="../456616/index.html">3 million rubles for those who know how to code</a></li>
<li><a href="../456618/index.html">Larabeer Moscow - June 21</a></li>
<li><a href="../456622/index.html">How to create an OS certified for I class of protection</a></li>
<li><a href="../456624/index.html">Useful Python Tools</a></li>
<li><a href="../456632/index.html">We are building the fourth floor of C ++ templates in RESTinio. Why and how?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>