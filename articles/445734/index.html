<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Getting Yandex Direct advertising campaigns using the API in DataFrame (Python)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Working at once with several clients, it becomes necessary to quickly analyze a lot of information in different accounts and reports. When customers b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Getting Yandex Direct advertising campaigns using the API in DataFrame (Python)</h1><div class="post__text post__text-html js-mediator-article">  Working at once with several clients, it becomes necessary to quickly analyze a lot of information in different accounts and reports.  When customers become more than 10, the marketer no longer has time to constantly monitor the statistics.  But there is a way out. <br><br>  In this article I will talk about how to monitor advertising accounts using API and Python. <br><br>  At the output, we will receive a request to the Yandex Direct API, with which we will receive statistics on advertising campaigns and will be able to process this data. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For this we need: <br><br><ol><li>  Get the Yandex Direct API token </li><li>  Write a request to the server </li><li>  Import Data to DataFrame </li></ol><a name="habracut"></a><br><h4>  Import Libraries </h4><br>  You need to import the libraries that are used in the query, as well as the ‚Äúpandas‚Äù and ‚ÄúDataFrame‚Äù. <br><br>  All imports will look like this: <br><br><pre><code class="plaintext hljs">import requests from requests.exceptions import ConnectionError from time import sleep import json import pandas as pd import numpy as np from pandas import Series,DataFrame</code> </pre> <br><h4>  Getting a token </h4><br>  This time I can‚Äôt tell better about the Direct API API documentation, so I‚Äôll leave a link. <br><br>  ( <a href="https://tech.yandex.ru/direct/doc/dg-v4/concepts/auth-token-docpage/">Instructions for obtaining a token</a> ) <br><br><h4>  We write a request to the server API Yandex Direct </h4><br>  <a href="https://tech.yandex.ru/direct/doc/examples-v5/python3_requests_stat1-docpage/">We copy request from the API documentation</a> <br><br>  <b>Change the query.</b> <br><br><ul><li>  Register your token and login </li></ul><br>  Token. <br><br>  token = 'blaBlaBLAblaBLABLABLAblabla' <br><br>  Login. <br><br>  clientLogin = 'e-66666666' <br><br><ul><li>  Adjust the body of the request for themselves. </li></ul><br>  From this <br><br><pre> <code class="plaintext hljs">body = { "params": { "SelectionCriteria": { "DateFrom": "_", "DateTo": "_" }, "FieldNames": [ "Date", "CampaignName", "LocationOfPresenceName", "Impressions", "Clicks", "Cost" ], "ReportName": u("_"), "ReportType": "CAMPAIGN_PERFORMANCE_REPORT", "DateRangeType": "CUSTOM_DATE", "Format": "TSV", "IncludeVAT": "NO", "IncludeDiscount": "NO"</code> </pre> <br>  Do it <br><br><pre> <code class="plaintext hljs"> body = { "params": { "SelectionCriteria": { "Filter": [ { "Field": "Clicks", "Operator": "GREATER_THAN", "Values": [ "0" ] }, ] }, "FieldNames": [ "CampaignName", "Impressions", "Clicks", "Ctr", "Cost", "AvgCpc", "BounceRate", "AvgPageviews", "ConversionRate", "CostPerConversion", "Conversions" ], "ReportName": u("Report4"), "ReportType": ¬´ ", "DateRangeType": "LAST_5_DAYS", "Format": "TSV", "IncludeVAT": "NO", "IncludeDiscount": "NO" } }</code> </pre> <br>  In <b>SelectionCriteria,</b> we write how we will select data.  As a standard, 2 dates are written there, but in order not to constantly change them, we will replace the length of time with ‚ÄúLast 5 days‚Äù. <br><br>  <b>We set the filter for data</b> .  This is primarily required in order not to get empty values.  The problem is that Direct shows the missing data as two minuses, because of which the data type of the entire column changes, after which you will not be able to perform mathematical operations without unnecessary gestures. <br><br>  <b>FieldNames.</b>  Register here the data that you need.  I registered the fields that I use for analysis, your list may differ. <br><br>  <b>ReportType</b> .  This type of report is written in this field, for campaigns you need this particular report. <br><br>  You should have something like this. <br><br><img src="https://imagizer.imageshack.com/img923/6747/G4Hz4e.png" alt="image"><br><br>  5. Import the data into the DataFrame. <br><br>  (DataFrame is probably the most suitable way to work with this data.) <br><br>  I was able to implement this function by writing and reading the csv file. <br>  We find in the request a piece that is responsible for displaying statistics - this is ‚Äúreq.text‚Äù. <br><br>  Remove the standard output of the program to write to the file.  To do this, change all the conclusions in code 200. <br><br><pre> <code class="plaintext hljs"> print("  ") print("RequestId: {}".format(req.headers.get("RequestId", False))) print(" : \n{}¬ª.format(u(req.text)))</code> </pre> <br>  On: <br><br><pre> <code class="plaintext hljs"> format(u(req.text))</code> </pre> <br>  Now we import the server response into the DataFrame. <br><br><pre> <code class="plaintext hljs"> file = open("cashe.csv", "w") file.write(req.text) file.close() f = DataFrame.from_csv("cashe.csv",header=1, sep=' ', index_col=0,)</code> </pre> <br>  Step by Step: <br><br><ul><li>  Open (and automatically create) the cashe.csv file to write </li><li>  Write the server response to it. </li><li>  Close the file </li><li>  Open the file as a DataFrame (specify the name of the file, which row contains the table headers, which divider between the data, which column the index) </li></ul><br>  It turned out the following: <br><br><img src="https://imagizer.imageshack.com/img923/8646/jQ4uBP.png" alt="image"><br><br>  Remove the restriction on the output columns: <br><br><pre> <code class="plaintext hljs"> pd.set_option('display.max_columns', None) pd.set_option('display.expand_frame_repr', False) pd.set_option('max_colwidth', -1)</code> </pre> <br>  Now everything is shown: <br><br><img src="https://imagizer.imageshack.com/img924/87/fY7apw.png" alt="image"><br><br>  The only problem is that monetary values ‚Äã‚Äãare not shown as desired.  These are features of the implementation of the Yandex Direct API.  We just need to divide the cash values ‚Äã‚Äãby 1,000,000. <br><br><pre> <code class="plaintext hljs">f['Cost'] = f['Cost']/1000000 f['AvgCpc'] = f['AvgCpc']/1000000 f['CostPerConversion'] = f['CostPerConversion']/1000000</code> </pre> <br>  I also propose to immediately sort by the number of clicks. <br><br><pre> <code class="plaintext hljs">f=f.sort_values(by=['Clicks'], ascending=False)</code> </pre> <br>  Here we also have a DataFrame ready for analysis. <br><br><img src="https://imagizer.imageshack.com/img922/3497/fftBUP.png" alt="image"><br><br>  I wrote similar requests for myself to get statistics in the context of days and campaigns in order to always be aware of traffic deviations and to understand where the deviation occurred approximately. <br><br>  Thanks for attention. <br><br><div class="spoiler">  <b class="spoiler_title">End Code:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">import requests from requests.exceptions import ConnectionError from time import sleep import json import pandas as pd import numpy as np from pandas import Series,DataFrame pd.set_option('display.max_columns', None) pd.set_option('display.expand_frame_repr', False) pd.set_option('max_colwidth', -1) #        UTF-8   Python 3,    Python 2 import sys if sys.version_info &lt; (3,): def u(x): try: return x.encode("utf8") except UnicodeDecodeError: return x else: def u(x): if type(x) == type(b''): return x.decode('utf8') else: return x # ---   --- #   Reports   JSON- () ReportsURL = 'https://api.direct.yandex.com/json/v5/reports' # OAuth- ,       token = ' ' #     #  ,        clientLogin = ' ' # ---   --- #  HTTP-  headers = { # OAuth-.   Bearer  "Authorization": "Bearer " + token, #     "Client-Login": clientLogin, #    "Accept-Language": "ru", #    "processingMode": "auto" #      # "returnMoneyInMicros": "false", #            # "skipReportHeader": "true", #         # "skipColumnHeader": "true", #          # "skipReportSummary": "true" } #    body = { "params": { "SelectionCriteria": { "Filter": [ { "Field": "Clicks", "Operator": "GREATER_THAN", "Values": [ "0" ] }, ] }, "FieldNames": [ "CampaignName", "Impressions", "Clicks", "Ctr", "Cost", "AvgCpc", "BounceRate", "AvgPageviews", "ConversionRate", "CostPerConversion", "Conversions" ], "ReportName": u("Report4"), "ReportType": "CAMPAIGN_PERFORMANCE_REPORT", "DateRangeType": "LAST_5_DAYS", "Format": "TSV", "IncludeVAT": "NO", "IncludeDiscount": "NO" } } #     JSON body = json.dumps(body, indent=4) # ---      --- #   HTTP- 200,     #   HTTP- 201  202,    while True: try: req = requests.post(ReportsURL, body, headers=headers) req.encoding = 'utf-8' #      UTF-8 if req.status_code == 400: print("         ") print("RequestId: {}".format(req.headers.get("RequestId", False))) print("JSON- : {}".format(u(body))) print("JSON-  : \n{}".format(u(req.json()))) break elif req.status_code == 200: format(u(req.text)) break elif req.status_code == 201: print("       ") retryIn = int(req.headers.get("retryIn", 60)) print("    {} ".format(retryIn)) print("RequestId: {}".format(req.headers.get("RequestId", False))) sleep(retryIn) elif req.status_code == 202: print("    ") retryIn = int(req.headers.get("retryIn", 60)) print("    {} ".format(retryIn)) print("RequestId: {}".format(req.headers.get("RequestId", False))) sleep(retryIn) elif req.status_code == 500: print("    . ,    ") print("RequestId: {}".format(req.headers.get("RequestId", False))) print("JSON-  : \n{}".format(u(req.json()))) break elif req.status_code == 502: print("     .") print(",     -      .") print("JSON- : {}".format(body)) print("RequestId: {}".format(req.headers.get("RequestId", False))) print("JSON-  : \n{}".format(u(req.json()))) break else: print("  ") print("RequestId: {}".format(req.headers.get("RequestId", False))) print("JSON- : {}".format(body)) print("JSON-  : \n{}".format(u(req.json()))) break #  ,       API  except ConnectionError: #         print("     API") #     break #   -   except: #         print("  ") #     break file = open("cashe.csv", "w") file.write(req.text) file.close() f = DataFrame.from_csv("cashe.csv",header=1, sep=' ', index_col=0,) f['Cost'] = f['Cost']/1000000 f['AvgCpc'] = f['AvgCpc']/1000000 f['CostPerConversion'] = f['CostPerConversion']/1000000 f=f.sort_values(by=['Clicks'], ascending=False) print(f)</code> </pre> <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/445734/">https://habr.com/ru/post/445734/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../445720/index.html">Russians will get a digital profile</a></li>
<li><a href="../445722/index.html">Let's play in books - what gamebooks are and which ones are worth trying</a></li>
<li><a href="../445724/index.html">We repair WSUS clients</a></li>
<li><a href="../445726/index.html">The use of machine learning to analyze a large number of feedback from respondents</a></li>
<li><a href="../445730/index.html">The founders of the theory of distributed systems in the arms of the hydra</a></li>
<li><a href="../445736/index.html">Brief history of unusual music formats</a></li>
<li><a href="../445740/index.html">Cat under the hood. Part 1</a></li>
<li><a href="../445742/index.html">IoT standards, networks, three tables</a></li>
<li><a href="../445744/index.html">Theory and practice of hobby for IT person</a></li>
<li><a href="../445746/index.html">QA-mitap April 12 in Redmadrobot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>