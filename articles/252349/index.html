<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Text chat for the site</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share the experience of creating a text chat based on the nginx-push-stream-module of the Nginx, PHP and Javascript module. This module func...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Text chat for the site</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/2f8/058/d9d/2f8058d9d3d7718a75bd0a81503303fb.jpg" alt="image"><br><br>  I want to share the experience of creating a text chat based on the nginx-push-stream-module of the Nginx, PHP and Javascript module.  This module functions on the principle of long polling and can be used both for instant messaging between users and for the system of push notifications. <br><a name="habracut"></a><br><h4>  Adding Nginx module </h4><br>  We assume that you have already installed Nginx.  Therefore, first you need to download and add the nginx-push-stream-module module and rebuild Nginx manually.  A detailed guide to adding a module can be found <a href="http://habrahabr.ru/company/cackle/blog/167895/">here</a> and <a href="http://firstwiki.ru/index.php/%25D0%2594%25D0%25BE%25D0%25B1%25D0%25B0%25D0%25B2%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25BC%25D0%25BE%25D0%25B4%25D1%2583%25D0%25BB%25D0%25B5%25D0%25B9_nginx_%25D0%25B2_Linux_%2528Debian/Ubuntu/CentOS%2529">here</a> , I think it makes no sense to write again. <br><br><h4>  Configuration </h4><br>  To support long polling, in the Nginx configuration, we will declare a message publishing point (in this example, publish) and a subscription point for receiving messages (in this example, subscribe). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">http</span></span> { ‚Ä¶ <span class="hljs-section"><span class="hljs-section">server</span></span> { ‚Ä¶ <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /publish { <span class="hljs-attribute"><span class="hljs-attribute">push_stream_publisher</span></span> admin; <span class="hljs-comment"><span class="hljs-comment">#      push_stream_channels_path $arg_id; # id     push_stream_store_messages on; #      allow 127.0.0.1; #         } location ~ /subscribe/(.*) { push_stream_subscriber long-polling ; #     # (  ) push_stream_channels_path $1; # id    push_stream_longpolling_connection_ttl 300s; #  ,     #   ( )  #  push_stream_last_received_message_time $arg_time; #     push_stream_last_received_message_tag $arg_tag; # ,    # } } push_stream_shared_memory_size 32M; }</span></span></code> </pre> <br><br>  Inside the http block, you need to specify the directive push_stream_shared_memory_size, that is, the size of the allocated memory. <br><br><h4>  Posting to PHP </h4><br>  In PHP, messages are sent using the usual POST method. <br><br><pre> <code class="php hljs">$channel_id = subscriber1; <span class="hljs-comment"><span class="hljs-comment">//id     $message='!'; //  //  $ch = curl_init('http://127.0.0.1/publish?id='.$channel_id); curl_setopt($ch, CURLOPT_RETURNTRANSFER, true); curl_setopt($ch, CURLOPT_POST, true); curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($message)); curl_exec($ch); curl_close($ch);</span></span></code> </pre><br><br><h4>  Receiving messages in Javascript (jQuery) </h4><br>  There are several ways to subscribe to the channel, the easiest - Ajax request method GET. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> channelId = subscriber1; <span class="hljs-comment"><span class="hljs-comment">//id  var last_etag=0; //   'Etag' var last_time=null; //   'Last-Modified' function new_message() { $.ajax({ url: '/subscribe/' + channelId, type: "GET", dataType: 'json', beforeSend: function(xhr){xhr.setRequestHeader('Etag', last_etag);xhr.setRequestHeader('Last-Modified', last_time);}, success: function(data, status, xhr) { last_etag =xhr.getResponseHeader('Etag'); //    last_etag //   'Etag'  last_time =xhr.getResponseHeader('Last-Modified'); //     last_time //   'Last-Modified'  // -     setTimeout(new_message, 500); //      } }) } new_message();</span></span></code> </pre><br>  That's all.  This chat is cross-browser, does not require additional plug-ins from users and is suitable for projects of any scale.  Here's a <a href="http://pictoschat.com/">video chat</a> using this text chat. </div><p>Source: <a href="https://habr.com/ru/post/252349/">https://habr.com/ru/post/252349/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252337/index.html">Angular 2: Built on TypeScript</a></li>
<li><a href="../252339/index.html">Experience of using the game designer Game salad</a></li>
<li><a href="../252343/index.html">Introducing the new Intel¬Æ IoT Developer Kit v1.0</a></li>
<li><a href="../252345/index.html">Discover FireUI</a></li>
<li><a href="../252347/index.html">Mobile Developer Rankings 2015 Results</a></li>
<li><a href="../252351/index.html">Circle Arduino and not only</a></li>
<li><a href="../252353/index.html">Hibernate, multi-tenancy and auto-update database schema</a></li>
<li><a href="../252355/index.html">Sidebar for extensions and other new Opera Developer 29</a></li>
<li><a href="../252357/index.html">C #: how to "shoot yourself in the leg"</a></li>
<li><a href="../252365/index.html">How did we get $ 30k from Google RISE, how to continue teaching children to program and how to become a partner in our team?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>