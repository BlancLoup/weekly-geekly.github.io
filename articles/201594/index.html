<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Profiling and Debugging Python</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago, I talked about " Profiling and debugging Django ." After the speech, I received a lot of questions (both personally and by email), we e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Profiling and Debugging Python</h1><div class="post__text post__text-html js-mediator-article">  Some time ago, I talked about " <a href="http://moscowdjango.ru/meetup/13/profiling-django/">Profiling and debugging Django</a> ."  After the speech, I received a lot of questions (both personally and by email), we even went to a bar with a couple of new acquaintances to discuss important programming problems behind a glass of excellent ale, and I continue to communicate with many people until now. <br><br>  Since the presentation aroused a keen interest, and conversations with colleagues allowed me to rethink some points of the presentation and correct the mistakes, I decided to issue a report and my thoughts in the form of an article.  This will allow you to familiarize yourself with the topic to a much larger circle of interested persons, besides, Habr provides the ideal platform for commenting on the proposed material and communicating with interesting interlocutors. <br><a name="habracut"></a><br>  There is a lot of material, the article turned out to be huge, so I decided to split it into several parts: <br><ul><li>  <strong>Introduction and theory</strong> - why do you need profiling, different approaches, tools and differences between them? </li><li>  <a href="http://habrahabr.ru/company/mailru/blog/201778/">Manual and statistical profiling</a> - go to practice </li><li>  <a href="http://habrahabr.ru/company/mailru/blog/202832/">Event Profiling</a> - tools and their use </li><li>  <a href="http://habrahabr.ru/company/mailru/blog/205426/">Debugging</a> - what to do when nothing works </li></ul><br><br><h2>  Introduction </h2><br>  First of all, you need to understand the definitions.  <a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25BE%25D1%2584%25D0%25B8%25D0%25BB%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5_(%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2582%25D0%25B8%25D0%25BA%25D0%25B0)">We read</a> in Wikipedia: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <em>Profiling - collecting the characteristics of the program in order to further optimize them.</em> <br><br>  So, for profiling, we need a working program, and working not quite the way we would like: either working too slowly, or consuming too many resources. <br><br>  What are the characteristics of the program can be collected? <br><ul><li>  execution time of individual lines of code (instructions) </li><li>  the number of calls and the execution time of individual functions </li><li>  function call tree </li><li>  ‚Äú <a href="http://ru.wikipedia.org/wiki/%25D0%25A5%25D0%25BE%25D1%2582-%25D1%2581%25D0%25BF%25D0%25BE%25D1%2582_(%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5)">Hot spots</a> ‚Äù (code areas that account for a significant proportion of instructions executed) </li><li>  CPU load and memory consumption </li><li>  access to other computer resources (for example, file descriptors) </li><li>  etc.  etc. </li></ul><br>  Of course, it does not always make sense to study the project in detail under a microscope, examining each instruction and studying everything thoroughly, but knowing what, how and where we can see is useful and necessary. <br><br>  Let's define the concept of "optimization".  Wikipedia <a href="http://ru.wikipedia.org/wiki/%25D0%259E%25D0%25BF%25D1%2582%25D0%25B8%25D0%25BC%25D0%25B8%25D0%25B7%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F_(%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2582%25D0%25B8%25D0%25BA%25D0%25B0)">tells</a> us that: <br><br>  <em>Optimization is a modification of the system to improve its efficiency.</em> <br><br>  The concept of "efficiency" is very vague and directly depends on the goal, for example, in some cases the program should run as fast as possible, in others the speed can be neglected and it is much more important to save RAM or other resources (such as disk).  As Frederick Brooks rightly <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B1%25D1%2580%25D1%258F%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25BF%25D1%2583%25D0%25BB%25D0%25B8_%25D0%25BD%25D0%25B5%25D1%2582">said</a> , "a silver bullet does not exist." <br><br>  Obviously, the program can be optimized indefinitely: in any fairly complex project there will always be a bottleneck that can be improved, so it is important to be able to stop on time.  In most cases (exceptions are extremely rare and relate rather to <a href="http://habrahabr.ru/post/27055/">folklore</a> than to real life) it makes no sense to spend, say, three days of working time for the sake of 5% gain in speed. <br><br>  On the other hand, as Donald Knut used to repeat: ‚ÄúPremature optimization is the root of all evils.‚Äù <br><br>  <i>What article about optimization does without this quote?</i>  <i>Many believe that its author is Donald Knut, but Donald himself claims that it was first said by Anthony Hoar.</i>  <i>Anthony, on the other hand, unlocks and suggests that the statement should be considered ‚Äúuniversal property‚Äù.</i> <br><br>  It is important to clearly understand what exactly does not suit us in the work of the program and what goals we want to achieve, but this does not mean that profiling and subsequent optimization should be done when everything starts to slow down.  A good programmer always knows how a program written by him feels and predicts its performance in critical situations (such as habra effect). <br><br>  I want to note another important point: often the optimization is accompanied by a significant deterioration in the readability of the code.  If possible, try to avoid this, and if you still had to write less readable code in critical places, do not be lazy and leave a comment with a detailed description of his work.  Your colleagues will thank you, and you yourself will find yourself surprisingly insightful when you return to these lines in a while. <br><br>  I will no longer touch upon the question of optimization, because, as I said above, everything very much depends on the task and each case must be disassembled separately.  Focus on the detection of problem areas of the program. <br><br><h2>  Approaches to profiling </h2><br>  There are at least three approaches to profiling: <br><ul><li>  gaze method </li><li>  manual profiling </li><li>  using tools </li></ul><br>  Everything is clear <strong>with the gaze method</strong> (and its related ‚Äú <strong>spear method</strong> ‚Äù).  Just sit in front of a text editor, open the code and think about where the problem might be, try to fix it, look at the result, roll back.  And only in rare cases ( <i>or with the highest qualification of the developer</i> ) is the method effective. <br><br>  Advantages and disadvantages of this method: <br>  + does not require special knowledge and skills <br>  - it is difficult to estimate labor costs and results <br><br>  <strong>Manual profiling is</strong> convenient to use when there is a reasonable assumption about bottlenecks and it is required to confirm or deny the hypothesis.  Or, if we, in contrast to the first method, need to obtain numerical indicators of the results of our optimization (for example, the function was performed for 946 milliseconds, began to work for 73 milliseconds, accelerated the code 13 times). <br><br>  The essence of this method is as follows: before executing the disputed part of the program, we save the current system time (up to microseconds) into a variable, and then we re-receive the current time and subtract the value of the saved variable from it.  We get (with enough error for us) the execution time of the analyzed code.  For a reliable result, repeat N times and take the average value. <br><br>  Advantages and disadvantages of this method: <br>  + very simple application <br>  + limited for production <br>  - insert "alien" code in the project <br>  - use is not always possible <br>  - no information about the program, except the execution time of the analyzed area <br>  - analysis of results may be difficult <br><br>  Profiling <strong>with the help of tools</strong> helps when we (for one reason or another) do not know why the program does not work as it should, or when we are too lazy to use manual profiling and analyze its results.  More on the tools in the next section. <br><br>  I must say that regardless of the approach chosen, the main tool of the developer is his brain.  No program (for <i>now (?)</i> ) Will say: <br>  <em>Hey, do you <i>have</i> nonsense written in line 619 of the <i>project / app.py</i> file!</em>  <em>Bring the call to that function out of the loop and you will be happy.</em>  <em>And also, if you use caching, and rewrite the <i>calculate</i> function on C, then the speed will increase by an average of 18 times!</em> <br><br><h2>  What are the tools </h2><br>  There are two types of tools (in fact, there are more options for classification and terminology, but we will limit ourselves to two): <br><ul><li>  statistical profiler </li><li>  event (deterministic, event-based) profiler </li></ul><br>  <i>Unfortunately, I could not come up with a beautiful name in Russian for a "deterministic" profiler, so I will use the word "event".</i>  <i>I would be grateful if someone corrected me in the comments.</i> <br><br>  Most developers are familiar only with event profilers, and a big surprise for them is the fact that the statistical profiler appeared first: in the early seventies of the last century, programmers of <a href="http://ru.wikipedia.org/wiki/IBM_System/360">IBM / 360</a> and <a href="http://ru.wikipedia.org/wiki/IBM_System/370">IBM / 370</a> computers set a timer interrupt, which recorded the current value of <a href="http://en.wikipedia.org/wiki/Program_status_word">Program status word</a> (Psw)  Further analysis of the stored data made it possible to determine the problem areas of the program. <br><br>  The first event profiler appeared at the end of the same seventies, it was the Unix <strong>prof</strong> OS utility, which showed the execution time of all program functions.  A few years later (1982), the <strong>gprof</strong> utility appeared, which learned how to display the function call graph. <br><br><h3>  Statistical profiler </h3><br>  The principle of operation of the statistical profiler is simple: at specified (rather small) intervals, a pointer is taken to the current instruction being executed and saves this information (‚Äúsamples‚Äù) for further study.  It looks like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/8a9/6cb/bc3/8a96cbbc3a23582f4ec1f465d9b01cbc.png"><br>  apparently, the function <strong>bar () was</strong> performed almost two and a half times longer than the functions <strong>foo ()</strong> , <strong>baz ()</strong> and some unnamed instruction. <br><br>  One of the drawbacks of the statistical profiler is that in order to obtain adequate statistics on the program's work, it is necessary to carry out as much as possible (ideally - an infinite) number of measurements with as short an interval as possible.  Otherwise, some calls may not be analyzed at all: <br><img src="https://habrastorage.org/getpro/habr/post_images/d4e/a00/2b9/d4ea002b9d96438ec259b11d856f88cc.png"><br>  for example, the figure shows that the nameless function was not included in the sample. <br><br>  It is also difficult to estimate the real time of the analyzed functions.  Consider a situation where the <strong>foo ()</strong> function executes fairly quickly, but is called very often: <br><img src="https://habrastorage.org/getpro/habr/post_images/c2e/9ee/be5/c2e9eebe5dedcdecc8ff8b3f9157e676.png"><br>  and a situation where the <strong>foo ()</strong> function runs for a very long time, but is called only once: <br><img src="https://habrastorage.org/getpro/habr/post_images/7a3/6b6/889/7a36b68898ff129c22ece3baad08c299.png"><br>  The result of the statistical profiler will be the same in both cases. <br><br>  Nevertheless, the statistical profiler copes great with the search for the most "heavy" and "hot" places of the program, and its minimal impact on the analyzed program (and, as a result, its suitability for production) negates all the drawbacks.  In addition, Python allows you to get the full stacktrace for code when sampling and analyzing it allows you to get a more complete and detailed picture. <br><br>  Advantages and disadvantages of the statistical profiler: <br>  + can be started up in production (the effect on the program being analyzed is minimal) <br>  - we get far from all the information about the code (in fact, only ‚Äúhot spots‚Äù) <br>  - incorrect interpretation of the result is possible <br>  - it takes a long time to collect adequate statistics <br>  - few tools for analysis <br><br><h3>  Event Profiler </h3><br>  The event profiler tracks all function calls, returns, exceptions, and measures the intervals between these events.  The measured time (along with information on the relevant parts of the code and the number of calls) is saved for further analysis. <br><img src="https://habrastorage.org/getpro/habr/post_images/fd3/9ee/478/fd39ee4789da3cfc81e2cedf859e78de.png"><br><br>  The most important drawback of such profilers directly follows from the principle of their work: since we intervene in the program being analyzed <strong>at every step</strong> , the process of its execution can (and will) be very different from the ‚Äúusual‚Äù working conditions (just like in quantum mechanics).  For example, in some cases, it is possible that the program will slow down two or more times.  Of course, in the production of releasing this can only be in the case of despair and complete hopelessness. <br><br>  Nevertheless, the pros outweigh the cons, otherwise there would not be such a huge variety of different tools.  Viewing the results in a user-friendly interface with the ability to analyze the execution time and the number of calls on each line of the program cost a lot, the call graph helps to detect flaws in the algorithms used. <br><br>  Advantages and disadvantages of event profilers: <br>  + no code change required <br>  + get all the information about the program <br>  + huge amount of tools <br>  - in some cases the profiler changes the behavior of the program <br>  - So slow <br>  - practically unsuitable for production <br><br>  In the <a href="http://habrahabr.ru/company/mailru/blog/201778/">next article,</a> we will practice manual profiling and statistical profilers in practice.  Stay in touch =) </div><p>Source: <a href="https://habr.com/ru/post/201594/">https://habr.com/ru/post/201594/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../201582/index.html">UrlEye.com is a free website control service.</a></li>
<li><a href="../201586/index.html">Installing the latest version of Firebird on Ubuntu</a></li>
<li><a href="../201588/index.html">Counts for the smallest: Ford & Bellman or how to understand that you got into the infinitely distant past</a></li>
<li><a href="../201590/index.html">The tragedy of communities in the real world or coupon fever-2</a></li>
<li><a href="../201592/index.html">Iterator in doT.js template engine for objects with filtering</a></li>
<li><a href="../201596/index.html">From idea to App Store in 24 hours</a></li>
<li><a href="../201598/index.html">Experience creating a cross-platform game (iOS / Android)</a></li>
<li><a href="../201600/index.html">jBone. Replacing jQuery for Backbone or 2kb for DOM manipulation</a></li>
<li><a href="../201602/index.html">Remote DOS exploit (device reboot) iOS ~ 6.1 - 7.0.3 [0day]</a></li>
<li><a href="../201604/index.html">How to work with inadequate customers?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>