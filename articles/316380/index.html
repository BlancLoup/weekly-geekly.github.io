<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FIAS addresses in the PostgreSQL environment. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the second part of the article, which outlines the experience with the list of FIAS addressing elements loaded into the database running Postg...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FIAS addresses in the PostgreSQL environment. Part 2</h1><div class="post__text post__text-html js-mediator-article">  This is the second part of the article, which outlines the experience with the list of FIAS addressing elements loaded into the database running PostgreSQL.  The first part of the article can be found <a href="https://habrahabr.ru/post/316314/">here</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/90f/3f4/68a/90f3f468a89b4002ad9d9ec27665cba5.png"></div><br><a name="habracut"></a><br>  The full text of the article consists of 4 parts.  The first half of this part of the article contains comments on the implementation of the function.  In the second - the source code of the function.  For those readers who are interested only in the source code, we suggest that you go straight to the Appendix. <br><a name="fnAddressTAN_def"></a><br><h2>  Full name addressing element </h2><br>  The main idea of ‚Äã‚Äãthe fsfn_AddressObjects_TreeActualName function is to return a single-named element name along with the names of all its ancestors.  For example, let the pedigree element search functions (fstf_AddressObjects_AddressObjectTree) return the following list of values. <br><br>  <strong>Table 5. The result of the function fstf_AddressObjects_AddressObjectTree ('bfc1236d-b5d2-4734-a238-3b1e4830e963')</strong> <br><table><tbody><tr><th>  AOGUID </th><th>  CurrStatus </th><th>  Actstatus </th><th>  AOLevel </th><th>  ShortName </th><th>  FormalName </th><th>  ObjectGroup </th></tr><tr><td>  db9c4f8b-b706-40e2-b2b4-d31b98dcd3d1 </td><td>  0 </td><td>  one </td><td>  one </td><td>  edge </td><td>  Krasnoyarsk </td><td>  Region </td></tr><tr><td>  625497d3-22de-4390-b4b4-2febfbfc15ce </td><td>  0 </td><td>  one </td><td>  3 </td><td>  rn </td><td>  Balakhtinsky </td><td>  Territory </td></tr><tr><td>  39da6405-b3e6-4baf-b332-d47b73b4d5fb </td><td>  0 </td><td>  one </td><td>  6 </td><td>  P </td><td>  Mighty </td><td>  Locality </td></tr><tr><td>  bfc1236d-b5d2-4734-a238-3b1e4830e963 </td><td>  0 </td><td>  one </td><td>  7 </td><td>  street </td><td>  New </td><td>  Street </td></tr></tbody></table><br>  Then fsfn_AddressObjects_TreeActualName ('bfc1236d-b5d2-4734-a238-3b1e4830e963') should return: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>"Krasnoyarsk Territory, Balakhta district, p Moguchy, New Street"</b> <br><br>  The function has one more optional parameter array of masks (a_MaskArray), with which you can include in the result not all the names of the elements, but only those that are needed. <br><br>  The text of the function is given in the Appendix section ‚ÄúCreating a function fsfn_AddressObjects_TreeActualName‚Äù. <br><br><h3>  How it works </h3><br>  The implementation of the function is based on the fstf_AddressObjects_AddressObjectTree call (described in the first part of the article) and the cycle of records returned to it, in the body of which the full name of the addressing element is formed by concatenating (concatenating) all names into one string.  This string will eventually be returned by the fsfn_AddressObjects_TreeActualName function. <br><br>  Further details will be explained. <br><br>  First, sometimes it is not necessary that the result of the function necessarily include the names of all the ancestors of the current element.  For example, within the Krasnoyarsk Territory, instead of ‚ÄúKrasnoyarsk Territory, Balakhta district, Moguchy, Novaya street‚Äù, they often use the shortened form ‚ÄúBalakhta district, Moguchy village, Novaya street‚Äù.  And inside the city of Krasnoyarsk, instead of the address "Krasnoyarsk Territory, Krasnoyarsk, D. Peschanka, St. Sergey Lazo" more often use "D. Peschanka, St. Sergey Lazo". <br><br>  In order to be able to manage different forms of writing the full name of the addressing element, the parameter is an array of masks (a_MaskArray) parameter that contains a sequence of pointers (masks) to groups of elements. <br><br>  <strong>Table 6. List of function masks</strong> <br><table><tbody><tr><th>  Value </th><th>  Note </th></tr><tr><td>  {ST} </td><td>  Mask - street </td></tr><tr><td>  {ZC} </td><td>  Mask - Zip Code </td></tr><tr><td>  {DT} </td><td>  Maska - urban area </td></tr><tr><td>  {LP} </td><td>  Mask - subordinate settlement </td></tr><tr><td>  {LM} </td><td>  Mask - the main settlement </td></tr><tr><td>  {TP} </td><td>  Mask - region of the subject of the federation </td></tr><tr><td>  {TM} </td><td>  Mask - subject of the federation (region) </td></tr><tr><td>  {CY} </td><td>  Mask - Country </td></tr></tbody></table><br>  Secondly, in order to implement the construction of the full name in accordance with the array of masks, an auxiliary function fsfn_AddressObjects_ObjectGroup has been created, which refers each address-forming element to a specific group. <br><br>  <strong>Table 7. Values ‚Äã‚Äãreturned by the fsfn_AddressObjects_ObjectGroup function</strong> <br><table><tbody><tr><th>  Value </th><th>  Note </th></tr><tr><td>  Country </td><td>  Group Sign - Country </td></tr><tr><td>  Region </td><td>  Group Tag - Region </td></tr><tr><td>  City </td><td>  Group Sign - Primary Settlement </td></tr><tr><td>  Territory </td><td>  Group Sign - District </td></tr><tr><td>  Locality </td><td>  Sign of the group - a settlement subordinate to the main </td></tr><tr><td>  Motorroad </td><td>  Sign of the group - the road </td></tr><tr><td>  Railwayaybject </td><td>  Sign of the group - the railway </td></tr><tr><td>  Villagecouncil </td><td>  Group Sign - Village Council </td></tr><tr><td>  Street </td><td>  Sign of the group - the street in the village </td></tr><tr><td>  AddlTerritory </td><td>  Sign of the group - additional territory </td></tr><tr><td>  PartAddlTerritory </td><td>  Group tag - part of additional territory </td></tr></tbody></table><br>  The list of values ‚Äã‚Äãreturned by the fsfn_AddressObjects_ObjectGroup function is given in Table 5. <br><br>  The purpose of creating this function is to collect in one place all the features (if you want, "crutches") of the definition of the element group.  A detailed implementation of this function can be found in the Appendix section ‚ÄúCreating a function fsfn_AddressObjects_ObjectGroup‚Äù. <br><br>  The combination of the values ‚Äã‚Äãof the function and the AOLevel field (the level of the address-forming element), along with checking for the presence of a mask group mask array, allows you to determine whether the name of the current element should be included in the result string. <br><br>  For example, a sign that the name of the main locality should be included in the full name of the element is the truth of the following expression: <br><br><pre><code class="sql hljs">v_ObjectGroup='City' AND '{LM}' &lt;@ a_MaskArray AND v_AOLevel =4</code> </pre> <br><h2>  ATTACHMENT </h2><br><a name="Script1"></a><br><h3>  Creating the fsfn_AddressObjects_ObjectGroup Function </h3><br><div class="spoiler">  <b class="spoiler_title">function source code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fsfn_AddressObjects_ObjectGroup(a_AOGUID <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>),a_CurrStatus <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*****************************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*         */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* fias_AddressObjects */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*****************************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> fsfn_AddressObjects_ObjectGroup( a_AOGUID <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>), <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> a_CurrStatus <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    4: */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* 0 - , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* 1-50 - , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* ..   , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* 51 -  */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_CountryGroupValue <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>):=<span class="hljs-string"><span class="hljs-string">'Country'</span></span>; c_RegionGroupValue CONSTANT VARCHAR(50):='Region'; c_CityGroupValue CONSTANT VARCHAR(50):='City'; c_TerritoryGroupValue CONSTANT VARCHAR(50):='Territory'; c_LocalityGroupValue CONSTANT VARCHAR(50):='Locality'; c_MotorRoadValue CONSTANT VARCHAR(50):='MotorRoad'; c_RailWayObjectValue CONSTANT VARCHAR(50):='RailWayObject'; c_VillageCouncilValue CONSTANT VARCHAR(50):='VillageCouncil'; c_StreetGroupValue CONSTANT VARCHAR(50):='Street'; c_AddlTerritoryValue CONSTANT VARCHAR(50):='AddlTerritory'; c_PartAddlTerritoryValue CONSTANT VARCHAR(50):='PartAddlTerritory'; v_ShortTypeName VARCHAR(10); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_AddressObjectName VARCHAR(100); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_AOLevel INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_CurrStatus INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_ObjectGroup VARCHAR(50); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_Return_Error Integer :=0; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">--************************************************************************** --************************************************************************** BEGIN SELECT INTO v_CurrStatus COALESCE(a_CurrStatus,MIN(addrobj.currstatus)) FROM fias_AddressObjects addrobj WHERE addrobj.AOGUID=a_AOGUID; SELECT INTO v_ShortTypeName,v_AddressObjectName,v_AOLevel ShortName,FormalName,AOLevel FROM fias_AddressObjects addrobj WHERE addrobj.AOGUID=a_AOGUID AND addrobj.currstatus = v_CurrStatus LIMIT 1; IF v_AOLevel = 1 AND UPPER(v_ShortTypeName) &lt;&gt; '' THEN /*   */ v_ObjectGroup:=c_RegionGroupValue; ELSIF v_AOLevel = 1 AND UPPER(v_ShortTypeName) = '' THEN /*   */ /*   */ v_ObjectGroup:=c_CityGroupValue; ELSIF v_AOLevel = 3 THEN /*   */ v_ObjectGroup:=c_TerritoryGroupValue; ELSIF (v_AOLevel = 4 AND UPPER(v_ShortTypeName) NOT IN ('/','/','/','/')) OR (v_AOLevel = 1 AND UPPER(v_ShortTypeName) &lt;&gt; '') THEN /*   */ v_ObjectGroup:=c_CityGroupValue; ELSIF v_AOLevel IN (4,6) AND UPPER(v_ShortTypeName) IN ('/','/','/','/') AND UPPER(v_ShortTypeName) NOT LIKE ('/%') THEN /*   */ v_ObjectGroup:=c_VillageCouncilValue; ELSIF v_AOLevel = 6 AND UPPER(v_ShortTypeName) NOT IN ('/','/','/','/', '','','', '', '', '','') AND UPPER(v_ShortTypeName) NOT LIKE ('/%') THEN /*   */ /*  */ v_ObjectGroup:=c_LocalityGroupValue; ELSIF UPPER(v_ShortTypeName) IN ('') THEN /*  */ /*   */ v_ObjectGroup:=c_MotorRoadValue; ELSIF v_AOLevel IN (6,7) AND UPPER(v_ShortTypeName) LIKE ('/%') THEN /*   */ /*    */ v_ObjectGroup:=c_RailWayObjectValue; ELSIF v_AOLevel = 7 AND UPPER(v_ShortTypeName) NOT LIKE ('/%') AND UPPER(v_ShortTypeName) NOT IN ('-','','-','','') OR (v_AOLevel = 6 AND UPPER(v_ShortTypeName) IN ('') ) THEN /*   */ v_ObjectGroup:=c_StreetGroupValue; ELSIF v_AOLevel = 90 OR v_AOLevel = 6 AND UPPER(v_ShortTypeName) IN ('', '','','','') OR v_AOLevel = 7 AND UPPER(v_ShortTypeName) IN ('-','','-','','') THEN /*   */ /*  */ v_ObjectGroup:=c_AddlTerritoryValue; ELSIF v_AOLevel = 91 THEN /*     */ /*  */ v_ObjectGroup:=c_PartAddlTerritoryValue; END IF; RETURN v_ObjectGroup; END; $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION fsfn_AddressObjects_ObjectGroup(a_AOGUID VARCHAR(36), a_CurrStatus INTEGER) IS '          fias_AddressObjects'; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT fsfn_AddressObjects_ObjectGroup('719b789d-2476-430a-89cd-3fedc643d821',51); SELECT fsfn_AddressObjects_ObjectGroup('db9c4f8b-b706-40e2-b2b4-d31b98dcd3d1'); SELECT fsfn_AddressObjects_ObjectGroup('625497d3-22de-4390-b4b4-2febfbfc15ce'); SELECT fsfn_AddressObjects_ObjectGroup('39da6405-b3e6-4baf-b332-d47b73b4d5fb'); SELECT fsfn_AddressObjects_ObjectGroup('bfc1236d-b5d2-4734-a238-3b1e4830e963');</span></span></code> </pre><br></div></div><br><h3>  Creating the fsfn_AddressObjects_TreeActualName function </h3><br><div class="spoiler">  <b class="spoiler_title">function source code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fsfn_AddressObjects_TreeActualName(a_AOGUID <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>),a_MaskArray <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)[<span class="hljs-number"><span class="hljs-number">10</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">CASCADE</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*****************************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*****************************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> fsfn_AddressObjects_TreeActualName( a_AOGUID <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> a_MaskArray <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)[<span class="hljs-number"><span class="hljs-number">10</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'{TP,LM,LP,ST}'</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_CountryGroupValue <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>):=<span class="hljs-string"><span class="hljs-string">'Country'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*   - */</span></span> c_RegionGroupValue CONSTANT VARCHAR(50):='Region'; <span class="hljs-comment"><span class="hljs-comment">/*   - */</span></span> c_CityGroupValue CONSTANT VARCHAR(50):='City'; <span class="hljs-comment"><span class="hljs-comment">/*   -  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> c_TerritoryGroupValue CONSTANT VARCHAR(50):='Territory';<span class="hljs-comment"><span class="hljs-comment">/*   -  */</span></span> c_LocalityGroupValue CONSTANT VARCHAR(50):='Locality';<span class="hljs-comment"><span class="hljs-comment">/*   - */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> c_MotorRoadValue CONSTANT VARCHAR(50):='MotorRoad';<span class="hljs-comment"><span class="hljs-comment">/*   - */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> c_RailWayObjectValue CONSTANT VARCHAR(50):='RailWayObject';<span class="hljs-comment"><span class="hljs-comment">/*   - */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> c_VillageCouncilValue CONSTANT VARCHAR(50):='VillageCouncil'; <span class="hljs-comment"><span class="hljs-comment">/*   -  */</span></span> c_StreetGroupValue CONSTANT VARCHAR(50):='Street'; <span class="hljs-comment"><span class="hljs-comment">/*   - */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> c_AddlTerritoryValue CONSTANT VARCHAR(50):='AddlTerritory';<span class="hljs-comment"><span class="hljs-comment">/*   - */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> c_PartAddlTerritoryValue CONSTANT VARCHAR(50):='PartAddlTerritory';<span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* -   */</span></span> c_StreetMask CONSTANT VARCHAR(2)[1] :='{ST}';<span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> c_PostIndexMask CONSTANT VARCHAR(2)[1] :='{ZC}';<span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> c_DistrictMask CONSTANT VARCHAR(2)[1] :='{DT}';<span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> c_PartLocalityMask CONSTANT VARCHAR(2)[1] :='{LP}';<span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> c_MainLocalityMask CONSTANT VARCHAR(2)[1] :='{LM}';<span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> c_PartTerritoryMask CONSTANT VARCHAR(2)[1] :='{TP}';<span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> c_MainTerritoryMask CONSTANT VARCHAR(2)[1] :='{TM}';<span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* ()*/</span></span> c_CountryMask CONSTANT VARCHAR(2)[1] :='{CY}';<span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> v_ShortTypeName VARCHAR(10); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_AddressObjectName VARCHAR(100); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_AOLevel INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_MinCurrStatus INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> v_TreeAddressObjectName VARCHAR(1000); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_ObjectGroup VARCHAR(50); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_TreeLeverCount INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> v_Return_Error_i Integer := 0; <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> cursor_AddressObjectTree RefCURSOR; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_Return_Error Integer :=0; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">--****************************************************************************** --****************************************************************************** BEGIN SELECT INTO v_MinCurrStatus MIN(addrobj.currstatus) FROM fias_AddressObjects addrobj WHERE aoguid=a_AOGUID; OPEN cursor_AddressObjectTree FOR SELECT rtf_ShortTypeName, REPLACE(rtf_AddressObjectName,' ',' '), rtf_AOLevel,fsfn_AddressObjects_ObjectGroup(rtf_AOGUID ) FROM fstf_AddressObjects_AddressObjectTree(a_AOGUID) ORDER BY rtf_AOLevel; v_TreeLeverCount:=0; v_TreeAddressObjectName:=''; FETCH FIRST FROM cursor_AddressObjectTree INTO v_ShortTypeName,v_AddressObjectName, v_AOLevel,v_ObjectGroup; WHILE FOUND LOOP v_TreeLeverCount:=v_TreeLeverCount+1; IF v_ObjectGroup=c_CountryGroupValue AND c_CountryMask &lt;@ a_MaskArray AND v_AOLevel =0 THEN v_TreeAddressObjectName:=v_TreeAddressObjectName|| CASE WHEN v_TreeAddressObjectName='' THEN '' ELSE ', ' END || v_AddressObjectName||' '||v_ShortTypeName; ELSIF v_ObjectGroup=c_RegionGroupValue AND c_MainTerritoryMask &lt;@ a_MaskArray AND v_AOLevel &lt;=2 THEN v_TreeAddressObjectName:=v_TreeAddressObjectName|| CASE WHEN v_TreeAddressObjectName='' THEN '' ELSE ', ' END || CASE WHEN UPPER(v_ShortTypeName) LIKE UPPER('%%') THEN ' ' || v_AddressObjectName ELSE v_AddressObjectName|| ' '||v_ShortTypeName END; ELSIF v_ObjectGroup=c_TerritoryGroupValue AND c_PartTerritoryMask &lt;@ a_MaskArray AND v_AOLevel =3 THEN v_TreeAddressObjectName:=v_TreeAddressObjectName|| CASE WHEN v_TreeAddressObjectName='' THEN '' ELSE ', ' END || v_AddressObjectName||' '||v_ShortTypeName; ELSIF v_ObjectGroup=c_CityGroupValue AND c_MainLocalityMask &lt;@ a_MaskArray AND v_AOLevel =4 THEN v_TreeAddressObjectName:=v_TreeAddressObjectName|| CASE WHEN v_TreeAddressObjectName='' THEN '' ELSE ', ' END || CASE WHEN UPPER(LEFT(v_AddressObjectName,6+ LENGTH(v_ShortTypeName)))=' '|| UPPER(TRIM(v_ShortTypeName))||'.' THEN v_AddressObjectName ELSE v_ShortTypeName ||' '|| v_AddressObjectName END; ELSIF v_ObjectGroup=c_LocalityGroupValue AND c_DistrictMask &lt;@ a_MaskArray AND v_AOLevel =5 THEN v_TreeAddressObjectName:=v_TreeAddressObjectName|| CASE WHEN v_TreeAddressObjectName='' THEN '' ELSE ', ' END || v_AddressObjectName||' '||v_ShortTypeName ; ELSIF v_ObjectGroup=c_LocalityGroupValue AND c_PartLocalityMask &lt;@ a_MaskArray AND v_AOLevel =6 THEN v_TreeAddressObjectName:=v_TreeAddressObjectName|| CASE WHEN v_TreeAddressObjectName='' THEN '' ELSE ', ' END || v_ShortTypeName ||' '|| v_AddressObjectName; ELSIF v_ObjectGroup=c_StreetGroupValue AND c_StreetMask &lt;@ a_MaskArray AND v_AOLevel =7 THEN v_TreeAddressObjectName:=v_TreeAddressObjectName|| CASE WHEN v_TreeAddressObjectName='' THEN '' ELSE ', ' END || v_ShortTypeName ||' '|| v_AddressObjectName; END IF; FETCH NEXT FROM cursor_AddressObjectTree INTO v_ShortTypeName, v_AddressObjectName, v_AOLevel,v_ObjectGroup; END LOOP; CLOSE cursor_AddressObjectTree; RETURN v_TreeAddressObjectName; END; $BODY$ LANGUAGE plpgsql ; COMMENT ON FUNCTION fsfn_AddressObjects_TreeActualName(a_AOGUID VARCHAR(36), a_MaskArray VARCHAR(2)[10]) IS '      '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT fsfn_AddressObjects_TreeActualName('bfc1236d-b5d2-4734-a238-3b1e4830e963','{TM,TP,LM,LP,ST}'); SELECT fsfn_AddressObjects_TreeActualName('bfc1236d-b5d2-4734-a238-3b1e4830e963');</span></span></code> </pre><br></div></div><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/316380/">https://habr.com/ru/post/316380/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316368/index.html">Creating a blog engine with Phoenix and Elixir / Part 4. Add processing roles in controllers</a></li>
<li><a href="../316370/index.html">12 billion requests per month for $ 120 in java</a></li>
<li><a href="../316374/index.html">Under the hood of the new crafts Dell + EMC - flash storage at the price of disk</a></li>
<li><a href="../316376/index.html">Entity? Provide your IP address</a></li>
<li><a href="../316378/index.html">Welcome to the DevFest Vladivostok</a></li>
<li><a href="../316382/index.html">FreeNAS 10 - the new face of the old storage</a></li>
<li><a href="../316386/index.html">Increase attack costs with Immutable Infrastructure</a></li>
<li><a href="../316388/index.html">Never take a counter offer</a></li>
<li><a href="../316392/index.html">Why not Assets Pipeline?</a></li>
<li><a href="../316394/index.html">5 reasons not to use your personal account in freelance</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>