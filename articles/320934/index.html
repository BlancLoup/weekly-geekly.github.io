<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple greylisting in opensmtpd</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is a logical continuation of the article " Integration of rspamd email anti-spam with opensmtpd " due to some challenge that I was thrown...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple greylisting in opensmtpd</h1><div class="post__text post__text-html js-mediator-article"><p>  This article is a logical continuation of the article " <a href="https://habrahabr.ru/post/320698/">Integration of rspamd email anti-spam with opensmtpd</a> " due to some challenge that I was thrown saying that it is difficult to implement greylisting in the opensmtpd + rspamd combination. </p><br><p>  I have not seen the ‚Äúsuccess stories‚Äù of integrating greylisting into opensmtpd (if they exist, please write in the comments). </p><br><p>  It is difficult to implement greylisting in my case - I didn‚Äôt deny and didn‚Äôt intend to do this functionality before opening filters in opensmtpd, although I understood that greylisting is one of the quite good methods of dealing with spam.  But the challenge and the desire to a little more reduce the amount of spam and sleep well - they did not let sleep sleep and forced to do it. </p><br><p>  I managed to implement a simple greylisting method. </p><br><a name="habracut"></a><br><p>  A few clarifications: </p><br><ol><li><p>  The method is simple only if the implementation of the opensmtpd + rspamd bundle is done through the mda script layer. </p><br></li><li><p>  The implementation of greylisting for opensmtpd exists through a <a href="https://github.com/jdelic/opensmtpd-filter-greylistd">filter</a> .  But, as they know, people interested in opensmtpd do not have a stable implementation of filters in opensmtpd.  In addition, I didn‚Äôt want to add one more daemon with rspamd integrated greiling </p><br></li><li><p>  Implementation of greylisting for opensmtpd exists for freebsd and spamd.  I was not interested in the implementation details, since  there is no spamd daemon for linux. </p><br></li><li>  Implementation is a crutch and use of undocumented features, but where are we without them in IT? </li></ol><br><h1 id="teoriya">  Theory </h1><br><p>  Greylisting is a method of spamming, based on the fact that spam programs want to send as much spam as possible here and in this second. </p><br><p>  Simplified logic of greylisting: if a letter comes to us, then we reply to the sender with a temporary error, we remember the sender ourselves (for example, for a day) in order to receive a letter from him after some time (for example, after 5 minutes). </p><br><p>  The "correct" sender (according to standards) should try to send us an email again after a while.  The ‚Äúwrong‚Äù sender either does this or does not, but in the intervening time, the sender has time to get into various external spam lists and we are filtering it out already on the basis of these spam lists. </p><br><p>  After we have remembered the sender, then within a day (as an example), the check for greylist is not done again.  This allows you to reduce the time of delivery of the second letter (if this is the correct sender). </p><br><p>  In postfix + amavis + spamasassin greylisting was done, if I'm not mistaken, by domain names.  In rspamd, the IP address of the sender with the mask / 19 (configurable) is made the key for greylisting.  On the part of general clustering and geo-distributed services, this looks like a more correct solution, but also discussed, on the other hand. </p><br><p>  Unfortunately, all this in theory looks good, but in practice, when there are a lot of botnets on teapots, microwaves and computers of ordinary users, they send spam through regular Outlook (how is it there, still exists on Windows?) - everything is not so great.  But somehow the technique works and you should not refuse it. </p><br><h1 id="praktika">  Practice </h1><br><h2 id="redis-v-rpsamd">  redis in rpsamd </h2><br><p>  We include radish support in rpsamd.  The module of greylisting stores its data in radish. </p><br><pre><code class="hljs pgsql"># /etc/rspamd/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>.d/redis.conf servers = "redis.example.com"; <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> = "example_password";</code> </pre> <br><p>  Run radishes (in docker, for example, this is done by one team). </p><br><h2 id="greylisting-v-rspamd">  greylisting in rspamd </h2><br><p>  Turn on the greylisting module (by default, it is turned off).  expire - the time for which the sender becomes trusted after passing the check.  I specifically twirted more.  The default is 86400 seconds. </p><br><pre> <code class="hljs pgsql"># /etc/rspamd/modules.d/greylist.conf greylist { expire = <span class="hljs-number"><span class="hljs-number">864000</span></span>; .<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>(try=<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>,priority=<span class="hljs-number"><span class="hljs-number">5</span></span>) "${DBDIR}/dynamic/greylist.conf" .<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>(try=<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>,priority=<span class="hljs-number"><span class="hljs-number">1</span></span>,duplicate=merge) "$LOCAL_CONFDIR/local.d/greylist.conf" .<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>(try=<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>,priority=<span class="hljs-number"><span class="hljs-number">10</span></span>) "$LOCAL_CONFDIR/override.d/greylist.conf" }</code> </pre> <br><p>  ‚Üí <a href="https://github.com/kak-tus/docker-rspamd">Example container with rspamd</a> </p><br><h2 id="greylisting-v-opensmtpd">  greylisting in opensmtpd </h2><br><p>  The most ambiguous part of the solution. </p><br><p>  After we sent the letter to the rspamd daemon via the rspamc client (see previous article), the demon on STDOUT responds with the text of the letter with added headers. </p><br><p>  In case greylisting is required, then "X-Spam-Action: soft reject" will be present in the headers.  For good, mta or filters recognize this header and respond to the sender with a temporary error. </p><br><p>  But we have no support for mta or filters.  Therefore, we just do exit 1! </p><br><pre> <code class="hljs vhdl"># .     greylisted=$( cat $mail_file | fgrep <span class="hljs-symbol"><span class="hljs-symbol">'X</span></span>-Spam-Action: soft <span class="hljs-keyword"><span class="hljs-keyword">reject</span></span>' ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -n <span class="hljs-string"><span class="hljs-string">"$greylisted"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> fi</code> </pre><br><p>  opensmtpd, having received return code 1, understands that something went wrong and is responsible for the sender with a temporary error. </p><br><p>  Peculiarities of launching a docker container with opensmtpd: it must be launched in the network mode "host" in order for the daemon to see the correct IP addresses of senders. </p><br><p>  ‚Üí <a href="https://github.com/kak-tus/docker-opensmtpd/tree/master/debian">Example container with opensmtpd</a> </p><br><h1 id="itogo">  Total </h1><br><p>  Even less spam. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/320934/">https://habr.com/ru/post/320934/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320924/index.html">PushAll Auth - user authentication and feedback</a></li>
<li><a href="../320926/index.html">Create anamorphic distortion in Unity</a></li>
<li><a href="../320928/index.html">Pure Python Architecture: A Walkthrough. Part 5</a></li>
<li><a href="../320930/index.html">In the US, are going to turn off the server with 24 years uptime</a></li>
<li><a href="../320932/index.html">Report and materials of the conference MageConf 2016</a></li>
<li><a href="../320936/index.html">Infrastructure simple electronic signature. Part 4: Practical aspects of implementation</a></li>
<li><a href="../320938/index.html">Site protection against hacker attacks - Nemesida Web Application Firewall</a></li>
<li><a href="../320940/index.html">Introduction to error handling in Swift 3</a></li>
<li><a href="../320942/index.html">GitHub introduced tags for repositories</a></li>
<li><a href="../320946/index.html">What I would like to know about promotions and shares, before becoming part of a startup-unicorn</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>