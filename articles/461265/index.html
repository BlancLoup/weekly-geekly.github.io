<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About the abuse of the use of the operating system in projects for microcontrollers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Modern microcontrollers have a fairly large performance and this gives many programmers the opportunity to think in approximately the following vein: ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About the abuse of the use of the operating system in projects for microcontrollers</h1><div class="post__text post__text-html js-mediator-article">  Modern microcontrollers have a fairly large performance and this gives many programmers the opportunity to think in approximately the following vein: - ‚ÄúIt's okay if 1-5% of the performance goes to operating system maintenance.  But my code will be easily debugged and explicit! ‚Äù  These thoughts are supported by a large amount of non-volatile (flash) memory for storing the operating system code and operational (RAM / SRAM) memory for allocating its own stack for each task.  However, in most cases this idea is erroneous.  And in this article I will explain why. <a name="habracut"></a><br><br><h2>  About the projects I work with </h2><br>  In my practice, I often have to work with a ‚Äúdesigner‚Äù.  I described this approach in detail in my previous article on the <a href="https://habr.com/ru/post/461113/">use of C ++ in microcontrollers</a> .  Then I did not tell the most important thing.  Most of the ‚Äúblocks‚Äù of this ‚Äúconstructor‚Äù are somehow tied to a real-time operating system.  Most of the "blocks" have their own flow (task, in terms of the real-time operating system FreeRTOS used).  And that, on average, the project has about 10-15 tasks.  Sometimes this value reaches 35-40. <br><br><h2>  Where so much? </h2><br>  Here is a short list of tasks that are encountered <b>in each</b> project: <ul><li>  ADC maintenance (each module is serviced by its own flow); </li><li>  wdt maintenance (if the OS crashes, the task will not reset it and the device will reboot); </li><li>  work with settings pages (a separate stream controls the work with flash memory); </li><li>  maintenance of the protocol of interaction with the outside world (downstream to the interface. For example, uart); </li></ul><br>  Then there are already specific things for each device, such as a stream for servicing thermistors (receiving data from the ADC measurement stream and converting this data to temperature), polling the external peripherals and so on. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Apparent simplicity </h2><br>  Despite the fact that there are many tasks in the project, each of them is ‚Äúhidden‚Äù inside an object of the corresponding class (remember that the constructor is in C ++, but this can also be imitated in C using ‚Äúprogramming in C in an object-oriented style.‚Äù But <a href="https://habr.com/ru/post/461113/">it‚Äôs better not to necessary</a> ).  Since the objects of this ‚Äúconstructor‚Äù are global and FreeRTOS 9 is used in the projects, which supports the creation of their own entities in buffers allocated by the user, the memory usage can be controlled even at the build stage.  So from the point of view of monitoring memory leaks - everything is more or less normal.  But there are the following nuances: <br><ul><li>  it needs to be clearly understood how much a stack is needed for each thread.  Wherein: <ul><li>  critical cases must be taken into account (for example, nesting with a certain behavior); </li><li>  if functions from standard libraries are used, then also know how they are arranged, or at least have an idea of ‚Äã‚Äãhow much they will consume the stack; </li></ul></li></ul><br>  Apart from this fact, it seems that using the operating system will only improve the logic of the code and make it clearer. <br><br><h2>  Abuse of operating system functionality </h2><br>  The main problems begin at the moment when you begin to forget what you are writing specifically for the microcontroller.  The OS imposes its costs on working with its own entities (such as semaphores, mutexes, queues).  Here is an example of a <a href="">UART class for implementing a terminal function</a> .  In the interrupt, the byte is received, after which, if it passes the range by valid input characters, it is added to the queue with the corresponding replacements (for example, '\ n' changes to the sequence "\ n \ r").  This was done in order to secure the port for sending (since the port can work not only as a terminal. Log data can also be sent through it).  On the one hand, this ensures that the response will be sent as soon as possible and will not interfere with sending more priority data (in addition, while priority data is being sent, it accumulates in the buffer, which allows DMA to be used to send the response).  However, starting from this moment you get on a slippery track.  Instead of writing a bunch through a queue, one could just correctly configure the interruption on a non-empty buffer that is not currently working on the UART and when the DMA ends.  This approach requires a clear understanding of how peripherals work.  However, it reduces costs to an absolute minimum, making the need for such a solution zero. <br><br><h2>  Ignoring the microcontroller hardware functionality </h2><br>  In my practice, I met a project with 18 software timers of the operating system tuned to the same frequency.  At the same time, there were about 10 timers in the microcontroller, of which only systic was used.  To clock the scheduler of the operating system.  This decision was explained by the lack of desire to "mess with the hardware" of the microcontroller.  At the same time, about 10 kb was allocated under the stack for the function called by the software timer.  In fact, about 1 kb was used (short).  This was due to the "ambiguity of what is happening inside the called libraries." <br>  In this case, it was possible to safely select TIM6 (in the case of using stm32f4), which would generate an interrupt with a given frequency and inside it would simply call the required functions. <br><br><h2>  Using an infinite loop instead of a state machine </h2><br>  As a separate column, I would single out the inability of some programmers to write compact finite state machines, and instead create a stream in which there is an infinite loop that starts its work by getting something from the queue.  Interestingly, how to create compact finite state machines by means of the language itself is written in <a href="https://habr.com/ru/post/241941/">this article</a> . <br><br><h2>  Ignoring the "hardware scheduler" </h2><br>  Many thirty-two bit microcontrollers have a sophisticated interrupt controller with a customizable priority system.  In the case of stm32f4, it has the name NVIC, and has the ability to set interrupt priorities with 16 levels (without considering even the sublevels). <br>  Most of the applications under FreeRTOS that I had to deal with could be written as state machines called in interrupts with correctly configured priorities.  And in case the processor returns to "normal execution" - go to "sleep".  In this case, there would be no need to block access to most resources (variables and others).  Applications would lose an extra level of abstraction.  And in this case - far from free.  However, this approach requires thoughtful architecture planning for each project.  In projects, "designers" - all interrupts have one priority and, in fact, are needed in order to "filter" the data.  Then put the leftovers in the queue, from where the object stream of the corresponding class will pick them up. <br><br><h2>  Summary </h2><br>  In this article, I talked about the basic problems that have to be encountered when using the operating system in projects for microcontrollers, and also examined common cases of using the operating system when this could have been avoided without losing the readability and logic of the code. </div><p>Source: <a href="https://habr.com/ru/post/461265/">https://habr.com/ru/post/461265/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../461251/index.html">A selection of useful slides from Julia Evans</a></li>
<li><a href="../461255/index.html">How to shoot yourself in the foot in C and C ++. Haiku OS Recipe Collection</a></li>
<li><a href="../461257/index.html">How to calculate ROI from test automation with Selenium?</a></li>
<li><a href="../461259/index.html">Storage Party, August 8, Moscow</a></li>
<li><a href="../461261/index.html">Checklist of useful RRC webinars on RRC products</a></li>
<li><a href="../461269/index.html">Problem solving with pwnable.kr 08 is leg and 10 is shellshock. ARM assembler. Bash vulnerability</a></li>
<li><a href="../46127/index.html">8 ways to turn a new site visitor into a regular visitor</a></li>
<li><a href="../461271/index.html">How to promote a mobile application in 2019: 4 practical ways + useful tools</a></li>
<li><a href="../461273/index.html">Greedy approach and slot machines. Analysis of the tasks of the ML-track of the programming championship</a></li>
<li><a href="../461277/index.html">Overview of the free SQLIndexManager tool</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>