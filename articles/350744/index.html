<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SSO and Kibana: Kibana integration with integrated Windows authentication (Single Sign-On)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I would like to share a way to configure single sign-on (SSO) in the Elastic Stack, which uses X-Pack to authenticate users and restr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SSO and Kibana: Kibana integration with integrated Windows authentication (Single Sign-On)</h1><div class="post__text post__text-html js-mediator-article"><p>  In this article, I would like to share a way to configure single sign-on (SSO) in the Elastic Stack, which uses X-Pack to authenticate users and restrict access to data. </p><br><p><img src="https://habrastorage.org/webt/lh/na/jr/lhnajrctf5jpyt89ndos1umeid4.png" alt="Stop SSO"></p><a name="habracut"></a><br><p>  I must say that active attempts to configure SSO in Kibana with Active Directory began after reading the article <a href="https://www.elastic.co/blog/user-impersonation-with-x-pack-integrating-third-party-auth-with-kibana">Integrating third party Auth with Kibana</a> .  As always, a simple and working example was given in such blogs, which is suitable for "home use", but not very applicable in enterprises with complex infrastructure.  And only after the release of Elastic Stack v.5.6.2, and more specifically, the <a href="https://www.elastic.co/guide/en/x-pack/5.6/xpack-change-list.html">patch</a> in X-Pack 5.6.2, which finally made it possible to use ‚Äúuser impersonation‚Äù with Active Directory, single sign-on (SSO) earned in full least </p><br><p>  ‚ÄúUser impersonation‚Äù (user impersonation) is a key component in this system, through which one account (for example, technical user) is allowed to send requests on behalf of other, already authenticated users.  In Elastic Stack X-Pack, this function is called <a href="https://www.elastic.co/guide/en/x-pack/current/run-as-privilege.html">run_as</a> . </p><br><p>  To be fair, it should be noted that SSO could have been configured even before this patch - if using LDAP.  But since the LDAP realm in Elasticsearch does not support nested groups, it was not serious to consider this solution. </p><br><h2 id="arhitektura">  Architecture </h2><br><p>  The architecture of the proposed solution will be as follows: </p><br><img src="https://habrastorage.org/webt/8f/o2/79/8fo279_8nr_ralqtnkd-dpw_yas.png"><br><p>  The picture is borrowed in the already mentioned blog, only the names of several components are changed.  I hope that Elastic will not object (if it finds out), and if it does, then you will have to draw your own squares in PPT. </p><br><h2 id="opisanie-raboty">  Description of work </h2><br><ul><li>  Users send a request to a web server (IIS), which authenticates them through the Windows Authenticated mechanism (all other authentication methods are disabled in the configuration of this website). </li><li> If the authentication is successful, then IIS sets the environment variable <code>REMOTE_USER=DOMAIN\user</code> . </li><li>  This variable will be used in the Helicon rewrite extension module to set up an impersonation HTTP header (impersonation header) <code>es-security-runas-user</code> . </li><li>  The Helicon rewrite module also sets the HTTP authentication header (Basic) for the special technical internal user Elasticsearch. </li><li>  A special role in Elasticsearch is used to allow search queries to run <a href="https://www.elastic.co/guide/en/x-pack/current/run-as-privilege.html">on behalf of other users</a> .  Since impersonation should be allowed only for domain users, this role will look something like this: <code>*@domain.name</code> . </li><li>  Configuring <a href="https://www.elastic.co/guide/en/x-pack/current/active-directory-realm.html">AD realm</a> for X-Pack </li><li>  Since user access to indexes will be regulated <strong>only</strong> through AD groups, AD-realm should use the <code>unmapped_groups_as_roles: true</code> .  This means that the name of the AD group will be the name of the role in Elasticsearch (see security and performance <sup><a href="https://habr.com/ru/post/350744/">1</a></sup> below). </li><li>  All users of our system (Kibana), regardless of which indices in Elasticsearch have access to them, should have read and write <code>.kibana</code> index.  So, in AD you need to create a special group, which will include all those users who need to use Kibana.  In addition, in Elasticsearch you need to create a role with the same name and with the rights to modify the <code>.kibana</code> index.  For example, this is what the user configuration of the network equipment administration department will look like: <br><ul><li>  Kibana user: AD-group = ES role = <code>ELK.Users</code> rights to the <code>.kibana*</code> index <code>.kibana*</code> : <br><ul><li>  <code>manage</code> , <code>read</code> , <code>index</code> , <code>delete</code> </li></ul></li><li>  Access to network logs: AD-group = ES role = <code>ELK.Network.Admins</code> rights to <code>net-*</code> indices: <br><ul><li>  <code>read</code> , <code>view_index_metadata</code> </li></ul></li></ul></li></ul><br><h2 id="ustanovka">  Installation </h2><br><ul><li>  Configure TLS on Kibana and Elasticsearch server: <a href="https://www.elastic.co/blog/tls-elastic-stack-elasticsearch-kibana-logstash-filebeat">instruction</a> .  This item is optional, but desirable - it is undignified to offer an authentication system without traffic encryption. </li><li>  Install IIS (Microsoft Internet Information Services) to authenticate users through NTLM.  Since this web server will be used as a proxy and will not perform any other work, you can install IIS on the same server as Kibana. </li><li>  Improving IIS: <br><ul><li>  <a href="https://www.iis.net/downloads/microsoft/application-request-routing">Application Request Routing (ARR)</a> is an extension that allows IIS to work as a load balancer.  In our case, it will be used as a reverse proxy server (reverse proxy). </li><li>  <a href="http://www.helicontech.com/isapi_rewrite/download.html">Helicon ISAPI_Rewrite 3 engine</a> is a third-party module that emulates the operation of the Apache rewrite engine.  It is needed because IIS (at the moment) cannot set the <code>REMOTE_USER</code> variable when using NTLM, since the embedded IIS Rewrite module is called before the user is authenticated. </li></ul></li></ul><br><h2 id="konfiguraciya">  Configuration </h2><br><p>  We start to configure all components (the dream is to write an installer ...). </p><br><h3 id="iis">  IIS </h3><br><ul><li>  SSL setup <br>  The network is full of instructions for configuring SSL / TLS in IIS, for example, <a href="https://docs.microsoft.com/en-us/iis/manage/configuring-security/how-to-set-up-ssl-on-iis">IIS SSL how-to</a> .  But I still list some steps.  Suppose that we already have a PEM certificate, we convert it into PKCS # 12 format for IIS: </li></ul><br><pre> <code class="hljs pgsql">openssl pkcs12 -export -<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.name.pfx -inkey <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.name.key -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.name.crt</code> </pre> <br><ul><li>  Import this certificate into IIS: <br><ul><li>  IIS Manager ‚áí Top level navigation tree ‚áí Server certificates ‚áí Import ... </li></ul></li><li>  We select this certificate in Binding for HTTPS (port 443) in our website: <br><ul><li>  IIS Manager ‚áí Top level navigation tree ‚áí Sites ‚áí Default Web Site ‚áí Bindings ... <br><ul><li>  Configuring reverse proxy for IIS ‚áî Kibana communication (it is assumed that Kibana works locally on the same server and uses its standard port - 5601) </li><li>  IIS Manager ‚áí Top level navigation tree ‚áí Application Request Routing Cache ‚áí Server Proxy Settings ... ‚áí </li></ul></li></ul></li></ul><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Enable</span></span> proxy [x] <span class="hljs-keyword"><span class="hljs-keyword">Reverse</span></span> proxy: localhost:<span class="hljs-number"><span class="hljs-number">5601</span></span></code> </pre> <br><ul><li>  Certificate Authority Certificate Kibana <br>  If it happens that the Kibana certificate is signed by an "unfamiliar" CA (not from the organization's PKI), then this CA must be added to the "Trusted Root Certification Authorities" on the server with IIS: <br><ul><li>  Call <code>mmc</code> (with administrator rights) ‚áí Add or Remove Snap-ins ‚áí Certificates ‚áí Add ‚áí Computer account ‚áí Local computer ‚áí Certificates (Local computer) ‚áí Trusted Root Certification Authorities ‚áí Certificate ‚áí import CA.crt </li></ul></li></ul><br><h3 id="helicon-rewrite-engine">  Helicon Rewrite engine </h3><br><p>  By default, the module is installed in <code>C:\Program Files</code> . <br>  Add the following to the configuration file <code>C:\Program Files\Helicon\ISAPI_Rewrite3\httpd.conf</code> : </p><br><pre> <code class="hljs apache"><span class="hljs-attribute"><span class="hljs-nomarkup"><span class="hljs-attribute"><span class="hljs-nomarkup">RewriteEngine</span></span></span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span> RewriteCond <span class="hljs-variable"><span class="hljs-variable">%{REMOTE_USER}</span></span> (.*)\\(.*) RewriteHeader es-security-runas-user: .* (<span class="hljs-number"><span class="hljs-number">%2</span></span>)(@company.com) RewriteHeader Authorization: .* (Basic\ aWlzOnNlY3JldHBhc3N3b3Jk) RewriteRule ^/logout /<span class="hljs-meta"><span class="hljs-meta"> [R,L]</span></span></code> </pre> <br><p>  How it works: </p><br><ul><li>  after the user is authenticated, his login <code>DOMAIN\user</code> converted by the module into the <code>userPrincipalName</code> format ( <code>user@company.com</code> ) and sent to Kibana by the new HTTP header <code>es-security-runas-user</code> </li><li>  Add another HTTP header for Basic authentication, where the <code>aWlzOnNlY3JldHBhc3N3b3Jk</code> value is the base64-encoded technical user login: <code>iis:secretpassword</code> (we will create it in Elasticsearch a bit later). </li><li>  Well, if the user clicks on <code>/logout</code> , we will simply redirect him to the Kibana start page, where he again automatically <code>/logout</code> </li></ul><br><h3 id="kibana">  Kibana </h3><br><p>  For SSO, add the following parameters to <code>kibana.yml</code> : </p><br><pre> <code class="hljs pgsql">elasticsearch.requestHeadersWhitelist: [ es-<span class="hljs-keyword"><span class="hljs-keyword">security</span></span>-runas-<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">authorization</span></span> ] xpack.monitoring.elasticsearch.requestHeadersWhitelist: [ es-<span class="hljs-keyword"><span class="hljs-keyword">security</span></span>-runas-<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">authorization</span></span> ]</code> </pre> <br><h3 id="elasticsearch">  Elasticsearch </h3><br><p>  X-Pack is already installed, configuring AD in <code>elasticsearch.yml</code> : </p><br><pre> <code class="hljs pgsql">xpack: <span class="hljs-keyword"><span class="hljs-keyword">security</span></span>: authc: realms: native_realm: <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: native <span class="hljs-keyword"><span class="hljs-keyword">order</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> company_ad_realm: enabled: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: active_directory <span class="hljs-keyword"><span class="hljs-keyword">order</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> domain_name: company.com user_search: base_dn: "DC=company,DC=com" group_search: base_dn: "DC=company,DC=com" url: ldaps://<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.company.com:<span class="hljs-number"><span class="hljs-number">636</span></span> ssl.verification_mode: <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> bind_dn: "CN=user,OU=People,DC=company,DC=com" bind_password: "XXXXXXXXXX" unmapped_groups_as_roles: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span>.ttl: <span class="hljs-number"><span class="hljs-number">300</span></span>s</code> </pre> <br><p>  The user specified in <code>bind_dn</code> must have rights to connect and search in AD. <br>  AD certificate verification is disabled ( <code>ssl.verification_mode: none</code> ) because the CA (CA) AD is not specified (parameter: <code>ssl.certificate_authorities</code> ). </p><br><p>  Create a technical user ( <code>iis</code> ) in Elasticsearch and a role (also <code>iis</code> ) for impersonization ("user impersonation" sounds even worse): </p><br><p> <code>POST _xpack/security/role/iis</code> </p> <br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"run_as"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"*@company.com"</span></span> ] }</code> </pre> <br><p> <code>POST _xpack/security/user/iis</code> </p> <br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"secretpassword"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"roles"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"iis"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"full_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Service Account for IIS reverse proxy"</span></span> }</code> </pre> <br><p>  Now we create a role for all Kibana users.  Let me remind you - the name of the role should be the name of a group in AD, whose members will have access to Kibane (let this group be called "ELK.Users"): </p><br><p> <code>POST _xpack/security/role/ELK.Users</code> </p> <br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"indices"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"names"</span></span>: [ <span class="hljs-string"><span class="hljs-string">".kibana*"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"privileges"</span></span>: [<span class="hljs-string"><span class="hljs-string">"read"</span></span>, <span class="hljs-string"><span class="hljs-string">"manage"</span></span>, <span class="hljs-string"><span class="hljs-string">"index"</span></span>, <span class="hljs-string"><span class="hljs-string">"delete"</span></span>] } ] }</code> </pre> <br><p>  Kibana stores all settings in a single index ( <code>.kibana</code> or <code>.kibana-6</code> ), so all Kibana users must have read and write access to this index. </p><br><p>  Now, for example, let's create a role whose members will have access to <code>net-*</code> indices that store data from network devices: </p><br><p> <code>POST _xpack/security/role/ELK.Network.Admins</code> </p> <br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"indices"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"names"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"net-*"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"privileges"</span></span>: [<span class="hljs-string"><span class="hljs-string">"read"</span></span>, <span class="hljs-string"><span class="hljs-string">"view_index_metadata"</span></span>] } ] }</code> </pre> <br><p>  Another example is the "custom" super-user role for the administrators of Elasticsearch <sup><a href="https://habr.com/ru/post/350744/">2</a></sup> : </p><br><p> <code>POST _xpack/security/role/ELK.Admins</code> </p> <br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"cluster"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"all"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"indices"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"names"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"*"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"privileges"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"all"</span></span> ] } ] }</code> </pre> <br><p>  Thus, members of the AD-group "ELK.Admins" get full access to the Elasticsearch cluster. </p><br><h3 id="rezultat">  Result </h3><br><p>  Turn on and wonder!  You can forget about entering a login. </p><br><p><img src="https://habrastorage.org/webt/qk/p2/7f/qkp27f5jjsomuvpgfxqkbmszrjg.png"></p><br><p>  When opening the root page of our IIS-proxy site, the user was successfully authenticated. <br>  Note: if this user has access only to the <code>net-*</code> index <code>net-*</code> , then he will still see all the configured indexes in Kibana - pay attention to the drop-down list.  But when selecting the indexes to which it does not have access, the user will see <strong>No results found</strong> .  But this problem has nothing to do with SSO. </p><br><h3 id="chto-to-poshlo-ne-tak">  "Something went wrong" </h3><br><p>  Testing and troubleshooting. </p><br><p>  <strong>Case 1</strong> : The user (or his group) was forgotten to add "Kibana users" ( <code>ELK.Users</code> ) to the AD group, or he should not have access to the Kibana at all: </p><br><pre> <code class="hljs sql">Config: Error 403 Forbidden: action [indices:data/write/<span class="hljs-keyword"><span class="hljs-keyword">update</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> unauthorized <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> [iis] run <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>@company.com]: [security_exception] <span class="hljs-keyword"><span class="hljs-keyword">action</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">indices</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>/write/<span class="hljs-keyword"><span class="hljs-keyword">update</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> unauthorized <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> [iis] run <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ...</code> </pre> <br><p><img src="https://habrastorage.org/webt/xx/wu/dl/xxwudliz0pmz_of25gxwsrhxau8.png" alt="Error 403 Forbidden"></p><br><p>  The user was successfully authenticated by IIS (NTLM, Kerberos, etc.) and authenticated by the technical user <code>iis</code> in Kibane.  But since  Since the real <code>user@company.com</code> account is not in the Kibana lovers AD group, it does not have a write / read role in the <code>.kibana</code> index in <code>.kibana</code> . <br>  I do not know how to make the message or the page "access denied" more "friendly." </p><br><p>  <strong>Case 2</strong> : IIS uses SSL in the proxy module configuration (the "Enable SSL offloading" option is disabled, as intended), and in Kiban they forgot to configure HTTPS.  Then we can observe the following in <code>kibana.log</code> : </p><br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"log"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"@timestamp"</span></span>:<span class="hljs-string"><span class="hljs-string">"2017-10-03T15:11:32Z"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"tags"</span></span>:[<span class="hljs-string"><span class="hljs-string">"connection"</span></span>,<span class="hljs-string"><span class="hljs-string">"client"</span></span>,<span class="hljs-string"><span class="hljs-string">"error"</span></span>],<span class="hljs-attr"><span class="hljs-attr">"pid"</span></span>:<span class="hljs-number"><span class="hljs-number">10416</span></span>,<span class="hljs-attr"><span class="hljs-attr">"level"</span></span>:<span class="hljs-string"><span class="hljs-string">"error"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"message"</span></span>:<span class="hljs-string"><span class="hljs-string">"Parse Error"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"error"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"message"</span></span>:<span class="hljs-string"><span class="hljs-string">"Parse Error"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"Error"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"stack"</span></span>:<span class="hljs-string"><span class="hljs-string">"Error: Parse Error\n at Error (native)"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"code"</span></span>:<span class="hljs-string"><span class="hljs-string">"HPE_INVALID_METHOD"</span></span>}}</code> </pre> <br><p>  <strong>Case 3</strong> : The Kibana Certificate Authority Certificate Authority unknown to IIS <br>  Open the IIS-Kibana start page: </p><br><pre> <code class="hljs vbscript">HTTP <span class="hljs-keyword"><span class="hljs-keyword">Error</span></span> <span class="hljs-number"><span class="hljs-number">502.3</span></span> - Bad Gateway A security <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> occurred</code> </pre> <br><p>  and the corresponding error in the Kibana log: </p><br><pre> <code class="hljs objectivec"><span class="hljs-string"><span class="hljs-string">"code"</span></span>:<span class="hljs-string"><span class="hljs-string">"ECONNRESET"</span></span> <span class="hljs-string"><span class="hljs-string">"message"</span></span>:<span class="hljs-string"><span class="hljs-string">"socket hang up"</span></span></code> </pre> <br><p>  <strong>Case 4</strong> : <em>Windows authentication is</em> not enabled for our website. <br>  Then users will be authenticated in Kibana as <code>iis</code> user: "Service Account for IIS reverse proxy" </p><br><p>  <strong>Test 1</strong> : Is everything OK with AD / LDAP?  And how are things going with the membership? <br>  We use <code>ldapsearch</code> or <code>adfind</code> - in every possible way I recommend downloading <a href="http://www.joeware.net/freetools/tools/adfind/">here.</a> </p><br><pre> <code class="hljs pgsql">ldapsearch -h <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.company.com -b "DC=company,DC=com" -D "CN=user,OU=People,DC=company,DC=com" -w "XXXXXXX" samaccountname=<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> adfind -f "userprincipalname=user@company.com"</code> </pre> <br><p>  <strong>Test 2</strong> : We are testing impersonation </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">curl</span></span> -k -v -u iis:secretpassword -H <span class="hljs-string"><span class="hljs-string">"es-security-runas-user: user</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">@company</span></span></span><span class="hljs-string">.com"</span></span> https://elastic-server:9200/.kibana/_search</code> </pre> <br><p>  If this test is passed ( <code>HTTP/1.1 200 OK</code> ), then Elasticsearch is configured correctly, and can check the user's rights in AD. <br>  Well, if we get something like: </p><br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"error"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"root_cause"</span></span>:[{<span class="hljs-attr"><span class="hljs-attr">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"security_exception"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"reason"</span></span>:<span class="hljs-string"><span class="hljs-string">"action [indices:data/read/search] is unauthorized for user [iis] run as [user@company.com]"</span></span>}],<span class="hljs-attr"><span class="hljs-attr">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"security_exception"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"reason"</span></span>:<span class="hljs-string"><span class="hljs-string">"action [indices:data/read/search] is unauthorized for user [iis] run as [user@company.com]"</span></span>},<span class="hljs-attr"><span class="hljs-attr">"status"</span></span>:<span class="hljs-number"><span class="hljs-number">403</span></span>}</code> </pre> <br><p>  This is the time to enable debugging and read Elasticsearch logs: <br> <code>PUT /_cluster/settings</code> </p> <br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"transient"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"logger.org.elasticsearch.xpack.security.authc"</span></span>: <span class="hljs-string"><span class="hljs-string">"trace"</span></span> } }</code> </pre> <br><p>  <strong>Test 3</strong> : Change user membership in AD and, so that Elasticsearch does not expect cache invalidation, manually clear the latter </p><br><pre> <code class="hljs pgsql">curl -k -u <span class="hljs-string"><span class="hljs-string">'elastic:changeme'</span></span> -X POST https://elastic-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>:<span class="hljs-number"><span class="hljs-number">9200</span></span>/_xpack/<span class="hljs-keyword"><span class="hljs-keyword">security</span></span>/realm/company_ad_realm/_clear_cache</code> </pre> <br><p>  Note: <code>elastic</code> is a built-in user with a default password (in version 5.x) or changed to the same (version 6.x). </p><br><h3 id="to-dos">  To-dos </h3><br><ul><li>  Create a ‚ÄúFriendly‚Äù Page When ‚ÄúInternal Server Error‚Äù Occurs <br>  If Elasticsearch cannot verify the user, for any reason (for example, there is no connection to AD), then Kibana will display the following JSON page: </li></ul><br><pre> <code class="hljs vbscript">{ statusCode: <span class="hljs-number"><span class="hljs-number">500</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">error</span></span>: Internal <span class="hljs-built_in"><span class="hljs-built_in">Server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Error</span></span>, message: An internal <span class="hljs-built_in"><span class="hljs-built_in">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> occurred }</code> </pre> <br><p>  In principle, it is possible in the same Helicon Rewrite to write a redirect when this error appears on the custom page, which can be placed in: </p><br><pre> <code class="hljs tex">&lt;kibana-home&gt;<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">optimize</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bundles</span></span></span></span></code> </pre> <br><p>  The page will be available at: </p><br><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/localhost/bundles</span></span><span class="hljs-regexp"><span class="hljs-regexp">/custom/error</span></span>.htm</code> </pre> <br><h3 id="spasibo-za-vnimanie">  Thanks for attention! </h3><br><p>  I hope that now in your organization the level of "user experience" and other "satisfaction" will be even greater! </p><br><hr><br><p>  <b>[1]</b> The following safety and performance considerations should be taken into account when using <code>unmapped_groups_as_roles: true</code> </p><br><ul><li>  The AD administrator theoretically gets full access to the ES cluster: when you create a group in AD called <code>superuser</code> and add your account to it, the administrator becomes a super-user of the cluster, because  The <code>superuser</code> role is built-in and cannot be disabled or removed.  The same will be true for other built-in roles: <code>logstash_admin</code> , <code>machine_learning_admin</code> , etc.  I can‚Äôt offer any kind of work rounds, just an AD audit. </li><li>  You must carefully plan and comply with the group naming convention in AD (naming convention) to avoid unauthorized access to data.  Use prefixes (suffixes) in group names to access the ES cluster, for example, <code>ELK.*</code> . </li><li>  Elasticsearch will check each user group, according to its role in the cluster.  With a large number of groups in which the user is included, this check will affect performance.  In large organizations, where users have hundreds, or even thousands of groups, this can be a problem.  But forewarned is forearmed.  In addition, Elasticsearch caches groups and does not access AD on every search request; see the <code>cache.ttl</code> parameter. </li></ul><br><p>  If you nevertheless decided not to use this automatic mapping through AD-groups for the reasons described above, then you will have to display the groups in the role either through files or through the <a href="https://www.elastic.co/guide/en/x-pack/current/mapping-roles.html">API</a> .  <a href="https://habr.com/ru/post/350744/">‚Ü©</a> </p><br><p>  <b>[2]</b> It is not recommended to create such a super-user role in products.  It is better to administer in the old manner - with the super-user <code>elastic</code> and through <code>curl</code> .  <a href="https://habr.com/ru/post/350744/">‚Ü©</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/350744/">https://habr.com/ru/post/350744/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350732/index.html">Solve problems without self-balancing trees in Python</a></li>
<li><a href="../350734/index.html">As I wrote my VNC, and then no</a></li>
<li><a href="../350738/index.html">802.11ax - details (webinar, english)</a></li>
<li><a href="../350740/index.html">Create your cryptocics (Part 1)</a></li>
<li><a href="../350742/index.html">Optimization of the code in the mind, or "Well, just as definitely faster"</a></li>
<li><a href="../350746/index.html">Swift vs. Kotlin. Differences are important</a></li>
<li><a href="../350748/index.html">How not to become a Python-developer</a></li>
<li><a href="../350750/index.html">How to write a one-page application (SPA) using Vue.js</a></li>
<li><a href="../350752/index.html">FastTrack Training. "Network Basics". "The structure of routers, routing platforms from Cisco." Eddie Martin December 2012</a></li>
<li><a href="../350754/index.html">SIP <-> Telegram: sip.tg</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>