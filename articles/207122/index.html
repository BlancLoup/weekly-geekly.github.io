<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A kosher way to modify write-protected areas of the Linux kernel</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Those who have ever encountered the need to change something in the kernel on the fly know firsthand that this issue requires detailed study, because ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A kosher way to modify write-protected areas of the Linux kernel</h1><div class="post__text post__text-html js-mediator-article">  Those who have ever encountered the need to change something in the kernel on the fly know firsthand that this issue requires detailed study, because the kernel memory pages that store code and some data are marked as ‚Äúread-only‚Äù and are protected from writing! <br><br>  For x86, the known solution is to temporarily disable page protection by resetting the WP register's CR0 bit.  But it should be used with caution, because page protection is the basis for many core mechanisms.  In addition, it is necessary to take into account the peculiarities of work on SMP systems, when various unpleasant situations are possible. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Disable paging protection </h4><br><br>  In the x86 architecture, there is a special protection mechanism, according to which an attempt to write to write-protected memory areas can lead to an exception being thrown.  This mechanism is called "page protection" and is the base for the implementation of many functions of the kernel, such as <a href="http://en.wikipedia.org/wiki/Copy-on-write">COW</a> .  The behavior of the processor in this situation is determined by the WP register's CR0 bit, and page access permissions are described in the corresponding PTE descriptor structure.  When the WP register CR0 bit is set, an attempt to write to write-protected pages (the RW bit is reset in PTE) leads to the processor generating the corresponding exception (#GP). <br><br>  The simplest solution to this problem is to temporarily disable page protection by resetting the WP register's CR0 bit.  This solution is the place to be, but it should be used with caution, because, as noted, the paging mechanism is the basis for many core mechanisms.  In addition, on SMP systems, a thread running on one of the processors and removing the WP bit in the same place can be interrupted and moved to another processor! <br><br>  However, if you really want to, you need to do this by turning off the <a href="http://en.wikipedia.org/wiki/Preemption_(computing)">preemption</a> , as recommended <a href="http://vulnfactory.org/blog/2011/08/12/wp-safe-or-not/">here</a> : <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">unsigned</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native_pax_open_kernel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> cr0; preempt_disable(); barrier(); cr0 = read_cr0() ^ X86_CR0_WP; BUG_ON(unlikely(cr0 &amp; X86_CR0_WP)); write_cr0(cr0); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cr0 ^ X86_CR0_WP; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">unsigned</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native_pax_close_kernel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> cr0; cr0 = read_cr0() ^ X86_CR0_WP; BUG_ON(unlikely(!(cr0 &amp; X86_CR0_WP))); write_cr0(cr0); barrier(); preempt_enable_no_resched(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cr0 ^ X86_CR0_WP; }</code> </pre> <br><br><h4>  Use mappings </h4><br><br>  A better and sufficiently universal way to create temporary mappings.  Due to the nature of the MMU, several descriptors referring to it with different attributes can be created for each physical memory frame.  This allows you to create a writeable mapping for the target memory area.  This method is used in the <a href="http://www.ksplice.com/">Ksplice</a> project ( <a href="https://github.com/jirislaby/ksplice">fork</a> on github'e).  Below is the <a href="">map_writable</a> function, which creates such a mapping: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * map_writable creates a shadow page mapping of the range * [addr, addr + len) so that we can write to code mapped read-only. * * It is similar to a generalized version of x86's text_poke. But * because one cannot use vmalloc/vfree() inside stop_machine, we use * map_writable to map the pages before stop_machine, then use the * mapping inside stop_machine, and unmap the pages afterwards. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">map_writable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *addr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *vaddr; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nr_pages = DIV_ROUND_UP(offset_in_page(addr) + len, PAGE_SIZE); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">page</span></span></span><span class="hljs-class"> **</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pages</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">kmalloc</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nr_pages</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sizeof</span></span></span><span class="hljs-class">(*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pages</span></span></span><span class="hljs-class">), </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GFP_KERNEL</span></span></span><span class="hljs-class">);</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *page_addr = (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *)((<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)addr &amp; PAGE_MASK); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pages == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nr_pages; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (__module_address((<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)page_addr) == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { pages[i] = virt_to_page(page_addr); WARN_ON(!PageReserved(pages[i])); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { pages[i] = vmalloc_to_page(page_addr); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pages[i] == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { kfree(pages); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; } page_addr += PAGE_SIZE; } vaddr = vmap(pages, nr_pages, VM_MAP, PAGE_KERNEL); kfree(pages); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (vaddr == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> vaddr + offset_in_page(addr); }</code> </pre><br><br>  Using this function will create a recordable display for any area of ‚Äã‚Äãmemory.  The release of the region created in this way is performed using the <a href="">vfree</a> function, the argument of which should be the address value aligned to the page boundary. <br><br><h4>  Stop the car! </h4><br><br>  The last element to make the modification of the kernel code safe is the <a href="">stop_machine</a> mechanism: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;linux/stop_machine.h&gt; int stop_machine(int (*fn)(void *), void *data, const struct cpumask *cpus)</span></span></span></span></code> </pre><br><br>  The bottom line is that <code>stop_machine</code> executes the <code>fn</code> function with a given set of processors active at the time of execution, which is set by the corresponding <code>cpumask</code> mask.  This is exactly what allows using this mechanism for modifying the kernel code, since  setting the appropriate mask automatically eliminates the need to keep track of those kernel threads, the execution of which may affect the modified code. <br><br>  Among the limitations of <code>stop_machine</code> it is worth noting that the function being executed must work in atomic context, which automatically excludes the possibility of using the previously described mechanism for creating temporary mappings via <a href="">vmap</a> .  However, this circumstance is not significant, because the required mappings can be prepared before calling <code>stop_machine</code> . </div><p>Source: <a href="https://habr.com/ru/post/207122/">https://habr.com/ru/post/207122/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../207108/index.html">Fukami, part 1.1: We bring the scene to the theme of the project</a></li>
<li><a href="../207110/index.html">Peewee - easy, flexible and very fast ORM in Python</a></li>
<li><a href="../207116/index.html">Autodesk Simulation CFD 2014 Quick Start Guide</a></li>
<li><a href="../207118/index.html">iTunes - the payment system of the future?</a></li>
<li><a href="../207120/index.html">New trends in cryptocurrencies: 100% proof-of-stake and Nxt</a></li>
<li><a href="../207124/index.html">Yandex.Disk congratulates the new year</a></li>
<li><a href="../207126/index.html">Zoo of Algebraic Data Types</a></li>
<li><a href="../207130/index.html">LEDs in the snow</a></li>
<li><a href="../207132/index.html">10 new commercials from Trailer Studio</a></li>
<li><a href="../207134/index.html">Who, when and how is going to fly to Mars</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>