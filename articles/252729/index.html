<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mikrotik: script to switch to the Internet backup channel</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share my script for switching to the backup Internet when the main one disappears, and return to the main one as soon as it starts working a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mikrotik: script to switch to the Internet backup channel</h1><div class="post__text post__text-html js-mediator-article">  I want to share my script for switching to the backup Internet when the main one disappears, and return to the main one as soon as it starts working again.  I‚Äôll say right away that channels are available one by one, there will be no load-balance here.  Both channels are PPP connections (in my case one is wired, the second is a 3G whistle).  The script is made specifically as the most flexible monitoring tool, since other options, in particular check-gateway, are not entirely correct for me. <br><a name="habracut"></a><br>  The basic principle is simple: a raised VPN channel does not mean that the Internet works through it.  I check by pinging several external addresses.  You can think up when the pings are not an indicator of the work, but I omit these cases, in the script you can specify any other way of checking, under the situation.  Other features: backup channel - a mobile network, and it connects only in the absence of the main channel, the rest of the time the interface is turned off.  When returning back to the main channel, its operability is checked correctly.  A method other than pinging with an interface.  Well, the route distance at the interfaces changes dynamically and is always not equal, which allows simultaneous operation of the channels, but the traffic is sent only to one of them. <br><br>  If you understand, you can easily alter the script, if the providers, or one of them, gives static. <br><br>  So, I will consistently describe what setting is needed for the script to work, and then I will describe the main points of the work in pieces.  At the end there will be a whole script. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Suppose there are 2 PPP connections: ISP1 is the primary and ISP2 is a backup, both are configured and work separately.  We set <i>dial-on-demand = no</i> and <i>add-default-route = yes on them</i> , then set the <i>default-route-distance</i> parameter for ISP2 to be one more than for ISP1.  We configure standard things like NAT, labeling packets and response connections using the same interface where the request came from, routes for tagged packets: <br><br><div class="spoiler">  <b class="spoiler_title">Training</b> <div class="spoiler_text"><pre><code class="bash hljs">/ip firewall mangle add action=mark-connection chain=forward connection-mark=no-mark \ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP1 new-connection-mark=ISP1 passthrough=no add action=mark-routing chain=prerouting connection-mark=ISP1 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=\ bridge-local new-routing-mark=to_ISP1 passthrough=no add action=mark-connection chain=forward connection-mark=no-mark \ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP2 new-connection-mark=ISP2 passthrough=no add action=mark-routing chain=prerouting connection-mark=ISP2 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=\ bridge-local new-routing-mark=to_ISP2 passthrough=no /ip firewall nat add action=masquerade chain=srcnat out-interface=ISP1 add action=masquerade chain=srcnat out-interface=ISP2 /ip route add distance=1 gateway=ISP1 routing-mark=to_ISP1 add distance=1 gateway=ISP2 routing-mark=to_ISP2</code> </pre> </div></div><br>  Also assume that the local address of the router is 192.168.xx.yy, and the subnet is 192.168.xx.0 / 24.  This data, like the interface names, needs to be changed to its own.  This is not the whole setting, but about everything in order. <br><br><div class="spoiler">  <b class="spoiler_title">Variables</b> <div class="spoiler_text"><pre> <code class="bash hljs">global FailoverTimes; global FailoverLastTime; global FailoverLastBackTime; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> ifMain <span class="hljs-string"><span class="hljs-string">"ISP1"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> ifRes <span class="hljs-string"><span class="hljs-string">"ISP2"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> scriptName <span class="hljs-string"><span class="hljs-string">"Failover"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> state 0; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> pingNum 0; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> pingRes; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> routeDist; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> routeDist2; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> tmp; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> ip { xxxx; yyyy; zzzz }; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> pingSrcAddr 192.168.xx.yy;</code> </pre></div></div><br>  We define variables: we write the names of the interfaces in <i>ifMain</i> and <i>ifRes</i> , the local address of the router in <i>pingSrcAddr</i> (it will be clear later why it is needed), and 3 external addresses that will be pinged to check the channel in the <i>ip</i> array. <br><br><div class="spoiler">  <b class="spoiler_title">Single instance</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [len [/system script job find <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> script=<span class="hljs-variable"><span class="hljs-variable">$scriptName</span></span>]] &gt; 1) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { error <span class="hljs-string"><span class="hljs-string">"single instance"</span></span> }; delay 15;</code> </pre></div></div><br>  Let us run only one copy of the script.  Delay in case of launch at the start of RouterOS, we give time to climb connections. <br><br>  Skip a bit, and move on to the main part.  The script works endlessly, or rather, until it is stopped or an error occurs.  In an infinite loop, it analyzes the current state of the state variable and performs the necessary actions.  Consider them. <br><br><div class="spoiler">  <b class="spoiler_title">State 0</b> <div class="spoiler_text"><pre> <code class="bash hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 0) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingNum</span></span> &gt;= 3) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingNum</span></span> 0; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([ping (<span class="hljs-variable"><span class="hljs-variable">$ip</span></span>-&gt;<span class="hljs-variable"><span class="hljs-variable">$pingNum</span></span>) count=1] = 0) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span> [ping (<span class="hljs-variable"><span class="hljs-variable">$ip</span></span>-&gt;0) count=2]; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span>+[ping (<span class="hljs-variable"><span class="hljs-variable">$ip</span></span>-&gt;1) count=2]); <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span>+[ping (<span class="hljs-variable"><span class="hljs-variable">$ip</span></span>-&gt;2) count=2]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span> = 0) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$FailoverLastTime</span></span> <span class="hljs-string"><span class="hljs-string">"$[/system clock get date] $[/system clock get time]"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$FailoverTimes</span></span> ([tonum <span class="hljs-variable"><span class="hljs-variable">$FailoverTimes</span></span>] + 1) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 1; <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> info <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$scriptName</span></span></span><span class="hljs-string">: state changed 0-&gt;1"</span></span>; } } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingNum</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingNum</span></span> + 1); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 0) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { delay 15 }; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 0); }</code> </pre></div></div><br>  State 0 - when the main channel is running.  Once every 15 seconds, we check one of the three specified addresses in sequence; if there is no answer, we check all 3 addresses.  Deaf - we initiate the transition to the backup channel.  It is strictly stated that the addresses in the array are 3. If this is not the case, you will have to correct it. <br><br><div class="spoiler">  <b class="spoiler_title">State 1</b> <div class="spoiler_text"><pre> <code class="bash hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 1) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [/interface l2tp-client get <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span> default-route-distance] &gt; 10) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { /interface ppp-client <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$ifRes</span></span> default-route-distance=1; } /interface <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> <span class="hljs-variable"><span class="hljs-variable">$ifRes</span></span>; beep frequency=2000 length=250ms; delay 500ms; beep frequency=2000 length=250ms; delay 500ms; delay 6; /interface <span class="hljs-built_in"><span class="hljs-built_in">disable</span></span> <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$routeDist</span></span> ([/interface ppp-client get <span class="hljs-variable"><span class="hljs-variable">$ifRes</span></span> default-route-distance] + 1); /interface l2tp-client <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span> default-route-distance=<span class="hljs-variable"><span class="hljs-variable">$routeDist</span></span>; /interface <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 2; <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> info <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$scriptName</span></span></span><span class="hljs-string">: state changed 1-&gt;2"</span></span>; }</code> </pre></div></div><br>  State 1 - switching channels.  It is important here which PPP connections are used.  In the example, ISP1 is l2tp-client, and ISP2 is ppp-client.  If others, you need to correct them in lines with the <i>default-route-distance</i> . <br><br>  After switching on the backup channel, we wait 7 seconds.  This is enough time for me, for which the 3G connection rises.  During this time, the current connections and new ones hang out in timeouts, while the main VPN has not yet broken, and the answers of the router like dest unreachable are minimized. <br><br>  Sound indication to an amateur, maybe even work at night.  If you do not need - we remove. <br><br>  Further, the main channel is disabled, its <i>default-route-distance is</i> set to 1 more than the backup channel, and it is turned back on.  Due to this, we have the opportunity to wait for the return of the main channel without interfering with the work of the Internet through the reserve. <br><br>  Looking ahead, when switching back to the main channel and disconnecting the reserve, its <i>default-route-distance</i> will increase again by 1. With each switch, the route distance of PPP connections increases sequentially.  In order for them not to go too far, the current value is checked here and a reset to 1 occurs when 10 is exceeded (the figure does not matter, taken for example, theoretically a maximum of about 250). <br><br><div class="spoiler">  <b class="spoiler_title">State 2</b> <div class="spoiler_text"><pre> <code class="bash hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 2) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [len [interface find <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> name=<span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span> and running] ] = 1) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span> [ping (<span class="hljs-variable"><span class="hljs-variable">$ip</span></span>-&gt;0) src-address=<span class="hljs-variable"><span class="hljs-variable">$pingSrcAddr</span></span> count=2]; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span>+[ping (<span class="hljs-variable"><span class="hljs-variable">$ip</span></span>-&gt;1) src-address=<span class="hljs-variable"><span class="hljs-variable">$pingSrcAddr</span></span> count=2]); <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span>+[ping (<span class="hljs-variable"><span class="hljs-variable">$ip</span></span>-&gt;2) src-address=<span class="hljs-variable"><span class="hljs-variable">$pingSrcAddr</span></span> count=2]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span> &gt; 0) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 3; <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> info <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$scriptName</span></span></span><span class="hljs-string">: state changed 2-&gt;3"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 2) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { delay 15 }; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 2); }</code> </pre></div></div><br>  State 2 - waiting for the restoration of the main channel.  It is worth noting that the state of the reserve is not interesting.  If he has not connected, nothing can be done, all the conditions for him are created, and in fact we are only interested in the main channel. <br><br>  It is expected to raise the VPN of the main channel, and then through it with an active reserve, attempts are made to ping external addresses.  Made it complicated, but correct.  If you write <i>ping xx.xx.xx.xx interface = $ ifMain</i> , then according to the developers, this may or may not work.  It uses ping from the local address of the router.  It is assumed that it is always there, otherwise why the router is needed.  I did not use the external address of the main channel, because the provider gives it a dynamic one.  We understand how to tell the router to send such pings through the main channel, even when its route is inactive (route distance is longer than the backup): <br><br><div class="spoiler">  <b class="spoiler_title">Donastroyka</b> <div class="spoiler_text"><pre> <code class="bash hljs">/ip firewall mangle add action=mark-routing chain=output comment=Failover_script_rule \ dst-address=!192.168.xx.0/24 new-routing-mark=to_ISP1 passthrough=no \ protocol=icmp src-address=192.168.xx.yy /ip route rule add action=lookup-only-in-table routing-mark=to_ISP1 src-address=\ 192.168.xx.yy/32 table=to_ISP1</code> </pre></div></div><br>  The ping traffic used here is non-standard.  This is the output traffic coming from the router itself to the external address.  Usually, in such cases, the <i>src-address of the</i> router takes the address of the interface at which the packet leaves.  By specifying the local address of the router as a <i>src-address</i> , we sort of place it for the same NAT behind which there is a local boot.  Further, such traffic is marked with the <i>routing-mark of the</i> main channel, and the packets go through the main channel at the expense of the route with a label. <br><br>  The second rule is also necessary.  Without it, if the main channel suddenly falls again, then the pings, even marked <i>to_ISP1</i> , will follow the route without a backup channel label, which will result in an incorrect return to the main channel.  This is how RouterOS works, if a channel is not connected, then routes, even those marked, are disabled.  To make it a little clearer, imagine that <i>state</i> = 2, the main channel is raised, but traffic does not go through it.  A ping in this case will take 6 seconds.  So if at this time the main channel is turned off, then the pings will begin to pass through the reserve.  The second rule excludes this. <br><br>  We note that pings to LAN from the router are not marked and work as usual. <br><br><div class="spoiler">  <b class="spoiler_title">State 3</b> <div class="spoiler_text"><pre> <code class="bash hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 3) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { /interface <span class="hljs-built_in"><span class="hljs-built_in">disable</span></span> <span class="hljs-variable"><span class="hljs-variable">$ifRes</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$routeDist</span></span> ([/interface l2tp-client get <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span> default-route-distance] + 1); /interface ppp-client <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$ifRes</span></span> default-route-distance=<span class="hljs-variable"><span class="hljs-variable">$routeDist</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 0; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$FailoverLastBackTime</span></span> <span class="hljs-string"><span class="hljs-string">"$[/system clock get date] $[/system clock get time]"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> info <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$scriptName</span></span></span><span class="hljs-string">: state changed 3-&gt;0"</span></span>; beep frequency=500 length=500ms; }</code> </pre></div></div><br>  State 3 - transition to the main channel.  After the pings on the main channel have started to pass, it is enough to turn off the backup VPN and the main one will be used.  Next, we change the <i>default-route-distance of</i> the backup one more than the main one, and give a sound signal.  Pay attention to the type of PPP connections, and change if necessary. <br><br>  On this cycle closes and returns to state 0. <br><br>  Now about how when you run the script, it finds out the current state: <br><br><div class="spoiler">  <b class="spoiler_title">Initial state</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$routeDist</span></span> [/interface l2tp-client get <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span> default-route-distance]; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$routeDist2</span></span> [/interface ppp-client get <span class="hljs-variable"><span class="hljs-variable">$ifRes</span></span> default-route-distance]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$routeDist</span></span> &lt; <span class="hljs-variable"><span class="hljs-variable">$routeDist2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [/interface get <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span> running] = <span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 0; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 1; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [/interface get <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span> disabled] = <span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { /interface <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$routeDist</span></span> &gt; <span class="hljs-variable"><span class="hljs-variable">$routeDist2</span></span> and [/interface get <span class="hljs-variable"><span class="hljs-variable">$ifRes</span></span> disabled] = <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 2; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 3; } } <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> info <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$scriptName</span></span></span><span class="hljs-string">: initial state </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$state</span></span></span><span class="hljs-string">"</span></span>;</code> </pre></div></div><br>  Here the logic is also complicated at first glance.  Three parameters are analyzed: whether ISP1 is running, whether ISP2 is running, and the default route distance relationship with them.  The initial states 1 and 3 are nonstandard, and they say about the wrong configuration, but the script in this case itself restores everything, even if sometimes by unnecessary switching. <br><br><div class="spoiler">  <b class="spoiler_title">Excluded state</b> <div class="spoiler_text">  I have one more condition which I have excluded, since  most likely it is hardly needed by the majority.  My ISP1 connects VPN by name, not by IP, to resolve this name, you need to use the same provider‚Äôs DNS, since  it resolves to the local address.  And if you don‚Äôt help the script with resolution, specifying a specific DNS, then even after the availability of the ISP1 network, it will never connect, because  will not resolve the domain name, but will continue to use the DNS reserve.  Here it is.  state: <br><br><pre> <code class="bash hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 2) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (([ping DNSip1 count=1] &gt; 0) or ([ping DNSip2 count=1] &gt; 0)) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$tmp</span></span> 0; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { resolve VPNaddress server=DNSip1; } on-error= { }; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { resolve VPNaddress server=DNSip2; } on-error= { }; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { resolve VPNaddress } on-error= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$tmp</span></span> 1; }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$tmp</span></span> = 0) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 3; <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> info <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$scriptName</span></span></span><span class="hljs-string">: state changed 2-&gt;3"</span></span>; delay 5; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 2) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { delay 15 }; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 2); }</code> </pre><br>  Instead of DNSip1, DNSip2 and VPNaddress, we substitute the necessary data.  All states below are respectively shifted by +1. <br></div></div><br><br>  That's basically all, developed and debugged on 6.26 and RB951G-2HnD.  On other versions - I do not promise, and sorry for the lack of ':' in front of the teams. <br><br>  In my configuration, another one works in conjunction with this script, which runs in a schedule once a minute.  It checks if this script is running, and additionally sends me an IP address by mail when it changes.  Here is a small example, but only the first part: <br><br><div class="spoiler">  <b class="spoiler_title">Script monitor</b> <div class="spoiler_text"><pre> <code class="bash hljs">global FailoverDisabled; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [len [/system script job find <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> script=<span class="hljs-string"><span class="hljs-string">"Failover"</span></span>]] = 0 and <span class="hljs-variable"><span class="hljs-variable">$FailoverDisabled</span></span> != 1) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { execute script=<span class="hljs-string"><span class="hljs-string">"Failover"</span></span>; } on-error= { <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> info <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$scriptName</span></span></span><span class="hljs-string">: Failed to execute Failover"</span></span> }; }</code> </pre></div></div><br>  A global variable can disable the launch of the failover script.  Also, due to the schedule, if the router unexpectedly reboots, the script will be automatically launched again. <br><br><div class="spoiler">  <b class="spoiler_title">Full Failover Script</b> <div class="spoiler_text"><pre> <code class="bash hljs">global FailoverTimes; global FailoverLastTime; global FailoverLastBackTime; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> ifMain <span class="hljs-string"><span class="hljs-string">"ISP1"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> ifRes <span class="hljs-string"><span class="hljs-string">"ISP2"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> scriptName <span class="hljs-string"><span class="hljs-string">"Failover"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> state 0; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> pingNum 0; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> pingRes; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> routeDist; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> routeDist2; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> tmp; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> ip { xxxx; yyyy; zzzz }; <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> pingSrcAddr 192.168.xx.yy; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [len [/system script job find <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> script=<span class="hljs-variable"><span class="hljs-variable">$scriptName</span></span>]] &gt; 1) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { error <span class="hljs-string"><span class="hljs-string">"single instance"</span></span> }; delay 15; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$routeDist</span></span> [/interface l2tp-client get <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span> default-route-distance]; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$routeDist2</span></span> [/interface ppp-client get <span class="hljs-variable"><span class="hljs-variable">$ifRes</span></span> default-route-distance]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$routeDist</span></span> &lt; <span class="hljs-variable"><span class="hljs-variable">$routeDist2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [/interface get <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span> running] = <span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 0; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 1; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [/interface get <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span> disabled] = <span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { /interface <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> <span class="hljs-variable"><span class="hljs-variable">$ifMain</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$routeDist</span></span> &gt; <span class="hljs-variable"><span class="hljs-variable">$routeDist2</span></span> and [/interface get <span class="hljs-variable"><span class="hljs-variable">$ifRes</span></span> disabled] = <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 2; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 3; } } <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> info <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$scriptName</span></span></span><span class="hljs-string">: initial state </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$state</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 0) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingNum</span></span> &gt;= 3) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingNum</span></span> 0; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([ping (<span class="hljs-variable"><span class="hljs-variable">$ip</span></span>-&gt;<span class="hljs-variable"><span class="hljs-variable">$pingNum</span></span>) count=1] = 0) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span> [ping (<span class="hljs-variable"><span class="hljs-variable">$ip</span></span>-&gt;0) count=2]; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span>+[ping (<span class="hljs-variable"><span class="hljs-variable">$ip</span></span>-&gt;1) count=2]); <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span>+[ping (<span class="hljs-variable"><span class="hljs-variable">$ip</span></span>-&gt;2) count=2]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingRes</span></span> = 0) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$FailoverLastTime</span></span> <span class="hljs-string"><span class="hljs-string">"$[/system clock get date] $[/system clock get time]"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$FailoverTimes</span></span> ([tonum <span class="hljs-variable"><span class="hljs-variable">$FailoverTimes</span></span>] + 1) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$state</span></span> 1; <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> info <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$scriptName</span></span></span><span class="hljs-string">: state changed 0-&gt;1"</span></span>; } } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$pingNum</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pingNum</span></span> + 1); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 0) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>= { delay 15 }; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-variable"><span class="hljs-variable">$state</span></span> = 0); } <span class="hljs-comment"><span class="hljs-comment"># endof if state = 0 if ($state = 1) do= { if ( [/interface l2tp-client get $ifMain default-route-distance] &gt; 10) do= { /interface ppp-client set $ifRes default-route-distance=1; } /interface enable $ifRes; beep frequency=2000 length=250ms; delay 500ms; beep frequency=2000 length=250ms; delay 500ms; delay 6; /interface disable $ifMain; set $routeDist ([/interface ppp-client get $ifRes default-route-distance] + 1); /interface l2tp-client set $ifMain default-route-distance=$routeDist; /interface enable $ifMain; set $state 2; log info "$scriptName: state changed 1-&gt;2"; } if ($state = 2) do= { do { if ( [len [interface find where name=$ifMain and running] ] = 1) do= { set $pingRes [ping ($ip-&gt;0) src-address=$pingSrcAddr count=2]; set $pingRes ($pingRes+[ping ($ip-&gt;1) src-address=$pingSrcAddr count=2]); set $pingRes ($pingRes+[ping ($ip-&gt;2) src-address=$pingSrcAddr count=2]); if ($pingRes &gt; 0) do= { set $state 3; log info "$scriptName: state changed 2-&gt;3"; } } if ($state = 2) do= { delay 15 }; } while ($state = 2); } # endof if state = 2 if ($state = 3) do= { /interface disable $ifRes; set $routeDist ([/interface l2tp-client get $ifMain default-route-distance] + 1); /interface ppp-client set $ifRes default-route-distance=$routeDist; set $state 0; set $FailoverLastBackTime "$[/system clock get date] $[/system clock get time]"; log info "$scriptName: state changed 3-&gt;0"; beep frequency=500 length=500ms; } # bad programming protection delay 1; } while= ( true );</span></span></code> </pre></div></div></div><p>Source: <a href="https://habr.com/ru/post/252729/">https://habr.com/ru/post/252729/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252717/index.html">HP Hyper-Converged Virtualization Platforms</a></li>
<li><a href="../252719/index.html">High performance and hosting infrastructure: 1cloud project experience</a></li>
<li><a href="../252721/index.html">The practice of semantic markup</a></li>
<li><a href="../252725/index.html">Censor links by Skype</a></li>
<li><a href="../252727/index.html">Toast notifications, now in the browser</a></li>
<li><a href="../252731/index.html">VDI without the hassle based on Microsoft Azure RemoteApp</a></li>
<li><a href="../252735/index.html">The story of one game</a></li>
<li><a href="../252737/index.html">Xpom-Xpum! SDK - IDE for Google Chrome Extensions and Applications</a></li>
<li><a href="../252741/index.html">RFC2544 standard test</a></li>
<li><a href="../252743/index.html">Your personal course on Big Data</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>