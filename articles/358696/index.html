<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We update Angular to the 6th version in the project without use of CLI</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I will talk about the thorny path of updating Angular with a custom Webpack config that our team had to go a week ago. Perhaps our exp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We update Angular to the 6th version in the project without use of CLI</h1><div class="post__text post__text-html js-mediator-article">  In this article I will talk about the thorny path of updating Angular with a custom Webpack config that our team had to go a week ago.  Perhaps our experience will be useful for those who use Angular with their Webpack configuration, and the rest is interesting as an illustration of where the modern frontend can lead and how to live with it. <br><br><img src="https://habrastorage.org/webt/vw/ue/qg/vwueqg9snef71pil1xfmtx5qcii.png"><br><br>  Our team is working on the <a href="https://www.ispsystem.ru/software/billmanager">BILLmanager 6</a> interface.  So that you have a general idea of ‚Äã‚Äãthe project before the update, I will inform you that the number of files in it has already exceeded 67 thousand.  Architecturally, there are two subprojects: the registration module and the main user interface.  The technologies are based on Angular components, directives and modules written in TypeScript.  There are several components on the Web components.  For styling, we use SASS / SCSS and use CSS variables to theme the application without recompiling. <br><a name="habracut"></a><br><h2>  Prerequisites </h2><br>  Everything has a reason, and our current difficulties got their start a year and a half ago.  Then only Angular 2 appeared. Programmers in the company had experience creating applications on Angular 1, ReactJS and their own small framework.  Angular 2 at that time absorbed the pluses from the first version and ReactJS.  Therefore, it was chosen because of its prospects (like Google), the success of Angular 1 and the formalization that TypeScript provides.  We do not write small SPA sites that you can give to the customer and forget, our applications live for a long time and they need constant support and development.  BILLmanager is used by providers to sell hosting and work with clients.  Therefore, both it and other <a href="https://www.ispsystem.ru/">ISPsystem</a> products need to be constantly maintained and developed.  In principle, the Angular 2 team has already written everywhere that now there will be just Angular and the development of the framework will happen evolutionarily, which is suitable for our internal processes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As I already wrote, our projects are large and long-lived.  They have complex configs with flexible settings for individual assemblies.  And Webpack has long been a kind of standard for assembling large and small projects in the frontend world, so the choice here was unequivocal. <br><br>  As a result, the common part of the config in the project looked as follows: <br><br><div class="spoiler">  <b class="spoiler_title">the contents of the file webpack.config.common.js before updating</b> <div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">context</span></span>: PATHS.root, <span class="hljs-attr"><span class="hljs-attr">target</span></span>: <span class="hljs-string"><span class="hljs-string">'web'</span></span>, entry, <span class="hljs-attr"><span class="hljs-attr">resolve</span></span>: { <span class="hljs-attr"><span class="hljs-attr">extensions</span></span>: [<span class="hljs-string"><span class="hljs-string">'.ts'</span></span>, <span class="hljs-string"><span class="hljs-string">'.js'</span></span>, <span class="hljs-string"><span class="hljs-string">'.json'</span></span>], <span class="hljs-attr"><span class="hljs-attr">modules</span></span>: [PATHS.src, PATHS.node_modules], }, <span class="hljs-attr"><span class="hljs-attr">module</span></span>: { <span class="hljs-attr"><span class="hljs-attr">rules</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.ts$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">loaders</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">loader</span></span>: <span class="hljs-string"><span class="hljs-string">'awesome-typescript-loader'</span></span>, <span class="hljs-attr"><span class="hljs-attr">options</span></span>: { <span class="hljs-attr"><span class="hljs-attr">transpileOnly</span></span>: process.env.NODE_ENV !== <span class="hljs-string"><span class="hljs-string">'production'</span></span> } }, <span class="hljs-string"><span class="hljs-string">'angular2-template-loader'</span></span>, <span class="hljs-string"><span class="hljs-string">'angular2-router-loader'</span></span> ], <span class="hljs-attr"><span class="hljs-attr">exclude</span></span>: [<span class="hljs-regexp"><span class="hljs-regexp">/\.(spec|e2e)\.ts$/</span></span>], }, { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.ts$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">include</span></span>: [<span class="hljs-regexp"><span class="hljs-regexp">/\.(spec|e2e)\.ts$/</span></span>], <span class="hljs-attr"><span class="hljs-attr">loaders</span></span>: [<span class="hljs-string"><span class="hljs-string">'awesome-typescript-loader'</span></span>, <span class="hljs-string"><span class="hljs-string">'angular2-template-loader'</span></span>] }, { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.json$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">use</span></span>: <span class="hljs-string"><span class="hljs-string">'json-loader'</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.html$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">use</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">loader</span></span>: <span class="hljs-string"><span class="hljs-string">'html-loader'</span></span>, }], }, { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.(eot|woff|woff2|ttf|png|jpg|gif|svg|ico)(\?v=\d+\.\d+\.\d+)?$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">loader</span></span>: <span class="hljs-string"><span class="hljs-string">'file-loader'</span></span>, <span class="hljs-attr"><span class="hljs-attr">options</span></span>: { <span class="hljs-attr"><span class="hljs-attr">context</span></span>: PATHS.assets, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'[path][name].[ext]'</span></span> }, }, { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.css$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">loader</span></span>: extractSASS.extract({ <span class="hljs-attr"><span class="hljs-attr">fallback</span></span>: <span class="hljs-string"><span class="hljs-string">'style-loader'</span></span>, <span class="hljs-attr"><span class="hljs-attr">use</span></span>: <span class="hljs-string"><span class="hljs-string">'css-loader?sourceMap'</span></span> }), <span class="hljs-attr"><span class="hljs-attr">exclude</span></span>: [path.join(PATHS.projectPath), path.join(PATHS.src, <span class="hljs-string"><span class="hljs-string">'common'</span></span>), path.join(PATHS.src, <span class="hljs-string"><span class="hljs-string">'common-bill'</span></span>)], }, { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.css$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">include</span></span>: [path.join(PATHS.projectPath), path.join(PATHS.src, <span class="hljs-string"><span class="hljs-string">'common'</span></span>), path.join(PATHS.src, <span class="hljs-string"><span class="hljs-string">'common-bill'</span></span>)], <span class="hljs-attr"><span class="hljs-attr">use</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">loader</span></span>: <span class="hljs-string"><span class="hljs-string">"raw-loader"</span></span> <span class="hljs-comment"><span class="hljs-comment">// creates style nodes from JS strings }], }, { test: /\.(scss|sass)$/, loader: extractSASS.extract({ use: [{ loader: "css-loader", }, { loader: "sass-loader", options: { sourceMap: true, } } ], // use style-loader in development fallback: "style-loader" }), exclude: [path.join(PATHS.projectPath), path.join(PATHS.src, 'common'), path.join(PATHS.src, 'common-bill')], }, { test: /\.(scss|sass)$/, use: [{ loader: "raw-loader" // creates style nodes from JS strings }, { loader: "sass-loader", // compiles Sass to CSS options: { sourceMap: true } } ], include: [path.join(PATHS.projectPath), path.join(PATHS.src, 'common'), path.join(PATHS.src, 'common-bill')], } ] }, plugins: [ extractSASS, new webpack.IgnorePlugin(/vertx/), new webpack.ContextReplacementPlugin( // The (\\|\/) piece accounts for path separators in *nix and Windows /\@angular(\\|\/)core(\\|\/)esm5/, PATHS.projectPath, // location of your src {} // a map of your routes ), new webpack.optimize.CommonsChunkPlugin({ name: ['vendor', 'polyfills'], // minChunks: Infinity }), ] };</span></span></code> </pre> <br></div></div><br>  This is very similar to what is described now in the Angular <a href="https://angular.io/guide/webpack">angular.io/guide/webpack</a> documentation.  The most interesting of this is the part about compiling .ts files. <br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.ts$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">loaders</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">loader</span></span>: <span class="hljs-string"><span class="hljs-string">'awesome-typescript-loader'</span></span>, <span class="hljs-attr"><span class="hljs-attr">options</span></span>: { <span class="hljs-attr"><span class="hljs-attr">transpileOnly</span></span>: process.env.NODE_ENV !== <span class="hljs-string"><span class="hljs-string">'production'</span></span> } }, <span class="hljs-string"><span class="hljs-string">'angular2-template-loader'</span></span>, <span class="hljs-string"><span class="hljs-string">'angular2-router-loader'</span></span> ], <span class="hljs-attr"><span class="hljs-attr">exclude</span></span>: [<span class="hljs-regexp"><span class="hljs-regexp">/\.(spec|e2e)\.ts$/</span></span>], }, { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.ts$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">include</span></span>: [<span class="hljs-regexp"><span class="hljs-regexp">/\.(spec|e2e)\.ts$/</span></span>], <span class="hljs-attr"><span class="hljs-attr">loaders</span></span>: [<span class="hljs-string"><span class="hljs-string">'awesome-typescript-loader'</span></span>, <span class="hljs-string"><span class="hljs-string">'angular2-template-loader'</span></span>] },</code> </pre><br>  As you see, we use the <a href="https://github.com/TheLarkInn/angular2-template-loader">angular2-template-loader</a> and <a href="https://github.com/brandonroberts/angular-router-loader">angular2-router-loader loaders</a> to build our Angular components.  The official documentation is written.  And this is extremely strange, since both loaders are not written by the Angular team and are stored in user repositories on GitHub.  One of the reasons for choosing Angular as the main framework was that it works like a combine - everything comes out of the box, unlike ReactJS.  But here we see that the tool with which our project will be assembled out of the box does not go. <br><br>  Well, okay, this config worked from the second to the fifth version, and there was no cause for concern.  Although no, there was one.  At ng-conf 2017, Brad Green spoke about trying to build an Angular application using <a href="https://bazel.build/">Bazel</a> and Closure.  Who worked with large projects on Angular, he will understand me - builds take a very long time.  Our first build of development mode on the fifth version of Angular with the second webpack takes more than 4 minutes.  And the desire of the framework developers to make assemblies faster is quite reasonable.  Although there is another look at this situation.  As my colleague said: <br><blockquote>  "It was necessary to make a slowly gathering framework, and then start accelerating it." </blockquote><br><h2>  Angular upgrade to version 6 </h2><br>  Our company is well aware of what happens when you don‚Äôt update tools.  We know what this may eventually lead to.  Revolutions do not go off painlessly, and it is better to foresee them, moving in an evolutionary way.  Therefore, when there is <a href="https://blog.angular.io/version-6-of-angular-now-available-cc56b0efa7a4">news</a> about the release of a stable version of Angular 6, we decided to update our project.  But it did not work out painlessly. <br><br>  As with the previous version update, we moved to the site with <a href="https://update.angular.io/">update.angular.io</a> update <a href="https://update.angular.io/">guide</a> .  Here we were in for the first surprise. <br><br><img src="https://habrastorage.org/webt/ef/gl/0a/efgl0ac-mywbytowkp3vxfjbpkg.png" width="600"><br><br>  If you do not specify the item ‚ÄúI use ngUpgrade‚Äù, then the manual will still offer to execute the <code>ng update @angular/core</code> command. <br><br><img src="https://habrastorage.org/webt/fm/fm/g3/fmfmg38xugadfrv_xsgnryn7vx8.png" width="600"><br><br>  In the update of previous versions of this was not, but now, it turns out, without the CLI and can not be updated?  Perhaps this is a bug and it will be fixed, but today, like a week ago, it was not possible to get clear instructions for updating without the CLI. <br><br>  If, like us, you still want to continue updating the project, then it is here that our thorny path begins.  First you need to determine the direction: <br><br><ol><li>  Install the CLI and update the steps of the official manual. </li><li>  Update packages separately and edit configs yourself. </li></ol><br>  The first one seemed simpler to us and we went over it. <br>  But after installing, updating the CLI and executing the <code>ng update @angular/core</code> command, we were disappointed. <br><br><pre> <code class="bash hljs">$ ng update @angular/core Package <span class="hljs-string"><span class="hljs-string">"@angular/compiler-cli"</span></span> has an incompatible peer dependency to <span class="hljs-string"><span class="hljs-string">"typescript"</span></span> (requires <span class="hljs-string"><span class="hljs-string">"&gt;=2.7.2 &lt;2.8"</span></span>, would install <span class="hljs-string"><span class="hljs-string">"2.8.3"</span></span>) Invalid range: <span class="hljs-string"><span class="hljs-string">"&gt;=2.3.0 &lt;3.0.0||&gt;=4.0.0"</span></span></code> </pre> <br>  The issues on GitHub can be found at <a href="https://github.com/angular/angular-cli/issues/10621">github.com/angular/angular- quad/</a> issues/ <a href="https://github.com/angular/angular-cli/issues/10621">10621</a> .  To date, this error seems to be corrected (judging by <a href="https://github.com/angular/devkit/pull/901">github.com/angular/devkit/pull/901</a> ), but at that time we decided not to go into the jungle of the update utility and updated the packages manually. <br><br>  After updating the packages, the project stopped running, which, in fact, was expected.  Angular 6 uses Webpack 4 (this can be seen if you install it via the CLI).  Therefore, in the next step, we updated the Webpack and related packages to the latest versions.  The story about updating Webpack pulls into a separate article, so here I will only write that if you use <a href="https://github.com/webpack-contrib/extract-text-webpack-plugin">extract-text-webpack-plugin</a> , replace it with <a href="https://github.com/webpack-contrib/mini-css-extract-plugin">mini-css-extract-plugin</a> , and this will save you nerves and strength.  You can read about how good the fourth webpack is, <a href="https://medium.com/webpack/webpack-4-released-today-6cdb994702d4">here</a> , well, and, actually, <a href="https://medium.com/webpack/webpack-4-released-today-6cdb994702d4">an article on migration</a> . <br><br>  In addition to updating Angular and Webpack, you need to update RxJS to the sixth version, otherwise the project simply will not start.  This is a prerequisite and it‚Äôs easy to do; you just need to follow the <a href="">migration documentation</a> .  There should be no significant difficulties, RxJS provides a utility that independently makes the necessary changes to the project. <br><br>  In the meantime, we are returning to the upgrade to Angular 6. The project is still not going to, and gives a lot of unintelligible errors.  Here is the time to pay attention to the loader, which handles .ts files.  We use a bunch of <a href="https://github.com/TheLarkInn/angular2-template-loader">angular2-template-loader</a> and <a href="https://github.com/brandonroberts/angular-router-loader">angular2-router-loader</a> .  If you go to the <a href="https://github.com/TheLarkInn/angular2-template-loader">angular2-template-loader</a> repository, you can see that it has not been updated for a year already (it‚Äôs strange that we are still offered to use it in the official documentation). <br><br><img src="https://habrastorage.org/webt/pa/ln/au/palnaua_4m-xamuqwywspboobc0.png"><br><br>  It seems that the problem is how this loader handles our code.  We started looking for a replacement and found a plugin for the Ahead-of-Time (AoT) compilation <a href="https://www.npmjs.com/package/%40ngtools/webpack">@ ngtools / webpack</a> .  This is not an equivalent replacement, as before we used only JIT compilation.  But, on the other hand, the Angular team has long been talking about plans to make AoT compilation by default.  @ ngtools / webpack is the official tool from <a href="https://github.com/angular/devkit">Angular DevKit</a> , it is updated constantly and has been redesigned for the sixth version of the framework.  To be fair, I can say that you can build Angular 6 project with angular2-template-loader and angular2-router-loader plugins.  A bunch of these plugins may be suitable for development, but for production assemblies it is better not to use them due to the lack of additional checks of the executable code.  It was precisely this that did not allow us to easily catch all the necessary corrections immediately for switching to the sixth version. <br><br>  <a href="https://angular.io/guide/aot-compiler">AOT</a> compilation is, by and large, different in that templates are compiled when the application is built, and not after it is launched in the user's browser.  On the one hand, it speeds up the application and reduces its size, on the other, it incurs additional costs when compiling and requires more rigor to writing components. <br><br>  Switching to AOT compilation of a project is a separate big task.  To accomplish it, you will have to redo a large part of the project, because AOT has very strict code requirements and if you didn‚Äôt observe them right away, it will be difficult.  But there is a way out.  You can use the @ ngtools / webpack plugin with JIT compilation.  To do this, add the parameter <code>skipCodeGeneration=true</code> to the plugin settings. <br><br>  I will outline the main points that had to be corrected when switching to the @ ngtools / webpack plugin: <br><br><ol><li>  In templates, all <code>private</code> variables are replaced by <code>public</code> . </li><li>  In inheritance, it is undesirable to inherit one component from another (with the same directives).  In principle, this is logical, but angular2-template-loader - skipped, and @ ngtools / webpack began to swear on incorrectly created modules. </li><li>  If we ignore the recommendation above, then you can get an error when using the component component in the designer variables of simple types.  This is the most strange mistake.  The component is as follows: </li></ol><br><pre> <code class="hljs scala"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span>({ selector: '[form-component]', template: '' }) export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FormComponent</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseComponent</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnInit</span></span></span><span class="hljs-class"> </span></span>{ constructor( public formService: <span class="hljs-type"><span class="hljs-type">FormService</span></span>, public formFunc: string, public formParams: <span class="hljs-type"><span class="hljs-type">Array</span></span>&lt;any&gt; = [] ) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); } ...</code> </pre><br>  In the logs we see about the following: <br><br><pre> <code class="bash hljs">ERROR <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> : Can<span class="hljs-string"><span class="hljs-string">'t resolve all parameters for FormComponent in form.component.ts: ( [object Object], ?, ?)</span></span></code> </pre> <br>  I recommend to fulfill the second rule, but if for some reason it does not work, you can make a small hack <a href="https://stackoverflow.com/a/48748942/4778628">https://stackoverflow.com/a/48748942/4778628</a> , replacing the code above with: <br><br><pre> <code class="hljs scala"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span>({ selector: '[form-component]', template: '' }) export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FormComponent</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseComponent</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnInit</span></span></span><span class="hljs-class"> </span></span>{ constructor( public formService: <span class="hljs-type"><span class="hljs-type">FormService</span></span>, <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span>('') public formFunc: string, <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span>('') public formParams: <span class="hljs-type"><span class="hljs-type">Array</span></span>&lt;any&gt; = [] ) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); } ...</code> </pre><br>  Unfortunately, the errors did not end there, and we got it in the <a href="https://github.com/angular/devkit/issues/880">Angular compiler</a> itself: <br><br><div class="spoiler">  <b class="spoiler_title">error text</b> <div class="spoiler_text"><pre> <code class="bash hljs"> [0] building modules ÔΩ¢wdsÔΩ£: Project is running at http://localhost:8080/ ÔΩ¢wdsÔΩ£: webpack output is served from / ÔΩ¢wdsÔΩ£: Content not from webpack is served from /home/dsumbaev/DEVELOPMENT/bill-client-front/dist ÔΩ¢wdsÔΩ£: 404s will fallback to /index.html [0] building modules/home/dsumbaev/DEVELOPMENT/bill-client-front/node_modules/@ngtools/webpack/src/angular_compiler_plugin.js:509 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.done &amp;&amp; (request.request.endsWith(<span class="hljs-string"><span class="hljs-string">'.ts'</span></span>) ^ TypeError: Cannot <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> property <span class="hljs-string"><span class="hljs-string">'request'</span></span> of null at nmf.hooks.beforeResolve.tapAsync (/home/dsumbaev/DEVELOPMENT/bill-client-front/node_modules/@ngtools/webpack/src/angular_compiler_plugin.js:509:47) at _fn1 (<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span> at create (/home/dsumbaev/DEVELOPMENT/bill-client-front/node_modules/webpack/node_modules/tapable/lib/HookCodeFactory.js:24:12), &lt;anonymous&gt;:27:1) at Object.resolveWithPaths (/home/dsumbaev/DEVELOPMENT/bill-client-front/node_modules/@ngtools/webpack/src/paths-plugin.js:14:9) at nmf.hooks.beforeResolve.tapAsync (/home/dsumbaev/DEVELOPMENT/bill-client-front/node_modules/@ngtools/webpack/src/angular_compiler_plugin.js:521:32) at AsyncSeriesWaterfallHook.eval [as callAsync] (<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span> at create (/home/dsumbaev/DEVELOPMENT/bill-client-front/node_modules/webpack/node_modules/tapable/lib/HookCodeFactory.js:24:12), &lt;anonymous&gt;:19:1) at NormalModuleFactory.create (/home/dsumbaev/DEVELOPMENT/bill-client-front/node_modules/webpack/lib/NormalModuleFactory.js:338:28) at semaphore.acquire (/home/dsumbaev/DEVELOPMENT/bill-client-front/node_modules/webpack/lib/Compilation.js:494:14) at Semaphore.acquire (/home/dsumbaev/DEVELOPMENT/bill-client-front/node_modules/webpack/lib/util/Semaphore.js:17:4) at asyncLib.forEach (/home/dsumbaev/DEVELOPMENT/bill-client-front/node_modules/webpack/lib/Compilation.js:492:15) at arrayEach (/home/dsumbaev/DEVELOPMENT/bill-client-front/node_modules/neo-async/async.js:2400:9) at Object.each (/home/dsumbaev/DEVELOPMENT/bill-client-front/node_modules/neo-async/async.js:2835:9) at Compilation.addModuleDependencies (/home/dsumbaev/DEVELOPMENT/bill-client-front/node_modules/webpack/lib/Compilation.js:471:12) at Compilation.processModuleDependencies (/home/dsumbaev/DEVELOPMENT/bill-client-front/node_modules/webpack/lib/Compilation.js:450:8) at afterBuild (/home/dsumbaev/DEVELOPMENT/bill-client-front/node_modules/webpack/lib/Compilation.js:556:15) at buildModule.err (/home/dsumbaev/DEVELOPMENT/bill-client-front/node_modules/webpack/lib/Compilation.js:600:11) at callback (/home/dsumbaev/DEVELOPMENT/bill-client-front/node_modules/webpack/lib/Compilation.js:358:35)</code> </pre><br></div></div><br>  At first, we thought that we were giving the compiler packages from node_modules, but he could not process them, but adding exceptions had no effect on the error.  There was nowhere to go and turn late, so a <a href="https://github.com/angular/devkit/pull/881">small PR</a> appeared in @ ngtools / webpack.  These changes are included in version 6.0.1 of the package.  After that, the build was successful and the project started! <br><br>  BUT!  It turned out that all modules except the main one were not pulled up.  Let's look at the plugin's @ ngtools / webpack setting. <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AngularCompilerPlugin({ <span class="hljs-attr"><span class="hljs-attr">platform</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">sourceMap</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">tsConfigPath</span></span>: path.join(PATHS.root, <span class="hljs-string"><span class="hljs-string">'tsconfig.json'</span></span>), <span class="hljs-attr"><span class="hljs-attr">skipCodeGeneration</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, })</code> </pre> <br>  At first glance, everything is in the <a href="https://github.com/angular/devkit/tree/master/packages/ngtools/webpack">documentation</a> .  Note that the entryModule parameter is marked as optional.  By trial and error, it was found that if the parameter was not specified, the assembly did not go beyond the main module, which is why we received a non-working application.  Fixing the problem is easy, you need to add the <code>entryModule</code> . <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AngularCompilerPlugin({ <span class="hljs-attr"><span class="hljs-attr">platform</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">entryModule</span></span>: path.join(PATHS.src, <span class="hljs-string"><span class="hljs-string">'apps/client/app/app.module#AppModule'</span></span>), <span class="hljs-attr"><span class="hljs-attr">sourceMap</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">tsConfigPath</span></span>: path.join(PATHS.root, <span class="hljs-string"><span class="hljs-string">'tsconfig.json'</span></span>), <span class="hljs-attr"><span class="hljs-attr">skipCodeGeneration</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, })</code> </pre> <br>  If you remember, at the beginning I wrote that we have two subprojects in the project, but only one can be specified in the entryModule.  Here we are lucky, because the second application does not contain nested modules.  If you have a different situation: several complex projects within one, then you have to make separate configs for each one or wait for <a href="https://github.com/angular/devkit/pull/875">this PR</a> to pass in the Angular DevKit repository. <br><br>  As a result, the common part of the config in the project was as follows: <br><br><div class="spoiler">  <b class="spoiler_title">the final content of the webpack.config.common.js file</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> path = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> merge = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'webpack-merge'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> webpack = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'webpack'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ProgressPlugin = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'webpack/lib/ProgressPlugin'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MiniCssExtractPlugin = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"mini-css-extract-plugin"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {AngularCompilerPlugin} = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'@ngtools/webpack'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { PATHS, PARAMS } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./helpers.js'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> devMode = process.env.NODE_ENV === <span class="hljs-string"><span class="hljs-string">'development'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> entry = { <span class="hljs-string"><span class="hljs-string">'polyfills'</span></span>: path.join(PATHS.src, <span class="hljs-string"><span class="hljs-string">'polyfills.browser.ts'</span></span>), <span class="hljs-string"><span class="hljs-string">'main'</span></span>: path.join(PATHS.projectPath, <span class="hljs-string"><span class="hljs-string">'main.ts'</span></span>), <span class="hljs-string"><span class="hljs-string">'extform'</span></span>: path.join(PATHS.apps, <span class="hljs-string"><span class="hljs-string">'extform/main.ts'</span></span>), <span class="hljs-string"><span class="hljs-string">'style'</span></span>: path.join(PATHS.assets, <span class="hljs-string"><span class="hljs-string">'sass'</span></span>, <span class="hljs-string"><span class="hljs-string">'app.sass'</span></span>) }; PARAMS.themes.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">theme</span></span></span><span class="hljs-function"> =&gt;</span></span> { entry[<span class="hljs-string"><span class="hljs-string">'themes/'</span></span> + theme + <span class="hljs-string"><span class="hljs-string">'/theme'</span></span>] = path.join(PATHS.themes, theme, <span class="hljs-string"><span class="hljs-string">'theme.scss'</span></span>) }); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">context</span></span>: PATHS.root, <span class="hljs-attr"><span class="hljs-attr">target</span></span>: <span class="hljs-string"><span class="hljs-string">'web'</span></span>, entry, <span class="hljs-attr"><span class="hljs-attr">resolve</span></span>: { <span class="hljs-attr"><span class="hljs-attr">extensions</span></span>: [<span class="hljs-string"><span class="hljs-string">'.ts'</span></span>, <span class="hljs-string"><span class="hljs-string">'.js'</span></span>, <span class="hljs-string"><span class="hljs-string">'.json'</span></span>], <span class="hljs-attr"><span class="hljs-attr">modules</span></span>: [PATHS.src, PATHS.node_modules], }, <span class="hljs-attr"><span class="hljs-attr">mode</span></span>: process.env.NODE_ENV, <span class="hljs-attr"><span class="hljs-attr">stats</span></span>: <span class="hljs-string"><span class="hljs-string">'errors-only'</span></span>, <span class="hljs-attr"><span class="hljs-attr">module</span></span>: { <span class="hljs-attr"><span class="hljs-attr">rules</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.ts$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">loader</span></span>: <span class="hljs-string"><span class="hljs-string">'@ngtools/webpack'</span></span>, <span class="hljs-attr"><span class="hljs-attr">exclude</span></span>: [<span class="hljs-regexp"><span class="hljs-regexp">/\.(spec|e2e)\.ts$/</span></span>, /node_modules/], }, { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.ts$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">loader</span></span>: <span class="hljs-string"><span class="hljs-string">'null-loader'</span></span>, <span class="hljs-attr"><span class="hljs-attr">include</span></span>: [<span class="hljs-regexp"><span class="hljs-regexp">/\.(spec|e2e)\.ts$/</span></span>], }, { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.json$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">use</span></span>: <span class="hljs-string"><span class="hljs-string">'json-loader'</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.html$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">use</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">loader</span></span>: <span class="hljs-string"><span class="hljs-string">'html-loader'</span></span>, }], }, { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.(eot|woff|woff2|ttf|png|jpg|gif|svg|ico)(\?v=\d+\.\d+\.\d+)?$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">loader</span></span>: <span class="hljs-string"><span class="hljs-string">'file-loader'</span></span>, <span class="hljs-attr"><span class="hljs-attr">options</span></span>: { <span class="hljs-attr"><span class="hljs-attr">context</span></span>: PATHS.assets, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'[path][name].[ext]'</span></span> }, }, { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.css$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">use</span></span>: [ MiniCssExtractPlugin.loader, <span class="hljs-string"><span class="hljs-string">"css-loader"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">exclude</span></span>: [path.join(PATHS.projectPath), path.join(PATHS.src, <span class="hljs-string"><span class="hljs-string">'common'</span></span>), path.join(PATHS.src, <span class="hljs-string"><span class="hljs-string">'common-bill'</span></span>)], }, { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.css$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">include</span></span>: [path.join(PATHS.projectPath), path.join(PATHS.src, <span class="hljs-string"><span class="hljs-string">'common'</span></span>), path.join(PATHS.src, <span class="hljs-string"><span class="hljs-string">'common-bill'</span></span>)], <span class="hljs-attr"><span class="hljs-attr">use</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">loader</span></span>: <span class="hljs-string"><span class="hljs-string">"raw-loader"</span></span> <span class="hljs-comment"><span class="hljs-comment">// creates style nodes from JS strings }], }, { test: /\.(scss|sass)$/, use: [ devMode ? 'style-loader' : MiniCssExtractPlugin.loader, 'css-loader', 'sass-loader', ], exclude: [path.join(PATHS.projectPath), path.join(PATHS.src, 'common'), path.join(PATHS.src, 'common-bill')], }, { test: /\.(scss|sass)$/, use: [{ loader: "raw-loader" // creates style nodes from JS strings }, { loader: "sass-loader", // compiles Sass to CSS options: { sourceMap: true } } ], include: [path.join(PATHS.projectPath), path.join(PATHS.src, 'common'), path.join(PATHS.src, 'common-bill')], } ] }, optimization: { splitChunks: { cacheGroups: { commons: { test: /[\\/]node_modules[\\/]/, name: "vendors", chunks: "all" } } } }, plugins: [ new MiniCssExtractPlugin({ filename: '[name].[hash].css', }), new webpack.IgnorePlugin(/vertx/), new ProgressPlugin(), new AngularCompilerPlugin({ platform: 0, entryModule: path.join(PATHS.src, 'apps/client/app/app.module#AppModule'), sourceMap: true, tsConfigPath: path.join(PATHS.root, 'tsconfig.json'), skipCodeGeneration: true, }) ] };</span></span></code> </pre><br></div></div><br><h2>  Conclusion </h2><br>  After all the above manipulations, we got a working application with Angular 6 and its own Webpack config.  During the work 180 project files were corrected, and it took about one week. <br><br>  Angular is a monolithic framework, and with the advent of the sixth version it becomes even more visible.  Now, not only additional tools in the form of a router or a library of HTTP requests, but also build tools go out of the box.  And it is better not to touch them, not to make changes that were not conceived by the Angular developers.  Only in this case, you can easily update the project and may not be faced with the need to change hundreds of files after the updates.  Otherwise, the hard way awaits you and you will have to like <a href="https://medium.com/%40sentinelaeux/i-love-throwing-in-the-garbage-all-the-work-i-had-building-applications-every-year-because-of-5e1e7fafaaaa">negative reviews on the new version</a> in a sea of ‚Äã‚Äãpositive and general joy of those around you. <br><br>  This does not mean that Angular is bad or good, it just requires special treatment and is not suitable for everyone.  If you work with it through the CLI, build the ng project with the utility, test and create modules and components for it, then you will be happy.  In our team, we would also like it, but, alas, too much is already tied to our Webpack config.  As they say in a good Russian proverb: "I would know where you fall, I would spread straws."  A year ago, CLI was not such an indispensable tool in Angular projects, but today, even in the documentation on updating, there is no guide on how to update without it. </div><p>Source: <a href="https://habr.com/ru/post/358696/">https://habr.com/ru/post/358696/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358686/index.html">Megafon ordered the Kupol storage complex to store traffic according to the law of Spring</a></li>
<li><a href="../358688/index.html">ESET discovered two 0-day vulnerabilities in Adobe Reader and Microsoft Windows</a></li>
<li><a href="../358690/index.html">We pack in containers, deploy, monitor - the program Root Conf</a></li>
<li><a href="../358692/index.html">Selection: 6 open frameworks for creating backtesters of trading strategies in Python</a></li>
<li><a href="../358694/index.html">UPD Broadcast. We invite you to the New PostgreSQL 11 features mitap</a></li>
<li><a href="../358698/index.html">13 interesting points from the javascript style guide from google</a></li>
<li><a href="../358700/index.html">GraalVM: mixed in a bunch of C and Scala</a></li>
<li><a href="../358702/index.html">How to run dynamic retargeting effectively in a mobile application</a></li>
<li><a href="../358704/index.html">Dirty tricks video game developers</a></li>
<li><a href="../358706/index.html">Applications for Tarantool. Part 3. Testing and launch</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>