<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Install and configure OSM-based tile generator in Ubuntu or Debian</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Most recently, the task of creating software for generating map tiles has arisen. As a basis, the choice fell on mapnik (there are few alternatives to...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Install and configure OSM-based tile generator in Ubuntu or Debian</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/comment_images/efa/062/85b/efa06285b12fe35779ae4d849b13bba7.png" alt="Openstreetmap" align="left">  Most recently, the task of creating software for generating map tiles has arisen.  As a basis, the choice fell on <a href="http://mapnik.org/">mapnik</a> (there are few alternatives to it).  As it turned out, there were a lot of difficulties and unexpected mistakes on the way, and more or less clear documentation on how to set up everything on a turnkey basis could not be found.  Having fidgeted for some time, I managed to collect a lot of rakes that may arise and bring the matter to the bitter end.  About this article. <a name="habracut"></a><br><br>  Installation was done in Ubuntu and Debian.  I will say right away that it is certainly better to use the latest versions of software products that are sometimes not in the repositories.  They can be downloaded, if desired, manually from the official sites. <br><br>  Apart from the necessary dependencies, in general we will need <br><ul><li>  PostgreSQL&gt; = 8.4 </li><li>  PostGIS&gt; = 1.5 &lt;2 </li><li>  Python 2.x </li><li>  Mapnik&gt; = 2 </li><li>  Osm2pgsql </li><li>  Some knowledge of working with bash, Python and PostgreSQL </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Install PostgreSQL </h4><br>  First, check which version of PostgreSQL we have in the repositories: <br><pre><code class="bash hljs">$ apt-cache show postgresql</code> </pre> <br>  If version 8.4 or more, then install the package. <br><pre> <code class="bash hljs">$ sudo apt-get install postgresql</code> </pre> <br>  Otherwise, download the package from the official website <a href="http://www.postgresql.org/download/linux/">www.postgresql.org/download/linux</a> and install it.  Next we need to set up our database.  By default, its user is postgres and you can only log in from it using OC itself.  However, we will act somewhat differently, first open the pg_hba.conf file.  You can find out its location using the locate utility. <br><br><pre> <code class="bash hljs">$ sudo updatedb $ sudo locate pg_hba.conf</code> </pre> <br>  If you have not installed this utility, then set <br><pre> <code class="bash hljs">$ sudo apt-get install findutils locate</code> </pre> <br>  and repeat the commands above.  For example, I have this file located at /etc/postgresql/8.4/main/pg_hba.conf.  Open it and edit it. <br><br><pre> <code class="bash hljs">$ sudo vi <span class="hljs-string"><span class="hljs-string">"/etc/postgresql/8.4/main/pg_hba.conf"</span></span></code> </pre> <br>  Replace: <br><pre> <code class="bash hljs">$ locate all all ident <span class="hljs-comment"><span class="hljs-comment">#   </span></span></code> </pre> <br>  On <br><pre> <code class="bash hljs">$ locate all all password <span class="hljs-comment"><span class="hljs-comment">#   </span></span></code> </pre> <br>  Save the file and restart PostgreSQL. <br><pre> <code class="bash hljs">$ sudo <span class="hljs-string"><span class="hljs-string">"/etc/init.d/postgresql-8.4 restart"</span></span></code> </pre> <br>  Now we can create any user base and log in with a regular password without any encryption (we are not critical to super security).  We also need a new database for our OSM data. <br>  Go to the PostgreSQL management console. <br><pre> <code class="bash hljs">$ su postgres $ psql postgres=<span class="hljs-comment"><span class="hljs-comment"># CREATE ROLE osm WITH SUPERUSER PASSWORD 'my_password' LOGIN; CREATE ROLE postgres=# CREATE DATABASE osm; CREATE DATABASE postgres=# \q</span></span></code> </pre> <br>  User and database created. <br>  You can check the performance of a new user with the command <br><pre> <code class="bash hljs">$ psql -U osm -d osm -W</code> </pre> <br>  If you enter the PostgreSQL console after entering the password, then everything went well. <br><br><h4>  PostGIS installation </h4><br>  We will need PostGIS.  In my repository was version 1.4.  Since, after its installation, for some reason I could not find the file postgis.sql, I demolished this version and downloaded version 1.5 from the official site.  Therefore, in the article, we will do the same. <br><pre> <code class="bash hljs">$ wget <span class="hljs-string"><span class="hljs-string">"http://postgis.refractions.net/download/postgis-1.5.4.tar.gz"</span></span></code> </pre> <br>  We unpack archive, we collect and we install. <br><pre> <code class="bash hljs">$ tar xvfz <span class="hljs-string"><span class="hljs-string">"./postgis-1.5.4.tar.gz"</span></span> $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-string"><span class="hljs-string">"./postgis-1.5.4"</span></span> $ sudo ./configure $ sudo make install</code> </pre> <br>  In the absence of the necessary libraries, install them. <br>  Next, install a special language in the osm database. <br><pre> <code class="bash hljs">$ createlang plpgsql osm -U osm -W</code> </pre> <br>  Now it is necessary to execute two SQL scripts in the osm database: postgis.sql and 900913.sql. <br>  Using the locate utility, we find their location and execute them. <br><pre> <code class="bash hljs">$ psql -U osm -d osm -W -f <span class="hljs-string"><span class="hljs-string">"/usr/share/postgresql/8.4/contrib/postgis-1.5/postgis.sql"</span></span> $ psql -U osm -d osm -W -f <span class="hljs-string"><span class="hljs-string">"/usr/share/osm2pgsql/900913.sql"</span></span></code> </pre> <br>  Note that as practice has shown, this command must be executed exactly from the user with the privileges of the PostgreSQL superuser.  If you have problems and errors in the <i>ERROR</i> plan <i>: type "geometry" does not exist</i> , then try the following before running the sql file: <br><pre> <code class="bash hljs">$ sudo ldconfig</code> </pre> <br>  and repeat the command to run sql files. <br>  Everything!  With PostgreSQL setup, we are done.  Go to the installation Mapnik. <br><br><h4>  Install Mapnik </h4><br><pre> <code class="bash hljs">$ sudo add-apt-repository ppa:mapnik/nightly-trunk $ sudo apt-get update $ sudo apt-get install libmapnik mapnik-utils python-mapnik</code> </pre> <br>  If the system shows that ‚Äúadd-apt-repository: command not found‚Äù, then <br><pre> <code class="bash hljs">$ sudo apt-get install python-software-properties</code> </pre> <br>  And repeat the three commands above.  Mapnik installed.  I did not write about the need to install Python, since in most cases it is always worth it.  Checking the work mapnik. <br><pre> <code class="bash hljs">$ python &gt;&gt;&gt; import mapnik</code> </pre> <br>  If there were no errors, then everything went well.  Now we are going to install osm2pgsql <br><br><h4>  Installing Osm2pgsql </h4><br><pre> <code class="bash hljs">$ sudo apt-get install osm2pgsql</code> </pre> <br>  There is one important touch.  The fact is that the default.style file supplied by osm2pgsql for exporting osm data to a database for some reason does not conform to the latest OSM format.  (Maybe someone knows why?).  Download the file in the correct format. <br><pre> <code class="bash hljs">$ wget <span class="hljs-string"><span class="hljs-string">"http://svn.openstreetmap.org/applications/utils/export/osm2pgsql/default.style"</span></span></code> </pre> <br>  Next, replace the default one with osm2pgsql <br><pre> <code class="bash hljs">$ sudo cp <span class="hljs-string"><span class="hljs-string">"./default.style"</span></span> <span class="hljs-string"><span class="hljs-string">"/usr/share/osm2pgsql/default.style"</span></span></code> </pre> <br><br><h4>  Installing scripts from OpenStreetMap to generate tiles </h4><br>  The OpenStreetMap <a href="http://svn.openstreetmap.org/">repository svn.openstreetmap.org</a> contains many scripts and utilities for cartographic topics.  We need one of the applications written in python, which already contains all the necessary scripts for working with mapnik.  To download it you need to install Subversion. <br><pre> <code class="bash hljs">$ sudo apt-get install subversion</code> </pre> <br>  Now you can safely download OSM Application.  Create a folder for its location.  for example, I have this / home / osm / mapnik and run checkout. <br><pre> <code class="bash hljs">$ mkdir <span class="hljs-string"><span class="hljs-string">"/home/osm/mapnik"</span></span> $ svn co <span class="hljs-string"><span class="hljs-string">"http://svn.openstreetmap.org/applications/rendering/mapnik"</span></span> <span class="hljs-string"><span class="hljs-string">"/home/osm/mapnik"</span></span></code> </pre> <br>  Now run the script in the application. <br><pre> <code class="bash hljs">$ bash /home/osm/mapnik/get-coastlines.sh</code> </pre> <br>  It downloads us the necessary files with the shapes of the world. <br>  Now you need to create an XML style file.  This is done by the following command: <br><pre> <code class="bash hljs">$ python /home/osm/mapnik/generate_xml.py osm.xml my_osm.xml --dbname osm --user osm --password my_password --accept-none</code> </pre> <br>  This will create a file my_osm.xml with the data to connect to PostgreSQL. <br><br><h4>  Attempt at writing </h4><br>  So the moment has come when you can download any OSM file and generate tiles on its basis.  OSM files can be downloaded from sites presented on the <a href="">wiki.openstreetmap.org/wiki/Planet.osm</a> web page <a href="">.</a> <br>  You can, of course, download the entire Planet.osm file, but do you need it?  When unpacked, it weighs over 250 GB. <br><br>  Suppose we want to generate Moscow tiles on the 17th scale. <br>  Download the required OSM file. <br><pre> <code class="bash hljs">$ wget <span class="hljs-string"><span class="hljs-string">"http://download.bbbike.org/osm/bbbike/Moscow/Moscow.osm.gz"</span></span></code> </pre> <br>  Now we can export it to the database. <br><pre> <code class="bash hljs">$ sudo osm2pgsql -U osm -d osm Moscow.osm.gz</code> </pre> <br>  Everything!  It remains only to run the script for generating tiles.  But before that, we need to slightly edit it in order to indicate the desired scale and coordinates of which tiles we want to receive.  Open the file /home/osm/mapnik/generate_tiles.py.  Set the mapfile variable to point to our my_osm.xml. <br><pre> <code class="python hljs">mapfile = <span class="hljs-string"><span class="hljs-string">"/home/osm/mapnik/my_osm.xml"</span></span></code> </pre> <br>  Next, override the variable that indicates where you want to add tiles. <br><pre> <code class="python hljs">tile_dir = <span class="hljs-string"><span class="hljs-string">"/home/osm/mapnik/all_tiles"</span></span></code> </pre> <br>  The Moscow.osm file that we downloaded has the coordinates of the vector data <br><pre> <code class="python hljs">xMin = <span class="hljs-number"><span class="hljs-number">37.32000</span></span> yMin = <span class="hljs-number"><span class="hljs-number">55.57000</span></span> xMax = <span class="hljs-number"><span class="hljs-number">37.88000</span></span> yMax = <span class="hljs-number"><span class="hljs-number">55.92000</span></span></code> </pre><br>  We find such lines in the script <br><pre> <code class="python hljs">bbox = (<span class="hljs-number"><span class="hljs-number">-180.0</span></span>,<span class="hljs-number"><span class="hljs-number">-90.0</span></span>, <span class="hljs-number"><span class="hljs-number">180.0</span></span>,<span class="hljs-number"><span class="hljs-number">90.0</span></span>) render_tiles(bbox, mapfile, tile_dir, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">"World"</span></span>)</code> </pre><br>  And before them (so as not to overwrite the existing code) we write: <br><pre> <code class="python hljs">bbox = (<span class="hljs-number"><span class="hljs-number">37.32000</span></span>, <span class="hljs-number"><span class="hljs-number">55.57000</span></span>, <span class="hljs-number"><span class="hljs-number">37.88000</span></span>, <span class="hljs-number"><span class="hljs-number">55.92000</span></span>) render_tiles(bbox, mapfile, tile_dir, <span class="hljs-number"><span class="hljs-number">17</span></span>, <span class="hljs-number"><span class="hljs-number">17</span></span>, <span class="hljs-string"><span class="hljs-string">"Moscow"</span></span>) exit()</code> </pre><br>  It is advisable to write exit (), so that the script after generating the Moscow tiles does not violate the generation of the whole world. <br>  4 and 5, the parameters of the render_tiles function set the scale with which for which we will generate tiles.  In this case, we chose only 17 scale. <br><br>  Save and run. <br><pre> <code class="bash hljs">$ python /home/osm/mapnik/generate_tiles.py</code> </pre> <br>  Will the process of generating tiles. <br><br>  [UPD] You can also find a great manual here. <a href="http://switch2osm.org/serving-tiles/manually-building-a-tile-server/">Switch2osm.org/serving-tiles/manually-building-a-tile-server</a> </div><p>Source: <a href="https://habr.com/ru/post/144675/">https://habr.com/ru/post/144675/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../144670/index.html">Creating flexible profiles in Drupal 7</a></li>
<li><a href="../144671/index.html">Mechanical display on the AVR from scratch. Part 0: Programmer (s)</a></li>
<li><a href="../144672/index.html">Debugging Native Android NDK Code on Windows</a></li>
<li><a href="../144673/index.html">Testing iOS Applications</a></li>
<li><a href="../144674/index.html">Roaming Guide 2012: choose fares for travel</a></li>
<li><a href="../144678/index.html">Apple patent application: Safari 3D interface</a></li>
<li><a href="../144679/index.html">Subtleties advancement in FaceBook</a></li>
<li><a href="../144680/index.html">Modern home network and cinema on the couch + Update (about transcoding)</a></li>
<li><a href="../144681/index.html">OmniThreadLibrary library - simple multithreading in Delphi environment</a></li>
<li><a href="../144683/index.html">Programming for everyone: why no</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>