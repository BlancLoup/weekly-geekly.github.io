<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pediatric Bone Age Challenge. Deep learning and many, many bones</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Competition to determine the bone age. Member Notes 
 On October 6, a very interesting contest organized by American radiologists from The Radiologica...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pediatric Bone Age Challenge. Deep learning and many, many bones</h1><div class="post__text post__text-html js-mediator-article"><h4>  Competition to determine the bone age.  Member Notes </h4><br>  On October 6, a very interesting <a href="http://rsnachallenges.cloudapp.net/competitions/4">contest</a> organized by American radiologists from The Radiological Society of North America ( <a href="https://www.rsna.org/">RSNA</a> ) and Radiology Informatics Committee ( <a href="https://www.rsna.org/Radiology_Informatics_Committee.aspx">RIC</a> ) came to <a href="https://www.linkedin.com/in/iglovikov/">Volodya Iglovikov‚Äôs</a> radars, and he threw a cry in the <a href="http://ods.ai/">ODS.ai</a> community <br><br><img src="https://habrastorage.org/webt/tt/eh/mq/ttehmqxcmewoamug1jnbuc-90r4.jpeg"><br><br>  The aim of the competition was to create an automatic system for determining the bone age from X-rays of a hand.  The bone age is used in pediatrics for a comprehensive assessment of the physical development of children, and its deviation from the chronological one helps to identify violations in the work of various body systems.  When it comes to medical projects, I don‚Äôt have to persuade me, but this competition started in August and it seemed like an adventure to join it 8 days before the end.  In order to at least begin the preprocessing of images, hand masks were required, and Volodya made them in a few days, of excellent quality, and shared them with the others.  How he so quickly coped with this difficult task, which included manual marking, is a mystery, and he may write about it himself.  With masks, the idea did not look hopeless anymore, I decided to participate and eventually managed to realize almost all the plans. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Task </h3><br> <a href=""><img src="https://habrastorage.org/webt/sg/qj/ye/sgqjye-xfs4axhj1skgn6ouqnoq.png" width="40%" height="40%" align="right"></a>  <a href="http://www.apreka.ru/%3Fi%3Dopredelenie_kostnogo_vozrasta">Bone age</a> (bone age) - is the conditional age, which corresponds to the level of development of the bones of children and adolescents.  Skeleton formation occurs in several stages.  It is used in pediatrics to compare bone age with chronological, which allows time to notice violations in the endocrine system and metabolic system. <br><br>  To determine the bone age, two methods are mainly used - Greulich and Pyle's GP (Greulich and Pyle) and Tanner TW, Whitehouse and Healy (Tanner, Whitehouse, Healy), developed in the second half of the 20th century.  Both techniques are based on an x-ray of the hand and wrist.  Due to the large number of areas of growing tissue in the bones and nuclei of ossification, <a name="habracut"></a>  using these radiographs, one can trace the appearance of the epiphyses (terminal sections of the tubular bones), the stages of their development, the processes of fusion of the epiphyses with the metaphysis with the formation of bone joints. <br><br>  The GP method is based on comparing radiographs with a special atlas.  <a href="http://vl.academicdirect.ro/medical_informatics/bone_age/v1.0/">Here</a> you can see how bone age is determined by the TW2 method.  The method consists in evaluating 20 specific bones, most of which belong to the wrist or to the joint zone of the metacarpal bones and proximal phalanges.  <a href="http://www.biochemi.ru/chems-469-2.html">Classical methods for</a> determining bone age require considerable time specialists and are highly dependent on subjective assessments, which adversely affects the diagnosis and subsequent therapy. <br><br>  The first and best automatic system for determining bone age today is the commercial <a href="http://www.bonexpert.com/products/the-bonexpert-product">BoneXpert</a> system, approved for use in Europe.  BoneXpert uses the <a href="https://en.wikipedia.org/wiki/Active_appearance_model">AAM</a> computer vision algorithm, with which it reconstructs the contours of 13 palm bones, then determines the bone age according to the GP or TW methodology according to their shape, texture and intensity.  The accuracy of this system is 0.65 years.  Serious limitations of BoneXpert include sensitivity to image quality and the fact that it does not use the bones of the wrist, which are especially important when determining the bone age of young children.  A recent <a href="https://link.springer.com/article/10.1007/s10278-017-9955-8">publication of the</a> ‚ÄúFully Automated Deep Learning System for Bone Age Assessment‚Äù described a machine learning system that showed an accuracy of 0.82‚Äì0.93 years using only radiographs. <br><br>  The task of our competition was to create an automatic system for determining the bone age only by X-ray. <br><br><h3>  Data </h3><br>  The organizers provided 12,611 training, 1,425 validation and 200 test shots collected from three laboratories - Stanford University, the University of Colorado, the University of California.  In the training set 5,778 girls, 6,833 boys.  Age from 1 to 228 months.  In the test set of boys and girls equally. <br><br><img src="https://habrastorage.org/webt/5a/m7/um/5am7umy36awtb3xowahlaxd5jos.png"><br><br>  The pictures were taken on different equipment, at different times and of various types: scale, hand size, orientation, contrast, accompanying inscriptions, frames and other garbage.  Monochrome in png format, typical size is 2044x1514 pixels.  For all the pictures, the gender was indicated, and for the training - the bone age in months, obtained by expert evaluation. <br><br><h3>  Preprocessing </h3><br>  To normalize the contrast and remove debris, it was necessary to zero the background, which was done using V. Iglovikov‚Äôs masks.  Further 2 options were considered: autocontrast and equalize from PIL.ImageOps.  The equalization of the histogram did not suit the fact that it overexposed light areas, and as a result, autocontrast was used. <br><br><img src="https://habrastorage.org/webt/ii/bg/se/iibgseoyvuk5mwsfpxmzuue0vhg.png"><br>  With this preprocessing, one could finish and train the model in pictures of different scales and orientations.  It is possible that it would work.  But in the original techniques, the focus is on several compact zones - the metacarpal bones (Metacarpal), the proximal phalanges (Proximal Phalanx) and the wrist (Carpal).  It was very tempting to train several different models on small areas with high resolution, but for the correct localization of these zones, you first had to bring all the palms to the same size and position, i.e.  to register.  Thus, the further task was reduced to two models: <br><br><ul><li>  for registration of images </li><li>  to determine the age of the specified zones </li></ul><br><br><h3>  Registration of images.  Model number 1 </h3><br> <a href=""><img src="https://habrastorage.org/webt/vn/jv/gu/vnjvguimp_opq32t0r99bmwmqs8.png" width="30%" height="30%" align="right"></a>  The key points were the middle finger tip, the center of the capitate bone in the wrist (Capitate), the tip of the thumb.  Manually tagged 800 shots.  For some reason, it turned out to be difficult to find working software for such a simple task as marking points, but in the end <a href="http://www.robots.ox.ac.uk/~vgg/software/via/">VGG Image Annotator (VIA)</a> was found and perfectly suited.  The images were reduced to a size of 2080x1600 and in the process of training were scaled with a 16-fold reduction. <br><br>  To determine the coordinates of key points (x, y), I used a regression VGG-like model with blocks of 64-128-256, two fully connected layers of 512 neurons, 6 outputs (3 x 2), and the MSE loss function.  VGG block consists of two convolutionary layers with 3x3 and 1x1 filters, batch normalization, ELU activation and MaxPooling 3-2.  I usually use SGD optimizer, but here Adam proved to be good, and time was running out.  Why VGG, not Resnet or Inception?  I don‚Äôt know what this is connected with, but in my tasks VGG often works a little better, and there was no time to choose the architecture again.  Coached with augmentation: rotation, shift, zoom.  The accuracy of localization turned out to be about 3%, which is clearly not the limit, and after the contest there was a desire to try other ways of registering medical images. <br><br><img src="https://habrastorage.org/webt/e2/0-/4t/e20-4t2koyqes0yxxmhurrugjtq.png"><br><br>  When the key points are found, it remains to calculate the affine transformation (scaling, rotation, shift and here and there mirror image), so that the tip of the middle finger and the capitate bone are on the same vertical, 100 pixels from the top and 480 from the bottom, respectively, and the thumb is on the right: <br><br><img src="https://habrastorage.org/webt/wc/9p/mt/wc9pmtjeetkjxedamir6qrk3lfu.png"><br><br><h3>  Main model </h3><br>  As you can guess, this is also a regression VGG model, but working on large pictures and deeper: blocks 32-64-128-128-256-384, two fully connected layers of 2048 neurons and one output.  The competition metric was Mean Absolute Distance, respectively, and the model used Mean Absolute Error (MAE) as a loss function.  At the entrance there are pictures 2080x1600, but for this model a generator was written that makes a crop of a given size from a given zone with augmentation and scaling.  3 zones were selected: <br><br>  A) the whole hand, crop 2000x1500, scale 1: 4 <br>  B) wrist, cropping 750x750, scale 1: 2 <br>  C) Metacarpals and proximal phalanges, 600x1400, scale 1: 3 <br><br><img src="https://habrastorage.org/webt/t7/-k/oz/t7-koz4_l-ir2j5hjoljnj_acsg.png"><br><br>  So 3 models from different zones were trained.  There were 2 days left until the end of the competition, and I didn‚Äôt do a full cross-qualification;  the models trained on 11,600 pictures and validated for 1,000.  Thanks to augmentation and dropout, convergence was very even, with no signs of retraining. <br><br> <a href=""><img src="https://habrastorage.org/webt/ta/ev/sy/taevsygqsjrkc5stjlgpmgyqtiu.png" width="30%" height="30%" align="right"></a>  It turned out that the model trained on the wrist (zone B) is almost as good as the model for the whole arm (A) with an area of ‚Äã‚Äã5.3 times larger.  An unexpected result was shown by a model on the metacarpal bones (C), which was not pinned much hope.  It turned out to be better (B) and in some cases slightly better (A), although in the TW2 method, the zone of metacarpal bones is given not the greatest value, but its area is less (A) 3.6 times. <br><br>  At the end of the competition, I remembered that in standard techniques, bone age is determined by gender.  Tyunig models separately for boys and girls gave a significant improvement, about 1.4 months, and instead of three models, it was six. <br><br>  And after the official completion, one misunderstanding helped to realize the idea, which was not reached in time - classification instead of regression.  The organizers appointed the end of the competition at ‚Äúmidnight October 15‚Äù.  We at <a href="http://ods.ai/">ODS.ai</a> thought it was midnight between 15 and 16, but on October 14 we learned that there were several hours left until completion and we barely had time to submit our decisions.  As it should be with such a beautiful deadline, not everyone was lucky.  Several contestants got caught, started complaining, the competition was extended for a day, and I had an extra day. <br><br>  The classification was not entirely traditional.  The role of classes was played by age in months, but the output of the network was not probabilities, but the expectation of age for all classes.  I considered different variants of quantization, and the simplest, 1 month - 1 class, only 240 classes, showed the best.  In the penultimate layer, I set softmax to 240 outputs, which scalar multiplied by the age vector (0, ..., 239 normalized to [-1, 1]).  He trained a model with the same labels and the same loss function (MAE) as in the case of regression. <br><br><img src="https://habrastorage.org/webt/ec/xq/7k/ecxq7kg7o8wphgskhn_snfzd3k4.png"><br><br>  Separate classification models only slightly exceeded the regression models, but they entered a linear ensemble with more significant weights and markedly improved the overall result. <br><br><img src="https://habrastorage.org/webt/kl/do/dj/kldodjzehpn713vdovwihsdt1e8.png"><br><br><h3>  Conclusion </h3><br>  The competition turned out to be wonderful and the most impetuous of all in which I had to participate.  I am grateful to the organizers for a very interesting topic, <a href="https://www.linkedin.com/in/iglovikov/">V.Iglovikov</a> - for <a href="https://www.linkedin.com/in/iglovikov/">drawing</a> me into this and helping with masks, <a href="https://www.linkedin.com/in/stromnov/">A.Stromnov</a> , <a href="https://www.linkedin.com/in/alexey-shvets-b0215263/">A.Shvets</a> , <a href="http://yorko.github.io/">Yu.</a> <a href="https://www.linkedin.com/in/alexey-shvets-b0215263/">Kashnitsky</a> , <a href="http://yorko.github.io/">P.Nesterov</a> - for comments and corrections to the text. <br><br>  It was possible to do almost everything planned, except for the boosting of features from the last layers.  But this is unlikely to significantly improve the result: it seems that the limit associated with the ambiguity of the annotation of images, as is often the case in medical ML, has been reached. <br><br>  I hope that our results will benefit medicine.  The accuracy of bone age, shown by <a href="http://ods.ai/">ODS.ai</a> participants on the test sample (A.Rakhlin - 4.97 months / 13th place, V.Iglovikov - 5.41 / 18, A.Shvets - 5.50 / 19), significantly exceeded BoneXpert and ‚ÄúFully Automated Deep Learning System for Bone Age Assessment ‚Äùwith their 0.65 and 0.82‚Äì0.93 years, respectively.  We look forward to making decisions of the winners, which will be presented at the annual RSNA conference next month, where we are also invited. <br><br>  Update December 15th. <br>  Published an article on <a href="https://doi.org/10.1101/234120">bioRxiv</a> and <a href="https://arxiv.org/abs/1712.05053">arXiv</a> .  Added description of segmentation and various statistics in the context of the chronological stages of development of the skeleton. </div><p>Source: <a href="https://habr.com/ru/post/341408/">https://habr.com/ru/post/341408/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../341398/index.html">Money monoid</a></li>
<li><a href="../341400/index.html">Cryptopolicy: law enforcement agencies on blockchain technology</a></li>
<li><a href="../341402/index.html">Kotlin DSL: Theory and Practice</a></li>
<li><a href="../341404/index.html">On the development of a single desktop application in Python</a></li>
<li><a href="../341406/index.html">Dataset: associations to the words and expressions of the Russian language</a></li>
<li><a href="../341410/index.html">B2BX: the economy of ICO and the main areas of expenditure of investors' money B2BX</a></li>
<li><a href="../341426/index.html">Reactive brain waves: a story about Muse, JS and browsers</a></li>
<li><a href="../341428/index.html">Kali Linux: kernel build</a></li>
<li><a href="../341430/index.html">Club of anonymous Santa Clauses 2017-2018 on Habrahabr</a></li>
<li><a href="../341432/index.html">Widget Ideas for Online Surfing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>