<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a native extension library for OpenFL, part two</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 This is a continuation of the translation of a series of articles about creating extensions for OpenFL from Laurent B√©dubourg. In the first...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a native extension library for OpenFL, part two</h1><div class="post__text post__text-html js-mediator-article"><h4>  Foreword </h4><br>  This is a continuation of the translation of a series of articles about creating extensions for OpenFL from Laurent B√©dubourg.  In the <a href="http://habrahabr.ru/post/186230/">first part,</a> we created a simple extension and compiled it for native platforms (Linux / Windows, Android, iOS).  In this part we will add the ability to send tweets to our iOS application. <br><br>  What we learn: <br><ul><li>  how to structure the source code of our extension for various platforms </li><li>  how to link haxe code and functions from our extension </li><li>  how to link with iOS frameworks (with the Twitter framework in particular) </li></ul><br><a name="habracut"></a><br><h4>  What to do? </h4><br>  Let's start by looking at how the <a href="https://github.com/haxenme/NME/tree/master/project">NME</a> project is structured, for example. <br><br>  At first glance, <a href="">Build.xml</a> looks complicated and we will return to it later.  Looking at the contents of the directory, we will see the following: <br><ul><li>  include / contains header files to be implemented in common / and plaforms </li><li>  common / platform-independent c ++ code (more or less platform-independent, we can use #if defined (HX_xxxx) to achieve maximum platform-independence) </li><li>  common / ExternalIterface.cpp exports functions to the runtime (DEFINE_PRIM) </li><li>  platform in this directory contains implementations for specific platforms (iPhone, Mac, windows and others) </li></ul><br>  In my opinion, such a structure looks quite comfortable, let us and we will use it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's start with our previous extension, we have to declare the Tweet () function in the existing include / Util.h file (by the mind, we have to use a separate header file, but today I am too lazy to do this). <br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> testextension { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SampleMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> inputValue)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Tweet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* msg)</span></span></span></span>; }</code> </pre> <br>  Now we need to implement it for the iphone platform: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> project mkdir iPhone</code> </pre><br>  Create an iPhone / Tweet.mm file: <br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Twitter/Twitter.h&gt;</span></span></span><span class="hljs-meta"> namespace testextension { bool Tweet(const char* message){ //       Objective-C //        //        //          :) NSString* str = [[NSString alloc] initWithUTF8String:message]; TWTweetComposeViewController* tweetView = [[TWTweetComposeViewController alloc] init]; [tweetView setInitialText:str]; TWTweetComposeViewControllerCompletionHandler completionHandler = ^(TWTweetComposeViewControllerResult result) { [[[[UIApplication sharedApplication] keyWindow] rootViewController] dismissModalViewControllerAnimated:YES]; }; [tweetView setCompletionHandler:completionHandler]; [[[[UIApplication sharedApplication] keyWindow] rootViewController] presentModalViewController:tweetView animated:YES]; return true; } }</span></span></code> </pre><br>  And register the Tweet function in haxe, for this we edit the file common / ExternalInterface.cpp: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> value </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testextension_tweet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(value message)</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  ,  message        const char* cStr = val_get_string(message); //    Tweet    haxe true  false if (testextension::Tweet(cStr)) return val_true; return val_false; } //   ,      DEFINE_PRIM(testextension_tweet, 1)</span></span></code> </pre><br>  DEFINE_PRIME, val_get_string, val_true and everything else are part of hxcpp and are defined in <a href="">hx / CFFI.h.</a> <br><br>  Learning about <a href="">ExternalInterface.cpp</a> from NME will help you understand how to register your functions. <br><br>  The haxe part is in TextExtension.hx and looks like this: <br><pre> <code class="actionscript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestExtension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    private static var testextension_tweet = Lib.load("testextension", "testextension_tweet", 1); //       public static function tweet(message:String) : Bool { return testextension_tweet(message); } }</span></span></code> </pre><br><h4>  How to compile </h4><br>  I had to make an effort to figure out how to compile and link the project, but as a result, everything turned out to be quite simple. <br><br>  First you need to create a project / Build.xml file: <br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!--       ios --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">files</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"iphone"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">file</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"iPhone/Tweet.mm"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">files</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--        ,     : "Library TestExtension version dev does not have a neko dll for your system" --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">files</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"mac"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">file</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Mac/Tweet.mm"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">files</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  In the section with id = NDLL, you need to add files that will be compiled: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">files</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"mac"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"mac"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">files</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"iphone"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ios"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre><br>  Finally, we need to add the Twitter framework depending on the include.xml.  Through this file, hxcpp will know what frameworks need to be added to our application. <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Twitter.framework"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ios"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre><br>  I compiled the extension, just like I did in the <a href="http://habrahabr.ru/post/186230/">first part</a> . <br><pre> <code class="bash hljs">haxelib run hxcpp Build.xml -Dmac haxelib run hxcpp Build.xml -Diphoneos -DHXCPP_ARMV7 haxelib run hxcpp Build.xml -Diphonesim</code> </pre><br><h4>  How to start </h4><br>  To test the operation of the extension, I added the following call to my test application: <br><pre> <code class="actionscript hljs">TestExtension.tweet(<span class="hljs-string"><span class="hljs-string">"This is my tweet message"</span></span>);</code> </pre><br>  And I launched it in the simulator and on my iOS device: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> TestApp openfl <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> project.xml iphone -simulator openfl <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> project.xml iphone</code> </pre><br><img src="https://habrastorage.org/storage2/977/3a5/4ac/9773a54ac009f4fb9e97373a8de9451f.png" alt="IPhone application window"><br>  We can tweet using the native API from our application!  Cool, is not it?  :) <br><br>  I want to note one very important thing - the way I got the information - I found it in the source code of hxcpp and nme, on a githaba. <br><br>  Trying to make it all work, I ran into several problems.  If you are experimenting and something is not working out for you, do not forget to clear the ndl / and project / obj directories and rebuild the entire project.  I continued to experiment until I found a suitable format for Build.xml and include.xml. <br><br>  The only real difficulty is the lack of documentation on the Build.xml format in hxcpp.  But, thank God, there are examples on which to learn. <br><br>  The next thing I want to do is try to build an extension for android to make sure everything works on this platform.  They say that not only developing an extension to java, but also describing this process will be useful :) <br><br>  I updated the <a href="https://github.com/labe-me/openfl-extension-example">github</a> expansion repository, in the hope that my small contribution would be useful to other haxers!  I hope this tutorial will work on your system ... although sometimes things don‚Äôt go as far as they think;) </div><p>Source: <a href="https://habr.com/ru/post/186722/">https://habr.com/ru/post/186722/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../186710/index.html">PHPShop PriceLoader: batch processing of price lists and uploading images to an online store. Part 2</a></li>
<li><a href="../186712/index.html">New edition of CLR via C # is now available.</a></li>
<li><a href="../186716/index.html">Learning platform LendWings, as we have come to Russian e-Learning</a></li>
<li><a href="../186718/index.html">We get access to private properties of objects in PHP without reflection</a></li>
<li><a href="../186720/index.html">Video review of Asus N550JV and N750JV laptops</a></li>
<li><a href="../186724/index.html">Harvard Master's Degree - Reality</a></li>
<li><a href="../186728/index.html">Interesting and informative: we are witnessing milestones in the history of astronautics with the Orbiter</a></li>
<li><a href="../186730/index.html">Game "sea battle": the placement of ships</a></li>
<li><a href="../186732/index.html">Using screen to log user actions (auditing) on ‚Äã‚ÄãLinux</a></li>
<li><a href="../186736/index.html">The most antimagnetic watch in the world</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>