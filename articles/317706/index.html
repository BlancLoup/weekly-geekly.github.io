<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Android Fingerprint API: we assign fingerprint authentication</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! It took quite a lot of time, as the Fingerprint API for Android appeared, there are many separate samples of code for its implementation and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Android Fingerprint API: we assign fingerprint authentication</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr!  It took quite a lot of time, as the Fingerprint API for Android appeared, there are many separate samples of code for its implementation and use on the network, but for some reason this topic was avoided on Habr√©.  In my opinion, it is time to correct this misunderstanding.  All interested in asking under the cat. <br><br><img src="https://habrastorage.org/files/7a1/40c/d43/7a140cd4306948bd99d0072315b53bd7.png"><br><a name="habracut"></a><br><h3>  The shortest educational program </h3><br>  So what is the Fingerprint API?  The API allows the user to authenticate with his fingerprint, <a href="https://developer.android.com/about/versions/marshmallow/android-6.0.html">obviously</a> .  To work with the sensor, the API offers us a <i><a href="https://developer.android.com/reference/android/hardware/fingerprint/FingerprintManager.html">FingerprintManager</a></i> , fairly simple to learn. <br><br>  How to use it?  But this is more interesting.  Almost everywhere where password authentication is required, you can fasten fingerprint authentication.  Imagine an application consisting of <i>LoginActivity</i> and <i>MainActivity</i> .  When you start, we get to the login screen, enter the pin code, go to the data.  But we want to replace the input by pin-code to the input by print.  By the way, it will not be possible to completely replace, we can only save the user from manually entering the PIN code, substituting the previously saved PIN code (meaning the client-server application, in which you need to send the password to the server). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's get started <br><br><h3>  Where is the sensor? </h3><br>  To start getting profit from the new API, first of all you need to add <i>permission</i> in the manifest: <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.USE_FINGERPRINT"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre> <br>  Of course, you can use the Fingerprint API only on devices that support it: respectively, these are Android 6+ devices with a sensor. <br><br>  Compatibility can be easily verified using the method: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkFingerprintCompatibility</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@NonNull Context context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FingerprintManagerCompat.from(context).isHardwareDetected(); }</code> </pre> <br>  <i><a href="https://developer.android.com/reference/android/support/v4/hardware/fingerprint/FingerprintManagerCompat.html">FingerprintManagerCompat</a></i> is a handy wrapper for the regular <i>FingerprintManager</i> , which simplifies device compatibility testing by encapsulating an API version check.  In this case, <i>isHardwareDetected ()</i> will return <i>false</i> if the API is below 23. <br><br>  Next, we need to understand whether the sensor is ready for use.  To do this, we define the <i>enum</i> states: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> SensorState { NOT_SUPPORTED, NOT_BLOCKED, <span class="hljs-comment"><span class="hljs-comment">//     ,    NO_FINGERPRINTS, //      READY }</span></span></code> </pre> <br>  And use the method: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> SensorState </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkSensorState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@NonNull Context context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (checkFingerprintCompatibility(context)) { KeyguardManager keyguardManager = (KeyguardManager) context.getSystemService(KEYGUARD_SERVICE); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!keyguardManager.isKeyguardSecure()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SensorState.NOT_BLOCKED; } FingerprintManagerCompat fingerprintManager = FingerprintManagerCompat.from(context); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!fingerprintManager.hasEnrolledFingerprints()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SensorState.NO_FINGERPRINTS; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SensorState.READY; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SensorState.NOT_SUPPORTED; } }</code> </pre> <br>  The code is quite trivial.  A small misunderstanding can cause a moment when we check whether the device is locked.  We need this check, since, although Android does not allow adding fingerprints to an unprotected device, some manufacturers bypass this, so it will not hurt to be safe. <br><br>  Different states can be used to make the user understand what is happening and direct him to the true path. <br><br><h3>  Training </h3><br>  So, without dwelling on checking the pin-code for validity, let's estimate the following simplified logic of actions: <br><br><ul><li>  The user enters the PIN code, if <i>SensorState.READY</i> , then we save the PIN code, run the <i>MainActivity</i> . </li><li>  Restart the application, if <i>SensorState.READY</i> , then we read the fingerprint, we get the pin-code, we simulate its input, we start the <i>MainActivity</i> . </li></ul><br>  The scheme would be quite simple if it were not for one thing: Google strongly recommends not to store private user data in the clear.  Therefore, we need an encryption and decryption mechanism to store and use, respectively.  Let's do it. <br><br>  What we need to encrypt and decrypt: <br><br><ol><li>  Secure storage for keys. </li><li>  Cryptographic key. </li><li>  Cryptographer </li></ol><br><h4>  Storage </h4><br>  To work with prints, the system provides us with its keystory - <i><a href="https://developer.android.com/training/articles/keystore.html">‚ÄúAndroidKeyStore‚Äù</a></i> and guarantees protection against unauthorized access.  We use it: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> KeyStore sKeyStore; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getKeyStore</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { sKeyStore = KeyStore.getInstance(<span class="hljs-string"><span class="hljs-string">"AndroidKeyStore"</span></span>); sKeyStore.load(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (KeyStoreException | IOException | NoSuchAlgorithmException | CertificateException e) { e.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> </pre> <br>  It should be accepted, understood and forgiven that the <b>keystor only stores cryptographic keys</b> .  Passwords, pins and other private data can not be stored there. <br><br><h4>  Key </h4><br>  We have two options to choose from: a symmetric key and a pair of public and private keys.  For UX reasons, we will use a pair.  This will allow us to separate fingerprint input from pin-code encryption. <br><br>  We will get the keys from keystor, but first we need to put them there.  To create a key, use the <a href="https://developer.android.com/reference/java/security/KeyPairGenerator.html">generator</a> . <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> KeyPairGenerator sKeyPairGenerator; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getKeyPairGenerator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { sKeyPairGenerator = KeyPairGenerator.getInstance(KeyProperties.KEY_ALGORITHM_RSA, <span class="hljs-string"><span class="hljs-string">"AndroidKeyStore"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (NoSuchAlgorithmException | NoSuchProviderException e) { e.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> </pre> <br>  During initialization, we specify in which keystars the generated keys go and for what algorithm this key is intended. <br><br>  The generation itself is as follows: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generateNewKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getKeyPairGenerator()) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { sKeyPairGenerator.initialize(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyGenParameterSpec.Builder(KEY_ALIAS, KeyProperties.PURPOSE_ENCRYPT | KeyProperties.PURPOSE_DECRYPT) .setDigests(KeyProperties.DIGEST_SHA256, KeyProperties.DIGEST_SHA512) .setEncryptionPaddings(KeyProperties.ENCRYPTION_PADDING_RSA_OAEP) .setUserAuthenticationRequired(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) .build()); sKeyPairGenerator.generateKeyPair(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InvalidAlgorithmParameterException e) { e.printStackTrace(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> </pre> <br>  Here you should pay attention to two places: <br><br><ul><li>  KEY_ALIAS is the alias of the key by which we will pull it out of the keystar, the usual psfs. </li><li>  .setUserAuthenticationRequired (true) - this flag indicates that every time we need to use a key, we will need to confirm ourselves, in our case, with a fingerprint. </li></ul><br>  We will check the availability of the key as follows: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isKeyReady</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sKeyStore.containsAlias(KEY_ALIAS) || generateNewKey(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (KeyStoreException e) { e.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> </pre> <br><h4>  Cryptographer </h4><br>  Encryption and decryption in Java is handled by a <i><a href="https://developer.android.com/reference/javax/crypto/Cipher.html">Cipher</a></i> object. <br><br>  We initialize it: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Cipher sCipher; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCipher</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { sCipher = Cipher.getInstance(<span class="hljs-string"><span class="hljs-string">"RSA/ECB/OAEPWithSHA-256AndMGF1Padding"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (NoSuchAlgorithmException | NoSuchPaddingException e) { e.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> </pre> <br>  The hell hash in the argument is a transformation string that includes the <a href="https://ru.wikipedia.org/wiki/RSA">algorithm</a> , <a href="https://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B5%25D0%25B6%25D0%25B8%25D0%25BC_%25D1%2588%25D0%25B8%25D1%2584%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F">blend mode,</a> and <a href="https://ru.wikipedia.org/wiki/%25D0%2594%25D0%25BE%25D0%25BF%25D0%25BE%25D0%25BB%25D0%25BD%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_(%25D0%25BA%25D1%2580%25D0%25B8%25D0%25BF%25D1%2582%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D1%2584%25D0%25B8%25D1%258F)">padding</a> . <br><br>  After we got <i>Cipher</i> , we need to prepare it for work.  When generating the key, we indicated that we would use it only for encryption and decryption.  Accordingly, <i>Cipher</i> will also be for these purposes: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initCipher</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> mode)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { sKeyStore.load(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (mode) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Cipher.ENCRYPT_MODE: initEncodeCipher(mode); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Cipher.DECRYPT_MODE: initDecodeCipher(mode); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-comment"><span class="hljs-comment">//this cipher is only for encode\decode } return true; } catch (KeyPermanentlyInvalidatedException exception) { deleteInvalidKey(); } catch (KeyStoreException | CertificateException | UnrecoverableKeyException | IOException | NoSuchAlgorithmException | InvalidKeyException | InvalidKeySpecException | InvalidAlgorithmParameterException e) { e.printStackTrace(); } return false; }</span></span></code> </pre><br>  where <i>initDecodeCipher ()</i> and <i>initEncodeCiper () are</i> as follows: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initDecodeCipher</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> mode)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> KeyStoreException, NoSuchAlgorithmException, UnrecoverableKeyException, InvalidKeyException </span></span>{ PrivateKey key = (PrivateKey) sKeyStore.getKey(KEY_ALIAS, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); sCipher.init(mode, key); }</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initEncodeCipher</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> mode)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> KeyStoreException, InvalidKeySpecException, NoSuchAlgorithmException, InvalidKeyException, InvalidAlgorithmParameterException </span></span>{ PublicKey key = sKeyStore.getCertificate(KEY_ALIAS).getPublicKey(); PublicKey unrestricted = KeyFactory.getInstance(key.getAlgorithm()).generatePublic(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> X509EncodedKeySpec(key.getEncoded())); OAEPParameterSpec spec = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OAEPParameterSpec(<span class="hljs-string"><span class="hljs-string">"SHA-256"</span></span>, <span class="hljs-string"><span class="hljs-string">"MGF1"</span></span>, MGF1ParameterSpec.SHA1, PSource.PSpecified.DEFAULT); sCipher.init(mode, unrestricted, spec); }</code> </pre> <br>  It is easy to see that the encrypting <i>Cipher is</i> somewhat more difficult to initialize.  This is a cant of Google itself, the essence of which is that the public key requires user confirmation.  We circumvent this requirement with a key cast ( <a href="http://stackoverflow.com/a/36021145/5884194">crutch</a> , yeah). <br><br>  The moment with <i>KeyPermanentlyInvalidatedException</i> - if for some reason the key cannot be used, it will fire this exception.  Possible reasons - adding a new fingerprint to an existing one, changing or completely removing a lock.  Then the key no longer has to be stored, and we delete it. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteInvalidKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getKeyStore()) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { sKeyStore.deleteEntry(KEY_ALIAS); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (KeyStoreException e) { e.printStackTrace(); } } }</code> </pre> <br>  The method that collects the entire training chain: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepare</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getKeyStore() &amp;&amp; getCipher() &amp;&amp; isKeyReady(); }</code> </pre> <br><h3>  Encryption and decryption </h3><br>  We describe a method that encrypts a string argument: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String inputString)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (prepare() &amp;&amp; initCipher(Cipher.ENCRYPT_MODE)) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytes = sCipher.doFinal(inputString.getBytes()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Base64.encodeToString(bytes, Base64.NO_WRAP); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IllegalBlockSizeException | BadPaddingException exception) { exception.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }</code> </pre> <br>  As a result, we get a <i>Base64</i> string, which can be safely stored in the preferences of the application. <br><br>  To decrypt, use the following method: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String encodedString, Cipher cipherDecrypter)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytes = Base64.decode(encodedString, Base64.NO_WRAP); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String(cipherDecrypter.doFinal(bytes)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IllegalBlockSizeException | BadPaddingException exception) { exception.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }</code> </pre> <br>  Oops, at the entrance he gets not only an encrypted string, but also a <i>Cipher</i> object.  Where he came from there, it will become clear later. <br><br><h3>  Wrong finger </h3><br>  In order to finally use the sensor, you need to use the <i>FingerprintManagerCompat</i> method: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">authenticate</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FingerprintManagerCompat.CryptoObject crypto, CancellationSignal cancel, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> flags, FingerprintManagerCompat.AuthenticationCallback callback, Handler handler)</span></span></span></span></code> </pre> <br>  Handler and flags are not needed right now, the signal is used to cancel fingerprint reading mode (when minimizing the application, for example), callbacks return the result of a specific readout, but let's stop in more detail above the crypto object. <br><br>  <i><a href="https://developer.android.com/reference/android/support/v4/hardware/fingerprint/FingerprintManagerCompat.CryptoObject.html">CryptoObject</a></i> in this case is used as a wrapper for <i>Cipher</i> .  To get it, use the method: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> FingerprintManagerCompat.<span class="hljs-function"><span class="hljs-function">CryptoObject </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCryptoObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (prepare() &amp;&amp; initCipher(Cipher.DECRYPT_MODE)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FingerprintManagerCompat.CryptoObject(sCipher); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }</code> </pre> <br>  As can be seen from the code, the crypto object is created from the <b>decrypting</b> <i>Cipher</i> .  If this <i>Cipher</i> is sent to the <i>decode ()</i> method right now, an exception will be thrown indicating that we are trying to use the key without confirmation. <br><br>  Strictly speaking, we create a crypto object and send it to the entrance to <i>authenticate ()</i> just to receive this confirmation. <br><br>  If <i>getCryptoObject ()</i> returns <i>null</i> , this means that during the initialization of the <i>Chiper</i> , a <i>KeyPermanentlyInvalidatedException</i> occurred.  There is nothing you can do except to let the user know that the fingerprint input is unavailable and he will have to re-enter the PIN code. <br><br>  As I said before, we get the results of sensor reading in the <a href="https://developer.android.com/reference/android/support/v4/hardware/fingerprint/FingerprintManagerCompat.AuthenticationCallback.html">kollbek</a> methods.  Here's what they look like: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onAuthenticationHelp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> helpCode, CharSequence helpString)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ,    //  helpString    } @Override public void onAuthenticationFailed() { // ,    } @Override public void onAuthenticationError(int errorCode, CharSequence errString) { //    (5) //        (30 ) } @Override public void onAuthenticationSucceeded(@NonNull FingerprintManagerCompat.AuthenticationResult result) { //   }</span></span></code> </pre> <br>  In case of successful recognition, we get an <i>AuthenticationResult</i> , from which we can get a <i>Cipher</i> object with an already confirmed key: <br><br><pre> <code class="java hljs">result.getCryptoObject().getCipher()</code> </pre> <br>  Now you can send it to <i>decode ()</i> with a clear conscience, get a pin code, simulate its input and show the user its data. <br><br>  That's all for today, comments, comments, suggestions and questions are welcome. <br>  The simplest version of the code can look at the <a href="https://github.com/AzretMagometov/FingerprintSample">githaba</a> . <br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/317706/">https://habr.com/ru/post/317706/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317696/index.html">Why has the activity of venture funds of Russia increased?</a></li>
<li><a href="../317698/index.html">How to construct words (from an author who hates reading)</a></li>
<li><a href="../317700/index.html">As we have 4 years survived in terms of two releases per day</a></li>
<li><a href="../317702/index.html">Books recommended Y Combinator for the winter holidays 2016-2017</a></li>
<li><a href="../317704/index.html">Co-location: data centers vs small and medium business?</a></li>
<li><a href="../317708/index.html">Landing Page as a replacement for the entire site</a></li>
<li><a href="../317710/index.html">Survival Guide for a Western IT Company</a></li>
<li><a href="../317712/index.html">The logic of consciousness. Part 9. Artificial neural networks and minicolumns of the real cortex.</a></li>
<li><a href="../317714/index.html">Immigration with the Crimea to Russia</a></li>
<li><a href="../317716/index.html">Gogland: JetBrains New Go IDE</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>