<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cooking Linux on Asus U31SD / P31SD and the like</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After purchasing the Asus P31SD and installing Linux on it, it was a shame to see only 6 hours of battery life instead of the desired 10-12. It was no...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cooking Linux on Asus U31SD / P31SD and the like</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/444/023/f51/444023f51a0e47c5ebc883aac1cfd93f.jpg"><br>  After purchasing the Asus P31SD and installing Linux on it, it was a shame to see only 6 hours of battery life instead of the desired 10-12.  It was not possible to return back to Windows (even cywgin did not help here), so it was decided to stock up on coffee and take the next weekend to solve these problems. <br><br>  We consider the solution on the example of Ubuntu 11.10. <br><br>  <b>PS</b> In theory, the guide is suitable for all laptops with Sandybridge and Nvidia Optimus. <br><a name="habracut"></a><br>  An important, for us, part of the laptop configuration: <br>  <i>Processor</i> : Intel Core i3-2310M ( <b>Sandybridge</b> ) <br>  <i>Video adapter</i> : Nvidia Geforce 520M ( <b>Nvidia Optimus</b> ) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, immediately after installing Linux, we see the following problems: <br><ol><li>  Crazy brightness. </li><li>  Increased energy consumption is our primary goal. </li><li>  Sleep does not work - to make life easier, make it work </li></ol><br><h2>  Brightness </h2><br>  Symptom: the backlight tries to simultaneously control the hardware module and the software module from the DE, resulting in jumps in a random direction. <br><br>  Problems with brightness in laptops are very common and varied, but almost everything is solved by one method: adding core to the kernel boot parameters <code>acpi_backlight=vendor</code> , which signals that the hardware controls the brightness and does not need to programmatically climb there. <br><br>  Open <code>/etc/default/grub</code> and enter the parameter in <code>GRUB_CMDLINE_LINUX</code> , you get: <br><pre> <code class="bash hljs">GRUB_CMDLINE_LINUX=<span class="hljs-string"><span class="hljs-string">"acpi_backlight=vendor"</span></span></code> </pre> <br>  We save, update the grub configuration ( <code>sudo update-grub</code> ), reboot and enjoy the highlight behavior. <br><br><h2>  Sleeping mode </h2><br>  Symptom: when sending a laptop to sleep, the device violently resists and eventually freezes. <br><br>  After a brief search, we find the culprits: badly falling asleep USB hubs.  And next we find the solution for the <code>pm-utils</code> hook: <br> <code>/etc/pm/sleep.d/20_custom-asus-u31sd:</code> <br> <pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh BUSES="0000:00:1a.0 0000:00:1d.0" case "${1}" in hibernate|suspend) # Switch USB buses off for bus in $BUSES; do echo -n $bus | tee /sys/bus/pci/drivers/ehci_hcd/unbind done ;; resume|thaw) # Switch USB buses back on for bus in $BUSES; do echo -n $bus | tee /sys/bus/pci/drivers/ehci_hcd/bind done ;; esac</span></span></code> </pre><br>  Save, make executable ( <code>sudo chmod +x /etc/pm/sleep.d/20_custom-asus-u31sd</code> ), check. <br>  Works?  Nearly.  After getting out of sleep, the display brightness drops to a minimum ... You can correct the mistake in the same hook.  You can get the brightness value somewhere from / sys.  Most drivers call the parameters trite so just look for backlight there: <br><pre> <code class="bash hljs">$ find /sys -name backlight /sys/devices/platform/asus-nb-wmi/backlight</code> </pre><br>  Found!  After studying the viscera, the brightness value was in <code>/sys/devices/platform/asus-nb-wmi/backlight/asus-nb-wmi/brightness</code> .  Let's add to the previous hook its saving and restoring: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh BUSES="0000:00:1a.0 0000:00:1d.0" case "${1}" in hibernate|suspend) # Switch USB buses off for bus in $BUSES; do echo -n $bus | tee /sys/bus/pci/drivers/ehci_hcd/unbind done # Saving brightness to /tmp/br cat /sys/devices/platform/asus-nb-wmi/backlight/asus-nb-wmi/brightness &gt; /tmp/br ;; resume|thaw) # Switch USB buses back on for bus in $BUSES; do echo -n $bus | tee /sys/bus/pci/drivers/ehci_hcd/bind done # Restoring brightness from /tmp/br cat /tmp/br &gt; /sys/devices/platform/asus-nb-wmi/backlight/asus-nb-wmi/brightness ;; esac</span></span></code> </pre><br>  Check it again and ... it works!  Now let's get down to the main enemy, power consumption. <br><br><h2>  Increased energy consumption </h2><br>  Shoot the appetites of Linux will be already in 3 stages. <br><br><h3>  1. Discrete graphics </h3><br>  The laptop is equipped with two video adapters: integrated (Intel) and discrete (Nvidia).  But not a simple Nvidia, and working on technology Nvidia Optimus.  That same Optimus, whose support in the foreseeable future in Linux is not expected. <br><br>  But the glory of the open-sourc world is full of enthusiasts.  <a href="https://github.com/Bumblebee-Project">Bumblebee</a> deals with Optimus (and sometimes friendship).  They have made good progress: <br><ul><li>  Bumblebee can enable / disable discrete card depending on needs </li><li>  Bumblebee can make apps use a discrete card </li></ul><br>  Naturally the project is full of crutches, but it's still better than nothing. <br>  Let's install: <br><pre> <code class="bash hljs">$ sudo add-apt-repository ppa:bumblebee/stable $ sudo apt-get update $ sudo apt-get install bumblebee</code> </pre><br>  Unfortunately, virtually every laptop has a different ACPI video card on / off command (a large table is compiled <a href="http://hybrid-graphics-linux.tuxfamily.org/index.php%3Ftitle%3DACPI_calls">here</a> ), so power management in Bumblebee is turned off by default.  From the table above, take the commands and write them in <code>/etc/bumblebee/cardoff</code> and <code>/etc/bumblebee/cardon</code> respectively: <br> <code>/etc/bumblebee/cardoff: <br> \_SB.PCI0.PEG0.GFX0.DOFF <br> <br> /etc/bumblebee/cardon: <br> \_SB.PCI0.PEG0.GFX0.DON <br></code> <br>  Then in <code>/etc/bumblebee/bumblebee.conf</code> power management: <br><pre> <code class="bash hljs">ENABLE_POWER_MANAGEMENT=Y</code> </pre> <br>  and force the service to terminate (and turn off the discrete video card accordingly) if nobody uses it: <br><pre> <code class="hljs">STOP_SERVICE_ON_EXIT=Y</code> </pre> <br>  We save, reboot, look at the energy consumption - significantly decreased. <br>  Before we go further, we fix the waiting mode again: the fact is that when going to sleep, the active video driver (nvidia or nouveau) will try to prepare a card, but the card is turned off.  Let's just decide and "in the forehead": add 2 commands to the previously used hook: <br><ul><li>  We will include the card before falling asleep. </li><li>  We will turn off the card after waking up. </li></ul><br>  The hook will look like this: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh BUSES="0000:00:1a.0 0000:00:1d.0" case "${1}" in hibernate|suspend) # Switch USB buses off for bus in $BUSES; do echo -n $bus | tee /sys/bus/pci/drivers/ehci_hcd/unbind done cat /sys/devices/platform/asus-nb-wmi/backlight/asus-nb-wmi/brightness &gt; /tmp/br # Switch optimus back on before going to sleep, avoids the "constant on" # bug that occurs after 2 suspend/resume cycles (thanks kos888) echo `cat /etc/bumblebee/cardon` | tee /proc/acpi/call ;; resume|thaw) # Switch USB buses back on for bus in $BUSES; do echo -n $bus | tee /sys/bus/pci/drivers/ehci_hcd/bind done cat /tmp/br &gt; /sys/devices/platform/asus-nb-wmi/backlight/asus-nb-wmi/brightness # Switch optimus off before resuming, avoids unneccessary power draw echo `cat /etc/bumblebee/cardoff` | tee /proc/acpi/call ;; esac</span></span></code> </pre><br><br><h3>  2. Integrated video card </h3><br>  Having played with different versions of the cores, I accidentally noticed a reduced power consumption on versions up to 2.6.39 inclusive.  Having rushed to search in these parameters I in the guess was not mistaken. <br>  The problem was discovered: the <a href="http://git.kernel.org/%3Fp%3Dlinux/kernel/git/torvalds/linux-2.6.git%3Ba%3Dcommitdiff%3Bh%3D05bd42688dbc066d4e2689b6f73c0470601f788b">patch</a> adopted in the i915 driver in the 3.0 kernel is to blame.  But, fortunately, it can be circumvented without consequences. <br>  In the already known <code>/etc/default/grub</code> add the parameter <code>i915.i915_enable_rc6=1</code> .  The line will expand to: <br><pre> <code class="bash hljs">GRUB_CMDLINE_LINUX=<span class="hljs-string"><span class="hljs-string">"acpi_backlight=vendor i915.i915_enable_rc6=1"</span></span></code> </pre><br>  We update the grub configuration, reboot and look at the battery readings.  Now you can live.  And you can reduce more! <br><br><h3>  3. Additional small tweaks </h3><br>  By running the powertop and applying all the recommended tweaks, you can squeeze another 0.5-1 Wh, which on this gland can additionally give up to an hour of battery life.  But not to be played every time with powertop?  We automate all this business through pm-utils.  We have 4 separate scripts: <br><br>  1. One of the main tweaks, for unknown reasons, not included in the standard package.  Change the processor frequency control mode: <br> <code>/etc/pm/power.d/cpu-governor</code> <br> <pre> <code class="hljs mel">#!/bin/bash cpu_powersave() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /sys/devices/<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>/cpu/cpu*/cpufreq/scaling_governor; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> echo $1 &gt; $i &amp;&amp; echo Done. || echo Failed. done } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> $1 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> true) cpu_powersave <span class="hljs-string"><span class="hljs-string">"ondemand"</span></span> ;; false) cpu_powersave <span class="hljs-string"><span class="hljs-string">"performance"</span></span> ;; *) exit $NA esac exit <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  2. Change the power management mode of USB devices: <br> <code>/etc/pm/power.d/usb-autosuspend</code> <br> <pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python from os import listdir, path from sys import argv status = argv[1] USB_PATH = '/sys/bus/usb/devices/' def powersave(status): devices = listdir(USB_PATH) devices = filter(lambda x: ':' not in x, devices) for device in devices: b = listdir(path.join(USB_PATH, device)) b = filter(lambda x: ':' in x, b) is_mouse = False for i in b: if open(path.join(USB_PATH, device, i, 'bInterfaceProtocol')).read().strip() == '02': is_mouse = True break if not is_mouse: open(path.join(USB_PATH, device, 'power/control'), 'w').write(status) if status == 'true': powersave('auto') elif status == 'false': powersave('on')</span></span></code> </pre><br>  The script can detect the mouse and will not extinguish them. <br><br>  3, 4. Change the power management mode of other devices: <br> <code>/etc/pm/power.d/scsi_host-link_power_management</code> <br> <pre> <code class="hljs vbscript">#!/bin/bash powersave() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /sys/<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>/scsi_host/host?/link_power_management_policy; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> echo $<span class="hljs-number"><span class="hljs-number">1</span></span> &gt; $i &amp;&amp; echo Done. || echo Failed. done } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>) powersave <span class="hljs-string"><span class="hljs-string">"min_power"</span></span> ;; <span class="hljs-literal"><span class="hljs-literal">false</span></span>) powersave <span class="hljs-string"><span class="hljs-string">"max_performance"</span></span> ;; *) <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> $NA esac <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br> <code>/etc/pm/power.d/pci-power-control</code> <br> <pre> <code class="hljs vbscript">#!/bin/bash powersave() { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /sys/bus/pci/devices/*/power/control; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> echo $<span class="hljs-number"><span class="hljs-number">1</span></span> &gt; $i &amp;&amp; echo Done. || echo Failed. done } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>) powersave <span class="hljs-string"><span class="hljs-string">"auto"</span></span> ;; <span class="hljs-literal"><span class="hljs-literal">false</span></span>) powersave <span class="hljs-string"><span class="hljs-string">"on"</span></span> ;; *) <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> $NA esac <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  We make these files executable and apply in one fell swoop: <code>sudo pm-powersave true</code> . <br><br>  Setup is over.  Official proof: <br><img src="https://habrastorage.org/storage2/ea6/6a2/ca5/ea66a2ca5564063b9d0c13f865f563f8.png" alt="image"><br>  And the results chart: <br><img src="https://habrastorage.org/storage2/a3d/80b/807/a3d80b807cde73a1a9db0c5c4ef0c2a3.png"></div><p>Source: <a href="https://habr.com/ru/post/134968/">https://habr.com/ru/post/134968/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../134963/index.html">We launched the first commercial LTE network in Russia</a></li>
<li><a href="../134964/index.html">Dwarfs and chain</a></li>
<li><a href="../134965/index.html">Droider Chart. Issue 83, warm</a></li>
<li><a href="../134966/index.html">CryptDB: processing information in the database without decrypting it</a></li>
<li><a href="../134967/index.html">The first LTE network in Russia launched today (December 20, 2011) in Novosibirsk by Scartel (brand ‚ÄúYota‚Äù)</a></li>
<li><a href="../134969/index.html">Solaris 11 kernel source</a></li>
<li><a href="../134972/index.html">Automating the processing of citizens in the E1 system of the Euphrates - as we did</a></li>
<li><a href="../134973/index.html">Connecting the HP LJ 1010/1015/1018/1020 printer in Linux Debian (Ubuntu) with CUPS 1.4 and higher</a></li>
<li><a href="../134974/index.html">Installing Redis + Redis PHP + phpRedisAdmin on the production server in 15 minutes</a></li>
<li><a href="../134977/index.html">Customer is always right</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>