<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Module for determining the sources of site visitors for Ruby on Rails</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This post is mainly about web analytics: how to correctly identify the sources of visitors to your site, and about my module for Ruby on Rails, which ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Module for determining the sources of site visitors for Ruby on Rails</h1><div class="post__text post__text-html js-mediator-article">  This post is mainly about web analytics: how to correctly identify the sources of visitors to your site, and about my module for Ruby on Rails, which helps in this difficult matter.  In the end there is a small part that I ask to draw the attention of members of the Rails community: it is about me and Rails.  But let's order. <br><a name="habracut"></a><br><h4>  Part one.  About web analytics and visitor sourcing </h4><br><h5>  Problem </h5><br>  There is a rather trivial task: to determine the source of the visitor who came to our site.  I don‚Äôt know about you, but we parasitized on the body of Google Analytics for quite a long time: they took utmz, gutted it on the sors and mediums, and didn‚Äôt live.  Analytics for us solved the issues of rewriting sources, recording sessions, and in general eliminated the paring of referrers from all sorts of buzzwords.  But all good things come to an end. <br><br>  When Google rolled out the beta of Universal, it became clear that sooner or later, the Google cookie would have to say goodbye and learn how to do everything yourself.  But since then he declared the incompatibility of Classic and Universal, so far it was possible to sit exactly: Classic will be maintained for a long time. <br><br><blockquote>  In the new version of GA, there was only one cookie left - with the user id.  Analytics sends it to your server and already does all the calculations there.  And neither through cookies, nor through js can you extract information about the source from it now. </blockquote><br>  But recently, Google began to gently poke users with a stick: he rolled out the profile converter - Classic ‚Üí Universal.  And here you have to start moving the rolls: the classic Analytics will receive the final Reader at the moment when remarketing lists will come to Universal.  And this, I think, is not far off. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this regard, I was delivered to the utmz self-made cookie generator.  And called it <b>sourcebuster</b> . <br><br><h5>  First about the form </h5><br>  The generator is made in the format <b>Mountable engine</b> for <b>Ruby on Rails</b> .  It can be quite quickly adapted to all your Rails applications as a gem and updated with a single command from the console.  The module is independent and does everything by itself.  Data on the source can be used to substitute phone numbers, content on the site, save them with applications and use for further analytics.  According to certain rules, the module calculates the source (and a number of parameters) and stores them in the visitor‚Äôs cookies. <br><br>  Immediately link to GitHub: <a href="https://github.com/alexfedoseev/sourcebuster">https://github.com/alexfedoseev/sourcebuster</a> <br>  <i>I have not yet figured out the design of README.rdoc, in the process, I will soon be fixed.</i> <br><br><h5>  Now about the content </h5><br>  Most of the logic repeats the logic of GA, but there are some differences. <br>  Let's start with the data structure. <br><br><h5>  Data structure </h5><br>  In total, we have 4 main types of traffic: <br><ol><li>  <b>utm</b> - traffic marked by utm-tags </li><li>  <b>organic</b> - traffic from organic search engines </li><li>  <b>referral</b> - referral traffic (links from third-party resources) </li><li>  <b>typein</b> - direct transitions </li></ol><br>  The filtering logic in the image below: <br><img src="https://habrastorage.org/getpro/habr/post_images/fca/ca7/5ac/fcaca75ace16929a2da306e532a51fee.jpg" alt="image"><br><br>  This way we pack our visitors in these 4 baskets. <br>  Next, we need to create a rewrite of the source rules, since one visitor can go to the site at different times from different sources. <br><br><h5>  Source rewriting logic </h5><br>  The rewrite logic follows the logic of Google Analytics: <br><img src="https://habrastorage.org/getpro/habr/post_images/e4c/a6e/1d4/e4ca6e1d4aa277d4c28d7e365f38198f.jpg" alt="image"><br><br>  Please note that in the current session referral referrals do not overwrite anything.  Why - I will explain with an example: a visitor often goes to a site from a third-party resource that is not a real source ‚Äî for example, from a postal service, where he had a link to activate registration. <br>  In this system, I decided in addition to overwritten data on the current visit to store data on the very first visit.  That is, at the time of conversion, we will have data on the first and current sources of the visitor. <br><br>  What specifically can be pulled out using the module: <br><ul><li>  Information about the very first source: <br>  utm_source, utm_medium, utm_campaign, utm_content, utm_term </li><li>  The same data about the current source <br>  (if the user made a second transition from another source) </li><li>  Date of first visit </li><li>  Point of entry </li><li>  Full referrer at which source rewriting occurred </li><li>  user ip and user agent </li></ul><br><br><div class="spoiler">  <b class="spoiler_title">Module installation</b> <div class="spoiler_text">  It's laying in, that you already have a rails application to which you want to screw the module. <br><br>  Add to <b>gemfile</b> applications: <br><pre><code class="ruby hljs">gem <span class="hljs-string"><span class="hljs-string">'sourcebuster'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:git</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"git@github.com:alexfedoseev/sourcebuster.git"</span></span></code> </pre> <br>  Install: <br><pre> <code class="bash hljs">bundle install</code> </pre><br>  Since this is a mountable engine, it exists in an isolated namespace. <br>  We mount it in the application, adding to <b>routes.rb</b> : <br><pre> <code class="ruby hljs">mount Sourcebuster::Engine =&gt; <span class="hljs-string"><span class="hljs-string">"/sourcebuster"</span></span></code> </pre><br>  Next we need to copy and complete all the migrations. <br>  We copy: <br><pre> <code class="bash hljs">bundle <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rake sourcebuster:install:migrations</code> </pre><br>  And we execute: <br><pre> <code class="bash hljs">bundle <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rake db:migrate</code> </pre><br>  There are 3 new tables in your database: <br><ul><li>  <b>sourcebuster_referer_sources</b> <br>  Data about customizable sources. </li><li>  <b>sourcebuster_referer_types</b> <br>  Data on the types of referrals (essentially utm_medium for referral traffic). </li><li>  <b>sourcebuster_settings</b> <br>  Application settings (session duration and subdomain processing). </li></ul><br>  You don‚Äôt need to do anything with them, there is already data out of the box and there are interfaces for them. <br><br>  For more information about Mountable engines - <a href="http://guides.rubyonrails.org/engines.html">http://guides.rubyonrails.org</a> <br><br>  The module is almost connected, the final touch remains: to allow it to set cookies anywhere in your application.  To do this, add the following to your application_controller.rb: <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationController</span></span></span><span class="hljs-class"> &lt; ActionController::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sourcebuster::CookieSettersHelper</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">before_filter</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">set_sourcebuster_data</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">helper_method</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extract_sourcebuster_data</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># some code private def set_sourcebuster_data set_sourcebuster_cookies end end</span></span></span></span></code> </pre><br>  It seems ready.  The engine uses the main application templates, so you can customize the styles yourself (perhaps I will change this).  I could miss something, if something does not work - write. <br></div></div><br><br><h5>  Using </h5><br><blockquote>  When using the module, please note that <b>this is a beta and was written by a person with rather little development experience</b> (which is a couple of paragraphs at the end of the post). </blockquote><br>  The module gives the following methods (more precisely, the method is one, but pulls out different data): <br><br><div class="spoiler">  <b class="spoiler_title">Module methods</b> <div class="spoiler_text"><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># C    (utm / organic / referral / typein) extract_sourcebuster_data(:sb_first, :typ) # C  utm_source extract_sourcebuster_data(:sb_first, :src) # C  utm_medium extract_sourcebuster_data(:sb_first, :mdm) # C  utm_campaign extract_sourcebuster_data(:sb_first, :cmp) # C  utm_content extract_sourcebuster_data(:sb_first, :cnt) # C  utm_term extract_sourcebuster_data(:sb_first, :trm) #    (utm / organic / referral / typein) extract_sourcebuster_data(:sb_current, :typ) #  utm_source extract_sourcebuster_data(:sb_current, :src) #  utm_medium extract_sourcebuster_data(:sb_current, :mdm) #  utm_campaign extract_sourcebuster_data(:sb_current, :cmp) #  utm_content extract_sourcebuster_data(:sb_current, :cnt) #  utm_term extract_sourcebuster_data(:sb_current, :trm) #     extract_sourcebuster_data(:sb_first_add, :fd) #   extract_sourcebuster_data(:sb_first_add, :ep) #  ,      extract_sourcebuster_data(:sb_referer, :ref) # ip  extract_sourcebuster_data(:sb_udata, :uip) #   user agent extract_sourcebuster_data(:sb_udata, :uag)</span></span></code> </pre><br></div></div><br>  Test module page: <a href="http://sandbox.alexfedoseev.com/sourcebuster/showoff">http://sandbox.alexfedoseev.com/sourcebuster/showoff</a> <br>  You can go to it from different sources and see what the module is. <br><br>  The module also allows you to configure a number of additional parameters. <br><br><h6>  Default settings </h6><br>  Interface: <a href="http://sandbox.alexfedoseev.com/sourcebuster/settings">http://sandbox.alexfedoseev.com/sourcebuster/settings</a> <br><br>  <b>Session duration</b> <br>  After what time after the last activity of the user his visit is considered completed.  Specified in minutes, the default is 30 minutes. <br><br>  <b>Subdomain processing</b> <br>  This is essentially an analogue of _setDomainName in GA.  Let me explain by example. <br>  Suppose you have a website that has subdomains: <br><ul><li>  site.com </li><li>  blog.site.com </li><li>  shop.site.com </li></ul><br>  And you want the transitions from the <b>site.com</b> pages to <b>blog.site.com</b> to <b>be</b> considered internal non-referral transitions (that is, when switching from one subdomain to another source is not overwritten).  To do this, in the settings you need to tick off <b>"I have subdomains and traffic"</b> and in the <b>"Main host"</b> field add the root host of the site, all subdomains of which will be regarded by the module as one site.  In our case, it indicates <b>"site.com"</b> . <br><br>  If you specify <b>blog.site.com</b> in the field, then the transition from <b>alex.blog.site.com</b> to <b>blog.site.com</b> will be non-referral, and the transition from <b>alex.blog.site.com</b> to <b>shop.site.com</b> will already be referral traffic. <br><br><h6>  Additional sources </h6><br>  Interface: <a href="http://sandbox.alexfedoseev.com/sourcebuster/custom_sources">http://sandbox.alexfedoseev.com/sourcebuster/custom_sources</a> <br><br>  The system has the ability to customize the processing of a number of additional sources. <br>  Setup is made by the following parameters: <br><ul><li>  <b>Domain</b> <br>  According to it, the source that will be processed is played. </li><li>  <b>Alias</b> <br>  Beautiful / friendly source name. </li><li>  <b>Channel</b> <br>  You can set the <i>referral</i> , <i>organic</i> or <i>social</i> . </li><li>  <b>Request parameter</b> <br>  Keyword parameter in search engine url. </li></ul><br>  What for this table is needed the easiest way to explain with examples. <br><br>  <b>Example 1</b> <br>  You want the system to count Bing search transitions as organic traffic (which is quite true). <br>  If you go to bing.com and enter the query ‚Äúapple‚Äù into the search box, you will be taken to the issuing page with the address of the form: <br>  <i><a href="http://www.bing.com/search">www.bing.com/search</a> ?</i>  <i><b>q = apple</b> &amp; go = &amp; qs = n &amp; form = QBLH &amp; pq = apple &amp; sc = 8-5 &amp; sp = -1 &amp; sk = &amp; cvid = 718ad07527244c319ecebf44aa261f64</i> <br><br>  On its basis we create a new special source: <br><ul><li>  Domain: <b>bing.com</b> </li><li>  Alias: <b>bing</b> <br>  Or, as you wish, you can just do not write anything, then the referrer host will be substituted. </li><li>  Channel: <b>organic</b> </li><li>  Keyword parameter: <b>q</b> <br>  This is a symbol between the ‚Äú?‚Äù And ‚Äú= your_query‚Äù constructs in the search results URL. </li></ul><br>  Now everything that comes from such pages will be considered organic traffic. <br><br>  <b>Example 2</b> <br>  You want to highlight the transitions from the social.  networks in a separate group. <br>  We act according to a similar scheme: <br><ul><li>  Domain: <b>facebook.com</b> </li><li>  Alias: <b>facebook</b> </li><li>  Channel: <b>social</b> </li><li>  Keyword parameter: <b>not needed</b> </li></ul><br>  Is done.  Now all clicks on links from facebook (except those marked with utm-tags) will be with the value of the social channel. <br><br><blockquote>  In the domain field, you must fully specify the zone (.com, .com.ru, etc.).  If you specify the value of facebook.com, then this filter will not get traffic from the domain facebook.com.ru.  And from the domain m.facebook.com - will fall. </blockquote><br><br><h5>  Tests </h5><br>  Sources: <a href="">https://github.com/alexfedoseev/sourcebuster/blob/master/test/integration/navigation_test.rb</a> <br>  The lion's share of tests is Selenium tests to verify the definition and rewrite of sources.  They are written in Ruby, but implemented in such a way that you can check not only the code of my module, but in principle any implementation (for example, if someone will port it to php or js).  That is, they are testing not the methods, but the result of their work.  In addition, surrogate referrers are not used here, but real transitions from real resources are tested.  And if Yandex changes something in the output (for example, it switches to https, which will kill the referrer), then the tests will show it.  Everything is really shorter. <br><br>  Now the tests are pretty meat and they are written rather for themselves, but if you want you can figure it out. <br>  In order to test the rewritten code, you need to have: <br><ul><li>  page folded by certain rules <br>  (see the code of the <a href="http://sandbox.alexfedoseev.com/sourcebuster/showoff">test page</a> , find the id of the data blocks, if anything - ask questions) </li><li>  indexed in search engines <br>  (Yandex, Google, the third additional (for example, Rambler)) </li><li>  and being in the top 5 on a specific request </li><li>  + links to this page from the social.  network and third-party (referral) site </li></ul><br>  The top block of code contains constants that need to be configured before running the tests.  Of these, it is clear what needs to be prepared. <br><br>  And yes, the test run takes about 20-30 minutes. <br><br><blockquote>  I repeat: when using the module, please note that <b>this is a beta, and it was written by a person with rather little development experience</b> (which is a couple of paragraphs below). </blockquote><br><br><h4>  Part two.  About me and Rails </h4><br>  For 3.5 years now I have been doing internet marketing, and not so long ago I came to the conclusion that traffic generation is not mine.  I want to generate meaning, not traffic.  And I started writing code.  It happened about 9 months ago.  I have no mathematical and mathematical background, I had to understand everything from scratch and myself.  The books of Chris Pine, Michael Hartl and other Internet services helped me in this. <br><br>  As a result, I wrote a blog for myself, but about 5 months ago I had to take a break, and this module is the first thing I wrote after being idle.  I ask the members of the Rails community to criticize the implementation and point out explicit and not very jambs.  For all this time, I never managed to meet a living person who writes in Ruby, and it‚Äôs rather hard to comprehend anything and everything. <br><br>  Thanks in advance for your criticism and I hope this post will be useful to someone.  Good luck. </div><p>Source: <a href="https://habr.com/ru/post/208112/">https://habr.com/ru/post/208112/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../208100/index.html">How to choose a name for an IT product and IT company</a></li>
<li><a href="../208104/index.html">Restoring open files but deleted from the linux file system</a></li>
<li><a href="../208106/index.html">Introducing Cisco TelePresence</a></li>
<li><a href="../208108/index.html">Computer control with the eyes - a practical implementation</a></li>
<li><a href="../208110/index.html">The experience of creating a robot. Part 1</a></li>
<li><a href="../208114/index.html">Dances with a tambourine on New Year's Eve or the second life of old cars</a></li>
<li><a href="../208116/index.html">Script monitoring the availability of ports on the network with notification by email (bash)</a></li>
<li><a href="../208120/index.html">Lectures from Yandex for those who want to spend the holidays with benefit. Discrete analysis and probability theory</a></li>
<li><a href="../208122/index.html">"With you, the game for 100 bucks!" Or why Indiegogo is not Go-Go</a></li>
<li><a href="../208132/index.html">The interaction of Android devices on the local network</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>