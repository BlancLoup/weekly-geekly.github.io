<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automatic lap and time counting system for RC cars</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, I collected my AMB counterpart, also known as MyLaps. For those who do not know - this is a very sophisticated system for counting th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automatic lap and time counting system for RC cars</h1><div class="post__text post__text-html js-mediator-article">  Not so long ago, I collected my AMB counterpart, also known as MyLaps.  For those who do not know - this is a very sophisticated system for counting the circles of radio-controlled models, kartings, and even motorsport.  The cost of the finished kit from MyLaps just space.  My task was to create either a clone or the most compatible one.  What I got at the moment. <br><a name="habracut"></a><br><h4>  Prehistory </h4><br>  Not so long ago, I was actively engaged in automotive sports.  Periodically I began to go to more or less major competitions in the nearest cities (Vladimir, Zarechny, I want to visit Tyumen in the summer of course), even moved to a more normal model and got pontovye devices to adjust the chassis.  A few photos, I apologize for the quality: <br><img src="https://habrastorage.org/storage3/6c7/fb8/596/6c7fb8596de2b3b8b48673945ca42ef5.jpg"><br><img src="https://habrastorage.org/storage3/5cd/b65/ad1/5cdb65ad15ff3f2b14d7f8164678f4c3.jpg"><br><img src="https://habrastorage.org/storage3/aa7/ad9/457/aa7ad945779e5d1d95c5f8c0057337dd.jpg"><br>  In short - this sport has tightened very much. <br><br>  Immediately began to think about how to make your own system of counting circles (later in the text of her call "notch").  The first attempts were implemented on the basis of RFID tags, which I converted into active ones.  The idea is so-so.  To cover the entire width of the track and eliminate collisions, several decoders and several loops were required: <br><img src="https://habrastorage.org/storage3/e3b/57c/6c5/e3b57c6c56648ad09c837f66c842185b.jpg"><br>  The label itself: <br><img src="https://habrastorage.org/storage3/43a/6c9/276/43a6c9276ee296916791f8982e77d77d.jpg"><br>  Increased the carrier frequency from 125 to 500kHz, but there was no particular result. <br>  After active google found a post on <a href="http://www.rctech.net/forum/radio-electronics/688671-lap-timing-decoder.html">rctech.net</a> .  Howard also started doing something.  I even laid out the detector and amplifier circuits, which I used. <br><br>  Already here I began to make a decoder that works with original AMB transponders and self-made ones.  And he even made his WiFi-based interface, but the project is still rotten: <br><img src="https://habrastorage.org/storage3/e45/44a/419/e4544a4199f6f44a761a1c0ac1cd4bda.jpg"><br><img src="https://habrastorage.org/storage3/90f/fe1/080/90ffe10807f0af60d1e827a4f7a91f90.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  What I have at the moment </h4><br>  Here is a black decoder box: <br><img src="https://habrastorage.org/storage3/046/df0/369/046df0369f6923c9c5388488cc03f783.jpg"><br>  Inside this shawl: <br><img src="https://habrastorage.org/storage3/232/518/8c8/2325188c8e4765df179750b9f4d6aba8.jpg"><br>  Loop enhancer: <br><img src="https://habrastorage.org/storage3/094/c15/381/094c15381744a564d9905c21b7a2fd33.jpg"><br>  Detection loop itself: <br><img src="https://habrastorage.org/storage3/e93/bea/09a/e93bea09a2b1647ff0a4e487346e673e.jpg"><br>  And transponders: <br><img src="https://habrastorage.org/storage3/6e0/00a/0ca/6e000a0cad86d42ecd8a869c9d7e580b.jpg"><br><br>  Today I want to consider in more detail how the transponder works and how it manages so quickly to transmit 13 byte identifiers per 100¬µs. <br><br><h4>  Transponder </h4><br>  This is what the original transponders look like: <br>  AMBrc dp <br><img src="https://habrastorage.org/storage3/fac/a67/0e3/faca670e3d680bbd0d4f15a5ce50b82e.jpg"><br>  MRT (AMB clones) <br><img src="https://habrastorage.org/storage3/492/79e/ce3/49279ece3a943099551a4d533d7a521a.jpg"><br>  AMB RC4 Hybrid <br><img src="https://habrastorage.org/storage3/720/558/977/720558977318d06d57d0319d6e970881.jpg"><br>  This is how Howard transponders look like: <br><img src="https://habrastorage.org/storage3/40a/059/a42/40a059a428c4792a5e312922ff3b5e6e.jpg"><br><img src="https://habrastorage.org/storage3/b45/438/2a7/b454382a728be43482a6f368b6be73e1.jpg"><br>  And the scheme: <br><img src="https://habrastorage.org/storage3/43d/8bf/650/43d8bf650835c932406e63d50e35830f.jpg"><br>  More detailed topic about them on <a href="http://www.rctech.net/forum/radio-electronics/688396-transponder-design.html">rctech.net</a> .  If interested - please read. <br><br>  I'll start with the scheme of their handicrafts: <br><img src="https://habrastorage.org/storage3/da3/97f/e68/da397fe6804b8ab0d8f9fd0d8c3b25ad.jpg"><br>  and photos: <br><img src="https://habrastorage.org/storage3/c2e/c42/e5b/c2ec42e5b042654d87e1e53522236f38.jpg"><br><img src="https://habrastorage.org/storage3/b6b/332/0db/b6b3320dbd0b70c9e65be36203337df9.jpg"><br>  The first thing that catches your eye is a coil around the board.  This can be called an antenna.  The diagram is L1.  For resonance, a 100 pF capacitor is connected to it.  I remind you that the carrier in the original AMB transponders is 5 MHz.  The data transfer method is BPSK, i.e. the phase shift.  Perhaps I'll show a couple of waveforms for clarity: <br><br><img src="https://habrastorage.org/storage3/fbc/477/6c3/fbc4776c3bcc9ba2bfa48bc4c3def1fe.jpg"><br><img src="https://habrastorage.org/storage3/76d/762/fc0/76d762fc0429c44526fc436e508a34b6.jpg"><br><br>  and some Howard waveforms: <br><br><img src="https://habrastorage.org/storage3/84e/dc1/68f/84edc168f6f106b4e3b4fca1da220b7c.jpg"><br><img src="https://habrastorage.org/storage3/427/5e1/62a/4275e162af193dc7b24cf2d596f2dba2.jpg"><br><br>  ps on the latest Howard waveforms testing a phase shift detector, still analog, apparently. <br><br>  Regarding the power supply, you can use a 200 ohm resistor and a 5.1V zener diode, for 5V LDO stabilizers are expensive. <br><br>  We use Attiny25 as a controller for several reasons: <br><br>  1. Built-in 64 MHz generator, which is not useful <br>  2. Programming for debugWire <br>  3. Powered by 20 MHz. <br>  4. There is an interesting mode of PWM, which is useful to me. <br><br>  I'll start with an interesting PWM mode: <br><br><img src="https://habrastorage.org/storage3/415/ffe/3e9/415ffe3e9d7a4b044f4e2635232d50d5.jpg"><br><br>  We can make 5 and 6 leg work in antiphase, and this removes some of the external unnecessary strapping. <br>  Timer initialization: <br><br><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Timer/Counter 1 initialization // Clock source: System Clock // Clock value: 20000,000 kHz // Mode: PWMA top=OCR1C // OC1A output: Non-Inv., /OC1A connected // OC1B output: Disconnected // Timer1 Overflow Interrupt: Off // Compare A Match Interrupt: Off // Compare B Match Interrupt: Off PLLCSR=0x00; TCCR1=0x51; GTCCR=0x00; TCNT1=0x00; OCR1A=2; OCR1B=0x00; OCR1C=3;</span></span></code> </pre> <br><br>  This will allow our timer to operate at 5 MHz and generate rectangular pulses at the PWM outputs. <br><br>  Each bit of information is transmitted once every 800 ns, which is 16 machine cycles at 20 MHz.  To implement such a fast transfer, I had to write each bit to a separate memory byte before sending the code.  I did not invent another easier way. <br><br>  Of the 13 transmitted bytes, the first 2 bytes are always 0x79 0x16.  Howard calls them the preamble.  These bytes will come in handy later.  For these bytes, the FPGA issues a VALID signal, which indicates to the scooter that a label has passed over the loop. <br><br>  So, before transferring the remaining 11 bytes, they need to be scattered in 88 bytes of RAM: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (RFID_Buffer_ee[RFIDBufferPtr]&amp;mask) { buffer[RFIDBit_Count]=<span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { buffer[RFIDBit_Count]=<span class="hljs-number"><span class="hljs-number">0</span></span>; } mask&gt;&gt;=<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!mask) { mask=<span class="hljs-number"><span class="hljs-number">0x80</span></span>; RFIDBufferPtr++; } RFIDBit_Count++; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (RFIDBit_Count&lt;TransBuffSize);</code> </pre><br><br>  I didn‚Äôt bother with the transfer of the first two bytes and did so: <br><br><pre> <code class="cs hljs"> <span class="hljs-comment"><span class="hljs-comment">//  TCCR1=0x51; // 8 delay_us(8); //transmit 0x79 0x16 NoPhaseChange NOP PhaseChange NOP PhaseChange NOP PhaseChange NOP PhaseChange NOP NoPhaseChange NOP NoPhaseChange NOP PhaseChange NOP NoPhaseChange NOP NoPhaseChange NOP NoPhaseChange NOP PhaseChange NOP NoPhaseChange NOP PhaseChange NOP PhaseChange NOP NoPhaseChange #asm("nop"); #asm("nop");</span></span></code> </pre><br><br>  But PhaseChange and NoPhaseChange themselves.  To change the phase you need to turn off and turn on the timer for 4 cycles.  Each entry in the timer register takes two ticks.  Well, to do nothing you just have to wait for 4 bars. <br><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PhaseChange TCCR1=0x50; TCCR1=0x51; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NoPhaseChange #asm("nop"); #asm("nop"); #asm("nop"); #asm("nop"); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NOP #asm("nop"); #asm("nop"); #asm("nop"); #asm("nop"); #asm("nop"); #asm("nop"); #asm("nop"); #asm("nop"); #asm("nop"); #asm("nop"); #asm("nop"); #asm("nop");</span></span></code> </pre><br><br>  So the transfer of the first two bytes is pretty dumb. <br><br>  And actually transfer the remaining 11 bytes: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;TransBuffSize;i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!buffer[i]) { <span class="hljs-meta"><span class="hljs-meta">#asm("nop"); #asm("nop"); #asm("nop");} </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { TCCR1=0x50; TCCR1=0x51; }; }</span></span></code> </pre><br><br>  Here one machine cycle takes if else. <br><br>  The signal after the BPSK detector looks like this: <br><br><img src="http://habrastorage.org/storage3/53f/351/2c9/53f3512c91d71206af31fea8a24ada2c.jpg"><br><br>  By the way, the time between transmissions of each code varies randomly from 1ms to 2ms <br><br>  A logical question arises, what do we need to transmit.  I will write about my protocol later, but for now I‚Äôll give the codes of those original transponders that I have: <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//flash char RFID_Buffer_ee[BuffSize]={0xEF,0xD4,0xFE,0xF6,0xE1,0xD1,0x22,0xCD,0xCC,0x3C,0}; //9887001: //flash char RFID_Buffer_ee[BuffSize]={0x3B,0x21,0xC7,0x1F,0xF7,0xFE,0x3E,0xFE,0xC3,0x3F,0}; //9577130: flash char RFID_Buffer_ee[BuffSize]={0x0D,0xAE,0xAD,0xB2,0x49,0x89,0xB9,0x64,0xB3,0x33,0x48}; //8087916: //flash char RFID_Buffer_ee[BuffSize]={0x00,0xEF,0x35,0xEF,0x0E,0x26,0x0A,0xD8,0x3F,0xCF,0x48}; //8110984: //flash char RFID_Buffer_ee[BuffSize]={0xE1,0x2A,0xD9,0xE1,0xEE,0xD9,0x4E,0x07,0x83,0x0F,0x40}; //5495805: //flash char RFID_Buffer_ee[BuffSize]={0x35,0xD1,0x1E,0x21,0x2A,0x10,0x5D,0xd0,0x7F,0xCF,0x40}; //3472238: //flash char RFID_Buffer_ee[BuffSize]={0xDA,0xE4,0x2B,0x24,0x27,0xEF,0x87,0x31,0x4F,0x33,0x00}; //8959711: //flash char RFID_Buffer_ee[BuffSize]={0xD4,0x14,0xC7,0xCB,0xDF,0xD6,0x9A,0x17,0xBF,0xF0,0x40}; //8361115 //flash char RFID_Buffer_ee[BuffSize]={0xDA,0x0B,0x2B,0x14,0xFC,0xC7,0x2C,0xC2,0xF3,0x03,0x04}; //8718039:</span></span></code> </pre><br><br>  I could not find the relationship between the transmitted code and the transponder number.  My transponder clones with the original AMBrc3 serif work like this: see one time, then stop.  I suspect that the problem still lies in the additionally transmitted information: <br><br><pre> <code class="cs hljs">EC84418105A6B5BD70CF0000 E12AD9E1EED94E07830F4001 E12AD9E7EED94E07C30F4002 E12AD9E1EED94E07830F4002 <span class="hljs-number"><span class="hljs-number">38</span></span>A8F9C1ECA67A7E4FCC4002 E12AD9E1EED94E07830F4002 E12AD9E1EED9CE07830F4000 E12BDBE1EED94E07830F4000 E12AD9E1EED94E07830F4000 E12AD9E1EED94E07830F4001 E27B5E0BC356B9B98CC24001 E12BD9E1EED94E07830F4001 F12AD9E1EED94E07830F4000 E12AD9E1EED94E07830F4002 E12AD9E1EED94E07830F4002 E242145FC145858D4CCF0023 E12AD9E1EED94E07830F4000 E12AD9E1EED94E07830F4004 D417A27CD8B9BA4E40CC4002 E12AD9E1EED94E07830F4002 E12AD9E1EED94E07830F4023 E12AD9E1EED94E07830F4000 E12AD9E1EED94E07830F4000 E12AD9E1EED94E07830F4000 E12AD9E1EED94E07830F4000 E12BD9E1EED94E07830F4001 E12AD9E1EED94E07830F4002 E12AD9E1EED94E07830F4002 E12AD9E1EED94E07830F4000 <span class="hljs-number"><span class="hljs-number">3B</span></span>14155CCA79B54D73000002 E12AD9E1EED94E07830F4002 E243145FC145858D4CCF0000 E12AD9E1EED94E07830F4000 E12A58E1EED94E07830F4002 E12AD9E1EED94E07830FC000</code> </pre><br>  It is badly seen due to interference, but every three parcels with an identifier (E12AD9E1EED94E07830F40), another package is sent with additional information (D417A27CD8B9BA4E40CC40). <br>  Everything is complicated by the fact that I can only check transponders at competitions.  Seen the cost of the order of 4,000 euros no one will play me. <br><br>  Everything is complicated by the fact that I can only check transponders at competitions.  Seen the cost of the order of 4,000 euros no one will play me. <br><br><h4>  Files to emulate </h4><br>  For those who want to see how this works in Proteus, <a href="">please come here.</a> <br><img src="http://habrastorage.org/storage3/51a/219/8b0/51a2198b0571ff6ff5617f80e8998e34.jpg"><br><br><h4>  Instead of conclusion </h4><br>  I want to say that in the next article I will tell you a little about the BPSK detector (half of the circuit is taken from rctech.net and crammed into the FPGA), but I‚Äôll tell you more about the software part of the decoder.  I will tell about AMB20 and AMBRc protocols working on Rs-232, about how I implemented compatibility with original AMB transponders </div><p>Source: <a href="https://habr.com/ru/post/195804/">https://habr.com/ru/post/195804/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../195794/index.html">"Boost.Asio C ++ Network Programming". Chapter 4: Client and Server</a></li>
<li><a href="../195796/index.html">Through thorns in the market</a></li>
<li><a href="../195798/index.html">About choosing hard drives for servers</a></li>
<li><a href="../195800/index.html">Synchronization of the web developer workspace</a></li>
<li><a href="../195802/index.html">Strategy for promoting a new site. When will the top 10 and search traffic?</a></li>
<li><a href="../195806/index.html">Generator utf-8 json on php with unicode 6 support</a></li>
<li><a href="../195808/index.html">We configure the HTTPS server on nginx</a></li>
<li><a href="../195810/index.html">Repairing a car with a 3D printer</a></li>
<li><a href="../195812/index.html">Derby.js deploy on Amazon EC2</a></li>
<li><a href="../195814/index.html">Timers in .Net</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>