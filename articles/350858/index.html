<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing Telegram-bot for Habrahabr</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I want to talk about how the Telegram bot was written, which could send articles from Habrahabr, first to Python, and then to Go, and ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing Telegram-bot for Habrahabr</h1><div class="post__text post__text-html js-mediator-article"><p>  In this article I want to talk about how the Telegram bot was written, which could send articles from Habrahabr, first to Python, and then to Go, and what came of it. </p><a name="habracut"></a><br><h2 id="nebolshaya-predystoriya">  A little background </h2><br><p>  It all began in the summer when Telegram began to penetrate into my life more and more.  After writing a couple of test bots in Python, the idea arose to write something for Habrahabr.  The first idea was simple: the bot should have just sent notifications about new articles. </p><br><h2 id="pervaya-versiya-na-python-35">  First version (in Python 3.5) </h2><br><p>  After a brief googling, it was discovered that the site has an RSS feed.  The process of sending articles immediately simplified: now it was not necessary to parse the entire site, just look at the RSS feed every few minutes (in my case - 10). </p><br><p>  The first version of the bot was written pretty quickly.  The <a href="https://github.com/eternnoir/pyTelegramBotAPI">pyTelegramBotAPI</a> library was used to interact with the Telegram API, and <a href="https://github.com/eternnoir/pyTelegramBotAPI">feedparser was</a> used to parse the RSS <a href="https://github.com/kurtmckee/feedparser">feed</a> . </p><br><p>  In the process of work, the structure became very complicated: now the bot did not just send new articles, but could also sift out those articles that did not contain tags that the user was subscribed to.  The implementation was very simple: the SQLite database was used, which had only 2 columns (id and tags), since Python3 had a built-in library for interacting with it.  Also added commands for editing tags: the user could delete, add and copy tags.  The last thing happened was very simple: the user sent a link to the profile to the bot, after which the tags were searched using (I repent! I did not know that it was bad) a regular expression. </p><br><h3 id="problemy">  Problems </h3><br><p> The final program turned out to be quite unstable: it fell quite often (in order to avoid this, we had to wrap a part of the code in <code>while True:</code> .  Do not forget about the regular expression.  As a result, the bot, although crooked, worked, so it was decided to leave everything as it is and allow it to live (as it turned out, until the end of February).  Sources can (but need?) Find <a href="https://github.com/ShoshinNikita/habr-telegram-bot">GitHub</a> . </p><br><h2 id="vtoraya-versiya-na-go">  Second version (on Go) </h2><br><p>  For a long time, the idea to try Go went to my head, but my hands did not reach.  And then, finally, free time was found.  After reading the documentation, I wanted to write something, and then just the Python bot fell (even <code>while True</code> did not help).  Realizing that this is a sign from above, I began to rewrite the bot on Go. </p><br><p>  Unfortunately, I don‚Äôt have any real development experience on Go, and there‚Äôs no one to ask.  Therefore, the solutions that I use, experienced people may not seem the best.  If something is really bad, then please write what is wrong.  And now let's move on to describing the architecture of the application. </p><br><p>  I'll start with the libraries.  Telegram <a href="">-bot-api.v4 is</a> used to interact with the Telegram API, <a href="">and go-sqlite3</a> is used to interact with SQLite3.  RSS feed parsed with <a href="https://github.com/mmcdole/gofeed">gofeed</a> .  To copy user tags, use the analogue Beautiful Soup on Go - <a href="https://github.com/anaskhan96/soup">soup</a> . </p><br><p>  We now turn to the code.  There is a main loop that receives new messages from the bot.  It defines the type of commands: </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> update := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> updateChannel { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> update.Message == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> update.Message.Command() == <span class="hljs-string"><span class="hljs-string">"start"</span></span> { startChan &lt;- update.Message } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> update.Message.Command() == <span class="hljs-string"><span class="hljs-string">"help"</span></span> { helpChan &lt;- update.Message ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { message := tgbotapi.NewMessage(update.Message.Chat.ID, <span class="hljs-string"><span class="hljs-string">"..."</span></span>) message.ReplyToMessageID = update.Message.MessageID bot.send(message) } }</code> </pre> <br><p>  As it was possible to understand from the code, each command is processed in a separate goroutine, the transfer of messages is carried out using channels: </p><br><pre> <code class="go hljs">startChan := <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> *tgbotapi.Message, <span class="hljs-number"><span class="hljs-number">50</span></span>) helpChan := <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> *tgbotapi.Message, <span class="hljs-number"><span class="hljs-number">50</span></span>) getTagsChan := <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> *tgbotapi.Message, <span class="hljs-number"><span class="hljs-number">50</span></span>) ... <span class="hljs-comment"><span class="hljs-comment">// Goroutines go bot.start(startChan) go bot.help(helpChan) go bot.getTags(getTagsChan) ...</span></span></code> </pre> <br><p>  It is also possible to send alerts to users.  This happens through a special web page. </p><br><div class="spoiler">  <b class="spoiler_title">Webpage</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/1s/gu/ch/1sguchqjd36_qg95bdh2txgq3mg.png"></p></div></div><br><p>  It was decided to split the project into several packages: </p><br><ul><li>  main - the config file is loaded, the bot and site are launched </li><li>  bot - responsible for bot operation </li><li>  website - responsible for the operation of the site </li><li>  logging - logs errors </li></ul><br><p>  Here is the process of starting the program: </p><br><ol><li>  Files for logging open </li><li>  The config file is read </li><li>  The bot is initialized and the database is opened. </li><li>  The bot runs in a separate goroutine (when the bot starts, goroutine starts with functions that process the commands) </li><li>  The site is launched in a separate goroutine </li></ol><br><p>  If during the launch or operation of the bot an error occurs that does not allow the program to work normally, the program ends with code 1. </p><br><h3 id="problemy-1">  Problems </h3><br><p>  Unfortunately, the problems could not be avoided this time.  But they are not connected with the bot's work, but with the development of the program and collecting the executable file under Linux (development takes place on Windows 10, the server runs on Ubuntu 04/16): CGO is needed to run the <code>go-sqlite3</code> library, and when the <code>go build</code> command is executed with the <code>CGO_ENABLED=1</code> flag <code>CGO_ENABLED=1</code> errors appear.  Because of this, you have to compile a project on a virtual machine with Ubuntu. </p><br><h2 id="zachem">  What for? </h2><br><p>  You may ask: "So why use this bot if there is a website?".  I will try to answer.  But before that I want to say that the bot is by no means a replacement for the site, just an add-on. </p><br><ul><li>  Ability to collect "all in one pile."  For me personally, Telegram is the source of all news and interesting materials, so I wanted to be able to receive articles from Habr and there </li><li>  Ability to view articles using Instant View.  For this was written your template.  Due to this, it is possible to read almost all articles in a convenient format directly from the phone (some articles contain tags that IV cannot correctly interpret, therefore some of the articles are not available for viewing) <div class="spoiler">  <b class="spoiler_title">An example of a message from the bot</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/9h/w-/ek/9hw-eklggg7ortvuenzm5zsxzxw.jpeg"></div></div></li><li>  It also implemented the ability to send the bot a link to the article from Habrahabr, after which it will return it in the same format that it sends itself (with Instant View, the link to the article and comments) <div class="spoiler">  <b class="spoiler_title">Example (from client for Windows)</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ru/it/xa/ruitxasoezauzzalfysdid9mbvk.png"></div></div></li></ul><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  Summing up, I would like to say that the experience of writing a bot on Go was quite interesting and useful (I hope).  If you are interested in a bot, you can find it yourself <a href="https://t.me/unofficial_habr_bot">here</a> , and its source code - again on <a href="https://github.com/ShoshinNikita/habrahabr-bot-go">GitHub</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/350858/">https://habr.com/ru/post/350858/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350848/index.html">Women in IT, an inside look</a></li>
<li><a href="../350850/index.html">Do you really need Redux?</a></li>
<li><a href="../350852/index.html">Information security of bank non-cash payments. Part 3 - Formation of requirements for the protection system</a></li>
<li><a href="../350854/index.html">FastTrack Training. "Network Basics". "Basics of data centers." Part 1. Eddie Martin. December 2012</a></li>
<li><a href="../350856/index.html">Interface Composition in Go</a></li>
<li><a href="../350860/index.html">How big data will change the automotive industry</a></li>
<li><a href="../350862/index.html">Tutorial: Using Thymeleaf</a></li>
<li><a href="../350864/index.html">Thymeleaf Tutorial: Chapter 1. Introduction</a></li>
<li><a href="../350866/index.html">Thymeleaf Tutorial: Chapter 2. A Thymes Good Virtual Grocery Store</a></li>
<li><a href="../350868/index.html">Thymeleaf Tutorial: Chapter 3. Using Text</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>