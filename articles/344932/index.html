<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Economy solution for the Internet of Things. Azure IoT Hub + Azure functions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the most expensive services in the standard IoT solution from Azure is Stream Analytic. In order to get around this expensive service, more sui...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Economy solution for the Internet of Things. Azure IoT Hub + Azure functions</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/post/344932/"><img src="https://habrastorage.org/webt/bu/o4/59/buo459steihwg28mqgytqhsvizm.png"></a> <br>  One of the most expensive services in the standard IoT solution from Azure is Stream Analytic.  In order to get around this expensive service, more suitable for the development of Enterprise solutions, you can use the capabilities of Azure Functions. <br><br>  How can I create an IoT hub and connect the Arduino to it I <a href="https://habrahabr.ru/company/microsoft/blog/343450/">wrote earlier</a> .  Now, let's cheapen the solution.  Replace Stream Analytic with Azure Functions. <br>  Under the cat you will find a manual How-To <br><a name="habracut"></a><br>  First we go to the endpoints of our IoT hub and take from the endpoint called Events, the name compatible with the event hub. <br><br><img src="https://habrastorage.org/webt/qf/zs/qf/qfzsqfyyx9a2w134clx8u9b8gki.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Copy and save.  It will be needed later. <br>  Now create a new function. <br><br><img src="https://habrastorage.org/webt/ha/pz/iy/hapziyet1nxgph9b0vzwrwwlk_4.png"><br><br>  The allocation plan will be more economical to choose the ‚ÄúConsumption Plan‚Äù if the number of calls to your function is not particularly large.  Cost 20 cents per million function launches. <br><br>  Next, create a custom function like IoT Hub (Event Hub) <br><br><img src="https://habrastorage.org/webt/il/2u/mp/il2umps4jerhb8pine6z-g-9olm.png"><br><br>  I chose C # as the language, but you can choose another language closer to you. <br><br><img src="https://habrastorage.org/webt/03/ai/yt/03aiyt1joheihmeuxlzuaw54bhc.png"><br><br>  In the string Event Hub name we enter the value that we copied from the IoT Hub. <br>  Clicking on the "new" set the value of the connection. <br><br><img src="https://habrastorage.org/webt/kp/1f/tr/kp1ftrtota_qutip7vygylmkldm.png"><br><br>  The following code will be automatically created as a function template code: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> myIoTHubMessage, TraceWriter log</span></span></span><span class="hljs-function">)</span></span> { log.Info(<span class="hljs-string"><span class="hljs-string">$"C# IoT Hub trigger function processed a message: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{myIoTHubMessage}</span></span></span><span class="hljs-string">"</span></span>); }</code> </pre> <br>  Run the function and turn on the device from the previous article.  If everything is configured correctly, then in the log window we will get the following log: <br><blockquote>  2017-12-17T16: 20: 40.486 Function started (Id = 63b0dbda-1624-4e2c-b381-47442e69b853) <br>  2017-12-17T16: 20: 40.486 C # IoT Hub trigger function processed a message: {‚ÄúdeviceId‚Äù: ‚ÄúArduinoAzureTwin‚Äù, ‚Äúiotdata‚Äù: 581} <br>  2017-12-17T16: 20: 40.486 Function completed (Success, Id = 63b0dbda-1624-4e2c-b381-47442e69b853, Duration = 0ms) </blockquote><br><img src="https://habrastorage.org/webt/1f/ud/x6/1fudx6bimkiwabgiyb4pfpth9bc.png"><br><br>  The function works, but we need to save the data to the database.  I use SQL Server as a database.  You can use some other type of database.  Go to the existing database or create a new one.  In the menu item "Connection Strings" take the line ADO.NET. <br><br><img src="https://habrastorage.org/webt/p_/r7/ki/p_r7ki86pwbdvdn4swmfgiehx3e.png"><br><br>  Now in our function, go to the "Application Settings". <br><br><img src="https://habrastorage.org/webt/zb/qe/nx/zbqenx_vjqazagj-jdv_gyuwrk4.png"><br><br>  We're not going to store our connection string in C # code?  We save it in the application connection lines, not forgetting to change the login and password. <br><br><img src="https://habrastorage.org/webt/1l/5p/zc/1l5pzcnsffu2p2mrk9sp9cviqsk.png"><br><br>  Now it remains to change our function so that it can write data from JSON to the database.  A pretty standard code version looks like this: <br><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#r "System.Configuration" #r "System.Data" #r "Newtonsoft.Json" using System; using System.Configuration; using System.Data.SqlClient; using System.Threading.Tasks; using System.Net; using Newtonsoft.Json; public static async Task Run(string myIoTHubMessage, TraceWriter log) { log.Info($"Message: {myIoTHubMessage}"); var e = JsonConvert.DeserializeObject&lt;EventData&gt;(myIoTHubMessage); var str = ConfigurationManager.ConnectionStrings["SQLServerDB_connection"].ConnectionString; using (SqlConnection conn = new SqlConnection(str)) { conn.Open(); var text = "INSERT INTO [dbo].[SensorData] (DeviceName, SensorValue) Values (@deviceId, @iotdata);"; using (SqlCommand cmd = new SqlCommand(text, conn)) { cmd.Parameters.AddWithValue("@iotdata", e.iotdata); cmd.Parameters.AddWithValue("@deviceId", e.deviceId); var result = await cmd.ExecuteNonQueryAsync(); log.Info($"Inserted: {result.ToString()}"); } } } public class EventData { public string deviceId { get; set; } public int iotdata { get; set; } }</span></span></code> </pre> <br>  As a result, we quickly got a cloud IoT solution that removes data from the device and saves it to the cloud database.  Additionally, you can create a free Azure Web App data visualization application. <br><br>  The price of the solution is slightly more than the cost of the database.  That is, if you use the base size of 2 Gb, you get a little more than 5 dollars a month.  Nothing prevents us from using some other cloud database or even some local database located on your server. </div><p>Source: <a href="https://habr.com/ru/post/344932/">https://habr.com/ru/post/344932/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../344920/index.html">The grand piano must disappear: the levels of professional development and their evaluation, the programmers</a></li>
<li><a href="../344922/index.html">How did I manage to hack the application</a></li>
<li><a href="../344924/index.html">Digital events in Moscow from December 18 to 24</a></li>
<li><a href="../344926/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ293 (December 11 - 17, 2017)</a></li>
<li><a href="../344930/index.html">How to animate the picture in the browser. Multi-pass WebGL rendering</a></li>
<li><a href="../344934/index.html">Jeb Klitschko</a></li>
<li><a href="../344936/index.html">The concept of communication in projection modeling</a></li>
<li><a href="../344938/index.html">Multi-pattern matching on GPU myth or reality</a></li>
<li><a href="../344942/index.html">How to ask questions in IRC</a></li>
<li><a href="../344944/index.html">Aliexpress brain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>