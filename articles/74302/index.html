<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Quick Reflection via DynamicMethod</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the ‚Äútasty‚Äù features of .NET, and in particular C #, is Reflection (reflexion) - a rich set of classes for working with data types, their prope...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Quick Reflection via DynamicMethod</h1><div class="post__text post__text-html js-mediator-article">  One of the ‚Äútasty‚Äù features of .NET, and in particular C #, is Reflection (reflexion) - a rich set of classes for working with data types, their properties, methods, and fields at runtime. <br>  But for such a wide functionality you have to pay performance. <br>  The method call from the code is executed almost a hundred times faster than the call through reflex. <br>  And if we don‚Äôt know in advance which particular class will be used and which method will be called or don‚Äôt want to be tied to a specific library, then working through reflection can greatly reduce application performance. <br><br>  In this article I would like to talk about the use of dynamic methods for such purposes. <br><br><a name="habracut"></a><br>  Suppose that we know in advance only the number of arguments of the method we want to call.  That will be enough for us ... <br>  Let's write a test class whose method we will call. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">using</font> System; <br> <br> <font color="#0000ff">namespace</font> AppForBlog1 { <br> <font color="#0000ff">class</font> TestClass { <br> <font color="#0000ff">int</font> index; <br> <font color="#0000ff">public</font> <font color="#0000ff">int</font> Index { <font color="#0000ff">get</font> { <font color="#0000ff">return</font> index; } <font color="#0000ff">set</font> { index = <font color="#0000ff">value</font> ; } } <br> <font color="#0000ff">public</font> <font color="#0000ff">int</font> UpdateIndex( <font color="#0000ff">int</font> index) { <br> <font color="#0000ff">this</font> .index = index; <br> <font color="#0000ff">return</font> <font color="#0000ff">this</font> .index * 2; <br> } <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  What do we want?  We want to get a delegate of a new method, which should receive an input of an instance of the required class and parameters of the called method and return the result of the called method. <br><br>  You must first define a delegate. <br><br><blockquote> <code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">delegate</font> <font color="#0000ff">object</font> MethodDelegate( <font color="#0000ff">object</font> inst, <font color="#0000ff">object</font> param);</font> <br></code> </blockquote><br>  Now we will decide what information we need to call the method: the name of the class, the name of the method, the signature of the method, and the type of the class from which this method will be called (explained below). <br><br>  We turn to the most interesting. <br>  To work with reflections and create a dynamic method, we need to use the following namespaces, respectively System.Reflection and System.Reflection.Emit. <br><br>  First, we need to get information about the method we will call.  We will do this by means of ordinary reflexion. <br><br><blockquote> <code><font color="black">MethodInfo mi = _.GetMethod( _, BindingFlags.Public | BindingFlags.Instance, <font color="#0000ff">null</font> , <font color="#0000ff">new</font> Type[] { _ }, <font color="#0000ff">null</font> );</font> <br></code> </blockquote><br>  Secondly, you need to create an instance of the DynamicMethod class. <br><br><blockquote> <code><font color="black">DynamicMethod dm = <font color="#0000ff">new</font> DynamicMethod( __, _, _, ___ , <font color="#0000ff">new</font> Type[] { __1__, __2__ }, __);</font> <br></code> </blockquote><br>  It should be clarified here that the method cannot exist without any class, therefore we indicate the type of owner_class to which the method will be attached. <br>  We will create a static method, so MethodAtributes.Public and MethodAttributes.Static should be specified in method_ attributes, and CallingConventions.Standard should be specified in method_call. <br><br>  Further, our method should do something.  Therefore, we create an IL generator and enter instructions into it. <br><br><blockquote> <code><font color="black">ILGenerator gen = dm.GetILGenerator();</font> <br></code> </blockquote><br>  We call the method is not static, so the first argument should be an instance of the class, followed by the parameters. <br>  Because  If the instance and parameters come in a method packed into an object, then they need to be unpacked (execute unboxing). <br>  After calling the method, we need to pack the result into object and return it to the calling code. <br><br><blockquote> <code><font color="black">gen.Emit(OpCodes.Ldarg_0); <br> gen.Emit(OpCodes.Unbox_Any, _); <br> gen.Emit(OpCodes.Ldarg_1); <br> gen.Emit(OpCodes.Unbox_Any, _); <br> gen.Emit(OpCodes.Callvirt, mi); <br> gen.Emit(OpCodes.Box, _); <br> gen.Emit(OpCodes.Ret);</font> <br></code> </blockquote><br>  The method is ready.  It remains only to receive a delegate. <br><br><blockquote> <code><font color="black">MethodDelegate method = (MethodDelegate)dm.CreateDelegate( <font color="#0000ff">typeof</font> (MethodDelegate));</font> <br></code> </blockquote><br>  Now we can use this delegate as many times as necessary to call the method we need. <br><br>  We collect the above in class. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">using</font> System; <br> <font color="#0000ff">using</font> System.Reflection; <br> <font color="#0000ff">using</font> System.Reflection.Emit; <br> <br> <font color="#0000ff">namespace</font> AppForBlog1 { <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> ReflectClass { <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> MethodDelegate GetMethodDelegate(Type owner, Type instance, <font color="#0000ff">string</font> methodName, Type returnType, Type parameterType) { <br> <font color="#008000">//   </font> <br> MethodInfo mi = instance.GetMethod(methodName, BindingFlags.Public | BindingFlags.Instance, <font color="#0000ff">null</font> , <font color="#0000ff">new</font> Type[] { parameterType }, <font color="#0000ff">null</font> ); <br> <font color="#0000ff">if</font> (mi == <font color="#0000ff">null</font> ) <font color="#0000ff">return</font> <font color="#0000ff">null</font> ; <br> <font color="#008000">//  </font> <br> DynamicMethod dm = <font color="#0000ff">new</font> DynamicMethod(methodName + <font color="#A31515">"Wrapper"</font> , <br> MethodAttributes.Public | MethodAttributes.Static, CallingConventions.Standard, <br> <font color="#0000ff">typeof</font> ( <font color="#0000ff">object</font> ), <font color="#0000ff">new</font> Type[] { <font color="#0000ff">typeof</font> ( <font color="#0000ff">object</font> ), <font color="#0000ff">typeof</font> ( <font color="#0000ff">object</font> ) }, owner, <font color="#0000ff">false</font> ); <br> <font color="#008000">// IL-</font> <br> ILGenerator gen = dm.GetILGenerator(); <br> <font color="#008000">//      </font> <br> gen.Emit(OpCodes.Ldarg_0); <br> <font color="#008000">//   object</font> <br> gen.Emit(OpCodes.Unbox_Any, instance); <br> <font color="#008000">//   </font> <br> gen.Emit(OpCodes.Ldarg_1); <br> <font color="#008000">//   object</font> <br> gen.Emit(OpCodes.Unbox_Any, parameterType); <br> <font color="#008000">// </font> <br> gen.Emit(OpCodes.Callvirt, mi); <br> <font color="#008000">//   object</font> <br> gen.Emit(OpCodes.Box, returnType); <br> <font color="#008000">// </font> <br> gen.Emit(OpCodes.Ret); <br> <font color="#008000">// </font> <br> <font color="#0000ff">return</font> (MethodDelegate)dm.CreateDelegate( <font color="#0000ff">typeof</font> (MethodDelegate)); <br> } <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">delegate</font> <font color="#0000ff">object</font> MethodDelegate( <font color="#0000ff">object</font> inst, <font color="#0000ff">object</font> param); <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Well, it's time to check the performance of this class. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">using</font> System; <br> <font color="#0000ff">using</font> System.Collections. <font color="#2B91AF">Generic</font> ; <br> <font color="#0000ff">using</font> System.Linq; <br> <font color="#0000ff">using</font> System.Text; <br> <font color="#0000ff">using</font> NUnit.Framework; <br> <font color="#0000ff">namespace</font> AppForBlog1 { <br> [TestFixture] <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> TestFixtureClass { <br> [Test] <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> FastReflectionTest() { <br> <font color="#008000">//  " "</font> <br> TestClass ts = <font color="#0000ff">new</font> TestClass(); <br> <br> <font color="#008000">// </font> <br> Assert.AreEqual(4, ts.UpdateIndex(2)); <br> Assert.AreEqual(2, ts.Index); <br> <br> <font color="#008000">// </font> <br> MethodDelegate updateIndex = ReflectClass.GetMethodDelegate( <font color="#0000ff">typeof</font> (TestFixtureClass), <font color="#0000ff">typeof</font> (TestClass), <font color="#A31515">"UpdateIndex"</font> , <font color="#0000ff">typeof</font> ( <font color="#0000ff">int</font> ), <font color="#0000ff">typeof</font> ( <font color="#0000ff">int</font> )); <br> <br> ts.Index = 1; <br> Assert.AreEqual(1, ts.Index); <br> <br> <font color="#008000">// </font> <br> Assert.AreEqual(16, updateIndex(ts, 8)); <br> Assert.AreEqual(8, ts.Index); <br> } <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Everything is working!.. <br><br>  When used in real-world applications, types will have to be obtained not through typeof, but correspondingly again through reflection.  But this will need to be done once and then use only the delegate, whose call speed is just 2 times slower than a direct call. <br><br>  Good luck! <br><br>  PS This method also works for class properties, since  any property is two methods: set and get.  And they can be obtained from property information (PropertyInfo). </div><p>Source: <a href="https://habr.com/ru/post/74302/">https://habr.com/ru/post/74302/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../74290/index.html">Apple.com vulnerability continues to work</a></li>
<li><a href="../74292/index.html">JRE 6.0 update 17</a></li>
<li><a href="../74295/index.html">The 27th edition of Russian Full Circle Magazine</a></li>
<li><a href="../74298/index.html">A look at the HTC Tattoo</a></li>
<li><a href="../74301/index.html">Pro X Lunar Prize, Million Dollars, Halloween and John Carmack</a></li>
<li><a href="../74303/index.html">Regular fundraising</a></li>
<li><a href="../74306/index.html">Google dashboard</a></li>
<li><a href="../74307/index.html">Habrastia Life Cycle - 2</a></li>
<li><a href="../74308/index.html">HTC HD2 went on sale in European countries</a></li>
<li><a href="../74309/index.html">Auto-update scripts in the next version of Greasemonkey</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>