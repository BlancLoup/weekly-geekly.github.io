<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>More about caching in Django</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Everyone knows what caching is and why it is needed. Attendance grows, the load on the database increases, and we decide to give the data from the cac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>More about caching in Django</h1><div class="post__text post__text-html js-mediator-article"> Everyone knows what caching is and why it is needed.  Attendance grows, the load on the database increases, and we decide to give the data from the cache.  In an ideal world, probably, it will be enough for this to add the line <code>USE_CACHE = True</code> in settings.py, but until this time has come, it will take a bit more gestures. <br><br>  When we are going to use the cache in Django, we need to make a choice: to take a <a href="http://djangopackages.com/grids/g/caching/">ready-made solution</a> that will make everything ‚Äúbehind the scenes‚Äù, or implement our own.  Unlike many other situations, this choice is not so obvious, as there are quite a lot of limitations and potential inconveniences in existing ready-made solutions. <br><br>  First, we will quickly look at ready-made solutions, and then we will figure out how best to implement caching yourself. <br><a name="habracut"></a><br><h1>  Turnkey solutions </h1><br>  We go to <a href="http://djangopackages.com/grids/g/caching/">djangopackages.com</a> and see what will please us. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  <a href="http://packages.python.org/johnny-cache/index.html">Johnny cache</a> </h2><br>  Monkeypatchit Django querysets so that all requests to ORM are cached automatically.  The installation is as simple as possible: a couple of new lines in settings.py, otherwise everything remains the same, the syntax of the queries does not change.  Data is cached forever, invalidate changes. <br><br>  But just a disability can negate all the effectiveness of Johnny.  Disabled <a href="http://packages.python.org/johnny-cache/queryset_cache.html">tables in the database entirely</a> .  In other words, if you have 9000 users, if you change at least one of them, the cache will be reset for all.  If you need to cache a rarely changing table, this solution may be appropriate, in other cases (and most of them) - alas. <br><br><h2>  <a href="https://github.com/jbalogh/django-cache-machine">Django cache machine</a> </h2><br>  Too requests to ORM.  Only querysets are cached, queries of type <code>.get()</code> not cached.  Also does not <code>.values()</code> and <code>.values_list()</code> .  To use, you need to add a mixin and a manager to the model. <br><br>  Tries to reasonably approach disability.  When changing one object, only those cache elements that include this object are invalidated (including relations like <code>ForeignKey</code> and <code>ManyToMany</code> ). <br><br><h2>  <a href="https://github.com/dziegler/django-cachebot">Django-cachebot</a> </h2><br><br>  Automatically caches all <code>.get()</code> requests.  To cache querysets, call the <code>cache()</code> method.  Uses his manager. <br><br>  Disability is about the same as Django Cache Machine.  Not invalidated by changes in <code>ManyToMany</code> . <br><br><h2>  Total </h2><br>  Django Cache Machine and Django-cachebot acceptable solve the task, Johnny Cache is too indistinct in invalidation, I would not recommend it. <br><br>  It would seem that you can take and use, but there are a couple of things that must be remembered. <br><ul><li>  There is practically no control over disability.  Very often it may be needed.  For example, you have a site with articles (or any other materials).  There is a page with a list of articles, there are only headlines, there are pages for each article.  Do I need to invalidate the cache of the list of articles if the text of any article changes (the title remains the same)?  Of course not.  But to explain something similar to a third-party application is very difficult. </li><li>  Almost all apps have some limitations.  Someone does not cache aggregation, someone calls <code>.get()</code> calls, someone is not disabled in some cases.  If you have such things in the project, then perhaps using a ready-made solution is not the best choice, because you still have to write a lot yourself (or yourself). </li></ul><br>  If such things do not confuse you, then ready-made solutions for you.  If for some reason you want to implement caching yourself, then move on. <br><br><h1>  Do it yourself </h1><br>  Architecturally, you need to implement two things.  The first is the logic of data acquisition: we look if there is data in the cache, if there is, give it, if not, take it from the database, put it in the cache, give it.  The second is the logic of invalidation. <br><br><h2>  Get the data </h2><br>  Everything is simple and obvious: <br><br><pre> <code class="python hljs"> cached = cache.get(<span class="hljs-string"><span class="hljs-string">'my_key'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cached <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cached result = make_heavy_query() cache.set(<span class="hljs-string"><span class="hljs-string">'my_key'</span></span>, result) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result</code> </pre><br><br>  <b>Q</b> : how to store data forever (infinite timeout)?  <b>A</b> : use a backend that supports it, for example, <a href="https://github.com/ericflo/django-newcache/">django-newcache</a> <br><br>  <b>Q</b> : What if I want to keep <code>None</code> in the cache?  <b>A</b> : read the <a href="https://docs.djangoproject.com/en/dev/topics/cache/">documentation</a> and find out that you can use any value instead of <code>None</code> : <br><br><pre> <code class="python hljs"> cached = cache.get(<span class="hljs-string"><span class="hljs-string">'my_key'</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cached != <span class="hljs-number"><span class="hljs-number">-1</span></span>: <span class="hljs-comment"><span class="hljs-comment"># ...</span></span></code> </pre><br><br><h3>  Where to keep the code associated with the cache? </h3><br>  The main thing - to keep it in one place, and not to smear throughout the project.  In my (and not only in my) opinion, the most suitable place is the manager of the corresponding model.  You can override <code>MyModel.objects</code> , you can add another <code>MyModel.cached</code> type. <br><br>  Often you need code that caches access to related objects.  For example, for some article you need to get a list of tags.  There is a temptation to put the caching code in the model method, but I am in favor of being consistent and do it through the manager.  And already in the model contact the manager: <br><br><pre> <code class="python hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Article</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(models.Model)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># ... def get_tags(self): return Article.cached.tags_for_instance(self.id)</span></span></code> </pre><br><br><h3>  How to store data? </h3><br>  Instance models can be put into the cache just like that, they are perfectly serialized.  All methods will work, type, <code>get_FOO_display</code> .  You just need to remember that related objects ( <code>ForeignKey</code> and <code>ManyToMany</code> ) will not get into the cache, and when you try to access them, the base will twitch again.  Therefore, it is better to add your methods to refer to them (see the example above). <br><br>  If you want to cache the queryset, then it is better to first bring it to the list ( <code>list</code> ).  It can be cached this way, but this may affect <a href="https://docs.djangoproject.com/en/dev/ref/models/querysets/">compatibility issues between Django versions</a> . <br><br>  If the list of objects is relatively small and rarely changes (for example, the list of cities, faculties, etc.) and the order of the elements is not important, then you can store it in the form of a dictionary, in this form: <br><pre> <code class="python hljs">dict((x.id, x) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> MyModel.objects.all())</code> </pre> <br>  This will make it possible to get by with one cache entry, rather than making an entry for each object. <br><br>  Sometimes it makes sense to store not a list of objects, but only a list of IT specialists, and the objects themselves to get their cache with another <code>get_many</code> request.  Plus: disability is needed only when the composition of the elements of the list changes, that is, less often.  Minus: sometimes no benefit from the plus.  Here, probably, we need an example.  Suppose we have a list of "10 recent articles."  If you store only IDs, then you need to invalidate this list only if a new article has been added to the site or some article has been deleted from this list.  If you keep the entire list of objects, then you need to invalidate any change to the article (for example, a typo corrected).  On the other hand, if articles are added infrequently, then there will be no benefit here, so this method will not work everywhere. <br><br><h3>  How to name keys? </h3><br>  If we store something in a unique site, for example, a list of articles, then you can call the key as you please.  For example, <code>'articles'</code> .  You do not need to add a unique prefix each time; <a href="https://docs.djangoproject.com/en/dev/ref/settings/">one time is enough</a> . <br><br>  If the key name depends on the object, then you need to use string formatting.  Often do this: <code>'article::%d'</code> .  Everything is good, but it is possible better: <code>'article::%(id)d'</code> .  In the first case, "some kind of whole", in the second - aidish.  Or compare <code>'tags_for::%d'</code> and <code>'tags_for::%(article_id)d'</code> .  If this syntax seems strange to you, then <a href="http://docs.python.org/library/stdtypes.html">it is fixable</a> . <br><br><h2>  Disability </h2><br>  Disability is best done with signals.  The signal code can be stored anywhere, I prefer <code>@staticmethod</code> 's model class for this.  Disability is often not done very effectively.  Here is a typical example: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta"> @receiver(post_save, sender=Article) @receiver(pre_delete, sender=Article) def invalidate(instance, **kwargs): cache.delete('article::%(id)d' % {'id': instance.id})</span></span></code> </pre><br><br>  After all, you can do better! <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta"> @receiver(post_save, sender=Article) def on_change(instance, **kwargs): cache.set('article::%(id)d' % {'id': instance.id}, instance) @receiver(pre_delete, sender=Article) def on_delete(instance, **kwargs): cache.delete('article::%(id)d' % {'id': instance.id})</span></span></code> </pre><br><br>  Why delete a value when it can be replaced with a new one?  We save the query to the database and we insure against the dogpile effect.  Of course, now we need two handlers: for changing an object and for deleting.  It is better to do this whenever possible. <br><br><h3>  Disability ManyToMany </h3><br>  For each <code>ManyToManyField</code> you need to hang an additional disability.  Like that: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta"> @receiver(m2m_changed, sender=Article.tags.through) def on_tags_changed(instance, **kwargs): # do update / invalidation</span></span></code> </pre><br><br><h1>  Caching ModelChoiceField and ModelMultipleChoiceField </h1><br>  Django has no built-in ability to cache options for these fields.  This means that each rendering of this field will result in a request to the database.  You can use your hands to replace them with <code>ChoiceField</code> and <code>MultipleChoiceField</code> respectively (+ add some logic), or you can use <a href="https://github.com/drtyrsa/django-cached-modelforms">my little application</a> .  It works exactly on Django 1.2-1.4.  Here I will not grovel, the link describes everything. <br><br><h1>  Never rely on cache persistence! </h1><br>  Finally, a few words about persistence.  Firstly, this word looks very clever, and secondly, remember that you can do exactly two things with the cache: read from there and write a new value there.  Never try to change the data in the cache, for example, like this: <br><br><pre> <code class="python hljs"> mylist = cache.get(<span class="hljs-string"><span class="hljs-string">'mylist'</span></span>) mylist.append(value) cache.set(<span class="hljs-string"><span class="hljs-string">'mylist'</span></span>, mylist)</code> </pre><br><br>  This operation is not atomic, that is, there is no guarantee that two customers will not change the list at the same time.  And when this happens, you will spend a sleepless night, figuring out what is the matter and why you have the wrong data.  So it is better not to.  Of course, you can use those operations whose atomicity is guaranteed by the backend, for example, <code>cache.incr()</code> / <code>cache.decr()</code> for the memocache. <br><br><h2>  Conclusion </h2><br>  If something in the above written is not optimal or wrong, write in the comments, I will correct the article.  She will be more useful, and her readers - happier.  Thank. </div><p>Source: <a href="https://habr.com/ru/post/143789/">https://habr.com/ru/post/143789/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../143781/index.html">How to turn all visitors to your site into buyers?</a></li>
<li><a href="../143782/index.html">Augmented reality to help you!</a></li>
<li><a href="../143784/index.html">Review of the phone Grandstream GXV3140</a></li>
<li><a href="../143787/index.html">PRUFFI Friends discloses financial indicators</a></li>
<li><a href="../143788/index.html">Office 365 ‚Äî Common Problems When Planning and Implementing Hybrid Configurations</a></li>
<li><a href="../143790/index.html">Nokia Maps Free Webinar for Nokia Series 40 Applications</a></li>
<li><a href="../143791/index.html">Testing the apple radiometer</a></li>
<li><a href="../143792/index.html">Battery that breathes</a></li>
<li><a href="../143793/index.html">Team LinguaLeo goes to Montenegro for 2 months. On board 5 empty seats! The mission of the team is to release the most important releases.</a></li>
<li><a href="../143795/index.html">Easter eggs on the website zoichland.ru</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>