<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A minute of Black Magic</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article will tell you how to learn how to debug and love the little black board of the Black Magic Probe V2.1. But first, a little about what it ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A minute of Black Magic</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/59/e4/a9/59e4a9852e408840259521.png" alt="Prev"><br></p><br>  This article will tell you how to learn how to debug and love the little black board of the Black Magic Probe V2.1.  But first, a little about what it is and why it is needed. <br><p>  The Black Magic Probe Mini V2.1 (BMPM2) board, developed by 1BitSquared in collaboration with Black Sphere Technologies, is a JTAG and SWD adapter, designed for programming and debugging ARM Cortex-M and ARM Cortex-A microcontrollers.  You can add support for other processors.  Description of the process of adding can be found by <a href="https://github.com/blacksphere/blackmagic/wiki/Adding-target-drivers">reference</a> .  It is also worth noting that any processor with ADIv5 support (ARM Debug Interface v5) will be determined by the board. </p><a name="habracut"></a><br><p>  The figures show the ARM Cortex-M and ARM Cortex-A processor families supported by the Black Magic Probe Mini V2.1 board. </p><br><p><img src="https://habrastorage.org/webt/59/e4/a9/59e4a9bd96731131455336.png" alt="Cortex-M processor family supported by Black Magic Probe Mini V2.1 board"><br><img src="https://habrastorage.org/webt/59/e4/a9/59e4a98ed3c7e195143811.png" alt="Cortex-A processor family supported by Black Magic Probe Mini V2.1"></p><br><p>  During testing, Black Magic Probe revealed that the supported processors are not limited to the list provided by the manufacturer.  Officially not supported processors with ARM Debug Interface v5 are defined, for example, as ‚ÄúCortex-M0‚Äù or ‚ÄúCortex-A7‚Äù.  At the same time, full functionality is not guaranteed, but still it will take minimal debugging actions. </p><br><p>  What you can do with the Black Magic Probe: </p><br><ul><li>  interrupt the program execution process; </li><li>  observe changes in registers and variables; </li><li>  set breakpoints (you can set a breakpoint in the code that will cause the program to stop as soon as this breakpoint is reached); </li><li>  view the call stack (a list of functions and their parameters that led us to the current point and the state of the program); </li><li>  disassembling (the ability to view the machine code and find out exactly what the program does); </li><li>  memory dump (save RAM and / or flash content to a file). </li></ul><br><p>  Functions of the Black Magic Probe, which can be useful in the study of information security devices: </p><br><ul><li>  development of embedded software and devices for conducting attacks; </li><li>  reverse engineering IoT; </li><li>  search for vulnerabilities; </li><li>  dynamic analysis using IDA and other gdb compatible tools. </li></ul><br><p>  BMPM2 has two main features.  The first is that the gdb server is running on the device itself, opening a virtual port to which you can directly connect via the gdb client on your host computer (the <a href="https://launchpad.net/gcc-arm-embedded">gcc-arm-embedded</a> toolset is recommended), so you don‚Äôt need to configure <a href="http://openocd.org/">OpenOCD</a> or <a href="http://www.st.com/en/development-tools/st-link-v2.html">STLink configurations</a> .  A comparison of the debugging interface connection diagrams using OpenOCD / STLink and BMPM2 can be seen below.  As you can see, the BMPM2 connection option is simpler. </p><br><p><img src="https://habrastorage.org/webt/59/df/3d/59df3deba7e05224333103.png" alt="Comparison of algorithms for debugging without Black Magic Probe Mini V2.1 board and with it"></p><br><p>  The second is the ability to compile the firmware for other boards, with no need for BMPM2.  Compatible boards are presented <a href="https://github.com/blacksphere/blackmagic/wiki/Debugger-Hardware">here</a> . </p><br><p>  To study the possibilities of work, four boards were taken: TM32F103C8, STM32vldiscovery, STM32F429I-disc1 and the 1Bitsy V1.0 proposed by the developers. </p><br><p>  Work with 1Bitsy and STM32F429I-disc1 will be discussed in more detail.  The first one was chosen on the recommendation of the developers themselves, and the second one has a touch screen, which makes the research process more visual. </p><br><p>  <strong>Discover the world of debugging with the Black Magic Probe</strong> </p><br><p>  Studying the work of the Black Magic Probe V2.1 is convenient to start by debugging 1Bitsy.  This board was created specifically to work with BMPM2, so no difficulty should arise. <br>  Connect the Black Magic Probe and 1Bitsy with a JTAG cable and connect them to the computer. <br>  Below will be described the work in the GNU / Linux environment, a guide to work in Windows and MacOS is easy to find at the <a href="http://1bitsy.org/overview/quickstart/">link</a> . </p><br><p>  After connecting BMPM2 to the PC and to the JTAG connector, on 1Bitsy we will execute three commands in gdb to start debugging.  It is important that the user is added to the dialout group with the command "sudo adduser $ USER dialout", otherwise it will not work.  The first command ‚Äútarget extended-remote / dev / ttyACMx‚Äù connects to BMPM2, where x is the serial port number, then we scan all devices connected to the Black Magic Probe with the help of the command ‚Äúmonitor jtag_scan‚Äù.  If everything is good, then the list of found devices will be displayed and with the ‚Äúattach 1‚Äù command we will connect to 1Bitsy. </p><br><pre><code class="bash hljs">(gdb) target extended-remote /dev/ttyACM0 Remote debugging using /dev/ttyACM0 (gdb) monitor jtag_scan Target voltage: 3.3V Available Targets: No. Att Driver 1 STM32F4xx (gdb) attach 1 Attaching to Remote target warning: No executable has been specified and target does not support determining executable automatically. Try using the <span class="hljs-string"><span class="hljs-string">"file"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>. 0x0800026c <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ?? () (gdb)</code> </pre> <br><p>  That's it, now we can debug the firmware loaded in 1Bitsy.  With 1Bitsy, and the truth, there were no problems with the connection, everything is simple and quite convenient.  Will simplicity and convenience be maintained when working with another card? </p><br><p>  There was a motherboard based on the STM32 microcontroller - STM32F429I-disc1, and we will use it, at the same time we will fill it with some interesting firmware.  The main difference in working with this board from working with 1Bitsy is the connection via SWD interface, not JTAG. </p><br><p>  Before starting work, we connect the boards via the JTAG / SWD <a href="https://1bitsquared.com/collections/embedded-hardware/products/jtag-swd-100mil-pitch-breakout">adapter</a> as follows: <br>  on the SWD interface (if you count from the topmost output): </p><br><ol><li>  SWCLK </li><li>  GND </li><li>  SWDIO </li><li>  3V - tVref. </li></ol><br><p><img src="https://habrastorage.org/webt/59/df/3d/59df3dea9e191175773319.jpeg" alt="STM32F429I-disc1 and Black Magic Probe"></p><br><p>  To demonstrate the performance of the debugging process, <a href="https://github.com/miehigh/STM32F429I-Discovery_FW_V1.0.1/tree/master/Projects/Demonstration">firmware</a> was used that contains several software modules.  One of them - the game Reversi, it will debug the most interesting. </p><br><p>  Fill the firmware on the board and in gdb we enter almost the same commands as for 1Bitsy, with the only difference that the board is connected via SWD, so you will need to use the swdp_scan command. </p><br><pre> <code class="bash hljs">(gdb) target extended-remote /dev/ttyACM0 Remote debugging using /dev/ttyACM0 (gdb) monitor swdp_scan Target voltage: 3.3V Available Targets: No. Att Driver 1 STM32F4xx (gdb) attach 1 Attaching to Remote target warning: No executable has been specified and target does not support determining executable automatically. Try using the <span class="hljs-string"><span class="hljs-string">"file"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>. 0x0800026c <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ?? () (gdb)</code> </pre> <br><p>  To great sadness, we never managed to win, so I wanted to break something in it.  For a start, we looked at the <a href="">source</a> .  They found the variable Board, presumably denoting the address of the first cell of the board.  Nearby are the lines "Reversi - Player 1" and "Reversi - Player 2". </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _SetPlayer(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Player) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Score, ValidMoves, PossibleMoves; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> ac[<span class="hljs-number"><span class="hljs-number">256</span></span>]; _Board.ActPlayer = Player; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Player == <span class="hljs-number"><span class="hljs-number">1</span></span>) { FRAMEWIN_SetText(_hFrame, <span class="hljs-string"><span class="hljs-string">"Reversi - Player 1"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { FRAMEWIN_SetText(_hFrame, <span class="hljs-string"><span class="hljs-string">"Reversi - Player 2"</span></span>); } FRAMEWIN_SetBarColor(_hFrame, <span class="hljs-number"><span class="hljs-number">1</span></span>, (Player == <span class="hljs-number"><span class="hljs-number">1</span></span>) ? GUI_RED : GUI_BLUE); PossibleMoves = _CalcValidMoves(&amp;_Board); GUI_Exec(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!PossibleMoves) { GUI_Exec(); _Board.ActPlayer = <span class="hljs-number"><span class="hljs-number">3</span></span> - Player;</code> </pre> <br><p>  On these lines, we searched the IDA disassembler.  Found out that from the pseudocode, you can find the address, which is the starting address of the cells of the board. </p><br><pre> <code class="cpp hljs"> v1 = a1; v2002CB74 = a1; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( a1 == <span class="hljs-number"><span class="hljs-number">1</span></span> ) { sub_D8B3C(v2002CB80, <span class="hljs-string"><span class="hljs-string">"Reversi - Player 1"</span></span>); v2 = <span class="hljs-number"><span class="hljs-number">255</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { sub_D8B3C(v2002CB80, <span class="hljs-string"><span class="hljs-string">"Reversi - Player 2"</span></span>); v2 = <span class="hljs-number"><span class="hljs-number">16711680</span></span>; } sub_E06A8(v2002CB80, <span class="hljs-number"><span class="hljs-number">1</span></span>, v2); v3 = sub_DEDF8(<span class="hljs-number"><span class="hljs-number">0x2002CAF4</span></span>); result = ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> (*)(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>))sub_C91B4)(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( v3 ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; sub_C91B4(result); v2002CB74 = <span class="hljs-number"><span class="hljs-number">3</span></span> - v1; v5 = sub_DEDF8(<span class="hljs-number"><span class="hljs-number">0x2002CAF4</span></span>);</code> </pre><br><p>  Next, we decided to use gdb to see what is located at this address. </p><br><p><img src="https://habrastorage.org/webt/59/df/3d/59df3dead9c47781056143.png" alt="GDB output"><br><img src="https://habrastorage.org/webt/59/df/3d/59df3deb01033020606205.jpeg" alt="Beginning of the game"></p><br><p>  That's right.  If you carefully study this table and the location of the chips at the beginning of the game, you will notice that 001 means a red chip, and 002 means blue.  You can try changing the value of one of the cells.  To do this, we used the command: </p><br><p> <code>set *(char *) 0x2002CAF4 = 1</code> </p> <br><p>  Result: </p><br><p><img src="https://habrastorage.org/webt/59/df/3d/59df3deb2a681266865229.png" alt="GDB output"><br><img src="https://habrastorage.org/webt/59/df/3d/59df3deb2a834553990631.jpeg" alt="The state of the cells after entering the command"></p><br><p>  After that, we decided to try to equate the values ‚Äã‚Äãof all the cells to one, and thereby win the game from the first move. </p><br><p>  Script execution result: </p><br><p><img src="https://habrastorage.org/webt/59/df/3d/59df3deb448be113102057.png" alt="Script Execution Result"><br><img src="https://habrastorage.org/webt/59/df/3d/59df3deb4d512477333282.jpeg" alt="Cell status after script execution"></p><br><p>  The script worked successfully, we managed to win the game, which means that using the Black Magic Probe Mini V2.1 board, using gdb, you can successfully debug and "break" the firmware. <br>  And now some boring examples with blinking lights. </p><br><p>  <strong>STM32F103C8</strong> </p><br><p>  Connect STM32F103C8 to Black Magic Probe V2.1 via JTAG interface. </p><br><p><img src="https://habrastorage.org/webt/59/df/3d/59df3deb620c9178188410.png" alt="JTAG interface"></p><br><p>  Sources for firmware boards can be found <a href="https://github.com/jollheef/stm32f103c8t6_hello">here</a> . </p><br><p>  In the source code, you can try to change the blinking speed of the light bulb, reducing or increasing the time intervals when it is lit and when it goes out. </p><br><p>  <strong>STM32vldiscovery</strong> </p><br><p>  Connect STM32vldiscovery to the Black Magic Probe V2.1 via the SWD interface, namely: </p><br><ol><li>  3V3 - tVref </li><li>  PA13 - SWDIO </li><li>  PA14 - SWCLK </li><li>  GND - GND </li></ol><br><p>  Sources for firmware boards can be found <a href="https://gitlab.com/sakura.ix86/stmf100rbt6_blink">here</a> . </p><br><p>  Here everything is similar to the previous board, we also change the time intervals in the source and look at the light bulb. </p><br><p>  <strong>findings</strong> </p><br><p>  The Black Magic Probe Mini V2.1 board is easy to use and has a set of tools and open source libraries, this is its main advantage. <br>  The downside is the lack of support for the architecture of the arm64 processors and Texas Instruments processors. </p><br><p><a href="http://1bitsy.org/overview/introduction/"></a>  <a href="http://1bitsy.org/overview/introduction/">http://1bitsy.org/overview/introduction/</a> <br><a href="https://1bitsquared.com/products/black-magic-probe"></a>  <a href="https://1bitsquared.com/products/black-magic-probe">https://1bitsquared.com/products/black-magic-probe</a> <br><a href="https://github.com/esden/1bitsy-bmpm-exercises/blob/master/embedded_programming_with_black_magic_and_lights_on-workshop_guide.pdf"></a>  <a href="https://github.com/esden/1bitsy-bmpm-exercises/blob/master/embedded_programming_with_black_magic_and_lights_on-workshop_guide.pdf">https://github.com/esden/1bitsy-bmpm-exercises/blob/master/embedded_programming_with_black_magic_and_lights_on-workshop_guide.pdf</a> <br><a href="https://github.com/blacksphere/blackmagic/wiki"></a>  <a href="https://github.com/blacksphere/blackmagic/wiki">https://github.com/blacksphere/blackmagic/wiki</a> </p><br><p>  <strong>The authors</strong> </p><br><ul><li>  Yevgeny Rasskazov <a href="https://habrahabr.ru/users/jokiv/" class="user_link">Jokiv</a> </li><li>  Valeria Gubareva <a href="https://habrahabr.ru/users/veneramuholovka/" class="user_link">veneramuholovka</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/339940/">https://habr.com/ru/post/339940/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../339928/index.html">How to maintain a Telegram channel with 20,000 subscribers? Interview with the creator of All-in-One Person</a></li>
<li><a href="../339930/index.html">Development for Sailfish OS: displaying graphs using D3.js and QML Canvas</a></li>
<li><a href="../339932/index.html">Development for Sailfish OS: working with maps and geolocation</a></li>
<li><a href="../339936/index.html">We are looking for treasures in the source code Aladdin</a></li>
<li><a href="../339938/index.html">We play APK golf. Reduce the size of Android APK files by 99.9%</a></li>
<li><a href="../339942/index.html">SuperJob Meetup. System business analysis. Live broadcast</a></li>
<li><a href="../339950/index.html">Dow Jones Financial Information Agency mistakenly reported merging Apple and Google</a></li>
<li><a href="../339952/index.html">Dynamic analysis of iOS applications without Jailbreak</a></li>
<li><a href="../339954/index.html">How to teach your neural network to analyze morphology</a></li>
<li><a href="../339956/index.html">Data Science Week 2017. Review of the second and third day</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>