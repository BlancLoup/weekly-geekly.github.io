<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>High overload: electronic archive on Alfresco ECM</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We would like to share our experience in automating work related to photo-fixation of cargo in one of the largest Russian transport companies. And to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>High overload: electronic archive on Alfresco ECM</h1><div class="post__text post__text-html js-mediator-article">  We would like to share our experience in automating work related to photo-fixation of cargo in one of the largest Russian transport companies.  And to talk about what challenges had to face, and how we solved them. <br><img src="https://habrastorage.org/webt/ab/2x/jt/ab2xjta_d2e_bdhof6noh9tdeda.jpeg"><br>  The task of photo-fixation of goods at various stages of transportation is typical for a transport company.  Employees of the company take pictures of the goods, upload the image to the ERP-system, from which it enters the electronic archive (EA).  Each photo is accompanied by meta-information: the office of the sender, the recipient, the code and index of the flight, etc.  The main task of the electronic archive is the organization of a flexible, convenient and, most importantly, quick search for photos by meta-information for the last 3 years. <br><a name="habracut"></a><br><p>  As is often the case, there was a supplier who offered a boxed solution - a flexible ECM system on the Alfresco Community Edition 4.2.x platform, quickly implemented it and even passed a successful test at one branch.  And they even MS SQL Server fastened to the Community Edition.  As for the interaction protocol with ERP, in our case it is 1C, nobody really thought about it, the customer wanted the most convenient way for him to upload files to a folder on the server, so they began to use the good old FTP. </p><br><h2>  Houston, we have problems ... </h2><br><p>  The most interesting thing started later, when they launched the replication of 120 branches.  The system crashed regularly due to non-valid Lucene indexes.  When this situation occurred, it was necessary to manually rebuild the indices, which led to the unavailability of the system for a day.  And for a logistics company of the federal scale, this is a rather critical period.  During the restructuring, the files remained on the ball, and with each failure it was more and more difficult to load the ‚Äúescaping‚Äù delta.  The maximum files we could receive per day were 40‚Äì60 thousand for us.  The web interface also did not differ in high search speed: the maximum number of users with running downloads was 20 people.  You shouldn't even mention the scalability - the system could not cope with the current volumes.  There was a question about the correctness of the choice of platform.  And at this stage, our cooperation with this customer began. </p><br><p>  There was no documentation for the system, but nobody canceled the reverse engineering.  Understood the code, found errors and a lot of crutches, which make it clear that the system was simply not ready for high loads: the files were first stored on the server, then the samopisny scheduler looked through the target folder, loaded the files into memory and then processed them.  It goes without saying that the Alfresco mechanisms were also tuned.  For example, when uploading files, it was possible to postpone actions with documents on different transactions.  But, unfortunately, nobody dealt with transaction management. </p><br><p>  And here we made a fatal mistake - we began to finish the existing system. <br>  We managed to run on all 120 branches, and for several months we tuned the system in which users work.  We tried to optimize Lucene, resized a single file, run merge indexes, change Java machine parameters, etc. <br>  During this time, the volumes increased several times to 100,000 documents per day, the size of the indices increased to a critical level of 100 GB, after which even the standard rebuilding of indices, which previously helped us out, was not always successfully completed - the process hung at the merge stage.  And we understood - it is impossible to continue this life!  It was decided to completely rewrite the decision.  Who does not like to give up the old bad and someone else's decision and write his own good from the height of the experience?  But the task was complicated by the fact that it was necessary to support the work of the existing solution while we were developing a new one, and then also to make the data migration.  The task seemed realistic, and we were optimistic. </p><br><h2>  Top View: Solution Architecture </h2><br><p>  All code was rewritten to java (part of the backend code was written in Alfresco-built JavaScript).  It was also decided to change the main DBMS from MS SQL to Postgresql (in fact, this is the first thing that comes to mind when we are talking about freely distributed relational databases).  Completely redone solution architecture.  They completely abandoned the use of the Alfresco Share interface, developed a user-friendly, customized web interface that accesses the web services we developed for receiving data.  Alfresco now serves as a REST API.  Added replication of the main database using Postgresql built-in tools, which allowed building reports from replication without loading the main database.  Search and download data posted on 2 servers.  Two copies of Alfresco were deployed instead of one: one is responsible for finding and displaying data, the other for downloading. </p><br><p>  Both copies of Alfresco use the same base.  Due to the separation of loading and viewing, lengthy operations at loading do not affect the viewing of data, and viewing and loading can work independently of each other.  Ultimately this added system performance.  The capacity of the system has grown and allowed uploading up to 200k photos per day, while the number of simultaneous users increased to 70-80. </p><br><br><img src="https://habrastorage.org/webt/em/ih/9o/emih9oyypey82am-xujoemo5bxo.png"><br><p>  Figure 1. Solution architecture </p><br><br><h2>  Accelerate the download </h2><br>  In order to optimize system performance we: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Redesigned file upload mechanism via FTP; </li><li>  Parallelized processing of XML files; </li><li>  Used a new search engine built into Alfresco 5. </li></ul><br><h3>  FTP </h3><br><p>  The mechanism for uploading files via FTP has been revised.  A virtual FTP server was implemented via Apache FTPServer.  Since we have the usual maven project, we can connect any libraries.  Now files are not stored on the server, but are processed immediately upon receipt, depending on the destination folder, the document type is determined.  This greatly improved performance. </p><br><p>  At once I will say that CMIS was not used, because interaction with the system via FTP was important for the customer. </p><br><h3>  XML processing </h3><br><p>  Also parallelized the processing of small blocks of xml files, manually determined the beginning and end of the transaction, by default, all actions with nodes (as all objects in Alfresco are called) are performed in one transaction. </p><br><h3>  New search engine </h3><br><p>  The transition to Alfresco 5 has provided a more reliable search engine.  In our data structure, consistent requests are needed, that is, when loading, you may need objects that were loaded a second ago.  SOLR does not support such queries, since it needs time to rebuild its indices.  Alfresco 4 previously supported these requests via Lucene, but as described earlier, it has its own problems.  In Alfresco 5, such queries are executed directly into the database (the query is transformed into a HQL query, which in turn is transformed into SQL, depending on the dialect specified).  This innovation significantly increased the download speed and fault tolerance of the system. </p><br><h2>  Robot injects: barcode recognition </h2><br><p>  A task has been received to implement a bar code recognition system.  Since the photos are processed and saved immediately, the task was solved by simply installing the Zbar library on the download server.  A pool of running Zbar processes was implemented, the size of the pool is equal to the number of cores on the server (the number of threads is regulated separately).  When uploading a photo, the photo is first ‚Äúrun‚Äù through Zbar, we receive a recognized barcode (as a string) in response to it, and if a document is loaded in the system, in the metadata of which this barcode is present, such a document is linked to a photo which further allows you to see the photo on the web interface when searching for a document. </p><br><h2>  We control the flight: devices </h2><br><p>  After transferring to Alfresco 5, as well as rewriting the source code, it became possible to properly maintain and develop the system, adding new functionality.  First of all, after optimizing the load, it was necessary to resolve the issue of monitoring systems.  Hip size, disk activity and other standard indicators were put on monitoring via Zabbix using JMX.  There was a question with monitoring application metrics: download speed, Alfresco REST API response speed, number of active users, etc.  To solve this problem was written JMX bean, collecting the number of users and having active tickets. </p><br><p><img src="https://habrastorage.org/webt/2k/qz/s0/2kqzs0z-z6hiw4b3qz64kbtu_rw.png"></p><br><p>  To monitor the download and the response of the web interface, 2 web services were written that are called by zabbix: </p><br><h4>  Returns the number (uploaded files or the number of calls to the REST API) </h4><br><p><img src="https://habrastorage.org/webt/vf/wp/wl/vfwpwlqtrbgh7co_u3be3w50po8.png"></p><br><p>  Figure 2. Number of downloads </p><br><p><img src="https://habrastorage.org/webt/ri/33/mt/ri33mtksprx5mpt__fqzze_yy-8.png"></p><br><p>  Figure 3. The number of requests in the REST API </p><br><h4>  Returns the average time (in milliseconds) </h4><br><p><img src="https://habrastorage.org/webt/mn/ke/jy/mnkejyi0j0udox7gekdts02iq2e.png"></p><br><p>  Figure 4. Response time REST API </p><br><p><img src="https://habrastorage.org/webt/mn/ke/jy/mnkejyi0j0udox7gekdts02iq2e.png"></p><br><p>  Figure 5. File upload time </p><br><p>  The type of the requested object is passed as the get parameter. </p><br><h2>  Space odyssey continues </h2><br><p>  The system‚Äôs own optimizations and improvements and the transition to Alfresco 5 made it possible to increase the loading capacity of up to 400,000 photos per day, taking into account that 300,000 of them pass through the recognition system.  Also, the average number of active users has so far increased to 120. This is all on condition that the size of the database is about 700GB and the total size of the content is 19TB.  We have over 90,000,000 documents in our system! </p><br><p>  Alfresco Community Edition can be used as a platform for Electronic Archive.  Large, large-scale space expeditions on her shoulder.  But it is important to note that the success of the expedition depends on the quality of the preparatory work prior to the launch and the coordinated work of the crew during the escort. </p><br><p>  And our flight continues, but at other speeds! </p><br><p> In the future, we plan to further optimize the web interface: make the so-called lazy loading of objects, which will speed up the search operations, and optimize screen forms from the point of view of user experience.  (User Experience) We also plan to implement document life cycle management, in particular, to make archiving of documents on slow media. </p></div><p>Source: <a href="https://habr.com/ru/post/358208/">https://habr.com/ru/post/358208/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358192/index.html">Marvin Minsky "The Emotion Machine": Chapter 3 "Suffering, pain, grief"</a></li>
<li><a href="../358198/index.html">Notification Center. Tame 200+ mailings</a></li>
<li><a href="../358200/index.html">Brief analysis of solutions in the field of SOC and the development of a neural network detector of anomalies in data networks</a></li>
<li><a href="../358202/index.html">Lapplanders and HTTP</a></li>
<li><a href="../358204/index.html">Managing release is simple: release management rules and steps</a></li>
<li><a href="../358210/index.html">Vinyl Data Storage</a></li>
<li><a href="../358212/index.html">Check Point Smart Event. Mini guide</a></li>
<li><a href="../358214/index.html">Honeypot- logger on nodejs and tcpdump</a></li>
<li><a href="../358216/index.html">Polymer 3.0 on Google I / O 2018</a></li>
<li><a href="../358218/index.html">How to collect feedback from users? Epic growth story with Ivan Zameshin</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>