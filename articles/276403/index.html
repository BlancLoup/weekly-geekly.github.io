<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Moira: Realtime Alerting</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The contour makes several dozen products, each of which consists of several dozen microservices, each of which is running on dozens of servers. 

 Thi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Moira: Realtime Alerting</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/ea5/9ea/c5f/ea59eac5fd5545569d50995571442cdf.jpg" align="left" width="45%" height="45%"><br>  The contour makes several dozen products, each of which consists of several dozen microservices, each of which is running on dozens of servers. <br><br>  This infrastructure generates metrics at all technological levels - load on hardware, OS state, application metrics.  Baseline data is collected in one large <a href="https://github.com/graphite-project/">Graphite</a> cluster.  Now we have a million unique metrics for which 20 thousand values ‚Äã‚Äãper second are generated in total. <br><br>  It is clear that for a million metrics not to keep track of eyes on TVs and dashboards - you need a system for sending notifications about abnormal situations.  Before writing our own Moira system, we used <a href="https://github.com/scobal/seyren">Seyren</a> for this task. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Pros and cons of Seyren </h2><br>  Seyren allows you to specify an arbitrary expression in the Graphite function language via the web interface and subscribe to notifications.  Notifications come in the event that the result of evaluating the expression exceeds a fixed threshold. <br><br>  It seems that this is what you need.  But for the year of operation of the Seyren, we stepped on a few rakes: <br><br><ol><li>  Inside the Outline there are several commands that make different products.  In Seyren there is no concept "user" or "group" - everyone sees the settings and events of all the others in one huge list. <br></li><li>  Seyren relies on the Graphite API to calculate the value of a metric and does not itself validate the entered expressions.  Errors while falling somewhere inside the logs, and in the web interface, everything looks working.  If you draw a graph in the Graphite web interface, there is no guarantee that the same expression will work in Seyren.  And if it does, its calculation may give an unexpected result. </li><li>  Not all graphite queries work efficiently.  With a large number of metrics, the expression can be calculated for several seconds.  It does not matter if this happens once at the user's request.  But Seyren requests each saved expression through the Graphite API once per minute.  If there are several such expressions in Seyren, they are guaranteed to kill a cluster of any size.  I do not want to teach all users of monitoring the art of compiling optimal queries in Graphite. </li><li>  Seyren misses events.  We saw points on the graph that went beyond the threshold value, but Seyren was inexplicably silent at the same time.  We were unable to consistently reproduce and, moreover, fix this bug. </li></ol><br><br><h2>  Seyren Alternatives </h2><br>  Why did we even choose Seyren?  There must be other options. <br><br>  Seyren is the best thing that was in the Monitoring section on the <a href="http://graphite.readthedocs.org/en/latest/tools.html">Tools That Work With Graphite</a> page from the official Graphite documentation.  We tried everything and chose Seyren.  Perhaps something else will suit you from this page (now Moira is there too). <br><br>  Still have a <a href="http://riemann.io/">riemann</a> .  Most likely, this is the most flexible and productive monitoring system in the world.  It supports incoming data in Graphite format.  Settings riemann is a code that is stored in the repository.  In short, this is a real DevOps. <br><br>  Unfortunately, riemann has a very high entry threshold.  For Seyren, this threshold is zero - if you use Graphite, copying an expression to Seyren does not require any additional knowledge.  The riemann configuration is a Clojure code.  The <a href="http://riemann.io/clojure.html">Just enough Clojure to work with Riemann</a> page is a couple of hours of thoughtful reading, even if you are familiar with the concept of functional programming.  We want any developer to be able to set up notifications about problems in his area of ‚Äã‚Äãresponsibility without learning a new programming language. <br><br>  And since we started to discuss what we want or do not want, let's understand what we have requirements for the notification system. <br><br><h2>  Requirements for sending notifications </h2><br><ol><li>  Should not load the Graphite cluster with frequent automated queries.  Well, if it does not depend on the main cluster Graphite. </li><li>  Must support all Graphite functions and calculate them the same way they are calculated when plotting graphs. </li><li>  Must be able to distinguish between users and allow them to customize what they see in the web interface. </li><li>  Must be able to send notifications through popular channels - email, Slack, Pushover, Telegram.  At the same time adding new plugins should not be too complicated. </li></ol><br><br><h2>  Moira: how we built such a system </h2><br>  Moira consists of modules, like Graphite itself.  Now it is called microservice architecture.  This allows at any time to replace a part of the system with a more productive or more functional one, without throwing out the entire system.  All parts of Moira are independent of each other and communicate only through a single data store Redis. <br><br><h3>  moira-cache </h3><br>  We want to leave Graphite alone - therefore, we want to receive a copy of the flow of incoming metrics.  But there are a lot of incoming metrics. <br><br>  To solve this problem, you need to consider two things: <br><ol><li>  For alerts, only fresh information is needed - history can be viewed in Graphite if necessary. </li><li>  Among the entire flow of incoming metrics, only those for which at least one alert rule is configured are needed. </li></ol><br>  Moira-cache is a fast Go service that accepts incoming metrics, filters the necessary ones and saves the cache of values ‚Äã‚Äãof these metrics to Redis for the last hour. <br><br><h3>  moira-worker </h3><br>  We want to support all the Graphite functions, and that they are calculated exactly as in Graphite itself.  Since Graphite is uploaded to opensource, the surest way to achieve results is to take the Graphite sources and include them directly in our application. <br><br>  Moira-worker is a Python service that checks values ‚Äã‚Äãin the cache using the original Graphite function code and generates alert events. <br><br>  In addition, we have added to moira-worker the ability to use not only Graphite functions, but also more versatile Python expressions for notifications. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0b5/b2a/f6c/0b5b2af6c97c8d58b3844b9a3455f615.png" alt="notification edit page" width="80%" height="80%"></div><br>  <i>notification edit page</i> <br><br><h3>  moira-web </h3><br>  We want to be able to distinguish between users and show everyone just what he wants to see.  These are two tasks. <br><br>  How to distinguish between users?  The monitoring system is a tool for the intranet, and here it is impossible to come up with one authentication solution that would suit everyone.  Someone needs LDAP, someone needs a login through GitHub or Google.  We did not invent anything: Moira simply trusts the X-Webauth-User header received from the upstream web server (for example, nginx or oauth_proxy).  In order for Moira to learn to distinguish your users, you need to pass a user ID (for example, a login) in the value of this header. <br><br>  How to show the user only those settings that he wants to see?  To do this, we use tags that work both in the web interface and in setting up notifications. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/baa/1cd/51c/baa1cd51c0c85e634b2905e09c464524.png" alt="list of configured notifications on the main screen" width="80%" height="80%"></div><br>  <i>list of configured notifications on the main screen</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c0d/ade/61c/c0dade61c0773cc66221508c837b3d3e.png" alt="Subscription Edit Page" width="80%" height="80%"></div><br>  <i>Subscription Edit Page</i> <br><br><h3>  moira-notifier </h3><br>  We want to be able to send notifications through popular channels - Slack, Telegram, Mail, Pushover.  In addition, moira-notifier: <br><br><ol><li>  Able to comply with a given schedule (for example, does not bother at night for trifles). </li><li>  It protects the user from being overwhelmed by emails if one of the triggers is "enraged" and starts sending notifications too often. </li><li>  Resends the notification if a delivery error has occurred. </li></ol><br><br><h2>  How to try Moira?  How to ask a question to developers? </h2><br>  We have been using Moira in production environment for half a year now.  On one eight-core virtual machine, we process the incoming stream of 20 thousand points per second with thousands of monitored metrics and hundreds of users. <br><br>  At the end of 2015, we decided that Moira is already stable enough to offer the opensource community to try using it. <br><br>  Instructions for installation and use are in <a href="http://moira.readthedocs.org/">our documentation</a> .  In addition, you can <a href="https://github.com/moira-alert">see the code on GitHub</a> , send bugreport or pullrequest. <br><br>  If your workload is higher, or your resources are more limited, come and chat in our <a href="https://gitter.im/moira-alert/moira">Gitter chat</a> .  We will tell you how to scale Moira for your case, or together we will try to optimize its code. <br><br>  And, of course, we will be happy to answer your questions in the comments. </div><p>Source: <a href="https://habr.com/ru/post/276403/">https://habr.com/ru/post/276403/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../276393/index.html">Smart babysitter based on Intel Edison and Ubidots</a></li>
<li><a href="../276395/index.html">Cache it: increase the stability of the ONLYOFFICE server with Redis</a></li>
<li><a href="../276397/index.html">What is the future of email: Opinions of the creator of Wikipedia, engineers and entrepreneurs from Silicon Valley</a></li>
<li><a href="../276399/index.html">What experts in Data Science and Big Data are discussing today</a></li>
<li><a href="../276401/index.html">The book "Hello World! Entertaining programming ¬ª</a></li>
<li><a href="../276407/index.html">Parse Server Migration Guide for Developers</a></li>
<li><a href="../276409/index.html">1C-Bitrix on Raspberry Pi 2</a></li>
<li><a href="../276411/index.html">Recognize emotions in a UWP application using the Project Oxford API</a></li>
<li><a href="../276413/index.html">Installing SuiteCRM 7.5. Integration with Asterisk via Callinize - community Edition</a></li>
<li><a href="../276415/index.html">Google has released an update for Android</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>