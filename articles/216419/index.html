<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing Your Orm for Android with Canas and Senorites, Part 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 After a break in the development of my Android application , during which more and more new ideas were formed in my head, how to make i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing Your Orm for Android with Canas and Senorites, Part 3</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  After a break in the development of my <b>Android application</b> , during which more and more new ideas were formed in my head, how to make it more beautiful and comfortable, at the end of January I sat down again for development.  During my thinking, the approach to creating an application was slightly transformed, and therefore I only got to the object model three weeks ago.  And almost immediately faced with the need for refinement <a href="https://github.com/UCASoft/UcaOrm">UCAOrm</a> .  Who is interested in learning not only about the innovations already implemented, but also about the fact that only during the development process - <a name="habracut"></a><br><br><h4>  Changes and additions </h4><br>  The first thing I encountered was the need for <b>ContentProvider</b> and <b>Cursor</b> . <br>  There are <b>no</b> particular problems with <b>ContentProvider</b> - the abstract <b>OrmContentProvider is</b> inherited from <b>ContentProvider</b> and it still implements two methods: <b>query</b> , which accepts <b>OrmWhere</b> and returns <b>OrmCursor</b> , and <b>update</b> , which accepts the instance being updated.  <b>OrmCursor</b> is inherited from <b>AbstractCursor</b> and, besides the implementation of all the necessary methods, it also implements the <b>getEntities</b> method, <b>which</b> returns a <b>List of</b> objects.  The most interesting, from the point of view of implementation, are the <b>getColumnNames</b> function, which returns an array of column names ( <b>has</b> already remade the <b>getOrmFields</b> function), and the private function <b>getObject</b> , which returns the value of the specified column.  These classes have greatly simplified the development of account synchronization. <br>  The second innovation was the support of new field types: <b>boolean</b> and <b>int array</b> .  If everything is more or less clear with <b>boolean</b> , I‚Äôll tell you about the <b>array in</b> more detail.  First, the idea was to create an additional table with the name ‚Äú <i>class name_ field name</i> ‚Äù and one single column of the type of the array component.  However, after speculating, I came to the conclusion that an array with a class inherited from <b>OrmEntity</b> destroys the entire architecture, and any other non-primitive type the developer still has to be serialized manually.  From this, I decided that <b>orm</b> will only support arrays of primitive types that are perfectly serialized into a string and also perfectly deserialized back.  Problems, perhaps, can arise with <b>double</b> , the format of which in the form of a string can contain a comma, which is the separator of the elements of the array, but they are easily solved by hard setting the locale in <b>English</b> . <br>  Also, I finally got to the implementation of the <b>getDefaultValues</b> method in <b>OrmHelper</b> 's successor.  Now it looks like this: <br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDefaultValues</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Class&lt;? extends OrmEntity&gt; entityClass, List&lt;OrmEntity&gt; valueList)</span></span></span><span class="hljs-function"> </span></span>{ }</code> </pre> <br>  accordingly, adding default values ‚Äã‚Äãfor our favorite model from the <a href="http://habrahabr.ru/post/187526/">second</a> part will be implemented like this: <br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDefaultValues</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Class&lt;? extends OrmEntity&gt; entityClass, List&lt;OrmEntity&gt; valueList)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entityClass.equals(CarType.class)) { valueList.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CarType(<span class="hljs-string"><span class="hljs-string">"Passenger"</span></span>)); valueList.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CarType(<span class="hljs-string"><span class="hljs-string">"Truck"</span></span>)); } }</code> </pre><br>  Well, now we have <a href="http://habrahabr.ru/users/hardex/" class="user_link">gotten</a> close to the most delicious problem that <a href="http://habrahabr.ru/users/hardex/" class="user_link">hardex</a> spoke <a href="http://habrahabr.ru/users/hardex/" class="user_link">about</a> in the <a href="http://habrahabr.ru/post/186078/">first</a> article - updating the data schema. <br><br><h4>  Updating data schema </h4><br>  Again, back to our model and consider the essence of <b>Car</b> : <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(rightJoinTo = {Truck.class}) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Car</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseEntity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"car_type"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> CarType type; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Wheel&gt; wheels; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"engine_power"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> enginePower; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"doors_count"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> doorsCount; }</code> </pre><br>  Suppose we decide to add another field: <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"max_speed"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> maxSpeed;</code> </pre><br>  In this case, we need to change the version of the database in the manifest: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta-data</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UO_DB_VERSION"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br>  And write the code in the <b>onUpdate helper</b> method: <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUpgrade</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> oldVersion, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> newVersion)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newVersion == <span class="hljs-number"><span class="hljs-number">2</span></span>) { OrmUtils.UpdateTable(Car.class).work(); } }</code> </pre><br>  ‚Äú <i>Why else do we need a <b>work</b> method?</i>  ‚Äù- someone will ask.  And let's consider possible options for changing the data schema: <br><ol><li>  A new field is added to the schema. </li><li>  The field is removed from the schema. </li><li>  The field is renamed. </li><li>  The field changes type. </li></ol><br>  Most likely, many have already guessed that the only item that does not cause difficulties is the first one, but we will consider them in order. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Field additions </h5><br>  Everything is easy here: <b>orm</b> scoops the fields from the table and compares it with the fields from the class.  When a new field is found in the object model, it jerks for it <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> ‚Ä¶</code> </pre>  If you need a default value, you will need to specify it in the annotation. <br><br><h5>  Deleting a field </h5><br>  The beginning of the algorithm is similar to the previous one: we compare the fields and find those that need to be deleted.  Well, then, almost, as indicated in <a href="http://www.sqlite.org/faq.html">faq'e</a> .  The only thing I don‚Äôt understand is why the second copy is needed, because after the <b>drop</b> 'zeros of the table, you can just rename the temporary one and it will become permanent! <br><br><h5>  Rename field </h5><br>  And here <b>work</b> is not your assistant!  <b>Orm</b> simply will not understand that you just renamed the field and will do two things: remove the field with the old name from the base and add a new one with the new one.  Of course, it was also possible to beat this in the annotation by adding the <b>old_name</b> field, but it seemed to me that this was too much, and the <b>orm</b> could be unloaded, <b>telling</b> him exactly what to do.  In light of the foregoing in this paragraph, we need the <b>rename</b> method: <br><pre> <code class="java hljs">OrmUtils.UpdateTable(Car.class).renameColumn(<span class="hljs-string"><span class="hljs-string">"old_column_name"</span></span>, <span class="hljs-string"><span class="hljs-string">"new_column_name"</span></span>);</code> </pre><br>  Note that you need to specify the name of the column, not the field!  As a result, <b>orm</b> will not wool the entire class and all fields in the database in order to understand what it needs to change, but simply make changes to the name of one single column. <br>  Also, we can help him add a column: <br><pre> <code class="java hljs">OrmUtils.UpdateTable(Car.class).addColumn(<span class="hljs-string"><span class="hljs-string">"column_name"</span></span>);</code> </pre><br>  and delete the column: <br><pre> <code class="java hljs">OrmUtils.UpdateTable(Car.class).deleteColumn(‚Äúcolumn_name‚Äù);</code> </pre><br>  The very same renaming in the form of a <b>sql</b> query caused some questions.  At first, I decided this, as well as the deletion, by creating a new table with the desired field name, where the data is copied from the old one, and it is simply deleted, and the new one is renamed.  But then, I stumbled upon <a href="http://www.gfairchild.com/2012/08/03/how-to-rename-columns-in-an-sqlite-database/">this</a> article and plan to try this method. <br><br><h5>  Change field type </h5><br>  <b>Orm,</b> again, can do everything for you, but you can help him: <br><pre> <code class="java hljs">OrmUtils.UpdateTable(Car.class).changeColumnType(<span class="hljs-string"><span class="hljs-string">"column_name"</span></span>);</code> </pre><br>  In principle, the second parameter could also be passed on a new column type, but I did not want to give the programmer the opportunity to specify the wrong type, and then scold <b>orm</b> (:-)).  The problem of incompatibility of data of the old type and the new one is solved by the base itself, throwing an exception when copying the old table into a new one.  But the column can be simply zeroed by passing <b>true</b> as the second parameter: <br><pre> <code class="java hljs">OrmUtils.UpdateTable(Car.class).changeColumnType(‚Äúcolumn_name‚Äù, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>);</code> </pre><br>  There was also a parameter in the design that indicates that the field should be reset only in case of incompatibility of types, but so far did not become. <br><br><h4>  Conclusion </h4><br>  <a href="https://github.com/UCASoft/UcaOrm">UCAOrm</a> has undergone such changes over the past two weeks.  Not everything has been laid out in <a href="https://github.com/">github</a> , since, as I wrote a little higher, the work on <b>Updater is</b> still underway, and not everything has been tested yet.  There is also an idea to slightly simplify the initial creation of the tables: simply by calling <b>OrmUtils‚Äôs createByPackeg</b> method, passing the package name there, in which <b>orm</b> will look for marked classes.  But this is only an idea. <br>  As always I will be glad to any new ideas and suggestions.  Wait for updates soon. <br></div><p>Source: <a href="https://habr.com/ru/post/216419/">https://habr.com/ru/post/216419/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../216407/index.html">Hi, Baynet! The adventures of the Runet assault in the partisan country</a></li>
<li><a href="../216409/index.html">The logic of thinking. Part 14. Hippocampus</a></li>
<li><a href="../216411/index.html">JTAG Peripheral Scanning: Testing Electronics Prototypes</a></li>
<li><a href="../216413/index.html">Calling x86 procedures from EFI Byte Code</a></li>
<li><a href="../216417/index.html">Microsoft Onenote - now free</a></li>
<li><a href="../216421/index.html">How to create and earn SaaS (Part I / remove all unnecessary, hit the target, experiment)</a></li>
<li><a href="../216427/index.html">Unreal Engine 4 is now available for everyone.</a></li>
<li><a href="../216429/index.html">Epic released Unreal Engine 4 with $ 19 subscription sources</a></li>
<li><a href="../216431/index.html">New to Java 8</a></li>
<li><a href="../216433/index.html">Appmethod Review [Many pictures]</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>