<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DI in complex applications. How not to drown in addictions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. 

 When designing applications, it is good use of Dependency Injection (dependency injection). This approach allows you to make the code loosel...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DI in complex applications. How not to drown in addictions</h1><div class="post__text post__text-html js-mediator-article">  Hello. <br><br>  When designing applications, it is good use of Dependency Injection (dependency injection).  This approach allows you to make the code loosely coupled, and this in turn provides ease of maintenance.  It also makes testing easier and the code becomes beautiful, versatile and replaceable.  From the very beginning this principle was used in the development of our products: in both high-load DSP and corporate <a href="http://hybrid.ru/">Hybrid</a> .  We wrote modules, connected integration with various systems, the number of dependencies grew and at some point it became difficult to maintain the application configuration itself.  In addition, implicit registrations were added (for example, the custom DependencyResolver for Web Api was set up in the Web Api settings) and difficulties began to arise with the <b><i>order of</i></b> calling configuration modules.  In the end, we developed an approach for registering, configuring and initializing modules in a complex application.  About him and tell. <br><br><img src="https://habrastorage.org/files/067/ecd/a1c/067ecda1c3824cd7886d796a91c8b93b.png" alt="image"><br><a name="habracut"></a><br>  First we need to clarify that for servicing various tasks (even within the same product) we have several types of applications: services, console applications, asp.net.  Accordingly, the initialization system represented its zoo everywhere, only in that there was a DependencyConfig class with a damn cloud of taste and color dependencies.  Each application also had its own advanced settings.  For example, setting up routing, converters, authorization filters in asp.net mvc, which should have been called after dependency registration and validation of this registration.  Accordingly, the problem arose: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  unify configuration for different types of applications </li><li>  remove the need to set the initialization sequence </li><li>  break the registration of modules into light, isolated from each other primitives. </li></ul><br>  As a result, we have identified 3 types of elementary configurations: dependencies (dependency), initialization (init), and settings (settings, which are actually the union of the two previous ones). <br><br><h2>  Dependencies (IDependency) </h2><br>  Dependency is a primitive for registering, ha ha, dependencies of a single module.  In general, implements the IDependency interface: <br><br><pre><code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDependency</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TContainer</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Register(TContainer <span class="hljs-keyword"><span class="hljs-keyword">container</span></span>); }</code> </pre> <br>  where TContainer is an IoC container (SimpleInjector is used here and below as an example of a container).  Accordingly, the Register method registers the services of a single logic module.  Other IDependency primitives can also be registered by directly calling the constructor and the Register method.  Example: <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TradingDeskDependency</span></span></span><span class="hljs-class"> :</span></span> IDependency&lt;Container&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Register</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Container container)</span></span></span><span class="hljs-function"> </span></span>{ container.Register(() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SwiffyClient(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SwiffyOptions{ MillisecondsTimeout = <span class="hljs-number"><span class="hljs-number">20000</span></span> })); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DspIntegrationDependency().Register(container); } }</code> </pre><br><h2>  Initialization (IInit) </h2><br>  Initializations include the code that should be executed after registration and dependency checking, but before the main application logic starts.  This can be asp.net mvc and web api setup or something similar.  In general, the initialization class implements the IInit interface: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IInit</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IDependencyResolver resolver</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br>  Where IDependencyResolver is needed if you need to get some service from the dependencies, or to get the methods of getting dependencies themselves, as in the example: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AspNetMvcInit</span></span>: <span class="hljs-title"><span class="hljs-title">IInit</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IDependencyResolver resolver</span></span></span><span class="hljs-function">)</span></span> { System.Web.Mvc.DependencyResolver.SetResolver(resolver.GetService, resolver.GetServices); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RouteInit().Init(resolver); } }</code> </pre><br>  As well as for dependencies, you can use nested initialization primitives. <br><br><h2>  Settings (ISettings) </h2><br>  Settings are needed if both the registration of dependencies and the initialization call after are necessary in the logic module.  They are described the easiest: <br><br><pre> <code class="hljs kotlin"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ISettings</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TContainer</span></span></span><span class="hljs-class">&gt; : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IDependency</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TContainer</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IInit { }</span></span></span></span></code> </pre><br>  Accordingly, the settings represent the complete functionality for configuring the logic module: both dependency registration and additional settings. <br><br><h2>  General construction </h2><br>  So, we have primitives into which the configuration can be broken, it remains to configure them.  For this we will be helped by the Application class, which implements the IApplication interface: <br><br><pre> <code class="hljs xml">public interface IApplication<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TContainer</span></span></span><span class="hljs-tag">&gt;</span></span> { IApplication<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TContainer</span></span></span><span class="hljs-tag">&gt;</span></span> SetDependency<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">T</span></span></span><span class="hljs-tag">&gt;</span></span>(T dependency) where T : IDependency<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TContainer</span></span></span><span class="hljs-tag">&gt;</span></span>; IApplication<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TContainer</span></span></span><span class="hljs-tag">&gt;</span></span> RemoveDependency<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">T</span></span></span><span class="hljs-tag">&gt;</span></span>() where T : IDependency<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TContainer</span></span></span><span class="hljs-tag">&gt;</span></span>; IApplication<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TContainer</span></span></span><span class="hljs-tag">&gt;</span></span> SetInit<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">T</span></span></span><span class="hljs-tag">&gt;</span></span>(T init) where T : IInit; IApplication<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TContainer</span></span></span><span class="hljs-tag">&gt;</span></span> RemoveInit<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">T</span></span></span><span class="hljs-tag">&gt;</span></span>() where T : IInit; IApplication<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TContainer</span></span></span><span class="hljs-tag">&gt;</span></span> SetSettings<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">T</span></span></span><span class="hljs-tag">&gt;</span></span>(T settings) where T : ISettings<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TContainer</span></span></span><span class="hljs-tag">&gt;</span></span>; IApplication<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TContainer</span></span></span><span class="hljs-tag">&gt;</span></span> RemoveSettings<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">T</span></span></span><span class="hljs-tag">&gt;</span></span>() where T : ISettings<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TContainer</span></span></span><span class="hljs-tag">&gt;</span></span>; IAppConfig Build(); }</code> </pre><br>  As you can see from the code, IApplication allows you to add all types of settings (as well as delete them).  And the Build method calls the code that collects all these settings: first, dependencies are registered (+ if necessary, a check if everything is possible to register), then a code from IInit modules (and Init methods in ISettings).  At the output, we get an IAppConfig object: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IAppConfig</span></span> { IDependencyResolver DependencyResolver { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } IAppLogger Logger { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } }</code> </pre><br>  where DependencyResolver allows you to get services, and Logger you know why.  The final code for setting up the application will be simple and transparent (although in the general case with some complications for universality): <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> container = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Container() <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> appOptions = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AppOptions { DependencyContainer = container, GetServiceFunc = container.GetInstance, GetAllServicesFunc = container.GetAllInstances, VerifyAction = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">c</span></span></span><span class="hljs-function"> =&gt;</span></span> c.Verify(), Logger = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CustomLogger() }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> appConfig = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Application(appOptions).SetDependency(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TradingDeskDependency()) .SetInit(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AspNetMvcInit()) .Build();</code> </pre><br>  The only class that will have to be defined explicitly is CustomLogger.  If we want to keep track of situations when the registration of dependencies and initializations fails, then it should be set.  Logger is described by the simplest interface: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IAppLogger</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Error</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Exception e</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br>  and write the implementation is not difficult. <br><br>  As a result, this approach can be used for any type of application, we do not need to think about the configuration order, and in dependency management, we moved to the level of logic modules.  Thus, you can screw up a bunch of settings, dependencies, initializations, while maintaining the sobriety of thought and fortitude. <br><br>  I wrote a slightly simplified (but quite working and easily expandable) version of the library (Jdart.CoreApp), which can be studied or simply used: <br>  1) <a href="https://github.com/alvaro-jdart/CoreApp">GitHub</a> <br>  2) <a href="https://www.nuget.org/packages/Jdart.CoreApp/">Nuget</a> . <br><br>  Adapters for <br>  1) <a href="https://www.nuget.org/packages/Jdart.CoreApp.SimpleInjector/">SimpleInjector</a> <br>  2) <a href="https://www.nuget.org/packages/Jdart.CoreApp.Autofac/">Autofac</a> <br>  3) <a href="https://www.nuget.org/packages/Jdart.CoreApp.Ninject/">Ninject</a> <br>  4) <a href="https://www.nuget.org/packages/Jdart.CoreApp.Unity/">Unity</a> <br><br>  Thanks to all. </div><p>Source: <a href="https://habr.com/ru/post/266975/">https://habr.com/ru/post/266975/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266963/index.html">Attackers use whatsapp service for phishing campaign</a></li>
<li><a href="../266967/index.html">Virtual reality around us. We invite to the MixAR conference</a></li>
<li><a href="../266969/index.html">What is beautiful code, and how to write it?</a></li>
<li><a href="../266971/index.html">Log processing with monit.d</a></li>
<li><a href="../266973/index.html">How much does it cost to make a mobile game?</a></li>
<li><a href="../266977/index.html">How to unlock Android without knowing the password</a></li>
<li><a href="../266981/index.html">Outbound mail routing using Cisco ESA</a></li>
<li><a href="../266985/index.html">How to make friends C ++ and QML</a></li>
<li><a href="../266987/index.html">ABBYY helps to digitize rare editions of the Sakhalin Library</a></li>
<li><a href="../266991/index.html">Restricting Access to Web Applications in Synology DSM</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>