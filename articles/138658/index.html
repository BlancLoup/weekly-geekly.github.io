<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Performance shared_ptr and C ++ 11: why I don‚Äôt believe libraries</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 I once optimized a critical section of code, and there was boost :: shared_ptr ... And I understood: I don‚Äôt believe the libraries, even tho...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Performance shared_ptr and C ++ 11: why I don‚Äôt believe libraries</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br><br>  I once optimized a critical section of code, and there was boost :: shared_ptr ... And I understood: I don‚Äôt believe the libraries, even though they are clever guys. <br><br>  Details under the cut. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, I optimized the code, and there was such a site: <br><blockquote>  <font color="#0000ff">auto</font> pRes <font color="#000080">=</font> boost <font color="#008080">::</font> <font color="#007788">static_pointer_cast</font> <font color="#000080">&lt;</font> TBase <font color="#000080">&gt;</font> <font color="#008000">(</font> boost <font color="#008080">::</font> <font color="#007788">allocate_shared</font> <font color="#000080">&lt;</font> TDerived <font color="#000080">&gt;</font> <font color="#008000">(</font> TAllocator <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#666666">// ... Doing something with pRes</font> <br>  <font color="#0000ff">return</font> std <font color="#008080">::</font> <font color="#007788">move</font> <font color="#008000">(</font> pRes <font color="#008000">)</font> </blockquote><br>  The optimization came to an end, so the release was compiled, and I decided to look in the disassembler, and then my favorite studio compiled it, expecting to see something beautiful and fast.  Just what I saw shocked me: <br><blockquote>  <font color="#666666">;</font>  <font color="#666666">-------------------------------------------------- -------------------------------------------</font> <br>  <font color="#666666">;</font>  <font color="#666666">Line 76: auto pRes = boost :: static_pointer_cast &lt;CBase&gt; (boost :: make_shared &lt;CDerived&gt; ());</font> <br><br>  <font color="#666666">;</font>  <font color="#666666">... nothing interesting - prepare the parameters</font> <br>  <font color="#00007f">call</font> boost <font color="#339933">::</font> make_shared &lt;CDerived&gt; <font color="#009900">(</font> <font color="#0000ff">0D211D0h</font> <font color="#009900">)</font> <br>  <font color="#666666">;</font>  <font color="#666666">... again, nothing interesting - prepare the parameters</font> <br>  <font color="#00007f">call</font> boost <font color="#339933">::</font> static_pointer_cast &lt;CBase <font color="#339933">,</font> CDerived&gt; <font color="#009900">(</font> <font color="#0000ff">0D212F0h</font> <font color="#009900">)</font> <br>  <font color="#666666">;</font>  <font color="#666666">... nothing interesting again - accepting the result of a call</font> <br><br>  <font color="#666666">;</font>  <font color="#666666">similar to the if (pRes) check, in fact it doesn't matter.</font>  <font color="#666666">It is important that je is NOT FULFILLABLE</font> <br>  <font color="#00007f">test</font> <font color="#00007f">eax</font> <font color="#339933">,</font> <font color="#00007f">eax</font> <br>  <font color="#00007f">je</font> `anonymous namespace` <font color="#339933">::</font> f <font color="#339933">+</font> <font color="#0000ff">7Ah</font> <font color="#009900">(</font> <font color="#0000ff">0D210CAh</font> <font color="#009900">)</font> <font color="#666666">;</font>  <font color="#666666">-&gt; do not jump anywhere, we have pRes! = 0</font> <br>  <font color="#666666">;</font>  <font color="#666666">... nothing interesting</font> <br><br>  <font color="#666666">;</font>  <font color="#666666">Epic fail # 1 - Interlocked Cmp Exchange</font> <br>  <font color="#666666">;</font>  <font color="#666666">This block actually deletes the temporary shared_ptr created as a result of</font> <br>  <font color="#666666">;</font>  <font color="#666666">call make_shared: the reference count is reduced here and then the conditional jump is made,</font> <br>  <font color="#666666">;</font>  <font color="#666666">the transition is performed if the reference count is not zero (which is obviously our option,</font> <br>  <font color="#666666">;</font>  <font color="#666666">because</font>  <font color="#666666">we are creating a pointer).</font> <br>  <font color="#00007f">lock</font> <font color="#00007f">xadd</font> <font color="#000000">dword</font> <font color="#000000">ptr</font> <font color="#009900">[</font> <font color="#00007f">eax</font> <font color="#009900">]</font> <font color="#339933">,</font> <font color="#00007f">ecx</font> <br>  <font color="#00007f">jne</font> `anonymous namespace` <font color="#339933">::</font> f <font color="#339933">+</font> <font color="#0000ff">7Ah</font> <font color="#009900">(</font> <font color="#0000ff">0D210CAh</font> <font color="#009900">)</font> <font color="#666666">;</font>  <font color="#666666">-&gt; jump to the next line in c ++ code</font> <br><br>  <font color="#666666">;</font>  <font color="#666666">... there is still a potential pointer removal, but this is a dead code</font> <br><br>  <font color="#666666">;</font>  <font color="#666666">-------------------------------------------------- -------------------------------------------</font> <br>  <font color="#666666">;</font>  <font color="#666666">Line 78: return std :: move (pRes);</font> <br><br>  <font color="#666666">;</font>  <font color="#666666">Assembler, I'm probably tired.</font> <br>  <font color="#666666">;</font>  <font color="#666666">In this block, Epic Fail # 2 is first called - Interlocked Increment, because</font>  <font color="#666666">we copy</font> <br>  <font color="#666666">;</font>  <font color="#666666">pRes to return the value.</font>  <font color="#666666">Then Epic Fail # 3 - Interlocked Cmp Exchange as result</font> <br>  <font color="#666666">;</font>  <font color="#666666">deleting the pRes pointer (memory release, of course, does not occur)</font> </blockquote><br>  I will add that I kept silent about 3 more interlocked instructions inside the make_shared and static_pointer_cast calls ... I looked at it and it became bad for me in front of my eyes.  This is what happens?  I here specifically move the designers to call, and they give me the reference count back and forth? <br><br>  * Lyrical digression: why it is so bad. <br>  I think everyone knows that the thing called smart pointer shared_ptr has a pointer to the number of shared pointer-s that refer to the same stored object.  When we copy shared_ptr, this very amount increases, and when we destroy it, it decreases.  During the destruction of the last shared pointer, the number of links becomes zero and with it the stored object is also deleted.  So, to make it all work fine in a multi-threaded environment, you need to change the number of links with atomic operations, the very ones with the assembler lock prefix: this prefix ensures that the processor will do everything exactly as it should, and no caches will prevent us from living.  The prefix is ‚Äã‚Äãgood, only slow, very slow.  He slows down the team by about 2 orders of magnitude, since  requires resetting the cache line, which means it should be used as little as possible. <br><br>  * Lyrical digression 2: how it happened and why there should be no atomic instructions. <br>  C ++ 11 gave us a very tasty piece called move semantics.  Now you can define ‚Äúmoving‚Äù constructors that move data from one object to another, instead of creating a copy of it.  Such a constructor, for example, moves a pointer to an internal string buffer from one std :: string to another, allowing you to move a string from one object to another without re-allocating memory.  Similarly, you can (and should!) Move the reference count from one shared_ptr to another.  Indeed, in this case, we do not need any atomic operations, because we do not change the number of pointers.  We just ‚Äútransfer‚Äù all internal data from one to another (and the pointer from which we took the data no longer indicates anywhere). <br><br>  So how did it happen ... Probably overlooked.  I wanted to write a tearful letter to boost, I even started to do it ... But then I found what struck me completely.  During the creation of boost :: shared_ptr, the get_deleter function calls type comparison via typeid (oh gods!).  I don‚Äôt know how they have it, but my compiler does it through strcmp (sad, isn't it?). <br><br>  Then I decided to measure the speed of the standard library versus boost.  2 times!  boost :: make_shared is slower std :: make_shared 2 times!  Why, you ask?  It's simple, boost allocates memory for 2 objects - the reference counter and the actual stored object.  But the standard library - just under one, this object contains both.  And the allocation of memory - it is slow.  Oral plus went to Microsoft, another one got there for the fact that smart pointers work as it should in the standard library - move the designer does not do any atomic operations.  Creating a pointer takes place in lock free mode ... Well, almost.  static_pointer_cast, after all, they didn‚Äôt master: it copies the pointer in spite of what it could move.  This problem was solved by ‚Äúfinishing‚Äù the library.  not portable to another platform dopilivaniem, but the relevant standard, you can download it here: <a href="http://pastebin.com/XZaE2cnW">pastebin.com/XZaE2cnW</a> - works in MSVC2010. <br><br>  PS <br><br>  So, our today's winner is std from MSVC2010: it has one plus in total <br>  But the boost was out of luck: -1 <br><br>  Well, I say goodbye, I hope at least someone this information was useful.  Use std :: shared_ptr, allocate memory via make / allocate shared and be happy :) </div><p>Source: <a href="https://habr.com/ru/post/138658/">https://habr.com/ru/post/138658/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../138648/index.html">Ya.Subbotnik goes to Chelyabinsk</a></li>
<li><a href="../138650/index.html">Windows XP and Windows 7 received extended five-year support</a></li>
<li><a href="../138652/index.html">Ukrainian traffic exchange point UA-IX want to privatize?</a></li>
<li><a href="../138655/index.html">Speech by Sergei Belousov in Chelyabinsk</a></li>
<li><a href="../138657/index.html">Jelastic + Luna = mini Github</a></li>
<li><a href="../138660/index.html">Don't die please</a></li>
<li><a href="../138664/index.html">IP Multipathing on Solaris 10</a></li>
<li><a href="../138666/index.html">Fair DOCX generation in PHP. Part 1</a></li>
<li><a href="../138667/index.html">Stack programming languages</a></li>
<li><a href="../138668/index.html">HTML5 canvas bilinear pixel distortion</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>