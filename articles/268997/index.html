<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Frida-node or a little bit strange code</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings to all who read this article. 
 Somehow it happened that in Habr√© there is almost no mention of the wonderful thing called Frida. The most s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Frida-node or a little bit strange code</h1><div class="post__text post__text-html js-mediator-article">  Greetings to all who read this article. <br>  Somehow it happened that in Habr√© there is almost no mention of the wonderful thing called Frida.  The most sensible of them is a couple of lines of code and a general description ( <a href="http://habrahabr.ru/company/dsec/blog/253309/">HabraFrida</a> , from which, in fact, I learned about the existence of this thing, for which a special thank you to the author). <br>  In short, Frida is committed to injecting the JS engine from Google (V8) into the targeted process (in the absence of protection, of course), and the built-in js-code can work with memory, intercept function calls, make these same calls and do other obscene. <br>  To be honest with the reverse, I am familiar with very mediocre and, mostly, from the MMORPG Runes of Magic, with which I began to learn how to code and with which a considerable part of my current knowledge in programming is connected.  Actually, I still have fun from time to time writing all sorts of differences for it (by the way, a toy is full of holes ... I didn‚Äôt find any smart bugs in it, starting from sketching objects and ending with sql-inject).  Here for her, I wrote a little test code on Frida, allowing you to do ... different. <br>  Why node.js?  Simple  In the end, the hub is abnormal programming) <br><a name="habracut"></a><br>  The most difficult part for me was the assembly of <a href="https://github.com/frida/frida-node">node-frida</a> .  Why?  Yes, it was too lazy to put 2013 studio.  Do not repeat this error - for 2015 it is unlikely to be able to collect.  If anyone needs it, I can later post the assembled add-on for win x64. <br><br>  So let's get down to the code itself.  The project itself is a normal project node, the startup script is called app.js, and we will start with it. <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> processName = process.argv[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> script=<span class="hljs-string"><span class="hljs-string">"'use strict'; "</span></span>; [ <span class="hljs-string"><span class="hljs-string">'./views/js/frida/romdata.js'</span></span>, <span class="hljs-string"><span class="hljs-string">'./views/js/frida/romlib.js'</span></span>, <span class="hljs-string"><span class="hljs-string">'./views/js/frida/rompackets.js'</span></span>, <span class="hljs-string"><span class="hljs-string">'./views/js/frida/rom.js'</span></span> ].forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">elem</span></span></span><span class="hljs-function">)</span></span>{ script+=fs.readFileSync(elem, <span class="hljs-string"><span class="hljs-string">'utf8'</span></span>); }); frida.attach(processName).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">session</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> session.createScript(script); }).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">script</span></span></span><span class="hljs-function">) </span></span>{ script.load().then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"script loaded"</span></span>); }); }).catch(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(err); });</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this piece of code, the following happens: we read the process name from the arguments (node ‚Äã‚Äãapp.js Client.exe-&gt; process.argv [2] -&gt; Client.exe) and specify the list of js-files that will be embedded in the targeted process.  Use strict was needed in exactly 1 place to use the class from ES6 (the easiest way that I found to implement the necessary functionality). <br>  Next, the connection to the target process is called, the result string is built into it, composed of the contents of the js-files, and the final script is initialized. <br><br>  While it seems easy, right? <br>  By the way, the code here is not all - only the essence of the essence, since  The code of the original project is rather heavily filled with all sorts of different test pieces. <br>  But enough of the lyrics, let's go further. <br><br>  The client itself uses a bunch of different functions, calling functions, calling functions, calling functions ... killing the brain by uselessness.  I used 2 functions, 1 for transmission, 2 for reception (before encrypting traffic). <br>  In general and in general, the transfer function looks something like this: <br>  SendToLocal (packetsize, (void *) packed data); <br>  where packetdata is a kind of structure that looks like this in general: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PG_Move_CtoL_PlayerMoveObject</span></span></span><span class="hljs-class"> {</span></span> GamePGCommandEnum Command; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> GItemID; RolePosStruct Pos; ClientMoveTypeENUM Type; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> vX; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> vY; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> vZ; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> AttachObjID; PG_Move_CtoL_PlayerMoveObject() { Command = EM_PG_Move_CtoL_PlayerMoveObject; } };</code> </pre><br><br>  which, in general (running ahead), is approximately as follows in js: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Move_CtoL_PlayerMoveObject = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MakeStruct(Memory, memalloc, { <span class="hljs-attr"><span class="hljs-attr">command</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'int'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">24</span></span>}, <span class="hljs-attr"><span class="hljs-attr">gitemid</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'int'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">2045</span></span>}, <span class="hljs-attr"><span class="hljs-attr">x</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'float'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">1000.0</span></span>}, <span class="hljs-attr"><span class="hljs-attr">y</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'float'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">1000.0</span></span>}, <span class="hljs-attr"><span class="hljs-attr">z</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'float'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">1000.0</span></span>}, <span class="hljs-attr"><span class="hljs-attr">dir</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'float'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">154</span></span>}, <span class="hljs-attr"><span class="hljs-attr">type</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'int'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>}, <span class="hljs-attr"><span class="hljs-attr">vX</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'float'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">0.0</span></span>}, <span class="hljs-attr"><span class="hljs-attr">vY</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'float'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">0.0</span></span>}, <span class="hljs-attr"><span class="hljs-attr">vZ</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'float'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">0.0</span></span>}, <span class="hljs-attr"><span class="hljs-attr">attachObjID</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'int'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>} });</code> </pre><br><br>  but more on that later. <br><br>  So, let's look at an example of intercepting a function <br><br><pre> <code class="javascript hljs"> Interceptor.attach(ptr(<span class="hljs-string"><span class="hljs-string">"0x6694E0"</span></span>), { <span class="hljs-attr"><span class="hljs-attr">onEnter</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">args</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dataptr = ptr(args[<span class="hljs-number"><span class="hljs-number">2</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> val = Memory.readU32(dataptr); } }</code> </pre><br><br>  In general, everything is trivially simple: 0x6694E0 is the address of the function being intercepted, onEnter is an event when a function is called (there is still onLeave, see the <a href="http://www.frida.re/docs/javascript-api/">JS API</a> for details), args are arguments of the intercepted function. <br>  In my case, remember that the SendToLocal ((int) size, (void *) data) function is intercepted, which means that in args [2] there is a pointer to data (ptr converts it to NativePointer (a pretty convenient wrapper for working with pointers). This piece of code is equivalent to something like this in the pluses (if I'm not mistaken, I somehow didn‚Äôt have a lot of pluses): <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendToLocal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Size , </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* Data )</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *dataptr=(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>*)Data; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> val = dataptr[<span class="hljs-number"><span class="hljs-number">0</span></span>]; }</code> </pre><br><br>  If we look a little higher, on Move_CtoL_PlayerMoveObject, then we will see that val == Move_CtoL_PlayerMoveObject.command.  I use it further to get the package name by its command id (var packetname = GamePGCommandEnum.enumName (val), where GamePGCommandEnum is the self-made function of transferring C ++ enum to js, ‚Äã‚Äãand GamePGCommandEnum.enumName - getting the name of enum by its id). <br><br>  The beauty of this Interceptor.attach is that it is called before the original function is called, which means that no one bothers to change the arguments or even overwrite the memory of the transmitted data by the received pointer).  For example, we use something in the spirit of args [1] = 10101010101, then the behavior of the function can be extremely puzzling (starting from crashing the client and ending with ignoring the packet, because it changed the size of the transmitted data). <br><br>  Let us turn to the MakeStruct function, which is necessary for deserializing binary data into a similar structure. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">buf, length</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> binary=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>(buf); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>(length); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;result.length; i++) result[i]=binary[i]; <span class="hljs-comment"><span class="hljs-comment">//console.log(length, result); return String.fromCharCode.apply(null, result); } function fromString(str, length) { var buf = new ArrayBuffer(length); // 2 bytes for each char var bufView = new Uint8Array(buf); for (var i=0, strLen=length; i&lt;strLen; i++) { if(i&lt;str.length) bufView[i] = str.charCodeAt(i); else bufView[i] = 0; } return buf; } var MakeStruct = function(Memory, ptr, options){ var _this=this; _this.offset = 0; _this.struct={}; _this.types={ byte: function(name, size){ _this.struct[name] = { type: 'byte', value: Memory.readS8(ptr.add(_this.offset)), size: 1, offset: _this.offset }; _this.offset+=1; }, short: function(name, size){ _this.struct[name] = { type: 'short', value: Memory.readS16(ptr.add(_this.offset)), size: 2, offset: _this.offset }; _this.offset+=2; }, int: function(name, size){ _this.struct[name] = { type: 'int', value: Memory.readS32(ptr.add(_this.offset)), size: 4, offset: _this.offset }; _this.offset+=4; }, float: function(name, size){ _this.struct[name] = { type: 'float', value: Memory.readFloat(ptr.add(_this.offset)), size: 4, offset: _this.offset }; _this.offset+=4; }, string: function(name, size, typesize){ //console.log(size, typesize); var mem=Memory.readByteArray(ptr.add(_this.offset), typesize); _this.struct[name] = { type: 'string', value: toString(mem, size), size: typesize, offset: _this.offset }; _this.offset+=typesize; }, bytes: function(name, size){ var mem=Memory.readByteArray(ptr.add(_this.offset), size); _this.struct[name] = { type: 'bytes', value: mem, size: size, offset: _this.offset }; _this.offset+=size; } }; _this.update = function(){ for(var key in _this.struct){ if(_this.struct.hasOwnProperty(key)){ var item=_this.struct[key]; switch(item.type){ case 'byte': Memory.writeS8(ptr.add(item.offset), item.value); break; case 'short': Memory.writeS16(ptr.add(item.offset), item.value); break; case 'int': Memory.writeS32(ptr.add(item.offset), item.value); break; case 'float': Memory.writeFloat(ptr.add(item.offset), item.value); break; case 'bytes': Memory.writeByteArray(ptr.add(item.offset), item.value); break; case 'string': Memory.writeByteArray(ptr.add(item.offset), fromString(item.value, item.size)); break; } } } } _this.sizeof = function(){ var s=0; for(var key in _this.struct){ if(_this.struct.hasOwnProperty(key) &amp;&amp; _this.struct[key].size){ s+=_this.struct[key].size*1; } } return s; } _this.print = function(){ for(var key in _this.struct){ if(_this.struct.hasOwnProperty(key) &amp;&amp; _this.struct[key].size){ console.log(key, _this.struct[key].value); } } console.log(''); } _this.struct['update']=_this.update; _this.struct['sizeof']=_this.sizeof; _this.struct['print']=_this.print; _this.struct['ptr']=ptr; for(var key in options){ if(options.hasOwnProperty(key)){ var elem=options[key]; _this.types[elem.type](key, typeof elem.size==="number" || typeof elem.size==="undefined"?elem.size:_this.struct[elem.size].value, elem.typesize); if(elem.value) _this.struct[key].value=elem.value; } } return _this.struct; };</span></span></code> </pre><br><br>  The toString / fromString functions are helpers for working with the char array.  The rest, in fact, wrappers for reading / writing from frida for more convenient work.  It is used like this: <br><br><pre> <code class="javascript hljs">Interceptor.attach(ptr(<span class="hljs-string"><span class="hljs-string">"0x60CCC0"</span></span>), { <span class="hljs-attr"><span class="hljs-attr">onEnter</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">args</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dataptr = ptr(args[<span class="hljs-number"><span class="hljs-number">1</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> val = Memory.readS16(dataptr); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> packetname=GamePGCommandEnum.enumName(val); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(packetname==<span class="hljs-string"><span class="hljs-string">"EM_PG_Move_CtoL_PlayerMoveObject"</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Move_CtoL_PlayerMoveObject = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MakeStruct(Memory, dataptr, { <span class="hljs-attr"><span class="hljs-attr">command</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'int'</span></span>}, <span class="hljs-attr"><span class="hljs-attr">gitemid</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'int'</span></span>}, <span class="hljs-attr"><span class="hljs-attr">x</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'float'</span></span>}, <span class="hljs-attr"><span class="hljs-attr">y</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'float'</span></span>}, <span class="hljs-attr"><span class="hljs-attr">z</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'float'</span></span>}, <span class="hljs-attr"><span class="hljs-attr">dir</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'float'</span></span>}, <span class="hljs-attr"><span class="hljs-attr">type</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'int'</span></span>}, <span class="hljs-attr"><span class="hljs-attr">vX</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'float'</span></span>}, <span class="hljs-attr"><span class="hljs-attr">vY</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'float'</span></span>}, <span class="hljs-attr"><span class="hljs-attr">vZ</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'float'</span></span>}, <span class="hljs-attr"><span class="hljs-attr">attachObjID</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'int'</span></span>} }); Move_CtoL_PlayerMoveObject.x.value+=<span class="hljs-number"><span class="hljs-number">100</span></span>; Move_CtoL_PlayerMoveObject.update(); Move_CtoL_PlayerMoveObject.print(); } } });</code> </pre><br><br>  will make the character cool teleamp when running (the x coordinate will increase by 100 relative to the real, and the server will be perplexed about what happened). <br><br>  Well, for a snack - an example of a function call. <br>  I use a wrapper over NativeFunction from Frida. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _sendToLocal=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NativeFunction(ptr(<span class="hljs-string"><span class="hljs-string">"0x60CCC0"</span></span>), <span class="hljs-string"><span class="hljs-string">'void'</span></span>, [<span class="hljs-string"><span class="hljs-string">'int'</span></span>, <span class="hljs-string"><span class="hljs-string">'pointer'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _setpos=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NativeFunction(ptr(<span class="hljs-string"><span class="hljs-string">"0x79AE70"</span></span>), <span class="hljs-string"><span class="hljs-string">'void'</span></span>, [<span class="hljs-string"><span class="hljs-string">'pointer'</span></span>]); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_Send</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj</span></span></span><span class="hljs-function">)</span></span>{ _sendToLocal(obj.sizeof(),obj.ptr); } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Structs</span></span></span></span>{ _gmcommand(ptr){ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> memalloc = ptr||Memory.alloc(<span class="hljs-number"><span class="hljs-number">4096</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> v = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Talk_CtoL_GMCommand = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MakeStruct(Memory, memalloc, { <span class="hljs-attr"><span class="hljs-attr">command</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'int'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">154</span></span>}, <span class="hljs-attr"><span class="hljs-attr">gitemid</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'int'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>}, <span class="hljs-attr"><span class="hljs-attr">contentsize</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'int'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: v.length}, <span class="hljs-attr"><span class="hljs-attr">content</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'string'</span></span>, <span class="hljs-attr"><span class="hljs-attr">typesize</span></span>: <span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-attr"><span class="hljs-attr">size</span></span>: <span class="hljs-string"><span class="hljs-string">'contentsize'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: v}, }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Talk_CtoL_GMCommand; } _moveTest(ptr){ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> memalloc = ptr||Memory.alloc(<span class="hljs-number"><span class="hljs-number">4096</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Move_CtoL_PlayerMoveObject = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MakeStruct(Memory, memalloc, { <span class="hljs-attr"><span class="hljs-attr">command</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'int'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">24</span></span>}, <span class="hljs-attr"><span class="hljs-attr">gitemid</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'int'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">2045</span></span>}, <span class="hljs-attr"><span class="hljs-attr">x</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'float'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">1000.0</span></span>}, <span class="hljs-attr"><span class="hljs-attr">y</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'float'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">1000.0</span></span>}, <span class="hljs-attr"><span class="hljs-attr">z</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'float'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">1000.0</span></span>}, <span class="hljs-attr"><span class="hljs-attr">dir</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'float'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">154</span></span>}, <span class="hljs-attr"><span class="hljs-attr">type</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'int'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>}, <span class="hljs-attr"><span class="hljs-attr">vX</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'float'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">0.0</span></span>}, <span class="hljs-attr"><span class="hljs-attr">vY</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'float'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">0.0</span></span>}, <span class="hljs-attr"><span class="hljs-attr">vZ</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'float'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">0.0</span></span>}, <span class="hljs-attr"><span class="hljs-attr">attachObjID</span></span>: {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'int'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>} }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Move_CtoL_PlayerMoveObject; } }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_call</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name, args, ptr</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> struct = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Structs(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s=struct[name](ptr); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> args){ s[i].value=args[i]; } s.update(); _Send(s); }</code> </pre><br><br>  A little more in detail: class - sugar for js-prototypes, in this case allows you to easily get a function by name without perversions with eval or something-else-can-come-in-head-at-3-hours-nights. <br>  _call is called something like this: <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cmd=<span class="hljs-string"><span class="hljs-string">"give 0x31194"</span></span>; _call(<span class="hljs-string"><span class="hljs-string">'_gmcommand'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">contentsize</span></span>: cmd.length, <span class="hljs-attr"><span class="hljs-attr">content</span></span>: cmd });</code> </pre><br><br>  in this case is equivalent to a call to chat / gm?  give 0x31994 (um-team for issuing things by its ID). <br><br>  _setpos is another binding to the real semi-um client function that allows you to change the character coordinates in the client and on the server, taking as an argument a string with 3 coordinates.  Charging something in the spirit <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> memalloc = Memory.alloc(<span class="hljs-number"><span class="hljs-number">128</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> q=<span class="hljs-number"><span class="hljs-number">-4050.7</span></span>; setInterval(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ Memory.writeUtf8String(memalloc, q+++<span class="hljs-string"><span class="hljs-string">", 244.5, -8251.9"</span></span>); _setpos(memalloc); }, <span class="hljs-number"><span class="hljs-number">100</span></span>);</code> </pre><br><br>  we get the character in a state of delirium tremens (his sausage is not weak, by the way). <br><br>  In general, at the moment I used frida more for entertaining and warming up the brain, however, with the right approach, it can turn into a very worthy tool for researching various kinds of processes. <br>  Thank you for your attention, I hope you enjoyed it. <br><br>  And finally, materials: <br><br>  <a href="http://www.frida.re/">Frida website</a> <br>  <a href="http://www.frida.re/docs/javascript-api/">Frida JS API</a> <br>  <a href="https://github.com/frida/frida-node">Frida-node</a> <br>  <a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Classes">Class in ECMAScript 6</a> <br>  <a href="http://vignette1.wikia.nocookie.net/absurdopedia/images/6/68/%25D0%259A%25D0%25BE%25D0%25BD%25D1%258C_%25D1%2581_%25D0%25BF%25D1%2580%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25B9.jpg/revision/latest%3Fcb%3D20100313231744">Horse</a> </div><p>Source: <a href="https://habr.com/ru/post/268997/">https://habr.com/ru/post/268997/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268987/index.html">Accelerate Android code</a></li>
<li><a href="../268989/index.html">Objects of zero size</a></li>
<li><a href="../268991/index.html">Pagination of lists in Android with RxJava. Part I</a></li>
<li><a href="../268993/index.html">Remote execution of system commands on request via sockets in Python 3 or how I downloaded the sites</a></li>
<li><a href="../268995/index.html">FlexPod DataCenter: Direct-Attached Storage</a></li>
<li><a href="../268999/index.html">How did Cisco Security Ninja teach 20,000 employees to secure programming?</a></li>
<li><a href="../269001/index.html">The digest of interesting materials for the mobile # 125 developer (October 12-18)</a></li>
<li><a href="../269003/index.html">Script shipping management online store</a></li>
<li><a href="../269007/index.html">Virtual quadrocopter on Unity + OpenCV (Part 2)</a></li>
<li><a href="../269009/index.html">Altera + OpenCL: we program under FPGA without knowledge of VHDL / Verilog</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>