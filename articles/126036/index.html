<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Color music or music visualization</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It all started with one very interesting post about creating a laser show . It was just under the new year and it was necessary to think of something ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Color music or music visualization</h1><div class="post__text post__text-html js-mediator-article">  It all started with one very interesting post <a href="http://habrahabr.ru/blogs/DIY/106746/">about creating a laser show</a> .  It was just under the new year and it was necessary to think of something for the impending New Year's party.  And the laser show, driven by music, was what the doctor ordered!  Chinese pointers burned one by one, and their brightness was very mediocre.  Just somewhere I found an article on how to make a laser pointer from a DVD-drive.  The new year has long passed, the LPT port burned down, but then the ATTiny2313 I ordered and a bunch of other electronic components arrived.  A lot of time passed for the soldering iron, a lot of converted boards, assembled rakes ... In the end I decided to order a powerful RGB LED for 3W.  Then the laser show was already working on a 30mW green laser with the help of the Winamp visualization plugin via the COM port.  In general, the LED made a huge impression on me, and I decided to add color music to the laser show. <br><a name="habracut"></a><br><h4>  Device </h4><br>  What we have been given: three coolers and a laser for the laser show module;  Two powerful 3W RGB LEDs.  It is necessary for this business to make a control unit so that he has the opportunity to communicate with the computer via the COM port with a special program. <br><br>  <i>I‚Äôll say right away that in the end the laser died and no code was even written for the laser show, so from here on it‚Äôs all about color music.</i>  <i>Also in the scheme there is a USB-port, but it was also not possible to implement.</i> <br><br> <a href="http://imageshack.us/photo/my-images/718/chematic.jpg/"><img src="http://img718.imageshack.us/img718/292/chematic.th.jpg" alt="image"></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      An ATMega8 microcontroller was selected for the control unit.  It is easy to program on it, there are a lot of articles on the Internet.  The <a href="http://easyelectronics.ru/">EasyElectronics</a> website helped me especially hard; there I learned how to make simple devices and learned a little circuitry. <br><br>  I did not have a large selection of LEDs, in fact there was only one option: ARPL-STAR 3W RGB. <img src="http://chip-nn.ru/doc/all/2529/2529.jpg" width="200" height="100" alt="ARPL-STAR 3W RG">  . <br>  It has 6 pins, so each of the three LEDs is controlled separately.  In my case, the connection scheme was with a common anode.  I must say that the LEDs consume a rather large current - each 350mA at maximum brightness.  There are two RGB lamps in total and they are connected in parallel to the same MK outputs, so the current is not very small.  For switching, I chose the same uln2003 from the article about the laser show, only I used two leads to each LED of the lamp, since  each pin holds only 500mA, so a total of 6 pins.  I have to say that the idea was not the best.  Although the parameters are fine, but in fact, if the lamps are lit in white with full power, then uln overheats and turns off.  I had an idea of ‚Äã‚Äãa completely different design, which I will write below. <br><br>  The diagram is a standard kit for the MK, a Molex connector is built in for powering, which provides 12V for laser show coolers and 5V for everything else.  You can connect to a computer, but for convenience I used a separate power supply with a molex type output.  To program the MC, the standard <a href="http://easyelectronics.ru/avr-shag-pervyj-programmator.html">Gromov programmer was</a> used.  But the <a href="http://easyelectronics.ru/svyaz-mikrokontrollera-s-kompyuterom-cherez-rs232.html">adapter</a> RS232 &lt;-&gt; UART.  In the future, it was planned to do everything via USB, but I used the wrong USB connector on the board, so now I can not find the cable to connect to the computer. <br><br>  The color of the lamp depends on all three LEDs that are built into it.  Color model - RGB.  The brightness of each of the LEDs depends on the voltage.  So <a href="http://easyelectronics.ru/avr-uchebnyj-kurs-ispolzovanie-shim.html">PWM is</a> used to change the brightness of a specific component.  Thus, to set the color for the controller, it is enough to transmit three values ‚Äã‚Äãfrom 0 to 255, where 255 means maximum brightness.  It is worth noting that the lamps are very hot, so you need to put them on radiators. <br><br>  The MK program was written in C on AVRStudio and it is quite simple: upon the arrival of a byte on UART, it is entered into a queue;  in the main loop, the program calls the current command.  A command is an index of the procedure in the table that needs to be run.  There are only three commands used: simple, clear color and set color.  In a simple program it looks if there is data in the queue, and if there is, then the index of the current command changes to what is in the queue.  The color setting command takes 3 bytes of data so that it hangs in the main loop while there are 3 bytes in the data queue. <br><br>  PWM is implemented in software.  This was done because there are only three PWM hardware channels in ATMega8, and I needed six: three for laser show coolers and three for lamps. <br><br>  Here is the main program code: <br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> baudrate 9600L #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> bauddivider (F_CPU / (16 * baudrate) - 1) UBRRL = LO(bauddivider); UBRRH = HI(bauddivider); UCSRA = 0; UCSRB = 1</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt;RXEN|1&lt;&lt;TXEN|1&lt;&lt;RXCIE|0&lt;&lt;TXCIE; UCSRC = 1&lt;&lt;URSEL|1&lt;&lt;UPM1|0&lt;&lt;UPM0|1&lt;&lt;UCSZ0|1&lt;&lt;UCSZ1; D_SEND('r'); TCCR0 = (0&lt;&lt;CS02)|(0&lt;&lt;CS01)|(1&lt;&lt;CS00); TIMSK = (1&lt;&lt;TOIE0); DDRB = DDRD = DDRC = 0xff; PORTB = PORTD = PORTC = 0; g_currentSetup = 0; SetupShowFromPredefines(0); g_currentColorSetup = 0; SetColorFromPredefines(0); UartRcvInit(); g_command = 0; g_shit = 1; g_pwmValue = 0; sei(); for(;;) { //.      //  ,     //    if (g_shit &gt; 0 &amp;&amp; g_counter &gt;= 0xff00) { g_currentColorSetup++; if (g_currentColorSetup == MAX_COLOR_PREDEFINES) g_currentColorSetup = 0; SetColorFromPredefines(g_currentColorSetup); ATOMIC_BLOCK(ATOMIC_FORCEON) { g_counter = 0; } } PCOMMAND pFunc = (PCOMMAND)pgm_read_word(g_commands + g_command); if (pFunc()) { g_command = 0; } } return 0; } ISR(USART_RXC_vect) { //  UartOnRecieve(); } ISR(TIMER0_OVF_vect) { g_counter++; g_pwmValue++; //      if (g_pwmValue == 0) { LAMP_PORT |= LAMP_MASK; } //       //     if (g_pwmValue == g_pwm[3]) CBI(LAMP_PORT, LAMP_RED); if (g_pwmValue == g_pwm[4]) CBI(LAMP_PORT, LAMP_GREEN); if (g_pwmValue == g_pwm[5]) CBI(LAMP_PORT, LAMP_BLUE); }</span></span></span></span></code> </pre> <br><br>  An example of a color change command: <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// - 4 //  bool UpdateColor() { ColorData data; if (UartRead((byte*)&amp;data, sizeof(ColorData))) { D_SEND('l'); g_shit = 0; SetColor(&amp;data); return true; } return false; } void SetColor(ColorData *pData) { ATOMIC_BLOCK(ATOMIC_FORCEON) { g_pwm[3] = pData-&gt;red; g_pwm[4] = pData-&gt;green; g_pwm[5] = pData-&gt;blue; } }</span></span></code> </pre> <br><br>  The printed circuit board is made using the <a href="http://easyelectronics.ru/sozdanie-pechatnoj-platy-metodom-lazernogo-utyuga.html">LUT</a> method. <br><br> <a title="ImageShack - Image And Video Hosting" href="http://imageshack.us/photo/my-images/804/p1040167p.jpg/"><img src="http://img804.imageshack.us/img804/7369/p1040167p.jpg"></a> <a title="ImageShack - Image And Video Hosting" href="http://imageshack.us/photo/my-images/585/p1040168w.jpg/"><img src="http://img585.imageshack.us/img585/9680/p1040168w.jpg"></a> <br><br><h4>  Program </h4><br> <a title="ImageShack - Image And Video Hosting" href="http://imageshack.us/photo/my-images/706/progrr.jpg/"><img src="http://img706.imageshack.us/img706/7253/progrr.jpg"></a> <br><br>  Initially, everything was controlled by a visualization plugin on Winamp.  But it was not convenient, because  often music listened to VKontakte.  It was decided to write in C #, since  The application should be purely front-end.  After searching the Internet for information about capturing sound, I did not find anything sensible, but I remembered that in the sound card, you can configure the recording device to the conclusion of what is currently playing.  So I, using the Bass library, quickly made an example.  It also turned out that in C # there is a whole class for working with serial ports - everything turned out to be very simple. <br><br>  Although the color model of the lamps is RGB for obvious reasons, it is not the most suitable for visualizing music, so the program uses the HSV model.  Each color component ‚Äî color, saturation, and brightness ‚Äî is independently adjustable.  I decided not to be limited only to color music: for each color component, you can choose one of the possible sources: manual input, random value, audio, and copying another component.  In manual mode, you can adjust the color, brightness and saturation.  With the help of a random mode, you can make a mood lamp (there are settings for the range, frequency of shift and speed of shift).  The most interesting mode is of course audio. <br><br>  Everything is based on the frequency spectrum.  The frequency range is selected, which will affect the value of the color components, the signal level is selected (can be reduced, it can be increased), offset, smoothing.  You can also use not the signal level, but its change.  I usually put it on the brightness of the lamps and it turns out such a stroboscopic effect (the stroboscope, by the way, can also be realized) - with an increase in the signal level, the brightness increases, with a decrease, respectively, decreases.  This is where the shift, with which you can adjust the initial brightness, is useful. <br><br><h4>  What can be done </h4><br>  First, as I wrote above, if you turn on the lamps at full power, they will quickly turn off because of uln.  In addition, if the lamps need to be placed at a relatively large distance from the head unit, then you need to use thick wires, otherwise there will be large losses.  So I had an idea of ‚Äã‚Äãa completely different design: to make each lamp as a separate module with its own power supply, its own MK and controls.  These modules will be connected to the main device via twisted pair, and the avr tools allow the MC to communicate with each other.  So  it will be possible to control the lamps separately. <br><br>  Secondly, it is possible to blink light bulbs not only to music, but also under video, it is possible to make something like AmbLight, and the current architecture allows to make it.  Any information on capturing video?  The lamps themselves are very bright, especially two, and they only illuminate a room of 35 squares, so you can bring the viewing of photos to a new level!  See you pictures from the sea, and the whole room is filled with a pleasant blue tint - beauty! <br><br><h4>  Conclusion </h4><br>  Much has been done, much remains to be done, unfortunately not in the near future.  Finally - the video.  Unfortunately, my camera is not distinguished by good photosensitivity, so the video seems that nothing is covered at all.  In fact, the effects are very strong, and if you look at the lamps themselves, it puts a lot of pressure on the eyes - the very thing for parties. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/u7h3J-y6KUs&amp;xid=25657,15700021,15700186,15700190,15700253,15700256,15700259&amp;usg=ALkJrhjfaxpK2mSk0sb_rpPz-F7ThCtDXg" frameborder="0" allowfullscreen=""></iframe><br><br><ul><li>  <a href="">Archive with the scheme, signet, program and firmware</a> </li></ul><br><br>  <b>UPD:</b> Added source control program to archive </div><p>Source: <a href="https://habr.com/ru/post/126036/">https://habr.com/ru/post/126036/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../126029/index.html">Where to go to an effective specialist</a></li>
<li><a href="../126030/index.html">Intellectual property protection in the aerospace and defense industries</a></li>
<li><a href="../126032/index.html">From idea to own game studio in 3 weeks</a></li>
<li><a href="../126033/index.html">Two sentences</a></li>
<li><a href="../126035/index.html">Export messages from Google Reader to Google+</a></li>
<li><a href="../126039/index.html">Blackjob telecom</a></li>
<li><a href="../126040/index.html">The most expensive Android smartphone in the world</a></li>
<li><a href="../126042/index.html">Quickly create load tests on JMeter for web sites</a></li>
<li><a href="../126043/index.html">How to help your child learn the multiplication table</a></li>
<li><a href="../126044/index.html">Schetov.ru API</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>