<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Returning to the foreach construction with Duck Typing for LINQ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I promise that this time there will be a short article (relatively). You all know the foreach language construct in C #, don't you? But think twice be...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Returning to the foreach construction with Duck Typing for LINQ</h1><div class="post__text post__text-html js-mediator-article">  I promise that this time there will be a short article (relatively).  You all know the foreach language construct in C #, don't you?  But think twice before saying exactly how the following code works: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">foreach</font> ( <font color="#0000ff">int</font> x <font color="#0000ff">in</font> src) { <font color="#008000">// Do something with x.</font> }</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <ol><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">foreach</font> ( <font color="#0000ff">int</font> x <font color="#0000ff">in</font> src) { <font color="#008000">// Do something with x.</font> } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">foreach</font> ( <font color="#0000ff">int</font> x <font color="#0000ff">in</font> src) { <font color="#008000">// Do something with x.</font> } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">foreach</font> ( <font color="#0000ff">int</font> x <font color="#0000ff">in</font> src) { // Do something with x. } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">foreach</font> ( <font color="#0000ff">int</font> x <font color="#0000ff">in</font> src) { <font color="#008000">// Do something with x.</font> } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> </ol> <code><font color="gray"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">foreach</font> ( <font color="#0000ff">int</font> x <font color="#0000ff">in</font> src) { <font color="#008000">// Do something with x.</font> }</font> * This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Already know the answer?  Let me disappoint you: if you have only <i>one</i> answer, then you are <i>mistaken</i> .  There is no one answer to the question, because you need to know more about the type of the src variable in order to make a final decision about how the above code works ... <br><a name="habracut"></a><br>  Obviously, you must say that the object must implement IEnumerable or IEnumerable &lt;T&gt;, and maybe you even mention that in the first case, the compiler will type for you when it gets the value "x", causing the IEnumerator.Current property.  In other words, you convert the code into something like this: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">var</font> e = src.GetEnumerator (); </li><li>  <font color="#0000ff">while</font> (e.MoveNext ()) </li><li>  { </li><li>  <font color="#0000ff">var</font> x = ( <font color="#0000ff">int</font> ) e.Current;  <font color="#008000">// without the cast if src was an IEnumerable &lt;T&gt;</font> </li><li>  <font color="#008000">// Do something with x.</font> </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  Worthy attempt, but not quite true.  First of all, the variable x is declared in the outer zone of visibility (which causes some trouble, if we talk about closures, but now we have a completely different topic ...).  Secondly, the enumerator can implement IDisposable, and in this case, the foreach construct provides the correct release of a for ‚Äúusing‚Äù: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  { </li><li>  <font color="#0000ff">int</font> x; </li><li></li><li>  <font color="#0000ff">using</font> ( <font color="#0000ff">var</font> e = src.GetEnumerator ()) </li><li>  { </li><li>  <font color="#0000ff">while</font> (e.MoveNext ()) </li><li>  { </li><li>  x = ( <font color="#0000ff">int</font> ) e.Current;  <font color="#008000">// without the cast if src was an IEnumerable &lt;T&gt;</font> </li><li>  <font color="#008000">// Do something with x.</font> </li><li>  } </li><li>  } </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  This is more reasonable, but we missed another type of source that foreach can work with: it is any object, as long as it provides the GetEnumerator enumeration template in tandem with MoveNext and Current.  For example, here‚Äôs an object that works just fine with the foreach construct. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">class</font> Source </li><li>  { </li><li>  <font color="#0000ff">public</font> SourceEnumerator GetEnumerator () </li><li>  { </li><li>  <font color="#0000ff">return</font> <font color="#0000ff">new</font> SourceEnumerator (); </li><li>  } </li><li>  } </li><li></li><li>  <font color="#0000ff">class</font> SourceEnumerator </li><li>  { </li><li>  <font color="#0000ff">private</font> <font color="#2B91AF">Random</font> rand = <font color="#0000ff">new</font> <font color="#2B91AF">Random</font> (); </li><li></li><li>  <font color="#0000ff">public</font> <font color="#0000ff">bool</font> MoveNext () </li><li>  { </li><li>  <font color="#0000ff">return</font> rand.Next (100)! = 0; </li><li>  } </li><li></li><li>  <font color="#0000ff">public</font> <font color="#0000ff">int</font> Current </li><li>  { </li><li>  <font color="#0000ff">get</font> </li><li>  { </li><li>  <font color="#0000ff">return</font> rand.Next (100); </li><li>  } </li><li>  } </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  How it is used is shown below: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">foreach</font> ( <font color="#0000ff">int</font> x <font color="#0000ff">in</font> <font color="#0000ff">new</font> Source ()) </li><li>  <font color="#2B91AF">Console</font> .WriteLine (x); </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  Ok, flexible, isn't it?  In fact, it can be said that in the foreach construction, <a href="http://ru.wikipedia.org/wiki/%25D0%25A3%25D1%2582%25D0%25B8%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2582%25D0%25B8%25D0%25BF%25D0%25B8%25D0%25B7%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F">duck typing</a> : it is not the nominal type that matters (that is, when Source is explicitly declared as IEnumerable and SourceEnumerator as IEnumerator), but only the structure of the object, which determines ‚Äúcompatibility‚Äù with the foreach construction . <br><br>  But who said that foreach over the collection immediately begins to think about LINQ?  Suppose the Source class is used like this: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#2B91AF">List</font> &lt; <font color="#0000ff">int</font> &gt; res = <font color="#0000ff">new</font> <font color="#2B91AF">List</font> &lt; <font color="#0000ff">int</font> &gt; (); </li><li>  <font color="#0000ff">foreach</font> ( <font color="#0000ff">int</font> x <font color="#0000ff">in</font> <font color="#0000ff">new</font> Source ()) </li><li>  <font color="#0000ff">if</font> (x% 2 == 0) </li><li>  res.Add (x); </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  Looks like a great candidate for LINQ, especially if we started adding more and more logic to our ‚Äúrequest‚Äù.  There is nothing surprising in this conclusion, but in reality, unfortunately, it falls and does not compile: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/79b/2af/8b5/79b2af8b595ca63f3e2f0ca4c249425b.png"></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Why?  Because in LINQ static typing <strong>(update: in this place, the author asks to read the comments on his article and agrees that it would be more accurate in this case to speak about LINQ to Objects)</strong> , so LINQ expects me to refer to the <i>nominal</i> implementation enumerator: to something that is explicitly defined as an IEnumerable, and not to something that "accidentally" turned out to be similar to an IEnumerable.  Question of the day: how to convert an existing <i>structural</i> enumerator into a nominal one so that it can be used with LINQ?  Of course, we can write a special code for the Source object, which will create the necessary iterator from Source: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">static</font> <font color="#0000ff">void</font> Main () </li><li>  { </li><li>  <font color="#0000ff">var</font> res = <font color="#0000ff">from</font> x <font color="#0000ff">in</font> IterateOver ( <font color="#0000ff">new</font> Source ()) </li><li>  <font color="#0000ff">where</font> x% 2 == 0 </li><li>  <font color="#0000ff">select</font> x; </li><li></li><li>  <font color="#0000ff">foreach</font> ( <font color="#0000ff">var</font> x <font color="#0000ff">in</font> res) </li><li>  <font color="#2B91AF">Console</font> .WriteLine (x); </li><li>  } </li><li></li><li>  <font color="#0000ff">static</font> <font color="#2B91AF">IEnumerable</font> &lt; <font color="#0000ff">int</font> &gt; IterateOver (Source s) </li><li>  { </li><li>  <font color="#0000ff">foreach</font> ( <font color="#0000ff">int</font> i <font color="#0000ff">in</font> s) </li><li>  <font color="#0000ff">yield</font> <font color="#0000ff">return</font> i; </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  But perhaps you are in such a situation, when there is a whole abundance of such structural enumerators around (for example, some Office automation libraries provide GetEnumerator in types like Range, while the Type type does not implement IEnumerable interface, therefore, it is not suitable for use with LINQ) so you want to summarize the above solution.  In essence, we need the ability to add an iterator with duck typing over any object and this is a suitable task for the extender method and the dynamic keyword from C # 4.0: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">static</font> <font color="#0000ff">class</font> DuckEnumerable </li><li>  { </li><li>  <font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#2B91AF">IEnumerable</font> &lt;T&gt; AsDuckEnumerable &lt;T&gt; ( <font color="#0000ff">this</font> <font color="#0000ff">object</font> source) </li><li>  { </li><li>  dynamic src = source; </li><li></li><li>  <font color="#0000ff">var</font> e = src.GetEnumerator (); </li><li>  <font color="#0000ff">try</font> </li><li>  { </li><li>  <font color="#0000ff">while</font> (e.MoveNext ()) </li><li>  <font color="#0000ff">yield</font> <font color="#0000ff">return</font> e.Current; </li><li>  } </li><li>  <font color="#0000ff">finally</font> </li><li>  { </li><li>  <font color="#0000ff">var</font> d = e <font color="#0000ff">as</font> IDisposable; </li><li>  <font color="#0000ff">if</font> (d! = <font color="#0000ff">null</font> ) </li><li>  { </li><li>  d.Dispose (); </li><li>  } </li><li>  } </li><li>  } </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  Question to the reader: why can't we just write a foreach loop over an ‚Äúobject that is cast to dynamic‚Äù?  Hint: how then do you implement the translation of the foreach construct in a dynamic object? <br><br>  Yes, you will pile up the required list of methods on System.Object, so be careful with using this, or simply use a call to the old flat method to "translate" the structural into the nominal.  Notice how easy it looks like dynamically typed code in C # 4.0.  With a large number of type conversions, it looks like this: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">static</font> <font color="#0000ff">class</font> DuckEnumerable </li><li>  { </li><li>  <font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#2B91AF">IEnumerable</font> &lt;T&gt; AsDuckEnumerable &lt;T&gt; ( <font color="#0000ff">this</font> <font color="#0000ff">object</font> source) </li><li>  { </li><li>  dynamic src = (dynamic) source; </li><li></li><li>  dynamic e = src.GetEnumerator (); </li><li>  <font color="#0000ff">try</font> </li><li>  { </li><li>  <font color="#0000ff">while</font> (( <font color="#0000ff">bool</font> ) e.MoveNext ()) </li><li>  <font color="#0000ff">yield</font> <font color="#0000ff">return</font> (T) e.Current; </li><li>  } </li><li>  <font color="#0000ff">finally</font> </li><li>  { </li><li>  <font color="#0000ff">var</font> d = e <font color="#0000ff">as</font> IDisposable; </li><li>  <font color="#0000ff">if</font> (d! = <font color="#0000ff">null</font> ) </li><li>  { </li><li>  d.Dispose (); </li><li>  } </li><li>  } </li><li>  } </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  And now we can write this: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">var</font> res = <font color="#0000ff">from</font> x <font color="#0000ff">in</font> <font color="#0000ff">new</font> Source (). AsDuckEnumerable &lt; <font color="#0000ff">int</font> &gt; () </li><li>  <font color="#0000ff">where</font> x% 2 == 0 </li><li>  <font color="#0000ff">select</font> x; </li><li></li><li>  <font color="#0000ff">foreach</font> ( <font color="#0000ff">var</font> x <font color="#0000ff">in</font> res) </li><li>  <font color="#2B91AF">Console</font> .WriteLine (x); </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  Dynamic glue - why not?  In fact, even objects from other languages ‚Äã‚Äã(like Ruby or Python) that follow the paradigm of duck typing now work with LINQ, and for existing compatible objects, calling the operator is harmless (but wasteful).  Oh, and note that you can also have an IEnumerable in ‚Äúdynamic‚Äù objects if you are dealing with objects from dynamic languages ‚Äã‚Äã... <br><br>  Can you implement the AsDuckEnumerable method in C # 3.0?  Of course, if you limit yourself to reflection-based methods (left as an exercise for the reader). <br><br>  Enjoy! <br></div><p>Source: <a href="https://habr.com/ru/post/68430/">https://habr.com/ru/post/68430/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../68421/index.html">Run a pre-installed copy of Windows in VirtualBox under Ubuntu</a></li>
<li><a href="../68424/index.html">Block of pictures aligned to the left and right side</a></li>
<li><a href="../68427/index.html">Update browser version</a></li>
<li><a href="../68428/index.html">ADO.NET Data Services v.1.5 CTP2</a></li>
<li><a href="../68429/index.html">The ‚ÄúInternet‚Äù of Teperecha is not that just now. Russian language reform</a></li>
<li><a href="../68431/index.html">The new site of the Kremlin</a></li>
<li><a href="../68432/index.html">Habr, i need help</a></li>
<li><a href="../68434/index.html">Movie that awakens the desire to work with millions!</a></li>
<li><a href="../68436/index.html">Transferring contacts from Microsoft Outlook to Mac OS Address book</a></li>
<li><a href="../68437/index.html">OpenGL ES: Moving in 3D</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>