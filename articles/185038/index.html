<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we did Peat TV</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How the technical implementation of the Internet TV channel was created, what tasks the team faced and what tools and services helped us in the develo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we did Peat TV</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/files/ef9/78e/468/ef978e4684d549788f18df71656328ab.png">  How the technical implementation of the Internet TV channel was created, what tasks the team faced and what tools and services helped us in the development process you can find out in this article. <br><a name="habracut"></a><br><br>  Peat TV is a cultural and anthropological Internet project founded by Kirill Kislyakov.  This is an author's project, respectively, with a pronounced subjective approach both to the selection of topics, the choice of characters, and to the presentation of the material.  The channel covers a wide range of issues of art and education, literature and poetry, science and technology, music and history, non-political news and interesting facts in the format of short video. <br>  Footage Peat TV come out with the accumulation of material.  Each issue is a short video with a duration of 3 to 15 minutes, made in the style of video art. <br><br><h4>  <font color="#ff9c00">‚ñå</font> Concept </h4><br>  Some issues are monologues or dialogues of people, sometimes they are addressed to the viewer, and sometimes they communicate with each other, not paying attention to what they are being filmed.  There are issues made in the format of documentary programs, and there are issues in the format of interviews.  Sometimes the interviewer may be in the frame, like the interviewee, and sometimes it may not be visible and the viewer hears only the voice asking questions.  All issues are divided by the program heading with a specific theme. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At the moment on the channel there are such sections as: <br><ul><li>  <b>Portrait</b> - author interviews </li><li>  <b>Brothers in the trash</b> - issues devoted to the culture of alcohol consumption </li><li>  <b>A look at the sound</b> - the releases are devoted to events and persons from the world of music </li><li>  <b>The end of geography</b> - editions of travel and various parts of the world </li><li>  <b>Favorite poem</b> - guests read their favorite poems </li><li>  <b>The first lit-ra</b> - issues devoted to literature </li><li>  <b>The third shift</b> - the professionals talk about what and why they do </li></ul><br><br>  From the point of view of anthropology, the most interesting issues are <i>Portrait</i> and <i>Brothers in the trash</i> .  So, in the first category of issues a person says what he wants to say, and in the second - what he can say.  Both formats often allow for 5 minutes to tell a person more than he himself assumes. <br><br>  The audience of the channel is people who are interested not only and not so much in cultural issues as an opportunity to follow the train of thought divorced from the context and time, relevant in any era and anywhere in the world, therefore, the video on the Peat is not an operational chronicle. what happens in cultural life, and an overview of what suddenly comes to the attention of the team of authors or invited characters.  Sometimes, the plots can be from the past or from the future, this does not affect their relevance. <br><br><h4>  <font color="#ff9c00">‚ñå</font> Implementation </h4><br>  When we started developing the IT part of the project, we faced several tasks: <br><br><ul><li>  the resource must be implemented using HTML5 and allow playing videos on any devices that support the standard </li><li>  the video should be available worldwide, in good quality and without delays playing </li><li>  project maintenance procedure should be as automated as possible. </li></ul><br><br>  Today, as a result of trial and experiment, we have come to the most optimal, in our opinion, project architecture (the full-size image can be <a href="">viewed here</a> ): <br> <a href="http://http:"><img src="https://habrastorage.org/files/f9a/ece/e72/f9aecee7223a4374952c9cfb2a881c05.png"><br></a> <br><br>  Let's see how it all works and why we did just that. <br><br><h4>  <font color="#ff9c00">‚ñå</font> Player </h4><br>  The project has developed its own HTML5 / JS player that supports the main video formats: <br><ul><li>  <b>ogg</b> is an open standard for the media container format, which is the main file and stream format for the Xiph.Org Foundation codecs.  Video in this format was encoded for users with Firefox browsers up to version 4 and Opera up to 10.6 </li><li>  <b>mp4</b> is a media container format that is part of the MPEG-4 standard.  This format is supported by most browsers and, judging by the statistics, videos in this format are most often downloaded for viewing. </li><li>  <b>webm</b> is an open multimedia format presented by Google at the Google I / O conference on May 19, 2010.  The format does not require license fees, based on the open video codec VP8.  It was used as an alternative codec, as the standard was supposed to be more widely distributed. </li></ul><br>  For each format we create 4 video options with different resolutions: <br><ul><li>  SD - for users with low Internet speeds and for mobile phones </li><li>  HD - this mode is enabled by default for viewing video in player mode </li><li>  HD720 - suitable for viewing video in full screen mode </li><li>  HD1080 - support for this resolution appeared a little later, for those who watch releases from smart TV devices and high-resolution screens </li></ul><br>  According to statistics, most of the views accounted for video files in <i>mp4</i> format with a resolution of <i>HD</i> and <i>SD</i> . <br><br><h4>  <font color="#ff9c00">‚ñå</font> Video preparation and publication </h4><br><img align="right" src="https://habrastorage.org/files/5fa/59a/61f/5fa59a61ff624fe7a908797f517198fa.png">  Over releases the team consists of several editors.  The editors are located in different cities and work remotely.  Each of them has FTP access to a media encoding server.  Together with the original (raw) video file, the editor also uploads a text file to the server with a description of the release and a poster for the video displayed on the main page.  After the video is uploaded to the server via FTP, the automatic video encoding process starts: <br><br><ol><li>  On the encoding server, with the help of a specially developed program, the video is converted into various formats and resolutions. <br></li><li>  After the video has been encoded, the program starts uploading the video to the Rackspace CDN endpoint, from which files later get into the local CDN server. <br></li><li>  After the download is complete, a request is sent to the web application to add a new release. <br></li><li>  When a web application receives a call, the video information is added to the database and released to the site. <br></li></ol><br><br>  In the process of creating a program for converting video, it was decided to allocate the code responsible for converting into a separate library.  The library is called X.Media.Encoding and can be freely <a href="http://www.nuget.org/packages/xmediaencoding/">downloaded from the nuget repository</a> . <br><br><h4>  <font color="#ff9c00">‚ñå</font> Transition to the clouds </h4><br>  When we were just starting development, the site was deployed on a regular dedicated server, and at first, that was enough.  However, over time, it became clear that a regular server has several drawbacks: <br><ol><li>  first of all, it concerned video files - the download speed of releases left much to be desired </li><li>  The second problem was connected with the fact that the resource essentially works in the peak load mode - the activity of the visitors is maximum when a new release is released, and minimal between releases.  Thus, you need to either acquire a more powerful server, whose resources will be idle most of the time, or switch to a platform that supports automatic scaling. </li></ol><br><br>  Initially, to solve problems with the speed of loading issues, we decided to use the services of CDN.UA, which provides content delivery services in Ukraine.  By the way, the guys there work very professional and for our project they even made some specific settings on their servers, which allowed us to upload videos to our own HTML-5 player, rather than using the flash player that they offered initially.  At this stage, for Ukrainian viewers, the problems with viewing disappeared almost completely.  But for those who watched issues from Georgia, Israel and other countries, the delays didn‚Äôt go away.  Therefore, the next step was to transfer the video to the international content delivery network.  The choice fell on the Rackspace CDN, which in turn <a href="http://www.rackspace.com/knowledge_center/frequently-asked-question/how-can-i-use-akamais-cdn-with-cloud-files">uses the</a> world's largest network <a href="https://ru.wikipedia.org/wiki/Akamai_Technologies">Akamai</a> : <br><img src="https://habrastorage.org/files/e94/584/85b/e9458485b5ac4b5bbc5672df3b8a7775.png"><br><br>  In connection with the move to a new platform, we had to slightly update the video download program.  So if we uploaded video via FTP to CDN.UA, we now use to upload it to Rackspace <br><div class="spoiler">  <b class="spoiler_title">OpenStack SDK:</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> net.openstack.Core.Domain; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> net.openstack.Providers.Rackspace; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> NLog; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.IO; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Net; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> X.Media.Encoding; .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Upload</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> path</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> container = <span class="hljs-string"><span class="hljs-string">"Video"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> region = <span class="hljs-string"><span class="hljs-string">"DFW"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cloudIdentity = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CloudIdentity { Username = _settings.StorageUserName, Password = _settings.StoragePassword }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> contentType = ContentTypeManager.GetContentType(Path.GetExtension(path)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> name = Path.GetFileName(path); _logger.Info(String.Format(<span class="hljs-string"><span class="hljs-string">"Upload: {0} \t with content type: [{1}]"</span></span>, Path.GetFileName(path), contentType)); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stream = File.OpenRead(path)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cloudFilesProvider = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CloudFilesProvider(cloudIdentity, region, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); cloudFilesProvider.CreateObject(container, stream, name, contentType); _logger.Info(String.Format(<span class="hljs-string"><span class="hljs-string">"Uploaded: {0}"</span></span>, path)); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { _logger.WarnException(String.Format(<span class="hljs-string"><span class="hljs-string">"Error while uploading: {0}"</span></span>, path), ex); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre> <br></div></div><br><br>  After the video content was transferred to the CDN, it was the turn of the site.  Now the load on the web server is quite small compared to the loads that were originally when distributing video, but considering that the influx of visitors was uneven as before, it was decided to migrate the site to the cloud platform.  Now the site is deployed in Microsoft Azure in the service WebSites.  The site is supported by load balancing and automatic scaling of resources in case of a sudden increase in the number of visitors. <br><br>  From an interesting point, I would like to note that the site has two display modes - night and day, which automatically changes, depending on the time of day. <br><br><h4>  <font color="#ff9c00">‚ñå Project</font> development and support process </h4><br>  Although the project development team is small (initially there were 4 people, now only 2 people are actively involved in writing the code), it was decided to optimize the process of developing and publishing the project as much as possible.  We store the source code of the project in a Bitbucket private repository.  The project itself, as mentioned earlier, is hosted by the Azure Website.  And what makes us very happy, this service allows you to configure the process of automatic deployment of the project from GitHub and Bitbucket (in fact, the number of sources is much more, and even the <a href="http://blogs.technet.com/b/sams_blog/archive/2014/11/14/azure-websites-deploy-asp-net-website-using-dropbox.aspx">publication from Dropbox is</a> supported).  In azure, we have two websites: <br><ul><li>  <b>test</b> - deployment to which occurs from the <i>master</i> branch </li><li>  <b>production</b> - deployment to which comes from the <i>cloud</i> branch </li></ul><br><br><img src="https://habrastorage.org/files/9a1/f76/dbf/9a1f76dbf5124761bac5b1cbeff99597.png"><br><br>  When a new commit hits the corresponding brunch, an automatic build of the project takes place, and in case of its successful completion, a new version of the site is published.  In case, if for some reason the project was not successfully assembled in a cloudy environment, we can always see the reason for this by reviewing the deployment logs: <br><img src="https://habrastorage.org/files/13b/8eb/419/13b8eb4193894370be7df4cb85160ebc.png"><br><br>  However, for all the time, this opportunity was useful to us only once, during the initial deployment of the project in the cloud. <br><br><h4>  <font color="#ff9c00">‚ñå</font> Mobile customers </h4><br>  After a year after the start of the project, we realized that it would be more convenient for many viewers to watch the releases not only from the computer, but also using their smartphones.  It was decided to make a mobile client.  We have made three versions of mobile clients for three main mobile platforms: <br><ul><li>  Windows Phone - supported from version 7.8 and above </li><li>  iOS - supported from version 5 onwards </li><li>  Android - supported from version 4.1 and higher. </li></ul><br><br>  The logic of mobile clients is as simple as possible.  In the xml-format, they receive from the site information about releases of available programs and video releases.  Also, the url of the video file located in the CDN is sent to the mobile client, from where it later downloads the video. <br><br>  Also, the project has an ‚Äúinner voice‚Äù.  He communicates with those who installed the Peat TV mobile app on their smartphone.  Sometimes users come announcements of releases, and sometimes just interesting thoughts and expressions.  Works "internal voice" on the basis of Azure Mobile Services.  Since, at the time of the creation of the ‚Äúinner voice‚Äù, Mobile Services had only just been released, the logic was written in JavaScript.  Later, the ability to write the logic of mobile services in C # was added, but since everything works well, I could rewrite this piece of code from steel. <br><br>  Interestingly, at the moment, about half of the video views occur through mobile applications. <br><br><h4>  <font color="#ff9c00">‚ñå</font> Useful information </h4><br><ul><li>  <a href="http://torf.tv/">Peat tv</a> <br></li><li>  X.Media.Encoding library <a href="http://nuget.org/packages/xmediaencoding/">on nuget.org</a> <br></li><li>  X.Media.Encoding Library <a href="http://github.com/ernado-x/X.Media.Encoding">on GitHub</a> <br></li><li>  <a href="https://developer.rackspace.com/sdks/dot-net/">OpenStack SDK</a> <br></li></ul><br><br><h6>  <font color="#ff9c00">‚ñå</font> Notes </h6><br><ul><li>  The article uses fragments from the project description prepared by the hacus <a href="https://habrahabr.ru/users/marcusaurelius/" class="user_link">browser</a> Marcus <a href="https://habrahabr.ru/users/marcusaurelius/" class="user_link">Aurelius</a> </li><li>  JavaScript player for the project was developed by gelas <a href="https://habrahabr.ru/users/gelas/" class="user_link">habrauzer</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/185038/">https://habr.com/ru/post/185038/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../185022/index.html">QIWI Plastic for you - on special conditions</a></li>
<li><a href="../185030/index.html">Software raids: migration from Windows raid0 to Linux mdadm raid5</a></li>
<li><a href="../185032/index.html">Critical review of the study of the availability of Internet resources Runet</a></li>
<li><a href="../185034/index.html">Public beta Sublime Text 3 released</a></li>
<li><a href="../185036/index.html">About the fight against pirates and promotion in the Chinese market of Android applications</a></li>
<li><a href="../185044/index.html">MySQL bug got a birthday cake</a></li>
<li><a href="../185050/index.html">And once again about motivation</a></li>
<li><a href="../185052/index.html">The end-user internet connection speed is still to be taken into account.</a></li>
<li><a href="../185054/index.html">11 reasons to never undertake to hold an international programming championship</a></li>
<li><a href="../185060/index.html">Windows 8.1 Preview video review</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>