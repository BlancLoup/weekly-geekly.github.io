<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bylina about how I connected Drupal and Yandex.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago I had an idea to make a city site (of course, another one) for one small town based on Drupal. Just before this, Yandex expanded the fun...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bylina about how I connected Drupal and Yandex.</h1><div class="post__text post__text-html js-mediator-article">  Some time ago I had an idea to make a city site (of course, another one) for one small town based on Drupal.  Just before this, Yandex expanded the functionality of its Mail for Domains and added the ability to manage mailboxes through the API.  And the thought arose in my head: why not?  Why not give users the ability to simultaneously receive a mailbox in the city domain at the same time as registering on the city portal?  The idea itself, of course, is not surprising, but there were no ready-made solutions.  I never launched the site, and it's a sin to lay the code without doing anything. <br><br>  As you know, Drupal is positioned as a CMS, oriented developers and allowing through an extensive API to develop at least a system for managing the lunar base.  In my post, I will not go into her praise and the most basic principles of developing modules for Drupal, however, Drupal beginner developers will certainly find the material useful, and I will be grateful for the advice and recommendations. <br><br><img src="https://habrastorage.org/files/7cd/ab9/adb/7cdab9adbbdc4d6ea7c486fb2ac40025.png"><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Formulation of the problem </h4><br>  Naturally, starting to write a module, you need to decide what functionality it will have.  The module is designed for a social site where users can register.  Therefore, it must: <br><ul><li>  when registering a user, offer him the opportunity to create a box on Yandex; </li><li>  when confirming registration, initiate the creation of the box; </li><li>  display to the authorized user a block with information about the number of new letters and the ability to go to the box; </li><li>  create an admin part to enter the required parameters. </li></ul><br>  Of course, it would be possible to add some other bonuses (for example, change the password to the box when changing the password in our system, edit user data, manage forwarding), but this is more of an excess. <br><br><h4>  .info file </h4><br>  Any Drupal module must contain a .info file with service information about the module.  The minimum set is the name of the module, a brief description and the version of the kernel for which it was written.  But in our case, you need to specify another field - dependencies.  The logic of the module provides for the creation of mailboxes whose login matches the user login.  But in order not to deprive users of the ability to create Cyrillic logins and not to surprise Yandex, we need a transliteration module.  Thus, the yandex_pdd.info file will look like this: <br><br><pre><code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">name</span></span> = Yandex PDD description = Yandex PDD mailboxes autocreation. core = 7.x dependencies[] = transliteration</code> </pre> <br>  Naturally, before installing the module, you need to remember to install this very <a href="https://www.drupal.org/project/transliteration">transliteration</a> in yourself. <br><br><h4>  Install and uninstall file </h4><br>  Another required file is .install (in our case, yandex_pdd.install), which defines the database module used and the necessary actions when installing and removing the module.  To work we need one database and two variables.  First, <a href="https://api.drupal.org/api/drupal/modules%2521system%2521system.api.php/function/hook_schema/7">let's</a> define the base structure ( <a href="https://api.drupal.org/api/drupal/modules%2521system%2521system.api.php/function/hook_schema/7">hook_schema ()</a> ) <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">yandex_pdd_schema</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $schema[<span class="hljs-string"><span class="hljs-string">'yandex_pdd'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'fields'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'serial'</span></span>, <span class="hljs-string"><span class="hljs-string">'not null'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>), <span class="hljs-comment"><span class="hljs-comment">//   'uid' =&gt; array('type' =&gt; 'int', 'unsigned' =&gt; TRUE, 'not null' =&gt; TRUE, 'default' =&gt; 0,), //   'login' =&gt; array('type' =&gt; 'varchar', 'length' =&gt; 100, 'not null' =&gt; TRUE), //      'activated' =&gt; array('type' =&gt; 'varchar', 'length' =&gt; 1, 'not null' =&gt; TRUE) //    ), 'primary key' =&gt; array('id'), ); return $schema; }</span></span></code> </pre> <br>  The first two columns, I think, do not cause questions.  In the third column, we will record the login of the e-mail box itself.  The fourth column should be disassembled separately.  In CMS Drupal, to activate a user, it is necessary that he follow the link sent to him by e-mail and set his password.  The well-known fact that part of the accounts will never be activated (part of the spam bots and just strange people), because it makes sense to create a box when the user sets a new password.  Actually, this at the same time allows us to create a box with the same password.  I will touch upon this question below. <br><br>  When a module is removed, the bases described in the diagram are automatically deleted.  But variables, cached data, etc.  it should be removed by <a href="https://api.drupal.org/api/drupal/modules%2521system%2521system.api.php/function/hook_uninstall/7">hook_uninstall ()</a> . <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">yandex_pdd_uninstall</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ variable_del(<span class="hljs-string"><span class="hljs-string">'yandex_pdd_domain'</span></span>); variable_del(<span class="hljs-string"><span class="hljs-string">'yandex_pdd_authtoken'</span></span>); cache_clear_all(<span class="hljs-string"><span class="hljs-string">'yandex_pdd'</span></span>,<span class="hljs-string"><span class="hljs-string">'cache'</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>); menu_rebuild(); }</code> </pre> <br>  The parameters <i>yandex_pdd_domain</i> and <i>yandex_pdd_authtoken</i> specify the domain in which the boxes will be created, and the API key, respectively.  I will tell about them in more detail later. <br><br>  The necessary foundation for the work of the module has been laid, and we can start writing the module code itself.  We will have it, as it should be, in the file with the .module extension (yandex_pdd.module). <br><br><h4>  Menu items </h4><br>  If the Drupal module needs to be registered in the menu, create any pages, etc., we need to describe the entire structure and the necessary actions when following links using the <a href="https://api.drupal.org/api/drupal/modules%2521system%2521system.api.php/function/hook_menu/7">hook_menu ()</a> hook.  In our case, two URLs will be used: the module settings page and the redirection to the mailbox. <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">yandex_pdd_menu</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ $items = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); $items[<span class="hljs-string"><span class="hljs-string">'admin/config/content/yandex_pdd'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-comment"><span class="hljs-comment">//   -     'title' =&gt; t('Yandex PDD'), // &lt;title&gt;  'page callback' =&gt; 'main_config', // ,      'type' =&gt; MENU_NORMAL_ITEM, //       CMS 'access callback' =&gt; TRUE, //      ); $items['mailbox'] = array( 'title' =&gt; 'Yandex PDD login', 'page callback' =&gt; 'mailbox_login', 'type' =&gt; MENU_CALLBACK, 'access callback' =&gt; TRUE, ); return $items; }</span></span></code> </pre> <br>  Note the use of the <a href="https://api.drupal.org/api/drupal/includes%2521bootstrap.inc/function/t/7">t ()</a> system function.  It allows you to translate text elements into the current system language.  And yes, on the <i>mailbox</i> page we don‚Äôt need this feature. <br><br><h4>  Setup page </h4><br>  In the previous section, we told our CMS that the page for entering the data needed by the module will be placed along the path <i>admin / config / content / yandex_pdd</i> and processed by the <i>main_config</i> function.  Actually, the CMS does not really know what the page will actually do, but it knows that when accessing this path you need to access this function. <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main_config</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ $form = drupal_get_form(<span class="hljs-string"><span class="hljs-string">'pdd_config_form'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    $form = drupal_render($form); //   return $form; }</span></span></code> </pre> <br>  To create a page, we get a drupalo-understandable array of form fields by calling the system function <a href="https://api.drupal.org/api/drupal/includes%2521form.inc/function/drupal_get_form/7">drupal_get_form ()</a> to the user function <i>pdd_config_form</i> . <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pdd_config_form</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($form, &amp;$form_state)</span></span></span></span>{ $form=<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); $form[<span class="hljs-string"><span class="hljs-string">'pdd_domain'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-comment"><span class="hljs-comment">//   -     '#type' =&gt; 'textfield', //   '#title' =&gt; t('Domain zone'), //  ,   '#description' =&gt; t('A domain zone in which email should be created.'), //   '#default_value' =&gt; variable_get('yandex_pdd_domain'), //    '#required' =&gt; 1, //   ); $form['authtoken'] = array( '#type' =&gt; 'textfield', '#title' =&gt; t('Auth Token'), '#description' =&gt; t('Authorization token obtained at Yandex.PDD service.'), '#default_value' =&gt; variable_get('yandex_pdd_authtoken'), '#required' =&gt; 1, ); $form['submit'] = array( '#type' =&gt; 'submit', '#value' =&gt; t('Submit'), ); return $form; }</span></span></code> </pre> <br>  The result is passed to the <a href="https://api.drupal.org/api/drupal/includes%2521common.inc/function/drupal_render/7">drupal_render ()</a> function, which assembles the array into the ready html-code of the page. <br><br>  The form contains only two fields: <br><ul><li>  <i>pdd_domain</i> - domain tied to Yandex.PDD in which the boxes will be created; </li><li>  <i>authtoken</i> is an authentication token obtained in the Mail API settings for the domain. </li></ul><br><img src="https://habrastorage.org/files/761/f67/678/761f67678913429da27fb0b6bf6fd6ff.png"><br><br>  Naturally, the results of filling out the form we need to save.  The <i>pdd_config_form_submit</i> function is responsible for this, which simply saves the field values ‚Äã‚Äãto system variables. <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pdd_config_form_submit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($form, &amp;$form_state)</span></span></span></span>{ variable_set(<span class="hljs-string"><span class="hljs-string">'yandex_pdd_domain'</span></span>, $form_state[<span class="hljs-string"><span class="hljs-string">'values'</span></span>][<span class="hljs-string"><span class="hljs-string">'pdd_domain'</span></span>]); variable_set(<span class="hljs-string"><span class="hljs-string">'yandex_pdd_authtoken'</span></span>, $form_state[<span class="hljs-string"><span class="hljs-string">'values'</span></span>][<span class="hljs-string"><span class="hljs-string">'authtoken'</span></span>]); }</code> </pre> <br>  Another small piece of code is the <a href="https://api.drupal.org/api/drupal/modules%2521system%2521system.api.php/function/hook_help/7">hook_help ()</a> implementation, which displays help information about the module in the corresponding section of the admin part.  Regarding this feature, I did not bother and followed the path of minimalism. <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">yandex_pdd_help</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($path, $arg)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> ($path) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"admin/help#yandex_pdd"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;p&gt;'</span></span>. t(<span class="hljs-string"><span class="hljs-string">"Yandex PDD mailboxes management module."</span></span>) .<span class="hljs-string"><span class="hljs-string">'&lt;/p&gt;'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }</code> </pre> <br>  Dealt with the administrative part.  It's time to do custom, all the functionality of which can be divided into the stage of creation and stage of work. <br><br><h4>  Creating a box </h4><br>  Not all of our users may need another e-mail, even in the domain of their favorite site.  Yes, and we have nothing to produce a huge number of unused boxes.  Therefore, we will add a checkbox to the user‚Äôs registration form, which will allow him to choose whether to create a box or not.  Any form in Drupal can be changed using <a href="https://api.drupal.org/api/drupal/modules%2521system%2521system.api.php/function/hook_form_alter/7">hook_form_alter ()</a> .  With the appointment of some elements of the form description array, we are already familiar.  More details on all the others can be found <a href="https://api.drupal.org/api/drupal/developer%2521topics%2521forms_api_reference.html/7">on the forms help page</a> . <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">yandex_pdd_form_alter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;$form, &amp;$form_state, $form_id)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($form_id==<span class="hljs-string"><span class="hljs-string">'user_register_form'</span></span>){ <span class="hljs-comment"><span class="hljs-comment">//    $form['account']['createmail']=array( //    '#type' =&gt; 'checkbox', '#title' =&gt; t('Create a mailbox'), '#description' =&gt; t('Check this box if you want to create a mailbox @'.variable_get('yandex_pdd_domain').'.'), '#required' =&gt; 0, '#access' =&gt; 1, //     '#weight' =&gt; 10 //  ( ) ); } }</span></span></code> </pre> <br>  A lot of text for one small checkbox. <br><img src="https://habrastorage.org/files/96d/c36/d61/96dc36d61fc24dbb85da9576b4c06b1a.png"><br>  When registering a user, we check whether the checkbox for creating a box in the form is checked, and if so, enter in the table information about the inactive box. <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">yandex_pdd_user_insert</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;$edit, $account, $category)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($account-&gt;createmail){ $transliterated = transliteration_get($account-&gt;name, <span class="hljs-string"><span class="hljs-string">'_'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   $pattern = '/[^a-zA-Z0-9]/'; //     ,     $transliterated = preg_replace($pattern, '-', $transliterated); //    alphanumeric    $newbox = db_insert('yandex_pdd'); //      $newbox-&gt;fields(array('uid' =&gt; $account-&gt;uid, 'login' =&gt; strtolower($transliterated), 'activated' =&gt; '0')); //     $res = $newbox-&gt;execute(); //   watchdog('yandex_pdd',print_r('Res: '.$res,1)); //       CMS  } }</span></span></code> </pre> <br>  Creating a box is bound to a form change with user data by hook <a href="https://api.drupal.org/api/drupal/modules%2521field%2521field.api.php/function/hook_field_attach_submit/7">hook_field_attach_submit ()</a> .  Thus, before the user first edits the data (changing the password), the box is not created. <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">yandex_pdd_field_attach_submit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($entity_type, $entity, $form, &amp;$form_state)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> $user; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($entity_type == <span class="hljs-string"><span class="hljs-string">'user'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> $user-&gt;uid &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//      user $select = db_select('yandex_pdd','ypdd'); $select-&gt;addField('ypdd', 'id'); $select-&gt;addField('ypdd', 'login'); $select-&gt;addField('ypdd', 'activated'); $select-&gt;condition('uid', $user-&gt;uid); $entries = $select-&gt;execute()-&gt;fetchAssoc(); //        if (array_key_exists('login', $entries) and $entries['login'] != '' and $entries['activated'] == 0) { //         $mailboxcreate = simplexml_load_file('https://pddimp.yandex.ru/reg_user_token.xml?token='.variable_get('yandex_pdd_authtoken').'&amp;u_login='.$entries['login'].'&amp;u_password='.$form["#user"]-&gt;pass); //     XML- if ($mailboxcreate-&gt;ok[0]) { //   $num_updated = db_update('yandex_pdd'); $num_updated-&gt;fields(array('activated' =&gt; '1')); $num_updated-&gt;condition('uid', $user-&gt;uid); $res = $num_updated-&gt;execute(); //     } elseif ($mailboxcreate-&gt;error[0]) { //   API foreach($mailboxcreate-&gt;error[0]-&gt;attributes() as $key =&gt; $value) { $mbc[$key] = (string)$value; } watchdog('yandex_pdd',"Can't create new mailbox. Reason: ".$mbc['reason']); //     } else { //      watchdog('yandex_pdd','Unknown error while creating mailbox.'); //    } } } }</span></span></code> </pre> <br>  Finally, our user received the box, although he doesn‚Äôt really know how to get there.  It remains to implement the functionality of the transition to the post. <br><br><h4>  Working functionality </h4><br>  Actually, there are only two user functions: display the block and log in by mail.  The block must first be described by hook <a href="https://api.drupal.org/api/drupal/modules%2521block%2521block.api.php/function/hook_block_info/7">hook_block_info ()</a> <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">yandex_pdd_block_info</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $blocks[<span class="hljs-string"><span class="hljs-string">'mailbox_status'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-comment"><span class="hljs-comment">//    'info' =&gt; t('Mailbox status'), //    'cache' =&gt; DRUPAL_CACHE_PER_ROLE, //   ); return $blocks; }</span></span></code> </pre> <br>  For the block, we still need to set the theme and the file with the formatting template.  The theme is described by hook <a href="https://api.drupal.org/api/drupal/modules%2521system%2521system.api.php/function/hook_theme/7">hook_theme ()</a> , which describes the implementation of the design of the elements of the module, which is described by the system. <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">yandex_pdd_theme</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'yandex_pdd_block'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-comment"><span class="hljs-comment">//    'variables' =&gt; array( //    'newmail' =&gt; NULL ), 'template' =&gt; 'yandex-pdd-block', //    ) ); }</span></span></code> </pre> <br>  And, actually, the file <i>yandex-pdd-block.tpl.php</i> . <br><br><pre> <code class="php hljs">&lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">yandexpdd</span></span></span><span class="hljs-class">"&gt;&lt;?</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">php</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">print</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">You</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">have</span></span></span><span class="hljs-class"> ').'&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">href</span></span></span><span class="hljs-class">="/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mailbox</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">target</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_blank</span></span></span><span class="hljs-class">"&gt;'.$</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">newmail</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">(' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messages</span></span></span><span class="hljs-class">').'&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">&gt;.'; ?&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt;</span></span></code> </pre> <br>  For the block, we need to get a single value via the API - the number of new letters, then render the block itself by hook <a href="https://api.drupal.org/api/drupal/modules%2521block%2521block.api.php/function/hook_block_view/7">hook_block_view ()</a> <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">yandex_pdd_block_view</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($delta = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> $user; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($user-&gt;uid &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// ,    $select = db_select('yandex_pdd','ypdd'); $select-&gt;addField('ypdd', 'login'); $select-&gt;condition('uid', $user-&gt;uid); $entries = $select-&gt;execute()-&gt;fetchAssoc(); //    $unreadmailxml = simplexml_load_file('https://pddimp.yandex.ru/get_mail_info.xml?token='.variable_get('yandex_pdd_authtoken').'&amp;login='.$entries['login']); //       if ($unreadmailxml-&gt;ok[0]) { //    foreach($unreadmailxml-&gt;ok[0]-&gt;attributes() as $key =&gt; $value) { //   $unreadmail[$key] = (string)$value; } $blocks = array(); $blocks['subject'] = null; $blocks['content'] = theme('yandex_pdd_block', array('newmail' =&gt; $unreadmail['new_messages'])); return $blocks; //   } elseif ($unreadmailxml-&gt;error[0]) { foreach($unreadmailxml-&gt;error[0]-&gt;attributes() as $key =&gt; $value) { $unreadmail[$key] = (string)$value; } watchdog('yandex_pdd',"Can't get new mail info. Reason: ".$unreadmail['reason']); } else { watchdog('yandex_pdd','Unknown error while loading new mail info'); } } }</span></span></code> </pre> <br>  The generated block will look something like this. <br><br><img src="https://habrastorage.org/files/b55/ba7/3af/b55ba73aff844f5187572a755ee861c7.png"><br><br>  The final touch is the system link <i>mailbox</i> , which will transfer the user to the Yandex.Mail page and authorize by a one-time token.  As we remember (or no longer remember), we previously specified that this link should be processed by the <i>mailbox_login</i> function.  The life time of the token is only 30 seconds, because after receiving it, the user should immediately be redirected to the login page. <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mailbox_login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> $user; <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> $base_url; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($user-&gt;uid &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { $select = db_select(<span class="hljs-string"><span class="hljs-string">'yandex_pdd'</span></span>,<span class="hljs-string"><span class="hljs-string">'ypdd'</span></span>); $select-&gt;addField(<span class="hljs-string"><span class="hljs-string">'ypdd'</span></span>, <span class="hljs-string"><span class="hljs-string">'login'</span></span>); $select-&gt;condition(<span class="hljs-string"><span class="hljs-string">'uid'</span></span>, $user-&gt;uid); $entries = $select-&gt;execute()-&gt;fetchAssoc(); $tokenxml = simplexml_load_file(<span class="hljs-string"><span class="hljs-string">'https://pddimp.yandex.ru/api/user_oauth_token.xml?token='</span></span>.variable_get(<span class="hljs-string"><span class="hljs-string">'yandex_pdd_authtoken'</span></span>).<span class="hljs-string"><span class="hljs-string">'&amp;domain='</span></span>.variable_get(<span class="hljs-string"><span class="hljs-string">'yandex_pdd_domain'</span></span>).<span class="hljs-string"><span class="hljs-string">'&amp;login='</span></span>.$entries[<span class="hljs-string"><span class="hljs-string">'login'</span></span>]); <span class="hljs-comment"><span class="hljs-comment">//     if ($tokenxml-&gt;xpath('status/success')) { $tokenarr = $tokenxml-&gt;xpath('domains/domain/email/oauth-token'); header('Location: http://passport.yandex.ru/passport?mode=oauth&amp;type=trusted-pdd-partner&amp;error_retpath='.urlencode($base_url.'/').'&amp;access_token='.(string)$tokenarr[0]); //    . drupal_exit(); //     CMS } elseif ($tokenxml-&gt;xpath('status/error')) { watchdog('yandex_pdd',"Can't get short-term auth token info. Reason: ".(string)$tokenxml-&gt;xpath('action/status/error')); } } }</span></span></code> </pre> <br><br><h4>  Conclusion </h4><br>  Here and I will say the end.  Placed pieces of code compiled according to the specified file names should give you a complete module.  I hope it will be useful to someone, and I will be happy to hear comments and recommendations on the code. </div><p>Source: <a href="https://habr.com/ru/post/245117/">https://habr.com/ru/post/245117/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../245101/index.html">A bit about the technology Forward Error Correction</a></li>
<li><a href="../245103/index.html">Equip a hamster or ‚ÄúOpenWrt does firmware from TP-LINK?‚Äù. Part 1 - preparatory</a></li>
<li><a href="../245107/index.html">Bash free space monitoring service</a></li>
<li><a href="../245109/index.html">Announcement of new features Typescript 1.4</a></li>
<li><a href="../245113/index.html">Mobile phones and total NSA surveillance: how it works</a></li>
<li><a href="../245119/index.html">Do not worry, we will look after them. Integration of Zabbix into the client‚Äôs personal account</a></li>
<li><a href="../245121/index.html">The way of the developer: stories about my fabulous failures, part 2</a></li>
<li><a href="../245123/index.html">Oracle, SQL * Net or ORDER BY saves network resources ...</a></li>
<li><a href="../245125/index.html">The Germans have created a library of drunken audio recordings.</a></li>
<li><a href="../245127/index.html">Fujitsu Optimized Server Solution for VMware EVO: RAIL</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>