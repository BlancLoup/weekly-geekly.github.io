<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OpenVPN, about which you knew so little</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="OpenVPN, as much in this word. A multiplatform, flexible, customizable, free open-source VPN server that is actually the "defacto" standard for access...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>OpenVPN, about which you knew so little</h1><div class="post__text post__text-html js-mediator-article"><p>  OpenVPN, as much in this word.  A multiplatform, flexible, customizable, free open-source VPN server that is actually the "defacto" standard for accessing internal corporate networks.  Most administrators use it with default settings or with typical configurations widely described in different HOW-TO.  But is OpenVPN as simple as it seems at first glance?  In this article, we will look at the internal OpenVPN mechanisms that are hidden from view, which radically change the perception of its capabilities. </p><a name="habracut"></a><br><p>  <a href="http://openvpn.net/">OpenVPN</a> server is distributed as <a href="https://github.com/OpenVPN/openvpn">source code</a> or ready-to-install <a href="https://openvpn.net/community-downloads/">compiled packages</a> for various operating systems.  OpenSSL is used as an encryption library. </p><br><p>  Most of the configurations for connecting clients to the server, as well as between servers, involve the use of a bunch of private or private / public keys to ensure the security of internal traffic.  Corporate networks in MultiPoint-To-SinglePoint mode typically use their own PKI certificate authority, which is easily built using either <a href="https://openvpn.net/community-resources/rsa-key-management/">easy-rsa</a> or <a href="https://sourceforge.net/projects/xca/">XCA</a> .  For inter-communication point-to-point communication, the common key configuration is used mainly.  Recall the main, well-known mechanisms and opportunities. </p><br><h1 id="osnovnye-mehanizmy-i-vozmozhnosti">  Basic mechanisms and capabilities </h1><br><ul><li><h3 id="sertifikatnaya-autentifikaciya">  Certificate Authentication </h3><br><p>  About her written a huge amount of documentation.  The bottom line is simple.  It creates its own certificate authority, which issues user certificates.  With the help of a certificate authority, control over the connection of users to the OpenVPN server is provided.  When the certificate expires or is revoked, user access is blocked.  Private keys with a password set on them, issued together with a certificate, provide security from unauthorized connection to internal resources. </p><br></li><li><h3 id="privatnye-point-to-point-klyuchi">  Private point-to-point keys </h3><br><p>  From the point of view of connecting to the company's resources only one user / server, a scheme with private keys is used.  On one of the hosts a key is generated, which is common for the server and the client. </p><br></li></ul><br><p>  In all cases, the connection for the security handshake handshake between the client and the server uses the Diffie-Hellmann protocol. </p><br><ul><li><h3 id="vneshnyaya-autentifikaciya-polzovateley">  External user authentication </h3><br><p>  To simplify control over the connection of users, instead of a scheme with its own PKI, you can use a scheme <a href="https://community.openvpn.net/openvpn/wiki/HOWTO">with external user authentication by login / password</a> .  This scheme is convenient for user authentication, say, using a domain login / password.  To connect to the server, the server certificate and the signing key of the transmitted packets <a href="https://openvpn.net/community-resources/how-to/">HARDENING OPENVPN SECURITY</a> is added to the client configuration file. <br>  example of client config </p><br><pre><code class="plaintext hljs">dev tun proto udp #  IP  OpenVPN remote 172.16.111.166 # Port  port 1200 client resolv-retry infinite tls-client key-direction 1 auth SHA1 cipher BF-CBC #comp-lzo persist-key persist-tun # auth-user-pass c:/temp/pass.txt # # just create a file with name pass.txt # and put to it two lines # ------------- #username #password # ------------- #auth-user-pass verb 3 &lt;ca&gt; -----BEGIN CERTIFICATE----- MIIE5jCCA86gAwIBAgIJAOt3kFH7PxA0MA0GCSqGSIb3DQEBCwUAMIGjMQswCQYD .... -----END CERTIFICATE----- &lt;/ca&gt; &lt;tls-auth&gt; -----BEGIN OpenVPN Static key V1----- 83ddd29fa82212f3059d85a41490134c .... a4f2c7df3a22364a49093bca102dedeb -----END OpenVPN Static key V1----- &lt;/tls-auth&gt;</code> </pre> <br><p>  Part of server config for client authentication via file <br>  <a href="https://openvpn.net/community-resources/how-to/">Using alternative authentication methods</a> </p><br><pre> <code class="plaintext hljs">verify-client-cert none #client-cert-not-required username-as-common-name tls-server tls-auth /usr/local/etc/openvpn/ssl/tlsauth.key key-direction 0 tls-timeout 120 auth SHA1 cipher BF-CBC auth-user-pass-verify /usr/local/etc/openvpn/auth/auth-static-file.pl via-file</code> </pre> <br><p>  This scheme is convenient, but very unsafe. </p><br></li><li><h3 id="pam">  Pam </h3><br><p>  To enhance security, you can use plug-ins that provide login / password verification in external systems.  The most common method is system PAM (Pluggable Authentication Modules). <br>  Add the line to the OpenVPN configuration file. </p><br><pre> <code class="plaintext hljs">plugin /usr/share/openvpn/plugin/lib/openvpn-auth-pam.so login</code> </pre> <br></li><li><h3 id="marshrutizaciya">  Routing </h3><br><p>  Since  The main task of the server is to provide access of remote users / servers to internal resources, the server allows defining static routing from clients to the server and from the server to clients.  From the point of view of client access to internal resources, the server using DHCP and the directives "route" or "push route" allows you to transfer routes to internal networks to the client.  To notify the server itself about remote networks on the client side, use the "client config dir" (ccd), a mechanism that allows using the "iroute" directive to describe the list of client's internal networks that should go to the server's routing table in order to transit traffic to them. </p><br></li></ul><br><p>  At this "regular" widely used features end and local customization begins for each specific case. </p><br><h1 id="dopolnitelnye-vozmozhnosti-openvpn">  Additional OpenVPN features </h1><br><p>  Consider the additional features of OpenVPN, about which someone may have heard, but in reality did not see or did not use. </p><br><ul><li><h3 id="bezopasnost-seteypacket-filtering">  Network Security / Packet Filtering </h3><br><p>  Since  OpenVPN routes traffic, it has two regular mutually exclusive modes of operation.  The first mode is the routing inside the OpenVPN server, the second mode is the inter-interface nuclear routing.  In the first case, OpenVPN itself is responsible for switching and filtering packets between clients / networks, in the second case any system packet filter supported on the host (pf, iptables, etc). <br>  Few people know that OpenVPN has a built-in packet filter that allows you to allow or isolate connections between users and networks. <br>  Yes Yes.  You read it right.  OpenVPN has its own built-in packet filter.  The ability to filter traffic was <a href="https://backreference.org/2010/06/18/openvpns-built-in-packet-filter/">implemented back in 2010</a> . <br>  <a href="https://openvpn.net/community-resources/management-interface/">The OpenVPN packet filter is</a> managed either through the management interface or via plugins connected to OpenVPN. <br>  Managing traffic rules occurs through the file.  The file format is simple. </p><br><pre> <code class="plaintext hljs">[CLIENTS DROP|ACCEPT] {+|-}common_name1 {+|-}common_name2 . . . [SUBNETS DROP|ACCEPT] {+|-}subnet1 {+|-}subnet2 . . . [END]</code> </pre> <br><p>  Block directives (ACCEPT / DENY) set the default action for all clients not specified inside the block. <br>  For example, the file for client user2 </p><br><pre> <code class="plaintext hljs">[CLIENTS DROP] +user1 [SUBNETS DROP] [END]</code> </pre> <br><p>  will block traffic to all users and networks, but will allow traffic towards the client user1.  If user1 does not explicitly describe the resolution of sending traffic to user2, then traffic will only go in one direction user2-&gt; user1. </p><br></li></ul><br><p>  Or another example. <br>  Disable everything except access between users and a DNS server located on the local network and a test circuit on the network 192.168.0.0/24 </p><br><pre> <code class="plaintext hljs">[CLIENTS DROP] +user1 +user2 [SUBNETS DROP] +10.150.0.1 +10.150.1.1 +192.168.0.0/24 [END]</code> </pre> <br><p>  The filtering mechanism is activated via the configuration file, or when connecting the plugin that has set the flag "OPENVPN_PLUGIN_ENABLE_PF". <br>  We will discuss this opportunity later. <br>  The second traffic filtering mode is a packet filter built into the system.  To activate it, the "client-to-client" directive should not be in the config.  From the point of view of automating the on / off of the necessary rules when connecting / disconnecting clients, it is most convenient to use separate inserts into the list of rules implemented either through CHAINS in Iptables (Linux) or in Anchors in PF (FreeBSD).  Activation / deactivation of rules is usually carried out through client-connect / client-disconnect directives in the server configuration file, which cause corresponding scripts when a user connects / disconnects. </p><br><ul><li><h3 id="rasshirennaya-pam-autentifikaciya">  Extended PAM authentication </h3><br><p>  Under the extended PAM authentication means changing the logic of the user login and password verification.  This is achieved either by installing the appropriate plug-ins for OpenVPN, which provide reading and verification of data in external sources, or by connecting libraries to the system allowing scripts of any logic.  One of such libraries is <a href="https://sourceforge.net/p/pam-python/code/ci/default/tree/">pam_python</a> , which helps to script any login / password verification logic through Python scripts. <br>  In the case of its use, the user verification string is changed as follows. </p><br><pre> <code class="plaintext hljs">plugin openvpn-plugin-auth-pam.so pam_python login USERNAME password PASSWORD domain mydomain.com</code> </pre> <br><p>  Since PAM is under the hood of the system‚Äôs dialogues with the user or external libraries, these dialogs can be managed.  For example, <a href="https://github.com/LinOTP/linotp-auth-pam-python">connect OTP tokens to the system</a> .  The LinOTP library is taken just for example, since  I lost somewhere ¬Ø \ <em>()</em> / ¬Ø my own self-written library written during testing <br>  Also, examples are easy to glance at the word "pam_python". <br>  The main problem when working with external PAM modules is the inability to get the OpenVPN session environment inside the called Python or any other script called via the system pam.  Those.  The script provides only those functions for checking the login / password that are assigned to it. </p><br></li><li><h3 id="otlozhennaya-autentifikaciya">  "Delayed" authentication </h3><br><p>  The OpenVPN server supports so-called "pending" authentication.  "Delayed" authentication is used in cases where the authentication service cannot service a login / password verification request in real time. </p><br></li><li><h3 id="plaginy-openvpn">  OpenVPN Plugins </h3><br><p>  This is a separate parallel universe, about which they may be known, but because of some entanglement they are not able or afraid to use.  Yes indeed, writing a functional plugin for OpenVPN requires programming in C with all the consequences.  <a href="https://github.com/OpenVPN/openvpn/tree/master/sample/sample-plugins/simple">Examples of simple plugins are included in the source OpenVPN tree</a> or, for example, there is a <a href="https://github.com/OpenVPN/openvpn/tree/master/sample/sample-plugins/log">plugin to demonstrate the invocation of methods from OpenVPN</a> . </p><br></li></ul><br><p>  Let's try to understand how plugins work on the part of OpenVPN. <br>  Functions and parameters used for working with plugins are described in a separate <a href="">file.</a> <br>  The main task of the plug-in, when it is initialized by the OpenVPN server, is to transfer the list of functions supported by the plug-in and, when calling any of the functions, return the correct response code that will be understood by the server. </p><br><pre> <code class="plaintext hljs">#define OPENVPN_PLUGIN_FUNC_SUCCESS 0 #define OPENVPN_PLUGIN_FUNC_ERROR 1 #define OPENVPN_PLUGIN_FUNC_DEFERRED 2</code> </pre> <br><p>  Let us dwell on each group.  The logic of the work we will consider on the basis of user password authentication. <br>  When the server starts, after reading the configuration file, the server calls the OPENVPN_PLUGIN_UP and OPENVPN_PLUGIN_ROUTE_UP functions.  In the variable environment of the called functions, the main parameters of the running server are passed. </p><br><pre> <code class="json hljs">OPENVPN_PLUGIN_UP { <span class="hljs-attr"><span class="hljs-attr">"route_netmask_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_start_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"1545994898"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_remote"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.139"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script_context"</span></span>:<span class="hljs-string"><span class="hljs-string">"init"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/openvpn/server150.conf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"link_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1622"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_local"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tun_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1500"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verb"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_pid"</span></span>:<span class="hljs-string"><span class="hljs-string">"626"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_vpn_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proto_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_log_redirect"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_net_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_gateway_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"remote_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pluginid"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_network_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.0"</span></span> }</code> </pre> <br><pre> <code class="json hljs">OPENVPN_PLUGIN_ROUTE_UP { <span class="hljs-attr"><span class="hljs-attr">"route_netmask_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_start_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"1545994898"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_remote"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.139"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script_context"</span></span>:<span class="hljs-string"><span class="hljs-string">"init"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/openvpn/server150.conf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"link_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1622"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_local"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tun_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1500"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verb"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_pid"</span></span>:<span class="hljs-string"><span class="hljs-string">"626"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_vpn_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proto_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_log_redirect"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_net_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_gateway_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"remote_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pluginid"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_network_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.0"</span></span> }</code> </pre> <br><p>  These functions can be used for notifications when starting the server or changing the configuration. <br>  When a client connects, OpenVPN requests the ability to activate an internal packet filter. </p><br><pre> <code class="json hljs">OPENVPN_PLUGIN_ENABLE_PF { <span class="hljs-attr"><span class="hljs-attr">"route_netmask_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_start_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"1545994898"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_remote"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.139"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script_context"</span></span>:<span class="hljs-string"><span class="hljs-string">"init"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/openvpn/server150.conf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"link_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1622"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pf_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_pf_b7a18ca8fac838679ca87ada6b8a356.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_local"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tun_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1500"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verb"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_pid"</span></span>:<span class="hljs-string"><span class="hljs-string">"626"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_vpn_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proto_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_net_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_log_redirect"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_gateway_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"remote_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pluginid"</span></span>:<span class="hljs-string"><span class="hljs-string">"11"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_network_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.0"</span></span> }</code> </pre> <br><p>  As you can see from the dump, the variable pf_file appeared.  This file should contain the internal packet filter rules for the current session being processed. <br>  Next, check the username and password of the user in the function OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY </p><br><pre> <code class="json hljs">OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY { <span class="hljs-attr"><span class="hljs-attr">"route_netmask_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_gateway_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_NCP"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUB"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_start_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"1545994898"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_remote"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4v2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.139"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script_context"</span></span>:<span class="hljs-string"><span class="hljs-string">"init"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.111.168"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/openvpn/server150.conf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>:<span class="hljs-string"><span class="hljs-string">"fa56bf61-90da-11e8-bf33-005056a12a82-1234568"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"link_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1622"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pf_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_pf_b7a18ca8fac838679ca87ada6b8a356.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_local"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tun_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1500"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auth_control_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_acf_a3d0650a43b88ca1b5f305ce2c8f682.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUBv2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verb"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PLAT"</span></span>:<span class="hljs-string"><span class="hljs-string">"win"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_pid"</span></span>:<span class="hljs-string"><span class="hljs-string">"626"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>:<span class="hljs-string"><span class="hljs-string">"12312312312312"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_vpn_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proto_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_net_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PROTO"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_log_redirect"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_VER"</span></span>:<span class="hljs-string"><span class="hljs-string">"2.4.3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZO"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"remote_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pluginid"</span></span>:<span class="hljs-string"><span class="hljs-string">"5"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_TCPNL"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_network_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.0"</span></span> }</code> </pre> <br><p>  This is the only place where the password in a variable environment is present in the clear. <br>  The result of this function should be three response options. </p><br><pre> <code class="plaintext hljs">#define OPENVPN_PLUGIN_FUNC_SUCCESS 0 #define OPENVPN_PLUGIN_FUNC_ERROR 1 #define OPENVPN_PLUGIN_FUNC_DEFERRED 2</code> </pre> <br><p>  If the server receives the response OPENVPN_PLUGIN_FUNC_DEFERRED, then the mechanism of "delayed" authentication comes into play.  As we can see, the variable "auth_control_file" appeared in the variable environment, the contents of this variable contain the name of the file in which the response from the authentication system will be expected.  The answer is the character 0 placed in the specified file (to allow access), 1 (to deny access).  The server parameter "hand-window" determines the timeout in seconds during which the server will wait for a response.  While waiting for traffic from other clients is not interrupted. </p><br><p>  Since we work with password authentication, the certificate verification function OPENVPN_PLUGIN_TLS_VERIFY is not called.  Instead, OPENVPN_PLUGIN_TLS_FINAL is immediately called, confirming session establishment. </p><br><pre> <code class="json hljs">OPENVPN_PLUGIN_TLS_FINAL { <span class="hljs-attr"><span class="hljs-attr">"route_netmask_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_gateway_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_NCP"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUB"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_start_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"1545994898"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_remote"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4v2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.139"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script_context"</span></span>:<span class="hljs-string"><span class="hljs-string">"init"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.111.168"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/openvpn/server150.conf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>:<span class="hljs-string"><span class="hljs-string">"fa56bf61-90da-11e8-bf33-005056a12a82-1234568"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"link_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1622"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pf_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_pf_b7a18ca8fac838679ca87ada6b8a356.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_local"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tun_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1500"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auth_control_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_acf_a3d0650a43b88ca1b5f305ce2c8f682.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUBv2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verb"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PLAT"</span></span>:<span class="hljs-string"><span class="hljs-string">"win"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_pid"</span></span>:<span class="hljs-string"><span class="hljs-string">"626"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_vpn_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proto_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_net_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PROTO"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_log_redirect"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_VER"</span></span>:<span class="hljs-string"><span class="hljs-string">"2.4.3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZO"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"remote_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pluginid"</span></span>:<span class="hljs-string"><span class="hljs-string">"10"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_TCPNL"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_network_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.0"</span></span> }</code> </pre> <br><p>  Next, the OPENVPN_PLUGIN_IPCHANGE call is triggered, which is called before changing the client's ip address. </p><br><pre> <code class="json hljs">OPENVPN_PLUGIN_IPCHANGE { <span class="hljs-attr"><span class="hljs-attr">"route_netmask_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_gateway_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"trusted_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.111.168"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"link_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1622"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUB"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_start_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"1547319280"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"common_name"</span></span>:<span class="hljs-string"><span class="hljs-string">"fa56bf61-90da-11e8-bf33-005056a12a82-1234568"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_remote"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_NCP"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4v2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.139"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script_context"</span></span>:<span class="hljs-string"><span class="hljs-string">"init"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.111.168"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/openvpn/server150.conf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>:<span class="hljs-string"><span class="hljs-string">"fa56bf61-90da-11e8-bf33-005056a12a82-1234568"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"trusted_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pf_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_pf_4fcad505693b33f97c4fe105df8681cb.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_local"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tun_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1500"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auth_control_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_acf_321bb12075dc0e1b5440d227220bac5d.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUBv2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verb"</span></span>:<span class="hljs-string"><span class="hljs-string">"3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PLAT"</span></span>:<span class="hljs-string"><span class="hljs-string">"win"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_pid"</span></span>:<span class="hljs-string"><span class="hljs-string">"52435"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_vpn_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proto_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_net_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PROTO"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_log_redirect"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_VER"</span></span>:<span class="hljs-string"><span class="hljs-string">"2.4.3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZO"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"remote_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pluginid"</span></span>:<span class="hljs-string"><span class="hljs-string">"3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_TCPNL"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_network_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.0"</span></span> }</code> </pre> <br><p>  The function OPENVPN_PLUGIN_CLIENT_CONNECT_V2, called when the IP address is set by the internal DHCP server. </p><br><pre> <code class="json hljs">OPENVPN_PLUGIN_CLIENT_CONNECT_V<span class="hljs-number"><span class="hljs-number">2</span></span> { <span class="hljs-attr"><span class="hljs-attr">"route_netmask_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_gateway_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"trusted_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.111.168"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"link_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1622"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUB"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_start_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"1547319280"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"common_name"</span></span>:<span class="hljs-string"><span class="hljs-string">"fa56bf61-90da-11e8-bf33-005056a12a82-1234568"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"time_ascii"</span></span>:<span class="hljs-string"><span class="hljs-string">"Sat Jan 12 18:54:48 2019"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_remote"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_NCP"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4v2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.139"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script_context"</span></span>:<span class="hljs-string"><span class="hljs-string">"init"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.111.168"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/openvpn/server150.conf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>:<span class="hljs-string"><span class="hljs-string">"fa56bf61-90da-11e8-bf33-005056a12a82-1234568"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"trusted_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pf_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_pf_4fcad505693b33f97c4fe105df8681cb.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_local"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tun_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1500"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auth_control_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_acf_321bb12075dc0e1b5440d227220bac5d.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUBv2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verb"</span></span>:<span class="hljs-string"><span class="hljs-string">"3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PLAT"</span></span>:<span class="hljs-string"><span class="hljs-string">"win"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_pid"</span></span>:<span class="hljs-string"><span class="hljs-string">"52435"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"time_unix"</span></span>:<span class="hljs-string"><span class="hljs-string">"1547319288"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_vpn_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proto_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_net_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PROTO"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_log_redirect"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_VER"</span></span>:<span class="hljs-string"><span class="hljs-string">"2.4.3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZO"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"remote_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_pool_local_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.5"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pluginid"</span></span>:<span class="hljs-string"><span class="hljs-string">"9"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_pool_remote_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.6"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_TCPNL"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_network_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.0"</span></span> }</code> </pre> <br><p>  In a variable environment, variables containing the tunnel parameters "ifconfig_pool_local_ip" and "ifconfig_pool_remote_ip" appear. </p><br><p>  The OPENVPN_PLUGIN_LEARN_ADDRESS function is called when the OpenVPN server learns a bunch of IP addresses and routes to them.  After exiting this function, the procedure for applying the packet filter settings from a file is activated.  The variable environment OPENVPN_PLUGIN_LEARN_ADDRESS corresponds to the phase OPENVPN_PLUGIN_CLIENT_CONNECT_V2. </p><br><pre> <code class="plaintext hljs">fa56bf61-.../172.16.111.168:1200 ----- pf_check_reload : struct pf_context ----- fa56bf61-.../172.16.111.168:1200 enabled=1 fa56bf61-.../172.16.111.168:1200 filename='/tmp/openvpn_pf_343330698e4acdea34c8a8c7fb87d861.tmp' fa56bf61-.../172.16.111.168:1200 file_last_mod=1547319124 fa56bf61-.../172.16.111.168:1200 n_check_reload=1 fa56bf61-.../172.16.111.168:1200 reload=[1,15,1547319125] fa56bf61-.../172.16.111.168:1200 ----- struct pf_set ----- fa56bf61-.../172.16.111.168:1200 kill=0 fa56bf61-.../172.16.111.168:1200 ----- struct pf_subnet_set ----- fa56bf61-.../172.16.111.168:1200 default_allow=ACCEPT fa56bf61-.../172.16.111.168:1200 ----- struct pf_cn_set ----- fa56bf61-.../172.16.111.168:1200 default_allow=DROP fa56bf61-.../172.16.111.168:1200 12345678-90da-11e8-bf33-005056a12a82-1234567 ACCEPT fa56bf61-.../172.16.111.168:1200 fa56bf61-90da-11e8-bf33-005056a12a82-1234567 ACCEPT fa56bf61-.../172.16.111.168:1200 ---------- fa56bf61-.../172.16.111.168:1200 fa56bf61-90da-11e8-bf33-005056a12a82-1234567 ACCEPT fa56bf61-.../172.16.111.168:1200 12345678-90da-11e8-bf33-005056a12a82-1234567 ACCEPT fa56bf61-.../172.16.111.168:1200 --------------------</code> </pre> <br><p>  When the client is disabled, the function OPENVPN_PLUGIN_CLIENT_DISCONNECT is called. </p><br><pre> <code class="json hljs">OPENVPN_PLUGIN_CLIENT_DISCONNECT { <span class="hljs-attr"><span class="hljs-attr">"route_netmask_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_gateway_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"trusted_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.111.168"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"link_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1622"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUB"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_start_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"1547319280"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"common_name"</span></span>:<span class="hljs-string"><span class="hljs-string">"fa56bf61-90da-11e8-bf33-005056a12a82-1234568"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"time_ascii"</span></span>:<span class="hljs-string"><span class="hljs-string">"Sat Jan 12 18:54:48 2019"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bytes_received"</span></span>:<span class="hljs-string"><span class="hljs-string">"30893"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_NCP"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_remote"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4v2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.139"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script_context"</span></span>:<span class="hljs-string"><span class="hljs-string">"init"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.111.168"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/openvpn/server150.conf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>:<span class="hljs-string"><span class="hljs-string">"fa56bf61-90da-11e8-bf33-005056a12a82-1234568"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"trusted_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pf_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_pf_4fcad505693b33f97c4fe105df8681cb.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_local"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tun_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1500"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auth_control_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_acf_4bdddbada2885cde42cd3cb1b85d77e5.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUBv2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verb"</span></span>:<span class="hljs-string"><span class="hljs-string">"3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PLAT"</span></span>:<span class="hljs-string"><span class="hljs-string">"win"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_pid"</span></span>:<span class="hljs-string"><span class="hljs-string">"52435"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"time_unix"</span></span>:<span class="hljs-string"><span class="hljs-string">"1547319288"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_vpn_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proto_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_net_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PROTO"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_log_redirect"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"time_duration"</span></span>:<span class="hljs-string"><span class="hljs-string">"3781"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_VER"</span></span>:<span class="hljs-string"><span class="hljs-string">"2.4.3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZO"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bytes_sent"</span></span>:<span class="hljs-string"><span class="hljs-string">"22684"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"remote_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_pool_local_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.5"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pluginid"</span></span>:<span class="hljs-string"><span class="hljs-string">"7"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_pool_remote_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.6"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_TCPNL"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_network_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.0"</span></span> }</code> </pre> <br><p>  In a variable environment, the connection duration and user traffic are added. </p><br><p>  As you have noticed, due to the abundance of data in different calls, writing and debugging a plug-in in the C programming language (C ++) will be a rather laborious task. <br>  To expand the functionality, it was decided to make a "miracle" first for the internal project, and then put it into free access :) <br>  After a long reading of the OpenVPN source codes and various examples of highly specialized plug-ins, a project was written that uses Python as the programming language of the session processing logic.  The code is a plug-in in C language that is connected to OpenVPN, which sends all requests to the plugin, sends to Python a module via <a href="https://docs.python.org/2/c-api/index.html">c-api reference</a> . </p><br><p>  <a href="https://github.com/aborche/openvpn-plugin-python-proxy">OpenVPN plugin python proxy</a> </p><br><h2 id="pochemu-python-modul-">  Why python module? </h2><br><p>  Python c-api reference working with python files directly, does not work correctly with loading python libraries. </p><br><h2 id="kak-eto-rabotaet-">  How it works ? </h2><br><p>  When initializing a plugin in OpenVPN, the plugin returns a masked list of all the functions it can serve.  When the next phase of the connection or internal event occurs, OpenVPN calls the corresponding functions from the plugin.  The plugin converts the variable environment and the parameters of the functions passed to the structure, initializes python and passes the structure to the corresponding python module procedure.  The procedure returns one of the three responses to the plugin (0 - Success, 1 - Error, 2 - Deferred).  The answer is transformed and returned to OpenVPN. </p><br><p>  Please note that all calls to the module are "stateless", which means that the procedures do not remember and do not know what happened earlier in other calls.  You can only focus on the variable environment passed to the plugin from OpenVPN. </p><br><p>  Inside the python module you can implement any logic by connecting the necessary libraries and resources.  If you are not sure about the speed of checks, use the "pending" confirmation. </p><br><p>  Using the grouping of users connected to the service, through pf_file, you can finely configure the network interaction between users and other resources.  In turn, by connecting the monitoring plugin, it will always be possible to manage client sessions through the management interface of OpenVPN. </p><br><p>  During the testing of the project, a password generation mechanism was developed, similar to jwt tokens, but having a smaller size. </p><br><p>  The bottom line is simple.  The token contains the client ID and the access end date.  To sign a token, use HMAC_SHA1 with a private key.  After signing the token, the text content is signed by the signature and converted to base64.  Thus it turns out "sealing" the token.  A "sealed" token is used as a user password.  When an unauthorized change of the data block, xor breaks, if xor breaks, the signature verification will break.  Without a private key, the signature cannot be changed. </p><br><p>  If you do not want to control the time of the password with your hands, then generate such a token, and check it for validity inside the plugin, without calling external services.  This scheme is very convenient for session generation of passwords for a certain time.  In this case, you can transfer the contents of the token to the external control system and it will tune itself to disconnect the user after the token expires. </p><br><p>  I hope the information in this article was useful to you. <br>  Thank you for taking the time to read it. <br>  If you have questions, I will try to answer what I can. </p><br><p>  ¬© Aborche 2019 <br><img src="https://habrastorage.org/getpro/habr/post_images/7c5/e49/ede/7c5e49ede95e47e91424dbb9bafbb7bb.jpg" alt="Aborche"></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/435802/">https://habr.com/ru/post/435802/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../435792/index.html">These toxic guys: they poison projects</a></li>
<li><a href="../435794/index.html">‚ÄúWhy you need to get fast‚Äù: Steve Cotton from Bungie about the creative process in the company</a></li>
<li><a href="../435796/index.html">About how from C # I moved to Elixir / Phoenix</a></li>
<li><a href="../435798/index.html">Sony WH-1000XM3 - the best wireless headphones?</a></li>
<li><a href="../435800/index.html">Letter of the Decembrist11</a></li>
<li><a href="../435804/index.html">Intel Cyclone does not save configuration after reboot</a></li>
<li><a href="../435806/index.html">Clinical trials of bioengineering heart patch announced in Japan</a></li>
<li><a href="../435810/index.html">JOIN local collection and DbSet in the Entity Framework</a></li>
<li><a href="../435812/index.html">The theory of happiness. Statistics, as a scientific way to not know anything</a></li>
<li><a href="../435814/index.html">[The Old New Thing] Can I use my stack as I like?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>