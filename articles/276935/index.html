<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reset suspended RDP sessions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Everyone who has terminal servers on Windows has to deal with hung sessions. 
 Sessions often hang, if the user simply closed the terminal window. 
 N...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reset suspended RDP sessions</h1><div class="post__text post__text-html js-mediator-article"> Everyone who has terminal servers on Windows has to deal with hung sessions. <br>  Sessions often hang, if the user simply closed the terminal window. <br>  Naturally, we all configure the settings for resetting sessions by time and user disconnection, but it happens that the sessions are still not completed and then we use the commands: <b>qwinsta - view sessions</b> and <b>rwinsta - reset sessions</b> <br>  I am absolutely sure that the script engine, which itself tracks and resends hung sessions, was written by many, but wasn‚Äôt uploaded to the network because it‚Äôs easy, I‚Äôll post it for those who are looking for and who need it right now: <br><br>  The script receives a list of <b>qwinsta</b> sessions, selects sessions with the status Disk ("* Eb–Ñ *" is also a "Disk", just in the encoding curve, added just in case) and <b>rwinsta</b> resets the session. <br>  In the script, <b>rwinsta</b> is commented out, so that the sessions are reset, uncomment it. <br>  In its current form, the script will just show you hung sessions. <br><a name="habracut"></a><br><pre> <code class="hljs mel"><code>#   ,        Function RDP_Resetfailure($server){ $ts = qwinsta /server:$server $td = ($ts | where { ($_ -like <span class="hljs-string"><span class="hljs-string">"*Disc*"</span></span> -or $_ -like <span class="hljs-string"><span class="hljs-string">"**"</span></span> -or $_ -like <span class="hljs-string"><span class="hljs-string">"*–Ñ*"</span></span> ) -and $_ -notlike <span class="hljs-string"><span class="hljs-string">"*services*"</span></span>}) $tdselect = $td #      : Login Id State $td = $td -ireplace (<span class="hljs-string"><span class="hljs-string">"[^0-9]"</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>) #   id  <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>($i=<span class="hljs-number"><span class="hljs-number">0</span></span>; $i -lt $td.Count; $i++){ Write-Host Reset RDP Failture session ID: $td[$i] $tdselect[$i] #  id  #rwinsta $td[$i] /server:$server #   ,    } } $server = <span class="hljs-string"><span class="hljs-string">"MyRDPServer"</span></span> RDP_Resetfailure($server)</code> <br></code> </pre> <code><code>#   ,        Function RDP_Resetfailure($server){ $ts = qwinsta /server:$server $td = ($ts | where { ($_ -like "*Disc*" -or $_ -like "**" -or $_ -like "*–Ñ*" ) -and $_ -notlike "*services*"}) $tdselect = $td #      : Login Id State $td = $td -ireplace ("[^0-9]","") #   id  for($i=0; $i -lt $td.Count; $i++){ Write-Host Reset RDP Failture session ID: $td[$i] $tdselect[$i] #  id  #rwinsta $td[$i] /server:$server #   ,    } } $server = "MyRDPServer" RDP_Resetfailure($server)</code> <br></code> <br>  Additive for those who prefer to drop manually or selectively: <br><pre> <code class="hljs mel"><code>#        [Console]::outputEncoding = [System.Text.Encoding]::GetEncoding(<span class="hljs-string"><span class="hljs-string">'cp866'</span></span>) Function RDP_Resetfailure($server){ $ts = qwinsta /server:$server $td = ($ts | where { ($_ -like <span class="hljs-string"><span class="hljs-string">"*Disc*"</span></span> -or $_ -like <span class="hljs-string"><span class="hljs-string">"**"</span></span> -or $_ -like <span class="hljs-string"><span class="hljs-string">"*–Ñ*"</span></span> ) -and $_ -notlike <span class="hljs-string"><span class="hljs-string">"*services*"</span></span>}) $tdselect = $td #      : Login Id State $td = $td -ireplace (<span class="hljs-string"><span class="hljs-string">"[^0-9]"</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>) #   id  Clear-Host Write-Host <span class="hljs-string"><span class="hljs-string">"   : "</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>($i=<span class="hljs-number"><span class="hljs-number">0</span></span>; $i -lt $td.Count; $i++){ Write-Host Reset RDP Failture session ID: $td[$i] $tdselect[$i] #  id  } Write-Host <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($td[<span class="hljs-number"><span class="hljs-number">0</span></span>]){ Write-Host <span class="hljs-string"><span class="hljs-string">" -    c  0 -   ID   ==================================== "</span></span> $r = Read-Host -Prompt <span class="hljs-string"><span class="hljs-string">" "</span></span> Write-Host ============================= # ====   ! ===== <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($r -eq <span class="hljs-number"><span class="hljs-number">0</span></span> ){ Write-Host Write-Host ====   ! ===== <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>($i=<span class="hljs-number"><span class="hljs-number">0</span></span>; $i -lt $td.Count; $i++){ Write-Host Reset RDP Failture session ID: $td[$i] $tdselect[$i] #  id  #rwinsta $td[$i] /server:$server #   ,    Write-Host } } #   ID <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($r -gt <span class="hljs-number"><span class="hljs-number">0</span></span> ){ $tdu = $tdselect | where { $_ -<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>+$r } Write-Host Reset RDP Failture session ID: $r $tdu #rwinsta $r /server:$server #   ,    } } } $server = <span class="hljs-string"><span class="hljs-string">"MyRDPServer"</span></span> RDP_Resetfailure($server)</code> <br></code> </pre> <code><code>#        [Console]::outputEncoding = [System.Text.Encoding]::GetEncoding('cp866') Function RDP_Resetfailure($server){ $ts = qwinsta /server:$server $td = ($ts | where { ($_ -like "*Disc*" -or $_ -like "**" -or $_ -like "*–Ñ*" ) -and $_ -notlike "*services*"}) $tdselect = $td #      : Login Id State $td = $td -ireplace ("[^0-9]","") #   id  Clear-Host Write-Host "   : " for($i=0; $i -lt $td.Count; $i++){ Write-Host Reset RDP Failture session ID: $td[$i] $tdselect[$i] #  id  } Write-Host if($td[0]){ Write-Host " -    c  0 -   ID   ==================================== " $r = Read-Host -Prompt " " Write-Host ============================= # ====   ! ===== if($r -eq 0 ){ Write-Host Write-Host ====   ! ===== for($i=0; $i -lt $td.Count; $i++){ Write-Host Reset RDP Failture session ID: $td[$i] $tdselect[$i] #  id  #rwinsta $td[$i] /server:$server #   ,    Write-Host } } #   ID if($r -gt 0 ){ $tdu = $tdselect | where { $_ -match ' '+$r } Write-Host Reset RDP Failture session ID: $r $tdu #rwinsta $r /server:$server #   ,    } } } $server = "MyRDPServer" RDP_Resetfailure($server)</code> <br></code> </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/276935/">https://habr.com/ru/post/276935/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../276923/index.html">Creating the concept of mobile f2p games. Part 1</a></li>
<li><a href="../276925/index.html">EDI standard. Technical Overview</a></li>
<li><a href="../276927/index.html">Recipes for Android: IoC with Gradle Taste</a></li>
<li><a href="../276931/index.html">Web version of Server Management Tools for TP 2016</a></li>
<li><a href="../276933/index.html">Record on the anniversary tour to the cloud data center Inoventica Services</a></li>
<li><a href="../276937/index.html">Algorithm for creating a list of all permutations or placements</a></li>
<li><a href="../276939/index.html">DUMP-2016 Developer Conference: Ekaterinburg, April 8</a></li>
<li><a href="../276941/index.html">Deploying Linux distribution with SCCM 2012</a></li>
<li><a href="../276943/index.html">GPU vs CPU: Why are GPUs used to analyze financial data</a></li>
<li><a href="../276945/index.html">How we ported the good old Russian quest</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>