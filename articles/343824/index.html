<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MySQL and partitioning</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After reading the article I remembered one very specific customer and a system for collecting statistics on events. In the 21st century, I know about ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MySQL and partitioning</h1><div class="post__text post__text-html js-mediator-article">  After reading the <a href="https://habrahabr.ru/post/159131/">article I</a> remembered one very specific customer and a system for collecting statistics on events.  In the 21st century, I know about the presence of <a href="https://clickhouse.yandex/docs/ru/single/">ClickHouse</a> , but the customer does not want to change the database (the reason is incomprehensible and unknown to me, religion probably does not allow), and so be it, I warned him several times about the consequences.  When it becomes slowly quite, aware of the problem. <br><br><h3>  The essence of the problem </h3><br>  But it's not about that. <a name="habracut"></a>  In general, after reading the article, I remembered this project and decided to try to integrate the partition into a table with 7,000,000 entries.  There are already a lot more entries on the prod stand. <cut></cut><br><br>  Also in the project was used sharding, which, by and large, there is extra.  It makes no sense in this kind of system to do sharding and even in time (for each month has its own table). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In general, there were actually a few options for how to divide the data, and the most obvious was chosen: add a dYm (date Year month) column to the table, since time is already written to the table, it was not difficult to do so.  True, with a certain reservation, since there is not enough memory on the server, I had to re-create the table and import the data into the new table, after adding the required field. <br><br>  Creating a table with partitions (some fields removed): <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`event_list_test`</span></span> ( <span class="hljs-string"><span class="hljs-string">`dYd`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span>, <span class="hljs-string"><span class="hljs-string">`hash`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'hash'</span></span>, <span class="hljs-string"><span class="hljs-string">`time`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'timestamp'</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`time`</span></span>,<span class="hljs-string"><span class="hljs-string">`dYd`</span></span>,<span class="hljs-string"><span class="hljs-string">`hash`</span></span>), ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8 <span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIST</span></span> (dYd) (<span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> p201703 <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">201703</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> p201704 <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">201704</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> p201705 <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">201705</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> p201706 <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">201706</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> p201707 <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">201707</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> p201708 <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">201708</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> p201709 <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">201709</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> p201710 <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">201710</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> p201711 <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">201711</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> p201712 <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">201712</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span>)</code> </pre> <br>  As it was described in the article that I cited initially, the advantages of such a division are obvious: <br><br><ol><li>  Simplicity of administration, since a column with 7,000,000 rows with 1GB of memory does not add a column, and the index is even more so </li><li>  Initially, this kind of table shardirovalis, but the obvious disadvantage is the writing of sql queries.  Often it was necessary to make inquiries for several months, and if aggregation is needed, then there is absolutely trouble. </li><li>  It is easier to add a partition to a table (especially if you put a task in cron with sending a letter to telegrams or to mail, here it is more convenient for someone) </li></ol><br>  Next, you need to optimize queries, because with an illiterate query, MySQL will run through all partitions, which adds additional costs, but this is not very good. <br><br>  After reading the <a href="https://dev.mysql.com/doc/refman/5.7/en/partitioning-pruning.html">article</a> , the optimization solution also suggests itself: we need to use a search through between for a unique key in the query.  As a result, if the application replaces all requests with such: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">`time`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`event_list_test`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (<span class="hljs-string"><span class="hljs-string">`time`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> <span class="hljs-number"><span class="hljs-number">1505385901</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">1506934784</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (<span class="hljs-string"><span class="hljs-string">`dYd`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> <span class="hljs-number"><span class="hljs-number">201709</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">201710</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre> <br>  then we will get a very good explain: <br><br> <code>SIMPLE event_list_test p201709,p201710 range PRIMARY,time PRIMARY 8 NULL 145875 11.11 Using where <br></code> <br><h3>  What have we achieved? </h3><br>  And we have achieved the following: <br><br><ol><li>  Unnecessary data sharding disappeared </li><li>  It is very easy to build requests for data (sharding had a lot of problems) </li><li>  It is very easy to administer the tables (insert partitions, delete partitions, insert data, select data, change table, work with indexes) </li><li>  And as a result - simplification of the application at times. </li></ol></div><p>Source: <a href="https://habr.com/ru/post/343824/">https://habr.com/ru/post/343824/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343812/index.html">DotNext 2018 Piter Release Notes</a></li>
<li><a href="../343816/index.html">We collect user activity in JS and ASP</a></li>
<li><a href="../343818/index.html">TypeScript: tslib library</a></li>
<li><a href="../343820/index.html">Technical diary: half a year developing mobile PvP</a></li>
<li><a href="../343822/index.html">Heading "We read articles for you." October - November 2017</a></li>
<li><a href="../343826/index.html">Russia's first mitap on Apache Ignite, December 12</a></li>
<li><a href="../343828/index.html">Writing a simple Linux kernel module</a></li>
<li><a href="../343830/index.html">Dependency injection in .Net Mark Siman 1 - Dependencies between application layers</a></li>
<li><a href="../343832/index.html">Designing a system for reading data from input devices (Part Two)</a></li>
<li><a href="../343834/index.html">Introduction to reinforcement training: from a multi-armed gangster to a full-fledged RL agent</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>