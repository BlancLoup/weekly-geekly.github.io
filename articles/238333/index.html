<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Features of Microsoft.Win32.SystemEvents in a Multi AppDomain Application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once upon a time there was a console application that created appdomain and started a service based on Topshelf in it. But once a bug appeared in it -...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Features of Microsoft.Win32.SystemEvents in a Multi AppDomain Application</h1><div class="post__text post__text-html js-mediator-article"> Once upon a time there was a console application that created appdomain and started a service based on Topshelf in it.  But once a bug appeared in it - after pressing Ctrl-C, it did not complete its work, but reported receiving a shutdown command and hung in that state.  A brief analysis showed that it hung on unloading the domain, but, strangely, did not throw out the exception <code>CannotUnloadAppDomainException</code> . <br><a name="habracut"></a><br>  Further, it was noted that the application freezes when closed only after performing certain tasks, and there are several ‚Äúextra‚Äù threads before unloading the domain, which are not observed in the case of normal application termination.  As you can guess from the name, the case turned out to be in <code>SystemEvents</code> .  When using <code>System.Drawing.SolidBrush</code> , the handler is added to <code>SystemEvents.UserPreferenceChanging</code> , but since this is a separate appdomain, the type is initialized again, another stream is created with the name ".NET SystemEvents", which, when started, adds its own to the console handlers. <br>  When the application is <code>SystemEvents.Dispose()</code> is called, and there when the <code>UnsafeNativeMethods.SetConsoleCtrlHandler(consoleHandler, 0)</code> console handler is <code>UnsafeNativeMethods.SetConsoleCtrlHandler(consoleHandler, 0)</code> application hangs.  I naguglil couple of mentions of a problem with removal of console handlers, but all solutions were reduced to a call of <code>SystemEvents.Shutdown()</code> through Reflection, but it did not help me, and should not seem to help, it then causes Dispose (). <br>  Then I decided that I need to somehow avoid creating a second SystemEvents thread, and a loophole was found in the <code>SystemEvents.EnsureSystemEvents(bool requireHandle, bool throwOnRefusal)</code> method <code>SystemEvents.EnsureSystemEvents(bool requireHandle, bool throwOnRefusal)</code> : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Thread.GetDomain().GetData(<span class="hljs-string"><span class="hljs-string">".appDomain"</span></span>) != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (throwOnRefusal) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(SR.GetString(SR.ErrorSystemEventsNotSupported)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//   SystemEvents</span></span></code> </pre><br>  In my case, this method was called with throwOnRefusal = false, so adding <code>domain.SetData(".appDomain", new object())</code> avoids creating another SystemEvents stream and freezing when you remove its console handler, the application shuts down correctly. <br>  A side effect is possible in the case of code that relies on checking the ".appDomain" property, it can count our application for asp.net)) If someone knows what problems may be caused by this setting, or knows a safer and more appropriate solution to the problem, please share. </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/238333/">https://habr.com/ru/post/238333/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../238323/index.html">How we test CSS regressions with Gemini. Report on BEMup in Yandex</a></li>
<li><a href="../238325/index.html">Cloudify and its use in OpenStack. First step</a></li>
<li><a href="../238327/index.html">Google Play Game Services in Libgdx</a></li>
<li><a href="../238329/index.html">My way is an indie developer, several years</a></li>
<li><a href="../238331/index.html">Speculations on the domain *. Moscow</a></li>
<li><a href="../238335/index.html">How user factors influence ranking: 2 critical factors</a></li>
<li><a href="../238337/index.html">More than phones: how Nokia produced computers</a></li>
<li><a href="../238341/index.html">Three interviews about static code analyzers</a></li>
<li><a href="../238343/index.html">Dimension, or why 3D printers and artificial intelligence will not take over the world</a></li>
<li><a href="../238345/index.html">Orthogonal - a model of the world with an alternative theory of relativity</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>