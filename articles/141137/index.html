<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What I would like from future versions of Ruby, and how I cope now</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, Habr. 
 I have been working with Ruby for about a year and would like to write about some things that I personally often lack there, a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>What I would like from future versions of Ruby, and how I cope now</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon, Habr. <br>  I have been working with Ruby for about a year and would like to write about some things that I personally often lack there, and which I would like to see embedded in the language.  Perhaps only a couple of these points are really serious flaws, with the rest you can easily cope with improvised means. <br>  It seems to be flaws and trivialities, but they significantly complicate the work - you have to write your own libraries of auxiliary methods that you can‚Äôt select in heme - it‚Äôs painfully small and uncomfortable without them.  And sometimes you open someone else's code - and you see there exactly the same auxiliary functions as yours.  I think this is a sign that the standard language library is incomplete.  Well, let's hope, one of the developers will read the text and commit the patch.  ;-) <br>  So let's start in order: <ul><li>  Method overloading with different argument lists, as in C ++ </li><li>  Display hash and get another hash from it, not an array </li><li>  Convert an instance of a class to an instance of its own subclass. </li><li>  Different ryushechki </li></ul><a name="habracut"></a><br><h4>  Method overloading with different argument lists, as in C ++ </h4><br>  This is in my opinion one of the biggest problems of ruby.  It does not allow to define a method differently for different types of arguments.  As a result, you have to write complex constructions for parsing the list of parameters, check types, the presence or absence of arguments, and so on.  I do not pretend to solve this problem, to solve it you need to shovel the source code, write a lot of code and even more tests.  Therefore, I will show only an implementation that in the simplest cases can save you a couple of lines of code. <br>  To do this, we will use the alias-method-chain'ing. <br><pre><code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodOverload</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClassMethods</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">overload</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">meth</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">submethods_hash</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method_defined?</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">meth</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">alias_method</span></span></span><span class="hljs-class"> "</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#{meth}_default_behavior", meth has_default_behavior = true end define_method meth do |*args,&amp;block| submethods_hash.each do |sub_meth,arg_typelist| if args.size == arg_typelist.size &amp;&amp; args.to_enum.with_index.all?{|arg,index| arg.is_a? arg_typelist[index]} return self.send(sub_meth,*args,&amp;block) end end if has_default_behavior return self.send("#{meth}_default_behavior",*args,&amp;block) else raise ArgumentError end end end end def self.included(base) base.extend(ClassMethods) end end</span></span></span></span></code> </pre> <br><br>  We write a function such that it yields the following results: <br><pre> <code class="ruby hljs"> x = X.new xf <span class="hljs-comment"><span class="hljs-comment"># =&gt; "original version []" xf 3, 'a' # =&gt; "original version [3,\"a\"]" xf 3, 4 # =&gt; "pair numeric version 3 &amp; 4" xf 3 # =&gt; "numeric version 3" xf 'mystr' # =&gt; "string version mystr"</span></span></code> </pre><br><br>  Here's what it looks like if you simulate method overloading: <br><pre> <code class="ruby hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">X</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodOverload</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">(*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">args</span></span></span><span class="hljs-class">) '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">original</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">version</span></span></span><span class="hljs-class"> ' + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">args</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_s</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f_string</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">str</span></span></span><span class="hljs-class">) '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">version</span></span></span><span class="hljs-class"> ' + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">str</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_s</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f_numeric</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">num</span></span></span><span class="hljs-class">) '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">numeric</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">version</span></span></span><span class="hljs-class"> ' + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">num</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_s</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f_pair_numeric</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">num1</span></span></span><span class="hljs-class">,</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">num2</span></span></span><span class="hljs-class">) "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pair</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">numeric</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">version</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#{num1} &amp; #{num2}" end overload :f, f_string:[String], f_numeric:[Numeric], f_pair_numeric:[Numeric, Numeric] end</span></span></span></span></code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Instead, of course, you can simply write one function. <br><pre> <code class="ruby hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">X</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">(*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">args</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">args</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">size</span></span></span><span class="hljs-class"> == 2 &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">args</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">first</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">is_a?</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Numeric</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">args</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">last</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">is_a?</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Numeric</span></span></span><span class="hljs-class"> "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pair</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">numeric</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">version</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#{args[0]} #{args[1]}" elsif args.size == 1 &amp;&amp; args.first.is_a? String 'string version ' + str.to_s elsif args.size == 1 &amp;&amp; args.first.is_a? Numeric 'numeric version ' + num.to_s else 'original version ' + args.to_s end end end</span></span></span></span></code> </pre><br><br>  However, this method swells very quickly and becomes inconvenient for reading and adding features.  Unfortunately, in the approach described by me, there are still problems such as working with arguments by default and list compression (* args), but I think they can be solved by slightly expanding the overload method.  If it seems to the community that it would be nice to develop such an approach - I will try to make a separate article on this topic and expand the code. <br>  I would like in future versions of Ruby to have built-in tools for this method overload. <br><br><h4>  Display hash and get another hash from it, not an array </h4><br>  Honestly, I wonder why this method is not directly in Enumerable, it is one of the most frequent constructions that is needed.  I certainly would like her to have a separate method, and not even in the second cut, but the sooner the better (especially since this is a trifling matter). <br>  I often have the task of walking through a hash and making another hash of it.  A sort of map.  Here only map for hash will give you what?  Right, array.  Usually it is necessary to get out a similar construction: <br><pre> <code class="ruby hljs">{<span class="hljs-symbol"><span class="hljs-symbol">a:</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">b:</span></span><span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">c:</span></span><span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">z:</span></span><span class="hljs-number"><span class="hljs-number">26</span></span>}.inject({}){<span class="hljs-params"><span class="hljs-params">|hsh,(k,v)|</span></span> hsh.merge(k=&gt;v.even?)} <span class="hljs-comment"><span class="hljs-comment"># =&gt; {a: false, b: true, c:false, z: true}</span></span></code> </pre> <br>  There is another option <pre> <code class="ruby hljs">Hash[{<span class="hljs-symbol"><span class="hljs-symbol">a:</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">b:</span></span><span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">c:</span></span><span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">z:</span></span><span class="hljs-number"><span class="hljs-number">26</span></span>}.map{<span class="hljs-params"><span class="hljs-params">|k,v|</span></span> [k,v.even?]}]</code> </pre>  This option is a bit simpler and more deadly.  allows you to display not only values, but also keys.  However, it is clear that the arrays lack the to_hash method to write not Hash [arr], but arr.to_hash. <br>  However, this method will not be applicable to all arrays, probably for these reasons the Array # to_hash method is not present in the kernel (see <a href="http://www.ruby-forum.com/topic/138218">discussion</a> ). <br>  This hints that it is worth making the Array derived class HashLikeArray, which accepts only arrays of the form [[k1, v1], [k2, v2], ...], but this is in the next paragraph. <br><br>  For now, let's implement a simple hash_map based on the inject method: <br><pre> <code class="ruby hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Hash</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hash_map</span></span></span><span class="hljs-class">(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">block</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inject</span></span></span><span class="hljs-class">({}) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hsh</span></span></span><span class="hljs-class">,(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class">,</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v</span></span></span><span class="hljs-class">)| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hsh</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">merge</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class">=&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">block</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v</span></span></span><span class="hljs-class">)) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br><br>  And now about the implementation of a class derived from Array.  There are some problems with this that we will try to solve now. <br><br><h4>  Convert an instance of a class to an instance of its own subclass. </h4><br>  It is clear that there is no problem to create a class derived from Array, but we also need to somehow replace the Hash # to_a method so that it returns not this Array, but this derived class HashLikeArray.  Of course, you can try to write your own implementation of this method, but in reality you just need a wrapper that turns the result of the original Hash # to_a from the Array class into a subclass of HashLikeArray. <br>  Let's try to write (not bothering now with any alias) <br><pre> <code class="ruby hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HashLikeArray</span></span></span><span class="hljs-class"> &lt; Array </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">args</span></span></span><span class="hljs-class">,&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">block</span></span></span><span class="hljs-class">) </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#raise unless ... -    ,        super end end class Hash def to_a_another_version HashLikeArray[*self.to_a] #   ,    Array::[] end end {a:3,b:5,c:8}.to_a.class # ==&gt; Array {a:3,b:5,c:8}.to_a_another_version.class # ==&gt; HashLikeArray</span></span></span></span></code> </pre><br><br>  Coped.  Now the task is more complicated, even if we have a less developed class than Array: <br><pre> <code class="ruby hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Animal</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_accessor</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">weight</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get_flying_animal</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">res</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">res</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">singleton_class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class_eval</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_accessor</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">flight_velocity</span></span></span><span class="hljs-class">} </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">res</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">flight_velocity</span></span></span><span class="hljs-class"> = 1 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">res</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bird</span></span></span><span class="hljs-class"> &lt; Animal </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_accessor</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">flight_velocity</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Now let you have an old get_flying_animal method that was written when the Bird class did not exist yet.  Animal :: get_flying_animal always returned birds with attributes attached, but formally they were of class Animal.  Now try, without changing the Animal class, to make the Bird :: get_flying_animal method, which yields the same birds using the same algorithm, but only now with the Bird class.  Yes, the get_flying_animal method is actually much larger than in the example and you do not want to duplicate it. <br>  Especially this situation can ruin your life if you cannot change the Animal class, or you don‚Äôt even know its source code, since  they are written, for example, in sy.  (As an exercise, try to write your own version of the HashLikeArray # to_a method, without using the Array :: [] or Array # replace methods. You simply have nowhere to duplicate the code, unless of course you are going to write a si library) <br>  I figured out how to do it in a non-elegant way, by copying all the instance variables into a derived class object. <br><pre> <code class="ruby hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type_cast</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new_class</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new_obj</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new_class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">allocate</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instance_variables</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">each</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">varname</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new_obj</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instance_variable_set</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">varname</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instance_variable_get</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">varname</span></span></span><span class="hljs-class">)) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new_obj</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br><br>  Now you can do this: <br><pre> <code class="ruby hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Bird</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_flying_animal</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Animal</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_flying_animal</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">type_cast</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bird)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><br>  If someone knows how to replace this clumsy crutch in the form of the type_cast method - write, this is a very interesting question. <br>  Generally speaking, it is a controversial question how correct it is to redefine a class type for a subclass type.  I would say that this is a dirty hack and not the PLO at all, but sometimes a very useful hack ... Ruby is such a special language, where every rule is needed only so that it is clear what can be broken.  I think it would not go badly against the principles of ruby, if the object could have changed the class to any other after it had been created, by directing something like: <br><pre> <code class="ruby hljs">x=X.new x.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span> = Y</code> </pre><br>  After all, a class actually means only an area for searching methods, constants and @@ - variables, so what difference does it make when to define a class: at the moment of creation or after.  All responsibility for the integrity of the object from this moment lies on the shoulders of the user, but this is his right.  Moreover, if the new class is a subclass of the old, then responsibility is mostly delegated to the old class. <br><br><h4>  Different ryushechki </h4><br>  Now on trifles: <br><br><h5>  Method returns self </h5><br>  In addition, I would suggest to introduce a method like <br><pre> <code class="ruby hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">identity</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">self</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  This is useful in order to write something like .collect (&amp;: identity) instead of .collect {| x |  x} <br>  In the case of numerators and collectors, everything is solved simply - with the to_a method you can get a complete list of objects, but if you write your own method, the receiving block, then the function may be useful. <br>  For example, let's make a method like the rail method <a href="http://apidock.com/rails/NilClass/try">Nil # try</a> . <br><pre> <code class="ruby hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">try</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method_name</span></span></span><span class="hljs-class">,&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">block</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">send</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method_name</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rescue</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">yield</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br><br>  Now we can do <br><pre> <code class="ruby hljs">x.try(<span class="hljs-symbol"><span class="hljs-symbol">:transform</span></span>,&amp;<span class="hljs-symbol"><span class="hljs-symbol">:another_transform</span></span>)</code> </pre> <br>  And here we may need our identity method: <br><pre> <code class="ruby hljs">x.try(<span class="hljs-symbol"><span class="hljs-symbol">:transform</span></span>, &amp;<span class="hljs-symbol"><span class="hljs-symbol">:identity</span></span>)</code> </pre> <br>  - if the conversion can be done, it will be done, no - the original object will be returned. <br><br><h5>  Object method # in? (Collection) </h5><br>  Rail method <pre> <code class="ruby hljs">color.<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>?([<span class="hljs-symbol"><span class="hljs-symbol">:red</span></span>,<span class="hljs-symbol"><span class="hljs-symbol">:green</span></span>,<span class="hljs-symbol"><span class="hljs-symbol">:blue</span></span>])</code> </pre>  looks much better than <pre> <code class="ruby hljs">[<span class="hljs-symbol"><span class="hljs-symbol">:red</span></span>,<span class="hljs-symbol"><span class="hljs-symbol">:green</span></span>,<span class="hljs-symbol"><span class="hljs-symbol">:blue</span></span>].<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>?(color)</code> </pre> <br>  We write: <br><pre> <code class="ruby hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">in?</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(collection)</span></span></span></span> raise ArgumentError <span class="hljs-keyword"><span class="hljs-keyword">unless</span></span> collection.respond_to? <span class="hljs-symbol"><span class="hljs-symbol">:include?</span></span> collection.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>? <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><br>  For the sake of this method to connect the whole library (it seems ActiveSupport) is very lazy.  I think that this method in the core would live well. <br><br><h5>  Negative form of interrogative methods </h5><br>  Would you like to write arr.not_empty?  instead of awkward! arr.empty?  There are a lot of similar interrogative methods in Ruby, but there are almost no negatives.  Methods like not_empty?  and not_nil?  I would like to have built into the standard library.  I prefer to add my own question methods to the negatives using method_missing (for obvious reasons method_missing is not recommended to be changed from the Object class) <br><pre> <code class="ruby hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">X</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method_missing</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">meth</span></span></span><span class="hljs-class">,*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">args</span></span></span><span class="hljs-class">,&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">block</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">match</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">meth</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_s</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">match</span></span></span><span class="hljs-class">(/^</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">not_</span></span></span><span class="hljs-class">(.+\?)$/) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> !</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">send</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">match</span></span></span><span class="hljs-class">[1], *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">args</span></span></span><span class="hljs-class">,&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">block</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">match</span></span></span><span class="hljs-class"> &amp;&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">respond_to?</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">match</span></span></span><span class="hljs-class">[1]) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">super</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">X</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">not_nil?</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># =&gt; true</span></span></span></span></code> </pre><br><br><h5>  We cut off file extensions </h5><br>  I have a particular hatred for the File module, in which there are no methods filename_wo_extname and basename_wo_extname.  We fix: <br><pre> <code class="ruby hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">File</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filename_wo_ext</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filename</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filename</span></span></span><span class="hljs-class">[0..-(1+</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extname</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filename</span></span></span><span class="hljs-class">).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">length</span></span></span><span class="hljs-class">)] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">basename_wo_ext</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filename</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">basename</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filename</span></span></span><span class="hljs-class">)[0..-(1+</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extname</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filename</span></span></span><span class="hljs-class">).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">length</span></span></span><span class="hljs-class">)] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">File</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">basename_wo_ext</span></span></span><span class="hljs-class">('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">:/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">my_folder</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">my_file</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">txt</span></span></span><span class="hljs-class">') </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># =&gt; "my_file" File.filename_wo_ext('d:/my_folder/my_file.txt') # =&gt; "d:/my_folder/my_file"</span></span></span></span></code> </pre><br><br><h5>  Some joy </h5><br>  I should make amends for such a mountain of complaints before ‚Äî no matter what ‚Äî the wonderful language of Ruby.  Therefore, I will share one of the joyful news from the world of Ruby - <a href="http://habrahabr.ru/post/140362/">Lazy numerators</a> . </div><p>Source: <a href="https://habr.com/ru/post/141137/">https://habr.com/ru/post/141137/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../141129/index.html">KCAPTCHA for Yii</a></li>
<li><a href="../141132/index.html">Zombies, run! The original concept of the game: audio guide + GPS + zombies + fitness</a></li>
<li><a href="../141133/index.html">Report on the First Habravstrebe in Almaty</a></li>
<li><a href="../141135/index.html">Black Isle Studios may be reborn</a></li>
<li><a href="../141136/index.html">StartPSD - to help website designers, automate work</a></li>
<li><a href="../141140/index.html">Overview of the navigation program Progorod for Android</a></li>
<li><a href="../141141/index.html">Three and a half programs for backup</a></li>
<li><a href="../141142/index.html">Asynchronous state machine: ideology and technology</a></li>
<li><a href="../141143/index.html">Let the morning be kind or Sleep as Android</a></li>
<li><a href="../141144/index.html">JIRA 4.1 integration with Active Directory</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>