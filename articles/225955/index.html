<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we implemented DKIM in Mail.Ru for business</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, Habr√© already had an article about how ‚ÄúMail.Ru for business‚Äù is getting better thanks to your comments: we told you how to realize your wis...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we implemented DKIM in Mail.Ru for business</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/company/mailru/blog/225955/"><img src="https://habrastorage.org/getpro/habr/post_images/ee3/40e/a43/ee340ea43cbfec101eec3b1be9484864.png"></a> <br><br>  Recently, Habr√© already had <a href="http://habrahabr.ru/company/mailru/blog/223667/">an article</a> about how ‚ÄúMail.Ru for business‚Äù is getting better thanks to your comments: we told you how to realize your wishes.  Today, I want to dwell on one of the embodied womens - the ability to customize your own DKIM-signature.  For us, it was one of the priorities: setting DKIM allows domain owners to verify the sender of a letter.  In this post, I will talk about how we implemented this feature and how to set up a DKIM signature for your domain. <br><a name="habracut"></a><br><h1>  A little about why DKIM technology is needed. </h1>  Wikipedia reminds us that ‚ÄúDomainKeys Identified Mail (DKIM) technology combines several existing anti-phishing and anti-spam methods in order to improve the quality of the classification and identification of legitimate email.  Instead of the traditional IP address, the DKIM adds a digital signature associated with the organization‚Äôs domain name to determine the sender of the message.  The signature is automatically verified on the recipient‚Äôs side. ‚Äù <br><br>  That is, whenever a user sends an email, our server adds a special header with a digital DKIM signature to it.  When generating a signature, a secret key is used (for each domain its own) and extracts from the letter.  This header allows the recipient server to verify that the email was indeed sent by the owner of this domain. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      DKIM signatures are one of the factors that allow ours, as well as other anti-spam systems, to separate letters of trustworthy senders from fakes.  For example, DKIM provides the technology DMARC, which we have already <a href="http://habrahabr.ru/company/mailru/blog/170957/">written about</a> .  DMARC allows you to recognize and filter spam and phishing emails disguised as messages from well-known services. <br><br>  In addition, the DKIM signature is <a href="http://habrahabr.ru/company/mailru/blog/147713/">needed for the FBL technology to work</a> (thanks to the FBL, mailing list senders can collect feedback on customer base status and loyalty, as well as check how subscribers respond to mailings and refine the content of letters). <br><br>  In general, setting up DKIM signatures is certainly a useful and necessary thing, so the question ‚ÄúTo do or not?‚Äù Did not arise.  We set to work.  Then we will talk in detail about how we implemented this functionality in Mail.Ru for Business.  If you do not want the details, we recommend that you immediately go to the <b>‚ÄúHow do I set up DKIM?‚Äù</b> Item. <br><br><h1>  How setting up DKIM signatures appeared in Mail.Ru for Business </h1>  To send letters, we use a very common mail transfer agent (MTA, Mail Transfer Agent) exim4.  It already has built-in tools for placing DKIM signatures in outgoing messages.  Until recently, we all signed our letters in exactly this way.  However, the problem is that the number of connected business domains is constantly growing, and each domain has its own secret key.  If earlier it was enough to decompose the keys once for all servers and specify the path to these keys to Exim, now this solution is no longer valid.  The problem could be solved by ‚Äúteaching‚Äù Exim to apply for a key to a centralized database.  So we decided to do. <br><br>  No sooner said than done.  Many experts value Exim for its rich customization options.  Using the built-in configuration language, you can easily teach Exim to access data in flat files, Berkeley databases, and even execute SQL queries in relational databases such as MySQL.  For the needs of the mail server of an average company, the configuration capabilities are enough for the eyes.  If something more is needed, then Exim has opportunities for writing its own lookup module that can be used in configurations along with built-in capabilities. <br><br>  To request a key from the database, a small auxiliary lookup module is created.  He installs a connection to the database, authorizes, searches for the necessary shard, replica, decrypts data, etc., providing a simple dictionary interface to the outside.  The process of creating a module is briefly described below. <br><br>  First, add the src / lookups / dkim.c file to the source tree (do not forget to add it to the build system by analogy with already existing modules).  It contains the source of our module. <br><br>  Next, we describe in the file the structure of the new lookup requests: <br><br><pre><code class="html hljs xml">/*       */ static lookup_info _lookup_info1 = { US"dkim_privkey", /* lookup name */ lookup_querystyle, _open_connection, /* open function */ NULL, /* no check function */ _get_priv_key, /* find function */ _close_connection, /* close function */ _tidy_cache, /* tidy function */ NULL, /* no quoting function */ NULL /* no version function */ }; /*      */ static lookup_info _lookup_info2 = { US"dkim_selector", /* lookup name */ ‚Ä¶ }; /*      */ static lookup_info _lookup_info3 = { US"dkim_domain", /* lookup name */ ‚Ä¶ }; static lookup_info *_lookup_list[] = { &amp;_lookup_info1, &amp;_lookup_info2, &amp;_lookup_info3 }; lookup_module_info dkim_lookup_module_info = { LOOKUP_MODULE_INFO_MAGIC, _lookup_list, 3 };</code> </pre> <br><br>  Callback functions in structures have a clear interface and purpose.  Details of the implementation of these functions are beyond the scope of the article.  I note only that the documentation and examples are enough for the eyes to understand all this. <br><br>  After the implementation of the module internals, it remains to register it.  We go to the src / drtables.c file and add the description of the module (where specifically to insert the lines, it is clear from the context - by analogy with the standard code): <br><br><pre> <code class="html hljs xml">extern lookup_module_info dkim_lookup_module_i void init_lookup_list(void) { ‚Ä¶ addlookupmodule(NULL, &amp;dkim_lookup_module_info); ... }</code> </pre> <br><br>  This is what the use of the module in the Exim configuration looks like: <br><br><pre> <code class="html hljs xml">begin transports remote_smtp: driver = smtp dkim_domain = ${lookup dkim_domain{$sender_address_domain}{$value}{DKIM_DEFAULT_DOMAIN}} dkim_selector = ${lookup dkim_selector{$sender_address_domain}{$value}{DKIM_DEFAULT_SELECTOR}} dkim_private_key = ${lookup dkim_privkey{$sender_address_domain}{$value}{DKIM_DEFAULT_KEY}}</code> </pre> <br><br>  Probably, you have already noticed that in order to fill all the parameters in the config, three lookups are made.  We decided to just use caching: the first request receives all the necessary information at once and stores it in the internal variable of the module, subsequent requests check whether the necessary information is cached, and if so, then they don‚Äôt apply to the database, they give it ready. <br><br>  The scheme of work is as follows: the domain administrator through the admin panel adds an existing one or generates a new secret and public DKIM key.  The admin panel stores them in the keystore.  Each time an email is sent on behalf of the business domain, Exim requests its secret key from the database.  If there is no key, then the default key is used for signing. <br><br>  To communicate with the database, our standard component Kapron is used, which we already described earlier in <a href="http://habrahabr.ru/company/mailru/blog/193906/">another article</a> . <br><br><h1>  How do I configure DKIM? </h1>  If you already use Mail.Ru for business, then setting up your own DKIM signature is very simple: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cbd/e9d/46c/cbde9d46c554a79415ab0b156c479b6a.jpg"><br><br><ol><li>  Go to biz.mail.ru with authorization of the domain administrator's mailbox. </li><li>  Select the connected domain for which you want to configure the DKIM signature. </li><li>  Go to the "Server Status" section and check whether the MX record is configured correctly.  After the successful verification of the MX record, the value of the TXT record will appear, which must be set in the DNS editor. </li><li>  Copy the value of the TXT record and set it in your domain‚Äôs DNS editor. </li><li>  Wait a few hours after setting the record so that the information will spread to all DNS servers. </li><li>  If the record is set up correctly and has passed all of our checks, we will send you a letter about successful setup and start signing all your letters with the correct DKIM signature. </li></ol><br>  If you have any questions about the configuration and use of DKIM-signature, leave them in the comments. </div><p>Source: <a href="https://habr.com/ru/post/225955/">https://habr.com/ru/post/225955/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../225935/index.html">In-Memory OLTP in SQL Server 2014. Part II</a></li>
<li><a href="../225945/index.html">We kill the "bell" from Google Chrome in the tray</a></li>
<li><a href="../225947/index.html">SwiftKey for Android. Now free</a></li>
<li><a href="../22595/index.html">Incredible!</a></li>
<li><a href="../225951/index.html">Google bought Skybox microsatellite company for 500 million</a></li>
<li><a href="../22596/index.html">Lebedev Decoder</a></li>
<li><a href="../225961/index.html">Managing Mozilla Firefox via GPO</a></li>
<li><a href="../225963/index.html">Attack on the black box. Reverse engineering of virtualized and mutated code</a></li>
<li><a href="../225965/index.html">Setting up server operation on CentOS with 2 gateways and balancing between them</a></li>
<li><a href="../225969/index.html">Understanding NSURL / NSURLComponents</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>