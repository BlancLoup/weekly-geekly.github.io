<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Checkup engine Spring RTS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Spring RTS is a real-time strategy game engine. Spring was originally written to repeat Total Annihilation, which was popular in the 90s / 00s. In the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Checkup engine Spring RTS</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/2f0/329/88e/2f032988e7c73919bde91852448cea2e.png" align="left">  Spring RTS is a real-time strategy game engine.  Spring was originally written to repeat Total Annihilation, which was popular in the 90s / 00s.  In the future, many other beautiful and interesting strategies appeared on this engine, including commercial ones.  The games under it are cross-platform and represent a three-dimensional real-time strategy with huge maps and a large number of combat and construction units.  Games have problems with stability.  Let's try to look at the source code (good, the project is open). <br><a name="habracut"></a><br>  <a href="http://www.viva64.com/go.php%3Furl%3D1455">Official site</a> . <br><br>  <a href="http://www.viva64.com/go.php%3Furl%3D1456">Source code</a> <br><br>  As an open source project, Spring RTS includes a number of open libraries that may also contain bugs, and ultimately they become part of the engine / games.  Some messages will be from the libraries that come with the engine.  Especially many warnings were in Assimp (Open Asset Import Library). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The verification of the code was performed using the <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> tool.  The article may not indicate all the errors that can be found using the analyzer.  Therefore, do not use the article as a guide to action.  Developers can get much more benefit by checking the project themselves. <br><br><h2>  Typos </h2><br>  <a href="http://www.viva64.com/ru/d/0090/">V501</a> There are identical sub-expressions "aha-&gt; mNumWeights! = Oha-&gt; mNumWeights"  operator.  assimp findinstancesprocess.cpp 87 <br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aiBone</span></span></span><span class="hljs-class"> {</span></span> C_STRUCT aiString mName; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mNumWeights; C_STRUCT aiVertexWeight* mWeights; C_STRUCT aiMatrix4x4 mOffsetMatrix; .... }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompareBones</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> aiMesh* orig, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> aiMesh* inst)</span></span></span><span class="hljs-function"> </span></span>{ .... aiBone* aha = orig-&gt;mBones[i]; aiBone* oha = inst-&gt;mBones[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aha-&gt;mNumWeights != oha-&gt;mNumWeights || <span class="hljs-comment"><span class="hljs-comment">//&lt;== aha-&gt;mOffsetMatrix != oha-&gt;mOffsetMatrix || aha-&gt;mNumWeights != oha-&gt;mNumWeights) { //&lt;== return false; } .... }</span></span></code> </pre> <br>  Two identical conditional expressions.  It is possible that in one of the cases it is necessary to compare the 'mName' or 'mWeights' field of the aiBone structure. <br><br>  <a href="http://www.viva64.com/ru/d/0090/">V501</a> There are identical to the left and the right of the | ||  operator: 0 == pArchive ||  0 == pArchive assimp q3bspfileimporter.cpp 631 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Q3BSPFileImporter::importTextureFromArchive( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Q3BSP::Q3BSPModel *pModel, Q3BSP::Q3BSPZipArchive *pArchive, aiScene* <span class="hljs-comment"><span class="hljs-comment">/*pScene*/</span></span>, aiMaterial *pMatHelper, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> textureId ) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> == pArchive || <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> == pArchive || <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> == pMatHelper) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( textureId &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || textureId &gt;= <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;( pModel-&gt;m_Textures.size() ) ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } .... }</code> </pre> <br>  Two more identical checks.  Most likely, there is not enough verification of the 'pModel' pointer, since the pointers passed to the function are checked here. <br><br>  <a href="http://www.viva64.com/ru/d/0153/">V560</a> A part of the conditional expression is always true: 0xFFFF.  engine-dedicated% engine-headless% engine-legacy% unitsync cpuid.cpp 144 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CpuId::getMasksIntelLeaf11Enumerate() { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((ebx &amp;&amp; <span class="hljs-number"><span class="hljs-number">0xFFFF</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">//&lt;== return; if (((ecx &gt;&gt; 8) &amp; 0xFF) == 1) { LOG_L(L_DEBUG,"[CpuId] SMT level found"); shiftCore = eax &amp; 0xf; } else { LOG_L(L_DEBUG,"[CpuId] No SMT level supported"); } .... }</span></span></code> </pre> <br>  Instead of the '&amp;&amp;' operator, the '&amp;' operator should have been used. <br><br>  <a href="http://www.viva64.com/ru/d/0119/">V530</a>  assimp b3dimporter.cpp 536 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> B3DImporter::ReadBB3D( aiScene *scene ){ _textures.clear(); _materials.size(); <span class="hljs-comment"><span class="hljs-comment">//&lt;== _vertices.clear(); _meshes.clear(); .... }</span></span></code> </pre> <br>  Calling the size () function without using the return value is clearly meaningless.  Most likely, here, as elsewhere, you need to call the function clear (). <br><br>  <a href="http://www.viva64.com/ru/d/0196/">V592</a> The expression was enclosed by parentheses twice: (((expression)).  One pair of parentheses is unnecessary or misprint is present.  engineSim weapon.cpp 597 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CWeapon::AttackUnit(CUnit* newTargetUnit, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> isUserTarget) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((!isUserTarget &amp;&amp; weaponDef-&gt;noAutoTarget)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } .... }</code> </pre> <br>  All conditional expression is in double brackets.  Perhaps the negation operator should apply to the entire expression, and not just to the 'isUserTarget' variable.  For example: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(isUserTarget &amp;&amp; weaponDef-&gt;noAutoTarget)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0291/">V666</a> Consider inspecting the third argument of the function 'TokenMatch'.  This is not the case.  assimp plyparser.cpp 185 <br><pre> <code class="cpp hljs">PLY::ESemantic PLY::Property::ParseSemantic(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TokenMatch(pCur,<span class="hljs-string"><span class="hljs-string">"specular_alpha"</span></span>,<span class="hljs-number"><span class="hljs-number">14</span></span>)) { eOut = PLY::EST_SpecularAlpha; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TokenMatch(pCur,<span class="hljs-string"><span class="hljs-string">"opacity"</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>)) { eOut = PLY::EST_Opacity; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TokenMatch(pCur,<span class="hljs-string"><span class="hljs-string">"specular_power"</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>)) { eOut = PLY::EST_PhongPower; } .... }</code> </pre> <br>  A string is passed to the 'TokenMatch' function and its length, which in one place is clearly not the same. <br><br>  Two more such places: <ul><li>  V666 Consider inspecting the third argument of the function 'TokenMatch'.  This is not the case.  assimp aseparser.cpp 1561 </li><li>  V666 Consider inspecting the third argument of the function 'TokenMatch'.  This is not the case.  assimp aseparser.cpp 1527 </li></ul><br><h2>  Copy paste </h2><br>  The following suspicious places I have separated from the simple typos that arise when typing.  Further, it is clearly seen how the duplicated code was ‚Äúsuccessfully‚Äù corrected. <br><br>  <a href="http://www.viva64.com/ru/d/0108/">V519</a> The 'pTexture-&gt; achFormatHint [2]' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 663, 664. assimp q3bspfileimporter.cpp 664 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Q3BSPFileImporter::importTextureFromArchive(....) { .... pTexture-&gt;achFormatHint[ <span class="hljs-number"><span class="hljs-number">0</span></span> ] = ext[ <span class="hljs-number"><span class="hljs-number">0</span></span> ]; pTexture-&gt;achFormatHint[ <span class="hljs-number"><span class="hljs-number">1</span></span> ] = ext[ <span class="hljs-number"><span class="hljs-number">1</span></span> ]; pTexture-&gt;achFormatHint[ <span class="hljs-number"><span class="hljs-number">2</span></span> ] = ext[ <span class="hljs-number"><span class="hljs-number">2</span></span> ]; pTexture-&gt;achFormatHint[ <span class="hljs-number"><span class="hljs-number">2</span></span> ] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; .... }</code> </pre> <br>  The last significant character was accidentally nullified.  There is even a separate article about such places: <a href="http://www.viva64.com/ru/b/0260/">Last line effect</a> . <br><br>  <a href="http://www.viva64.com/ru/d/0186/">V583</a> The '?:' Operator, regardless of its conditional expression, always returns one and the same value: player.cpuUsage.  engine-dedicated% engine-headless% engine-legacy gameserver.cpp 902 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CGameServer::LagProtection() { .... <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> playerCpuUsage = player.isLocal ? player.cpuUsage : player.cpuUsage; <span class="hljs-comment"><span class="hljs-comment">//&lt;== .... }</span></span></code> </pre> <br>  I think that conditional constructions are not used if there is no choice.  It can be assumed that here one variable was forgotten to be corrected. <br><br>  <a href="http://www.viva64.com/ru/d/0113/">V524</a> It is odd that the body of 'function is fully equivalent to the body of' + 'function.  assimp% engine-headless% engine-legacy types.h 183 <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** Component-wise addition */</span></span> aiColor3D <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>+(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> aiColor3D&amp; c) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> aiColor3D(r+cr,g+cg,b+cb); } <span class="hljs-comment"><span class="hljs-comment">/** Component-wise subtraction */</span></span> aiColor3D <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>-(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> aiColor3D&amp; c) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> aiColor3D(r+cr,g+cg,b+cb); }</code> </pre> <br>  The functions of addition and subtraction are equally suspiciously implemented.  Most likely, they forgot to correct the sign for subtraction. <br><br>  <a href="http://www.viva64.com/ru/d/0113/">V524</a> It is odd that the body of '&gt;' function is fully equivalent.  assimp 3dshelper.h 470 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> &lt; (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> aiFloatKey&amp; o) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mTime &lt; o.mTime;} <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> &gt; (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> aiFloatKey&amp; o) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mTime &lt; o.mTime;}</code> </pre> <br>  Opposite comparison operators are even more suspicious when implemented in the same way. <br><br><h2>  Formatting </h2><br>  In this section, we will talk about suspicious places related to code formatting.  Are the real errors here - more visible to the authors, but the programming style is clearly not the best. <br><br>  <a href="http://www.viva64.com/ru/d/0245/">V628</a> It was possible that the line was commented out, thus altering the program's operation logics.  assimp colladaparser.cpp 2281 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ColladaParser::ReadSceneLibrary() { .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( mReader-&gt;getNodeType() == irr::io::EXN_ELEMENT_END) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>( mReader-&gt;getNodeName(), <span class="hljs-string"><span class="hljs-string">"...."</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">//ThrowException( "Expected end of \"....\" element."); break; } .... }</span></span></code> </pre> <br>  Previously, this place was always called 'break', now the exit from the cycle is performed only by condition.  Perhaps it should comment out the condition itself. <br><br>  <a href="http://www.viva64.com/ru/d/0258/">V640</a> The code's operational logic does not correspond with its formatting.  The second statement will always be executed.  It is possible that curly brackets are missing.  sound oggstream.cpp 256 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> COggStream::UpdateBuffers() { .... active = DecodeStream(buffer); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (active) alSourceQueueBuffers(source, <span class="hljs-number"><span class="hljs-number">1</span></span>, &amp;buffer); CheckError(<span class="hljs-string"><span class="hljs-string">"...."</span></span>); .... }</code> </pre> <br>  The CheckError () function is not part of the condition, but it is written as if it were. <br><br>  <a href="http://www.viva64.com/ru/d/0265/">V646</a> Consider inspecting the application's logic.  It's possible that 'else' keyword is missing.  streflop s_atanf.cpp 90 <br><pre> <code class="cpp hljs">Simple __atanf(Simple x) { .... ix = hx&amp;<span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ix&gt;=<span class="hljs-number"><span class="hljs-number">0x50800000</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* if |x| &gt;= 2^34 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ix&gt;<span class="hljs-number"><span class="hljs-number">0x7f800000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x+x; <span class="hljs-comment"><span class="hljs-comment">/* NaN */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(hx&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> atanhi[<span class="hljs-number"><span class="hljs-number">3</span></span>]+atanlo[<span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -atanhi[<span class="hljs-number"><span class="hljs-number">3</span></span>]-atanlo[<span class="hljs-number"><span class="hljs-number">3</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ix &lt; <span class="hljs-number"><span class="hljs-number">0x3ee00000</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* |x| &lt; 0.4375f */</span></span> <span class="hljs-comment"><span class="hljs-comment">//&lt;== if (ix &lt; 0x31000000) { /* |x| &lt; 2^-29 */ if(huge+x&gt;one) return x; /* raise inexact */ } id = -1; } else { .... } .... }</span></span></code> </pre> <br>  The if statement is located on the same line as the closing bracket of the previous if.  Probably, in this place the 'else' keyword is missing, and the program does not work as the programmer expected. <br><br>  <a href="http://www.viva64.com/ru/d/0258/">V640</a> The code's operational logic does not correspond with its formatting.  The statement is indented.  It is possible that curly brackets are missing.  AAI aaibrain.cpp 1138 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> AAIBrain::BuildUnitOfMovementType(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ai-&gt;Getbt()-&gt;units_static[unit].cost &lt; ....) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ai-&gt;Getexecute()-&gt;AddUnitToBuildqueue(unit, <span class="hljs-number"><span class="hljs-number">3</span></span>, urgent)) { ai-&gt;Getbt()-&gt;units_dynamic[unit].requested += <span class="hljs-number"><span class="hljs-number">3</span></span>; ai-&gt;Getut()-&gt;UnitRequested(....); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ai-&gt;Getbt()-&gt;units_static[unit].cost &lt; ....) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ai-&gt;Getexecute()-&gt;AddUnitToBuildqueue(unit, <span class="hljs-number"><span class="hljs-number">2</span></span>, urgent)) ai-&gt;Getbt()-&gt;units_dynamic[unit].requested += <span class="hljs-number"><span class="hljs-number">2</span></span>; ai-&gt;Getut()-&gt;UnitRequested(....); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ai-&gt;Getexecute()-&gt;AddUnitToBuildqueue(unit, <span class="hljs-number"><span class="hljs-number">1</span></span>, urgent)) ai-&gt;Getbt()-&gt;units_dynamic[unit].requested += <span class="hljs-number"><span class="hljs-number">1</span></span>; ai-&gt;Getut()-&gt;UnitRequested(....); } .... }</code> </pre> <br>  Here at once in two places the operators are shifted in the condition.  Perhaps it would not look so suspicious if there were no similar condition with properly placed braces above. <br><br><h2>  Pointers </h2><br>  <a href="http://www.viva64.com/ru/d/0169/">V571</a> Recurring check.  The 'if (0 == MatFilePtr)' condition was already verified in line 140. assimp ogrematerial.cpp 143 <br><pre> <code class="cpp hljs">aiMaterial* OgreImporter::LoadMaterial(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> MaterialName) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { .... MatFilePtr=m_CurrentIOHandler-&gt;Open(MaterialFileName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>==MatFilePtr) { <span class="hljs-comment"><span class="hljs-comment">//try the default mat Library if(NULL==MatFilePtr) { MatFilePtr=m_CurrentIOHandler-&gt;Open(m_MaterialLibFilename); .... } } .... }</span></span></code> </pre> <br>  Duplicate checks are not a mistake, but there are many places in the project where there are really not enough checks. <br><br>  <a href="http://www.viva64.com/ru/d/0205/">V595</a> The 'model-&gt; GetRootPiece ()' pointer was used against nullptr.  Check lines: 236, 238. engine-headless% engine-legacy imodelparser.cpp 236 <br><pre> <code class="cpp hljs">S3DModel* C3DModelLoader::Load3DModel(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> modelName) { .... model-&gt;GetRootPiece()-&gt;SetCollisionVolume( <span class="hljs-comment"><span class="hljs-comment">//&lt;== new CollisionVolume("box", -UpVector, ZeroVector)); if (model-&gt;GetRootPiece() != NULL) { //&lt;== CreateLists(model-&gt;GetRootPiece()); } .... }</span></span></code> </pre> <br>  For example, in this place it would be worth checking the correctness of the pointer before its dereference. <br><br>  Similar places: <ul><li>  V595 The 'szComment' pointer was used before it was verified against nullptr.  Check lines: 1559, 1564. assimp unzip.c 1559 </li><li>  V595 The 'facCAI' pointer was used before it was verified against nullptr.  Check lines: 1059, 1064. engineSim commandai.cpp 1059 </li><li>  V595 The 'projectileDrawer' pointer was used before it was verified against nullptr.  Check lines: 170, 176. engineSim shieldprojectile.cpp 170 </li><li>  V595 The 'szComment' pointer was used before it was verified against nullptr.  Check lines: 2068, 2073. minizip unzip.c 2068 </li></ul><br>  <a href="http://www.viva64.com/ru/d/0176/">V576</a> Incorrect format.  Consider checking the sprintf function.  To print the value of the% p 'should be used.  engine-dedicated% engine-headless% engine-legacy seh.cpp 45 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __<span class="hljs-function"><span class="hljs-function">cdecl </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">se_translator_function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> err, struct _EXCEPTION_POINTERS* ep)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[<span class="hljs-number"><span class="hljs-number">128</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf,<span class="hljs-string"><span class="hljs-string">"%s(0x%08x) at 0x%08x"</span></span>,ExceptionName(err), <span class="hljs-comment"><span class="hljs-comment">//&lt;== errep-&gt;ExceptionRecord-&gt;ExceptionAddress); //&lt;== CrashHandler::ExceptionHandler(ep); throw std::exception(buf); }</span></span></code> </pre> <br>  To print the pointer, you must use the% p specifier.  The current code will work correctly as long as the pointer is the same size as the 'int'. <br><br>  <a href="http://www.viva64.com/ru/d/0261/">V643</a> Unusual pointer arithmetic: ".." + io-&gt; getOsSeparator ().  The value of the 'char' type is being added to the string pointer.  assimp lwsloader.cpp 467 <br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> LWSImporter::FindLWOFile(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&amp; in) { .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> test = <span class="hljs-string"><span class="hljs-string">".."</span></span> + io-&gt;getOsSeparator() + tmp; <span class="hljs-comment"><span class="hljs-comment">//&lt;== if (io-&gt;Exists(test)) return test; test = ".." + io-&gt;getOsSeparator() + test; //&lt;== if (io-&gt;Exists(test)) { return test; } .... }</span></span></code> </pre> <br>  It was expected that the string ".. \ tmp" would be received, but in this case an integer value would be added to the pointer to the string "..".  This is guaranteed to lead the string literal out of bounds.  To prevent such a situation, such arithmetic operations with string and character variables should be avoided. <br><br>  The correct code is: <br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> test = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>(<span class="hljs-string"><span class="hljs-string">".."</span></span>) + io-&gt;getOsSeparator() + tmp;</code> </pre> <br><h2>  Memory operations </h2><br>  <a href="http://www.viva64.com/ru/d/0101/">V512</a> A call-out the memset function will lead to underflow of the buffer area.  RAI gterrainmap.h 84 <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MAP_AREA_LIST_SIZE 50 struct TerrainMapMobileType { TerrainMapMobileType() { .... memset(area,0,MAP_AREA_LIST_SIZE); </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//&lt;== }; TerrainMapArea *area[MAP_AREA_LIST_SIZE]; //&lt;== .... };</span></span></span></span></code> </pre> <br>  Incomplete memory reset.  An array of 50 pointers is declared, and 50 bytes are reset.  The size of the array is 50 * sizeof (pointer) bytes. <br><br>  Similar places: <ul><li>  V512 A call of the memset function will lead to the underflow of the buffer BQ.  RAI builder.cpp 67 </li><li>  V512 A call of the memset function will lead to the underflow of the buffer SL.  RAI unitmanager.cpp 28 </li><li>  V512 A call of the memset function will lead to the underflow of the buffer group.  RAI unitmanager.cpp 29 </li><li>  V512 A call of the memset function will lead to the event flow of event buffer.  RAI rai.cpp 77 </li></ul><br>  <a href="http://www.viva64.com/ru/d/0340/">V701</a> realloc () possible leak: when realloc () fails in allocating memory, the original pointer 'dest' is lost.  Consider assigning realloc () to a temporary pointer.  assimp blenderloader.cpp 217 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> BlenderImporter::InternReadFile( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&amp; pFile, aiScene* pScene, IOSystem* pIOHandler) { .... dest = <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;Bytef*&gt;( <span class="hljs-built_in"><span class="hljs-built_in">realloc</span></span>(dest,total) ); <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(dest + total - have,block,have); .... }</code> </pre> <br>  In case the size of the memory block cannot be changed, the realloc () function will return a null pointer, and the pointer to the old memory area will be lost.  You must save the pointer to the buffer variable and do the appropriate checks. <br><br>  Similar place: <ul><li>  V701 realloc () possible leak: when realloc () fails in allocating memory, the original pointer 'dest' is lost.  Consider assigning realloc () to a temporary pointer.  assimp xglloader.cpp 181 </li></ul><br><h2>  Undefined behavior </h2><br>  <a href="http://www.viva64.com/ru/d/0225/">V610</a> Undefined behavior.  Check the shift operator '&lt;&lt;.  The left operand '(- 1)' is negative.  engine-dedicated% engine-headless% engine-legacy% unitsync cpuid.cpp 176 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CpuId::getMasksIntelLeaf11() { getMasksIntelLeaf11Enumerate(); <span class="hljs-comment"><span class="hljs-comment">// We determined the shifts now compute the masks maskVirtual = ~((-1) &lt;&lt; shiftCore); maskCore = (~((-1) &lt;&lt; shiftPackage)) ^ maskVirtual; maskPackage = (-1) &lt;&lt; shiftPackage; }</span></span></code> </pre> <br>  According to the C ++ 11 standard, a negative number shift leads to undefined behavior. <br><br><h2>  Conclusion </h2><br>  I hope the improvement of the quality of this project will lead to the improvement of all related products.  This is a good project for novice game developers and gamers, fans of the genre. <br><br>  Using static analysis regularly, you can save a lot of time on solving more useful tasks. <br><br><h2>  This article is in English. </h2><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Svyatoslav Razmyslov.  <a href="http://www.viva64.com/en/b/0293/">Spring RTS Engine Checkup</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected the answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio and CppCat, version 2014</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/244865/">https://habr.com/ru/post/244865/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../244855/index.html">Steam launched the game broadcast service</a></li>
<li><a href="../244857/index.html">Virtual hacksummit.org developer conference</a></li>
<li><a href="../244859/index.html">Product Design Digest November 2014</a></li>
<li><a href="../244861/index.html">Short guide: GitHub via I2P</a></li>
<li><a href="../244863/index.html">Cashier in Italian</a></li>
<li><a href="../244869/index.html">Quick Guide: GitHub via Tor</a></li>
<li><a href="../244871/index.html">F # Advent calendar in English for 2014</a></li>
<li><a href="../244877/index.html">How to increase sales in the online store by segmenting sheets of email-mailings</a></li>
<li><a href="../244879/index.html">Process Mining: Acquaintance</a></li>
<li><a href="../244883/index.html">VMware Certification</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>