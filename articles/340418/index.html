<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we made npm packages work in a browser</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="During the initial development of the CodeSandbox project, I always ignored support for npm dependencies. I thought it was impossible to install an ar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we made npm packages work in a browser</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/59/e8/94/59e894c71e991131484220.jpeg"></p><br><p>  During the initial development of the CodeSandbox project, I always ignored support for npm dependencies.  I thought it was impossible to install an arbitrary, random number of packages in the browser, my brain just refused to think about it. </p><br><p>  Today npm support is one of the defining capabilities of CodeSandbox, so somehow we managed to implement it.  For the feature to work under any scenarios, we had to do quite a few iterations, rewriting the code many times, and even today we can still improve the logic.  I will tell you how we started supporting npm, what we have today and what we can do to improve it. </p><a name="habracut"></a><br><h2 id="pervaya-versiya">  "First version </h2><br><p>  I just didn‚Äôt know how to tackle it, so I started with a very simple version of npm support: </p><br><p><img src="https://habrastorage.org/webt/59/e7/97/59e797d68c7e6675168880.png"><br>  <em>The first version, the import of stylized components and React (November 25, 2016)</em> </p><br><p>  This version was very simple.  So much so that in fact there was no support, I just locally installed the dependencies and made a stub for each call as an already established dependency.  Of course, the scalability of up to 400 thousand packages of different versions does not smell here. </p><br><p>  Although this version is useless, it was nice to see that I made at least two dependencies work in a sandbox environment. </p><br><h2 id="webpack-versiya">  Webpack version </h2><br><p>  I was satisfied with the first version, and it seemed to me that it was enough for MVP (the first release of CodeSandbox).  I had no idea that it was possible to establish any dependence at all without the use of magic.  Until I came across <a href="https://esnextb.in/">https://esnextb.in/</a> .  The guys already supported any dependencies from npm, it was enough to define them in package.json - and everything worked in a magical way! </p><br><p>  It was a great lesson for me.  I didn‚Äôt even think about such npm support because I considered it unreal.  But, having seen the living proof of reality, I began to think a lot about it.  First, it was necessary to explore the possibilities before discarding the idea. </p><br><p>  In my thoughts, I have complicated the task too much.  My first version didn't fit in my mind, so I drew a diagram: </p><br><p><img src="https://habrastorage.org/webt/59/e7/97/59e797d69d455131877310.png"><br>  <em>The first idea is probably wrong.</em> </p><br><p>  This approach had one advantage: the real implementation is much simpler than expected! </p><br><p>  I found out that the WebPack DLL plugin could bundle dependencies and issue a JS package (bundle) with a manifest.  This manifesto looked like this: </p><br><pre><code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"dll_bundle"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"content"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"./node_modules/fbjs/lib/emptyFunction.js"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"./node_modules/fbjs/lib/invariant.js"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"./node_modules/fbjs/lib/warning.js"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">"./node_modules/react"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"./node_modules/fbjs/lib/emptyObject.js"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"./node_modules/object-assign/index.js"</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-attr"><span class="hljs-attr">"./node_modules/prop-types/checkPropTypes.js"</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-attr"><span class="hljs-attr">"./node_modules/prop-types/lib/ReactPropTypesSecret.js"</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-attr"><span class="hljs-attr">"./node_modules/react/cjs/react.development.js"</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span> } }</code> </pre> <br><p>  Each path is associated with a module ID.  If I need react, then just call <code>dll_bundle(3)</code> , and I will get a React!  It was perfect for us, so I came up with just such a real system: </p><br><p><img src="https://habrastorage.org/webt/59/e7/97/59e797d6b86fe263877055.png"><br>  <em>The source code of the service is <a href="https://github.com/CompuIves/codesandbox-bundler">here</a> .</em>  <em>The service also contains code for publishing any sandbox in npm, we later abandoned this function.</em> </p><br><p>  For each request to the packer, I created a new directory in <code>/tmp/:hash</code> , started <code>yarn add ${dependencyList}</code> and allowed WebPack to build the package.  I saved the result in gcloud as a cache.  It turns out to be much simpler than in the diagram, mainly because I replaced the installation of dependencies with Yarn and collected them in packages using WebPack. </p><br><p>  When loading the sandbox, before performing the execution, we first checked the presence of the manifest and the package.  During the analysis, we called <code>dll_bundle(:id)</code> for each dependency.  This solution worked perfectly, I created the first version with normal support for npm-dependencies! </p><br><p><img src="https://habrastorage.org/webt/59/e7/97/59e797d70058d190682591.png"><br>  <em>Hooray!</em>  <em>We have an interface in the style of Material Design and dynamically executed React!</em>  <em>(December 24, 2016)</em> </p><br><p>  The system still had a big limitation: it did not support files that were not in the dependency graph of the WebPack.  This means that, for example, <code>require('react-icons/lib/fa/fa-beer')</code> will not work, because it will never be requested first by the dependency input point. </p><br><p>  Nevertheless, I created a release of CodeSandbox with such support and contacted <a href="https://medium.com/%40christianalfoni">Christian Alfoni, the</a> author of <a href="https://medium.com/%40christianalfoni">WebPackBin</a> .  To support npm dependencies, we used very similar systems and faced the same limitations.  Therefore, we decided to join forces and create an absolute packer! </p><br><h2 id="webpack-s-zapisyami">  Webpack with posts </h2><br><p>  The ‚Äúabsolute‚Äù packer received the same functionality as the previous one, except for the algorithm created by Christian, which added files to the package depending on their importance.  We manually added entry points to ensure that WebPack also packs these files.  After multiple system settings, it began to work with any (?) Combination.  So we could already request React icons and CSS files. </p><br><p>  The new system received an architectural upgrade: we had only one dll service serving the load balancer and cache.  Packaging was done by several packers, which could be added dynamically. </p><br><p><img src="https://habrastorage.org/webt/59/e7/97/59e797d734c5a533412745.png"></p><br><p>  We wanted our packaging service to be available to everyone.  Therefore, we made a <a href="http://webpack-dll-prod.herokuapp.com/">site</a> that explained the operation of the service and use cases.  It brought us fame, we were even mentioned <a href="https://blog.codepen.io/2017/08/11/using-resources-npm-codepen/">on the CodePen blog</a> ! </p><br><p>  But the "absolute" packer had some limitations and shortcomings.  As the popularity grew, the costs grew exponentially and we cached by <strong>combination of</strong> packages.  This means that when adding a dependency, you had to recompile the whole combination. </p><br><h2 id="besservernaya-obrabotka-serverless">  Serverless processing (serverless) </h2><br><p>  I always wanted to try this cool technology - serverless processing.  With its help, you can determine the function that will be executed on request. </p><br><p>  It will start, process the request and after some time kill itself.  This means very high scalability: if you receive a thousand simultaneous requests, you can instantly start a thousand servers.  But at the same time pay only for the real time of the servers. </p><br><p>  It sounds perfect for our service: it does not work all the time, and we need high consistency in case of multiple requests being received simultaneously.  So I started experimenting with the appropriately named <a href="https://serverless.com/">Serverless framework</a> . </p><br><p>  The change of our service went smoothly (thanks to Serverless!), After two days I had a working version.  I created three serverless functions: </p><br><ol><li>  Metadata handler: this service resolved versions and peerDependencies, and also requested the packer function. </li><li>  Packer: this service installs and bundles dependencies. </li><li>  Minifikator (Uglifier) ‚Äã‚Äãwas responsible for asynchronous minification (uglifying) of the resulting packets. </li></ol><br><p>  I launched a new service next to the old one, everything worked perfectly!  We predicted spending at $ 0.18 per month (compared with the previous $ 100), and the response time improved by 40-700%. </p><br><p><img src="https://habrastorage.org/webt/59/e7/97/59e797d73f115345948921.png"></p><br><p>  A few days later I noticed one restriction: the lambda function had only 500 MB of disk space.  This means that some dependency combinations could not be installed.  This was unacceptable, and I went back to drawing schemes. </p><br><h3 id="peresmotr-besservernoy-obrabotki">  Revise serverless processing </h3><br><p>  A couple of months passed, and I released a <a href="https://hackernoon.com/how-i-created-a-parallel-offline-extensible-browser-based-bundler-886db508cc31">new packer</a> for CodeSandbox.  It was very powerful and supported more libraries like Vue and Preact.  Thanks to this, we have interesting requests.  For example: if you want to use React libraries in Preact, then you need to associate <code>require('react')</code> with <code>require('preact-compat')</code> .  For Vue, you may need to resolve (resolve) <code>@/components/App.vue</code> for sandbox files.  Our packer does not do this for dependencies, while others do. </p><br><p>  I began to think that perhaps we would shift the packaging task to the browser wrapper.  If you simply send the corresponding files to the browser, then as a result, its packer will assemble the dependencies into packages.  So it will be faster, because we do not process the whole package, but only a part. </p><br><p>  This approach has a big advantage: we can independently install and cache dependencies.  Or simply merge the dependency files on the client.  This means that if you request a new dependency on top of an existing one, we only need to collect the files for the new dependency!  This solves the 500 MB problem for AWS Lambda, because we only install one dependency.  So you can throw WebPack out of the packer, because it is now fully responsible for calculating the relevant files and sending them. </p><br><p><img src="https://habrastorage.org/webt/59/e7/97/59e797d75d80a153370887.png"><br>  <em>Parallel packaging of our dependencies</em> </p><br><p>  <em>Note: you can throw out the packer and dynamically query each file from unpkg.com.</em>  <em>Perhaps this is faster than my approach.</em>  <em>But I decided to leave the packer for the time being (at least for the editor), because I want to provide offline support.</em>  <em>This is only possible if you have all the possible relevant files.</em> </p><br><h3 id="rabota-na-praktike">  Work in practice </h3><br><p>  When requesting a combination of dependencies, we first check whether it is already stored in S3.  If not, then we request a combination from the API service, and the latter requests all packers separately for each dependency.  If we get 200 OK in response, then we request S3 again. </p><br><p>  The packer installs dependencies using Yarn and, bypassing the AST of all files in the input point directory, finds all relevant files.  It searches for require statements and adds to the file list.  This is done recursively, and as a result we get a dependency graph.  Example output ( <code>react@latest</code> ): </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"aliases"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"asap"</span></span>: <span class="hljs-string"><span class="hljs-string">"asap/browser-asap.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"asap/asap"</span></span>: <span class="hljs-string"><span class="hljs-string">"asap/browser-asap.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"asap/asap.js"</span></span>: <span class="hljs-string"><span class="hljs-string">"asap/browser-asap.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"asap/raw"</span></span>: <span class="hljs-string"><span class="hljs-string">"asap/browser-raw.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"asap/raw.js"</span></span>: <span class="hljs-string"><span class="hljs-string">"asap/browser-raw.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"asap/test/domain.js"</span></span>: <span class="hljs-string"><span class="hljs-string">"asap/test/browser-domain.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"core-js"</span></span>: <span class="hljs-string"><span class="hljs-string">"core-js/index.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"encoding"</span></span>: <span class="hljs-string"><span class="hljs-string">"encoding/lib/encoding.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"fbjs"</span></span>: <span class="hljs-string"><span class="hljs-string">"fbjs/index.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"iconv-lite"</span></span>: <span class="hljs-string"><span class="hljs-string">"iconv-lite/lib/index.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"iconv-lite/extend-node"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"iconv-lite/streams"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"is-stream"</span></span>: <span class="hljs-string"><span class="hljs-string">"is-stream/index.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"isomorphic-fetch"</span></span>: <span class="hljs-string"><span class="hljs-string">"isomorphic-fetch/fetch-npm-browserify.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"js-tokens"</span></span>: <span class="hljs-string"><span class="hljs-string">"js-tokens/index.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"loose-envify"</span></span>: <span class="hljs-string"><span class="hljs-string">"loose-envify/index.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"node-fetch"</span></span>: <span class="hljs-string"><span class="hljs-string">"node-fetch/index.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"object-assign"</span></span>: <span class="hljs-string"><span class="hljs-string">"object-assign/index.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"promise"</span></span>: <span class="hljs-string"><span class="hljs-string">"promise/index.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"prop-types"</span></span>: <span class="hljs-string"><span class="hljs-string">"prop-types/index.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"react"</span></span>: <span class="hljs-string"><span class="hljs-string">"react/index.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"setimmediate"</span></span>: <span class="hljs-string"><span class="hljs-string">"setimmediate/setImmediate.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ua-parser-js"</span></span>: <span class="hljs-string"><span class="hljs-string">"ua-parser-js/src/ua-parser.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"whatwg-fetch"</span></span>: <span class="hljs-string"><span class="hljs-string">"whatwg-fetch/fetch.js"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"contents"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"react/index.js"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"requires"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"./cjs/react.development.js"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"content"</span></span>: <span class="hljs-string"><span class="hljs-string">"/* code */"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"object-assign/index.js"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"requires"</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">"content"</span></span>: <span class="hljs-string"><span class="hljs-string">"/* code */"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"fbjs/lib/emptyObject.js"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"requires"</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">"content"</span></span>: <span class="hljs-string"><span class="hljs-string">"/* code */"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"fbjs/lib/invariant.js"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"requires"</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">"content"</span></span>: <span class="hljs-string"><span class="hljs-string">"/* code */"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"fbjs/lib/emptyFunction.js"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"requires"</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">"content"</span></span>: <span class="hljs-string"><span class="hljs-string">"/* code */"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"react/cjs/react.development.js"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"requires"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"object-assign"</span></span>, <span class="hljs-string"><span class="hljs-string">"fbjs/lib/warning"</span></span>, <span class="hljs-string"><span class="hljs-string">"fbjs/lib/emptyObject"</span></span>, <span class="hljs-string"><span class="hljs-string">"fbjs/lib/invariant"</span></span>, <span class="hljs-string"><span class="hljs-string">"fbjs/lib/emptyFunction"</span></span>, <span class="hljs-string"><span class="hljs-string">"prop-types/checkPropTypes"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"content"</span></span>: <span class="hljs-string"><span class="hljs-string">"/* code */"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"fbjs/lib/warning.js"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"requires"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"./emptyFunction"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"content"</span></span>: <span class="hljs-string"><span class="hljs-string">"/* code */"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"prop-types/checkPropTypes.js"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"requires"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"fbjs/lib/invariant"</span></span>, <span class="hljs-string"><span class="hljs-string">"fbjs/lib/warning"</span></span>, <span class="hljs-string"><span class="hljs-string">"./lib/ReactPropTypesSecret"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"content"</span></span>: <span class="hljs-string"><span class="hljs-string">"/* code */"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"prop-types/lib/ReactPropTypesSecret.js"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"requires"</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">"content"</span></span>: <span class="hljs-string"><span class="hljs-string">"/* code */"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"react/package.json"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"requires"</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">"content"</span></span>: <span class="hljs-string"><span class="hljs-string">"/* code */"</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"dependency"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"react"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"16.0.0"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"dependencyDependencies"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"asap"</span></span>: <span class="hljs-string"><span class="hljs-string">"2.0.6"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"core-js"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.2.7"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"encoding"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.1.12"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"fbjs"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.8.16"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"iconv-lite"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.4.19"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"is-stream"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.1.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"isomorphic-fetch"</span></span>: <span class="hljs-string"><span class="hljs-string">"2.2.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"js-tokens"</span></span>: <span class="hljs-string"><span class="hljs-string">"3.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"loose-envify"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.3.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"node-fetch"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.7.3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"object-assign"</span></span>: <span class="hljs-string"><span class="hljs-string">"4.1.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"promise"</span></span>: <span class="hljs-string"><span class="hljs-string">"7.3.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"prop-types"</span></span>: <span class="hljs-string"><span class="hljs-string">"15.6.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"setimmediate"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0.5"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ua-parser-js"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.7.14"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"whatwg-fetch"</span></span>: <span class="hljs-string"><span class="hljs-string">"2.0.3"</span></span> } }</code> </pre> <br><h2 id="preimuschestva">  Benefits </h2><br><h3 id="ekonomiya">  Saving </h3><br><p>  I deployed a new packer on October 5th, and in two days we paid a ridiculous $ 0.02 dollar!  And this is for the creation of the cache.  Giant savings compared to $ 100 per month. </p><br><h3 id="vyshe-proizvoditelnost">  Higher performance </h3><br><p>  A new combination of dependencies you can get in 3 seconds.  Any combination.  On the old system, sometimes it took a minute.  If the combination is cached, you will receive it in 50 milliseconds with a fast connection.  We cache with Amazon Cloudfront around the world.  Also, our sandbox is faster, because now we parse and execute only the relevant .js files. </p><br><h3 id="bolshe-gibkosti">  More flexibility </h3><br><p>  Our packager now handles dependencies as if they were local files.  This means that our error stack traces have become much cleaner, we can now include any dependency files (.scss, .vue, etc.) and easily maintain aliases.  All this works as if the dependencies are installed locally. </p><br><h2 id="reliz">  Release </h2><br><p>  I started using the new packer next to the old one to build a cache.  In two days, 2000 different combinations and 1400 different dependencies were cached.  I want to intensely test the new version before fully switching to it.  You can try to enable it in your settings. </p><br><p><img src="https://habrastorage.org/webt/59/e7/97/59e797d774c84865809970.png"><br>  <em><a href="https://github.com/CompuIves/dependency-packager">Source code</a></em>  <em>It is still unsightly, soon I will clean it, write README.md, etc.</em> </p><br><h3 id="ispolzuyte-serverless">  Use Serverless! </h3><br><p>  I am very impressed with this technology, it makes it incredibly easy to scale and manage servers.  The only thing that always kept me, is a very complicated setup, but the developers from <a href="https://serverless.com/">serverless.com have</a> greatly simplified it.  Very grateful for their work, I think that serverless is the future of many forms of applications. </p><br><h3 id="buduschee">  Future </h3><br><p>  We can still greatly improve our system.  I want to explore the dynamic queries required in embedding and offline saving.  It is difficult to strike a balance, but it should be possible.  You can start independently cache dependencies in the browser, based on what it allows you to do.  In this case, you sometimes do not even need to download new dependencies when visiting a new sandbox with a different combination of dependencies.  I also want to explore dependency resolution better.  In the new system there is a possibility of a version conflict, which I want to exclude before giving up the old version. </p><br><p>  In any case, I am very pleased with the result and intend to work on innovations for CodeSandbox! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/340418/">https://habr.com/ru/post/340418/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../340408/index.html">How to add information about transfers to the game assembly at Unity</a></li>
<li><a href="../340410/index.html">Visual Scripting: The Future Is Now?</a></li>
<li><a href="../340412/index.html">Monday begins on Saturday: 28 years of LANIT</a></li>
<li><a href="../340414/index.html">Two days left until the Moscow Python conference. What is interesting in the program?</a></li>
<li><a href="../340416/index.html">Google AdWords Extensions: Making Advertising More Effective</a></li>
<li><a href="../340420/index.html">Indentation in the layout (margin / padding)</a></li>
<li><a href="../340424/index.html">From optimizations to Machine Learning: an interview with the author of Android High Performance Programming</a></li>
<li><a href="../340426/index.html">Those. support. How much money can you make on this? (Part 1 - Russia)</a></li>
<li><a href="../340430/index.html">Friday format: 7 sure ways to ruin the work with ServiceNow at the start</a></li>
<li><a href="../340432/index.html">25 materials on ITSM, incident handling and business process development</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>