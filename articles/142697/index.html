<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing your Core Image Filter</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Long ago, in 2005, they bought me the first camera phone with a camera - Siemens M65. After a decent amount of shots were taken, the need arose to str...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing your Core Image Filter</h1><div class="post__text post__text-html js-mediator-article">  Long ago, in 2005, they bought me the first camera phone with a camera - Siemens M65.  After a decent amount of shots were taken, the need arose to streamline them - a small Delphi program was written that organized and allowed you to view images by date - by choosing the desired year, month and day.  As time went on, the power of the phones increased, the number of megapixels, video support appeared - and all this was built into the program as it appeared.  Later, a version of the program appeared under Mac OS X, which was written using the frameworks available in this OS for working with images (Core Image) and video (AV Foundation).  Let's talk about the first framework and creating your own filter for it in more detail. <br><a name="habracut"></a><br><br><h4>  Core image </h4><br>  <a href="http://en.wikipedia.org/wiki/Core_Image">Core Image</a> - image processing technology, which appeared in Mac OS X 10.4 - allows pixel-by-pixel operations with the original image using so-called plug-ins.  There are a lot of built-in plug-ins - with a certain amount of time on the basis of Core Image, you can make some analogue of Photoshop with layers, blending modes, level adjustments, brightness, etc.  And all the miscalculations will be made on the <a href="http://ru.wikipedia.org/wiki/%25D0%2593%25D1%2580%25D0%25B0%25D1%2584%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9_%25D0%25BF%25D1%2580%25D0%25BE%25D1%2586%25D0%25B5%25D1%2581%25D1%2581%25D0%25BE%25D1%2580">GPU</a> (if available), which will give a significant speed in image processing. <br><br><h4>  Core Image Filter </h4><br>  Core Image Filter is an image processing plugin that has at least 2 functions: take an input image and display the result.  On <a href="http://developer.apple.com/library/mac/">the</a> embedded plugin <a href="http://developer.apple.com/library/mac/">description page</a> there are examples of how the image will look before and after the filter.  Also plugins are divided into categories: <br><ul><li>  <b>CICategoryBlur</b> - image blur (example - Gaussian blur) </li><li>  <b>CICategoryColorAdjustment</b> - color management (example - work with color channels) </li><li>  <b>CICategoryColorEffect</b> - color effects (example - sepia) </li><li>  <b>CICategoryCompositeOperation</b> - image overlay (for example, 2-screen image overlay) </li><li>  <b>CICategoryDistortionEffect</b> - image distortion (example - "twisting" the image) </li><li>  <b>CICategoryGenerator</b> - image generators (example - image generator with specified color) </li><li>  <b>CICategoryGeometryAdjustment</b> - image geometry management (example - scaling, perspective) </li><li>  <b>CICategoryGradient</b> - gradient generators (example - linear, radial gradients) </li></ul>  Other categories are also available, a full list of the <a href="http://developer.apple.com/library/mac/">link</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Own filter </h4><br><h5>  Training </h5>  Our goal is to write our own plugin filter.  And as an example, I decided to choose to create an <a href="http://ru.wikipedia.org/wiki/%25D0%2590%25D0%25BD%25D0%25B0%25D0%25B3%25D0%25BB%25D0%25B8%25D1%2584">anaglyph</a> image to view it with red-turquoise glasses.  All this was implemented in my program, which was discussed at the beginning of the article.  To get started, run xcode.  Next, we decide whether we will write the plugin as a separate project, or add it to the existing one.  In my case, I added a new project to the existing one - for this, just below the TARGETS window, click Add Target: <br><img src="https://habrastorage.org/storage2/6af/354/e56/6af354e56868fee0614e64a3627d1bb6.png"><br>  and select: Mac OS X -&gt; System Plug-in -&gt; Image Unit Plug-in: <br><img src="https://habrastorage.org/storage2/ecb/eaf/3ab/ecbeaf3ab86364f8aa28461fbc5e466c.png"><br>  Next, enter the name of the filter (my version is AnaglyphFilter) and immediately add it to the project assembly (Product - Edit Scheme - Build, Targets list).  I also added the dependency of the main project build on the filter (so that the filter was probably built when building the project, Build Phases - Target Dependencies) and automatically copying the filter to the Resources folder, all the same main project (Build Phases - Add Build Phase - Add Copy Files) .  Now you can proceed directly to the programming of the filter.  But first, a little about the content of the plugin. <br><br><h5>  Inside view </h5>  After creating a new plug-in, you can see the following files in the &lt;plug-in name&gt; folder in the project tree: <br><ul><li>  <i>AnaglyphFilterPlugInLoader .h / .m</i> - the class of the loader of our plugin </li><li>  <i>AnaglyphFilterFilter .h / .m</i> is a plugin class that contains some auxiliary data. </li><li>  <i>index.html</i> - file with the description / help of our plugin </li><li>  <i>Description.plist</i> - information about our plugin </li><li>  <i>Description.strings</i> - localization file </li><li>  <i>AnaglyphFilterFilterKernel.cikernel</i> - the most interesting part is the <a href="https://developer.apple.com/library/mac/">Core Image Kernel Language</a> (CIKL) program, which is responsible for working with pixels </li></ul><br><br><h5>  We remove too much </h5>  The template that xcode made for us needs to be modified to suit our needs.  The filter will have 2 input parameters: the main image (left) and right.  The output will be a combined anaglyph image.  For a start, we leave only the parameters we need.  Open the AnaglyphFilterFilter.h file and convert the AnaglyphFilterFilter class to the following form: <br><blockquote>  <font color="#a61390">@interface</font> AnaglyphFilterFilter <font color="#002200">:</font> CIFilter <br>  <font color="#002200">{</font> <br>  CIImage <font color="#002200">*</font> inputImage;  <font color="#11740a">// input image (left)</font> <br>  CIImage <font color="#002200">*</font> rightImage;  <font color="#11740a">// right image</font> <br>  <font color="#002200">}</font> <br>  <font color="#a61390">@end</font> </blockquote><br>  There are several procedures in the AnaglyphFilterFilter.m file, I provide a description: <br><ul><li>  <i>init</i> - download the plug-in code from the file and convert it to a CIKernel object, you don‚Äôt need to change anything </li><li>  <i>regionOf</i> - returns the region of the image with which the filter will work.  In our case, we need the whole image, so we change the code like this: <blockquote>  <font color="#002200">-</font> <font color="#002200">(</font> CGRect <font color="#002200">)</font> regionOf <font color="#002200">:</font> <font color="#002200">(</font> <font color="#a61390">int</font> <font color="#002200">)</font> sampler destRect <font color="#002200">:</font> <font color="#002200">(</font> CGRect <font color="#002200">)</font> rect userInfo <font color="#002200">:</font> <font color="#002200">(</font> NSValue <font color="#002200">*</font> <font color="#002200">)</font> value <br>  <font color="#002200">{</font> <br>  <font color="#a61390">return</font> rect; <br>  <font color="#002200">}</font> </blockquote></li><li>  <i>customAttributes</i> - setting and description of additional filter attributes.  Add the attribute of the right image: <blockquote>  <font color="#002200">-</font> <font color="#002200">(</font> <font color="#400080">NSDictionary</font> <font color="#002200">*</font> <font color="#002200">)</font> customAttributes <br>  <font color="#002200">{</font> <br>  <font color="#a61390">return</font> <font color="#002200">[</font> <font color="#400080">NSDictionary</font> dictionaryWithObjectsAndKeys <font color="#002200">:</font> <br>  <font color="#002200">[</font> <font color="#400080">NSDictionary</font> dictionaryWithObjectsAndKeys <font color="#002200">:</font> <br>  <font color="#002200">[</font> CIImage class <font color="#002200">]</font> , kCIAttributeClass, <br>  <font color="#002200">[</font> CIImage emptyImage <font color="#002200">]</font> , kCIAttributeDefault, <br>  <font color="#a61390">nil</font> <font color="#002200">]</font> , <font color="#bf1d1a">@</font> <font color="#bf1d1a">"rightImage"</font> , <br>  <font color="#a61390">nil</font> <font color="#002200">]</font> ; <br>  <font color="#002200">}</font> </blockquote></li><li>  <i>outputImage</i> is a subroutine call for working with an image.  In the apply procedure, the leftSamp and rightSamp parameters are passed, which will be passed to the CIKL subroutine: <blockquote>  <font color="#002200">-</font> <font color="#002200">(</font> CIImage <font color="#002200">*</font> <font color="#002200">)</font> outputImage <br>  <font color="#002200">{</font> <br>  CISampler <font color="#002200">*</font> leftSamp <font color="#002200">=</font> <font color="#002200">[</font> CISampler samplerWithImage <font color="#002200">:</font> inputImage <font color="#002200">]</font> ; <br>  CISampler <font color="#002200">*</font> rightSamp <font color="#002200">=</font> <font color="#002200">[</font> CISampler samplerWithImage <font color="#002200">:</font> rightImage <font color="#002200">]</font> ; <br>  <font color="#a61390">return</font> <font color="#002200">[</font> self apply <font color="#002200">:</font> _AnaglyphFilterFilterKernel, leftSamp, rightSamp, <br>  kCIApplyOptionDefinition, <font color="#002200">[</font> src definition <font color="#002200">]</font> , <font color="#a61390">nil</font> <font color="#002200">]</font> ; <br>  <font color="#002200">}</font> </blockquote></li></ul><br><br><h5>  CIKL program </h5>  This is CIKL code, which is a kind of <a href="http://ru.wikipedia.org/wiki/OpenGL_Shading_Language">OpenGL Shading Language</a> .  Subroutines that we call from the main code begin with the key word <i>kernel</i> and can be found using the <i>name</i> property of the CIKernel class.  But in our case, we need only one procedure, so initialization is as follows (in the init procedure): <br><blockquote>  _AnaglyphFilterFilterKernel <font color="#002200">=</font> <font color="#002200">[</font> <font color="#002200">[</font> kernels objectAtIndex <font color="#002200">:</font> <font color="#2400d9">0</font> <font color="#002200">]</font> retain <font color="#002200">]</font> ; </blockquote>  Similarly, you could get the procedure by name: <br><blockquote>  _AnaglyphFilterFilterKernel <font color="#002200">=</font> <font color="#002200">[</font> <font color="#002200">[</font> kernels findKernelByName <font color="#002200">:</font> <font color="#bf1d1a">@</font> <font color="#bf1d1a">"procedureName"</font> <font color="#002200">]</font> retain <font color="#002200">]</font> ; </blockquote>  The very procedure in the <i>.cikernel</i> file will look something like this: <blockquote>  kernel <font color="#000066">vec4</font> procedureName <font color="#000066">(</font> sampler leftSamp <font color="#000066">,</font> sampler rightSamp <font color="#000066">)</font> <br>  <font color="#000066">{</font> <br>  <font color="#666666">// code to work with pixels</font> <br>  <font color="#666666">// return the result</font> <br>  <font color="#000066">}</font> </blockquote><br><br><h5>  Anaglyph </h5>  There are different ways of obtaining anaglyph images.  For our case, we will use the full-color image overlay mode: <br><ul><li>  At the left image we remove the green and blue channels, it remains red </li><li> At the right image we remove the red channel, remain green and blue </li><li>  We combine the image by the screen blending method. </li></ul><br>  The CIKL subroutine will look like this: <br><blockquote>  kernel <font color="#000066">vec4</font> anaglyphRedCyan <font color="#000066">(</font> sampler leftSamp <font color="#000066">,</font> sampler rightSamp <font color="#000066">)</font> <br>  <font color="#000066">{</font> <br>  <font color="#666666">// get the pixel of the left image</font> <br>  <font color="#000066">vec4</font> l <font color="#000066">=</font> sample <font color="#000066">(</font> leftSamp <font color="#000066">,</font> samplerCoord <font color="#000066">(</font> leftSamp <font color="#000066">)</font> <font color="#000066">)</font> <font color="#000066">;</font> <br>  <font color="#666666">// remove green and blue feeds</font> <br>  l <font color="#000066">.</font>  <font color="#006600">g</font> <font color="#000066">=</font> l <font color="#000066">.</font>  <font color="#006600">b</font> <font color="#000066">=</font> <font color="#0000ff">0.0</font> <font color="#000066">;</font> <br>  <font color="#666666">// get the pixel of the right image</font> <br>  <font color="#000066">vec4</font> r <font color="#000066">=</font> sample <font color="#000066">(</font> rightSamp <font color="#000066">,</font> samplerCoord <font color="#000066">(</font> rightSamp <font color="#000066">)</font> <font color="#000066">)</font> <font color="#000066">;</font> <br>  <font color="#666666">// remove the red channel</font> <br>  r <font color="#000066">.</font>  <font color="#006600">r</font> <font color="#000066">=</font> <font color="#0000ff">0.0</font> <font color="#000066">;</font> <br>  <font color="#666666">// overlay with the image by the method "Screen"</font> <br>  <font color="#000066">vec4</font> ret <font color="#000066">;</font> <br>  <font color="#666666">// red channel</font> <br>  ret <font color="#000066">.</font>  <font color="#006600">r</font> <font color="#000066">=</font> <font color="#0000ff">1.0</font> <font color="#000066">-</font> <font color="#000066">(</font> <font color="#0000ff">1.0</font> <font color="#000066">-</font> l <font color="#000066">.</font> <font color="#006600">r</font> <font color="#000066">)</font> <font color="#000066">*</font> <font color="#000066">(</font> <font color="#0000ff">1.0</font> <font color="#000066">-</font> r <font color="#000066">.</font> <font color="#006600">r</font> <font color="#000066">)</font> <font color="#000066">;</font> <br>  <font color="#666666">// green channel</font> <br>  ret <font color="#000066">.</font>  <font color="#006600">g</font> <font color="#000066">=</font> <font color="#0000ff">1.0</font> <font color="#000066">-</font> <font color="#000066">(</font> <font color="#0000ff">1.0</font> <font color="#000066">-</font> l <font color="#000066">.</font> <font color="#006600">g</font> <font color="#000066">)</font> <font color="#000066">*</font> <font color="#000066">(</font> <font color="#0000ff">1.0</font> <font color="#000066">-</font> r <font color="#000066">.</font> <font color="#006600">g</font> <font color="#000066">)</font> <font color="#000066">;</font> <br>  <font color="#666666">// blue channel</font> <br>  ret <font color="#000066">.</font>  <font color="#006600">b</font> <font color="#000066">=</font> <font color="#0000ff">1.0</font> <font color="#000066">-</font> <font color="#000066">(</font> <font color="#0000ff">1.0</font> <font color="#000066">-</font> l <font color="#000066">.</font> <font color="#006600">b</font> <font color="#000066">)</font> <font color="#000066">*</font> <font color="#000066">(</font> <font color="#0000ff">1.0</font> <font color="#000066">-</font> r <font color="#000066">.</font> <font color="#006600">b</font> <font color="#000066">)</font> <font color="#000066">;</font> <br>  <font color="#666666">// transparency is not used</font> <br>  ret <font color="#000066">.</font>  <font color="#006600">a</font> <font color="#000066">=</font> <font color="#0000ff">1.0</font> <font color="#000066">;</font> <br>  <font color="#666666">//result</font> <br>  <font color="#000000">return</font> ret <font color="#000066">;</font> <br>  <font color="#000066">}</font> </blockquote><br><br><h5>  Use filter </h5>  When downloading the main program, you need to insert the code that will load our filter (taking into account that we put it in the Resources folder): <blockquote>  <font color="#000066">-</font> <font color="#000066">(</font> <font color="#000066">void</font> <font color="#000066">)</font> loadCoreImageFilters <br>  <font color="#000066">{</font> <br>  NSString <font color="#000066">*</font> path <font color="#000066">=</font> <font color="#000066">[</font> <font color="#000066">[</font> NSBundle mainBundle <font color="#000066">]</font> pathForResource <font color="#000066">:</font> @ <font color="#ff0000">"AnaglyphFilter"</font> ofType <font color="#000066">:</font> @ <font color="#ff0000">"plugin"</font> <font color="#000066">]</font> <font color="#000066">;</font> <br>  <font color="#000066">[</font> CIPlugIn loadPlugIn <font color="#000066">:</font> <font color="#000066">[</font> NSURL fileURLWithPath <font color="#000066">:</font> path <font color="#000066">]</font> allowExecutableCode <font color="#000066">:</font> YES <font color="#000066">]</font> <font color="#000066">;</font> <br>  <font color="#000066">}</font> </blockquote>  Now you can use the filter in the same way as other filters: <blockquote>  CIFilter <font color="#000066">*</font> anaglyphFilter <font color="#000066">=</font> <font color="#000066">[</font> CIFilter filterWithName <font color="#000066">:</font> @ <font color="#ff0000">"AnaglyphFilter"</font> <font color="#000066">]</font> <font color="#000066">;</font> <br>  <font color="#000066">[</font> anaglyphFilter setDefaults <font color="#000066">]</font> <font color="#000066">;</font> <br>  <font color="#000066">[</font> anaglyphFilter setValue <font color="#000066">:</font> leftImage forKey <font color="#000066">:</font> @ <font color="#ff0000">"inputImage"</font> <font color="#000066">]</font> <font color="#000066">;</font> <br>  <font color="#000066">[</font> anaglyphFilter setValue <font color="#000066">:</font> rightImage forKey <font color="#000066">:</font> @ <font color="#ff0000">"rightImage"</font> <font color="#000066">]</font> <font color="#000066">;</font> <br>  CIImage <font color="#000066">*</font> anaglyphImage <font color="#000066">=</font> <font color="#000066">[</font> anaglyphFilter valueForKey <font color="#000066">:</font> @ <font color="#ff0000">"outputImage"</font> <font color="#000066">]</font> <font color="#000066">;</font> </blockquote><br><br><h4>  Conclusion </h4>  Working with Core Image was not as difficult as it might seem.  And here are the results: <br><ul><li>  source left image: <img src="https://habrastorage.org/storage2/f1e/557/e72/f1e557e7256a9c8d2b093e48b13423f8.png"></li><li>  original right image <img src="https://habrastorage.org/storage2/a58/bb8/258/a58bb82586dae18d3f28c64eef3687fb.png"></li><li>  result <img src="https://habrastorage.org/storage2/b5f/201/9fd/b5f2019fde02868b5d7e076e2305ac3e.png"></li></ul></div><p>Source: <a href="https://habr.com/ru/post/142697/">https://habr.com/ru/post/142697/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../142688/index.html">The Habrahabr ribbon is now provided with the ‚ÄúAll‚Äù tab, and this tab contains not only blog entries, but also questions</a></li>
<li><a href="../142689/index.html">Knee monitoring</a></li>
<li><a href="../142690/index.html">How does a programmer think</a></li>
<li><a href="../142694/index.html">Droider Show # 37. Holivar, senseless and merciless</a></li>
<li><a href="../142696/index.html">Accessibility - OS test for people with disabilities (Part 1)</a></li>
<li><a href="../142699/index.html">MS SCOM and group policies: are there any drawbacks?</a></li>
<li><a href="../142701/index.html">Home electronic library: MyHomeLib + FBD</a></li>
<li><a href="../142702/index.html">GeekTool - customization of the desktop in OS X</a></li>
<li><a href="../142703/index.html">Pangurman Recipes</a></li>
<li><a href="../142704/index.html">OT Routes - 8 New Cities and a Pedestrian Update</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>