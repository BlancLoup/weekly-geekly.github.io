<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Introduction to complex queries in SQLAlchemy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="During my visit to PyConRu 2014, I was surprised to learn that a large enough audience of python developers does not use SQLAlchemy as the main tool f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Introduction to complex queries in SQLAlchemy</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/44b/d2c/c98/44bd2cc98f2ca6e5d689f21c772ce56e.png"><br><blockquote>  During my visit to PyConRu 2014, I was surprised to learn that a large enough audience of python developers does not use SQLAlchemy as the main tool for working with the database.  After discussing this topic after Light Talks, it was decided with colleagues to write an article about what can be done with all the power of SQLAlchemy. </blockquote><br><br>  Usually in writing sites do not need something like that from the regular ORM.  And if it is required, then there are enough replacements for abnormal ones or reading the main part of the documentation.  And, as a rule, it is not necessary to break the head over complex queries.  Quite a lot of different ORMs offer the classic One-2-Many, One-2-One, Many-2-Many, etc. schemes.  For ordinary queries and links this is quite enough.  Unfortunately, in large projects it does not do without particular cases and programmers with complex queries write either raw sql or rely on what the basic ORM functionality offers them.  It does not look very nice or creates a rather large load on the database. <br><br>  It is clear that in pursuit of the speed of execution of scenarios, you can sacrifice the beauty of the code, but what if speed can be neglected, but not cross-platform?  And I don‚Äôt want to see in python code anything other than python code.  And what if you want to use your favorite ORM to its fullest (for my SQLAlchemy) and not write raw sql queries? <br><a name="habracut"></a><br>  It is assumed that you have already configured access to the database and you know how to map classes, create a session and make simple requests (this is described in the SQLAlchemy documentation at <a href="http://www.pythoncentral.io/series/python-sqlalchemy-database-tutorial/">www.pythoncentral.io/series/python-sqlalchemy-database-tutorial</a> ). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Below is a set of classes that we will use in our examples.  Of course, he will not cover all those many cases that may arise, but I hope that you will have a low start for writing your own complex queries and help you to get rid of manually writing complex SQL queries. <br><br>  Short note: I will not prescribe all imports for each example. <br>  Here are some features you might need: <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sqlalchemy <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> func, and_, or_, not_, aliased</code> </pre> <br><br>  For the rest, refer to the documentation. <br><br>  I want to separately note the function func.  This function will allow you to generate almost any expression for your database. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sqlalchemy <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Column, Integer, String <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sqlalchemy.schema <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ForeignKey <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserStatus</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Base)</span></span></span><span class="hljs-class">:</span></span> __tablename__ = <span class="hljs-string"><span class="hljs-string">'user_statuses'</span></span> STATUS_INITIAL = <span class="hljs-number"><span class="hljs-number">1</span></span> id = Column(Integer(), primary_key=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) name = Column(String(), unique=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Base)</span></span></span><span class="hljs-class">:</span></span> __tablename__ = <span class="hljs-string"><span class="hljs-string">'users'</span></span> id = Column(Integer(), primary_key=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) username = Column(String(), unique=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) password = Column(String(), nullable=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>) status_id = Column( Integer(), ForeignKey(<span class="hljs-string"><span class="hljs-string">'user_statuses.id'</span></span>), nullable=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, default=UserStatuses.STATUS_INITIAL ) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Role</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Base)</span></span></span><span class="hljs-class">:</span></span> __tablename__ = <span class="hljs-string"><span class="hljs-string">'roles'</span></span> id = Column(Integer(), primary_key=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) name = Column(String(), unique=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserRole</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Base)</span></span></span><span class="hljs-class">:</span></span> __tablename__ = <span class="hljs-string"><span class="hljs-string">'users_roles'</span></span> user_id = Column(Integer(), ForeignKey(<span class="hljs-string"><span class="hljs-string">'users.id'</span></span>)) role_id = Column(Integer(), ForeignKey(<span class="hljs-string"><span class="hljs-string">'roles.id'</span></span>)) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Product</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Base)</span></span></span><span class="hljs-class">:</span></span> __tablename__ = <span class="hljs-string"><span class="hljs-string">'products'</span></span> id = Column(Integer(), primary_key=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) name = Column(String(), unique=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Order</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Base)</span></span></span><span class="hljs-class">:</span></span> __tablename__ = <span class="hljs-string"><span class="hljs-string">'orders'</span></span> id = Column(Integer(), primary_key=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) product_id = Column(Integer(), ForeignKey(<span class="hljs-string"><span class="hljs-string">'products.id'</span></span>)) user_id = Column(Integer(), ForeignKey(<span class="hljs-string"><span class="hljs-string">'users.id'</span></span>))</code> </pre><br><br>  Yes, there are no relationships in the structure.  I did not begin to write them for one simple reason, we will not need them.  This is, of course, cool when all the relations and backrefs are registered, but they can only select dependent data.  We will try to use all the tables at once in different variations. <br><br><h4>  Simple JOIN </h4><br>  For example, we need to take all users with their roles, products, orders and statuses. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> SessionContext() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> session: query = session.query(User, Role, Product, Order, UserStatus) records = query.all() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> user, role, product, order, user_status <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> records: <span class="hljs-comment"><span class="hljs-comment"># execute all you need</span></span></code> </pre><br><br>  In this case, SQLAlchemy will generate an INNER JOIN.  This method is good when you have all the indexes in the database (believe me, very often they are not).  SQLAlchemy itself generates a query based on the data of the class (after all, we have connections). <br><br>  And what if everything is not so smooth, and there is no possibility to specify the Foreign Key in the database (for various reasons)?  For this, SQLAlchemy allows you to explicitly specify for which columns we will link the tables. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> SessionContext() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> session: query = session.query(User, Role, Product, Order, UserStatus) query = query.join(UserRole, UserRole.user_id == User.id) query = query.join(Role, Role.id == UserRole.role_id) query = query.join(Order, Order.user_id == User.id) query = query.join(Product, Product.id == Order.product_id) query = query.join(UserStatus, UserStatus.id == User.status_id) records = query.all() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> user, role, product, order, user_status <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> records: <span class="hljs-comment"><span class="hljs-comment"># execute all you need</span></span></code> </pre><br><br>  In this case, even if there is unrelated data in the database, we can select all the necessary records. <br><br><h4>  Simple LEFT JOIN </h4><br>  Suppose we need to take ALL users and even those who have no orders.  Those.  if the user has orders, then show them, and if not, then show the user without orders. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> SessionContext() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> session: query = session.query(User, Role, Product, Order, UserStatus) query = query.join(UserRole, UserRole.user_id == User.id) query = query.join(Role, Role.id == UserRole.role_id) query = query.join(UserStatus, UserStatus.id == User.status_id) query = query.outerjoin(Order, Order.user_id == User.id) query = query.outerjoin(Product, Product.id == Order.product_id) records = query.all() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> user, role, product, order, user_status <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> records: <span class="hljs-comment"><span class="hljs-comment"># execute all you need</span></span></code> </pre><br><br>  Here we used the outerjoin function, which for PostgreSQL will generate a LEFT OUTER JOIN Query. <br><br><h4>  Complex queries </h4><br>  Sometimes there is a situation when we need to do a lot of sorts and add a lot of conditions.  Complicates everything, often the base itself. <br><br>  For example.  Suppose users can order the same product several times.  You need to select a record that indicates whether the user bought the product for each user and each product.  In this case, if the user bought the product more than once, then it does not matter which purchase information will be selected.  If the user did not buy this product, then the desired behavior is similar to left join.  To group the results you can use GROUP BY, if we were not important data on the purchase.  Otherwise, it is necessary to specify all required fields (which are specified in select) for GROUP BY, which is highly undesirable, since it will create additional load on the database.  To select data, it is better to use DISTINCT ON, which simply cuts off duplicate records by product ID and user ID.  The problem is that PostgreSQL requires that those columns specified in DISTINCT ON are present in ORDER BY.  And I want to sort the output by user name (for example).  This is where the fun begins.  Fortunately, the database allows you to "wrap" one query into another. <br><br>  SQLAlchemy has the cte () * Common Table Expression * function.  This function creates a subquery from your query. <br><br>  Example <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> SessionContext() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> session: query = session.query(User, Role, Product, Order, UserStatus) query = query.distinct(Product.id, User.id) query = query.join(UserRole, UserRole.user_id == User.id) query = query.join(Role, Role.id == UserRole.role_id) query = query.join(UserStatus, UserStatus.id == User.status_id) query = query.outerjoin(Order, Order.user_id == User.id) query = query.outerjoin(Product, Product.id == Order.product_id) query = query.order_by(Product.id, User.id) found_records = query.cte() main_query = session.query(found_records).order_by(found_records.c.user.username) records = main_query.all() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> user, role, product, order, user_status <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> records: <span class="hljs-comment"><span class="hljs-comment"># execute all you need</span></span></code> </pre><br><br>  In this example, we ‚Äúisolated‚Äù the main query and sorted the result as we needed.  You can also do with complex samples with group_by. <br><br>  There is another useful tool in SQLAlchemy called subquery.  This function allows you to use the generated statement in large queries or in a JOIN. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> SessionContext() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> session: stmt = session.query(Order.user_id, sqlalchemy.func.count(<span class="hljs-string"><span class="hljs-string">'id'</span></span>).label(<span class="hljs-string"><span class="hljs-string">'users_found'</span></span>)).subquery() main_query = session.query(User, stmt.c.users_found).outerjoin(stmt, User.id==stmt.c.user_id).order_by(User.id) records = main_query.all() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> user, orders <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> records: <span class="hljs-comment"><span class="hljs-comment"># execute all you need</span></span></code> </pre><br><br>  This example makes a subquery within a query via LEFT OUTER JOIN and returns the number of orders for each user found. <br><br>  Also, there are situations when it is necessary to link one and the same table in one query.  For this there is a function aliased ().  To be honest, I have never used it, so I will take an example from the documentation <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> SessionContext() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> session: adalias1 = aliased(Address) adalias2 = aliased(Address) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> username, email1, email2 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> \ session.query(User.name, adalias1.email_address, adalias2.email_address).\ join(adalias1, User.addresses).\ join(adalias2, User.addresses).\ filter(adalias1.email_address==<span class="hljs-string"><span class="hljs-string">'jack@google.com'</span></span>).\ filter(adalias2.email_address==<span class="hljs-string"><span class="hljs-string">'j25@yahoo.com'</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> username, email1, email2</code> </pre><br><br>  Well, in the end, an example that is used in my code and works on PostgreSQL.  The over () function is not in the postgresql dialect section, so it will most likely work everywhere.  In this case, I want to show how to work with the func function. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sqlalchemy <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> over <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> SessionContext() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> session: query = session.query( User, over( func.row_number(), partition_by=User.id ) ) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> user, row_number <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> query.all(): <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"{0}# {1}"</span></span>.format(row_number, user.username)</code> </pre><br><br>  This example will display the numbered user names in the order in which they were found in the database. <br><br>  At the end of the article I repeat.  Perhaps this code will not be the fastest, but at least you will be able to maintain many databases that are supported by SQLAlchemy. <br>  For example, for development and testing, you can not deploy a full-fledged relational database on a local machine, but use SQLite. <br><br>  The advantages of this approach include: <br>  - Code uniformity.  Only python will be in python files. <br>  - Screening possible incoming data using SQLAlchemy <br>  - Ability to use different databases without changing the query syntax <br>  - Ability not to know SQL at all.  There is no direct use of SQL. <br>  - Do not write kilometer requests yourself <br><br>  Minuses: <br>  - Memory consumption for function calls, for storage in the memory of generators.  The string does take up less memory space. <br>  - It is impossible to see immediately what generated SQLALchemy (only at the time of execution) <br>  - You need to know SQLAlchemy, its functions and capabilities in order to use it correctly.  Still, the library is not small <br><br>  <a href="http://sqlalchemy.org/">Read</a> more about SQLAlchemy ORM here: <a href="http://sqlalchemy.org/">sqlalchemy.org</a> </div><p>Source: <a href="https://habr.com/ru/post/226521/">https://habr.com/ru/post/226521/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../226507/index.html">Forward to new heights of ignorance</a></li>
<li><a href="../226509/index.html">Situational analysis / pre-project development site</a></li>
<li><a href="../226513/index.html">Endurance SSD test: write 1 petabyte</a></li>
<li><a href="../226515/index.html">Benefits of Jelastic pricing over Amazon</a></li>
<li><a href="../226517/index.html">How do we with the help of mathematical statistics measure the quality of data in Yandeks.Gorode</a></li>
<li><a href="../226523/index.html">Record of the webinar "What's new in Kerio Operator 2.3"</a></li>
<li><a href="../226527/index.html">Ubuntu Phone activated on 10,000 devices</a></li>
<li><a href="../226531/index.html">The first Russian coins with a QR code</a></li>
<li><a href="../226535/index.html">How to honestly work as a freelancer in Belarus?</a></li>
<li><a href="../226537/index.html">Synology¬Æ introduces the RackStation RS3614xs and RS3614RPxs. Optimum performance and reliability for large businesses</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>