<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We optimize PropertyDrawer under Unity3d</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In my previous article, I described OneLine - PropertyDrawer, which allows you to draw an object of any nesting in one line. 


 This time I will tell...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We optimize PropertyDrawer under Unity3d</h1><div class="post__text post__text-html js-mediator-article"><p>  In my previous <a href="https://habrahabr.ru/post/340536/">article,</a> I described OneLine - PropertyDrawer, which allows you to draw an object of any nesting in one line. </p><br><p>  This time I will tell you how I had to optimize the code so that the inspector could edit databases consisting of hundreds of lines. </p><br><p><img src="https://habrastorage.org/webt/7r/ly/vk/7rlyvkzln56ozbdcxrrjteiijyy.png"></p><br><p>  Attention, under the cat a lot of gifs and pictures! </p><a name="habracut"></a><br><h1 id="sut-problemy">  The essence of the problem </h1><br><p>  In the standard inspector, all fields that have a complex structure are drawn collapsed, which consumes quite a few resources and allows you to easily draw an array consisting of hundreds of objects. </p><br><div class="spoiler">  <b class="spoiler_title">Example</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/zo/dg/xb/zodgxbt2ullmhfhjvk-tgcw6iq4.gif" alt="default"></p><br><p>  If we look at the profiler, we will see 4.3 ms to draw 100 elements of the array. </p><br><p><img src="https://habrastorage.org/webt/jn/mw/ms/jnmwmseid1a2rbkn1lwj3em6vns.png" alt="default"></p></div></div><br><p>  OneLine was invented to save the developer from constant mouse clicks in the inspector, and all the nested fields are drawn immediately.  At the same time, during drawing, rather costly calculations of the element positions are performed. </p><br><p>  Comrade Shipilev in his report <a href="https://habrahabr.ru/company/jugru/blog/338732/">"Performance: what is in my name to you?"</a>  proposes a graph of code performance versus its complexity (time moves along a curve from A to E): </p><br><p><img src="https://habrastorage.org/webt/wa/gr/c7/wagrc7xsvoygyjflkkkct1ksblc.png"></p><br><div class="spoiler">  <b class="spoiler_title">Description of graphics</b> <div class="spoiler_text"><blockquote>  This is a parametric graph: time flows here from point ‚ÄúA‚Äù to point ‚ÄúB‚Äù, ‚ÄúC‚Äù, ‚ÄúD‚Äù, ‚ÄúE‚Äù.  On the y-axis we have performance, on the x-axis is some abstract complexity of the code. <br><br>  Usually, it all starts with people cycling a prototype that works slowly but slowly.  It is rather complicated because we just bike or not so that it does not fall apart under its own weight. <br><br>  After the optimization begins - little by little the rewriting of different parts begins.  Being in this green zone, developers usually take profilers and rewrite pieces of code that are obviously badly written.  This at the same time reduces the complexity of the code (because you cut out bad pieces) and improves performance. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At point ‚ÄúB‚Äù, the project reaches a certain subjective peak of ‚Äúbeauty‚Äù, when we have a kind of performance and a good one, and the product is not bad. <br><br>  Further, if developers want more performance, they go into the yellow zone when they take a more accurate profiler, write good workloads and carefully tighten the nuts.  In this process, they do things there that they would not do if it were not for productivity. <br><br>  If you want even further, then the project comes to a certain red zone, when developers begin to make their product go wild in order to get the last percentages of performance.  What to do in this zone is not very clear.  There is a recipe, at least for this conference - go to JPoint / JokerConf / JBreak and try product developers, how to write code that repeats the curvature of the lower layers.  Because, as a rule, in the red zone there are things that repeat the problems that arise in the lower layers. </blockquote><p>  The schedule is extremely good, as the whole article, I highly recommend reading. </p></div></div><br><p>  Moving from A to B is a rather boring and trivial thing.  Our article covers first the movement from B to C, then - wandering around D in search of the right crutch / counterweight to the features of Unity. </p><br><p>  Someone will always think: "What kind of kindergarten? And what do you call wandering around D? Where are the features of <a href="http://www.k-press.ru/cs/2004/4/netPrimer/NetPrimer.asp">CLR</a> and <a href="https://docs.unity3d.com/Manual/IL2CPP.html">IL2CPP</a> ? Where are the benchmarks according to all the rules? Where is the code over-complication to gain a speed of 0.05%?". </p><br><p>  Most likely, the article is not for this reader.  Things about which I write, are rather simple and are directed more likely to the young reader who is beginning the way of the developer in Unity.  Therefore, I simplify the implementation and spend rather a description of the approaches to optimize PropertyDrawer. </p><br><p>  Once I saw my colleague write PropertyDrawer, which displays a grid with a <abbr title="Cells occupied on the playing field">footprint of a</abbr> game object.  He generated images on the fly, pixel-by-pixel changing their colors and doing many more scary things.  Ultimately, the display of one such field could significantly draw down the FPS in the editor. </p><br><p>  Of course, this does not mean: "If someone does something stupid, it means I can."  Just some nonsense, we are forced to do, and after - to optimize. </p><br><div class="spoiler">  <b class="spoiler_title">As was the case for optimizations.</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/kr/lc/hu/krlchutdtytkxem8js2oc9kvhm4.gif" alt="pure"></p><br><p>  The same 100 elements required 104 ms, that is, ~ 24 times more.  This speed can be described in one word: <strong>disgusting</strong> . </p><br><p><img src="https://habrastorage.org/webt/uv/bd/tc/uvbdtc3sdtbn9on8fplrskycw6i.png" alt="pure"></p></div></div><br><h1 id="keshiruem-chto-mozhem">  Cache what we can </h1><br><p> OneLine itself calculates the positions of the fields depending on their number, type and attributes hanging on them (for example, <code>[Width]</code> or <code>[Weight]</code> ).  And every call to OnGUI, this calculation happens again. </p><br><p>  The same situation with the abstract PropertyDrawer, which works very slowly and therefore does not give rest to the programmer Vasya.  Obviously, if slowly, then most likely it does a lot of identical calculations. </p><br><p>  It was decided: we will cache! </p><br><p>  To continue, we need to know the following: for one inspector window, only one PropertyDrawer object is created for each type, which draws all fields of this type, and after changing the object, it is discarded. </p><br><p>  And this means that if we have two fields of the same type on the screen, they are drawn by the same PropertyDrawer object.  This somewhat complicates caching. </p><br><p>  On the other hand, if we have one PropertyDrower for one inspector, then we can save any data in a <code>Dictionary&lt;string, YourData&gt;</code> , where <code>property.propertyPath</code> key. </p><br><p>  In the end, we get a simple cache: </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> delegate &lt;T&gt; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CalculateValue</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SerializedProperty property)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PropertyDrawerCache</span></span></span><span class="hljs-class">&lt;T&gt; {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Dictionary&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>, T&gt; cache; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> CalculateValue&lt;T&gt; calculate; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PropertyDrawerCache</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CalculateValue&lt;T&gt; calculate)</span></span></span></span>{ cache = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>, T&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.calculate = calculate; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[SerializedProperty property] { get { T result = null; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache.TryGetValue(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>, out result)){ result = calculate(property); cache.Add(property.propertyPath, result); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } } }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">What we got with the cache.</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/8b/y8/ru/8by8rumlomtk_oa-neitstqbbv8.gif" alt="cache"></p><br><p>  The first call is fulfilled as slowly, but all subsequent ones are twice as fast.  Not bad, but it still feels unpleasant. </p><br><p>  When first called: <br><img src="https://habrastorage.org/webt/h4/8a/qx/h48aqxgg0g37hneuzy_zlaxi5f4.png" alt="cache-1"></p><br><p>  On subsequent calls: <br><img src="https://habrastorage.org/webt/5o/s8/j-/5os8j-f2y9cn1yvecif68cf2atm.png" alt="cache-2"></p></div></div><br><h2 id="problemy-s-oneline-vlozhennye-massivy">  Problems with OneLine: Nested Arrays </h2><br><p>  The main trouble cache: it must be kept up to date.  We cache the calculated positions for the fields of the classes and consider them to be unchanged (the structure of the classes will not change in runtime).  However, we did not take into account one thing: OneLine fits in the string as well all the elements of the child arrays. </p><br><div class="spoiler">  <b class="spoiler_title">This is how it looks</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/fv/m9/pk/fvm9pkmannvnepofy-0ux1grx88.gif"></p></div></div><br><p>  Fortunately, the problem is solved by resetting the cached item positions. </p><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DrawPlusButton</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Rect rect, SerializedProperty </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">array</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GUI.Button(rect, <span class="hljs-string"><span class="hljs-string">"+"</span></span>)) { <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>.InsertArrayElementAtIndex(<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>.arraySize); ResetCurrentElementCache(); } }</code> </pre> <br><h2 id="problemy-s-oneline-kornevoy-massiv">  Problems with OneLine: Root Array </h2><br><blockquote>  The main trouble cache: it must be kept up to date. </blockquote><p>  While using OneLine, I came across an interesting caching bug: </p><br><div class="spoiler">  <b class="spoiler_title">What it looks like</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/dn/jd/7b/dnjd7bxxzothwd9jzhcfvustxck.gif"></p><br><p><img src="https://habrastorage.org/webt/q0/fy/bw/q0fybwwlshzgqvxdvghrmumca6u.gif"></p></div></div><br><p>  The same words: </p><br><ul><li>  take an array of arrays; </li><li>  add element B (copying element A is the last element of the array); </li><li>  change the length of the array in the element B; </li><li>  remove item B; </li><li>  add element C (copying element A); </li><li>  we get the situation: the element C has a length different from the element B, at the same time the calculated positions for the element B. </li></ul><br><p>  Solution: remember the size for each array and with the next drawing check if the array has changed.  I present the solution only for the case when OneLine hangs on an array in the root of the ScriptableObject to simplify reading. </p><br><p>  At the same time, I draw the reader‚Äôs attention to the remarkable <code>IsReallyArray</code> function in the code. </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Dictionary&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; arraysSizes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsArraySizeChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SerializedProperty arrayElement)</span></span></span></span>{ var arrayName = arrayElement.propertyPath.Split(<span class="hljs-string"><span class="hljs-string">'.'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>]; var <span class="hljs-built_in"><span class="hljs-built_in">array</span></span> = arrayElement.serializedObject.FindProperty(arrayName); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IsReallyArray(<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>) &amp;&amp; IsRealArraySizeChanged(arrayName, <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>.arraySize); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsReallyArray</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> SerializedProperty property)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> property.isArray &amp;&amp; property.propertyType != SerializedPropertyType.String; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsRealArraySizeChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arrayName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> currentArraySize)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (! arraysSizes.ContainsKey(arrayName)){ arraysSizes[arrayName] = currentArraySize; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (arraysSizes[arrayName] != currentArraySize){ arraysSizes[arrayName] = currentArraySize; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre> <br><h1 id="ne-risuem-chto-mozhem">  Do not draw what we can </h1><br><p>  There are 100 elements in our array, and only 20-25 (on gifs) are visible on the screen, which brings us to another standard optimization: <abbr title="Culling">Culling</abbr> : we just don‚Äôt draw something that doesn‚Äôt fit on the screen! </p><br><p>  To do this, we need to know the size of the window in which we are located, as well as the position of the ScrollView.  I offer you a solution on the verge of a foul (hello, <a href="https://github.com/MattRix/UnityDecompiled">Unity-Decompiled</a> ). </p><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> InspectorUtil { private const string INSPECTOR_WINDOW_ASSEMBLY_QUALIFIED_NAME = "UnityEditor.InspectorWindow, UnityEditor, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null"; private const string INITIALIZATION_ERROR_MESSAGE = @"OneLine can not initialize Inspector Window Utility. You may experience some performance issues. Please create an issue on https://github.com/slavniyteo/one-line/ and we will repair it. "; private <span class="hljs-type"><span class="hljs-type">bool</span></span> enabled = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; private MethodInfo getWindowPositionInfo; private FieldInfo scrollPositionInfo; private <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">window</span></span>; private <span class="hljs-type"><span class="hljs-type">float</span></span> lastWindowWidth; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> InspectorUtil() { try { Initialize(); enabled = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex){ //      //     Unity  , //   . enabled = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.LogError(INITIALIZATION_ERROR_MESSAGE + ex.ToString()); } } private <span class="hljs-type"><span class="hljs-type">void</span></span> Initialize(){ var inspectorWindowType = <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>.GetType(INSPECTOR_WINDOW_ASSEMBLY_QUALIFIED_NAME); <span class="hljs-keyword"><span class="hljs-keyword">window</span></span> = inspectorWindowType .GetField("s_CurrentInspectorWindow", BindingFlags.<span class="hljs-built_in"><span class="hljs-built_in">Public</span></span> | BindingFlags.Static) .GetValue(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); scrollPositionInfo = inspectorWindowType .GetField("m_ScrollPosition"); getWindowPositionInfo = inspectorWindowType .GetProperty("position", typeof(Rect)) .GetGetMethod(); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">bool</span></span> IsOutOfScreen(Rect position){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (! enabled) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } var scrollPosition = (Vector2) scrollPositionInfo.GetValue(<span class="hljs-keyword"><span class="hljs-keyword">window</span></span>); var windowPosition = (Rect) getWindowPositionInfo.Invoke(<span class="hljs-keyword"><span class="hljs-keyword">window</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-type"><span class="hljs-type">bool</span></span> above = (position.y + position.height) &lt; scrollPosition.y; <span class="hljs-type"><span class="hljs-type">bool</span></span> below = position.y &gt; (scrollPosition.y + windowPosition.height); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> above || below; } }</code> </pre> <br><p>  Then use: </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnGUI</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Rect position, SerializedProperty property, GUIContent label</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inspectorUtil.IsOutOfScreen(position)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } &lt;..&gt; }</code> </pre> <br><p>  This code will only work when objects are drawn in the inspector window.  If you use OneLine (or another PropertyDrawer) in your custom window, this optimization will not work.  The reason, of course, is the rigid basis for the scrolling of the screen.  To make a universal tool in this case is impossible.  But the code is quite simple, it can always be adapted to your needs. </p><br><div class="spoiler">  <b class="spoiler_title">What we got with the cooling.</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/n4/s6/gj/n4s6gj1itnpvurr6j58rljlrery.gif" alt="culling"></p><br><p>  It feels quite differently, the scrolling is much smoother, and the number of FPS largely depends on the height of the window. </p><br><p><img src="https://habrastorage.org/webt/5y/oa/tk/5yoatkss8yjkcj_krpn_vuza-vy.png" alt="culling"></p></div></div><br><h2 id="problema-s-kullingom">  Cooling problem </h2><br><p>  If you look at the previous gif, you can see.  that when scrolling, the focus of the element "sticks" to the top edge and does not leave the screen. </p><br><p>  Obviously, Unity remembers the active element on the basis of its sequence number from the beginning of the event processing.  And since culling discards all invisible elements, we are breaking this order. </p><br><p>  Solving the problem can be quite simple: reset the focus from the control with each movement of the wheel. </p><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">if</span></span> (<span class="hljs-type"><span class="hljs-type">Event</span></span>.current.<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> == </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EventType</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ScrollWheel</span></span></span><span class="hljs-class">){ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EditorGUI</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FocusTextInControl</span></span></span><span class="hljs-class">(""); }</span></span></code> </pre> <br><p>  But I have never integrated this solution into OneLine, because I have not yet convinced myself that this solution is good enough.  Someday I dig a little deeper and maybe do it a little better. </p><br><h1 id="soberem-vse-vmeste">  Let's put it all together </h1><br><div class="spoiler">  <b class="spoiler_title">What we got.</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/j6/am/8k/j6am8k9flhzgr6n2wxl0m_wyj6g.gif" alt="full"></p><br><p>  When first called: <br><img src="https://habrastorage.org/webt/vz/-7/rh/vz-7rhoqvhoaf54ate3tyhvsgos.png" alt="full-1"></p><br><p>  On subsequent calls, everything happens much faster: <br><img src="https://habrastorage.org/webt/_e/ej/so/_eejsosh_wjzizvpg3kexmjy-hs.png" alt="full-2"></p></div></div><br><p>  For comparison, all options in one window: <br><img src="https://habrastorage.org/webt/jl/tw/cq/jltwcq_ojhixrrvk8-mugveu9aw.png" alt="all"></p><br><p>  As a result of the work, we received a significant acceleration of the library.  I do not write "tenfold acceleration", since the time of drawing elements largely depends on the height of the window (if we take the window twice as long, the time will also increase almost twice).  However, this result suits me. </p><br><hr><br><p>  I will not insert the block with advertising already familiar to Habr√©: whoever needs it will find it. </p><br><p>  All good! </p></div><p>Source: <a href="https://habr.com/ru/post/341064/">https://habr.com/ru/post/341064/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../341048/index.html">What every C programmer should know about Undefined Behavior. Part 1/3</a></li>
<li><a href="../341050/index.html">Full cycle of creating a character model for the game</a></li>
<li><a href="../341056/index.html">Who is a fullstack designer</a></li>
<li><a href="../341058/index.html">JAVA 9. What's new?</a></li>
<li><a href="../341060/index.html">UX design: 50 things you probably forgot to do</a></li>
<li><a href="../341066/index.html">Cocos2d-x - Event Manager</a></li>
<li><a href="../341068/index.html">Service alert a million users with RabbitMQ</a></li>
<li><a href="../341070/index.html">Nearly 2018, and we love callbacks</a></li>
<li><a href="../341072/index.html">We work with Bitcoin on Elixir</a></li>
<li><a href="../341074/index.html">Translation and dubbing of a movie at home - Indie Game: The Movie Special Edition</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>