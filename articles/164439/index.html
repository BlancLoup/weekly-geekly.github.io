<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Universal C # code under .NET and JavaScript</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Greetings to you, habravchane. In this topic, I would like to highlight the details of C # development for heterogeneous target platfor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Universal C # code under .NET and JavaScript</h1><div class="post__text post__text-html js-mediator-article"><h3>  Introduction </h3><br>  Greetings to you, habravchane.  In this topic, I would like to highlight the details of C # development for heterogeneous target platforms, primarily such as .NET and browser (JavaScript).  As an example, anyone can explore the <a href="http://gfranq.com/">gfranq.com</a> photo processing web service, which implements client and server photo processing using filters, as well as collage functionality based on the material described in this article. <br><br>  Since I do not know how to select pictures to attract attention, it will be on the topic: <br> <a href="http://habrahabr.ru/post/164439/"><img src="https://habrastorage.org/storage2/d07/ead/520/d07ead5209a54ce4fbb083f1a0c746a1.png"></a> <br><br><a name="habracut"></a><br><h3>  Content </h3><br>  <a href="https://habr.com/ru/post/164439/">purpose</a> <br><ul><li>  <a href="https://habr.com/ru/post/164439/">Filter Description</a> </li><li>  <a href="https://habr.com/ru/post/164439/">Collage Description</a> </li></ul>  <a href="https://habr.com/ru/post/164439/">Implementation</a> <br><ul><li>  <a href="https://habr.com/ru/post/164439/">Choosing a platform for photo processing</a> </li><li>  <a href="https://habr.com/ru/post/164439/">C # to JavaScript</a> </li><li>  <a href="https://habr.com/ru/post/164439/">Structure</a> <br><ul><li>  <a href="https://habr.com/ru/post/164439/">Use alias</a> </li><li>  <a href="https://habr.com/ru/post/164439/">File Links</a> </li></ul></li><li>  <a href="https://habr.com/ru/post/164439/">Notes about .NET implementation</a> <br><ul><li>  <a href="https://habr.com/ru/post/164439/">Using Dispose</a> </li><li>  <a href="https://habr.com/ru/post/164439/">Use lock</a> </li><li>  <a href="https://habr.com/ru/post/164439/">Storing masks in memory</a> </li></ul></li><li>  <a href="https://habr.com/ru/post/164439/">JavaScript implementation notes</a> <br><ul><li>  <a href="https://habr.com/ru/post/164439/">Minification</a> <br><ul><li>  <a href="https://habr.com/ru/post/164439/">Manually</a> </li><li>  <a href="https://habr.com/ru/post/164439/">Automatically</a> </li></ul></li><li>  <a href="https://habr.com/ru/post/164439/">Debug &amp; Release Modes</a> </li><li>  <a href="https://habr.com/ru/post/164439/">CrossOrigin property</a> </li></ul></li><li>  <a href="https://habr.com/ru/post/164439/">Optimization</a> <br><ul><li>  <a href="https://habr.com/ru/post/164439/">Use of precomputed (tabular) values</a> </li><li>  <a href="https://habr.com/ru/post/164439/">Convert an image to an array of pixels</a> </li></ul></li></ul>  <a href="https://habr.com/ru/post/164439/">Code examples</a> <br><ul><li>  <a href="https://habr.com/ru/post/164439/">Are common</a> <br><ul><li>  <a href="https://habr.com/ru/post/164439/">Determining whether a string is a number</a> </li><li>  <a href="https://habr.com/ru/post/164439/">Integer division</a> </li><li>  <a href="https://habr.com/ru/post/164439/">Rotate and reverse images on canvas and bitmap respectively</a> </li><li>  <a href="https://habr.com/ru/post/164439/">Asynchronous and synchronous loading images</a> </li></ul></li><li>  <a href="https://habr.com/ru/post/164439/">Only Script #</a> <br><ul><li>  <a href="https://habr.com/ru/post/164439/">Determining the type and version of the browser</a> </li><li>  <a href="https://habr.com/ru/post/164439/">Dashed line drawing</a> </li><li>  <a href="https://habr.com/ru/post/164439/">Image rotation animation</a> </li></ul></li></ul>  <a href="https://habr.com/ru/post/164439/">Conclusion</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="Goal"></a><h3>  purpose </h3><br>  So, the task was to implement the processing of photos by filters and creating collages on the client, and, if possible, on the server.  To begin, I will tell you how we have presented filters and collages. <br><br><a name="Filters"></a><h4>  Filter Description </h4><br>  <b>The filter</b> in our project is represented by a sequence of actions (actions), prepared in Photoshop, applied to a specific photo.  The action can be for example one of: <br><br><ul><li>  Brightness change </li><li>  Contrast change </li><li>  Saturation change </li><li>  Correction of color curves </li><li>  Mask overlay with different modes </li><li>  Overlay frames </li><li>  ... </li></ul><br>  In order to describe all these actions a certain format is needed.  Of course, there are standard formats such as JSON and XML, but it was decided to develop a custom format for the following reasons: <br><br><ul><li>  Code universality for all platforms (.NET, JavaScript, WinPhone, etc.). </li><li>  The filter format is simple, not having a hierarchical structure, which makes it easy to write a parser for it. </li><li>  XML and JSON weigh more (for this case). </li></ul><br>  For example, this is what the sequence of actions for the <b>XPro Film</b> filter looks like: <br><br><img src="https://habrastorage.org/storage2/676/c7f/02d/676c7f02d48365b075a03854256eac55.jpg"><br><br>  In addition to photo processing with a filter, it was also necessary to implement cropping and rotation of the image.  Yes, I knew that jQuery plug-ins exist to implement rotation and trimming, but, first, they were too overloaded, and, second, they did not fit into the universal architecture of the project. <br><br><a name="Collages"></a><h4>  Collage Description </h4><br>  <b>The collage</b> is presented in the form of several miniature photos combined into one with or without a mask.  At the same time, it was necessary to provide the ability to drag and drop available photos onto the collage and change their position and scale. <br><br>  Collage may look like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/084/250/1f8/0842501f87761a3c128b5f117719b10c.jpg" alt="image"><br><br>  The collage also uses its own simple format that stores a set of rectangles in relative coordinates from 0 to 1, the addresses of photos, as well as their transformations.  Relative coordinates are used because on the server the same client transformations are applied to large photos. <br><br><a name="Means"></a><h3>  Implementation </h3><br>  So, it was necessary to choose a platform on which the functionality of filters and collages worked for users. <br><br><a name="Platform"></a><h4>  Choosing a platform for photo processing </h4><br>  There are the following RIA technologies: <br><ul><li>  Adobe flash </li><li>  Microsoft Silverlight </li><li>  HTML 5 + JavaScript </li><li>  Native client </li></ul><br>  For obvious reasons, only Flash and HTML 5 currently deserve attention from the entire list, since all the others are not cross-platform.  And Silverlight is also slowly dying off.  Although the concept of <s>salt</s> NaCl I really like, but, alas, it exists only on Chrome, and it is not known when it will and will be supported by other popular browsers. <br><br>  So, fashionable and developing HTML 5 was chosen as a platform, which potentially works also on iOS, unlike Flash.  Also, this choice is justified by the fact that there are many libraries that allow you to convert C # to JavaScript, including in Visual Studio.  This, however, will be discussed further. <br><br><a name="Translation"></a><h4>  C # to JavaScript </h4><br>  In the previous section, a development platform was chosen: HTML 5 + JavaScript.  But the question arose, is it possible to write a universal C # code that could compile both under .NET and under JavaScript? <br><br>  Thus, several libraries were found to accomplish the task: <br><ul><li>  Jsil </li><li>  SharpKit </li><li>  Script # </li><li>  And others that can be viewed for example <a href="https://github.com/jashkenas/coffee-script/wiki/List-of-languages-that-compile-to-JS">in this list on github</a> . </li></ul><br><br>  As a result, it was decided to use <b>Script #</b> due to the fact that JSIL works directly with assemblies and generates less pure code (although it supports more C # features), and SharpKit is commercial.  A detailed comparison of such tools can be seen in the <a href="http://stackoverflow.com/q/11547471/1046374">JSIL vs Script # vs SharpKit question on stackoverflow</a> . <br><br>  In summary, I want to highlight the following advantages and disadvantages of using ScriptSharp compared with writing JavaScript manually: <br><br>  <b>Advantages:</b> <br><ul><li>  The ability to write a universal code for .NET and other platforms (WP, Mono). </li><li>  Development in a strongly typed C # language with OOP capabilities. </li><li>  IDE development support (autocompletion, refactoring). </li><li>  Identify many errors at compile time. </li></ul><br>  <b>Disadvantages:</b> <br><ul><li>  Redundancy and non-standard generated javascript (due to mscorlib). </li><li>  Supports only ISO-2 specifications (no function overload, type inference, extensions, generics, and more). </li></ul><br><br><a name="Structure"></a><h4>  Structure </h4><br>  Compiling under .NET and JavaScript of the same code can be represented in the form of the following scheme: <br><img src="https://habrastorage.org/storage2/8ba/bce/32c/8babce32c532d3b3954cdabebabb0e06.png"><br><br>  Despite the fact that .NET and HTML5 are completely different technologies, they have similar features.  This also applies to working with graphics.  For example, in .NET there is a <b>Bitmap</b> , and in JavaScript, the equivalent is <b>canvas</b> .  Also with <b>Graphics</b> and <b>Context</b> , and pixel arrays.  In order to combine all this in one code, it was decided to develop the following architecture: <br><br><img src="https://habrastorage.org/storage2/89c/427/74c/89c42774cf90bdc873a0c34619cf7207.png"><br><br>  Of course, it is not limited to two platforms.  In the future we plan to add support for WP, and then, perhaps, Android and iOS. <br><br>  It should be noted that there are two types of graphic operations: <br><br><ul><li>  <b>Using API functions</b> (DrawImage, Arc, MoveTo, LineTo).  The advantage is high speed and possible hardware acceleration.  The disadvantage is that they can be implemented differently on different platforms. </li><li>  <b>Pixel by pixel.</b>  The advantage is the ability to implement any effects and unified work on all platforms.  The disadvantage is low speed.  However, disadvantages can be leveled by parallelizing, using shaders and using pre-calculated tables (which will be discussed later in the section on optimization). </li></ul><br>  As you can see, in the abstract <b>Graphics</b> class all methods for working with graphics are described, and in derived classes they are implemented for various platforms.  In order to abstract from such classes as Bitmap and Canvas, the following <a href="http://msdn.microsoft.com/en-us/library/aa664765(v%3Dvs.71).aspx">aliases</a> were written.  Also in the WP version being developed, the <a href="http://ru.wikipedia.org/wiki/%25D0%2590%25D0%25B4%25D0%25B0%25D0%25BF%25D1%2582%25D0%25B5%25D1%2580_(%25D1%2588%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BD_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F)">adapter pattern</a> is also used. <br><br><a name="Alias"></a><h5>  Use alias </h5><br><pre><code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP using System.Html; using System.Html.Media.Graphics; using System.Runtime.CompilerServices; using Bitmap = System.Html.CanvasElement; using Graphics = System.Html.Media.Graphics.CanvasContext2D; using ImageData = System.Html.Media.Graphics.ImageData; using Image = System.Html.ImageElement; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">elif</span></span></span><span class="hljs-meta"> DOTNET using System.Drawing; using System.Drawing.Imaging; using System.Drawing.Drawing2D; using Bitmap = System.Drawing.Bitmap; using Graphics = System.Drawing.Graphics; using ImageData = System.Drawing.Imaging.BitmapData; using Image = System.Drawing.Bitmap; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br>  However, in C #, unfortunately, it is impossible to make aliases for unsafe types and arrays, i.e.  so ( <a href="http://stackoverflow.com/q/13489903/1046374">Alias ‚Äã‚Äãto pointer (byte *) in C #</a> ): <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> PixelArray = <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>*, <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> PixelArray = <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[]</code> </pre> <br>  And in order to be able to use unmanaged code in C # for fast pixel processing, while simultaneously compiling into Script #, the following scheme was introduced using directives: <br><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP PixelArray data = context.GetPixelArray(); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">elif</span></span></span><span class="hljs-meta"> DOTNET byte* data = context.GetPixelArray(); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre><br><br>  Further, the data array is used for various pixel-by-pixel operations (such as masking, fish-eye, saturation, and others), parallelized and not. <br><br><a name="Links"></a><h5>  File Links </h5><br>  For each platform, a separate project is added to the solution, but, of course, Mono, Script # and even Silverlight projects cannot refer to a regular .NET assembly.  Fortunately, there is an add mechanism in Visual Studio <hh user="http://support.microsoft.com/kb/306234"></hh>  links to files, which allows you to reuse the same code in different projects. <br><br>  An indication of compilation directives (DOTNET, SCRIPTSHARP, etc.) is added to the project properties in Conditional Compilation Symbols. <br><br><a name="DotnetNotes"></a><h4>  Notes about .NET implementation </h4><br>  Thanks to the above abstractions and aliases, C # code with a low level of redundancy was written.  However, further I want to draw attention to the problems of the .NET and JavaScript platforms that we had to face when developing, but which were successfully solved. <br><br><a name="DisposeUsing"></a><h5>  Using Dispose </h5><br>  I would like to draw attention to the fact that for any instance of the C # class that implements the IDisposable interface, you should always call <b>Dispose</b> after using it or using the using pattern.  In this project, such classes were Bitmap and Context.  This is not only my words and simple theory, but also practice: On an ASP.NET Developer Server x86 server, the processing of a large number of large photos (up to 2400 * 2400) led to the exception associated with memory.  After placing Dispose in the right places, the problem disappeared.  This and many other image processing tips are also written in article <a href="http://www.nathanaeljones.com/blog/2009/20-image-resizing-pitfalls">20 Image Resizing Pitfalls</a> and <a href="http://blogs.msdn.com/b/tess/archive/2009/02/03/net-memory-leak-to-dispose-or-not-to-dispose-that-s-the-1-gb-question.aspx">.NET Memory Leak: To dispose or to dispose, that's the 1 GB question</a> . <br><br><a name="LockUsing"></a><h5>  Use lock </h5><br>  In JavaScript, there is a separation between the already loaded picture with the <b>img</b> tag, which can be set the source and the loading event, and between the canvas with the canvas tag, on which you can draw something.  However, in .NET everything is represented by a single Bitmap class.  Thus, the aliases Bitmap and Image in .NET indicate the same System.Drawing.Bitmap class as can be seen above. <br><br>  Nevertheless, this separation in JavaScript on img and canvas helped a lot in the .NET version in the future.  The fact is that pre-loaded masks are used for filters, which are used by different threads, and therefore you need to use the <b>lock</b> pattern to avoid synchronization exclusion (the image is copied from lock, and then the result is used without blocking): <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Bitmap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CloneImage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Image image</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP Bitmap result = (Bitmap)Document.CreateElement("canvas"); result.Width = image.Width; result.Height = image.Height; Graphics context = (Graphics)result.GetContext(Rendering.Render2D); context.DrawImage(image, 0, 0); return result; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> Bitmap result; lock (image) result = new Bitmap(image); return result; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> }</span></span></code> </pre><br>  Do not forget that lock should also be used when accessing properties of a synchronized object (because any properties are in essence methods). <br><br><a name="MasksInMemory"></a><h5>  Storing masks in memory </h5><br>  When the server starts, all potentially used filter masks are loaded into memory to speed up processing.  Do not forget that no matter what format the mask has, the loaded Bitmap on the server takes 4 * 2400 * 2400 ~ 24 MB (the maximum image size is 2400 * 2400, number of bytes per pixel is 4), which means all the masks for filters ( ~ 30 pieces) and collages (40 pieces) will occupy ~ 1.5 GB in memory, which in principle is not much for the server, but with an increase in the number of masks, this number can increase significantly.  So in the future, it may be necessary to use compression of the masks in memory (in the form of .jpg, .png formats) and then unpacking them during use, especially considering that the size can be reduced by about 300 times.  An additional advantage of this approach is that a compressed image will copy faster than a large one, which means that the <b>lock</b> operation will take less time and the threads will be less blocked. <br><br><a name="JavascriptNotes"></a><h4>  JavaScript implementation notes </h4><br><a name="Minification"></a><h5>  Minification </h5><br>  I did not specifically use the word ‚Äúobfuscation‚Äù in the title of this section, since this term is not very applicable to a language with all the time open source, which in this case is JavaScript.  However, the logic and readability of the code can be confused by ‚Äúdepersonalizing‚Äù various identifiers (we will not talk now about the perverted methods shown <a href="http://habrahabr.ru/post/112530/">in one of the topics</a> ).  Well and most importantly, this technique will significantly reduce the size of the script (now in compressed form it weighs ~ 80 Kb). <br><br>  There are two ways to minify JavaScript in our case: <br><br><ul><li>  <b>Manually</b> .  At the generation stage, using ScriptSharp. </li><li>  <b>Automatically</b> .  After the generation stage.  To do this, use external tools, such as Google Closure Compiler, Yui. </li></ul><br><a name="ManualMinify"></a><h6>  Manual minification </h6><br>  In order to shorten the names of methods, classes and attributes, such a syntactic construction was used immediately before the declarations of these entities.  Naturally, for methods that are called from external scripts and classes (public), this of course is not necessary. <br><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP &amp;&amp; !DEBUG [ScriptName("a0")] #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre><br>  However, local variables still cannot be minimized.  Also a disadvantage is the clogging of the code with such constructions and, as a result, deterioration of the code readability.  However, this technique can significantly reduce and confuse the generated JavaScript code. <br><br>  Another disadvantage is that such short names need to be monitored if they rename the names of methods (especially overloaded abstract in descendants) and fields, because in this case Script # will not swear at duplicate names.  However, it will not allow duplicate classes. <br><br>  By the way, in the developing version of Script # it would seem that the minification of private and internal methods and fields has already been added. <br><br><a name="AutoMinify"></a><h6>  Minification automatically </h6><br>  There are many utilities for JavaScript minification, but I used Google Closure Compiler because of the brand, good compression quality.  However, Google‚Äôs minifier‚Äôs disadvantage is that it cannot compress CSS files, but <a href="http://yui.github.com/yuicompressor/css.html">YUI,</a> for example, can.  In fact, Script # also minifies scripts, but it makes it significantly worse than GCC. <br><br>  It is worth noting that Google minifier has several levels of compression: Whitespace, Simple and Advanced.  The Simple level was chosen in the project, because although with Advanced you can achieve maximum compression quality, you need to write code in a special way so that the methods and classes are accessible from the outside.  Well, partly this minification was done manually with Script #.  If you are interested in Google Closure minifiers, I recommend viewing <a href="http://javascript.ru/optimize/google-closure-compiler">this list of</a> Russian-language articles. <br><br><a name="DebugRelease"></a><h5>  Debug &amp; Release Modes </h5><br>  The connection of debug and release versions of libraries to ASP.NET pages was done as follows: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span><span class="hljs-tag"> (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Gfranq.JavaScriptFilters.HtmlHelper.IsDebug</span></span></span><span class="hljs-tag">) { %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Scripts/mscorlib.debug.js"</span></span></span><span class="hljs-tag"> &gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Scripts/imgProcLib.debug.js"</span></span></span><span class="hljs-tag"> &gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> } </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">else</span></span></span><span class="hljs-tag"> { %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Scripts/mscorlib.js"</span></span></span><span class="hljs-tag"> &gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Scripts/imgProcLib.js"</span></span></span><span class="hljs-tag"> &gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> } %&gt;</span></span></code> </pre><br><br>  By the way, in our project not only scripts were minified, but also filter description files, too. <br><br><a name="crossOrigin"></a><h5>  CrossOrigin property </h5><br>  In order to be able to access the pixels of an image, it must first be converted to canvas.  However, this may cause a cross-domain access error (CORS).  In our case, this problem was resolved as follows: <br><ul><li>  Putting crossOrigin = '' on the client. </li><li>  Adding a special header to the http package on the server. </li></ul><br>  But since ScriptSharp does not support this property for img elements, the following code was written: <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Imported</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AdvImage</span></span> { [IntrinsicProperty] <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CrossOrigin { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { } } }</code> </pre><br>  And then use it like this: <br><pre> <code class="cs hljs">((AdvImage)(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>)result).CrossOrigin = <span class="hljs-string"><span class="hljs-string">""</span></span>;</code> </pre><br><br>  It should be noted that this technique allows you to add any property to an object without a compilation error.  In particular, the wheelDelta <a href="http://stackoverflow.com/q/13572711/1046374">property</a> (at least in version 0.7.5), which displays the amount of rotation of the wheel (used in collages), has <a href="http://stackoverflow.com/q/13572711/1046374">not</a> yet <a href="http://stackoverflow.com/q/13572711/1046374">been implemented</a> in ScriptSharp.  Therefore, it was implemented in a similar way.  In fact, such a dirty hack with properties is bad, but for good you need to make forks into the project.  But I honestly have not quite figured out how to compile ScriptSharp from source. <br><br>  On the server for such images you need to return such headers (in Global.asax): <br><pre> <code class="cs hljs">Response.AppendHeader(<span class="hljs-string"><span class="hljs-string">"Access-Control-Allow-Origin"</span></span>, <span class="hljs-string"><span class="hljs-string">"*"</span></span>);</code> </pre><br>  You can read more about cross-domain access to resources <a href="http://enable-cors.org/">here</a> . <br><br><a name="Optimizations"></a><h4>  Optimization </h4><br><a name="Precalculs"></a><h5>  Use of precomputed (tabular) values </h5><br>  For some operations, such as changing the brightness, contrast and color curves, optimization was applied, consisting in a preliminary calculation of the resulting color components (r, g, b) for all possible values, and then using the resulting arrays to directly change the colors of the pixels.  However, it is worth noting that such optimization is only suitable for operations in which the neighboring pixels do not affect the color of the resulting pixel. <br><br>  Calculation of color components for all possible values: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">256</span></span>; i++) { r[i] = &lt;actionFuncR&gt;(i); g[i] = &lt;actionFuncG&gt;(i); b[i] = &lt;actionFuncB&gt;(i); }</code> </pre><br>  Using pre-computed color components: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; data.Length; i += <span class="hljs-number"><span class="hljs-number">4</span></span>) { data[i] = r[data[i]]; data[i + <span class="hljs-number"><span class="hljs-number">1</span></span>] = g[data[i + <span class="hljs-number"><span class="hljs-number">1</span></span>]]; data[i + <span class="hljs-number"><span class="hljs-number">2</span></span>] = b[data[i + <span class="hljs-number"><span class="hljs-number">2</span></span>]]; }</code> </pre><br><br>  It is worth noting that if such table operations go in a row, then intermediate images can not be calculated at all, but only the arrays of the color components can be transferred.  But due to the fact that the code worked on the client and the server quite quickly, so far it was decided not to implement such optimization.  In addition, there were some other problems because of it.  However, the listing of this optimization, I still give: <br><table><tbody><tr><td>  Plain code </td><td>  Optimized code </td></tr><tr><td><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//   . for (int i = 0; i &lt; 256; i++) { r[i] = &lt;actionFunc1R&gt;(i); g[i] = &lt;actionFunc1G&gt;(i); b[i] = &lt;actionFunc1B&gt;(i); } ‚Ä¶ //    . for (int i = 0; i &lt; data.Length; i += 4) { data[i] = r[data[i]]; data[i + 1] = g[data[i + 1]]; data[i + 2] = b[data[i + 2]]; } ‚Ä¶ //   . for (int i = 0; i &lt; 256; i++) { r[i] = &lt;actionFunc2R&gt;(i); g[i] = &lt;actionFunc2G&gt;(i); b[i] = &lt;actionFunc2B&gt;(i); } ‚Ä¶ //   . for (int i = 0; i &lt; data.Length; i += 4) { data[i] = r[data[i]]; data[i + 1] = g[data[i + 1]]; data[i + 2] = b[data[i + 2]]; } ‚Ä¶</span></span></code> </pre><br></td><td><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//   . for (int i = 0; i &lt; 256; i++) { r[i] = &lt;actionFunc1R&gt;(i); g[i] = &lt;actionFunc1G&gt;(i); b[i] = &lt;actionFunc1B&gt;(i); } ‚Ä¶ //   . tr = r.Clone(); tg = g.Clone(); tb = b.Clone(); for (int i = 0; i &lt; 256; i++) { r[i] = tr[&lt;actionFunc2R&gt;(i)]; g[i] = tg[&lt;actionFunc2G&gt;(i)]; b[i] = tb[&lt;actionFunc2B&gt;(i)]; } ‚Ä¶ //   . for (int i = 0; i &lt; data.Length; i += 4) { data[i] = r[data[i]]; data[i + 1] = g[data[i + 1]]; data[i + 2] = b[data[i + 2]]; } ‚Ä¶</span></span></code> </pre><br></td></tr></tbody></table><br>  However, even this is not all.  If you look at the right table, you will notice that new arrays are created there using Clone.  In fact, the array can not be copied, but simply change the pointers to the old and new arrays (here we recall the analogy with <a href="http://ru.wikipedia.org/wiki/%25D0%2594%25D0%25B2%25D0%25BE%25D0%25B9%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25B1%25D1%2583%25D1%2584%25D0%25B5%25D1%2580%25D0%25B8%25D0%25B7%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F">double buffering</a> ). <br><br><a name="Pixels"></a><h5>  Convert an image to an array of pixels </h5><br>  The JavaScript profiler in Google Chrome has revealed that the GetImageData function (which is used to convert canvas to an array of pixels) takes a long time, which, however, can be read in various articles on optimizing Canvas in JavaScript. <br><br>  However, the number of calls to this function can also be minimized.  Namely, to use the same array of pixels for pixel-by-pixel operations, by analogy with the previous optimization. <br><br><a name="CodeSamples"></a><h3>  Code examples </h3><br>  Here I will describe examples of code that seemed interesting and useful to me.  To prevent the article from getting too long, I enclosed them in spoilers. <br><br><a name="General"></a><h4>  Are common </h4><br><a name="IsNumericSample"></a><div class="spoiler">  <b class="spoiler_title">Determining whether a string is a number</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsNumeric</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> !SCRIPTSHARP return ((Number)int.Parse(n)).ToString() != "NaN"; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> double number; return double.TryParse(n, out number); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> }</span></span></code> </pre><br></div></div><br><a name="IntegerDivSample"></a><div class="spoiler">  <b class="spoiler_title">Integer division</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Div</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> k</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result = n / k; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP result = Math.Floor(n / k); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> return result; }</span></span></code> </pre><br></div></div><br><a name="ImageRotateFlipSample"></a><div class="spoiler">  <b class="spoiler_title">Rotate and reverse images on canvas and bitmap respectively</b> <div class="spoiler_text">  Please note that in html5 canvas there are no functions to rotate the image by 90, 180 degrees, except using matrices, but in .NET there are.  So the corresponding exact pixel function was written. <br><br>  It is also worth noting that in the .NET version, turning 90 degrees in any direction can lead to incorrect results.  Therefore, after using the RotateFlip function in these cases, you need to create a new Bitmap. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Bitmap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RotateFlip</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Bitmap bitmap, RotFlipType rotFlipType</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP int t, i4, j4, w, h, c; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.RotateNoneFlipNone) return bitmap; GraphicsContext context; PixelArray data; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.RotateNoneFlipX) { context = GraphicsContext.GetContext(bitmap); data = context.GetPixelArray(); w = bitmap.Width; h = bitmap.Height; for (int i = 0; i &lt; h; i++) { c = (i + 1) * w * 4 - 4; for (int j = 0; j &lt; w / 2; j++) { i4 = (i * w + j) * 4; j4 = j * 4; t = (int)data[i4]; data[i4] = data[c - j4]; data[c - j4] = t; t = (int)data[i4 + 1]; data[i4 + 1] = data[c - j4 + 1]; data[c - j4 + 1] = t; t = (int)data[i4 + 2]; data[i4 + 2] = data[c - j4 + 2]; data[c - j4 + 2] = t; t = (int)data[i4 + 3]; data[i4 + 3] = data[c - j4 + 3]; data[c - j4 + 3] = t; } } context.PutImageData(); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.Rotate180FlipNone || rotFlipType == RotFlipType.Rotate180FlipX) { context = GraphicsContext.GetContext(bitmap); data = context.GetPixelArray(); w = bitmap.Width; h = bitmap.Height; c = w * 4 - 4; int dlength4 = data.Length - 4; for (int i = 0; i &lt; data.Length / 4 / 2; i++) { i4 = i * 4; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.Rotate180FlipNone) j4 = i4; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> j4 = (Math.Truncate((double)i / w) * w + (w - i % w)) * 4; t = (int)data[j4]; data[j4] = data[dlength4 - i4]; data[dlength4 - i4] = t; t = (int)data[j4 + 1]; data[j4 + 1] = data[dlength4 - i4 + 1]; data[dlength4 - i4 + 1] = t; t = (int)data[j4 + 2]; data[j4 + 2] = data[dlength4 - i4 + 2]; data[dlength4 - i4 + 2] = t; t = (int)data[j4 + 3]; data[j4 + 3] = data[dlength4 - i4 + 3]; data[dlength4 - i4 + 3] = t; } context.PutImageData(); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { Bitmap tempBitmap = PrivateUtils.CreateCloneBitmap(bitmap); GraphicsContext tempContext = GraphicsContext.GetContext(tempBitmap); PixelArray temp = tempContext.GetPixelArray(); t = bitmap.Width; bitmap.Width = bitmap.Height; bitmap.Height = t; context = GraphicsContext.GetContext(bitmap); data = context.GetPixelArray(); w = tempBitmap.Width; h = tempBitmap.Height; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.Rotate90FlipNone || rotFlipType == RotFlipType.Rotate90FlipX) { c = w * h - w; for (int i = 0; i &lt; temp.Length / 4; i++) { t = Math.Truncate((double)i / h); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.Rotate90FlipNone) i4 = i * 4; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> i4 = (t * h + (h - i % h)) * 4; j4 = (c - w * (i % h) + t) * 4; //j4 = (w * (h - 1 - i4 % h) + i4 / h) * 4; data[i4] = temp[j4]; data[i4 + 1] = temp[j4 + 1]; data[i4 + 2] = temp[j4 + 2]; data[i4 + 3] = temp[j4 + 3]; } } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.Rotate270FlipNone || rotFlipType == RotFlipType.Rotate270FlipX) { c = w - 1; for (int i = 0; i &lt; temp.Length / 4; i++) { t = Math.Truncate((double)i / h); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (rotFlipType == RotFlipType.Rotate270FlipNone) i4 = i * 4; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> i4 = (t * h + (h - i % h)) * 4; j4 = (c + w * (i % h) - t) * 4; // j4 = w * (1 + i4 % h) - i4 / h - 1; data[i4] = temp[j4]; data[i4 + 1] = temp[j4 + 1]; data[i4 + 2] = temp[j4 + 2]; data[i4 + 3] = temp[j4 + 3]; } } context.PutImageData(); } return bitmap; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">elif</span></span></span><span class="hljs-meta"> DOTNET Bitmap result = null; switch (rotFlipType) { case RotFlipType.RotateNoneFlipNone: result = bitmap; break; case RotFlipType.Rotate90FlipNone: bitmap.RotateFlip(RotateFlipType.Rotate90FlipNone); result = new Image(bitmap); bitmap.Dispose(); break; case RotFlipType.Rotate270FlipNone: bitmap.RotateFlip(RotateFlipType.Rotate270FlipNone); result = new Image(bitmap); bitmap.Dispose(); break; case RotFlipType.Rotate180FlipNone: bitmap.RotateFlip(RotateFlipType.Rotate180FlipNone); result = bitmap; break; case RotFlipType.RotateNoneFlipX: bitmap.RotateFlip(RotateFlipType.RotateNoneFlipX); result = bitmap; break; case RotFlipType.Rotate90FlipX: bitmap.RotateFlip(RotateFlipType.Rotate90FlipX); result = new Image(bitmap); bitmap.Dispose(); break; case RotFlipType.Rotate180FlipX: bitmap.RotateFlip(RotateFlipType.Rotate180FlipX); result = bitmap; break; case RotFlipType.Rotate270FlipX: bitmap.RotateFlip(RotateFlipType.Rotate270FlipX); result = new Image(bitmap); bitmap.Dispose(); break; } return result; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> }</span></span></code> </pre><br></div></div><br><a name="AsyncSyncImageLoadSample"></a><div class="spoiler">  <b class="spoiler_title">Asynchronous and synchronous loading images</b> <div class="spoiler_text">  Please note that in the ScriptSharp version, another CollageImageLoad function is specified, which will be called after the image is loaded, while in the .NET version everything happens synchronously (from the file system or the Internet). <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CollageData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> smallMaskPath, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bigMaskPath, List&lt;CollageDataPart&gt; dataParts</span></span></span><span class="hljs-function">)</span></span> { SmallMaskImagePath = smallMaskPath; BigMaskImagePath = bigMaskPath; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SCRIPTSHARP CurrentMask = PrivateUtils.CreateEmptyImage(); CurrentMask.AddEventListener("load", CollageImageLoad, false); CurrentMask.Src = CurrentMaskImagePath; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> CurrentMask = PrivateUtils.LoadBitmap(CurrentMaskImagePath); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!CurrentMaskImagePath.Contains("http://") &amp;&amp; !CurrentMaskImagePath.Contains("https://")) CurrentMask = Bitmap(CurrentMaskImagePath); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { var request = WebRequest.Create(CurrentMaskImagePath); using (var response = request.GetResponse()) using (var stream = response.GetResponseStream()) CurrentMask = (Bitmap)Bitmap.FromStream(stream); } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> DataParts = dataParts; }</span></span></code> </pre><br></div></div><br><a name="JavascriptOnly"></a><h5>  Only Script # </h5><br><a name="BrowserDetermSample"></a><div class="spoiler">  <b class="spoiler_title">Determining the type and version of the browser</b> <div class="spoiler_text">  This function is used, for example, to determine the drag &amp; drop capabilities in various browsers (I tried to use <a href="http://modernizr.com/">modernizr</a> , but it returned that Safari (in my case for Win) and IE9 implement it. However, in practice, it turned out that these browsers do not completely implement drag &amp; drop right). <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> BrowserVersion { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { DetectBrowserTypeAndVersion(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _browserVersion; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DetectBrowserTypeAndVersion</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_browserDetected) { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> userAgent = Window.Navigator.UserAgent.ToLowerCase(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">"opera"</span></span>) != <span class="hljs-number"><span class="hljs-number">-1</span></span>) _browser = BrowserType.Opera; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">"chrome"</span></span>) != <span class="hljs-number"><span class="hljs-number">-1</span></span>) _browser = BrowserType.Chrome; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">"safari"</span></span>) != <span class="hljs-number"><span class="hljs-number">-1</span></span>) _browser = BrowserType.Safari; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">"firefox"</span></span>) != <span class="hljs-number"><span class="hljs-number">-1</span></span>) _browser = BrowserType.Firefox; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">"msie"</span></span>) != <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> numberIndex = userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">"msie"</span></span>) + <span class="hljs-number"><span class="hljs-number">5</span></span>; _browser = BrowserType.IE; _browserVersion = userAgent.Substring(numberIndex, userAgent.IndexOf(<span class="hljs-string"><span class="hljs-string">';'</span></span>, numberIndex)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> _browser = BrowserType.Unknown; _browserDetected = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }</code> </pre><br></div></div><br><a name="DashDotLineSample"></a><div class="spoiler">  <b class="spoiler_title">Dashed line drawing</b> <div class="spoiler_text">  Used for a rectangle when cropping images.  For ideas thanks to everyone who answered in this <a href="http://stackoverflow.com/q/4576724/1046374">question on SO</a> . <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DrawDahsedLine</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GraphicsContext context, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] dashArray</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dashArray == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) dashArray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>] { <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dashCount = dashArray.Length; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> dx = x2 - x1; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> dy = y2 - y1; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> xSlope = Math.Abs(dx) &gt; Math.Abs(dy); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> slope = xSlope ? dy / dx : dx / dy; context.MoveTo(x1, y1); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> distRemaining = Math.Sqrt(dx * dx + dy * dy); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dashIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (distRemaining &gt;= <span class="hljs-number"><span class="hljs-number">0.1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dashLength = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)Math.Min(distRemaining, dashArray[dashIndex % dashCount]); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> step = Math.Sqrt(dashLength * dashLength / (<span class="hljs-number"><span class="hljs-number">1</span></span> + slope * slope)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xSlope) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dx &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) step = -step; x1 += step; y1 += slope * step; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dy &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) step = -step; x1 += slope * step; y1 += step; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dashIndex % <span class="hljs-number"><span class="hljs-number">2</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span>) context.LineTo(x1, y1); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> context.MoveTo(x1, y1); distRemaining -= dashLength; dashIndex++; } }</code> </pre><br></div></div><br><a name="RotateAnimationSample"></a><div class="spoiler">  <b class="spoiler_title">Image rotation animation</b> <div class="spoiler_text">  To animate the rotation of the image, use the setInterval function.  Notice that the result result is rendered during the animation so that there are no small lags at the end of the animation. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Rotate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cw</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_rotating &amp;&amp; !_flipping) { _rotating = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; _cw = cw; RotFlipType oldRotFlipType = _curRotFlipType; _curRotFlipType = RotateRotFlipValue(_curRotFlipType, _cw); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> currentStep = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> stepCount = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(RotateFlipTimeSeconds * <span class="hljs-number"><span class="hljs-number">1000</span></span> / StepTimeTicks); Bitmap result = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; _interval = Window.SetInterval(<span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentStep &lt; stepCount) { <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> absAngle = GetAngle(oldRotFlipType) + currentStep / stepCount * Math.PI / <span class="hljs-number"><span class="hljs-number">2</span></span> * (_cw ? <span class="hljs-number"><span class="hljs-number">-1</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>); DrawRotated(absAngle); currentStep++; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Window.ClearInterval(_interval); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) Draw(result); _rotating = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }, StepTimeTicks); result = GetCurrentTransformResult(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_rotating) Draw(result); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DrawRotated</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rotAngle</span></span></span><span class="hljs-function">)</span></span> { _resultContext.FillColor = FillColor; _resultContext.FillRect(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, _result.Width, _result.Height); _resultContext.Save(); _resultContext._graphics.Translate(_result.Width / <span class="hljs-number"><span class="hljs-number">2</span></span>, _result.Height / <span class="hljs-number"><span class="hljs-number">2</span></span>); _resultContext._graphics.Rotate(-rotAngle); _resultContext._graphics.Translate(-_origin.Width / <span class="hljs-number"><span class="hljs-number">2</span></span>, -_origin.Height / <span class="hljs-number"><span class="hljs-number">2</span></span>); _resultContext._graphics.DrawImage(_origin, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); _resultContext.Restore(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Draw</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Bitmap bitmap</span></span></span><span class="hljs-function">)</span></span> { _resultContext.FillColor = FillColor; _resultContext.FillRect(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, _result.Width, _result.Height); _resultContext.Draw2(bitmap, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)((_result.Width - bitmap.Width) / <span class="hljs-number"><span class="hljs-number">2</span></span>), (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)((_result.Height - bitmap.Height) / <span class="hljs-number"><span class="hljs-number">2</span></span>)); }</code> </pre><br></div></div><br><a name="Conclusion"></a><h3>  Conclusion </h3><br>  This article showed how large cross-platform C # can have, combining unmanaged code on one side and compiling for JavaScript on the other.  Despite the fact that the main emphasis was placed on .NET and JavaScript, compilation for Android, iOS (using Mono) and Windows Phone is also possible based on the described approach, naturally with its pitfalls. ,      ,         ,       . <br><br>    ,    ,     .           . <br><br>   ,      ,      google  ASP.NET  MS SQL   ,       .       : <br><br><ul><li>    MS SQL (    TSQL, C#,    ). </li><li>         . </li><li> Google maps  geocoding api (   ,  ). </li></ul><br> PS     <a href="http://gfranq.com/">gfranq.com</a> <a href="https://habr.com/users/oneuser/" class="user_link">oneuser</a>  <a href="https://habr.com/users/vladaorlova/" class="user_link">VladaOrlova</a> . <br><br>  <b>UPDATE</b> <br><br>  JavaScript,  Script#     : <br> <a href="">imgProcLib</a> <br><br>  mscorlib (  ): <br> <a href="">mscorlib</a> <br><br>   ,      ,    ,        mscorlib. <br><br>  <b>UPDATE 2</b> <br><br>        <a href="http://habrahabr.ru/post/182532/"></a> </div><p>Source: <a href="https://habr.com/ru/post/164439/">https://habr.com/ru/post/164439/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../164427/index.html">LED standby lighting</a></li>
<li><a href="../164431/index.html">Happy New Year! or Demoscene on the calculator</a></li>
<li><a href="../164433/index.html">jQuery inside - introduction</a></li>
<li><a href="../164435/index.html">Why Facebook offers are not in a hurry to blow up the news feed?</a></li>
<li><a href="../164437/index.html">Analysis of keygenme from Ra $ cal on the basis of a virtual machine</a></li>
<li><a href="../164441/index.html">Christmas app on Android</a></li>
<li><a href="../164443/index.html">Correct ajax requests in Drupal 7</a></li>
<li><a href="../164445/index.html">Cfengine3 - configuration management system</a></li>
<li><a href="../164447/index.html">Will the base break if the server is pulled out of the socket, or DB ORACLE giblets for dummies</a></li>
<li><a href="../164451/index.html">Concept art - the history, purpose, problems associated with it, and how to create it</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>