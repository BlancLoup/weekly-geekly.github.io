<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SQL engine for generating reports. Idea</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 The article is written from the point of view of a programmer from the ERP system technical support. 

 Carrying out the next test task...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SQL engine for generating reports. Idea</h1><div class="post__text post__text-html js-mediator-article"><h5>  Introduction </h5><br>  The article is written from the point of view of a programmer from the ERP system technical support. <br><br>  Carrying out the next test task, for the next vacancy, I got another brilliant idea. <br>  Why not give the user the editing of formulas for calculating report columns?  The result is the same Excel that everyone is used to, only the syntax is SQL. <br><br>  And of course, in the 30 years of the development of ERP systems, this has already been realized where it is.  But their algorithms are their secrets, but I do not mind.  I will share an idea. <br><a name="habracut"></a><br><h5>  Test </h5><br>  There is a relational database with data that comes in daily.  Each month based on these data reports are built.  It is necessary to think over and propose the architecture of the system for building periodic reports. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      System requirements: <br><br>  1) Reports can be viewed in the web interface, downloaded to excel, retrieved from the web service as JSON (for transmission to an external system). <br>  2) Reports are built for different clients.  Each client wants a different report from the standard one: its own header and footer, displayed columns, column order, additional calculated columns. <br>  3) Ability to save reports.  The original data is changed, and the saved report remains unchanged. <br>  4) Edit the report (source data) on the fly in the web interface. <br><br>  The result should be an ER (Entity-Relationship) chart.  Text description of the solution. <br><br><h5>  Idea </h5><br>  What is a regular report?  This is a printed source data table to which several columns have been added with the calculated values, or a summary of the source data has been summed up. <br><br>  What do users want from programmers?  change the logic of calculations, if it concerns the logic of selecting source data, then only the programmer can deal with it, because it is necessary to change or the presentation on which the report is based, or the logic of the stored procedure, and if these are only formulas for which calculations are made, then this work can be done at the mercy of users.  What is offered? <br><br>  Teach the user to write SQL formulas, users are smart enough to write Excel formulas and, if desired, they will master SQL as well, and the standard set of SQL should of course be expanded with domain-specific functions. <br><br>  If functions are written in SQL, then we can substitute them in a SELECT, which should then be executed as a dynamic query. <br>  This feature is in T-SQL and PL / SQL. <br><br><h5>  Sketch implementation project </h5><br><h6>  Main entities </h6><br><ul><li>  <b>Formula</b> </li><li>  <b>Speaker</b> </li><li>  <b>A section</b> is a heading or basement of a report, or anything else that is not a column, a printed form area that exists in a single copy. </li><li>  <b>Instance</b> - generated report. </li><li>  <b>Client</b> - according to the test task that I performed, each client has its own set of columns, in general <b>consumer_id</b> is a separate report, which is based on its data according to its own rules. </li></ul><br><h6>  Formulas </h6><br>  Formulas for calculating fields will be stored in the <b>formulas</b> table, DDL: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> formulas ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,code <span class="hljs-keyword"><span class="hljs-keyword">NCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,formula <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_formulas PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> UK_formulas_code <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (code) ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] TEXTIMAGE_ON [PRIMARY]</code> </pre> <br>  Each formula has its own unique code designation - the <b>code</b> field;  <b>formula</b> - SQL expression to calculate the value. <br><br>  The text of the formula will be inserted into the phrase ‚ÄúSELECT‚Äù, which will be executed dynamically, so you can use parameters (": PARAM1") in the formula and substitute the values ‚Äã‚Äãof these parameters when dynamically executing the SQL code.  Similarly, you can form the phrase ‚ÄúFROM‚Äù, ‚ÄúWHERE‚Äù and other parts of the SQL statement. <br><br>  When calculating a column using a formula, additional parameters may be required which are not in the source data; in order to substitute such parameters, the ‚Äúplaceholder‚Äù should be indicated in the formula - the text to be replaced with the parameter value. <br><br>  To do this, you can ‚Äúattach‚Äù an entry from the <b>formula_parameters</b> , DDL table to the entry in the <b>formula</b> table: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> formula_parameters ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,code <span class="hljs-keyword"><span class="hljs-keyword">NCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,formula_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,placeholder <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">4000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_formula_parameters PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> UK_formula_parameters_code <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (formula_id, code) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> UK_formula_parameters_placeholder <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (formula_id, placeholder) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_formula_parameters_formulas_id <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (formula_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> dbo.formulas (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY]</code> </pre><br>  <b>code</b> - unique parameter code; <br>  <b>placeholder</b> - the text to replace with the parameter value, in the formula, the value must be substituted through the appropriate CAST or another way of converting the type from string to required (taking into account the specifics of the DBMS), the text is substituted into the formula, therefore CAST must be from the text to the required type, this must be taken into account formatting the parameter value. <br><br><h6>  Columns and Sections </h6><br>  Formulas can be substituted in the columns and in the report section.  The value of the column is calculated by the same formula.  Report sections are a cap and a basement.  You can add other types of sections.  A section can contain several calculated values, so several formulas can be associated with one section. <br><br>  Column formulas are stored in the <b>columns</b> , DDL table: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">columns</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,formula_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,description <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_columns PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_columns_formulas_id <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (formula_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> dbo.formulas (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] TEXTIMAGE_ON [PRIMARY]</code> </pre><br>  <b>name</b> - each column has its own name, different columns can have the same name. <br>  <b>description</b> - the description may be empty. <br><br>  <b>Section</b> formulas - <b>region_formulas</b> , DDL: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> region_formulas ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,formula_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,region_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,placeholder <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">4000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_region_formulas PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> UK_region_formulas_formula_id_region_id <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (formula_id, region_id) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_region_formulas_formulas_formula_id <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (formula_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> dbo.formulas (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_region_formulas_regions_id <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (region_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> dbo.regions (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY]</code> </pre><br>  <b>placeholder</b> - the text to be replaced with the value calculated using the formula. <br><br>  In one section ( <b>region_id</b> ) one formula ( <b>formula_id</b> ) can be calculated only once, for all places where it is necessary to insert its result must be the same <b>placeholder</b> . <br><br>  You can of course give free rein to users, this restriction is the ‚Äúautopilot‚Äù optimization. <br><br>  The calculated values ‚Äã‚Äãof the parameters of the partition template must be inserted into the partition template, the partition templates are the table <b>regions</b> : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> regions ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,pattern <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">4000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,description <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_regions PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> UK_regions_name <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] TEXTIMAGE_ON [PRIMARY]</code> </pre><br>  <b>pattern</b> - the actual section template <br>  <b>name</b> - section name <br>  <b>description</b> - the description may be empty. <br><br>  When calculating a specific section text, it is necessary to replace the <b>pattern</b> in the text of the <b>pattern</b> (table regions) with the text of the <b>placeholder</b> (table region_formulas) with the calculated values. <br><br>  The layout of the sections in the report instance is defined by the <b>consumers_report_regions</b> , DDL table: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> consumers_report_regions ( consumer_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,region_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,region_order <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,type_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_consumers_report_base PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED (consumer_id, region_id) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> UK_consumers_report_regions_region_order <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (consumer_id, region_order) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_consumers_report_regions_consumer_reference_id <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (consumer_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> dbo.consumer_reference (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_consumers_report_regions_regions_id <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (region_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> dbo.regions (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_consumers_report_regions_report_region_types_id <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (type_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> dbo.report_region_types (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY]</code> </pre><br>  <b>type_id</b> - link to the directory of types of sections (header / basement / other); <br>  <b>region_order</b> - the order of the section in the report, for one client, the value of the order can not be repeated. <br><br>  The column order for each customer is unique and is stored in the <b>consumers_report_columns</b> , DDL table: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> consumers_report_columns ( column_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,consumer_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,column_order <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_consumers_report_columns PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED (consumer_id, column_id) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> UK_consumers_report_columns_column_order <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (consumer_id, column_order, column_id) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_consumers_report_columns_columns_id <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (column_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> dbo.columns (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_consumers_report_columns_consumer_reference_id <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (consumer_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> dbo.consumer_reference (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY]</code> </pre><br>  <b>column_order</b> - the ordinal number of the column, for one customer each column has its own order value; <br><br>  Thus, using the <b>consumers_report_columns</b> and <b>consumers_report_regions</b> tables, the report structure is set individually for each client. <br><br>  The tables <b>columns</b> and <b>region_formulas</b> define calculation rules for columns and sections.  The <b>formulas</b> table sets the rules for calculating values. <br><br><h6>  Instance </h6><br>  The calculated report (instance) is stored in the structure of the tables report_instances, report_region_instances, report_cell_instances.  The <b>report_instances</b> table stores information about the generated report copies, DDL: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> report_instances ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">4000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,description <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,state_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_report_instances PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> NONCLUSTERED (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> UK_report_instances_name <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_report_instances_report_instace_states_reference_id <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (state_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> dbo.report_instace_states_reference (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] TEXTIMAGE_ON [PRIMARY]</code> </pre><br>  <b>name</b> - instance name unique in the table; <br>  <b>description</b> - the description may be empty; <br>  <b>state_id</b> - reference to the instance status directory (‚Äúformed‚Äù, ‚Äúready‚Äù, ‚Äúsaved‚Äù, ‚Äúdeleted‚Äù). <br><br>  Formed report sections - <b>report_region_instances</b> , DDL: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> report_region_instances ( instace_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,consumer_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,region_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_report_region_instances PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED (instace_id, consumer_id, region_id) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_report_region_instances_consumers_report_regions <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (consumer_id, region_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> dbo.consumers_report_regions (consumer_id, region_id) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_report_region_instances_report_instances_instace_id <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (instace_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> dbo.report_instances (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] TEXTIMAGE_ON [PRIMARY]</code> </pre><br>  <b>value</b> - section text, the text is saved ‚Äúalready glued‚Äù, individual values ‚Äã‚Äãcalculated by the formulas are not saved. <br><br>  The generated cell values ‚Äã‚Äãof the table part are <b>report_cell_instances</b> , DDL: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> report_cell_instances ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,instance_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,consumer_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,column_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,row_order <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_report_cell_instances PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> UK_report_cell_instances_column_id_row_order <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (instance_id, consumer_id, column_id, row_order) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_report_cell_instances <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (consumer_id, column_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> dbo.consumers_report_columns (consumer_id, column_id) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_report_cell_instances_report_instances_id <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (instance_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> dbo.report_instances (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] TEXTIMAGE_ON [PRIMARY]</code> </pre><br>  <b>row_order</b> - row order, row number of the table part; <br>  <b>value</b> is the cell text. <br><br>  One instance of the report of one client has one calculated column that cannot have several identical row numbers, that is, the cell coordinate is unique - a pair (column, row). <br><br>  According to the client's report structure (consumers_report_columns, consumers_report_regions) and calculated values ‚Äã‚Äã(report_region_instances, report_cell_instances), you can ‚Äúglue‚Äù a specific instance of the report. <br><br>  Thus, the mechanism of unique formulas and the composition of columns for each client is implemented, the mechanism of saving the calculated report is implemented. <br><br>  It remains only to develop a stored procedure for calculating the values ‚Äã‚Äãusing the formulas and the corresponding storage. <br><br>  I would be glad to constructive criticism or references to the classical implementations of such logic. <br><br><h4>  Links </h4><br><ul><li>  <a href="https://habrahabr.ru/post/278921/">SQL engine for generating reports.</a>  <a href="https://habrahabr.ru/post/278921/">Solution Draft</a> </li><li>  <a href="https://github.com/SbWereWolf/SqlReportConstructor">Sources on GitHub</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/278595/">https://habr.com/ru/post/278595/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../278581/index.html">History of Chatto</a></li>
<li><a href="../278583/index.html">Work with FireBird from 1C. Collection of proven recipes</a></li>
<li><a href="../278585/index.html">Margaret Hamilton: "Guys, I'll send you to the moon"</a></li>
<li><a href="../278589/index.html">libuniset2 is a library for creating ACS. It‚Äôs better to see once ... Part 4 (Adjustment)</a></li>
<li><a href="../278593/index.html">We get acquainted with web standards. Work with audio. - Video and creation history</a></li>
<li><a href="../278597/index.html">Decomposition of the affine transformation matrix</a></li>
<li><a href="../278599/index.html">We send Angular 2 routs through Laravel 5 router</a></li>
<li><a href="../278601/index.html">WG Labs Announces Developer Contest</a></li>
<li><a href="../278603/index.html">Build FreeType library for Android x86 using NDK</a></li>
<li><a href="../278605/index.html">The history of one technology. Mob</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>