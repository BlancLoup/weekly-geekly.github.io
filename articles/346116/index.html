<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Restate - or how to turn a Redux log into a tree</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The history of IT development is much more interesting than any soap opera, but we will not retell it. We can only say that we have witnessed the prin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Restate - or how to turn a Redux log into a tree</h1><div class="post__text post__text-html js-mediator-article">  The history of IT development is much more interesting than any soap opera, but we will not retell it.  We can only say that we have witnessed the principle of "data-driven", adrenals with two-way-binding and boundless people without principles and concepts. <br><blockquote>  God made people strong and weak.  Samuel Colt made them equal. <br>  Flux and Redux did about the same thing. </blockquote><br>  There was only one problem - Redux is essentially a very primitive crap, and in order to work with it at least, you had to add a couple of middleware - thunk, saga, observable, and so on. <br><br>  But this article comes from the other side, seriously asking about the composition, and, in particular, about the component model.  Which is in the editor - no. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yd/5s/5v/yd5s5v81qkzbzywm32sbdf8wpmo.jpeg"></div><br><a name="habracut"></a><br>  For a better understanding of the problem - let's start with the basics, and make TODO. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  React option </h2><br>  Everyone loves reaction for the component model, and generally because it is very ‚Äúcomposable‚Äù.  You can <i>take almost any component, wrap it in 10 others and it will work as you need.</i>  (remember this phrase) <br><br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   TODO const TODOs = [todo1, todo2, todo3]; //     const Application = &lt;TodoList todos={TODOs} /&gt; //  TodoList,      const TodoList = ({todos}) =&gt; ( &lt;ol&gt; {todos.map( todo =&gt; &lt;Todo key={todo.id} {...todo} /&gt; &lt;/ol&gt; ); //    TODO   const Todo = (props) =&gt; &lt;div&gt;......&lt;/div&gt;</span></span></code> </pre> <br>  All is well, but the question arises of what to do with events, how to control everything in general. <br><br><h2>  Simple redux option </h2><br>  Redux solves a lot of problems, and we will not talk about them now.  I hope the code below is completely understandable and obvious to everyone. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   const store = createStore({ todos: [todo1, todo2, todo3] }); //   const Application = &lt;Provider store={store}&gt; &lt;ConnectedTodoList/&gt; &lt;/Provider&gt; //    .    TODO const ConnectedTodoList = connect( state =&gt; ({todos: state.todos}), { onTodoClick } )(TodoList) //     const TodoList = ({todos}) =&gt; ( &lt;ol&gt; {todos.map( todo =&gt; &lt;Todo key={todo.id} {...todo} onClick={() =&gt; onTodoClick(todo.id)} /&gt; &lt;/ol&gt; ); ....</span></span></code> </pre><br>  This is an example of a <u>bad</u> redux application, and this is what the <a href="https://github.com/reactjs/redux/tree/master/examples/todos/src">original example</a> from the redux repository looks like. <br><br>  There are two problems here: <br>  - mix React and Redux <br>  - when any Todo changes, a rerenter of everything happens - both the Todo list and each Todo. <br><br><h2>  More correct redux </h2><br>  The correct option does not differ from the wrong one. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    .    TODO const ConnectedTodoList = connect( state =&gt; ({todos: getOnlyIds(state.todos)}), &lt;-----    { onTodoClick } )(TodoList) const TodoList = ({todos}) =&gt; ( &lt;ol&gt; {todos.map( id =&gt; &lt;ConnectedTodo key={id} id={id} /&gt; &lt;-----   &lt;/ol&gt; ); //  Todo   const ConnectedTodo = connect( (state,props) =&gt; ({...state.todos[props.id])}), &lt;-----    { onTodoClick: () =&gt; dispatch =&gt; dispatch(onTodoClick(props.id)) } )(Todo) ....</span></span></code> </pre><br>  What is better?  TodoList does not depend on the contents of a particular Todo, responding only to the fact of presence.  Well, Todo - he goes behind the data himself, and he adds his own Id in onTodoClick. <br><br>  In essence, it is no longer possible to add ‚Äúmore‚Äù redaks.  At the same time, React is no longer used to pass data from parents to children.  As a result, no composition is possible anymore. <br><br><h2>  What is the composition? </h2><br>  A good example of a ‚Äúproblem‚Äù is an <a href="https://github.com/reactjs/redux/blob/master/examples/tree-view/">example of a Tree-view</a> , again from the official repository. <br><br>  Technically, the same TODO-list, only ‚Äúnesting‚Äù appears.  There is no ‚Äúnesting‚Äù there, because the ‚Äústor‚Äù is completely flat, and any deepest node can be addressed according to Id.  And the problem is not in this data structure, but in the fact that it is impossible to use another one! <br><br>  That's because Node, when encountering child Node to render, renders ConnectedNode, and in case of redux, all Connected components are equal and connect directly to the server. <br>  And, <u>if the components are equal, they must also perform a completely identical action</u> ‚Äî take the element of the array with the known Id. <br><br>  In other words - Components work regardless of their position in the tree, and it is absolutely impossible <i>to take a component, wrap it back in 10, and make it work as you need</i> - it will always work the same way.  Predictable - of course, yes.  Did we just want it? <br><br>  Trite - try to remake any TODO list into a list of lists, ala Trello - you will have to rewrite just about everything, and certainly each connect. <br><br>  And if the problem is precisely in the complete ignoring of the component's nesting of components, perhaps this is what needs to be fixed.  In the sense that <br><br><h2>  Enough tolerating this! </h2><br>  Imagine a situation where the parent component can prepare data for your child, as he considers it necessary.  Imagine a situation where a parent can control all the actions that his child performs.  And remember, this is roughly what redux tried to ‚Äúfix‚Äù, and it can‚Äôt be washed back. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rf/y1/pk/rfy1pkoysiesfz8qr46f8pmiw5c.png"></div><br>  That's just really a bit different things.  The problem was the bi-directionality of the events, which spawned cascade updates that were almost impossible to control. <br>  Plus - 99% of the examples continue to use the standard approach of Reacta, which just allows truthfully or not to throw some secret Id into the child, so that he can then read the data from the store. <br><br>  Simply this can be done a little more easier, and more correctly. <br><br><h2>  Redux-restate </h2><br>  Redux-restate ( <a href="https://github.com/thekashey/restate">github</a> ) is a miniature (50 lines *) library that accepts one or more input entries and performs certain operations on them and outputs an exit exit. <br><blockquote>  Immediately it is necessary to clarify - the number of pages does not change!  restate is a view in the database, or transformation in mobx, or lens, or mapStateToProps (only ToState).  This is not a ‚ÄúStor.‚Äù </blockquote><br>  In fact, restate are three separate packages: <br>  - redux-restate - lower level, do what you want <br>  - react-redux-restate - piping around the reactor - get the story from the context, and put it back (narrow moment) <br>  - react-redux-focus is a simplified version of restate.  For use in 99% of cases. <br><br>  Everything works simply: <br>  - When ‚Äúimmersing‚Äù (creating a state), you can programmatically change the data that will be available to children <br>  - During the ‚Äúascent‚Äù (event processing), you can supplement the event with the necessary data in order to correctly form the final command. <br><br>  ‚ÄúImmersion‚Äù is simply a unidirectional action that takes the state to the input and gives the state to the exit.  It is very important to memorize the intermediate result with the same recompose, just as it is done in mapStateToProps. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> composeState = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state, props</span></span></span><span class="hljs-function">) =&gt;</span></span> ({ ...state, <span class="hljs-attr"><span class="hljs-attr">part</span></span>: recompose(operationOn(state)) });</code> </pre><br>  A ‚Äúascent‚Äù is a unidirectional action that is performed when the subordinate component calls dispatch.  Its meaning is to add that ‚Äúspecificity‚Äù that was removed at the moment of the creation of the state. <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> routeDispatch = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dispatch, event, props</span></span></span><span class="hljs-function">) =&gt;</span></span> dispatch({...event, <span class="hljs-attr"><span class="hljs-attr">somethingFrom</span></span>: props.data });</code> </pre><br>  An example of "even more correct" redux: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    .    TODO const ConnectedTodoList = connect( state =&gt; ({todos: getOnlyIds(state.todos)}), { onTodoClick } )(TodoList) const TodoList = ({todos}) =&gt; ( &lt;ol&gt; {todos.map( id =&gt; &lt;RestatedTodo key={id} id={id} /&gt; &lt;-----    &lt;/ol&gt; ); //  Todo   (reactReduxFocus -    API   ) const RestatedTodo = reactReduxFocus( (state, props) =&gt; ({todo: state.todos[props.id]}), //    __ todo (dispatch, event, props) =&gt; dispatch({...event, id: props.id}); //    todoID )(ConnectedTodo) //  Todo   const ConnectedTodo = connect( (state,props) =&gt; ({...state.todo}), &lt;-----    { onTodoClick } &lt;----    )(Todo) ....</span></span></code> </pre><br>  As a side effect, we get the automatic areStatesEqual - if the calculated state is shallowEqual to the old value - the propagation of the change stops, which allows you to isolate different parts of the application from each other. <br><br>  An example of a tree can now write ‚Äúmore‚Äù correctly <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> RestatedNode = reactReduxFocus( <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state, props</span></span></span><span class="hljs-function">) =&gt;</span></span> ({ ...state, <span class="hljs-comment"><span class="hljs-comment">//  node   node: state.node.children[props.nodeId] }), (dispatch, event, props) =&gt; dispatch({ ...event, //   nodeId     nodeId:[props.nodeId, ...event.nodeId] }); )(ConnectedNode); const ConnectedNode = connect( state =&gt; { ...state, children: state.node.children, leafs: state.node.leafs }........); )(Node)</span></span></code> </pre><br>  And that's all - put RestatedNode into each other - reactReduxFocus will sort out everything neatly at the beginning, and then collect all the bread crumbs back into the command line. <br><br>  The question remains how to return to normal, when the "synthetic", "in which there is nothing" is no longer needed.  Well, you need reactReduxRestate, which takes more than one entry per input. <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {createProvider} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-redux'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> reactReduxFocus <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-redux-focus'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> reactReduxRestate <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-redux-restate'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Provider = createProvider(<span class="hljs-string"><span class="hljs-string">'realStore'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// restate    'realStore',   -  'store',    connect const FocusedComponent = reactReduxFocus(..., ..., { storageKey: 'realStore' })(SomeComponent); const RestatedComponent = reactReduxRestate({ //     default  ('store')  'realStore' //          ,   .   -  ? realStore: 'realStore' },..., ...)(AnotherComponent) &lt;Provider store={realStore}&gt; &lt;FocusedComponent &gt; &lt;RestatedComponent /&gt; -     "" &lt;FocusedComponent /&gt; -    ,   ,     &lt;/FocusedComponent &lt;/Provider&gt;</span></span></code> </pre><br>  In general, the source code of all three components actually takes a couple of dozen lines, but opens up so many options for ... composites. <br><br>  In principle, this is exactly what was required. <br><br><h2>  And what, so it was possible? </h2><br>  Restate is far from being a pioneer in this matter.  For example, <a href="https://github.com/hardchor/electron-redux">electron-redux</a> is engaged in ‚Äúalmost‚Äù which is the same - it connects two lines (main and render), one of which is not real, and even dispatch routing from one to another. <br><br>  Technically, the same effect can be achieved with the use of the restate, and with fewer crutches, but the restate has absolutely no IPC. <br><br>  Or take the "system of options" Yandex. Map.  It is generally not very well known (publicly and documented), but anyone who has ever used the Yandex Maps API can notice how beautifully the options ‚Äúcascade‚Äù there - there is a polyline color specified at the map level, the option is called geoObjectStrokeColor, and if at the geoobject level - strokeColor. <br><br>  In general, ‚Äúprefixing‚Äù works, and it can be found everywhere ‚Äî the best example of work ‚Äî in <a href="https://tech.yandex.com/maps/jsbox/2.1/behaviors">the map setup example,</a> ‚ÄúscrollZoomSpeed‚Äù is set, the control component itself will read from the store simply ‚Äúspeed‚Äù. <br><br>  Only in Yandex.Maps this prefixing works from bottom to top - the prefixes are added from the child to the parent until a match is found, which almost excludes the possibility of stopping updates, changing what value means you cannot find out which component will read this value in a cunning way. <br><br>  Restate is an attempt to cross exactly Yandex.Maps and redux.  Fix both.  Come on and take long vacation nights. <br><br>  -&gt; <a href="https://github.com/thekashey/restate">github.com/thekashey/restate</a> </div><p>Source: <a href="https://habr.com/ru/post/346116/">https://habr.com/ru/post/346116/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../346106/index.html">Release Rust 1.23</a></li>
<li><a href="../346108/index.html">Weapon system through components in Unreal Engine 4</a></li>
<li><a href="../346110/index.html">How to build a geographic dashboard with real-time data</a></li>
<li><a href="../346112/index.html">Telegram-bot as a gift</a></li>
<li><a href="../346114/index.html">Meltdown: not only affects performance</a></li>
<li><a href="../346118/index.html">MPS 2017.3 released</a></li>
<li><a href="../346120/index.html">Ok google get me a car</a></li>
<li><a href="../346126/index.html">Tachometer or speedometer: The flow of thoughts about measuring the frequency in the Arduino</a></li>
<li><a href="../346128/index.html">February 31</a></li>
<li><a href="../346130/index.html">So why aren't you participating in the development of open source software?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>