<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Zone.js or how Dart saved Angular</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I am a front-end developer at Wrike, writing in JavaScript and Dart, which is compiled into JavaScript. Today I want to talk about the Zone.js library...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Zone.js or how Dart saved Angular</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/96f/27d/381/96f27d3813bd4e2a98f3c1a14a6e4fde.png"><br><br>  I am a front-end developer at Wrike, writing in JavaScript and Dart, which is compiled into JavaScript.  Today I want to talk about the Zone.js library, the underlying Angular 2. <br><br>  Initially, Zone.js was invented by Google developers for the Dart programming language and the Dart2JS utility.  With the help of this library, ‚ÄúGoogle users‚Äù solved the problem with the digest cycle, which was characteristic of the first Angular. <br>  To understand where this library is used and what is needed, I ask for cat. <br><a name="habracut"></a><br><h2>  Problem </h2><br>  If you write in JavaScript or in languages ‚Äã‚Äãthat are compiled into JavaScript, you probably have encountered the following situation: <br>  <a href="https://jsfiddle.net/zolotyh/1cmpf0ov/">working example</a> : 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> feedback = { <span class="hljs-attr"><span class="hljs-attr">message</span></span>: <span class="hljs-string"><span class="hljs-string">'!'</span></span>, <span class="hljs-attr"><span class="hljs-attr">send</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ alert(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.message) } } setTimeout(feedback.send)</code> </pre> <br>  The problem is known for a long time - the context was lost.  Therefore, in the pop-up message we will see "undefined".  I know 4 ways to get out of the situation: <br><br><ul><li>  Transfer the ‚Äúmessage‚Äù variable using <a href="https://jsfiddle.net/zolotyh/jwjuLk4u/">closures</a> </li><li>  Bind the context to the function we pass to setTimeout with <a href="https://jsfiddle.net/zolotyh/ypegy5v6/">bind</a> </li><li>  Use <a href="https://jsfiddle.net/zolotyh/u4v3ja8f/">ES6 classes and switch functions</a> </li><li>  Use <a href="https://jsfiddle.net/zolotyh/wpath6dz/">double colons</a> operator </li></ul><br>  On this one could have finished, if not ... <br><br><h2>  Root of evil </h2><br>  The example we have considered is the tip of the iceberg, in fact the problem of loss of context is more global.  The fact is that the context in JavaScript is lost in the place where the asynchronous functions are called, and in order to save it, you need to constantly <b>keep the</b> entire chain of calls <b>in your head</b> and control it.  This is especially difficult in large projects. <br><br>  There is an opposite effect: due to the loss of context, the <b>connection</b> with the place where the asynchronous function is called from is <b>lost</b> .  For example, it is not clear where we hung the click handler that caused the error.  In the console, only the link to the click handler itself is visible, but <b>not shown</b> where it is signed. <br><br><h2>  Decision </h2><br>  How many ways to call functions asynchronously do you know?  SetTimeout, addEventListener, asynchronous requests to the server, etc. come to my mind.  and so on. Not so much - the number of these places of course.  What does it mean?  If you prevent the loss of context for each asynchronous call, the problem will be solved.  First, let's try to prevent the loss of context in setTimeout: <br><br>  We write a class with a constructor and three methods. <br><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(parentContext) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> context; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parentContext) { <span class="hljs-comment"><span class="hljs-comment">//   context = Object.create(parentContext) context.parent = parentContext; } else { //    context = this; } return context; } fork() { //   return new Context(this); } bind(fn) { //    const context = this.fork(); //        return () =&gt; { return context.run(() =&gt; fn.apply(this, arguments), this, arguments); } } run(fn) { //      let oldContext = context; context = this; const result = fn.call() //     context = oldContext; //    return result; //   } }</span></span></code> </pre> <a name="setTimeout"></a><br>  After that, substitute the original setTimeout: <br><br><pre> <code class="javascript hljs">context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Context(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nativeSetTimeout = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.setTimeout; <span class="hljs-comment"><span class="hljs-comment">//  setTimeout context.setTimeout = (callback, time) =&gt; { callback = context.bind(callback); return nativeSetTimeout.call(window, callback.bind(context), time); }; window.setTimeout = function (){ return context.setTimeout.apply(this, arguments); };</span></span></code> </pre><br>  Now client code: <br><br><pre> <code class="javascript hljs">context.fork({} <span class="hljs-comment"><span class="hljs-comment">/*  ,  */</span></span>).run(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { context.message = <span class="hljs-string"><span class="hljs-string">'!'</span></span>; setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`%c  : ¬´</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${context.message}</span></span></span><span class="hljs-string">¬ª`</span></span>, <span class="hljs-string"><span class="hljs-string">'font-size: x-large'</span></span>); }, <span class="hljs-number"><span class="hljs-number">0</span></span>); }); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`%c  : ¬´</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${context.message}</span></span></span><span class="hljs-string">¬ª`</span></span>,<span class="hljs-string"><span class="hljs-string">'font-size: x-large'</span></span>);</code> </pre><br>  Now the link is saved.  Here is an example of <a href="https://jsfiddle.net/zolotyh/mm0tsh1n/">working code</a> .  Using the same technique, you can replace asynchronous calls for most cases and manually manage the context in a predictable manner. <br><br>  But below is a graphic illustration of the work.  Each zone is painted in its own color: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/12e/29a/9c7/12e29a9c7a6941b4b9cd84afc39693de.png" alt="illustration of Zone.js work"></div><br>  In fact, we implemented part of the Zone.js library.  I think that this can stop and do not write your bike, and continue to explore the zones, using the original library. <br><br><h2>  Library Description </h2><br>  After the library is connected, the Zone object appears in the global scope.  Zone.current contains a link to the current zone.  The Zone object's fork method returns a new zone based on the parent.  It is better to look at what parameters are possible here in the <a href="">documentation on github</a> .  The run method accepts a function whose body will execute within this zone.  Here is <a href="https://jsfiddle.net/zolotyh/4st0wtv7/">an example</a> . <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> childZone = Zone.current.fork({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">' '</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> handler = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { alert(<span class="hljs-string"><span class="hljs-string">`      ¬´</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${Zone.current.name}</span></span></span><span class="hljs-string">¬ª`</span></span>); } childZone.run(handler); handler();</code> </pre><br>  Library developers distinguish three types of asynchronous tasks: <br><br><ul><li>  Microtasks (MicroTasks) - tasks that are performed immediately after the iteration of a JavaScript machine loop is completed.  These tasks cannot be undone. </li><li>  Macrotasks (MacroTasks) - tasks that are performed on before a certain time comes (setTimeout).  These tasks are canceled. </li><li>  Events (EventTasks) - tasks that are performed many times after the occurrence of the event, the delay time is unknown. </li></ul><br>  Zone.js intercepts an attempt to schedule asynchronous tasks, perform callbacks, errors, and so on.  Tasks are planned both explicitly, by calling special methods on the Zone.current object, and implicitly, by calling an asynchronous function (setTimeout), as we did in the first part of the article. <br><br>  Zones are easy to combine: for example, one zone catches errors within its borders and sends notifications to the server, and a child zone (descendant) acts as a tracker and sends statistics on the user‚Äôs work in the graphical interface to the server.  In this case, if an error occurs within the child zone, the parent zone will intercept and send information to the server.  Here is <a href="https://jsfiddle.net/zolotyh/w7trLaL3/">an example of combining zones</a> . <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> errorHandlerZone = Zone.current.fork({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'ErrorZone'</span></span>, <span class="hljs-attr"><span class="hljs-attr">onHandleError</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">parentZoneDelegate, currentZone, targetZone, error</span></span></span><span class="hljs-function">) =&gt;</span></span> { sendError(error); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> trackingZone = errorHandlerZone.fork({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'TrackingZone'</span></span> }); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Widget</span></span></span><span class="hljs-class"> </span></span>{ render = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">'render error'</span></span>; } } trackingZone.runGuarded(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">'click'</span></span>, (event) =&gt; { trackEvent(event); }, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> widget = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Widget(); widget.render(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; }); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendError</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">)</span></span>{ alert(<span class="hljs-string"><span class="hljs-string">`: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${error}</span></span></span><span class="hljs-string">  : </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${Zone.current.name}</span></span></span><span class="hljs-string">`</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event</span></span></span><span class="hljs-function">)</span></span>{ alert(<span class="hljs-string"><span class="hljs-string">`: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${event}</span></span></span><span class="hljs-string">  : </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${Zone.current.name}</span></span></span><span class="hljs-string">`</span></span>); }</code> </pre><br><h2>  Other helpful examples </h2><br><br><h3>  Long treysy </h3><br>  The first and rather typical example about which I wrote above is an error in the console.  The click handler on the button fell and everything would be fine, that's just not clear where it was hung.  With Zone.js, we can determine this.  For this we use a special zone from the repository Zone.js.  Here is <a href="https://jsfiddle.net/zolotyh/zkdzky2r/">an example</a> . <br><br><h3>  Profiling </h3><br>  Using zones, we measure the running time of the code, which contains asynchronous calls, excluding non-code-related delays: timeouts, server response waiting, and pauses between events.  <a href="https://jsfiddle.net/zolotyh/7f404twp/">An example</a> . <br><br><h2>  And here Angular 2? </h2><br>  Zones are used in the second Angular.  The framework understands that it is necessary to start the search engine for changes when an asynchronous event occurs.  About the occurrence of this asynchronous event, he learns just from Zone.js. <br><br>  If you present all of the above as a code, you get something like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   addEventListener function addEventListener(eventName, callback) { //   addEventListener callRealAddEventListener(eventName, function () { //    callback(...); //    var changed = angular2.runChangeDetection(); if (changed) { angular2.reRenderUIPart(); //   } }); }</span></span></code> </pre><br>  Thanks to zones, we know in which element an asynchronous event occurred.  It remains to be seen whether the changes need to be rendered for children, and there is a distinctive feature of Angular 2. In the first Angular, we had to run a digest loop that went around the children and parents many times to check if the model had changed or not.  The second Angular checks for changes unidirectionally. <br><br><h2>  disadvantages </h2><br>  Zone.js changes the standard behavior of the browser API ( <a href="https://habr.com/ru/company/wrike/blog/310422/">overriding setTimeout is</a> not good).  This is a minus.  Given that the <a href="https://ru.wikipedia.org/wiki/Monkey_patch">monkey patching was</a> done carefully, we used an <a href="https://ru.wikipedia.org/wiki/Monkey_patch">anti-pattern</a> .  There are additional costs when calling the basic functions.  These costs are small, but they are. <br><br>  Mankipatching can lead to additional bugs in standard situations.  Although I myself have never stumbled upon these bugs, they are potentially possible. <br><br>  I also failed to make the zones work in the application on React and Angular of the first version as I wanted. <br><br>  In fact, nothing prevents you from using Zone.js as such, but to make every component called in a separate zone is problematic.  For full operation of zones, it is necessary that each piece of asynchronous code (event binding, asynchronous requests to the server) be called within the zone.  I did not manage to manage these processes.  The reaction uses virtual home and smart rendering with caching, and the basic events in Angular are hung in basic ngClick directives, which are tedious to rewrite.  There is a chance that you will succeed.  Share your successes in the comments. <br><br><h2>  Conclusion: Never Say Never </h2><br>  Zone.js is the case when skipping is appropriate.  The advantages that the library provides override the shortcomings of the approach, and violation of the unwritten rules sometimes leads to victory. </div><p>Source: <a href="https://habr.com/ru/post/310422/">https://habr.com/ru/post/310422/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../310404/index.html">How I Made a Game of Indians of Central America</a></li>
<li><a href="../310406/index.html">Many-to-many attitudes without a third table in PostgreSQL using Elixir Ecto</a></li>
<li><a href="../310414/index.html">A person. Michael Dell's dream come true</a></li>
<li><a href="../310418/index.html">101 ways of making RabbitMQ and a bit about pipeline architecture</a></li>
<li><a href="../310420/index.html">WD My Cloud Mirror - inaccessibility from under networks of the range 172.16.0.0/12</a></li>
<li><a href="../310428/index.html">Taming Yota with Zyxel</a></li>
<li><a href="../310432/index.html">Application on Elm in seconds</a></li>
<li><a href="../310434/index.html">As we wrote freelance exchange for Telegram</a></li>
<li><a href="../310436/index.html">Your blog on vibe-d, part 1: a simple web application using encryption</a></li>
<li><a href="../310438/index.html">First steps in Java: how to start developing without installing anything</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>