<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>WebSocket chat on symfony2 in 100 lines</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Habr! 
 Recently, I developed a chat on the web socket for my service http://internetsms.org/chat . 
 When implemented, I was faced with the fact t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>WebSocket chat on symfony2 in 100 lines</h1><div class="post__text post__text-html js-mediator-article">  Hi Habr! <br>  Recently, I developed a chat on the web socket for my service <a href="http://internetsms.org/chat">http://internetsms.org/chat</a> . <br>  When implemented, I was faced with the fact that on the Internet most of the chats are made using repeated ajax requests that check for new messages over a specified period of time.  This approach was unacceptable for me, because with the influx of users, the load on the server will increase exponentially.  In fact, there are more interesting implementation options: <br>  <b>Long polling</b> <br>  The client sends a ‚Äúlong‚Äù request to the server, and if there are changes, the server sends a response.  Thus, the number of requests is reduced.  By the way, this technology is used in Gmail. <br>  <b>Web sockets</b> <br>  Html5 has a built-in ability to use WebSocket connections.  The request-response paradigm is not used here at all.  A communication channel is established once between the client and the server.  There is one daemon on the server that handles incoming connections.  Thus, there is practically no load on the server even with a large number of users online. <br><a name="habracut"></a><br><h4>  Server part </h4><br>  Now I will explain in detail how this chat works.  I used <a href="https://github.com/cboden/Ratchet">Ratchet</a> , a library that allows you to work with sockets on the server.  The database stores the entities current chat (Chat) and users (ChatUser). <br><div class="spoiler">  <b class="spoiler_title">Chat entity</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ISMS</span></span>\<span class="hljs-title"><span class="hljs-title">ChatBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">Common</span></span>\<span class="hljs-title"><span class="hljs-title">Collections</span></span>\<span class="hljs-title"><span class="hljs-title">ArrayCollection</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">ORM</span></span>\<span class="hljs-title"><span class="hljs-title">Mapping</span></span> <span class="hljs-title"><span class="hljs-title">as</span></span> <span class="hljs-title"><span class="hljs-title">ORM</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Entity * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Table */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Chat</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Id * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(type="bigint") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\GeneratedValue(strategy="AUTO") * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> int */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $id; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> bool * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(type="boolean") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $isCompleted = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\OneToMany(targetEntity="ChatUser", mappedBy="Chat") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> ArrayCollection */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $users; <span class="hljs-comment"><span class="hljs-comment">/** * Constructor */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;users = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayCollection(); } <span class="hljs-comment"><span class="hljs-comment">/** * Get id * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> integer */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;id; } <span class="hljs-comment"><span class="hljs-comment">/** * Add users * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> ChatUser $user * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Chat */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChatUser $user)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;users[] = $user; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * Remove users * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> ChatUser $user */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removeUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChatUser $user)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;users-&gt;removeElement($user); } <span class="hljs-comment"><span class="hljs-comment">/** * Get users * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> ArrayCollection|ChatUser[] */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUsers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;users; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> boolean $isCompleted */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setIsCompleted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($isCompleted)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isCompleted = $isCompleted; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> boolean */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getIsCompleted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isCompleted; } }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">ChatUser Entity</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ISMS</span></span>\<span class="hljs-title"><span class="hljs-title">ChatBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">ORM</span></span>\<span class="hljs-title"><span class="hljs-title">Mapping</span></span> <span class="hljs-title"><span class="hljs-title">as</span></span> <span class="hljs-title"><span class="hljs-title">ORM</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Entity * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Table */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChatUser</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Id * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(type="bigint") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\GeneratedValue(strategy="AUTO") * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> int */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $id; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\Column(type="integer", unique=true) * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> int */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $rid; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\ManyToOne(targetEntity="Chat", inversedBy="users") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\JoinColumn(name="chat_id", referencedColumnName="id") * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> Chat */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $Chat; <span class="hljs-comment"><span class="hljs-comment">/** * Get id * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> integer */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;id; } <span class="hljs-comment"><span class="hljs-comment">/** * Set rid * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> integer $rid * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> ChatUser */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setRid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($rid)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rid = $rid; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * Get rid * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rid; } <span class="hljs-comment"><span class="hljs-comment">/** * Set Chat * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> Chat $chat * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> ChatUser */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setChat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Chat $chat = null)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;Chat = $chat; $chat-&gt;addUser(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * Get Chat * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Chat */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getChat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;Chat; } }</code> </pre><br></div></div><br><br>  Trivial operations with entities made in a separate manager <br><pre> <code class="bash hljs">parameters: isms_chat.manager.class: ISMS\ChatBundle\Manager\ChatManager services: isms_chat.manager: class: %isms_chat.manager.class% arguments: [ @doctrine.orm.entity_manager ]</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Chatmanager</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ISMS</span></span>\<span class="hljs-title"><span class="hljs-title">ChatBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Manager</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">Common</span></span>\<span class="hljs-title"><span class="hljs-title">Persistence</span></span>\<span class="hljs-title"><span class="hljs-title">ObjectManager</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">ISMS</span></span>\<span class="hljs-title"><span class="hljs-title">ChatBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>\<span class="hljs-title"><span class="hljs-title">Chat</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">ISMS</span></span>\<span class="hljs-title"><span class="hljs-title">ChatBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>\<span class="hljs-title"><span class="hljs-title">ChatUser</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChatManager</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> ObjectManager */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $em; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ObjectManager $em)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;em = $em; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removeUserFromChat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChatUser $user, Chat $chat)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($chat-&gt;getIsCompleted()) { $chat-&gt;removeUser($user); $chat-&gt;setIsCompleted(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;em-&gt;remove($chat); } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;em-&gt;remove($user); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;em-&gt;flush(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findOrCreateChatForUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($rid)</span></span></span><span class="hljs-function"> </span></span>{ $chat_user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ChatUser(); $chat_user-&gt;setRid($rid); $chat = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getUncompletedChat(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($chat) { $chat-&gt;setIsCompleted(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $chat = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Chat(); } $chat_user-&gt;setChat($chat); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;em-&gt;persist($chat); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;em-&gt;persist($chat_user); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;em-&gt;flush(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $chat; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getChatByUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($rid)</span></span></span><span class="hljs-function"> </span></span>{ $chat_user = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getUserByRid($rid); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $chat_user ? $chat_user-&gt;getChat() : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserByRid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($rid)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;em-&gt;getRepository(<span class="hljs-string"><span class="hljs-string">'ISMSChatBundle:ChatUser'</span></span>)-&gt;findOneBy([<span class="hljs-string"><span class="hljs-string">'rid'</span></span> =&gt; $rid]); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUncompletedChat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;em-&gt;getRepository(<span class="hljs-string"><span class="hljs-string">'ISMSChatBundle:Chat'</span></span>)-&gt;findOneBy([<span class="hljs-string"><span class="hljs-string">'isCompleted'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>]); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">truncateChats</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> \Doctrine\DBAL\Connection $conn */</span></span> $conn = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;em-&gt;getConnection(); $platform = $conn-&gt;getDatabasePlatform(); $conn-&gt;query(<span class="hljs-string"><span class="hljs-string">'SET FOREIGN_KEY_CHECKS=0'</span></span>); $conn-&gt;executeUpdate($platform-&gt;getTruncateTableSQL(<span class="hljs-string"><span class="hljs-string">'chat_user'</span></span>)); $conn-&gt;executeUpdate($platform-&gt;getTruncateTableSQL(<span class="hljs-string"><span class="hljs-string">'chat'</span></span>)); $conn-&gt;query(<span class="hljs-string"><span class="hljs-string">'SET FOREIGN_KEY_CHECKS=1'</span></span>); } }</code> </pre><br></div></div><br>  All processing of incoming connections and redirection of messages between users occurs in the class Chat. <br><div class="spoiler">  <b class="spoiler_title">Chat</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ISMS</span></span>\<span class="hljs-title"><span class="hljs-title">ChatBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Chat</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">ISMS</span></span>\<span class="hljs-title"><span class="hljs-title">ChatBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Manager</span></span>\<span class="hljs-title"><span class="hljs-title">ChatManager</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Ratchet</span></span>\<span class="hljs-title"><span class="hljs-title">ConnectionInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Ratchet</span></span>\<span class="hljs-title"><span class="hljs-title">MessageComponentInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Ratchet</span></span>\<span class="hljs-title"><span class="hljs-title">WebSocket</span></span>\<span class="hljs-title"><span class="hljs-title">Version</span></span>\<span class="hljs-title"><span class="hljs-title">RFC6455</span></span>\<span class="hljs-title"><span class="hljs-title">Connection</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Chat</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MessageComponentInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> ConnectionInterface[] */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $clients = []; <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> ChatManager */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $chm; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChatManager $chm)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;chm = $chm; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;chm-&gt;truncateChats(); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> ConnectionInterface|Connection $conn * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConnectionInterface $conn)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $conn-&gt;resourceId; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> ConnectionInterface|Connection $conn */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onOpen</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConnectionInterface $conn)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;clients[<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getRid($conn)] = $conn; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onClose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConnectionInterface $conn)</span></span></span><span class="hljs-function"> </span></span>{ $rid = array_search($conn, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;clients); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($user = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;chm-&gt;getUserByRid($rid)) { $chat = $user-&gt;getChat(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;chm-&gt;removeUserFromChat($user, $chat); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($chat-&gt;getUsers() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $user) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;clients[$user-&gt;getRid()]-&gt;close(); } } <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;clients[$rid]); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConnectionInterface $conn, \Exception $e)</span></span></span><span class="hljs-function"> </span></span>{ $conn-&gt;close(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConnectionInterface $from, $msg)</span></span></span><span class="hljs-function"> </span></span>{ $msg = json_decode($msg, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $rid = array_search($from, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;clients); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> ($msg[<span class="hljs-string"><span class="hljs-string">'type'</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'request'</span></span>: $chat = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;chm-&gt;findOrCreateChatForUser($rid); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($chat-&gt;getIsCompleted()) { $msg = json_encode([<span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'response'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($chat-&gt;getUsers() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $user) { $conn = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;clients[$user-&gt;getRid()]; $conn-&gt;send($msg); } } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'message'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($chat = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;chm-&gt;getChatByUser($rid)) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($chat-&gt;getUsers() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $user) { $conn = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;clients[$user-&gt;getRid()]; $msg[<span class="hljs-string"><span class="hljs-string">'from'</span></span>] = $conn === $from ? <span class="hljs-string"><span class="hljs-string">'me'</span></span> : <span class="hljs-string"><span class="hljs-string">'guest'</span></span>; $conn-&gt;send(json_encode($msg)); } } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } }</code> </pre><br></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To start the server, a <a href="https://github.com/mac-cain13/daemonizable-command">library</a> was used to create daemon commands.  By the way, it describes how <a href="https://github.com/mac-cain13/daemonizable-command">to start the</a> daemon using the standard Upstart.  This allows you to start the chat process and make sure that it does not fall. <br><br><div class="spoiler">  <b class="spoiler_title">DaemonCommand</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ISMS</span></span>\<span class="hljs-title"><span class="hljs-title">ChatBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Command</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">ISMS</span></span>\<span class="hljs-title"><span class="hljs-title">ChatBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Chat</span></span>\<span class="hljs-title"><span class="hljs-title">Chat</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Ratchet</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">HttpServer</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Ratchet</span></span>\<span class="hljs-title"><span class="hljs-title">Server</span></span>\<span class="hljs-title"><span class="hljs-title">IoServer</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Ratchet</span></span>\<span class="hljs-title"><span class="hljs-title">WebSocket</span></span>\<span class="hljs-title"><span class="hljs-title">WsServer</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Console</span></span>\<span class="hljs-title"><span class="hljs-title">Input</span></span>\<span class="hljs-title"><span class="hljs-title">InputInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Console</span></span>\<span class="hljs-title"><span class="hljs-title">Output</span></span>\<span class="hljs-title"><span class="hljs-title">OutputInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">DependencyInjection</span></span>\<span class="hljs-title"><span class="hljs-title">ContainerAwareInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">DependencyInjection</span></span>\<span class="hljs-title"><span class="hljs-title">ContainerInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Wrep</span></span>\<span class="hljs-title"><span class="hljs-title">Daemonizable</span></span>\<span class="hljs-title"><span class="hljs-title">Command</span></span>\<span class="hljs-title"><span class="hljs-title">EndlessCommand</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DaemonCommand</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EndlessCommand</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContainerAwareInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> ContainerInterface */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $container; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setContainer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContainerInterface $container = null)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;container = $container; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;setName(<span class="hljs-string"><span class="hljs-string">'isms:chat:daemon'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputInterface $input, OutputInterface $output)</span></span></span><span class="hljs-function"> </span></span>{ $chm = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;container-&gt;get(<span class="hljs-string"><span class="hljs-string">'isms_chat.manager'</span></span>); $server = IoServer::factory( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpServer( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WsServer( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Chat($chm) ) ), <span class="hljs-number"><span class="hljs-number">8080</span></span> ); $server-&gt;run(); } }</code> </pre><br></div></div><br><br><h4>  Client part </h4><br>  The chat engine is designed as a finite state machine, represented by a set of states and transitions.  The <a href="https://github.com/jakesgordon/javascript-state-machine">Javascript Finite State Machine</a> library was used for this.  You can set a handler function for an event of any transition.  You can hang business logic on the handler. <br><br>  States and state transitions <br><img src="https://habrastorage.org/getpro/habr/post_images/db5/8c4/e85/db58c4e853060a318d8ef14012b8802d.png"><br><br><div class="spoiler">  <b class="spoiler_title">HTML</b> <div class="spoiler_text"><pre> <code class="html hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"chat_wrapper"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"template_idle"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"template"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"row text-center"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span>    !<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>  ,   " "  ,     <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>   ,   " "    " ".<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>   . !<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-large btn-primary begin-chat"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"template_wait"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"template"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"row text-center"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">i</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fa fa-spin fa-refresh"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">i</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"state"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"template_chat"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"template"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"row"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"message_box"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"message_box"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"row well"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"send-msg-form"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"input-append"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">textarea</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"message"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rows</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">placeholder</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"  (  Ctrl + Enter)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">required</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"required"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"span6"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">textarea</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"send-btn"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-primary btn-large has-spinner"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"spinner"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">i</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fa fa-spin fa-refresh"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">i</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text-center"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"show-chat"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-danger close-chat"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"show-closed"</span></span></span><span class="hljs-tag">&gt;</span></span> . <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-primary begin-chat"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ asset('bundles/ismschat/js/chat-widget.js') }}"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> $(</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">).ready(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>)</span></span></span><span class="javascript">{ $(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'#chat_wrapper'</span></span></span><span class="javascript">).chatWidget(); }); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">chat-widget.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs">(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">) </span></span>{ $.fn.extend({<span class="hljs-attr"><span class="hljs-attr">chatWidget</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> o = jQuery.extend({ <span class="hljs-attr"><span class="hljs-attr">wsUri</span></span>: <span class="hljs-string"><span class="hljs-string">'ws://'</span></span>+location.host+<span class="hljs-string"><span class="hljs-string">':8080'</span></span>, <span class="hljs-attr"><span class="hljs-attr">tmplClass</span></span>: <span class="hljs-string"><span class="hljs-string">'.template'</span></span>, <span class="hljs-attr"><span class="hljs-attr">tmplIdle</span></span>: <span class="hljs-string"><span class="hljs-string">'#template_idle'</span></span>, <span class="hljs-attr"><span class="hljs-attr">tmplWait</span></span>: <span class="hljs-string"><span class="hljs-string">'#template_wait'</span></span>, <span class="hljs-attr"><span class="hljs-attr">tmplChat</span></span>: <span class="hljs-string"><span class="hljs-string">'#template_chat'</span></span>, <span class="hljs-attr"><span class="hljs-attr">btnBeginChat</span></span>: <span class="hljs-string"><span class="hljs-string">'.begin-chat'</span></span>, <span class="hljs-attr"><span class="hljs-attr">labelWaitState</span></span>: <span class="hljs-string"><span class="hljs-string">'.state'</span></span>, <span class="hljs-attr"><span class="hljs-attr">messageBox</span></span>: <span class="hljs-string"><span class="hljs-string">'#message_box'</span></span>, <span class="hljs-attr"><span class="hljs-attr">formSend</span></span>: <span class="hljs-string"><span class="hljs-string">'#send-msg-form'</span></span>, <span class="hljs-attr"><span class="hljs-attr">textMessage</span></span>: <span class="hljs-string"><span class="hljs-string">'#message'</span></span>, <span class="hljs-attr"><span class="hljs-attr">btnCloseChat</span></span>: <span class="hljs-string"><span class="hljs-string">'.close-chat'</span></span> },options); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> websocket, fsm; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> windowNotifier = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> window_active = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, new_message = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; $(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>).blur(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ window_active = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }); $(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>).focus(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ window_active = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; new_message = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> original = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.title; <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.setInterval(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (new_message &amp;&amp; window_active == <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.title = <span class="hljs-string"><span class="hljs-string">'******'</span></span>; setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.title = original; }, <span class="hljs-number"><span class="hljs-number">750</span></span>); } }, <span class="hljs-number"><span class="hljs-number">1500</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">setNewMessage</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ new_message = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }; } (); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> initSocket = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ websocket = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebSocket(o.wsUri); websocket.onopen = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ fsm.request(); }; websocket.onclose = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">)</span></span>{ fsm.close(); }; websocket.onerror = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(e); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (websocket.readyState == <span class="hljs-number"><span class="hljs-number">1</span></span>) { websocket.close(); } }; websocket.onmessage = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> msg = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(e.data); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (msg.type) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'response'</span></span>: fsm.response(); windowNotifier.setNewMessage(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'message'</span></span>: chatController.addMessage(msg); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (msg.from == <span class="hljs-string"><span class="hljs-string">'me'</span></span>) { chatController.unspinChat(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { windowNotifier.setNewMessage(); } $(o.textMessage).focus(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> setView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tmpl</span></span></span><span class="hljs-function">) </span></span>{ $(o.tmplClass).removeClass(<span class="hljs-string"><span class="hljs-string">'active'</span></span>); $(tmpl).addClass(<span class="hljs-string"><span class="hljs-string">'active'</span></span>); }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> idleController = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ $(o.btnBeginChat).click(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ fsm.open(); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">show</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ setView(o.tmplIdle); } }; } (); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> waitController = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">show</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">label</span></span></span><span class="hljs-function">) </span></span>{ $(o.labelWaitState).text(label); setView(o.tmplWait); } }; } (); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> chatController = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ $(o.textMessage).keydown(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.ctrlKey &amp;&amp; e.keyCode == <span class="hljs-number"><span class="hljs-number">13</span></span>) { $(o.formSend).trigger(<span class="hljs-string"><span class="hljs-string">'submit'</span></span>); } }); $(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>).on(<span class="hljs-string"><span class="hljs-string">'submit'</span></span>, o.formSend, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ e.preventDefault(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> text = $(o.textMessage).val(); text = $.trim(text); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!text) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> msg = { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: text }; websocket.send(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(msg)); $(o.textMessage).val(<span class="hljs-string"><span class="hljs-string">''</span></span>); chatController.spinChat(); }); $(o.btnCloseChat).click(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ websocket.close(); }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> htmlForTextWithEmbeddedNewlines = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">text</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> htmls = []; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lines = text.split(<span class="hljs-regexp"><span class="hljs-regexp">/\n/</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tmpDiv = jQuery(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">'div'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span> ; i &lt; lines.length ; i++) { htmls.push(tmpDiv.text(lines[i]).html()); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> htmls.join(<span class="hljs-string"><span class="hljs-string">"&lt;br&gt;"</span></span>); }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">clear</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ $(o.messageBox).empty(); }, <span class="hljs-attr"><span class="hljs-attr">lockChat</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ $(o.formSend).find(<span class="hljs-string"><span class="hljs-string">':input'</span></span>).attr(<span class="hljs-string"><span class="hljs-string">'disabled'</span></span>, <span class="hljs-string"><span class="hljs-string">'disabled'</span></span>); }, <span class="hljs-attr"><span class="hljs-attr">unlockChat</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ $(o.formSend).find(<span class="hljs-string"><span class="hljs-string">':input'</span></span>).removeAttr(<span class="hljs-string"><span class="hljs-string">'disabled'</span></span>); }, <span class="hljs-attr"><span class="hljs-attr">spinChat</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ chatController.lockChat(); $(o.formSend).find(<span class="hljs-string"><span class="hljs-string">'.btn'</span></span>).addClass(<span class="hljs-string"><span class="hljs-string">'active'</span></span>); }, <span class="hljs-attr"><span class="hljs-attr">unspinChat</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ $(o.formSend).find(<span class="hljs-string"><span class="hljs-string">'.btn'</span></span>).removeClass(<span class="hljs-string"><span class="hljs-string">'active'</span></span>); chatController.unlockChat(); }, <span class="hljs-attr"><span class="hljs-attr">showChat</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ chatController.unlockChat(); $(<span class="hljs-string"><span class="hljs-string">'.show-closed'</span></span>).hide(); $(<span class="hljs-string"><span class="hljs-string">'.show-chat'</span></span>).show(); setView(o.tmplChat); }, <span class="hljs-attr"><span class="hljs-attr">showClosed</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ chatController.lockChat(); $(<span class="hljs-string"><span class="hljs-string">'.show-chat'</span></span>).hide(); $(<span class="hljs-string"><span class="hljs-string">'.show-closed'</span></span>).show(); setView(o.tmplChat); }, <span class="hljs-attr"><span class="hljs-attr">addMessage</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">msg</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> d = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> text = htmlForTextWithEmbeddedNewlines(msg.message); $(o.messageBox).append( <span class="hljs-string"><span class="hljs-string">'&lt;div&gt;'</span></span> + <span class="hljs-string"><span class="hljs-string">'&lt;span class="user_name"&gt;'</span></span>+msg.from+<span class="hljs-string"><span class="hljs-string">'&lt;/span&gt; : &lt;span class="user_message"&gt;'</span></span>+text + <span class="hljs-string"><span class="hljs-string">'&lt;/span&gt;'</span></span> + <span class="hljs-string"><span class="hljs-string">'&lt;span class="pull-right"&gt;'</span></span>+d.toLocaleTimeString()+<span class="hljs-string"><span class="hljs-string">'&lt;/span&gt;'</span></span> + <span class="hljs-string"><span class="hljs-string">'&lt;/div&gt;'</span></span> ); $(o.messageBox).scrollTop($(o.messageBox)[<span class="hljs-number"><span class="hljs-number">0</span></span>].scrollHeight); }, <span class="hljs-attr"><span class="hljs-attr">addSystemMessage</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">msg</span></span></span><span class="hljs-function">) </span></span>{ $(o.messageBox).append(<span class="hljs-string"><span class="hljs-string">'&lt;div class="system_msg"&gt;'</span></span>+msg+<span class="hljs-string"><span class="hljs-string">'&lt;/div&gt;'</span></span>); } }; } (); fsm = StateMachine.create({ <span class="hljs-attr"><span class="hljs-attr">initial</span></span>: <span class="hljs-string"><span class="hljs-string">'idle'</span></span>, <span class="hljs-attr"><span class="hljs-attr">events</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'open'</span></span>, <span class="hljs-attr"><span class="hljs-attr">from</span></span>: [<span class="hljs-string"><span class="hljs-string">'idle'</span></span>, <span class="hljs-string"><span class="hljs-string">'closed'</span></span>], <span class="hljs-attr"><span class="hljs-attr">to</span></span>: <span class="hljs-string"><span class="hljs-string">'connecting'</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'request'</span></span>, <span class="hljs-attr"><span class="hljs-attr">from</span></span>: <span class="hljs-string"><span class="hljs-string">'connecting'</span></span>, <span class="hljs-attr"><span class="hljs-attr">to</span></span>: <span class="hljs-string"><span class="hljs-string">'waiting'</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'response'</span></span>, <span class="hljs-attr"><span class="hljs-attr">from</span></span>: <span class="hljs-string"><span class="hljs-string">'waiting'</span></span>, <span class="hljs-attr"><span class="hljs-attr">to</span></span>: <span class="hljs-string"><span class="hljs-string">'chat'</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'close'</span></span>, <span class="hljs-attr"><span class="hljs-attr">from</span></span>: [<span class="hljs-string"><span class="hljs-string">'connecting'</span></span>, <span class="hljs-string"><span class="hljs-string">'waiting'</span></span>], <span class="hljs-attr"><span class="hljs-attr">to</span></span>: <span class="hljs-string"><span class="hljs-string">'idle'</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'close'</span></span>, <span class="hljs-attr"><span class="hljs-attr">from</span></span>: <span class="hljs-string"><span class="hljs-string">'chat'</span></span>, <span class="hljs-attr"><span class="hljs-attr">to</span></span>: <span class="hljs-string"><span class="hljs-string">'closed'</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">callbacks</span></span>: { <span class="hljs-attr"><span class="hljs-attr">onidle</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event, from, to</span></span></span><span class="hljs-function">) </span></span>{ idleController.show(); }, <span class="hljs-attr"><span class="hljs-attr">onconnecting</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event, from, to</span></span></span><span class="hljs-function">) </span></span>{ waitController.show(<span class="hljs-string"><span class="hljs-string">'  '</span></span>); }, <span class="hljs-attr"><span class="hljs-attr">onwaiting</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event, from, to</span></span></span><span class="hljs-function">) </span></span>{ waitController.show(<span class="hljs-string"><span class="hljs-string">' '</span></span>); }, <span class="hljs-attr"><span class="hljs-attr">onchat</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event, from, to</span></span></span><span class="hljs-function">) </span></span>{ chatController.showChat(); }, <span class="hljs-attr"><span class="hljs-attr">onclosed</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event, from, to</span></span></span><span class="hljs-function">) </span></span>{ chatController.showClosed(); }, <span class="hljs-attr"><span class="hljs-attr">onopen</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event, from, to</span></span></span><span class="hljs-function">) </span></span>{ initSocket(); }, <span class="hljs-attr"><span class="hljs-attr">onrequest</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event, from, to</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> msg = { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'request'</span></span> }; websocket.send(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(msg)); }, <span class="hljs-attr"><span class="hljs-attr">onresponse</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event, from, to</span></span></span><span class="hljs-function">) </span></span>{ chatController.clear(); chatController.addSystemMessage(<span class="hljs-string"><span class="hljs-string">'  - '</span></span>); }, <span class="hljs-attr"><span class="hljs-attr">onclose</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event, from, to</span></span></span><span class="hljs-function">) </span></span>{ chatController.addSystemMessage(<span class="hljs-string"><span class="hljs-string">' '</span></span>); } } }); }}) })(jQuery);</code> </pre><br></div></div><br><br><h4>  Result </h4><br>  Chat stably works for about two weeks.  The daemon consumes 50MB of memory and 0.2% of the processor. <br>  People stay longer on the site, chat and post likes.  I invite you <a href="http://internetsms.org/chat">to chat</a> ! <br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/205934/">https://habr.com/ru/post/205934/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../205912/index.html">Mr. Handy - Sony SmartWatch 2 Review</a></li>
<li><a href="../205914/index.html">Tour of the data center</a></li>
<li><a href="../205918/index.html">We listen to edits in wikipedia</a></li>
<li><a href="../205920/index.html">Google opened the first data centers in Asia</a></li>
<li><a href="../205926/index.html">Black Friday: servers with a guarantee of 10 Gbit / s in NL / US from $ 1,749 / month!</a></li>
<li><a href="../205938/index.html">Rounding Difficulties in MS SQL Server</a></li>
<li><a href="../205940/index.html">The release of 3CX Phone System 12 Service Pack 3</a></li>
<li><a href="../205944/index.html">Python on Habr√©</a></li>
<li><a href="../205946/index.html">Python-digest # 6. News, interesting projects, articles and interviews [December 6, 2013 - December 13, 2013]</a></li>
<li><a href="../205948/index.html">Debugging 3CX Phone for Android using ADB monitor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>