<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Monitoring Trassir Servers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It so happened that there is a need to administer a large number (over 50 and will be multiply more) of the Trassir servers (video surveillance server...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Monitoring Trassir Servers</h1><div class="post__text post__text-html js-mediator-article">  It so happened that there is a need to administer a large number (over 50 and will be multiply more) of the Trassir servers (video surveillance server) located in different cities of the CIS.  In general, the equipment is not bad, but there are problems with centralized management due to the peculiarities of the system architecture, each server (NVR) lives its own life.  Some opportunities to steer at once with a bunch of devices are given by the ‚Äúnative‚Äù cloud, but it is absolutely unconfigurable and you can use it only as it is. <br><br>  The morning of each working day begins with checking each server for operability, which takes a lot of time. <br><br>  DSSL has an SDK, a full <a href="http://www.dssl.ru/files/trassir/manual/ru/sdk.html">description is available here</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Spent a couple of evenings and wrote a class in php, which allows the web server to check the status of Trassir servers and display on the page. <a name="habracut"></a>  To access Trassir servers via the web, they need to be configured.  First, in the server settings, enable ‚ÄúAllow access to Trassir from the browser‚Äù, secondly, ‚ÄúTrassir SDK‚Äù (and set the SDK password).  In addition, I recommend creating a user with truncated permissions to authorize the script (in my case, the Monitoring user, password 123, SDK password 12345). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ae7/05f/50a/ae705f50acf6a323816c66781674b4ba.png" alt="image"><br><br>  In general, the SDK provides great opportunities, you can familiarize yourself with the link that I gave above. <br><br>  The class code itself: <br><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TrassirServer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* 1.   . $serv = new TrassirServer('10.18.242.33', 'Monitoring', '123', '12345'); 2.           ! $serv-&gt;check_connection(); 3.   $serv-&gt;get_sid(); 4.      $objects = $serv-&gt;get_objects();   SDK 5.   $serv-&gt;get_health();      3 (get_sid()) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $status = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-comment"><span class="hljs-comment">//public $objects = array(); private $ip_address, $user, $sid, $sdk_sid; public function __construct($ip_address, $user, $password, $sdk_password) { //. $this-&gt;ip_address = $ip_address; $this-&gt;status['ip_address']= NULL; $this-&gt;user = $user; $this-&gt;password = $password; $this-&gt;sdk_password = $sdk_password; } public function check_connection (){ //  . $url = 'http://'.trim($this-&gt;ip_address).':80/'; $curlInit = curl_init($url); curl_setopt($curlInit,CURLOPT_CONNECTTIMEOUT,2); //  -       curl_setopt($curlInit,CURLOPT_HEADER,true); curl_setopt($curlInit,CURLOPT_NOBODY,true); curl_setopt($curlInit,CURLOPT_RETURNTRANSFER,true); $response = curl_exec($curlInit); curl_close($curlInit); if ($response){ $this-&gt;status['online'] = true; } else { $this-&gt;status['online'] = false; } return $this-&gt;status['online']; } /* { "success" : "0", "error_code" : "invalid username or password" } /* Username and Password should match to one of the server users. */ public function get_sid(){ //  if ($this-&gt;status['online']){ $url = 'https://' . trim($this-&gt;ip_address) . ':8080/login?username=' . $this-&gt;user . '&amp;password='.$this-&gt;password; //     $responseJson_str = file_get_contents ($url); $server_auth = json_decode ($responseJson_str, true); // JSON   if($server_auth['success']==1){ $this-&gt;status['sid'] = $server_auth['sid']; // sid  } else{ $this-&gt;status['sid'] = false; } } return $this-&gt;status['sid']; } public function get_objects(){//   if ($this-&gt;status['online']){ $url = 'https://' . trim($this-&gt;ip_address) . ':8080/objects/?password='.$this-&gt;sdk_password; $responseJson_str = file_get_contents ($url); //     $comment_position = strripos ($responseJson_str, '/*'); //      $responseJson_str = substr ($responseJson_str, 0, $comment_position); $objects = json_decode ($responseJson_str, true); return $objects; } return false; } /*    { "disks": "1", "database": "1", "channels_total": "10", "channels_online": "5", "uptime": "12902", "cpu_load": "22.50", "network": "1", "automation": "1", "disks_stat_main_days": "56.15", "disks_stat_priv_days": "35.03", "disks_stat_subs_days": "40.20" } */ public function get_health() { if ($this-&gt;status['online'] &amp;&amp; $this-&gt;status['sid']){ $url = 'https://' . trim($this-&gt;ip_address) . ':8080/health?sid='.$this-&gt;status['sid']; $responseJson_str = file_get_contents ($url); //     $comment_position = strripos ($responseJson_str, '/*'); //      $responseJson_str = substr ($responseJson_str, 0, $comment_position); $server_health = json_decode ($responseJson_str, true); // JSON   } return $server_health; } } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre> <br>  The usage example implies the presence of three files, index.php, view.css (the style sheet is optional, but everything will be sad without it), list_of_servers.txt (a text file that shows the IP addresses of all servers to check, each with a new line) . <br><br>  view.css: <br><br><pre> <code class="css hljs"><span class="hljs-selector-class"><span class="hljs-selector-class">.error</span></span>{ <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>: cc3f5b; #<span class="hljs-attribute"><span class="hljs-attribute">border</span></span>: <span class="hljs-number"><span class="hljs-number">1px</span></span> dotted red; #<span class="hljs-attribute"><span class="hljs-attribute">width</span></span>: <span class="hljs-number"><span class="hljs-number">99%</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">padding-left</span></span>: <span class="hljs-number"><span class="hljs-number">5px</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.trassir_server</span></span>{ #<span class="hljs-attribute"><span class="hljs-attribute">border-bottom</span></span>: <span class="hljs-number"><span class="hljs-number">1px</span></span> solid black; <span class="hljs-attribute"><span class="hljs-attribute">width</span></span>: <span class="hljs-number"><span class="hljs-number">250px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">height</span></span>: <span class="hljs-number"><span class="hljs-number">240px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>: <span class="hljs-number"><span class="hljs-number">#4682B4</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">color</span></span>: white; <span class="hljs-attribute"><span class="hljs-attribute">margin-top</span></span>: <span class="hljs-number"><span class="hljs-number">15px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">margin-left</span></span>: <span class="hljs-number"><span class="hljs-number">5px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">display</span></span>: inline-block; <span class="hljs-attribute"><span class="hljs-attribute">vertical-align</span></span>: top; } <span class="hljs-selector-class"><span class="hljs-selector-class">.OK</span></span>{ <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>: <span class="hljs-number"><span class="hljs-number">#4169E0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border-bottom</span></span>: <span class="hljs-number"><span class="hljs-number">1px</span></span> solid black; <span class="hljs-attribute"><span class="hljs-attribute">padding-left</span></span>: <span class="hljs-number"><span class="hljs-number">5px</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.trassir_server_name</span></span>{ <span class="hljs-attribute"><span class="hljs-attribute">font-size</span></span>: <span class="hljs-number"><span class="hljs-number">20px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">text-align</span></span>: center; <span class="hljs-attribute"><span class="hljs-attribute">height</span></span>: <span class="hljs-number"><span class="hljs-number">30px</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">body</span></span>{ <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>: <span class="hljs-number"><span class="hljs-number">#DCDCDC</span></span>; }</code> </pre> <br>  index.php <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> header(<span class="hljs-string"><span class="hljs-string">'Content-Type: text/html; charset=utf-8'</span></span>); ini_set(<span class="hljs-string"><span class="hljs-string">'max_execution_time'</span></span>, <span class="hljs-number"><span class="hljs-number">60</span></span>); error_reporting(E_ALL); <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> (<span class="hljs-string"><span class="hljs-string">'classes/TrassirServer.php'</span></span>); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;html&gt; &lt;head&gt; &lt;link rel=<span class="hljs-string"><span class="hljs-string">'stylesheet'</span></span> href=<span class="hljs-string"><span class="hljs-string">'./css/view.css'</span></span>&gt; &lt;/head&gt; &lt;body&gt; <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $user = <span class="hljs-string"><span class="hljs-string">'Monitoring'</span></span>; $password = <span class="hljs-string"><span class="hljs-string">'123'</span></span>; $sdk_password = <span class="hljs-string"><span class="hljs-string">'12345'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trassir_server_monitor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($ip, $user, $password, $sdk_password)</span></span></span></span>{ $serv = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TrassirServer($ip, $user, $password, $sdk_password); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;div class = "trassir_server"&gt;'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($serv-&gt;check_connection()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($serv-&gt;get_sid()) { $objects = $serv-&gt;get_objects(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($objects){ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($objects <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $obj) <span class="hljs-comment"><span class="hljs-comment">//      { if ($obj['class'] == 'Server') { $serv-&gt;status['name']= $obj['name']; } } } echo '&lt;div class = "trassir_server_name"&gt;'; //   echo $serv-&gt;status['name']; echo '&lt;/div&gt;'; echo '&lt;div class = "trassir_server_status"&gt;'; //  $health = $serv-&gt;get_health(); foreach ($health as $key =&gt; $value){ if (($key == 'disks' || $key == 'database' || $key == 'network' || $key == 'automation')&amp;&amp; $value=='1') { echo '&lt;div class = "OK"&gt;'; echo $key . ': '; echo 'OK'; echo '&lt;/div&gt;'; } else if ($key == 'cpu_load' &amp;&amp; $value &lt;= 75) { echo '&lt;div class = "OK"&gt;'; echo ' : '; echo $value . '%'; echo '&lt;/div&gt;'; } else if ($key == 'uptime' &amp;&amp; $value &gt; 3600) { echo '&lt;div class = "OK"&gt;'; echo ': '; $day = floor($value/86400); $value1 = $value - $day*86400; $hour = floor(($value - $day*86400)/3600); echo $day.' days '.$hour . ' hours'; echo '&lt;/div&gt;'; } else if ($key == 'uptime' &amp;&amp; $value &lt;= 3600) { echo '&lt;div class = "error"&gt;'; echo $key . ' less than hour : '; echo $value . ' seconds'; echo '&lt;/div&gt;'; } else if ($key == 'channels_total') { echo '&lt;div class = "OK"&gt;'; echo ' : '; echo $value; $ch_total = $value; echo '&lt;/div&gt;'; } else if ($key == 'channels_online' &amp;&amp; $value == $ch_total) { echo '&lt;div class = "OK"&gt;'; echo ' : '; echo $value; $ch_total = $value; echo '&lt;/div&gt;'; } else if (($key == 'disks_stat_main_days' || $key == 'disks_stat_subs_days')&amp;&amp; $value &gt; 45) { echo '&lt;div class = "OK"&gt;'; echo $key . ': '; echo $value; echo '&lt;/div&gt;'; } else if ( $key == 'disks_stat_priv_days') { echo '&lt;div class = "OK"&gt;'; echo $key . ': '; echo $value; echo '&lt;/div&gt;'; } else { echo '&lt;div class = "error"&gt;'; echo $key . ': '; echo $value; echo '&lt;/div&gt;'; } } echo '&lt;/div&gt;'; } } if (!$serv-&gt;status['online'] || !$serv-&gt;status['sid'] || !$objects){ //   ,          . echo '&lt;div class = "error"&gt;'; echo 'server ' . $ip . '&lt;/br&gt;'; echo 'connection error'; echo '&lt;/div&gt;'; } echo '&lt;/div&gt;'; } $list_of_servers = fopen("conf/list_of_servers.txt", "r"); if ($list_of_servers) { while (($buffer = fgets($list_of_servers)) !== false) { trassir_server_monitor($buffer, $user, $password, $sdk_password); } } fclose($list_of_servers); echo '&lt;br/&gt;'; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> &lt;/body&gt; &lt;/html&gt;</span></span></code> </pre> <br>  The result in my case (for the testing period only 4 servers): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2ea/89d/0eb/2ea89d0eb1878b32511d32ac64f8ebd3.jpg" alt="image"><br><br>  In the plans: <br><br><ol><li>  Automatic regular launch of the script (a couple of times a day) and saving statistics on the status of servers in the database. </li><li>  Perhaps the centralized management of UZ users if it is relevant to the time when I can implement the first. </li></ol><br>  If there are still ‚Äúhappy‚Äù administrators of this system, I will be happy to help with the desire to jointly refine the functionality.  Also, if someone is interested in the final result, but is not ready to engage in development - write to denis.glushakov@bk.ru, I will try not to forget about you. <br><br>  Tips on optimizing the code with pleasure I will accept in the comments. <br><br>  UPD from 06/22/2018.  Since there was some interest in the material, I will make a small update: I rewrote all this horror in a more or less decent lib available on packagist (look for the word Trassir) and did a different implementation with full functionality on the symphony (saving states in the database, displaying statistics, etc.).  To whom it is relevant - write to the post office, there is no time to find it to publish yet, and it‚Äôs not yet complete until the end. </div><p>Source: <a href="https://habr.com/ru/post/344488/">https://habr.com/ru/post/344488/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../344478/index.html">Another implementation of case-insensitive search for Cyrillic characters in SQLite</a></li>
<li><a href="../344480/index.html">Perfect maven. Part 2: project structure</a></li>
<li><a href="../344482/index.html">Intel AI Academy - New Year's gift for all developers of AI</a></li>
<li><a href="../344484/index.html">Click, trade, deposit. Our online tools for corporate clients</a></li>
<li><a href="../344486/index.html">Parcel - a very fast bandler that does not require configuration.</a></li>
<li><a href="../344490/index.html">Let's drive a mammoth into a hole: how to make a presentation so that you can be heard and remembered</a></li>
<li><a href="../344492/index.html">Zabbix 3.4: Macros in time intervals</a></li>
<li><a href="../344494/index.html">Do not succumb to HYIP, or why the price of Bitcoin does not reflect its real value.</a></li>
<li><a href="../344496/index.html">New spyware StrongPity2 replaced FinFisher in a cyber espionage campaign with the possible participation of an Internet provider</a></li>
<li><a href="../344498/index.html">PHP dependency management</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>