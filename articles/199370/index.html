<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we made friends with PayPal</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dear foreign guest with a surname too well known to be called, a PayPal citizen has just ‚Äústepped off the ship‚Äù to the domestic ‚Äúberth‚Äù, but has alrea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we made friends with PayPal</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/getpro/habr/post_images/dfa/7bb/72c/dfa7bb72c920453fcb9e1ee0c3186868.jpg"><br>  Dear foreign guest with a surname too well known to be called, a PayPal citizen has just ‚Äústepped off the ship‚Äù to the domestic ‚Äúberth‚Äù, but has already managed to become his own ball, where electronic payment systems of the Russian segment actively dance.  We did not stand aside and hurried to make a useful acquaintance with such a respected comrade, adding, finally, his good name to our <a href="https://unitpay.ru/tariff">list of friends</a> .  From which side to approach, what to talk about and how to get his attention we read in a small story under the cut. <a name="habracut"></a><br><br clear="all"><h4>  Friendship begins with a smile </h4><br>  The first timid step on the way to a great friendship is a presentation, that is, registration, where in the personal data it is necessary to provide information about the commercial activities of the company, which we did in good faith. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/094/cb9/b05/094cb9b055649abf41f641b5baa3eeeb.png"><br><br>  However, instead of easy and relaxed relations, which we managed to mentally rejoice, we were waited by an inhospitable message about the restriction of the account and please provide a number of additional documents to confirm our account.  We did not have time to collect everything we needed, as, fortunately, in mid-September, PayPal significantly simplified the procedure for connecting legal entities.  It was only necessary to fill out a special form for this on the PayPal side.  But now it was too early to rejoice - the form simply did not work for the first few days.  We honestly filled in all required and optional fields, but each time we received a data transmission error and, no matter how hard we tried, it repeated again and again.  Without losing determination and having a lot of perseverance in store, a week later we repeated the ‚Äúexperiment‚Äù and, finally, received a long-awaited confirmation, and soon a cherished letter from PayPal. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/1eb/3b1/da1/1eb3b1da19ee1da1d8e6fd34555fb8f8.png"><br><br><h4>  A true friend is known in the API </h4><br>  Understanding all the intricacies of the <a href="https://developer.paypal.com/webapps/developer/docs/api/">protocol PayPal is</a> not easy.  Scattered across different parts of the site, pieces of documentation, the heavy legacy of SOAP, the general confusion of the protocol stack (NVP, SOAP, REST) ‚Äã‚Äãand the lack of examples did the trick.  A typical example of confusion, an action implemented by one protocol cannot be performed by another, and vice versa. <br>  But the journey of a thousand miles begins with the first step, throwing all doubts away, we will use the currently most popular REST API, and take their own <a href="https://github.com/paypal/rest-api-sdk-php">PHP SDK</a> as a wrapper for it.  Some things, however, still have to think out themselves, exploring the code. <br><br>  The general idea can be described in the following steps: <br><br><ol><li>  We register <a href="https://developer.paypal.com/webapps/developer/applications/myapps">PayPal Application</a> to get pairs of client_id and secret_key values ‚Äã‚Äãfor live and sandbox mode: <br><img src="https://habrastorage.org/getpro/habr/post_images/582/83e/586/58283e58619b55fd49909dbc70daacbe.png"><br><br></li><li>  We perform OAuth authentication: <br><pre><code class="php hljs">$apiContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApiContext(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OAuthTokenCredential( $clientId, $clientSecret)); $apiContext-&gt;setConfig([ <span class="hljs-string"><span class="hljs-string">'mode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'live'</span></span>]);</code> </pre> <br></li><li>  Make a request to create a payment.  If you plan to accept payment from the paypal account, as well as the card attached to it, do not forget to specify the payment method: paypal <br><pre> <code class="php hljs">$payer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Payer(); $payer-&gt;setPaymentMethod(<span class="hljs-string"><span class="hljs-string">'paypal'</span></span>); $amount = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Amount(); $amount-&gt;setCurrency(<span class="hljs-string"><span class="hljs-string">'RUB'</span></span>); $amount-&gt;setTotal(<span class="hljs-string"><span class="hljs-string">'10'</span></span>); $item1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Item(); $item1-&gt;setName(<span class="hljs-string"><span class="hljs-string">' /'</span></span>)-&gt;setCurrency(<span class="hljs-string"><span class="hljs-string">'RUB'</span></span>)-&gt;setQuantity(<span class="hljs-number"><span class="hljs-number">1</span></span>)-&gt;setPrice(<span class="hljs-string"><span class="hljs-string">'10'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  /    $item1-&gt;setSku('1000'); $itemList = new ItemList(); $itemList-&gt;setItems(array($item1)); $transaction = new Transaction(); $transaction-&gt;setAmount($amount); $transaction-&gt;setDescription('Payment to UnitPay'); $transaction-&gt;setItemList($itemList); $payment = new Payment(); $payment-&gt;setIntent('sale'); $payment-&gt;setPayer($payer); $payment-&gt;setTransactions(array($transaction)); $payment&gt;setRedirectUrls(array( "return_url" =&gt; $resultUrl, "cancel_url" =&gt; $resultUrl )); $payment-&gt;create($apiContext);</span></span></code> </pre><br></li><li>  In response, we get the payment number in PayPal and the redirectURL form of payment, where we transfer the user: <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// ID ,         $payment-&gt;getId(); $links = $payment-&gt;getLinks(); foreach ($links as $link) { if ($link-&gt;getMethod() == 'REDIRECT') { header('location:'.$link-&gt;getHref()); return; } }</span></span></code> </pre><br></li><li>  Customer Account Confirmation: <br><img src="https://habrastorage.org/getpro/habr/post_images/044/866/b34/044866b34908293bb89de72052f0edde.png"><br><br></li><li>  Automatic client return with GET token, PayerID on $ resultUrl parameters (see step 3). <br></li><li>  The money has been written off, but the payment has not yet been made.  We say to PayPal, that yes, we confirm the payment: <br><pre> <code class="php hljs">$apiContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApiContext(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OAuthTokenCredential( $clientId, $clientSecret)); $apiContext-&gt;setConfig([ <span class="hljs-string"><span class="hljs-string">'mode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'live'</span></span>]); $payment = Payment::get($payment-&gt;getExternalPaymentId(), $apiContext); $paymentExecution= <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PaymentExecution(); $paymentExecution-&gt;setPayerId($payerId); $payment-&gt;execute($paymentExecution, $apiContext);</code> </pre><br></li><li>  Optionally, PayPal makes a notification of payments to the specified URL, this is called their <a href="https://www.paypal.com/ru/cgi-bin/webscr%3Fcmd%3Dp/acc/ipn-info-outside">IPN</a> : <br><img src="https://habrastorage.org/getpro/habr/post_images/ccf/bf1/0ee/ccfbf10eeafc068f4fe2cdd9447cfc34.png"><br><br>  Each such notification received must be validated by a response request in the direction of PayPal.  You also need to verify the amount of payment, currency and email recipient.  It remains only to wait for the coveted status of completed and the payment can be considered completed.  If you do not want to contact an IPN, you can always simply poll PayPal about the status of required payments, for example, via cron, although the IPN is still more convenient: <br><pre> <code class="php hljs">$ipn = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PPIPNMessage(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>([<span class="hljs-string"><span class="hljs-string">'mode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'live'</span></span>])); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$ipn-&gt;validate()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'      PayPal'</span></span>); } <span class="hljs-comment"><span class="hljs-comment">// $_GET['txn_id']   PayPal // $_GET['mc_gross']   // $_GET['mc_currency']   // $_GET['payer_email'] mail  // $_GET['item_number1']    // $_GET['payment_status']   // $_GET['receiver_email'] Email  switch ($_GET['payment_status']) { //   ,   case 'completed': break; //    case 'failed': break; //    case 'denied': break; //     case 'refunded': break; }</span></span></code> </pre></li></ol><br>  In our opinion, most of the steps of this scheme are redundant: you can remove repeated checks to PayPal at the payment notification stage simply by signing the data sent in advance.  The same applies to superfluous actions with the confirmation of the user's payment already made.  Also, in addition to storing the PayPal payment number, you will have to organize the storage of the token to uniquely identify the order and complete step 7. An alternative option is to create a return Url with a unique key. <br><br>  At the moment, API PayPal is <a href="http://habrahabr.ru/post/128198/">one of the most confusing and ambiguous</a> among popular payment systems, but on the other hand, if you go along the trodden path, without turning, then everything will work out. <br><br><h4>  Do not have a hundred rubles, and have a hundred friends </h4><br>  In turn, we have simplified connection and work with PayPal and are ready to provide a number of payment instruments to choose from. <br><br>  If you only thought about how to implement payment acceptance for your project and what payment methods will suit you besides PayPal, then we recommend the fastest and easiest way to connect - the <a href="https://unitpay.ru/pay/demo/mc%3Fsum%3D10%26account%3Ddemo%26desc%3DDEMO%2B%25D0%25BF%25D0%25BB%25D0%25B0%25D1%2582%25D0%25B5%25D0%25B6%2BUnitpay.ru">universal payment method UnitPay</a> .  PayPal will be available among other payment methods. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f1a/c0e/1f8/f1ac0e1f88f7824013edbc87971e5431.png"><br><br>  For those who have already formed their list of payment systems and just want to expand it by connecting PayPal, we suggest using our API, a full description of which can be found on your project page. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b0a/4f0/0a5/b0a4f00a53724a69d3fa8d943015fa98.png"><br><br><h4>  And what for the CIS countries? </h4><br>  Unfortunately, while PayPal is not available for a number of countries closest to us.  Many are experiencing a number of difficulties with this and offer quite <a href="http://habrahabr.ru/post/182790/">different solutions</a> .  We think that soon this situation will change for the better. <br><br><h4>  Finally </h4><br>  PayPal in Russia is still very young, but it has a rich past and huge potential.  We hope that quite a bit of time will pass, and it will take its rightful place in the list of safe and convenient payment systems in the domestic market. </div><p>Source: <a href="https://habr.com/ru/post/199370/">https://habr.com/ru/post/199370/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../199360/index.html">As the "magic" of an error correction code that is over 50 years old, can speed up flash memory</a></li>
<li><a href="../199362/index.html">Runet in pictures - X. Mobile Internet in Russia (part 2)</a></li>
<li><a href="../199364/index.html">Mini drill with their own hands</a></li>
<li><a href="../199366/index.html">Automatic control of temperature, ventilation and lighting in the greenhouse in the 80s</a></li>
<li><a href="../199368/index.html">How does a robot vacuum cleaner?</a></li>
<li><a href="../199372/index.html">Events that influenced your childhood development</a></li>
<li><a href="../199374/index.html">What is Hackspace?</a></li>
<li><a href="../199376/index.html">IPv4 inventory depletion: what's really going on and how does REG.RU do it</a></li>
<li><a href="../199378/index.html">Aspect-oriented programming: study and do it yourself!</a></li>
<li><a href="../199380/index.html">What's new in Direct3D 11.2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>