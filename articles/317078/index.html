<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Overtaking compiler</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It is often repeated now on forums and other places where developers talk, that a decent optimizing compiler will always surpass the pitiful, almost h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Overtaking compiler</h1><div class="post__text post__text-html js-mediator-article">  It is often repeated now on forums and other places where developers talk, that a decent optimizing compiler will always surpass the pitiful, almost human attempts of a program written by hand in assembly language.  There are rare cases, such as MPEG decoders, where good use of SIMD instructions may allow assembly to completely outperform the compiler.  But usually, and everywhere, we hear that the compiler always works better. <br><br>  The reason is usually indicated by the fact that a modern CPU has so many pipelines and management conflicts that you have to deal with, that a simple assembler program will not do the job well, handling them. <br><br>  But is it?  Let's not just take on faith the words of some guys on the Internet as a biblical revelation, but we will do a little experiment and find out. <br><a name="habracut"></a><br>  We just take a simple piece of code and look at it.  I'm not going to pick an example that can benefit, to a large extent, from exotic built-in functions.  Instead, I'll take the old standard quicksort. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Here we show a simple quick sort in C ++, which we will test: <br><br><pre><code class="hljs perl">struct Item { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> key; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> value; }; extern <span class="hljs-string"><span class="hljs-string">"C"</span></span> void sortRoutine(Item *items, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> already sorted <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> only zero/one element // Pick the pivot. Item pivot = items[count-<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> low = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pos</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">pos</span></span>&lt;count-<span class="hljs-number"><span class="hljs-number">1</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">pos</span></span>++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (items[<span class="hljs-keyword"><span class="hljs-keyword">pos</span></span>].key &lt;= pivot.key) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> swap elements Item tmp = items[<span class="hljs-keyword"><span class="hljs-keyword">pos</span></span>]; items[<span class="hljs-keyword"><span class="hljs-keyword">pos</span></span>] = items[low]; items[low] = tmp; low++; } } items[count-<span class="hljs-number"><span class="hljs-number">1</span></span>] = items[low]; items[low] = pivot; sortRoutine(items, low); sortRoutine(items+low+<span class="hljs-number"><span class="hljs-number">1</span></span>, count-<span class="hljs-number"><span class="hljs-number">1</span></span>-low); }</code> </pre> <br>  Nothing unusual.  This is not the best sorting algorithm in the world, and this is not even the best implementation, but it is simple and does its job well. <br><br>  Now we will try to directly execute a simple implementation of this approach in the assembler: <br><br><pre> <code class="hljs perl">sortRoutine: ; rcx = items ; rdx = count <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rdx</span></span></span><span class="hljs-function">, 1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jbe</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">done</span></span></span><span class="hljs-function"> </span></span>; Pick the pivot. mov r8, [rcx+rdx*<span class="hljs-number"><span class="hljs-number">8</span></span>] ; r8 = pivot data <span class="hljs-keyword"><span class="hljs-keyword">xor</span></span> r9, r9 ; r9 = low <span class="hljs-keyword"><span class="hljs-keyword">xor</span></span> r1<span class="hljs-number"><span class="hljs-number">0</span></span>, r1<span class="hljs-number"><span class="hljs-number">0</span></span> ; r1<span class="hljs-number"><span class="hljs-number">0</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">pos</span></span> partition: cmp [rcx+r1<span class="hljs-number"><span class="hljs-number">0</span></span>*<span class="hljs-number"><span class="hljs-number">8</span></span>], r8d jg noswap ; swap elements mov rax, [rcx+r1<span class="hljs-number"><span class="hljs-number">0</span></span>*<span class="hljs-number"><span class="hljs-number">8</span></span>] mov r11, [rcx+r9*<span class="hljs-number"><span class="hljs-number">8</span></span>] mov [rcx+r9*<span class="hljs-number"><span class="hljs-number">8</span></span>], rax mov [rcx+r1<span class="hljs-number"><span class="hljs-number">0</span></span>*<span class="hljs-number"><span class="hljs-number">8</span></span>], r11 inc r9 noswap: inc r1<span class="hljs-number"><span class="hljs-number">0</span></span> cmp r1<span class="hljs-number"><span class="hljs-number">0</span></span>, rdx jb partition ; move pivot into place mov rax, [rcx+r9*<span class="hljs-number"><span class="hljs-number">8</span></span>] mov [rcx+rdx*<span class="hljs-number"><span class="hljs-number">8</span></span>], rax mov [rcx+r9*<span class="hljs-number"><span class="hljs-number">8</span></span>], r8 ; recurse <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rdx</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r9</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lea</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rax</span></span></span><span class="hljs-function">, [</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rcx</span></span></span><span class="hljs-function">+</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r9</span></span></span><span class="hljs-function">*8+8] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rdx</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rdx</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r9</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sortRoutine</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pop</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rdx</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pop</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rcx</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rdx</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rdx</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jnz</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sortRoutine</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">done</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ret</span></span></span></span></code> </pre> <br>  It turned out to be quite easy to write, mainly due to the operators of flexible addressing to Intel memory.  What is interesting - I did not make any real attempt to pay attention to planning, pipelining, and so on.  I just wrote it as a simple assembly language program. <br><br>  Now let's estimate the elapsed time.  I wrote a simple test program that sorted an array of 1,000,000 positions.  The test was performed 100 times and was taken the best value for the entire set.  Version C ++ was compiled using gcc 4.8.1, clang 3.8.0 and MSVC 2013. <br><br><h2>  results </h2><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">sort_cpp_recurse_gcc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.exe</span></span> : 99  <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>    100  <span class="hljs-selector-tag"><span class="hljs-selector-tag">sort_cpp_recurse_clang</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.exe</span></span> : 99  <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>    100  <span class="hljs-selector-tag"><span class="hljs-selector-tag">sort_cpp_recurse_ms</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.exe</span></span> : 98  <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>    100  <span class="hljs-selector-tag"><span class="hljs-selector-tag">sort_asm_recurse</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.exe</span></span> : 92  <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>    100 </code> </pre> <br>  Well, this is interesting.  Different compilers produce basically the same result with a slight advantage for MSVC.  <b>But the assembler version is clearly faster</b> - almost 7% in this case. <br><br>  The fact is, in C ++ there is not always a good representation of the underlying machine.  This is normal when it comes to variables, but its stack representation is very limited.  C ++ believes that we can only use the stack for calls, whereas in reality one of the things we can do is use it as a data stack. <br><br>  Let's try and see what happens.  We remove the recursive calls to sortRoutine and instead retrieve our data ranges directly from the stack.  This allows us to work in a single cycle without the need, in fact, to access recursion.  Often, this approach can provide a significant advantage, since it eliminates the loss of time at each input to a function / output from it. <br><br>  The corresponding program is available in the archive file below. <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">sort_cpp_recurse_gcc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.exe</span></span> : 99  <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>    100  <span class="hljs-selector-tag"><span class="hljs-selector-tag">sort_cpp_recurse_clang</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.exe</span></span> : 99  <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>    100  <span class="hljs-selector-tag"><span class="hljs-selector-tag">sort_cpp_recurse_ms</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.exe</span></span> : 98  <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>    100  <span class="hljs-selector-tag"><span class="hljs-selector-tag">sort_asm_recurse</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.exe</span></span> : 92  <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>    100  <span class="hljs-selector-tag"><span class="hljs-selector-tag">sort_cpp_iter_gcc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.exe</span></span> : 106  <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>    100  <span class="hljs-selector-tag"><span class="hljs-selector-tag">sort_cpp_iter_clang</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.exe</span></span> : 97  <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>    100  <span class="hljs-selector-tag"><span class="hljs-selector-tag">sort_cpp_iter_ms</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.exe</span></span> : 95  <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>    100  <span class="hljs-selector-tag"><span class="hljs-selector-tag">sort_asm_iter</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.exe</span></span> : 92  <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>    100 </code> </pre> <br><br>  Interesting.  The assembler version gave almost the same result.  I suppose this is due to the fact that, although the iterative approach eliminates the loss of work with functions, such losses for our hand-written version for x64 are actually small, so there is no gain. <br><br>  But for C ++ versions, the situation is different.  Most showed a slight increase in speed, but gcc is clearly slower!  As far as I can see from disassembling, the control is built as if it is trying to confuse itself.  Increased control routes and the associated bells and whistles have led to complicated juggling. <br><br>  I compiled these x64 tests, where the default calling convention is fastcall.  I suppose that if instead of compiling a solution for a 32-bit version using the agreement based on the cdecl stack, a non-recursive version would have produced a relatively better result.  I have not tried it - I leave it as an exercise for the reader. <br><br><h2>  Conclusion </h2><br>  It seems that the old saying ‚Äúmodern compilers are always faster than the program you have written in assembler‚Äù is not necessarily correct. <br><br>  However, it is correct that the compiler does its work <i>quite well</i> , and it is easier to work with code.  Therefore, although it would be possible to squeeze a little more speed, but this is hardly justified because of the emerging difficulties associated with maintenance. <br><br>  The assembler version <i>was</i> still faster.  I believe that if in this post you have found something useful for yourself, it is that people on the Internet <i>can sometimes say something that does not correspond to reality at all</i> . <br><br>  <b>Materials</b> <br>  <a href="">sorttest.zip</a> - All codes used in this article. </div><p>Source: <a href="https://habr.com/ru/post/317078/">https://habr.com/ru/post/317078/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317064/index.html">DevOpsDays 2017 Conference: Become a Rapporteur or Participant</a></li>
<li><a href="../317066/index.html">Psychology in the service of information security. Tendency to crime</a></li>
<li><a href="../317068/index.html">Install Oracle ApEx</a></li>
<li><a href="../317072/index.html">vSphereTools: How we created an open source automation tool for vSphere</a></li>
<li><a href="../317074/index.html">Features of the implementation of a virtual machine in Dart. JS and Dart compiler eyes</a></li>
<li><a href="../317082/index.html">How we animate the presentation</a></li>
<li><a href="../317084/index.html">On the eve of the birthday of the first female programmer: my story</a></li>
<li><a href="../317086/index.html">New service on My Circle - access to the resume database</a></li>
<li><a href="../317088/index.html">Your / my / our code</a></li>
<li><a href="../317090/index.html">Asterisk, Hangupcause Substitution</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>