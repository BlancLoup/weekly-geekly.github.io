<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Weather Station on Arduino from A to Z. Part 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continued. The previous part . 


 Table of contents: 


- Part 1. Requirements. The choice of iron. General scheme 
- Part 2. Software. Central unit,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Weather Station on Arduino from A to Z. Part 3</h1><div class="post__text post__text-html js-mediator-article"><p>  Continued.  <a href="https://habr.com/post/425927/">The previous part</a> . </p><br><p>  Table of contents: </p><br><ul><li>  <a href="https://habr.com/post/425901/">Part 1. Requirements.</a>  <a href="https://habr.com/post/425901/">The choice of iron.</a>  <a href="https://habr.com/post/425901/">General scheme</a> </li><li>  <a href="https://habr.com/post/425927/">Part 2. Software.</a>  <a href="https://habr.com/post/425927/">Central unit, iron</a> </li><li>  <a href="https://habr.com/post/425953/">Part 3. Central unit, software</a> </li><li>  <a href="https://habr.com/post/425963/">Part 4. Transom Sensor</a> </li><li>  <a href="https://habr.com/post/426019/">Part 5. MySQL, PHP, WWW, Android</a> </li></ul><br><h1 id="centralnyy-blok-programmnoe-obespechenie">  Central unit.  Software </h1><br><p>  Finally, we come to the most difficult part for any programmer - to describe in human terms what he has done there. </p><br><p>  The source code for the server is about 1300 lines, including indents, but this should not scare you.  The source text is provided with detailed comments, in this respect I will not be mistaken if I say that my source codes are described better than any others that you can find.  In the comments directly in the source text you will find all the pinouts for connecting modules and all the necessary links to external documentation.  The secret is simple - I wrote comments for myself all the time, ‚Äúin the course of the play,‚Äù so I did not experience any difficulties with documentation. </p><a name="habracut"></a><br><p>  As I already wrote, you can start without having all the modules at hand.  For example, you can start without a radio module or ESP8266.  The barometric pressure sensor BMP180 may also be missing.  Add later.  The truth is that in this case you (probably) will have to independently comment out in the sketch those parts of the code that are responsible for interacting with the missing blocks, but most likely this will not be necessary.  The main thing is that at least something gathered and earned, then more fun to continue. </p><br><p>  Specifically now, at this point in the story, we have not yet assembled the outside window (external) module and do not have our own web server with a database, then we don‚Äôt need it yet (but if you have it, connect right away so you don‚Äôt have to dig) </p><br><ul><li>  radio module nRF24L01 + </li><li>  WiFi module ESP8266. </li></ul><br><p>  And yet, I will begin, perhaps, with ESP8266, as the most problematic in programming and operating the module.  The reason lies in the variety of execution of the modules themselves and their firmware. </p><br><p>  As I wrote the standard AT-firmware for it have several disadvantages: </p><br><ul><li>  they are still damp (as of 2016) </li><li>  I could not find a normal library for Arduino to control the ESP8266 module using AT commands, I had to ‚Äúcollective farm‚Äù myself. </li></ul><br><p>  I did not design the code for ESP8266 into a separate library, but simply wrote the necessary functions, so the sketch came out so long.  And I implemented only the functionality I needed.  All programming for ESP using AT commands is reduced as a result to parsing lines and setting delays between commands. </p><br><p>  <a href="https://github.com/tim4dev/arduino/tree/master/project/weather-station/server">The source code for the server (central module) server.ino can be found and downloaded here</a> . </p><br><p> Next, I put the firmware for ESP8266 in the file <code>firmware/AT23-SDK101-nocloud.bin</code> and in the same directory there is documentation for the curious.  After flashing the specified firmware, you can be sure that my sketch will work for you with WiFi as it was intended.  I have not experimented with other AT firmware.  The fact is that I managed to find the ‚Äúadvanced‚Äù <strong>non-</strong> AT firmware, and even participate in its creation, which is perfectly suited for our purposes ( <a href="https://github.com/jeelabs/esp-link">here it is esp-link</a> ).  However, as often happens, everything happened after the completion of the current version of the weather station, so it was decided to leave everything as it is. </p><br><p>  So, at the very beginning you will have to flash the specified AT firmware.  There is nothing difficult here, but also simple.  How to do this is described in many places on the network - <a href="http://esp8266.ru/esp8266-podkluchenie-obnovlenie-proshivki/">ESP8266 - connecting and updating the firmware</a> . </p><br><p>  Since my USB-TTL converter did not have enough current power and the USB port was constantly falling off (this is a turn!), I electrically connected the module for its firmware using the ‚ÄúArduino as a simple USB-to-Serial TTL converter‚Äù module. </p><br><p>  Since I work in Linux, I am also using <code>esptool.py</code> .  For the convenience of the firmware, I ‚Äúnakolhozil‚Äù a small auxiliary board with switches (not described here). </p><br><p>  After the firmware, you need to set the port speed of 57600 (as for SoftSerial, the port speed of 115200 is high and does not guarantee stable operation) with the command </p><br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">AT</span></span>+UART_DEF=<span class="hljs-number"><span class="hljs-number">57600</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  Next, you need to slightly change the standard Arduino IDE libraries, namely, in the <code>arduino/hardware/arduino/avr/libraries/SoftwareSerial/SoftwareSerial.h</code> file, change the corresponding line to </p><br><pre> <code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _SS_MAX_RX_BUFF 128 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// RX buffer size</span></span></span></span></code> </pre> <br><p>  in the <code>arduino/hardware/arduino/avr/cores/arduino/HardwareSerial.h</code> change the corresponding lines to </p><br><pre> <code class="hljs cs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SERIAL_TX_BUFFER_SIZE 128 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SERIAL_RX_BUFFER_SIZE 128</span></span></code> </pre> <br><p>  and in the file <code>arduino/hardware/arduino/avr/cores/arduino/USBAPI.h</code> change the corresponding line to </p><br><pre> <code class="hljs cs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SERIAL_BUFFER_SIZE 128</span></span></code> </pre> <br><p>  Strictly speaking this is wrong, because  when updating the Arduino SDK, these files will most likely be overwritten and you will have to repeat all the fixes again.  According to science, we have to invent our library, which manipulates the specified values ‚Äã‚Äã(if it works), but this is an amateur. </p><br><p>  One way or another, the preliminary manipulations are over. </p><br><p>  Now go directly to the code of the central unit (server) <a href="">server.ino</a> </p><br><p>  In the very first lines you should change the access settings for your WiFi point. </p><br><pre> <code class="hljs vbscript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> SSID = <span class="hljs-string"><span class="hljs-string">"..."</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> PASSWORD = <span class="hljs-string"><span class="hljs-string">"..."</span></span>;</code> </pre> <br><p>  work with the web server will be discussed in detail later. </p><br><p>  Next come the (commented out) debug definitions: </p><br><pre> <code class="hljs smalltalk">//<span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">DEBUG</span></span> //<span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">DEBUG_RF</span></span> //<span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">DEBUG_ESP</span></span> //<span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">DEBUG_LOG_SD</span></span></code> </pre> <br><p>  If something goes wrong, you can always uncomment them, recompile and reload the sketch and get more debugging information in the console or write it to a file on the SD card.  And you can uncomment only what you need.  For example, is the nRF24L01 + module swindling?  Then uncomment only DEBUG_RF, etc. </p><br><p>  Next come extensive comments with pinout, initialization and a detailed description of the entire periphery. </p><br><p>  Here you can change the number of the radio channel for nRF24L01 + </p><br><pre> <code class="hljs cs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RF_CHANNEL 73</span></span></code> </pre> <br><p>  Next comes the <code>void setup()</code> , which is made clear from the detailed comments.  Well and then <code>void loop()</code> , the code of work with the web server is not considered yet. </p><br><p>  After casting the sketch, your central unit will come to life and will show you something, but not immediately, but after 10 minutes - the value <code>DELAY_LOCAL_SENSOR</code> .  You can change it of course. <br>  The display should show: room temperature and humidity (data coming from the DHT11 sensor) and barometric pressure (from BMP180). </p><br><p>  For the display on the LCD 16 √ó 4 answer functions: </p><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> lcdClearRow(<span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>) //     ,   <span class="hljs-type"><span class="hljs-type">void</span></span> lcdPrintOutdoor(<span class="hljs-type"><span class="hljs-type">int</span></span> temperature, <span class="hljs-type"><span class="hljs-type">int</span></span> humidity, <span class="hljs-type"><span class="hljs-type">float</span></span> voltage) //     ,   <span class="hljs-type"><span class="hljs-type">void</span></span> lcdPrintHome(<span class="hljs-type"><span class="hljs-type">int</span></span> temperature, <span class="hljs-type"><span class="hljs-type">int</span></span> humidity, <span class="hljs-type"><span class="hljs-type">int</span></span> pressure) <span class="hljs-type"><span class="hljs-type">void</span></span> lcdPrintInfo(<span class="hljs-type"><span class="hljs-type">char</span></span> <span class="hljs-keyword"><span class="hljs-keyword">info</span></span>[LCD_MAX_COLS]) <span class="hljs-type"><span class="hljs-type">void</span></span> lcdPrintStatus() <span class="hljs-type"><span class="hljs-type">void</span></span> lcdPrintLastSensorTime()</code> </pre> <br><p>  LCD1604 display design is as follows. </p><br><p><img src="https://habrastorage.org/webt/5j/ub/5i/5jub5itnl0k6wamohdusvk4_cea.png" alt="LCD1604 display design"></p><br><p>  The first (top) line prints a stylized icon (walking man) designed to indicate the weather on the street (went outside, walking down the street).  Invented the icon himself, so if you have a better idea (which fits 5x8 pixels), you can indicate in the comments (in the form of a byte-array).  You can practice in pixel art here the <a href="http://omerk.github.io/lcdchargen/">Custom Character Generator for HD44780 LCD Modules</a> .  The same line prints the power supply voltage of the windowed module. </p><br><p>  The second line contains ‚Äúweather in the house‚Äù and atmospheric pressure.  The house icon is standard, understandable to everyone. </p><br><p>  In the third line, <code>lcdPrintLastSensorTime()</code> prints how much time has elapsed (in seconds) since the last sensor readings, respectively, of the street sensor, and, comma, home time, were taken.  It is useful to know for sure that the weather station does not show the weather yesterday.  In fact, this is debug information and can be removed in the final version. </p><br><p>  And in the last fourth line of the screen, using the <code>lcdPrintStatus()</code> function, the status information is printed, where </p><br><ul><li>  s is a local pressure sensor </li><li>  e is the ESP8266 module </li><li>  i is a wifi connection </li><li>  w is the availability of the web server </li><li>  l - log file on SD card </li></ul><br><p>  After each of these symbols, there will be a plus or minus sign, which means no or there are errors, problems in the work of the corresponding modules. </p><br><p>  Returning to the question of the choice of iron, I will explain the advantages of choosing a text LCD1604 display over a graphic one.  The fact is that the LCD1604 modules purchased from different vendors will in most cases be the same and predictable in connection and easy to program.  What can not be said about graphic displays, although you can draw and show on them much more.  The intelligibility of the image from a distance of several meters is again better for a text display, yes, you can make a bigger font on a graphic display, but can you fit a lot on it? </p><br><p>  Further.  As soon as you fill in the sketch and make sure that everything works as it should, you can reconnect the ‚Äúmotherboard‚Äù of the Arduino Mega to an external power source.  Or leave it as it is, connected to the USB of the computer to look at all this beauty in the debug console. </p><br><p>  If you do not have all the blocks in the collection, then you can comment out unnecessary code.  Although, I repeat, it should work this way, you will simply receive error messages in the console.  How to get around this? </p><br><p>  For example, you have not yet purchased the BMP180 atmospheric pressure sensor.  In the sketch <a href="">server.ino</a> we look for the lines responsible for connecting the corresponding libraries, in our case this </p><br><pre> <code class="hljs css"><span class="hljs-selector-id"><span class="hljs-selector-id">#include</span></span> &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">Wire</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.h</span></span>&gt; <span class="hljs-selector-id"><span class="hljs-selector-id">#include</span></span> &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">Adafruit_Sensor</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.h</span></span>&gt; <span class="hljs-selector-id"><span class="hljs-selector-id">#include</span></span> &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">Adafruit_BMP085_U</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.h</span></span>&gt;</code> </pre> <br><p>  Commenting this block. </p><br><p>  Next, in the Arduino IDE, we start compiling the code (not the firmware) and look at which lines the compiler curses.  Commenting on these lines.  The operation is repeated until the code is assembled normally, without errors.  Before editing, it will be a good practice to create a copy of the sketch, so that when the correct sensor comes from sunny China, do not repeat all the operations back. </p><br><p>  References to used libraries are given in the source code.  If there is no such link, then the standard Arduino IDE library was used. </p><br><p>  Just in case, all the libraries (except the standard ones) that I used are <a href="https://github.com/tim4dev/arduino/tree/master/libraries">stored in the libraries directory</a> .  Strictly speaking, this is wrong.  You should download the latest versions of the libraries from their official repositories (with bug fixes, new features), but in case they are difficult to find, either they have already been deleted, or the old versions are not supported, only for this case I saved all the libraries used. </p><br><p>  Next comes the assembly of the behind-the-window sensor, so this part came out short so as not to mix. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/425953/">https://habr.com/ru/post/425953/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../425941/index.html">Download JivoSite dialogs via API</a></li>
<li><a href="../425943/index.html">Kotlin: digging deeper. Constructors and initializers</a></li>
<li><a href="../425945/index.html">Tips for professional use RecyclerView. Part 1</a></li>
<li><a href="../425947/index.html">Corporate Ratatouille</a></li>
<li><a href="../425951/index.html">How to break the blockchain and cryptocurrencies: 6 successful attacks "51 percent"</a></li>
<li><a href="../425955/index.html">8 interesting beta bugs iOS 12 and how we searched for them</a></li>
<li><a href="../425957/index.html">Petrol bikes or weird product search (e-commerce)</a></li>
<li><a href="../425959/index.html">A few tips on Angular</a></li>
<li><a href="../425961/index.html">‚ÄúLearning to Spring is a pointless exercise‚Äù - Josh Long, the main evangelist of Spring about the project‚Äôs internal kitchen</a></li>
<li><a href="../425963/index.html">Weather Station on Arduino from A to Z. Part 4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>