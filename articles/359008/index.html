<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As we swung at the mobile fast paced shooter: technology and approaches</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A year ago we had one project in our company - mobile shooter War Robots with relatively slow but colorful and intense battles. The game continues to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As we swung at the mobile fast paced shooter: technology and approaches</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/pu/zy/o0/puzyo0v6sjwaqr6iqbk3umd2ce0.jpeg"><br><br>  A year ago we had one project in our company - mobile shooter War Robots with relatively slow but colorful and intense battles.  The game continues to evolve, it has tens of millions of installations and players around the world, updates are constantly being released.  At some point, we wanted to make a dynamic Unity shooter with speeds comparable to Overwatch, CS: GO or Quake.  But to realize our plans for mobile platforms (primarily iOS and Android) based on War Robots with current architecture and approaches was almost unreal. <br><br>  We understood how to do this in theory - there are many articles, presentations on YouTube telling in detail how to write a shooter, <a href="https://gafferongames.com/">how to work with the network</a> , what problems arise and how to solve them.  Rocket Science is not here, all these approaches were invented 30 years ago and during this time they have not changed much.  BUT: we had no practice. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Looking ahead, I will say - we managed to realize our plans.  We have created a dynamic fast shooter for mobile platforms, which is currently in beta testing and is actively being finalized.  And I would love to share all of this.  This is the first review article listing and briefly describing virtually everything we use (please do not be confused with our <a href="https://habr.com/company/pixonic/blog/354336/">other</a> project in development, technologies and approaches in which are similar, but differ in details). <a name="habracut"></a><br><br><h3>  Simulation </h3><br>  Let's start with the gameplay simulation.  We decided to write it on <a href="https://en.wikipedia.org/wiki/Entity%25E2%2580%2593component%25E2%2580%2593system">ECS</a> - this is a data-oriented approach, in which data is separated from logic.  Data is represented as entities (Entity) and components (Components) belonging to entities.  The logic is described in Systems (Systems), which are usually traversed by the components of entities and change them, creating new components and entities. <br><br><img src="https://habrastorage.org/webt/gx/bp/2h/gxbp2h6ndfhl0xmd0gcxxytz-om.jpeg"><br><br>  We quickly wrote our ECS, because the current solutions did not suit us.  ECS allowed us to separate logic from data, as well as quickly serialize data about the world and exchange it between client and server.  We have a separate project for generating ECS-code in the common library, since  many methods in it are duplicated from component to component, for example, data serialization, their copying, comparison and delta compression. <br><br>  The same simulation code runs simultaneously on the client and the server.  This gave us the following benefits: <br><br><ol><li>  The client programmer can fully write the game features - the same logic will work on the server. </li><li>  There is no delay between the player‚Äôs action and the result of the action in the game, since  the client instantly processes the command locally (prediction).  And only if the result of the local simulation is sold with the server one, the client takes the server state of the world as a basis and rolls it. </li><li>  Learning the player (tutorial) we can simulate locally on the device, without connecting to the game server. </li><li>  When developing a feature on a project, a constantly running server is not needed.  To test logic, graphics, game design, etc.  - You can run a match locally. </li><li>  Using the common library, we were able to quickly write bots for load testing, which in time revealed various performance and memory problems on the game server. </li></ol><br><h3>  Customer </h3><br>  In addition to the prediction and rollback on the client, we use interpolation.  But not in the usual sense, because  we simulate and draw in one frame, 30 times per second, and as a matter of fact, we do not need classical interpolation. <br><br>  Whenever possible, we interpolate the status from the server in the buffer, since  On mobile platforms, packet loss can be significant, and we want to have the state of the world to draw here and now. <br><br>  <b>Client architecture</b> <br><br><img src="https://habrastorage.org/webt/49/lv/k4/49lvk4xqtf8ta-ytxmy7tjaydwi.jpeg"><br>  In client code, dependency injection is actively used.  We use <a href="https://github.com/modesttree/Zenject">Zenject</a> as the DI framework.  Specific binding settings are described in small Composition Root, which in Zenject are called Installer.  In most cases, we try to write in such a way that by turning off the specific Installer we disable the feature / view / network interaction. <br><br>  The game has several contexts and the objects there belong to a specific context, they live with it: <br><br><ul><li>  ProjectContext - objects that live the entire lifetime of the application; </li><li>  MetaContext - character selection, equipment, purchases, etc .; </li><li>  MatchContext is the context of PvP combat. </li></ul><br>  <b>Fight context</b> <br><br>  In the context of MatchContext at the presentation level of game mechanics, we use <a href="https://ru.wikipedia.org/wiki/Model-View-Presenter">MVP</a> .  The model is the data from ECS, the presenters work with them and the Unity-view part for display.  We have presenters for entities and components.  At the presentation UI level, <a href="https://ru.wikipedia.org/wiki/Model-View-ViewModel">MVVM is</a> used, described below. <br><br>  For the transport of data between the client and the server, a low-level library <a href="https://doc.photonengine.com/en-us/onpremise/current/reference/dotnet-sdk">Photon</a> comes out, from which we use a protocol based on udp.  Serialize the data yourself: we wrote custom delta compression, because  The world of the game is large, and the volume of traffic is critical for mobile devices and it would be good for us to meet the <a href="https://ru.wikipedia.org/wiki/Maximum_transmission_unit">MTU</a> so that the state of the world fit in one physical package. <br><br>  <b>Meta context</b> <br><br>  In MetaContext, for the display layer, we use <a href="https://en.wikipedia.org/wiki/Model%25E2%2580%2593view%25E2%2580%2593viewmodel">MVVM</a> and <a href="https://en.wikipedia.org/wiki/Data_binding">DataBinding</a> based on the <a href="https://github.com/Real-Serious-Games/Unity-Weld">Unity-Weld</a> library.  As a result, we do not have a custom MonoBehaviour-class for each window with a bunch of settings and UI logic, as is usually done on Unity-projects.  Instead, the UI logic is described in the ViewModel of a specific window, and the View level is represented by just one class, View (inherits MonoBehaviour) and several standard classes for data binding.  In our case, the programmer writes only logic and outputs the required data outward, and the UI designer imposes and sets up data binding for the display. <br><br>  In the context of meta, we also use the Signal-Command-Service approach, partially borrowed from the <a href="http://strangeioc.github.io/strangeioc/">StrangeIoC</a> and <a href="http://iocplus.com/tutorials/inversion-of-control-in-ioc-plus/">IoC +</a> libraries.  Now it is based on Zenject signals, but it is written in such a way that at any moment it can be rewritten to any other variant.  Thus, the <i>event-action / service</i> connection is now configured at the Installer level and is described in one line. <br><br>  The protocol of communication with meta-servers is based on <a href="https://ru.wikipedia.org/wiki/Protocol_Buffers">Protobuf</a> , <a href="http://websockets/">WebSockets is</a> used as a transport. <br><br><h3>  Third Party Solutions </h3><br>  In addition to the above, we use on the client a lot of other third-party solutions and plug-ins to speed up development: <br><br><ul><li>  <a href="https://www.fmod.com/">FMOD</a> - for working with sound.  We have a separate sound designer, he knows how to ‚Äúcook‚Äù cool sounds and music in the FMOD editor. </li><li>  <a href="https://github.com/ashoulson/VolatilePhysics">Volatile Physics</a> - client and server physics written in C #. </li><li>  <a href="https://github.com/SpaceMadness/lunar-unity-console">Lunar Console</a> - to view logs on the client, as well as test functionality. </li><li>  <a href="https://www.helpshift.com/">Helpshift</a> - to communicate with our players and collect feedback. </li><li>  <a href="https://appmetr.com/welcome">AppMetr</a> is our own analytics system. </li><li>  <a href="https://www.newtonsoft.com/json">Json.net</a> . </li><li>  And etc. </li></ul><br><h3>  Common solutions </h3><br>  We have a separate team that develops common solutions for projects.  For example: <br><br><ul><li>  we have our own PackageManager (it's better than in Unity 2018 and appeared long before it), which supports versioning and deletion.  Through it, we deliver all our other solutions to the project, as well as third-party plug-ins and libraries.  We have no problem removing and updating plugins; </li><li>  Your BuildPipeline - the ability to customize the assembly for different configurations and platforms, because  usually the steps of assembly and configuration are different + integration with TeamCity; </li><li>  client authorization module in the system; </li><li>  automatic testing system; </li><li>  third-party plug-ins adapted for us (logging, analytics; see above); </li><li>  common shaders; </li><li>  and etc. </li></ul><br><h3>  Client optimization </h3><br>  We have a lot of experience optimizing for mobile platforms.  In particular: <br><br><ul><li>  We optimize shaders. </li><li>  Reduce the build size by times by compressing textures, assembling them into atlases, reducing the number of options in shaders and more. </li><li>  We use our MeshMerger to combine static objects with one material into one object, also with merge textures. </li><li>  Using the profiler built into Unity, as well as <a href="https://jetbrains.ru/products/dottrace/">dotTrace</a> and <a href="https://jetbrains.ru/products/dotmemory/">dotMemory, we</a> optimize the code. </li><li>  We use memory pools and preallocated memory to minimize garbage collection. </li><li>  We use delta compression to reduce the size of the packets sent. </li><li>  Much more. </li></ul><br>  Some of this can be found in our previous articles <a href="https://habr.com/company/pixonic/blog/327442/">‚ÄúPost-effects in mobile games‚Äù</a> and <a href="https://habr.com/post/169451/">‚ÄúOptimization of 2d applications for mobile devices in Unity3d‚Äù</a> .  The second of these two articles is already outdated, but many tips from there work now. <br><br><h3>  Game server </h3><br>  The game server on which the battles take place is written in C #.  The udp-based Photon Network Library mentioned above is used as the network protocol.  Currently, changes to the server are made very rarely, because  All game logic is written by client programmers and it is spinning on the server. <br><br>  We also wrote a special tool that allows you to connect to the server via http and visually view the battles in real time.  In addition, you can view all entities, their components and values, as well as record the battle to play it later for test purposes.  About the game server, we will write separately in future articles. <br><br><img src="https://habrastorage.org/webt/w8/um/il/w8umilrnj3em3sxdlvhwfld8gle.jpeg"><br><br><h3>  Meta server </h3><br>  By meta, we mean a microservice system that allows you to implement such features as: player profile, purchases, matchmaking, chat, clans, etc.  All this is written by individual programmers and is used jointly on different projects.  Technologies used in the development: <br><br><ul><li>  Java is the main development language. </li><li>  <a href="http://cassandra.apache.org/">Cassandra</a> , <a href="https://www.postgresql.org/">postgres</a> - for storing player data. </li><li>  <a href="https://www.consul.io/">Consul</a> - as a service discovery, including the storage of key-value data for game settings and servers. </li><li>  <a href="https://www.rabbitmq.com/">RabbitMQ</a> - the message queue. </li><li>  <a href="https://ru.wikipedia.org/wiki/Protocol_Buffers">Protobuf</a> is a protocol between services and client. </li><li>  <a href="https://grpc.io/">gRPC</a> - for communication between services and game server. </li><li>  As well as <a href="https://netty.io/">netty</a> , <a href="https://akka.io/">akka</a> , <a href="https://logback.qos.ch/">logback</a> and more. </li></ul><br><h3>  Team </h3><br>  The game quickly grows with features and we actively attract new employees, but in general the project team consists of a core and related departments. <br><br>  The core includes client programmers, game designer, Project Manager, Product Owner and QA (testers).  Related departments include: <br><br><ul><li>  graphics programmers; </li><li>  programmers of meta-servers; </li><li>  team developing common solutions for projects; </li><li>  artists; </li><li>  animators; </li><li>  community managers; </li><li>  support; </li><li>  marketing, etc. </li></ul><br><h3>  How we are working </h3><br>  We work on <a href="https://ru.wikipedia.org/wiki/Scrum">scrum</a> .  But you should understand that everyone has their own Scrum.  We have two-week iterations, poker planning, retrospectives, demos, etc.  But at the same time releases we are not tied to the end of the sprint and there is an additional stage of release testing. <br><br>  Store the code on GitHub, do pull requests, and use <a href="https://www.jetbrains.com/upsource/">Upsource</a> for code review.  We write the code in <a href="https://www.jetbrains.com/rider/">Rider</a> and Visual Studio + <a href="https://www.jetbrains.com/resharper/">Resharper</a> . <br><br>  To build the client, as well as the development and deployment of servers, we use TeamCity and Gradle.  Client installation on a mobile device occurs in one or two clicks: <br><br><ul><li>  build the client in TeamCity by clicking Run (you can skip this step, since most of the builds take place automatically); </li><li>  installation by QR code generated for the build. </li></ul><br><h3>  Instead of conclusion </h3><br>  As you can see, nowadays a serious product uses a large number of approaches and technologies, as well as resources and specialists, and not everything is as simple as it may seem at first glance. <br><br>  In the <a href="https://habr.com/company/pixonic/blog/413729/">next article I can talk about our ECS</a> , how we wrote it and how it works, or write in the comments about what you would like to read about from the above described soon. </div><p>Source: <a href="https://habr.com/ru/post/359008/">https://habr.com/ru/post/359008/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358996/index.html">As I did programming tests, my little TIOBE and a few dollars</a></li>
<li><a href="../358998/index.html">Digital events in Moscow from 21 to 27 May</a></li>
<li><a href="../359002/index.html">Online education trends: TED, LinguaLeo, Knewton and other experiences</a></li>
<li><a href="../359004/index.html">Symbols, generators, async / await, and asynchronous iterators in JavaScript: their essence, interconnection, and use cases</a></li>
<li><a href="../359006/index.html">.NET Core 2.1 Global Tools</a></li>
<li><a href="../359010/index.html">Chrome tests Picture-in-Picture API for pop-up videos outside the browser</a></li>
<li><a href="../359012/index.html">Webinar: Planning Apache Ignite Cluster Capacity with Live Examples</a></li>
<li><a href="../359014/index.html">Hysteria around GDPR</a></li>
<li><a href="../359016/index.html">Image Enhancement with Neural Network</a></li>
<li><a href="../359022/index.html">Analysis of Zebrocy, the first-stage malware group Fancy Bear</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>