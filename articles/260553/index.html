<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sending Nginx logs to Google Analytics</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Every day several million drivers (static .exe and .zip files) are downloaded from our Download servers. To analyze user behavior, we faced the task o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sending Nginx logs to Google Analytics</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/company/driverpack/blog/260553/"><img src="https://habrastorage.org/getpro/habr/post_images/ef2/e07/09d/ef2e0709d3304f3476278718420e3ed9.png" alt="image"></a> <br><br>  Every day several million drivers (static .exe and .zip files) are downloaded from our Download servers.  To analyze user behavior, we faced the task of calculating the following parameters: when, how much, how often and even who downloads the drivers. <br><br>  The most obvious solution would be to use tools like AWstat, GoAccess, ELK stack or Splunk, and in extreme cases to collect Nginx logs. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But each option has its drawbacks: an inconvenient interface, paucity of data, complexity of setup and, most importantly, the inability to build segments in user reports. <br><br>  And then we decided to force Nginx to send events to Google Analytics on its own immediately after downloading the file.  We were also able to pass a unique ClientID to GA. <br>  As a result, we received analytics on static files to which previously it was impossible to link the GA counter. <br><br>  Under the cut ready config and examples of our system. <br><a name="habracut"></a><br>  In the <a href="http://habrahabr.ru/company/driverpack/blog/259009/">last post,</a> we talked about how to send events from the DriverPack Online application using the Analytics Measurement Protocol. <br><br>  Well, today we will show how the downloads of static files on our Download-servers. <br><br>  Information on downloads comes in "real time". <br><img src="https://habrastorage.org/getpro/habr/post_images/d39/918/901/d39918901c9aed8a2f9feea029480915.png" alt="image"><br><br><h3>  Works out of the box </h3><br>  Now you can monitor how many real downloads of our product are from servers.  Moreover, the counting of unique downloads is performed many times more accurately than if you do it by IP address, since  Each user is associated with a unique identifier - ClientID. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f29/ba8/6ea/f29ba86ea304ab24a701b63259c28197.png" alt="image"><br><br>  404 and 500 errors are tracked through events. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e81/074/e94/e81074e94264d6791c6620579a21da78.png" alt="image"><br><br>  Due to the fact that we transmit the user's real IP address to events, we can use his location when analyzing. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7b3/7b7/fb8/7b37b7fb805894a5ddb97c2089ad64cf.png" alt="image"><br><br>  Reports ‚Äúby behavior‚Äù can be trusted, since the real ClientID of the user is forwarded, which allows to evaluate: <br><ul><li>  the number of new and returned users </li><li>  the frequency of visits by the user and the time since his last visit, </li><li>  user involvement </li><li>  by what keywords the user came to our site from the very beginning. </li></ul><br>  Nginx itself sends the correct User-Agent, which makes it possible to build reports on browsers and OS.  In the report, you can find wget, with which our DriverPack Online downloads drivers, real browsers, as well as robots and all parsers. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b33/854/ab3/b33854ab3dbefb36f6a7c26cd11afa28.png" alt="image"><br><br>  For some, information on downloads from mobile devices will be very valuable. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/af9/13e/ae6/af913eae62d78792044530dd2c3e89d7.png" alt="image"><br><br>  Unfortunately, we still cannot referrer to GA, because  Nginx does not support urlencode (). <br>  Therefore, channel reports will not work (details at the end of the post). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e7e/f0f/0fb/e7ef0f0fbf4d79fc6b92a04940881513.png" alt="image"><br><br><h3>  How to configure the same?  Instruction </h3><br>  <b>1.</b> Create a GA counter with which all Download servers will work.  Or use the number of the existing counter. <br><br>  <b>2.</b> In the ‚ÄúCustom Parameters‚Äù counter settings, add special parameters: <br><ul><li>  dimension1.  The name ‚ÄúClientID‚Äù, level ‚ÄúUser‚Äù; </li><li>  dimension2.  The name ‚Äúrequest_time‚Äù, level ‚ÄúHit‚Äù; </li><li>  dimension3.  The name ‚Äúbody_bytes_sent‚Äù, level ‚ÄúHit‚Äù. </li></ul><br><br>  This will help us calculate the download speed and even the percentage of dangling downloads. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/61a/f11/369/61af11369d7b161332dd887ce2210ab1.png" alt="image"><br><br>  <b>3.</b> Create a config called "google-analytics" in the directory "/ etc / nginx /" <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#       set $gaID 'UA-XXXXXX-1'; set $mainDomain 'example.com'; #  ClientID  cookie "_ga_cid" # ,  cookie      set $cid $cookie__ga_cid; if ($cid = '') { set $cid "$request_time$request_length.$msec$connection"; } add_header Set-Cookie "_ga_cid=$cid; path=/; domain=.$mainDomain" always; set $postURI $uri; set $postRequestURI $request_uri; set $postIP $remote_addr; set $postHOST $host; #   pageview location @GAlog { resolver 8.8.8.8 ipv6=off internal; proxy_ignore_client_abort on; proxy_next_upstream timeout; proxy_pass http://google-analytics.com/collect?v=1&amp;dh=$postHOST&amp;dt=$postHOST&amp;tid=$gaID&amp;cid=$cid&amp;cd1=$cid&amp;uip=$postIP&amp;cd2=$request_time&amp;cd3=$body_bytes_sent&amp;t=pageview&amp;dp=$postURI; } #   404 location @GAlog404 { resolver 8.8.8.8 ipv6=off; internal; proxy_ignore_client_abort on; proxy_next_upstream timeout; proxy_pass http://google-analytics.com/collect?v=1&amp;tid=$gaID&amp;cid=$cid&amp;cd1=$cid&amp;uip=$postIP&amp;t=event&amp;el=nginx&amp;ec=404&amp;ea=$postHOST$postRequestURI; } #   500 location @GAlog500 { resolver 8.8.8.8 ipv6=off; internal; proxy_ignore_client_abort on; proxy_next_upstream timeout; proxy_pass http://google-analytics.com/collect?v=1&amp;tid=$gaID&amp;cid=$cid&amp;cd1=$cid&amp;uip=$postIP&amp;t=event&amp;el=nginx&amp;ec=500&amp;ea=$postHOST$postRequestURI; }</span></span></code> </pre> <br><br>  <b>4.</b> Get the configuration file ‚Äú/etc/nginx/conf.d/default.config‚Äù (using our example) <br><br><pre> <code class="bash hljs">server { include google-analytics; listen 80; server_name localhost; autoindex on; autoindex_exact_size off; access_log off; location / { root /usr/share/nginx/html; index index.html index.htm; post_action @GAlog; } error_page 404 /404.html; location = /404.html { root /usr/share/nginx/html; post_action @GAlog404; } error_page 500 502 503 504 /50x.html; location = /50x.html { root /usr/share/nginx/html; post_action @GAlog500; } }</code> </pre><br><br>  <b>5.</b> Restart nginx <br><br><pre> <code class="bash hljs">$ sudo service nginx reload</code> </pre><br><br>  <b>6.</b> Configure the counter on the site so that the ClientID is stored in the cookie (do not forget to substitute the number of your counter and the name of the main domain). <br><br><pre> <code class="bash hljs">&lt;script&gt; (<span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(i,s,o,g,r,a,m){i[<span class="hljs-string"><span class="hljs-string">'GoogleAnalyticsObject'</span></span>]=r;i[r]=i[r]||<span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span></span>(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,<span class="hljs-string"><span class="hljs-string">'script'</span></span>,<span class="hljs-string"><span class="hljs-string">'//www.google-analytics.com/analytics.js'</span></span>,<span class="hljs-string"><span class="hljs-string">'ga'</span></span>); ga(<span class="hljs-string"><span class="hljs-string">'create'</span></span>, <span class="hljs-string"><span class="hljs-string">'UA-XXXXXX-1'</span></span>, <span class="hljs-string"><span class="hljs-string">'auto'</span></span>); ga(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(tracker) { var clientId = tracker.get(<span class="hljs-string"><span class="hljs-string">'clientId'</span></span>); // Get clientId from Google Analytics document.cookie = <span class="hljs-string"><span class="hljs-string">"_ga_cid="</span></span> + clientId + <span class="hljs-string"><span class="hljs-string">"; path=/; domain=.&lt;  &gt;"</span></span>; // Write cookie <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> web-server ga(<span class="hljs-string"><span class="hljs-string">'set'</span></span>, <span class="hljs-string"><span class="hljs-string">'dimension1'</span></span>, clientId); // Write clientId <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> custom dimension }); ga(<span class="hljs-string"><span class="hljs-string">'require'</span></span>, <span class="hljs-string"><span class="hljs-string">'displayfeatures'</span></span>) ga(<span class="hljs-string"><span class="hljs-string">'send'</span></span>, <span class="hljs-string"><span class="hljs-string">'pageview'</span></span>); &lt;/script&gt;</code> </pre><br><br><h3>  Finally about accuracy </h3><br>  Statistics accuracy up to 99%!  We analyzed several files and compared GA data with log data. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/22d/b88/1d8/22db881d850aea9bee9e9960acef3acf.png" alt="image"><br><br>  The comparison shows that GA calculates unique downloads even more accurately than we can do it with our hands. <br><br><h4>  disadvantages </h4><br>  The script works fine and 100% meets our requirements, but you can add several improvements to it: <br><ol><li>  The script loads the server a little, but for us it is not critical at all. </li><li>  Nginx does not support urlencode (), so links like <a href="http://example.com/%3FSomeOptions">example.com/?SomeOptions</a> will beat.  One way to solve this problem is to use a lua script. </li><li>  The referrer is not passed to the GA parameter (urlencode () must also be used). </li><li>  In Nginx 1.8, the $ content_length variable does not work, so we cannot transfer the file size to GA.  This parameter would allow to make reports containing information about the percentage of under-downloaded files. </li><li>  Send service information from Nginx.  For example, the number of connections, etc. </li><li>  It would be possible to send download time directly to Google Analytics using the &amp; plt parameter, but Nginx returns the time in seconds, and GA does not like this format (milliseconds are expected).  Therefore, you have to send this data to dimension2. </li><li>  The script uses the undocumented post_action function.  There is a risk that this feature will be eliminated in newer versions. </li></ol><br><br>  Friends, please write in the comments, what problems will help you solve the described method? <br>  Real-world examples of use will be very helpful in further improving <a href="http://drp.su/ru/">our product</a> . <br><br>  Well, in advance - thanks! </div><p>Source: <a href="https://habr.com/ru/post/260553/">https://habr.com/ru/post/260553/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../260541/index.html">Zabbix Moscow Meetup in Badoo</a></li>
<li><a href="../260543/index.html">How to pass "test free data recovery software" (part 1)</a></li>
<li><a href="../260545/index.html">The guys who make the talking robot for a smart home, distribute fees</a></li>
<li><a href="../260547/index.html">The best usability solutions for online shopping: we make the client happy</a></li>
<li><a href="../260549/index.html">4 scripts to handle the most complex Email from clients</a></li>
<li><a href="../260557/index.html">XARA vulnerabilities in OS X and iOS</a></li>
<li><a href="../260559/index.html">AngularJS directive for remembering e-mail</a></li>
<li><a href="../260561/index.html">ECMAScript 2015 official release</a></li>
<li><a href="../260565/index.html">TEETH based on Intel Edison will find a way to motivate you to brush your teeth and send a report to the cloud</a></li>
<li><a href="../260569/index.html">Jii: Active Record for Node.js with API from Yii 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>