<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Billing in SaaS applications on Ruby on Rails. Continued about 3-D Secure</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, community! 

 Today I will tell you, as promised in the last article , about the implementation of 3-D Secure authentication in SaaS applicatio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Billing in SaaS applications on Ruby on Rails. Continued about 3-D Secure</h1><div class="post__text post__text-html js-mediator-article">  Hello, community! <br><br>  Today I will tell you, as promised <a href="http://habrahabr.ru/company/lpcloud/blog/236453/">in the last article</a> , about the implementation of 3-D Secure authentication in SaaS applications.  3-D Secure adds another authentication step for online payments.  Usually there is a redirect to the website of the issuing bank, where the user is prompted to enter a verification SMS-pin to confirm the payment.  This process is terribly inconvenient, your customers are required to leave your service in order to pass this authentication. <br><br>  In <a href="http://lpcloudapp.com/">LPCloud,</a> we decided to do 3-D Secure frame authentication so that the user does not leave our service. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/38b/c25/6fb/38bc256fb25544ebba8997703151f663.png"><a name="habracut"></a><br><br><h5>  Controller </h5><br><br><pre><code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">purchase</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updating_card</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">current_user</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">account</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">present?</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">options</span></span></span><span class="hljs-function"> = { :</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IpAddress</span></span></span><span class="hljs-function"> =</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">&gt;</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ip</span></span></span><span class="hljs-function">, :</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AccountId</span></span></span><span class="hljs-function"> =</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">&gt;</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">current_user</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">email</span></span></span><span class="hljs-function">, :</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Name</span></span></span><span class="hljs-function"> =</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">&gt;</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">params</span></span></span><span class="hljs-function">[:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">name</span></span></span><span class="hljs-function">], :</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">JsonData</span></span></span><span class="hljs-function"> =</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">&gt;</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">plan</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">params</span></span></span><span class="hljs-function">[:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">plan</span></span></span><span class="hljs-function">], </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updating_card</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updating_card</span></span></span><span class="hljs-function"> }.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">to_json</span></span></span><span class="hljs-function">, :</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Currency</span></span></span><span class="hljs-function"> =</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">&gt;</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">current_subscription</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">currency</span></span></span><span class="hljs-function">, :</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Description</span></span></span><span class="hljs-function"> =</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">&gt;</span></span></span><span class="hljs-function"> "</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Storing</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">card</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">details</span></span></span><span class="hljs-function">" } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">current_subscription</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">plan</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Plan</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(params[</span></span><span class="hljs-symbol"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:plan</span></span></span></span><span class="hljs-function"><span class="hljs-params">])</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> params[<span class="hljs-symbol"><span class="hljs-symbol">:plan</span></span>].present? amount = updating_card ? <span class="hljs-number"><span class="hljs-number">1</span></span> : current_subscription.amount response = gateway.purchase(params[<span class="hljs-symbol"><span class="hljs-symbol">:cryptogram</span></span>], amount, options, <span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-comment"><span class="hljs-comment"># making response as action controller params </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@params</span></span></span><span class="hljs-comment"> = parametrize(response.params) if response.success? resp = { json: success_transaction(</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@params</span></span></span><span class="hljs-comment">) } else # if 3d-secure needed if </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@params</span></span></span><span class="hljs-comment"> and </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@params</span></span></span><span class="hljs-comment">['PaReq'].present? resp = { json: { response: </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@params</span></span></span><span class="hljs-comment">, type: '3ds' }, status: 422 } else resp = { json: { response: response, type: 'error' }, status: 422 } end end render resp end private def gateway ActiveMerchant::Billing::CloudpaymentsGateway.new(public_id: configatron.cloudpayments.public_id, api_secret: configatron.cloudpayments.api_secret) end</span></span></code> </pre> <br><br>  If your client‚Äôs card requires 3-DS, then <a href="http://cloudpayments.ru/">cloudpayments</a> returns the necessary parameters for authentication, including the url of the page on the issuing bank‚Äôs website, where SMS-pin is entered, which is what we open in the frame.  Further, after passing the authentication, the website of the issuing bank, right in the frame, will redirect the client to your website, where you can display a payment message.  And what if after passing the authentication you want to automatically close the popup with the frame and display the alert? <br><br><h5>  Controller </h5><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post3ds</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">response</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gateway</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check_3ds</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(params[</span></span><span class="hljs-symbol"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:MD</span></span></span></span><span class="hljs-function"><span class="hljs-params">], params[</span></span><span class="hljs-symbol"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:PaRes</span></span></span></span><span class="hljs-function"><span class="hljs-params">])</span></span></span></span> @params = parametrize(response.params) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> response.success? resp = success_transaction(@params) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> resp = { <span class="hljs-symbol"><span class="hljs-symbol">message:</span></span> response.message } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @response = { <span class="hljs-symbol"><span class="hljs-symbol">response:</span></span> resp, <span class="hljs-symbol"><span class="hljs-symbol">success:</span></span> response.success? } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><br><h5>  View </h5><br>  Just pass the response results from the cloudpayments server to the js variable and call the function in parent. <br><br><pre> <code class="ruby hljs"><span class="hljs-symbol"><span class="hljs-symbol">javascript:</span></span> var resp = JSON.parse(<span class="hljs-string"><span class="hljs-string">'</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{@response.to_json.html_safe}</span></span></span><span class="hljs-string">'</span></span>); parent.window.showMessage(resp);</code> </pre><br><br><h5>  Client function </h5><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.showMessage = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">) </span></span>{ alert(r.response.message); }</code> </pre><br><br>  That's all.  If there are suggestions how to improve this method I will be glad to hear you in the comments. </div><p>Source: <a href="https://habr.com/ru/post/240573/">https://habr.com/ru/post/240573/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../240557/index.html">Using the proxy pattern to organize caching in PHP</a></li>
<li><a href="../240559/index.html">Pricing model for SaaS: more money - more problems</a></li>
<li><a href="../240561/index.html">Methods in primitive types of PHP</a></li>
<li><a href="../240565/index.html">Semi-automatic registration of unit tests on pure C</a></li>
<li><a href="../240571/index.html">Device for laying additional air lines</a></li>
<li><a href="../240575/index.html">Partnership Docker and Microsoft: a lot of announcements</a></li>
<li><a href="../240577/index.html">Russian OVP - Telebreeze</a></li>
<li><a href="../240579/index.html">15 e-commerce trends for 2015</a></li>
<li><a href="../240581/index.html">Python Tools 2.1 for Visual Studio released</a></li>
<li><a href="../240583/index.html">12 questions for you about working with people</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>