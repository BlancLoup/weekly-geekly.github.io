<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using Database Connections in Multi-threaded Qt Applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When writing a multi-service system in bark, each service must be multithreaded, faced with the problem of using a database connection. Services are d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using Database Connections in Multi-threaded Qt Applications</h1><div class="post__text post__text-html js-mediator-article">  When writing a multi-service system in bark, each service must be multithreaded, faced with the problem of using a database connection.  Services are developed in QT, so they used the QtSql module to interact with the database. <br><br><h4>  Problems </h4><br><ol><li>  Each thread requires its own database connection (QSqlDatabase).  When using one connection from different streams, a segmentation error occurs. </li><li>  Since  at the current time it is possible to keep open a limited number of connections to the database, it is necessary to implement the capture, release and waiting for the connection by threads. </li><li>  In the context of the flow, in order to work properly with transactions, you need to work with only one connection.  For example: Entity order contains Entity entities.  When you save the order must be saved all the goods.  If an exceptional situation arises while saving the goods, then the whole saving transaction must cancel the order. </li><li>  The library should be able to work with several databases simultaneously, and of different types (Mysql, PostgreSQL) </li></ol><br><br><h4>  Decision </h4><br>  As a result, we got 3 classes: <br><ul><li>  <b>Connection</b> - class wrapper responsible for working with the database: Connection, execution and processing of query results. </li><li>  <b>ConnectionManager</b> is a singleton connection buried in itself and is responsible for issuing and releasing connections. </li><li>  <b>ManagedConnection</b> - class wrapper to automate the capture and release of the connection. </li></ul><br><a name="habracut"></a><br><h5>  Connection </h5><br>  In the class constructor, the QSqlDatabase _conn member is initialized and the connection is opened (open): <br><pre><code class="cpp hljs">Connection::Connection(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString&amp; ident, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString&amp; driver, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString&amp; dbHost, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString&amp; dbName, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString&amp; dbUser, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString&amp; dbPassword, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dbPort) : _threadId(<span class="hljs-number"><span class="hljs-number">0</span></span>), _countRef(<span class="hljs-number"><span class="hljs-number">0</span></span>), _countBegins(<span class="hljs-number"><span class="hljs-number">0</span></span>), _retryCount(<span class="hljs-number"><span class="hljs-number">0</span></span>),_invalid(<span class="hljs-literal"><span class="hljs-literal">false</span></span>) { _conn = QSqlDatabase::addDatabase(driver, ident); _conn.setHostName(dbHost); _conn.setDatabaseName(dbName); _conn.setUserName(dbUser); _conn.setPassword(dbPassword); _conn.setPort(dbPort), open(); }</code> </pre> <br>  Basic prototypes method for working with DB <br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exec</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(QSqlQuery&amp; sql)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exec</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* sql)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exec</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QString&amp; sql)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *   ,         */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchCol</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(QSqlQuery&amp; sql,QList&lt;T&gt;&amp; result)</span></span></span><span class="hljs-function">... </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">template</span></span></span><span class="hljs-function"> &lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typename</span></span></span><span class="hljs-function"> T&gt; QList&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchCol</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(QSqlQuery&amp; sql)</span></span></span><span class="hljs-function"> ... </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">template</span></span></span><span class="hljs-function"> &lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typename</span></span></span><span class="hljs-function"> T&gt; QList&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchCol</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* sql)</span></span></span><span class="hljs-function"> ... </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">template</span></span></span><span class="hljs-function"> &lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typename</span></span></span><span class="hljs-function"> T&gt; QList&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchCol</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QString&amp; sql)</span></span></span><span class="hljs-function"> ... </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">/* *         */</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">template</span></span></span><span class="hljs-function"> &lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typename</span></span></span><span class="hljs-function"> T&gt; T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchOne</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(QSqlQuery&amp; sql, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params">* ok = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> ... </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">template</span></span></span><span class="hljs-function"> &lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typename</span></span></span><span class="hljs-function"> T&gt; T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchOne</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QString&amp; sql, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params">* ok = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> ... </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">template</span></span></span><span class="hljs-function"> &lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typename</span></span></span><span class="hljs-function"> T&gt; T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchOne</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* sql, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params">* ok = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> ... </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">/* *     */</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchRow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(QSqlQuery&amp; sql,QVariantMap&amp; res)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">QVariantMap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchRow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QString&amp; sql)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">QVariantMap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchRow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* sql)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">QVariantMap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchRow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(QSqlQuery&amp; sql)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *     */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(QSqlQuery&amp; sql,QList&lt;QVariant&gt;&amp; result)</span></span></span></span>; QList&lt;QVariant&gt; query(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* sql); QList&lt;QVariant&gt; query(QSqlQuery&amp; sql); QList&lt;QVariant&gt; query(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString&amp; sql); <span class="hljs-comment"><span class="hljs-comment">/*  query */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(QSqlQuery&amp; sql,QList&lt;QVariant&gt;&amp; result)</span></span></span></span>; QList&lt;QVariant&gt; fetchAll(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* sql); QList&lt;QVariant&gt; fetchAll(QSqlQuery&amp; sql); QList&lt;QVariant&gt; fetchAll(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString&amp; sql);</code> </pre><br>  Since  in QT, to work with a database, QSqlQuery is used, which depends on QSqlDatabase, then it is strictly necessary to use methods for creating queries: <br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-function">QSqlQuery </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> QSqlQuery(_conn);} <span class="hljs-function"><span class="hljs-function">QSqlQuery </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QString&amp; sql)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> QSqlQuery(sql, _conn); }</code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  ManagedConnection </h5><br>  The class "links" Connection and ConnetcionManager. <br>  When an object is created, an attempt is made to request a connection from the ConnetcionManager by identifier (for example, db1conn).  After capture, the member pointer to the connection is initialized.  For convenience, the operator is overridden -&gt; so that Connection methods are called. <br>  Typically, an application requires connecting to only one database.  Therefore, it was customary to give it the identifier ‚Äúdefault‚Äù. <br>  The typedef type of ManagedConnection DConn will allow to get a connection.  for example <br><pre> <code class="cpp hljs">DB::DConn conn; <span class="hljs-comment"><span class="hljs-comment">// DB::ManagedConnection conn("default'); //   DB::ManagedConnection c1("db1conn); DB::ManagedConnection c2("db2conn);</span></span></code> </pre><br><br>  Take for example the call stack on pseudocode.  Order (Order) saves its data in the database and causes its member to save (there are a lot of them in the IDAL).  Item saves its data in the database and causes its Data member to be saved.  Data saves its data in the database.  As a result, the nesting on 3 levels: <br><pre> <code class="cpp hljs">Order : save(){ DB::DBConn conn; <span class="hljs-comment"><span class="hljs-comment">// . countRef = 1 conn-&gt;query('INSERT INTO order...'); item-&gt;save(); Item:save() { DB::DBConn conn;// . countRef = 2 conn-&gt;query('INSERT INTO item...'); data-&gt;save(); Data:save() { DB::DBConn conn;// . countRef = 3 conn-&gt;query('INSERT INTO data...'); // ,   ~ManagedConnection countRef = 2 } // ,   ~ManagedConnection countRef = 1 } // ,   ~ManagedConnection countRef = 0 } } }</span></span></code> </pre><br><h5>  Connectionmanager </h5><br>  Keep the settings for the connection: host, port, database type, etc. <br>  For example, for an application, you must have a connection with the db1 database of the MySQL type and db2 of the PostgresSQL type.  The configuration in the configuration file will look like this: <br><pre> <code class="apache hljs">[<span class="hljs-attribute"><span class="hljs-attribute">database</span></span>] size = 2 ; 1\ident=db1conn ; ,    MySQL 1\driver=QMYSQL ;  1\host=localhost ;   1\name=db1 ;  1\user=db1_user ; 1\password=lol ; 1\port=3306 ; -         1\max_count = 30 2\ident=db2conn 2\driver=QPSQL 2\host=localhost 2\name=test 2\user=postgres 2\password= 2\port=5432 2\max_count = 30</code> </pre><br>  When the application starts, the config is read and converted to QVariantMap. <br>  An example of initialization in Application <br><pre> <code class="cpp hljs">Application::Application(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&amp; argc, <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>** argv): QCoreApplication(argc, argv) { ... QVariantMap stgs = settings(); DB::ConnectionManager::init(stgs); ... }</code> </pre><br><br>  The static member of the ConnectionManager is initialized from the config (static QMap &lt;QString, ConnectionManager *&gt; _instances;) <br>  The identifier from the ident config will be used as the key in the map. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ConnectionManager::init(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QVariantMap&amp; settings) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> size = settings.value(<span class="hljs-string"><span class="hljs-string">"database/size"</span></span>).toInt(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt;= size; ++i) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString ident = settings.value(QString(<span class="hljs-string"><span class="hljs-string">"database/%1/ident"</span></span>).arg(i), <span class="hljs-string"><span class="hljs-string">"default"</span></span>).toString(); ConnectionManager* inst = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConnectionManager( ident, settings.value(QString(<span class="hljs-string"><span class="hljs-string">"database/%1/driver"</span></span>).arg(i)).toString(), ... ); _instances[ident] = inst; Log::info(QString(<span class="hljs-string"><span class="hljs-string">"ConnectionManager::init: [%1] [%2@%3:%4] "</span></span>).arg(inst-&gt;_driver).arg(inst-&gt;_dbUser).arg(inst-&gt;_dbHost).arg(inst-&gt;_dbPort)); } }</code> </pre><br><br>  The identifier from the ident config will be used as the key in the map. <br>  The main class method getConnection (explained in the code comments): <br><br><pre> <code class="cpp hljs">Connection* ConnectionManager::getConnection() { Connection* conn = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(count++ &lt; MAX_RETRY_GET_CONN_COUNT) { <span class="hljs-keyword"><span class="hljs-keyword">pthread_t</span></span> thread_id = pthread_self(); <span class="hljs-comment"><span class="hljs-comment">//  ,           { QMutexLocker mlocker(&amp;_mutex); for (int i = 0; i &lt; _pool.size(); ++i) { conn = _pool.at(i); //    if (conn &amp;&amp; conn-&gt;threadID() == thread_id &amp;&amp; conn-&gt;isValid()) { //         conn-&gt;lock(); //Log::debug(QString("ConnectionManager::getConnection          thread [%1])").arg(conn-&gt;name())); return conn; } } } //       ,       { QMutexLocker mlocker(&amp;_mutex); for (int i = 0; i &lt; _pool.size(); ++i) { conn = _pool.at(i); if (conn &amp;&amp; !conn-&gt;isLocked() &amp;&amp; conn-&gt;isValid() ) { //Log::debug(QString("ConnectionManager::getConnection    [%1])").arg(conn-&gt;name())); //   conn-&gt;lock(); return conn; } } } //       { QMutexLocker mlocker(&amp;_mutex); if(_currentCount &lt; _maxCount) { //      //    //try { conn = new Connection( QString("%1_%2").arg(_ident).arg(_currentCount), _driver, _dbHost, _dbName, _dbUser, _dbPassword,_dbPort ); _currentCount++; conn-&gt;lock(); _pool.append(conn); return conn; /*} catch(exc::Message&amp; ex) { delete conn; throw ex; }*/ } else { //   //Log::warn("  - [%d]    DB  [%d]",_maxCount,count); /*for (int i = 0; i &lt; _pool.size(); ++i) { conn = _pool.at(i); if (!conn-&gt;isValid() &amp;&amp; !conn-&gt;isLocked() ) { removeConnection(conn); break; } }*/ } } // , //     sleep(2); } Log::crit(" %d       ",MAX_RETRY_GET_CONN_COUNT); { QMutexLocker mlocker(&amp;_mutex); for (int i = 0; i &lt; _pool.size(); ++i) { conn = _pool.at(i); if (!conn-&gt;isValid() &amp;&amp; !conn-&gt;isLocked()) { removeConnection(conn); break; } } } throw exc::Message("     "); //return 0; }</span></span></code> </pre><br><h4>  Work logic </h4><br>  ConnetctionManager is initialized from the config in order to know with what settings to create connections, and what is their maximum number. <br>  When creating a DB :: ManagedConnection instance, the ConnetctionManager is accessed and an attempt is made to get a pointer to the Connetction from the ConnetctionManager :: getConnetction. <br>  In ConnetctionManager :: getConnetction using several attempts occurs: <br><ol><li>  An attempt to take from the drive a connection whose thread_id matches the current one.  If found then return by increasing the refCount of the connection by 1 </li><li>  Attempt to take a free connection from the drive. If it is found to return, increasing the connection refCount by 1 </li><li>  If all connections are busy and the max is not reached.  limit, then create a new connection, put it in the pool and return </li></ol><br>  After deleting an instance of the DB :: ManagedConnection class, the connection's refCount decreases.  If refCount == 0, the connection becomes available for capturing other streams. <br><br><h3>  Usage example </h3><br><br><pre> <code class="cpp hljs">QList&lt;QVariant&gt; Bank::banksByAccountNumber(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString&amp; accountNumber) { QList&lt;QVariant&gt; res; DB::ManagedConnection conn; foreach(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QVariant&amp; row, conn-&gt;fetchAll( <span class="hljs-string"><span class="hljs-string">"SELECT `real` as state ,namen as name,namep as full_name,"</span></span> <span class="hljs-string"><span class="hljs-string">"newnum as bik,ksnp as korr_acc,okpo as okpo,nnp as city,"</span></span> <span class="hljs-string"><span class="hljs-string">"ind as zip, adr as address,regn as regnum, telef as phones FROM `bankdinfo` WHERE `real` = '' ORDER BY RAND()"</span></span> )) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(isBelongToBank((row.toMap()[<span class="hljs-string"><span class="hljs-string">"bik"</span></span>]).toString(),accountNumber)) { res.append(row); } } Log::debug(<span class="hljs-string"><span class="hljs-string">"Banks found %d"</span></span>,res.size()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; }</code> </pre><br><br>  <a href="https://github.com/zordon13/db-connection/tree/master/database">Sources on Github</a> <br>  <b>UPD</b> <br>  At peak load, a maximum number of connections is created (specified in the config), but after a load drops, the connections do not close and take up resources.  It turns out that it is necessary to launch a thread that will close the connections, leaving their optimal number, only it is not clear on the basis of what criteria it will determine at the moment this number. <br>  During the operation, we faced the fact that MySQL breaks the connection once a day, and it happens that the DBMS must be reloaded.  For application fault tolerance, we had to add not very flexible code in Connection: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Connection::tryRetry(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QSqlError&amp; err) { <span class="hljs-comment"><span class="hljs-comment">//    bool needRecon = false; QRegExp mrx("MySQL server has gone away"); if (err.type() == QSqlError::NoError &amp;&amp; qstrcmp(_conn.driver()-&gt;handle().typeName(), "PGconn*") == 0) { needRecon = true; } else if ( /*(qstrcmp(_conn.driver()-&gt;handle().typeName(), "MYSQL*") == 0)*/ err.text().contains(mrx)) { needRecon = true; } bool ok = false; if (needRecon) { Log::err( "     - GONE AWAY.   ..."); bool lol = true; while(lol) { if (_retryCount &gt;= MAX_RETRY_COUNT) { _retryCount = 0; _invalid = true; Log::crit( "       ."); throw exc::Message("     "); } lol = !reconnect(); if(!lol) { ok = true; _retryCount = 0; break; } _retryCount++; sleep(2); } } //_retryCount return ok; } void Connection::query(QSqlQuery&amp; sql, QList&lt;QVariant&gt;&amp; result) { if (!sql.exec()) { if (tryRetry(sql.lastError())) { if(isValid()) { QSqlQuery qs = createQuery(); cpQuery(sql, qs); Log::warn("   ..."); return query(qs, result); } else { throw exc::Message("    ");; } } else throw exc::Sql(sql); } ... }</span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/164377/">https://habr.com/ru/post/164377/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../164361/index.html">SQL is flexible or why I‚Äôm afraid of NoSQL</a></li>
<li><a href="../164363/index.html">Samsung's latest novelty: GALAXY Grand</a></li>
<li><a href="../164367/index.html">Parallax effect for live wallpaper on Android</a></li>
<li><a href="../164371/index.html">NIST SP 800: Information Security Library</a></li>
<li><a href="../164373/index.html">Marmalade announces support for Windows Phone 8</a></li>
<li><a href="../164379/index.html">How the owner of a team Dropbox account can destroy your Dropbox account</a></li>
<li><a href="../164381/index.html">A simple in-circuit programmer LPC microcontroller. Features in-circuit programming. Part two</a></li>
<li><a href="../164383/index.html">Microsoft Reporting Services tips for beginners. Part 2</a></li>
<li><a href="../164385/index.html">LED Christmas tree on the Arduino in one evening</a></li>
<li><a href="../164391/index.html">Logic - weekly selection of gaming and IT industry news ‚Ññ7</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>