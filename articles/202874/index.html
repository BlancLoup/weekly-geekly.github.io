<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tiny Tron on JS (30 lines of code)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Actually, continuing the trend of the week. 

 The first time I read a tiny excel, I wanted to write something like that - small and cool. Seeing a sn...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tiny Tron on JS (30 lines of code)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/c32/6f8/1b5/c326f81b58860544152671475c130abc.png" alt="image"><br><br>  Actually, continuing the trend of the week. <br><br>  The first time I read a <a href="http://habrahabr.ru/post/202304/">tiny excel, I</a> wanted to write something like that - small and cool.  Seeing a snake - I realized that it was worth writing a game.  After reading the comments - ‚ÄúI want pakman with brand sounds,‚Äù I decided that I would write ‚Äúsiteman‚Äù on canvas, with web audio api (and waka-waka-waka) and devouring pages. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But this was not destined to come true, more - under the cut. <br><a name="habracut"></a><br>  For those who are not interested to read it all: control - arrows, you can run on any page: <br>  <a href="http://jsfiddle.net/WDL3Y/1/">jsfiddle</a> , source. <br><div class="spoiler">  <b class="spoiler_title">source</b> <div class="spoiler_text"><pre><code class="javascript hljs">siteman = { <span class="hljs-string"><span class="hljs-string">'settings'</span></span>:{<span class="hljs-string"><span class="hljs-string">'size'</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">'speed'</span></span> : <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">'time'</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>().getTime(), <span class="hljs-string"><span class="hljs-string">'width'</span></span>:<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.innerWidth, <span class="hljs-string"><span class="hljs-string">'height'</span></span>:<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.innerHeight}, <span class="hljs-string"><span class="hljs-string">'coord'</span></span>:{<span class="hljs-string"><span class="hljs-string">'x'</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span> + <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-string"><span class="hljs-string">'y'</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span> + <span class="hljs-number"><span class="hljs-number">20</span></span>}, <span class="hljs-comment"><span class="hljs-comment">// plus siteman size 'direction':{ 'current':{'x': 0.75 * Math.PI, 'y' : 1.75 * Math.PI, 'clock' : false, 'calc_x' : function(){ return siteman.coord.x + siteman.settings.speed}, 'calc_y' : function(){return siteman.coord.y}}, 37:{'x': 0.75 * Math.PI, 'y' : 1.75 * Math.PI, 'clock' : true, 'calc_x' : function(){ return siteman.coord.x - siteman.settings.speed}, 'calc_y' : function(){return siteman.coord.y}}, 38:{'x': 1.75 * Math.PI, 'y' : 0.75 * Math.PI, 'clock' : false, 'calc_x' : function(){ return siteman.coord.x}, 'calc_y' : function(){return siteman.coord.y - siteman.settings.speed}}, 39:{'x': 0.75 * Math.PI, 'y' : 1.75 * Math.PI, 'clock' : false, 'calc_x' : function(){ return siteman.coord.x + siteman.settings.speed}, 'calc_y' : function(){return siteman.coord.y}}, 40:{'x': 1.75 * Math.PI, 'y' : 0.75 * Math.PI, 'clock' : true, 'calc_x' : function(){ return siteman.coord.x}, 'calc_y' : function(){return siteman.coord.y + siteman.settings.speed}} }, 'ctx':document.body.appendChild((function(element){element.width=window.innerWidth; element.height=window.innerHeight; element.style.cssText='background:rbga(60, 40, 20, 1); position:absolute; top:0; z-index: 100000000;'; return element;})(document.createElement('canvas'))).getContext("2d"), 'h_ctx':new function(){this.chain = function(method, args){siteman.ctx[method].apply(siteman.ctx, args); return this;}}, 'checkCollision':function(data){return data[0] == 128 &amp;&amp; data[1] == 128 &amp;&amp; data[2] == 128;} }; siteman.ctx.fillStyle = "rgb(128, 128, 128)"; siteman.h_ctx.chain('beginPath').chain('fillRect', [0, 0, window.innerWidth, window.innerHeight]); (function game_loop(){ siteman.coord = {'x':siteman.direction.current.calc_x(), 'y':siteman.direction.current.calc_y()}; siteman.ctx.fillStyle = "rgb(255, 255, 0)"; siteman.h_ctx.chain('beginPath').chain('arc', [siteman.coord.x, siteman.coord.y, siteman.settings.size, 0.25 * Math.PI, 1.25 * Math.PI, siteman.direction.current.clock]).chain('fill') siteman.h_ctx.chain('beginPath').chain('arc', [siteman.coord.x, siteman.coord.y, siteman.settings.size, siteman.direction.current.x, siteman.direction.current.y, siteman.direction.current.clock]).chain('fill'); var offset_x = siteman.settings.size * (siteman.coord.x != siteman.direction.current.calc_x() ? (siteman.direction.current.clock ? -1 : 1) : 0), offset_y = siteman.settings.size * (siteman.coord.y != siteman.direction.current.calc_y() ? (siteman.direction.current.clock ? 1 : -1) : 0); if(!siteman.checkCollision(siteman.ctx.getImageData(siteman.coord.x + offset_x, siteman.coord.y + offset_y,1,1).data)){ alert('Game over. Your score is: '+(new Date().getTime() - siteman.settings.time)+'. Siteman size: '+siteman.settings.size+' and speed:'+siteman.settings.speed+', map width: '+siteman.settings.width+' and height: '+siteman.settings.height); }else{ setTimeout(function(){game_loop();}, 1000 / 60); //requestAnimationFrame(game_loop); } })(); document.addEventListener('keydown', function (e) {siteman.direction.current=siteman.direction[e.keyCode] || siteman.direction.current}, false);</span></span></code> </pre> <br></div></div><br><br><h4>  How did it all start? </h4><br>  Long before the ‚Äúmarathon of 30 line applications on js‚Äù I wanted to write my own mini-game - master new technologies and ‚Äújoin the game-girl.‚Äù  But, having understood that the resulting code, <s>complete shit</s> smells bad and you need to rewrite everything - like you lost the enthusiasm to continue, although the skills from working with canvass remained.  Yes, and I do not leave hopes to continue. <br><br>  But now here is the occasion to do something small and interesting.  The choice fell on pakman who devours the site leaving behind blackness, but at the end it turned out to be a tron ‚Äã‚Äãtraining room for one player. <br><br><h4>  What is it all about? </h4><br>  I spent about 3 days on a small pile of mathematics (for the first time over the construction of a segment of the desired length on the canvas), calculating collisions, drawing shapes of the desired shape, and other techniques of normal and abnormal programming.  In short, because most of the code is trivial. <br><br>  It agree, some lines __ long, for example a line with creation canvas (11).  But, consider that this is an abstraction, such as ‚Äúdraw a siteman‚Äù, ‚Äúbuild a canvas‚Äù, ‚Äúoutput the result‚Äù.  It would also be possible to reduce the length of some variables, but we are not playing JS1K, right? <br><br><h4>  What is this code interesting? </h4><br>  0) Logic: <br>  it is simple - we initialize the siteman, define its properties, draw the canvas on top of the page, press all the keys and ‚Äúlisten‚Äù to only certain ones, also display the siteman, compute collisions in the main loop. <br><br>  1) Chaining implementation: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    source 'h_ctx':new function(){this.chain = function(method, args){siteman.ctx[method].apply(siteman.ctx, args); return this;}} /*     this    -   --,  this     window,       .  ,  this      ,   h_ctx     ,        - siteman.ctx[method].apply(siteman.ctx, args)     "  ", .apply -  ,    this   .  ""  */ siteman.h_ctx.chain('beginPath').chain('arc'... /*    */ siteman.ctx.beginPath(); siteman.ctx.arc(... /*   30         */</span></span></code> </pre><br><br>  2) Siteman drawing.  It consists of two filled perpendicular semi-circles (thanks to <a href="http://simeonvisser.hubpages.com/hub/HTML5-Tutorial-Drawing-Circles-and-Arcs">this article</a> for the tip, and one of them is ‚Äústatic‚Äù (only the order of filling changes clockwise or counterclockwise), the other changes coordinates when the direction of movement changes (up + down - left + to the right), in fact, in this way it turned out to be quite compact to accommodate a drawing of a pacman that looks in all directions. <br><br>  At first, I wanted to describe the state of movement as normal, then I realized that it takes up too much space, so I wrote down all the necessary formulas directly into the object containing the direction of movement.  As a result, we have what we have <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/*  -   -*/</span></span> siteman.h_ctx.chain(<span class="hljs-string"><span class="hljs-string">'beginPath'</span></span>) .chain(<span class="hljs-string"><span class="hljs-string">'arc'</span></span>, [siteman.coord.x, siteman.coord.y, siteman.settings.size, <span class="hljs-number"><span class="hljs-number">0.25</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI, <span class="hljs-number"><span class="hljs-number">1.25</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI, siteman.direction.current.clock]) .chain(<span class="hljs-string"><span class="hljs-string">'fill'</span></span>) <span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> siteman.h_ctx.chain(<span class="hljs-string"><span class="hljs-string">'beginPath'</span></span>) .chain(<span class="hljs-string"><span class="hljs-string">'arc'</span></span>, [siteman.coord.x, siteman.coord.y, siteman.settings.size, siteman.direction.current.x, siteman.direction.current.y, siteman.direction.current.clock]) .chain(<span class="hljs-string"><span class="hljs-string">'fill'</span></span>);</code> </pre><br><br>  3) the calculation of collisions: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* .  ""   -   ""    ,  ,  siteman              ,     "" ,                  */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> offset_x = siteman.settings.size * (siteman.coord.x != siteman.direction.current.calc_x() ? (siteman.direction.current.clock ? <span class="hljs-number"><span class="hljs-number">-1</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>) : <span class="hljs-number"><span class="hljs-number">0</span></span>), offset_y = siteman.settings.size * (siteman.coord.y != siteman.direction.current.calc_y() ? (siteman.direction.current.clock ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">-1</span></span>) : <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*   ,          128( ,   ).       ,    -.      ,     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!siteman.checkCollision(siteman.ctx.getImageData(siteman.coord.x + offset_x, siteman.coord.y + offset_y,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>).data))</code> </pre><br>  How does it work and why exactly such formulas?  If the x or y coordinate changes, it means that you need to take into account the offset along this coordinate (by the way, you can also add composite movements), otherwise you should not take it into account.  By filling the circle (clockwise or counterclockwise) we understand the direction of motion, and either subtract or add an offset by size. <br>  In the end, we add what we got to the coordinates, because we are interested in what will be in front of us (we take away - after). <br>  The formulas for calculating the coordinates are very similar to those that I originally used to construct the loop. <br><br>  4) Well, a little by creating canvas, but this is already a perversion, so I will not explain it, never a good practice. <br><br>  The code works from both requestAnimationFrame and setTimeout.  Why is setTimeout defaulted?  Because on linux I couldn‚Äôt run the ‚Äúpolyfill‚Äù in one line, so it‚Äôs more stable. <br><br><h4>  What is this bad code? </h4><br>  1) You can not clone siteman'a.  If it were possible - 100% could be stuffed with a small siteman factory and there would be at least some opponents.  Now I see it, but I do not want to rewrite everything for the third time. <br>  2) It's a bit boring to just chase a blank page.  It turned out such a quickly fattening snake than tron. <br>  3) Some lines are too large (in all senses) abstraction. <br>  4) Nevertheless, it would be more correct to count through the delta from the past time and only then move the siteman when he ‚Äúcan‚Äù. <br>  5) Well, the picture on the turns looks a bit strange, but here you‚Äôll have to draw not a pacman but a whole circle, or even more distort with the coordinates. <br>  6) Yes, you can eat yourself.  if you press the opposite key.  Because the direction of movement is nowhere explicitly indicated - it would have been a hard line with bindings of keys, but this is quite realistic. <br>  7) Not enough reset'a <br><br>  Yes, and for a long time I tried to force the normal loop to be displayed, but if you take into account the direction (and not to make a ‚Äúsimple‚Äù loop that will always be over-the-pack), you get too much code and formulas.  The same with audio, at least you need to spend 3 lines on it: <br><pre> <code class="javascript hljs">siteman.audio = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Audio(data:wav/base64); siteman.audio.loop=<span class="hljs-literal"><span class="hljs-literal">true</span></span>; siteman.audio.play();</code> </pre><br>  but not the fact that they will immediately earn money in most cases. <br><br><h4>  So, what is next? </h4><br>  And nothing.  The goal was set to make the game on 30 lines, on js, with the help of canvas - it is completed.  The code did not turn out to be the UG, but not the best either.  But I got a lot of exp, and still made some kind of game. <br><br>  True, I would still continue to do better, especially I would like to add a simple AI that will bounce off the walls and move randomly, but for this you would need to seriously rewrite the code, and not the fact that it would fit in 30 lines more or less readable code.  Well, or still would have finished the idea with a site eater.  But it is a pity time, only 5 hours were spent on this project and did not want to spend another couple of evenings on it. <br><br>  PS I read the sarcastic article "js-code is just one line," and IMHO - the point is not to do exactly N lines (most languages ‚Äã‚Äãallow themselves to be compressed into just 1 line), but the point is to write something funny and small. </div><p>Source: <a href="https://habr.com/ru/post/202874/">https://habr.com/ru/post/202874/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../202860/index.html">Another Tetris on JS (~ 30 "conditional" lines)</a></li>
<li><a href="../202864/index.html">Minimize apps to dock for lazy using AppleScript</a></li>
<li><a href="../202866/index.html">Meet Dependency Injection with the Dagger example</a></li>
<li><a href="../202868/index.html">Testing: a clear career choice</a></li>
<li><a href="../202870/index.html">Automate subtitle uploading from * .mkv files</a></li>
<li><a href="../202876/index.html">Upgrading Nexus 4 to Android 4.4 on Linux</a></li>
<li><a href="../202878/index.html">What do bad security managers do?</a></li>
<li><a href="../202880/index.html">Git to help admin lokalkhost</a></li>
<li><a href="../202884/index.html">Overcoming the hidden dangers of KVO in Objective C</a></li>
<li><a href="../202888/index.html">Asteroids javascript implementation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>