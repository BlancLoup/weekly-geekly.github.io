<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>6 XSS on Habrahabr and methods of protection with their consequences</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once I wondered how much corporate blogs cost in Habrahabr. I went to this page and clicked on the link to order . Automatically, instead of the expec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>6 XSS on Habrahabr and methods of protection with their consequences</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/7bf/b30/d77/7bfb30d77b95164edfbd21821fa1a6ef.jpg" alt="image"><br><br>  Once I wondered how much corporate blogs cost in Habrahabr.  I went to <a href="http://habrahabr.ru/info/advertising/corporate/">this</a> page and clicked on the link to <a href="http://habrahabr.ru/companies/add/%3Fpackage%3Dsimple">order</a> .  Automatically, instead of the expected data, I entered the vector for testing XSS and received JS execution in my browser.  But this is not all as interesting as the methods of protection on Habr√© from the effects of XSS. <br><a name="habracut"></a><br><h4>  Protection.  HTTP Only </h4><br>  Running XSS in two fields in step 2 and in four in step 3, I wondered what could be done about it.  The most standard attack vector, if possible, is to conduct XSS - this is to ‚Äúmerge‚Äù the authorization session and substitute yourself.  Turning to the cookies, I saw that the PHPSSESID uses the HTTP Only flag, which prohibits accessing this cookie through JS.  Those.  even having implemented malicious JS code, we cannot ‚Äúmerge‚Äù the user's session and substitute to ourselves (in order to be authorized by the user, the classic attack vector).  There are ways to circumvent this protection, on some versions of Apache (and here is nginx, so it does not) and through the use of plug-ins in the browser, but the next item breaks all the vectors. <br><br>  <i>hint: For phpsessid to have the HTTP Only flag, you need to set the following value in php.ini: <b>session.cookie_httponly = true</b></i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Protection.  Anti-CSRF protection </h4><br>  Since we are dealing with XSS through POST, in such cases XSS exploitation through CSRF is used.  The attacker creates an identical form on his website, as well as on a vulnerable resource, with already filled data (placing a vector for XSS in vulnerable fields) and places it in a hidden frame on his own website.  When the attacked user opens the site with this frame and form - he will automatically send the data to Habr and execute the malicious JS in his browser.  But there is a difference - the HTTP Referer field will contain the domain of the attacker's site. <br><br>  In the article <a href="http://habrahabr.ru/post/168739/">Towards a Secure Web Resource.</a>  <a href="http://habrahabr.ru/post/168739/">Part 1 - the server software</a> I considered the following rule in nginx (which can be implemented directly at the level of the web application) as a dirty hack: <br><br><pre><code class="hljs mel"># ANTI CSRF HACK valid_referers blocked example.com www.example.com; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($invalid_referer) { set $possible_csrf <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($request_method = POST) { set $possible_csrf <span class="hljs-string"><span class="hljs-string">"${possible_csrf}2"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($possible_csrf = <span class="hljs-number"><span class="hljs-number">12</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">403</span></span>; }</code> </pre> <br><br>  And here he, a bright example - Habrahabr, uses this rule.  Those.  we can not send a POST request to the server from another site - we get 403. As a result, we can execute the JS code only in our browser. <br><br>  <i>hint: protection from CSRF saves from the effects of XSS through POST, which negates the vulnerability.</i> <br><br><h4>  Attack.  Cookie injection </h4><br>  But still, may still have loopholes?  Having continued to study how the form works, I came across that the data filled in the application form are temporarily stored in some cache on the server (maybe memcache).  This cache is not associated with a user session (PHPSESSID), but on the other - habrsession_id.  Those.  having already generated the form with the XSS vector and substituting our cookie habrsession_id to another user, we can theoretically carry out an attack.  But we cannot (in standard terms) set the value of a cookie on another domain.  But there is a way - Cookie injection. <br><br>  It consists in analyzing the JS code of the application and setting the value of document.cookie.  If there is a DOM XSS or such conditions that allow you to embed your Cookie value (for example, some kind of test cookie which sets itself the titile value of the current window (we can open the window through window.open with its title, there are cases in real systems) , the attacker can write his habrsession_id value to the attacked and execute JS. At the moment, all XSS are fixed. If you find something, inform <a href="http://habrahabr.ru/feedback/">the support service</a> , respond very promptly. <br><br>  <i>hint: in the article <a href="http://habrahabr.ru/company/xakep/blog/189210/">Finding loopholes: DOM based XSS guide</a> describes the moments from where to wait for a trick with DOM XSS.</i> <br><br>  PS And the hint is off topic: While writing the topic, I did not save it and accidentally pressed f5.  As a result, at one of the moments, I lost the entire text of the article (when I had almost finished writing it, the ‚Äúrestore‚Äù button did not help).  Instantly made a dump of the process through the usual task manager, opened it via <a href="http://mh-nexus.de/en/hxd/">HxD</a> , found the text of the article (the Russian text was in json) using the key words and put it <a href="http://www.percederberg.net/tools/text_converter.html">here</a> .  Restored the lion's share of the article. </div><p>Source: <a href="https://habr.com/ru/post/195320/">https://habr.com/ru/post/195320/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../195308/index.html">New 5-Mpix IP Video Camera with Autofocus</a></li>
<li><a href="../195312/index.html">VLC 2.1 released</a></li>
<li><a href="../195314/index.html">How Moscow helps IT-entrepreneurs</a></li>
<li><a href="../195316/index.html">IBM Trial Software</a></li>
<li><a href="../195318/index.html">The announcement of the Cloud OS Summit conference is all about the Microsoft cloud. Participation is free, registration is open.</a></li>
<li><a href="../195322/index.html">Writing a bot client for schemaverse</a></li>
<li><a href="../195330/index.html">A real-life challenge: How to restore a process tree in Linux</a></li>
<li><a href="../195334/index.html">DataPro will open its first data center in Tver this year</a></li>
<li><a href="../195338/index.html">Using Paint as a level editor</a></li>
<li><a href="../195340/index.html">Organization of electronics and robotics group in Moscow</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>