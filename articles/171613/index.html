<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Wireless communications "smart home"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When the beginner (or continuing) ‚Äúradio amateurs‚Äù played with the LEDs and were tired of turning the servos into different positions, some of them be...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Wireless communications "smart home"</h1><div class="post__text post__text-html js-mediator-article">  When the beginner (or continuing) ‚Äúradio amateurs‚Äù played with the LEDs and were tired of turning the servos into different positions, some of them begin to apply their knowledge to the ordinary household sphere. <br>  As a rule, this application is in two areas - a car or a house. <br>  ‚ÄúTyunit‚Äù cars are somehow not interesting to me personally, but to make your own housing a little bit ‚Äúsmarter‚Äù and more comfortable is a worthy choice. <br><img src="https://habrastorage.org/storage2/c6a/25f/d38/c6a25fd381ed4771ce5b3bf149474ff7.jpg"><br><a name="habracut"></a><br>  The photo above shows a working prototype of the ‚ÄúControl Panel‚Äù of my ‚Äúsmart‚Äù home. <br><div class="spoiler">  <b class="spoiler_title">Lyrical digression # 1: How it all began (you can skip it, but someone may be useful).</b> <div class="spoiler_text"><a name="lyrics1"></a><br>  The initial philosophy of <b>my</b> ‚Äúsmart home‚Äù was as follows: <i>each device created was made to achieve a specific goal and it should work independently</i> . <br>  So at home there appeared devices like: <br><ul><li>  IR lighting control in the living room (the original lamp was with radio control, but I wanted to control it from the universal IR remote control). </li><li>  <a href="http://habrahabr.ru/post/165747/">Weather Station</a> . </li><li>  <a href="http://habrahabr.ru/post/168783/">Power monitoring device</a> and others. </li></ul><br>  The house uses not only home-made, but also purchased "smart" devices.  One of these very successful devices is the chronothermostat: <br><img src="https://habrastorage.org/storage2/962/dc6/5fc/962dc65fcb460cd83c71d8d2318436cb.jpg"><br><br>  The thermostat operates in two modes: <br><ul><li>  "Night" - the temperature is lower so that it is more comfortable to sleep (and save gas). </li><li>  "Daytime" - the temperature is higher and more comfortable for wakefulness. </li></ul><br>  Everything is extremely convenient, the individual schedule of the ‚Äúnight‚Äù and ‚Äúday‚Äù mode is set up, both temperatures are set.  "Night" mode for myself is configured so that it turns on both at night and during the day, when no one is at home. <br><br>  But since my working day is not normalized, after several early returns it turned out that <i>it was somehow not very pleasant to return to a cool house from a cold day</i> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      From that moment, the epic began with wireless communications (it was possible, of course, to entangle the whole house with a ‚Äútwisted pair‚Äù, but this is not our method). <br></div></div><br>  The choice of wireless modules was quite spontaneous, but after several months of operation, it was quite justified. <br><br>  Cheap <a href="http://imall.iteadstudio.com/im120606002.html">2.4GHz nRF24L01 +</a> transceivers were purchased: <br><img src="https://habrastorage.org/storage2/78d/814/3a7/78d8143a7e4494a36d9a0a9cc3121dac.jpg"><br><br>  According to the characteristics, it is stated that the range is up to 100m (in direct line of sight) and the data transfer rate is up to 2Mbps.  You can use any of the 126 available frequency channels.  Very worthy for such a "crumbs." <br><br>  Just in case for the most "critical" modules there were <a href="http://imall.iteadstudio.com/im120606003.html">"enhanced" versions</a> : <br><img src="https://habrastorage.org/storage2/6a2/c6e/ebb/6a2c6eebb255cea60cfaa9755778655a.jpg"><br><br>  These modules are fully compatible with "conventional", but additionally equipped with a power amplifier and an external antenna. <br><blockquote>  By the way, they are still doing nothing so far - it turned out that in my case there are enough ‚Äúordinary‚Äù modules. </blockquote><br>  Modules connect to MK via SPI. <br>  The peculiarity of the modules is that they need 3.3V for power (i.e. they need to provide individual power if the rest of the circuit is powered, for example, from 5V).  The good news is that these RFs are tolerant to 5B signals (no level matching scheme is required). <br><br><div class="spoiler">  <b class="spoiler_title">Lyrical digression # 2: First experiences.</b> <div class="spoiler_text">  Initially, the <a href="http://playground.arduino.cc/InterfacingWithHardware/Nrf24L01">Mirf</a> library was used to work with wireless modules. <br><br>  To eliminate the "cool house" problem (see <a href="https://habr.com/ru/post/171613/">Lyrical digression # 1</a> ), a "forced" thermostat was created. <br>  The module is a small box that connects between the gas boiler and the chronothermostat: <br><img src="https://habrastorage.org/storage2/a66/aa4/09d/a66aa409d4641d516b08bba0da13917d.jpg"><br><br>  The module is equipped with 2 relyushki that provide the necessary switching, its own temperature sensor (DS18B20) and 3 LEDs to indicate the operating mode. <br><br>  The logic is simple: if the ‚Äúforced‚Äù thermostat has an automatic mode of operation selected - it pretends to be a ‚Äúpiece of cable‚Äù and does not affect the interaction between the boiler and the chronothermostat.  But if he was transferred to the ‚Äúmanual‚Äù mode of operation, the chronothermostat is disconnected from the boiler and no longer participates in the work, the ‚Äúforced‚Äù thermostat becomes responsible for the temperature of the house. <br>  The module has 2 parameters: <br><ul><li>  Mode of operation (0 - auto, 1 - manual). </li><li>  Set temperature </li></ul><br>  In addition, this module is a ‚Äúsensor‚Äù of temperature, a monitoring function was added a bit later, which shows whether ‚Äúthe gas boiler is currently allowed to heat‚Äù. <br><br>  Thus, the first device is created that can transmit data about its state and receive commands. <br><br>  But in order to manage it, you need at least one more. <br><br>  The choice fell on the <a href="http://imall.iteadstudio.com/development-platform/im120411004.html">gBoard</a> board (atmega328, sim900 based gsm, interface for nrf24l01 (using hardware SPI), SD, a bunch of analog pins, etc.): <br><img src="https://habrastorage.org/storage2/12c/882/1f9/12c8821f91747d8090ba3b22fba3f599.jpg"><br><br>  The SIM card slot is located on the back of the board (I didn‚Äôt take pictures - there‚Äôs nothing else interesting there). <br><br>  Again, using the same library for nrf24l01 (Mirf), a sketch was written. <br>  Now it is possible via SMS to request the current temperature of the house, set the desired temperature and transfer the "forced" thermostat from one mode to another. <br><br>  The problem of ‚Äúcool home‚Äù was decided: just going to the side of the house to send an SMS with the meaning ‚ÄúI want a warm home for arrival‚Äù. <br><br>  Similarly, the module for IR light control was equipped with a wireless module and also became controlled via SMS (again, this module became another ‚Äúsensor‚Äù in the system - temperature / humidity / light condition). <br><br>  After a while, almost all the ‚Äúcrafts‚Äù acquired a wireless interface and at least became ‚Äúsensors‚Äù, and at the maximum, executive devices with remote control capabilities. <br><br>  At the same time, all devices remained true to the basic principle indicated above: <i>each device created was made to achieve a specific goal and it should work independently</i> . <br></div></div><br><br>  And it seems like everything works and everything is fine, but somehow it is not very convenient - only via SMS, and it was rather difficult to implement new features.  The control of execution was carried out either by another SMS with a request for the current value of the ‚Äúsensor‚Äù or by looking into the video surveillance system (to see, for example, the switched on light). <br><br>  When working with modules, one had to keep in front of him a ‚Äúpiece of paper‚Äù, where it was fixed, as the name of a particular sensor, the number of its parameters, the purpose of each of the parameters. <br><br>  The format of the structure for data transmission was not optimal (for my case).  This version of the format does not even want to bring. <br><br>  It is clear that it is necessary to somehow modify (prerequisite # 1). <br><br>  Naturally, there was a desire to receive information and manage more via LAN.  An <a href="http://imall.iteadstudio.com/development-platform/im120410001.html">iBoard</a> shawl was purchased (atmega328, LAN based on Wiznet W5100, interface for nrf24l01, SD, a bunch of analog pins, etc.): <br><img src="https://habrastorage.org/storage2/11e/8e7/676/11e8e76764c87a9e4555d5639c48efc8.jpg"><br><br>  And everything seems to be all as on gBoard, but it turned out that the wireless module is not completely divorced as expected.  Hardware SPI in this board is used for LAN and SD, but for the wireless module it was proposed to implement this interface independently.  This was most likely done so that it was possible to work ‚Äúsimultaneously‚Äù with both LAN and RF. <br><br>  The Mirf library on this board with this switching module refused to work categorically.  Writing my library to interact with nrf24l01 was not at all my plans. <br><br>  Obviously, something needs to be done, otherwise a good fee will go ‚Äúon the table‚Äù until better times (prerequisite # 2). <br><br>  The wonderful library <a href="https://github.com/maniacbug/RF24">RF24</a> (by <a href="https://github.com/maniacbug">maniacbug</a> , Seattle, USA) and even more wonderful fork <a href="https://github.com/andykarpov/iBoardRF24">iBoardRF24</a> made by <a href="https://github.com/andykarpov">Andrey Karpov</a> (Kiev, Ukraine) were <a href="https://github.com/andykarpov/iBoardRF24">discovered</a> . <br><br>  Libraries did a great job on all available devices (test cases), but devices with different libraries (Mirf and RF24) cannot communicate with each other (premise # 3). <br><br>  It became obvious that the very moment came when it was necessary to redo everything. <br><blockquote> Below are pieces of code (Arduino IDE) to illustrate the current solution.  I do not give a full listing to leave room for creativity. </blockquote><br>  Having already gained considerable experience, I took all the good things from the structure of the transmitted data and took into account the existing shortcomings and came to the conclusion that it is better to use the following structure of the ‚Äúpacket‚Äù of data: <br><pre><code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/     typedef struct{ int SensorID; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   int CommandTo; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    ... int Command; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 0 -     /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 1 -   /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 2 -   int ParamID; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   float ParamValue; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   boolean Status; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  0 - , 1 -  char Comment[16]; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  } Message;</span></span></code> </pre> <br>  From the comments almost everywhere it is clear which parameter is used for what.  What is not clear will be explained below. <br><br>  Inside each ‚Äúsensor‚Äù it is necessary to have structures for the parameters: <br><pre> <code class="hljs pgsql">//      typedef struct{ <span class="hljs-type"><span class="hljs-type">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>; //  <span class="hljs-type"><span class="hljs-type">boolean</span></span> Status; //  - <span class="hljs-number"><span class="hljs-number">0</span></span>- (<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>- (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) <span class="hljs-type"><span class="hljs-type">char</span></span> Note[<span class="hljs-number"><span class="hljs-number">16</span></span>]; //  } Parameter;</code> </pre><br>  The structure has three parameters.  Well, with ‚Äúvalue‚Äù everything is clear, the ‚ÄúNote‚Äù field is used to give some kind of intelligible (but brief) explanation of what kind of a sensor it is and, possibly, a unit of measurement. <br>  Status wound up more for control and possible flexibility in the future. <br>  Now it is used, for example, if it was not possible for some reason to read data from some sensor, then the system can safely handle this situation and transmit 0, denoting the problem. <br><br>  It is seen that the second structure completely repeats the ‚Äúend‚Äù of the structure of the transmitted packet. <br><br>  The format of the transmitted ‚Äúpacket‚Äù is absolutely identical for both ‚Äúmaster‚Äù (the one who sends commands and collects data) and the ‚Äúslave‚Äù (the one who receives commands and reports on the work done).  Moreover, with this approach, master and slave are quite conventional symbols.  Modules really communicate on an equal footing and requests with answers can go both ways. <br><br>  Now you can begin to describe a specific module.  Take some hypothetical module with 3 parameters.  It will be encoded as follows: <br><pre> <code class="hljs smalltalk">//    <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">SID</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> //   <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">NumSensors</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> //   (     -  ) <span class="hljs-type"><span class="hljs-type">Parameter</span></span> <span class="hljs-type"><span class="hljs-type">MySensors</span></span>[<span class="hljs-type"><span class="hljs-type">NumSensors</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>] = { //   (  ) <span class="hljs-type"><span class="hljs-type">NumSensors</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-comment"><span class="hljs-comment">"Sensor 100: LED"</span></span>, //   <span class="hljs-comment"><span class="hljs-comment">""</span></span>        , <span class="hljs-number"><span class="hljs-number">1</span></span>    <span class="hljs-comment"><span class="hljs-comment">"  "</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-comment"><span class="hljs-comment">"value A0"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-comment"><span class="hljs-comment">"counter"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-comment"><span class="hljs-comment">"set_value"</span></span>, }; <span class="hljs-type"><span class="hljs-type">Message</span></span> sensor;</code> </pre><br>  Please note that in spite of the fact that parameters 3, a structure of 4 elements is declared.  For myself, I accepted that in the ‚Äúzero‚Äù element I will always encode information about the ‚Äúmodule‚Äù itself - the number of its sensors, give information that the sensor can accept commands or it only has a ‚Äúsensor‚Äù and a text description of the sensor. <br><blockquote>  Now I think that when describing a sensor, the Status parameter can be used to indicate whether it is possible to change this parameter (ie, ‚Äúactuator‚Äù) or not (just ‚Äúsensor value‚Äù). <br>  Or enter another parameter for this? </blockquote><br>  With the data figured out, go to the functions: <br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">boolean</span></span> sendMasterMessage(<span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">From</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">To</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> Command, <span class="hljs-type"><span class="hljs-type">int</span></span> ParamID, <span class="hljs-type"><span class="hljs-type">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>, <span class="hljs-type"><span class="hljs-type">char</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span>, Message* answer);</code> </pre><br>  This is how the function with which the command is sent is declared. <br>  Returns "true" if the correct answer came, or "false" if it failed. <br>  Input parameters: from which module the command goes, to which module, the command (read or set), which parameter, value, comment and link to the structure for the answer. <br>  The ‚Äúcomment‚Äù parameter here is more a ‚Äúbookmark for the future‚Äù so that, for example, you can change the names of the modules and the names of the parameters. <br><br>  The result of the function is determined by the following rules: <br><ol><li>  the response must be received from the sensor addressed </li><li>  the response must be intended to the master who initiated the request </li><li>  the response must be the ParamID that participated in the transfer </li></ol><br>  Thus, to find out the value of the first sensor from our hypothetical sensor, it suffices to call the function on the master (let its SID be 900) as follows: <br><pre> <code class="hljs swift"> ... <span class="hljs-type"><span class="hljs-type">Message</span></span> answer; ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(sendMasterMessage(<span class="hljs-number"><span class="hljs-number">900</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, answer)) { <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">println</span></span>(answer.<span class="hljs-type"><span class="hljs-type">ParamValue</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">println</span></span>(<span class="hljs-string"><span class="hljs-string">"No answer"</span></span>); } ...</code> </pre><br><br>  Accordingly, on the ‚Äúreceiving‚Äù side in the main loop there should be something like this: <br><pre> <code class="hljs pgsql"> //    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (radio.available()) { <span class="hljs-type"><span class="hljs-type">bool</span></span> done = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!done) { done = radio.<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>( &amp;sensor, sizeof(sensor) ); //     -  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor.CommandTo == SID) { //   ( , , , ) doCommand(sensor.SensorID, sensor.Command, sensor.ParamID, sensor.ParamValue, sensor.Status, sensor.<span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span>); } } }</code> </pre><br><br>  The doCommand function can be something like this: <br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> doCommand(<span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">From</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> Command, <span class="hljs-type"><span class="hljs-type">int</span></span> ParamID, <span class="hljs-type"><span class="hljs-type">float</span></span> ParamValue, <span class="hljs-type"><span class="hljs-type">boolean</span></span> Status, <span class="hljs-type"><span class="hljs-type">char</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span>) { switch (Command) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: //    break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: //     sendSlaveMessage(<span class="hljs-keyword"><span class="hljs-keyword">From</span></span>, ParamID); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: //  setValue(<span class="hljs-keyword"><span class="hljs-keyword">From</span></span>, ParamID, ParamValue, <span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span>); break; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: break; } //  "" sendSlaveMessage(<span class="hljs-keyword"><span class="hljs-keyword">From</span></span>, ParamID); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre><br><br>  The sendSlaveMessage function is almost the same as sendMasterMessage, but does not check the correctness of the response after it has sent data and contains fewer input parameters ‚Äî the function accepts the input of the identifier of the module to which the parameter identifier responds, the information about which needs to be sent. <br>  The system already knows the rest of the required data for the composition of the sending package (remember, there are still required fields ‚Äî the identifier of the module that sends the data at the moment, the command (in this case it will be 0, because we just send the current value )). <br><br>  Thus, the logic of the work is simple: <br><ul><li>  The master initiates an address request to the module and requests to read (or set) the value of a specific parameter. </li><li>  Slave accepts this command (and if it is addressed to him) and performs the required, which is "reported" in the response message. </li><li>  The master analyzes the received packet and if it is satisfied with the result, it goes further with its own affairs or makes a second request (the necessary number of times). </li></ul><br>  The code for gBoard was also rewritten accordingly and now the interaction via SMS looks something like this (part of the screenshot from my phone): <br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/b35/439/40b/b3543940bb7bb0f9d03bd008743d85ad.jpg"></div><br>  The first SMS I request the temperature of the eastern sensor from the ‚Äúweather‚Äù module, the second SMS - I set the desired temperature of the ‚Äúforced‚Äù thermostat.  In response, I get a measured value or an answer about a successfully set value (at the end of the message there is ‚ÄúOK!‚Äù). <br><br>  It is clearly seen that the SMS includes the data necessary to form a complete request for a specific module.  I agree that the format of outgoing messages is not too simple, then it will be possible to rewrite it into something more ‚Äúhuman-readable‚Äù. <br><br>  At this ‚Äúaddress‚Äù data exchange describe finish. <br><br>  But there are other modules in the home system that are primitive ‚Äúsensors‚Äù.  A typical example of such a module is a temperature and humidity sensor, which may be battery operated and it must protect its resources and ‚Äúsleep soundly‚Äù and wake up solely in order to quickly send information about your condition and ‚Äúsleep‚Äù again. <br>  For him, the "request-response" mode is not suitable (you will have to keep at least the RF module in a "waking" state, which will adversely affect the battery life). <br><br>  Then I thought that it was possible to arrange ‚Äúflood‚Äù on the air: the sensors can send their parameter values ‚Äã‚Äã(all or only some of them on a regular basis) for all (then the To parameter (to whom) takes the value 0 (i.e. " all ")). <br><br>  It turns out a kind of "multicast" - the module woke up, gave its status to the air (and it does not matter to him if someone heard it or not) and fell asleep again. <br><br>  Almost all the modules that work "addressfully" added the "flood" mode, so that they also regularly broadcast their status (for the logging system). <br><blockquote>  To rewrite (it would be more accurate to say ‚Äúcorrect‚Äù) the code of the sketches for those modules that already worked (for the new library) turned out to be a very simple task - no more than 15-20 minutes per module.  The process of "migration" was absolutely painless. </blockquote><br>  And now it remains only to collect the data together.  This is where the iBoard board came in handy (I‚Äôll bring her photo again, with the RF module already installed): <br><img src="https://habrastorage.org/storage2/7e6/0ab/48d/7e60ab48daa5daf879b72b56d07ff4aa.jpg"><br><br>  One simple, but very important function is assigned to this module - to listen to ‚Äúflood‚Äù and send data (POST method) to a web server.  A module on iBoard doesn't know anything at all about the number and "composition" of transmitting modules - it listens to everything. <br><br>  In the data packet for the web server, the ‚Äúkey‚Äù is transmitted (so that the server understands that it is ‚Äúits own‚Äù) and the full received packet (I repeat once again that the following key data comes in the packet: module SID, parameter ID, value of this parameter, comment (parameter name and / or unit of measurement)). <br>  If in the received ParamID package it is equal to zero, then in the value of the parameter we have the number of ‚Äúsensors‚Äù in the module, and in the ‚Äúcomments‚Äù - the name of the module. <br><br>  On the web server, in automatic mode, records are formed in 2 labels: sensor_list and sensor_value (from the names, I think, everything is clear). <br><br>  The applied approach allows you to add modules to the system completely painlessly and not to correct the code for iBoard - the new values ‚Äã‚Äãwill get to the database according to a well-established pattern. <br><br>  As a web server, I used what was ‚Äúat hand‚Äù (Synology DS411 + II) - a web server with php and mySQL was raised in a couple of clicks.  If there is nothing suitable ‚Äúat hand‚Äù and you don‚Äôt want to keep the computer on for the sake of it - you can use third-party hosting, buy something like <a href="http://experthd.ru/products/gi-ms100-xtreamer-pro">this</a> (nice and useful) or, for example, <a href="https://cosm.com/">cosm.com</a> service <br><br>  Depending on the choice of ‚Äústorage‚Äù, the code for the MC with a LAN module will change minimally (cosm.com has its own library for arduinka and a convenient debugging mode ‚Äî it's very easy to use). <br><br>  The data collected (and in the case of using cosm.com - already displayed on the graphs). <br><br>  In my project, I used <a href="https://developers.google.com/chart/">Google Charts</a> for display.  It turns out like this (weather parameters only): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/256/570/b28/256570b283bbf492436a9f9802f7c51b.png"></div><br>  Specially bring a screenshot, but I do not give a link to the page - NAS, I think, will not withstand the load from Habr. <br>  The data from the sensors are ‚Äúnoisy‚Äù, we should use <a href="http://habrahabr.ru/post/166693/">the Kalman filter</a> , but my hands have not reached it yet. <br><br>  Actually, with the collection and display of data - also finished. <br><br>  It remains to implement control via LAN (and this is still not done and, if interested, will be the topic of another post (although the basic principles are already voiced - how to do it is clear, you just need to "sit down and write")). <br><br>  You may ask: "What is the picture with which the post started?" <br><br>  And this is another board for rapid prototyping - <a href="http://imall.iteadstudio.com/development-platform/iboard-pro.html">iBoardPro</a> (built already on mega2560, LAN, RTC, SD, RF-interface, 40-pin connector for connecting TFT displays with touchscreen and other "buns"): <br><img src="https://habrastorage.org/storage2/850/976/cf8/850976cf885b1ff20a1e0aab4ee2e9c9.jpg"><br><br>  The photo clearly shows the TFT 2.4 "320 * 240 display with a resistive touchscreen <a href="http://imall.iteadstudio.com/display/tft-lcm/im120419004.html">ITDB02-2.4E</a> . It looks good, but it's too small for work with your fingers, and I would like more texts (I will look towards 5 or even 7-inch displays). <br><br>  Using the principles described above, this board implements (but still appends) a ‚Äúcontrol module‚Äù to which data from the desired sensors is output and it is possible to control those devices that support it. <br><br>  A short video showing the current work of the prototype: <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/O5Lk9zAruOk%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700190,15700253&amp;usg=ALkJrhj2VrPj3VnA1nqu02LhRjrM9QEv_Q" frameborder="0" allowfullscreen=""></iframe><br><br>  The logic of work is as follows: <br><ul><li>  There are ‚Äúmain‚Äù screens - ‚Äúsummary‚Äù data fall on them (‚ÄúWeather‚Äù - green, ‚ÄúHouse‚Äù - yellow) </li><li>  There are ‚Äúsub-screens‚Äù - data from the sensors is displayed on them (in the video this is shown for the ‚Äúyellow‚Äù bookmark - ‚Äúhome parameters‚Äù: temperature and humidity in two points of the house and data on power consumption). </li><li>  A ‚Äúred‚Äù screen is a ‚Äúbulletin summary‚Äù - the most requested data. </li><li>  "Blue" screen - control.  In the middle of it is the control of the light, in the bottom - the control of the "forced" thermostat.  At the bottom left, a red ‚Äúindicator‚Äù is a display of that parameter (about which I wrote above), indicating whether the gas boiler can be operated at the current time. </li></ul><br>  The ‚Äúcontrol buttons‚Äù on the screen have ‚Äúfeedback‚Äù: i.e.  after the inclusion of a specific mode - it is displayed in the appropriate color.  If something has already been included earlier, then when you go to the control screen, it will be immediately visible. <br>  Each "press" on the button generates a call to the sendMasterMessage function with the appropriate parameters and receiving a response from a specific sensor (it is from this data that the buttons are repainted or the value changes, as is evident for the set temperature of the "forced" thermostat). <br><br>  It can be seen that there is a certain delay in ‚Äúrepainting‚Äù the button and changing the parameter - this is due not only to the slowness of the MC when rendering, but also because it takes time to send a request and receive a response (sometimes the ‚Äúrequest-response‚Äù process goes more than once - master able to repeat his "order", if not wait for the expected response). <br><br>  The ‚Äúpurple‚Äù screen is planned to be used to display data about the state of the system: current IP address, start time, last synchronization time via NTP, last ‚Äúconnection‚Äù times (or ‚Äúauditions‚Äù) with specific sensors, etc. <br><br>  Perhaps that today is all that I wanted to tell (and so it happened a long time). <br><br>  Sorry for the quality of the photo - I shot the phone on the <s>microwave</s> . <br><br>  <b>PS</b> ‚ÄúZhelezki‚Äù acquired in <a href="http://devicter.ru/">this</a> store (of course, I overpaid, but did not want to wait for a long, long time from China, during which time I managed to order and receive several parcels from the NSC).  Closer and faster nowhere found. <br><br>  <b>PPS</b> Yes, all these ‚Äúglands‚Äù (well, except perhaps for a display) can be assembled at home, but that was not the goal. </div><p>Source: <a href="https://habr.com/ru/post/171613/">https://habr.com/ru/post/171613/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../171597/index.html">Meet the beta Opera 14 for Android</a></li>
<li><a href="../171599/index.html">Penguin cookies</a></li>
<li><a href="../171607/index.html">The Bank of Russia reminds you that your electronic money and mobile payments may be more illegal</a></li>
<li><a href="../171609/index.html">Ubuntu Global Jam 13.04 in Novosibirsk</a></li>
<li><a href="../171611/index.html">Available 3D anti-aliasing technology</a></li>
<li><a href="../171615/index.html">Spring warming at DevCon 2013: ticket prices are melting</a></li>
<li><a href="../171617/index.html">How Halfbrick Studios develops games like Fruit Ninja, Age Of Zombies and Jetpack Joyride</a></li>
<li><a href="../171623/index.html">Under the hood: a patch for Dalvik from Facebook for Android</a></li>
<li><a href="../171629/index.html">Secure Cryptographic Execution Environment</a></li>
<li><a href="../171631/index.html">Project "Creation Creation". Do it yourself</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>