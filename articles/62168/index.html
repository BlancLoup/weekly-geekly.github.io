<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How cache affects multi-threaded applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The theoretical component. 

 It so happened, the bottleneck in many computers is the interface memory - processor. This is due to the significant tim...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How cache affects multi-threaded applications</h1><div class="post__text post__text-html js-mediator-article">  <b>The theoretical component.</b> <br><br>  It so happened, the bottleneck in many computers is the interface memory - processor.  This is due to the significant time of forming a request to the memory and the fact that the memory frequency is lower than the frequency of the processor.  In general, at the time of receiving data from memory, the execution of the program stops.  To improve the situation, use specialized high-speed memory - cache. <br><br>  If there is a cache, if the processor needs to access a certain byte in RAM, then the memory area containing this byte (the size of the area depends on the processor) is first selected in the cache, and then the processor reads the data from the cache.  If the processor writes data to the memory, they first get into the cache, and then into the RAM. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In a multi-core and multi-processor system, each core or processor has its own personal cache.  When modifying data in the cache with a single processor, the changes should be synchronized with other processors using intersecting address space. <br>  If changes occur frequently and the data areas overlap strongly, performance will fall. <br><br>  I have a question how bad things can be.  In addition, it was interesting to see how the data length affects. <br><a name="habracut"></a><br><br>  <b>Experiment.</b> <br>  For checking, 2 multi-threaded C ++ programs were written for two cases of intersection of working areas: <br><br><ul><li>  The areas do not intersect and are in the stack of each of the threads; </li><li>  The working area for threads is common; it is an array of 1, 4, and 8 byte words, with a total length of 1024 bytes, each of the threads modifying its words (for example, even or even odd). </li></ul><br><br>  Working threads - 2, each, changing its words, passes the whole array and, having reached the border, returns to the beginning and so on.  Each of the threads makes 100,000,000 changes. <br><br>  <b>UPD</b> Thank you mikhanoid for the identified typo in the name of the CPU. <br>  For testing, the HP xw4600 workstation, CPU Core 2 Quad (Q9300), OS Linux Slamd64 12.1, kernel 2.6.24.5, compiler gcc 4.2.3 was used.  The result was a 64-bit program, so any arithmetic operation for words of 1.4 and 8 bytes in length was performed in 1 clock cycle. <br><br>  The execution time was measured with the command time (1), and averaged over 5 experiments. <br><br>  First, a program was written that simply increments the word and puts it back, but it turned out that in the case of an array on the stack, optimization -O2 creates something indecent.  Therefore, a second program was written that does something more complex with the data. <br><br>  <b>Results.</b> <br>  <b>UPD:</b> Thnx for noticing mt_ and Google Charts for api charts.  Result in graphic form. <br>  Those who want to see the numbers, can squander further. <br><br>  On the y-axis, the real time of program execution in seconds.  X axis word length (in pairs). <br><br>  Program 1. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/612/856/ab1/612856ab189b60345af3418469289f53.png" alt="image"><br><br>  Program 2. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b04/5b8/720/b045b8720515a1083a8328ce8e7fd2a0.png" alt="image"><br><br>  Program 2 + -O2 optimization. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e48/ae8/308/e48ae830834a4fb1ffb479ecb800d818.png" alt="image"><br><br>  <b>findings</b> <br>  It can be said for sure that in the case of obviously non-intersecting areas it works faster, and significantly.  Optimization somehow affects, but the trend continues. <br><br>  But the dependence on the length of the word is somehow hardly noticeable. <br><br>  The idea of ‚Äã‚Äãthis opus is inspired by the article <a href="http://www.ddj.com/architect/208200273">www.ddj.com/architect/208200273</a> . <br><br>  <b>UPD</b> Attempt to transfer to the Perfect Code blog, it seems to me that this is the right place. <br><br>  <i>Results in tabular form.</i> <br>  Results are presented in seconds. <br><br>  Program 1 (shared memory). <br><table><tbody><tr><th>  Word length </th><th>  64 </th><th>  32 </th><th>  eight </th></tr><tr><th>  Real time </th><td>  1,297 </td><td>  1.532 </td><td>  0.846 </td></tr><tr><th>  User time  regime </th><td>  2,461 </td><td>  3,049 </td><td>  1.664 </td></tr></tbody></table><br><br>  Program 1 (stack) <br><table><tbody><tr><th>  Word length </th><th>  64 </th><th>  32 </th><th>  eight </th></tr><tr><th>  Real time </th><td>  0.453 </td><td>  0.431 </td><td>  0.441 </td></tr><tr><th>  User time  regime </th><td>  0.851 </td><td>  0.842 </td><td>  0.866 </td></tr></tbody></table><br><br>  Program 2 (shared memory). <br><table><tbody><tr><th>  Word length </th><th>  64 </th><th>  32 </th><th>  eight </th></tr><tr><th>  Real time </th><td>  9,191 </td><td>  9.033 </td><td>  8,921 </td></tr><tr><th>  User time  regime </th><td>  18,365 </td><td>  18,039 </td><td>  17,824 </td></tr></tbody></table><br><br>  Program 2 (stack) <br><table><tbody><tr><th>  Word length </th><th>  64 </th><th>  32 </th><th>  eight </th></tr><tr><th>  Real time with </th><td>  8,432 </td><td>  8,412 </td><td>  8,808 </td></tr><tr><th>  User time  Mode with </th><td>  16.843 </td><td>  16.796 </td><td>  17,548 </td></tr></tbody></table><br><br>  Program 2 + optimization-O2 (shared memory). <br><table><tbody><tr><th>  Word length </th><th>  64 </th><th>  32 </th><th>  eight </th></tr><tr><th>  Real time </th><td>  4,247 </td><td>  4,380 </td><td>  3,473 </td></tr><tr><th>  User time  regime </th><td>  8,415 </td><td>  8,960 </td><td>  6,781 </td></tr></tbody></table><br><br>  Program 2 + optimization-O2 (stack) <br><table><tbody><tr><th>  Word length </th><th>  64 </th><th>  32 </th><th>  eight </th></tr><tr><th>  Real time </th><td>  3.282 </td><td>  3.718 </td><td>  3,308 </td></tr><tr><th>  User time  regime </th><td>  6.550 </td><td>  7.384 </td><td>  5.565 </td></tr></tbody></table><br><br>  <i>Source.</i> <br><br>  <b>Program 1.</b> <br><br> <code><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">#include &lt;sys/types.h&gt; <br> <br> #include &lt;stdio.h&gt; <br> #include &lt;stdlib.h&gt; <br> <br> #include &lt;pthread.h&gt; <br> <br> <font color="#0000ff">#define</font> TBYTES 1024 <br> <font color="#008000">//</font> <br> <font color="#0000ff">#define</font> TOTAL 2 <br> <font color="#008000">//    u_int8_t u_int32_t u_int64_t</font> <br> <font color="#0000ff">#define</font> MTYPE u_int8_t <br> <font color="#008000">//</font> <br> <font color="#0000ff">#define</font> MAXAR TBYTES/ <font color="#0000ff">sizeof</font> (MTYPE) <br> <font color="#0000ff">#define</font> DOIT 100000000 <br> <br> MTYPE *array; <br> <br> pthread_mutex_t mux = PTHREAD_MUTEX_INITIALIZER; <br> pthread_cond_t cond = PTHREAD_COND_INITIALIZER; <br> <font color="#0000ff">int</font> workers = 2; <br> <br> <font color="#008000">//     </font> <br> <font color="#008000">//#define SHARED 1</font> <br> <br> <font color="#0000ff">void</font> * <br> runner( <font color="#0000ff">void</font> * args){ <br> unsigned <font color="#0000ff">int</font> which = *(unsigned <font color="#0000ff">int</font> *)args; delete (unsigned <font color="#0000ff">int</font> *)args; <br> unsigned <font color="#0000ff">int</font> index = which; <br> MTYPE array1[MAXAR]; <br> <font color="#008000">//</font> <br> <font color="#0000ff">for</font> ( unsigned <font color="#0000ff">int</font> i = 0; i &lt; DOIT; ++i){ <br> <font color="#0000ff">if</font> ( index &gt;= MAXAR) <br> index = which; <br> <font color="#008000">//</font> <br> <font color="#0000ff">#if</font> defined(SHARED) <br> array[index] = array[index] + 1; <br> <font color="#0000ff">#else</font> <br> array1[index] = array1[index] + 1; <br> <font color="#0000ff">#endif</font> <br> <font color="#008000">//</font> <br> index += TOTAL; <br> } <br> <font color="#008000">//</font> <br> pthread_mutex_lock(&amp;mux); <br> -- workers; <br> pthread_mutex_unlock(&amp;mux); <br> pthread_cond_broadcast(&amp;cond); <br> <font color="#008000">//</font> <br> <font color="#0000ff">return</font> 0; <br> }; <br> <br> <font color="#0000ff">int</font> <br> main() { <br> <font color="#008000">//</font> <br> array = (MTYPE*)calloc(MAXAR, <font color="#0000ff">sizeof</font> (MTYPE)); <br> <font color="#008000">//</font> <br> unsigned <font color="#0000ff">int</font> *which; <br> pthread_t t1; <br> pthread_attr_t attr; <br> <font color="#008000">//</font> <br> pthread_attr_init(&amp;attr); <br> pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED); <br> <font color="#008000">//</font> <br> which = <font color="#0000ff">new</font> unsigned <font color="#0000ff">int</font> (0); <br> pthread_create(&amp;t1, &amp;attr, runner, ( <font color="#0000ff">void</font> *)which); <br> <font color="#008000">//</font> <br> which = <font color="#0000ff">new</font> unsigned <font color="#0000ff">int</font> (1); <br> pthread_create(&amp;t1, &amp;attr, runner, ( <font color="#0000ff">void</font> *)which); <br> <font color="#008000">//</font> <br> pthread_mutex_lock(&amp;mux); <br> <font color="#0000ff">while</font> (!pthread_cond_wait(&amp;cond, &amp;mux)){ <br> <font color="#0000ff">if</font> ( !workers) <br> <font color="#0000ff">break</font> ; <br> }; <br> pthread_mutex_unlock(&amp;mux); <br> <font color="#008000">//</font> <br> <font color="#0000ff">return</font> 0; <br> }; <br> <font color="#008000">//</font> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> <br></code></code> <blockquote> <code><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">#include &lt;sys/types.h&gt; <br> <br> #include &lt;stdio.h&gt; <br> #include &lt;stdlib.h&gt; <br> <br> #include &lt;pthread.h&gt; <br> <br> <font color="#0000ff">#define</font> TBYTES 1024 <br> <font color="#008000">//</font> <br> <font color="#0000ff">#define</font> TOTAL 2 <br> <font color="#008000">//    u_int8_t u_int32_t u_int64_t</font> <br> <font color="#0000ff">#define</font> MTYPE u_int8_t <br> <font color="#008000">//</font> <br> <font color="#0000ff">#define</font> MAXAR TBYTES/ <font color="#0000ff">sizeof</font> (MTYPE) <br> <font color="#0000ff">#define</font> DOIT 100000000 <br> <br> MTYPE *array; <br> <br> pthread_mutex_t mux = PTHREAD_MUTEX_INITIALIZER; <br> pthread_cond_t cond = PTHREAD_COND_INITIALIZER; <br> <font color="#0000ff">int</font> workers = 2; <br> <br> <font color="#008000">//     </font> <br> <font color="#008000">//#define SHARED 1</font> <br> <br> <font color="#0000ff">void</font> * <br> runner( <font color="#0000ff">void</font> * args){ <br> unsigned <font color="#0000ff">int</font> which = *(unsigned <font color="#0000ff">int</font> *)args; delete (unsigned <font color="#0000ff">int</font> *)args; <br> unsigned <font color="#0000ff">int</font> index = which; <br> MTYPE array1[MAXAR]; <br> <font color="#008000">//</font> <br> <font color="#0000ff">for</font> ( unsigned <font color="#0000ff">int</font> i = 0; i &lt; DOIT; ++i){ <br> <font color="#0000ff">if</font> ( index &gt;= MAXAR) <br> index = which; <br> <font color="#008000">//</font> <br> <font color="#0000ff">#if</font> defined(SHARED) <br> array[index] = array[index] + 1; <br> <font color="#0000ff">#else</font> <br> array1[index] = array1[index] + 1; <br> <font color="#0000ff">#endif</font> <br> <font color="#008000">//</font> <br> index += TOTAL; <br> } <br> <font color="#008000">//</font> <br> pthread_mutex_lock(&amp;mux); <br> -- workers; <br> pthread_mutex_unlock(&amp;mux); <br> pthread_cond_broadcast(&amp;cond); <br> <font color="#008000">//</font> <br> <font color="#0000ff">return</font> 0; <br> }; <br> <br> <font color="#0000ff">int</font> <br> main() { <br> <font color="#008000">//</font> <br> array = (MTYPE*)calloc(MAXAR, <font color="#0000ff">sizeof</font> (MTYPE)); <br> <font color="#008000">//</font> <br> unsigned <font color="#0000ff">int</font> *which; <br> pthread_t t1; <br> pthread_attr_t attr; <br> <font color="#008000">//</font> <br> pthread_attr_init(&amp;attr); <br> pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED); <br> <font color="#008000">//</font> <br> which = <font color="#0000ff">new</font> unsigned <font color="#0000ff">int</font> (0); <br> pthread_create(&amp;t1, &amp;attr, runner, ( <font color="#0000ff">void</font> *)which); <br> <font color="#008000">//</font> <br> which = <font color="#0000ff">new</font> unsigned <font color="#0000ff">int</font> (1); <br> pthread_create(&amp;t1, &amp;attr, runner, ( <font color="#0000ff">void</font> *)which); <br> <font color="#008000">//</font> <br> pthread_mutex_lock(&amp;mux); <br> <font color="#0000ff">while</font> (!pthread_cond_wait(&amp;cond, &amp;mux)){ <br> <font color="#0000ff">if</font> ( !workers) <br> <font color="#0000ff">break</font> ; <br> }; <br> pthread_mutex_unlock(&amp;mux); <br> <font color="#008000">//</font> <br> <font color="#0000ff">return</font> 0; <br> }; <br> <font color="#008000">//</font> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> <br></code></code> </blockquote> <code><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">#include &lt;sys/types.h&gt; <br> <br> #include &lt;stdio.h&gt; <br> #include &lt;stdlib.h&gt; <br> <br> #include &lt;pthread.h&gt; <br> <br> <font color="#0000ff">#define</font> TBYTES 1024 <br> <font color="#008000">//</font> <br> <font color="#0000ff">#define</font> TOTAL 2 <br> <font color="#008000">//    u_int8_t u_int32_t u_int64_t</font> <br> <font color="#0000ff">#define</font> MTYPE u_int8_t <br> <font color="#008000">//</font> <br> <font color="#0000ff">#define</font> MAXAR TBYTES/ <font color="#0000ff">sizeof</font> (MTYPE) <br> <font color="#0000ff">#define</font> DOIT 100000000 <br> <br> MTYPE *array; <br> <br> pthread_mutex_t mux = PTHREAD_MUTEX_INITIALIZER; <br> pthread_cond_t cond = PTHREAD_COND_INITIALIZER; <br> <font color="#0000ff">int</font> workers = 2; <br> <br> <font color="#008000">//     </font> <br> <font color="#008000">//#define SHARED 1</font> <br> <br> <font color="#0000ff">void</font> * <br> runner( <font color="#0000ff">void</font> * args){ <br> unsigned <font color="#0000ff">int</font> which = *(unsigned <font color="#0000ff">int</font> *)args; delete (unsigned <font color="#0000ff">int</font> *)args; <br> unsigned <font color="#0000ff">int</font> index = which; <br> MTYPE array1[MAXAR]; <br> <font color="#008000">//</font> <br> <font color="#0000ff">for</font> ( unsigned <font color="#0000ff">int</font> i = 0; i &lt; DOIT; ++i){ <br> <font color="#0000ff">if</font> ( index &gt;= MAXAR) <br> index = which; <br> <font color="#008000">//</font> <br> <font color="#0000ff">#if</font> defined(SHARED) <br> array[index] = array[index] + 1; <br> <font color="#0000ff">#else</font> <br> array1[index] = array1[index] + 1; <br> <font color="#0000ff">#endif</font> <br> <font color="#008000">//</font> <br> index += TOTAL; <br> } <br> <font color="#008000">//</font> <br> pthread_mutex_lock(&amp;mux); <br> -- workers; <br> pthread_mutex_unlock(&amp;mux); <br> pthread_cond_broadcast(&amp;cond); <br> <font color="#008000">//</font> <br> <font color="#0000ff">return</font> 0; <br> }; <br> <br> <font color="#0000ff">int</font> <br> main() { <br> <font color="#008000">//</font> <br> array = (MTYPE*)calloc(MAXAR, <font color="#0000ff">sizeof</font> (MTYPE)); <br> <font color="#008000">//</font> <br> unsigned <font color="#0000ff">int</font> *which; <br> pthread_t t1; <br> pthread_attr_t attr; <br> <font color="#008000">//</font> <br> pthread_attr_init(&amp;attr); <br> pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED); <br> <font color="#008000">//</font> <br> which = <font color="#0000ff">new</font> unsigned <font color="#0000ff">int</font> (0); <br> pthread_create(&amp;t1, &amp;attr, runner, ( <font color="#0000ff">void</font> *)which); <br> <font color="#008000">//</font> <br> which = <font color="#0000ff">new</font> unsigned <font color="#0000ff">int</font> (1); <br> pthread_create(&amp;t1, &amp;attr, runner, ( <font color="#0000ff">void</font> *)which); <br> <font color="#008000">//</font> <br> pthread_mutex_lock(&amp;mux); <br> <font color="#0000ff">while</font> (!pthread_cond_wait(&amp;cond, &amp;mux)){ <br> <font color="#0000ff">if</font> ( !workers) <br> <font color="#0000ff">break</font> ; <br> }; <br> pthread_mutex_unlock(&amp;mux); <br> <font color="#008000">//</font> <br> <font color="#0000ff">return</font> 0; <br> }; <br> <font color="#008000">//</font> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <br></code> <br><br>  <b>Program 2.</b> <br><br> <code><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">#include &lt;sys/types.h&gt; <br> <br> #include &lt;stdio.h&gt; <br> #include &lt;stdlib.h&gt; <br> <br> #include &lt;pthread.h&gt; <br> <br> <font color="#0000ff">#define</font> TBYTES 1024 <br> <font color="#008000">//</font> <br> <font color="#0000ff">#define</font> TOTAL 2 <br> <font color="#008000">//    u_int8_t u_int32_t u_int64_t</font> <br> <font color="#0000ff">#define</font> MTYPE u_int64_t <br> <font color="#008000">//</font> <br> <font color="#0000ff">#define</font> MAXAR TBYTES/ <font color="#0000ff">sizeof</font> (MTYPE) <br> <font color="#008000">//#define DOIT 100000000 * (sizeof(u_int64_t) / sizeof(MTYPE))</font> <br> <font color="#0000ff">#define</font> DOIT 100000000 <br> <br> MTYPE *array; <br> <br> pthread_mutex_t mux = PTHREAD_MUTEX_INITIALIZER; <br> pthread_cond_t cond = PTHREAD_COND_INITIALIZER; <br> <font color="#0000ff">int</font> workers = 2; <br> <br> template&lt;typename RTYPE, <font color="#0000ff">int</font> TLEN&gt; <br> RTYPE scramble(u_int16_t *seed, RTYPE a){ <br> <font color="#0000ff">int</font> d; <br> <font color="#008000">//</font> <br> <font color="#0000ff">for</font> ( d = 0; d &lt; 8; ++d){ <br> u_int16_t mask; <br> <font color="#008000">//</font> <br> mask = (*seed &amp; 0x1) ^ ( (*seed &gt;&gt; 1) &amp;0x1); <br> mask = mask &amp; 0x1; <br> *seed = (mask &lt;&lt; 15) | (*seed &gt;&gt; 1); <br> <font color="#008000">//</font> <br> a = a ^ ((RTYPE)mask &lt;&lt; d); <br> } <br> <font color="#008000">//</font> <br> <font color="#0000ff">return</font> a; <br> }; <br> <br> <font color="#008000">//     </font> <br> <font color="#008000">//#define SHARED 1</font> <br> <br> <font color="#0000ff">void</font> * <br> runner( <font color="#0000ff">void</font> * args){ <br> unsigned <font color="#0000ff">int</font> which = *(unsigned <font color="#0000ff">int</font> *)args; delete (unsigned <font color="#0000ff">int</font> *)args; <br> unsigned <font color="#0000ff">int</font> index = which; <br> u_int16_t seed = 0x4a80; <br> MTYPE array1[MAXAR]; <br> <font color="#008000">//</font> <br> <font color="#0000ff">for</font> ( unsigned <font color="#0000ff">int</font> i = 0; i &lt; DOIT; ++i){ <br> MTYPE data; <br> <font color="#0000ff">if</font> ( index &gt;= MAXAR) <br> index = which; <br> <font color="#008000">//</font> <br> <font color="#0000ff">#if</font> defined(SHARED) <br> data = array[index]; <br> array[index] = scramble&lt;MTYPE, 8* <font color="#0000ff">sizeof</font> (MTYPE)&gt;(&amp;seed, data); <br> <font color="#0000ff">#else</font> <br> data = array1[index]; <br> array1[index] = scramble&lt;MTYPE, 8* <font color="#0000ff">sizeof</font> (MTYPE)&gt;(&amp;seed, data); <br> <font color="#0000ff">#endif</font> <br> <font color="#008000">//</font> <br> index += TOTAL; <br> } <br> <font color="#008000">//</font> <br> pthread_mutex_lock(&amp;mux); <br> -- workers; <br> pthread_mutex_unlock(&amp;mux); <br> pthread_cond_broadcast(&amp;cond); <br> <font color="#008000">//</font> <br> <font color="#0000ff">return</font> 0; <br> }; <br> <br> <font color="#0000ff">int</font> <br> main() { <br> <font color="#008000">//</font> <br> array = (MTYPE*)calloc(MAXAR, <font color="#0000ff">sizeof</font> (MTYPE)); <br> <font color="#008000">//</font> <br> unsigned <font color="#0000ff">int</font> *which; <br> pthread_t t1; <br> pthread_attr_t attr; <br> <font color="#008000">//</font> <br> pthread_attr_init(&amp;attr); <br> pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED); <br> <font color="#008000">//</font> <br> which = <font color="#0000ff">new</font> unsigned <font color="#0000ff">int</font> (0); <br> pthread_create(&amp;t1, &amp;attr, runner, ( <font color="#0000ff">void</font> *)which); <br> <font color="#008000">//</font> <br> which = <font color="#0000ff">new</font> unsigned <font color="#0000ff">int</font> (1); <br> pthread_create(&amp;t1, &amp;attr, runner, ( <font color="#0000ff">void</font> *)which); <br> <font color="#008000">//</font> <br> pthread_mutex_lock(&amp;mux); <br> <font color="#0000ff">while</font> (!pthread_cond_wait(&amp;cond, &amp;mux)){ <br> <font color="#0000ff">if</font> ( !workers) <br> <font color="#0000ff">break</font> ; <br> }; <br> pthread_mutex_unlock(&amp;mux); <br> <font color="#008000">//</font> <br> <font color="#0000ff">return</font> 0; <br> }; <br> <font color="#008000">//</font> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> <br></code></code> <blockquote> <code><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">#include &lt;sys/types.h&gt; <br> <br> #include &lt;stdio.h&gt; <br> #include &lt;stdlib.h&gt; <br> <br> #include &lt;pthread.h&gt; <br> <br> <font color="#0000ff">#define</font> TBYTES 1024 <br> <font color="#008000">//</font> <br> <font color="#0000ff">#define</font> TOTAL 2 <br> <font color="#008000">//    u_int8_t u_int32_t u_int64_t</font> <br> <font color="#0000ff">#define</font> MTYPE u_int64_t <br> <font color="#008000">//</font> <br> <font color="#0000ff">#define</font> MAXAR TBYTES/ <font color="#0000ff">sizeof</font> (MTYPE) <br> <font color="#008000">//#define DOIT 100000000 * (sizeof(u_int64_t) / sizeof(MTYPE))</font> <br> <font color="#0000ff">#define</font> DOIT 100000000 <br> <br> MTYPE *array; <br> <br> pthread_mutex_t mux = PTHREAD_MUTEX_INITIALIZER; <br> pthread_cond_t cond = PTHREAD_COND_INITIALIZER; <br> <font color="#0000ff">int</font> workers = 2; <br> <br> template&lt;typename RTYPE, <font color="#0000ff">int</font> TLEN&gt; <br> RTYPE scramble(u_int16_t *seed, RTYPE a){ <br> <font color="#0000ff">int</font> d; <br> <font color="#008000">//</font> <br> <font color="#0000ff">for</font> ( d = 0; d &lt; 8; ++d){ <br> u_int16_t mask; <br> <font color="#008000">//</font> <br> mask = (*seed &amp; 0x1) ^ ( (*seed &gt;&gt; 1) &amp;0x1); <br> mask = mask &amp; 0x1; <br> *seed = (mask &lt;&lt; 15) | (*seed &gt;&gt; 1); <br> <font color="#008000">//</font> <br> a = a ^ ((RTYPE)mask &lt;&lt; d); <br> } <br> <font color="#008000">//</font> <br> <font color="#0000ff">return</font> a; <br> }; <br> <br> <font color="#008000">//     </font> <br> <font color="#008000">//#define SHARED 1</font> <br> <br> <font color="#0000ff">void</font> * <br> runner( <font color="#0000ff">void</font> * args){ <br> unsigned <font color="#0000ff">int</font> which = *(unsigned <font color="#0000ff">int</font> *)args; delete (unsigned <font color="#0000ff">int</font> *)args; <br> unsigned <font color="#0000ff">int</font> index = which; <br> u_int16_t seed = 0x4a80; <br> MTYPE array1[MAXAR]; <br> <font color="#008000">//</font> <br> <font color="#0000ff">for</font> ( unsigned <font color="#0000ff">int</font> i = 0; i &lt; DOIT; ++i){ <br> MTYPE data; <br> <font color="#0000ff">if</font> ( index &gt;= MAXAR) <br> index = which; <br> <font color="#008000">//</font> <br> <font color="#0000ff">#if</font> defined(SHARED) <br> data = array[index]; <br> array[index] = scramble&lt;MTYPE, 8* <font color="#0000ff">sizeof</font> (MTYPE)&gt;(&amp;seed, data); <br> <font color="#0000ff">#else</font> <br> data = array1[index]; <br> array1[index] = scramble&lt;MTYPE, 8* <font color="#0000ff">sizeof</font> (MTYPE)&gt;(&amp;seed, data); <br> <font color="#0000ff">#endif</font> <br> <font color="#008000">//</font> <br> index += TOTAL; <br> } <br> <font color="#008000">//</font> <br> pthread_mutex_lock(&amp;mux); <br> -- workers; <br> pthread_mutex_unlock(&amp;mux); <br> pthread_cond_broadcast(&amp;cond); <br> <font color="#008000">//</font> <br> <font color="#0000ff">return</font> 0; <br> }; <br> <br> <font color="#0000ff">int</font> <br> main() { <br> <font color="#008000">//</font> <br> array = (MTYPE*)calloc(MAXAR, <font color="#0000ff">sizeof</font> (MTYPE)); <br> <font color="#008000">//</font> <br> unsigned <font color="#0000ff">int</font> *which; <br> pthread_t t1; <br> pthread_attr_t attr; <br> <font color="#008000">//</font> <br> pthread_attr_init(&amp;attr); <br> pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED); <br> <font color="#008000">//</font> <br> which = <font color="#0000ff">new</font> unsigned <font color="#0000ff">int</font> (0); <br> pthread_create(&amp;t1, &amp;attr, runner, ( <font color="#0000ff">void</font> *)which); <br> <font color="#008000">//</font> <br> which = <font color="#0000ff">new</font> unsigned <font color="#0000ff">int</font> (1); <br> pthread_create(&amp;t1, &amp;attr, runner, ( <font color="#0000ff">void</font> *)which); <br> <font color="#008000">//</font> <br> pthread_mutex_lock(&amp;mux); <br> <font color="#0000ff">while</font> (!pthread_cond_wait(&amp;cond, &amp;mux)){ <br> <font color="#0000ff">if</font> ( !workers) <br> <font color="#0000ff">break</font> ; <br> }; <br> pthread_mutex_unlock(&amp;mux); <br> <font color="#008000">//</font> <br> <font color="#0000ff">return</font> 0; <br> }; <br> <font color="#008000">//</font> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> <br></code></code> </blockquote> <code><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">#include &lt;sys/types.h&gt; <br> <br> #include &lt;stdio.h&gt; <br> #include &lt;stdlib.h&gt; <br> <br> #include &lt;pthread.h&gt; <br> <br> <font color="#0000ff">#define</font> TBYTES 1024 <br> <font color="#008000">//</font> <br> <font color="#0000ff">#define</font> TOTAL 2 <br> <font color="#008000">//    u_int8_t u_int32_t u_int64_t</font> <br> <font color="#0000ff">#define</font> MTYPE u_int64_t <br> <font color="#008000">//</font> <br> <font color="#0000ff">#define</font> MAXAR TBYTES/ <font color="#0000ff">sizeof</font> (MTYPE) <br> <font color="#008000">//#define DOIT 100000000 * (sizeof(u_int64_t) / sizeof(MTYPE))</font> <br> <font color="#0000ff">#define</font> DOIT 100000000 <br> <br> MTYPE *array; <br> <br> pthread_mutex_t mux = PTHREAD_MUTEX_INITIALIZER; <br> pthread_cond_t cond = PTHREAD_COND_INITIALIZER; <br> <font color="#0000ff">int</font> workers = 2; <br> <br> template&lt;typename RTYPE, <font color="#0000ff">int</font> TLEN&gt; <br> RTYPE scramble(u_int16_t *seed, RTYPE a){ <br> <font color="#0000ff">int</font> d; <br> <font color="#008000">//</font> <br> <font color="#0000ff">for</font> ( d = 0; d &lt; 8; ++d){ <br> u_int16_t mask; <br> <font color="#008000">//</font> <br> mask = (*seed &amp; 0x1) ^ ( (*seed &gt;&gt; 1) &amp;0x1); <br> mask = mask &amp; 0x1; <br> *seed = (mask &lt;&lt; 15) | (*seed &gt;&gt; 1); <br> <font color="#008000">//</font> <br> a = a ^ ((RTYPE)mask &lt;&lt; d); <br> } <br> <font color="#008000">//</font> <br> <font color="#0000ff">return</font> a; <br> }; <br> <br> <font color="#008000">//     </font> <br> <font color="#008000">//#define SHARED 1</font> <br> <br> <font color="#0000ff">void</font> * <br> runner( <font color="#0000ff">void</font> * args){ <br> unsigned <font color="#0000ff">int</font> which = *(unsigned <font color="#0000ff">int</font> *)args; delete (unsigned <font color="#0000ff">int</font> *)args; <br> unsigned <font color="#0000ff">int</font> index = which; <br> u_int16_t seed = 0x4a80; <br> MTYPE array1[MAXAR]; <br> <font color="#008000">//</font> <br> <font color="#0000ff">for</font> ( unsigned <font color="#0000ff">int</font> i = 0; i &lt; DOIT; ++i){ <br> MTYPE data; <br> <font color="#0000ff">if</font> ( index &gt;= MAXAR) <br> index = which; <br> <font color="#008000">//</font> <br> <font color="#0000ff">#if</font> defined(SHARED) <br> data = array[index]; <br> array[index] = scramble&lt;MTYPE, 8* <font color="#0000ff">sizeof</font> (MTYPE)&gt;(&amp;seed, data); <br> <font color="#0000ff">#else</font> <br> data = array1[index]; <br> array1[index] = scramble&lt;MTYPE, 8* <font color="#0000ff">sizeof</font> (MTYPE)&gt;(&amp;seed, data); <br> <font color="#0000ff">#endif</font> <br> <font color="#008000">//</font> <br> index += TOTAL; <br> } <br> <font color="#008000">//</font> <br> pthread_mutex_lock(&amp;mux); <br> -- workers; <br> pthread_mutex_unlock(&amp;mux); <br> pthread_cond_broadcast(&amp;cond); <br> <font color="#008000">//</font> <br> <font color="#0000ff">return</font> 0; <br> }; <br> <br> <font color="#0000ff">int</font> <br> main() { <br> <font color="#008000">//</font> <br> array = (MTYPE*)calloc(MAXAR, <font color="#0000ff">sizeof</font> (MTYPE)); <br> <font color="#008000">//</font> <br> unsigned <font color="#0000ff">int</font> *which; <br> pthread_t t1; <br> pthread_attr_t attr; <br> <font color="#008000">//</font> <br> pthread_attr_init(&amp;attr); <br> pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED); <br> <font color="#008000">//</font> <br> which = <font color="#0000ff">new</font> unsigned <font color="#0000ff">int</font> (0); <br> pthread_create(&amp;t1, &amp;attr, runner, ( <font color="#0000ff">void</font> *)which); <br> <font color="#008000">//</font> <br> which = <font color="#0000ff">new</font> unsigned <font color="#0000ff">int</font> (1); <br> pthread_create(&amp;t1, &amp;attr, runner, ( <font color="#0000ff">void</font> *)which); <br> <font color="#008000">//</font> <br> pthread_mutex_lock(&amp;mux); <br> <font color="#0000ff">while</font> (!pthread_cond_wait(&amp;cond, &amp;mux)){ <br> <font color="#0000ff">if</font> ( !workers) <br> <font color="#0000ff">break</font> ; <br> }; <br> pthread_mutex_unlock(&amp;mux); <br> <font color="#008000">//</font> <br> <font color="#0000ff">return</font> 0; <br> }; <br> <font color="#008000">//</font> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <br></code> <br></div><p>Source: <a href="https://habr.com/ru/post/62168/">https://habr.com/ru/post/62168/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../62158/index.html">Olympus EP-1</a></li>
<li><a href="../62160/index.html">Opera Unite reopens the web</a></li>
<li><a href="../62161/index.html">Columns of the same height + border-bottom!</a></li>
<li><a href="../62163/index.html">ReSabj - a convenient service for discussions (browser, email) without registration</a></li>
<li><a href="../62164/index.html">Yota-Music app</a></li>
<li><a href="../62175/index.html">Free software: what is your share,% username%?</a></li>
<li><a href="../62177/index.html">Touchphone for the blind</a></li>
<li><a href="../62178/index.html">Preserve the original video aspect ratio</a></li>
<li><a href="../62179/index.html">The world's first 128GB flash drive</a></li>
<li><a href="../62181/index.html">Zeo ZQ - sleep correction alarm clock</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>