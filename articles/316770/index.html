<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Connection of peripheral modules to MIPSfpga, for example, ultrasonic distance sensors</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. In this article I will explain how to integrate the modules, using the example of two ultrasonic sensors HC-SR04 and Pmod MAXSONAR, into a s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Connection of peripheral modules to MIPSfpga, for example, ultrasonic distance sensors</h1><div class="post__text post__text-html js-mediator-article">  Good day.  In this article I will explain how to integrate the modules, using the example of two ultrasonic sensors HC-SR04 and Pmod MAXSONAR, into a system on a chip based on MIPSfpga.  I will also tell you how to write a program for managing connected modules. <br><br>  Based on my example, you can connect your own modules and manage them with the help of the program.  Create a system with its own set of peripherals, based on MIPSfpga. <br><br><img src="https://habrastorage.org/files/d55/726/637/d5572663735848adbe8d9c368bd9c64f.jpg"><br><a name="habracut"></a><br>  We will connect this sensor: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <a href="http://store.digilentinc.com/pmodmaxsonar-maxbotix-ultrasonic-range-finder/"><img src="https://habrastorage.org/files/6d6/305/af5/6d6305af56484242a5c343a9aea441dc.jpg" align="left" width="155" height="130"></a> <img src="https://habrastorage.org/files/45e/599/e35/45e599e356954379a3f6731b542a5dc8.jpg" align="right" width="140" height="130"><br>  Documentation for it can be found <a href="http://maxbotix.com/documents/LV-MaxSonar-EZ_Datasheet.pdf">here</a> .  Data will be displayed on the seven-segment indicators on the board.  We will also generate sound signals of various duration using piezo-dynamics. <br><br>  For starters, you need the MIPSfpga sources. <br><br>  Instructions for downloading: <br><br>  ‚Üí <a href="http://www.silicon-russia.com/2015/12/11/mipsfpga-download-instructions">www.silicon-russia.com/2015/12/11/mipsfpga-download-instructions</a> <br><br>  Next, you need to download the MIPSfpga-plus add-on, which allows you to write programs on the UART: <br><br>  ‚Üí <a href="https://github.com/MIPSfpga/mipsfpga-plus">github.com/MIPSfpga/mipsfpga-plus</a> <br><br>  The description and installation instructions are present, in short, in order to be able to just run the script and the project is assembled, you need: <br><br>  Place the MIPSfpga source in the folder: <br><br><pre><code class="1c hljs">C:\MIPSfpga</code> </pre> <br>  And MIPSfpga-plus in: <br><br><pre> <code class="1c hljs">C:\github\mipsfpga-plus</code> </pre> <br>  Next, in the folder <i>C: \ github \ mipsfpga-plus \ boards,</i> select your board, for me it is de0_cv, and execute the <i>make_project</i> script.  The project that you want to run will be in <i>C: \ github \ mipsfpga-plus \ boards \ de0_cv \ project</i> . <br><br>  If your card does not exist, then you can select the most suitable by the number of logical cells and change the destination. <br><br>  You will also need a compiler, linker <a href="https://community.imgtec.com/developers/mips/tools/codescape-mips-sdk/download-codescape-mips-sdk-essentials/">Codescape</a> .  And USB UART converter.  For example, pl2303hx or ch340. <br><br>  The sensor has an analog output, pulse-width modulation output, a serial interface UART, which we will use to connect the sensor to the MIPSfpga.  The connection is made by connecting the registers, in which data from the sensor are displayed, to the bus, through which the processor communicates with the memory. <br><br><h4>  We describe the module that will receive and process data from the sensor. </h4><br>  We will use the UART receiver already described, which is used to program programs, changing only the baud_rate parameter to 9600, which is used by the sensor at such a transmission rate. <br><br><div class="spoiler">  <b class="spoiler_title">Uart receiver module</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">module uart_receiver ( <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> clock, <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> reset_n, <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> rx, output reg [<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] byte_data, output byte_ready ); parameter clock_frequency = <span class="hljs-number"><span class="hljs-number">50000000</span></span>; parameter baud_rate = <span class="hljs-number"><span class="hljs-number">9600</span></span>; localparam clock_cycles_in_symbol = clock_frequency / baud_rate; // Synchronize rx <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> clock reg rx_sync1, rx_sync; <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> @(posedge clock <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> negedge reset_n) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (! reset_n) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> rx_sync1 &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>; rx_sync &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> rx_sync1 &lt;= rx; rx_sync &lt;= rx_sync1; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> // Finding edge <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-type"><span class="hljs-type">bit</span></span> reg prev_rx_sync; <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> @(posedge clock <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> negedge reset_n) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (! reset_n) prev_rx_sync &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> prev_rx_sync &lt;= rx_sync; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> wire start_bit_edge = prev_rx_sync &amp; ! rx_sync; // Counter <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> measure distance <span class="hljs-keyword"><span class="hljs-keyword">between</span></span> symbols reg [<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] counter; reg load_counter; reg [<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] load_counter_value; <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> @(posedge clock <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> negedge reset_n) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (! reset_n) counter &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (load_counter) counter &lt;= load_counter_value; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (counter != <span class="hljs-number"><span class="hljs-number">0</span></span>) counter &lt;= counter - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> wire counter_done = counter == <span class="hljs-number"><span class="hljs-number">1</span></span>; // Shift register <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> accumulate data reg shift; reg [<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] shifted_1; assign byte_ready = shifted_1 [<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> @ (posedge clock <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> negedge reset_n) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (! reset_n) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> shifted_1 &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shift) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shifted_1 == <span class="hljs-number"><span class="hljs-number">0</span></span>) shifted_1 &lt;= <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-string"><span class="hljs-string">'b10000000; else shifted_1 &lt;= shifted_1 &gt;&gt; 1; byte_data &lt;= { rx, byte_data [7:1] }; end else if (byte_ready) begin shifted_1 &lt;= 0; end end reg idle, idle_r; always @* begin idle = idle_r; shift = 0; load_counter = 0; load_counter_value = 0; if (idle) begin if (start_bit_edge) begin load_counter = 1; load_counter_value = clock_cycles_in_symbol * 3 / 2; idle = 0; end end else if (counter_done) begin shift = 1; load_counter = 1; load_counter_value = clock_cycles_in_symbol; end else if (byte_ready) begin idle = 1; end end always @ (posedge clock or negedge reset_n) begin if (! reset_n) idle_r &lt;= 1; else idle_r &lt;= idle; end endmodule</span></span></code> </pre> <br></div></div><br>  According to the datasheet [1], every 49ms, the sonar sends four bytes in ASCII format, the symbol ‚ÄúR‚Äù and three characters of the measured distance, in high bits ahead. <br><br><div class="spoiler">  <b class="spoiler_title">Sonar module</b> <div class="spoiler_text"><pre> <code class="hljs matlab">module sonn ( input clock, input reset_n, input rx, output reg [<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] hword ); reg [<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] count2; wire [<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] byte_data; reg [<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] wordd; always @(posedge clock) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (! reset_n) wordd &lt;= <span class="hljs-number"><span class="hljs-number">32</span></span>'b0; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (byte_ready) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span>(count2) <span class="hljs-number"><span class="hljs-number">2</span></span>'d0:begin wordd[<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span>]&lt;=byte_data; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(byte_data==<span class="hljs-number"><span class="hljs-number">8</span></span>'h52) count2&lt;=<span class="hljs-number"><span class="hljs-number">2</span></span>'d1; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>'d1:begin wordd[<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>]&lt;=byte_data; count2&lt;=<span class="hljs-number"><span class="hljs-number">2</span></span>'d2;<span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>'d2:begin wordd[<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">8</span></span>]&lt;=byte_data; count2&lt;=<span class="hljs-number"><span class="hljs-number">2</span></span>'d3;<span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>'d3:begin wordd[<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>]&lt;=byte_data; count2&lt;=<span class="hljs-number"><span class="hljs-number">2</span></span>'d0; hword={<span class="hljs-number"><span class="hljs-number">4</span></span>'b0000,wordd[<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>],wordd[<span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">8</span></span>],wordd[<span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>]};<span class="hljs-keyword"><span class="hljs-keyword">end</span></span> default begin wordd[<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span>]&lt;=byte_data; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(byte_data==<span class="hljs-number"><span class="hljs-number">8</span></span>'h52) count2&lt;=count2+<span class="hljs-number"><span class="hljs-number">1</span></span>'b1; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> endcase uart_receiver uart(clock,reset_n,rx,byte_data,byte_ready); endmodule</code> </pre> </div></div><br>  For each clock and byte_ready flag (cocked when the byte was received), we expect the character ‚ÄúR‚Äù - 52 in hexadecimal, then proceed to receive the next three characters.  On receiving three bytes, write lower nibbles to the output register, thus transferring from ASCII to binary-decimal format. <br><br>  The module for controlling piezo-dynamics consists of two, in the first, pulses are actually generated with the possibility of selecting a frequency: <br><br><div class="spoiler">  <b class="spoiler_title">Tone module</b> <div class="spoiler_text"><pre> <code class="hljs erlang">module note(clk,reset_n,notein,noteout); input clk,reset_n; input [<span class="hljs-number"><span class="hljs-number">6</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>]notein; output reg noteout; reg [<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>]<span class="hljs-keyword"><span class="hljs-keyword">div</span></span>; reg [<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>]cnt; reg eocnt; always @* <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (notein) <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">191114</span></span>; // C <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">180385</span></span>; // C# <span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">170262</span></span>; // D <span class="hljs-number"><span class="hljs-number">3</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">160705</span></span>; // D# <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">151686</span></span>; // E <span class="hljs-number"><span class="hljs-number">5</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">143173</span></span>; // F <span class="hljs-number"><span class="hljs-number">6</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">135136</span></span>; // F# <span class="hljs-number"><span class="hljs-number">7</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">127552</span></span>; // G <span class="hljs-number"><span class="hljs-number">8</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">120389</span></span>; // G# <span class="hljs-number"><span class="hljs-number">9</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">113636</span></span>; // A <span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">107259</span></span>; // A# <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">101239</span></span>; // H <span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">95558</span></span>; // C <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">90194</span></span>; // C# <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">85132</span></span>; // D <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">80354</span></span>; // D# <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">75845</span></span>; // E <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">71558</span></span>; // F <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">67567</span></span>; // F# <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">63775</span></span>; // G <span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">60197</span></span>; // G# <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">28403</span></span>; // A <span class="hljs-number"><span class="hljs-number">22</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">53629</span></span>; // A# <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">50619</span></span>; // H <span class="hljs-number"><span class="hljs-number">24</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">47777</span></span>; // C <span class="hljs-number"><span class="hljs-number">25</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">45097</span></span>; // C# <span class="hljs-number"><span class="hljs-number">26</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">42566</span></span>; // D <span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">40176</span></span>; // D# <span class="hljs-number"><span class="hljs-number">28</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">37921</span></span>; // E default: <span class="hljs-keyword"><span class="hljs-keyword">div</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; // endcase <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> always @(posedge clk) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(~reset_n) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> noteout&lt;=<span class="hljs-number"><span class="hljs-number">0</span></span>; cnt &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(cnt == <span class="hljs-keyword"><span class="hljs-keyword">div</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> cnt &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; noteout &lt;= ~noteout; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> else cnt &lt;= cnt + <span class="hljs-number"><span class="hljs-number">1</span></span>'b1; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> endmodule</code> </pre> <br></div></div><br>  Count to div and invert the output signal.  The div is chosen as input notein. <br><br>  <i>Div = Fclk / Fnote / 2</i> <br><br>  Where Fclk is the clock frequency, Fnote is the desired frequency of the output signal. <br><br>  And the module where the duration of the sound pulses is regulated: <br><br><div class="spoiler">  <b class="spoiler_title">Buzz module</b> <div class="spoiler_text"><pre> <code class="hljs vhdl">module buzz(clk,reset_n,en,tim,tone); input clk,reset_n,en; input [<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>]tim; output reg tone; wire [<span class="hljs-number"><span class="hljs-number">6</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>]notein; wire noteout; assign notein=<span class="hljs-number"><span class="hljs-number">21</span></span>; reg [<span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>]counter,div,div1; reg ene; <span class="hljs-literal"><span class="hljs-literal">note</span></span> note1(clk,reset_n,notein,noteout); always@(posedge clk) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(~reset_n) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> counter&lt;=<span class="hljs-number"><span class="hljs-number">28</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b0</span></span>; ene&lt;=<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span>(tim) <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> div&lt;=<span class="hljs-number"><span class="hljs-number">28</span></span><span class="hljs-symbol"><span class="hljs-symbol">'d</span></span> <span class="hljs-number"><span class="hljs-number">5_000_000</span></span>; div1&lt;=<span class="hljs-number"><span class="hljs-number">28</span></span><span class="hljs-symbol"><span class="hljs-symbol">'d</span></span> <span class="hljs-number"><span class="hljs-number">12_000_000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> div&lt;=<span class="hljs-number"><span class="hljs-number">28</span></span><span class="hljs-symbol"><span class="hljs-symbol">'d</span></span> <span class="hljs-number"><span class="hljs-number">10_000_000</span></span>; div1&lt;=<span class="hljs-number"><span class="hljs-number">28</span></span><span class="hljs-symbol"><span class="hljs-symbol">'d</span></span> <span class="hljs-number"><span class="hljs-number">20_000_000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> div&lt;=<span class="hljs-number"><span class="hljs-number">28</span></span><span class="hljs-symbol"><span class="hljs-symbol">'d</span></span> <span class="hljs-number"><span class="hljs-number">25_000_000</span></span>; div1&lt;=<span class="hljs-number"><span class="hljs-number">28</span></span><span class="hljs-symbol"><span class="hljs-symbol">'d</span></span> <span class="hljs-number"><span class="hljs-number">35_000_000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> div&lt;=<span class="hljs-number"><span class="hljs-number">28</span></span><span class="hljs-symbol"><span class="hljs-symbol">'d</span></span> <span class="hljs-number"><span class="hljs-number">50_000_000</span></span>; div1&lt;=<span class="hljs-number"><span class="hljs-number">28</span></span><span class="hljs-symbol"><span class="hljs-symbol">'d</span></span> <span class="hljs-number"><span class="hljs-number">60_000_000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> div&lt;=<span class="hljs-number"><span class="hljs-number">28</span></span><span class="hljs-symbol"><span class="hljs-symbol">'d</span></span> <span class="hljs-number"><span class="hljs-number">10_000_000</span></span>; div1&lt;=<span class="hljs-number"><span class="hljs-number">28</span></span><span class="hljs-symbol"><span class="hljs-symbol">'d</span></span> <span class="hljs-number"><span class="hljs-number">20_000_000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> endcase counter&lt;=counter+<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(counter==div) ene&lt;=<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(counter==div1 | counter&gt;<span class="hljs-number"><span class="hljs-number">60_000_000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> counter&lt;=<span class="hljs-number"><span class="hljs-number">28</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b0</span></span>; ene&lt;=<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> always@(posedge clk) tone&lt;=en¬¨eout&amp;ene; endmodule</code> </pre> <br></div></div><br>  Each tick counter is incremented, when the div value is reached, the beep is enabled, when div1 is reached, it is disabled.  This sets the duration and frequency of the audio signals.  Also, the counter is limited to 60000000 to prevent a long pulse, which can occur when changing div1 at the moment when the value of the counter is between div and div1. <br><br><h4>  We connect to the project files with the modules described above. </h4><br><ul><li>  In my top-level file, this is <i>de0_cv.v;</i> we add the following lines: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">wire</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[15:0]</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">hword</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">wire</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[31:0]</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">control</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">sonn</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sonna</span></span> ( <span class="hljs-selector-class"><span class="hljs-selector-class">.clock</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">CLOCK_50</span></span> ), <span class="hljs-selector-class"><span class="hljs-selector-class">.reset_n</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">RESET_N</span></span> ), <span class="hljs-selector-class"><span class="hljs-selector-class">.rx</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">GPIO_0</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span> ), <span class="hljs-selector-class"><span class="hljs-selector-class">.hword</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">hword</span></span> ) ); <span class="hljs-selector-tag"><span class="hljs-selector-tag">buzz</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">buzz</span></span> ( <span class="hljs-selector-class"><span class="hljs-selector-class">.clk</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">CLOCK_50</span></span> ), <span class="hljs-selector-class"><span class="hljs-selector-class">.reset_n</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">RESET_N</span></span> ), <span class="hljs-selector-class"><span class="hljs-selector-class">.en</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">control</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span> ), <span class="hljs-selector-class"><span class="hljs-selector-class">.tim</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">control</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[2:1]</span></span> ), <span class="hljs-selector-class"><span class="hljs-selector-class">.tone</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">GPIO_0</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[35]</span></span> ) );</code> </pre> <br>  For the receiver RX UART input, select the GPIO_0 pin [7] and for the tone GPIO_0 [35] output.  Registers hword and control will be connected to the bus. <br><br><pre> <code class="hljs vhdl"> assign GPIO_0 [<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b1</span></span>; //VCC <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Sensor assign GPIO_0 [<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b0</span></span>; //GND <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Sensor assign GPIO_0 [<span class="hljs-number"><span class="hljs-number">34</span></span>] = <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b0</span></span>; //GND <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> buzz</code> </pre> <br>  Select the legs GPIO_0 [1], GPIO_0 [3], GPIO_0 [34] to power the sensor, common wire for the sensor and piezo-dynamics, respectively. <br><br>  In the description of the module <i>mfp_system</i> add: <br><br><pre> <code class="hljs css"><span class="hljs-selector-class"><span class="hljs-selector-class">.IO_Sonar</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">hword</span></span> ), <span class="hljs-selector-class"><span class="hljs-selector-class">.IO_control</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">control</span></span> ),</code> </pre> <br></li><li>  In the file <i>mfp_system.v we</i> add the inputs to the outputs: <br><br><pre> <code class="hljs lua"> <span class="hljs-built_in"><span class="hljs-built_in">input</span></span> [<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] IO_Sonar, <span class="hljs-built_in"><span class="hljs-built_in">output</span></span> [<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] IO_control,</code> </pre> <br>  In the description of the module <i>mfp_ahb_lite_matrix_with_loader:</i> <br><br><pre> <code class="hljs css"><span class="hljs-selector-class"><span class="hljs-selector-class">.IO_Sonar</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">IO_Sonar</span></span> ), <span class="hljs-selector-class"><span class="hljs-selector-class">.IO_control</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">IO_control</span></span> ),</code> </pre> <br></li><li>  In the file <i>mfp_ahb_lite_matrix_with_loader.v:</i> <br><br><pre> <code class="hljs lua"> <span class="hljs-built_in"><span class="hljs-built_in">input</span></span> [<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] IO_Sonar, <span class="hljs-built_in"><span class="hljs-built_in">output</span></span> [<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] IO_control,</code> </pre> <br>  In the description of the module <i>mfp_ahb_lite_matrix:</i> <br><br><pre> <code class="hljs css"> <span class="hljs-selector-class"><span class="hljs-selector-class">.IO_Sonar</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">IO_Sonar</span></span> ), <span class="hljs-selector-class"><span class="hljs-selector-class">.IO_control</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">IO_control</span></span> ),</code> </pre> <br></li><li>  In the file <i>mfp_ahb_lite_matrix.v:</i> <br><br><pre> <code class="hljs lua"> <span class="hljs-built_in"><span class="hljs-built_in">input</span></span> [<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] IO_Sonar, <span class="hljs-built_in"><span class="hljs-built_in">output</span></span> [<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] IO_control,</code> </pre> <br>  In the description of the module <i>mfp_ahb_gpio_slave</i> <br><br><pre> <code class="hljs css"> <span class="hljs-selector-class"><span class="hljs-selector-class">.IO_Sonar</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">IO_Sonar</span></span> ), <span class="hljs-selector-class"><span class="hljs-selector-class">.IO_control</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">IO_control</span></span>)</code> </pre> <br></li><li>  In the file <i>mfp_ahb_gpio_slave.v:</i> <br><br><pre> <code class="hljs lua"> <span class="hljs-built_in"><span class="hljs-built_in">input</span></span> [<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>]IO_Sonar, <span class="hljs-built_in"><span class="hljs-built_in">output</span></span> reg[<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>]IO_control,</code> </pre> <br>  in the last but one <i>by!</i>  <i>HRESETn</i> <br><br><pre> <code class="hljs lisp"> IO_control &lt;=32'b0<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br>  And in <i>case (write_ionum)</i> <br><br><pre> <code class="hljs"> `MFP_CONTROL_IONUM : IO_control &lt;=HWDATA;</code> </pre> <br>  In the last <i>always in case (read_ionum)</i> <br><br><pre> <code class="hljs scala">`<span class="hljs-type"><span class="hljs-type">MFP_SONAR_SENSOR_IONUM</span></span> : <span class="hljs-type"><span class="hljs-type">HRDATA</span></span> = { <span class="hljs-number"><span class="hljs-number">16</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b0</span></span>, <span class="hljs-type"><span class="hljs-type">IO_Sonar</span></span> };</code> </pre> </li></ul><br>  In the file <i>mfp_ahb_lite_matrix_config.vh</i> which is located in the folder <i>C: \ github \ mipsfpga-plus</i> . <br><br>  Add the following lines: <br><br><pre> <code class="hljs scala">`define <span class="hljs-type"><span class="hljs-type">MFP_SONAR_SENSOR_IONUM</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h6</span></span> `define <span class="hljs-type"><span class="hljs-type">MFP_CONTROL_IONUM</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h9</span></span> `define <span class="hljs-type"><span class="hljs-type">MFP_SONAR_SENSOR_ADDR</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h1f800018</span></span> `define <span class="hljs-type"><span class="hljs-type">MFP_CONTROL_ADDR</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h1f800024</span></span></code> </pre> <br>  Actually this is the address at which registers will be available. <br><br>  Sources of modules and modified files are available here: <br><br>  ‚Üí <a href="https://github.com/Denis-Kingit/UltraSonicToMIPSfpga">github.com/Denis-Kingit/UltraSonicToMIPSfpga</a> <br><br>  Next, we compile the project and flash the board.  Connect the sensor, transducer, piezo: <br><br>  Pin <i>GND</i> converter to <i>GPIO_1 [26]</i> , pin <i>TX</i> to <i>GPIO_1 [31]</i> .  Pyezodinamik to <i>GPIO_0 [34]</i> , <i>GPIO_0 [35]</i> .  Pin <i>GND</i> sensor to <i>GPIO_0 [3]</i> , <i>VCC - GPIO_0 [1], TX - GPIO_0 [7]</i> .  It turns out something like: <br><br><img src="https://habrastorage.org/files/ff8/4e2/a46/ff84e2a46acc4d089c9de044b5bdbb86.jpg"><br><br><h4>  Software part </h4><br>  Copy the contents of the folder <i>C: \ github \ mipsfpga-plus \ programs \ 01_light_sensor</i> or simply work in it.  Add the <i>following</i> registers to the <i>mfp_memory_mapped_registers.h</i> file: <br><br><pre> <code class="hljs delphi">#define MFP_SONAR_SENSOR_ADDR <span class="hljs-number"><span class="hljs-number">0</span></span>xBF800018 #define MFP_CONTROL_ADDR <span class="hljs-number"><span class="hljs-number">0</span></span>xBF800024 #define MFP_SONAR_SENSOR <span class="hljs-comment"><span class="hljs-comment">(* (volatile unsigned *)</span></span> MFP_SONAR_SENSOR_ADDR ) #define MFP_CONTROL <span class="hljs-comment"><span class="hljs-comment">(* (volatile unsigned *)</span></span> MFP_CONTROL_ADDR )</code> </pre> <br>  Now we will write a program in which we will read the values ‚Äã‚Äãfrom the register and output them to the seven-segment indicators.  And depending on the read value, it is controlled by a sound signal.  Change main.c: <br><br><div class="spoiler">  <b class="spoiler_title">Program</b> <div class="spoiler_text"><pre> <code class="hljs kotlin">#include <span class="hljs-string"><span class="hljs-string">"mfp_memory_mapped_registers.h"</span></span> int main () { MFP_CONTROL = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) { MFP_7_SEGMENT_HEX = MFP_SONAR_SENSOR; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(MFP_SONAR_SENSOR&lt;<span class="hljs-number"><span class="hljs-number">0x10</span></span>) MFP_CONTROL = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (MFP_SONAR_SENSOR&lt;<span class="hljs-number"><span class="hljs-number">0x12</span></span>) MFP_CONTROL = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (MFP_SONAR_SENSOR&lt;<span class="hljs-number"><span class="hljs-number">0x14</span></span>) MFP_CONTROL = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (MFP_SONAR_SENSOR&lt;<span class="hljs-number"><span class="hljs-number">0x16</span></span>) MFP_CONTROL = <span class="hljs-number"><span class="hljs-number">7</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> MFP_CONTROL = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br></div></div><br>  Compile by running the script: <br><br><pre> <code class="hljs"> 02_compile_and_link</code> </pre> <br>  Generate the motorola_s_record file: <br><br><pre> <code class="hljs"> 08_generate_motorola_s_record_file</code> </pre> <br>  Check to which COM port the USB UART converter is connected: <br><br><pre> <code class="hljs"> 11_check_which_com_port_is_used</code> </pre> <br>  <i>Modify the 12_upload_to_the_board_using_uart</i> file: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> a=<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mode</span></span> com%a% baud=<span class="hljs-number"><span class="hljs-number">115200</span></span> parity=n <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>=<span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">off</span></span> xon=<span class="hljs-keyword"><span class="hljs-keyword">off</span></span> odsr=<span class="hljs-keyword"><span class="hljs-keyword">off</span></span> octs=<span class="hljs-keyword"><span class="hljs-keyword">off</span></span> dtr=<span class="hljs-keyword"><span class="hljs-keyword">off</span></span> rts=<span class="hljs-keyword"><span class="hljs-keyword">off</span></span> idsr=<span class="hljs-keyword"><span class="hljs-keyword">off</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> program.rec &gt;\.\COM%a%</code> </pre> <br>  where a is the number of the COM port to which the USB UART converter is connected. <br><br>  Finally, download the program: <br><br><pre> <code class="hljs"> 12_upload_to_the_board_using_uart</code> </pre> <br><img src="https://habrastorage.org/files/138/f0f/429/138f0f429d7c49b685e3d7de68e8e209.jpg"><br><br><h4>  Now connect Ultrasonic HC-SR04 </h4><br><div style="text-align:center;"><img src="https://habrastorage.org/files/813/a37/d20/813a37d20d3d4155bdcd13f423c346bb.jpg"></div><br>  The idea of ‚Äã‚Äãthe connection is the same, we display the data from the sensor to the registers connected to the bus. <br><br>  To measure the distance, it is necessary to apply a pulse with a duration of 10 Œºs to the signal Trig pin, after which the ultrasound module will emit eight packets of an ultrasonic signal with a frequency of 40 kHz and detect echo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/c11/5ed/635/c115ed63573744fdac58e7515b5ccbbb.jpg"></div><br>  The measured distance to the object is proportional to the width of the echo, which is encoded by the duration of the electrical signal at the output of the sensor (Echo).  The recommended period between measurements is at least 50ms.  In order to calculate the distance, it is necessary to divide the pulse duration (echo) in microseconds by 58 for the distance in centimeters or by 148 for the distance in inches.  If no obstacles are detected, then the output will be a signal with a duration of 38ms [2]. <br><br><div class="spoiler">  <b class="spoiler_title">Sonic module</b> <div class="spoiler_text"><pre> <code class="hljs vhdl">module sonic(clk,trig,reset_n,en,echo,<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>); input clk,echo,reset_n,en; output reg trig; output reg[<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>]<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>; reg [<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>]count; reg [<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>]countp; always@(posedge clk) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(~reset_n) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> countp&lt;=<span class="hljs-number"><span class="hljs-number">24</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b0</span></span>; count&lt;=<span class="hljs-number"><span class="hljs-number">24</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(en) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(countp==<span class="hljs-number"><span class="hljs-number">0</span></span>) trig&lt;=<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(echo) count&lt;=count+<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(countp==<span class="hljs-number"><span class="hljs-number">500</span></span>) trig&lt;=<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(countp==<span class="hljs-number"><span class="hljs-number">2500000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count&gt;<span class="hljs-number"><span class="hljs-number">1800000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>&lt;=<span class="hljs-number"><span class="hljs-number">24</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hfff</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>&lt;=count/<span class="hljs-number"><span class="hljs-number">2900</span></span>; countp&lt;=<span class="hljs-number"><span class="hljs-number">24</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b0</span></span>; count&lt;=<span class="hljs-number"><span class="hljs-number">24</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> countp&lt;=countp+<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> endmodule</code> </pre> <br></div></div><br>  With a period of 2500000 cycles (50ms), we create a pulse at the output of trig with a duration of 500 cycles (10 Œºs), count the echo duration, divide by 2900 (by 50 for conversion to microseconds and by 58 for conversion to centimeters) and write the result to the register (for If you do not create an additional divider, you can translate it programmatically)) if the pulse duration is greater than 36ms, write 0xFFF, which means that no obstacles were detected. <br><br>  We connect the module in the project‚Äôs top level file ( <i>de0_cv.v</i> ). <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">wire</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[23:0]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">usonic</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">sonic</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sonica</span></span> ( <span class="hljs-selector-class"><span class="hljs-selector-class">.clk</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">CLOCK_50</span></span> ), <span class="hljs-selector-class"><span class="hljs-selector-class">.trig</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">GPIO_0</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[33]</span></span> ), <span class="hljs-selector-class"><span class="hljs-selector-class">.reset_n</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">RESET_N</span></span> ), <span class="hljs-selector-class"><span class="hljs-selector-class">.en</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">control</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[3]</span></span> ), <span class="hljs-selector-class"><span class="hljs-selector-class">.echo</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">GPIO_0</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[32]</span></span> ), <span class="hljs-selector-class"><span class="hljs-selector-class">.out</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">usonic</span></span> ) );</code> </pre> <br>  Similarly, we modify the files: <i>mfp_ahb_gpio_slave.v, mfp_ahb_lite_matrix.v, mfp_ahb_lite_matrix_with_loader.v, mfp_ahb_lite_matrix_config.vh, mfp_system.v</i> in the folder <i>C: \</i> <i>gith_matrix_config.vh, mfp_system.v</i> in the folder folder <i>C: \</i> <i>gith_matrix_config.vh, mfp_site.vb, mfp_ahb_lite.v</i> <br><br>  To connect the sensor, you will need a 5V power supply, the trig pin is connected to GPIO_0 [33], since the sensor operates from 5V, the echo pin must be connected via a voltage divider to GPIO_0 [32], we connect the common wire of the source, sensor and board. <br><br>  We write the program: <br><br><div class="spoiler">  <b class="spoiler_title">Program</b> <div class="spoiler_text"><pre> <code class="hljs lua">#include <span class="hljs-string"><span class="hljs-string">"mfp_memory_mapped_registers.h"</span></span> int main () { int k = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) { //MFP_RED_LEDS = MFP_SONICR_SENSOR &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>; k=MFP_SONIC_SENSOR/<span class="hljs-number"><span class="hljs-number">58</span></span>/<span class="hljs-number"><span class="hljs-number">50</span></span>; MFP_7_SEGMENT_HEX = k; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(k&lt;<span class="hljs-number"><span class="hljs-number">0x10</span></span>) MFP_CONTROL = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (k&lt;<span class="hljs-number"><span class="hljs-number">0x12</span></span>) MFP_CONTROL = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (k&lt;<span class="hljs-number"><span class="hljs-number">0x14</span></span>) MFP_CONTROL = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (k&lt;<span class="hljs-number"><span class="hljs-number">0x16</span></span>) MFP_CONTROL = <span class="hljs-number"><span class="hljs-number">7</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> MFP_CONTROL = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br></div></div><br>  We read the values ‚Äã‚Äãfrom the register, depending on the received value we control the duration of the sound, output the distance value to the seven-segment indicators. <br><br>  You also need to add a new address to the <i>mfp_memory_mapped_registers.h</i> file <i>.</i> <br><br><pre> <code class="hljs delphi">#define MFP_SONIC_SENSOR_ADDR <span class="hljs-number"><span class="hljs-number">0</span></span>xBF800020 #define MFP_SONIC_SENSOR <span class="hljs-comment"><span class="hljs-comment">(* (volatile unsigned *)</span></span> MFP_SONIC_SENSOR_ADDR )</code> </pre> <br><img src="https://habrastorage.org/files/170/290/66e/17029066ed3444378e8612ce2cff414d.jpg"><br><br>  As described above, you can connect your own modules, and manage them programmatically. <br><br><div class="spoiler">  <b class="spoiler_title">useful links</b> <div class="spoiler_text">  [1] LV-MaxSonar - <a href="http://maxbotix.com/documents/LV-MaxSonar-EZ_Datasheet.pdf">maxbotix.com/documents/LV-MaxSonar-EZ_Datasheet.pdf</a> <br>  [2] Ultrasonic HC SR04 - <a href="http://robocraft.ru/blog/electronics/772.html">robocraft.ru/blog/electronics/772.html</a> <br>  Sources MIPSfpga-plus <a href="https://github.com/MIPSfpga/mipsfpga-plus">github.com/MIPSfpga/mipsfpga-plus</a> <br>  Codescape - <a href="https://community.imgtec.com/developers/mips/tools/codescape-mips-sdk/download-codescape-mips-sdk-essentials/">Codescape</a> <br>  Instructions for downloading mipsfpga <a href="http://www.silicon-russia.com/2015/12/11/mipsfpga-download-instructions">- Instructions</a> <br>  Sources of modules, programs and modified files: <br>  <a href="https://github.com/Denis-Kingit/UltraSonicToMIPSfpga">github.com/Denis-Kingit/UltraSonicToMIPSfpga</a> <br>  Just a useful book - David Harris and Sarah Harris "Digital Circuit Design and Computer Architecture" </div></div></div><p>Source: <a href="https://habr.com/ru/post/316770/">https://habr.com/ru/post/316770/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316758/index.html">Linux kernel documentation goes to Python Sphinx</a></li>
<li><a href="../316760/index.html">Enhance your video surveillance system using OpenCV and Telegram bot</a></li>
<li><a href="../316762/index.html">MemC3 - compact Memcache with increased parallelism - due to more stupid caching and smarter hashing</a></li>
<li><a href="../316766/index.html">How Ionic 2 helps me to understand angular 2</a></li>
<li><a href="../316768/index.html">Ludum Dare translation</a></li>
<li><a href="../316772/index.html">November digest of product design: Profstandard, algorithmic design, Adobe XD and technical proficiency</a></li>
<li><a href="../316776/index.html">I spent 3 months trying to get a job after a programming camp, and this is what I learned</a></li>
<li><a href="../316778/index.html">Creating and testing a firewall in Linux, Part 2.3. Finish the firewall. We process traffic in userspace</a></li>
<li><a href="../316782/index.html">Fuel cells as one of the sources of energy for the data center</a></li>
<li><a href="../316784/index.html">Psychology of persuasion. How to convince others and be able to recognize the manipulation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>