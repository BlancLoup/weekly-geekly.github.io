<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Oh, I have a delay. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous article, we talked about reducing the delay in broadcasting video. With the shipment figured out, now let's talk about the delivery. 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Oh, I have a delay. Part 2</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="https://habrahabr.ru/company/erlyvideo/blog/335208/">previous article,</a> we talked about reducing the delay in broadcasting video.  With the shipment figured out, now let's talk about the delivery. <br><br><img src="https://habrastorage.org/webt/dk/sf/2_/dksf2_idafyn8rigkx1rydntzww.png"><br><a name="habracut"></a><br>  The client has places where the video can accumulate and lag behind the real time: <br><br><ul><li>  input network buffer; </li><li>  internal synchronization buffer of transport; </li><li>  protocol buffer to compensate for network speed fluctuations; </li><li>  player buffer; </li><li>  decoder buffer (video card); </li><li>  hardware delays. </li></ul><br>  And this again buffers, buffers and buffers again.  Let's take it in order. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/wv/cu/pf/wvcupfasd_xoyafong0vw4e4vzs.jpeg"><br>  <i>(lamp buffer)</i> <br><br><h2>  Network input buffer </h2><br>  The client receives data through a network socket.  IP sockets have buffers that can be filled when the user program data is not fast enough. <br><br>  If the buffer is too small, the video broadcast will be constantly interrupted, and if it is too large, the user will have to wait until the buffer is filled longer than the required time, determined by the data transfer rate.  In the worst case, if the buffer is under a megabyte, then video can fill up to 4-8 seconds in it. <br><br>  If the buffer is full, you can restore the realtime by either fast forwarding or discarding part of the data.  In fact, this almost never happens, since player developers are postponing this functionality for future releases. <br><br>  From the point of view of proximity to realtime, a large network buffer is evil.  From the point of view of the smoothness of playing the TV channel, this is quite a reasonable thing, because the core works fast enough and well enough to have time to fill its buffers. <br><br>  It is difficult to look at the buffer state on the client, because if there was Linux, you could run the ss utility.  But finding out this information on Android or Windows is more difficult. <br><br><h2>  Demuxer internal synchronization buffer </h2><br>  In various protocols, they love to drag apart audio and video in different ways.  For example, in MPEG-TS, it is customary to take 3-5 audio frames in a row and put them in one packet in order to reduce traffic.  At the same time, the frame flow from ‚ÄúVAVAAVAVAA‚Äù turns into ‚ÄúVVAAAAAVVAAAAVAAAVVVAAA‚Äù. <br><br>  In this case, timestamps are mixed and, if you want to have them sorted further (for example, for returning to RTMP this is critical), then you need to create a buffer that will slow down the frames.  Especially wonderful behavior in such a buffer occurs when the audio disappears completely or on one channel out of five. <br><br>  In general, it is almost impossible to distinguish a complete loss from a very large delay.  Therefore, in the development process, you have to write code that should ‚Äúfeel‚Äù what happened there. <br><br><h2>  Network speed compensation buffer </h2><br>  Here we will talk about the buffer that we have in the HLS, or the buffer that was controlled in the RTMP player. <br><br>  For example, the HLS player is designed like this: <br><br><ul><li>  the player downloads three segments; </li><li>  After downloading the third player starts to lose the stream, starting with the first; </li><li>  one process independently takes the oldest segment, and the other pumps up the first one. </li></ul><br>  In the ideal case, 2-3 segments are supported in the buffer, which can disappear if the network speed starts to subside. <br><br>  Buffer to compensate for fluctuating network speeds laid in any player.  For example, in RTMP this buffer is, theoretically, 0, in HLS it is, theoretically, say 10 seconds, in RTSP players, it is usually real 0, and in SIP it is exactly 0. <br><br>  We say ‚Äútheoretically‚Äù, because nothing will work on the boundary parameters.  For example, HLS players on 1-second fragments can start to work extremely unstable.  Moreover, this may be due to trivial errors such as accounting for the duration of a segment in seconds, and not milliseconds. <br><br>  And the RTMP flash player on the zero buffer behaves just ‚Äúdelightfully‚Äù - it starts accumulating a delay of one second per minute and in a couple of hours it can die in terrible agony. <br><br><h2>  Player buffer </h2><br>  The playback mechanism is almost always separated from the mechanism that downloads video using any protocol.  Frames are unpacked, separated from the metadata and transferred to the player.  Then begins the "strange": Flash and MSE player may require more than one frame to start playing. <br><br>  If this happens, then you again begin to lag and delay.  Here the numbers are about 2‚Äì5 frames, i.e.  up to 200 ms <br><br><h2>  Decoder buffer </h2><br>  A good realtime decoder will immediately decode the received stream and give it away.  The access blocks enter the buffer continuously, with the speed of filling the buffer proportional to the speed of the encoded stream.  Access blocks are loaded into the buffer at different times, because the coded images have a different amount of data.  Data is unloaded from the buffer at regular intervals equal to the frame rate of the reproduced image, and it is unloaded completely and instantly.  If, for example, the starting delay of the new stream is much larger than the finish delay of the old one, then after the last image of the old stream has been played and unloaded from the buffer, it will take a long time to decode and play the first image of the new stream.  This will, for example, lead to the freezing of the last image of the old stream and a noticeable glueing.  If the speed of the new stream is much higher than the speed of the old one, then the splicing will be even more noticeable, since the buffer is full and part of the data is lost. <br><br><img src="https://habrastorage.org/webt/e_/3h/d-/e_3hd-8gn9xly26oqbbp0bxk3zw.jpeg"><br><br>  If you have turned on b-frames on coding a real-time stream, which is a wonderful idea in itself, then you will immediately receive a delay in the amount of N * T, where: <br><br><ul><li>  N is the maximum frame permutation distance, usually around 4 </li><li>  T - frame duration.  For 25 fps, this is 40 ms. </li></ul><br>  Thus, we on an even place receive a delay in a minimum of 160 ms. <br><br>  In reality, a decoder can still slow down a frame or two, or simply not have a good event API for timely notification of frame readiness. <br><br><h2>  Hardware delays on the last meter of video delivery </h2><br>  A huge decoded frame must be shown.  If you decoded not on the video card, but on the processor, then it should be copied to the video memory for display, and this takes time.  Video cards can also add milliseconds, but usually everything is not so terrible here compared to the thousands of milliseconds in previous cases. <br><br><h2>  Total </h2><br>  Having dealt with all kinds of delays in the delivery and receipt of video, you can begin to measure it.  In the next article we will explain how this can be done. </div><p>Source: <a href="https://habr.com/ru/post/345010/">https://habr.com/ru/post/345010/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../344996/index.html">Evaluation of option premiums - analytical formulas vs modeling</a></li>
<li><a href="../344998/index.html">One day at Alpha Lab: Java development</a></li>
<li><a href="../345000/index.html">R and Information Security. How to eliminate the contradiction of interests and run R on Linux in offline mode</a></li>
<li><a href="../345002/index.html">Naive Spellchecking, or search for the nearest words from the dictionary by Levenshtein's metric on Scala</a></li>
<li><a href="../345006/index.html">Technology good</a></li>
<li><a href="../345012/index.html">Task with an asterisk: how we recoded the FIAS in KLADR</a></li>
<li><a href="../345014/index.html">How to manage sections in Oracle DB and not go crazy</a></li>
<li><a href="../345016/index.html">Polymer, fight for performance</a></li>
<li><a href="../345018/index.html">Tutorial on the Unreal Engine. Part 7: Sound</a></li>
<li><a href="../345020/index.html">How I hacked 40 sites in 7 minutes (transfer)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>