<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Change source code (DDL) on the fly</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="With the maintenance of ERP systems, it is sometimes necessary to massively change the code of procedures, functions, triggers or packages. For exampl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Change source code (DDL) on the fly</h1><div class="post__text post__text-html js-mediator-article">  With the maintenance of ERP systems, it is sometimes necessary to massively change the code of procedures, functions, triggers or packages.  For example, to replace a call from one procedure to a call to another. <br>  If you need to change a couple of procedures, you can do it manually, but when you need to change several hundred objects, you have to think about automating the process.  The article describes an automation example for the <b>ORACLE 11g</b> DBMS. <br><a name="habracut"></a><br><h4>  Theory </h4><br>  The DDL scripts of all objects (ORACLE) stored in the <b>SYS.SOURCE $</b> table would seem to be enough to do: <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">source</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">source</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">source</span></span>,<span class="hljs-string"><span class="hljs-string">'old_name'</span></span>,<span class="hljs-string"><span class="hljs-string">'new_name'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">source</span></span> <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%old_name%'</span></span></code> </pre> <br>  but actually changing the source is not enough.  Sources must be compiled. <br>  Compilation is performed using <b>EXECUTE IMMEDIATE</b> . <br>  Prior to version 11, for queries the text of which could not be written to <b>VARCHAR2</b> (32767), it was necessary to use the functionality of the <b>DBMS_SQL</b> package: <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- To process a SQL statement, you must have an open cursor nCursorId := DBMS_SQL.OPEN_CURSOR ; -- Every SQL statement must be parsed DBMS_SQL.PARSE (nCursorId , SqlStatement_CLOB, DBMS_SQL.NATIVE); -- DDL statements are run on the parse, which performs the implied commit.</span></span></code> </pre><br>  The problem is how to get the source of the object. <br>  You can use the cursor to go through the records of the table <b>SYS.SOURCE $</b> - glue the <b>SOURCE</b> fields of each record through the operator " <b>||</b> " and the end of line character.  But there is a simpler way, through the <b>DBMS_METADATA</b> package, which has the <b>GET_DDL</b> function. <br>  The convenience of the DBMS_METADATA.GET_DDL function is not only that it gives all the source code of the object, but also that it substitutes the name of the schema and adds " <b>CREATE OR REPLACE</b> ". <br>  The disadvantage is that the function accepts string arguments while numbers are stored in the <b>SYS.OBJ $</b> table. <br><br><h4>  Algorithm for changing the source code of procedures. </h4><br><ol><li>  Get the sources using DBMS_METADATA.GET_DDL; </li><li>  Change the text as necessary (in the simplest case through REPLACE); </li><li>  Compile the procedure using EXECUTE IMMEDIATE; </li><li>  Enjoy and have fun; </li></ol><br><br><h4>  Practice </h4><br>  In practice, everything is not so simple. <br>  When I logged in with the user <b>SYS</b> , I could not compile the procedures of another scheme ( <b>PROD</b> ), because the tables were not substituted for the names of the schemes, that is, it had: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TABLE_NAME</code> </pre>  , the compiler for some reason expected <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> PROD.TABLE_NAME</code> </pre>  , although at the beginning of the DDL script it was written <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> PROD.PROCEDURE_NAME</code> </pre>  and when in " <b>PL / SQL Developer</b> " or " <b>TOAD</b> " you compile objects of another scheme (not the one under which you log in), everything compiles without errors. <br>  Apparently there is a nuance about which I do not guess, or my hands are not straight enough. <br>  When I logged in to the <b>PROD</b> user, I had an error accessing the <b>SYS.SOURCE $</b> table, it was cured by the privilege <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ANY</span></span> DICTIONARY <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> PROD;</code> </pre>  Privilege needed for debugging <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> DEBUG <span class="hljs-keyword"><span class="hljs-keyword">ANY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> PROD;</code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Automation, scripts, and procedures </h4><br><br><h5>  Source Data Analysis </h5><br>  My task was to replace the function call " <b>GET_ACTUAL_DATE</b> " with the call " <b>SYSDATE</b> ".  Of course, it was possible to replace the code of the GET_ACTUAL_DATE function with ‚ÄúRETURN SYSDATE‚Äù, but then I wouldn‚Äôt have anything to write about in this article :), so let's get started. <br>  First of all, you need to see where the substring "GET_ACTUAL_DATE" occurs: <br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> SC.SOURCE <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> SYS.USER$ UR <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> SYS.OBJ$ OB <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> UR.USER<span class="hljs-comment"><span class="hljs-comment"># = OB.OWNER# JOIN SYS.SOURCE$ SC ON SC.OBJ# = OB.OBJ# WHERE UR.USER# = 50 /* schema id from table USER$ for 'PROD'*/ AND UPPER(SC.SOURCE) LIKE '%' || 'GET_ACTUAL_DATE' || '%' ORDER BY SC.OBJ# , SC.LINE ;</span></span></code> </pre><br>  It turned out 1185 lines in 590 objects. <br>  I looked through the sample and concluded that in order to replace the function call, and not part of the name of a variable or procedure, we must look for <pre> <code class="sql hljs">'(' || 'GET_ACTUAL_DATE'</code> </pre>  , also before calling the function there were other characters: <br><ul><li>  '='; </li><li>  '' (space); </li><li>  ','(comma); </li><li>  '' '' (quotes); </li></ul><br>  Based on this, I wrote a query to generate a search pattern: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> PATTERNS <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'GET_ACTUAL_DATE'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ERST <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> , <span class="hljs-string"><span class="hljs-string">'('</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> OPENING <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> , <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> CLOSING <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> , <span class="hljs-string"><span class="hljs-string">'SYSDATE'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> BECOME <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> DUAL <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'GET_ACTUAL_DATE'</span></span> , <span class="hljs-string"><span class="hljs-string">' '</span></span> , <span class="hljs-string"><span class="hljs-string">''</span></span> , <span class="hljs-string"><span class="hljs-string">'SYSDATE'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> DUAL <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'GET_ACTUAL_DATE'</span></span> , <span class="hljs-string"><span class="hljs-string">'='</span></span> , <span class="hljs-string"><span class="hljs-string">''</span></span> , <span class="hljs-string"><span class="hljs-string">'SYSDATE'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> DUAL <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'GET_ACTUAL_DATE'</span></span> , <span class="hljs-string"><span class="hljs-string">','</span></span> , <span class="hljs-string"><span class="hljs-string">''</span></span> , <span class="hljs-string"><span class="hljs-string">'SYSDATE'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> DUAL <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'GET_ACTUAL_DATE'</span></span> , <span class="hljs-string"><span class="hljs-string">''''</span></span> , <span class="hljs-string"><span class="hljs-string">''</span></span> , <span class="hljs-string"><span class="hljs-string">'SYSDATE'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> DUAL ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> PT.OPENING || PT.ERST || PT.CLOSING <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> , PT.OPENING || PT.BECOME || PT.CLOSING <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> PATTERNS PT ;</code> </pre><br>  Now you could see what happens if you perform substitutions (REPLACE): <br><div class="spoiler">  <b class="spoiler_title">view request</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> PATTERNS <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'GET_ACTUAL_DATE'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ERST , <span class="hljs-string"><span class="hljs-string">'('</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> OPENING , <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> CLOSING , <span class="hljs-string"><span class="hljs-string">'SYSDATE'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> BECOME <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> DUAL <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'GET_ACTUAL_DATE'</span></span> , <span class="hljs-string"><span class="hljs-string">' '</span></span> , <span class="hljs-string"><span class="hljs-string">''</span></span> , <span class="hljs-string"><span class="hljs-string">'SYSDATE'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> DUAL <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'GET_ACTUAL_DATE'</span></span> , <span class="hljs-string"><span class="hljs-string">'='</span></span> , <span class="hljs-string"><span class="hljs-string">''</span></span> , <span class="hljs-string"><span class="hljs-string">'SYSDATE'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> DUAL <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'GET_ACTUAL_DATE'</span></span> , <span class="hljs-string"><span class="hljs-string">','</span></span> , <span class="hljs-string"><span class="hljs-string">''</span></span> , <span class="hljs-string"><span class="hljs-string">'SYSDATE'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> DUAL <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'GET_ACTUAL_DATE'</span></span> , <span class="hljs-string"><span class="hljs-string">''''</span></span> , <span class="hljs-string"><span class="hljs-string">''</span></span> , <span class="hljs-string"><span class="hljs-string">'SYSDATE'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> DUAL ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> SC.OBJ<span class="hljs-comment"><span class="hljs-comment"># AS OBJ# , SC.LINE AS LINE , SC.SOURCE AS SOURCE , REPLACE ( UPPER(SC.SOURCE) , PT.OPENING || PT.ERST || PT.CLOSING , PT.OPENING || PT.BECOME || PT.CLOSING ) AS COMPLETE FROM SYS.USER$ UR JOIN SYS.OBJ$ OB ON UR.USER# = OB.OWNER# JOIN SYS.SOURCE$ SC ON SC.OBJ# = OB.OBJ# , PATTERNS PT WHERE UR.USER# = 50 /* USER PROD */ AND UPPER(SC.SOURCE) LIKE '%' || PT.ERST || '%' AND REPLACE ( UPPER(SC.SOURCE) , PT.OPENING || PT.ERST || PT.CLOSING , PT.OPENING || PT.BECOME || PT.CLOSING ) &lt;&gt; UPPER(SC.SOURCE) ORDER BY OBJ# , LINE ;</span></span></code> </pre><br></div></div><br>  I looked at the result, one line was the declaration of the ‚ÄúGET_ACTUAL_DATE‚Äù function, it was not required to be converted into a ‚ÄúSYSDATE‚Äù declaration. <br>  The other two lines were comments, they also had to be left alone.  I added a script to exclude the specified lines and objects: <br><div class="spoiler">  <b class="spoiler_title">view request</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> EXCLUDE_LINE <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">105857</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> OBJ<span class="hljs-comment"><span class="hljs-comment"># , 321 AS LINE FROM DUAL UNION SELECT 82036 , 50 FROM DUAL ) , EXCLUDE_OBJ AS /*   */ ( SELECT 121939 AS OBJ# FROM DUAL ) , PATTERNS AS ( SELECT 'GET_ACTUAL_DATE' AS ERST , '(' AS OPENING , '' AS CLOSING , 'SYSDATE' AS BECOME FROM DUAL UNION ALL SELECT 'GET_ACTUAL_DATE' , ' ' , '' , 'SYSDATE' FROM DUAL UNION ALL SELECT 'GET_ACTUAL_DATE' , '=' , '' , 'SYSDATE' FROM DUAL UNION ALL SELECT 'GET_ACTUAL_DATE' , ',' , '' , 'SYSDATE' FROM DUAL UNION ALL SELECT 'GET_ACTUAL_DATE' , '''' , '' , 'SYSDATE' FROM DUAL ) SELECT SC.OBJ# AS OBJ# , SC.LINE AS LINE , SC.SOURCE AS SOURCE , REPLACE ( UPPER(SC.SOURCE) , PT.OPENING || PT.ERST || PT.CLOSING , PT.OPENING || PT.BECOME || PT.CLOSING ) AS COMPLETE FROM SYS.USER$ UR JOIN SYS.OBJ$ OB ON UR.USER# = OB.OWNER# JOIN SYS.SOURCE$ SC ON SC.OBJ# = OB.OBJ# , PATTERNS PT WHERE UR.USER# = 50 AND UPPER(SC.SOURCE) LIKE '%' || PT.ERST || '%' AND (SC.OBJ# , SC.LINE ) NOT IN (SELECT EL.OBJ# , EL.LINE FROM EXCLUDE_LINE EL ) AND SC.OBJ# NOT IN (SELECT EO.OBJ# FROM EXCLUDE_OBJ EO ) AND REPLACE ( UPPER(SC.SOURCE) , PT.OPENING || PT.ERST || PT.CLOSING , PT.OPENING || PT.BECOME || PT.CLOSING ) &lt;&gt; UPPER(SC.SOURCE) ORDER BY OBJ# , LINE ;</span></span></code> </pre><br></div></div><br>  Executed the query, looked at the sample - approx. <br><br><h5>  Preservation of substitutions </h5><br>  Now the result of the ‚Äúcalculation‚Äù of substitutions had to be saved somewhere.  Add a table: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> SWAP_SOURCE_CODE ( BATCH <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*   /      */</span></span> OBJ<span class="hljs-comment"><span class="hljs-comment"># NUMBER, /*  */ LINE NUMBER, /*  */ SOURCE VARCHAR2(4000 BYTE), /*   SYS.SOURCE$.SOURCE%TYPE */ OUTPUT VARCHAR2(4000 BYTE), /*   */ CONSTRAINT PK_SWAP_SOURCE_CODE PRIMARY KEY (BATCH, OBJ#, LINE) USING INDEX TABLESPACE PROD_INDEX STORAGE (INITIAL 80 K NEXT 1 M MAXEXTENTS UNLIMITED) )</span></span></code> </pre><br>  Populating the SWAP_SOURCE_CODE table with data: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SWAP_SOURCE_CODE <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> EXCLUDE_LINE <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">105857</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> OBJ<span class="hljs-comment"><span class="hljs-comment"># , 321 AS LINE FROM DUAL UNION SELECT 82036 , 50 FROM DUAL ) , EXCLUDE_OBJ AS /*   */ ( SELECT 121939 AS OBJ# FROM DUAL ) , BATCH_NUMBER AS /*    */ ( SELECT (COALESCE (MAX(BATCH),0) +1) AS BATCH# FROM PROD.SWAP_SOURCE_CODE ) , PATTERNS AS /*   */ ( SELECT 'GET_ACTUAL_DATE' AS ERST , '(' AS OPENING , '' AS CLOSING , 'SYSDATE' AS BECOME FROM DUAL UNION ALL SELECT 'GET_ACTUAL_DATE' , ' ' , '' , 'SYSDATE' FROM DUAL UNION ALL SELECT 'GET_ACTUAL_DATE' , '=' , '' , 'SYSDATE' FROM DUAL UNION ALL SELECT 'GET_ACTUAL_DATE' , ',' , '' , 'SYSDATE' FROM DUAL UNION ALL SELECT 'GET_ACTUAL_DATE' , '''' , '' , 'SYSDATE' FROM DUAL ) SELECT BATCH_NUMBER.BATCH# , SC.OBJ# AS OBJ# , SC.LINE AS LINE , SC.SOURCE AS SOURCE , REPLACE ( UPPER(SC.SOURCE) , PT.OPENING || PT.ERST || PT.CLOSING , PT.OPENING || PT.BECOME || PT.CLOSING ) AS COMPLETE FROM SYS.USER$ UR JOIN SYS.OBJ$ OB ON UR.USER# = OB.OWNER# JOIN SYS.SOURCE$ SC ON SC.OBJ# = OB.OBJ# , PATTERNS PT , BATCH_NUMBER WHERE UR.USER# = 50 /*      PROD */ AND UPPER(SC.SOURCE) LIKE '%' || PT.ERST || '%' AND (SC.OBJ# , SC.LINE ) NOT IN (SELECT EL.OBJ# , EL.LINE FROM EXCLUDE_LINE EL ) AND SC.OBJ# NOT IN (SELECT EO.OBJ# FROM EXCLUDE_OBJ EO ) AND REPLACE ( UPPER(SC.SOURCE) , PT.OPENING || PT.ERST || PT.CLOSING , PT.OPENING || PT.BECOME || PT.CLOSING ) &lt;&gt; UPPER(SC.SOURCE) ORDER BY OBJ# , LINE ;</span></span></code> </pre><br>  Check the result of substitutions: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> SWAP_SOURCE_CODE;</code> </pre><br>  I did not do the generation of substitutions by the procedure because the conditions of substitutions are different each time and it‚Äôs not a fact that once again using PL / SQL it will be convenient to describe the algorithm for converting the original DDL script to the target, usually this is done by an external program (written in C #, Ruby Perl). <br><h5>  Perform substitution </h5><br>  Now we have substitutions in the SWAP_SOURCE_CODE table, and you can perform substitutions, while you need to save the source before performing the substitutions and, of course, you need to save the source after the substitutions.  To do this, add the table SOURCE_CODE_BACKUP: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> SOURCE_CODE_BACKUP ( BATCH <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> OBJ <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> CODE_BACKUP <span class="hljs-keyword"><span class="hljs-keyword">CLOB</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> CODE_UPDATE <span class="hljs-keyword"><span class="hljs-keyword">CLOB</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_SOURCE_CODE_BACKUP PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (BATCH, OBJ) <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLESPACE</span></span> PROD_INDEX <span class="hljs-keyword"><span class="hljs-keyword">STORAGE</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">INITIAL</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> K <span class="hljs-keyword"><span class="hljs-keyword">NEXT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> M <span class="hljs-keyword"><span class="hljs-keyword">MAXEXTENTS</span></span> NLIMITED) )</code> </pre><br>  Perform substitution procedure P_REPLACE_SOURCE_WITH_OUTPUT: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> P_REPLACE_SOURCE_WITH_OUTPUT ( N_BATCH_IN <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span> <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURSOR</span></span> GetObjFromSwap_Source_Code ( nBatchIn <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> SW.OBJ<span class="hljs-comment"><span class="hljs-comment"># AS OBJ FROM SWAP_SOURCE_CODE SW WHERE SW.BATCH = nBatchIn GROUP BY SW.OBJ# ORDER BY SW.OBJ# ; TYPE T_OBJ_TABLE IS TABLE OF GetObjFromSwap_Source_Code%ROWTYPE; OBJ_TABLE T_OBJ_TABLE := T_OBJ_TABLE(); nObjCount NUMBER ; nObjFirstIndex NUMBER ; nObjLastIndex NUMBER ; nObj NUMBER; ObjBackup_CLOB CLOB ; /*   */ ObjUpdate_CLOB CLOB ; /*    */ nBATCH NUMBER; /*      */ CURSOR GetNextBatchNumber IS SELECT COALESCE( MAX(SB.BATCH),0 ) + 1 FROM SOURCE_CODE_BACKUP SB ; nIsEqual NUMBER ; /*         */ /*     */ PROCEDURE PARSE_SOURCE_CODE_WITH_OUTPUT ( nObjIn IN NUMBER /*    */ , nBatchIn IN NUMBER /*     */ , ObjBackupOut_CLOB OUT CLOB /*   */ , ObjUpdateOut_CLOB OUT CLOB /*   */ ) AS /*         */ CURSOR GetObjNameTypeSchema ( nObjIn IN NUMBER ) IS /*           SYS.DBA_OBJECTS ,   DBMS_METADATA.GET_DDL   ,       DBA_OBJECTS       "_" ,      http://docs.oracle.com/cd/B19306_01/appdev.102/b14258/d_metada.htm#BGBBIEGA */ WITH OBJ_TYPE AS ( SELECT 0 AS TYPE#, 'NEXT_OBJECT' AS NAME FROM DUAL UNION ALL SELECT 1, 'INDEX' FROM DUAL UNION ALL SELECT 2, 'TABLE' FROM DUAL UNION ALL SELECT 3, 'CLUSTER' FROM DUAL UNION ALL SELECT 4, 'VIEW' FROM DUAL UNION ALL SELECT 5, 'SYNONYM' FROM DUAL UNION ALL SELECT 6, 'SEQUENCE' FROM DUAL UNION ALL SELECT 7, 'PROCEDURE' FROM DUAL UNION ALL SELECT 8, 'FUNCTION' FROM DUAL UNION ALL /*      'PACKAGE'         ,        'PACKAGE_SPEC' */ SELECT 9, 'PACKAGE_SPEC' FROM DUAL UNION ALL -- 'PACKAGE' SELECT 11, 'PACKAGE_BODY' FROM DUAL UNION ALL SELECT 12, 'TRIGGER' FROM DUAL UNION ALL /*      'TYPE'        ,        'TYPE_SPEC' */ SELECT 13, 'TYPE_SPEC' FROM DUAL UNION ALL --TYPE SELECT 14, 'TYPE_BODY' FROM DUAL UNION ALL SELECT 19, 'TABLE_PARTITION' FROM DUAL UNION ALL SELECT 20, 'INDEX_PARTITION' FROM DUAL UNION ALL SELECT 21, 'LOB' FROM DUAL UNION ALL SELECT 22, 'LIBRARY' FROM DUAL UNION ALL SELECT 23, 'DIRECTORY' FROM DUAL UNION ALL SELECT 24, 'QUEUE' FROM DUAL UNION ALL SELECT 28, 'JAVA_SOURCE' FROM DUAL UNION ALL SELECT 29, 'JAVA_CLASS' FROM DUAL UNION ALL SELECT 30, 'JAVA_RESOURCE' FROM DUAL UNION ALL SELECT 32, 'INDEXTYPE' FROM DUAL UNION ALL SELECT 33, 'OPERATOR' FROM DUAL UNION ALL SELECT 34, 'TABLE_SUBPARTITION' FROM DUAL UNION ALL SELECT 35, 'INDEX_SUBPARTITION' FROM DUAL UNION ALL SELECT 39, 'LOB_PARTITION' FROM DUAL UNION ALL SELECT 40, 'LOB_SUBPARTITION' FROM DUAL UNION ALL SELECT 43, 'DIMENSION' FROM DUAL UNION ALL SELECT 44, 'CONTEXT' FROM DUAL UNION ALL SELECT 47, 'RESOURCE_PLAN' FROM DUAL UNION ALL SELECT 48, 'CONSUMER_GROUP' FROM DUAL UNION ALL SELECT 51, 'SUBSCRIPTION' FROM DUAL UNION ALL SELECT 52, 'LOCATION' FROM DUAL UNION ALL SELECT 56, 'JAVA_DATA' FROM DUAL ) SELECT OB.NAME , TP.NAME , UR.NAME FROM SWAP_SOURCE_CODE SW JOIN SYS.OBJ$ OB ON SW.OBJ# = OB.OBJ# JOIN SYS.USER$ UR ON UR.USER# = OB.OWNER# LEFT JOIN OBJ_TYPE TP ON OB.TYPE# = TP.TYPE# WHERE SW.OBJ# = nObjIn ; ObjRaw_CLOB CLOB; /*    */ ObjParsed_CLOB CLOB; /* DDL      */ sObjName VARCHAR2(30); /*   */ sTypeName VARCHAR2(30); /*   */ sSchemaName VARCHAR2(30); /*   */ /*       */ CURSOR GetSourceOutputFromSwap_Source ( nObjectNumberIn IN NUMBER , nBatchNumberIn IN NUMBER ) IS SELECT SW.SOURCE AS SOURCE , SW.OUTPUT AS OUTPUT FROM SWAP_SOURCE_CODE SW WHERE SW.BATCH = nBatchNumberIn AND SW.OBJ# = nObjectNumberIn ORDER BY SW.LINE ; TYPE T_SOURCE_AND_OUTPUT_TABLE IS TABLE OF GetSourceOutputFromSwap_Source%ROWTYPE; SourceAndOutput_TABLE T_SOURCE_AND_OUTPUT_TABLE := T_SOURCE_AND_OUTPUT_TABLE(); nSourceCount NUMBER ; nSourceFirstIndex NUMBER ; nSourceLastIndex NUMBER ; sPlaceholder SYS.SOURCE$.SOURCE%TYPE; /*    */ sSubstitute SYS.SOURCE$.SOURCE%TYPE; /*    */ BEGIN /*   GET_DDL   ,      */ OPEN GetObjNameTypeSchema(nObjIn); FETCH GetObjNameTypeSchema INTO sObjName, sTypeName, sSchemaName; CLOSE GetObjNameTypeSchema; /*    */ ObjRaw_CLOB := DBMS_METADATA.GET_DDL ( OBJECT_TYPE =&gt; sTypeName , NAME =&gt; sObjName , SCHEMA =&gt; sSchemaName ); /*    */ ObjBackupOut_CLOB := ObjRaw_CLOB ; /*      */ ObjParsed_CLOB := ObjRaw_CLOB; OPEN GetSourceOutputFromSwap_Source ( nObjectNumberIn =&gt; nObjIn , nBatchNumberIn =&gt; nBatchIn ); FETCH GetSourceOutputFromSwap_Source BULK COLLECT INTO SourceAndOutput_TABLE; CLOSE GetSourceOutputFromSwap_Source ; nSourceCount := SourceAndOutput_TABLE.COUNT; IF ( nSourceCount &gt; 0 ) THEN nSourceFirstIndex := SourceAndOutput_TABLE.FIRST; nSourceLastIndex := SourceAndOutput_TABLE.LAST; FOR indx IN nSourceFirstIndex .. nSourceLastIndex LOOP sPlaceholder := SourceAndOutput_TABLE(indx).SOURCE ; sSubstitute := SourceAndOutput_TABLE(indx).OUTPUT ; /*   */ ObjParsed_CLOB := REPLACE ( ObjParsed_CLOB , sPlaceholder , sSubstitute ); END LOOP; /*     */ ObjUpdateOut_CLOB := ObjParsed_CLOB ; END IF ; END PARSE_SOURCE_CODE_WITH_OUTPUT ; BEGIN /*    */ OPEN GetNextBatchNumber; FETCH GetNextBatchNumber INTO nBATCH; CLOSE GetNextBatchNumber; /*       */ OPEN GetObjFromSwap_Source_Code(N_BATCH_IN); FETCH GetObjFromSwap_Source_Code BULK COLLECT INTO OBJ_TABLE; CLOSE GetObjFromSwap_Source_Code; nObjCount := OBJ_TABLE.COUNT; IF ( nObjCount &gt; 0 ) THEN nObjFirstIndex := OBJ_TABLE.FIRST; nObjLastIndex := OBJ_TABLE.LAST; FOR indx IN nObjFirstIndex .. nObjLastIndex LOOP /*     */ nObj := OBJ_TABLE(indx).OBJ; /*   */ PARSE_SOURCE_CODE_WITH_OUTPUT ( nObjIn =&gt; nObj , nBatchIn =&gt; N_BATCH_IN , ObjBackupOut_CLOB =&gt; ObjBackup_CLOB , ObjUpdateOut_CLOB =&gt; ObjUpdate_CLOB ); /*       */ nIsEqual := DBMS_LOB.COMPARE(ObjBackup_CLOB,ObjUpdate_CLOB); IF( nIsEqual IS NOT NULL /* NULL    CLOB_   */ AND nIsEqual &lt;&gt; 0 /*  CLOB _   0,      0 */ ) THEN /*  CLOB _       SOURCE_CODE_BACKUP */ INSERT INTO SOURCE_CODE_BACKUP (BATCH,OBJ,CODE_BACKUP,CODE_UPDATE) VALUES(nBATCH,nObj,ObjBackup_CLOB,ObjUpdate_CLOB) ; END IF ; END LOOP; END IF ; END P_REPLACE_SOURCE_WITH_OUTPUT ;</span></span></code> </pre><br>  Perform the procedure: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> P_REPLACE_SOURCE_WITH_OUTPUT( N_BATCH_IN =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre><br>  After that, in theory, you can check what was accumulated there. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> SOURCE_CODE_BACKUP;</code> </pre><br><h5>  Compilation of objects </h5><br>  And here we are at the finish line - it remains to compile all the objects - execute DDL scripts. <br>  Perform the same procedure - P_EXECUTE_CODE_UPDATE: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> P_EXECUTE_CODE_UPDATE ( N_BATCH_IN <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span> <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-comment"><span class="hljs-comment">/*       ,       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURSOR</span></span> GetUpdateFromSourceCodeBackup ( nBatchNumberIn <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> SB.CODE_UPDATE <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> CodeUpdate , SB.OBJ <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> Obj <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> SOURCE_CODE_BACKUP SB <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> SYS.OBJ$ OB <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> SB.OBJ = OB.OBJ<span class="hljs-comment"><span class="hljs-comment"># WHERE SB.BATCH = nBatchNumberIn AND OB.TYPE# &lt;&gt; 12 -- 12, 'TRIGGER' /*    DBMS_METADATA.GET_DDL         ,     DDL     ,     ,    DBMS_METADATA           */ ORDER BY SB.BATCH , SB.OBJ ; TYPE T_CodeUpdate IS TABLE OF GetUpdateFromSourceCodeBackup%ROWTYPE; CodeUpdate_TABLE T_CodeUpdate := T_CodeUpdate(); nCodeUpdateCount NUMBER; nCodeUpdateFirst NUMBER; nCodeUpdateLast NUMBER; /*      */ SqlText_CLOB CLOB; nObj NUMBER; /*      */ CURSOR GetObjName( ObjIn IN NUMBER ) IS SELECT OB.NAME AS ObjectName FROM SYS.OBJ$ OB WHERE OB.OBJ# = ObjIn ; /*    ORACLE     30- ,      -   32767 */ sObjectName VARCHAR2(32767); BEGIN /*   " "  ,    */ DBMS_OUTPUT.ENABLE(NULL); /*   DDL    */ OPEN GetUpdateFromSourceCodeBackup(N_BATCH_IN); FETCH GetUpdateFromSourceCodeBackup BULK COLLECT INTO CodeUpdate_TABLE; CLOSE GetUpdateFromSourceCodeBackup; nCodeUpdateCount := CodeUpdate_TABLE.COUNT; IF ( nCodeUpdateCount &gt; 0 ) THEN nCodeUpdateFirst := CodeUpdate_TABLE.FIRST; nCodeUpdateLast := CodeUpdate_TABLE.LAST; FOR indx IN nCodeUpdateFirst .. nCodeUpdateLast LOOP /*   DDL  */ SqlText_CLOB := CodeUpdate_TABLE(indx).CodeUpdate; /*    */ nObj := CodeUpdate_TABLE(indx).Obj; /*    */ OPEN GetObjName(nObj); FETCH GetObjName INTO sObjectName ; CLOSE GetObjName; /*            */ DBMS_OUTPUT.PUT_LINE( '#' || LPAD (indx, 3,'0' )|| ' Process .. ' || sObjectName || ' ' || nObj ); /*  DDL  */ EXECUTE IMMEDIATE SqlText_CLOB; /*       ,             */ DBMS_OUTPUT.PUT_LINE( '#' || LPAD (indx, 3,'0' )|| ' Complete ' || sObjectName || ' ' || nObj ); END LOOP; END IF; END;</span></span></code> </pre><br>  We carry out: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> PARUS.P_EXECUTE_CODE_UPDATE( N_BATCH_IN =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre><br>  We compiled all the objects except for the triggers, select the triggers from our run: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> SWAP_SOURCE_CODE SW <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> SYS.OBJ$ OB <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> OB.OBJ<span class="hljs-comment"><span class="hljs-comment"># = SW.OBJ# WHERE OB.TYPE# = 12 AND SW.BATCH = 1 ;</span></span></code> </pre><br>  We execute trigger scripts in parts, first the part where the trigger is created, then the part where the trigger is turned on. <br><br><h4>  Conclusion </h4><br>  Sources are changed as necessary and compiled.  The original sources are preserved, you can restore the original objects from them without contacting the administrator of the DBMS with a request to deploy the backup. <br>  Why was it so easy for me to perform the substitution of one function for another?  Because this ERP is out of the box with a 20-year history, the code is monitored, the code is designed in the same style, if it was an ERP on my knee, it‚Äôs not a fact that I would be able to perform the substitution of the function name so easily. <br>  Comrades, do not be your enemies, love yourself - watch your code, let it be written in the same style according to the same standards! <br>  Amen. <br><br><h4>  Links </h4><br><ol><li>  <a href="http://stackoverflow.com/questions/2478670/what-privileges-do-you-need-to-access-sys-tables">privileges to read the SYS.SOURCE $ table</a> </li><li>  <a href="http://docs.oracle.com/cd/B19306_01/appdev.102/b14258/d_metada.htm">object types for the DBMS_METADATA.GET_DDL function</a> </li><li>  <a href="http://docs.oracle.com/cd/B28359_01/appdev.111/b28370/dynamic.htm">use DBMS_SQL to perform dynamic SQL</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/280648/">https://habr.com/ru/post/280648/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280638/index.html">Xamarin is now free. "In the debugger, I have an exception (vosk. Sign)"</a></li>
<li><a href="../280640/index.html">[The Methanum project] Creating tools for building distributed systems with the ‚ÄúStar‚Äù topology</a></li>
<li><a href="../280642/index.html">man! (D => Rust) .basics</a></li>
<li><a href="../280644/index.html">We look at the drying of paint: How I filled the game on the Steam Store without any approval from Valve</a></li>
<li><a href="../280646/index.html">Steganography in acroconstructions. Algorithm DANTSOVA</a></li>
<li><a href="../280652/index.html">EMC relies on ReactOS for storing big data in the IoT sphere</a></li>
<li><a href="../280656/index.html">SQL Server 2014 Developer Edition is now free</a></li>
<li><a href="../280660/index.html">Traditional April 1 on the Internet</a></li>
<li><a href="../280662/index.html">CLRium # 3: .NET Technology Workshop</a></li>
<li><a href="../280664/index.html">8 harmful tips to "accelerate" the site</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>