<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Memory mapped files</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I would like to talk about such a wonderful thing as memory-mapped files, hereinafter - MMF ). 
 Sometimes their use can give quite a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Memory mapped files</h1><div class="post__text post__text-html js-mediator-article">  In this article I would like to talk about such a wonderful thing as memory-mapped files, hereinafter - <b>MMF</b> ). <br>  Sometimes their use can give quite a significant performance boost compared with the usual buffered file handling. <br><a name="habracut"></a><br>  This is a mechanism that allows you to display files on the memory.  Thus, when reading data from it, the corresponding bytes are read from the file.  The recording is similar. <br>  ‚ÄúCool, of course, but what does it give?‚Äù - you ask.  Let me explain by example. <br>  Suppose we face the task of processing a large file (several tens or even hundreds of megabytes).  It would seem that the task is trivial - open the file, copy it block by block from it into memory, process it.  What happens when this happens?  Each block is copied to a temporary cache, then from it to our memory.  And so with each block.  There is non-optimal use of memory for cache + a bunch of copy operations.  What to do? <br>  This is where the MMF mechanism comes to our rescue.  When we access the memory in which the file is mapped, the data is loaded from the disk into the cache (if they are not there yet), then the cache is mapped into the address space of our program.  If this data is deleted, the mapping is canceled.  Thus, we get rid of the copy operation from the cache to the buffer.  In addition, we do not need to bathe about optimizing the work with the disk - all the dirty work takes the core of the OS. <br>  At one time I was conducting an experiment.  Measured using quantify, the speed of the program, which is buffered, copies a large 500 MB file to another file.  And the speed of the program, which does the same, but with the help of MMF.  So the second one works faster by almost 30% (in Solaris, in other OSs the result may differ).  Agree, not bad. <br>  To take advantage of this opportunity, we must inform the kernel about our desire to map the file to memory.  This is done using the <b>mmap ()</b> function. <br><blockquote><code><font color="black">#include&lt;sys/mman.h&gt; <br> <font color="#0000ff">void</font> *mmap( <font color="#0000ff">void</font> *addr, size_t len, <font color="#0000ff">int</font> prot, <font color="#0000ff">int</font> flag, <font color="#0000ff">int</font> filedes, off_t off);</font></code> </blockquote> <br>  It returns the address of the beginning of the portion of the mapped memory or <b>MAP_FAILED</b> in case of failure. <br>  The first argument is the desired address of the beginning of the area of ‚Äã‚Äãthe displayed memory.  I do not know when it might be useful.  Passing 0 - then the kernel itself will select this address. <br>  <b>len</b> is the number of bytes to display in memory. <br>  <b>prot</b> is a number that determines the security level of the mapped memory area (read only, write only, execution, area is not available).  Common values ‚Äã‚Äãare <b>PROT_READ</b> , <b>PROT_WRITE</b> (can be kombinirovat through OR).  I will not dwell on it - read in more detail in mana.  I will only note that the memory security will not be established lower than the rights with which the file is opened. <br>  <b>flag</b> - describes the attributes of the area.  The normal value is <b>MAP_SHARED</b> .  For the rest - smoke mana.  But I note that using <b>MAP_FIXED</b> reduces the portability of the application, since  its support is optional on POSIX systems. <br>  <b>filedes</b> - as you have already guessed - the file descriptor to be displayed. <br>  <b>off</b> - offset of the displayed area from the beginning of the file. <br><br>  <b>Important note</b> .  If you plan to use MMF to write to a file, before mapping you need to set the final file size not less than the size of the mapped memory!  Otherwise, you will fall for <a href="http://ru.wikipedia.org/wiki/SIGBUS">SIGBUS.</a> <br><br>  Below is an example (honestly styled from a wonderful book <a href="http://www.ozon.ru/context/detail/id/3406745/">"Unix. Professional Programming"</a> ) of a program that copies a file using MMF. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">#include &lt;fcntl.h&gt; <br> #include &lt;sys/mman.h&gt; <br> <font color="#0000ff">int</font> main( <font color="#0000ff">int</font> argc, <font color="#0000ff">char</font> *argv[]) <br> { <br> <font color="#0000ff">int</font> fdin, fdout; <br> <font color="#0000ff">void</font> *src, *dst; <br> <font color="#0000ff">struct</font> stat statbuf; <br> <font color="#0000ff">if</font> (argc != 3) <br> err_quit( <font color="#A31515">": %s &lt;fromfile&gt; &lt;tofile&gt;"</font> , argv[0]); <br> <font color="#0000ff">if</font> ( (fdin = open(argv[1], O_RDONLY)) &lt; 0 ) <br> err_sys( <font color="#A31515">"  %s  "</font> , argv[1]); <br> <font color="#0000ff">if</font> ( (fdout = open(argv[2], O_RDWR | O_CREAT | O_TRUNC, FILE_MODE)) &lt; 0 ) <br> err_sys( <font color="#A31515">"  %s  "</font> , argv[2]); <br> <font color="#0000ff">if</font> ( fstat(fdin, &amp;statbuf) &lt; 0 ) <font color="#008000">/*     */</font> <br> err_sys( <font color="#A31515">"fstat error"</font> ); <br> <font color="#008000">/*     */</font> <br> <font color="#0000ff">if</font> ( lseek(fdout, statbuf.st_size - 1, SEEK_SET) == -1 ) <br> err_sys( <font color="#A31515">"   lseek"</font> ); <br> <font color="#0000ff">if</font> ( write(fdout, <font color="#A31515">""</font> , 1) != 1 ) <br> err_sys( <font color="#A31515">"   write"</font> ); <br> <font color="#0000ff">if</font> ( (src = mmap(0, statbuf.st_size, PROT_READ, MAP_SHARED, fdin, 0)) == MAP_FAILED ) <br> err_sys( <font color="#A31515">"   mmap   "</font> ); <br> <font color="#0000ff">if</font> ( (dst = mmap(0, statbuf.st_size, PROT_READ | PROT_WRITE, MAP_SHARED, fdout, 0)) == MAP_FAILED ) <br> err_sys( <font color="#A31515">"   mmap   "</font> ); <br> memcpy(dst, src, statbuf.st_size); <font color="#008000">/*    */</font> <br> exit(0); <br> }</font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Here, in general, that's all.  Hope this article was helpful.  I am pleased to accept constructive criticism. </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/55716/">https://habr.com/ru/post/55716/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../55711/index.html">Bibliography</a></li>
<li><a href="../55712/index.html">Twitter + counter</a></li>
<li><a href="../55713/index.html">PHPEdit is an editor with full symfony support.</a></li>
<li><a href="../55714/index.html">‚ÄúGifts‚Äù in social networks - new ideas</a></li>
<li><a href="../55715/index.html">Pixazza - AdSense for Images</a></li>
<li><a href="../55717/index.html">Fiddler in the subway - a social experiment</a></li>
<li><a href="../55719/index.html">svn diff notification</a></li>
<li><a href="../55720/index.html">Google Scholar without paid links</a></li>
<li><a href="../55722/index.html">Developmental biology for geeks.</a></li>
<li><a href="../55724/index.html">Drivers for Audigy SE / LS / Value / Live! 24-bit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>