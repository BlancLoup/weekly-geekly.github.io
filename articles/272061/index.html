<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reservation of internal and external communication channels, static routing, corporate network on MikroTik</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I work as a technical support engineer at ISP. In the article I will share the experience of building a corporate network with static routing and rese...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reservation of internal and external communication channels, static routing, corporate network on MikroTik</h1><div class="post__text post__text-html js-mediator-article">  I work as a technical support engineer at ISP.  In the article I will share the experience of building a corporate network with static routing and reservation of communication channels, as well as automatic notification of an accident by email, with a limited budget for a retail chain of stores.  For experienced network engineers, the article is unlikely to be interesting.  For admins who are assigned a similar task, this article may be useful. <br><br>  I believe that dynamic routing in this task would not work as quickly and probably reliably as the project requires.  I have nothing against dynamic routing, but negative feedback on its operation on MikroTik equipment and some network specifics (more on this below) influenced the choice towards statics and scripts. <br><a name="habracut"></a><br><h4>  <b>Part 0. What is given</b> </h4><br>  I was approached by customers - the local trading network.  To which we provide services in the organization of a local network for communication between stores distributed in the city. <br><br>  From a technical point of view - the provider allocates them a separate VLAN in their network.  All stores (12 of them) are connected to the ISP through optics using two technologies: FTTH and PON. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The enterprise network diagram before the upgrade is shown in the picture. <br><br><img src="https://habrastorage.org/files/c16/1a5/6a5/c161a56a50fc432cb547b618c6f362b2.png"><br><br>  The two stores and the central office are connected using Ethernet (FTTH) technology.  In the remaining 9 stores, the connection takes place via PON (Passive Optical Network) technology.  When connected via PON, Huawei terminals are used, the model HG810 is also called ONU (Optical Network Unit).  You can read about PON technology <a href="http://www.skomplekt.com/technology/pon/">here</a> . <br><br>  The equipment of this company has specific functions.  On the one hand, they are not needed for ISP users and play a positive role in terms of subscriber access network design.  On the other hand, these features can have a negative effect on corporate clients. <br><br>  Let's take a closer look at them: <br><br><ol><li>  In the PON network built on the equipment of Huawei, traffic is prohibited by default between ONUs working from one base station (OLT - Optical Line Terminal).  We managed to solve this problem using special profiles for corporate VLANs. </li><li>  ONU does not allow DHCP packets from the subscriber to the provider's network.  From the provider‚Äôs network to the subscriber‚Äôs side, everything goes.  If you connect the main office with a DHCP server to a distributed corporate network via the ONU, the server located in the office will not be able to distribute addresses to nodes that are located outside the office. </li><li>  A similar problem with the passage Multicast - packages.  <b>All multicast packages do not go through the ONU and are not seen in other parts of the network.</b> </li></ol><br>  With the rest of the traffic there are no problems, no filtering and restrictions. <br><br>  Regarding problems 2 and 3, if there are engineers among the readers who use Huawei's PON in their networks and know how to allow such traffic to pass, I will be glad to advise. <br><br>  At the time of contacting me, the chain of stores was a flat, unmanaged network, with one router running Kerio Control Server. <br><br>  In the network, all IP devices from all stores were visible to each other.  The FDB table on the provider's switch has more than 350 devices in their VLAN.  All these devices were in the same large broadcast domain. <br><br>  Because of this, there were various failures in the network that interfered with the work of the stores, so the network needed to be segmented. <br><br>  Sometimes there was an accident at the provider because of which the connection between the office and individual stores was lost. <br><br>  Worse, when there is a loss of communication between the central office and the network provider.  In this case, all 12 stores distributed in the city remain without communication with the servers located in the office and without access to the Internet.  During this period, the work of the stores is significantly limited, the opportunities disappear: <br><br><ol><li>  Accept payment by cashless payment. </li><li>  To conduct reception and revision of goods. </li><li>  Synchronize prices and balances. </li></ol><br>  The central office was connected via Ethernet.  Since they needed to distribute DHCP for devices in all stores.  Optics from the office goes to the nearest apartment building where the provider‚Äôs communications center is located.  When in this house or the houses connected further the power supply is lost - all 12 stores are left without communication with the office. <br><br>  In order to work in the event of a power failure, the PON line was established at the main office.  It was used only as a reserve in case of falling Ethernet, because  DHCP packets did not pass through it.  Switching between the Ethernet and PON communication channels was <b>carried out manually</b> . <br><br>  I was tasked with: <br><br><ol><li>  Segment the network and break it into many small broadcast-domains to eliminate the negative impact in one of them on the overall network. </li><li>  Introduce a method of automatically switching internal communication channels in case there is no connection between the main office and the provider via Ethernet or PON. </li><li>  Introduce a way to automatically switch communication with the office, in case if in a particular store the connection with the ISP is lost - which means local connection with the office and Internet access. </li><li>  Introduce the ability to automatically notify system administrators of an enterprise about an accident on a particular network segment (the connection to the office was lost or the backup Internet was lost). </li></ol><br><h4>  <b>Part 1. The solution of the tasks</b> </h4><br>  To perform these tasks, <i>MikroTik</i> equipment was purchased.  The <b>RB1100AHx2</b> model was purchased to the central office, and to each of the 12 <b>MikroTik hEx stores (RB750Gr2</b> ). <br><br>  At the central office and in all stores, the second provider is connected - Rostelecom.  From which the company buys <b>only</b> <u>Internet access</u> .  At the central office, the connection is made by cable (FTTH), in stores via ADSL.  Modems are leased from the provider and work exclusively in bridge mode. <br><br>  A distributed addressing scheme has been introduced in the enterprise network: <br><br><ul><li>  192.168.1.0/24 - the network of the central office. </li><li>  192.168.2.0/24 - 192.168.13.0/24 local networks of each of the 12 stores. </li></ul><br>  For the work of routing between offices, two auxiliary networks have been introduced in which communication between MikroTik routers is organized: <br><br><ul><li>  10.10.10.0/24 - the network coming to the main office through the main Ethernet channel </li><li>  10.10.20.0/24 - the network coming to the main office through the backup channel (PON) </li></ul><br>  <u>The main office has access to the Internet through 3 channels:</u> <br><br><ul><li>  <b>ISP1-A</b> - via Ethernet channel, with prefix / 30 IP - <b>1.1.1.1</b> </li><li>  <b>ISP1-B</b> - via the PON channel, with the / 30 IP prefix - <b>2.2.2.2</b> </li><li>  <b>ISP-2</b> (Rostelecom) - via PPPoE, IP - <b>3.3.3.3</b> </li></ul><br><br>  Below is an example configuration: <br><br><pre><code class="bash hljs">[s@MAIN-BORDER-ROUTER] &gt; ip address <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> <span class="hljs-comment"><span class="hljs-comment"># nov/27/2015 22:43:50 by RouterOS 6.32.2 # /ip address add address=10.10.10.1/24 comment=ISP-LOCAL-ADDRESS interface=eth-1 network=10.10.10.0 add address=10.10.20.1/24 comment=ISP-RESERVE-LOCAL-ADDRESS interface=eth-2 network=10.10.20.0 add address=1.1.1.1/30 comment=ISP1-MAIN-INET-ADDRESS interface=eth-1 network=1.1.1.0 add address=2.2.2.2/30 comment=ISP1-RESERVE-INET interface=eth-2 network=2.2.2.0 add address=192.168.1.1/24 comment=OFFICE-LOCAL-ADDRESS interface=bridge-MAIN-OFFICE network=192.168.1.0</span></span></code> </pre> <br>  For PPPoE from the second provider: <br><br><pre> <code class="bash hljs">[s@MAIN-BORDER-ROUTER] &gt; interface pppoe-client <span class="hljs-built_in"><span class="hljs-built_in">print</span></span> Flags: X - disabled, R - running 0 R name=<span class="hljs-string"><span class="hljs-string">"RT-PPPoE"</span></span> max-mtu=1480 max-mru=1480 mrru=1600 interface=eth-3 user=<span class="hljs-string"><span class="hljs-string">"U"</span></span> password=<span class="hljs-string"><span class="hljs-string">"P"</span></span> profile=default keepalive-timeout=30 service-name=<span class="hljs-string"><span class="hljs-string">""</span></span> ac-name=<span class="hljs-string"><span class="hljs-string">""</span></span> add-default-route=no dial-on-demand=no use-peer-dns=no allow=pap,chap,mschap1,mschap2</code> </pre><br>  To organize the work of remote stores in case of loss of communication <i>between the store and ISP-1</i> , on the main router in the office, 2 VPN users were created for each store.  This is done so that each of the stores has at the same time two active connections via the external Internet network to two external IP addresses in the office from both providers. <br><br>  We introduce 2 more auxiliary networks for the exchange of traffic between the office and the stores already through VPN. <br><br><ul><li>  10.20.30.0/24 - a network inside a VPN, for stores clinging through an external network to IP from ISP-1 </li><li>  10.30.40.0/24 network inside VPN, for shops clinging to IP from ISP-2 via external network </li></ul><br>  We enable L2TP Server on the router and create user profiles (here is an example for one store): <br><br><pre> <code class="bash hljs">/interface l2tp-server server <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> enabled=yes keepalive-timeout=15 add <span class="hljs-built_in"><span class="hljs-built_in">local</span></span>-address=10.20.30.1 name=VERTOLET-VPN password=Pass profile=default-encryption remote-address=10.20.30.15 service=l2tp add <span class="hljs-built_in"><span class="hljs-built_in">local</span></span>-address=10.30.40.1 name=VERTOLET-VPN-RESERVE password=Pass profile=default-encryption remote-address=10.30.40.15 service=l2tp /interface l2tp-server add name=15.VERTOLET-VPN user=VERTOLET-VPN add name=15.VERTOLET-VPN-RESERVE user=VERTOLET-VPN-RESERVE</code> </pre><br>  <b>With the / interface l2tp-server command, I</b> add a hard link in the PPP section for each store.  This is done to conveniently determine which stores are connected.  And what goes through the traffic. <br><br>  We get four networks for traffic exchange. <br><br><pre> <code class="bash hljs">[s@MAIN-BORDER-ROUTER] &gt; ip address <span class="hljs-built_in"><span class="hljs-built_in">print</span></span> Flags: X - disabled, I - invalid, D - dynamic 0 ;;; IT-MAIN-LOCAL-ADDRESS 10.10.10.1/24 10.10.10.0 eth-1 1 ;;; IT-RESERVE-LOCAL-ADDRESS 10.10.20.1/24 10.10.20.0 eth-2 2 D 10.30.40.1/32 10.30.40.15 2.VERTOLET-VPN-RESERVE 3 D 10.20.30.1/32 10.20.30.15 2.VERTOLET-VPN</code> </pre><br>  For convenience, I planned the addressing in such a way that the network 192.168.  <b>15</b> .0 / 24, will be available in 10.10.10.  <b>15</b> , 10.10.20.  <b>15</b> , 10.20.30.  <b>15</b> and 10.30.40.  <b>15</b> , other subnets will have different addresses respectively. <br><br>  Now create the routes. <br><br><pre> <code class="bash hljs">[sbl@MAIN-BORDER-ROUTER] &gt; ip route <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> <span class="hljs-comment"><span class="hljs-comment"># nov/27/2015 23:24:47 by RouterOS 6.32.2 # /ip route add comment=1.VERTOLET distance=10 dst-address=192.168.15.0/24 gateway=10.10.10.15 add comment=2.VERTOLET distance=20 dst-address=192.168.15.0/24 gateway=10.10.20.15 add comment=3.VERTOLET distance=30 dst-address=192.168.15.0/24 gateway=10.20.30.15 add comment=4.VERTOLET distance=40 dst-address=192.168.15.0/24 gateway=10.30.40.15</span></span></code> </pre><br>  I use different administrative distances for different routes.  In normal mode, the data will go to the store through the network on 10.10.10.15, because  she has the lowest administrative distance - <b>10</b> .  The 10.10.10.0/24 network is available through <b>eth-1</b> , which means the main Ethernet channel from <b>ISP-1</b> . <br><br>  In case of failure of the communication channel eth-1, the data will go through the eth-2 network through the PON, if even then there is trouble then to help VPN via PPPoE from ISP-2. <br><br>  An example of a network connection in the office is shown in the picture below. <br><br><img src="https://habrastorage.org/files/b3c/ecd/02c/b3cecd02c8fb417084e9a0724374b7cf.png"><br><br>  Perform similar settings in a remote store.  Assign addresses: <br><br><pre> <code class="bash hljs">[s@VERTOLET-GW] &gt; ip address <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> <span class="hljs-comment"><span class="hljs-comment"># nov/27/2015 23:47:45 by RouterOS 6.32.3 # /ip address add address=192.168.15.2/24 interface=bridge-VERTOLET network=192.168.15.0 add address=10.10.10.15/24 comment=LOCAL-MAIN-ADDRESS interface=ether1 network=10.10.10.0 add address=10.10.20.15/24 comment=LOCAL-RESERVE-ADDRESS interface=ether1 network=10.10.20.0 add address=192.168.15.253/30 interface=ether2 network=192.168.15.252</span></span></code> </pre><br>  Create a l2tp vpn connection <br><pre> <code class="bash hljs">[s@VERTOLET-GW] &gt; interface l2tp-client <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> <span class="hljs-comment"><span class="hljs-comment"># nov/27/2015 23:54:11 by RouterOS 6.32.3 # /interface l2tp-client add connect-to=2.2.2.2 disabled=no keepalive-timeout=45 mrru=1600 name=VPN-OFFICE password=Pass user=VERTOLET-VPN add connect-to=3.3.3.3 disabled=no keepalive-timeout=45 mrru=1600 name=VPN-OFFICE-RESERVE password=Pass user=VERTOLET-VPN-RESERVE</span></span></code> </pre><br>  I suggest to look at the store's connection diagram: <br><br><img src="https://habrastorage.org/files/d87/1ac/ecd/d871acecd7b749da81c06bd89339b87d.png"><br><br>  In the event that a channel fails <b>eth-1</b> at a remote store, it automatically loses contact with the office through both local routes going through ISP-1.  Here we come to the aid of VPN networks 10.20.30.1 and 10.30.40.1 which are <b>always raised</b> , and they are <b>always</b> raised <b>via the backup Internet channel</b> for the store! <br><br>  To implement this trick, I created a separate routing table for <b>ISP-2.</b>  This is also done so that the router can always respond to requests coming from <b>ISP-2</b> through the same interface, but I will not dwell on this in detail. <br><br>  Create a routing table for ISP-2 in the store: <br><br><pre> <code class="bash hljs">[s@VERTOLET-GW] &gt; ip route <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> <span class="hljs-comment"><span class="hljs-comment"># nov/28/2015 00:13:41 by RouterOS 6.32.3 # /ip route add distance=1 gateway=RT-INET-Reserve routing-mark=ISP2-Reserve</span></span></code> </pre><br>  And we create routing rules, according to which traffic to both IP VPN servers in the office will <b>only</b> go through the backup Internet. <br><br><pre> <code class="bash hljs">[s@VERTOLET-GW] &gt; ip route <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> <span class="hljs-comment"><span class="hljs-comment"># nov/28/2015 00:13:41 by RouterOS 6.32.3 /ip route rule add action=lookup-only-in-table dst-address=2.2.2.2/32 table=ISP2-Reserve add action=lookup-only-in-table dst-address=3.3.3.3/32 table=ISP2-Reserve</span></span></code> </pre><br>  Now VPN is always available and raised no matter which of the channels the online store and the router take.  The VPN network will always work only through the backup channel and is always ready to accept the mission of communicating with the office. <br><br>  The Internet itself, by default, works through ISP-1 from the office, therefore, 2 separate routing tables for accessing the Internet through the office are also created. <br><br><pre> <code class="bash hljs">[s@VERTOLET-GW] &gt; ip route <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> <span class="hljs-comment"><span class="hljs-comment"># nov/28/2015 00:13:41 by RouterOS 6.32.3 # /ip route add distance=1 gateway=10.10.10.1 pref-src=10.10.10.2 routing-mark=ISP1-A add distance=1 gateway=10.10.20.1 pref-src=10.10.20.2 routing-mark=ISP1-B</span></span></code> </pre><br>  We need to make sure that traffic until <b>10.10.10.1</b> and <b>10.10.20.1</b> will not go through the default route, from which the answer can arrive with some probability.  To do this, I create a <b>hard link</b> where to look for addresses <b>10.10.10.1</b> and <b>10.10.20.1</b> . <br><br><pre> <code class="bash hljs">[s@VERTOLET-GW] &gt; ip route rule <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> <span class="hljs-comment"><span class="hljs-comment"># nov/28/2015 00:13:41 by RouterOS 6.32.3 /ip route rule add action=lookup-only-in-table dst-address=10.10.10.1/32 table=ISP1-A add action=lookup-only-in-table dst-address=10.10.20.1/32 table=ISP1-B</span></span></code> </pre><br>  Last for the store - create routes to the office. <br><br><pre> <code class="bash hljs">[s@VERTOLET-GW] &gt; ip route <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> <span class="hljs-comment"><span class="hljs-comment"># nov/28/2015 00:13:41 by RouterOS 6.32.3 /ip route add comment=1.Local-NET-MAIN-IT distance=10 dst-address=192.168.1.0/24 gateway=10.10.10.1 add comment=2.Local-NET-RESERVE-IT distance=20 dst-address=192.168.1.0/24 gateway=10.10.20.1 add comment=3.Local-NET-RESERVE-INET distance=30 dst-address=192.168.1.0/24 gateway=10.20.30.1 add comment=4.Local-NET-RESERVE-INET distance=40 dst-address=192.168.1.0/24 gateway=10.30.40.1</span></span></code> </pre><br>  With the routing table that's all.  Now we need to configure automatic and fast switching between these communication channels. <br><br><h4>  <b>Part 2. Setting up automatic switching</b> </h4><br>  At the beginning of the article I wrote that in my opinion in this case dynamic routing is not very appropriate.  Although <b>it wins</b> <u>on the simplicity of the setting</u> - it‚Äôs just corny less to create and write. <br><br>  But, firstly, most stores are connected via <b>PON</b> , which does not allow <b>multicast</b> .  Both <b>OSPF</b> and <b>RIP</b> would simply not take off via LAN. <br><br>  Secondly, I have little experience with OSPF.  And I'm not sure how exactly it will behave, if the channel through <b>ISP-1 is</b> locally available, but there will be losses of 20-25% or more.  Traffic will go and packets with Router Hello will be visible, but with live traffic there will be difficulties. <br><br>  The third is the speed of reaction and switching; by default, in the OSPF settings, the <b>Router Dead Interval</b> value is <b>40 seconds</b> .  As for the store long enough (well, here are the customers).  Of course, it can be tweaked and reduced, but how stable will OSPF work then? <br><br>  And the last verdict in favor of statics I will call a considerable amount of criticism and dissatisfaction among MikroTik users on the stability of OSPF.  What, for example, was written <a href="http://habrahabr.ru/post/201042/">here</a> . <br><br>  Honestly, I have nothing against OSPF.  But in this case, I decided to play it safe and make the switch through the script. <br><br>  Alas, I don‚Äôt have the experience of writing scripts; therefore, some of my edits made to borrowed scripts (primary sources will be given) may seem to you too crutch.  I am always happy to criticize. <br><br>  The <a href="http://habrahabr.ru/post/141785/">script of</a> habrauser <a href="http://habrahabr.ru/users/magnitudo/" class="user_link">magnitudo</a> was taken as the basis of the script for checking the availability of local communication channels. <br><br><div class="spoiler">  <b class="spoiler_title">Script to check the availability of local channels</b> <div class="spoiler_text"><pre> <code class="bash hljs">name=<span class="hljs-string"><span class="hljs-string">"CHECK-LOCAL-ALARM"</span></span> owner=<span class="hljs-string"><span class="hljs-string">"admin"</span></span> policy=<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>,write,policy,<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>,sniff,sensitive <span class="hljs-comment"><span class="hljs-comment">#DEFINE GLOBAL VARIABALES for LOCAL-REACHIBLE-STATUS :global GlobalITFail #DEFINE INTERNAL PING TARGETS :local PingCount 7 #       # MAIN LOCAL CENTRAL-GW IP ADDRESS :local PingTarget1 10.10.10.1 #        # RESERVE LOCAL CENTRAL-GW IP ADDRESS :local PingTarget2 10.10.20.1 #        # RESERVE VPN LOCAL CENTRAL-GW IP ADDRESS :local PingTarget3 10.20.30.1 #     VPN     IP ISP1-B #CHECK MAIN LOCAL SERVER ADDRESS :local MainLocalServerOK false; #            :local PingResult1 [/ping $PingTarget1 count=$PingCount size=1500 ] #  7   1500    5     :set MainLocalServerOK ( $PingResult1 &gt;= 5) #CHECK RESERVE LOCAL SERVER ADDRESS :local ReserveLocalServerOK false; :local PingResult2 [/ping $PingTarget2 count=$PingCount size=1500 ] :set ReserveLocalServerOK ( $PingResult2 &gt;= 5) #        #CHECK VPN LOCAL SERVER ADDRESS :local VpnLocalServerOK false; #    VPN        ,   :local PingResult3 [/ping $PingTarget3 count=5 ] :set VpnLocalServerOK ( $PingResult3 &gt;= 4) ###        /system script run &lt;&gt; :put "MainLocalServerOK=$MainLocalServerOK" :put "ReserveLocalServerOK=$ReserveLocalServerOK" :put "VpnLocalServerOK=$VpnLocalServerOK" #DEFINE GATEWAYS Administrative Distances #       :local MainLocalServerGWDistance [/ip route get [find comment="1.Local-NET-MAIN-IT"] distance] :local ReserveLocalServerGWDistance [/ip route get [find comment="2.Local-NET-RESERVE-IT"] distance] :local VpnLocalServerGWDistance [/ip route get [find comment="3.Local-NET-RESERVE-INET"] distance] ###        /system script run &lt;&gt; :put "MainLocalServerGWDistance=$MainLocalServerGWDistance" :put "ReserveLocalServerGWDistance=$ReserveLocalServerGWDistance" :put "VpnLocalServerGWDistance=$VpnLocalServerGWDistance" ### #SETUP ADMINISTRATIVE DISTANCE # FROM MAIN LOCAL SERVER if ($MainLocalServerOK) do={ if ($MainLocalServerGWDistance != 10) do={ /log warning "Switch LOCAL-ROUTE to MAIN LOCAL SERVER" } /ip route set [find comment="1.Local-NET-MAIN-IT"] distance=10 } if (!$MainLocalServerOK) do={ /ip route set [find comment="1.Local-NET-MAIN-IT"] distance=110 } ### # FROM RESERVE LOCAL SERVER if (!$MainLocalServerOK &amp;&amp; $ReserveLocalServerOK) do={ /log warning "Switch LOCAL-ROUTE to RESERVE LOCAL SERVER" } if ($ReserveLocalServerOK &amp;&amp; ($ReserveLocalServerGWDistance != 20)) do={ /ip route set [find comment="2.Local-NET-RESERVE-IT"] distance=20 } if (!$ReserveLocalServerOK &amp;&amp; ($ReserveLocalServerGWDistance != 120)) do={ /ip route set [find comment="2.Local-NET-RESERVE-IT"] distance=120 } ### #FROM VPN LOCAL SERVER if (!$MainLocalServerOK &amp;&amp; !$ReserveLocalServerOK &amp;&amp; $VpnLocalServerOK) do={ /log warning "Switch LOCAL-ROUTE to RESERVE LOCAL SERVER" } if ($VpnLocalServerOK &amp;&amp; ($VpnLocalServerGWDistance != 30)) do={ /ip route set [find comment="3.Local-NET-RESERVE-INET"] distance=30 } if (!$VpnLocalServerOK &amp;&amp; ($VpnLocalServerGWDistance != 130)) do={ /ip route set [find comment="3.Local-NET-RESERVE-INET"] distance=130 } #### ###   ,    .         .   ,   . ####INFORMING############################################ :local ITfail false; #         10.10.10.0/24  10.10.20.0/4,          ISP-1   ( )   VPN. if (!$MainLocalServerOK &amp;&amp; !$ReserveLocalServerOK) do={ :set ITfail true; } #      -     ,        ISP       ,        if ($MainLocalServerOK) do={ :set ITfail false; } if ($ReserveLocalServerOK) do={ :set ITfail false; } #       email #    ,       :put "1.ITfail=$ITfail" :put "1.1.GlobalITFail=$GlobalITFail" #       ,          if ($ITfail != $GlobalITFail) do={ if ($ITfail &amp;&amp; !$GlobalITFail) do={ :set GlobalITFail true; /log error "WARNING!!!! IT-MAIN LIK IS DOWN!!!!" :delay 8 /system script run EMAIL-IT-FAIL } if (!$ITfail &amp;&amp; $GlobalITFail) do={ :set GlobalITFail false; /log warning " IT-MAIN LINK RECOVERED!!!!!" /system script run EMAIL-IT-RECOVER } }</span></span></code> </pre><br></div></div><br>  The principle of the script is simple.  We ping 7 times each of the interfaces on the main router in large packets of 1500 bytes.  A satisfactory result is considered if at least 5 packets are returned.  This method is very sensitive to possible problems with communication in the channel.  If there are problems, the channel is considered not available. <br><br>  Depending on the result, set the value of the administrative distance.  Increasing it by 100 if the channel is not available. <br>  If both channels connected locally disappear, the script initiates the launch of another script, sending a letter about the fall, or about the restoration. <br><br>  Someone noticed that I have four routes, and the script only checks three.  This is done to save time, because  All three interfaces (two - locally, one through the Internet) are tied to the main provider.  And if he fails on all 3 interfaces, then only the last backup external VPN through ISP-2 remains.  Which always has AD = 40. <br><br>  Here is the script from the store, a similar script is spinning on the main router, for each store its own script. <br><br>  Someone will think the same how many scripts will be constantly spinning?  And in general, how long does it take for the script to work?  How often to run it? <br><br>  For me <b>, the reaction time for accessibility of the route is critical</b> .  When checking the script, I tried to note the time working out.  In the case when everything is regular, it is somewhere <b>7 seconds.</b> <br><br>  If any of the channels is not available and the script waits for a response on a timeout, then the time increases to approximately <b>15 seconds.</b> <br>  Which is much faster than OSPF waiting <b>40 seconds</b> by default <b>.</b> <br><br>  How often to run the script?  And with no!  I did not do for this <b>scheduler</b> script! <br><br>  This reduced the reaction time even faster.  I managed to achieve almost instant reaction time (in practice, about <b>5 seconds</b> ) thanks to the <b>NetWatch connection</b> ! <br><br>  When routes are created and scripts are created to check the reliability of the channel and notify about the accident, we need to invent a trigger for launching these scripts. <br><br>  Create a netwatch for all 3 addresses: <br><br><pre> <code class="bash hljs">[s@VERTOLET-GW] &gt; tool netwatch <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> <span class="hljs-comment"><span class="hljs-comment"># nov/28/2015 01:53:17 by RouterOS 6.32.3 /tool netwatch add down-script="/ip route set [find comment="1.Local-NET-MAIN-IT"] distance=110\r\ \n/system script run CHECK-INET-ALARM\r\ \n/system script run CHECK-LOCAL-ALARM\r\ \n" host=10.10.10.1 interval=10s timeout=2s up-script=\ "/system script run CHECK-INET-ALARM\r\ \n/system script run CHECK-LOCAL-ALARM"</span></span></code> </pre><br>  Let me explain - NetWatch pings the host 10.10.10.1 every 10 seconds, with a timeout of 2 seconds.  In the event of a fall, we immediately establish the administrative distance of +100 <b><u>preventively</u></b> - we make the route <b>inactive</b> . <br><br>  After that, we initialize the launch of the script with a <u>more accurate check</u> of the availability status of the local network.  Which in the case of a false alarm <i>will return the priority of the route back,</i> and in the case of a real drop in both local channels, <b>will send a letter to the admins.</b> <br><br>  In the case of ping recovery, we <b>do not</b> immediately return the route as an active one.  And again we are launching a more detailed check, which already decides whether it is possible to return to the main channel or not. <br><br>  Such NetWatch are designed for all three internal addresses in the ISP-1 network.  Which regularly ping each other from two sides and in case of problems, they instantly change AD and launch a more detailed check with the script. <br><br>  Below is a listing of the script that notifies of the fall and the restoration of communication with the office.  For the basis of the scripts for the notification used <a href="http://habrahabr.ru/post/153971/">article</a> <a href="http://habrahabr.ru/users/seventh/" class="user_link">seventh</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Script notification of the fall of the communication channel in the store</b> <div class="spoiler_text"><pre> <code class="bash hljs">   EMAIL-IT-FAIL :<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> sysname [/system identity get name]; :<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> smtpserv [:resolve <span class="hljs-string"><span class="hljs-string">"you_mail_server "</span></span>]; :<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> Eaccount <span class="hljs-string"><span class="hljs-string">"you_username"</span></span>; :<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> pass <span class="hljs-string"><span class="hljs-string">"you_password"</span></span>; :<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> date [/system clock get date]; :<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> time [/system clock get time]; :<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> mailto you@mail.yu /tool e-mail send to=<span class="hljs-variable"><span class="hljs-variable">$mailto</span></span> from=you@mail. \ user=<span class="hljs-variable"><span class="hljs-variable">$Eaccount</span></span> password=<span class="hljs-variable"><span class="hljs-variable">$pass</span></span> server=<span class="hljs-variable"><span class="hljs-variable">$smtpserv</span></span> port=587 start-tls=yes \ subject=(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$sysname</span></span></span><span class="hljs-string">-ALARM!!!"</span></span>) \ body=(<span class="hljs-string"><span class="hljs-string">"   </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$sysname</span></span></span><span class="hljs-string">    !     ,     VPN.    </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$time</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$date</span></span></span><span class="hljs-string">"</span></span>)</code> </pre><br></div></div><br>  The recovery script for EMAIL-IT-RECOVER is identical, except for the text. <br><br><h4>  <b>the end</b> </h4><br>  That's all.  Although I did not tell everything I wanted.  Behind the brackets there is the realization of the reservation of the Internet itself in the office and in the branches, notification of the accident related to the Internet and their restoration.  Time counters - how much is the channel on the Internet.  How I caught a Wi-Fi printer walking through OSPF. <br><br>  Thanks to everyone who read to the end.  Waiting for your criticism, advice, suggestions.  There will be questions, I will answer them with pleasure. <br>  If it is interesting, I will write a few more articles on this project, with a description of some crutches in the network, which had to be solved in nontrivial ways. <br><br>  The latter is a general scheme for connecting an office and one of 12 stores. <br><br><img src="https://habrastorage.org/files/969/551/112/96955111292343fca2e58bc4fd31e349.png"></div><p>Source: <a href="https://habr.com/ru/post/272061/">https://habr.com/ru/post/272061/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272051/index.html">Want to integrate Telegram into Redmine? There is a solution</a></li>
<li><a href="../272053/index.html">Recommendations for writing C # code from Aviva Solutions</a></li>
<li><a href="../272055/index.html">Thinking out loud about TypeScript</a></li>
<li><a href="../272057/index.html">Accident history on the UPS</a></li>
<li><a href="../272059/index.html">New dynamic objects and JSON support in InterSystems Cach√©</a></li>
<li><a href="../272063/index.html">Using LRDIMM Modules in High-Performance Servers</a></li>
<li><a href="../272067/index.html">How we beat the twilight between testing and exploitation</a></li>
<li><a href="../272071/index.html">How do residents of different cities communicate</a></li>
<li><a href="../272073/index.html">Underground carders market. Translation of the book "KingPIN". Chapter 18. "Briefing"</a></li>
<li><a href="../272075/index.html">Creating a desktop application with Electron and web technologies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>