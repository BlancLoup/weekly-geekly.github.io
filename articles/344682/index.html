<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Error on the site ... What to do?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When the code gets into production, the programmer releases to the outside world, along with useful functionality, also errors. It is possible that, f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Error on the site ... What to do?</h1><div class="post__text post__text-html js-mediator-article">  When the code gets into production, the programmer releases to the outside world, along with useful functionality, also errors.  It is possible that, for example, on a certain website, they will sometimes lead to minor failures, which will be written off for a variety of reasons, and without getting to the bottom of the essence.  It would be good for a developer who knows his business to foresee some kind of mechanism by which he can meet his mistakes, listen to their story about the adventures that they had to go through, and, as a result, correct them. <br><br> <a href="https://habrahabr.ru/company/ruvds/blog/344682/"><img src="https://habrastorage.org/webt/ay/dp/mt/aydpmtdaqx8ueuo3kitujhva7mm.gif"></a> <br><br>  Today we want to share with you a translation of the article by programmer David Gilbertson, in which he talks about an experimental system developed by him that allows him to track and reproduce errors in web projects written in React.  We believe that a similar approach can be transferred to other environments, but first things first. <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Approaches to collecting error information</font> </h2><br>  Perhaps you are using such a simple system for collecting information about errors in web projects (please do not throw stones at me for the following example): 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs javascript"><span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.onerror = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function"> =&gt;</span></span> fetch(<span class="hljs-string"><span class="hljs-string">`/errors/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${err}</span></span></span><span class="hljs-string">`</span></span>);</code> </pre> <br>  In order to look at the error reports, it is enough to ask a friendly IT specialist to give you a file with all 404 page entries starting with <code>/errors</code> , and here it is - happiness. <br><br>  However, the ‚Äúcode‚Äù that you get with this approach will not help you find out exactly where the error occurred.  It is likely that this will require some improvements and error messages, which contain information about the file and the line number: <br><br><pre> <code class="hljs javascript"><span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, e =&gt; { fetch(<span class="hljs-string"><span class="hljs-string">'/errors'</span></span>, {   <span class="hljs-attr"><span class="hljs-attr">method</span></span>: <span class="hljs-string"><span class="hljs-string">'POST'</span></span>,   <span class="hljs-attr"><span class="hljs-attr">body</span></span>: <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${e.message}</span></span></span><span class="hljs-string"> (in </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${e.filename}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${e.lineno}</span></span></span><span class="hljs-string">:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${e.colno}</span></span></span><span class="hljs-string">)`</span></span>, }); });</code> </pre> <br>  This code balances somewhere on the verge of decency, however, it is still just a skeleton of something more serious.  If the error is related to specific data, then information about line numbers will not bring you any particular benefit. <br><br>  It would be nice if you had a complete report on the activities of the user at the time of the error, which will give an opportunity to recreate the situation in which the failure occurred.  For example, something like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/992/3aa/fe9/9923aafe9ecb6a795c12cc2cfef788f2.png"><br>  <i><font color="#999999">User Activity Report</font></i> <br><br>  The most interesting thing is that the user went to the page with detailed information about the product (step 4) and clicked on the buy button (at the fifth, last step). <br><br>  I can immediately assume that there is probably something suspicious going on with the data for a particular product, so I can follow the same link and click on the purchase button that says ‚ÄúBuy this for $‚Äù. <br><br>  Having done this, I, of course, will see the same mistake.  This particular product does not have a price, so calling <code>toLocaleString</code> fails.  Before us is a typical oversight of a not very experienced developer. <br><br>  But what if the order of user interaction with the site is much more complicated?  Maybe the user was on one of the many tabs, the work with which is not reflected in the URL, or an error occurred during the validation of the data from the form.  Clicking on the link and clicking on the button will not reveal such an error. <br><br>  In this situation, I would like to be able to reproduce all the actions of the user before the error occurred.  Ideally, just clicking during playback on a certain button that says ‚ÄúNext Step‚Äù. <br><br>  Here's how, if I have not lost my imagination, I imagine all this for myself: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/01c/990/3d2/01c9903d234b71b5867f7d8a72f3f5c9.gif"><br>  <i><font color="#999999">Reproducing user actions by monitoring the DOM</font></i> <br><br>  The error information displayed on the screen and the file opening in my editor is a merit of the Create React App. <br><br>  I want to note that I really built, in the form of an experiment, a system that allows you to conduct something like "unmoderated usability testing."  I wrote code that tracks user actions, and then plays them, and then asked a knowledgeable person, John, about what he thinks about all this.  He said it was a stupid idea, but added that my code could be useful for reproducing errors. <br><br>  Actually, this is what I want to tell here.  Thanks, John. <br><br><h2>  <font color="#3AC1EF">Core system</font> </h2><br>  The code in question can be found <a href="https://github.com/davidgilbertson/peeping-dom/tree/master/src/peepingDomUtils">here</a> .  You might be more interested in reading it than my story.  Below, I show simplified versions of functions and give links to their full texts. <br><br>  I have a module, <a href="">record.js</a> , which contains several functions for intercepting various user actions.  All this enters the object of the <code>journey</code> , which can be transferred to the server when an error occurs. <br><br>  At the entry point of the application, I start gathering information by calling the <code>startRecording()</code> function, which looks like this: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> journey = { <span class="hljs-attr"><span class="hljs-attr">meta</span></span>: {}, <span class="hljs-attr"><span class="hljs-attr">steps</span></span>: [], }; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> startRecording = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { journey.meta.startTime = <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now(); journey.meta.startUrl = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.location.href; journey.meta.screenWidth = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.innerWidth; journey.meta.screenHeight = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.innerHeight; journey.meta.userAgent = navigator.userAgent; };</code> </pre> <br>  If an error occurs, the <code>journey</code> object, for example, can be sent to the server for analysis.  For this, the corresponding event handler is connected: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">window</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, sendErrorReport);</code> </pre> <br>  At the same time, the <code>sendErrorReport</code> function <code>sendErrorReport</code> declared in the same module as the <code>journey</code> object: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> sendErrorReport = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function">) =&gt;</span></span> { journey.meta.endTime = <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now(); journey.meta.error = <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${err.message}</span></span></span><span class="hljs-string"> (in </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${err.filename}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${err.lineno}</span></span></span><span class="hljs-string">:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${err.colno}</span></span></span><span class="hljs-string">)`</span></span>; fetch(<span class="hljs-string"><span class="hljs-string">'/error'</span></span>, {   <span class="hljs-attr"><span class="hljs-attr">method</span></span>: <span class="hljs-string"><span class="hljs-string">'POST'</span></span>,   <span class="hljs-attr"><span class="hljs-attr">body</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(journey) }) .catch(<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error); };</code> </pre> <br>  By the way, if someone can explain why the <code>JSON.stringify(err)</code> command does not give me the body of an error, it will be very cool. <br><br>  While all this does not bring much benefit.  However, now we have a framework on which to build everything else. <br><br>  If your application is state-based (that is, DOM is derived only based on some main state), then it will be easier for you to live (and I would venture to assume that the probability that you will encounter errors will be less).  When you try to reproduce the error, you can simply recreate the state, which will probably give you the opportunity to cause this error. <br><br>  If your application is not based on the latest technologies, it uses bindings and display of something, based directly on how the user interacts with the page, then it becomes a bit more complicated.  To reproduce the error, you will need to recreate mouse clicks, events related to the loss and gain of focus elements, and, I believe, keystrokes.  True, I find it difficult to say how to be if the user inserts something into the fields from the clipboard.  Here I can only wish good luck in experiments. <br><br>  I want to admit that I am a lazy and selfish person, so what I‚Äôm going to talk about will be aimed at the technologies I work with, namely, projects built on React and Redux. <br><br>  That's what exactly I want to intercept: <br><br><ul><li>  All dispatched actions (as a result, it will be possible to turn on the ‚Äúreplay‚Äù of changes to the status store). <br></li><li>  URL changes (which means it will be possible to update the URL as well). <br></li><li>  Clicks on the page (this will make it possible to see with your own eyes which buttons and links the user clicks on). <br></li><li>  Scrolling (this will let you know exactly what the user saw on the page at the time of the error). <br></li></ul><br><h2>  <font color="#3AC1EF">Redux interception</font> </h2><br>  Here is the code that is used to intercept and save Redux actions in the <code>journey</code> object: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> captureActionMiddleware = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> next =&gt; <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">action</span></span></span><span class="hljs-function"> =&gt;</span></span> { journey.steps.push({   <span class="hljs-attr"><span class="hljs-attr">time</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now(),   <span class="hljs-attr"><span class="hljs-attr">type</span></span>: INTERACTION_TYPES.REDUX_ACTION,   <span class="hljs-attr"><span class="hljs-attr">data</span></span>: action, }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> next(action); };</code> </pre> <br>  At the beginning you can see the construction <code>= () =&gt; next =&gt; action =&gt; {</code> , which is simply impossible not to understand at a glance.  If you still don't understand her, read <a href="https://redux.js.org/docs/advanced/Middleware.html">this</a> .  True, I, instead of delving into it, would rather spend time on something more important, for example, I would practice painting a happy smile that would be useful to me when I was congratulated on my birthday. <br><br>  The most important thing to understand in this code is the role it plays in the project.  Namely, he is busy putting Redux ‚Äúactions‚Äù, as they are executed, into a <code>journey</code> object. <br><br>  Then I applied the above function when creating the Redux repository, passing the reference to it to the functions of the <code>applyMiddleware()</code> framework: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> store = createStore( reducers, applyMiddleware(captureActionMiddleware), ); ReactDOM.render( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Provider</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">store</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{store}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">   </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">App</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Provider</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>, <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'root'</span></span>) );</code> </pre> <br><h2>  <font color="#3AC1EF">Record URL changes</font> </h2><br>  The location where URL changes are intercepted depends on how the application performs the routing. <br><br>  The React router doesn‚Äôt help very well in determining URL changes, so you‚Äôll have to resort to <a href="https://github.com/ReactTraining/react-router/issues/3554">this approach</a> or maybe <a href="https://reacttraining.com/react-router/web/api/history/history-is-mutable">this one</a> .  I would like, with the help of the React router, just to set the handler for <code>onRouteChange</code> .  It is worth noting here that this is necessary not only for me.  For example, many are faced with the need to send information about the views of virtual pages in Google Analytics. <br><br>  Anyway, I prefer to write my own routing system for most sites, as it takes only seventeen minutes, and in the end, what happens is <a href="https://hackernoon.com/routing-in-react-the-uncomplicated-way-b2c5ffaee997">very fast</a> . <br><br>  To intercept URL changes, I prepared the following function, which is called each time the URL changes: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> captureCurrentUrl = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { journey.steps.push({   <span class="hljs-attr"><span class="hljs-attr">time</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now(),   <span class="hljs-attr"><span class="hljs-attr">type</span></span>: INTERACTION_TYPES.URL_CHANGE,   <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.location.href, }); };</code> </pre> <br>  I call her in two places.  In the same place where I execute the <code>history.push()</code> command to update the URL, and also in the <code>popstate</code> event, which is called if the user clicks the <code></code> button in the browser: <br><br><pre> <code class="hljs coffeescript"><span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">'popstate'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  - ,     captureCurrentUrl(); });</code> </pre> <br><h2>  <font color="#3AC1EF">Record user actions</font> </h2><br>  This is probably the most "intrusive" mechanism for intercepting information about working with the site, since it has to be built literally everywhere.  I would, if it depended only on my desires, would not bother with it.  However, I encountered errors that I thought could not be reproduced without knowing exactly where the user clicked. <br><br>  In any case, the task was interesting, so here I will tell you about its solution.  When developing on React, I always use the <code>&lt;Link&gt;</code> and <code>&lt;Button&gt;</code> components, as a result, the development of a centralized system for intercepting clicks is quite simple.  Take a look at <code>&lt;Link&gt;</code> : <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Link = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">props</span></span></span><span class="hljs-function"> =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">   </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{props.to}</span></span></span></span><span class="xml"><span class="hljs-tag">   </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">data-interaction-id</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{props.interactionId}</span></span></span></span><span class="xml"><span class="hljs-tag"> //     </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{(e)</span></span></span></span><span class="xml"><span class="hljs-tag"> =&gt;</span></span></span><span class="xml"> {     e.preventDefault();         captureInteraction(e); //           historyManager.push(props.to);   }} &gt;   {props.children} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> );</code> </pre> <br>  What we are talking about here is the <code>data-interaction-id={props.interactionId}</code> and <code>captureInteraction(e);</code>  . <br><br>  When it comes time to play a session, I would like to highlight what the user clicked on.  For this, I need some sort of selector.  I can state with confidence that the items I click on have ids, but for some reason, which I don‚Äôt remember, I decided that something specifically designed for my surveillance system would be better. for user activity. <br><br>  Here is the <code>captureInteraction()</code> function: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> captureInteraction = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) =&gt;</span></span> { journey.steps.push({   <span class="hljs-attr"><span class="hljs-attr">time</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now(),   <span class="hljs-attr"><span class="hljs-attr">type</span></span>: INTERACTION_TYPES.ELEMENT_INTERACTION,   <span class="hljs-attr"><span class="hljs-attr">data</span></span>: {     <span class="hljs-attr"><span class="hljs-attr">interactionId</span></span>: e.target.dataset.interactionId,     <span class="hljs-attr"><span class="hljs-attr">textContent</span></span>: e.target.textContent,   }, }); };</code> </pre> <br>  <a href="">Here</a> you can find its full code, which checks that the element, after playing the session, can be found again. <br><br>  As with other information, I collect what I need, and then I execute the <code>journey.steps.push</code> command. <br><br><h2>  <font color="#3AC1EF">Scrolling</font> </h2><br>  It only remains for me to tell you about how I record scrolling data in order to know exactly which parts of the pages the user is viewing.  If, for example, the page was rewound to the very bottom and began to fill in a form, reproducing this without scrolling would not be of particular use. <br><br>  I collect all consecutive scrolling events into one event in order not to waste system resources to record many small events and use <code>Lodash</code> , as I don‚Äôt like setting and clearing timeouts in cycles. <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> startScrollCapturing = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleScroll</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{   journey.steps.push({     <span class="hljs-attr"><span class="hljs-attr">type</span></span>: INTERACTION_TYPES.SCROLL,     <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.scrollY,   }); } <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">'scroll'</span></span>, debounce(handleScroll, <span class="hljs-number"><span class="hljs-number">200</span></span>)); };</code> </pre> <br>  In the <a href="">working version of</a> this code, events associated with continuous scrolling are excluded. <br><br>  The <code>startScrollCapturing()</code> function is called when the application is first started. <br><br><h2>  <font color="#3AC1EF">Additional ideas</font> </h2><br>  Here is a small list of ideas not used in my project.  Perhaps you seem worthy of implementation. <br><br><ul><li>  Interception of keystrokes on the keyboard like <code>Escape</code> , <code>Tab</code> or <code>Enter</code> . <br></li><li>  Record information about the size of the application's working window (for those cases when it is important to reproduce what is happening taking into account the scrolling position). <br></li><li>  Call, in the course of reproduction, instead of interception of a position of scrolling, <a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/scrollIntoView">scrollIntoView ()</a> for an element at its selection. <br></li><li>  Create a copy of <code>localStorage</code> and <code>cookies</code> , if they affect the behavior of the site. <br></li><li>  And finally, users usually don‚Äôt really like it if someone intercepts and stores everything they enter, especially credit card numbers, passwords, and so on.  Therefore, it is very important that no one knows that while working with your site, its actions are recorded somewhere (of course, you understand that I am joking). <br></li></ul><br>  Here I made an addition after the publication of the original version of the article.  In contrast to what has been voiced in several comments, I can note that the methods described in this material do not give rise to additional concerns about security or about the protection of personal data.  If you are already working with confidential user data, then any requirements that apply to the collection and storage of such data should also be applied when preparing and sending error reports.  If you, for example, do not automatically save form data, without asking the corresponding question to the user, then you should not automatically send error reports without asking the user about it.  If you are obliged, before sending the user's personal data, to receive consent from him in the form of a check mark in a special field, the same must be done before sending an error report.  In sending user data to the address <code>/signup</code> , when it is registered in the system, or to the address <code>/error</code> , when an error occurs, there is not much difference.  The most important thing, and there, and there, to work with the data correctly and legally. <br><br>  Perhaps you believe that we are already ending the conversation, but at this point we only recorded what the user is doing on the site.  Now let's do the most interesting thing - playing the recording. <br><br><h2>  <font color="#3AC1EF">Replaying user actions</font> </h2><br>  Speaking about the reproduction of actions performed by the user when working with the site, I would like to discuss two issues: <br><br><ul><li>  An interface that I use to investigate the causes of errors by reproducing user actions. <br></li><li>  The mechanism that is embedded in the site code and allows you to manage it from the outside. <br></li></ul><br><h2>  <font color="#3AC1EF">Interface for reproducing user actions</font> </h2><br>  On the page, <code>iFrame</code> used to repeat user actions, where the website opens, where the steps previously recorded in the <code>journey</code> object are played. <br><br>  This page downloads information about the work session during which an error occurred, and then sends each recorded step to the site, which changes its state, eventually leading to the same error. <br><br>  When I open this page, I see a simple, unsightly interface, after which the site is loaded as if it is being viewed on an iPad (the usual picture of the tablet is used here, I like it more). <br>  Here is the same animated picture that I showed at the beginning of the article.  <a href="">Here</a> you can find its code. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/01c/990/3d2/01c9903d234b71b5867f7d8a72f3f5c9.gif"><br>  <i><font color="#999999">User session replay process</font></i> <br><br>  When I click on the <code>Next step</code> button, <code>iFrame</code> sends a message using the <code>iFrame.contentWindow.postMessage(nextStep, '*')</code> construct.  There is one exception related to URL changes.  Namely, in this situation, the <code>iFrame</code> <code>src</code> property simply changes.  For an application, this is, in fact, a complete page refresh, so whether it will work depends on how you transfer the state of the application between pages. <br><br>  If you do not know, then <code>postMessage ‚Äî</code> a <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage">Window object method</a> created to allow interaction between different windows (in this case, this is the main window of the page and the window opened in <code>iFrame</code> ). <br><br>  As a matter of fact, this is all that can be said about the page for reproducing user actions. <br><br><h2>  <font color="#3AC1EF">Mechanisms to manage the site from the outside</font> </h2><br>  The mechanism for reproducing user actions while working with the site is implemented in the file <a href="">playback.js</a> . <br><br>  When the application starts, I call a function that expects messages that go to the repository and can be called later.  This is done only in development mode. <br><br><pre> <code class="hljs ruby">const store = createStore( <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (process.env.NODE_ENV === <span class="hljs-string"><span class="hljs-string">'development'</span></span>) { startListeningForPlayback(store); }</code> </pre> <br>  <a href="">This is</a> where this code is used. <br><br>  The function we are interested in looks like this: <br><br><pre> <code class="hljs kotlin">export <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> startListeningForPlayback = (store) =&gt; { window.addEventListener(<span class="hljs-string"><span class="hljs-string">'message'</span></span>, (message) =&gt; {   switch (message.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>.type) {     case INTERACTION_TYPES.REDUX_ACTION:       store.dispatch(message.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>);       <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;     case INTERACTION_TYPES.SCROLL:       window.scrollTo(<span class="hljs-number"><span class="hljs-number">0</span></span>, message.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>);       <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;     case INTERACTION_TYPES.ELEMENT_INTERACTION:       highlightElement(message.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>.interactionId);       <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;     <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>:       <span class="hljs-comment"><span class="hljs-comment">//  -   ,          return;   } }); };</span></span></code> </pre> <br>  <a href="">Here</a> you can find its full version. <br><br>  When working with Redux actions, they are dispatched to the repository and nothing else. <br><br>  When playing scrolling, exactly what can be expected is performed.  In this situation, it is important that the page had the correct width.  You can see, looking at the project repository, that everything will work incorrectly if the user resizes the window or, for example, rotates the mobile device on which the site is watching, but I think the <code>scrollIntoView() ‚Äî</code> call is, in any case, a reasonable solution . <br><br>  The <code>highlightElement()</code> function simply adds a frame around the element.  Its code looks like this: <br><br><pre> <code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">highlightElement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">interactionId</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> el = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.querySelector(<span class="hljs-string"><span class="hljs-string">`[data-interaction-id="</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${interactionId}</span></span></span><span class="hljs-string">"]`</span></span>); el.style.outline = <span class="hljs-string"><span class="hljs-string">'5px solid rgba(255, 0, 0, 0.67)'</span></span>; setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> {   el.style.outline = <span class="hljs-string"><span class="hljs-string">''</span></span>; }, <span class="hljs-number"><span class="hljs-number">2000</span></span>); }</code> </pre> <br>  As usual, <a href="">here</a> is the complete code for this function. <br><br><h2>  <font color="#3AC1EF">Results</font> </h2><br>  We looked at a simple system for collecting information about errors in React / Redux applications.  Is it useful in practice?  I suppose it depends on how many errors are manifested in your project, and how difficult their search turns out to be. <br><br>  It may be quite enough, when an error occurs, to record the URL and save information about it, which will allow you to identify the source of the problem.  Or, perhaps, the system of recording user actions will seem successful to you, but the page for replaying a session with the site is not.  If, for example, you encounter errors that, say, occur only in Safari 9 on iOS, the session playback page will be useless, because with its help it will not be possible to repeat the error. <br><br>  If we talk about various kinds of research, about one of which I have just told, then for me the moment of truth comes when I ask myself whether I am ready to embed what was created as a result of the experiment into one of my real projects .  In this case, the answer to this question is negative. <br><br>  In any case, working on a system for intercepting and reproducing user actions is an interesting experience that allowed me to learn something new.  In addition, I believe that one day it all may come in handy if I need to quickly implement a monitoring system on any site. <br><br>  <b>Dear readers!</b>  How do you handle bugs?  We offer to participate in the survey and share your ideas about this. </div><p>Source: <a href="https://habr.com/ru/post/344682/">https://habr.com/ru/post/344682/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../344672/index.html">Search for application performance issues with NodeJs (with examples)</a></li>
<li><a href="../344674/index.html">Trading strategy for trading co-integrated stock pairs</a></li>
<li><a href="../344676/index.html">One + One - Blockchain Charity Marketplace</a></li>
<li><a href="../344678/index.html">Japanese poetry in the service of learning English: an application for memorizing the pronunciation of words</a></li>
<li><a href="../344680/index.html">5-minute guide to esoteric programming languages: try to classify them</a></li>
<li><a href="../344684/index.html">We learn the car to understand languages</a></li>
<li><a href="../344686/index.html">Tanchiki in the console, the second article: "It is time to redo everything!"</a></li>
<li><a href="../344690/index.html">Tutorial on the Unreal Engine. Part 5: How to create a simple game</a></li>
<li><a href="../344692/index.html">The transfer pattern scala.concurrent.Promise to the actor: usage features and alternatives</a></li>
<li><a href="../344694/index.html">Deploy Parallels RAS to Microsoft Azure in half an hour</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>