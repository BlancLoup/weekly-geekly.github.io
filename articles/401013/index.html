<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The gift of the beloved on February 14 from the electronics engineer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings to you, GT reader. For me, as a person of technical and not very romantic, the choice of a gift for any celebration is an incredible pain. E...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The gift of the beloved on February 14 from the electronics engineer</h1><div class="post__text post__text-html js-mediator-article">  Greetings to you, GT reader.  For me, as a person of technical and not very romantic, the choice of a gift for any celebration is an incredible pain.  Everything would have been simple if my beloved could have been given a RAM in a laptop or a slide of processors, but it was never a techie. <br><br>  Well, since: <a href="https://www.youtube.com/watch%3Fv%3D6GxRynfQPWY">Not so expensive gift, how expensive attention</a> (s) - try to invest time.  I present to your attention "Heart v1.0" <br><br><img src="https://habrastorage.org/files/772/31e/41d/77231e41d878453c8cbc358f4d397607.png"><br><a name="habracut"></a><br>  The main idea of ‚Äã‚Äãthe device was collectively invented with my team for ‚ÄúChristmas Tree v1.0‚Äù.  Briefly set of functions: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      - engraved heart greeting <br>  - powered by phone's memory (microUSB connector) <br>  - RGB backlight with the ability to record flash profiles, switchable by button <br>  - night light mode <br>  - Built-in memory to record congratulations.  When connected to a PC is defined as a flash drive. <br><br>  Having discussed / rejoiced at the pledged functionality, we decided to do it - no one then suspected what time costs the heart would require ... <br><br><h3>  Iron </h3><br>  As it turned out - the simplest part of the heart.  The first thing was drawn up a block diagram of the device: <br><br><img src="https://habrastorage.org/files/7a4/93c/70e/7a493c70e0ab4951b1ec11086a5553a4.png"><br><br>  Details were taken from those that we had in stock, and also used more than once in devices.  According to the scheme, the cheapest MK with USB on board STM32F042F6P6, simple LDO is XC6206P332MR, 32 Mbit SPI memory W25Q32FVSSIG (2 pcs on the board, but eventually soldered one), controlled by RGB LED WS2812. <br><br>  Schematic diagram: <br><br><img src="https://habrastorage.org/files/72a/0e4/c6b/72a0e4c6b92543d7b7fc91347f86a5e6.png"><br><br>  The minimum of details and the most important miscalculation is the hope that WS2812 will work normally at the level of 3.3V (Slavik! Yes, I did it a hundred times ... many said). <br><br>  The board was made of the minimum width, in order to hide it as much as possible under the edge of the heart.  White colour.  The result in the figure. <br><br><img src="https://habrastorage.org/files/faa/dae/2a4/faadae2a46f748629f281affc3c31656.png"><br><br><h3>  Feil </h3><br>  Remember I mentioned the timid hope that WS2812 will work at 3.3V level?  So there will not be !!!  More precisely, everything seems to have worked before the USB exchange began.  At the same time, the Blue channel began to fail.  We were looking for a problem in the software for a long time, thinking that there was not enough processor resources, but then we pulled up the PB1 leg to 5V through a 1kŒ© resistor and it all worked out clearly.  The level of log.1 became approximately 4.3V.  I understand that doing so is not good, but there was no choice.  The board turned out pretty elegant "farm": <br><br><img src="https://habrastorage.org/files/317/0e1/b98/3170e1b98c5f4404a1032072a5e2039f.jpg"><br><br><h3>  Soft MK </h3><br>  To facilitate the programming of the MK, it was decided to use the STM HAL Library, since almost everything is already there; you just need to add logic and connect all its modules together.  In this, in part, STM32CubeMX helped us - the generation of most of the code can be assigned to it.  But then everyone decides for himself - the generated code will still have to be significantly corrected, and you will have to pay the firmware size - the HAL library is not compact. <br><br>  However, in our microcontroller 32kb is available, the firmware will take a little more than half, so it is logical to store three-byte sequences (RGB) in the remaining memory, which we transmit in turn to the input of the LED.  Pressing the button will cycle through the sequences that are recorded in the MK flash. <br><br>  Here we are confronted with the first problem: the WS2812 LED is very demanding on the period and duration of pulses, while the pulse time (0.4-0.8 Œºs) is sufficiently short for a processor operating at 48 MHz.  In addition, we must note that in addition to controlling the LED, our microcontroller will also need to maintain communication with the PC via usb and read / write flash memory. <br>  Fortunately, this diode is quite popular and several ways to implement its protocol are described on the Internet, including on STM microcontrollers.  We have chosen, perhaps, one of the most difficult from the point of view of implementation, but also at the same time the most effective from the point of view of processor time - DMA + timer.  DMA writes directly to the GPIO port, the timer controls the DMA channels.  Since DMA writes to the entire port at once, then using other port pins will not work as an output.  That is why the output of PB1 was chosen to control the LED.  Ideologically, everything is simple, but it would have to be pretty tricky with the implementation if it were not for the wonderful library that Martin Hub√°ƒçek wrote and posted on <a href="https://github.com/hubmartin/ws2812b_stm32F3">github</a> .  After a little dopilivaniya under our MK and the selected method of storing RGB sequences, we get a working LED. <br><br><h3>  Flash memory </h3><br>  Imagine giving you a heart with a personalized greeting.  You come home, joyful, connect it to the computer, and instead of ‚ÄúI love!‚Äù It gives you ‚ÄúThe necessary device driver was not found‚Äù or something else like that.  Not good. <br><br>  Therefore, the heart should be recognized as a flash drive in any of the common operating systems, without requiring the installation of drivers.  Therefore, we will use the usb class called ‚ÄúMass storage device‚Äù, the benefit of the STM32 USB Device Library provides us with a turnkey solution.  Stop!  Ready ????  Let's see. <br><br>  We create a project in STM32CubeMX, combine read / write methods for spi flash memory with corresponding calls in the usb mass storage module and immediately find two problems: the flash drive does not want to be safely removed and ‚Äúchokes‚Äù when trying to write something more than the text ‚ÄúHello World "in the README.txt file. <br><br>  The first problem is easy to solve - you need to implement the missing SCSI processing of the StartStopUnit command.  The second is more difficult to solve.  The file system block size (of course, having only 8mb of space, we will use Fat16) 512 bytes.  Memory is able to erase only blocks of 4K.  We will have to reserve one of the blocks for temporary storage (we cannot afford 4kb of RAM with 6kb available).  That is, to write 512 bytes, you have to copy 4k, erase 4k, and copy them back.  Moreover, if the file is large enough, the operating system wants to write to the drive 64kB at a time, and our controller is not able to serve such a large amount of data for it at the right time, given that the flash drive used is also not the fastest.  In general, while the controller slowly writes data 256 bytes at a time (the size of the memory page), the operating system (at least Fedora, on which all this was tested) already has time to decide that the drive has died a brave death. <br><br>  Connoisseurs will certainly indicate a more elegant solution to the problem, but "we will go another way."  Reading the flash memory will be via the mass storage device interface and in this mode it will position itself as Read-Only (at the same time it will be possible to ‚Äúpull the heart‚Äù out of the computer without any ‚Äúsafe extraction‚Äù, but fearing to spoil the file system), and we will record via virtual com port (aka Communication Device Class).  Through the same interface, we will write our RGB sequences to the end of the MK memory. <br><br>  Download mode (mass storage or cdc) will be selected when loading by the pressed (or not) button. <br>  It is said - done (as always, the main amount of time and coffee was spent on these two words).  Returning read-write to the MSC interface, because it turns out that in the read-only mode, macOs refuses to recognize the USB flash drive, it doesn‚Äôt matter, here we‚Äôre fooled by the operating system and will return ‚Äúsuccess‚Äù to any write request without doing anything (again, the decision from the category of "if not elegant, but cheap and cheerful").  Things are easy - PC software. <br><br><h3>  PC software </h3><br>  Since it was decided to make the setting and firmware via the cdc interface, it is no longer possible to drag the files with the mouse and you need a special application that will know how to do it.  Its main task is to provide the user with the opportunity to create a disk image, add user files there and write this image into flash memory.  Also, the application must provide an interface for creating / reading / writing RGB sequences. <br><br>  The application should be cross-platform, and here the Qt library for creating a graphical interface and FatFS from ChaN for creating and managing the image of the disk come to our aid.  Data exchange with the device through the com-port is available in Qt of the latest versions ‚Äúout of the box‚Äù (QSerialPort module), for disk image operations we use QTreeView with the item model, inherited from QabstractItemModel, which additionally implements Drag &amp; Drop operations (whatever you say, drag and drop mouse "convenient and familiar, if we are talking about files / folders).  QListWidget (for displaying a sequence of colors), QtColorWidgets (by Mattia Basaglia) for color selection and QEasingCurve‚Äôs built-in Qt class for smooth (or, conversely, hopping) transitions between colors and creating a rainbow effect is useful for creating RGB sequences. <br><br>  Result: the application has two tabs: <br><br>  1) ‚ÄúStorage‚Äù for files <br><br><img src="https://habrastorage.org/files/592/3ac/357/5923ac357ea541ad8ba3a3fef2da78c5.png"><br><br>  2) "LED" to control RGB sequences <br><br><img src="https://habrastorage.org/files/a0a/8a6/e6b/a0a8a6e6b4f54dfb865a8b7acd1399c6.png"><br><br>  Dialogue for creating RGB sequences: <br><br><img src="https://habrastorage.org/files/d3f/2fb/2d2/d3f2fb2d2e334f008ef4ed03664ea45d.png"><br><br>  The dialogue works in three modes: <br><br>  a) RGB - allows you to specify transitions between two colors specified in the RGB notation. <br>  b) HSV is the same, but in the HSV notation ‚Äî the overflow is more familiar to the human eye, in particular, the ‚ÄúHSV‚Äù + ‚ÄúIterate-&gt; HUE‚Äù mode allows you to create a rainbow. <br>  c) Custom - this mode allows you to manually set each color of a sequence.  It‚Äôs not possible to make large sequences so that in this mode it is very convenient to put out the heart for a while (setting the color ‚Äúblack‚Äù) in this mode. <br><br>  And finally, the definition of our device as a flash drive in Windows / macOs / Linux (Gnome): <br><br><img src="https://habrastorage.org/files/dcc/621/4b9/dcc6214b92aa40b5a3b5dd3cf77a2ef1.png"><br><br><img src="https://habrastorage.org/files/397/434/a0d/397434a0d4ea40d5a061fcd7fa3bab77.png"><br><br><img src="https://habrastorage.org/files/5cf/549/4fc/5cf5494fcefe47dba54c442f72f9eaf3.png"><br><br><h3>  Conclusion </h3><br>  And after all the work done and the text I wrote, I found that I did not take a single normal photo of the heart itself.  Therefore, I attach the option "how it happened": <br><br><img src="https://habrastorage.org/files/185/4b5/0d2/1854b50d264a44b8b7054dc876c3b211.jpg"><br><br><img src="https://habrastorage.org/files/25c/ccb/987/25cccb9873d946b083101dcae6af2b48.jpg"><br><br>  In reality, it looks great (especially with the presence of engraving).  Love your loved ones !!! </div><p>Source: <a href="https://habr.com/ru/post/401013/">https://habr.com/ru/post/401013/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../401003/index.html">Bluetooth charm on everything ready</a></li>
<li><a href="../401005/index.html">Guide Samsung told about the causes of spontaneous ignition Galaxy Note 7</a></li>
<li><a href="../401007/index.html">The colony. Chapter 2: Response to a distress call</a></li>
<li><a href="../401009/index.html">More and more people are hitting the obscurantism and denying the existence of HIV. Russia on the verge of an epidemic</a></li>
<li><a href="../401011/index.html">The study on improving the skills of possession of weapons due to the game of shooters was withdrawn</a></li>
<li><a href="../401015/index.html">Polvox saga: the flight of the Soviet Phoenix from the 80s to a "bright" future in DOOM</a></li>
<li><a href="../401017/index.html">Russian authorities have developed new amendments to the law "On Communications"</a></li>
<li><a href="../401019/index.html">January 1, 1925: the day we opened the universe</a></li>
<li><a href="../401021/index.html">Internet around the world: China</a></li>
<li><a href="../401023/index.html">The lamps are not the same</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>