<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Python for network engineers: getting started</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Probably, many network engineers have already realized that the administration of network equipment only through the CLI is too time consuming and unp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Python for network engineers: getting started</h1><div class="post__text post__text-html js-mediator-article">  Probably, many network engineers have already realized that the administration of network equipment only through the CLI is too time consuming and unproductive.  Especially when running dozens or hundreds of devices, often configured in a single pattern.  To remove a local user from all devices, check the configurations of all routers for compliance with some rules, count the number of enabled ports on all switches ‚Äî these are typical examples of tasks that cannot be solved without automation. <br><br><img src="https://habrastorage.org/web/317/809/5ac/3178095ac8c44f31a7a68a542f867974.png"><br><br>  This article is mainly for network engineers who are not familiar with or very little familiar with Python.  We will consider an example of a script for solving some practical problems, which you can immediately use in your work. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br>  To begin, tell you why I chose Python. <br><br>  Firstly, it is an easy-to-learn programming language that allows you to solve a very wide range of tasks. <br><br>  Secondly, large network equipment manufacturers, such as Cisco, Juniper, Huawei, are implementing Python support on their equipment.  The language has a future in the network sphere, and learning it will not be a waste of time. <br><br>  Thirdly, the language is very common.  Many useful libraries have been written for it, there is a large community of programmers, and you can find answers to most of the questions on the Internet in the first lines of the search results. <br><br>  I am engaged in the design and implementation of a little network projects.  In one of them it was necessary to solve two problems at once. <br><br><ol><li>  Go through several hundred branch routers and make sure that they are configured uniformly.  For example, the interface Tunnel1 is used to communicate with the data center, not Tunnel0 or Tunnel99.  And that these interfaces are configured in the same way, with the exception of their IP addresses, of course. </li><li>  Reconfigure all routers, including add a static route through the IP address of the local provider.  That is, this command will be unique for each router. </li></ol><br>  The script came to the rescue in Python.  Its development and testing took one day. <br><br>  The first thing to do is <a href="https://www.python.org/downloads/">install Python</a> and the highly desirable PyCharm CE.  Download and install Python 3 (now the latest version is 3.6.2).  When installing, select ‚ÄúCustomize installation‚Äù and at the stage of ‚ÄúAdvanced Options‚Äù set a checkbox next to ‚ÄúAdd Python to environment variables‚Äù. <br><br>  PyCharm CE is a free development environment with a very convenient debugger.  <a href="https://www.jetbrains.com/pycharm/download/">Download</a> and install. <br><br>  The second step is to install the necessary netmiko library.  It is needed to interact with devices via SSH or telnet.  Install the library from the command line: <br><br> <code>pip install netmiko</code> <br> <br>  The third step is to prepare the source data and the script for our tasks. <br><br>  We will use the text file ‚Äúip.txt‚Äù as input data.  Each line of the file should contain the IP address of the device to which we connect.  A comma can be used to specify a username and password for a specific device.  If you do not do this, then those that you enter when running the script will be used.  Spaces will be ignored.  If the first character in the ‚Äú#‚Äù line, then it is considered a comment and is ignored.  Here is an example of a valid file: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/79c/36a/692/79c36a692da84571a149327e802c99d0.png"></div><br><br>  The script itself consists of two parts: the main program and the <code>doRouter()</code> function.  Inside it, you connect to the router, send commands to the CLI, and receive and analyze responses.  The input data for the function are: IP address of the router, login and password.  If a problem occurs, the function will return the IP address of the router, we will write it in a separate file fail.txt.  If everything went well, a message will simply be displayed on the screen. <br><br>  Why do we need to make interaction with routers in a separate function, and not to do everything in a loop in the main program?  The main reason is the duration of the script.  Connecting to all routers in turn took me 4 hours.  Mainly due to the fact that some of them did not respond and the script waited a long time for the timeout to expire.  Therefore, we will run in parallel in 10 copies of functions.  In my case, this reduced the script execution time to 10 minutes. <br><br>  We now consider the main program in more detail. <br><br>  For the sake of security, we will not store the login and password in the script.  Therefore, we will display an invitation to enter them.  And when you enter a password, it will not be displayed.  These global variables are used in the <code>doRouter</code> procedure.  I had problems with getpass working in PyCharm under Windows.  The script worked correctly, only if you run it in Debug mode, not Run.  On the command line, everything worked flawlessly.  Also, the script was tested in OS X, there were no problems with PyCharm. <br><br><pre> <code class="python hljs">user_name = input(<span class="hljs-string"><span class="hljs-string">"Enter Username: "</span></span>) pass_word = getpass()</code> </pre> <br>  Then we read the file with IP addresses.  The <code>try‚Ä¶except</code> construction will correctly handle the error of reading the file.  At the output we get an array of data for connection <code>connection_data</code> , containing the IP address, login and password. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: f = open(<span class="hljs-string"><span class="hljs-string">'ip.txt'</span></span>) connection_data=[] filelines = f.read().splitlines() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> filelines: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> line == <span class="hljs-string"><span class="hljs-string">""</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> line[<span class="hljs-number"><span class="hljs-number">0</span></span>] == <span class="hljs-string"><span class="hljs-string">"#"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> conn_data = line.split(<span class="hljs-string"><span class="hljs-string">','</span></span>) ipaddr=conn_data[<span class="hljs-number"><span class="hljs-number">0</span></span>].strip() username=global_username password=global_password <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(conn_data) &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> conn_data[<span class="hljs-number"><span class="hljs-number">1</span></span>].strip() != <span class="hljs-string"><span class="hljs-string">""</span></span>: username = conn_data[<span class="hljs-number"><span class="hljs-number">1</span></span>].strip() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(conn_data) &gt; <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> conn_data[<span class="hljs-number"><span class="hljs-number">2</span></span>].strip() != <span class="hljs-string"><span class="hljs-string">""</span></span>: password = conn_data[<span class="hljs-number"><span class="hljs-number">2</span></span>].strip() connection_data.append((ipaddr, username, password)) f.close() <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: sys.exit(<span class="hljs-string"><span class="hljs-string">"Couldn't open or read file ip.txt"</span></span>)</code> </pre> <br>  Next, create a list of processes and run them.  I set the process creation method as ‚Äúspawn‚Äù so that the script works the same on Windows and OS X.  The number of created processes will be equal to the number of IP addresses.  But no more than 10 will be executed at the same time. In the list of <code>routers_with_issues</code> write what is returned to the <code>doRouter</code> function.  In our case, these are the IP addresses of the routers with which there were problems. <br><br><pre> <code class="python hljs">multiprocessing.set_start_method(<span class="hljs-string"><span class="hljs-string">"spawn"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> multiprocessing.Pool(maxtasksperchild=<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> process_pool: routers_with_issues = process_pool.map(doRouter, connection_data, <span class="hljs-number"><span class="hljs-number">1</span></span>) process_pool.close() process_pool.join()</code> </pre> <br>  The <code>process_pool.join()</code> command is needed so that the script <code>doRouter()</code> for the completion of all instances of the <code>doRouter()</code> functions and only then continues to execute the main program. <br><br>  At the end we create / rewrite a text file in which we will have the IP addresses of the unconfigured routers.  We also display this list on the screen. <br><br><pre> <code class="python hljs">failed_file = open(<span class="hljs-string"><span class="hljs-string">'fail.txt'</span></span>, <span class="hljs-string"><span class="hljs-string">'w'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> routers_with_issues: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> item != <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: failed_file.write(<span class="hljs-string"><span class="hljs-string">"%s\n"</span></span> % item) print(item)</code> </pre> <br>  Now we will analyze the procedure <code>doRouter()</code> .  The first thing to do is to process the input.  Using ReGex, we verify that the correct IP address was transferred to the function. <br><br><pre> <code class="python hljs">ip_check = re.findall(<span class="hljs-string"><span class="hljs-string">"^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$"</span></span>, ip_address) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ip_check == []: print(bcolors.FAIL + <span class="hljs-string"><span class="hljs-string">"Invalid IP - "</span></span> + str(ip_address) + bcolors.ENDC) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ip_address</code> </pre> <br>  Next, create a dictionary with the necessary data to connect and connect to the router. <br><br><pre> <code class="python hljs">device = { <span class="hljs-string"><span class="hljs-string">'device_type'</span></span>: <span class="hljs-string"><span class="hljs-string">'cisco_ios'</span></span>, <span class="hljs-string"><span class="hljs-string">'ip'</span></span>: ip_address.strip(), <span class="hljs-string"><span class="hljs-string">'username'</span></span>: username, <span class="hljs-string"><span class="hljs-string">'password'</span></span>: password, <span class="hljs-string"><span class="hljs-string">'port'</span></span>: <span class="hljs-number"><span class="hljs-number">22</span></span>, } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: config_ok = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> net_connect = ConnectHandler(**device)</code> </pre> <br>  We send commands and analyze the received response from the router.  It will be placed in the <code>cli_response</code> variable.  In this example, we check the current settings.  The result is displayed on the screen.  This part needs to be changed for different tasks.  In this script, we check the current configuration of the router.  If it is correct, then we make changes.  If the check <code>config_ok</code> problems, then set the variable <code>config_ok</code> to <code>False</code> and do not apply the changes. <br><br><pre> <code class="python hljs">cli_response = net_connect.send_command(<span class="hljs-string"><span class="hljs-string">"sh dmvpn | i Interface"</span></span>) cli_response = cli_response.replace(<span class="hljs-string"><span class="hljs-string">"Interface: "</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) cli_response = cli_response.replace(<span class="hljs-string"><span class="hljs-string">", IPv4 NHRP Details"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>).strip() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cli_response != <span class="hljs-string"><span class="hljs-string">"Tunnel1"</span></span>: print(str(ip_address)+<span class="hljs-string"><span class="hljs-string">" - "</span></span> + bcolors.WARNING + <span class="hljs-string"><span class="hljs-string">"WARNING - DMVPN not on Tunnel1. "</span></span> + cli_response+ <span class="hljs-string"><span class="hljs-string">" "</span></span> + bcolors.ENDC) config_ok=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre> <br>  Here the following string operations will be useful. <br><br><table><tbody><tr><th>  Operation </th><th>  Description </th><th>  Example </th></tr><tr><td>  + </td><td>  String concatenation </td><td>  s3 = s1 + s2 <br>  &gt;&gt;&gt; print ('Happy New' + str (2017) + 'Year') <br>  Happy New 2017 Year </td></tr><tr><td>  len (s) </td><td>  Determining the length of the string </td><td></td></tr><tr><td>  [] </td><td>  Substring selection (index starts from zero) </td><td>  s [5] - the sixth character <br>  s [5: 7] - symbols from the sixth to the eighth <br>  s [-1] - the last character, the same as s [len (s) -1] </td></tr><tr><td>  s.split () <br>  s.join () </td><td>  Split lines <br>  Combine strings </td><td>  &gt;&gt;&gt; 'Peter, Lesha, Kohl'.split (', ') <br>  ['Petya', 'Lesha', 'Kohl'] <br><br>  &gt;&gt;&gt; ','. join ({'Peter', 'Lesha', 'Kohl'}) <br>  'Lesha, Peter, Kohl' </td></tr><tr><td>  str (l) <br>  list (s) </td><td>  Convert list to string <br>  Convert string to list </td><td>  &gt;&gt;&gt; str (['1', '2', '3']) <br>  "['1', '2', '3']" <br><br>  &gt;&gt;&gt; list ('Test') <br>  ['T', 'e', ‚Äã‚Äã's', 't'] </td></tr><tr><td>  % </td><td>  Pattern Formatting </td><td>  &gt;&gt;&gt; s1, s2 = 'Mitya', 'Vasilisa' <br>  &gt;&gt;&gt; '% s +% s = love'% (s1, s2) <br>  'Mitya + Vasilisa = love' </td></tr><tr><td>  f </td><td>  Variable substitution </td><td>  &gt;&gt;&gt; a = 'Maxim' <br>  &gt;&gt;&gt; f'Name {a} ' <br>  'Name Maxim' </td></tr><tr><td>  str.find (substr) </td><td>  Search substr in string str <br>  Returns the position of the first substring found </td><td>  &gt;&gt;&gt; 'This is a text'.find (' a ') <br>  eight </td></tr><tr><td>  str.replace (old, new) </td><td>  Replacing the substring old with the substring new in the string str </td><td>  &gt;&gt;&gt; newstr = 'This is a text'.replace (' is', 'is not') <br>  &gt;&gt;&gt; print (newstr) <br>  This is not a text </td></tr><tr><td>  str.strip () <br>  str.rstrip () </td><td>  Remove spaces and tabs at the beginning and end (or only at the end) </td><td>  &gt;&gt;&gt; 'This is a text \ t \ t \ t'.strip () <br>  'This is a text' </td></tr></tbody></table><br>  To solve the problem of adding a static route, first you need to determine the IP address of the <code>next-hop</code> .  In my case, the easiest way is to look at the <code>next-hop</code> address of existing static routes. <br><br><pre> <code class="python hljs">cli_response2=net_connect.send_command(<span class="hljs-string"><span class="hljs-string">"sh run | i ip route 8.8.8.8 255.255.255.255"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cli_response2.strip() == <span class="hljs-string"><span class="hljs-string">""</span></span>: print(str(ip_address)+<span class="hljs-string"><span class="hljs-string">" ‚Äî "</span></span> + bcolors.FAIL + <span class="hljs-string"><span class="hljs-string">"WARNING ‚Äî couldn't find static route to 8.8.8.8"</span></span> + bcolors.ENDC) config_ok=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span> ip_next_hop = <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cli_response2 != <span class="hljs-string"><span class="hljs-string">""</span></span>: ip_next_hop = cli_response2.split(<span class="hljs-string"><span class="hljs-string">" "</span></span>)[<span class="hljs-number"><span class="hljs-number">4</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ip_next_hop == <span class="hljs-string"><span class="hljs-string">""</span></span>: print(str(ip_address)+<span class="hljs-string"><span class="hljs-string">" ‚Äî "</span></span> + bcolors.FAIL + <span class="hljs-string"><span class="hljs-string">"WARNING ‚Äî couldn't find next-hop IP address "</span></span> + bcolors.ENDC) config_ok=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre> <br>  You can send one or more configuration commands at once.  I did not work well sending more than 5 teams at the same time, if necessary, you can simply repeat the design several times. <br><br><pre> <code class="python hljs">config_commands = [<span class="hljs-string"><span class="hljs-string">'ip route 1.1.1.1 255.255.255.255 '</span></span>+ip_next_hop, <span class="hljs-string"><span class="hljs-string">'ip route 2.2.2.2 255.255.255.255 '</span></span>+ip_next_hop] net_connect.send_config_set(config_commands)</code> </pre> <br><br><div class="spoiler">  <b class="spoiler_title">Full script.</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> netmiko <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ConnectHandler <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> getpass <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> getpass <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> multiprocessing <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> re start_time = time.time() <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bcolors</span></span></span><span class="hljs-class">:</span></span> HEADER = <span class="hljs-string"><span class="hljs-string">'\033[95m'</span></span> OKBLUE = <span class="hljs-string"><span class="hljs-string">'\033[94m'</span></span> OKGREEN = <span class="hljs-string"><span class="hljs-string">'\033[92m'</span></span> WARNING = <span class="hljs-string"><span class="hljs-string">'\033[93m'</span></span> FAIL = <span class="hljs-string"><span class="hljs-string">'\033[91m'</span></span> ENDC = <span class="hljs-string"><span class="hljs-string">'\033[0m'</span></span> BOLD = <span class="hljs-string"><span class="hljs-string">'\033[1m'</span></span> UNDERLINE = <span class="hljs-string"><span class="hljs-string">'\033[4m'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doRouter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(connection_data)</span></span></span><span class="hljs-function">:</span></span> ip_address = connection_data[<span class="hljs-number"><span class="hljs-number">0</span></span>] username = connection_data[<span class="hljs-number"><span class="hljs-number">1</span></span>] password = connection_data[<span class="hljs-number"><span class="hljs-number">2</span></span>] ip_check = re.findall(<span class="hljs-string"><span class="hljs-string">"^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$"</span></span>, ip_address) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ip_check == []: print(bcolors.FAIL + <span class="hljs-string"><span class="hljs-string">"Invalid IP - "</span></span> + str(ip_address) + bcolors.ENDC) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ip_address device = { <span class="hljs-string"><span class="hljs-string">'device_type'</span></span>: <span class="hljs-string"><span class="hljs-string">'cisco_ios'</span></span>, <span class="hljs-string"><span class="hljs-string">'ip'</span></span>: ip_address.strip(), <span class="hljs-string"><span class="hljs-string">'username'</span></span>: username, <span class="hljs-string"><span class="hljs-string">'password'</span></span>: password, <span class="hljs-string"><span class="hljs-string">'port'</span></span>: <span class="hljs-number"><span class="hljs-number">22</span></span>, } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: config_ok = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> net_connect = ConnectHandler(**device) cli_response = net_connect.send_command(<span class="hljs-string"><span class="hljs-string">"sh dmvpn | i Interface"</span></span>) cli_response = cli_response.replace(<span class="hljs-string"><span class="hljs-string">"Interface: "</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) cli_response = cli_response.replace(<span class="hljs-string"><span class="hljs-string">", IPv4 NHRP Details"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>).strip() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cli_response != <span class="hljs-string"><span class="hljs-string">"Tunnel1"</span></span>: print(str(ip_address)+<span class="hljs-string"><span class="hljs-string">" - "</span></span> + bcolors.WARNING + <span class="hljs-string"><span class="hljs-string">"WARNING - DMVPN not on Tunnel1. "</span></span> + cli_response+ <span class="hljs-string"><span class="hljs-string">" "</span></span> + bcolors.ENDC) config_ok=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span> cli_response2=net_connect.send_command(<span class="hljs-string"><span class="hljs-string">"sh run | i ip route 1.1.1.1 255.255.255.255"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cli_response2.strip() == <span class="hljs-string"><span class="hljs-string">""</span></span>: print(str(ip_address)+<span class="hljs-string"><span class="hljs-string">" - "</span></span> + bcolors.WARNING + <span class="hljs-string"><span class="hljs-string">"WARNING - couldn't find static route to 8.8.8.8"</span></span> + bcolors.ENDC) config_ok=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span> ip_next_hop = <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cli_response2 != <span class="hljs-string"><span class="hljs-string">""</span></span>: ip_next_hop = cli_response2.split(<span class="hljs-string"><span class="hljs-string">" "</span></span>)[<span class="hljs-number"><span class="hljs-number">4</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ip_next_hop == <span class="hljs-string"><span class="hljs-string">""</span></span>: print(str(ip_address)+<span class="hljs-string"><span class="hljs-string">" - "</span></span> + bcolors.WARNING + <span class="hljs-string"><span class="hljs-string">"WARNING - couldn't find next-hop IP address "</span></span> + bcolors.ENDC) config_ok=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> config_ok: config_commands = [<span class="hljs-string"><span class="hljs-string">'ip route 1.1.1.1 255.255.255.255 '</span></span>+ip_next_hop, <span class="hljs-string"><span class="hljs-string">'ip route 2.2.2.2 255.255.255.255 '</span></span>+ip_next_hop] net_connect.send_config_set(config_commands) print(str(ip_address) + <span class="hljs-string"><span class="hljs-string">" - "</span></span> + <span class="hljs-string"><span class="hljs-string">"Static routes added"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: print(str(ip_address) + <span class="hljs-string"><span class="hljs-string">" - "</span></span> + bcolors.FAIL + <span class="hljs-string"><span class="hljs-string">"Routes weren't added because config is incorrect"</span></span> + bcolors.ENDC) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ip_address <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> config_ok: net_connect.send_command_expect(<span class="hljs-string"><span class="hljs-string">'write memory'</span></span>) print(str(ip_address) + <span class="hljs-string"><span class="hljs-string">" - "</span></span> + <span class="hljs-string"><span class="hljs-string">"Config saved"</span></span>) net_connect.disconnect() <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: print(str(ip_address)+<span class="hljs-string"><span class="hljs-string">" - "</span></span>+bcolors.FAIL+<span class="hljs-string"><span class="hljs-string">"Cannot connect to this device."</span></span>+bcolors.ENDC) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ip_address print(str(ip_address) + <span class="hljs-string"><span class="hljs-string">" - "</span></span> + bcolors.OKGREEN + <span class="hljs-string"><span class="hljs-string">"Router configured sucessfully"</span></span> + bcolors.ENDC) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: <span class="hljs-comment"><span class="hljs-comment"># Enter valid username and password. Note password is blanked out using the getpass library global_username = input("Enter Username: ") global_password = getpass() try: f = open('ip.txt') connection_data=[] filelines = f.read().splitlines() for line in filelines: if line == "": continue if line[0] == "#": continue conn_data = line.split(',') ipaddr=conn_data[0].strip() username=global_username password=global_password if len(conn_data) &gt; 1 and conn_data[1].strip() != "": username = conn_data[1].strip() if len(conn_data) &gt; 2 and conn_data[2].strip() != "": password = conn_data[2].strip() connection_data.append((ipaddr, username, password)) f.close() except: sys.exit("Couldn't open or read file ip.txt") multiprocessing.set_start_method("spawn") with multiprocessing.Pool(maxtasksperchild=10) as process_pool: routers_with_issues = process_pool.map(doRouter, connection_data, 1) # doRouter - function, iplist - argument process_pool.close() process_pool.join() print("\n") print("#These routers weren't configured#") failed_file = open('fail.txt', 'w') for item in routers_with_issues: if item != None: failed_file.write("%s\n" % item) print(item) #Completing the script and print running time print("\n") print("#This script has now completed#") print("\n") print("--- %s seconds ---" % (time.time() - start_time))</span></span></code> </pre> </div></div><br>  After preparing the script, you can execute it from the command line or from PyCharm CE.  From the command line, run the command: <br><br> <code>python script.py</code> <br> <br>  I recommend using PyCharm CE.  There we create a new project, a Python file (File ‚Üí New ...) and paste our script into it.  Put the ip.txt file in the folder with the script and run the script (Run ‚Üí Run) <br><br>  We get the following result: <br><br><pre> <code class="bash hljs">bash ~/PycharmProjects/p4ne $ python3 script.py Enter Username: cisco Password: Invalid IP - 10.1.1.256 127.0.0.1 - Cannot connect to this device. 1.1.1.1 - Cannot connect to this device. 10.10.100.227 - Static routes added 10.10.100.227 - Config saved 10.10.100.227 - Router configured sucessfully 10.10.31.170 - WARNING - couldn<span class="hljs-string"><span class="hljs-string">'t find static route to 8.8.8.8 10.10.31.170 - WARNING - couldn'</span></span>t find next-hop IP address 10.10.31.170 - Routes weren<span class="hljs-string"><span class="hljs-string">'t added because config is incorrect 2.2.2.2 - Cannot connect to this device. #These routers weren'</span></span>t configured<span class="hljs-comment"><span class="hljs-comment"># 10.1.1.256 127.0.0.1 217.112.31.170 1.1.1.1 2.2.2.2 #This script has now completed#</span></span></code> </pre> <br>  A few words on how to debug the script.  The easiest way to do this is in PyCharm.  Mark the line on which we want to stop the execution of the script, and run the execution in debug mode.  After the script stops, you can see the current values ‚Äã‚Äãof all variables.  Check that the correct data is being transmitted and received.  Using the ‚ÄúStep Into‚Äù or ‚ÄúStep Into My Code‚Äù buttons you can continue the script execution step by step. <br><br><img src="https://habrastorage.org/web/80b/bd8/86b/80bbd886bc194a8ab3991d957b4a6081.png"><br><br>  Limitations of the described version of the script: <br><br><ul><li>  tested only in python 3 </li><li>  does not know how to handle the situation when you connect to the router for the first time and get a question like: <br><br> <code>The authenticity of host '11.22.33.44 (11.22.33.44)' can't be established.</code> <br> <code>RSA key fingerprint is SHA256:C+BHaMBjuMIoEewAbjbQbRGdVkjs&amp;840Ve3z4aJo.</code> <br> <code>Are you sure you want to continue connecting (yes/no)?</code> </li> </ul><br>  This script was written to solve specific problems.  However, it is universal and, I hope, will help someone else in the work.  And most importantly - will serve as the first step in the development of Python. <br><br>  The following resources were used when writing the script: <br><br><ul><li>  <a href="https://github.com/ktbyers/netmiko">https://github.com/ktbyers/netmiko</a> is the netmiko library page on GitHub.  There is documentation and examples. </li><li>  <a href="https://pynet.twb-tech.com/blog/automation/netmiko.html">https://pynet.twb-tech.com/blog/automation/netmiko.html</a> - another example with netmiko </li><li>  <a href="">https: //docs.Python .org / 3 / library / multiprocessing.html</a> - description and examples of the multiprocessing library </li></ul><br>  <i>Alexander Garshin, leading engineer and designer of data transmission systems of Jet Infosystems</i> </div><p>Source: <a href="https://habr.com/ru/post/336608/">https://habr.com/ru/post/336608/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336598/index.html">Non-standard approach to the construction of a modern programming language</a></li>
<li><a href="../336600/index.html">Development at a speed of 450 words per minute</a></li>
<li><a href="../336602/index.html">Moscow Exchange is working on a platform for trading cryptocurrencies</a></li>
<li><a href="../336604/index.html">Collecting Windows Server 2016 Boot Event Data</a></li>
<li><a href="../336606/index.html">How to develop an effective project management plan and learn how to prevent problems before they occur</a></li>
<li><a href="../336610/index.html">PostgreSQL partitioning with pg_pathman</a></li>
<li><a href="../336612/index.html">Flappy Bird Machine Learning Algorithm</a></li>
<li><a href="../336614/index.html">How to stop DDoS-attack + WireX Botnet code analysis</a></li>
<li><a href="../336620/index.html">As a newcomer to Go, cont.</a></li>
<li><a href="../336622/index.html">Submit the cool project: utbone core library for unit testing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>