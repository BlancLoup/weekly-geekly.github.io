<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Proper increase in disk size in a virtual machine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Without pretending to be complete, I still think that this can be useful for system administrators. 

 Increasing the size of the disk in the virtual ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Proper increase in disk size in a virtual machine</h1><div class="post__text post__text-html js-mediator-article">  Without pretending to be complete, I still think that this can be useful for system administrators. <br><br>  Increasing the size of the disk in the virtual machine occurred with the following introductory: qcow2 virtual file format, the virtual machine uses lvm and ext4, the root partition is located in the extended partition.  The action usually occurs at night, when the load is minimal and the downtime does not put much pressure on the nerves.  Although when working with highload projects, adrenaline still stands out enough to think 10 times before doing something.  Therefore, before starting the process, it is better to turn off the SMS alert system so as not to scare your colleagues with messages like ‚ÄúServer down‚Äù in the middle of the night. <br><a name="habracut"></a><br>  <b>1. Shut down the virtual machine</b> <br>  I did this through the GUI by clicking on the red power button in the virt-manager.  If there is no virt-manager, this can be done by giving the shutdown command in the virtual machine command line. <br>  <b>2. On the hypervisor, we increase the file size</b> (in my case, 200 gigabytes) <br><pre><code class="bash hljs">qemu-img resize /path/to/vm-disk.qcow2 +200G</code> </pre> <br>  <b>3. We cling the disk to another (service) virtual machine</b> through the control machine with virt-manager, an alternative option is to boot from a CD with lvm support. <br>  Cooperatively, when booting from the LiveCD, vdb will change to vda <br>  <b>4. Start the service machine</b> (it should also have lvm on it) through virt-manager. <br>  <b>5. Next on the service (or LVM liveCD)</b> machine: <br><pre> <code class="bash hljs">parted /dev/vdb</code> </pre> <br>  get disk size: <br><pre> <code class="bash hljs">(parted) <span class="hljs-built_in"><span class="hljs-built_in">print</span></span> Model: Virtio Block Device (virtblk) Disk /dev/vdb: 1288GB Sector size (logical/physical): 512B/512B Partition Table: msdos Number Start End Size Type File system Flags 1 1049kB 256MB 255MB primary ext2 boot 2 257MB 1000GB 1000GB extended 5 257MB 1000GB 1000GB logical lvm</code> </pre> <br>  Increase the extended partition, if you do not get it, we get Error: Can't have overlapping partitions.  ubuntu parted -gparted <br><pre> <code class="bash hljs">(parted) resizepart 2 End? [1000GB]? 1288Gb</code> </pre> <br>  increase logical root partition <br><pre> <code class="bash hljs">(parted) resizepart 5 End? [1000GB]? 1288Gb (parted) q</code> </pre> <br>  now you need to increase the size of the physical disk in lvm <br><pre> <code class="bash hljs">pvresize /dev/vdb5</code> </pre> <br>  increase the size of the logical drive in lvm <br><pre> <code class="bash hljs">root@vm-service:/etc<span class="hljs-comment"><span class="hljs-comment"># lvextend /dev/vm-db-0-vg/root -l +100%FREE lvextend /dev/vm-db-0-vg/root -l +100%FREE File descriptor 7 (pipe:[7918]) leaked on lvextend invocation. Parent PID 1378: bash (     ) Extending logical volume root to 1.12 TiB Logical volume root successfully resized root@vm-service:/etc# resize2fs /dev/vm-db-0-vg/root</span></span></code> </pre><br>  The output of resize2fs should be this: <br><pre> <code class="bash hljs">The filesystem on /dev/vm-db-0-vg/root is now 231278592 blocks long.</code> </pre> <br>  Now check and fix the file system: <br><pre> <code class="bash hljs">fsck -f /dev/mapper/vm--db--0--vg-root</code> </pre><br>  the disk is ready <br>  <b>6. turn off the service machine</b> , disable the virt-manager disk from it <br>  from the command line, without using the GUI to manage virtual machines, you can do this with virsh, the use of which is well described here: <a href="http://docs.fedoraproject.org/ru-RU/Fedora/12/html/Virtualization_Guide/chap-Virtualization_Guide-Managing_guests_with_virsh.html">managing virtual machines from the command line</a> <br>  <b>7. Start the server</b> <br>  <b>An increase with minimal downtime, almost on the fly, tested for lvm2 / ext4 can be done like this:</b> <br>  1. Increasing the file size by 200 gigabytes is performed on the hypervisor <br><pre> <code class="bash hljs">qemu-img resize /path/to/vm-disk.qcow2 +200G</code> </pre> <br>  2. Reboot the virtual machine <br>  3. On the virtual machine <br><pre> <code class="bash hljs">parted /dev/vda</code> </pre> <br>  Let's see the size of the physical disk and all logical partitions. <br><pre> <code class="bash hljs">(parted) <span class="hljs-built_in"><span class="hljs-built_in">print</span></span> Model: Virtio Block Device (virtblk) Disk /dev/vda: 1288GB Sector size (logical/physical): 512B/512B Partition Table: msdos Number Start End Size Type File system Flags 1 1049kB 256MB 255MB primary ext2 boot 2 257MB 1000GB 1000GB extended 5 257MB 1000GB 1000GB logical lvm</code> </pre> <br>  increase the extended partition <br><pre> <code class="bash hljs">(parted) resizepart 2 End? [1000GB]? 1288Gb</code> </pre> <br>  increase logical root partition <br><pre> <code class="bash hljs">(parted) resizepart 5 End? [1000GB]? 1288Gb (parted) q</code> </pre> <br>  now you need to increase the size of the physical disk in lvm <br><pre> <code class="bash hljs">pvresize /dev/vda5</code> </pre> <br>  increase the size of the logical drive in lvm <br><pre> <code class="bash hljs">root@vm-db-0:/etc<span class="hljs-comment"><span class="hljs-comment"># lvextend /dev/vm-db-0-vg/root -l +100%FREE lvextend /dev/vm-db-0-vg/root -l +100%FREE File descriptor 7 (pipe:[7918]) leaked on lvextend invocation. Parent PID 1378: bash Extending logical volume root to 1.12 TiB Logical volume root successfully resized root@vm-db-0:/etc# resize2fs /dev/vm-db-0-vg/root</span></span></code> </pre> <br>  In this case, you cannot check and correct the file system, fsck -f / dev / mapper / vm - db - 0 - vg-root will kill the file system <br>  Check what happened: <br><pre> <code class="bash hljs">df -h</code> </pre> <br>  <a href="http://habrahabr.ru/post/261755/">Continuing the theme</a> </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/252973/">https://habr.com/ru/post/252973/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252963/index.html">How to steal money that is not. Or something new about cryptocurrencies</a></li>
<li><a href="../252965/index.html">Neuroplasticity in artificial neural networks</a></li>
<li><a href="../252967/index.html">How not to configure antifraud rules on user geography</a></li>
<li><a href="../252969/index.html">Localization of Android applications using Google Sheets</a></li>
<li><a href="../252971/index.html">Building a Nodejs Modular System</a></li>
<li><a href="../252975/index.html">Create your Amazon-like navigation menu</a></li>
<li><a href="../252977/index.html">Time is money =?</a></li>
<li><a href="../252979/index.html">Watching new lease addresses on a DHCP server using PowerShell</a></li>
<li><a href="../252983/index.html">We show the work process of a continuous task on the server using one connection.</a></li>
<li><a href="../252985/index.html">Visual linear approximation with Gnuplot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>