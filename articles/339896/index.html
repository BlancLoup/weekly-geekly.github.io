<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Instructions on how to compile the dynamic ngx_pagespeed module for Nginx to Debian</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Objective: To provide instructions for building a dynamic module, to give an understanding of the principle of building a dynamic module for Nginx sup...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Instructions on how to compile the dynamic ngx_pagespeed module for Nginx to Debian</h1><div class="post__text post__text-html js-mediator-article">  <b>Objective:</b> To provide instructions for building a dynamic module, to give an understanding of the principle of building a dynamic module for <a href="https://wiki.debian.org/ru/nginx/nginx%2Bphp-fpm">Nginx supplied from the Debian repository</a> . <br><br>  <b>Target audience:</b> Server administrators, advanced website administrators, SEOs, and just those who want to achieve a good rating from the <a href="https://developers.google.com/speed/pagespeed/">Google PageSpeed</a> service. <br><br>  There are many articles on this topic in search that shine, but in my opinion, none have been disclosed as it should.  Yes and no explanatory explanation.  For an inexperienced user, this can be difficult, and most of the articles explain how to build Nginx along with the module, and only a few show that it is possible to assemble a dynamic one. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The action plan is: <br><br>  1. We rent vps for an hour. <br>  2. We build a dynamic module <b>on the</b> rented vps <b>on the same Nginx version that was used in the combat</b> ( <i>it is</i> <b>IMPORTANT !!!</b> . <b>Nginx started supporting dynamic modules from version 1.9.11</b> ). <br>  3. Transfer the module to the new server. <br>  4. Configure Nginx. <br>  5. Apply the settings. <br>  6. Freeze the Nginx version ( <i>If this is not done, the next time Nginx is updated, the server will crash. The reason is that the compiled module will work only with a specific version of Nginx. If you want to upgrade, compile the module for the new version and upgrade</i> ). <br><br>  Or we watch that we update and in due time we add the new assembled module. <br><br>  The advantage is that the combat server is not subject to change, and if for example you don‚Äôt like ngx_pagespeed, then you simply remove the lines that configure it and the module itself.  Well, if you use multiple servers with Nginx, you can once compile the module for them all. <br><a name="habracut"></a><br>  Good links to similar articles, but not enough disclosed in my opinion: <br><br>  ‚Üí <a href="https://www.linode.com/docs/web-servers/nginx/install-nginx-pagespeed-module-on-ubuntu1604">Install Nginx ngx_pagespeed Module on Ubuntu 16.04</a> <br>  ‚Üí <a href="https://gist.github.com/jniltinho/393728f0323a3aad636387d6e584de77">How to Install Nginx and Google PageSpeed ‚Äã‚Äãon Debian / Ubuntu</a> <br>  ‚Üí <a href="https://losst.ru/nastrojka-nginx">SETUP NGINX</a> <br><br>  Official ngx_pagespeed links <br>  ‚Üí <a href="https://github.com/pagespeed/ngx_pagespeed">ngx_pagespeed - gihub</a> <br>  ‚Üí <a href="https://www.modpagespeed.com/doc/">Documentation ngx_pagespeed</a> <br><br>  We proceed to the instructions. <br><br>  Connect to the test server via ssh. <br><br>  Install <a href="https://wiki.debian.org/apt-src">apt-src</a> . <br><br><pre><code class="bash hljs">apt install apt-src</code> </pre> <br>  Add the source code repository and package repository with the required version of Nginx. I have this <a href="https://packages.debian.org/sid/nginx">Nginx / 1.13.5</a> <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e <span class="hljs-string"><span class="hljs-string">'deb-src http://ftp.ru.debian.org/debian sid main\ndeb http://ftp.ru.debian.org/debian sid main'</span></span> &gt;&gt; /etc/apt/sources.list</code> </pre> <br>  Update the package cache. <br><br><pre> <code class="bash hljs">apt update apt-src update</code> </pre> <br>  Download the Nginx source in the current folder. <br><br><pre> <code class="bash hljs">apt-src install nginx</code> </pre> <br>  In the process of executing the command, not only all the source codes will be downloaded, but also all the necessary dependencies will be installed. <br><br>  Install the necessary dependencies for the module: <br><br><pre> <code class="bash hljs">apt install build-essential zlib1g-dev libpcre3 libpcre3-dev unzip ca-certificates</code> </pre> <br>  Check the <a href="https://www.modpagespeed.com/doc/release_notes">current version of the</a> module. <br><br>  We indicate the version to install. <br><br><pre> <code class="bash hljs">NPS_VERSION=1.12.34.3-stable</code> </pre> <br>  Download the source of the module: <br><br><pre> <code class="bash hljs">wget https://github.com/pagespeed/ngx_pagespeed/archive/v<span class="hljs-variable"><span class="hljs-variable">${NPS_VERSION}</span></span>.zip</code> </pre> <br>  Unpack the current folder: <br><br><pre> <code class="bash hljs">unzip v<span class="hljs-variable"><span class="hljs-variable">${NPS_VERSION}</span></span>.zip</code> </pre> <br>  Prepare the source for the assembly: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ngx_pagespeed-<span class="hljs-variable"><span class="hljs-variable">${NPS_VERSION}</span></span>/ NPS_RELEASE_NUMBER=<span class="hljs-variable"><span class="hljs-variable">${NPS_VERSION/stable/}</span></span> psol_url=https://dl.google.com/dl/page-speed/psol/<span class="hljs-variable"><span class="hljs-variable">${NPS_RELEASE_NUMBER}</span></span>.tar.gz [ -e scripts/format_binary_url.sh ] &amp;&amp; psol_url=$(scripts/format_binary_url.sh PSOL_BINARY_URL) wget <span class="hljs-variable"><span class="hljs-variable">${psol_url}</span></span> tar -xzvf $(basename <span class="hljs-variable"><span class="hljs-variable">${psol_url}</span></span>)</code> </pre> <br>  Now we will add information about our module to the raws so that it will be gathered together with Nginx, we will first learn the path to the raw materials of our module. <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span> nano ../nginx-1.13.5/debian/rules</code> </pre> <br>  We see the highlighted path after the first command in order to add it to the rules. <br><br><pre> <code class="hljs cs">--<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span>-module=/root/ngx_pagespeed<span class="hljs-number"><span class="hljs-number">-1.12</span></span><span class="hljs-number"><span class="hljs-number">.34</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>-stable</code> </pre> <br><img src="https://habrastorage.org/webt/59/de/86/59de861c6600b968278930.png" alt="image"><br><br>  We proceed to the assembly before returning to a higher level. <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../ apt-src build nginx</code> </pre> <br>  During the assembly process, a question will be asked, we answer it no. <br><br><img src="https://habrastorage.org/webt/59/de/86/59de86b008e4d222884581.png" alt="image"><br><br>  After a successful build, I found the module at: <br><br><pre> <code class="bash hljs">./nginx-1.13.5/debian/build-extras/objs/ngx_pagespeed.so</code> </pre> <br>  On the combat server we place in the folder: <br><br><pre> <code class="bash hljs">/usr/lib/nginx/modules</code> </pre> <br>  Next in the file: <br><br><pre> <code class="bash hljs">/etc/nginx/nginx.conf</code> </pre> <br>  add module loading: <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">load_module</span></span> modules/ngx_pagespeed.so;</code> </pre> <br>  If you want to use the module in all sites, specify these two lines in the same place. <br>  If the folder that you specify does not exist, create it and assign it the rights of the nginx user. <br><br><pre> <code class="bash hljs">mkdir -p /var/cache/nginx/ngx_pagespeed chown www-data:www-data /var/cache/nginx/ngx_pagespeed</code> </pre> <br><pre> <code class="nginx hljs"><span class="hljs-comment"><span class="hljs-comment"># Pagespeed pagespeed on; pagespeed FileCachePath /var/cache/nginx/ngx_pagespeed;</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/59/de/8b/59de8b29b8e96455070227.png" alt="image"><br><br>  In the virtual host of sites on which we want the module to work, we add: <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~ "\.pagespeed\.([az]\.)?[az]</span></span>{2}\.[^.]{10}\.[^.]+" { <span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~ "^/pagespeed_static/"</span></span> { } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~ "^/ngx_pagespeed_beacon$"</span></span> { }</code> </pre> <br>  In the virtual hosts of sites on which it should not work we add: <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">pagespeed</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>;</code> </pre> <br>  I will be glad to any comments, if something did not work out for you, write.  I will supplement the article as questions arise. </div><p>Source: <a href="https://habr.com/ru/post/339896/">https://habr.com/ru/post/339896/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../339874/index.html">About the Strata AI conference: the future of artificial intelligence</a></li>
<li><a href="../339878/index.html">Uneducated youth. What's left overs</a></li>
<li><a href="../339882/index.html">How do we at Tutu.ru achieve the effectiveness of each of the 9000+ UI tests?</a></li>
<li><a href="../339892/index.html">Vraytap autumn crackme from Kaspersky Lab</a></li>
<li><a href="../339894/index.html">What every developer should know about the search</a></li>
<li><a href="../339900/index.html">Stream in NodeJS - rivers that you enter twice</a></li>
<li><a href="../339902/index.html">Maven, where are my artifacts? Another article about dependency management</a></li>
<li><a href="../339904/index.html">Overview of the Luigi Framework for building sequences of tasks</a></li>
<li><a href="../339906/index.html">Home Minecraft server in Azure part 2 - Azure Automation</a></li>
<li><a href="../339908/index.html">Killer feature Vim</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>