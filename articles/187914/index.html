<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we do the Alkoscaner</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr. 

 Today I want to tell in some detail about how we made an application consisting not only of a client server, but also connected with the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we do the Alkoscaner</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://alcoscanner.ru/"><img src="https://habrastorage.org/getpro/habr/post_images/f30/b05/4f4/f30b054f44cb87ba722286faefd5c19e.png"></a> <br><br>  Hi, Habr. <br><br>  Today I want to tell in some detail about how we made an application consisting not only of a client server, but also connected with the outside world. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Application - <a href="http://alcoscaner.ru/">Alkoskaner</a> , made for <a href="https://itunes.apple.com/WebObjects/MZStore.woa/wa/viewSoftware%3Fid%3D654997316%26mt%3D8">iPhone</a> and <a href="https://play.google.com/store/apps/details%3Fid%3Dru.veborg.alcoscanner">Android</a> (from 4.0 so far, release for two is preparing for release).  Totally free.  Brief essence - aggregator of stocks and special offers for the purchase of alcohol.  Currently working in Moscow (million-plus cities will be gradually added), supported by 2500 stores, in the database of about 70,000 special offers. <br><br>  Initially, everything was planned in one form, as a result, the application evolved well to release, but this also gave rise to certain problems. <br><br><a name="habracut"></a><br><h4>  Let's start with the server </h4><br><br><img src="https://habrastorage.org/getpro/habr/post_images/125/b74/677/125b7467759aafaa88fb91bf3edc0d72.png" alt="image"><br><br><h5>  1. Work speed </h5><br>  In general, a very key factor that is particularly relevant on mobile phones (no one will wait long for an answer, especially when you want to drink now).  Initially, everything was fine, but after loading the first combat base, it turned out that there was so much data that they would go to the client forever, especially on the radius of Moscow.  I had to rewrite the conclusion that caused significant brakes on the server side.  Optimized, optimized and optimized.  On a dedicated server, everything worked quite quickly and adequately with Hetzner, but then we moved to Selectk ... <br><br><h5>  2. Server platform </h5><br>  When choosing a hosting provider, we were guided by the proximity of servers to Moscow to reduce ping in the first place and scaling (preferably automatic), secondly, because during peak mailing periods we have hundreds of users at a time, and queries related to geo-location are quite expensive.  For some reason, the Scalaxi never answered the call once, chose Selektel (by the way, I somehow don‚Äôt even know other Russian clouds, maybe you can tell?).  But it didn‚Äôt happen - constant independent server drops without load, soaring under 200% of the CPU load, when there is no one in the application, etc.  persuaded to return to Hetzner. <br><br><h5>  3. Summary </h5><br>  So far everything runs on PHP + MySQL (CodeIgniter framework with its own add-on above it).  We are planning to bring part of MySQL to Redis, since  architecture is constantly evolving and requests are becoming more expensive. <br><br><h4>  IPhone part </h4><br><br><img src="https://habrastorage.org/getpro/habr/post_images/236/a82/bba/236a82bba54f63c6ac604a64dc7025aa.png"><br><br><h5>  1. YandexMapKit integration. </h5><br>  Download from gitHub library.  We run an example - everything works fine, a lot of things can. <br>  We integrate into the project, using a small description on the gita, how to do it.  Compiled and earned everything with a half kick.  But after a couple of weeks of working with the UC, all of a sudden, the app began to crumble on adding annotations on the map.  Debug as the main tool for the search for bugs did not give anything, searches for descriptions of similar situations in the internet also did not succeed.  The issue in GitHub is still answered) <a href="https://github.com/yandexmobile/yandexmapkit-ios/issues/95">github.com/yandexmobile/yandexmapkit-ios/issues/95</a> <br>  They decided everything in the end by demolishing the entire library from the project and re-importing it, even the code was not to be rewritten.  Everything went on smoothly, but not one hour of time left like water in the sand, and the sediment remained. <br><br><h5>  2. Additional points and clustering. </h5><br>  Googling a little and not finding a hint of such tasks, without much hope unsubscribed to the same issues on GitHub with a request to suggest how to implement clustering on the UC.  <a href="https://github.com/yandexmobile/yandexmapkit-ios/issues/109">github.com/yandexmobile/yandexmapkit-ios/issues/109</a> Almost immediately, some of the guys who were already using Yak answered that they did this by hand.  For what, rolling up our sleeves, we started.  Having scribbled a simple, but ornate algorithm, it turned out to achieve the desired result - with the zoom, additional points turned into full-fledged balloons, and at a distance - again turned into a small red mark. <br><br><h5>  3. Building a route </h5><br>  And again YAK.  Want a route from point to point?  Api can't do this.  Start YandexNavigator from your App and transfer coordinates there, and it will only build a car route.  Do you want to use Yandex.Maps to build a pedestrian?  Use Android!  He is able, iOS-kit - no. <br><br><h4>  Android </h4><br><br><img src="https://habrastorage.org/getpro/habr/post_images/d6a/b5b/79e/d6ab5b79e1059281eeace3d5ec813685.jpg"><br><br><h5>  1. Data exchange with the server </h5><br>  No one could have imagined that on a large amount of data the good old JSON turns into a stunned old woman ... <br>  The first implementation of the parser was the native Androids - JSONParser, which did not show itself from the best side even before the actual amount of data was loaded.  But when they loaded ... They got from 15-90 seconds of parsing, which was oh, how not good.  With this, JSONParser ate not so little memory, sometimes filling up the application.  The first way out of this situation was to increase the heap of the application, using the attribute ‚ÄúLarge heap‚Äù.  But this did not solve the problem with speed. <br>  The guru androd was sent on the right path and dropped the link to the repository <a href="https://github.com/johnkil/Android-JSONCompare">https://github.com/johnkil/Android-JSONCompare</a> .  The graphs and samples showed the potential speed of parsing, but only rock - only hardcore!  To begin with, we took up JSON.simple, which, when implemented within objects, was not very different from native, allowing it to be used on the fly without significant changes in the code.  The result was depressing, as was to be expected, with a significant load of 1000+ records, simple started to blunt even worse than JSONParser.  Further, the choice fell on GSON, which, in turn, on the implementation of the same was very similar to the native, which immediately alerted, given the previous failure.  But it turned out not so bad!  90 seconds turned into a maximum of 30. But even that didn‚Äôt suit anyone, so there was only one choice - Jackson.  The parser is original, in comparison with the previous ones, but, by trial and error, we still forced it to work for ourselves.  And they were shocked. <br>  He showed himself even better than in a dream could dream.  The previous 30 seconds have sunk into oblivion and surfaced for 3-5 seconds. <br><br><h5>  2. Oh, these Yandex.Maps </h5><br>  Considering that the application for Russia, where Google and Apple maps are still very sad, the choice of the map fell on Yandex.cards.  First, here is the <a href="https://github.com/yandexmobile/yandexmapkit-android">github.com/yandexmobile/yandexmapkit-android</a> repository itself.  It began to use maps quite easily, but ‚Äúthe deeper into the forest, the angrier the woodpeckers‚Äù.  The first brake point was the installation of points on the map, the points, like the baluns, were custom ones, they were installed perfectly, but when there are more than 50+ on the map, significant memory leaks start, due to which the application began to fall systematically.  At first, we assumed that the leaks were somewhere in our code.  Walking through the code more than once, optimizing the image we use instead of the flag, re-encoding and compressing it, we found out that nothing had changed ... As a result, I had to restrict myself to random percentage of data (every 3 entries) that fell into a certain radius around the center of the map.  But by this time, I really wanted to go testing the application in the field, because fiction was becoming far from scientific.  Further - calmer, until the moment when two obvious and very noticeable bugs came out: black tiles or tiles that behave very strange ( <a href="https://github.com/yandexmobile/yandexmapkit-android/issues/105">https://github.com/yandexmobile/yandexmapkit-android/issues/105</a> ) or spontaneous crashes clicking on the baluns ( <a href="https://github.com/yandexmobile/yandexmapkit-android/issues/122">https://github.com/yandexmobile/yandexmapkit-android/issues/122</a> ).  At the same time, the entire library has not been updated for nearly a year, considering how many bugs were detected and corrected by both users and developers ... In general, having armed ourselves with brains and a tambourine tambourine, we forced this library to work without crashing (frequent), but the project manager at some point, he began to seriously think about writing his own mapkit for Yandex.Maps. <br><br><h5>  3. Port 2.2+ </h5><br>  For a quick conversion, it was decided to use the Sherlock library.  Its first application left a pleasant residue on the soul.  Redoing the application from 4.0 to 2.2 took 15 minutes, while all the functionality remained untouched, there were only minor problems with the styles, or rather with the standard android style indents, but this was solved 5 minutes after the search. <br>  And then - more.  Tests on all the phones that were on hand (2.2, 2.3) show no problems, tests from friends and acquaintances who are hundreds of kilometers away - crash, crash, crash ... <br>  Here, tests are still ongoing, suggestions for reasons of falls on every HTC Desire are accepted <br><br><h5>  4. Animation </h5><br>  Animation, as an action in the system, is a very simple process in terms of implementation.  But the observations and test showed an interesting picture.  When you call an asynchronous request to the server, an animation appears, which, both in appearance and implementation, is very simple.  Although the data is loaded asynchronously, the parsing takes place as it is strangely long, with a delay.  After receiving the data, we immediately parse in the doInBackground, and then in onPostExecute we display them (as it should).  It seems that a simple animation loads the UI thread, which later loads the application.  Measurements with animation that the animation slows down parsing data by about 3 seconds (SGS3).  On different devices, this delay time is different, which leaves the question open even now. <br><br><h4>  Data </h4><br><br>  All this work made sense only if we could fill the app with up-to-date information about discounts in stores.  Now I‚Äôll open a small secret: no, we didn‚Äôt suck up to some secret database, as many people who used the application think.  There are shops from which we receive data directly, but so far there are few of them.  During the development of the collection process, we came to the conclusion that a single process gives unstable quality results, and that every trading network needs to be studied, and now we have more than one process, but actually 20+ collection procedures, by the number of networks, and these procedures are important part of the application.  Our methods cannot give 100% accuracy, but according to our own tests, we have 80% accuracy.  There are still various ridiculous problems, right up to a fight with guards and blocking the assembler in the room, contrary to Art.  29 of the Constitution of the Russian Federation (which emphasizes its authority in the country), but in general we cope with these incidents, inventing various tricks if necessary. <br><br>  We will be happy to answer questions and clarifications in the comments. </div><p>Source: <a href="https://habr.com/ru/post/187914/">https://habr.com/ru/post/187914/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../187890/index.html">Podcast: 10 formulas about power, motivation, influence and freedom from Mikhail Zavileisky</a></li>
<li><a href="../187892/index.html">Happy System Administrator!</a></li>
<li><a href="../187894/index.html">What can you learn about the candidate for the test task</a></li>
<li><a href="../187902/index.html">Zipkin from Twitter</a></li>
<li><a href="../187908/index.html">MP Mizulina proposed to block sites for the mat</a></li>
<li><a href="../187918/index.html">Congratulations on the day of the system administrator!</a></li>
<li><a href="../187928/index.html">Motorola Atrix HD: a rare smartphone for fans of junk and not only</a></li>
<li><a href="../187930/index.html">How much of this sound: the story of Nokia Tune</a></li>
<li><a href="../187934/index.html">US authorities require major Internet companies to disclose user passwords</a></li>
<li><a href="../187936/index.html">Adaptive filter search</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>