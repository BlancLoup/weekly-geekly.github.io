<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Chinese HID USBISP Programmer (USBASP) in Linux. Preprogramming</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Microcontroller programming and robotics are very promising areas of activity. This is already being discussed at the state level. And it all starts w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Chinese HID USBISP Programmer (USBASP) in Linux. Preprogramming</h1><div class="post__text post__text-html js-mediator-article">  Microcontroller programming and robotics are very promising areas of activity.  This is already being discussed at the state level.  And it all starts with the fact that beginners collect their first programmer or order it from the online store.  The most affordable are Chinese crafts.  They are not always ready to immediately please their new owners.  However, usually, they are quite efficient after revision and / or flashing. <br><br><img src="https://habrastorage.org/files/c48/db4/d09/c48db4d092c0424f937e9d0b5d813c13.jpg"><br><br>  The situation is complicated by the fact that there are many similar models and different versions of Chinese-made printed circuit boards.  I got programmers with a printed circuit board that is incompatible with the firmware on the network.  Trite, does not match the purpose of the conclusions of the microcontroller on the board and in the program.  Next, I will describe the process of treating a small batch of these programmers and some tricks for beginners. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I hope someone this article will be useful, since it is specifically for this version of the programmers information on the Internet, apparently, no. <br><br>  For those who want a quick solution, at the end of the article there is a link to the archive with the USBASP from Thomas Fischl, which I modified, and a list of changes in the git diff format. <br><a name="habracut"></a><br><h4>  Purchase </h4><br>  I decided to buy a set of programmers and microcontrollers for classes in robotics in our <a href="http://zabota.nnov.ru/clubhouse">Center for Children's Computer Creativity</a> .  The choice fell on Aliexpress.  Cheap and angry. <br>  I ordered a pack of Attiny13A, a couple of pads for them, several Atmega32 on the training boards, mockups, and, of course, a dozen USBASP programmers.  Earlier, I ordered a couple of similar programmers - one of them even worked. <br><br><img src="https://habrastorage.org/files/7d0/5b5/a16/7d05b5a162cc448ba1cf4c11c2363b67.JPG"><br><br>  As it turned out, the delivered programmers turned out to be inoperable in Ubuntu Linux.  One of them corresponded to the advertising picture, the other 9 were slightly longer and not packed in anti-static bags.  At the same time, all 10 had USBISP on the case and were proudly defined as a HID device. <br><br><div class="spoiler">  <b class="spoiler_title">Description of the programmer USBASP USBISP with aliexpress (by the way, not a word about Linux):</b> <div class="spoiler_text">  <b>The USBASP USBISP AVR / 51 Series Programmer Download Aluminum Shell 64K Limit Support WIN7 64</b> <br><br>  Description: <br><br>  Perfectly support WIN7 <br><br>  1, support USB1.1 or USB2.0 communication. <br>  2, support WIN98, WINME, WIN2K, WINXP operation system. <br>  3. USB ports Power supply <br>  4, download not finish influence the operation of the target board. <br>  5, support S51 and AVR chips record, ISP speed, faster than parallel, more stable;  The best choice. <br>  6, The latest version of the firmware upgrade, download speed jump line <br>  7, using standard IDC10 interface <br></div></div><br><br>  Sly Chinese, wanting to simplify the lives of users of the default OS, wrote a firmware that does not require drivers.  One minus - only one Chinese program with the interface in the Chinese language and only in one OS can work with these programmers.  This option absolutely did not suit me. <br><br><h4>  Finding a solution </h4><br>  A web search led me to the <a href="http://www.sciencetronics.com/greenphotons/%3Fp%3D938">Hacking an AVR programmer</a> page. <br>  There everything is fine and well described.  I was delighted and began to disassemble the programmers.  It turned out to be easy.  They struck the original design solutions in the form of an insulator of double-sided tape. <br><br><img src="https://habrastorage.org/files/f1c/142/318/f1c14231893140dd91275fc05d46c605.JPG"><br><br><img src="https://habrastorage.org/files/675/456/a75/675456a75b2a41638848766e37845f70.JPG"><br><br>  I was happy early.  On this page, the process of flashing was described for another version of the programmer (v3.0), which is otherwise divorced.  I had an unidentified version of the programmer in my hands. <br><br><img src="https://habrastorage.org/files/f72/3b6/485/f723b64851d54a8aa7d49f5ce3e5bfb1.JPG"><br><br>  The result of studying the board is the picture below.  Everything that could have been divorced differently than in the already familiar third version with a blue card.  This did not prevent the finalization of the firmware, in which the output numbers had to be changed, their initialization (see the article <a href="http://www.sciencetronics.com/greenphotons/%3Fp%3D938">Hacking an AVR programmer</a> ) and the LED control algorithm. <br><br><img src="https://habrastorage.org/files/649/742/85d/64974285dab24303bf066fe4ad2fa928.jpg"><br><br>  In the original usbasp firmware for USB and LEDs correspond legs 12,13 and 23,24.  On the board, the outputs of 1.32 and 9.10 were divorced.  In this case, the LEDs were connected in parallel, which was subsequently taken into account in the program. <br><br>  There were no jumpers for programming here.  Therefore, I had to slightly alter the cable, releasing the ‚ÄúReset‚Äù posting at will.  I temporarily soldered this wire to the ‚ÄúReset‚Äù input for programming the victim. <br><br><img src="https://habrastorage.org/files/8ad/ccd/385/8adccd3857284a4fa7ec6713ad5d64b6.JPG"><br><br><img src="https://habrastorage.org/files/502/6b9/fc7/5026b9fc77bb4d63be3a28a13c34aeb9.JPG"><br><br>  An illustrative picture that helped me in matching the controller's legs (ATmega8): <br><br><img src="https://habrastorage.org/files/2a6/060/e1e/2a6060e1e99c4740a23dc0c1c19dbf86.png"><br><br>  It is good that there was already a working programmer.  Just version v3.0, but with a working firmware. <br><br><img src="https://habrastorage.org/files/3ce/cf9/6c0/3cecf96c0e8d4fba9bd44aa22580695f.JPG"><br><br><h4>  Flashing </h4><br>  The first two programmers were stitched successfully.  The third protested.  It turned out that it was exactly the 29th leg of the ‚ÄúReset‚Äù that was not soldered. <br><br><img src="https://habrastorage.org/files/059/6a8/202/0596a820240f4c74b05dc7b82d8ca1fe.JPG"><br><br>  Eliminating this cant, I continued to work. <br><br><img src="https://habrastorage.org/files/8da/960/15b/8da96015b3e14f00bb8a249cb3cc3568.JPG"><br><br>  On the fifth programmer, I was tired of soldering entries to the reset, and I applied a less reliable but faster method.  Helped daughter's hair tie. <br><br><img src="https://habrastorage.org/files/7c4/fa8/971/7c4fa89717964baf8a799a13d010d1bb.JPG"><br><br>  The victim programmer is plugged into a USB hub (blue) only to be more stable - the hub is not connected anywhere. <br>  Sometimes I received messages from avrdude that the controller is not responding.  It was saved by lowering the voltage with a three-meter USB extension cable and reducing the programming speed (the -B switch in the ‚Äúavrdude -c usbasp -p m8 -B 50‚Äù line). <br><br><h4>  The most important snack </h4><br>  Archive with original firmware: <a href="">www.fischl.de/usbasp/usbasp 2011-05-28.tar.gz</a> <br>  We look in the Readme.txt section "BUILDING AND INSTALLING FROM SOURCE CODE" <br>  Extract the folder from the archive /usbasp.2011-05-28/firmware/ <br>  We are updating the firmware to taste. <br>  In the console, go to the firmware folder and run make to get help on the available commands. <br>  We compile the firmware and upload it into the programmer (through another working programmer). <br><br><div class="spoiler">  <b class="spoiler_title">Git diff for this project (my changes)</b> <div class="spoiler_text"><pre><code class="diff hljs">diff --git a/main.cb/main.c index a225432..64755ca 100755 --- a/main.c +++ b/main.c @@ -306,11 +306,16 @@ int main(void) { /* no pullups on USB and ISP pins */ PORTD = 0; PORTB = 0; + PORTC = 0; /* PORTC not connected */ /* all outputs except PD2 = INT0 */ - DDRD = ~(1 &lt;&lt; 2); + //DDRD = ~(1 &lt;&lt; 2); /* output SE0 for USB reset */ - DDRB = ~0; + // DDRB = ~0; + //DDRD = ~0; + DDRD = 0b01100000; // 1 = output (PD6+PD5 LEDS, PD3+PD2 USB) + ledRedOff(); + j = 0; /* USB Reset by device only required on Watchdog Reset */ while (--j) { @@ -322,10 +327,9 @@ int main(void) { /* all USB and ISP pins inputs */ DDRB = 0; - /* all inputs except PC0, PC1 */ - DDRC = 0x03; - PORTC = 0xfe; - + /* PORTC not connected -&gt; all inputs*/ + DDRC = 0; + /* init timer */ clockInit(); diff --git a/usbasp.hb/usbasp.h index b60bd04..9c12652 100644 --- a/usbasp.h +++ b/usbasp.h @@ -62,9 +62,9 @@ #define USBASP_ISP_SCK_1500 12 /* 1.5 MHz */ /* macros for gpio functions */ -#define ledRedOn() PORTC &amp;= ~(1 &lt;&lt; PC1) -#define ledRedOff() PORTC |= (1 &lt;&lt; PC1) -#define ledGreenOn() PORTC &amp;= ~(1 &lt;&lt; PC0) -#define ledGreenOff() PORTC |= (1 &lt;&lt; PC0) +#define ledRedOn() PORTD |= (1 &lt;&lt; PD5); PORTD &amp;= ~(1 &lt;&lt; PD6) +#define ledRedOff() PORTD &amp;= ~(1 &lt;&lt; PD5); PORTD |= (1 &lt;&lt; PD6) +//#define ledGreenOn() PORTD &amp;= ~(1 &lt;&lt; PD5) +//#define ledGreenOff() PORTD |= (1 &lt;&lt; PD5) #endif /* USBASP_H_ */ diff --git a/usbconfig.hb/usbconfig.h index 203239e..9fe7375 100755 --- a/usbconfig.h +++ b/usbconfig.h @@ -22,15 +22,15 @@ the newest features and options. /* ---------------------------- Hardware Config ---------------------------- */ -#define USB_CFG_IOPORTNAME B +#define USB_CFG_IOPORTNAME D /* This is the port where the USB bus is connected. When you configure it to * "B", the registers PORTB, PINB and DDRB will be used. */ -#define USB_CFG_DMINUS_BIT 0 +#define USB_CFG_DMINUS_BIT 3 /* This is the bit number in USB_CFG_IOPORT where the USB D- line is connected. * This may be any bit in the port. */ -#define USB_CFG_DPLUS_BIT 1 +#define USB_CFG_DPLUS_BIT 2 /* This is the bit number in USB_CFG_IOPORT where the USB D+ line is connected. * This may be any bit in the port. Please note that D+ must also be connected * to interrupt pin INT0!</code> </pre> <br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Bonus photos</b> <div class="spoiler_text">  What could be done from the pads for tinkeys (it turned out - very convenient). <br><br><img src="https://habrastorage.org/files/39d/a9c/75e/39da9c75e8dd4fcfa36191984498c58c.JPG"><br><br>  Control LED between outputs PB3-PB4. <br><br><img src="https://habrastorage.org/files/7d7/456/b7e/7d7456b7ebb24f2c93ce9c4f65025a75.JPG"><br><br></div></div><br><br><h4>  Links </h4><br>  Archive with modified firmware (source + compiled firmware main.hex): <a href="https://app.box.com/s/xz4neeubv663rvcem12pbctq91hutpp2">app.box.com/s/xz4neeubv663rvcem12pbctq91hutpp2</a> <br>  Original firmware (USBasp firmware from Thomas Fischl): <a href="http://www.fischl.de/usbasp">www.fischl.de/usbasp</a> <br>  Hacking an AVR programmer: <a href="http://www.sciencetronics.com/greenphotons/%3Fp%3D938">www.sciencetronics.com/greenphotons/?p=938</a> <br>  An article on Habr√© on the same topic: <a href="http://habrahabr.ru/post/198882/">"How to make a Chinese USB programmer for $ 5 work in Linux"</a> </div><p>Source: <a href="https://habr.com/ru/post/252061/">https://habr.com/ru/post/252061/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252049/index.html">Creating a cloud network: not so simple</a></li>
<li><a href="../252053/index.html">GDC 2015: a major news digest. 2nd of March</a></li>
<li><a href="../252055/index.html">How to crack corporate Wi-Fi: new features</a></li>
<li><a href="../252057/index.html">The right platform for Java EE applications: how z / OS + DB2 were 3 times faster than Linux + Oracle</a></li>
<li><a href="../252059/index.html">High Frequency Trading Neighborhood - Part V (Final)</a></li>
<li><a href="../252063/index.html">How many interface designs do you really need to draw for iPhone 4, 5, 6, and 6+?</a></li>
<li><a href="../252065/index.html">Tarantool 1.6 POV</a></li>
<li><a href="../252067/index.html">Writing a search plugin for Elasticsearch</a></li>
<li><a href="../252069/index.html">Testing flash storage. EMC XtremIO</a></li>
<li><a href="../252073/index.html">11 cool sites for iOS developers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>