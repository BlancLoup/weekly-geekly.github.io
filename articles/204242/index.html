<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Openfire + Miranda + Asterisk + Active Directory + pinch php, bash, C # or how to call from Miranda using regular phones</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Making Miranda make calls is easy using SIP telephony plugins that turn Miranda into a softphone, 
 However, what to do when users do not have any hea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Openfire + Miranda + Asterisk + Active Directory + pinch php, bash, C # or how to call from Miranda using regular phones</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/89a/ce7/961/89ace7961a9336331ffe5c7aa0e0cd42.jpg" alt="image" align="right"><br>  Making Miranda make calls is easy using SIP telephony plugins that turn Miranda into a softphone, <br>  However, what to do when users do not have any headsets or microphones? <br>  But to educate users to work with the soft-background, built-in with Miranda - a bad dream. <br><br>  Option one is to use existing telephones (IP, analog, digit) to make calls from Miranda. <br><br>  Initial data: <br>  1. Digital mini PBX Panasonic TDE200, to which all phones are connected <br>  2. A bunch of subscribers with different types of phones: IP, analog, digital, system phones <br>  3. A working XMPP server based on OpenFire <br>  4. Miranda client for communication via XMPP (Jabber) protocol - installed for all users. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Wishlist: <br>  1. The ability to make a call using the client Miranda. <br>  2. The call and conversation should be made by usual working phones (IP, analog, digit). <br>  3. Phone number information must be taken from Active Directory. <br>  4. Transparency / ease of use for users. <br>  5. When making a call, add an alert on Jabber about the caller. <br><br>  Anyone interested in the introduction - welcome under cat.  Below it will be interesting. <br><a name="habracut"></a><br><br><h4>  Prehistory </h4><br>  A few years ago, in search of a solution for corporate IM-service on the Internet, I came across an <a href="http://it.rpkkirov.ru/jabber-server-korporativnoj-seti-miranda-kak-instrument-administrirovaniya/">article by</a> IT specialists from the city of Kirov, about corporate IM-Service on OpenFire with transparent user authentication, where Miranda acted as a client, and not possible to initialize Connecting via RDP and VNC to the computer whose user you selected in the contact list, you do not need to enter the DNS name of the user's computer, it is automatically inserted into the address field, and establishes a connection. <br><br>  I used their Miranda build for quite a while, but over time, glitches began to appear in the work, connection instability, and client departures. <br>  As a result, it was decided to assemble my Miranda <s>with blackjack and</s> ... with a new core and necessary functions. <br><br><h4>  New client </h4><br><br>  Assembling your own Miranda assembly is not a tricky business: I installed the latest version of the kernel, I saved up the necessary plug-ins, and voila - its own assembly. <br>  But the article is not about that. <br><br>  The new client Miranda completely duplicated the functionality of connecting to RDP and VNC, however it became much more stable due to the updated kernel (I will call it ‚Äúadmin client‚Äù).  By the way - for users their own Miranda was assembled, but already without the connection ‚Äúbuns‚Äù (user client). <br>  For several months, the client worked successfully with our technical support team - there were no complaints. <br>  During this time, I successfully implemented monitoring for Active Diretory (article <a href="http://habrahabr.ru/post/147750/">here</a> and <a href="http://habrahabr.ru/post/150122/">here</a> ), behind the file server ( <a href="http://habrahabr.ru/post/150149/">here</a> ) and VPN servers. <br>  In the process of creating a monitoring, I heard several times from the technical support guys that it would not have been bad to add the ability to connect to the user using the Remote Assistance, since  we have it is the de facto standard for user support <br><br>  Actually, it did not cause any difficulties. <br>  It would seem - what else is needed?  Everything you need to support is present. <br><br><h5>  Small retreat </h5><br>  At that moment, I became interested in C # programming - rewrote all monitoring with Powershell in C #, screwed monitoring to the database (I used to write to text files) and made a simple web page with php that pulled monitoring data from the database - it became very good . <br>  On the page it was possible to make a sample: <br>  1. for AD changes: by username or computer name <br>  2. for file server: by username or file name <br>  3. for VPN servers: by username <br><br><h5>  Updated new customer </h5><br><img src="https://habrastorage.org/getpro/habr/post_images/476/d72/a2a/476d72a2ae42d5aba511d47ae32f9959.jpg" alt="image" align="right"><br>  For even greater convenience of technical support for users, it was decided to add a sample of the required user to the Miranda client. <br>  How it works: <br>  To connect to the example via RDP, Miranda using a specific plug-in can return not only the value of the user's computer name, but also the user‚Äôs login. <br>  The client added the functions of opening web pages with monitoring tables, to the URL of which the login of the required user was transferred by GET. <br>  As a result, the client has acquired a completely different color - now he not only allows real-time support, but also performs analysis on past events concerning a given user (for example, this way you can find out which files this user opened or deleted on a network resource what servers did he try to connect to, what actions were performed with his account in AD). <br><br>  Next, I wrote a simple WindowsForm application in C #, which, using a WMI provider, can receive a list of processes of a remote computer, with the possibility of their completion. <br><br>  Without hesitation, this application was "embedded" in the functionality of the admin client. <br>  Now, user support has received a new coloring: there is no need to keep tables with data about computers, IP addresses, users who work on these computers, and even more now there is no need to request information about the computer‚Äôs name or IP address from the user (assuming of course he still has the network, otherwise Miranda will not be able to ‚Äútake‚Äù the name of the computer of the user who is offline, but the user's login will be able to). <br><br><h4>  It was a prehistory, now the main theme is the ability to make calls </h4><br>  As the saying goes: Laziness is the engine of progress. <br>  This client minimized manual data entry to connect to the user or search for information about him in the monitoring database ‚Äî everything is done with 2 clicks. <br>  In the process of using Miranda with advanced functionality for 2 years, I occasionally visited the idea that it would be nice to make the ability to make calls using the Miranda client - without having to dial numbers manually. <br>  One problem is that we do not have IP telephony, or rather, it is there, but it is used by 5% of subscribers :) <br>  Those.  I want to make it so that when you select a user in the Miranda contact list, you can choose an action - ‚Äúcall‚Äù, and talk on your usual work phone. <br>  Then one day he set himself the task - to realize it.  No sooner said than done! <br><br>  Given: <br>  1. Panasonic PBX TDE200 <br>  2. 300 subscribers (15 - SIP, 285 - analog or digital phones) <br>  3. Miranda (where do without it) <br>  4. A drilling idea that keeps you awake at night :) <br><br><h5>  Let's go from the reverse, i.e.  from telephones to Miranda. </h5><br><h6>  We connect Panasonic to LAN </h6><br>  The first thing I wondered how Miranda will reach the PBX. <br>  The solution turned out to be straightforward - Asterisk. <br>  I will not touch upon the procedure of installing and configuring Asterisk, there are already many articles on this topic on the network. <br>  We combine Asterisk and Panasonic TDE200 with a SIP trunk, according to this <a href="http://pbx.gal.cv.ua/asterisk-tde">article</a> . <br><br>  Made by  Now using a computer, you can make calls to users' phones.  However, we need to make calls from ordinary phones, without dialing.  We dig further. <br><br><h6>  Callback </h6><br>  Asterisk is a powerful software IP PBX, everything you can think of with telephony - Asterisk can do. <br>  Including it has a great feature like CallBack, i.e.  callback - from this and we will dance. <br>  Asterisk can also form a call automatically using specially crafted call files (call-files).  They contain information about the phone numbers to which you need to make a call.  These files when placed in a special folder on Asterisk and initiate a call to both subscribers and connects them. <br>  Sample file text: <br><pre><code class="bash hljs">Channel: SIP/utde/9311264 CallerID: <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> &lt;9311264&gt; Context: from-internal Extension: 994120031</code> </pre> <br>  This means that the asterisk should call the numbers: 9311264 (our number) and 994120031 (where we call).  The call to both numbers leaves from the number 9311264 (ie, from ours, specified in the CallerID property). <br><br><h6>  Automating the creation of call files </h6><br>  To automate, we will use the usual bash-script, which, using the <b>echo</b> command, will write the necessary data to the new call-file for making a call: i.e.  phone numbers of the caller and the caller.  We will transmit both phone numbers with parameters when running a bash script, for example: <b>call.sh 945954 945932</b> <br><br>  Sample script for generating a Call file: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # outcall="/var/spool/asterisk/$1-$2.call" echo Channel: SIP/utde/$1 &gt; $outcall echo CallerID: 'call &lt;'$1'&gt;' &gt;&gt; $outcall echo Context: from-internal &gt;&gt; $outcall echo Extension: $2: &gt;&gt; $outcall chown asterisk:asterisk $outcall mv $outcall /var/spool/asterisk/outgoing</span></span></code> </pre><br><br><h6>  How to run a bash script "from the outside" </h6><br>  All this is wonderful, we can, by running the script and passing it 2 parameters, make the call to the phones of two employees and combine them into a conversation. <br>  But how do we get to do this without being in the console on the server where Asterisk is located? <br>  The answer is quite simple - web. <br>  Let's deploy apache, create a php page that will run the bash script and send it 2 phone numbers as parameters. <br>  It is possible to start bash_script from php with the following function: <br><pre> <code class="php hljs">shell_exec(<span class="hljs-string"><span class="hljs-string">"sudo /var/scripts/out.sh $from $to"</span></span>);</code> </pre><br>  Where the script name is: out.sh <br>  Your phone number in the parameter: $ from <br>  Number to call: $ to <br><br><h6>  We transfer data to php </h6><br>  Like the bash script, the php page should get 2 phone numbers.  The easiest solution to this problem is the GET method. <br>  Those.  A specially crafted URL, carrying 2 phone numbers, sends them to php, where they are already transmitted to bash. <br><br>  Using the GET method to transfer to a variable is not difficult, it is enough to specify in php-code: <br><pre> <code class="php hljs">$from=$_GET[<span class="hljs-string"><span class="hljs-string">'from'</span></span>]; $to=$_GET[<span class="hljs-string"><span class="hljs-string">'to'</span></span>];</code> </pre><br>  Those.  the $ from and $ to variables are assigned the values ‚Äã‚Äãthat were passed to the url in the from and to parameters, <br>  For example the link: <a href="http://pbx.domain.ru/index.php%3Ffrom%3D943216%26to%3D987632">pbx.domain.ru/index.php?from=943216&amp;to=987632</a> <br>  sends the $ from number to the $ from variable telephone number 943216, and to the $ to variable - 987632 <br><br><h6>  We form a GET request from Miranda </h6><br>  To solve this problem, I did not find a ready-made solution, so it was decided to write the application itself, which would itself form the necessary URL and make a request for it, passing phone numbers.  And of course, implemented it in C #.  Let's call this application conditionally: <b>Application C #</b> . <br>  What the application does: <br>  1. Accepts from Miranda the input parameter is the login of the employee to whom we want to make a call. <br>  2. Picks up the current username on our computer (i.e., our username) <br>  3. Makes a request to Active Directory, in which it searches for these users by their usernames and returns their phone numbers (Phones must be specified in the telephoneNumber account attribute). <br>  4. Generates a URL into which it inserts 4 values: the number of ‚Äúwho is calling‚Äù, the number of ‚Äúwho is calling‚Äù, the login ‚Äúwho is calling‚Äù, the login ‚Äúwho is calling‚Äù (For example: <a href="http://pbx.domain.ru/index.php%3Ffrom%3D924374%26to%3D859345%26fromLogin%3Divanov%26toLogon%3Dpetrov">pbx.domain.ru/index.php?from=924374&amp;to = 859345 &amp; fromLogin = ivanov &amp; toLogon = petrov</a> (I give the logins to create an alert, about this below). <br>  5. Makes a request to this URL. <br><br>  At this "caller" is ready. <br><br>  This is what the context menu of admin Miranda looks like now: <br><img src="https://habrastorage.org/getpro/habr/post_images/8dd/597/d7a/8dd597d7a4d290abeff4a3ce6dcc15d6.jpg" alt="image"><br><br>  And so the users: <br><img src="https://habrastorage.org/getpro/habr/post_images/767/99e/fd4/76799efd4c775d7adcedaa338cd82411.jpg" alt="image"><br><br>  When the ‚ÄúCall‚Äù function is selected, the C # Application starts: <br><img src="https://habrastorage.org/getpro/habr/post_images/e52/bf1/9b8/e52bf19b8ec467894645b60a8bf3f072.jpg" alt="image"><br><br>  The user selects which number wants to make a call, and presses the appropriate call button. <br>  If the mobile number is not listed in Active Directory, then it will not be displayed (as well as the call button). <br>  If this user does not have numbers, the application will report this. <br><br><h6>  Create an incoming call alert </h6><br>  Since  for most users, the phones do not have a contact list, then it is difficult to determine who is calling, even if you see which number is calling you, the alert function has been added to Jabber about who is calling: full name, position, department, phone number. <br>  Above, I wrote that the application transmits in addition to 2 phones also two logins. <br>  Those.  php can accept 4 parameters, not only phone numbers but also logins. <br>  We add php.  Add the query function in Active Directory. <br>  What php does in the end: <br>  1. having received logins, makes a request to AD to receive a full name, position, department of a person who makes a call <br><pre> <code class="php hljs">$srv = <span class="hljs-string"><span class="hljs-string">"10.10.10.1"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//ip   $srv_domain = "domain.ru"; //  $srv_login = "username@".$srv_domain; //        LDAP $srv_password = "PASSW0RD"; //     $dn = "dc=domain,dc=ru"; //DN-  $filter = "(&amp;(sAMAccountName=$fromLogin)(objectCategory=user)(memberOf=CN=Openfire,CN=Users,DC=domain,DC=ru)(!(userAccountControl:1.2.840.113556.1.4.803:=2)))"; $attr = array("cn","telephoneNumber","title","department","company"); $dc = ldap_connect($srv); ldap_set_option($dc, LDAP_OPT_PROTOCOL_VERSION, 3); ldap_set_option($dc, LDAP_OPT_REFERRALS, 0); if ($dc) { ldap_bind($dc,$srv_login,$srv_password); $result = ldap_search($dc,$dn,$filter,$attr); $result_entries = ldap_get_entries($dc,$result); ldap_unbind($dc); } $DisplayName = $result_entries[0]['cn'][0]; //   $Title = $result_entries[0]['title'][0]; // $Department = $result_entries[0]['department'][0]; // $DisplayName = iconv('utf-8', 'cp1251', $DisplayName); $Title = iconv('utf-8', 'cp1251', $Title); $Department = iconv('utf-8', 'cp1251', $Department);</span></span></code> </pre><br>  2. generates a message containing information about the caller. <br>  3. Runs a bash script to which it sends the message body and the login to "who's being called." <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # echo "$2" | sendxmpp $1@domain.ru</span></span></code> </pre><br>  The bash script launches the sendxmpp (Perl script to send messages via the XMPP / Jabber protocol, is freely available in the repositories) and sends it the message body and the login name.  Sendxmpp sends a message to the user from a specially created contact (let's call it <b>Operator</b> ). <br><br>  Also in the body of the message is transmitted a link, upon opening of which, a callback is created, to the person who called you - made for convenience.  For example, you missed the call, saw the message, although the message contains information about the caller‚Äôs number, but ‚ÄúLaziness is the engine of progress‚Äù and we don‚Äôt want to manually dial the number on the phone, or search for this employee in the Miranda contact list to make the call - We just click on the link, and all this cotovasia with skipty starts to work: <br>  there are requests to AD from php <br>  a message is formed to the person that you are calling to him, also with reference to the chime <br>  call-file is formed <br>  phones are ringing <br><br>  So the message looks like: <br><img src="https://habrastorage.org/getpro/habr/post_images/168/bb4/c16/168bb4c16b6c6cd8da48c4e80d813e3a.jpg" alt="image"><br><br><h4>  Conclusion </h4><br>  As a result, we received a full-fledged client, from which you can connect to users, view monitoring information, make calls with one click. <br>  The advantage of this solution is that all data is taken from Active Directory, which makes it easy to store data about phone numbers - you only need to store it in one place. <br>  The C # application requests data in Active Directory not only about the work phone number, but also about the mobile.  And we can choose which number we want to call: work or mobile. <br>  Calls are also made to long-distance numbers, this is especially true for us, because  we have several branches in different cities - which undoubtedly simplifies life, because  no need to dial long phone numbers with city codes. <br><br>  General scheme of work: <br><img src="https://habrastorage.org/getpro/habr/post_images/4f3/e55/6c8/4f3e556c8d010f0d7559bd26a4f70963.jpg" alt="image"><br>  It looks of course cumbersome, but in practice, after pressing the "call" button, your phone starts ringing after 1-2 seconds. <br><br><h5>  Security </h5><br>  All this works fine, but there are nuances in security: <br>  1. I encode phone numbers and logins in a C # application so that they are not transmitted in clear text (since the link is present in the alert text).  Php already decodes them and receives normal data (numbers and logins). <br>  2. Be sure to read online about Asterisk protection.  At a minimum, configure iptables and allow only your subnet to go to Asterisk. <br><br>  <b>Question:</b> Tell me, how can I realize a timeout, for example, so that the user cannot make a call through Miranda, within 30 seconds after the start of the previous call?  It only comes to mind to record IP addresses and the time when the call request came from.  MB are there any other options? <br><br>  <b>PS:</b> Since  Entering phone numbers in Active Directory is quite a tedious task, I wrote a small WindowsForm application in C # that runs once on users' computers and asks them to indicate their phone numbers (work and mobile).  This data is written to the corresponding attribute of the user account in Active Directory.  This application can not close the feed as you enter your data.  You can close through the task manager, but users usually do not reach it. <br>  This application was also added to the Miranda client so that users can always enter their phone numbers if they have changed.  (Here, of course, you can close the application without having to write down your number). <br><br>  PSS: Thank you for helping with <a href="http://habrahabr.ru/users/lanched/" class="user_link">Asched Lanched</a> </div><p>Source: <a href="https://habr.com/ru/post/204242/">https://habr.com/ru/post/204242/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../204230/index.html">Winners of WEB READY 2013</a></li>
<li><a href="../204234/index.html">Is it worth optimizing image processing in C ++ using SIMD?</a></li>
<li><a href="../204236/index.html">OpenVX: computer vision standard</a></li>
<li><a href="../204238/index.html">60 FPS? Easy! pointer-events: none!</a></li>
<li><a href="../204240/index.html">Introduction to Veritas Volume Manager</a></li>
<li><a href="../204244/index.html">How software companies die, or How to grow programmers correctly</a></li>
<li><a href="../204248/index.html">Highlighting code on android. My experience</a></li>
<li><a href="../204250/index.html">Service robot Tod. First steps with ROS</a></li>
<li><a href="../204252/index.html">10 months of free clouds on DigitalOcean</a></li>
<li><a href="../204254/index.html">Gnuplot vs. 2MASS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>