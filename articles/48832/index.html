<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>IronPython as an engine for macros in .NET applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I suspect that many of you wondered how you can add macro support to a .NET application so that you can extend the program's capabilities without reco...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>IronPython as an engine for macros in .NET applications</h1><div class="post__text post__text-html js-mediator-article">  I suspect that many of you wondered how you can add macro support to a .NET application so that you can extend the program's capabilities without recompiling it and give third-party developers the ability to easily and easily access the API of your application?  The article describes how to use IronPython, the implementation of the Python language on the .NET platform, as the basis for macros execution. <br><a name="habracut"></a><br>  To begin with, it should be determined - what we will mean by the word ‚Äúmacro‚Äù is a script that, without recompiling the project, would allow access to a specific API.  Those.  pull values ‚Äã‚Äãfrom the form, modify them - and all this in run-time mode, without modifying the application. <br><br>  The first option that comes to mind is to create your own interpreter for a simple script-language.  The second is the dynamic compilation of some .NET language (the same C #) - with dynamic loading of assemblies and execution via Reflection.  And the third is the use of interpreted .NET languages ‚Äã‚Äã(DLR) - IronPython or IronRuby. <br><br>  To create your own language + interpreter to it with the possibility of .NET interoperability is not a trivial task, we will leave it for enthusiasts. <br>  Dynamic compilation is too cumbersome and drags the use of Reflection.  However, this method is not without advantages - the written macro is compiled once and later can be used many times - as a full-fledged .NET assembly.  So - the finalist - method number three - using existing DLR languages.  As such a language, choose IronPython (accept this as a fact :).  The current IPy version is 2.0, you can take it at <a href="http://codeplex.com/IronPython">codeplex.com/IronPython</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We proceed directly to the coding. <br>  To begin with, consider the interface of the test application "Notepad". <br><br> <a href="http://imageshack.us/"><img src="https://habrastorage.org/getpro/habr/post_images/233/dae/036/233dae036c61684fdd84b1da65f243f2.png" alt="Image Hosted by ImageShack.us"></a> <br> <a href="http://g.imageshack.us/img228/notepad1ed1.png/1/"><img src="http://img228.imageshack.us/img228/notepad1ed1.png/1/w482.png"></a> <br><br>  In the "Service" menu and place the item "Macros".  For example, consider the simplest version of the formation of a list of macros - in the directory with the program, create a folder ‚ÄúMacroses‚Äù files from this folder will become menu items. <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">private</font> <font color="#0000ff">void</font> Main_Load( <font color="#0000ff">object</font> sender, <font color="#2B91AF">EventArgs</font> e) <br> { <br> MacrosToolStripMenuItem itm = <font color="#0000ff">null</font> ; <br> <font color="#0000ff">string</font> [] files = <font color="#2B91AF">Directory</font> .GetFiles( <font color="#A31515">@".\Macroses"</font> ); <br> <font color="#0000ff">foreach</font> ( <font color="#0000ff">string</font> file <font color="#0000ff">in</font> files) <br> { <br> itm = <font color="#0000ff">new</font> MacrosToolStripMenuItem(Path.GetFileNameWithoutExtension(file)) { MacrosFileName = file }; <br> itm.Click += <font color="#0000ff">new</font> EventHandler(macroToolStripMenuItem_Click); <br> ToolStripMenuItem.DropDownItems.Add(itm); <br> } <br> } <br> <br> <font color="#0000ff">internal</font> <font color="#0000ff">class</font> MacrosToolStripMenuItem : ToolStripMenuItem <br> { <br> <font color="#0000ff">public</font> MacrosToolStripMenuItem( <font color="#0000ff">string</font> FileName) : <font color="#0000ff">base</font> (FileName) { } <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> MacrosFileName { <font color="#0000ff">get</font> ; <font color="#0000ff">set</font> ; } <br> } <br> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  MacrosToolStripMenuItem - a successor class from ToolStripMenuItem that differs only in the MacrosFileName property <br><br>  To begin with, we will create a macro that will view the text in the textBox and find all e-mail addresses of the form ‚Äúvpupkin@mail.ru‚Äù.  In the Macroses folder, create the SaveEmail.py file, launch the application - and see that the SaveEmail item appears in the Macros menu. <br><br>  Now the key point itself is the execution of the IPy script and its access to the interface.  Add to the project a link to the assembly IronPython.dll.  And create a class MacroRunner - executing script. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> MacroRunner <br> { <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> Form CurrentForm; <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> FileName { <font color="#0000ff">get</font> ; <font color="#0000ff">set</font> ; } <br> <br> <font color="#0000ff">public</font> MacroRunner() { } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> Execute() <br> { <br> <font color="#008000">//    Python-</font> <br> IronPython.Hosting.PythonEngine pyEngine = <font color="#0000ff">new</font> IronPython.Hosting.PythonEngine(); <br> <font color="#008000">//   -       , ..</font> <br> <font color="#008000">//      ,     </font> <br> pyEngine.LoadAssembly(System.Reflection. <font color="#2B91AF">Assembly</font> .GetExecutingAssembly()); <br> <br> <font color="#0000ff">try</font> <br> { <br> pyEngine.ExecuteFile(FileName); <br> } <br> <font color="#0000ff">catch</font> (Exception exc) <br> { <br> MessageBox.Show(exc.Message); <br> } <br> } <br> } <br> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  The key point is to connect to the current build IPY runtime to access the form.  When the assembly is connected, in the IPy script it will be possible to use the Notepad namespace classes.  You can also add other necessary assemblies via LoadAssebmly - such as System.Windows.Forms - to work with forms. <br>  The class is ready, now we modify the click handler on the Macros submenu items <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">protected</font> <font color="#0000ff">void</font> macroToolStripMenuItem_Click( <font color="#0000ff">object</font> sender, <font color="#2B91AF">EventArgs</font> e) <br> { <br> MacrosToolStripMenuItem item = sender <font color="#0000ff">as</font> MacrosToolStripMenuItem; <br> <br> MacroRunner runner = <font color="#0000ff">new</font> MacroRunner() { FileName = item.MacrosFileName }; <br> MacroRunner.CurrentForm = <font color="#0000ff">this</font> ; <br> runner.Execute(); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Here it is necessary to note the following point - to transfer the form from which the macro is actually called to the IPy script, the static CurrentForm field is used.  In the script, the form will be available as Notepad.MacroRunner.CurrentForm.  Ideally, the script, of course, should not have full access to the interface of the form ‚Äî but should only use the provided API ‚Äî and be limited to them.  But now we will not bother with this - and just make the textBox open (Modifier = Public).  Well, except for the text field, let the script access the Tools menu item (Modifier = Public). <br><br>  The work with the form is completed, we collect the project and open the SaveEmail.py file - now we work only with macros. <br><br>  So, the first macro is SaveEmail.py: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">from</font> Notepad import * <br> import re <br> <br> text = MacroRunner.CurrentForm.textBox.Text <br> links = re.findall( <font color="#A31515">"\w*@\w*\.\w{2,4}"</font> , text) <br> file = open( <font color="#A31515">"emails.txt"</font> , <font color="#A31515">"w"</font> ) <br> file.write( <font color="#A31515">"\n"</font> .join(links)) <br> file.close()</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Because  the assembly is connected to the runtime - then the namespace is available Notepad - in which the application classes are declared.  Right now, you need a static method of the MacroRunner class - to get access to the active form (once again I‚Äôll make a reservation - that it would be more correct to provide not direct access, but through an intermediary class - that will restrict access to a specific API).  Well, then everything is simple - we get the text, with regular expression we pull out the email - and save them to a file in the current directory. <br><br>  You can start the application, enter arbitrary text containing the email - and make sure that after the macro has completed - the file emails.txt has appeared in the folder with the executable program. <br><br>  Now another example of what a macro can do is a bit more interesting than the previous one.  So, create the UIModifier.py file in the Macroses folder.  As the name suggests, the macro will change the interface elements of the application.  Specifically, it will add a new item to the Tools menu.  In order to work with WinForms controls, you need to connect the System.Windows.Forms assembly to the IPy runtime.  This can be done at the time of launching the script from the application - add another call to LoadAssembly.  But we decided - no recompilations, let IronPython manage on its own.  Well, there is strength :).  To connect the assembly, use the AddReference method of the clr class. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">from</font> Notepad import * <br> main = MacroRunner.CurrentForm <br> <br> import clr <br> clr.AddReference( <font color="#A31515">"System.Windows.Forms"</font> ) <br> <font color="#0000ff">from</font> System.Windows.Forms import * <br> <br> def pyHello(s,e): <br> MessageBox.Show( <font color="#A31515">"Hello from IPy!"</font> ) <br> <br> item = ToolStripMenuItem() <br> item.Name = <font color="#A31515">"pybtn"</font> <br> item.Text = <font color="#A31515">"Python created!"</font> <br> item.Click += pyHello <br> <br> main.ToolStripMenuItem.DropDownItems.Add(item) <br> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Everything is simple - we get the current form, connect the System.Windows.Forms assembly and import everything from the System.Windows.Forms namespace - it will be useful. <br>  pyHello - a simple event handler - when you click on the created menu item - a message will be displayed. <br><br>  Run the application, run the macro.  Look at the Service menu item: <br><br> <a href="http://imageshack.us/"><img src="http://img517.imageshack.us/img517/8186/notepad2ht8.png" alt="Image Hosted by ImageShack.us"></a> <br> <a href="http://g.imageshack.us/img517/notepad2ht8.png/1/"><img src="http://img517.imageshack.us/img517/notepad2ht8.png/1/w488.png"></a> <br><br>  When you click on the ‚ÄúPython with Regated!‚Äù Menu item, a standard MessageBox will appear - in fact, it was achieved. <br><br>  Thank you all for your attention :) <br><br></div><p>Source: <a href="https://habr.com/ru/post/48832/">https://habr.com/ru/post/48832/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../48823/index.html">enter through F</a></li>
<li><a href="../48824/index.html">Small pleasures</a></li>
<li><a href="../48825/index.html">Search functions in the programs - concept</a></li>
<li><a href="../48826/index.html">Excellent technical support excuses</a></li>
<li><a href="../48828/index.html">Internet Explorer 8 and Windows 7 together</a></li>
<li><a href="../48834/index.html">IE vs all</a></li>
<li><a href="../48835/index.html">jQuery & Greasemonkey</a></li>
<li><a href="../48837/index.html">Cover</a></li>
<li><a href="../48839/index.html">ZTE531B flashing on NetComm NB6Plus4W with DHCP setting for working with Stream TV</a></li>
<li><a href="../48842/index.html">We invent technology: the experience of connecting several open-source projects</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>