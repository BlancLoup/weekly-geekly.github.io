<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Icinga2 and agentless monitoring of Windows servers using WMI</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today, not everyone is satisfied with the IT infrastructure monitoring system used, and for some it is simply not available. Many of them have obvious...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Icinga2 and agentless monitoring of Windows servers using WMI</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/327/e81/a3b/327e81a3bcdc4fdaba821f4ff30fb73e.png" alt="image"><br><br>  Today, not everyone is satisfied with the IT infrastructure monitoring system used, and for some it is simply not available.  Many of them have obvious problems with usability, configuration complexity and low productivity.  That is why, I suggest to look at the new fork of Nagios - Icinga 2, which is ready to please us with a modular architecture, user-friendly web-interface, report generation and excellent speed! <br><a name="habracut"></a><br><h2>  About the system itself </h2><br>  At first glance, Icinga 2 immediately has a pleasant-looking web interface, with a large number of different representations of hosts and services (various lists, calendar, grid), but these are not all the advantages of this monitoring system. <br><br>  The configuration style is different from its previous version, it has an object-oriented format (similar to Puppet) and allows you to define dependencies and host / service parent / child relationships for hosts.  The dependencies in Icinga 2 are direct, they can be defined as host-host, service-service, or mixed host-service and service-host.  Volume configurations can be minimized by applying templates to objects.  During the operation of the system, you will understand how convenient it is.  Personally, I have always been dissatisfied with the lack of the possibility of setting up monitoring via the web interface, in view of the complexity of the configuration files, but in this case, I am happy about it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Icinga2 is built with a focus on performance, has a multi-threaded design and can perform thousands of checks per second.  The system itself can be installed as a high-availability cluster or as a single instance. <br><br><img src="https://habrastorage.org/files/521/788/92c/52178892c3154088ab488df04c6b41c7.png" alt="image"><br><br>  Also, highly available clusters can be combined into a distributed installation, in which operations are spread over several sites.  Replication can be isolated for its implementation only between the primary and secondary zones.  Secondary zones can be either full-fledged copies of Icinga 2, with a local IDO database and user interface, or simple instances that perform checks. <br><br><img src="https://habrastorage.org/files/343/3b0/7fc/3433b07fcd7443c7b1787f5b93dd1485.png"><br><br>  Icinga 2 comes with several engines and almost any addon can be easily integrated, in particular the Perfdata module is included initially.  For example, Icinga 2 offers the integration of popular productivity graphing tools such as PNP4Nagios, inGraph, and Graphite. <br><br><h2>  Customization </h2><br>  There is no point in considering the installation of Icinga 2 itself, since it is simple and very clearly described in the <a href="http://docs.icinga.org/icinga2/latest/doc/module/icinga2/toc">documentation</a> , in my case it is installed on CentOS 7 and PostgreSQL.  First, do not forget to install EPEL: <pre><code class="bash hljs">yum install epel-release</code> </pre> <br>  Also, when it is configured via the web interface, it is necessary to use two bases, and not one (otherwise, an error in creating a user will occur). <br><br>  For full monitoring using WMI, we need several plugins and a prepared Windows Server. <br><br>  First, install <b>wmic</b> and <b>Scheck WMI Plus</b> using the step-by-step guide located <a href="http://www.edcint.co.nz/checkwmiplus/InstallationTerminalSession">here</a> . <br><br>  Next, you need to prepare Windows Server for processing incoming WMI requests, to do this, enter in the command line: <br><br><pre> <code class="bash hljs">winrm quickconfig</code> </pre> <br>  The user on whose behalf we will connect to the server must be in the group of local administrators, and also do not forget about the firewall. <br>  For verification, we run two times: <br><br><pre> <code class="bash hljs">/opt/nagios/bin/plugins/check_wmi_plus.pl -m checkcpu -H HOST -u USER -p PASS</code> </pre><br>  We now turn to the configuration itself Icinga 2. <br>  The main configuration files are located in <i>/etc/icinga2/conf.d/</i> <br>  Prepare a group for our Windows servers by adding the following to the groups.conf file: <br><br><pre> <code class="bash hljs">object HostGroup <span class="hljs-string"><span class="hljs-string">"windows-servers"</span></span> { display_name = <span class="hljs-string"><span class="hljs-string">"Windows Servers"</span></span> assign <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> host.vars.os == <span class="hljs-string"><span class="hljs-string">"Windows"</span></span> }</code> </pre><br>  All hosts in configurations of which the element is present will fall into this group: <pre> <code class="bash hljs">host.vars.os = <span class="hljs-string"><span class="hljs-string">"Windows"</span></span></code> </pre><br>  We describe the use of the Check WMI Plus plugin. To do this, open <i>commands.conf</i> and add the following content: <br><br><pre> <code class="bash hljs">object CheckCommand <span class="hljs-string"><span class="hljs-string">"check_wmi"</span></span> { import <span class="hljs-string"><span class="hljs-string">"plugin-check-command"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> = [ WmiPluginDir + <span class="hljs-string"><span class="hljs-string">"/check_wmi_plus.pl"</span></span> ] arguments = { <span class="hljs-string"><span class="hljs-string">"--inidir"</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$wmi_inidir</span></span></span><span class="hljs-string">$"</span></span> <span class="hljs-string"><span class="hljs-string">"-H"</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$host</span></span></span><span class="hljs-string">.name$"</span></span> <span class="hljs-string"><span class="hljs-string">"-A"</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$wmi_authfile_path</span></span></span><span class="hljs-string">$"</span></span> <span class="hljs-string"><span class="hljs-string">"-m"</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$check_mode</span></span></span><span class="hljs-string">$"</span></span> <span class="hljs-string"><span class="hljs-string">"-s"</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$wmi_submode</span></span></span><span class="hljs-string">$"</span></span> <span class="hljs-string"><span class="hljs-string">"-a"</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$wmi_arg1</span></span></span><span class="hljs-string">$"</span></span> <span class="hljs-string"><span class="hljs-string">"-o"</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$wmi_arg2</span></span></span><span class="hljs-string">$"</span></span> <span class="hljs-string"><span class="hljs-string">"-3"</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$wmi_arg3</span></span></span><span class="hljs-string">$"</span></span> <span class="hljs-string"><span class="hljs-string">"-4"</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$wmi_arg4</span></span></span><span class="hljs-string">$"</span></span> <span class="hljs-string"><span class="hljs-string">"-y"</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$wmi_delay</span></span></span><span class="hljs-string">$"</span></span> <span class="hljs-string"><span class="hljs-string">"-w"</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$wmi_warn</span></span></span><span class="hljs-string">$"</span></span> <span class="hljs-string"><span class="hljs-string">"-c"</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$wmi_crit</span></span></span><span class="hljs-string">$"</span></span> <span class="hljs-string"><span class="hljs-string">"--nodatamode"</span></span> = { set_if = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$wmi_nodatamode</span></span></span><span class="hljs-string">$"</span></span> } } vars.wmi_authfile_path = <span class="hljs-string"><span class="hljs-string">"/etc/icinga2/wmi.auth"</span></span> vars.wmi_inidir = <span class="hljs-string"><span class="hljs-string">"/opt/nagios/bin/plugins/check_wmi_plus.d"</span></span> vars.wmi_nodatamode = <span class="hljs-literal"><span class="hljs-literal">false</span></span> }</code> </pre><br>  Create an authorization file for the plugin ( <i>/etc/icinga2/wmi.auth</i> ) with the following contents: <br><br><pre> <code class="bash hljs">username=user@domain.domain password=pass domain=</code> </pre><br>  Set the value to a constant in the <i>constants.conf</i> file: <br><br><pre> <code class="bash hljs">const WmiPluginDir = <span class="hljs-string"><span class="hljs-string">"/opt/nagios/bin/plugins"</span></span></code> </pre> <br>  Create a template for our services in <i>templates.conf</i> : <br><br><pre> <code class="bash hljs">template Service <span class="hljs-string"><span class="hljs-string">"wmi-service"</span></span> { import <span class="hljs-string"><span class="hljs-string">"generic-service"</span></span> check_command = <span class="hljs-string"><span class="hljs-string">"check_wmi"</span></span> check_interval = 1m retry_interval = 1m }</code> </pre> <br>  Here you can set the desired inspection interval. <br><br>  On the plugin page there are <a href="http://www.edcint.co.nz/checkwmiplus/%3Fq%3Dnagiosservicedefinitions">examples of</a> configuration services for Nagios, we just need to edit them a little. <br>  For example, add the following service to the <i>services.conf</i> file: <br><br><pre> <code class="bash hljs">apply Service <span class="hljs-string"><span class="hljs-string">"MSSQL: General Statistics"</span></span> { import <span class="hljs-string"><span class="hljs-string">"wmi-service"</span></span> vars.check_mode = <span class="hljs-string"><span class="hljs-string">"checksql"</span></span> vars.wmi_submode = <span class="hljs-string"><span class="hljs-string">"general"</span></span> vars.wmi_arg1 = host.vars.sql assign <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> host.vars.sql ignore <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> host.vars.disable_wmi }</code> </pre><br>  Add a host to the <i>hosts.conf</i> file: <br><br><pre> <code class="bash hljs">object Host <span class="hljs-string"><span class="hljs-string">"sql"</span></span> { address = <span class="hljs-string"><span class="hljs-string">"XXXX"</span></span> check_command = <span class="hljs-string"><span class="hljs-string">"hostalive"</span></span> vars.os = <span class="hljs-string"><span class="hljs-string">"Windows"</span></span> vars.sql = <span class="hljs-string"><span class="hljs-string">"MSSQL***_MSSQL***"</span></span> } <span class="hljs-comment"><span class="hljs-comment"># *** -   SQL </span></span></code> </pre> <br>  In this example, the ‚ÄúMSSQL: General Statistics‚Äù service will be applied to a host that has the variable <i>vars.sql</i> specified in the configuration and its value will be used in the WMI query as an argument. <br>  It remains only to make a graphical representation of the collected data, for this we need <b>Graphite</b> and its web module for our Icinga 2. <br>  Install Graphite: <br><br><pre> <code class="bash hljs">yum install graphite-web graphite-web-selinux /usr/bin/graphite-manage syncdb --noinput /usr/bin/graphite-build-index /usr/bin/chown -R apache:apache /var/lib/graphite-web yum install python-carbon python-whisper systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> carbon-cache systemctl start carbon-cache systemctl restart httpd</code> </pre> <br><br>  We edit the apache settings for vhost at our discretion. <br>  Enable the use of Graphite in Icinga 2: <br><br><pre> <code class="bash hljs">icinga2 feature <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> graphite systemctl restart icinga2</code> </pre> <br>  Download the web module <a href="https://github.com/findmypast/icingaweb2-module-graphite">from here</a> .  Unpack the folder <i>/ usr / share / icingaweb2 / modules</i> and rename the module root folder to <i>graphite</i> (otherwise an error will occur).  Create the <i>/etc/icingaweb2/modules/graphite/config.ini</i> configuration file with the following contents: <br><br><pre> <code class="bash hljs">[graphite] metric_prefix = icinga base_url = http://172.18.200.15/render?</code> </pre> <br>  Now it remains to enable the web module (Configuration -&gt; Modules -&gt; graphite -&gt; enable) and enjoy the result: <br><br><img src="https://habrastorage.org/files/b8b/110/e66/b8b110e664f44871a319b8f3261b8be7.png"><img src="https://habrastorage.org/files/938/b7a/cb4/938b7acb49964c40acbce5f922e251a7.png"><br><br>  PS: In the next part we will look at monitoring network equipment </div><p>Source: <a href="https://habr.com/ru/post/262115/">https://habr.com/ru/post/262115/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262097/index.html">Algorithms of attack and protection of mobile advertising network</a></li>
<li><a href="../262101/index.html">Advanced Exim and Dovecot configuration with OpenLDAP binding</a></li>
<li><a href="../262103/index.html">Why we encrypt</a></li>
<li><a href="../262105/index.html">Checking JSON using decorators in TypeScript</a></li>
<li><a href="../262113/index.html">Insane experiences on the "implementation" of Windows 3.11 continues</a></li>
<li><a href="../262117/index.html">We improve the form of payment with the help of design and animation</a></li>
<li><a href="../262119/index.html">My vision of road events</a></li>
<li><a href="../262121/index.html">Effective logo design, part 3: The influence of geometry on logo design</a></li>
<li><a href="../262123/index.html">Network Security, Part 2. Next-Generation Firewall</a></li>
<li><a href="../262125/index.html">Will Microsoft Azure be able to find an index that your DBA couldn't find?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>