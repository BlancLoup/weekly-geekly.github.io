<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Inclusion of the Ubuntu-based Samba server in the AD domain</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Our previous work examined what Active Directory and Samba are and what the advantages of their collaboration are. It also reviewed the Samba build pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Inclusion of the Ubuntu-based Samba server in the AD domain</h1><div class="post__text post__text-html js-mediator-article">  Our previous work examined what Active Directory and Samba are and what the advantages of their collaboration are.  It also reviewed the Samba build process from source and its inclusion into the domain, and all this from the command line.  It should be recognized that building something from source is not common practice in modern Linux distributions.  More often, repositories are used to install software.  This allows you to make the installation process more friendly and easy for the user.  Also, additional packages necessary for the operation of the installed software can be automatically involved, which again makes life easier and eliminates the need to study the lists of necessary pre-installed packages. <a name="habracut"></a>  Currently, there is a trend towards the widespread use of graphical interfaces.  One can discuss the pros and cons for a long time, but the fact remains that an increasing number of users and even system administrators prefer to use the GUI for a significant number of tasks.  In this article we will try to consider the process of installing and integrating into the Samba domain using the command line and repositories, as well as including Samba into the domain using the SADMS utility graphical interface. <br>  According to statistics, Openstat Ubuntu is the 4th in the list of the most popular operating systems for web servers, and its popularity is growing rapidly.  In our case, this is the Ubuntu Server 12.04 LTS distribution.  Find the distribution can be on the official <a href="http://www.ubuntu.com/download/server">website of Ubuntu</a> . <br><br><h5>  1.Include a Ubuntu-based Samba server to the AD domain using the command line </h5><br>  To begin, consider the inclusion of a server based on Ubuntu in the AD domain using the command line.  The process is described in detail in the documentation on <a href="http://help.ubuntu.ru/wiki/%25D0%25B2%25D0%25B2%25D0%25BE%25D0%25B4_%25D0%25B2_%25D0%25B4%25D0%25BE%25D0%25BC%25D0%25B5%25D0%25BD_windows">the Ubuntu site</a> . <br><br><h5>  2. Installation of updates and necessary packages. </h5><br>  We need Kerberos, Samba and Winbind.  Before installing them, it is recommended to upgrade the system: <br><pre><code class="bash hljs">sudo apt-get update sudo apt-get upgrade</code> </pre> <br>  After successfully installing the updates, we install Kerberos, Samba and Winbind: <br><pre> <code class="bash hljs">sudo apt-get install install krb5-user samba winbind</code> </pre><br>  In this team, <br>  <b>krb5-user</b> - package for the Kerberos protocol, which is used for authentication in Windows; <br>  <b>samba</b> - allows you to become a member of the domain; <br>  <b>winbind</b> - allows you to use a user account from ActiveDirectory. <br>  When using the GUI, you can use the Synaptic package manager.  It is worth noting that there is no graphical interface in Ubuntu Server 12.04 LTS by default, it can be installed separately if necessary: <br><pre> <code class="bash hljs">sudo apt-get install ubuntu-desktop</code> </pre><br>  After that, you need to configure all the components to work with the domain.  The test domain is called LAB.LOCAL, the domain controller is lab-dc1.lab.local, with IP 192.168.7.2, the server name is testubuntu. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  3. DNS Setup </h5><br>  First of all, you need to configure DNS on the host running Ubuntu (the DNS server will be the domain controller), and also register the correct search domain.  To do this, you need to edit the /etc/resolv.conf file so that it contains the following information: <br><pre> <code class="bash hljs">domain lab.local search lab.local nameserver 192.168.7.2</code> </pre><br>  To apply the changes, you must restart the network service: <br><pre> <code class="bash hljs">/etc/init.d/networking restart</code> </pre><br>  You should also make sure that the server name in the <i>/ etc / hostname</i> file is correct: <br><pre> <code class="bash hljs">testubuntu</code> </pre>  It is also necessary to edit the / etc / hosts file so that it contains a record with the fully-qualified domain name of the computer and always with a short host name that refers to one of the internal IPs: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    127.0.0.1 localhost 127.0.1.1 testubuntu.lab.local testubuntu</span></span></code> </pre><br><br><h5>  4. Setting time synchronization. </h5><br>  The next step is to set up time synchronization with the domain controller.  It is very important not to forget about this moment, since if the discrepancy in time is more than five minutes, we will not be able to get a ticket from Kerberos. <br>  If there is an exact time server on the network, you can use it or any public one: <pre> <code class="bash hljs">ntpdate ntp.mobatime.ru</code> </pre><br>  Automatic synchronization is configured using ntpd, this daemon will periodically perform synchronization.  First you need to install it: <pre> <code class="bash hljs">sudo ap&lt;i&gt;t-get&lt;/i&gt; install ntp</code> </pre><br>  Now you need to make changes to the <code>/etc/ntp.conf</code> file, adding information about the time server to it: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># You do need to talk to an NTP server or two (or three). server lab-dc1.lab.local</span></span></code> </pre><br>  Then you need to restart the <code>ntpd</code> daemon: <br><pre> <code class="bash hljs">sudo /etc/init.d/ntp restart</code> </pre><br><br><h5>  5. Configure Kerberos. </h5><br>  The next step is to configure authorization via the Kerberos protocol.  You will need to edit the <code>/etc/krb5.conf</code> file.  Below is the result of edits: <br><pre> <code class="bash hljs">[libdefaults] default_realm = LAB.LOCAL kdc_timesync = 1 ccache_type = 4 forwardable = <span class="hljs-literal"><span class="hljs-literal">true</span></span> proxiable = <span class="hljs-literal"><span class="hljs-literal">true</span></span> v4_instance_resolve = <span class="hljs-literal"><span class="hljs-literal">false</span></span> v4_name_convert = { host = { rcmd = host ftp = ftp } plain = { something = something-else } } fcc-mit-ticketflags = <span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre><br><br><pre> <code class="bash hljs">[realms] LAB.LOCAL = { kdc = lab-dc1 admin_server = lab-dc1 default_domain = LAB.LOCAL }</code> </pre><br><br><pre> <code class="bash hljs">[domain_realm] .lab.local = LAB.LOCAL lab.local = LAB.LOCAL [login] krb4_convert = <span class="hljs-literal"><span class="hljs-literal">false</span></span> krb4_get_tickets = <span class="hljs-literal"><span class="hljs-literal">false</span></span></code> </pre><br>  At this stage, you can verify that we can log in to the domain.  To do this, use the following command: <pre> <code class="bash hljs">kinit user@LAB.LOCAL</code> </pre><br>  Instead of <code>user</code> , of course, it is necessary to enter the name of an existing domain user.  Domain name must be written in capital letters! <br>  If the command did not lead to errors, then everything is correct, and the domain gives you a Kerberos ticket.  You can make sure that the ticket is received by running the command: <br><pre> <code class="bash hljs">klist</code> </pre><br>  You can delete all tickets with the command <br><pre> <code class="bash hljs">kdestroy</code> </pre><br>  So, we will assume that the authorization was successful;  it's time to configure the domain login directly. <br>  Another file that interests us is <code>/etc/samba/smb.con</code> f.  In it, we need the <code>[global]</code> section.  Below is an example of a portion of the Samba configuration file with comments about the meaning of important parameters: <br><pre> <code class="bash hljs">[global]</code> </pre><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#         ,  &lt;code&gt;workgroup&lt;/code&gt;  #    ,  &lt;code&gt;realm&lt;/code&gt; -    workgroup = LAB realm = LAB.LOCAL</span></span></code> </pre><br><br><pre> <code class="bash hljs"> <span class="hljs-comment"><span class="hljs-comment">#          AD security = ADS encrypt passwords = true #   dns proxy = no socket options = TCP_NODELAY</span></span></code> </pre><br><br><pre> <code class="bash hljs"> <span class="hljs-comment"><span class="hljs-comment">#    ,             , #    ,           domain master = no local master = no preferred master = no os level = 0 domain logons = no</span></span></code> </pre><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    load printers = no show add printer wizard = no printcap name = /dev/null disable spoolss = yes</span></span></code> </pre><br>  After <code>smb.conf</code> , run the command <br><pre> <code class="bash hljs">testparm</code> </pre><br>  She will check the configuration for errors and give a summary of it: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># testparm Load smb config files from /etc/samba/smb.conf Loaded services file OK. Server role: ROLE_DOMAIN_MEMBER Press enter to see a dump of your service definitions</span></span></code> </pre><br>  As you can see, the correct parameters were set in order for the computer to become a member of the domain.  Now it's time to try to directly enter the domain.  To do this, use the following command: <br><pre> <code class="bash hljs">net ads join -U admin -D LAB</code> </pre><br>  And if successful, the output of the command should be something like this: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># net ads join -U &lt;i&gt;admin&lt;/i&gt; -D LAB Enter admin's password: Using short domain name ‚Äî LAB Joined 'testubuntu' to realm 'lab.local'</span></span></code> </pre><br><br><h5>  6. Parameters used by the net command </h5><br><ol><li>  <code>U username%password</code> is a required parameter; instead of admin, you must substitute the username with domain administrator rights and specify a password. </li><li>  <code>D DOMAIN: DOMAIN</code> - the domain itself;  it is possible and not to indicate, but it is better to do it all the time - so much calmer. </li><li>  <code>S win_domain_controller: win_domain_controller</code> can be omitted, but there are times when the server does not automatically find the domain controller. </li><li>  <code>createcomputer=¬´OU/OU/‚Ä¶¬ª</code> : in AD, the OU (Organizational Unit) is often used, it is in the root of the domain OU = Office, in it OU = Cabinet;  to immediately add to the desired, you can specify as follows: <br><pre> <code class="bash hljs"> sudo net ads join -U username createcomputer=¬´Office/Cabinet¬ª.</code> </pre></li></ol><br>  If there are no more messages, then everything went well. <br>  Try using ping by name from another domain member to make sure that everything in the domain has worked properly. <br>  You can also use the command <br><pre> <code class="bash hljs">net ads testjoin</code> </pre><br>  If there are no problems, the output of the command will be as follows: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#net ads testjoin Join is OK</span></span></code> </pre><br>  But sometimes after the message about joining the domain you get the following error: <br><pre> <code class="bash hljs">DNS update failed!</code> </pre><br>  Before finding out why the DNS is not updated, restart the computer after entering the domain!  It is possible that this will solve the problem. <br>  If this does not help, it is recommended to check the DNS settings again: it is very likely that they will be the cause.  After that, you need to remove the computer from the domain and try to repeat the process again. <br>  If everything went smoothly, the computer was successfully included in the domain.  You can go to the domain controller and see this. <br>  If you need to somehow work with domain users, for example, configure SMB-balls with access control, then in addition to Samba itself you will also need Winbind - a special daemon used to connect the local Linux user management system and groups to the Active Directory server. <br>  Simply put, Winbind is needed if you want to see domain users on your Ubuntu computer. <br>  Winbind allows you to project all users and all AD groups into your Linux system by assigning them IDs from a specified range.  Thus, you can assign domain users as owners of folders and files on your computer and perform any other operations related to users and groups. <br>  To configure Winbind, the same <code>/etc/samba/smb.conf</code> file is used.  Add the following lines to the <code>[global]</code> section: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#           Winbind. #       . idmap uid = 10000 - 40000 idmap gid = 10000 - 40000 #     . winbind enum groups = yes winbind enum users = yes #       .        #    , ..  user - DOMAIN\user. #      ,      . winbind use default domain = yes #          ,  #   ,    shell'   /bin/false template shell = /bin/bash #     Kerberos  pam_winbind.so    winbind refresh tickets = yes</span></span></code> </pre><br>  Now restart the Winbind daemon and Samba in the following order: <br><pre> <code class="bash hljs">sudo /etc/init.d/winbind stop sudo smbd restart sudo /etc/init.d/winbind start</code> </pre><br>  After restarting, verify that Winbind has established a trust relationship with the AD command. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># wbinfo -t</span></span></code> </pre><br>  and also that Winbind saw users and groups from AD, commands <br><pre> <code class="bash hljs">wbinfo -u wbinfo -g</code> </pre><br>  These two commands should produce a list of users and groups from the domain, respectively. <br>  So, Winbind works, but it is not yet integrated into the system. <br>  In order for your Ubuntu to work transparently with domain users (in particular, so that you can assign domain users as owners of folders and files), you must tell Ubuntu to use Winbind as an additional source of information about users and groups. <br>  To do this, change two lines in the <code>/etc/nsswitch.conf</code> file: <br><pre> <code class="bash hljs">passwd: compat group: compat</code> </pre><br>  adding winbind to them at the end: <br><pre> <code class="bash hljs">passwd: compat winbind group: compat winbind</code> </pre><br>  Now check that Ubuntu is requesting user and group information from Winbind by running <br><pre> <code class="bash hljs">getent passwd getent group</code> </pre><br>  The first command should return all the contents of your <code>/etc/passwd</code> , that is, your local users plus domain users with an ID from the range you specified in <code>smb.conf</code> .  The second should do the same for groups. <br><br><h5>  The inclusion of a Ubuntu-based Samba server in the AD domain using a graphical interface and SADMS. </h5><br>  Perhaps, let's say at home or in a hurry, you will want to perform all these manipulations in graphical mode.  For these purposes, there is a package SADMS, about which there is information on <a href="http://help.ubuntu.com/community/ActiveDirectoryWinbind-SADMS">the Ubuntu site</a> .  And <a href="http://sadms.sourceforge.net/">on the site</a> you can find out everything about this package and download it.  Let's look at the package interface: <br><img src="https://habrastorage.org/storage2/787/c0f/eef/787c0feef4e391c2daabfff7956b3045.png"><br>  Fig.  1. General view of the main tab. <br><br>  It displays the status of winbind, smb and nmb, and there is an indication of the connection of the computer to the domain. <br><img src="https://habrastorage.org/storage2/896/6f6/8b5/8966f68b53f5f846a8d7f375a5b40c92.png"><br>  Fig.  2. Run smb and nmb. <br><br><img src="https://habrastorage.org/storage2/741/dc3/510/741dc35100077100b59e0c42b014e9e8.png"><br>  Fig.  3. ‚ÄúData‚Äù tab. <br><br>  Here we must specify the data that will be used to connect to the domain.  By default, the fields are filled in by the developers, for example.  The developers of the package are French, so don't be confused by examples like ‚Äúadministrateur‚Äù instead of the usual ‚ÄúAdministrator‚Äù. <br><br><img src="https://habrastorage.org/storage2/7c7/86e/bd5/7c786ebd5434bf1acca2fa0f13bcf610.png"><br>  Fig.  4. Automatic capture of the parameters. <br><br>  We click on "Determine" - and some parameters are picked up automatically.  The rest will have to fill out manually.  All these parameters were used when configuring from the command line. <br><br><img src="https://habrastorage.org/storage2/bab/8be/9fa/bab8be9fa19a19d8a1ea107b3125ea04.png"><br>  Fig.  5. Filling in the remaining fields. <br><br>  Fill in the fields.  Pay special attention here: Netbios domain name must be spelled in BIG letters, otherwise we get an error Kerberos, as it turned out in this case.  If everything is filled out correctly, click on ‚ÄúInstall‚Äù - and SADMS switches the machine into the domain. <br><br><img src="https://habrastorage.org/storage2/a71/122/d10/a71122d108eea7e06efee5ba51a29dff.png"><br>  Fig.  6. The machine is included in the domain successfully. <br><br><img src="https://habrastorage.org/storage2/762/75e/7fb/76275e7fb24cb6a2580c453a72dfe26e.png"><br>  Fig.  7. Menu "Checks". <br><br>  From the menu "Checks" we can perform tests to perform various operations.  You can also run all the tests from the command line, as described earlier. <br><br><img src="https://habrastorage.org/storage2/e9d/ebc/347/e9debc347085ed024ca1219383e04edf.png"><br>  Fig.  8. An example of the conclusion of the test for domain membership. <br><br><img src="https://habrastorage.org/storage2/b9e/d24/749/b9ed24749ea1d23c374859791204b270.png"><br>  Fig.  9. Network test results. <br><br><img src="https://habrastorage.org/storage2/252/a12/4f0/252a124f092cc71ccf8ac7ce262b84f5.png"><br>  Fig.  10. Check the availability of the machine on the domain controller. <br><br>  The server is in the list of domain machines along with our other servers. <br>  So, we have reviewed the installation of Samba and its inclusion in the domain - using both the command line and the graphical interface.  Using the graphical interface allows you to seriously speed up and simplify the configuration, but at the same time does not allow you to understand the whole mechanics of the process, and can also seriously complicate the process of finding errors.  On the other hand, the CLI (Command Line Interface), although it provides absolute control over everything, is much less user friendly and implies that it has some working skills.  Which way to use is up to you. </div><p>Source: <a href="https://habr.com/ru/post/171057/">https://habr.com/ru/post/171057/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../171037/index.html">Google two-way authentication bypass</a></li>
<li><a href="../171041/index.html">The coolest result on TechCrunch Moscow '12</a></li>
<li><a href="../171043/index.html">Video from the W3C conf 2013 conference is available on YouTube</a></li>
<li><a href="../171045/index.html">3PAR StoreServ for work in a corporate mail environment</a></li>
<li><a href="../171047/index.html">What to read? Proposals for the publication of computer books. Part 1</a></li>
<li><a href="../171059/index.html">President Barack Obama has awarded IBM scientists with national medals</a></li>
<li><a href="../171061/index.html">Forget about B2B and B2C. Mobile technology turns everything into B2P - a business for people</a></li>
<li><a href="../171063/index.html">Microsoft suspected the creators of the terrorist recognition complex of plagiarism</a></li>
<li><a href="../171069/index.html">Fire Safety in Version Control Systems</a></li>
<li><a href="../171071/index.html">Sergey Brin: smartphones are asocial</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>