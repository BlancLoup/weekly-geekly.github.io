<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Integration of LMS Moodle and Microsoft Active Directory. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Well, this is my first post in the habr-community. In the future, this article should be one of the articles in the series of stories about building a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Integration of LMS Moodle and Microsoft Active Directory. Part 1</h1><div class="post__text post__text-html js-mediator-article">  Well, this is my first post in the habr-community.  In the future, this article should be one of the articles in the series of stories about building an information infrastructure of an educational institution based on <a href="http://moodle.org/">Moodle</a> , <a href="http://bigbluebutton.org/">BigBlueButton</a> , <a href="https://ru.wikipedia.org/wiki/Active_Directory">Microsoft Active Directory</a> and <a href="http://www.kaspersky.ru/security-center">Kaspersky Security Center</a> . <br>  For those who do not know, Moodle is a <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D1%2581%25D1%2582%25D0%25B5%25D0%25BC%25D0%25B0_%25D1%2583%25D0%25BF%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F_%25D0%25BE%25D0%25B1%25D1%2583%25D1%2587%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5%25D0%25BC">distance learning system</a> , a sort of CMS with an emphasis on education, a <a href="http://habrahabr.ru/search/%3Fq%3Dmoodle">lot</a> has already been <a href="http://habrahabr.ru/search/%3Fq%3Dmoodle">written</a> about it in Habr√©.  In this article I will tell you how to fully connect it with the user base created in Microsoft Active Directory. <a name="habracut"></a><br><br><h4>  What is it for? </h4><br><ul><li>  Well, firstly, to simplify the work of the administrator, because it is easier to keep users in one database, and not in two. </li><li>  Secondly, for the possibility of delegating the functions of managing the list of users to other employees.  The fact is that in Moodle all users ‚Äúlie‚Äù in a single list without division into structure, and, as a result, it is impossible to give someone the right to edit parts of this list.  And at the Active Directory level it is quite possible to delegate editing rights: to employees of a specific dean's office for students of this faculty, and for class teachers for students of their own class. </li><li>  Thirdly, the use of such a bundle allows you to organize SSO - the entrance to the site with the same username and password with which the user logged on to Windows.  A trifle, but nice - no need to once again enter the password. </li></ul><br><br><h4>  Where to begin? </h4><br>  Well, let's assume that the following has already been done: <br><ul><li>  Set up a computer with a server version of Microsoft Windows.  Any version, you can 2003, you can 2008 (in the screenshots will be 2012).  On this server, the role of the domain controller has already been raised.  Several machines have already been entered into the domain.  Let the domain be called <b>ad.liceum.ru</b> , its NetBIOS name <b>ad_liceum_ru</b> , and the domain controller <b>pdc.ad.liceum.ru</b> </li><li>  Configured web server with Moodle.  I have it based on Ubuntu 12.04.  Of course, you can install IIS and Moodle on the same machine as the domain controller, but that‚Äôs another story.  Let the server be called <b>moodle.liceum.ru</b> .  The screenshots will be Moodle 2.5, but the logic has not fundamentally changed since version 1.9.  Moodle is already configured to send mail. </li><li>  The domain controller, web server, and machines included in the domain have the ability to interact with each other.  In the simplest case, you can simply arrange them in one network, but you can use a more complex configuration with clever routing and closing all unnecessary ports. </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Manage users in Active Directory </h4><br>  First, on any machine included in the domain, you need to run the Active Directory Users and Computers MMC snap-in.  Of course, you can go to the server via RDP and run it there, as many administrators like.  But if you plan to further simplify your work by transferring responsibilities for maintaining the user base to others, I recommend to learn now how to install this snap-in on client machines.  This is done differently in different versions of Windows.  First download: <a href="http://www.microsoft.com/ru-ru/download/details.aspx%3Fid%3D6315">for XP</a> , <a href="http://www.microsoft.com/ru-ru/download/details.aspx%3Fid%3D7887">for 7 SP1</a> and <a href="http://www.microsoft.com/ru-ru/download/details.aspx%3Fid%3D28972">for 8</a> .  In XP, a snap-in appears immediately via <i>Control Panel&gt; Administrative Tools</i> .  In 7 and 8, after installing the downloaded update, you will need to go to <i>Control Panel&gt; Programs&gt; Turn Windows components on or off</i> .  There you can select <i>Remote Server Administration Tools&gt; Role Administration Tools&gt; Active Directory Domain Services Tools and ...&gt; Active Directory Domain Services Tools&gt; Snap-ins and Command-Line Utilities ...</i> and mark the last one to install. <br><img src="https://habrastorage.org/getpro/habr/post_images/f50/5e4/2e1/f505e42e108b0d2ca78c4e5fadc2c8a6.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/079/277/898/0792778985310adc5d907928bc6c32bc.png"><br><br>  Using this snap-in, we will create a separate unit for users.  In it, we will store the accounts of all users, setting the structure convenient for us.  Trite, but I will call this unit "Users". <br><img src="https://habrastorage.org/getpro/habr/post_images/ae4/c72/6df/ae4c726df881e8ceb4ea327299f2aed0.png"><br><br>  In order for the Moodle system to request information about users from Active Directory, we will create a special user for communication.  Let it be called <b>moodle_liceum</b> .  Let's create it not in the ‚ÄúUsers‚Äù container created by us, but in the existing ‚ÄúUsers‚Äù container, so that there is no confusion between the real users' accounts and the service account created for system communication. <br><img src="https://habrastorage.org/getpro/habr/post_images/1bb/156/41c/1bb15641c63e23dc067ed74873a2768d.png"><br>  Add the created account to the Domain Admins group. <br><img src="https://habrastorage.org/getpro/habr/post_images/32a/18a/c00/32a18ac005592595abf8f437af053f5f.png"><br>  Of course, adding a service account to the group of administrators is not a good idea, because having hijacked the Moodle administrator password or getting access to the Moodle database, you can also get access to the domain, because the Moodle user password for communication is stored in clear text.  In fact, it is enough to give this account only the rights to edit users in the "Users" division.  How to do this, I will describe later.  But, as they say, <a href="http://www.anekdot.ru/id/101180/">there is one nuance</a> .  In this case, it will not be possible to change the password from the Moodle to the user if he is a member of the Domain Admin group.  Regardless of the rights to edit the division in which the user is located, only another domain administrator can change the password for the domain administrator.  Such is the mysterious soul of Windows. <br><br>  Now we will create this user in Active Directory. <br><img src="https://habrastorage.org/getpro/habr/post_images/fbd/aa8/5f1/fbdaa85f193845d378ec6dac909beb93.png"><br>  Middle name, if you want it to be displayed, it is better to immediately enter in the same field as the name.  The fact is that neither Active Directory nor Moodle provides default patronymic fields in the interface.  Immediately you should change the order of the name and surname in the "Full Name" field.  This will allow us to see users in the list sorted by the usual way by the name. <br><br>  After creating the user and setting up his password, call the properties.  Fill in the fields with email, country and city.  What is it for?  The fact is that the meticulous Moodle system considers that the e-mail, country and city fields are required to be filled by all users.  And, if they cannot be obtained from Active Directory, the user will not be able to continue working until he has entered this data.  Well, with the city and the country is clear, but what if the user does not have e-mail, or she is not known to the administrator?  In this case, you can come up with a fictitious email.  If desired, the user will be able to change it, while the confirmation letter will be sent to the new address, which means that the user does not have access to the mail we have invented will not be a restriction. <br><br><h4>  Customize Moodle </h4><br>  Go to Moodle in <i>Administration&gt; Plugins&gt; Authentication&gt; Authentication Settings</i> , enable the LDAP Server plugin <br><img src="https://habrastorage.org/getpro/habr/post_images/d32/54b/c8e/d3254bc8ecbdf5fc97fef9b15a891e58.png"><br>  Why LDAP?  Well, <a href="https://ru.wikipedia.org/wiki/LDAP">LDAP</a> is such a protocol for working with a hierarchical database.  So, it is possible and necessary to connect to Active Directory using this protocol. <br><br>  Well, let's start setting up the authentication plugin.  Enter the name of our server in the ‚ÄúServer URL‚Äù field by adding the prefix <b>ldap: // to it</b> .  Remember, the web server must be able to correctly resolve the LDAP server name to an IP address.  To do this, you can specify a domain controller as a DNS server, you can also configure DNS more cleverly, you can simply enter the correct IP into the hosts file on the machine with the web server.  Well, you can, of course, in the Moodle settings, specify the IP instead of the name.  By the way, who does not know, you can check what the name resolves with using the ping and nslookup commands. <br><img src="https://habrastorage.org/getpro/habr/post_images/548/290/6e4/5482906e423cb6887600eb39c6c42ee0.png"><br>  Of course, if you are thinking about the future, you have a backup domain controller.  In this case, it is also worth pointing here.  Other parameters in this section should be left as default. <br><br>  Now you need to specify the data to connect to the server.  However, this is not just a username and password; instead, a ‚ÄúDistinguished Name‚Äù is required instead of a username, it is DistinguishedName or Post DN.  What is it?  The fact is that in a hierarchical database, as in a file system, there can be many objects with the same name.  So, the fact that the file system is called the file name, in LDAP, it is common to call common name or CN, and what is called the full file name, that is, the file name plus the path to it, is called the distinguished name or DN.  Well, now a small digression about how to find out this very DN. <br><br><h4>  We look for the necessary information in LDAP </h4><br>  Back in the Active Directory Users and Computers snap-in.  In the <i>View</i> menu, enable the option <i>Additional Components</i> <br><img src="https://habrastorage.org/getpro/habr/post_images/79c/26a/2f0/79c26a2f01e3b56ea15e1f34c7950776.png"><br>  Now, when we call the properties of different objects, among the tabs there will be an attribute editor. <br><img src="https://habrastorage.org/getpro/habr/post_images/fc5/6ff/ce1/fc56ffce165e71c69f70cf2c60acff3c.png"><br>  In the attribute editor, you can view all the properties of an object.  Will be there and we need to distinguishName. <br><img src="https://habrastorage.org/getpro/habr/post_images/501/2c3/c26/5012c3c26176c38974e0ed129bddc5d2.png"><br><br>  By the way, it's time to see how the fields are called, in which any user data is stored.  By comparing what we entered in the user card and what we see in the attribute editor, we create a label. <br><table><tbody><tr><th>  Value </th><th>  Attribute </th></tr><tr><td>  Surname </td><td>  sn </td></tr><tr><td>  Name </td><td>  givenName </td></tr><tr><td>  Windows login </td><td>  sAMAccountName </td></tr><tr><td>  Email </td><td>  mail </td></tr><tr><td>  City </td><td>  l </td></tr><tr><td>  A country </td><td>  with </td></tr></tbody></table><br>  Supervisors will notice that the country is stored twice - with the full name in the <b>co</b> attribute and the code in the <b>c</b> attribute.  For Moodle you need exactly two-letter code. <br><br><h4>  We continue to customize Moodle </h4><br>  Introduce the distinguished username and password derived from Active Directory into Moodle.  In my example, the distinguished name will be <b>CN = moodle_liceum_ru, CN = Users, DC = ad, DC = liceum, DC = ru</b> .  In the field ‚ÄúUser Type‚Äù we indicate ‚ÄúMS ActiveDirectory‚Äù. <br><br>  By default, Moodle stores password hashes in its database.  It stores well - in the latest versions, the bcrypt algorithm is used, so that using the md5 database, such passwords cannot be decrypted.  True, this is of little use, because if the connection with Active Directory suddenly disappears, users will not be able to log in to the system, despite the information in it about passwords.  The only way to use the saved password is if the administrator manually switches the authentication type for the user account to the <i>Manual Registration</i> option.  But you can disable this by turning on the <i>Do not store passwords</i> option. <br><br>  In the <i>Containers</i> field we indicate the distinguished name of the department in which users are stored.  It can be learned as described above.  In our case it will be <b>OU = Users, DC = ad, DC = liceum, DC = ru</b> .  Since users are stored in our subdivisions, we enable the <i>Search</i> parameter <i>in child containers</i> . <br><br>  In the <i>User Attribute</i> field <i>,</i> specify <b>sAMAccountName</b> .  You can, of course, experiment with this parameter.  If you specify mail here, then you will need to specify an email address when logging in, if you specify telephoneNumber, then your phone number.  However, with all the alternative options, we will not then be able to configure automatic login with an account from the domain. <br><img src="https://habrastorage.org/getpro/habr/post_images/ae2/dd0/ce4/ae2dd0ce4848e8f86d598331ac61ac52.png"><br>  We will leave other parameters by default. <br><br><h4>  Login </h4><br>  Well, it's time to try to log in to Moodle with an account from Active Directory. <br><img src="https://habrastorage.org/getpro/habr/post_images/b33/31b/596/b3331b596350e8480ba395ad9c03e937.png"><br><br>  If everything has been done correctly, then it will be possible to enter Moodle.  However, the system will offer us to fill in an empty questionnaire - there will be no user data in Moodle. <br><img src="https://habrastorage.org/getpro/habr/post_images/a34/715/19a/a3471519a5b35d53429f9598558701e9.gif"><br><br>  The reason is simple - we haven‚Äôt told Moodle yet where exactly the data should be taken.  For this, the group of parameters ‚ÄúData mapping‚Äù is responsible.  Fill in the fields using the previously obtained label. <br><img src="https://habrastorage.org/getpro/habr/post_images/bfa/31d/3c3/bfa31d3c38202892451afd9130b35eff.png"><br><br>  Well, try to log in again.  This time, if everything is done correctly, no requests for filling in the missing fields will arise.  In the upper right corner will be specified user data. <br><img src="https://habrastorage.org/getpro/habr/post_images/c43/cc9/d0b/c43cc9d0b9a30b115e1e6805079db6a7.png"><br><br>  If you invoke a user profile, you can make sure that the data matches the information from the LDAP. <br><img src="https://habrastorage.org/getpro/habr/post_images/580/099/6d6/5800996d67dcfe3505aa8584f7346311.png"><br><br><h4>  Check data update </h4><br>  How do you use the <i>Local Account</i> <i>Update, External Account Update,</i> and <i>Block Value settings</i> when matching data? <br><br>  I would like to manage data such as, for example, the first and last names exclusively from Active Directory.  This is necessary, for example, so that the students do not write down any nonsense instead of the name and surname.  And when data changes in AD, I would like to update them as quickly as possible in Moodle.  For such options, a combination is suitable <i>For each entry</i> , <i>Never</i> , <i>Locked</i> . <br><br>  In my example, the email addresses of users are unknown, so dummy ones are invented instead.  This approach allows users to start working in the system immediately, and then, if desired, replace the email address with the real one, for example, to begin receiving notifications.  If you want users to enter e-mail when they first log in, this field should not be filled in Active Directory.  For email, I use the option <i>With every login</i> , <i>When updating</i> , <i>Unlocked</i> .  This allows you to update data in AD when you update it in Moodle, and vice versa. <br><br>  Well, now let's check if the data is updated.  Let's exit Moodle, fix the user's email in Active Directory and go back to Moodle again.  In the profile, the user should display a new mail. <br>  Now we‚Äôll change the email from Moodle.  A confirmation email will be sent.  The address in Moodle and in Active Directory will have to change immediately after confirming the new address. <br><br>  Well, how to set up passwords in Active Directory from Moodle, how to allow users to create accounts on their own, and, of course, how to enter Moodle without entering a password - I hope to tell you about all this in the following sections.  Unless, of course, someone sends an invite. </div><p>Source: <a href="https://habr.com/ru/post/200872/">https://habr.com/ru/post/200872/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../200856/index.html">India launched a satellite into Mars orbit</a></li>
<li><a href="../200858/index.html">How the NSA implemented a bookmark in a pseudo-random number generator</a></li>
<li><a href="../200866/index.html">Advanced chat on Node.JS</a></li>
<li><a href="../200868/index.html">SRVCC technology in 4th generation mobile networks</a></li>
<li><a href="../200870/index.html">RabbitMQ tutorial 3 - Publish / Subscribe</a></li>
<li><a href="../200874/index.html">Immersive Mode (dive mode) in Android 4.4 KitKat</a></li>
<li><a href="../200878/index.html">Hash strings at compile time with annotation</a></li>
<li><a href="../200880/index.html">Multiplayer Games: Inside Look</a></li>
<li><a href="../200882/index.html">Six rules for effective management of promotion and "lead generation" using social media</a></li>
<li><a href="../200884/index.html">There is nothing wrong with types in C #</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>