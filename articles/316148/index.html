<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Monitoring the status of your resource using Telegram-bot</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! I have been watching you for a long time, but I still can‚Äôt decide to take my first step. Now it seemed to me that I was ready. I'll tell yo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Monitoring the status of your resource using Telegram-bot</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr!  I have been watching you for a long time, but I still can‚Äôt decide to take my first step.  Now it seemed to me that I was ready.  I'll tell you about my experience of working with a <b>telegram bot</b> - recently this topic has been quite popular in the open spaces of the network, and I have already seen quite a few articles on Habr√© itself.  But for the most part they tell about the principles of creating bots, and there is not a word about the practical benefits you can get from these same bots. <br><a name="habracut"></a><br>  I had experience in creating systems for monitoring the status of servers, with the ability to set up testing strategies and sending short sms messages in order to inform about problems on one of the monitored servers, but all this is not quite convenient, as well as a fee - each message costs money. <br><br>  What is a condition monitoring system?  According to its architecture, it should be a small module that is responsible for checking the state and for informing about deviations from the normal state. <br><br>  There are many ready-made integrated solutions that include such a monitoring system.  This is the famous <b>zabbix</b> and <b>nagios</b> , <b>yandex metric</b> and a huge pile of similar beautiful tools. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Analytics </h3><br>  At the stage of creating a site, any developer using my local development server.  But as soon as the project comes to a working condition, I immediately want to put it on the production server.  And often this becomes a big mistake, because as soon as your site becomes available for Internet users, you will find yourself in the wonderful world of adventure and instead of developing you will start setting up.  And here, perforce, again, the state control system is remembered.  It is very convenient when you learn about any difficulties or problems immediately from your informant. <br><br>  At first, any fresh site is of little interest to users.  However, with sufficient effort or financial investment (usually both) traffic appears on the resource. <br><br>  We have already placed the <i>google analytics</i> script in our code and can observe the dynamics of changes in our audience.  But this is not always enough.  Sometimes you want to know more - you want to control the whole process of finding a user on the site, to lead him, to direct.  Analyzing the headers of requests and responses, you can get comprehensive information about what each user did, when and why.  For this, sooner or later, you start reading the logs of your web server - sometimes there is a bug that will help you fix a serious bug, and sometimes it‚Äôs just interesting to know: who is spamming your guestbook? <br><br><h3>  Bot </h3><br>  Python and django are ideal for working with a telegram bot.  What is a bot?  In this context, a bot is an interaction interface between your application and a telegram client.  This interface allows you to send messages depending on the business logic of your application. <br>  I will not write here the whole process of creating and configuring a web application on django - whether I‚Äôd be able to do it better than the creators of the official documentation.  I can only say that it should not take you more than ten minutes if you have already worked with this framework. <br><br>  I would like to say thanks to Pavel Durov and his team - thanks to the ability to install webHook, it has become as easy and convenient to work with a bot.  All that is needed is: <br><br><ul><li>  Create your bot using the BotFather interface in the telegram client and configure it using the bot dad's instructions <br><br></li><li>  Install webHook using your token, which dad bot will help you get.  To do this, go to url: <i><a href="https://api.telegram.org/bot">api.telegram.org/bot</a> {{token}} / setWebhook? Url = {{url}}</i> , where <i>token</i> is your authentication ring, and <i>url</i> is the link that your telegram bot processes the request for .  I will also note that only the https protocol can be used, i.e.  SSL is required. <br><br></li><li>  Create a controller that processes the url from point 2, create business logic for your bot.  Bind the controller to the url handler.  In the url part, you must also add your <i>token</i> to ensure other people could not send requests to this address. <br><br></li><li>  Add bot to your contact list.  This can be done through a search in the telegram client or using the link <i>@ {{bot_name}}</i> <br></li></ul><br>  Then it all comes down to a simple scheme.  As soon as your bot receives a message, a request with information about this message comes to the <i>url</i> set in webHook.  In particular, there is information about the date of the message, about the sender's chat id, about the sender himself.  It is better to save this information in the database in order not to accidentally lose it - you need to work with it.  We program the bot in such a way that if it receives a message that is a command, it performs an action.  Let's say I want the bot to send me a telegram message with information about each request that comes to my site.  To do this, you need to ask him only two teams, for example <br><br>  <i>/ requests</i> and <i>/ stop_requests</i> .  The first team will add a subscription to the database to send information about the requests to the site, the second team will remove this subscription.  Next, you need to create your own context processor - this can be done in most modern <b>MVC frameworks</b> .  In its code, it is necessary to process subscriptions to the newsletter and then send messages to the chat with the specified id, which we previously saved in the database, when we received a request to our <b>webHook url</b> .  We can also subscribe to absolutely any events on our site: user registration (conveniently realized through signals), comments, errors.  The scope for creativity is just bottomless.  On my <a href="https://born2fish.ru/">born2fish</a> resource, where you can edit information about the rivers and lakes of the World, I used a bot to get information about when someone changed the nature of the reservoir.  This helps to quickly receive messages about reservoirs that need to be checked by a moderator. <br><br>  The sending of the message itself depends on the implementation.  In python, it looks like this: <br><br><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_send_msg</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bot, chat_id, message)</span></span></span><span class="hljs-function">:</span></span> bot.sendMessage(chat_id=chat_id, text=message)</code> </pre> <br>  This is how the function of processing subscriptions and sending information about a request might look like: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_requests_subscriptions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request, city)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" send Telegram messages to subscribed users """</span></span> bot_message = request.META[<span class="hljs-string"><span class="hljs-string">'HTTP_USER_AGENT'</span></span>] + <span class="hljs-string"><span class="hljs-string">" request from "</span></span> + get_client_ip( request) + <span class="hljs-string"><span class="hljs-string">" ("</span></span> + str(city[<span class="hljs-string"><span class="hljs-string">'city'</span></span>]) + <span class="hljs-string"><span class="hljs-string">") url = ["</span></span> + request.path_info + <span class="hljs-string"><span class="hljs-string">"]"</span></span> subscriptions = RequestsSubscription.objects.all() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> subscr <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> subscriptions: _send_msg(bot=bot, chat_id=subscr.chat_id, message=bot_message)</code> </pre><br>  This method allows the user to display help, which is read from the help.md file: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_display_help</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> render_to_string(<span class="hljs-string"><span class="hljs-string">'help.md'</span></span>)</code> </pre> <br><h3>  Instead of conclusion </h3><br>  In words, everything seems very simple, but I note that these bots are difficult to test.  The optimal solution will be Unit Test, in which you will simulate a request from a telegram and check the operation of the bot's business logic. <br><br>  What else might come in handy?  The information in the telegram user profile is not always full, so you should check the values ‚Äã‚Äãfor <i>None</i> before saving to the database in order not to get an <i>IndexError</i> . <br><br>  You can add your bot to the group.  This will help not to send information to each user, but to send it to a single place from where it will already be available to everyone.  This can be done through the client interface of the telegram, in the settings of your bot and your group. <br>  As an example, I want to share a link to my test bot: <b>@ born2fishBot</b> , Write to him <i>/ help</i> to get a list of possible commands. <br><br>  <b>Telegram</b> is a great application that opens up new horizons for programmers, administrators and even simple users.  Using innovations, you can get a tangible benefit from the use of telegram bots, with very little time spent on development.  Get all the latest information about the status of your web resource first.  And let this news be <b>only</b> pleasant. </div><p>Source: <a href="https://habr.com/ru/post/316148/">https://habr.com/ru/post/316148/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316138/index.html">Call Transfer Using Script in Asterisk</a></li>
<li><a href="../316140/index.html">How to test a legacy without pain and fear</a></li>
<li><a href="../316142/index.html">How we built a cloud backend for a mobile shooter</a></li>
<li><a href="../316144/index.html">Ambient Occlusion Volumes for burnt samovars</a></li>
<li><a href="../316146/index.html">FlyElephant celebrates its first year of public access and announces cooperation with HPC-HUB</a></li>
<li><a href="../316150/index.html">7 most unpleasant problems in programming</a></li>
<li><a href="../316152/index.html">Release DataGrip 2016.3</a></li>
<li><a href="../316154/index.html">How to become a product manager. Part 1</a></li>
<li><a href="../316156/index.html">Co-authorship on Habr√©</a></li>
<li><a href="../316158/index.html">Raise your own package repository for Ubuntu (Debian)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>