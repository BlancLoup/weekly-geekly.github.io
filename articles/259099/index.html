<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Visualization of sound on a 6E1P lamp</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I decided to share the experience of creating a sound indicator on the 6E1P lamp. When creating a tube audio amplifier for headphones, it was decided ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Visualization of sound on a 6E1P lamp</h1><div class="post__text post__text-html js-mediator-article">  I decided to share the experience of creating a sound indicator on the 6E1P lamp.  When creating a tube audio amplifier for headphones, it was decided to visualize the audio signal.  The choice fell on this Soviet lamp.  The result of the work was a small printed circuit board with a size of 30x33 mm.  This article provides a diagram of this board and a description of the operation algorithm. <br><br><img src="https://habrastorage.org/files/6d7/d61/724/6d7d61724ee94c7f8f7aaf2cd192e3c6.gif"><br><a name="habracut"></a><br>  The 6E1P lamp is not scarce and is relatively easy to get at a price of about 200 rubles.  This article <b>will not address the issues of creating an audio amplifier and audio quality</b> , it will deal exclusively with the connection circuit and control of the 6E1P lamp.  Anyone can repeat my scheme, modify or use the individual nodes of the scheme in their devices (source code attached). <br><br><div class="spoiler">  <b class="spoiler_title">Photograph of the lamp and developed board</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/f35/90c/441/f3590c4410c64569b29f0927f311e437.jpg"><img src="https://habrastorage.org/files/227/60f/7fa/22760f7fafc34df9ace036db165eef86.jpg"><br></div></div><br><h4>  Content: </h4><br><ul><li>  <a href="https://habr.com/ru/post/259099/">Introduction</a> </li><li>  <a href="https://habr.com/ru/post/259099/">Part 1. Power and lamp connection</a> </li><li>  <a href="https://habr.com/ru/post/259099/">Part 2. Analog channel circuit</a> </li><li>  <a href="https://habr.com/ru/post/259099/">Part 3. Control scheme</a> </li><li>  <a href="https://habr.com/ru/post/259099/">Part 4. Control Algorithm</a> </li><li>  <a href="https://habr.com/ru/post/259099/">Part 5. Result</a> </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2></h2><h4>  INTRODUCTION </h4><br>  When creating a tube amplifier, it was decided to decorate, to make the appearance of the tube amplifier for headphones more alive due to the animation of the sound signal.  The amplifier itself is assembled on two double 6N23P triodes according to the <a href="http://tubeamplifier.narod.ru/mess085.htm">SRPP cascade</a> scheme.  The design of the amplifier repeats a trapeze: 6N23P lamps are placed at the back, the 6E1P lamp is located at the front.  <a href="http://aivelectronics.ru/project-umgt-c2-01/">Read more about the amplifier here</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Photo amplifier (large)</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/225/411/5f7/2254115f752f47b58ebee717e229c892.jpeg"><br></div></div><br>  As an introduction, I will give the main points that were at the time of the beginning of the development of the lamp control circuit, and identified the final implementation: <br><ol><li>  The 6E1P lamp glows with a pleasant green light and looks original among many other lamp indicators of the past.  The lamp mounting is vertical, which is much more convenient than end lamps, especially when used in conjunction with other vacuum tubes in the amplifier, which are typically mounted vertically on the top panel. </li><li>  The required supply voltages are combined with the supply voltages of other vacuum tubes, which does not require a separate power supply.  True, at this point there is a certain feature (see below). </li><li>  Immediately the task was to draw a joint audio signal from two channels to one 6E1P lamp.  Usually placed on each channel by its indicator lamp or use the output of only one of the stereo channels for visualization.  Here the task was to make an ‚Äúhonest‚Äù display of the audio signal. </li><li>  The solution of point 3 requires a signal adder, which, of course, can be implemented on vacuum tubes, but then the control circuit of the indicator lamp becomes equal in complexity to the circuit of the amplifier itself.  The classical 6E1P lamp switching circuit provides for the removal of a signal from either the anode of the amplifier's output lamp, or the use of a special matching transformer, which is much harder to get than the 61 lamp itself.  Also, classical schemes do not give auto-tuning of the signal amplitude, which leads to the dependence of the degree of lamp opening on the volume level.  This dependence becomes critical when using headphones, since  The headphone impedance can vary between 32-600 ohms, which gives a change in the amplitude of the output signal tenfold.  Therefore, it was immediately decided: to use integrated amplifiers;  to implement auto-tuning, use a digital potentiometer controlled by a microcontroller;  implement digital filtering of the audio signal by the controller. </li></ol><br><br>  It is considered that it is not beautiful to use integrated circuits in tube audio equipment.  I have no such preconceptions and, as was written above, the quality of the audio signal is not discussed in this article.  It will be exclusively about the quality control circuit of the 6E1P lamp. <br><br>  Let's get started! <br><br><h2></h2><h4>  PART 1. POWER AND CONNECTION OF LAMP </h4><br>  The 6E1P lamp uses standard filament and anode voltages. <br>  Glow: 6.3V / 300 mA -&gt; 1.9 W <br>  Anode: 250V / 6 mA -&gt; 1.5 W <br><img src="https://habrastorage.org/files/917/17b/77b/91717b77b7094e1493deb9b14bf296e7.jpg"><br><br>  In my project I used TAN 21-127 / 220-50 to power the 6E1P lamp, the rest of the amplifier lamps and the power supply of the microcontroller.  Anode voltage + 270V was used in the final circuit. <br><br>  You can read more about TAN transformers <a href="http://chiplist.ru/transformers/transformator_tan/">here</a> . <br>  If you aim only at visualization, then the use of a TAN may not be appropriate.  It would be more reasonable to use power adapters with the subsequent formation of high voltage, heating voltage and power supply of the controller using switching power supplies.  For example, <a href="http://desmith.net/NMdS/Electronics/NixiePSU.html">this option</a> is used for gas-discharge lamps in Nixie lamp watches. <br><br>  I would recommend choosing a 24V power adapter.  This will make the upconverter circuit simpler and more efficient and will allow you to make a virtual ground for the lamp (see below). <br><br>  Now about connecting the lamp.  The heating leads (4 and 5) of the 6E1P lamp are isolated from the rest of the lamp leads, so you can connect them as you please, the main thing is that there is a voltage of about 6V between them.  Can be constant, can be variable.  Only in the case of the use of TAN, it is recommended to make a tightening of conclusions 4 and 5 to conclusion 2 (ground) in order to exclude the breakdown between the heat and the cathode.  Pins 3, 7, 8, 9 are connected to high voltage.  And now, the most interesting thing - pin 1 (grid) controls the opening of the lamp with the help of negative voltage!  Voltage -12 ... -15V on the grid relative to the cathode corresponds to the full disclosure of the lamp, and voltage 0 - full closure.  And even worse, in reality, when the grid is grounded to the cathode, the lamp does not fully close: instead of a thin even luminous strip, there is a bold luminous cone.  This is solved by applying a small positive voltage to the grid (+ 5V is enough).  Thus, the lamp is controlled by voltage relative to the cathode from -15V to + 5V.  That, to put it mildly, is uncomfortable. <br><br><div class="spoiler">  <b class="spoiler_title">Power scheme</b> <div class="spoiler_text">  And so, the microcontroller power circuit (+ 5V) looks like this: <br><br><img src="https://habrastorage.org/files/011/afa/5e8/011afa5e825b4b8382fc6582f9d7f42d.jpg"><br><br>  One of the TAN windings at ~ 20V was used.  Rectifier assembled at + 28V.  Chip is used low-power pulser TPS62120.  The chip was available and has small dimensions, so the choice fell on her, but her maximum input voltage is 15V.  Therefore, the voltage from 28V to 15V falls on the limiting resistor R4 and additionally protects the microcircuit Zener diode to 15V.  I cannot recommend such a hybrid power supply for repetition, but, nevertheless, it works stably for a current of 10 mA.  Having a zener diode is better to assemble a <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2582%25D0%25B0%25D0%25B1%25D0%25B8%25D0%25BB%25D0%25B8%25D0%25B7%25D0%25B0%25D1%2582%25D0%25BE%25D1%2580_%25D0%25BD%25D0%25B0%25D0%25BF%25D1%2580%25D1%258F%25D0%25B6%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F">parametric stabilizer</a> . <br>  Voltage + 28V I use to control the lamp.  Voltage + 5V is used to power the rest of the board (amplifiers, microcontroller, potentiometer). <br>  To control the lamp, we create a virtual ground + 21V with the following scheme: <br><img src="https://habrastorage.org/files/d3d/796/136/d3d7961361fe43c9ab4e93fef7e2675b.jpg"><br>  We use power + 28V and with the help of a stabilitron on 21V we create a virtual ground AMP_GND on + 21V.  It is this virtual earth that needs to be connected to pin 2 of the lamp.  This is possible because all windings of the TAN are insulated, and the earth of the board is not connected to the earth of the lamp supply (+ 250V).  Then to control the lamp we get the voltage range from -21V to + 7V. <br>  In case you use power from a 24V power adapter and generate a high voltage with a pulse source, then form a virtual earth of about 18V with the same exact circuit (replacing the zener diode with 18V). <br></div></div><br><h2></h2><h4>  PART 2. ANALOG CHANNEL DIAGRAM </h4><br>  Let's turn to the audio signal conversion circuit.  The audio channel should provide the summation of the signal from two channels and bringing it to the input range of the controller's ADC (signal range not exceeding 5V). <br><br><img src="https://habrastorage.org/files/956/ef6/8ca/956ef68cab0a4b1893f208e77435d9c2.jpg"><br><br>  We have two channels.  Since when connecting any circuit, it distorts the source signal, and the amplifier's output is the least sensitive to this, we connect directly to the amplifier's output (parallel to the load, to the headphones).  The signal is decoupled on a constant by input capacitors 0.1 microfarad.  Diodes VD4 and VD5 are to protect the circuit from possible surges on the input.  Next on each channel is a inverting amplifier (DA1A and DA1B) with a gain of 0.34.  They perform 2 tasks.  Firstly, for high-impedance headphones, the signal swing is reduced by 3 times, leading it to the 5V range.  Since, for example, for a 600 ohm headphone, the signal sweep can be up to 16V.  Secondly, they serve as buffer amplifiers for the subsequent adder.  If they did not exist, and the signal was immediately sent to the adder, then, in fact, both channels would be connected to each other through 20 kOhm resistors to each other, which would worsen channel separation. <br><br>  Next, the signal goes to the adder and the amplifier with auto-tuning (DA1C).  The gain can vary from 1 to 1000. The digital potentiometer AD5160 is one of the most readily available and cheapest.  He has 256 positions.  The amplifier is selected AD8608 quadrupled case.  The last fourth amplifier (DA1D) used to create a virtual earth + 2.5V: <br><br><img src="https://habrastorage.org/files/f65/ac4/57c/f65ac457ca9142699dfce7d107a8824a.jpg"><br><br>  In principle, a similar scheme could be made for the virtual earth + 21V lamp. <br><br><h2></h2><h4>  PART 3. MANAGEMENT DIAGRAM </h4><br>  ATiny25 / 45 is selected as a microcontroller.  Productivity sufficient for this task, food 5V, the small case.  Usually, programming the AVR8 family of controllers is simple and intuitive, but the ATiny25 / 45 is an ultra-low integration controller with almost no hardware blocks.  Therefore, the work with the ATiny25 / 45 universal transceiver is not pleasant: almost everything has to be done programmatically. <br><br><img src="https://habrastorage.org/files/e0a/965/4a8/e0a9654a891e4207aa6d063264481987.jpg"><br><br>  The 6E1P lamp control circuit itself is built on an IRLML2803 field-effect transistor and is a simple PWM with a low-pass filter.  Transistor switches voltage + 28V or ground.  Regarding the output of 2 lamps, it will be + 7V or -21V. <br><br>  Also in my device I decided to add a miniature dual relay for switching.  With the help of it, I commute the anode voltage of the amplifier after the lamps warm up and control the LED in the power switch, changing its color from red to green after warming up.  There is one special feature in this: the PB5 port of the controller is used as a RESET and is not available until the corresponding FUSE bit is flashed, but after its firmware programming via SPI will become impossible.  So we activate the PB5 port at the very last turn, when everything is debugged and works as it should. <br><br><h2></h2><h4>  PART 4. MANAGEMENT ALGORITHM </h4><br>  As a result of lengthy experiments with various audio signal processing methods and selection of various parameters, the best option was found, which gives good visualization.  Anyone can develop their own regulation algorithm, which would be better suited to its hardware solution or to listen to music content. <br><br>  My method includes: pre-filtering the signal, determining the local maxima of the signal, generating a lamp control signal, controlling the gain of the amplifier. <br><br>  Now in order I will describe the operation of the algorithm. <br><ol><li>  The total signal of both channels is read by the ADC with the maximum sampling rate for this microcontroller - 77kSPS. </li><li>  The signal is filtered.  A simple method is used to calculate the average of 4 counts.  Thus, we reduce the sampling rate to 19.2kSPS. </li><li>  The signal is variable with a constant component of + 2.5V (0x7f).  Straighten it (subtracting 0x7f) and remove the noise near zero. </li><li>  Based on accumulated 5 counts (averaged), a local maximum (peak) is searched using a sliding window, which reduces the frequency bandwidth to about 2.4 kHz. </li><li>  We adjust the PWM output to the lamp depending on the peak value obtained.  I introduced the regulation with asymmetric constraint.  Those.  I increase PWM with a big step, and I decrease with a small one. </li><li>  Adjust the gain with a digital potentiometer.  Algorithm of regulation I propose the following: </li></ol><br><ul><li>  a) We find the maximum of all the peaks at a certain time interval.  In my version, on average, this interval is about 300ms. </li><li>  b) If at this interval the maximum peak is more than 90% of the input range, then decrease the gain. </li><li>  c) If at this interval the maximum peak is less than 50% of the input range, then increase the gain. </li><li>  d) The proposed analog circuit has the following drawback: the regulation of the gain is non-linear due to the applied method of switching on the potentiometer.  Especially strong non-linearity with high gain, i.e.  changing the potentiometer by one step leads to a multiple increase in the gain and, as a result, to overload the input of the ADC.  Therefore, I had to abandon the use of the last few steps of the potentiometer (254 and 255), and instead amplify the signal, simply multiplying it by 2 √∑ 8. </li></ul><br>  Real oscilloscope measurements showed that the algorithm, on average, updates the PWM data with a frequency of 1 kHz.  The frequency floats strongly and depends on the amplitude of the input signal.  But, in any case, the update of the PWM data occurs at least with a frequency of 100 Hz, which is sufficient for good visualization.  The gain change occurs from 2 to 10 times per second. <br><br>  The microcontroller firmware project (ATiny45) for IAR v6.3 and the layout for Altium Designer 2009 are located at: <br>  <a href="https://bitbucket.org/AiV_Electronics/6e1p_tube/overview">https://bitbucket.org/AiV_Electronics/6e1p_tube/overview</a> <br><br><h2></h2><h4>  PART 5. RESULT </h4><br><div class="spoiler">  <b class="spoiler_title">Video with the result of the lamp for different musical compositions</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/NL52b8G6hMk%3Ffeature%3Doembed&amp;xid=17259,15700019,15700043,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiz8CCsNkV7ib9JPbHEzDXpvNSVhA" frameborder="0" allowfullscreen=""></iframe><br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/YmYs7FmPmek%3Ffeature%3Doembed&amp;xid=17259,15700019,15700043,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgJW0X0iD8MToMMWUa5IUTU_bryyg" frameborder="0" allowfullscreen=""></iframe><br></div></div><br>  The lamp responds well to both high-pitched and low-pitched sounds.  Works out clearly, without delay.  The magnitude of the response is adequate to the volume of the sound.  On this I consider the task as solved. <br><br>  I want to note that, although this option is final and no further refinement is planned, however, this version leaves room for improvement.  If the task of refinement had come together before me, I would improve the scheme in the following points: <br><ol><li>  Would change the power supply circuit to fully pulsed.  Linear stabilizer would not be set, because  transformer winding produces only 47mA. </li><li>  Would change the potentiometer circuit to eliminate non-linearity. </li><li>  Would use a parametric stabilizer to form a virtual ground + 21V and reduce the capacitors C18-C20. </li></ol><br><br>  That's all for now.  In the future I plan to write an article on the manufacture of the mechanical part of the amplifier and share my experience in manufacturing REA cases made of wood, manufacturing parts from sheet metal, painting, varnishing and marking through stencils and dies. <br><br>  Thanks for attention.  Waiting for your questions and comments. <br><br>  PS I worry in advance that the topic could develop into a discussion of tube audio and audio quality issues.  Therefore, I ask you to discuss only issues related to the visualization of the audio signal.  Thank you in advance. </div><p>Source: <a href="https://habr.com/ru/post/259099/">https://habr.com/ru/post/259099/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259085/index.html">John Forbes Nash died</a></li>
<li><a href="../259087/index.html">Basic troubleshooting in VMware vSphere or what to do if VM slows down</a></li>
<li><a href="../259089/index.html">How large companies organize the Common Customer Service Center (SSC)</a></li>
<li><a href="../259093/index.html">How we modernized the portal yota.ru</a></li>
<li><a href="../259095/index.html">Sexy primes, "slow python" or how I fought against the wall of misunderstanding</a></li>
<li><a href="../259101/index.html">Yandex research - true or fiction?</a></li>
<li><a href="../259103/index.html">Launch BIGIP Trial Edition for Oracle VirtualBox</a></li>
<li><a href="../259105/index.html">Cones on matryoshka</a></li>
<li><a href="../259107/index.html">Centos-admin.ru: learn Ansible</a></li>
<li><a href="../259111/index.html">We connect Microsoft Azure and a cloud of service provider in a uniform network</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>