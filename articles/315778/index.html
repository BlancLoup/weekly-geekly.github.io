<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementing DMARC to protect your corporate domain from spoofing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A Thief on the Run by Manweri 

 Hi, Habr! In this post we will again talk about the problem of the fake sender (or the so-called spoofing). Recently,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementing DMARC to protect your corporate domain from spoofing</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/e2f/e0b/659/e2fe0b659cc64833bcfc2bb3f7b4b718.jpg" alt="A Thief on the Run by Manweri"><br>  <a href="http://manweri.deviantart.com/art/A-Thief-on-the-Run-577760957">A Thief on the Run</a> by Manweri <br><br>  Hi, Habr!  In this post we will again talk about the problem of the fake sender (or the so-called spoofing).  Recently, such cases have become very frequent: everything is forged: letters with bills for housing and communal services, from the tax inspectorate, banks, and so on.  Configuring a strict DMARC policy helps solve this problem.  We, as a postal service, check all incoming letters to DMARC since February 2013.  We were the <a href="https://corp.mail.ru/ru/press/releases/8736/">first mail service in runet</a> that supported the DMARC standards.  However, to minimize the number of fake letters, this, unfortunately, is not enough.  The main thing is that strict DMARC is supported on the sender's side.  That is why we do not get tired to download this topic, we are actively engaged in explanatory work and strongly urge everyone to include strict DMARC. <br><br>  Positive shifts are already there: every month we see a 10 percent increase in the number of corporate senders who have registered DMARC.  However, of course, there is still something to work on.  Practice shows that IT culture is at a very different level.  Someone heard vaguely about DMARC, but is not going to introduce it yet.  There are those for whom the fact that there is no verification and protection of the sender's address in the transport protocols of e-mail is still a real revelation.  In addition, support for DMARC is not an easy task.  Only at first glance it seems that it is enough to publish the record in the DNS, and no additional software or hardware is required (for more details, see our <a href="https://habrahabr.ru/company/mailru/blog/170957/">DMARC</a> article <a href="https://habrahabr.ru/company/mailru/blog/170957/">: protect your mailing from fakes</a> ).  In practice, in a large company with numerous e-mail flows and a spreading structure of e-mail domains, everything is much more complicated.  And there are moments that should be foreseen and thought out in advance.  For such difficult cases, we wrote this article, trying to collect all the nuances in it. <br><a name="habracut"></a><br>  We want to share our own experience of implementing DMARC and all the rakes we stepped on (crossed out) with the recommendations that we developed in cooperation with large companies and government agencies.  We will consider only the implementation of the DMARC policy to protect a domain name.  Implementing the server part of DMARC to protect corporate mail server users from fake emails is a separate, completely independent and independent process. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      DMARC is a policy of actions with incoming letters that have a policy publishing domain in the From field.  DMARC allows you not only to specify how to deal with such letters, but also to collect statistics from all recipients who support the server part of DMARC. <br><br>  The main problem is that DMARC requires the authorization of all legitimate emails.  And for this, it is necessary not only to implement authorization methods (SPF and DKIM are used as basic protocols), but also to ensure that for all legitimate emails with return addresses of the domain to pass, the authorization takes place.  Therefore, the introduction of DMARC should begin with the following paragraph. <br><br><h2>  1. Audit legitimate emails from your domain and its subdomains </h2><br>  Typical omissions in this process: <br><br><ul><li>  commercial letters sent through external mailing service providers; </li><li>  internal mailing lists; </li><li>  redirection of mail from user boxes; </li><li>  technological letters generated by servers and equipment; </li><li>  delivery reports (DSN) or undeliverable (NDR) letters. </li></ul><br>  For each category of letters, it is necessary to implement SPF and find out whether it is possible or impossible to sign letters using DKIM. <br><br><h2>  2. Implement SPF for the main domain and its subdomains </h2><br>  You can often hear that SPF protects the sender's address from being fake.  This is not true.  SPF only controls the address of the SMTP envelope that the user does not see.  However, a large number of domains have not yet implemented it, and many parties do not support SPF-compatible mail forwarding.  For this reason, neutral SPF (neutral <code>?</code> ) Or soft blocking (soft reject, <code>~</code> ) is most often used.  For sharing with DMARC, it does not matter which default policy (neutral <code>?</code> Soft reject <code>~</code> or reject <code>-</code> ) SPF will be used.  We do not recommend using the reject ( <code>-</code> ) policy with the exception of highly security-sensitive domains, as this may adversely affect the delivery of legitimate emails in indirect ways, such as through mailing lists or mailing lists.  Although most recipients do not block SPF emails even when they publish strict policies, they use SPFs as part of weight classifiers.  Contrary to popular belief, it is this SPF regime that is most often used in practice, and it fully complies with the recommendations of the standard. <br><br>  You can make the following recommendations for the implementation of SPF: <br><br><ul><li>  Do not forget that SPF is checked for the domain from the envelope-from address (it is MAIL FROM and Return-Path).  In order for SPF to be used to authenticate the sender of the message, the domain in the envelope-from must match the domain of the From header with an accuracy of the organizational domain (that is, the second level domain in .ru or .com).  Using invalid addresses for envelope-from is one of the most common server configuration errors, CMS and server-side scripts. <br><br></li><li>  In SMTP, some categories of letters ( <a href="https://ru.wikipedia.org/wiki/%25D0%2592%25D0%25BE%25D0%25B7%25D0%25B2%25D1%2580%25D0%25B0%25D1%2589%25D1%2591%25D0%25BD%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25BF%25D0%25B8%25D1%2581%25D1%258C%25D0%25BC%25D0%25BE">NDR</a> , <a href="https://tools.ietf.org/html/rfc1894">DSN</a> ) have an empty envelope-from address.  For such letters, authentication is performed on the domain that the sender's SMTP server uses in the HELO / EHLO command and which, as a rule, is the same as the canonical server name.  Incorrect names in the HELO command is another common problem.  Make sure that the domain name in HELO is correct, and list the appropriate SPF policy for it, for example, <code>mailserver.example.org. TXT "v=spf1 a -all"</code>  <code>mailserver.example.org. TXT "v=spf1 a -all"</code> .  In messages about the impossibility of delivery in the sender's address, you can either not specify the domain at all (for example, <code>From: mailer-daemon:;</code> ) or use a domain that matches the HELO domain with an accuracy of the organization's domain (usually a second-level domain, for example, <code>From: mailer-daemon@example.org</code> ). <br><br></li><li>  Do not forget that SPF does not affect subdomains.  You need to implement it for each subdomain or resort to <a href="https://en.wikipedia.org/wiki/Wildcard_DNS_record">wildcards DNS</a> . <br><br></li><li>  SPF has a limit of 10 name permissions per record.  Therefore, you should minimize the use of elements that lead to additional permissions, such as <code>mx</code> and <code>include</code> .  For example, for the <code>mx</code> element, one additional request is required to receive the MX record itself and one request for each server in the MX record to obtain its IP address by name. </li></ul><br><h2>  3. Publish a DMARC record with a policy of none for the main domain and subdomains. </h2><br>  An example of such a record: <br><br><pre> <code class="hljs perl">_dmarc.example.com. TXT <span class="hljs-string"><span class="hljs-string">"v=DMARC1;p=none;rua=mailto:rua@example.com;ruf=mailto:ruf@example.com;fo=s"</span></span></code> </pre> <br>  The record instructs the recipient to send daily statistical reports to <code>rua@example.com</code> .  From the reports you will see all the IP addresses from which mailings were sent from your domain name, and the authorization status of SPF, DKIM and DMARC for these letters.  Especially carefully follow the letters from your IP-addresses.  Check the reports to see if you have missed any categories of letters or their sources in your audit.  Adjust the SPF if necessary.  Some recipients may send reports on individual cases of problems with SPF ( <code>fo=s</code> ) to the address <code>ruf</code> , these reports will be useful for identifying problem mailings. <br><br>  Typical problems and recommendations: <br><br><ul><li>  We do not recommend publishing a policy even with the <code>none</code> tag until at least one of the SPF or DKIM authentication mechanisms is implemented for the main mail flows. </li><li>  The entry must begin with v = DMARC1, and the case of letters matters. </li><li>  Some DNS clients show back slashes before the semicolon <code>v=DMARC1\;p=none</code> - but you don‚Äôt usually need to add a backslash in the records of the DNS zone. </li><li>  The rua / ruf addresses must belong to the same organizational domain for which the policy is published, or the receiving domain must publish a special policy showing consent to receive reports.  It will not be possible to accept reports to addresses, for example, public mails. </li><li>  If you have not completed the implementation of DKIM, then you will receive quite a lot of DMARC violations from public mail IP addresses (Mail.Ru, Gmail, Hotmail / Outlook, Yahoo, etc.).  This is due to the fact that users of these services often use redirections to other mailboxes, and this leads to a violation of SPF authentication.  The problem is solved by the introduction of the DKIM signature. </li><li>  There are some good tools for visualizing DMARC reports.  <a href="https://dmarcian.com/">Dmarcian</a> provides both free and paid (for small volumes of mail) services, and a convenient and convenient free <a href="https://dmarcian.com/dmarc-xml/">XML-To-Human Converter</a> tool for viewing DMARC reports.  <a href="https://www.agari.com/">Agari</a> and <a href="https://www.proofpoint.com/us/products/email-fraud-defense/">proofpoint</a> also offer commercial services for implementing and maintaining DMARC. </li></ul><br><h2>  4. Implement DKIM </h2><br>  Recommendations: <br><br><ul><li>  Make sure that the letters generated by the servers comply with the recommendations on the structure, encodings and number of headers, otherwise it is possible that when transmitted by the mail relay the letter will be changed to bring it into compliance with the standards (most often breakdown of long strings occurs), which causes the DKIM signature to be broken. </li><li>  Use a key with a length of 1024 or 2048 bits. </li><li>  Make sure your DNS server supports resolution of large records.  Usually, in addition to access to the server via UDP / 53, it is necessary to additionally allow access via TCP / 53.  Make sure that the TXT record with the DKIM key is correctly resolved from external networks. </li><li>  Use the relaxed / relaxed canonization mode, it is less likely to cause problems with the normalization of the letter during transmission. </li><li>  Do not sign headers that change upon message delivery (such as Received: and Return-Path :), make sure that mandatory headers (Date :, Message-ID :, From :) are formed before applying DKIM signatures </li><li>  Implement DKIM on all sources of letters for all subdomains. </li><li>  Use separate selectors with separate keys for external sources (mail sending service providers) so that you can revoke the key if necessary. </li><li>  For DMARC, it is necessary that the domain used in the DKIM signature matches up to the organizational domain with the domain from the From header.  Other DKIM signatures may be present, but they will be ignored. </li><li>  Monitor the implementation of DKIM from statistical reports from external services. </li><li>  Use <code>fo=1</code> in the DMARC policy, this will allow you to receive forensic reports on all problems with SPF and DKIM, even for letters that are authorized by DMARC. </li></ul><br><h2>  5. Start switching to strict policies. </h2><br>  Do not use the quarantine policy for a long time, as it may mask the existing problems.  You are guaranteed to learn about the existence of problems only from aggregated reports, which may take more than a day to get. <br><br>  You can start by turning on the reject policy at 10% ( <code>p=reject; pct=10</code> ) to track potential problems with delivery errors.  But it is not recommended to keep such a policy for a long time: the quarantine policy will be applied for the remaining 90% of the operations, and you can skip isolated problems <br><br>  Be sure to follow the server logs and reports about the inability to deliver letters for errors related to DMARC.  The standard recommends that recipients implementing the server part of DMARC be sure to include it as the cause in the error message, so you can use ‚ÄúDMARC‚Äù as the key word in the error message to identify the problem.  According to the server logs, you will see the problem much earlier than the reports and you will know exactly which addresses which emails were not delivered. <br><br>  You can implement a policy that is different from the policy of the main domain on separate subdomains by publishing separate policies for them or specifying the policy of the main domain ( <code>p=none; sp=reject</code> ): the sp policy will affect subdomains that do not publish their own policies. <br><br>  When all subdomains are transferred to a strict policy, you can remove the policy of subdomains - or leave, at your discretion.  This only affects the generation of reports in accordance with established practice (in the standard, this point is not negotiated).  If a subdomain publishes its policy, separate reports will come to it;  if there is no separate policy, then reports on the subdomain will be included in the report of the parent domain. <br><br><h2>  6. Tuning DMARC policy </h2><br>  Below is an analysis of some optional DMARC entry fields, examples and recommendations for their use. <br><br>  <b>p</b> ( <code>p=reject</code> ) - DMARC policy.  Tells the recipient how to deal with unauthenticated emails.  It can be <code>none</code> (deliver letters to the recipient), <code>quarantine</code> (deliver letters to the Spam folder) and <code>reject</code> (not accept letters). <br><br>  <b>sp</b> ( <code>sp=quarantine</code> ) is a policy for subdomains that do not publish independent policies.  If the subdomain has its own DMARC policy, then <code>sp</code> does not affect it.  If there is no <code>sp</code> field in the DMARC entry for subdomains that do not have their own policy, the policy from the <code>p</code> field is applied. <br><br>  <b>pct</b> ( <code>pct=20</code> ) - the percentage of emails that this policy applies to.  For example, if you set a <code>reject</code> policy with <code>pct=20</code> <code>reject</code> policy will be applied to the received letter with a probability of 20% and a <code>quarantine</code> policy with a probability of 80%. <br><br>  <b>rua</b> ( <code>rua=mailto:ruamailbox@example.com</code> ) - the address to which recipients will send an aggregated (statistical) report.  The address must belong to the same organizational domain.  We recommend that you always publish an address for aggregated reports and monitor them at least during the implementation phase of the DMARC policy. <br><br>  <b>ruf</b> ( <code>ruf=mailto:rufmailbox@example.com</code> ) is the address to which forensic reports (that is, research reports) will be sent by individual letters.  By default, forensic reports are sent only for DMARC violations.  You can use the fo option to regulate behavior.  Currently, a relatively small number of recipients send forensic reports. <br><br>  <b>fo</b> ( <code>fo=1</code> ) - for what violations to send notifications.  <code>fo=0</code> (default behavior) sends reports only when both authentication fails: SPF and DKIM.  <code>fo=1</code> - when any of the authentication fails, even if an alternative method passes.  <code>fo=s</code> sends forensic reports on problems with SPF authentication.  <code>fo=d</code> - for DKIM problems. <br><br>  <b>adkim</b> ( <code>adkim=r</code> ) - mode for checking compliance with the DKIM domain.  The default mode is <code>r</code> (relaxed) and only the organizational domain should match.  In strict ( <code>s</code> ) mode, a complete match of the domain from the sender's address to the domain from the DKIM signature is required.  It makes sense to use strict domain matching, if part of your subdomains are delegated to untrusted parties. <br><br>  <b>aspf</b> ( <code>aspf=r</code> ) - similarly for the domain from envelope-from, for which SPF and From is checked.  For <code>aspf=s</code> these domains must be exactly the same in order to pass SPF authentication. <br><br>  <b>ri</b> ( <code>ri=86400</code> ) - the desired interval for receiving aggregated reports (in seconds).  By default, reports are sent once a day, but some recipients (not all, because the server does not support this parameter) support sending reports at shorter intervals.  At the stage of policy implementation, you can try using smaller ri, for example <code>ri=3600</code> . <br><br>  We are very pleased that domain owners have begun to think about protecting their domain name in electronic correspondence.  Help on setting up DMARC is available <a href="https://help.mail.ru/mail-help/postmaster/dmarc">here</a> .  If you have questions or need advice or help with setting up SPF, DKIM, DMARC, contact <a href="">dmarc_support@corp.mail.ru</a> or ask a question here.  We hope that together we can make email safer for all users. </div><p>Source: <a href="https://habr.com/ru/post/315778/">https://habr.com/ru/post/315778/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../315768/index.html">Dart Developer Summit 2016: Top Dart News</a></li>
<li><a href="../315770/index.html">JIT-enabled Qemu.js: minced meat can still be turned back</a></li>
<li><a href="../315772/index.html">React.js State of the art (interview with Max Stoiber)</a></li>
<li><a href="../315774/index.html">Here tuk open</a></li>
<li><a href="../315776/index.html">KPI for the elite, or business consultants against small business</a></li>
<li><a href="../315780/index.html">ASP.NET Core: Your first Mac application using Visual Studio Code</a></li>
<li><a href="../315782/index.html">Siri + Zway + Homebridge = Start Engine</a></li>
<li><a href="../315786/index.html">Implementation of guaranteed asynchronous message delivery</a></li>
<li><a href="../315788/index.html">We test seamless WiFi using voice traffic</a></li>
<li><a href="../315790/index.html">How are you zadolbali with their alerts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>