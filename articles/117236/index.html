<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I struggled with the encodings in the console</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once again, running my script informer for SamIzdat in Windows and seeing the ‚Äúmysterious characters‚Äù in the console , I said to myself: ‚ÄúYes, finally...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I struggled with the encodings in the console</h1><div class="post__text post__text-html js-mediator-article">  Once again, running my script informer for <a href="http://zhurnal.lib.ru/">SamIzdat</a> in Windows and seeing the <a href="http://ru.wikipedia.org/wiki/%25D0%259A%25D1%2580%25D0%25B0%25D0%25BA%25D0%25BE%25D0%25B7%25D1%258F%25D0%25B1%25D1%2580%25D1%258B">‚Äúmysterious characters‚Äù</a> in the console <a href="http://ru.wikipedia.org/wiki/%25D0%259A%25D1%2580%25D0%25B0%25D0%25BA%25D0%25BE%25D0%25B7%25D1%258F%25D0%25B1%25D1%2580%25D1%258B">,</a> I said to myself: ‚ÄúYes, finally, make yourself a normal cross-platform logging!‚Äù <br><br>  About it, and how to color a log output like Django-vsky in Win32 I will try to tell under a habr-kat <sub>(Everything</sub> written below is <sub>applicable to Python 2.x to a branch)</sub> <br><a name="habracut"></a><br><h5>  Task one.  Correct text output to the console </h5><br><h6>  Symptoms </h6><br>  As long as we do not make any ‚Äúcorrections‚Äù to the initialized I / O system and use only the <i>print</i> operator with unicode strings, everything goes more or less normally regardless of the OS. <br><br>  ‚ÄúMiracles‚Äù start further - if we change any encodings (see a little further) or use the logging module for displaying on the screen.  It seems that by setting the expected behavior in Linux, in Windows you get garbage in utf-8.  You start to rule under Win - 1251 gets out in the console ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h6>  Theoretical excursion </h6><br>  Several parameters are responsible for the parameters for converting characters and outputting them to the console: <br><ul><li> The default encoding of the <code>sys</code> module is <code>sys.getdefaultencoding()</code> </li><li>  The preferred encoding for the current locale is <code>locale.getpreferredencoding()</code> </li><li>  Encoding standard streams <code>sys.stdout, sys.stderr</code> </li><li>  Some confusion is made by the encoding of the file itself, but agree that everything is unified and all files are utf-8 and contain the correct header </li><li>  The ‚Äúbonus‚Äù is the love of standard threads to throw exceptions if, even with a correctly set encoding, there is no necessary character when printing a unicode string </li></ul><br><h6>  We are looking for a solution </h6><br>  Obviously, to get rid of all these problems, you must somehow bring them to uniformity. <br>  And here the most interesting begins: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- &gt;&gt;&gt; import sys &gt;&gt;&gt; import locale &gt;&gt;&gt; print sys.getdefaultencoding() ascii &gt;&gt;&gt; print locale.getpreferredencoding() # linux UTF-8 &gt;&gt;&gt; print locale.getpreferredencoding() # win32/rus cp1251 #   : &gt;&gt;&gt; print sys.stdout.encoding # linux UTF-8 &gt;&gt;&gt; print sys.stdout.encoding # win32 cp866</span></span></code> </pre><br>  Aha  It turns out that the ‚Äúsystem‚Äù lives in general in ASCII.  As a result, the attempt to work with input / output in a simple way ends with the ‚Äúfavorite‚Äù exception <code>UnicodeEncodeError/UnicodeDecodeError</code> . <br><br>  In addition, as is remarkably evident from the example, if on linux we have utf-8 everywhere, then on Windows there are two different encodings - the so-called ANSI, also cp1251, used for the graphic part and OEM, it is also cp866, for displaying text in console.  OEM encoding has come to us since DOS, and, theoretically, it can also be reconfigured by special teams, but in practice no one has been doing this for a long time. <br><br>  Until recently, I used a common way to fix this trouble: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- # ============== # Main script file # ============== import sys reload(sys) sys.setdefaultencoding('utf-8') #  import locale sys.setdefaultencoding(locale.getpreferredencoding()) # ...</span></span></code> </pre><br>  And this, in general, worked.  Worked until used <code>print</code> th.  When you go to the output to the screen through <code>logging</code> everything is broken. <br>  Yeah, I thought, since "it" uses the default encoding, I will set the same encoding as in the console: <br><pre> <code class="python hljs">sys.setdefaultencoding(sys.stdout.encoding <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> sys.stderr.encoding)</code> </pre><br>  Already a little better, but: <br><ul><li>  In Win32, the text is printed with sharp-edges, clearly resembling cp1251 </li><li>  When starting with redirected output, again we get not what was expected. </li><li>  Periodically, when trying to print text, where there is a character converted to unicode type  ( <code>&amp;#x2460;</code> ), ‚Äúkindly‚Äù added by the author to any title, again we get <code>UnicodeEncodeError</code> ! </li></ul><br>  Looking closely at the first example, it is easy to see that the desired cp866 encoding can only be obtained by checking the attribute of the corresponding stream.  And he is not always available. <br>  The second part of the task is to leave the system encoding in utf-8, but correctly configure the output to the console. <br>  To customize the output, you need to override the processing of output streams like this: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> codecs sys.stdout = codecs.getwriter(<span class="hljs-string"><span class="hljs-string">'cp866'</span></span>)(sys.stdout,<span class="hljs-string"><span class="hljs-string">'replace'</span></span>)</code> </pre><br>  This code allows you to kill two birds with one stone - set the desired encoding and protect yourself from exceptions when printing any umlauts and other typography, which is absent in 255 cp866 characters. <br>  It remains to make this code universal - how can I know the OEM encoding on an arbitrary spherical computer?  Googling for ready support for ANSI / OEM coding in python did not give anything sensible, therefore I had to remember a little WinAPI <br><pre> <code class="hljs objectivec"><span class="hljs-built_in"><span class="hljs-built_in">UINT</span></span> GetOEMCP(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   OEM     UINT GetANSICP(void); //    ANSI  </span></span></code> </pre><br>  ... and put everything together: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- import sys import codecs def setup_console(sys_enc="utf-8"): reload(sys) try: #  win32     if sys.platform.startswith("win"): import ctypes enc = "cp%d" % ctypes.windll.kernel32.GetOEMCP() #</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">   win64/python64 else: #  Linux , ,    enc = (sys.stdout.encoding if sys.stdout.isatty() else sys.stderr.encoding if sys.stderr.isatty() else sys.getfilesystemencoding() or sys_enc) #   sys sys.setdefaultencoding(sys_enc) #    ,     if sys.stdout.isatty() and sys.stdout.encoding != enc: sys.stdout = codecs.getwriter(enc)(sys.stdout, 'replace') if sys.stderr.isatty() and sys.stderr.encoding != enc: sys.stderr = codecs.getwriter(enc)(sys.stderr, 'replace') except: pass # ?    -  -...</span></span></code> </pre><br><h5>  Task two.  Color the output </h5><br>  Looking at the debug output of Dzhangi in conjunction with werkzeug, I wanted something similar for myself.  <a href="http://www.google.com/search%3Fq%3Dpython%2Bcolored%2Blogging">Googling</a> produces several projects of varying degrees of development and convenience - from the simplest heir to <code>logging.StreamHandler</code> , to a certain set, when importing automatically replacing the standard StreamHandler. <br><br>  Having tried several of them, I, as a result, used the simplest heir of StreamHandler, cited in one of the comments on <a href="http://stackoverflow.com/questions/384076/how-can-i-make-the-python-logging-output-to-be-colored">Stack Overflow</a> and so far I am quite pleased: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ColoredHandler</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">( logging.StreamHandler )</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">emit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( self, record )</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># Need to make a actual copy of the record # to prevent altering the message for other loggers myrecord = copy.copy( record ) levelno = myrecord.levelno if( levelno &gt;= 50 ): # CRITICAL / FATAL color = '\x1b[31;1m' # red elif( levelno &gt;= 40 ): # ERROR color = '\x1b[31m' # red elif( levelno &gt;= 30 ): # WARNING color = '\x1b[33m' # yellow elif( levelno &gt;= 20 ): # INFO color = '\x1b[32m' # green elif( levelno &gt;= 10 ): # DEBUG color = '\x1b[35m' # pink else: # NOTSET and anything else color = '\x1b[0m' # normal myrecord.msg = (u"%s%s%s" % (color, myrecord.msg, '\x1b[0m')).encode('utf-8') # normal logging.StreamHandler.emit( self, myrecord )</span></span></code> </pre><br>  However, in Windows all this, of course, refused to work.  And if earlier it was possible to ‚Äúenable‚Äù the support of ansi-codes in the console by adding the ‚Äúmagic‚Äù ansi.dll from the symfony project somewhere in the depths of the Windows system folders, then starting (it seems) with Windows 7, this feature is finally ‚Äúcut out‚Äù from the system .  Yes, and forcing the user to copy some dll in the system folder is also somehow "not kosher." <br><br>  Again, we turn to Google and, again, we get several solutions.  One way or another, all options are reduced to replacing the output of ANSI escape sequences by calling WinAPI to manage console attributes. <br><br>  After wandering for some time on the links, I came across a project <a href="http://pypi.python.org/pypi/colorama">colorama</a> .  He somehow liked me more than the rest.  The advantages of this particular project should be attributed to the fact that the entire console output is replaced - you can display colored text with a simple <code>print u"\x1b[31;40m-   \x1b[0m"</code> if you suddenly want to pervert. <br><br>  Immediately, I note that the current version 0.1.18 contains an annoying <a href="http://code.google.com/p/colorama/issues/detail%3Fid%3D21">bug</a> that breaks the output of unicode strings.  But I gave the simplest solution in the same place when creating the issue. <br><br>  Actually, it remains to combine both wishes and start using instead of the traditional ‚Äúcrutches‚Äù: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- import sys import codecs import copy import logging #: Is ANSI printing available ansi = not sys.platform.startswith("win") def setup_console(sys_enc='utf-8', use_colorama=True): """ Set sys.defaultencoding to `sys_enc` and update stdout/stderr writers to corresponding encoding .. note:: For Win32 the OEM console encoding will be used istead of `sys_enc` """ global ansi reload(sys) try: if sys.platform.startswith("win"): #... ,   if use_colorama and sys.platform.startswith("win"): try: #   colorama      `ansi`,    from colorama import init init() ansi = True except: pass class ColoredHandler( logging.StreamHandler ): def emit( self, record ): # Need to make a actual copy of the record # to prevent altering the message for other loggers myrecord = copy.copy( record ) levelno = myrecord.levelno if( levelno &gt;= 50 ): # CRITICAL / FATAL color = '\x1b[31;1m' # red elif( levelno &gt;= 40 ): # ERROR color = '\x1b[31m' # red elif( levelno &gt;= 30 ): # WARNING color = '\x1b[33m' # yellow elif( levelno &gt;= 20 ): # INFO color = '\x1b[32m' # green elif( levelno &gt;= 10 ): # DEBUG color = '\x1b[35m' # pink else: # NOTSET and anything else color = '\x1b[0m' # normal myrecord.msg = (u"%s%s%s" % (color, myrecord.msg, '\x1b[0m')).encode('utf-8') # normal logging.StreamHandler.emit( self, myrecord )</span></span></code> </pre><br>  Further in the project, in the started file we use: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- from setupcon import setup_console setup_console('utf-8', False) #... #       import setupcon setupcon.setup_console() import logging #... if setupcon.ansi: logging.getLogger().addHandler(setupcon.ColoredHandler())</span></span></code> </pre><br><br>  That's all.  From the potential improvements, it remains to test the performance under win64 python and, possibly, to add ColoredHandler to check itself on isatty, as in more complex examples on the same StackOverflow. <br><br>  The final version of the resulting module can be <a href="http://dumpz.org/47667/">picked</a> up at <a href="http://dumpz.org/47667/">dumpz.org</a> </div><p>Source: <a href="https://habr.com/ru/post/117236/">https://habr.com/ru/post/117236/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../117226/index.html">We invite you to test virtual machines based on KVM</a></li>
<li><a href="../117229/index.html">Build a project without a single global variable</a></li>
<li><a href="../117230/index.html">Google SPDY: life after HTTP 1.1</a></li>
<li><a href="../117234/index.html">Use Google Voice Search in your .NET application.</a></li>
<li><a href="../117235/index.html">Interview with Opera's vice president of mobile browsers</a></li>
<li><a href="../117237/index.html">Expanding Java Applications</a></li>
<li><a href="../117238/index.html">Facebook vs Twitter</a></li>
<li><a href="../117239/index.html">Black developers: dismissed programmers return ... with devilish code</a></li>
<li><a href="../117241/index.html">Special cocktails for the MIX'11 conference!</a></li>
<li><a href="../117243/index.html">Kaspersky Crystal - domestic security combine</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>