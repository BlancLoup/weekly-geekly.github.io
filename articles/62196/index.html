<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>GoogleApps + Postfix + Fetchmail (OpenLdap + Postfix)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 Implementation  Platform  AltLinux 4, kernel version 2.6.18-std-smp-alt6. All packages were made from the official repository.  Install L...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>GoogleApps + Postfix + Fetchmail (OpenLdap + Postfix)</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://asktim.habrahabr.ru/blog/60759/">Prehistory</a> <br><h4>  Implementation </h4><h6>  Platform </h6>  AltLinux 4, kernel version 2.6.18-std-smp-alt6.  All packages were made from the official repository. <h6>  Install LDAP server </h6> Install the openldap-servers-2.3.35-alt0, libldap2.3-2.3.35-alt0, openldap-clients-2.3.35-alt0, openldap-2.3.35-alt0, openldap-doc-2.3.35-alt0 packages. <br>  We include additional schemas in the /etc/openldap/slapd.conf file: <a name="habracut"></a><br> <code>include /etc/openldap/schema/core.schema <br> include /etc/openldap/schema/cosine.schema <br> include /etc/openldap/schema/inetorgperson.schema <br> include /etc/openldap/schema/openldap.schema <br> include /etc/openldap/schema/nis.schema <br> include /etc/openldap/schema/courier.schema <br> include /etc/openldap/schema/qmail.schema <br> allow bind_v2 <br> concurrency 20 <br> gentlehup on <br> sizelimit -1 <br> password-hash {CLEARTEXT} <br> pidfile /var/run/slapd.pid <br> argsfile /var/run/slapd.args <br> replica-pidfile /var/run/slurpd.pid <br> replica-argsfile /var/run/slurpd.args <br> rootDSE /etc/openldap/rootdse.ldif <br> access to dn.exact="" <br> by * read <br> access to dn.subtree="cn=Subschema" <br> by * read <br> access to attrs=userPassword <br> by self write <br> by anonymous auth <br> by * none <br> modulepath /usr/lib/openldap <br> moduleload back_hdb.la <br> moduleload back_monitor.la <br> moduleload back_null.la <br> include /etc/openldap/slapd-hdb-db01.conf</code> <br>  Register our new ldap database in slapd-hdb-db01.conf: <br> <code>database hdb <br> suffix "dc=your,dc=ru" <br> rootdn "cn=admin,dc=your,dc=ru" <br> rootpw 123 <br> directory /var/lib/ldap/bases/your.ru <br> index objectClass eq <br> index uid pres,eq,sub <br> index cn pres,eq,sub,subany <br> access to attrs=userPassword <br> by self write <br> by anonymous auth <br> by * none <br> access to * <br> by dn="cn=admin,dc=your,dc=ru" write <br> by * read</code> <br>  If you plan to publish the database to the outside, then configure the interface that our Ldap server / etc / sysconfig / ldap will listen on (by default 127.0.0.1): <br> <code>SLAPDURLLIST="ldap://servername.your.ru/" <br> SLAPD_OPTIONS="" <br> SLURPD_OPTIONS='-t /' <br></code>  We start the demon: <br> <code>service slapd start</code> <br>  Then our base should be created in /var/lib/ldap/bases/your.ru <h5>  Filling user base </h5>  If there is already an existing domain base, then it is possible to unload it into a text CSV file and parse it using AWK to the ldif file ready for import.  Anyway, it is most convenient to create a text file with a list of users, and then use the AWK script to convert it to ldif, automatically generating user passwords.  Thus, you will have a script and a backup copy of the Ldap database.  Here is an example of the CSV file format for uploading from Active Directory: <br> <code>"DN","objectClass","ou","distinguishedName","instanceType","whenCreated","whenChanged","uSNCreated", "uSNChanged","name","objectGUID","objectCategory","dSCorePropagationData","cn","sn","displayName", "proxyAddresses","altRecipientBL","targetAddress","mAPIRecipient","mailNickname","internetEncoding", "legacyExchangeDN","textEncodedORAddress","mail","msExchPoliciesIncluded","msExchALObjectVersion", "msExchHideFromAddressLists","givenName","altRecipient","department","homeMTA","homeMDB", "mDBUseDefaults","userAccountControl","codePage","countryCode","pwdLastSet","primaryGroupID", "objectSid","accountExpires","sAMAccountName","sAMAccountType","showInAddressBook","userPrincipalName", "msExchHomeServerName","msExchMailboxSecurityDescriptor","msExchUserAccountControl","msExchMailboxGuid", "member","groupType","badPwdCount","badPasswordTime","lastLogoff","lastLogon","userParameters","logonCount", "lastLogonTimestamp","gPLink","gPOptions","userCertificate","adminCount","msNPAllowDialin","title", "physicalDeliveryOfficeName","telephoneNumber","initials","postOfficeBox","company","deliverAndRedirect", "memberOf","scriptPath","localPolicyFlags","operatingSystem","operatingSystemVersion", "operatingSystemServicePack","dNSHostName","servicePrincipalName","isCriticalSystemObject","location","flags", "uNCName","versionNumber","serverName","portName","driverName","priority","printStartTime","printEndTime", "printBinNames","printMaxResolutionSupported","printOrientationsSupported","printCollate","printColor", "printShareName","printSpooling","printKeepPrintedJobs","driverVersion","printMaxXExtent","printMaxYExtent", "printMinXExtent","printMinYExtent","printMediaSupported","printerName","url","shortServerName", "printDuplexSupported","printLanguage","printStaplingSupported","printMemory","printRate","printRateUnit", "printMediaReady","printNumberUp","printPagesPerMinute","description","deletedItemFlags","submissionContLength", "garbageCollPeriod","msExchRequireAuthToSendTo","homePhone","otherTelephone","mobile", "showInAdvancedViewOnly","keywords","serviceClassName","serviceDNSName","serviceDNSNameType", "mS-SQL-Name","mS-SQL-RegisteredOwner","mS-SQL-Contact","mS-SQL-Location","mS-SQL-Memory","mS-SQL-Build", "mS-SQL-ServiceAccount","mS-SQL-CharacterSet","mS-SQL-SortOrder","mS-SQL-UnicodeSortOrder","mS-SQL-Clustered", "mS-SQL-NamedPipe","mS-SQL-MultiProtocol","mS-SQL-SPX","mS-SQL-TCPIP","mS-SQL-AppleTalk","mS-SQL-Vines", "mS-SQL-Status","mS-SQL-LastUpdatedDate","mS-SQL-InformationURL","mS-SQL-GPSLatitude","mS-SQL-GPSLongitude", "mS-SQL-GPSHeight","mS-SQL-Keywords","mSMQSites","mSMQServiceType","mSMQOSType","mSMQEncryptKey","mSMQSignKey", "mSMQDependentClientServices","mSMQRoutingServices","mSMQDsServices","mS-SQL-Description","mS-SQL-Alias", "mS-SQL-Size","mS-SQL-CreationDate","mS-SQL-LastBackupDate","mS-SQL-LastDiagnosticDate","mS-SQL-Applications","msRRASAttribute","mS-DS-CreatorSID","rIDSetReferences","delivContLength","autoReplyMessage","reportToOriginator","reportToOwner", "oOFReplyToOriginator","mSMQSignCertificates","mSMQDigests" <br></code> <br>  Here is an example of an AWK script to process it: <br> <code>##   <br> <br> BEGIN { <br> FS=","; <br> ##  <br> userCounter = 0; <br> } <br> function pass(name) <br> { <br> return substr(name,1,1)""int(rand()*100000); <br> } <br> function trim(v) <br> { <br> ## Remove leading and trailing spaces (add tabs if you like) <br> sub(/^ */,"",v); <br> sub(/ *$/,"",v); <br> return v; <br> } <br> ##     <br> { <br> num = 1; <br> for(i=1; i&lt;= NF; i++) <br> { <br> if($(i)~/\"/) <br> { <br> rez[num] = $(i); <br> for(j=i+1; j&lt;= NF; j++) <br> { <br> rez[num]= rez[num]","$(j); <br> if($(j)~/\"/) <br> { <br> i =j; <br> break; <br> } <br> } <br> gsub(/\"/, "", rez[num]); <br> } <br> else rez[num] = $(i); <br> num+= 1; <br> } <br> <br> if(rez[2]=="user") <br> { <br> mail = rez[25]; <br> split(substr($1, 5, length($1)), fio, "/"); <br> if(rez[21]!= "") <br> { <br> userdn = "uid="rez[21]""substr(rez[1], length($1), length(rez[1])); <br> <br> ##      second name <br> i = 1; <br> while(i &gt; 0) <br> { <br> if(i+1 in fio) <br> { <br> i++; <br> } <br> else <br> { <br> name = trim(fio[i]); <br> split(name, aname, " "); <br> if(2 in aname) <br> { <br> second_name = aname[2]; <br> } <br> else <br> { <br> second_name = "null"; <br> } <br> if(3 in aname) <br> { <br> second_name = second_name""aname[3]; <br> } <br> delete aname; <br> break; <br> } <br> } <br> print "dn: cn="rez[21]",ou=People,dc=your,dc=ru\nobjectClass: inetOrgPerson\nobjectClass: organizationalPerson\nobjectClass: person\nobjectClass: qmailUser\nobjectClass: CourierMailAccount\nobjectClass: top\naccountStatus: active\ncn: "rez[21]"\nemployeeType: \ngidNumber: 100\nhomeDirectory: /var/spool/maildir\nmail: "mail"\nmailAlternateAddress: "rez[21]"@servername.your.ru\nmailAlternateAddress: "rez[21]"@your.ru\nmailMessageStore: /var/spool/maildir/"rez[21]"/\no: your.ru\nsn: "name"\nuid: "name"\nuidNumber: "userCounter+1000"\nuserPassword: "pass(rez[21])"\n"; <br> userCounter += 1; <br> } <br> # uidNumber: 99 nobody <br> } <br> }</code> <br>  At once I will say that I used Windows ports of awk utilities (http://gnuwin32.sourceforge.net/packages/gawk.htm), so this script was not tested under Linux.  Be careful with the translation of the string in the file when importing to the server.  I used JExplorer as a browser and directory editor, this utility did not cause any complaints, it can do everything, including exporting and importing directory branches into .ldif files, the only thing is that it is written in Java.  In principle, I heard that you can put PhpLdapAdmin, but I did not succeed in this. <h5>  Postfix installation </h5>  Install the postfix-cyrus-2.3.11-alt1, postfix-control-1.6.1-alt1, postfix-2.3.11-alt1, postfix-ldap-2.3.11-alt1, cyrus-sasl2-2.1.22, libcourier- packages authlib-0.59.1-alt1.0, courier-imap-utils-4.1.2-alt1, courier-imap-4.1.2-alt1, courier-authlib-0.59.1-alt1.0, courier-authlib-ldap- 0.59.1-alt1.0, procmail-3.22-alt7.  Configuring postfix: <br> <code>#/etc/postfix/main.cf <br> <br> mailbox_command = /usr/bin/procmail -a $DOMAIN -d $LOGNAME <br> myhostname = servername.your.ru <br> #          <br> local_transport = virtual <br> virtual_transport = virtual <br> virtual_mailbox_domains = your.ru <br> #         <br> virtual_mailbox_base = /var/spool/maildir <br> virtual_mailbox_maps = ldap:/etc/postfix/ldapvirtual.cf <br> virtual_uid_maps = static:999 <br> virtual_gid_maps = static:12 <br> virtual_mailbox_limit = 0 <br> message_size_limit = 20480000 <br> relayhost = <br> transport_maps = cdb:/etc/postfix/transport <br> smtpd_sasl_auth_enable = yes <br> smtpd_sasl_security_options = noanonymous <br> #       <br> smtpd_recipient_restrictions = permit_sasl_authenticated, reject <br> smtpd_client_restrictions = permit <br> unknown_local_recipient_reject_code = 550 <br> mynetworks = 192.168.0.0/24 <br></code> <br>  I use the maildrop mailbox format (each letter is a separate text file in the mailbox folder).  User boxes are created by themselves when they receive the first letter and subject to the permission to write to the maildir directory to the user under whom postfix runs. <br> <code>#/etc/postfix/ldapvirtual.cf <br> <br> server_host = servername.your.ru <br> server_port = 389 <br> bind = yes <br> bind_dn = cn=admin,dc=your,dc=ru <br> bind_pw = 123 <br> # ,    <br> search_base = ou=People,dc=your,dc=ru <br> query_filter = (&amp;(mail=%s)(objectClass=CourierMailAccount)(AccountStatus=active)) <br> result_attribute = uid <br> result_format = %u/ <br></code> <br> <code>#/etc/postfix/transport <br> <br> your.ru : <br> .your.ru : <br> servername.your.ru : <br> * smtp:[mail.your_provider.ru] <br></code> <br>  Now compile this transport scheme with the command <br> <code>postmap transport</code> <br>  And update the configuration team <br> <code>postfix reload</code> <br>  In the next series, setting up courier-imap and authorization when you receive mail. </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/62196/">https://habr.com/ru/post/62196/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../62187/index.html">Meeting in Donetsk: Scripting, CSS, GAE, HD video</a></li>
<li><a href="../62191/index.html">PPTP vs L2TP via router</a></li>
<li><a href="../62192/index.html">Computer company: from absolute zero to deserved success</a></li>
<li><a href="../62193/index.html">System Restoranonline.ru successfully launched and is looking for partners in the regions</a></li>
<li><a href="../62194/index.html">The exact time 0100 hours 010111 minutes</a></li>
<li><a href="../62198/index.html">New simulator of life sysadmin from Intel</a></li>
<li><a href="../62200/index.html">Give Internet, Yota-Magister</a></li>
<li><a href="../62202/index.html">Questions about .NET ‚Ññ2</a></li>
<li><a href="../62203/index.html">Procedure for resolving methods in Python</a></li>
<li><a href="../62204/index.html">Fan table under the laptop</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>