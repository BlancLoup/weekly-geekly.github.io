<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Working with GPS in WinCE (C #)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Hello! 
 In this article I want to consider the implementation of access to GPS data in devices based on WindowsCE. When creating the S...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Working with GPS in WinCE (C #)</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  Hello! <br>  In this article I want to consider the implementation of access to GPS data in devices based on WindowsCE.  When creating the SCAUT-Navigator product, it was necessary to develop an application that works in both WinCE version 5.0 and WinCE version 6.0, which can receive NMEA data from a navigation receiver, and record them in a log. <br><br><a name="habracut"></a><br><br><h4>  Decision </h4><br>  To work with GPS in WinCE, both version 5.0 and version 6.0, the easiest way to use it is to work with a COM port.  You can find in the device which COM port provides GPS data using the program: DeviceManager. <br><img src="https://habrastorage.org/storage2/ff2/56d/c32/ff256dc32086e142a73e539af879ad40.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Often, manufacturers of firmware have already taken care that the COM ports of GPS were two.  This allows you to separate software that requires GPS and navigation, so that they do not fight for access to the COM port.  Suppose that the COM port we will use in exclusive access. <br>  To get NMEA data (http://ru.wikipedia.org/wiki/NMEA_0183), we just need to open the COM port, read the data from it, then close the COM port.  What looks like in C #: <br><br><pre><code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">//</span></span>&lt;summary&gt; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   COM  /</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span>&lt;<span class="hljs-regexp"><span class="hljs-regexp">/summary&gt; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span>&lt;param name=<span class="hljs-string"><span class="hljs-string">"comPortName"</span></span>&gt; COM-&lt;<span class="hljs-regexp"><span class="hljs-regexp">/param&gt; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span>&lt;param name=<span class="hljs-string"><span class="hljs-string">"baudRate"</span></span>&gt;&lt;<span class="hljs-regexp"><span class="hljs-regexp">/param&gt; private void ReadData(string comPortName,int baudRate) { var serialPort = newSerialPort(comPortName) { BaudRate = baudRate, DataBits = 8, Parity = Parity.None, StopBits = StopBits.One, RtsEnable = true }; serialPort.Open(); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  COM- /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/..... var line=serialPort.ReadLine(); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/..... serialPort.Close(); }</span></span></code> </pre> <br>  Despite the fact that everything looks rather trivial, the above code often does not work due to access errors to the COM port.  (For example, an error often occurs: "UnauthorizedAccessException: Access to port is denied"). <br><br>  Let's not get upset, there is another approach that works. <br><br>  Wonderful people from the OpenNetCf project carefully provide the source codes of their own SerialPort. <br><br>  <a href="http://serial.codeplex.com/SourceControl/changeset/view/25883">http://serial.codeplex.com/SourceControl/changeset/view/25883#435389</a> <br><br>  Add an OpenNetCf.IO.Serial assembly to the project <br><br>  The class of work with the COM-port of GPS will look like this: <br><pre> <code class="hljs pgsql">///&lt;<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; ///    GPS COM- ///&lt;/<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> GpsPort: IDisposable { private Port _serialPort; private <span class="hljs-type"><span class="hljs-type">bool</span></span> _disposed; private readonly <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> _syncObject = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">bool</span></span> IsOpen { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; private <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } ///&lt;<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; ///   GPS ///&lt;/<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; ///&lt;param <span class="hljs-type"><span class="hljs-type">name</span></span>="serialPortName"&gt;&lt;/param&gt; ///&lt;param <span class="hljs-type"><span class="hljs-type">name</span></span>="baudRate"&gt;&lt;/param&gt; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> GpsPort(string serialPortName, <span class="hljs-type"><span class="hljs-type">int</span></span> baudRate) { _serialPort = newPort(serialPortName, newDetailedPortSettings { BasicSettings = newBasicPortSettings { BaudRate = (BaudRates)baudRate }, EOFChar = <span class="hljs-string"><span class="hljs-string">'\n'</span></span> }); _disposed = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> Dispose() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_disposed) { <span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>(); _serialPort = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; _disposed = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } GC.SuppressFinalize(this); } ///&lt;<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; ///Destructor ///&lt;/<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; ~GpsPort() { Dispose(); } ///&lt;<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; ///      ///&lt;/<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Open</span></span>() { try { _serialPort.<span class="hljs-keyword"><span class="hljs-keyword">Open</span></span>(); _serialPort.DataReceived += SerialPortDataReceived; IsOpen = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ApplicationException("Could not open com port", ex); } } ///&lt;<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; ///     ///&lt;/<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; private <span class="hljs-type"><span class="hljs-type">void</span></span> SerialPortDataReceived() { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (_syncObject) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_serialPort == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || !_serialPort.IsOpen) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; var realPortData = _serialPort.<span class="hljs-keyword"><span class="hljs-keyword">Input</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (realPortData.Length == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Write</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.GetEncoding("ASCII").GetString(realPortData, <span class="hljs-number"><span class="hljs-number">0</span></span>, realPortData.Length)); } } ///&lt;<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; /// ///&lt;/<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>() { IsOpen = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_serialPort != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_serialPort.IsOpen) { _serialPort.DataReceived -= SerialPortDataReceived; _serialPort.<span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>(); } } }</code> </pre><br>  In the SerialPortDataReceived method, we write, in fact, the parsing of NMEA strings. <br>  To do this, you can: <br><ol><li>  Write your NMEA parser; </li><li>  Use <a href="http://sharpgps.codeplex.com/">SharpGps</a> ; </li><li>  Use <a href="http://www.codeproject.com/Articles/279647/NMEA-0183-2-0-Sentense-parser-builder">NMEA-0183-2-0-Sentense-parser-builder</a> ( <a href="http://habrahabr.ru/post/132493/">Here is the</a> developer's article on Habr√©); </li><li>  Any other parser. </li></ol><br>  I did not try to use Sentenseparserbuilder, but I have something to tell about SharpGps. <br><br>  I will make a small digression from the topic.  There is an amusing error in the checksum calculation in the library, although many of my colleagues believe that this is not an error, but logical behavior.  But first things first: <br><br>  In NMEA 0183 ( <a href="http://www.tronico.fi/OH6NT/docs/NMEA0183.pdf">http://www.tronico.fi/OH6NT/docs/NMEA0183.pdf</a> ), the checksum is described as a 2-digit hexadecimal number ‚Äî the XOR checksum of all bytes in the line between $ and * ". <br><br>  SharpGps has a checksum validation feature in the package: <br><pre> <code class="hljs pgsql">private <span class="hljs-type"><span class="hljs-type">bool</span></span> CheckSentence(string strSentence) { <span class="hljs-type"><span class="hljs-type">int</span></span> iStart = strSentence.IndexOf(<span class="hljs-string"><span class="hljs-string">'$'</span></span>); <span class="hljs-type"><span class="hljs-type">int</span></span> iEnd = strSentence.IndexOf(<span class="hljs-string"><span class="hljs-string">'*'</span></span>); //<span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-keyword"><span class="hljs-keyword">start</span></span>/stop isn<span class="hljs-string"><span class="hljs-string">'t found it probably doesn'</span></span>t contain a checksum, //<span class="hljs-keyword"><span class="hljs-keyword">or</span></span> there <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> checksum <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> *. <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> such cases just <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (iStart &gt;= iEnd || iEnd + <span class="hljs-number"><span class="hljs-number">3</span></span> &gt; strSentence.Length) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; byte result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i = iStart + <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; iEnd; i++) { result ^= (byte)strSentence[i]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (result.ToString("X") == strSentence.Substring(iEnd + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>)); }</code> </pre><br>  This feature works great if the navigation receiver transmits a checksum in the form of two numbers (0x01, 0x02, etc.), as stated in the protocol.  But any ideal code breaks into a reality in which navigation receivers transmit packets with a checksum without adding a leading zero (0x1,0x2). <br><br>  In a running application, it turns out that some packets are dropped.  In this case, the feeling that everything seems to be working.  But the track, although it is, but of very poor quality. <br><br>  To make it work, the last line can be rewritten, at least like this: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> packCrc = <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>.Parse(strSentence.Substring(iEnd + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), System.Globalization.NumberStyles.AllowHexSpecifier); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (result == packCrc);</code> </pre><br>  With retreat everything. <br><br>  For storing navigation data, it was decided to use SqlServer Compact Edition.  It is very easy to integrate it into the application, and use it in development.  I did not plan to describe the use of SqlServer Compact in this article, if you want to see an article on using SqlServer Compact in applications on WinCe, you can mark it in the comments. <br><br><h4>  Conclusion </h4><br><br>  In this article, I gave a solution to the problem of accessing GPS data on WinCe devices, the solution was tested on navigators of various manufacturers (Prestigio, Texet, Shturmann, Mio) with different versions of WinCE.  I hope that it will save you from a part of the rake waiting for you on the path of development under WinCE. <br>  Thanks for attention.  Waiting for questions and comments in the comments. <br><br></div><p>Source: <a href="https://habr.com/ru/post/157975/">https://habr.com/ru/post/157975/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../157961/index.html">‚ÄúUniversal‚Äù links in C ++ 11 or T && do not always mean ‚ÄúRvalue Reference‚Äù</a></li>
<li><a href="../157965/index.html">Styling SVG graphics</a></li>
<li><a href="../157967/index.html">20 largest domain sales in history</a></li>
<li><a href="../157969/index.html">Be careful when buying a MacBook. High-tech offline fraud</a></li>
<li><a href="../157973/index.html">Microsoft Seed Fund in Russia - the next cycle for receiving applications for grants ends on November 18</a></li>
<li><a href="../157981/index.html">Microsoft shows almost instant translation from English to Chinese</a></li>
<li><a href="../157983/index.html">Yandex and Mail.ru. The war has begun?</a></li>
<li><a href="../157985/index.html">What is Coding Dojo and where to practice</a></li>
<li><a href="../157987/index.html">Hours left before the start of the first round of the Russian AI Cup</a></li>
<li><a href="../157989/index.html">ZTE enters the Ukrainian smartphone market</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>