<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>IIS as an edge web server (now haproxy)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I want to describe not the most typical scenario, which, however, has the right to life. 
 The fact is that we use IIS as a proxy for ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>IIS as an edge web server (now haproxy)</h1><div class="post__text post__text-html js-mediator-article">  In this article I want to describe not the most typical scenario, which, however, has the right to life. <br>  The fact is that we use IIS as a proxy for other web servers of the company.  I will tell you how this is implemented and what difficulties have been encountered. <br><br>  <b>Formulation of the problem</b> <br>  Let us analyze the example of the YouTrack server.  It is represented by unsightly srv-youtrack-01.local.domain and is located on a web server inside the company.  The task is to provide access to it from the Internet using the beautiful name yt.company.ru.  In this case, https must be used. <br><a name="habracut"></a><br>  <b>Implementation</b> <br>  To get started, we need to install the <a href="http://www.iis.net/downloads/microsoft/url-rewrite">URL Rewrite</a> component.  This can be done using the web platform installer, as well as <a href="">manually</a> .  After installing it, we‚Äôll see a new shortcut in IIS Manager. <br>  URL redefinition ". <br><img src="https://habrastorage.org/getpro/habr/post_images/1a8/e7b/438/1a8e7b43809bd28b9d68d32ea40ca69b.png" alt="image"><br><br>  With this tool, you can create a reverse proxy address rewrite rule. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/b51/e88/4f6/b51e884f6aba0ead8b4a840fb07279f9.png" alt="image"><br><br>  When creating a rule, you need to specify the server URL (without the http: // prefix - IIS will add it automatically) to which proxying will occur.  As a result, we get a rule that is available for editing.  It does not apply to all requests, but only to those that fit the criteria that we can customize.  To begin with, the URL is checked for compliance with the pattern, after which other criteria are checked. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f05/796/13b/f0579613b02df8e7715b3d0a17210d36.png" alt="image"><br><br>  I‚Äôll just make a reservation that there are two ways: the first way is to create a set of rules with different URL patterns for different resources on the same IIS site;  and the second is to create a site for each proxied resource and in each of them make one rule.  Understanding that the first path is more Jedi, I nevertheless chose the path of the second - albeit not so beautiful, but I did not venture to write the wrong regular expression for one site to break all routing.  Therefore, the URL pattern I have everywhere default "(. *)". <br><br>  So, I create a website yt.company.ru with binders for port 80 and port 443 and a mandatory indication of the host name so that IIS knows which site I am accessing.  About obtaining and installing a certificate for 443 I allow myself not to mention.  I‚Äôll only note that you don‚Äôt need to configure the service to use https - inside the network, no one will be encrypted, and external requests will be connected via ssl to the border server, which will already proxy requests inside the network via an unprotected channel. <br><br>  While the mandatory requirement is the use of https, we will only proxy those requests that come to port 443, for which we will create a simple condition.  When you create it, a drop-down list of possible options is offered. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f73/d76/d53/f73d76d538971b32a588d23bb9e4e1a0.png" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/7f7/0a7/a9d/7f70a7a9d0973e76f6c7b13bc313d2ae.png" alt="image"><br><br>  Great, now all <a href="https://yt.company.ru/">yt.company.ru</a> requests <a href="https://yt.company.ru/">are</a> proxied to the internal server with the unsightly name srv-youtrack-01.local.domain transparent to the user. <br><br>  However, all requests <a href="http://yt.company.ru/">yt.company.ru</a> cut off with an error of 403, which is not very beautiful.  To solve this problem, you can either create index.html with a redirect, or another URL Rewrite rule, in which in the "action" field we select a permanent redirect to the URL we need. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/229/e56/fe7/229e56fe780c589ce242f6ccf4e57f8e.png" alt="image"><br><br>  It should be noted that the rules for the site are applied in order, so you must first place the rule with the condition, and then the rule without conditions.  At the same time, since the second rule applies to all URLs without exception, for the first rule it is necessary to tick (leave checked) ‚ÄúStop processing subsequent rules‚Äù. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/310/a38/762/310a38762ef9b15a7603680a96706e7d.png" alt="image"><br><br>  After manipulating the graphical interface, a web.config is created in the root of our site, which contains all the rules created.  Therefore, if you need to proxy some other site, you do not need to repeat these manipulations, you can simply copy the web.config and change the required URL in it or, after copying, use the graphical interface to change the rules.  Moreover, it is possible not to use the interface at all, but to write right there - as you like. <br><br>  <b>Underwater rocks</b> <br>  When you click the Agile Boards tab, YouTrack generates a URL like <i><a href="https://yt.company.ru/rest/agile/Overview-0/sprint/Iteration%2B24">yt.company.ru/rest/agile/Overview-0/sprint/Iteration+24</a></i> .  Further, when switching between sprints <i><a href="https://yt.company.ru/rest/agile/Overview-0/sprint/Iteration%25252023%3Fq%3D">yt.company.ru/rest/agile/Overview-0/sprint/Iteration%252023?q=</a></i> .  When switching to these URLs, IIS began to return me a 404 error.  This indicated that requests were not being proxied.  In this case, the transitions between the saved queries of the form <i><a href="https://yt.company.ru/issues/IT%3Fq%3D%2523">yt.company.ru/issues/IT?q=%23</a> {Current + work} + Assigned + to% 3A + me + updated% 3A + {This + week} were</i> completely correctly worked out. <br><br>  Experiments with the addition of a question mark in the middle of the problematic URL ended up in that I began to receive a 404 error already from the YouTrack server, and not IIS.  This gave me the idea that IIS interprets the URL for some reason (hello, Microsoft) and this needs to be fixed. <br><br>  The problem with the plus sign in the middle of the address was solved by adding the <i>requestFiltering</i> parameter <i>to allowDoubleEscaping = ‚Äútrue‚Äù</i> : <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.webServer</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">security</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">requestFiltering</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">allowDoubleEscaping</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">security</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.webServer</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  But after that, switching between sprints still didn't work.  It turned out that IIS considers such requests unsafe.  This check also had to be disabled: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.web</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">httpRuntime</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">requestPathInvalidCharacters</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.web</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  This is how web.config turned out after all the manipulations: <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.webServer</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rewrite</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rules</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rule</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ProxyToYouTrack"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">patternSyntax</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ECMAScript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stopProcessing</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">match</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">url</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"(.*)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">negate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Rewrite"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">url</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://srv-youtrack-01.local.domain/{R:1}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">appendQueryString</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">logRewrittenUrl</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">conditions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">input</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{SERVER_PORT}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pattern</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"443"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">conditions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rule</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rule</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"redir to ssl"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">enabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stopProcessing</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">match</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">url</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"(.*)"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Redirect"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">url</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://yt.company.ru"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rule</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rules</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">outboundRules</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">preConditions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">preCondition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ResponseIsHtml1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">input</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{RESPONSE_CONTENT_TYPE}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pattern</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"^text/html"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">preCondition</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">preConditions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">outboundRules</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rewrite</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">security</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">requestFiltering</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">allowDoubleEscaping</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">security</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.webServer</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.web</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">httpRuntime</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">requestPathInvalidCharacters</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.web</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  <b>Results</b> <br>  Probably, the solutions that I found are not optimal, and instead of resolving everything in a row, it was necessary to carefully write down the rules appropriate in a particular case.  But now it works.  I will be glad to hear your thoughts and suggestions. <br><br>  Thus, in our organization, absolutely all web servers that need external access are proxied, among which are nginx, and apache, and svn, and gitlab, and exchange web access. <br><br>  The main problem that makes me look for a solution is that NTLM authentication does not work through a proxy, which is so necessary for many Microsoft services.  I don‚Äôt want to use the dead TMG product, so now I‚Äôm trying to figure out the new Windows Server 2012 R2 service called <a href="http://technet.microsoft.com/en-us/library/dn584107.aspx">Web Application Proxy</a> while simultaneously glancing at nginx and apache, which, it seems, are not yet able to proxy NTLM either. <br><br><h4>  Links </h4><br>  <a href="http://www.ifinity.com.au/Blog/EntryId/60/404-Error-in-IIS-7-when-using-a-Url-with-a-plus-sign-in-the-path">http://www.ifinity.com.au/Blog/EntryId/60/404-Error-in-IIS-7-when-using-a-Url-with-a-plus-sign-in-the-path</a> <br>  <a href="http://stackoverflow.com/questions/2831142/asp-net-4-url-limitations-why-url-cannot-contain-any-3f-characters">stackoverflow.com/questions/2831142/asp-net-4-url-limitations-why-url-cannot-contain-any-3f-characters</a> <br><br><hr><br>  <b>Big update:</b> <br>  In the comments I was advised to try haproxy.  Logging on to the site, I made a search on the ‚Äúntlm‚Äù page and found ‚Äúfull HTTP‚Äù, which gave me confidence. <br>  After a few days of active fuss in the console, I still mastered this wonderful tool and now I no longer need IIS as a proxy server.  I think it‚Äôs not worth writing a separate article about it, so I decided to update the topic. <br><br>  The whole thing works quite simply out of the box: <br>  1. Install from backports using apt-get (prefer debian) <br>  2. The config is written.  Slightly corrected settings proxied applications <br>  3. Switches iptables to new proxy <br><br>  On the second point I will focus in more detail. <br>  <i>Configured in the defaults</i> section <br><pre> <code class="bash hljs"> mode http balance roundrobin option redispatch http-send-name-header Host</code> </pre><br>  The last item is needed so that the host name is passed to the bend, the rest are ‚Äúlike all‚Äù. <br><br>  Next, create frontends for 80 and 443 ports, which will listen and decide on which backend to send a request, depending on certain conditions.  And I have only one condition - the incoming host name. <br><pre> <code class="bash hljs">frontend http <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> *:80 <span class="hljs-comment"><span class="hljs-comment">#Define hosts acl host_yt hdr(host) -i yt.company.name acl host_ar hdr(host) -i ar.company.name acl host_portal hdr(host) -i portal.company.name acl host_crm hdr(host) -i crm.company.name acl host_git hdr(host) -i git.company.name acl host_mail hdr(host) -i mail.company.name ... use_backend yt if host_yt use_backend ar if host_ar use_backend crm_r if host_crm use_backend git_r if host_git use_backend mail_r if host_mail</span></span></code> </pre><br>  With https is somewhat more complicated.  A <a href="http://habrahabr.ru/post/244027/">neighboring topic</a> came to the rescue, in the comments of which they recommended using SNI.  He used it <br><pre> <code class="bash hljs">frontend https <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> *:443 ssl crt /etc/ssl/tfs.cer.ipk.pem crt /etc/ssl/yt.cer.ipk.pem crt /etc/ssl/crm.cer.ipk.pem crt /etc/ssl/git.cer.ipk.pem crt /etc/ssl/mail.cer.ipk.pem use_backend tfs <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> { ssl_fc_sni tfs.company.name } use_backend yt <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> { ssl_fc_sni yt.company.name } use_backend crm <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> { ssl_fc_sni crm.company.name } use_backend git <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> { ssl_fc_sni git.company.name } use_backend mail <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> { ssl_fc_sni mail.company.name }</code> </pre><br>  It turned out to be very simple!  First of all, certificates are generated for all backends - they will be given to customers.  I use PKI from Microsoft, so I had to tinker a little with generating requests, issuing and transferring these certificates to the proxy.  By the way, it is allowed to use * .company.name, but I decided that it was somehow not very solid, especially with such a small number of backends.  After the certificates are ready, you need to write them stupidly in the line as in the example above, and then write the rules for backends - the certificates will be pushed in order. <br>  The construction using sni is so simple that you don‚Äôt even need to explain.  True, it turned out that most android mail clients do not know how (or do not want) sni, and send requests to port 443 without specifying the host name.  No problem!  For such cases there is <br><pre> <code class="bash hljs"> default_backend mail</code> </pre><br>  (I, by the way, did not check which certificate slips in this case) <br><br>  Well, then described bekandy.  With http, everything is trivial: <br><pre> <code class="bash hljs">backend it server it.company.name srv-web-01 backend ar server ar.company.name srv-web-01</code> </pre><br>  Here <i>it.company.name</i> is the host name that will be transmitted to srv-web-01.  I need this by the fact that IIS on this server uses authentication by the host name. <br><br>  For https, these are the constructions. <br><pre> <code class="bash hljs">backend yt server yt.company.name srv-youtrack-01:80 backend tfs server tfs.company.name tfs:443 ssl verify none</code> </pre><br>  Here you can unload SSL by specifying port 80 - then the traffic between the client and the proxy will be encrypted, but it will not be inside the network.  And you can continue to use https ( <i>verify none</i> means "not finding fault with the certificate").  However, it should be understood that the client still receives the certificate that we entered when creating the frontend.  If you need to shove the certificate of the destination server, then you can use the method described in the topic, which I have indicated above. <br><br>  One more thing: I want to beautifully redirect http to https for some servers.  For this, I created special backends with the <i>_r</i> postfix, which neatly threw the unsuspecting user onto https. <br><pre> <code class="bash hljs">backend tfs_r <span class="hljs-comment"><span class="hljs-comment">#redirect location https://tfs.company.name code 301 redirect scheme https</span></span></code> </pre><br>  I did not deliberately remove the commented line - this option was originally used, but it redirected me to the root of the site, which is very inconvenient if the user clicked on the long link http: //site.company.name/lib/doc/%20 letter of 2020% 20.Name.docx, and it was thrown onto the main page without any hope of finding your document.  Chances are good that he will close it and try to follow the link again, but again he will not get anything and will be very upset.  To prevent this from happening, we are helped by the construction of the <i>redirect scheme https</i> , which neatly redirects the user, substituting the entire URL. <br><br>  Details on all the subtleties of configuration on the documentation page <a href="http://cbonte.github.io/haproxy-dconv/configuration-1.5.html">cbonte.github.io/haproxy-dconv/configuration-1.5.html#4.2</a> <br><br>  Thanks for attention.  I hope someone my experience will be useful. </div><p>Source: <a href="https://habr.com/ru/post/240495/">https://habr.com/ru/post/240495/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../240483/index.html">Using the beanstalkd queue server to distribute our mailing list</a></li>
<li><a href="../240485/index.html">Sequential execution of tasks in Gulp JS</a></li>
<li><a href="../240489/index.html">We create notebooks for the book in automatic mode</a></li>
<li><a href="../240491/index.html">Starban. Flexible development methodology, gamification and many more buzz words</a></li>
<li><a href="../240493/index.html">We introduce work with coordinates in sonata-admin</a></li>
<li><a href="../240497/index.html">SAM: your personal "Internet of things"</a></li>
<li><a href="../240499/index.html">SSLv3 POODLE vulnerability - like BEAST, only easier</a></li>
<li><a href="../240501/index.html">Explore the big and small worlds with the Lumia 1020</a></li>
<li><a href="../240505/index.html">How does coworker work actually look like?</a></li>
<li><a href="../240507/index.html">Operating practice: 1000 days without downtime TIER-III data center</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>