<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SQL Access to NoSQL Data: Implementing SQL Procedure in Cach√© with Dynamic Detection of Returned Metadata</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As you know, Cach√© can be used as a relational DBMS, including through JDBC / ODBC drivers , with the ability to execute arbitrary SQL queries and cal...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SQL Access to NoSQL Data: Implementing SQL Procedure in Cach√© with Dynamic Detection of Returned Metadata</h1><div class="post__text post__text-html js-mediator-article">  As you know, Cach√© can be used as a relational DBMS, including through <a href="http://habrahabr.ru/company/intersystems/blog/148530/">JDBC / ODBC drivers</a> , with the ability to execute arbitrary SQL queries and call SQL procedures. <br>  It is also known that all data in Cach√© is stored in multidimensional sparse arrays - <a href="">globals</a> .  This allows, in case of insufficient performance of a single SQL procedure, not to use the standard Cach√©SQL engine, but to rewrite its execution code in the Cach√© ObjectScript (COS) server business logic language, in which you can implement an optimal algorithm for executing the SQL procedure, often using more optimal NoSQL data structures (globals). <br>  However, there is one limitation in the standard Cach√© class library: for SQL procedures in which the selection is performed by self-written COS code, it is necessary to define a set of returned fields at the compilation stage ‚Äî that is,  There is no possibility to dynamically set metadata for a SQL procedure working with NoSQL structures. <br><br>  How to remove this restriction, it is told under cat. <br><a name="habracut"></a><br><h5>  Work with SQL procedures in Cach√© </h5><br>  Requests via JDBC / ODBC to non-relational Cach√© structures are implemented using stored procedures as follows: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/96e/1f3/92b/96e1f392bf79d62e5d3dfb1d0e015990.jpg" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Such a stored procedure can return one or several record sets (ResultSets), or a scalar value. <br><br>  As an example, let's call the stored procedure sample.SP_Sample_By_Name from the Samples area using one of the tools for working with ODBC: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/87f/59e/2c2/87f59e2c231a9010e92e4e54e746ffba.jpg" alt="image"><br><br>  By the signature of the SQL procedure, it is not known what it will return, it becomes known only during the execution of the procedure. <br><br>  Cach√© allows you to make class methods stored SQL procedures both returning a value and returning a ResultSet.  For example, this is how a stored procedure is declared that returns a ResultSet: <br><br>  <font color="#000080">ClassMethod</font> <font color="#000000">SomeSqlProc (</font> <font color="#ff00ff">p1</font> <font color="#000080">As% Integer</font> <font color="#000000">=</font> <font color="#000080">0</font> <font color="#000000">) [</font> <font color="#000080">ReturnResultsets</font> <font color="#000000">,</font> <font color="#000080">SqlProc <font color="#000000">]</font></font> <br><br>  With this construct, you can write Cach√© ObjectScript code that can be called via ODBC as a stored procedure, which will return a ResultSet (or several). <br><br>  In Cach√©, there are two standard methods for generating NoSQL data, returned as a ResultSet: <br><br><h6>  The first way.  Using class queries </h6><br><div class="spoiler">  <b class="spoiler_title">Using class queries</b> <div class="spoiler_text">  <font color="#000080">ClassMethod</font> <font color="#000000">SomeSqlProc (</font> <font color="#ff00ff">p1</font> <font color="#000080">As% Integer</font> <font color="#000000">=</font> <font color="#000080">0</font> <font color="#000000">) [</font> <font color="#000080">ReturnResultsets</font> <font color="#000000">,</font> <font color="#000080">SqlProc</font> <font color="#000000">]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">if</font> <font color="#000000">'</font> <font color="#0000ff">$ isobject</font> <font color="#000000">(</font> <font color="#0000ff">$ Get</font> <font color="#000000">(</font> <font color="#800000">% sqlcontext</font> <font color="#000000">))</font> <font color="#800080">{</font> <font color="#0000ff">set</font> <font color="#800000">% sqlcontext</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% ProcedureContext</font> <font color="#000000">).</font>  <font color="#0000ff">% New</font> <font color="#000000">()</font> <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">query</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% ResultSet</font> <font color="#000000">).</font>  <font color="#0000ff">% New</font> <font color="#000000">(</font> <font color="#008000">"User.SomeClass: Query"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">Do</font> <font color="#800000">query</font> <font color="#000000">.</font>  <font color="#0000ff">Execute</font> <font color="#000000">(</font> <font color="#800000">p1</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">do</font> <font color="#800000">% sqlcontext</font> <font color="#000000">.</font>  <font color="#0000ff">AddResultSet</font> <font color="#000000">(</font> <font color="#800000">query</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <br></div></div><br>  Look <a href="">here for</a> details <br><br>  This method allows you to write arbitrary code to form data in Cach√© ObjectScript, but the metadata of the returned ResultSet is generated by the compiler based on the% Query parameter. # ROWSPEC, i.e.  at compile time. <br><br><h6>  The second way.  Using% SQL.CustomResultSet </h6><br><div class="spoiler">  <b class="spoiler_title">Using% SQL.CustomResultSet</b> <div class="spoiler_text">  <font color="#000080">ClassMethod</font> <font color="#000000">SomeSqlProc (</font> <font color="#ff00ff">p1</font> <font color="#000080">As% Integer</font> <font color="#000000">=</font> <font color="#000080">0</font> <font color="#000000">) [</font> <font color="#000080">ReturnResultsets</font> <font color="#000000">,</font> <font color="#000080">SqlProc</font> <font color="#000000">]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">if</font> <font color="#000000">'</font> <font color="#0000ff">$ isobject</font> <font color="#000000">(</font> <font color="#0000ff">$ Get</font> <font color="#000000">(</font> <font color="#800000">% sqlcontext</font> <font color="#000000">))</font> <font color="#800080">{</font> <font color="#0000ff">set</font> <font color="#800000">% sqlcontext</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% ProcedureContext</font> <font color="#000000">).</font>  <font color="#0000ff">% New</font> <font color="#000000">()</font> <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">query</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">User.MyResultSet</font> <font color="#000000">).</font>  <font color="#0000ff">% New</font> <font color="#000000">(,</font> <font color="#800000">p1</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">do</font> <font color="#800000">% sqlcontext</font> <font color="#000000">.</font>  <font color="#0000ff">AddResultSet</font> <font color="#000000">(</font> <font color="#800000">query</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <br></div></div><br>  Learn more about <a href="">% SQL.CustomResultSet</a> , <a href="https://developer.intersystems.com/search/262-17/creating-a-custom-result">an example</a> implementation. <br><br>  The method is similar to the previous one, but the metadata is generated based on the definition of the class-descendant% SQL.CustomResultSet - just as in the previous case, at compile time. <br><br>  Note: Similarly, you can get and SQL-data: <br><br><div class="spoiler">  <b class="spoiler_title">SQL data retrieval</b> <div class="spoiler_text">  <font color="#000080">ClassMethod</font> <font color="#000000">SomeSqlProc (</font> <font color="#ff00ff">p1</font> <font color="#000080">As% Integer</font> <font color="#000000">=</font> <font color="#000080">0</font> <font color="#000000">) [</font> <font color="#000080">ReturnResultsets</font> <font color="#000000">,</font> <font color="#000080">SqlProc</font> <font color="#000000">]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">s</font> <font color="#800000">sqltext</font> <font color="#000000">=</font> <font color="#008000">"SELECT * FROM dbo.Classname" ##;</font>  <font color="#008000">Prepare request text</font> <font color="#008000"><br></font>  <font color="#0000ff">if</font> <font color="#000000">'</font> <font color="#0000ff">$ isobject</font> <font color="#000000">(</font> <font color="#0000ff">$ Get</font> <font color="#000000">(</font> <font color="#800000">% sqlcontext</font> <font color="#000000">))</font> <font color="#800080">{</font> <font color="#0000ff">set</font> <font color="#800000">% sqlcontext</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% ProcedureContext</font> <font color="#000000">).</font>  <font color="#0000ff">% New</font> <font color="#000000">()</font> <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">query</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% ResultSet</font> <font color="#000000">).</font>  <font color="#0000ff">% New</font> <font color="#000000">(</font> <font color="#008000">"% DynamicQuery: SQL"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">Do</font> <font color="#800000">query</font> <font color="#000000">.</font>  <font color="#0000ff">Prepare</font> <font color="#000000">(</font> <font color="#800000">sqltext</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">Do</font> <font color="#800000">query</font> <font color="#000000">.</font>  <font color="#0000ff">Execute</font> <font color="#000000">()</font> <font color="#000000"><br></font>  <font color="#0000ff">do</font> <font color="#800000">% sqlcontext</font> <font color="#000000">.</font>  <font color="#0000ff">AddResultSet</font> <font color="#000000">(</font> <font color="#800000">query</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <br></div></div><br>  In this case, metadata is generated at runtime, but data can only be obtained from SQL. <br><br>  Thus, if we want to generate result metadata in runtime and use arbitrary Cach√© ObjectScript to generate data, then as can be seen - there are not enough funds in the Cach√© distribution. <br><br><h5>  The solution of the problem </h5><br>  There are 4 solutions to the problem: <br><br><ul><li>  at runtime, create a class containing a class query with the generated on-the-fly ROWSPEC; </li><li>  at run time, create a class inherited from% SQL.CustomResultSet with the required set of fields; </li><li>  implement an alternative to% SQL.CustomResultSet, which will generate metadata at runtime based on the parameters of the call, not at compile time; </li><li>  implement an alternative to% Query, which will generate metadata at runtime. </li></ul><br>  I chose the last method - it seemed to me the most elegant (looking ahead, I could not manage without crutches). <br><br>  To begin with, let's create a User.Query class and inherit it from% Query - so as not to overwrite the implementation of all% Query.  When% Query is used by the consumer (% ResultSet), metadata is requested via two class methods: GetInfo and GetODBCInfo.  In the heir class, you must write alternative implementations of these methods.  Through several experiments (it's easier than to understand the generators), I found out about the parameters GetInfo (.colinfo, .parminfo, .idinfo, .qHandle, extoption, .extinfo): <br><br><ul><li>  colinfo - you need to add $ lb ($ lb (name, typeid, caption), ...) into it, where name is the internal field name, typeid is the Cach√© type identifier, caption is the column header; </li><li>  parminfo - you need to add $ lb ($ lb (name, typeid), ...) into it - the same format as in the previous paragraph, but without a header; </li><li>  idinfo - you can add $ lb (0,0) into it (system information related to the index, we assume that it is not); </li><li>  qHandle is a multidimensional local array formed by a programmer; </li><li>  the rest can be left alone (it seems, for object references, in the absence of objects it is not necessary). </li></ul><br><br>  With GetODBCInfo, everything is the same, there are slightly more fields, and the result should be added to one-level lists, but in general it‚Äôs still the same. <br><br>  In order to return the correct metadata from GetInfo and GetODBCInfo, I need to find several not quite obvious techniques, which are mainly given below: <br><ul><li>  To get the type identifier Cach√© (typeid), you need to call $$ externaltype ^% apiOLE (ctype, .type, "0"), where ctype is the type name in Cach√© (for example,% String [link to class% string]).  The function will put the id in type. <br>  Before recognizing an identifier, the type (ctype) must be normalized (reduced to the Package.Class type), this can be done with the $$$ NormalizeClassname (ctype) macro <br>  To get information for GetODBCInfo, you need to call <br>  <font color="#ff0000">GetODBCColInfo</font> <font color="#000000">^% ourODBC (</font> <font color="#800000">ctype</font> <font color="#ff0000">,. ColParms</font> <font color="#000000">,.</font> <font color="#ff0000">ColODBCTypeName</font> <font color="#000000">,.</font> <font color="#ff0000">ColODBCType</font> <font color="#000000">,.</font> <font color="#ff0000">MaxLen</font> <font color="#000000">,.</font> <font color="#ff0000">Precision</font> <font color="#000000">,.</font> <font color="#800000">Scale</font> <font color="#000000">)</font> , <br>  where ctype is the type name in Cach√©, not necessarily normalized. <br><br>  Since we want to generate metadata (field names and types) dynamically, our Query needs to pass information about them.  The most obvious way to do this is with the qHandle parameter.  Through it we will transmit information about the ResultSet.  To do this, the programmer, in his implementation of the query execution (QueryExecute), should form a ROWSPEC string for the required fields and a string of formal query parameters (by analogy with ROWSPEC) and put them in qHandle (‚Äúrowspec‚Äù) and qHandle (‚Äúparams‚Äù), respectively. <br><br>  As a result, we get the following implementation of the User.Query class: <br><br><div class="spoiler">  <b class="spoiler_title">User.Query class</b> <div class="spoiler_text">  <font color="#000080">Class User.Query Extends% Query</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">GetInfo (</font> <font color="#000080">ByRef</font> <font color="#ff00ff">colinfo</font> <font color="#000080">As% List</font> <font color="#000000">,</font> <font color="#000080">ByRef</font> <font color="#ff00ff">parminfo</font> <font color="#000080">As% List</font> <font color="#000000">,</font> <font color="#000080">ByRef</font> <font color="#ff00ff">idinfo</font> <font color="#000080">As% List</font> <font color="#000000">,</font> <font color="#000080">ByRef</font> <font color="#ff00ff">qHandle</font> <font color="#000080">As% Binary</font> <font color="#000000">,</font> <font color="#ff00ff">extoption</font> <font color="#000080">As% Integer</font> <font color="#000000">=</font> <font color="#000080">0</font> <font color="#000000">,</font> <font color="#000080">ByRef</font> <font color="#ff00ff">extinfo</font> <font color="#000080">As% List</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">if $ get</font> <font color="#000000">(</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"colinfo"</font> <font color="#000000">)) =</font> <font color="#008000">""</font> <font color="#008000"><br></font>  <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">set</font> <font color="#800000">RowSpec</font> <font color="#000000">=</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"rowspec"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"colinfo"</font> <font color="#000000">) =</font> <font color="#008000">""</font> <font color="#008000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">sc</font> <font color="#000000">=</font> <font color="#0000ff">$$$ OK</font> <font color="#0000ff"><br></font>  <font color="#0000ff">for</font> <font color="#800000">i</font> <font color="#000000">= 1: 1:</font> <font color="#0000ff">$ length</font> <font color="#000000">(</font> <font color="#800000">RowSpec</font> <font color="#000000">,</font> <font color="#008000">","</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">set</font> <font color="#800000">col</font> <font color="#000000">=</font> <font color="#0000ff">$ piece</font> <font color="#000000">(</font> <font color="#800000">RowSpec</font> <font color="#000000">,</font> <font color="#008000">","</font> <font color="#000000">,</font> <font color="#800000">i</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">name</font> <font color="#000000">=</font> <font color="#008000">"p"</font> <font color="#000000">_</font> <font color="#800000">i</font> <font color="#800000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">ctype</font> <font color="#000000">=</font> <font color="#0000ff">$$$ NormalizeClassname</font> <font color="#000000">(</font> <font color="#0000ff">$ select</font> <font color="#000000">(</font> <font color="#0000ff">$ piece</font> <font color="#000000">(</font> <font color="#800000">col</font> <font color="#000000">,</font> <font color="#008000">":"</font> <font color="#000000">, 2) '=</font> <font color="#008000">""</font> <font color="#000000">:</font> <font color="#0000ff">$ piece</font> <font color="#000000">(</font> <font color="#800000">col</font> <font color="#000000">,</font> <font color="#008000">":"</font> <font color="#000000">, 2), 1:</font> <font color="#008000">"% String"</font> <font color="#000000">))</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">sc</font> <font color="#000000">=</font> <font color="#0000ff">$$</font> <font color="#ff0000">externaltype</font> <font color="#000000">^% apiOLE (</font> <font color="#800000">ctype</font> <font color="#000000">,.</font> <font color="#800000">type</font> <font color="#000000">,</font> <font color="#008000">"0"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">quit</font> <font color="#000000">:</font> <font color="#0000ff">$$$ ISERR</font> <font color="#000000">(</font> <font color="#800000">sc</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">caption</font> <font color="#000000">=</font> <font color="#0000ff">$ piece</font> <font color="#000000">(</font> <font color="#800000">col</font> <font color="#000000">,</font> <font color="#008000">":"</font> <font color="#000000">, 1)</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"colinfo"</font> <font color="#000000">) =</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"colinfo"</font> <font color="#000000">) _</font> <font color="#0000ff">$ listbuild</font> <font color="#000000">(</font> <font color="#0000ff">$ listbuild</font> <font color="#000000">(</font> <font color="#800000">name</font> <font color="#000000">,</font> <font color="#800000">type</font> <font color="#000000">,</font> <font color="#800000">caption</font> <font color="#000000">))</font> <font color="#000000"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">quit</font> <font color="#000000">:</font> <font color="#0000ff">$$$ ISERR</font> <font color="#000000">(</font> <font color="#800000">sc</font> <font color="#000000">)</font> <font color="#800000">sc</font> <font color="#800000"><br><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">if $ get</font> <font color="#000000">(</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"parminfo"</font> <font color="#000000">)) =</font> <font color="#008000">""</font> <font color="#008000"><br></font>  <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">set</font> <font color="#800000">Params</font> <font color="#000000">=</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"params"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"parminfo"</font> <font color="#000000">) =</font> <font color="#008000">""</font> <font color="#008000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">sc</font> <font color="#000000">=</font> <font color="#0000ff">$$$ OK</font> <font color="#0000ff"><br></font>  <font color="#0000ff">for</font> <font color="#800000">i</font> <font color="#000000">= 1: 1:</font> <font color="#0000ff">$ length</font> <font color="#000000">(</font> <font color="#800000">Params</font> <font color="#000000">,</font> <font color="#008000">","</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">set</font> <font color="#800000">col</font> <font color="#000000">=</font> <font color="#0000ff">$ piece</font> <font color="#000000">(</font> <font color="#800000">Params</font> <font color="#000000">,</font> <font color="#008000">","</font> <font color="#000000">,</font> <font color="#800000">i</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">name</font> <font color="#000000">=</font> <font color="#008000">"p"</font> <font color="#000000">_</font> <font color="#800000">i</font> <font color="#800000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">ctype</font> <font color="#000000">=</font> <font color="#0000ff">$$$ NormalizeClassname</font> <font color="#000000">(</font> <font color="#0000ff">$ select</font> <font color="#000000">(</font> <font color="#0000ff">$ piece</font> <font color="#000000">(</font> <font color="#800000">col</font> <font color="#000000">,</font> <font color="#008000">":"</font> <font color="#000000">, 2) '=</font> <font color="#008000">""</font> <font color="#000000">:</font> <font color="#0000ff">$ piece</font> <font color="#000000">(</font> <font color="#800000">col</font> <font color="#000000">,</font> <font color="#008000">":"</font> <font color="#000000">, 2), 1:</font> <font color="#008000">"% String"</font> <font color="#000000">))</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">sc</font> <font color="#000000">=</font> <font color="#0000ff">$$</font> <font color="#ff0000">externaltype</font> <font color="#000000">^% apiOLE (</font> <font color="#800000">ctype</font> <font color="#000000">,.</font> <font color="#800000">type</font> <font color="#000000">,</font> <font color="#008000">"0"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">quit</font> <font color="#000000">:</font> <font color="#0000ff">$$$ ISERR</font> <font color="#000000">(</font> <font color="#800000">sc</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"parminfo"</font> <font color="#000000">) =</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"parminfo"</font> <font color="#000000">) _</font> <font color="#0000ff">$ listbuild</font> <font color="#000000">(</font> <font color="#0000ff">$ listbuild</font> <font color="#000000">(</font> <font color="#800000">name</font> <font color="#000000">,</font> <font color="#800000">type</font> <font color="#000000">))</font> <font color="#000000"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">quit</font> <font color="#000000">:</font> <font color="#0000ff">$$$ ISERR</font> <font color="#000000">(</font> <font color="#800000">sc</font> <font color="#000000">)</font> <font color="#800000">sc</font> <font color="#800000"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">set</font> <font color="#800000">colinfo</font> <font color="#000000">=</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"colinfo"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">parminfo</font> <font color="#000000">=</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"parminfo"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">idinfo</font> <font color="#000000">=</font> <font color="#0000ff">$ listbuild</font> <font color="#000000">(0,0)</font> <font color="#000000"><br></font>  <font color="#0000ff">quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">GetODBCInfo (</font> <font color="#000080">ByRef</font> <font color="#ff00ff">colinfo</font> <font color="#000080">As% List</font> <font color="#000000">,</font> <font color="#000080">ByRef</font> <font color="#ff00ff">parminfo</font> <font color="#000080">As% List</font> <font color="#000000">,</font> <font color="#000080">ByRef</font> <font color="#ff00ff">qHandle</font> <font color="#000080">As% Binary</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#0000ff">if $ get</font> <font color="#000000">(</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"colinfoodbc"</font> <font color="#000000">)) =</font> <font color="#008000">""</font> <font color="#008000"><br></font>  <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">set</font> <font color="#800000">RowSpec</font> <font color="#000000">=</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"rowspec"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"colinfoodbc"</font> <font color="#000000">) =</font> <font color="#0000ff">$ listbuild</font> <font color="#000000">(</font> <font color="#0000ff">$ LENGTH</font> <font color="#000000">(</font> <font color="#800000">RowSpec</font> <font color="#000000">,</font> <font color="#008000">","</font> <font color="#000000">))</font> <font color="#000000"><br></font>  <font color="#0000ff">for</font> <font color="#800000">i</font> <font color="#000000">= 1: 1:</font> <font color="#0000ff">$ length</font> <font color="#000000">(</font> <font color="#800000">RowSpec</font> <font color="#000000">,</font> <font color="#008000">","</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">set</font> <font color="#800000">col</font> <font color="#000000">=</font> <font color="#0000ff">$ piece</font> <font color="#000000">(</font> <font color="#800000">RowSpec</font> <font color="#000000">,</font> <font color="#008000">","</font> <font color="#000000">,</font> <font color="#800000">i</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">ctype</font> <font color="#000000">=</font> <font color="#0000ff">$ select</font> <font color="#000000">(</font> <font color="#0000ff">$ piece</font> <font color="#000000">(</font> <font color="#800000">col</font> <font color="#000000">,</font> <font color="#008000">":"</font> <font color="#000000">, 2) '=</font> <font color="#008000">""</font> <font color="#000000">:</font> <font color="#0000ff">$ piece</font> <font color="#000000">(</font> <font color="#800000">col</font> <font color="#000000">,</font> <font color="#008000">":"</font> <font color="#000000">, 2), 1:</font> <font color="#008000">"% String"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">Do</font> <font color="#ff0000">GetODBCColInfo</font> <font color="#000000">^% ourODBC (</font> <font color="#800000">ctype</font> <font color="#ff0000">,. ColParms</font> <font color="#000000">,.</font> <font color="#ff0000">ColODBCTypeName</font> <font color="#000000">,.</font> <font color="#ff0000">ColODBCType</font> <font color="#000000">,.</font> <font color="#ff0000">MaxLen</font> <font color="#000000">,.</font> <font color="#ff0000">Precision</font> <font color="#000000">,.</font> <font color="#800000">Scale</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">bstr</font> <font color="#000000">=</font> <font color="#008000">"$ Char (0,0,0,0,0,0,0,0,0,0,0,0,0)"</font> <font color="#008000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">name</font> <font color="#000000">=</font> <font color="#0000ff">$ piece</font> <font color="#000000">(</font> <font color="#800000">col</font> <font color="#000000">,</font> <font color="#008000">":"</font> <font color="#000000">, 1)</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"colinfoodbc"</font> <font color="#000000">) =</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"colinfoodbc"</font> <font color="#000000">) _</font> <font color="#0000ff">$ listbuild</font> <font color="#000000">(</font> <font color="#800000">name</font> <font color="#000000">,</font> <font color="#800000">colODBCType</font> <font color="#000000">,</font> <font color="#800000">precision</font> <font color="#000000">,</font> <font color="#800000">scale</font> <font color="#000000">, 2,</font> <font color="#800000">name</font> <font color="#000000">,</font> <font color="#008000">"Query"</font> <font color="#000000">,</font> <font color="#008000">"% Library"</font> <font color="#000000">,</font> <font color="#008000">""</font> <font color="#000000">,</font> <font color="#800000">bstr</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">if $ get</font> <font color="#000000">(</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"parminfoodbc"</font> <font color="#000000">)) =</font> <font color="#008000">""</font> <font color="#008000"><br></font>  <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">set</font> <font color="#800000">Params</font> <font color="#000000">=</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"params"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"parminfoodbc"</font> <font color="#000000">) =</font> <font color="#0000ff">$ listbuild</font> <font color="#000000">(</font> <font color="#0000ff">$ LENGTH</font> <font color="#000000">(</font> <font color="#800000">Params</font> <font color="#000000">,</font> <font color="#008000">","</font> <font color="#000000">))</font> <font color="#000000"><br></font>  <font color="#0000ff">for</font> <font color="#800000">i</font> <font color="#000000">= 1: 1:</font> <font color="#0000ff">$ length</font> <font color="#000000">(</font> <font color="#800000">RowSpec</font> <font color="#000000">,</font> <font color="#008000">","</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">set</font> <font color="#800000">col</font> <font color="#000000">=</font> <font color="#0000ff">$ piece</font> <font color="#000000">(</font> <font color="#800000">Params</font> <font color="#000000">,</font> <font color="#008000">","</font> <font color="#000000">,</font> <font color="#800000">i</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">ctype</font> <font color="#000000">=</font> <font color="#0000ff">$ select</font> <font color="#000000">(</font> <font color="#0000ff">$ piece</font> <font color="#000000">(</font> <font color="#800000">col</font> <font color="#000000">,</font> <font color="#008000">":"</font> <font color="#000000">, 2) '=</font> <font color="#008000">""</font> <font color="#000000">:</font> <font color="#0000ff">$ piece</font> <font color="#000000">(</font> <font color="#800000">col</font> <font color="#000000">,</font> <font color="#008000">":"</font> <font color="#000000">, 2), 1:</font> <font color="#008000">"% String"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">Do</font> <font color="#ff0000">GetODBCColInfo</font> <font color="#000000">^% ourODBC (</font> <font color="#800000">ctype</font> <font color="#ff0000">,. ColParms</font> <font color="#000000">,.</font> <font color="#ff0000">ColODBCTypeName</font> <font color="#000000">,.</font> <font color="#ff0000">ColODBCType</font> <font color="#000000">,.</font> <font color="#ff0000">MaxLen</font> <font color="#000000">,.</font> <font color="#ff0000">Precision</font> <font color="#000000">,.</font> <font color="#800000">Scale</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">name</font> <font color="#000000">=</font> <font color="#008000">"p"</font> <font color="#000000">_</font> <font color="#800000">i</font> <font color="#800000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"parminfoodbc"</font> <font color="#000000">) =</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"parminfoodbc"</font> <font color="#000000">) _</font> <font color="#0000ff">$ listbuild</font> <font color="#000000">(</font> <font color="#800000">colODBCType</font> <font color="#000000">,</font> <font color="#800000">precision</font> <font color="#000000">,</font> <font color="#800000">scale</font> <font color="#000000">, 2,</font> <font color="#800000">name</font> <font color="#000000">, 1)</font> <font color="#000000"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">set</font> <font color="#800000">colinfo</font> <font color="#000000">=</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"colinfoodbc"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">parminfo</font> <font color="#000000">=</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"parminfoodbc"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000000">}</font> <br></div></div><br><br><h5>  How to apply the User.Query class </h5><br>  Using User.Query is similar to using <a href="">% Query</a> , but during initialization it is necessary to pass information to it to generate metadata. <br>  The class using User.Query should look something like this: <br><br><div class="spoiler">  <b class="spoiler_title">User.DynamicQuery class</b> <div class="spoiler_text"> <font color="#000080">Class User.DynamicQuery</font> <font color="#000000">[</font> <font color="#000080">Abstract</font> <font color="#000000">]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br><br></font>  <font color="#000080">Query</font> <font color="#000000">Query (</font> <font color="#ff00ff">p1</font> <font color="#000080">As% Integer</font> <font color="#000000">)</font> <font color="#000080">As User.Query</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">QueryExecute (</font> <font color="#000080">ByRef</font> <font color="#ff00ff">qHandle</font> <font color="#000080">As% Binary</font> <font color="#000000">,</font> <font color="#ff00ff">p1</font> <font color="#000080">As% Integer</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#008000">/// Making all the preparations</font> <font color="#008000"><br></font>  <font color="#008000">; ...</font> <font color="#008000"><br></font>  <font color="#008000">/// Forming ROWSPEC</font> <font color="#008000"><br></font>  <font color="#0000ff">s</font> <font color="#800000">RowSpec</font> <font color="#000000">=</font> <font color="#008000">"ID:% Integer, date:% TimeStamp, Info:% String"</font> <font color="#008000"><br><br></font>  <font color="#0000ff">s</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"rowspec"</font> <font color="#000000">) =</font> <font color="#800000">RowSpec</font> <font color="#800000"><br></font>  <font color="#008000">/// Build a string of formal parameters, constant</font> <font color="#008000"><br></font>  <font color="#0000ff">s</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"params"</font> <font color="#000000">) =</font> <font color="#008000">"p1:% Integer"</font> <font color="#008000"><br><br></font>  <font color="#0000ff">q $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">QueryClose (</font> <font color="#000080">ByRef</font> <font color="#ff00ff">qHandle</font> <font color="#000080">As% Binary</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000000">[</font> <font color="#000080">PlaceAfter</font> <font color="#000000">= QueryExecute]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">Quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">QueryFetch (</font> <font color="#000080">ByRef</font> <font color="#ff00ff">qHandle</font> <font color="#000080">As% Binary</font> <font color="#000000">,</font> <font color="#000080">ByRef</font> <font color="#ff00ff">Row</font> <font color="#000080">As% List</font> <font color="#000000">,</font> <font color="#000080">ByRef</font> <font color="#ff00ff">AtEnd</font> <font color="#000080">As% Integer</font> <font color="#000000">=</font> <font color="#000080">0</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000000">[</font> <font color="#000080">PlaceAfter</font> <font color="#000000">= QueryExecute]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">/// We write the usual QueryFetch, as described in the documentation for class queries</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <br><br>  <font color="#000080">/// Code of the stored procedure calling User.Query:</font> <font color="#000080"><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">DynamicProc (</font> <font color="#ff00ff">p1</font> <font color="#000080">As% Integer</font> <font color="#000000">=</font> <font color="#000080">0</font> <font color="#000000">) [</font> <font color="#000080">ReturnResultsets</font> <font color="#000000">,</font> <font color="#000080">SqlProc</font> <font color="#000000">]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">if</font> <font color="#000000">'</font> <font color="#0000ff">$ isobject</font> <font color="#000000">(</font> <font color="#0000ff">$ Get</font> <font color="#000000">(</font> <font color="#800000">% sqlcontext</font> <font color="#000000">))</font> <font color="#800080">{</font> <font color="#0000ff">set</font> <font color="#800000">% sqlcontext</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% ProcedureContext</font> <font color="#000000">).</font>  <font color="#0000ff">% New</font> <font color="#000000">()</font> <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">query</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% ResultSet</font> <font color="#000000">).</font>  <font color="#0000ff">% New</font> <font color="#000000">(</font> <font color="#008000">"User.DynamicQuery: Query"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">Do</font> <font color="#800000">query</font> <font color="#000000">.</font>  <font color="#0000ff">Execute</font> <font color="#000000">(</font> <font color="#800000">p1</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">do</font> <font color="#800000">% sqlcontext</font> <font color="#000000">.</font>  <font color="#0000ff">AddResultSet</font> <font color="#000000">(</font> <font color="#800000">query</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <br></div></div><br><br><h5>  Usage example </h5><br>  Create the Queries class in the Samples area.  It will contain only one request, so it can be made abstract. <br><br><div class="spoiler">  <b class="spoiler_title">Class User.Queries</b> <div class="spoiler_text">  <font color="#000080">Class User.Queries</font> <font color="#000000">[</font> <font color="#000080">Abstract</font> <font color="#000000">]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br><br></font>  <font color="#000080">Query</font> <font color="#000000">NoSQL (</font> <font color="#ff00ff">ColCount</font> <font color="#000080">As% Integer</font> <font color="#000000">)</font> <font color="#000080">As User.Query</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">NoSQLExecute (</font> <font color="#000080">ByRef</font> <font color="#ff00ff">qHandle</font> <font color="#000080">As% Binary</font> <font color="#000000">,</font> <font color="#ff00ff">ColCount</font> <font color="#000080">As% Integer</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">RowSpec</font> <font color="#000000">=</font> <font color="#008000">"Id:% Integer"</font> <font color="#008000"><br></font>  <font color="#0000ff">for</font> <font color="#800000">colNum</font> <font color="#000000">= 1: 1:</font> <font color="#800000">ColCount</font> <font color="#800000"><br></font>  <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">set</font> <font color="#800000">RowSpec</font> <font color="#000000">=</font> <font color="#800000">RowSpec</font> <font color="#000000">_</font> <font color="#008000">", p"</font> <font color="#000000">_</font> <font color="#800000">colNum</font> <font color="#000000">_</font> <font color="#008000">":% Integer"</font> <font color="#008000"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">set</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"rowspec"</font> <font color="#000000">) =</font> <font color="#800000">RowSpec</font> <font color="#800000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"params"</font> <font color="#000000">) =</font> <font color="#008000">"ColCount:% Integer"</font> <font color="#008000"><br><br></font>  <font color="#0000ff">kill</font> <font color="#000000">^ || MyData (+</font> <font color="#000080">## this</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">for</font> <font color="#800000">rowNum</font> <font color="#000000">= 1: 1: 100</font> <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">for</font> <font color="#800000">colNum</font> <font color="#000000">= 1: 1:</font> <font color="#800000">ColCount</font> <font color="#800000"><br></font>  <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">set $ list</font> <font color="#000000">(^ || MyData (+</font> <font color="#000080">## this</font> <font color="#000000">,</font> <font color="#800000">rowNum</font> <font color="#000000">),</font> <font color="#800000">colNum</font> <font color="#000000">) =</font> <font color="#0000ff">$ R</font> <font color="#000000">(1000)</font> <font color="#000000"><br></font>  <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#800080">}</font> <font color="#800080"><br><br></font>  <font color="#0000ff">set</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"colcount"</font> <font color="#000000">) =</font> <font color="#800000">ColCount</font> <font color="#800000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"cursor"</font> <font color="#000000">) =</font> <font color="#0000ff">$ order</font> <font color="#000000">(^ || MyData (+</font> <font color="#000080">## this</font> <font color="#000000">,</font> <font color="#008000">""</font> <font color="#000000">))</font> <font color="#000000"><br><br></font>  <font color="#0000ff">quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">NoSQLClose (</font> <font color="#000080">ByRef</font> <font color="#ff00ff">qHandle</font> <font color="#000080">As% Binary</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000000">[</font> <font color="#000080">PlaceAfter</font> <font color="#000000">= NoSQLExecute]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">kill</font> <font color="#000000">^ || MyData (+</font> <font color="#000080">## this</font> <font color="#000000">),</font> <font color="#800000">qHandle</font> <font color="#800000"><br><br></font>  <font color="#0000ff">Quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">NoSQLFetch (</font> <font color="#000080">ByRef</font> <font color="#ff00ff">qHandle</font> <font color="#000080">As% Binary</font> <font color="#000000">,</font> <font color="#000080">ByRef</font> <font color="#ff00ff">Row</font> <font color="#000080">As% List</font> <font color="#000000">,</font> <font color="#000080">ByRef</font> <font color="#ff00ff">AtEnd</font> <font color="#000080">As% Integer</font> <font color="#000000">=</font> <font color="#000080">0</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000000">[</font> <font color="#000080">PlaceAfter</font> <font color="#000000">= NoSQLExecute]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">if</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"cursor"</font> <font color="#000000">) =</font> <font color="#008000">""</font> <font color="#008000"><br></font>  <font color="#800080">{</font> <font color="#800080"><br></font>  <font color="#0000ff">set</font> <font color="#800000">Row</font> <font color="#000000">=</font> <font color="#008000">""</font> <font color="#000000">,</font> <font color="#800000">AtEnd</font> <font color="#000000">= 1</font> <font color="#000000"><br></font>  <font color="#0000ff">quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#800080">}</font> <font color="#800080"><br><br></font>  <font color="#0000ff">set</font> <font color="#800000">rowNum</font> <font color="#000000">=</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"cursor"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">Row</font> <font color="#000000">=</font> <font color="#0000ff">$ listbuild</font> <font color="#000000">(</font> <font color="#800000">rowNum</font> <font color="#000000">) _ ^ || MyData (+</font> <font color="#000080">## this</font> <font color="#000000">,</font> <font color="#800000">rowNum</font> <font color="#000000">)</font> <font color="#000000"><br><br></font>  <font color="#0000ff">set</font> <font color="#800000">qHandle</font> <font color="#000000">(</font> <font color="#008000">"cursor"</font> <font color="#000000">) =</font> <font color="#0000ff">$ order</font> <font color="#000000">(^ || MyData (+</font> <font color="#000080">## this</font> <font color="#000000">,</font> <font color="#800000">rowNum</font> <font color="#000000">))</font> <font color="#000000"><br><br></font>  <font color="#0000ff">Quit $$$ OK</font> <font color="#0000ff"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000000">}</font> <br></div></div><br><br>  Our query takes a number of columns, and returns 100 entries filled with random numbers.  Now we will write the Procedures class, which will contain the method of the class-stored procedure using our query. <br><br><div class="spoiler">  <b class="spoiler_title">User.Procedures class</b> <div class="spoiler_text">  <font color="#000080">Class User.Procedures Extends% Persistent</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br><br></font>  <font color="#000080">ClassMethod</font> <font color="#000000">ProcNoSQL (</font> <font color="#ff00ff">p1</font> <font color="#000080">As% Integer</font> <font color="#000000">) [</font> <font color="#000080">ReturnResultsets</font> <font color="#000000">,</font> <font color="#000080">SqlName</font> <font color="#000000">=</font> <font color="#008000">proc_nosql</font> <font color="#000000">,</font> <font color="#000080">SqlProc</font> <font color="#000000">]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">if</font> <font color="#000000">'</font> <font color="#0000ff">$ isobject</font> <font color="#000000">(</font> <font color="#0000ff">$ Get</font> <font color="#000000">(</font> <font color="#800000">% sqlcontext</font> <font color="#000000">))</font> <font color="#800080">{</font> <font color="#0000ff">set</font> <font color="#800000">% sqlcontext</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% ProcedureContext</font> <font color="#000000">).</font>  <font color="#0000ff">% New</font> <font color="#000000">()</font> <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">query</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% ResultSet</font> <font color="#000000">).</font>  <font color="#0000ff">% New</font> <font color="#000000">(</font> <font color="#008000">"User.Queries: NoSQL"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">Do</font> <font color="#800000">query</font> <font color="#000000">.</font>  <font color="#0000ff">Execute</font> <font color="#000000">(</font> <font color="#800000">p1</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">do</font> <font color="#800000">% sqlcontext</font> <font color="#000000">.</font>  <font color="#0000ff">AddResultSet</font> <font color="#000000">(</font> <font color="#800000">query</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000080">ProcSQL</font> <font color="#000000">ClassMethod (</font> <font color="#ff00ff">p1</font> <font color="#000080">As% String</font> <font color="#000000">=</font> <font color="#800080">""</font> <font color="#000000">) [</font> <font color="#000080">ReturnResultsets</font> <font color="#000000">,</font> <font color="#000080">SqlName</font> <font color="#000000">=</font> <font color="#008000">proc_sql</font> <font color="#000000">,</font> <font color="#000080">SqlProc</font> <font color="#000000">]</font> <font color="#000000"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">sqltext</font> <font color="#000000">=</font> <font color="#008000">"SELECT ID, Name, DOB, SSN"</font> <font color="#008000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">sqltext</font> <font color="#000000">=</font> <font color="#800000">sqltext</font> <font color="#000000">_</font> <font color="#008000">"FROM Sample.Person"</font> <font color="#008000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">sqltext</font> <font color="#000000">=</font> <font color="#800000">sqltext</font> <font color="#000000">_</font> <font color="#008000">"WHERE (Name% STARTSWITH '"</font> <font color="#000000">_</font> <font color="#800000">p1</font> <font color="#000000">_</font> <font color="#008000">"')"</font> <font color="#008000"><br></font>  <font color="#0000ff">set</font> <font color="#800000">sqltext</font> <font color="#000000">=</font> <font color="#800000">sqltext</font> <font color="#000000">_</font> <font color="#008000">"ORDER BY Name"</font> <font color="#008000"><br><br></font>  <font color="#0000ff">if</font> <font color="#000000">'</font> <font color="#0000ff">$ isobject</font> <font color="#000000">(</font> <font color="#0000ff">$ Get</font> <font color="#000000">(</font> <font color="#800000">% sqlcontext</font> <font color="#000000">))</font> <font color="#800080">{</font> <font color="#0000ff">set</font> <font color="#800000">% sqlcontext</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% ProcedureContext</font> <font color="#000000">).</font>  <font color="#0000ff">% New</font> <font color="#000000">()</font> <font color="#800080">}</font> <font color="#800080"><br></font>  <font color="#0000ff">Set</font> <font color="#800000">query</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">% ResultSet</font> <font color="#000000">).</font>  <font color="#0000ff">% New</font> <font color="#000000">(</font> <font color="#008000">"% DynamicQuery: SQL"</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">Do</font> <font color="#800000">query</font> <font color="#000000">.</font>  <font color="#0000ff">Prepare</font> <font color="#000000">(</font> <font color="#800000">sqltext</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#0000ff">Do</font> <font color="#800000">query</font> <font color="#000000">.</font>  <font color="#0000ff">Execute</font> <font color="#000000">()</font> <font color="#000000"><br></font>  <font color="#0000ff">do</font> <font color="#800000">% sqlcontext</font> <font color="#000000">.</font>  <font color="#0000ff">AddResultSet</font> <font color="#000000">(</font> <font color="#800000">query</font> <font color="#000000">)</font> <font color="#000000"><br></font>  <font color="#000000">}</font> <font color="#000000"><br><br></font>  <font color="#000000">}</font> <br></div></div><br><br>  Now the generated SQL procedure that executes the NoSQL query can be called via xDBC: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/23d/bbb/4bb/23dbbb4bb4d4025b196a0ec3a8dd4b9e.jpg" alt="image"><br><br><h5>  Conclusion </h5><br>  I hope that the method I have proposed for creating NoSQL queries for SQL procedures with dynamic definition will be useful to someone, as it turned out to be useful to me, when implementing a specific practical task of improving the performance of SQL procedures, which I will probably discuss in the next article. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/160147/">https://habr.com/ru/post/160147/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../160133/index.html">RIM Shares Show Record Growth</a></li>
<li><a href="../160135/index.html">Minecraft officially ported to Raspberry Pi</a></li>
<li><a href="../160137/index.html">Bruce Beyer, "the father of digital photography," passed away</a></li>
<li><a href="../160139/index.html">Digest IT events until the end of 2012</a></li>
<li><a href="../160145/index.html">Issues of release management of maven projects with CI approach to software development</a></li>
<li><a href="../160151/index.html">A selection of syntax highlighting color schemes for Sublime, TextMate and Vim</a></li>
<li><a href="../160153/index.html">The Oliver Twins launch the project Dizzy Returns</a></li>
<li><a href="../160155/index.html">GEEK WEEK ‚Ññ2 | GAME VIDEO DIGEST</a></li>
<li><a href="../160159/index.html">Crowdfunding raised $ 1.5 billion in 2011 and could attract twice as much in 2012</a></li>
<li><a href="../160161/index.html">Strange behavior Task Manager in Windows Server 2012</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>