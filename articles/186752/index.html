<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How Yandex.Disk works: bootloader</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We have already talked about how the choice was made in favor of the WebDAV protocol, as well as about the problems that arise on the server side and ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How Yandex.Disk works: bootloader</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/e1c/4f2/75e/e1c4f275efb76d296c6ae9e305e32910.gif" width="1" height="1">  We have already talked about how the <a href="http://habrahabr.ru/company/yandex/blog/173343/">choice</a> was <a href="http://habrahabr.ru/company/yandex/blog/173343/">made</a> in favor of the WebDAV protocol, as well as about the problems that arise on the <a href="http://habrahabr.ru/company/yandex/blog/176251/">server side</a> and their solution. <br><br>  Today, it‚Äôs about how the file uploader to the service is organized, and what you need not to forget when writing it for Yandex.Disk-scale services. <br><br> <a href="http://habrahabr.ru/company/yandex/blog/186752/"><img src="https://habrastorage.org/getpro/habr/post_images/acc/b77/c24/accb77c24640dcbd929276fa25f2c4c7.png" alt="image"></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To begin, consider the architecture of the service as a whole.  At the core of the service is mpfs - Magic Proxy File System.  This is a backend that contains all the business logic for working with files, folders, directories: all operations for copying or creating new files go through this system.  The same system is also responsible for the storage of metadata. <br><a name="habracut"></a><br>  Synchronization with clients occurs via WebDAV protocol.  Based on it, we have created clients for Windows, OS X and mobile platforms.  But if necessary, using WebDAV, you can configure synchronization with any application that supports this protocol. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bb4/5fb/847/bb45fb847100bdff1e1e33b3cf7678db.png" alt=" 1.  ." title="Figure 1. Yandex.Disk architecture"><br><br>  Through the web interface, users can access the same functions as clients: upload, download and view files.  In addition, through our internal API, interaction with other Yandex services is performed.  At the moment it is the People, Mail, Music and Browser.  For example, through the Yandex.Music mobile client, you can access audio files downloaded to Disk. <br><br><h5>  Sword </h5><br>  But back to our main theme - the loader.  We have it under the code name "Kladun."  For a long time we could not find a suitable Russian-language counterpart for the uploader-downloader pair, but in the end we settled on the Kladun-Zaburun combination. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f6b/a03/599/f6ba03599d04fffe40a35e2c97029902.png" alt=" 2.  " title="Figure 2. Loader architecture"><br><br>  It is not difficult to guess that the main task of Kladun is to download and place files with metadata in the repositories.  It all starts with the fact that the user adds a file to the folder on the Disk via the client or the web interface.  A request is sent to the server, which is transmitted to mpfs.  The file system returns the link to the specific machine from the boot loader cluster, after which the file is uploaded to it.  As a result, it goes to the repository, then the download status is transferred to mpfs, and it saves all the metadata.  Each loader machine has its own local queue.  This improves the reliability of the boot process.  When one of the data centers or any machine in the cluster is disconnected, the files on all other machines will continue to be uploaded.  And on the shut down machines, the pouring process will continue immediately after they are restarted. <br>  In addition to its most obvious function, pick up the file from the user and put it in the storage - the loader can also transfer files between Yandex services. <br><br><h5>  Task stages </h5><br>  Each task performed by the loader is divided into several stages.  First of all, after receiving the file from the user or service, the checksums are calculated.  Later they will be used when synchronizing the file to track changes.  Since our Kladun supports downloading changes by patches, each file is divided into several blocks, for each of which a separate checksum is generated.  If the file has been slightly edited after uploading, then it will not be completely reloaded during synchronization: only those blocks that have changed will be reloaded, and the checksums will no longer match.  Something similar is used in version control systems. <br><br>  The use of hash sums also allows you to avoid reloading files already uploaded by other users.  For example, if you want to upload any popular video or installation file to the Disk, and there is already a file in the Disk repository with the same checksum, it will be used.  Thus, even very large files can be placed in the storage in just a couple of seconds.  This is beneficial to both parties: the user gets a very fast download, and we save resources.  Total duplicate files make up about 12 percent of all uploaded files. <br><br>  After uploading the file to the bootloader's machine and calculating the hash sum, you need to move the file to the storage and send the download status to mpfs.  From this point on, files become available to the user: they are displayed in the web interface and can be synchronized using clients.  But the work of the loader does not end there; it is the turn of two stages of post-processing: the creation of a preview and a check for viruses. <br><br>  Each stage passes through a specific set of states.  Initially, they are all in the initial state.  Some stages of execution require very little time, they almost immediately go into the status of successfully completed (success).  But on the road to success may fail.  They are of two types: temporary and final.  For example, when a network fails during data transfer to mpfs or one of the data centers stops responding, the stage goes into a state of temporary failure (temp fail) and after some time the request is repeated.  If after a certain number of repetitions to successfully complete the stage and fails, it goes into a state of final failure (fail). <br><img src="https://habrastorage.org/getpro/habr/post_images/e0e/30c/a24/e0e30ca2472a3341c752bcfea381a9ee.png" alt=" 3.  " title="Figure 3. Stage states"><br><br>  In the event of a failure at a stage that is not connected to the network in any way and is executed locally, it immediately goes into fail status, since restarting it most likely will not give any results.  This is the case with the generation of previews.  This is a fairly simple and understandable process, and if something went wrong, then it is likely that we have not yet learned how to do a preview for this type of file, which means that repeating this stage is pointless.  The need to repeat the operation, as well as the number of repetitions, after which it finally goes into a state of fail is prescribed for each stage separately.  Whether a failure in performing a particular stage leads to the failure of the entire task depends on the mandatory parameter of successful execution.  For example, as mentioned above, the generation of the preview is not always successful.  But for the user, the presence of a preview in the web interface is not critical, the main thing is that access to their files is obtained, which means that the main task is completed.  However, if the failure occurs at a more important stage, such as transferring a file to the repository, the entire task will fail.  In this case, the desktop client will retry by itself, and when uploading via the web, the user will receive a message about the failure, after which he may try to download the file again. <br><br>  In addition, each stage has a maximum execution time.  If a stage takes a long time to complete successfully, it can go into a ‚Äúin progress‚Äù state.  This usually happens when a file is received from the user, since the downloaded files are quite large (the maximum file size on the Disk is 10 GB), and the connection speed is low. <br><br><h5>  Just do not disconnect!  Just do not disconnect! </h5><br>  When transferring a file to the loader machine, anything can happen.  For example, a user connection may disappear.  In this case, the stage status is set to temp fail, and after the connection is restored, the download resumes. </div><p>Source: <a href="https://habr.com/ru/post/186752/">https://habr.com/ru/post/186752/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../186738/index.html">"Thread" - a real rope for cultural, educational and social projects</a></li>
<li><a href="../186740/index.html">Flying robot to the competition and a bunch of rake with him</a></li>
<li><a href="../186744/index.html">New backdoors in HP server products</a></li>
<li><a href="../186746/index.html">What would the modern world look like without smartphones?</a></li>
<li><a href="../186750/index.html">RWpod. 19th edition of the 01 season. Rspec 2.14, try Elixir, PivotTable.js, GorillaScript, etc.</a></li>
<li><a href="../186758/index.html">Experience of entering the ‚Äúbusy‚Äù market of regional real estate portals</a></li>
<li><a href="../186760/index.html">Step-by-step firmware OpenWRT to TP-LINK TL-WR741ND router from Windows</a></li>
<li><a href="../186762/index.html">Access javascript webpage from chrome extension</a></li>
<li><a href="../186764/index.html">Linux 3.11 officially named ‚ÄúLinux For Workgroups‚Äù</a></li>
<li><a href="../186766/index.html">Beacon Mountain - now for MacOS X</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>