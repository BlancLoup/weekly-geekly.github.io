<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The basics of Juniper Contrail, and how to put it in the lab</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Unexpectedly, it was found that on Habr√© there is almost no information about Juniper Contrail (yes, SDN) - and I decided on my own to make up for the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The basics of Juniper Contrail, and how to put it in the lab</h1><div class="post__text post__text-html js-mediator-article">  Unexpectedly, it was found that on Habr√© there is almost no information about Juniper Contrail (yes, SDN) - and I decided on my own to make up for the omission. <br><br>  In this article I want to briefly talk about what is Contrail, in what forms it is available and how to put it in the lab.  More specifically, we will install Contrail Cloud 3.2.0. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e83/0b0/4cd/e830b04cde57b409a3b1c7a48906dc88.jpg" alt="image"><br><a name="habracut"></a><br><h3>  Contrail Basics </h3><br>  The challenge that Contrail solves is building flexible and scalable virtual networks.  A virtual network can be understood as a replacement for the good old VLAN, in this case implemented approximately as a provider L3VPN / EVPN.  At the same time, from the point of view of connected clients, everything looks as if all their virtual machines and physical servers are connected via a regular switch. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The easiest way to describe Contrail as an SDN overlay.  Software-Defined Networking is understood here in the sense of the classic <a href="https://www.opennetworking.org/sdn-resources/sdn-definition">definition of</a> ONF - the separation of the forwarding plane and control plane, plus the centralization of the control plane in this case in the Contrail controller. <br><br>  The word "overlay" indicates that there are actually two networks: <br><br><ol><li>  Physical "factory", which is required to "only" ensure IP accessibility between connected physical devices (servers, gateway routers), and </li><li>  An overlay is a network made up of tunnels laid between servers and gateway routers.  Tunnels can be MPLS over UDP, MPLS over GRE or VXLAN (listed in the order of priority set by default; although there are some nuances, in general, the specific type of tunnel used is part of the implementation). </li></ol><br>  Contrail-controller is engaged in managing a virtualized overlay network in the data center or provider cloud, and completely climbs into the work of the factory.  Answering the questions ‚Äúwhy?‚Äù And ‚Äúwhy exactly?‚Äù, The strengths of Contrail include: <br><br><ul><li>  Scalability - the system is built on the same principles as the time-tested BGP / MPLS VPN solution. </li><li>  Flexibility - changing the configuration of a virtual network does not require changes to the physical network.  This is a natural consequence of overlay and the use of the smart edge - simple core principle. </li><li>  Programmability - applications can manage the network as a system through the Contrail API. </li><li>  NFV (virtualization of network functions) aka service chains (chain of services) is a very important aspect, it allows to drive traffic through specified virtualized network services (virtual firewall, cache, etc.).  At the same time, both Juniper VNF (vSRX, vMX) and any products of other vendors are absolutely equal. </li><li>  Powerful analytics and visualization of results, including ‚ÄúUnderlay Overlay Mapping‚Äù ‚Äîthis is when Contrail shows you how the traffic between virtual networks actually ‚Äúflows‚Äù through the physical network. </li><li>  Open Source - all source codes are open, plus only standard protocols are used for interaction between the parts.  Project site - <a href="http://www.opencontrail.org/">www.opencontrail.org</a> . </li><li>  Easy integration with existing MPLS VPNs. </li></ul><br>  Here is a picture of the <a href="http://www.juniper.net/us/en/local/pdf/whitepapers/2000535-en.pdf">Contrail Architecture whitepaper</a> , showing how the system <a href="http://www.juniper.net/us/en/local/pdf/whitepapers/2000535-en.pdf">works</a> as a whole: <br><br><img src="https://habrastorage.org/files/767/171/9d6/7671719d661d443a9129ec345c576f5d.jpg"><br><br>  The infrastructure orchestrator works at the top level - most often it will be OpenStack (there are options for integrating Contrail with vCenter and Kubernetes).  In it, the network is configured via high-level commands (Neutron API) - while the implementation details remain the concern of the SDN controller. <br><br>  The SDN controller itself consists of four main types of nodes: <br><br><ul><li>  Configuration nodes are responsible for providing the REST API to the orchestrator and other applications.  ‚ÄúCompiles‚Äù instructions coming ‚Äúfrom above‚Äù in configurations applicable to a particular network at a low level. </li><li>  Control nodes - accept configuration from configuration nodes and program vRouters (see below) and physical routers. </li><li>  Analytics - nodes collecting flow statistics, logs, and more. </li><li>  Database (not shown in the picture) - the Cassandra database, which stores the configuration and information collected by analytics. </li></ul><br>  On one physical (or even virtual) server, several roles can be run, in a lab, you can even make an all-in-one controller (plus computational nodes separately). <br><br>  Now a little about forvarding.  All traffic between virtual machines or containers in the system runs through tunnels terminated on a vRouter, a physical router or an OVSDB switch (I don‚Äôt consider this option here).  vRouter is a software component (default Linux kernel module, user space if using DPDK), the second important part of the Contrail solution (the first is the controller itself).  vRouters are installed and run on cluster computing nodes (Virtualized Server in the picture) - in the same place where the machines / containers are started. <br><br>  Once again, the main task of vRouter is to terminate the overlay tunnel.  By function, vRouter corresponds to the PE (provider edge) router in MPLS VPN. <br><br><h3>  What is Contrail </h3><br>  We have the following options for using Contrail (the features and code are the same everywhere and only support options are different): <br><br><ul><li>  OpenContrail is an option available for free.  Installation is described in the <a href="http://www.opencontrail.org/opencontrail-quick-start-guide/">Quick Start Guide</a> . </li><li>  Contrail Networking is a commercial version supported by Juniper TAC. </li><li>  Contrail Cloud is again a commercial version, and this includes both Contrail itself and Canonical / Ubuntu OpenStack, both supported by Juniper TAC. </li></ul><br>  In addition, there is an option with support for OpenContrail from Mirantis. <br><br>  I will follow the path of least resistance in this article and show you how to install the Contrail Cloud. <br><br><h3>  Install Contrail Cloud </h3><br>  We will install Contrail Cloud 3.2.0 - the latest version, at the time of this writing.  For installation, I used one ESXi 6.0 server with a 4-core hyper-threading CPU and 32GB RAM.  This is enough for tests, even with a margin (you can still run a pair of vMX). <br><br>  The scheme of the virtual laboratory will look like this: <br><br><img src="https://habrastorage.org/files/a96/576/2f4/a965762f428641b3a5541339b4cb7735.jpg" alt="image"><br><br>  Please note that the Compute nodes (as well as the controller nodes) are virtualized in the lab, that is, the virtual machines will run inside other virtual machines.  You should go to the hypervisor settings and check the box next to the option ‚ÄúExpose hardware assisted virtualization to the guest OS‚Äù for each Compute node.  As you can see from testbed.py, the first two are actually for virtual machines, and they use KVM, and the third is for Docker containers. <br><br>  We deploy all 5 virtual locks with parameters as shown in the diagram.  At the same time, for compute nodes, the parameters are actually determined by how many and what kind of machines / containers you are going to run, but for the controller, the parameters are close to the minimum acceptable. <br><br>  We put on all machines the minimum Ubuntu 04/14/4 (ubuntu-04/14/4-server-i386.iso).  Strictly this version, as stated in the Contrail 3.2.0 documentation - this is very important!  Otherwise, it is very easy to run into the incompatibility of packages.  And it is the minimum, for the same reason.  Naked minimum plus only OpenSSH Server.  For some reason, many people do not take seriously such simple instructions and then they do not work :) <br><br>  Next, we write the addresses in / etc / network / interfaces, and in / etc / hosts we ask, so as not to bother with DNS, <br><br><pre><code class="hljs css">10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.230</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">openstack</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.231</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">control</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.233</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">compute-1</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.234</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">compute-2</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.235</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">compute-3</span></span></code> </pre> <br>  We will install Contrail using Fabric scripts.  This option is the easiest for labs, there is also Server Manager for production (with Puppet under the hood), but this is some other time.  For Fabric, we need to allow root login for SSH, like so <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e <span class="hljs-string"><span class="hljs-string">"contrail\ncontrail"</span></span> | sudo passwd root sudo sed -i.bak <span class="hljs-string"><span class="hljs-string">'s/PermitRootLogin without-password/PermitRootLogin yes/'</span></span> /etc/ssh/sshd_config sudo service ssh restart</code> </pre><br>  It is also desirable to enable ntp on all nodes: <br><br><pre> <code class="bash hljs">sudo apt-get install ntp</code> </pre> <br>  Next, on the first node, copy the package contrail-install-packages_3.2.0.0-19-ubuntu-14-04mitaka_all.deb to / tmp and install it: <br><br><pre> <code class="bash hljs">dpkg -i /tmp/contrail-install-packages_3.2.0.0-19-ubuntu-14-04mitaka_all.deb</code> </pre> <br>  Run the installation script: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt/contrail/contrail_packages ./setup.sh</code> </pre><br>  Now an important point.  We need to create the file /opt/contrail/utils/fabfile/testbeds/testbed.py, which will describe our cluster.  Here is a working example: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> fabric.api <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> env <span class="hljs-comment"><span class="hljs-comment"># FOR LAB ONLY, DEFAULT IS 250 minimum_diskGB = 10 # MANAGEMENT USERNAME/IP ADDRESSES host1 = 'root@10.10.10.230' host2 = 'root@10.10.10.231' host3 = 'root@10.10.10.233' host4 = 'root@10.10.10.234' host5 = 'root@10.10.10.235' # EXTERNAL ROUTER DEFINITIONS ext_routers = [] # AUTONOMOUS SYSTEM NUMBER router_asn = 64512 # HOST FROM WHICH THE FAB COMMANDS ARE TRIGGERED # TO INSTALL AND PROVISION host_build = 'root@10.10.10.230' # ROLE DEFINITIONS env.roledefs = { 'all': [host1, host2, host3, host4, host5], 'cfgm': [host1], 'openstack': [host1], 'control': [host2], 'compute': [host3, host4, host5], 'collector': [host1], 'webui': [host1], 'database': [host1], 'build': [host_build] } # DOCKER env.hypervisor = { host5 : 'docker', } # NODE HOSTNAMES env.hostnames = { 'host1': ['openstack'], 'host2': ['control'], 'host3': ['compute-1'], 'host4': ['compute-2'], 'host5': ['compute-3'], } # OPENSTACK ADMIN PASSWORD env.openstack_admin_password = 'contrail' # NODE PASSWORDS env.passwords = { host1: 'contrail', host2: 'contrail', host3: 'contrail', host4: 'contrail', host5: 'contrail', host_build: 'contrail', }</span></span></code> </pre><br>  The meaning of different sections, I think, should be clear without further explanation. <br><br>  Just a few more steps.  Install packages for the remaining nodes: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt/contrail/utils/ fab install_pkg_all:/tmp/contrail-install-packages_3.2.0.0-19-ubuntu-14-04mitaka_all.deb</code> </pre><br>  Change the core to the recommended: <br><br><pre> <code class="bash hljs">fab upgrade_kernel_all</code> </pre> <br>  (kernel version will change from 4.2.0-27-generic to 3.13.0-85-generic and the nodes will reboot). <br><br>  Next, go to the first node and: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt/contrail/utils/ fab install_contrail</code> </pre><br>  And finally, the last step (the longest, takes about an hour in my case): <br><br><pre> <code class="bash hljs">fab setup_all</code> </pre><br>  In principle, everything.  But in this form, with the given parameters of virtual computers, Contrail Cloud slows down.  Apply a few tricks to speed it up (use only for labs): <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'export JAVA_OPTS="-Xms100m -Xmx500m"'</span></span> &gt; /etc/zookeeper/java.env sed -i.bak <span class="hljs-string"><span class="hljs-string">'s/workers = 40/workers = 1/'</span></span> /etc/nova/nova.conf sed -i.bak <span class="hljs-string"><span class="hljs-string">'s/#MAX_HEAP_SIZE="4G"/MAX_HEAP_SIZE="1G"/'</span></span> /etc/cassandra/cassandra-env.sh sed -i.bak <span class="hljs-string"><span class="hljs-string">'s/#HEAP_NEWSIZE="800M"/HEAP_NEWSIZE="500M"/'</span></span> /etc/cassandra/cassandra-env.sh</code> </pre><br>  (after which the server must be restarted; everything adds up to one and a half times the use of memory and noticeably improves the response to actions like virtualo run). <br><br>  Now you can go to the web interface.  Openstack Horizon should be available on 10.10.10.230/horizon, and Contrail Web UI - on 10.10.2.230:8080.  With our settings, login is admin, password is contrail. <br><br><img src="https://habrastorage.org/files/42f/3e1/542/42f3e1542ca04be68cd59703ae46b6e3.jpg" alt="image"><br><br><h3>  findings </h3><br>  I hope that this article will help interested people to begin to understand and work with Contrail 3.2.  Full product documentation is available <a href="http://www.juniper.net/techpubs/en_US/contrail3.2/information-products/pathway-pages/index-r3.2.html">on the Juniper website</a> .  Some examples of how to pull Contrail through the API, I try to collect <a href="https://github.com/pklimai/contrail-scripts">here</a> . <br><br>  All success in work and good mood! </div><p>Source: <a href="https://habr.com/ru/post/321656/">https://habr.com/ru/post/321656/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321644/index.html">Using expressions to filter data from a database</a></li>
<li><a href="../321646/index.html">Automatic 3CX configuration using the setupconfig.xml answer file</a></li>
<li><a href="../321648/index.html">J-bird</a></li>
<li><a href="../321652/index.html">UNIX-like systems contain a bunch of crutches. The collapse of the "UNIX philosophy"</a></li>
<li><a href="../321654/index.html">C ++ Russia: interview with speakers</a></li>
<li><a href="../321658/index.html">The digest of interesting materials for the mobile developer # 190 (February 5-12)</a></li>
<li><a href="../321660/index.html">How to make a distributed assembly system from Ninja?</a></li>
<li><a href="../321662/index.html">Pygest # 3. Releases, articles, interesting projects from the world of Python [January 30, 2017 - February 13, 2017]</a></li>
<li><a href="../321664/index.html">Release Management Process - for post-project support or product development</a></li>
<li><a href="../321666/index.html">Why I work only remotely</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>