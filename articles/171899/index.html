<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>TASK_RTF_NOTES in MS Project or RTF in MS SQL. How to win it and prepare cubes in SSAS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There is a problem that is quite painful for programmers of organizations of MS Project organizations - getting notes from responsible persons. Notes ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>TASK_RTF_NOTES in MS Project or RTF in MS SQL. How to win it and prepare cubes in SSAS</h1><div class="post__text post__text-html js-mediator-article">  There is a problem that is quite painful for programmers of organizations of MS Project organizations - getting notes from responsible persons.  Notes have significant value (with the correct formulation of the control problem), because without the initial information, the problems are not classified and the correct decision is not taken.  They, notes, of course, need to be displayed in reports. <br><br>  From the user's point of view, everything seems to be simple - the report is the report, but from a technical point of view, there are a lot of nuances and questions.  In this article, I present my solution, based on some pieces of code scattered here and there, over the network, and I hope that it will be useful to my colleagues. <br><br>  I do not pretend to originality, but for some reason I did not find analogues of this solution, I had to collect it myself.  In addition, I am not a very deep MS SQL specialist, so if I have any practical comments, please comment. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br>  The notes are obviously stored in a field called TASK_RTF_NOTES.  The field is filled by the user when sending reports on tasks for which he is responsible.  There seems to be no special need for markup tools, moreover, they, these tools, are hidden from the user, but for some reason, the respected (though not understood by me) Indians save this information in RTF format.  Everything would be fine, but it is necessary to prepare reports, including not on one project, but on a heap at a time.  SSAS combined with, for example, MS Excel is a good reporting tool. <br><br>  Yes, in MS Project Professional, of course, there is a ‚Äúreport builder‚Äù.  But these are not cubes, this is a bunch of requests with output to the table.  And to change the cuts on the go, even if you really want it, you will fail.  And you will have to send this report to a heap of people instead of themselves taking it at any time. <br><br>  Ie, presumably, the scheme is approximately as follows: <br>  1) Extract field value <br>  2) Pass value to cube dimension <br>  3) Get a beautiful report in MS Excel (for example) <br><br>  Those.  something like this: <br><img src="https://habrastorage.org/storage2/f1f/fa2/fb5/f1ffa2fb51d85b6962f0a0b179cf0614.jpg"><br><br>  But it was not there. <br><br>  The first surprise is that the field is of type <b><i>image</i></b> .  What for?  Unclear.  Why I stopped at this little thing - it will be clear further.  Transformed into <i><b>varbinary (MAX)</b></i> , drove on. <br>  The second surprise is RTF itself.  what to do with it?  We climb into the network and find a pack of tips, which I broke into 2 categories: <br><br>  1) Take advantage of the object RTFTextBox. <br>  The tip is right on MSDN!  This, apparently, the official position of MS on this issue!  Even a vague doubt creeps in, and did not they put this feature on the MSP specifically, in order to be able to sell report builders? <br><br>  2) Do not fool people with problems and use the TASK_NOTES field. <br>  Great.  Especially if you read further.  And further it is written that only the TASK_RTF_NOTES fields are stored here. <br><br>  And that's all.  There are more tips to parse RTF using regular expressions.  But regular expressions in MS SQL also seem to be rather not there than there is, for their implementation it is also necessary to add the "CLR function" ... What should I do? <br><br>  I had to search for more.  Now I already had more opportunities - because  I obviously can‚Äôt do without addon, I thought and thought and decided to write addon specifically to parse RTF.  Do you think I took advice number 1?  Yes, that's right, I used it.  But for some reason, SQL chewed my dll-ku and spat it out with the phrase ‚ÄúI don‚Äôt believe System.Drawing, it‚Äôs a curve, it‚Äôs badly written and there are a lot of vulnerabilities in it‚Äù.  Funny, in MS, it turns out, they write curves dll-ki! <br><br>  Then I finally realized that without parsing the RTF I could not do it, and finally I came across this place: <br>  <a href="http://www.codeproject.com/Articles/11306/NRTFTree-A-class-library-for-RTF-processing-in-C">NRTFTRee by Oliver</a> <br><br>  Here, of course, not a word about TASK_RTF_NOTES.  Yes, and the comments in Spanish.  However, here I saw a real opportunity to collect the source code of the parser, which was done. <br><br>  I‚Äôll omit the details of the assembly without System.Drawing - just a little imagination and understanding that in fact all these classes are not really needed for this task, but there are no irreplaceable ones. <br><br>  <u><i>An example of a SQL script that now really works:</i></u> <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">1000</span></span> [TASK_UID] ,[TASK_NAME] ,[PROJ_UID] ,<span class="hljs-keyword"><span class="hljs-keyword">convert</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>),[dbo].ConvertFromRTF(<span class="hljs-keyword"><span class="hljs-keyword">convert</span></span>(varbinary(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>),[TASK_RTF_NOTES]))) ,[TASK_NOTES] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [ProjectServer2010_Published].[dbo].[MSP_TASKS] <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> [TASK_RTF_NOTES] <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span></code> </pre> <br><br>  I will answer the question ‚ÄúWhy covert so many times ???‚Äù - for some reason, the CLR functions do not support the transfer of image and varchar (at least in 2005 MS SQL). <br><br>  Yes, there is still a caveat - for some reason, the encoding in our MSP is not 1251, but 1252 (but not always, since some of the projects have been moved), so the <u><i>conversion function</i></u> itself <u><i>is</i></u> written like this: <br><pre> <code class="hljs pgsql">[SqlFunction(DataAccess = DataAccessKind.<span class="hljs-keyword"><span class="hljs-keyword">Read</span></span>)] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static SqlBytes ConvertFromRTF(SqlBytes bytes) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bytes == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bytes.<span class="hljs-keyword"><span class="hljs-keyword">IsNull</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bytes.Length == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; MemoryStream strm = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> MemoryStream(bytes.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>); byte[] buff = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> byte[<span class="hljs-number"><span class="hljs-number">4096</span></span>]; <span class="hljs-type"><span class="hljs-type">int</span></span> rd = strm.<span class="hljs-keyword"><span class="hljs-keyword">Read</span></span>(buff, <span class="hljs-number"><span class="hljs-number">0</span></span>, buff.Length); RtfTree tree = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> RtfTree(); string s1 = <span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>.GetString(buff); tree.LoadRtfText(s1); string <span class="hljs-type"><span class="hljs-type">text</span></span> = tree.Text; SqlBytes res; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s1.IndexOf("ansicpg1252") &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span>) { res = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SqlBytes(<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.GetEncoding("Windows-1252").GetBytes(tree.Text)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s1.IndexOf("ansicpg1251") &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span>) { res = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SqlBytes(<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.GetEncoding("Windows-1251").GetBytes(tree.Text)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { res = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SqlBytes(<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>.GetBytes(tree.Text)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; }</code> </pre><br><br>  <b>References:</b> <br>  1. Original converter: <a href="http://www.codeproject.com/Articles/11306/NRTFTree-A-class-library-for-RTF-processing-in-C">NRTFTRee by Oliver</a> <br>  2. Archive with solution: <a href="http://yadi.sk/d/d9x5bGqn320tk">LibRTFToVarchar</a> </div><p>Source: <a href="https://habr.com/ru/post/171899/">https://habr.com/ru/post/171899/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../171881/index.html">In the beta version of Chrome for Android added password synchronization, data compression through SPDY proxy</a></li>
<li><a href="../171883/index.html">Startup trap</a></li>
<li><a href="../171891/index.html">Moving The Pirate Bay to North Korea was a joke</a></li>
<li><a href="../171895/index.html">85 misconceptions and obstacles to introducing agile development</a></li>
<li><a href="../171897/index.html">WebStorm 6 Released with Latest Web Development Technology</a></li>
<li><a href="../171901/index.html">Create a backup copy of the database in Azure Storage</a></li>
<li><a href="../171903/index.html">Technical fight: mobile apps against mobile sites</a></li>
<li><a href="../171905/index.html">Riddle of the Amazon dropdown list</a></li>
<li><a href="../171909/index.html">Distance learning using mobile devices</a></li>
<li><a href="../171911/index.html">ContactManager, part 3. Testing controllers using MockMvc</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>