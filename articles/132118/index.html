<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sphinx Sample Search on Real Project - Tecdoc Auto Parts Store</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In short: the article will be useful to those programmers who have already become interested in the relevant search and have read the articles on the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sphinx Sample Search on Real Project - Tecdoc Auto Parts Store</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/a852324d/0bcaab81/7dd9f3c3/8be6c329.jpg" align="right" hspace="10" vspace="10">  In short: the article will be useful to those programmers who have already become interested in the relevant search and have read the articles on the initial installation of the sphinx search, drove on test examples and the same synthetic problems.  Often, these examples do not provide an answer to the question, but how can you feel the real benefits of the Sphinx search module in comparison with other simpler search options?  Code examples in the article are on php + smarty, Sphinx 2.0.1-beta, the database is mysql, the source code and the dump of the database structure are laid out in a separate archive in the basement.  The article describes an example of using such features of the Sphinx as: <br><ul><li>  Creating a single config file for windows development and linux production </li><li>  SetMatchMode (SPH_MATCH_EXTENDED2) and why SPH_MATCH_ANY and others are not suitable for real search </li><li>  SetSortMode (SPH_SORT_RELEVANCE), SetFieldWeights - sort by relevance and set weights for index fields </li><li>  SetLimits (0.20) - limiting the output of results </li><li>  AddQuery, RunQueries - building multi-queries </li><li>  SetFilter, ResetFilters - add filtering in the multi-query to limit the received data </li><li>  Wordforms - using synonyms and overcoming limitations for non-standard word forms, like "C #" </li></ul><br>  I would also like to contribute to the development of the project and frankly insufficient Russian documentation, despite the fact that the project was created and supported by a Russian-speaking programmer.  Therefore, it was decided: the uninterrupted flow of task blocker goes through the forest, instead of him, as a thank you to the developers of the sphinx in general, and to the user Andrei Aksyonov, aka <a href="https://habrahabr.ru/users/shodan/" class="user_link">shodan,</a> I am writing this article. <br><a name="habracut"></a><br><h4>  1. Introduction </h4><br>  If the sphinx is not yet installed and want to start, a link to the article for a newbie: <a href="http://habrahabr.ru/blogs/sphinx/104690/">Creating a trial search engine in Sphinx + php</a> .  You can test and see how this search works at <a href="http://autoklad.biz/%3Faction%3Dsearch">autoklad.biz/?action=search</a> . <br><br>  I‚Äôll say right away that our search module is in the beta testing version: there are many more rough spots, potential holes and other less obvious bugs, and therefore it is not recommended to set the current example for your production headlong because you need another testing stage with real loads and real requests from numerous users of our sites. <br><br>  Our company has been dealing with auto parts, or rather selling online stores for parts, for a long time, fruitfully and quite successfully.  But for a number of reasons, the relevant search was needed just now.  The main reason most likely is that full text search is not suitable for most parts.  But there are 5-10% of the goods for which he is catastrophically needed without him.  And our standard search with inherently direct cross-links and indicating a clear model and brand of car from tecdoc does not work for this product group.  An example of such "wrong" products: oils, tires, batteries and other similar. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The average price for spare parts of a small ordinary company is 2-10 million positions, respectively, 10% of this base will occupy the data we need.  That is, the index in the examples below is built on the basis of about 300 thousand documents. <br><br><h4>  2. Creating a single config file for windows development and linux production OS </h4><br>  The problem to be solved is that the configuration files of the developer‚Äôs machine and the server‚Äôs production are different, and when developing, it is necessary to promptly update the unstable structure and constantly change these sphinx configs.  In our case, it was aggravated by the fact that these configs on the server should be shared with a separate project by another development team, and such a section as ‚Äúinclude * .conf‚Äù in the Sphinx is not yet provided. <br><br>  On the local windows of the machine, the config is in ‚ÄúD: \ Sphinx \ sphinx.conf‚Äù, on the server in "/etc/sphinx/sphinx.conf", and on Linux the machine has a symbolic link to the updated Search-&gt; CreateConfigFile () file in /var/www/autoklad.com.ua/imgbank/sphinx/sphinx.conf.  The local file is updated directly to the folder, as it does not interfere with the neighbors. <br><br>  Source code methods: <br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateConfigFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $sConfigFilePath=Db::GetConstant(<span class="hljs-string"><span class="hljs-string">'sphinx:config_file_path'</span></span>,SERVER_PATH.<span class="hljs-string"><span class="hljs-string">'/imgbank/sphinx/'</span></span>); $sConfigFileName=<span class="hljs-string"><span class="hljs-string">'sphinx.conf'</span></span>; $sConfigTemplate=Db::GetConstant(<span class="hljs-string"><span class="hljs-string">'sphinx:config_template'</span></span>,<span class="hljs-string"><span class="hljs-string">'production'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!file_exists($sConfigFilePath)) mkdir($sConfigFilePath); $sTopSection.=<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;GetPriceGroupConfig(); Base::$tpl-&gt;assign(<span class="hljs-string"><span class="hljs-string">'sTopSection'</span></span>,$sTopSection); $sFileContent=Base::$tpl-&gt;fetch(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sPrefix.<span class="hljs-string"><span class="hljs-string">'/config_sphinx_'</span></span>.$sConfigTemplate.<span class="hljs-string"><span class="hljs-string">'.tpl'</span></span>); file_put_contents($sConfigFilePath.$sConfigFileName,$sFileContent); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPriceGroupConfig</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Base::$tpl-&gt;assign(<span class="hljs-string"><span class="hljs-string">'sDataFilePath'</span></span>,Base::GetConstant(<span class="hljs-string"><span class="hljs-string">'sphinx:data_file_path'</span></span>,<span class="hljs-string"><span class="hljs-string">'/var/data/'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Base::$tpl-&gt;fetch(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sPrefix.<span class="hljs-string"><span class="hljs-string">'/config_price_group.tpl'</span></span>); }</code> </pre> <br><br>  Template config_price_group.tpl, the rest - in the archive, so as not to stretch the article <br><pre> <code class="hljs pgsql">source price_group {ldelim} <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = mysql sql_host = {$aDbConf.Host} sql_user = {$aDbConf.<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>} sql_pass = {$aDbConf.<span class="hljs-keyword"><span class="hljs-keyword">Password</span></span>} sql_db = {$aDbConf.<span class="hljs-keyword"><span class="hljs-keyword">Database</span></span>} sql_query_pre = <span class="hljs-keyword"><span class="hljs-keyword">SET NAMES</span></span> utf8 sql_query_pre = <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-type"><span class="hljs-type">CHARACTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> utf8 sql_query = \ <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> p.id \ , p.code <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> code \ , c.title <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> brand \ , <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ifnull(cp.name_rus,<span class="hljs-string"><span class="hljs-string">''</span></span>)&lt;&gt;<span class="hljs-string"><span class="hljs-string">''</span></span>, cp.name_rus, ifnull(p.part_rus,<span class="hljs-string"><span class="hljs-string">''</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> part_name \ , pgr.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> price_group_name \ , p.id_price_group <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> id_price_group \ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> price <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> p \ <span class="hljs-keyword"><span class="hljs-keyword">left join</span></span> cat_part <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> cp <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> cp.item_code=p.item_code \ <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> cat <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> p.pref=c.pref \ <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> provider_virtual <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> pv <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> p.id_provider=pv.id_provider \ <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> user_provider <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> up <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> pv.id_provider_virtual=up.id_user \ <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> provider_group <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> pg <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> up.id_provider_group=pg.id \ <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> up.id_user=u.id <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> u.visible=<span class="hljs-number"><span class="hljs-number">1</span></span> \ <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> currency <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> cu <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> up.id_currency=cu.id \ <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> price_group <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> pgr <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> pgr.id=p.id_price_group \ <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span> sql_attr_uint = id_price_group sql_query_info = <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> price <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> id=$id {rdelim} <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> price_group {ldelim} source = price_group <span class="hljs-type"><span class="hljs-type">path</span></span> = {$sDataFilePath}price_group/<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> morphology = stem_ru min_word_len = <span class="hljs-number"><span class="hljs-number">3</span></span> charset_type = utf<span class="hljs-number"><span class="hljs-number">-8</span></span> min_infix_len = <span class="hljs-number"><span class="hljs-number">3</span></span> #min_prefix_len = <span class="hljs-number"><span class="hljs-number">3</span></span> enable_star = <span class="hljs-number"><span class="hljs-number">1</span></span> {rdelim}</code> </pre><br><br>  The request could be simplified with a view, but as far as I understood, they do not recommend doing this, and a direct query to the data with joins is more efficient for reasons of the load created during indexing. <br><br>  The value of the constants that are taken from the database for the local site <br><pre> <code class="hljs javascript">sphinx:data_file_path D:<span class="hljs-regexp"><span class="hljs-regexp">/Sphinx/</span></span>data/ sphinx:config_template local sphinx:config_file_path D:<span class="hljs-regexp"><span class="hljs-regexp">/Sphinx/</span></span></code> </pre><br><br>  The value of the constants that are taken from the database for the production site <br><pre> <code class="hljs kotlin">sphinx:data_file_path /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>/ sphinx:config_template production sphinx:config_file_path /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/www/autoklad.com.ua/imgbank/sphinx/</code> </pre><br><br>  As a result of the work for the local sphinx, we have the following config file: <br>  <a href="">http://www.mstarproject.com/temp/3/sphinx/sphinx.conf</a> <br><br><h4>  3. SetMatchMode (SPH_MATCH_EXTENDED2) and why SPH_MATCH_ANY and others are not suitable for a real search. </h4><br>  In order for the morphology to work and in the query ‚Äúoil Castrol 5W40‚Äù there were documents with the text ‚ÄúOil‚Äù and ‚Äú15W40‚Äù - you need to simultaneously use the "*" symbol and search for the word "oil", and for this you need a query builder that works it is in the ‚ÄúSPH_MATCH_EXTENDED2‚Äù mode.  There are also SPH_MATCH_EXTENDED, but as I understand it is the old version and recommend using the new version of the mode. <br><br>  In the SPH_MATCH_ANY mode, it is impossible to ensure that when words are increased in the query, the number of results decreases.  In the SPH_MATCH_ALL mode, it is impossible to achieve simultaneous operation of the mode by partial occurrence and word form.  Other modes casually looked through, until they were useful, so I can not say anything about them. <br><br>  The very request to the Sphinx for the phrase ‚ÄúCastrol 5W40 oils‚Äù will look like this: <br><pre> <code class="hljs lisp">( | **) &amp; (Castrol | *Castrol*) &amp; (<span class="hljs-number"><span class="hljs-number">5</span></span>W40 | *5W40*)</code> </pre><br><br>  Important: in the config of the used index there should be 2 lines: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">min_infix_len</span></span> = <span class="hljs-number"><span class="hljs-number">3</span></span> enable_star = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  The first allows you to search for a partial occurrence of the word on the right and left, that is, from the end and from the beginning of the word.  The second line allows to use "*" in the query.  You can use min_prefix_len, if you need, for example, only occurrences on the left (from the beginning) of a word. <br><br>  The function that processes the incoming string and forms the correct query: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetSphinxKeyword</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($sQuery)</span></span></span><span class="hljs-function"> </span></span>{ $aRequestString=preg_split(<span class="hljs-string"><span class="hljs-string">'/[\s,-]+/'</span></span>, $sQuery, <span class="hljs-number"><span class="hljs-number">5</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($aRequestString) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($aRequestString <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $sValue) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strlen($sValue)&gt;<span class="hljs-number"><span class="hljs-number">3</span></span>) { $aKeyword[] .= <span class="hljs-string"><span class="hljs-string">"("</span></span>.$sValue.<span class="hljs-string"><span class="hljs-string">" | *"</span></span>.$sValue.<span class="hljs-string"><span class="hljs-string">"*)"</span></span>; } } $sSphinxKeyword = implode(<span class="hljs-string"><span class="hljs-string">" &amp; "</span></span>, $aKeyword); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $sSphinxKeyword; }</code> </pre><br><br>  The result of the query can be tested at: <a href="http://autoklad.biz/%3Faction%3Dsearch%26search%5Bquery%5D%3D%25D0%25BC%25D0%25B0%25D1%2581%25D0%25BB%25D0%25BE%2520Castrol%25205W40%26search%5Bid_price_group%5D%3D35">http://autoklad.biz/?action=search&amp;search[query[=%D0%BC%D0%B0%D1%81%D0%BB%D0%BE%20Castrol%205W40&amp;search[id_price_group] = 35</a> <br>  Below the search results, the resulting array is displayed, which returns the sphinx for processing - pay attention to the [words] section, which indicates by what words how many documents were found.  Other sections are no less important, but we are not talking about them yet. <br><br>  Also a very frequent question on the forum and developer site is ‚ÄúHow to raise higher the exact phrase entry?‚Äù, I.e., so that the weight of the ‚ÄúSearch for word‚Äù document was higher than the ‚ÄúSearch for word and also a lot of text‚Äù.  Answer - you need to use SPH_RANK_SPH04, specially created for this typical task, as I understood. <br><br><h4>  4. SetSortMode (SPH_SORT_RELEVANCE), SetFieldWeights - sort by relevance and set weights for index fields </h4><br>  This method determines which results will be higher in the sorted array of data returned by the sphinx.  In the case of SPH_SORT_RELEVANCE, the result will be sorted by so-called.  "Relevance."  Relevance, as much as we would like, works by purely arithmetic rules, and not like Google or Yandex search.  That is, no magic: multiplying and adding up the weight of the index, the weight of the field, the number of occurrences of the desired word in the document and the frequency of the word in other documents. <br><br>  In the simplest case, we set the weights for the index fields: <br><pre> <code class="php hljs">$oSphinxClient-&gt;SetFieldWeights(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span> ( <span class="hljs-string"><span class="hljs-string">'code'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">'brand'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-string"><span class="hljs-string">'part_name'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">'price_group_name'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">5</span></span>, ));</code> </pre><br>  and at the output we get an array sorted by ‚Äúrelevance‚Äù = ‚Äútotal weight‚Äù, where weight is an integer value.  These numbers can be controlled by adjusting the relevance to yourself, that is, the more important field you need to assign more weight.  In our example, the most important field is the ‚Äúcode‚Äù part code. <br><br><h4>  5. SetLimits (0.20) - limiting the output of results </h4><br>  This method is the simplest, works similarly to the Mayskle limit 0.20, and is needed respectively for the same: to get batch data for building steppers.  In our project, we just need the first 20 (constant) results, as we will be further down the steps, if there are 3 or more, there is no sense to go. <br><br><h4>  6. AddQuery, RunQueries - building multi-queries </h4><br>  Multi-requests are a very convenient solution for batch requests when you need to send more than one request to the sphinx, but several.  In our example, this is sending all parts groups the same request for a list of groups and the number of records in each group.  That is, about 100 requests are sent, and one result is returned in one connection to the sphinx.  It is also ‚Äúresolved‚Äù to limit the maximum 32 allowed simultaneous requests in one batch of requests. <br><br>  Code example: <br><pre> <code class="php hljs">$aPriceGroup=Db::GetAll(Base::GetSql(<span class="hljs-string"><span class="hljs-string">"Price/Group"</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'visible'</span></span>=&gt;<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"where"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">" and pg.code_name is not null"</span></span>, ))); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($aPriceGroup) { $aResultAll=<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); $i=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($aPriceGroup <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $aValue) { $oSphinxClient-&gt;SetFilter(<span class="hljs-string"><span class="hljs-string">'id_price_group'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($aValue[<span class="hljs-string"><span class="hljs-string">'id'</span></span>])); $iQuery = $oSphinxClient-&gt;AddQuery($sSphinxKeyword, <span class="hljs-string"><span class="hljs-string">'price_group'</span></span>); $oSphinxClient-&gt;ResetFilters(); $bAddedUnrunQuery=<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; $aPriceGroupAssoc[$iQuery+(<span class="hljs-number"><span class="hljs-number">32</span></span>*$i)]=$aValue; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($iQuery &amp;&amp; !($iQuery % <span class="hljs-number"><span class="hljs-number">31</span></span>) ) { $aResultQuery=$oSphinxClient-&gt;RunQueries(); $aResultAll=array_merge($aResultAll,$aResultQuery); $sLastError=$oSphinxClient-&gt;GetLastError(); $i++; $bAddedUnrunQuery=<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($bAddedUnrunQuery) { $aResultQuery=$oSphinxClient-&gt;RunQueries(); $aResultAll=array_merge($aResultAll,$aResultQuery); } }</code> </pre><br>  Due to the fact that the task being performed had deadlines, it was not the goal to delve into all the subtleties of requests at the start.  Therefore, I probably wrote a bike that solves the problem of a ‚Äúgrouped‚Äù query, similar to the group by in mysql.  On the other hand, if I had dealt with the grouping in the sphinx - there would be no example where you can use multi-queries. <br><br>  So in the comments, a more correct example of a request to receive the same is welcomed, but with the help of sphinx grouping. <br><br><h4>  7. SetFilter, ResetFilters - add filtering in the multi-request to limit the received data </h4><br>  In order to use filters, you must first register the fields in the index index that will be used for filtering.  In our example, this is the id_price_group field: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sql_attr_uint</span></span> = id_price_group</code> </pre><br>  Accordingly, the code is used like this: <br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($aPriceGroup <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $aValue) { $oSphinxClient-&gt;SetFilter(<span class="hljs-string"><span class="hljs-string">'id_price_group'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($aValue[<span class="hljs-string"><span class="hljs-string">'id'</span></span>])); $iQuery = $oSphinxClient-&gt;AddQuery($sSphinxKeyword, <span class="hljs-string"><span class="hljs-string">'price_group'</span></span>); $oSphinxClient-&gt;ResetFilters(); <span class="hljs-comment"><span class="hljs-comment">//... }</span></span></code> </pre><br>  That is, in the foreach loop, for each request in a multi-request, a filter is first set, and after adding, it is reset so that it does not work for other requests.  In my opinion, everything is logical, obviously, and difficulties should arise. <br><br><h4>  8. Wordforms - using synonyms and overcoming limitations for non-standard word forms, like ‚ÄúC #‚Äù </h4><br>  In order for synonyms and non-standard (own) word forms to work, you need to include a file with the following word forms in the index config: <br><pre> <code class="hljs tex">wordforms = D:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Sphinx</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">data</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wordforms</span></span></span></span>.txt</code> </pre><br>  The file itself may contain, for example, such a data set in UTF-8 encoding: <br><pre> <code class="hljs objectivec">bosh &gt; bosch  &gt; bosch <span class="hljs-built_in"><span class="hljs-built_in">CASTROL</span></span> &gt; <span class="hljs-built_in"><span class="hljs-built_in">CASTROLL</span></span>  &gt; <span class="hljs-built_in"><span class="hljs-built_in">CASTROLL</span></span>  &gt; <span class="hljs-built_in"><span class="hljs-built_in">CASTROLL</span></span></code> </pre><br>  That is, on the left side all possible synonyms are from the right meaning of these words.  And on the left should not be for example "bosch", if it is already on the right.  At least if you do this - the search does not behave as I expected. <br><br>  In our example, you can use the query "Castrol oil 5W40" and it will find the same as Castrol 5W40 oil.  In the example with ‚ÄúC #‚Äù you need to include such non-standard word forms so that they are not processed according to the standard index scheme and work manually exactly as you configure them.  Only you know the exact meaning of the phrase in your project, for example ‚ÄúC #‚Äù = ‚ÄúTO DIEZ for musicians‚Äù <br><br>  There is no such functionality in the config file and the example on the server, only an example is given, but not yet implemented in the existing structure of the project synonyms. <br><br><h4>  Source codes, archives, links to useful sites </h4><br>  * Unofficial wiki documentation, including non-English <a href="http://sphinxsearch.com/wiki/doku.php">http://sphinxsearch.com/wiki/doku.php</a> <br><br>  * Archive of cut-down sources of auto parts sample <a href="">http://www.mstarproject.com/temp/3/sphinx/sphinxsearch_soruce.zip</a> <br><br>  * Archive of the structure of the curtailed example DB <a href="">http://www.mstarproject.com/temp/3/sphinx/sphinxsearch_db_structure.zip</a> <br><br>  * Archive of the curtailed example DB (43 MB) with the data <a href="">http://www.mstarproject.com/temp/3/sphinx/sphinxsearch_db_data.zip</a> <br><br>  * Sponsor's sponsored link: <a href="http://www.mstarproject.com/%3Faction%3Dtecdoc_mysql_site">tecdoc + sphinxsearch online store development</a> <br><br>  I will be glad to constructive criticism and try to answer your questions.  Most likely I will not go to the <a href="http://sphinxsearch.com/conf/">conference in St. Petersburg</a> : a very inconvenient flight, and indeed a winter.  I decided that there would be more benefit from the article, and you can meet the author of the Sphinx in Ukraine, you just have to wait. </div><p>Source: <a href="https://habr.com/ru/post/132118/">https://habr.com/ru/post/132118/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../132111/index.html">Modx and "restriction" in 5000 documents</a></li>
<li><a href="../132114/index.html">Introduction to Sterling NoSQL OODB</a></li>
<li><a href="../132115/index.html">PHP: Advanced Flow Interface</a></li>
<li><a href="../132116/index.html">Taming Graylog2 - a visualized and functional server log files</a></li>
<li><a href="../132117/index.html">A friend will help</a></li>
<li><a href="../132119/index.html">Chamber technology on Yandex.Maps</a></li>
<li><a href="../132120/index.html">What is the new media and how to advance start-ups in social networks</a></li>
<li><a href="../132123/index.html">Automated backup of Windows workstations with rsync and vshadow - Part 1</a></li>
<li><a href="../132124/index.html">Writing uLogin module for Kohana 3.2</a></li>
<li><a href="../132125/index.html">German district court found Apple guilty of patent infringement by Motorola</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>