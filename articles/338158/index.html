<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>kubernetes, playground, microservices and a bit of magic</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the life of any DevOps engineer it becomes necessary to create a playground for the development team. As always, he should be smart, nimble and con...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>kubernetes, playground, microservices and a bit of magic</h1><div class="post__text post__text-html js-mediator-article">  In the life of any DevOps engineer it becomes necessary to create a playground for the development team.  As always, he should be smart, nimble and consume the minimum amount of resources.  In this article I want to talk about how I solved the problem of creating such a beast for a microservice application on kubernetes. <br><br><img src="https://habrastorage.org/web/eda/726/c1c/eda726c1c3cc4dd4a26ce15b2b922a13.jpg"><br><a name="habracut"></a><br><h3>  Incoming conditions and requirements </h3><br>  It is a little about what the system is for which it was necessary to create a playground: <br><br><ul><li>  Kubernetes, bare-metal cluster; </li><li>  Simple api-gateway based on nginx; </li><li>  MongoDB as a DB; </li><li>  Jenkins as a CI server; </li><li>  Git on Bitbucket; </li><li>  Two dozen microservices that can communicate with each other (via api-gateway), with the base and with the user. </li></ul><br><img src="https://habrastorage.org/web/1c9/321/864/1c93218646244511ae8bbd9305e8481c.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Requirements that we were able to formulate while actively communicating with the timlide: <br><br><ul><li>  Minimization of resource consumption; </li><li>  Minimization of changes in the code of services for work on the playground; </li><li>  The possibility of parallel development of several services; </li><li>  Ability to develop multiple services in the same space; </li><li>  The ability to show changes to customers before deployment to staging; </li><li>  All developed services can work with one database; </li><li>  Minimizing developer efforts to deploy test code. </li></ul><br><h3>  Reflections on the topic </h3><br>  From the very beginning it was clear that the most logical way to create parallel spaces in k8s is the most logical way to use the native virtual cluster tool, or in the terminology of k8s - namespaces.  The task is also simplified by the fact that all interactions within the cluster are made using the short names provided by kube-dns, which means that the launch of the structure can be done in a separate namespace without losing connectivity. <br>  This solution has only one problem - the need to deploy all available services in the namespace, which is long, inconvenient and consumes a large amount of resources. <br><br><h3>  Namespace and DNS </h3><br>  When creating any service, k8s creates a DNS record of the form <i>&lt;service-name&gt;. &lt;Namespace-name&gt; .svc.cluster.local</i> .  This mechanism allows communication through short names within one namespace due to changes made to resolv.conf of each launched container. <br><br>  In its normal state, it looks like this: <br> <code>search &lt;namespace-name&gt;.svc.cluster.local svc.cluster.local cluster.local <br> nameserver 192.168.0.2 <br> options ndots:5</code> <br>  Ie, the service in the same namespace can be addressed by the name &lt;service-name&gt;, in the neighboring namespace by the name &lt;service-name&gt;. &lt;Namespace-name&gt; <br><br><h3>  We go around the system </h3><br>  At this moment, a simple thought comes to mind: " <i>General base, the api-gateway is engaged in routing requests to services, why not make it go first to the service in its namespace, and if it is not in default?</i> " <br>  Yes, such a solution could be organized with the namespace settings (we remember that it is nginx), but such a solution will cause a difference in the settings for pg and on other clusters, which is inconvenient and can cause a number of problems. <br><br>  So, the string replacement method was chosen. <br> <code>search &lt;namespace-name&gt;.svc.cluster.local svc.cluster.local cluster.local</code> <br>  On <br> <code>search &lt;namespace-name&gt;.svc.cluster.local svc.cluster.local cluster.local default.svc.cluster.local</code> <br>  This approach will provide an automatic transition to the namespace default in the absence of the required service in its namespace. <br><br><img src="https://habrastorage.org/web/aad/fd7/3f3/aadfd73f35cc4e6c8bd22495e6d59e38.png"><br><br>  A similar result can be achieved in a cluster as follows.  Kubelet adds the search parameters to the container from the host‚Äôs resolve.conf, so it‚Äôs enough just to add a line to /etc/resolv.conf for each node: <br><br> <code>search default.svc.cluster.local</code> <br> <br>  If you do not want the nodes to resolve the addresses of the services, then you can use the --resolv-conf option when running kubelet, which allows you to specify any other file instead of /etc/resolv.conf.  For example, the file /etc/k8s/resolv.conf with the same line. <br><br><h3>  The matter of technology </h3><br>  Further decision is quite simple, you only need to accept the following agreements: <br><br><ul><li>  New features are developed in separate branches of the play / &lt;feature-name&gt; type </li><li>  To work with several services within one feature, branch names must match in the repositories of all involved services. </li><li>  Jenkins does all the deployment work automatically. </li><li>  For feature tests, the branches are available at &lt;feature-name&gt; .cluster.local </li></ul><br><h4>  Ssl-offloader settings </h4><br>  Nginx config to redirect requests to api-gw in the corresponding namespace <br><br><pre> <code class="nginx hljs"> <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> ~^(?&lt;namespace&gt;.+)\.cluster\.local; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">resolver</span></span> <span class="hljs-number"><span class="hljs-number">192.168.0.2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://api-gw.<span class="hljs-variable"><span class="hljs-variable">$namespace</span></span>.svc.cluster.local; }</code> </pre> <br><h4>  Jenkins </h4><br>  To automate the deployment process, the Jenkins <a href="https://wiki.jenkins.io/display/JENKINS/Pipeline%2BMultibranch%2BPlugin">Pipeline Multibranch Plugin is used</a> . <br><br>  In the project settings, we specify to collect only the branches corresponding to the play / pattern. And we add Jenkinsfile to the root of all projects with which the builder will work. <br>  For processing the groovy script is used, I will not give it entirely, just a couple of examples.  The rest of the deployment is fundamentally no different from the usual. <br><br>  Getting branch name: <br><br><pre> <code class="plaintext hljs">def BranchName() { def Name = "${env.BRANCH_NAME}" =~ "play[/]?(.*)" Name ? Name[0][1] : null }</code> </pre> <br>  The minimal configuration of the namespace requires a deployed api-gateway, so we add a call to the project that creates the namespace and deploys the api-gateway to it: <br><br><pre> <code class="plaintext hljs"> def K8S_NAMESPACE = BranchName() build job: 'Create NS', parameters: [[$class: 'StringParameterValue', name: 'K8S_NAMESPACE', value: "${K8S_NAMESPACE}"]] build job: 'Create api-gw', parameters: [[$class: 'StringParameterValue', name: 'K8S_NAMESPACE', value: "${K8S_NAMESPACE}"]]</code> </pre><br><h3>  Conclusion </h3><br>  There is no silver bullet, but I was not able to find not only the best practices, but also descriptions of how the sandboxes are organized in others, so I decided to share the method I used when creating the k8s sandbox.  Perhaps this is not an ideal way, so I‚Äôm happy to accept comments or stories about how this problem is solved in yours. </div><p>Source: <a href="https://habr.com/ru/post/338158/">https://habr.com/ru/post/338158/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338146/index.html">Russia's first OpenHack from Microsoft (that is, from us)</a></li>
<li><a href="../338148/index.html">MultiSim + M2M OTA platform</a></li>
<li><a href="../338150/index.html">How JS works: memory management, four types of memory leaks and how to deal with them</a></li>
<li><a href="../338154/index.html">How to launch a patent process in an IT company</a></li>
<li><a href="../338156/index.html">Another HighLoadCup solution on Go</a></li>
<li><a href="../338160/index.html">3CX technical support responds: how to replace or update the SSL certificate on the server</a></li>
<li><a href="../338164/index.html">Do not touch the logs with your hands! How to reduce the time for analysis using autotests</a></li>
<li><a href="../338166/index.html">Use PowerShell for IT security. Part III: Budget Classification</a></li>
<li><a href="../338168/index.html">Do-it-yourself Windows server file backup</a></li>
<li><a href="../338170/index.html">Timing attack on Node.js - when time works against you</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>