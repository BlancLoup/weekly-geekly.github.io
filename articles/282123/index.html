<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Manage database structure without pain</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share a tool that was born in the development of a single web project and really helps me not to get lost in the sea of ‚Äã‚Äãtables, stored pro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Manage database structure without pain</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/778/56a/d70/77856ad707d84dda852cc1dcd39c5fb0.png" alt="image"><br><br>  I want to share a tool that was born in the development of a single web project and really helps me not to get lost in the sea of ‚Äã‚Äãtables, stored procedures, indexes and other database inhabitants. <br><br>  The project itself is written in Django, PostgreSQL is used as a backend.  At the very beginning of the work, it was decided to at least partially abandon the use of Django ORM in favor of ‚Äúraw‚Äù SQL and stored procedures.  In other words, almost all business logic is moved to the database level.  I can say right away that I can prepare ORM, but in this case it was necessary to perform multi-stage calculations related to a multitude of samples, and this is better done on the database server and not drag intermediate data into the application. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Faced with the need to maintain the database structure manually, without Django Migrations, I found out that manually writing incremental SQL patches is possible, but it is difficult to keep track of the dependencies of database objects.  For example, when a function that is used somewhere else, you add another argument, a simple CREATE OR REPLACE is not enough - you need to first DROP, and then CREATE.  In this case, you must first remove the functions dependent on it, and then create it again (and if someone else depends on these functions, then you need to recreate them). <br><br>  Under the cut a brief description of the possibilities in the form of a tutorial.  Meet - Sqlibrist. <a name="habracut"></a><br><br>  I must say that my problem has already been learned to be solved.  For example, <a href="http://sqitch.org/">Sqitch</a> has been <a href="http://sqitch.org/">around for a</a> relatively long time.  It allows you to describe the database structure in a declarative form in SQL.  Each table, view, or function is stored in a separate file, and a simple DSL describes the dependencies.  The utility is written in Perl, and I, who are not familiar with Perl development and the ecosystem of its packages, had to really try to compile this utility.  Perhaps due to the long history of development, Sqitch has a lot of dependencies, as for such a simple program.  I also did not like the confusing description of dependencies and the work with versions of the structure.  I admit that I just did not want to adapt and understand the tool, which seemed uncomfortable to me. <br><br>  When creating Sqlibrist, I was inspired by Sqitch, Django Migrations, and some VCS.  He also wanted it to be simple and straightforward to use.  Objects of the database structure are stored in separate files.  Each contains a SQL statement for creating and (optionally) deleting this object.  Dependencies between objects are described explicitly in the form of directives on the built-in DSL (in it, by the way, only three keywords: REQ, UP, DOWN).  Like the version control system, Sqlibrist stores snapshots of the database structure and SQL patch for updating to it from the previous snapshot. <br><br>  Sqlibrist's intelligence is limited, it does not parse SQL and does not generate ALTER TABLE - this is your work.  It only tracks changes in files and creates patches with your instructions, and also keeps records of applied migrations. <br>  It all sounds like something abstract, let's move on to practice. <br><br><h1>  Installation </h1><br>  My primary OS is Linux both on the server and on the desktop, so the installation instructions are for it only.  Maybe someone will help me with Windows and Mac. <br><br>  First header files: <br><br><h2>  Ubuntu </h2><br><pre><code class="bash hljs">$ sudo apt-get install python-pip python-dev libyaml-dev $ sudo apt-get install libmysqlclient-dev <span class="hljs-comment"><span class="hljs-comment"># for MySQL $ sudo apt-get install libpq-dev # PostgreSQL</span></span></code> </pre> <br><h2>  Fedora / CentOS </h2><br><pre> <code class="bash hljs">$ sudo dnf install python-devel python-pip libyaml-devel $ sudo dnf install postgresql-devel <span class="hljs-comment"><span class="hljs-comment"># PostgreSQL</span></span></code> </pre><br><pre> <code class="bash hljs">$ sudo dnf install mariadb-devel <span class="hljs-comment"><span class="hljs-comment"># for MariaDB</span></span></code> </pre><br>  or <br><br><pre> <code class="bash hljs">$ sudo dnf install mysql++-devel <span class="hljs-comment"><span class="hljs-comment"># for MySQL</span></span></code> </pre><br>  Sqlibrist is written in Python and has two dependencies: PyYAML and one of psycopg2 and mysql-python. <br><br>  It is installed using pip either in virtualenv or in the system libraries: <br><br><pre> <code class="bash hljs">$ pip install sqlibrist</code> </pre><br>  or <br><br><pre> <code class="bash hljs">$ sudo pip install sqlibrist</code> </pre><br>  After installation, the <b>sqlibrist</b> command becomes available. <br><br><h1>  Online Store Database </h1><br>  Let's play with Sqlibrist on the example of a primitive online store. <br><br><pre> <code class="bash hljs">$ mkdir shop_schema $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> shop_schema $ sqlibrist init Creating directories... Done.</code> </pre><br>  The <b>init</b> team created the directory structure of our project: <br><br><pre> <code class="bash hljs">shop_schema sqlibrist.yaml migrations schema constraints <span class="hljs-built_in"><span class="hljs-built_in">functions</span></span> indexes tables triggers types views</code> </pre><br>  In <b>sqlibrist.yaml</b> project configuration for connecting to the database: <br><br><pre> <code class="bash hljs">--- default: engine: pg user: &lt;username&gt; name: &lt;database_name&gt; password: &lt;password&gt; <span class="hljs-comment"><span class="hljs-comment"># host: 127.0.0.1 # port: 5432</span></span></code> </pre><br>  To verify that the settings are correct: <br><br><pre> <code class="bash hljs">$ sqlibrist test_connection Connection OK</code> </pre><br>  Next, we initialize the table where Sqlibrist will store information about the migrations applied.  This part is identical to Django Migrations / South. <br><br><pre> <code class="bash hljs">$ sqlibrist initdb Creating db... Creating schema and migrations <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> table... Done.</code> </pre><br>  By the way, in the terminology of Sqlibrist, migration is a snapshot of the base structure and patches for applying this migration or reverting to the previous one. <br><br>  Next, create the file <b>shop_schema / schema / tables / user.sql</b> : <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--UP CREATE TABLE "user" ( id SERIAL PRIMARY KEY, name TEXT, password TEXT);</span></span></code> </pre><br>  The first line <b>--UP</b> means that the following SQL statements create a database object.  This is enough to create a table. <br><br>  Similarly, create two more files: <br><br>  <b>shop_schema / schema / tables / product.sql</b> : <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--UP CREATE TABLE product ( id SERIAL PRIMARY KEY, name TEXT, price MONEY);</span></span></code> </pre><br>  <b>shop_schema / schema / tables / order.sql</b> : <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--REQ tables/user --UP CREATE TABLE "order" ( id SERIAL PRIMARY KEY, user_id INTEGER REFERENCES "user"(id), date DATE);</span></span></code> </pre><br>  Note the line <b>--REQ tables / user</b> .  It means that the current object depends on the object in the <b>tables / user.sql file</b> (the extension is not written to the REQ).  This ensures that when the patch is generated, the user table will be created before the <b>order</b> table.  All <b>--REQ</b> should go at the beginning of the file. <br><br>  Another file: <br><br>  <b>shop_schema / schema / tables / order_product.sql</b> : <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--REQ tables/order --UP CREATE TABLE order_product ( id SERIAL PRIMARY KEY, order_id INTEGER REFERENCES "order"(id), product_id INTEGER REFERENCES product(id), quantity INTEGER);</span></span></code> </pre><br>  Create the first migration: <br><br><pre> <code class="bash hljs">$ sqlibrist makemigration -n <span class="hljs-string"><span class="hljs-string">'initial'</span></span> Creating: tables/user tables/product tables/order tables/order_product Creating new migration 0001-initial</code> </pre><br>  Migration files are created in <b>shop_schema / migrations / 0001-initial</b> : <br><br><pre> <code class="bash hljs">up.sql down.sql schema.json</code> </pre><br>  <b>Up.sql</b> contains a patch for applying migration, <b>down.sql</b> in this case is empty, and <b>schema.json has a</b> snapshot of the current database structure. <br><br>  Before applying the patch, you can (and this is desirable) familiarize yourself with the text of the patch and make sure that it is doing what it needs.  If it does not suit you, delete the entire directory <b>0001-initial</b> and re-create the migration.  You can edit <b>up.sql</b> and <b>down.sql</b> if you know what you are doing, but do not touch <b>schema.json</b> . <br><br>  Now apply our first migration: <br><br><pre> <code class="bash hljs">$ sqlibrist migrate Applying migration 0001-initial... <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br>  Three tables are created.  Now we need a view that displays the user's orders with the order amounts: <br><br>  <b>shop_schema / schema / views / user_orders.sql</b> : <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--REQ tables/user --REQ tables/order --REQ tables/product --REQ tables/order_product --UP CREATE VIEW user_orders AS SELECT u.id as user_id, o.id as order_id, o.date, SUM(p.price*op.quantity) AS total FROM "user" u INNER JOIN "order" o ON u.id=o.user_id INNER JOIN order_product op ON o.id=op.order_id INNER JOIN product p ON p.id=op.product_id GROUP BY o.id, u.id; --DOWN DROP VIEW user_orders;</span></span></code> </pre><br>  Following the <b>--DOWN</b> directive, <b>there</b> are instructions for removing <b>user_orders</b> when it is being re-created. <br><br>  The general rule: we update data containing objects, for example, tables manually, so their descriptions do not contain <b>--DOWN</b> , and functions, types, indexes can be safely removed and created, so this can be entrusted to automation. <br><br>  We also need a function that returns <b>user_orders</b> for a given user: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--REQ views/user_orders --UP CREATE FUNCTION get_user_orders(_user_id INTEGER) RETURNS SETOF user_orders LANGUAGE SQL AS $$ SELECT * FROM user_orders WHERE user_id=_user_id; $$; --DOWN DROP FUNCTION get_user_orders(INTEGER);</span></span></code> </pre><br>  Create and apply the following migration: <br><br><pre> <code class="bash hljs">$ sqlibrist makemigration -n <span class="hljs-string"><span class="hljs-string">'user_orders view and function'</span></span> Creating: views/user_orders <span class="hljs-built_in"><span class="hljs-built_in">functions</span></span>/get_user_orders Creating new migration 0002-user_orders view and <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> $ sqlibrist migrate Applying migration 0002-user_orders view and <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>... <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br>  Thus, we have 4 tables, one view and one function. <br><br>  Suppose we need to add another field to the <b>user_orders</b> view.  Here are some problems that may arise: <br><br><ul><li>  we can delete and recreate a new <b>user_orders</b> view, but the database will not allow this, because the <b>get_user_orders</b> function depends on this view; </li><li>  you can cheat and get out CREATE OR REPLACE VIEW user_orders ..., but the type of the field of the form and the type of the result of the function will be different.  And in this case the database will not allow us to do this without re-creating the function. </li></ul><br>  Sqlibrist is designed to solve such problems.  Add the <b>SUM</b> field <b>(op.quantity) as order_total</b> to the <b>user_orders</b> view: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--REQ tables/user --REQ tables/order --REQ tables/product --REQ tables/order_product --UP CREATE VIEW user_orders AS SELECT u.id as user_id, o.id as order_id, o.date, SUM(p.price*op.quantity) AS total, SUM(op.quantity) as order_total FROM "user" u INNER JOIN "order" o ON u.id=o.user_id INNER JOIN order_product op ON o.id=op.order_id INNER JOIN product p ON p.id=op.product_id GROUP BY o.id, u.id; --DOWN DROP VIEW user_orders;</span></span></code> </pre><br>  You can see what has changed: <br><br><pre> <code class="bash hljs">$ sqlibrist -V diff Changed items: views/user_orders --- +++ @@ -2,7 +2,8 @@ u.id as user_id, o.id as order_id, o.date, - SUM(p.price*op.quantity) AS total + SUM(p.price*op.quantity) AS total, + SUM(op.quantity) as total_quantity FROM <span class="hljs-string"><span class="hljs-string">"user"</span></span> u INNER JOIN <span class="hljs-string"><span class="hljs-string">"order"</span></span> o ON u.id=o.user_id</code> </pre><br>  Create a migration: <br><br><pre> <code class="bash hljs">$ sqlibrist makemigration Updating: dropping: <span class="hljs-built_in"><span class="hljs-built_in">functions</span></span>/get_user_orders views/user_orders creating: views/user_orders <span class="hljs-built_in"><span class="hljs-built_in">functions</span></span>/get_user_orders Creating new migration 0003-auto</code> </pre><br>  You see that the dependent object is first removed ‚Äî the <b>get_user_orders</b> function, then the view itself.  Next, the view is created with a new structure, then the function is restored.  Such a scheme will work for dependencies of arbitrary depth (but not circular dependencies ‚Äî Sqlibrist will ask you to fix it). <br><br>  Apply this migration: <br><br><pre> <code class="bash hljs">$ sqlibrist migrate Applying migration 0003-auto... <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br>  Finally, let's make a change to the table.  Since files with table definitions do not contain <b>--DROP</b> , we will work with our hands: <br><br><ol><li>  Change the CREATE TABLE statement; </li><li>  We will generate a new migration using the same makemigration command; </li><li>  Add the required ALTER TABLE to up.sql. </li></ol><br>  Add a new <b>‚Äútype‚Äù text</b> field to the <b>product</b> table: <br><br>  <b>shop_schema / schema / tables / product.sql</b> : <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--UP CREATE TABLE product ( id SERIAL PRIMARY KEY, name TEXT, "type" TEXT, price MONEY);</span></span></code> </pre><br>  This is item 1. Now create the migration: <br><br><pre> <code class="bash hljs">$ sqlibrist makemigration -n <span class="hljs-string"><span class="hljs-string">'new product field'</span></span> Updating: dropping: <span class="hljs-built_in"><span class="hljs-built_in">functions</span></span>/get_user_orders views/user_orders creating: views/user_orders <span class="hljs-built_in"><span class="hljs-built_in">functions</span></span>/get_user_orders Creating new migration 0004-new product field</code> </pre><br>  Note that although we have changed the definition of the product table, <b>tables / product is</b> not present in the migration log, BUT all objects dependent on it are re-created.  This is point 2. <br><br>  Now point 3: open <b>shop_schema / migrations / 0004-new product field / up.sql in the editor</b> and find line 12 with the text <i>- ==== Add your instruction here ====</i> .  This is the logical middle of the migration.  At this point, all dependent objects are deleted and we can insert our ALTER TABLE. <br><br>  Insert the following: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> product <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> <span class="hljs-string"><span class="hljs-string">"type"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>;</code> </pre><br>  Our <b>up.sql</b> will look like this: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- begin -- DROP FUNCTION get_user_orders(INTEGER); -- end -- -- begin -- DROP VIEW user_orders; -- end -- -- begin -- -- ==== Add your instruction here ==== ALTER TABLE product ADD COLUMN "type" TEXT; -- end -- -- begin -- CREATE VIEW user_orders AS SELECT u.id as user_id, o.id as order_id, o.date, SUM(p.price*op.quantity) AS total, SUM(op.quantity) as total_quantity FROM "user" u INNER JOIN "order" o ON u.id=o.user_id INNER JOIN order_product op ON o.id=op.order_id INNER JOIN product p ON p.id=op.product_id GROUP BY o.id, u.id; -- end -- -- begin -- CREATE FUNCTION get_user_orders(_user_id INTEGER) RETURNS SETOF user_orders LANGUAGE SQL AS $$ SELECT * FROM user_orders WHERE user_id=_user_id; $$; -- end --</span></span></code> </pre><br>  You can apply this patch: <br><br><pre> <code class="bash hljs">$ sqlibrist migrate Applying migration 0004-new product field... <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br>  At this point, we leave alone our online store. <br><br>  Sqlibrist is also able to integrate into the Django project, I use it in this context. <br><br>  Project site - <a href="https://github.com/condograde/sqlibrist">here</a> , bug reports are welcome. </div><p>Source: <a href="https://habr.com/ru/post/282123/">https://habr.com/ru/post/282123/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282113/index.html">Emoji ?! No, I have not heard</a></li>
<li><a href="../282115/index.html">Essay tool: from idea to monetization</a></li>
<li><a href="../282117/index.html">Free Practical Courses on Basic JavaScript Programming</a></li>
<li><a href="../282119/index.html">We write a simple file parser (for beginners)</a></li>
<li><a href="../282121/index.html">The new cryptographer CryptoBit is distributed through exploit kits that affect the browser.</a></li>
<li><a href="../282125/index.html">How I tried Microsoft Project Oxford + Telegram Bot API</a></li>
<li><a href="../282127/index.html">Striving for nil: how the prices for mobile communications have changed in a quarter of a century</a></li>
<li><a href="../282129/index.html">Work with geofences (geofences) in Android. Update</a></li>
<li><a href="../282131/index.html">Introduction to Shader Programming: Part 3</a></li>
<li><a href="../282133/index.html">SpyEye authors were given 24 years for two</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>