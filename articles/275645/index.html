<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Systemd: write your own .service and .target</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I got Linux on my home computer, and I hurried to get used to the new OS. It was installed with the systemd init process. This was my first acquaintan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Systemd: write your own .service and .target</h1><div class="post__text post__text-html js-mediator-article">  I got Linux on my home computer, and I hurried to get used to the new OS.  It was installed with the systemd init process.  This was my first acquaintance with this new tool.  I use my laptop for everyday life and for programming.  I wanted to include work programs (Apache2 and MySQL) only for a while, while I use them, so as not to waste my computer resources.  Additionally, for testing, I wrote a bash script that dumps the contents of one of the MySQL databases from the hard disk into RAM (in tmpfs) - so the tests are performed much faster.  In theory, I could start my work day like this: <br><pre><code class="bash hljs">systemctl start apache2.service systemctl start mysqld.service /root/scripts/mysqld-tmpfs start</code> </pre> <br>  And finish it: <br><pre> <code class="bash hljs">systemctl stop apache2.service systemctl stop mysqld.service /root/scripts/mysqld-tmpfs stop</code> </pre><br>  But I wanted to do things ‚Äúright‚Äù. <br><a name="habracut"></a><br><h4>  What did I want? </h4><br>  I wanted to achieve 2 goals: <br><ol><li>  I was too lazy to write 2 commands (running apache and starting mysql), because  I knew that both programs would always be turned off and on synchronously.  I wanted to perform this operation as a team. </li><li>  The case smacked of trouble, if the computer restarts while my database is sitting in tmpfs - all files will be lost.  Of course, I made backups, but again I was too lazy to restore them manually after each unexpected reboot. </li></ol><br><br><h4>  What I've done? </h4><br>  In the end, I combined Apache2 and MySQL into one target.  This allowed both services to be started with the same command.  And I declared my mysqld-tmpfs script as a service in the eyes of systemd.  Being a service, I am sure that systemd will correctly stop it if the system goes to reboot or some other abnormal situation, and my database will be saved to the hard disk without loss. <br><br><h4>  What is a service? </h4><br>  This is some kind of program that runs in the background and provides useful functionality.  For example, Apache web server.  Services can be started and stopped.  Some services can start and stop automatically on certain events (OS loading, OS unloading, etc.).  They can also be started / stopped manually.  The service is declared in the /etc/systemd/system/my-name.service files (with the suffix ‚Äú.service‚Äù). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  What is target? </h4><br>  Target in systemd is very similar to runlevel in openRC, but it‚Äôs still different things.  First, the target allows you to group 1 or more services into a single unit.  By grouping services into targets, they are easier to manage.  Secondly, systemd automatically turns on / off targets for events.  ‚ÄúTurning on‚Äù the target means turning on all the services that it combines in itself.  For example, if systemd has target configured as default my-favorite.target, then when systemd to boot, systemd will turn on all services that are declared inside my-favorite.target.  At some point in the console, you can type: <br><pre> <code class="bash hljs">systemctl isolate my-another.target</code> </pre><br>  All services from my-another.target will be enabled, and all enabled services not from my-another.target will be disabled.  This is very similar to the runRC switching in openRC.  However, systemd supports the inclusion of more than 1 target.  Here is an example: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   my-favorite.target      systemctl isolate my-favorite.target #      targets   1 target systemctl start my-another.target</span></span></code> </pre><br>  After these commands are executed, the system will combine the services from my-favorite.target and my-another.target. <br><br><h4>  How did I do it? </h4><br>  In the end, I got this mysqld-tmpfs.service file: <br><pre> <code class="bash hljs">Description=Mount a MySQL database into tmpfs. <span class="hljs-comment"><span class="hljs-comment">#  /root/scripts/tmpfs      ,     mysql .    mysql    ,  ,      : #Requires=mysqld.service #After=mysqld.service [Service] #   systemd,        1 . Man page    . Type=oneshot #      . ExecStart=/root/scripts/mysqld-tmpfs start #      . ExecStop=/root/scripts/mysqld-tmpfs stop #   systemd,     ,       .   ,   :          ,    , ..    . RemainAfterExit=yes</span></span></code> </pre><br>  And here is such a programming.target file: <br><pre> <code class="bash hljs">[Unit] Description=Working/Programming target Requires=mysqld.service Requires=apache2.service <span class="hljs-comment"><span class="hljs-comment">#       ‚ÄúRequires=another.service‚Äù,       .</span></span></code> </pre><br><br><h4>  What were the problems? </h4><br>  When stopping programming.target for some reason, the underlying apache2.service and mysqld.service did not stop.  Having read the man page properly, I found the problem: systemd stops the services ‚Äúlazily‚Äù - if no one requires the started service and it was not started explicitly, but as a dependency for some other service, systemd will stop it only with one of the 3 circumstances: <br><ol><li>  Some other service will start, which in its declaration indicates that it conflicts with our service. </li><li>  Run systemctl isolate some-another.target or systemctl stop this.service. </li><li>  Our service can request in its declaration to stop itself not in a lazy way, but in an active way, adding the following section to the [Unit] section: StopWhenUnneeded = true </li></ol><br><br>  Declarations of ‚Äúforeign‚Äù services can be changed by creating files /etc/systemd/system/name-i-alter.service.d/*.conf.  I just created /etc/systemd/system/apache2.service/auto-stop.conf and /etc/systemd/system/mysqld.service.d/auto-stop.conf and put that line there. <br><br>  Another problem that I stumbled upon was that systemd does not like symlinks very much.  I'm not a big fan of ‚Äúmessing up‚Äù system directories like / etc, / bin, / usr with my local waste products, so initially I tried my /etc/systemd/system/mysqld-tmpfs.service to symlink to / root / scripts / mysqld- tmpfs.service file i.  store the file itself in the user's home root directory.  But the systemctl team refused to work with such a service giving out obscure errors.  It turned out that the systemd makes a certain part of its internal kitchen on symlinks, and then it is ‚Äúdifficult‚Äù for it to distinguish the internal kitchen (its symlinks) from third-party * .service files (if they are symlinks too).  Removing symlink from /etc/systemd/system/mysqld-tmpfs.service and copying the contents of this file there, I solved this problem.  A more detailed description of this problem can be found here: <a href="https://bugzilla.redhat.com/show_bug.cgi%3Fid%3D955379">bugzilla.redhat.com/show_bug.cgi?id=955379</a> <br><br><h4>  Result </h4><br>  I achieved my goal.  Starting a working day: <br><pre> <code class="bash hljs">systemctl start programming.target</code> </pre><br>  When you need to run tests on your project: <br><pre> <code class="bash hljs">systemctl start mysqld-tmpfs.service</code> </pre><br>  When I want to remove the database from tmpfs to the hard disk (although in practice I almost don‚Äôt do that, I just leave the database to tmpfs for a whole day, and when I turn off, systemd starts dismantling from tmpfs to my hard disk): <br><pre> <code class="bash hljs">systemctl stop mysqld-tmpfs.service</code> </pre><br>  When I finished work and I want to stop working programs: <br><pre> <code class="bash hljs">systemctl stop programming.target</code> </pre><br><br><h4>  Cheat sheet </h4><br>  Some useful things when working with systemd: <br><ul><li>  Call systemctl daemon-reload if you change the declaration of something (systemd reads the declaration files again) </li><li>  systemctl start my-name. (service | target) - start service or target </li><li>  systemctl stop my-name. (service | target) - service stop or target </li><li>  systemctl enable my-name.service - services can declare under which enabled targets they should be enabled.  To do this, use the [Install] section in the service declaration file.  You, as a sysadmin, have the authority to install this ‚Äúwish‚Äù service.  Often, services are ‚Äúinstalled‚Äù in the target by default multi-user.target or similar. </li><li>  systemctl disable my-name.service is the reverse operation of enable: de-associate the connection between my-name.service and targets that he requested in the [Install] section of his declaration. </li><li>  systemctl isolate my.target ‚Äî turn on all services from my.target and turn off all other enabled services. </li><li>  systemctl status my-name. (service | target) - find out the status (started / stopped) from the service or target. </li></ul><br><br>  I hope this article will help someone with the mastering systemd.  I tried to make it compact, and if I missed any additional questions from attention, ask in the comments! </div><p>Source: <a href="https://habr.com/ru/post/275645/">https://habr.com/ru/post/275645/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../275633/index.html">Microservice design patterns</a></li>
<li><a href="../275637/index.html">Critically dangerous vulnerabilities discovered in FreeBSD</a></li>
<li><a href="../275639/index.html">Expansion of a network of monitoring sites: Europe, Latin America, India</a></li>
<li><a href="../275641/index.html">Welcome to Moscow CocoaHeads January 29</a></li>
<li><a href="../275643/index.html">How to run i2pd for the first time: instruction under Debian / Ubuntu</a></li>
<li><a href="../275647/index.html">How to use i2pd: a comprehensive instruction under MS Windows</a></li>
<li><a href="../275649/index.html">Project Abacus from Google: biometrics instead of a password</a></li>
<li><a href="../275651/index.html">Common Lisp SDL2 Tutorial</a></li>
<li><a href="../275655/index.html">Setting up Google Mail in 3CX Phone System</a></li>
<li><a href="../275659/index.html">Reverse engineering protocol of the TFA Spring weather station sensor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>