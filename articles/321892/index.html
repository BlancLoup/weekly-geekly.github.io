<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The answer to the introduction to the design of entities, the problem of creating objects</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After reading the article Introduction to the design of entities, the problem of creating objects in Habr√©, I decided to write a detailed comment on e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The answer to the introduction to the design of entities, the problem of creating objects</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/253/22c/d13/25322cd136904f059edd2d0c789e3428" align="left">  After reading the article <a href="https://habrahabr.ru/post/321340/">Introduction to the design of entities, the problem of creating objects</a> in Habr√©, I decided to write a detailed comment on examples of using the <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25BE%25D0%25B1%25D0%25BB%25D0%25B5%25D0%25BC%25D0%25BD%25D0%25BE-%25D0%25BE%25D1%2580%25D0%25B8%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">Domain-driven design (DDD)</a> , but, as usual, the comment was too big and I thought it was right to write a full article, especially since DDD, on Habr√© and not only, little attention is removed. </p><br><p>  I recommend reading the article about which I will speak here. <br>  In short, the author suggests using <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2582%25D1%2580%25D0%25BE%25D0%25B8%25D1%2582%25D0%25B5%25D0%25BB%25D1%258C_(%25D1%2588%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BD_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F)">builders</a> to control the consistency of data in essence when using the DDD approach.  I want to suggest using <a href="https://ru.wikipedia.org/wiki/DTO">Data Transfer Object (DTO)</a> for this purpose. </p><br><a name="habracut"></a><br><p>  The general structure of the entity class discussed by the author: </p><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $id, $corporateForm, $name, $generalManager, $country, $city, $street, $subway = null )</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span></span>; }</code> </pre> <br><p>  and an example of using the builder </p><br><pre> <code class="php hljs">$client = $builder-&gt;setId($id) -&gt;setName($name) -&gt;setGeneralManagerId($generalManager) -&gt;setCorporateForm($corporateForm) -&gt;setAddress($address) -&gt;buildClient();</code> </pre> <br><p>  You can not go into details of the implementation, I think the general sense is clear. </p><br><p>  The idea of ‚Äã‚Äãusing the builder in this example is not bad, but in my opinion the builder is not needed here.  Having taken setters from the entity to the builder, they did not cease to be setters.  The author created an extra builder when you could just pass the parameters to the constructor or the factory method.  Forgetting a setter is easier than an argument. </p><br><blockquote>  <em>I think you know without me what the setters are bad with DDD approach.</em>  <em>In short, they break encapsulation and do not guarantee the consistency of data at any time.</em> </blockquote><p>  If we are talking about DDD, then it is better to consider the business processes associated with the entity. </p><br><p>  For example, consider registering a new client and transferring an existing client to another manager.  This can be considered as requests to perform operations on an entity and create DTOs for each action.  We get this picture: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Client</span></span>\<span class="hljs-title"><span class="hljs-title">Request</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegisterClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $name = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $manager; <span class="hljs-comment"><span class="hljs-comment">// Manager public $address; // Address }</span></span></code> </pre> <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Client</span></span>\<span class="hljs-title"><span class="hljs-title">Request</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DelegateClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $new_manager; <span class="hljs-comment"><span class="hljs-comment">// Manager }</span></span></code> </pre> <br><p>  Based on the request from the user, we create a DTO, validate and create / edit an entity based on it. </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Client</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $id; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $name = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $manager; <span class="hljs-comment"><span class="hljs-comment">// Manager private $address; // Address private function __construct( IdGenerator $generator, string $name, Manager $manager, Address $address ) { $this-&gt;id = $generator-&gt;generate(); $this-&gt;name = $name; $this-&gt;manager = $manager; $this-&gt;address = $address; } //   ,      public static function register(IdGenerator $generator, RegisterClient $request) : Client { return new self($generator, $request-&gt;name, $request-&gt;manager, $request-&gt;address); } public function delegate(DelegateClient $request) { $this-&gt;manager = $request-&gt;new_manager; } }</span></span></code> </pre> <br><p>  Wait.  That's not all.  Suppose we need to know when the client card was registered and updated.  This is done in just a couple of lines: </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... private $date_create; // \DateTime private $date_update; // \DateTime private function __construct( IdGenerator $generator, string $name, Manager $manager, Address $address ) { // ... $this-&gt;date_create = new \DateTime(); $this-&gt;date_update = clone $this-&gt;date_create; } // ... public function delegate(DelegateClient $request) { $this-&gt;manager = $request-&gt;new_manager; $this-&gt;date_update = new \DateTime(); } }</span></span></code> </pre> <br><p>  The obvious solution at first glance has a flaw that will manifest itself during testing.  The problem is that we explicitly initialize the date object.  In reality, this is the date the action is performed on the entity and the logical decision will be to initialize the request DTO. </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegisterClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... public $date_action; // \DateTime public function __construct() { $this-&gt;date_action = new \DateTime(); } }</span></span></code> </pre> <br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DelegateClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... public $date_action; // \DateTime public function __construct() { $this-&gt;date_action = new \DateTime(); } }</span></span></code> </pre> <br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... private function __construct( IdGenerator $generator, string $name, Manager $manager, Address $address, \DateTime $date_action ) { $this-&gt;id = $generator-&gt;generate(); $this-&gt;name = $name; $this-&gt;manager = $manager; $this-&gt;address = $address; $this-&gt;date_create = clone $date_action; $this-&gt;date_update = clone $date_action; } public static function register(IdGenerator $generator, RegisterClient $request) : Client { return new self( $generator, $request-&gt;name, $request-&gt;manager, $request-&gt;address, $request-&gt;date_action ); } public function delegate(DelegateClient $request) { $this-&gt;manager = $request-&gt;new_manager; $this-&gt;date_update = clone $request-&gt;date_action; } }</span></span></code> </pre> <br><p>  If we know when the card was edited, then it would be nice to know who edited it.  Again, it is logical to bring this to the DTO.  The request for editing someone performs. </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegisterClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... public $user; // User public function __construct(User $user) { // ... $this-&gt;user = $user; } }</span></span></code> </pre> <br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DelegateClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... public $user; // User public function __construct(User $user) { // ... $this-&gt;user = $user; } }</span></span></code> </pre> <br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... private $user; // User private function __construct( IdGenerator $generator, string $name, Manager $manager, Address $address, \DateTime $date_action, User $user ) { $this-&gt;id = $generator-&gt;generate(); $this-&gt;name = $name; $this-&gt;manager = $manager; $this-&gt;address = $address; $this-&gt;date_create = clone $date_action; $this-&gt;date_update = clone $date_action; $this-&gt;user = $user; } public static function register(IdGenerator $generator, RegisterClient $request) : Client { return new self( $generator, $request-&gt;name, $request-&gt;manager, $request-&gt;address, $request-&gt;date_action, $request-&gt;user ); } public function delegate(DelegateClient $request) { $this-&gt;manager = $request-&gt;new_manager; $this-&gt;date_update = clone $request-&gt;date_action; $this-&gt;user = $request-&gt;user; } }</span></span></code> </pre> <br><p>  Now we want to add more action on the entity.  Add a change to the name of the client and his address  These are the same actions on an entity as others, therefore we create DTO by analogy. </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Client</span></span>\<span class="hljs-title"><span class="hljs-title">Request</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MoveClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $new_address; <span class="hljs-comment"><span class="hljs-comment">// Address public $date_action; // \DateTime public $user; // User public function __construct(User $user) { $this-&gt;date_action = new \DateTime(); $this-&gt;user = $user; } }</span></span></code> </pre> <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Client</span></span>\<span class="hljs-title"><span class="hljs-title">Request</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RenameClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $new_name = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $date_action; <span class="hljs-comment"><span class="hljs-comment">// \DateTime public $user; // User public function __construct(User $user) { $this-&gt;date_action = new \DateTime(); $this-&gt;user = $user; } }</span></span></code> </pre> <br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... public function move(MoveClient $request) { $this-&gt;address = $request-&gt;new_address; $this-&gt;date_update = clone $request-&gt;date_action; $this-&gt;user = $request-&gt;user; } public function rename(RenameClient $request) { $this-&gt;name = $request-&gt;new_name; $this-&gt;date_update = clone $request-&gt;date_action; $this-&gt;user = $request-&gt;user; } }</span></span></code> </pre> <br><p>  Do you notice code duplication?  Then it will be even worse. </p><br><p>  Now we want to log a change in the client's card in the database in order to know which employees to kick their ears in case something happens.  This is a new entity.  In the log we will write: </p><br><ul><li>  Who </li><li>  When </li><li>  What did you do </li><li>  What IP </li><li>  Which device </li></ul><br><p>  <em>I give it only as an example.</em>  <em>In this case, you can get by the log file, but for example, in the case of voting or likes, each request may be important to us separately.</em> </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Client</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Change</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $client; <span class="hljs-comment"><span class="hljs-comment">// Client private $change = ''; private $user; // User private $user_ip = ''; private $user_agent = ''; private $date_action; // \DateTime public function __construct( Client $client, string $change, User $user, string $user_ip, string $user_agent, \DateTime $date_action ) { $this-&gt;client= $client; $this-&gt;change = $change; $this-&gt;user = $user; $this-&gt;user_ip = $user_ip; $this-&gt;user_agent = $user_agent; $this-&gt;date_action = clone $date_action; } }</span></span></code> </pre> <br><p>  Thus, in the DTO action we need to add information from the HTTP request. </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">HttpFoundation</span></span>\<span class="hljs-title"><span class="hljs-title">Request</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegisterClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $name = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $manager; <span class="hljs-comment"><span class="hljs-comment">// Manager public $address; // Address public $date_action; // \DateTime public $user; // User public $user_ip = ''; public $user_agent = ''; public function __construct(User $user, string $user_ip, string $user_agent) { $this-&gt;date_action = new \DateTime(); $this-&gt;user = $user; $this-&gt;user_ip = $user_ip; $this-&gt;user_agent = $user_agent; } //     public static function createFromRequest(User $user, Request $request) : RegisterClient { return new self($user, $request-&gt;getClientIp(), $request-&gt;headers-&gt;get('user-agent')); } }</span></span></code> </pre> <br><p>  <em>The remaining DTOs are modified by analogy.</em> </p><br><p>  The author of the change and the date of the change we no longer need to be kept in essence, since we have a change log.  Remove these fields from the entity and add logging. </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $id; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $name = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $manager; <span class="hljs-comment"><span class="hljs-comment">// Manager private $address; // Address private $changes = []; // Change[] private function __construct( IdGenerator $generator, string $name, Manager $manager, Address $address, \DateTime $date_action, User $user, string $user_ip, string $user_agent ) { $this-&gt;id = $generator-&gt;generate(); $this-&gt;name = $name; $this-&gt;manager = $manager; $this-&gt;address = $address; $this-&gt;date_create = clone $date_action; $this-&gt;changes[] = new Change($this, 'create', $user, $user_ip, $user_agent, $date_action); } public static function register(IdGenerator $generator, RegisterClient $request) : Client { return new self( $generator, $request-&gt;name, $request-&gt;manager, $request-&gt;address, $request-&gt;date_action, $request-&gt;user, $request-&gt;user_ip, $request-&gt;user_agent ); } public function delegate(DelegateClient $request) { $this-&gt;manager = $request-&gt;new_manager; $this-&gt;changes[] = new Change( $this, 'delegate', $request-&gt;user, $request-&gt;user_ip, $request-&gt;user_agent, $request-&gt;date_action ); } //     }</span></span></code> </pre> <br><p>  Now we create a new log instance for each action and we cannot put it into a separate method as the query class differs, although the fields are similar. </p><br><p>  To solve this problem, I use contracts.  Let's create this: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">UserAction</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthorizedUserActionInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">User</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserIp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserAgent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDateAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : \</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DateTime</span></span></span></span>; }</code> </pre> <br><p>  The interface can contain only methods.  It cannot contain properties.  This is one of the reasons why I prefer to use getters and setters in DTO, rather than public properties. </p><br><p>  We will immediately implement for quick connection of this contract: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">UserAction</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">HttpFoundation</span></span>\<span class="hljs-title"><span class="hljs-title">Request</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">trait</span></span> AuthorizedUserActionTrait { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">User</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;user; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserIp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;user_ip; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserAgent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;user_agent; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDateAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : \</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DateTime</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;date_action; } <span class="hljs-comment"><span class="hljs-comment">//    protected function fillFromRequest(User $user, Request $request) { $this-&gt;user = $user; $this-&gt;user_agent = $request-&gt;headers-&gt;get('user-agent'); $this-&gt;user_ip = $request-&gt;getClientIp(); $this-&gt;date_action = new \DateTime(); } }</span></span></code> </pre> <br><p>  Add our contract to DTO: </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegisterClient</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthorizedUserActionInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">AuthorizedUserActionTrait</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $name = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $manager; <span class="hljs-comment"><span class="hljs-comment">// Manager protected $address; // Address protected $date_action; // \DateTime protected $user; // User protected $user_ip = ''; protected $user_agent = ''; public function __construct(User $user, Request $request) { $this-&gt;fillFromRequest($user, $request); } //... }</span></span></code> </pre> <br><p>  Update the client change log so that it uses our new contract: </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Change</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $client; <span class="hljs-comment"><span class="hljs-comment">// Client private $change = ''; private $user; // User private $user_ip = ''; private $user_agent = ''; private $date_action; // \DateTime //      public function __construct( Client $client, string $change, AuthorizedUserActionInterface $action ) { $this-&gt;client = $client; $this-&gt;change = $change; $this-&gt;user = $action-&gt;getUser(); $this-&gt;user_ip = $action-&gt;getUserIp(); $this-&gt;user_agent = $action-&gt;getUserAgent(); $this-&gt;date_action = $action-&gt;getDateAction(); } }</span></span></code> </pre> <br><p>  Now we will create a change log based on our contract: </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... private function __construct( IdGenerator $generator, string $name, Manager $manager, Address $address, \DateTime $date_action ) { $this-&gt;id = $generator-&gt;generate(); $this-&gt;name = $name; $this-&gt;manager = $manager; $this-&gt;address = $address; $this-&gt;date_create = $date_action; } public static function register(IdGenerator $generator, RegisterClient $request) : Client { $self = new self( $generator, $request-&gt;getName(), $request-&gt;getManager(), $request-&gt;getAddress(), $request-&gt;getDateAction() ); $self-&gt;changes[] = new Change($self, 'register', $request); return $self; } public function delegate(DelegateClient $request) { $this-&gt;manager = $request-&gt;getNewManager(); $this-&gt;changes[] = new Change($this, 'delegate', $request); } public function move(MoveClient $request) { $this-&gt;address = $request-&gt;getNewAddress(); $this-&gt;changes[] = new Change($this, 'move', $request); } public function rename(RenameClient $request) { $this-&gt;name = $request-&gt;getNewName(); $this-&gt;changes[] = new Change($this, 'rename', $request); } }</span></span></code> </pre> <br><p>  We have already significantly simplified the client classes and requests for its change.  The next stage of development can be domain events.  Should I use them is a moot point, but I will give them as an example: </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AggregateEventsInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">AggregateEventsRaiseInSelfTrait</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ... public static function register(IdGenerator $generator, RegisterClient $request) : Client { // ... $self-&gt;raise(new ChangeEvent($self, 'register', $request)); return $self; } public function delegate(DelegateClient $request) { // ... $this-&gt;raise(new ChangeEvent($this, 'delegate', $request)); } //     //         $this-&gt;raise(); public function onChange(ChangeEvent $event) { $this-&gt;changes[] = new Change($this, $event-&gt;getChange(), $event-&gt;getRequest()); } }</span></span></code> </pre> <br><p>  This was a small example of the evolution of the project using the DDD approach.  This example is not the ultimate truth.  Many things can be done differently.  DDD is so good that everyone has his own. </p><br><h2 id="ssylki">  Links </h2><br><ul><li>  <a href="https://habrahabr.ru/post/321340/">Original article</a> </li><li>  <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25BE%25D0%25B1%25D0%25BB%25D0%25B5%25D0%25BC%25D0%25BD%25D0%25BE-%25D0%25BE%25D1%2580%25D0%25B8%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">Domain-driven design (DDD)</a> </li><li>  <a href="https://ru.wikipedia.org/wiki/DTO">Data Transfer Object (DTO)</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/321892/">https://habr.com/ru/post/321892/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321882/index.html">Install MLDonkey and DC ++ plugin for it</a></li>
<li><a href="../321884/index.html">PyNSK # 12 - February meeting of the Pitonists of Novosibirsk</a></li>
<li><a href="../321886/index.html">How IT professionals work. Andrei Makarov, Neti company</a></li>
<li><a href="../321888/index.html">DALI light control with Arduino</a></li>
<li><a href="../321890/index.html">Creating your own View for Android - can something go wrong?</a></li>
<li><a href="../321894/index.html">Zabbix data monitoring in Oracle database without unixODBC</a></li>
<li><a href="../321896/index.html">Unknown cyber grouping has attacked 140 companies in 40 countries with legitimate software</a></li>
<li><a href="../321898/index.html">CEF, ES6, Angular 2, WebPack 2 .Net Core desktop application without server side</a></li>
<li><a href="../321900/index.html">That's what life-giving quantum does.</a></li>
<li><a href="../321902/index.html">Vim and switch layouts: about sore</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>