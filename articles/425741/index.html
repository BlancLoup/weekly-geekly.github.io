<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Docotic.Pdf: What problems will PVS-Studio detect in a mature project?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quality is important to us. And we have heard about PVS-Studio. All this led to the desire to check Docotic.Pdf and find out what else can be improved...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Docotic.Pdf: What problems will PVS-Studio detect in a mature project?</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/tt/fj/-u/ttfj-uhwy2ogamewgz6zit48lni.png" alt="Docotic.Pdf and PVS-studio"></div><br>  Quality is important to us.  And we have heard about PVS-Studio.  All this led to the desire to check Docotic.Pdf and find out what else can be improved. <br><a name="habracut"></a><br>  <a href="https://bitmiracle.com/pdf-library/">Docotic.Pdf</a> is a general purpose library for working with PDF files.  Written in C #, no unsafe code, no external dependencies other than .NET runtime.  It works both under .NET 4+ and under .NET Standard 2+. <br><br>  The library has been in development for a little over 10 years and it has 110 thousand lines of code without taking tests, examples and other things into account.  For static analysis, we constantly use Code Analysis and StyleCop.  Several thousand automatic tests protect us from regressions.  Our clients from different countries and different industries trust the quality of the library. <br><br>  What problems will PVS-Studio detect? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Installation and first impression </h3><br>  I downloaded the trial version from the PVS-Studio website.  Pleasantly surprised by the small size of the installer.  Installed with the default settings: analysis engines, a separate PVS-Studio environment, integration into Visual Studio 2017. <br><br>  After installation, nothing started, and two shortcuts with identical icons were added to the Start menu: Standalone and PVS-Studio.  For a moment I wondered what to launch.  I launched Standalone and was unpleasantly surprised by the interface.  The 200% scale set for my Windows is supported crookedly.  Part of the text is too small, part of the text does not fit in the space reserved for it.  The name, Unicorn, and Actions list are cropped at any window size.  Even with full screen. <br><br><img src="https://habrastorage.org/webt/ll/3k/c5/ll3kc5bovj5wkbvtldfz9zhzpzk.png"><br><br>  Well, okay, I decided to open my project file.  Suddenly, the File menu did not find such an option.  There I was offered only to open separate files.  Thank you, I thought, I‚Äôll try another option.  I launched PVS-Studio - they showed me a window with blurred text.  Scale 200% again made itself felt.  Text reported: <s>look for me in ‚ÄúThree Crowns‚Äù;</s> look for the PVS-Studio menu in Visual Studio.  Well, opened the Studio. <br><br>  Opened the solution.  Indeed, there is a PVS-Studio menu, and in it there is an opportunity to check ‚ÄúCurrent Project‚Äù.  I made the project I needed current and launched the check.  Below in the Studio a window appeared with the results of the analysis.  A window with the progress of the checkout appeared in the background, but I did not immediately find it.  At first there was a feeling that the test did not start or immediately ended. <br><br><h3>  The result of the first check </h3><br>  The analyzer checked all 1253 project files in approximately 9 minutes and 30 seconds.  By the end of the check, the file counter did not change as quickly as at the beginning.  Perhaps there is some non-linear dependence of the scan duration on the number of files to be scanned. <br><br>  Information about 81 High, 109 Medium and 175 Low warnings appeared in the results window.  If you count the frequency, you get 0.06 High warnings / file, 0.09 Medium warnings / file, and 0.14 Low warnings / per file.  Or <br>  0.74 High warnings per thousand lines of code, 0.99 Medium warnings per thousand lines of code, and 1.59 Low warnings per thousand lines of code. <br><br>  Here <a href="https://habr.com/company/pvs-studio/blog/328354/">in this article it is indicated</a> that in CruiseControl.NET with its 256 thousand lines of code, the analyzer found 15 High, 151 Medium and 32 Low warnings. <br><br>  It turns out that as a percentage for Docotic.Pdf, more warnings were issued in each group. <br><br><h3>  What is found? </h3><br>  Warnings Low I decided to disregard at this stage. <br><br>  I sorted out warnings on the Code column and it turned out that <a href="https://www.viva64.com/ru/w/v3022/">V3022</a> "Expression is always true / false" and <a href="https://www.viva64.com/ru/w/v3063/">V3063</a> "If it is evaluated", became the absolute frequency record holder.  In my opinion, they are about one thing.  In total, these two warnings give 92 cases out of 190. Relative frequency = 48%. <br><br>  The logic of division into High and Medium is not entirely clear.  I expected <a href="https://www.viva64.com/ru/w/v3072/">V3072</a> "The 'A' class containing IDisposable members doesn‚Äôt itself implement IDisposable" and <a href="https://www.viva64.com/ru/w/v3073/">V3073</a> "Not all IDisposable members are properly disposed.  Call 'Dispose' when disposing 'A' class' in the High group, for example.  But it tastes, of course. <br><br>  I was surprised that <a href="https://www.viva64.com/ru/w/v3095/">V3095</a> ‚ÄúThe object was used before it was verified against null.  Check lines: N1, N2 ‚Äùis marked twice as High and once as Medium.  Bug <br><br><img src="https://habrastorage.org/webt/kz/dk/e8/kzdke88cvkewlgqplmw4xlp55ym.png"><br><br><h3>  Trust but check </h3><br>  It is time to check whether the received warnings are justified.  Are any real errors found?  Are there any incorrect warnings? <br><br>  I divided the warnings I found into groups below. <br><br><h4>  Important warnings </h4><br>  Their correction increased the stability of work, solved problems with memory leaks, etc.  Real errors / imperfections. <br><br>  There were 16 of them, which is about 8% of all warnings. <br><br>  I will give some examples. <br><br>  <a href="https://www.viva64.com/ru/w/v3019/">V3019</a> "Possibly incorrectly variable compared to null after type conversion using 'as' keyword.  Check variables 'color', 'indexed' ¬ª <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsCompatible</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ColorImpl color</span></span></span><span class="hljs-function">)</span></span> { IndexedColorImpl indexed = color <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IndexedColorImpl; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (color == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> indexed.ColorSpace.Equals(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); }</code> </pre> <br>  As you can see, instead of indexed, the variable color is compared with null.  This is wrong and can lead to NRE. <br><br>  <a href="https://www.viva64.com/ru/w/v3080/">V3080</a> ‚ÄúPossible null dereference.  Consider inspecting 'cstr_index.tile_index' ¬ª <br><br>  A small fragment for illustration: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cstr_index.tile_index == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cstr_index.tile_index[<span class="hljs-number"><span class="hljs-number">0</span></span>].tp_index == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// .. } }</span></span></code> </pre><br>  Obviously, the first condition implied! = Null.  In the current view, the code will call NRE each time it is called. <br><br>  <a href="https://www.viva64.com/ru/w/v3083/">V3083</a> ‚ÄúUnsafe invocation of event 'OnProgress', NullReferenceException is possible.  Consider assigning an event to a local variable before invoking it. ‚Äù <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Updated</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (OnProgress != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) OnProgress(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EventArgs()); }</code> </pre><br>  The warning helped correct a potential exception.  Why can it occur?  There is a <a href="https://stackoverflow.com/q/3668953/249690">good explanation</a> on Stackoverflow. <br><br>  <a href="https://www.viva64.com/ru/w/v3106/">V3106</a> ‚ÄúPossibly index is out of bounds.  The '0' index is pointing beyond 'v' bound ¬ª <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;FontStringPair&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; text.Length; ++i) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> v = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;FontStringPair&gt;(); createPairs(text[i].ToString(CultureInfo.InvariantCulture)); result.Add(v[<span class="hljs-number"><span class="hljs-number">0</span></span>]); }</code> </pre><br>  The error is that the result of createPairs is ignored, and instead an appeal is made to the empty list.  Apparently, initially createPairs took the list as a parameter, but an error was made during the method change process. <br><br>  <a href="https://www.viva64.com/ru/w/v3117/">V3117</a> "Constructor parameter 'validateType' is not used <br><br>  An alert has been issued for code similar to <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SomeClass</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IDocument document, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> validateType = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">true</span></span></span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">document, </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">true</span></span></span></span></span><span class="hljs-function">)</span></span> { m_provider = document; }</code> </pre><br>  The warning itself does not seem important.  But the problem is more serious than it seems at first glance.  In the process of adding the optional parameter validateType, the call to the constructor of the base class was forgotten fixed. <br><br>  <a href="https://www.viva64.com/ru/w/v3127/">V3127</a> ‚ÄûTwo similar code fragments were found.  Perhaps this is a typo and a range of variable should be used instead of a domain <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fillTransferFunction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">PdfStreamImpl function</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// .. PdfArrayImpl domain = new PdfArrayImpl(); domain.AddReal(0); domain.AddReal(1); function.Add(Field.Domain, domain); PdfArrayImpl range = new PdfArrayImpl(); range.AddReal(0); range.AddReal(1); function.Add(Field.Range, domain); // .... }</span></span></code> </pre><br>  Perhaps a warning will not be issued if parts of the code are slightly different.  But in this case, an error was found when using copy-paste. <br><br><h4>  Theoretical / formal warnings </h4><br>  They are either correct, but fixing them does not fix any specific errors and does not affect the readability of the code.  Or they point to places where there could be a mistake, but there is none.  For example, the order of the parameters is intentionally changed.  For such alerts do not need to change anything in the program. <br><br>  There were 57 of them, which is about 30% of all warnings.  I will give examples for cases that deserve attention. <br><br>  <a href="https://www.viva64.com/ru/w/v3013/">V3013</a> ‚ÄúIt is the odd that the body of the BeginText function is fully equivalent to the body of the EndText function (166, line 171)‚Äú <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BeginText</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { m_state.ResetTextParameters(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EndText</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { m_state.ResetTextParameters(); }</code> </pre><br>  Both body functions are actually the same.  But it is right.  And is it really strange if the bodies of functions from one line coincide? <br><br>  <a href="https://www.viva64.com/ru/w/v3106/">V3106</a> ‚ÄûPossible negative index value.  The value of 'c1' index could reach -1 ‚Äú <br><br><pre> <code class="cs hljs">freq[<span class="hljs-number"><span class="hljs-number">256</span></span>] = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">// .... c1 = -1; v = 1000000000L; for (i = 0; i &lt;= 256; i++) { if (freq[i] != 0 &amp;&amp; freq[i] &lt;= v) { v = freq[i]; c1 = i; } } // .... freq[c1] += freq[c2];</span></span></code> </pre><br>  It agree, I resulted a slice of not the most clear algorithm.  But, in my opinion, in this case, the analyzer suffers in vain. <br><br>  <a href="https://www.viva64.com/ru/w/v3107/">V3107</a> "Identical expression 'neighsum' to the left and to the right of compound assignment" <br><br>  The warning is caused by a completely banal code: <br><br><pre> <code class="cs hljs">neighsum += neighsum;</code> </pre><br>  Yes, it can be rewritten via multiplication.  But there is no error. <br><br>  <a href="https://www.viva64.com/ru/w/v3109/">V3109</a> ‚ÄûThe 'l_cblk.data_current_size' The sub-expression is present on both sides of the operator.  The expression is incorrect or it can be simplified. ‚Äú <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/* Check possible overflow on size */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((l_cblk.data_current_size + l_seg.newlen) &lt; l_cblk.data_current_size) { <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre><br>  A comment in the code explains the intent.  False alarm again. <br><br><h4>  Reasonable warnings </h4><br>  Their correction had a positive effect on the readability of the code.  That is, reduced unnecessary conditions, checks, etc.  The impact on how the code works is not obvious. <br><br>  There were 103 of them, which is about 54% of all warnings. <br><br>  <a href="https://www.viva64.com/ru/w/v3008/">V3008</a> ‚ÄûThe 'l_mct_deco_data' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake ‚Äú <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_nb_mct_records == m_nb_max_mct_records) { ResizeMctRecords(); l_mct_deco_data = (OPJ_INT32)m_nb_mct_records; } l_mct_deco_data = (OPJ_INT32)m_nb_mct_records;</code> </pre><br>  Rights analyzer: assignment inside if is not necessary. <br><br>  <a href="https://www.viva64.com/ru/w/v3009/">V3009</a> ‚ÄûIt‚Äôs odd that this method always returns one and the same value‚Äú <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">opj_dwt_decode_tile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">opj_tcd_tilecomp_t tilec, OPJ_UINT32 numres</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (numres == <span class="hljs-number"><span class="hljs-number">1U</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ... return true; }</span></span></code> </pre><br>  On the advice of the analyzer, the method has been changed and returns nothing more. <br><br>  <a href="https://www.viva64.com/ru/w/v3022/">V3022</a> ‚ÄûExpression '! Add' is always true‚Äú <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addToFields</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">PdfDictionaryImpl controlDict, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">add</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... if (add) { // .. return; } if (!add) { // ... } // ... }</span></span></code> </pre><br>  Indeed, there is no point in the second if.  The condition will always be true. <br><br>  <a href="https://www.viva64.com/ru/w/v3029/">V3029</a> "The conditional expression of the" if "statements followed alongside each other are identical" <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (stroke) extGState.OpacityStroke = opacity; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (stroke) state.AddReal(Field.CA, opacity);</code> </pre><br>  It is not clear how such a code came about.  But now we fixed it. <br><br>  <a href="https://www.viva64.com/ru/w/v3031/">V3031 Anonymous</a> check can be simplified.  The '||'  operator is surrounded by opposite expressions ‚Äú <br><br>  This is a nightmare condition: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(cp.m_enc.m_tp_on != <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; ((!opj_codec_t.OPJ_IS_CINEMA(cp.rsiz) &amp;&amp; (t2_mode == J2K_T2_MODE.FINAL_PASS)) || opj_codec_t.OPJ_IS_CINEMA(cp.rsiz)))) { <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre><br>  After the change is much better <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(cp.m_enc.m_tp_on != <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; (opj_codec_t.OPJ_IS_CINEMA(cp.rsiz) || t2_mode == J2K_T2_MODE.FINAL_PASS))) { <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre><br>  <a href="https://www.viva64.com/ru/w/v3063/">V3063</a> ‚ÄûA part of conditional expression is always true if it is evaluated: x! = Null‚Äú <br>  <a href="https://www.viva64.com/ru/w/v3022/">V3022</a> ‚ÄúExpression 'x! = Null' is always true‚Äú <br><br>  Here I took the warning that checking for null does not make sense.  Is it right to do so - the question is ambiguous.  Below I have described the essence of the issue. <br><br><h4>  Unwarranted Warnings </h4><br>  False positives.  Due to errors in the implementation of a specific test or some lack of the analyzer. <br><br>  14 of them were issued, which is about 7% of all warnings. <br><br>  <a href="https://www.viva64.com/ru/w/v3081/">V3081</a> ‚ÄûThe 'i' counter is not used inside a nested loop.  Consider inspecting usage of 'j' counter ‚Äú <br><br>  A slightly simplified version of the code for which this warning was issued: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; initialGlyphsCount - <span class="hljs-number"><span class="hljs-number">1</span></span>; ++i) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; initialGlyphsCount - i - <span class="hljs-number"><span class="hljs-number">1</span></span>; ++j) { <span class="hljs-comment"><span class="hljs-comment">// ... } }</span></span></code> </pre><br>  Obviously, i is used in a nested loop. <br><br>  <a href="https://www.viva64.com/ru/w/v3125/">V3125</a> ‚ÄûThe object was used after it was verified against null‚Äú <br><br>  The code for which this warning is issued: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Compare_SecondGreater</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">cmapEncodingRecord er1, cmapEncodingRecord er2</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (er1 == er2) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (er1 != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; er2 == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (er1 == <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; er2 != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> er1.CompareTo(er2); }</code> </pre><br>  er1 cannot be null at the time of calling CompareTo (). <br><br>  Another code for which this warning is issued: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">realloc</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">[][] table, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> newSize</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[][] newTable = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[newSize][]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> existingSize = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (table != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) existingSize = table.Length; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; existingSize; i++) newTable[i] = table[i]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = existingSize; i &lt; newSize; i++) newTable[i] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[<span class="hljs-number"><span class="hljs-number">4</span></span>]; table = newTable; }</code> </pre><br>  table cannot be null in a loop. <br><br>  <a href="https://www.viva64.com/ru/w/v3134/">V3134</a> ‚ÄûShift by [32.255] bits is greater than the size of 'UInt32' type of expression '(uint) 1'‚Äú <br><br>  A piece of code for which this warning is issued: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> bitPos = (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)(numBits &amp; <span class="hljs-number"><span class="hljs-number">0x1F</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> mask = (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>)<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; bitPos;</code> </pre><br>  It can be seen that bitPos can have a value from the range [0..31], but the analyzer believes that it can have a value from the range [0..255], which is incorrect. <br><br>  I will not give other similar cases, as they are equivalent. <br><br><h4>  Additional thoughts about some checks </h4><br>  It seemed undesirable to warn that 'x! = Null' is always true in cases where x is the result of calling some method.  Example: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> X </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetX</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> X(...); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (y == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> X(...); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentOutOfRangeException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(x)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Method</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... X x = GetX(..); if (x != null) { // ... } }</span></span></code> </pre><br>  Yes, formally the analyzer is right: x will always not be null, because GetX will either return a full instance, or throw an exception.  But will the code improve removing null checks?  What if GetX changes later?  Is Method required to know the implementation of GetX? <br><br>  Inside the team opinions are divided.  It has been suggested that the current method has a contract in which it should not return null.  And it makes no sense to write redundant code "for the future" with each call.  And if the contract changes - it is necessary to update the calling code. <br><br>  In support of this opinion, the following argument was cited: checking for null is like wrapping up every call in try / catch in case the method starts throwing exceptions in the future. <br><br>  As a result, according to the principle of <a href="https://ru.wikipedia.org/wiki/YAGNI">YAGNI</a> , they decided not to hold on to the checks and deleted them.  All warnings were moved from theoretical / formal to reasonable. <br><br>  I would be glad to read your opinion in the comments. <br><br><h3>  findings </h3><br>  Static analysis is a useful thing.  PVS-Studio allows you to find real errors. <br><br>  Yes, there are unfounded / incorrect warnings.  Still, PVS-Studio found real errors in the project, where Code Analysis is already used.  Our product is fairly well covered with tests, our clients test it in one way or another, but static analysis still benefits the <s>robots do it better</s> . <br><br>  Finally, some statistics. <br><br><h4>  Top 3 unfounded warnings </h4><br>  <a href="https://www.viva64.com/ru/w/v3081/">V3081</a> ‚ÄûThe 'X' counter is not used inside a nested loop.  Consider inspecting usage of 'Y' counter ‚Äú <br>  1 of 1 is considered unreasonable <br><br>  <a href="https://www.viva64.com/ru/w/v3125">V3125</a> ‚ÄûThe object was used against it.  Check lines: N1, N2 ‚Äú <br>  9 out of 10 found to be unfounded <br><br>  <a href="https://www.viva64.com/ru/w/v3134/">V3134</a> ‚ÄûShift by N bits is greater than the size of type‚Äú <br>  4 out of 5 were found to be unfounded <br><br><h4>  Top 3 Important Warnings </h4><br>  <a href="https://www.viva64.com/ru/w/v3083/">V3083</a> Unsafe invocation of event, NullReferenceException is possible.  Consider assigning an event to a local variable before invoking it ‚Äú <br>  5 out of 5 recognized as important <br><br>  <a href="https://www.viva64.com/ru/w/v3020/">V3020</a> ‚ÄûAn unconditional 'break / continue / return / goto' within a loop‚Äú <br>  <a href="https://www.viva64.com/ru/w/v3080/">V3080</a> ‚ÄûPossible null dereference‚Äú <br>  2 out of 2 recognized as important <br><br>  <a href="https://www.viva64.com/ru/w/v3019/">V3019</a> "It is possible that you are not <a href="https://www.viva64.com/ru/w/v3019/">correct</a> after the type conversion using 'as' keyword" <br>  <a href="https://www.viva64.com/ru/w/v3127/">V3127</a> ‚ÄûTwo similar code fragments were found.  Perhaps this is a typo and 'X' variable should be used instead of 'Y' ‚Äú <br>  1 of 1 recognized as important </div><p>Source: <a href="https://habr.com/ru/post/425741/">https://habr.com/ru/post/425741/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../425727/index.html">To new meetings</a></li>
<li><a href="../425729/index.html">Hackathon Pro Welcome: how was the first charity SmartMail Hack</a></li>
<li><a href="../425731/index.html">The secrets of impossible computing on the GPU</a></li>
<li><a href="../425737/index.html">Cards on the table: how to choose a supplier of geographic maps for a mobile application</a></li>
<li><a href="../425739/index.html">Microsoft announced Project xCloud - an ultra-modern gaming streaming service</a></li>
<li><a href="../425743/index.html">Psychotherapy. Mars in the house of Saturn and intracerebral injections of homeopathic psilocybin</a></li>
<li><a href="../425747/index.html">What happened to "Timur and his team" or thoughts about the Partnership of Militant Techies</a></li>
<li><a href="../425749/index.html">Web threatened. Join us and fight for it</a></li>
<li><a href="../425751/index.html">For the first time, a polymer prosthesis simulating bone structure has been successfully implanted</a></li>
<li><a href="../425753/index.html">Google+ RIP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>