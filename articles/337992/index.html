<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Journey from Node to Crystal</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Duo has used Node for many years as the main platform. However, recently they have experimented with a very new, not yet fully formed language Crystal...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Journey from Node to Crystal</h1><div class="post__text post__text-html js-mediator-article">  Duo has used Node for many years as the main platform.  However, recently they have experimented with a very new, not yet fully formed language Crystal.  According to them, the more they did to them, the more they became attached to him. <br><br>  Today we want to share with you a translation of their story about the strengths and weaknesses of the Node and Crystal platforms, and why in Duo more and more server projects are being transferred to Crystal. <br><br> <a href="https://habrahabr.ru/company/ruvds/blog/337992/"><img src="https://habrastorage.org/web/bd4/cc0/869/bd4cc08691ce4792bd5453501077d6c0.jpg"></a> <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Node</font> </h2><br><h3>  <font color="#3AC1EF">‚ñç Waiting</font> </h3><br>  We switched to Node a few years ago.  We were then a small company with a handful of developers, and we needed our employees to be as versatile as possible.  Allowing developers to specialize in the frontend or backend was an unattainable luxury for us.  If we had a lot of work on the server or client parts of the applications, we needed people who were able, regardless of their specialization, to help deal with the affairs. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Node then seemed like an obvious choice to us.  If we took a developer who knew JavaScript to the staff, it meant for us that he could work on both client and server projects.  Tools, syntax and dependencies would overlap, and everyone would improve their skills, as any task would involve the use of JavaScript. <br><br><h3>  <font color="#3AC1EF">‚ñçReality</font> </h3><br>  The server and client code have completely different goals; these types of code require knowledge of very different methods of work.  Typically, client code is user interaction, interface updates, and data queries from the server.  Our developers usually worked with webpack or browserify for packaging code, developed interfaces on React, and used CSS frameworks to simplify page layout. <br><br>  On the server, the programmer deals with SQL queries to databases, with ORM, with reading and writing files, organizes interaction with third-party APIs.  Data streams on the server are subject to the model "request - response".  Between requests, all tasks must serve the answers, and all this needs to be done in a specific way.  If a certain step relies on the results obtained in the previous step, the corresponding processes should be carried out in order; if not, they can be performed in parallel. <br><br><h3>  <font color="#3AC1EF">‚ñçStandard asynchrony</font> </h3><br>  Node is designed so that it performs each task asynchronously.  This means that if you ask Node to do 5 tasks, it will try to do it all at once.  The last few years, the main means to support this model of work have been promises.  In a nutshell, promises allow the programmer to chain sets of asynchronous tasks, which are sequences of steps that follow each other. <br><br>  On the server, the standard use of parallel tasks may seem like a very effective idea.  In reality, for most of the tasks we face, data from previous tasks are required.  Even if we can perform tasks in parallel, system resources can be quite quickly depleted, that is, performing multiple parallel queries to the database can exhaust the pool of connections and reduce the number of users that can be served simultaneously. <br><br>  Over the years of using Node, the creation of chains of promises has become the norm for us.  Half of the written code was aimed at turning asynchronous tasks into tasks solved sequentially.  These promise chains are hard to test, debug, the code is not particularly intelligible.  It often happens that just looking at the code is hard to understand even the order in which tasks and subtasks are performed. <br><br>  Roal Dahl, the creator of Node, quite successfully described this situation, comparing Node and Go in <a href="https://www.mappingthejourney.com/single-post/2017/08/31/Episode-8-Interview-with-Ryan-Dahl-Creator-of-Nodejs">an interview</a> : <br><br>  <i>But the interface that this system provides to the programmer is blocking, and I think, in fact, that this is a better programming model.</i>  <i>Using the blocking approach allows, in many situations, to see the essence of the actions performed much better.</i>  <i>Say, if there are a bunch of consecutive actions, it is quite useful to tell the system something like the following: ‚ÄúSolve task A, wait for an answer, perhaps give an error.</i>  <i>Solve problem B, wait for an answer, or give an error. ‚Äù</i>  <i>And in Node, because of the need to constantly ‚Äújump‚Äù between function calls, it is much more difficult to achieve this.</i> <br><br><h3>  <font color="#3AC1EF">‚ñçDynamic types</font> </h3><br>  Anyone who regularly programs in JavaScript, sooner or later will get acquainted with the error "undefined is not an object".  This error occurs when you try to access a method or property of a variable that you consider to be an object, but which contains the value null.  It is not enough to control what data is transferred between asynchronous parts of the code, you also need to be aware of what is happening with the types anywhere in the application code.  Each time an application receives data from one process and transfers it to another, it may fail.  If you do not anticipate the possibility of processing all possible values, the server will generate an error, or, much worse, do something unexpected. <br><br><h2>  <font color="#3AC1EF">Crystal</font> </h2><br>  While working with Node, I explored many other languages ‚Äã‚Äãand platforms, including Python, PHP, Ruby and Go.  They, as a rule, were either slower than Node, or not as convenient for development purposes.  Speed ‚Äã‚Äãand syntax are two things in a language that can be optimized only up to a certain limit. <br><br>  Then, last year, I read an article about the Crystal language.  It is from a new generation of languages ‚Äã‚Äãthat are compiled into machine code via LLVM.  Its syntax is similar to Ruby (I like it), but it works as fast as Go (and this beast doesn‚Äôt take speed!). <br><br>  Crystal is still very young, but I decided to redo some server parts of our content management system on it.  It turned out just fine.  Here is what I found out in the course of work: <br><br><ul><li>  Crystal has a high performance.  For my tasks, it was 2 times faster than Node. <br></li><li>  It uses very little memory.  Crystal usually needs less than 5 MB per process, and Node more than 200 MB. <br></li><li>  It has an excellent standard library, and as a result, we only needed 12 dependencies to solve a typical problem, compared to a hundred Node dependencies. <br></li><li>  The code, by default, looks synchronous, it uses, like Node, a cycle of events, but for the organization of parallelism, lightweight streams are used (fibers), the interaction is organized through channels like Go.  This makes it easier to understand the code. <br></li><li>  Crystal is statically typed, so errors can be found during compilation. <br></li><li>  Crystal prints types, and as a result, its type system is easy to use, since you don't have to use type annotations too often. <br></li></ul><br>  I liked Crystal programming so much that we rewrote the whole backend of our CMS in this language.  Its API is compatible with our Node-based CMS, as a result, websites can be transferred to a new system, or returned to the old system, with relatively little effort.  This is important because Crystal is still a young project and we need insurance. <br><br>  After our DuoCMS was completely rewritten to Crystal, I needed to test it in production.  As a matter of fact, the original of this material is placed on the site that works on Crystal. <br><br><h3>  <font color="#3AC1EF">‚ñçCompare code on Node and Crystal</font> </h3><br>  Below, for comparison, is a slightly simplified version of the controller code written in Crystal and Node. <br><br>  Here is the controller on Node (using the Express framework). <br><br><pre><code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> express = <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'express'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> app = express() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bodyParser = <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'body-parser'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> UserService = <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'user-service'</span></span>) app.<span class="hljs-keyword"><span class="hljs-keyword">use</span></span>(bodyParser.json()) app.get(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(req, res)</span></span></span><span class="hljs-function"> </span></span>{  res.send(<span class="hljs-string"><span class="hljs-string">'Hello World!'</span></span>) }) app.post(<span class="hljs-string"><span class="hljs-string">'/api/users'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(req, res)</span></span></span><span class="hljs-function"> </span></span>{  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(request.body){    UserService.save(request.body)    .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{      res.send(<span class="hljs-string"><span class="hljs-string">'user saved'</span></span>)    })    .<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(err)</span></span></span></span>{      res.send(err)    })  }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{    res.send(<span class="hljs-string"><span class="hljs-string">"no user provided"</span></span>)  } }) app.listen(<span class="hljs-number"><span class="hljs-number">3000</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{  console.log(<span class="hljs-string"><span class="hljs-string">'Example app listening on port 3000!'</span></span>) })</code> </pre> <br>  Here is the Crystal controller (using the Kemal framework). <br><br><pre> <code class="hljs pgsql">require "kemal" require "user" require "user-service" <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> "/" <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> "Hello World!" <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> post "/api/users" <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> |ctx| <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-type"><span class="hljs-type">json</span></span> = ctx.request.body)   <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>.from_json(<span class="hljs-type"><span class="hljs-type">json</span></span>)   UserService.<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>.save(<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>)   "user saved" <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>   "no user provided" <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> Kemal.run</code> </pre> <br>  It is easy to see that the structure of these two examples is very similar.  However, when there was no need for promises, the total amount of code decreased.  When writing larger applications, this is noticeably stronger.  The DuoCMS 5 server code consists of approximately 15,609 lines of JavaScript.  The volume of the DuoCMS 6 code is close to 10186 lines.  At the moment, DuoCMS 6 has more features, the implementation of which required 30% less code.  At the same time, due to the absence of promises, this code is much easier to read and maintain. <br><br><h2>  <font color="#3AC1EF">What is missing in Crystal?</font> </h2><br>  Developers call the current release of the Crystal alpha version.  Here I must say that I had to use much less developed frameworks intended for production.  At worst, I would say that Crystal is now in beta.  However, I can understand the caution of the developers.  They talk about the alpha version, as it gives them room to maneuver, to make changes, even to break some API, and so on. <br><br>  I have been using Crystal for about a year now and have only encountered a few changes, which are explained by the development of the project and the fact that this is still the alpha version.  I had more problems updating the React on the front end.  In addition, it is worth saying that Crystal is written in Crystal, that is, if something turns out to be non-working, you can make corrections to the language and the standard library (I did). <br><br>  At the moment, the main missing capabilities of Crystal include the following: <br><br><ul><li>  There is still no Windows support (it doesn't bother me, I work on a Mac, I deploy the code on Linux). <br></li><li>  Until now, there is no real parallelism (in the Node it does not exist either). <br></li><li>  There is no incremental compilation (it would be very convenient, as now, to compile our system after making changes to the code, it takes about 8 seconds). <br></li><li>  There are not many well-supported open source libraries for Crystal, but everything will be in order when the use of Crystal begins in serious projects. <br></li></ul><br>  For us, none of these shortcomings was the reason for abandoning Crystal.  I needed to make a few additions that implement the missing features in the libraries we use, but this also happened when working with Node.  In the end, I can say that I am very pleased with Crystal. <br><br><h2>  <font color="#3AC1EF">Results</font> </h2><br>  Should you try Crystal?  Yes worth it!  Stuck is really wonderful.  Crystal is nice to program, just read and edit the code.  And by the way, the more people will use Crystal and contribute to the development of this language - the better it will become.  Want to see everything with your own eyes?  Here are <a href="https://crystal-lang.org/docs/installation/">the</a> installation <a href="https://crystal-lang.org/docs/installation/">instructions</a> .  Here is <a href="https://crystal-lang.org/">the project site</a> .  And this is <a href="https://gitter.im/crystal-lang/crystal">Crystal chat</a> , if anything - write me at @crisward. <br><br>  If you ask if you should use Crystal in production, well, that's what you want.  Personally, I think that the only way to make something suitable for practical use is to try it on those tasks that fail, and then gradually move to it in larger projects.  We do not use Crystal everywhere, for example - on projects with very high traffic, or on critical areas.  We monitor all of our sites and back them up regularly, in addition, Node is always on the pickup - in case something happens to Crystal. <br><br>  Dear readers!  Do you plan to try Crystal in your projects? </div><p>Source: <a href="https://habr.com/ru/post/337992/">https://habr.com/ru/post/337992/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../337978/index.html">Telegram bot for Mikrotik with Webhook and JSON parser</a></li>
<li><a href="../337982/index.html">Methods for developing motion software flow sensors that work with Arduino</a></li>
<li><a href="../337984/index.html">About smart contracts in simple words</a></li>
<li><a href="../337986/index.html">Prototyping in the Python-Arduino environment</a></li>
<li><a href="../337990/index.html">Android web applications without Cordova, Phonegap and SMS</a></li>
<li><a href="../337994/index.html">Approach to the separation of schemes (users) in the design of OLTP databases</a></li>
<li><a href="../337996/index.html">Sci-fi for a startup: how technological entrepreneurship and science fiction are connected</a></li>
<li><a href="../337998/index.html">And again about caching in Django</a></li>
<li><a href="../338000/index.html">Machine learning in the practice of administration. QoSmic technology</a></li>
<li><a href="../338002/index.html">Go for big data</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>