<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pitfalls of backup in hybrid storage systems</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Of course, ways to protect data from loss are determined both by the amount of information and the device itself, on which they are stored. And the on...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pitfalls of backup in hybrid storage systems</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/8cd/c30/370/8cdc3037023d4f819d4eb0b4c233adc5.jpg"></div><br><br>  Of course, ways to protect data from loss are determined both by the amount of information and the device itself, on which they are stored.  And the one and the other is constantly evolving. <br><br>  Therefore, there have long been controversies between supporters of the traditional approach to backups and those who are looking for new ways to protect data, more convenient in terms of the architecture of the storage systems used.  Now this dispute has escalated as the variety of storage system types has sharply increased lately.  The use of some of them requires a change in approaches to the usual tasks of operation and accessibility, including backup, which I want to talk about here. <br><a name="habracut"></a><br>  The traditional approach is not even to save a backup to tape.  We are talking about having a backup in a storage system designed specifically for backup.  Whether it is a disk SRK, or tape - no difference.  This traditional approach implies that there is a productive system that stores the most up-to-date production data, and there is a system where copies of this data are regularly stored.  In particular, EMC offers <a href="http://russia.emc.com/data-protection/data-domain/index.htm">Data Domain</a> for this storage. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/files/d59/161/80b/d5916180b7c74dd6a8894c96e78b4ce9.png"></div><br>  <i>The scheme of the traditional backup.</i> <br><br>  A backup server is also typically used to centrally manage this process.  He also carries out and information recovery, if the original data were damaged or lost.  In this segment, the <a href="https://community.emc.com/community/products/networker">Networker</a> software product has proven itself well.  This is a time-tested data protection tool that satisfies a host of regulatory laws.  And due to the presence of software clients for applications, Networker integrates perfectly with them, for which many deservedly love. <br><br>  In contrast to the traditional approach, replication of data is put by means of storage systems.  In this case, the productive data was replicated (mirrored) to the same, and preferably to another storage system.  To create a set of recovery points, snapshots are regularly created from this mirror, which can be up to several hundred.  Due to its convenience, this approach has gradually gained popularity over the past years.  Most often he was chosen: <br><br><ul><li>  NetApp systems administrators, in which snapshots are deeply embedded in the architecture, </li><li>  those who didn‚Äôt pay much attention to regulatory legislation about alienable carriers, </li><li>  and those who did not care about the perfect integration with applications. </li></ul><br>  In general, the struggle between these two approaches was going on, but without any particular intensity.  In my opinion, the reason is that these two worlds overlap a little.  My thoughts on this topic, by the way, are here: <a href="http://denserov.com/2013/01/30/bu-vs-rep/">http://denserov.com/2013/01/30/bu-vs-rep/</a> . <br><br>  I believe that the world of backup began to change fundamentally when new types of storage systems appeared, which began to gain weight quickly. <br><br>  In the context of a changing approach to backups, I see three basic new types of storage. <br><br><ol><li>  Hybrid storage systems using two- and three-level storage (SSD / SAS / NL-SAS).  Systems such as VNX, VMAX and their analogues. </li><li>  Ultra-scalable massive scale-out Isilon, ScaleIO, Elastic Cloud Storage and their analogues. </li><li>  Systems with deduplication of productive data.  For example, XtremIO.  In some cases - VNX. </li></ol><br>  Perhaps many have long noticed that these three types of storage systems need a special approach to backup.  Below, I present backup considerations for hybrid systems, as for the most common ones, and in future publications I‚Äôll review the remaining two types. <br><br><h3>  Backup </h3><br>  Currently, these are the most common storage systems in the corporate segment.  The architectures of most of them were the result of the development of traditional storage systems, which, as a rule, were combined with the traditional backup tools (EMC Networker and its analogs).  Traditional storage systems mutated into hybrid ones, and the approach to backup remained largely the same.  What is the problem with backups in these systems, if everything is traditional there? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/1fa/f3a/8f6/1faf3a8f633944fa9ccb05f1236d3c8c.jpg"></div><br>  <i>A typical hybrid storage system contains fast, medium and slow media.</i> <br><br>  Someone has already guessed that the problem lies in the lowest level of storage, where the ‚Äúcoldest‚Äù data ‚Äúslides‚Äù.  For economy, this level is sometimes made up of a very small number of large-capacity disks (NL-SAS, 7200 rpm, from 1 to 6 TB). <br><br>  <b>Never, never, never use NL-SAS drives larger than 2TB for automatic multi-level storage in hybrid systems!</b>  Resist the temptation.  And that's why. <br><br>  It would be a mistake to assume that if you designed the system for capacity and performance, then with backup everything will settle down somehow by itself. <br><br>  When designing three-tier systems, you need to remember that from the lower level, data also sometimes needs to be quickly raised for various tasks - from backup to reporting. <br><br>  With sad regularity, we have to deal with the design of hybrid storage systems for databases of hundreds of TB.  Sometimes they even make MS SQL databases of this size, adding electronic documents into the database.  At the same time, no one considers how long the backup will take, and multi-level storage with the lower level on 6TB drives is prescribed in the TZ.  Sometimes even 5400 rpm to be cheaper. <br><br>  Consider a small hybrid system with not the worst set of disks: <br><br><ul><li>  16 200GB SSD drives in RAID 5 (7 + 1) </li><li>  32 600GB 15000 rpm drives in RAID 1 </li><li>  8 2000GB 7200 rpm disks in RAID6 (6 + 2) </li></ul><br>  Decimal capacity (including RAID): <br><br><ul><li>  SSD - 2800 GB </li><li>  SAS 15,000 rpm - 9600 GB </li><li>  NL-SAS 7200 rpm - 24,000 GB </li></ul><br>  TOTAL 36,400 GB. <br><br>  Crude performance: <br><br><ul><li>  SSD 16 * 3500 = 80000 IOPS </li><li>  SAS 15000 rpm 32 * 180 = 5760 IOPS </li><li>  NL-SAS 7200 rpm 8 * 80 = 640 IOPS </li></ul><br>  TOTAL 86,400 IOPS. <br><br>  The volume and performance of such a system on just 56 disks turned out to be impressive.  Now all this can fit in a disk shelf for 60 disks.  In the worst case - 4 shelves with 15 discs. <br><br>  A similar ‚Äúflat‚Äù system, without the use of ‚ÄúAuto-Tiering‚Äù technologies, would consist of 480 disks of 15,000 rpm, would consume many times more electricity and would take many times more space.  The economic gain of the ‚Äúhybrid‚Äù approach is obvious. <br><br>  We here admit, of course, that the design of this system for the workload profile was chosen to be correct, and the hot and cold data ‚Äúsprawled‚Äù on it correctly (although the solution to this fascinating task is the subject of a separate and very interesting article). <br><br>  Now I would like to consider exactly how the backup of such a ‚Äúsuccessfully designed‚Äù hybrid system will occur.  Suppose traditional backup is used.  Those.  full backup on Friday night, and then a series of incremental ones.  And so every week. <br><br>  We calculate in the zero approximation how long a full backup of 36 TB from the hybrid system takes in the absence of productive load. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f13/361/bc6/f13361bc6a0d4706bdbbc971d76bd482.JPG"></div><br><br>  The calculation was made based on the assumption that there are no other bottlenecks in the backup process, and neither the storage controllers nor the target backup system prevent the disks from transmitting data for the backup. <br><br>  From the illustration we see that the lower storage level ‚Äúate‚Äù 94% of the backup time and took 7 days.  This is unacceptable.  In fact, this is a consequence of the use of multi-level storage.  The speed of the application is determined by the speed of the top level and its volume.  And the speed of backup (and recovery!) Is the speed of the lower level and its volume.  Does this mean that hybrid systems are poorly adapted to real life?  Someone will say yes.  But already very significant benefits come from their use in terms of storage efficiency.  Therefore, you just need to rethink the rules of their operation and follow common sense. <br><br>  I see the following solutions (or a combination of them) for hybrid systems: <br><br>  <b>The first.</b>  Discard full backups of large amounts of data.  Go to synthetic full backups, distribute backups in time.  Those.  reduce the amount of data transmitted in a given time interval.  The advantage of this option is the conditional cheapness. <br><br>  The big drawback is the time to full recovery.  It does not matter here whether the synthetic backup was or not.  We'll have to fill the data completely even on the lower level.  This will add to the daily data loss also about a week of inactivity. <br><br>  <b>The second.</b>  Try to make the lower level not so slow.  After all, it is possible to compose it from disks of 1 TB, which, at a price per GB, are approximately in the same price category as 2 TB.  It is possible to lay additional spindles in the lower storage level precisely in order to ensure an acceptable backup time.  This need to think in advance.  Those.  increase both the speed of "return" of data for backup and plan the speed of potential recovery. <br><br>  It is slightly more expensive than the first option, but it can be several times faster.  The first and second options can be freely combined. <br><br>  <b>Third</b> .  Avoid 100% utilization of third-level storage for multi-level volumes.  After all, it can be filled with ‚Äúcombat‚Äù data not by 100%, but by 15-20%, and the remaining 80% are allocated, for example, to archived data, which can be backed up less often.  This is the fundamental difference between archival and operational data.  For some, it may still sound strange, but the archive and backup are fundamentally different things.  An archive is a long-term storage of immutable data that is moved there from the operational storage.  A backup is a regularly created copy of operational data for possible recovery.  In other words, the archive is the move operation, and the backup is the copy.  You can read more about archiving <a href="http://russia.emc.com/content-management/infoarchive/infoarchive.htm">on the EMC website</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b89/55f/0b2/b8955f0b246b4858b4933445f05c2159.JPG"></div><br>  <i>Combination archive and backup.</i> <br><br>  <b>Fourth.</b>  If all of the above does not allow to drastically improve the situation, then, perhaps, it is worth reconsidering a principled approach to backup.  For a long time there are backup systems with data deduplication at the source, for example, Avamar or Vmware Data Protection Advanced.  This technology effectively reduces the amount of data transferred between the client and the backup server.  Another alternative is continuous data replication with snapshots to another storage system.  For example, using RecoverPoint. <br><br>  As you can see, when designing hybrid storage systems, you need to consider the backup context.  Even when storage and backup are different projects. <br><br><h3>  Recovery </h3><br>  Imagine now that we have a system with automated multi-level storage and we successfully make backups from it.  In addition, in the design process we take into account the speed of recovery, and with this, too, there are no serious questions. <br><br>  The application runs on a hybrid storage system, the performance is sufficient.  However, we recall that in modern environments most of the load falls on only a small amount of data. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/222/6cc/e5d/2226cce5ddb24cad8d7c46ce2e6b1068.JPG"></div><br><br>  The question arises: how fast will the application work after a successful recovery from a backup made half a day ago?  No one guarantees that when recovering from IBS, data blocks will necessarily expand on the carriers in exact accordance with their ‚Äútemperature‚Äù before the failure.  If we take into account that the hottest data is not in the storage cache, but in the RAM of the database servers and applications that, when recovering data from a backup, also have to warm up all their memory from scratch, the load on the disk system will also be higher than usual.  The situation is not pleasant. <br><br>  Since hybrid storage systems have in some places become almost standard approach to solving storage problems, the question of potential recovery after a failure, I think, has arisen and will arise more than once before administrators during operation. <br><br>  If people encounter backup every day, it comes to full-scale recovery, I think, a hundred times less.  Therefore, when in practice one encounters the scenario considered here, this turns out to be an unpleasant, but quite predictable event.  Perhaps you should foresee and take it into account? <br><br>  But since the design of backups is still about copying / restoring data, rather than guaranteed performance after recovery, this topic most often remains somewhere on the border of the attention of architects.  And it is not clear from what budget to finance this project.  Backup or storage?  Perhaps that is why I still have not met with clear and clear recommendations on this matter when planning the architecture.  Apparently, many believe that when recovering, the main thing is to recover.  And further - these are minor nuances. <br><br>  It should be noted here that there are cases when successful recovery of data from a backup did not allow a successful launch of the application.  Hundreds and thousands of users literally "burst into" the "cold" storage system, successfully dumping it, entering the application server into a coma, and sometimes even damaging the data.  Similar situations occur even on conventional storage systems, not to mention hybrid. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a67/19b/e78/a6719be784e140cc9bc1769f067710a8.jpg"></div><br><br>  Therefore, we must remember that recovery from a full backup is a last resort.  And if we resort to it, then we should not expect an instant release of applications at full capacity.  In addition, in most cases, you still have to resolve organizational issues related to rolling back data for a while.  But this does not remove the issue of technical support from the agenda. <br><br><h3>  Solution to the problem </h3><br>  What can I advise to solve this problem, characteristic of all disk systems, including hybrid ones? <br><br>  <b>First</b> : consider the possibility of heating the storage system.  Some hybrid storage algorithms <a href="http://denserov.com/2012/09/28/fast-cache-part-1/">use Flash as a cache expansion</a> , and can respond to application needs in minutes, while others need at least three days to restore data from slow disks to fast disks after restoring from backup.  So, if the hybrid system does not respond very quickly, then it is important not to overdo it with slow disks.  They can significantly limit the ability of the system to "warm up" under load. <br><br>  <b>Second</b> : backing up to an external IBS is always a last resort, Plan B, when nothing else worked ( <a href="http://denserov.com/2013/01/30/bu-vs-rep/">see in another article</a> ).  Therefore, in order to minimize the uncertainty in application performance after data recovery, I would use online recovery tools that allow you to recover data more ‚Äúpointwise‚Äù, ‚Äúblock by block‚Äù. <br><br>  We are talking about replication at the storage level (clones, snapshots), and replication at the application level (Data Guard, etc.).  This approach minimizes not only recovery time and data loss, but also saves the nerves of administrators in terms of more predictable performance after recovery.  That is, it is best to combine backup to external devices with data replication, knowing what they are for. <br><br>  <b>Third</b> : if the first two positions are taken into account, but you want more, then you can use two hybrid systems operating in a synchronous, crash-resistant cluster pair, which provides not only the storage of identical data instances, but also completely identical placement of these data at the storage levels.  Even if one of the storage systems is completely disabled, data loss or application shutdown will not occur, and after restoring a failed system, the cluster can synchronize data and its layering on both systems. <br><br>  In general, I share the opinion that a good backup should be integrated not only with the application level, but also with the productive storage system, and be able to both back up and restore individual data blocks similar to snapshots.  And it seems that about this trend is currently observed in the backup market. <br><br>  In these arguments, I deliberately adhered only to the protection and restoration of hybrid storage systems.  The issue of flash systems will be discussed in one of the following articles.  Stay tuned! <br><br><br>  <a href="http://denserov.com/">Denis Serov</a> </div><p>Source: <a href="https://habr.com/ru/post/269933/">https://habr.com/ru/post/269933/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../269919/index.html">The digest of interesting materials for the mobile developer # 127 (October 26 - November 1)</a></li>
<li><a href="../269923/index.html">Immersion cooling reaches new heights: 250 kW per bitFury rack</a></li>
<li><a href="../269925/index.html">Altera + OpenCL: we open the core</a></li>
<li><a href="../269927/index.html">What we have learned by developing the backend</a></li>
<li><a href="../269931/index.html">How to draw curves graphics in the style of XKCD</a></li>
<li><a href="../269935/index.html">Operating System Migration History</a></li>
<li><a href="../269937/index.html">PHP Digest number 73 - interesting news, materials and tools (October 18 - November 5, 2015)</a></li>
<li><a href="../269943/index.html">How to write Go code that is easy to port</a></li>
<li><a href="../269947/index.html">Cloud explanations: we create a virtual PBX operator service in three days</a></li>
<li><a href="../269949/index.html">Choosing a Virtualization Platform: Why VMware</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>