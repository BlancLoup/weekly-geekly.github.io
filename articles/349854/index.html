<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Migrate API and what it eat. On the example of the migration of the forum Drupal 7. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This guide is a translation of the article . 
 I would like to share my experience with the migration of the forum from Drupal 7 to Drupal 8 , as well...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Migrate API and what it eat. On the example of the migration of the forum Drupal 7. Part 1</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/rn/ov/qw/rnovqwm4nwj8g1spoy0jfbv-vyg.png" alt="Migrate API     .      Drupal 7.  1" title="Migrate API and what it eat. Using the example of forum migration using Drupal 7. Part 1"><br><blockquote>  This guide is a translation of the <a href="https://balachky.org/blog/animan/migrate-api-i-z-chym-yogo-yidyat-na-prykladi-migraciyi-forumu-z-drupal-7-chastyna-1">article</a> . </blockquote><br>  I would like to share my experience with the migration of the forum from <b>Drupal 7</b> to <b>Drupal 8</b> , as well as talk about the problems I had to face during this process, as well as the tools I used.  In addition, I will talk about the pitfalls that have occurred during the migration of the forum and the terms to it. <br><a name="habracut"></a><br><h2>  Instruments </h2><br>  We will carry out the entire migration process using <a href="http://www.drush.org/">Drush</a> .  Now let's define what we need for the <b>migration</b> (I will indicate the versions that will be used at the time of this writing) <br><br>  Drupal: <b>8.4.5</b> <br><br>  Modules for migration: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  migrate </li><li>  migrate_drupal </li><li>  migrate_plus: <b>8.x-4.0-beta2</b> </li><li>  migrate_tools: <b>8.x-4.0-beta2</b> </li></ul><br>  Drush: <b>9.1.0</b> <br><br><h4>  The entire migration process took place using </h4><br>  PHP: <b>7.1.14</b> <br>  MySQL: MariaDB <b>10.1.31</b> <br><blockquote><h4>  Note: </h4><br><ul><li>  All paths will be specified relative to the module root (the custom_migration_forum directory, or the name you give to your module). </li><li>  Before starting the migration, disable the <b>rdf</b> module in Drupal 8, since it can cause problems during the execution of Rolling back (when we cancel the migration changes). </li></ul></blockquote><br><h2>  Test content </h2><br>  For the relevance of the information, I decided in the course of writing this article to append the module that migrates the forum.  I created test content using <a href="https://www.drupal.org/project/devel">Devel</a> to generate content.  The total number of generated forum topics is 300 pcs., As well as comments to them.  It turned out this: <br><br><img src="https://habrastorage.org/webt/te/pc/fz/tepcfzbwdzpft_klfqgahcfw7iu.png" alt=" Devel' " title="Generated by devel content"><br><br><h2>  Preparing for migration </h2><br>  First, we will deploy a clean site on Drupal 8. On a clean site, we create our own module, or use <a href="https://github.com/animan01/custom_migration_forum">GitHub</a> . <br><br>  Create a <b>custom_migration_forum.info.yml</b> file in which we enter basic information about our module and dependencies: <br><br><pre><code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">name</span></span>: Custom Migration Forum description: Custom module <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> migrating forum <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> a Drupal <span class="hljs-number"><span class="hljs-number">7</span></span> site. package: Migrations <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: module core: <span class="hljs-number"><span class="hljs-number">8.</span></span>x dependencies: - drupal:migrate - drupal:migrate_drupal - drupal:forum - migrate_plus:migrate_plus (&gt;=<span class="hljs-number"><span class="hljs-number">4.0</span></span>-beta2) - migrate_tools:migrate_tools (&gt;=<span class="hljs-number"><span class="hljs-number">4.0</span></span>-beta2)</code> </pre> <br>  In order to remove the old configs of migrations, when uninstalling the module, it should be described in <u>custom_migration_forum.install</u> .  I used to come across situations where a conflict of configs arose due to the fact that the old configs were not deleted when the module was uninstalled.  Therefore, in order to protect yourself, it is better to remove them when uninstalling the module. <br><br>  <b>custom_migration_forum.install</b> <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@file</span></span></span><span class="hljs-comment"> * Contains migrate_forum_drupal8.install. */</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * Implements hook_uninstall(). * * Removes stale migration configs during uninstall. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">custom_migration_forum_uninstall</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $query = \Drupal::database()-&gt;select(<span class="hljs-string"><span class="hljs-string">'config'</span></span>, <span class="hljs-string"><span class="hljs-string">'c'</span></span>); $query-&gt;fields(<span class="hljs-string"><span class="hljs-string">'c'</span></span>, [<span class="hljs-string"><span class="hljs-string">'name'</span></span>]); $query-&gt;condition(<span class="hljs-string"><span class="hljs-string">'name'</span></span>, $query-&gt;escapeLike(<span class="hljs-string"><span class="hljs-string">'migrate_plus.'</span></span>) . <span class="hljs-string"><span class="hljs-string">'%'</span></span>, <span class="hljs-string"><span class="hljs-string">'LIKE'</span></span>); $config_names = $query-&gt;execute()-&gt;fetchAll(); <span class="hljs-comment"><span class="hljs-comment">// Delete each config using configFactory. foreach ($config_names as $config_name) { \Drupal::configFactory()-&gt;getEditable($config_name-&gt;name)-&gt;delete(); } }</span></span></code> </pre><br>  Or, you just need to register a dependency on each migration: <br><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">dependencies:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">enforced:</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class">: - </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">custom_migration_forum</span></span></span></span></code> </pre><br><h2>  Migration of forum terms </h2><br>  Since the forum in Drupal 7 is, in fact, a node with terms, then for a start, we need to migrate terms.  Start by creating plugins for migrating terms and vocabulary. <br><br>  <b>src / plugin / migrate / source / Vocabulary.php:</b> <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@file</span></span></span><span class="hljs-comment"> * Contains \Drupal\migrate_therasomnia\Plugin\migrate\source\Vocabulary. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Drupal</span></span>\<span class="hljs-title"><span class="hljs-title">custom_migration_forum</span></span>\<span class="hljs-title"><span class="hljs-title">Plugin</span></span>\<span class="hljs-title"><span class="hljs-title">migrate</span></span>\<span class="hljs-title"><span class="hljs-title">source</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Drupal</span></span>\<span class="hljs-title"><span class="hljs-title">migrate</span></span>\<span class="hljs-title"><span class="hljs-title">Row</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Drupal</span></span>\<span class="hljs-title"><span class="hljs-title">migrate</span></span>\<span class="hljs-title"><span class="hljs-title">Plugin</span></span>\<span class="hljs-title"><span class="hljs-title">migrate</span></span>\<span class="hljs-title"><span class="hljs-title">source</span></span>\<span class="hljs-title"><span class="hljs-title">SqlBase</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Drupal 7 vocabularies source from database. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@MigrateSource</span></span></span><span class="hljs-comment">( * id = "custom_migration_forum_vocabulary", * source_provider = "taxonomy" * ) */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Vocabulary</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SqlBase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment">} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $query = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;select(<span class="hljs-string"><span class="hljs-string">'taxonomy_vocabulary'</span></span>, <span class="hljs-string"><span class="hljs-string">'v'</span></span>) -&gt;fields(<span class="hljs-string"><span class="hljs-string">'v'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'vid'</span></span>, <span class="hljs-string"><span class="hljs-string">'name'</span></span>, <span class="hljs-string"><span class="hljs-string">'description'</span></span>, <span class="hljs-string"><span class="hljs-string">'hierarchy'</span></span>, <span class="hljs-string"><span class="hljs-string">'module'</span></span>, <span class="hljs-string"><span class="hljs-string">'weight'</span></span>, <span class="hljs-string"><span class="hljs-string">'machine_name'</span></span> )); <span class="hljs-comment"><span class="hljs-comment">// Filtered out unnecessary dictionaries. $query-&gt;condition('machine_name', 'forums'); return $query; } /** * {@inheritdoc} */ public function fields() { return array( 'vid' =&gt; $this-&gt;t('The vocabulary ID.'), 'name' =&gt; $this-&gt;t('The name of the vocabulary.'), 'description' =&gt; $this-&gt;t('The description of the vocabulary.'), 'help' =&gt; $this-&gt;t('Help text to display for the vocabulary.'), 'relations' =&gt; $this-&gt;t('Whether or not related terms are enabled within the vocabulary. (0 = disabled, 1 = enabled)'), 'hierarchy' =&gt; $this-&gt;t('The type of hierarchy allowed within the vocabulary. (0 = disabled, 1 = single, 2 = multiple)'), 'weight' =&gt; $this-&gt;t('The weight of the vocabulary in relation to other vocabularies.'), 'parents' =&gt; $this-&gt;t("The Drupal term IDs of the term's parents."), 'node_types' =&gt; $this-&gt;t('The names of the node types the vocabulary may be used with.'), ); } /** * {@inheritdoc} */ public function getIds() { $ids['vid']['type'] = 'integer'; return $ids; } }</span></span></code> </pre><br>  <b>src / plugin / migrate / source / Terms.php:</b> <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@file</span></span></span><span class="hljs-comment"> * Contains \Drupal\migrate_therasomnia\Plugin\migrate\source\Terms. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Drupal</span></span>\<span class="hljs-title"><span class="hljs-title">custom_migration_forum</span></span>\<span class="hljs-title"><span class="hljs-title">Plugin</span></span>\<span class="hljs-title"><span class="hljs-title">migrate</span></span>\<span class="hljs-title"><span class="hljs-title">source</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Drupal</span></span>\<span class="hljs-title"><span class="hljs-title">migrate</span></span>\<span class="hljs-title"><span class="hljs-title">Row</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Drupal</span></span>\<span class="hljs-title"><span class="hljs-title">migrate</span></span>\<span class="hljs-title"><span class="hljs-title">Plugin</span></span>\<span class="hljs-title"><span class="hljs-title">migrate</span></span>\<span class="hljs-title"><span class="hljs-title">source</span></span>\<span class="hljs-title"><span class="hljs-title">SqlBase</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Drupal 7 taxonomy terms source from database. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@MigrateSource</span></span></span><span class="hljs-comment">( * id = "custom_migration_forum_term", * source_provider = "taxonomy" * ) */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Terms</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SqlBase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment">} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $query = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;select(<span class="hljs-string"><span class="hljs-string">'taxonomy_term_data'</span></span>, <span class="hljs-string"><span class="hljs-string">'td'</span></span>) -&gt;fields(<span class="hljs-string"><span class="hljs-string">'td'</span></span>, [<span class="hljs-string"><span class="hljs-string">'tid'</span></span>, <span class="hljs-string"><span class="hljs-string">'vid'</span></span>, <span class="hljs-string"><span class="hljs-string">'name'</span></span>, <span class="hljs-string"><span class="hljs-string">'description'</span></span>, <span class="hljs-string"><span class="hljs-string">'weight'</span></span>, <span class="hljs-string"><span class="hljs-string">'format'</span></span>]) -&gt;fields(<span class="hljs-string"><span class="hljs-string">'tv'</span></span>, [<span class="hljs-string"><span class="hljs-string">'vid'</span></span>, <span class="hljs-string"><span class="hljs-string">'machine_name'</span></span>]) -&gt;distinct(); <span class="hljs-comment"><span class="hljs-comment">// Add table for condition on query. $query-&gt;innerJoin('taxonomy_vocabulary', 'tv', 'td.vid = tv.vid'); // Filtered out unnecessary dictionaries. $query-&gt;condition('tv.machine_name', 'forums'); return $query; } /** * {@inheritdoc} */ public function fields() { return [ 'tid' =&gt; $this-&gt;t('The term ID.'), 'vid' =&gt; $this-&gt;t('Existing term VID'), 'name' =&gt; $this-&gt;t('The name of the term.'), 'description' =&gt; $this-&gt;t('The term description.'), 'weight' =&gt; $this-&gt;t('Weight'), 'parent' =&gt; $this-&gt;t("The Drupal term IDs of the term's parents."), ]; } /** * {@inheritdoc} */ public function prepareRow(Row $row) { // Find parents for this row. $parents = $this-&gt;select('taxonomy_term_hierarchy', 'th') -&gt;fields('th', ['parent', 'tid']); $parents-&gt;condition('tid', $row-&gt;getSourceProperty('tid')); $parents = $parents-&gt;execute()-&gt;fetchCol(); $row-&gt;setSourceProperty('parent', reset($parents)); return parent::prepareRow($row); } /** * {@inheritdoc} */ public function getIds() { $ids['tid']['type'] = 'integer'; return $ids; } }</span></span></code> </pre><br>  After creating plugins for migrating terms and dictionaries, you need to configure for our migration.  To do this, create a <u>migrate_plus.migration.term.yml</u> and <u>migrate_plus.migration.vocablary.yml</u> . <br><br>  <b>config / install / migrate_plus.migration.vocablary.yml:</b> <br><br><pre> <code class="hljs vhdl">id: custom_migration_forum_vocabulary <span class="hljs-keyword"><span class="hljs-keyword">label</span></span>: Taxonomy vocabulary forum migration_group: Custom Migration Forum dependencies: enforced: module: - custom_migration_forum source: plugin: custom_migration_forum_vocabulary target: migrate <span class="hljs-keyword"><span class="hljs-keyword">process</span></span>: vid: - plugin: machine_name source: machine_name - plugin: make_unique_entity_field entity_type: taxonomy_vocabulary field: vid length: <span class="hljs-number"><span class="hljs-number">32</span></span> migrated: <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">label</span></span>: name name: name description: description hierarchy: hierarchy module: module weight: weight destination: plugin: <span class="hljs-keyword"><span class="hljs-keyword">entity</span></span>:taxonomy_vocabulary</code> </pre><br>  In the 'source' we specify our plugin <i>custom_migration_forum_vocabulary</i> , which was described in the class <b>Vocabulary</b> . <br><br>  <b>config / install / migrate_plus.migration.term.yml:</b> <br><br><pre> <code class="hljs mel">id: custom_migration_forum_term label: Taxonomy terms forum migration_group: Custom Migration Forum dependencies: enforced: module: - custom_migration_forum <span class="hljs-keyword"><span class="hljs-keyword">source</span></span>: plugin: custom_migration_forum_term target: migrate process: tid: tid vid: plugin: migration migration: custom_migration_forum_vocabulary <span class="hljs-keyword"><span class="hljs-keyword">source</span></span>: vid name: name description: description weight: weight <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> changed: timestamp destination: plugin: entity:taxonomy_term migration_dependencies: required: - custom_migration_forum_vocabulary</code> </pre><br>  When migrating terms in the <b>vid,</b> we specify the machine name ( <i>custom_migration_forum_vocabulary</i> ), from which we will take the forum dictionary ID. <br><br><h2>  Forum Migration </h2><br>  I would like to note that in this article we migrate the forum without additional fields.  Before you start migrating forums, we need to migrate users, because without them, forums will not have authors.  We will do this migration using plugins from the Kernel, but we will add them to our ‚Äú <b>Custom Migration Forum</b> ‚Äù migration group in order to be able to start the entire migration with one team.  We need three migrations: <br><br><ol><li>  role migration (custom_migration_forum_user_role) </li><li>  user migration (custom_migration_forum_user) </li><li>  Text format migration (custom_migration_forum_filter_format). </li></ol><br>  Here are our three yml files. <br><br>  <b>config / install / migrate_plus.migration.user_role.yml:</b> <br><br><pre> <code class="hljs sql">id: custom_migration_forum_user_role label: User roles migration_group: Custom Migration Forum dependencies: enforced: module: - custom_migration_forum source: plugin: d7_user_role process: id: - plugin: machine_name source: name - plugin: user_update_8002 label: name permissions: - plugin: static_map source: permissions bypass: true map: '<span class="hljs-keyword"><span class="hljs-keyword">use</span></span> PHP <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">block</span></span> visibility<span class="hljs-string"><span class="hljs-string">': '</span></span><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> PHP <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">settings</span></span><span class="hljs-string"><span class="hljs-string">' '</span></span><span class="hljs-keyword"><span class="hljs-keyword">administer</span></span> site-wide contact <span class="hljs-keyword"><span class="hljs-keyword">form</span></span><span class="hljs-string"><span class="hljs-string">': '</span></span><span class="hljs-keyword"><span class="hljs-keyword">administer</span></span> contact forms<span class="hljs-string"><span class="hljs-string">' '</span></span>post comments <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> approval<span class="hljs-string"><span class="hljs-string">': '</span></span><span class="hljs-keyword"><span class="hljs-keyword">skip</span></span> <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span> approval<span class="hljs-string"><span class="hljs-string">' '</span></span>edit own blog entries<span class="hljs-string"><span class="hljs-string">': '</span></span>edit own blog <span class="hljs-keyword"><span class="hljs-keyword">content</span></span><span class="hljs-string"><span class="hljs-string">' '</span></span>edit <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> blog entry<span class="hljs-string"><span class="hljs-string">': '</span></span>edit <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> blog <span class="hljs-keyword"><span class="hljs-keyword">content</span></span><span class="hljs-string"><span class="hljs-string">' '</span></span><span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> own blog entries<span class="hljs-string"><span class="hljs-string">': '</span></span><span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> own blog <span class="hljs-keyword"><span class="hljs-keyword">content</span></span><span class="hljs-string"><span class="hljs-string">' '</span></span><span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> blog entry<span class="hljs-string"><span class="hljs-string">': '</span></span><span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> blog <span class="hljs-keyword"><span class="hljs-keyword">content</span></span><span class="hljs-string"><span class="hljs-string">' '</span></span><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> forum topics<span class="hljs-string"><span class="hljs-string">': '</span></span><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> forum <span class="hljs-keyword"><span class="hljs-keyword">content</span></span><span class="hljs-string"><span class="hljs-string">' '</span></span><span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> forum topic<span class="hljs-string"><span class="hljs-string">': '</span></span><span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> forum <span class="hljs-keyword"><span class="hljs-keyword">content</span></span><span class="hljs-string"><span class="hljs-string">' '</span></span><span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> own forum topics<span class="hljs-string"><span class="hljs-string">': '</span></span><span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> own forum <span class="hljs-keyword"><span class="hljs-keyword">content</span></span><span class="hljs-string"><span class="hljs-string">' '</span></span>edit <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> forum topic<span class="hljs-string"><span class="hljs-string">': '</span></span>edit <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> forum <span class="hljs-keyword"><span class="hljs-keyword">content</span></span><span class="hljs-string"><span class="hljs-string">' '</span></span>edit own forum topics<span class="hljs-string"><span class="hljs-string">': '</span></span>edit own forum <span class="hljs-keyword"><span class="hljs-keyword">content</span></span><span class="hljs-string"><span class="hljs-string">' - plugin: flatten weight: weight destination: plugin: entity:user_role migration_dependencies: optional: - custom_migration_forum_filter_format</span></span></code> </pre><br>  <b>config / install / migrate_plus.migration.user.yml:</b> <br><br><pre> <code class="hljs pgsql">id: custom_migration_forum_user label: <span class="hljs-keyword"><span class="hljs-keyword">User</span></span> accounts migration_group: Custom Migration Forum dependencies: enforced: module: - custom_migration_forum <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>: Drupal\<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>\Plugin\migrate\<span class="hljs-keyword"><span class="hljs-keyword">User</span></span> source: plugin: d7_user process: uid: uid <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-type"><span class="hljs-type">name</span></span> pass: pass mail: mail created: created <span class="hljs-keyword"><span class="hljs-keyword">access</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> <span class="hljs-keyword"><span class="hljs-keyword">login</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">login</span></span> status: status timezone: timezone langcode: plugin: user_langcode source: <span class="hljs-keyword"><span class="hljs-keyword">language</span></span> fallback_to_site_default: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> preferred_langcode: plugin: user_langcode source: <span class="hljs-keyword"><span class="hljs-keyword">language</span></span> fallback_to_site_default: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> preferred_admin_langcode: plugin: user_langcode source: <span class="hljs-keyword"><span class="hljs-keyword">language</span></span> fallback_to_site_default: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> init: init roles: plugin: migration_lookup migration: custom_migration_forum_user_role source: roles user_picture: - plugin: default_value source: picture default_value: <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> - plugin: migration_lookup migration: d7_file destination: plugin: entity:<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> migration_dependencies: required: - custom_migration_forum_user_role optional: - d7_field_instance - d7_file - <span class="hljs-keyword"><span class="hljs-keyword">language</span></span> - default_language - user_picture_field_instance - user_picture_entity_display - user_picture_entity_form_display</code> </pre><br>  <b>config / install / migrate_plus.migration.filter_format.yml:</b> <br><br><pre> <code class="hljs sql">id: custom_migration_forum_filter_format label: Filter format configuration migration_group: Custom Migration Forum dependencies: enforced: module: - custom_migration_forum source: plugin: d7_filter_format process: format: format name: name <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> weight: weight filters: <span class="hljs-keyword"><span class="hljs-keyword">plugin</span></span>: sub_process <span class="hljs-keyword"><span class="hljs-keyword">source</span></span>: filters <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>: <span class="hljs-string"><span class="hljs-string">'@id'</span></span> process: <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">plugin</span></span>: filter_id bypass: <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">source</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>: { } <span class="hljs-keyword"><span class="hljs-keyword">settings</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">plugin</span></span>: filter_settings <span class="hljs-keyword"><span class="hljs-keyword">source</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">settings</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">plugin</span></span>: default_value default_value: <span class="hljs-literal"><span class="hljs-literal">true</span></span> weight: weight destination: <span class="hljs-keyword"><span class="hljs-keyword">plugin</span></span>: entity:filter_format</code> </pre><br>  Now you can start preparing a plugin for the migration of <b>forum materials</b> . <br><br>  <b>src / plugin / migrate / source / Forum.php:</b> <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Drupal</span></span>\<span class="hljs-title"><span class="hljs-title">custom_migration_forum</span></span>\<span class="hljs-title"><span class="hljs-title">Plugin</span></span>\<span class="hljs-title"><span class="hljs-title">migrate</span></span>\<span class="hljs-title"><span class="hljs-title">source</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Drupal</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Extension</span></span>\<span class="hljs-title"><span class="hljs-title">ModuleHandlerInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Drupal</span></span>\<span class="hljs-title"><span class="hljs-title">migrate</span></span>\<span class="hljs-title"><span class="hljs-title">Row</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Drupal</span></span>\<span class="hljs-title"><span class="hljs-title">migrate_drupal</span></span>\<span class="hljs-title"><span class="hljs-title">Plugin</span></span>\<span class="hljs-title"><span class="hljs-title">migrate</span></span>\<span class="hljs-title"><span class="hljs-title">source</span></span>\<span class="hljs-title"><span class="hljs-title">d7</span></span>\<span class="hljs-title"><span class="hljs-title">FieldableEntity</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Drupal</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Database</span></span>\<span class="hljs-title"><span class="hljs-title">Query</span></span>\<span class="hljs-title"><span class="hljs-title">SelectInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Drupal</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>\<span class="hljs-title"><span class="hljs-title">EntityManagerInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Drupal</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Extension</span></span>\<span class="hljs-title"><span class="hljs-title">ModuleHandler</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Drupal</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">State</span></span>\<span class="hljs-title"><span class="hljs-title">StateInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Drupal</span></span>\<span class="hljs-title"><span class="hljs-title">migrate</span></span>\<span class="hljs-title"><span class="hljs-title">Plugin</span></span>\<span class="hljs-title"><span class="hljs-title">MigrationInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">DependencyInjection</span></span>\<span class="hljs-title"><span class="hljs-title">ContainerInterface</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Extract forum from Drupal 7 database. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@MigrateSource</span></span></span><span class="hljs-comment">( * id = "custom_migration_forum_forum", * ) */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Forum</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FieldableEntity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * The module handler. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> \Drupal\Core\Extension\ModuleHandlerInterface */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $moduleHandler; <span class="hljs-comment"><span class="hljs-comment">/** * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment">} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $configuration, $plugin_id, $plugin_definition, MigrationInterface $migration, StateInterface $state, EntityManagerInterface $entity_manager, ModuleHandlerInterface $module_handler)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::__construct($configuration, $plugin_id, $plugin_definition, $migration, $state, $entity_manager); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;moduleHandler = $module_handler; } <span class="hljs-comment"><span class="hljs-comment">/** * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment">} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContainerInterface $container, array $configuration, $plugin_id, $plugin_definition, MigrationInterface $migration = NULL)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>( $configuration, $plugin_id, $plugin_definition, $migration, $container-&gt;get(<span class="hljs-string"><span class="hljs-string">'state'</span></span>), $container-&gt;get(<span class="hljs-string"><span class="hljs-string">'entity.manager'</span></span>), $container-&gt;get(<span class="hljs-string"><span class="hljs-string">'module_handler'</span></span>) ); } <span class="hljs-comment"><span class="hljs-comment">/** * The join options between the node and the node_revisions table. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> JOIN = <span class="hljs-string"><span class="hljs-string">'n.vid = nr.vid'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment">} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Select node in its last revision. $query = $this-&gt;select('node_revision', 'nr') -&gt;fields('n', [ 'nid', 'type', 'language', 'status', 'created', 'changed', 'comment', 'promote', 'sticky', 'tnid', 'translate', ]) -&gt;fields('nr', [ 'vid', 'title', 'log', 'timestamp', ]) -&gt;fields('fb', [ 'body_value', 'body_format', ]); $query-&gt;addField('n', 'uid', 'node_uid'); $query-&gt;addField('n', 'type', 'node_type'); $query-&gt;addField('nr', 'uid', 'revision_uid'); $query-&gt;innerJoin('node', 'n', static::JOIN); $query-&gt;innerJoin('field_data_body', 'fb', 'n.nid = fb.entity_id'); // If the content_translation module is enabled, get the source langcode // to fill the content_translation_source field. if ($this-&gt;moduleHandler-&gt;moduleExists('content_translation')) { $query-&gt;leftJoin('node', 'nt', 'n.tnid = nt.nid'); $query-&gt;addField('nt', 'language', 'source_langcode'); } $this-&gt;handleTranslations($query); // Filtered node type forum. $query-&gt;condition('n.type', 'forum'); return $query; } /** * {@inheritdoc} */ public function prepareRow(Row $row) { // Get Field API field values. foreach (array_keys($this-&gt;getFields('node', 'forum')) as $field) { $nid = $row-&gt;getSourceProperty('nid'); $vid = $row-&gt;getSourceProperty('vid'); $row-&gt;setSourceProperty($field, $this-&gt;getFieldValues('node', $field, $nid, $vid)); } // Make sure we always have a translation set. if ($row-&gt;getSourceProperty('tnid') == 0) { $row-&gt;setSourceProperty('tnid', $row-&gt;getSourceProperty('nid')); } return parent::prepareRow($row); } /** * {@inheritdoc} */ public function fields() { $fields = [ 'nid' =&gt; $this-&gt;t('Node ID'), 'type' =&gt; $this-&gt;t('Type'), 'title' =&gt; $this-&gt;t('Title'), 'body_value' =&gt; $this-&gt;t('Full text of body'), 'body_format' =&gt; $this-&gt;t('Format of body'), 'node_uid' =&gt; $this-&gt;t('Node authored by (uid)'), 'revision_uid' =&gt; $this-&gt;t('Revision authored by (uid)'), 'created' =&gt; $this-&gt;t('Created timestamp'), 'changed' =&gt; $this-&gt;t('Modified timestamp'), 'status' =&gt; $this-&gt;t('Published'), 'promote' =&gt; $this-&gt;t('Promoted to front page'), 'sticky' =&gt; $this-&gt;t('Sticky at top of lists'), 'revision' =&gt; $this-&gt;t('Create new revision'), 'language' =&gt; $this-&gt;t('Language (fr, en, ...)'), 'tnid' =&gt; $this-&gt;t('The translation set id for this node'), 'timestamp' =&gt; $this-&gt;t('The timestamp the latest revision of this node was created.'), ]; return $fields; } /** * {@inheritdoc} */ public function getIds() { $ids['nid']['type'] = 'integer'; $ids['nid']['alias'] = 'n'; return $ids; } /** * Adapt our query for translations. * * @param \Drupal\Core\Database\Query\SelectInterface $query * The generated query. */ protected function handleTranslations(SelectInterface $query) { // Check whether or not we want translations. if (empty($this-&gt;configuration['translations'])) { // No translations: Yield untranslated nodes, or default translations. $query-&gt;where('n.tnid = 0 OR n.tnid = n.nid'); } else { // Translations: Yield only non-default translations. $query-&gt;where('n.tnid &lt;&gt; 0 AND n.tnid &lt;&gt; n.nid'); } } }</span></span></code> </pre><br>  And the yml file to the plugin. <br><br>  <b>config / install / migrate_plus.migration.forum.yml:</b> <br><br><pre> <code class="hljs bash">id: custom_migration_forum_forum label: Custom forum migration migration_group: Custom Migration Forum dependencies: enforced: module: - custom_migration_forum dependencies: enforced: module: - custom_migration_forum <span class="hljs-built_in"><span class="hljs-built_in">source</span></span>: plugin: custom_migration_forum_forum node_type: forum target: migrate migration_dependencies: required: - custom_migration_forum_term - custom_migration_forum_user - custom_migration_forum_filter_format process: nid: tnid vid: vid langcode: plugin: default_value <span class="hljs-built_in"><span class="hljs-built_in">source</span></span>: language default_value: <span class="hljs-string"><span class="hljs-string">'en'</span></span> title: title <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: plugin: default_value default_value: forum <span class="hljs-string"><span class="hljs-string">'body/value'</span></span>: body_value <span class="hljs-string"><span class="hljs-string">'body/format'</span></span>: body_format uid: plugin: migration migration: custom_migration_forum_user <span class="hljs-built_in"><span class="hljs-built_in">source</span></span>: node_uid status: status created: created changed: changed promote: promote sticky: sticky revision_uid: revision_uid revision_log: <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> revision_timestamp: timestamp taxonomy_forums: plugin: migration migration: custom_migration_forum_term <span class="hljs-built_in"><span class="hljs-built_in">source</span></span>: taxonomy_forums destination: plugin: entity:node</code> </pre><br>  The last thing left for us is comments on the topics (how can they be without them?). <br>  Create a plugin and describe it in the configuration. <br><br>  <b>src / plugin / migrate / source / ForumComment.php:</b> <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@file</span></span></span><span class="hljs-comment"> * Contains \Drupal\custom_migration_forum\Plugin\migrate\source\ForumComment. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Drupal</span></span>\<span class="hljs-title"><span class="hljs-title">custom_migration_forum</span></span>\<span class="hljs-title"><span class="hljs-title">Plugin</span></span>\<span class="hljs-title"><span class="hljs-title">migrate</span></span>\<span class="hljs-title"><span class="hljs-title">source</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Drupal</span></span>\<span class="hljs-title"><span class="hljs-title">migrate</span></span>\<span class="hljs-title"><span class="hljs-title">Row</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Drupal</span></span>\<span class="hljs-title"><span class="hljs-title">migrate_drupal</span></span>\<span class="hljs-title"><span class="hljs-title">Plugin</span></span>\<span class="hljs-title"><span class="hljs-title">migrate</span></span>\<span class="hljs-title"><span class="hljs-title">source</span></span>\<span class="hljs-title"><span class="hljs-title">d7</span></span>\<span class="hljs-title"><span class="hljs-title">FieldableEntity</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Drupal 7 comment forum source from database. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@MigrateSource</span></span></span><span class="hljs-comment">( * id = "custom_migration_forum_forum_comment", * source_provider = "comment", * ) */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ForumComment</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FieldableEntity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment">} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $query = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;select(<span class="hljs-string"><span class="hljs-string">'comment'</span></span>, <span class="hljs-string"><span class="hljs-string">'c'</span></span>)-&gt;fields(<span class="hljs-string"><span class="hljs-string">'c'</span></span>); $query-&gt;innerJoin(<span class="hljs-string"><span class="hljs-string">'node'</span></span>, <span class="hljs-string"><span class="hljs-string">'n'</span></span>, <span class="hljs-string"><span class="hljs-string">'c.nid = n.nid'</span></span>); $query-&gt;addField(<span class="hljs-string"><span class="hljs-string">'n'</span></span>, <span class="hljs-string"><span class="hljs-string">'type'</span></span>, <span class="hljs-string"><span class="hljs-string">'node_type'</span></span>); $query-&gt;addField(<span class="hljs-string"><span class="hljs-string">'n'</span></span>, <span class="hljs-string"><span class="hljs-string">'nid'</span></span>); $query-&gt;condition(<span class="hljs-string"><span class="hljs-string">'n.type'</span></span>, <span class="hljs-string"><span class="hljs-string">'forum'</span></span>); $query-&gt;orderBy(<span class="hljs-string"><span class="hljs-string">'c.created'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $query; } <span class="hljs-comment"><span class="hljs-comment">/** * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment">} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareRow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Row $row)</span></span></span><span class="hljs-function"> </span></span>{ $cid = $row-&gt;getSourceProperty(<span class="hljs-string"><span class="hljs-string">'cid'</span></span>); $node_type = $row-&gt;getSourceProperty(<span class="hljs-string"><span class="hljs-string">'node_type'</span></span>); $comment_type = <span class="hljs-string"><span class="hljs-string">'comment_node_'</span></span> . $node_type; $row-&gt;setSourceProperty(<span class="hljs-string"><span class="hljs-string">'comment_type'</span></span>, <span class="hljs-string"><span class="hljs-string">'comment_forum'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (array_keys(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getFields(<span class="hljs-string"><span class="hljs-string">'comment'</span></span>, $comment_type)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $field) { $row-&gt;setSourceProperty($field, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getFieldValues(<span class="hljs-string"><span class="hljs-string">'comment'</span></span>, $field, $cid)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::prepareRow($row); } <span class="hljs-comment"><span class="hljs-comment">/** * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment">} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fields</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'cid'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;t(<span class="hljs-string"><span class="hljs-string">'Comment ID.'</span></span>), <span class="hljs-string"><span class="hljs-string">'pid'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;t(<span class="hljs-string"><span class="hljs-string">'Parent comment ID. If set to 0, this comment is not a reply to an existing comment.'</span></span>), <span class="hljs-string"><span class="hljs-string">'nid'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;t(<span class="hljs-string"><span class="hljs-string">'The {node}.nid to which this comment is a reply.'</span></span>), <span class="hljs-string"><span class="hljs-string">'uid'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;t(<span class="hljs-string"><span class="hljs-string">'The {users}.uid who authored the comment. If set to 0, this comment was created by an anonymous user.'</span></span>), <span class="hljs-string"><span class="hljs-string">'subject'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;t(<span class="hljs-string"><span class="hljs-string">'The comment title.'</span></span>), <span class="hljs-string"><span class="hljs-string">'comment'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;t(<span class="hljs-string"><span class="hljs-string">'The comment body.'</span></span>), <span class="hljs-string"><span class="hljs-string">'hostname'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;t(<span class="hljs-string"><span class="hljs-string">"The author's host name."</span></span>), <span class="hljs-string"><span class="hljs-string">'created'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;t(<span class="hljs-string"><span class="hljs-string">'The time that the comment was created, as a Unix timestamp.'</span></span>), <span class="hljs-string"><span class="hljs-string">'changed'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;t(<span class="hljs-string"><span class="hljs-string">'The time that the comment was edited by its author, as a Unix timestamp.'</span></span>), <span class="hljs-string"><span class="hljs-string">'status'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;t(<span class="hljs-string"><span class="hljs-string">'The published status of a comment. (0 = Published, 1 = Not Published)'</span></span>), <span class="hljs-string"><span class="hljs-string">'format'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;t(<span class="hljs-string"><span class="hljs-string">'The {filter_formats}.format of the comment body.'</span></span>), <span class="hljs-string"><span class="hljs-string">'thread'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;t(<span class="hljs-string"><span class="hljs-string">"The vancode representation of the comment's place in a thread."</span></span>), <span class="hljs-string"><span class="hljs-string">'name'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;t(<span class="hljs-string"><span class="hljs-string">"The comment author's name. Uses {users}.name if the user is logged in, otherwise uses the value typed into the comment form."</span></span>), <span class="hljs-string"><span class="hljs-string">'mail'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;t(<span class="hljs-string"><span class="hljs-string">"The comment author's email address from the comment form, if user is anonymous, and the 'Anonymous users may/must leave their contact information' setting is turned on."</span></span>), <span class="hljs-string"><span class="hljs-string">'homepage'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;t(<span class="hljs-string"><span class="hljs-string">"The comment author's home page address from the comment form, if user is anonymous, and the 'Anonymous users may/must leave their contact information' setting is turned on."</span></span>), <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;t(<span class="hljs-string"><span class="hljs-string">"The {node}.type to which this comment is a reply."</span></span>), ]; } <span class="hljs-comment"><span class="hljs-comment">/** * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@inheritdoc</span></span></span><span class="hljs-comment">} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getIds</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $ids[<span class="hljs-string"><span class="hljs-string">'cid'</span></span>][<span class="hljs-string"><span class="hljs-string">'type'</span></span>] = <span class="hljs-string"><span class="hljs-string">'integer'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $ids; } }</code> </pre><br>  <b>config / install / migrate_plus.migration.forum_comment.yml:</b> <br><br><pre> <code class="hljs pgsql">id: custom_migration_forum_forum_comment label: Comments forum migration_group: Custom Migration Forum dependencies: enforced: module: - custom_migration_forum source: plugin: custom_migration_forum_forum_comment target: migrate constants: entity_type: node process: cid: cid pid: plugin: migration_lookup migration: custom_migration_forum_forum_comment source: pid entity_id: nid entity_type: <span class="hljs-string"><span class="hljs-string">'constants/entity_type'</span></span> comment_type: comment_type field_name: comment_type subject: subject uid: uid <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-type"><span class="hljs-type">name</span></span> mail: mail homepage: homepage hostname: hostname created: created changed: changed status: status thread: thread comment_body: comment_body destination: plugin: entity:<span class="hljs-keyword"><span class="hljs-keyword">comment</span></span> migration_dependencies: required: - custom_migration_forum_forum</code> </pre><br><h2>  Begin migration </h2><br>  Now we are ready for the migration.  Add the Drupal 7 database to the configuration file of our site on Drupal 8. We do this in the settings.php file (or in another file that connects your settings. I have this <b>settings.local.php</b> file): <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $databases[<span class="hljs-string"><span class="hljs-string">'migrate'</span></span>][<span class="hljs-string"><span class="hljs-string">'default'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span> ( <span class="hljs-string"><span class="hljs-string">'database'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Drupal_7'</span></span>, <span class="hljs-string"><span class="hljs-string">'username'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'root'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'root'</span></span>, <span class="hljs-string"><span class="hljs-string">'prefix'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'host'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'localhost'</span></span>, <span class="hljs-string"><span class="hljs-string">'port'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'3306'</span></span>, <span class="hljs-string"><span class="hljs-string">'namespace'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Drupal\Core\Database\Driver\mysql'</span></span>, <span class="hljs-string"><span class="hljs-string">'driver'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'mysql'</span></span>, );</code> </pre><br>  We include the following modules: <br><br><pre> <code class="bash hljs">drush en migrate migrate_drupal migrate_plus migrate_tools taxonomy forum -</code> </pre> <br>  If you downloaded a module from <a href="https://github.com/animan01/custom_migration_forum">GitHub</a> , you can simply enable it: <br><br><pre> <code class="bash hljs">drush en custom_migration_forum -y</code> </pre> <br><img src="https://habrastorage.org/webt/qg/93/gw/qg93gwrkdcl3703trdm3_b9393e.png" alt="image"><br><br><h4>  Drush Migration </h4><br>  Check the list of available migrations: <br><br><pre> <code class="bash hljs">drush ms</code> </pre> <br><img src="https://habrastorage.org/webt/ce/ky/ai/cekyaiajh15vmovchrnrfexobas.png" alt="image"><br><br>  We start all our migrations with one command: <br><br><pre> <code class="bash hljs">drush mim --group=<span class="hljs-string"><span class="hljs-string">"Custom Migration Forum"</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/sp/b9/f5/spb9f5siplftv5qaf_h3iloasra.png" alt="image"><br><br>  In order to undo migration changes, there is a drush mr command: <br><br><pre> <code class="bash hljs">drush mr --group=<span class="hljs-string"><span class="hljs-string">"Custom Migration Forum"</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/-s/ad/lg/-sadlgsqh25bhptafedlbws6hue.png" alt="image"><br><br>  Also, sometimes errors occur during migration, and migration may hang in the status of <b>Importing</b> or <b>Rolling back</b> .  In order to reset the migration status, you need to run: <br><br><pre> <code class="bash hljs">drush php-eval <span class="hljs-string"><span class="hljs-string">'var_dump(Drupal::keyValue("migrate_status")-&gt;set('</span></span>custom_migration_forum_forum<span class="hljs-string"><span class="hljs-string">', 0))'</span></span></code> </pre> <br>  Where <b>custom_migration_forum_forum</b> is the migration ID. <br><br>  Our forum migration is complete.  As a result, we got a fully migrated forum with users and comments on topics. <br><br><img src="https://habrastorage.org/webt/nf/un/ck/nfunck2tivrwfemrapr6mifrxue.png" alt="image"></div><p>Source: <a href="https://habr.com/ru/post/349854/">https://habr.com/ru/post/349854/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../349838/index.html">The story of the internet in Germany and the undocumented features of Juniper SRX</a></li>
<li><a href="../349840/index.html">iPaaS - cloud ESB ... or not?</a></li>
<li><a href="../349842/index.html">Check Point Technical Support (TAC). Quick Start Guide</a></li>
<li><a href="../349844/index.html">Microsatellites for Earth Remote Sensing</a></li>
<li><a href="../349852/index.html">Extension methods for .NET standard library types</a></li>
<li><a href="../349858/index.html">How JS Works: Service Workers</a></li>
<li><a href="../349860/index.html">Regular expressions in Python from simple to complex. Details, examples, pictures, exercises</a></li>
<li><a href="../349862/index.html">Application Release Automation: Release Management Automation "Goes to the Cloud"</a></li>
<li><a href="../349864/index.html">Natasha - a library for extracting structured information from texts in Russian</a></li>
<li><a href="../349866/index.html">W3View - straight web UI path</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>