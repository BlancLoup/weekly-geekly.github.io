<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PostgreSQL testing with HugePages on Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The Linux kernel provides a wide range of configuration options that can affect performance. The key is to choose the right configuration for your app...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PostgreSQL testing with HugePages on Linux</h1><div class="post__text post__text-html js-mediator-article"><p>  The Linux kernel provides a wide range of configuration options that can affect performance.  The key is to choose the right configuration for your application and workload.  Like any other database, PostgreSQL requires optimal tuning of the Linux kernel.  Incorrect settings may result in poor performance.  It is important to conduct a comparative analysis of database performance after each tuning session.  In one of my previous posts called <a href="https://www.percona.com/blog/2018/08/29/tune-linux-kernel-parameters-for-postgresql-optimization/">"Tune Linux Kernel Parameters For PostgreSQL Optimization",</a> I described some of the most useful parameters of the Linux kernel and how they help improve database performance.  Now I will share the results of benchmarking after configuring HugePages in Linux under various PostgreSQL loads.  I conducted a complete set of tests under a variety of different PostgreSQL loads with a different number of parallel clients. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/cc3/be2/1f8/cc3be21f802843526a6739be7b84af6e.jpg" alt="image"></p><a name="habracut"></a><br><h3 id="pk-na-kotorom-vypolnyalos-testirovanie">  PC on which testing was performed </h3><br><ul><li>  Supermicro Server: <br><ol><li>  Intel¬Æ Xeon¬Æ CPU E5-2683 v3 @ 2.00 GHz </li><li>  2 sockets / 28 cores / 56 threads </li><li>  Memory: 256 GB RAM </li><li>  Storage: SAMSUNG SM863 1.9 TB Enterprise SSD </li><li>  File system: ext4 / xfs </li></ol></li><li>  OS: Ubuntu 16.04.4, kernel 4.13.0-36-generic </li><li>  PostgreSQL: version 11 </li></ul><br><h3 id="nastroyki-yadra-linux">  Linux kernel settings </h3><br><p>  I used the default kernel parameters without any optimization / configuration, only disabled Transparent HugePages.  This technology is enabled by default and allocates pages of a size that is not recommended for databases.  In general, databases need HugePages of a fixed size, but Transparent HugePages cannot provide them.  Therefore, it is always recommended to disable this feature and by default install the classic HugePages. </p><br><h3 id="nastroyki-postgresql">  PostgreSQL settings </h3><br><p>  I used the same PostgreSQL settings for all tests to record various PostgreSQL workloads with different Linux HugePages settings.  The following PostgreSQL settings were used for all tests: </p><br><pre><code class="plaintext hljs">shared_buffers = '64GB' work_mem = '1GB' random_page_cost = '1' maintenance_work_mem = '2GB' synchronous_commit = 'on' seq_page_cost = '1' max_wal_size = '100GB' checkpoint_timeout = '10min' synchronous_commit = 'on' checkpoint_completion_target = '0.9' autovacuum_vacuum_scale_factor = '0.4' effective_cache_size = '200GB' min_wal_size = '1GB' wal_compression = 'ON'</code> </pre> <br><h3 id="shema-testirovaniya">  Testing scheme </h3><br><p>  The testing scheme plays an important role.  All tests are performed three times, the duration of each run is 30 minutes.  Following these 3 tests, I derived the average.  Testing was performed using the PostgreSQL <a href="https://www.postgresql.org/docs/current/pgbench.html">pgbench</a> tool, it works with a scaling factor in steps of approximately 16 MB of load. </p><br><h3 id="hugepages">  Hugepages </h3><br><p>  By default, Linux uses 4K memory pages, as well as HugePages technology.  BSD uses Super Pages technology, and Windows uses Large Pages.  PostgreSQL only supports HugePages (Linux) technology.  In cases where the amount of memory used is large, smaller pages will reduce performance.  Using HugePages, you increase the allocated memory for the application and, therefore, reduce the "overhead" that occurs during the allocation / swap process.  Thus, HugePages increase productivity. </p><br><p>  Here are the settings for HugePages of 1 GB.  This information is available at any time using / proc. </p><br><pre> <code class="plaintext hljs">AnonHugePages:     0 kB ShmemHugePages:    0 kB HugePages_Total:   100 HugePages_Free:    97 HugePages_Rsvd:    63 HugePages_Surp:    0 Hugepagesize:  1048576 kB</code> </pre> <br><p>  More about HugePages I wrote in a previous post. </p><br><p>  <a href="https://www.percona.com/blog/2018/08/29/tune-linux-kernel-parameters-for-postgresql-optimization/">https://www.percona.com/blog/2018/08/29/tune-linux-kernel-parameters-for-postgresql-optimization/</a> </p><br><p>  In general, HugePages are 2 MB and 1 GB, so it makes sense to use 1 GB. </p><br><p>  <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/performance_tuning_guide/s-memory-transhuge">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/performance_tuning_guide/s-memory-transhuge</a> </p><br><p>  <a href="https://kerneltalks.com/services/what-is-huge-pages-in-linux/">https://kerneltalks.com/services/what-is-huge-pages-in-linux/</a> </p><br><h3 id="rezultaty-testirovaniya">  Test results </h3><br><p>  This test shows the overall effect of using HugePages of various sizes.  The first test suite was created with a 4K page size ‚Äî used by Linux by default ‚Äî and without activating HugePages.  Let me remind you: I turned off the Transparent HugePages option for the duration of the tests. </p><br><p>  Then a second set of tests was performed for HugePages of 2 MB.  Finally, a third set of tests was performed for HugePages of 1 GB. </p><br><p>  For all comparative tests PostgreSQL version 11 DBMS was used. The sets include combinations of different sizes of databases and different clients.  The graph below shows the results of performance comparisons using these tests: TPS (number of transactions per second) is on the Y axis, and database size and number of clients for a database of a certain size is on the X axis. </p><br><p> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/d72/a5e/0fa/d72a5e0fa05b8774fe82874c8832d048.png" alt="image"></a> </p><br><p>  From the above graph, it can be seen that, from the use of HugePages, the gain increases as the number of customers and the size of the database increases - as long as this size remains within the pre-allocated shared buffer. </p><br><p>  This test compared the TPS scores and the number of customers.  In this case, the size of the database is 48 GB.  TPS is shown on the Y axis, and the number of connected clients is shown on the X axis.  The size of the database is small enough to fit into a shared buffer with a fixed size of 64 GB. </p><br><p> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/5d9/dd6/a4b/5d9dd6a4b647b25ef7edde3928276e7d.png" alt="image"></a> </p><br><p>  When the size of HugePages is 1 GB, the comparative performance gain increases with the number of customers. </p><br><p>  The following graph is the same as the previous one, but the size of the database is 96 GB.  This is larger than the total buffer size set to 64 GB. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/z8/6r/je/z86rjeljjqfr_nyaylzzpv7xf9q.png"></a> </p><br><p>  The main thing to note here is that performance with HugePages of 1 GB increases as the number of customers increases and ultimately provides better performance than with the use of HugePages of 2 MB or standard pages of 4 KB. </p><br><p>  This test shows the ratio of TPS and database size.  In this case, the number of connected clients is 32. TPS is shown on the Y axis, and database sizes are shown on the X axis. </p><br><p> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/c93/228/0c2/c932280c2a1becc89eacd56de3fefaff.png" alt="image"></a> </p><br><p>  As expected, when the size of the database exceeds the size of the pre-allocated HugePages, performance is significantly reduced. </p><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>  One of my main recommendations is to disable Transparent HugePages.  You will get the most performance boost if the database is placed in a shared buffer with the included HugePages.  Determining the optimal size of HugePages is carried out by trial and error, but potentially this approach can lead to significant gains in TPS, when the size of the database is large enough, but at the same time allows it to fit in a common buffer. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/435558/">https://habr.com/ru/post/435558/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../435546/index.html">Practical tips, examples, and SSH tunnels</a></li>
<li><a href="../435548/index.html">Hacking public services - you can, if you really need</a></li>
<li><a href="../435550/index.html">GitLab 11.6 released with serverless functions and Kubernetes clusters for groups</a></li>
<li><a href="../435552/index.html">Import Substitution - Epitaph from Digitalization</a></li>
<li><a href="../435556/index.html">Moving to the data center: how it was</a></li>
<li><a href="../435560/index.html">The first commercial quantum computer - IBM</a></li>
<li><a href="../435562/index.html">The path of a smoker: how to enter the profession of a programmer, if you are a humanist</a></li>
<li><a href="../435564/index.html">Using GtkApplication. Librsvg drawing features</a></li>
<li><a href="../435568/index.html">VyOS OpenSource Router</a></li>
<li><a href="../435572/index.html">Anycubic i3 Mega: a quality remake of Prusa i3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>