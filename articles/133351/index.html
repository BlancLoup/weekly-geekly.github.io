<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Loader of images and thumbnails. New standards, old problems</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 Hello. Not so long ago, I wrote an article on creating a flash image loader . There I mentioned that the loader can be implemented using th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Loader of images and thumbnails. New standards, old problems</h1><div class="post__text post__text-html js-mediator-article"><h4>  Foreword </h4><br>  Hello.  Not so long ago, I wrote <a href="http://habrahabr.ru/blogs/Flash_Platform/132489/">an article on creating a flash image loader</a> .  There I mentioned that the loader can be implemented using the html5 File API.  A few nights and - hurray - I did it.  It is time to tell what tricks I used, in which browsers it works, and whether to use it at all. <br>  Let me remind you in brief of the requirements: you must implement an image loader that supports batch loading, creating thumbnails (and uploading them to the server), and an acceptable interface. <br><a name="habracut"></a><br>  I understand perfectly well that my article uses the current implementation of a not yet fully developed standard, and therefore I will list browsers that are relevant at the moment: <br><ol><li>  Firefox 8 </li><li>  Chrome 15 </li><li>  Opera 11.60 beta </li><li>  Safari 5.1.1 </li><li>  Internet Explorer 9 </li></ol><br>  Now about the sad.  For IE 9 there is no implementation of the File API, so I will not consider it (the browser).  Well, let's go. <br><br><h4>  Appearance </h4><br>  Since time immemorial, there has been the task of making a stylish button for calling the file selection dialog.  Therefore, violent crutches were used.  For example, a popular solution is to make the input transparent and hang over a beautiful diva.  That is, it all depends on the input, on its size.  All of the above browsers support a different solution.  You can programmatically generate inputa click in them.  And in essence, call the file selection dialog.  And the input itself can be easily hidden: <br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"input_file"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"file"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiple</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"position:absolute; top:-999px; visibility:hidden"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"background-color: blue; width: 100px; height:40px;"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><pre> <code class="javascript hljs">&lt;script type=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> input = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.querySelector(<span class="hljs-string"><span class="hljs-string">"#input_file"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> btn = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.querySelector(<span class="hljs-string"><span class="hljs-string">"#button"</span></span>); btn.onclick = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ input.click(); }; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br>  This method allows you to forget about the input as a control, which in my opinion is very convenient. <br><br><h4>  About downloading a file to the browser </h4><br>  In order to manipulate the file data, for example, resize the image, you need to get this data.  To do this, you need a FileReader.  To create thumbnails, take a Canvas and load the file data there.  This is possible if the data is presented as base64: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> files; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileReader(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cv = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">"canvas"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cvContext = cv.getContext(<span class="hljs-string"><span class="hljs-string">"2d"</span></span>); input.onchange = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ files = input.files; reader.readAsDataURL(files[<span class="hljs-number"><span class="hljs-number">0</span></span>]); }; reader.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> im = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Image(); im.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ cv.width = <span class="hljs-number"><span class="hljs-number">100</span></span>; cv.height = <span class="hljs-number"><span class="hljs-number">100</span></span>; cvContext.drawImage(im, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); <span class="hljs-comment"><span class="hljs-comment">//       canvas         } im.src = reader.result; };</span></span></code> </pre><br>  So far everything is quite transparent.  However, we must immediately say that downloading data to the browser is not supported in Safari.  The most interesting thing is that you can upload a file to the server, but not to the browser.  Neither FileReader nor URL is supported.  However, for our problem there is one solution, but I would honestly not use it.  I'll come back to this later. <br><br><h4>  About receiving thumbnails and sending to server </h4><br>  So.  We have the original image.  We have miniatures on canvas.  We need to get all this, group and send to the server.  What is easier, right?  This is where problems arise.  At this stage, browsers behave quite differently.  Consider solutions for everyone.  Of course, from simple to complex. <br><br><h5>  Firefox </h5><br>  Everything is simple.  Canvas has a mozGetAsFile method, the name of which speaks for itself.  Firefox also supports FormData.  This means that there is a container for our files.  XMLHttpRequest will easily send this data to a server where you can pick it up.  The upload process can be monitored using upload.onprogress. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> blobData = cv.mozGetAsFile(name, files[<span class="hljs-number"><span class="hljs-number">0</span></span>].type); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> form = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FormData(); form.append(<span class="hljs-string"><span class="hljs-string">"Filedata0"</span></span>, files[<span class="hljs-number"><span class="hljs-number">0</span></span>]); form.append(<span class="hljs-string"><span class="hljs-string">"Filedata1"</span></span>, blobData); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xhr.open(<span class="hljs-string"><span class="hljs-string">"POST"</span></span>, <span class="hljs-string"><span class="hljs-string">"load.php"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); xhr.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.response); } xhr.upload.onprogress = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(e.position / e.totalSize) * <span class="hljs-number"><span class="hljs-number">100</span></span>; } xhr.send(form);</code> </pre><br><br>  There is only one minus.  The mozGetAsFile method does not allow to select the quality of the paged image. <br><br><h5>  Chrome </h5><br>  Here, there is no mozGetAsFile at all.  It is possible to get the image in base64 (This makes the toDataURL method).  But it did not suit me, and I still led the image to blob.  Comments in the code: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> BlobBuilder = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.BlobBuilder || <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.WebKitBlobBuilder || <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.MozBlobBuilder; <span class="hljs-comment"><span class="hljs-comment">//    base64,     ( 0  1) var sBase64 = canva.toDataURL(type, 1); var aBase64 = sBase64.split(','); //  var sData = atob(aBase64[1]); var aBufferView = new Uint8Array(sData.length); // ArrayBuffer    for (var i = 0; i &lt; aBufferView.length; i++) { aBufferView[i] = sData.charCodeAt(i); } //   BlobBuilder   blob var builder = new BlobBuilder(); builder.append(aBufferView.buffer); var blobData = builder.getBlob(type);</span></span></code> </pre><br><br>  These data can already be written in FormData and sent in the same way as in firefox. <br><br><h5>  Opera </h5><br>  Here we have big problems.  You can get a thumbnail and turn it into an ArrayBuffer just like in Chrome, but how to send it?  Opera does not support FormData and BlobBuilder.  And XMLHttpRequest can send only ArrayBuffer except text.  Here we will help the experience of creating a bootloader on a flash.  We will have to generate the form header with the data ourselves, write it to the ArrayBuffer and send it. <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sBase64 = canva.toDataURL(type, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> aBase64 = sBase64.split(<span class="hljs-string"><span class="hljs-string">','</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sData = atob(aBase64[<span class="hljs-number"><span class="hljs-number">1</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> aBufferView = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>(sData.length); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; aBufferView.length; i++) { aBufferView[i] = sData.charCodeAt(i); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fBuilder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FormBuilder(); fBuilder.addFile(aBufferView); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> form = fBuilder.getForm(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xhr.open(<span class="hljs-string"><span class="hljs-string">"POST"</span></span>, <span class="hljs-string"><span class="hljs-string">"load.php"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); xhr.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ alert(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.response); } xhr.setRequestHeader(<span class="hljs-string"><span class="hljs-string">'Content-type'</span></span>, <span class="hljs-string"><span class="hljs-string">'multipart/form-data; boundary='</span></span> + fBuilder.BOUND); xhr.send(form); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FormBuilder</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getBoundary = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _boundary = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">0x20</span></span>; i++) { _boundary += <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(<span class="hljs-number"><span class="hljs-number">97</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * <span class="hljs-number"><span class="hljs-number">25</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _boundary; } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.addFile = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name, buffer</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sHeader = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ADDB + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.BOUND; sHeader += <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ENTER; sHeader += <span class="hljs-string"><span class="hljs-string">'Content-Disposition: form-data; name="Filedata'</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.index + <span class="hljs-string"><span class="hljs-string">'"; filename="'</span></span> + name + <span class="hljs-string"><span class="hljs-string">'"'</span></span>; sHeader += <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ENTER; sHeader += <span class="hljs-string"><span class="hljs-string">'Content-Type: application/octet-stream'</span></span>; sHeader += <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ENTER; sHeader += <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ENTER; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.index++; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.header = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sumBuffers(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.header, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.StrToBuffer(sHeader), buffer, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.EnterBuffer); } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.addParam = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name, value</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sHeader = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ADDB + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.BOUND; sHeader += <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ENTER; sHeader += <span class="hljs-string"><span class="hljs-string">'Content-Disposition: form-data; name="'</span></span>+ name + <span class="hljs-string"><span class="hljs-string">'"'</span></span>; sHeader += <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ENTER; sHeader += <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ENTER; sHeader += value; sHeader += <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ENTER; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.header = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sumBuffers(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.header, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.StrToBuffer(sHeader)); } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getForm = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sHeader = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ENTER; sHeader += <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ENTER; sHeader += (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ADDB + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.BOUND + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ADDB); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> aHeader = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.StrToBuffer(sHeader); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sumBuffers(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.header, aHeader).buffer; } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.StrToBuffer = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">str</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> buffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>(str.length); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; buffer.length; i++) { buffer[i] = str.charCodeAt(i); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buffer; } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sumBuffers = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sumLength = <span class="hljs-number"><span class="hljs-number">0</span></span>, position = <span class="hljs-number"><span class="hljs-number">0</span></span>, aSumHeader; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>.length; i++) { sumLength += <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>[i].length; } aSumHeader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>(sumLength); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>.length; i++) { aSumHeader.set(<span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>[i], position); position += <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>[i].length; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> aSumHeader; } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.BOUND = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getBoundary(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ENTER = <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.EnterBuffer = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.StrToBuffer(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ENTER); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ADDB = <span class="hljs-string"><span class="hljs-string">"--"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.index = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.header = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> </pre><br><br>  This is such a free translation from actionscript to javascript of my class from the first article.  With it, we essentially emulate FormData.  By the way, in Chrome, it works great.  But firefox swears - he does not know how to transmit ArrayBuffer. <br>  Let's return to the Opera.  Everything works, but it will not work to track the download: onprogress in Opera is not supported (as by the way, in the URLLoader Fleshevsky). <br><br><h5>  Safari </h5><br>  I have already said above that in Safari we do not have access to the file data, and therefore practically nothing can be done.  However, if you decided to definitely make a functional image loader on html5 and with Safari support, then there is a pseudo-solution.  The fact is that although there is no access to the file data, you can upload it to the server.  And you can do anything on the server.  The idea is simple: having received and saved the file, transfer it back (in the form of base64 or just links with the subsequent loading into Canvas).  And here you can try to implement one of the above options.  Naturally, the method is not good, but if absolutely necessary, then you can do so. <br><br><h4>  Conclusion </h4><br>  The conclusions from the above are pretty simple.  First, the File API is clearly not mature yet.  Browsers are trying to somehow maintain what is in the specification, but the standard is still at the stage of discussion and refinement.  Despite this, we still have a fairly powerful tool that allows us to solve problems not only on paper. <br>  I hope the article will help someone. <br><br><h4>  Example </h4><br>  I cite a small <a href="http://jsfiddle.net/AlvaroJDart/9ydPV/10/">demo</a> , the functionality there is minimal, but demonstrates how this should work. <br>  Yes, and more.  The minimum server code for this example is: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($_FILES <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $value){ $filename = substr_replace($key, <span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-number"><span class="hljs-number">-4</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); move_uploaded_file($value[<span class="hljs-string"><span class="hljs-string">'tmp_name'</span></span>], $filename); } <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'complete'</span></span>;</code> </pre><br><br>  If you need a full-fledged loader with all the options and features, then write.  Maybe I will. <br>  And, of course, do not forget that the version of Opera for example 11.60 beta. </div><p>Source: <a href="https://habr.com/ru/post/133351/">https://habr.com/ru/post/133351/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../133345/index.html">Tale of how harmful it is to put components out of the box</a></li>
<li><a href="../133346/index.html">Samsung Galaxy Note - video review of new products before the start of its official sales.</a></li>
<li><a href="../133347/index.html">Scala complexity issues</a></li>
<li><a href="../133348/index.html">Large manufacturers reduce prices for 7-inch tablets</a></li>
<li><a href="../133350/index.html">TornadIO2 = Tornado + Socket.IO</a></li>
<li><a href="../133353/index.html">How easy it is to create beautiful</a></li>
<li><a href="../133354/index.html">OpenStreetMap News ‚Ññ10: OSM on Russian TV, statistics on the streets of Russia, OSM goal is to be easier for ordinary people, interesting map screenshots</a></li>
<li><a href="../133355/index.html">Styling applications part two</a></li>
<li><a href="../133356/index.html">Candidates of Sciences may cancel, but will not</a></li>
<li><a href="../133357/index.html">Little known Java features. The second part of</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>